<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: flushtb.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>flushtb.c</h1><a href="../../d7/d5/alpha_2flushtb_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1992-1998  Microsoft Corporation</span>
00004 <span class="comment">Copyright (c) 1993  Digital Equipment Corporation</span>
00005 <span class="comment"></span>
00006 <span class="comment">Module Name:</span>
00007 <span class="comment"></span>
00008 <span class="comment">    flushtb.c</span>
00009 <span class="comment"></span>
00010 <span class="comment">Abstract:</span>
00011 <span class="comment"></span>
00012 <span class="comment">    This module implements machine dependent functions to flush the</span>
00013 <span class="comment">    translation buffers and synchronize PIDs in an Alpha AXP MP system.</span>
00014 <span class="comment"></span>
00015 <span class="comment">    N.B. This module contains only MP versions of the TB flush routines.</span>
00016 <span class="comment">         The UP versions are macros in ke.h</span>
00017 <span class="comment">         KeFlushEntireTb remains a routine for the UP system since it is</span>
00018 <span class="comment">         exported from the kernel for backwards compatibility.</span>
00019 <span class="comment"></span>
00020 <span class="comment">Author:</span>
00021 <span class="comment"></span>
00022 <span class="comment">    David N. Cutler (davec) 13-May-1989</span>
00023 <span class="comment">    Joe Notarangelo  29-Nov-1993</span>
00024 <span class="comment"></span>
00025 <span class="comment">Environment:</span>
00026 <span class="comment"></span>
00027 <span class="comment">    Kernel mode only.</span>
00028 <span class="comment"></span>
00029 <span class="comment">Revision History:</span>
00030 <span class="comment"></span>
00031 <span class="comment"></span>
00032 <span class="comment">--*/</span>
00033 
00034 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00035 
00036 <span class="comment">//</span>
00037 <span class="comment">// Define forward referenced prototypes.</span>
00038 <span class="comment">//</span>
00039 
00040 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00041 <a class="code" href="../../d4/d1/xxflshtb_8c.html#a0">KiFlushEntireTbTarget</a> (
00042     IN PKIPI_CONTEXT SignalDone,
00043     IN PVOID Parameter1,
00044     IN PVOID Parameter2,
00045     IN PVOID Parameter3
00046     );
00047 
00048 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00049 <a class="code" href="../../d4/d1/xxflshtb_8c.html#a1">KiFlushMultipleTbTarget</a> (
00050     IN PKIPI_CONTEXT SignalDone,
00051     IN PVOID Number,
00052     IN PVOID Virtual,
00053     IN PVOID Pid
00054     );
00055 
00056 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00057 <a class="code" href="../../d4/d1/xxflshtb_8c.html#a2">KiFlushSingleTbTarget</a> (
00058     IN PKIPI_CONTEXT SignalDone,
00059     IN PVOID Virtual,
00060     IN PVOID Pid,
00061     IN PVOID Parameter3
00062     );
00063 
00064 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00065 <a class="code" href="../../d4/d1/xxflshtb_8c.html#a3">KiFlushMultipleTbTarget64</a> (
00066     IN PKIPI_CONTEXT SignalDone,
00067     IN PVOID Number,
00068     IN PVOID Virtual,
00069     IN PVOID Pid
00070     );
00071 
00072 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00073 <a class="code" href="../../d4/d1/xxflshtb_8c.html#a4">KiFlushSingleTbTarget64</a> (
00074     IN PKIPI_CONTEXT SignalDone,
00075     IN PVOID Virtual,
00076     IN PVOID Pid,
00077     IN PVOID Parameter3
00078     );
00079 
00080 <span class="preprocessor">#if defined(NT_UP)</span>
00081 <span class="preprocessor"></span><span class="preprocessor">#undef KeFlushEntireTb</span>
00082 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00083 <span class="preprocessor"></span>
00084 
00085 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00086"></a><a class="code" href="../../d7/d5/alpha_2flushtb_8c.html#a5">00086</a> <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (
00087     IN BOOLEAN Invalid,
00088     IN BOOLEAN AllProcessors
00089     )
00090 
00091 <span class="comment">/*++</span>
00092 <span class="comment"></span>
00093 <span class="comment">Routine Description:</span>
00094 <span class="comment"></span>
00095 <span class="comment">    This function flushes the entire translation buffer (TB) on all</span>
00096 <span class="comment">    processors that are currently running threads which are children</span>
00097 <span class="comment">    of the current process or flushes the entire translation buffer</span>
00098 <span class="comment">    on all processors in the host configuration.</span>
00099 <span class="comment"></span>
00100 <span class="comment">Arguments:</span>
00101 <span class="comment"></span>
00102 <span class="comment">    Invalid - Supplies a boolean value that specifies the reason for</span>
00103 <span class="comment">        flushing the translation buffer.</span>
00104 <span class="comment"></span>
00105 <span class="comment">    AllProcessors - Supplies a boolean value that determines which</span>
00106 <span class="comment">        translation buffers are to be flushed.</span>
00107 <span class="comment"></span>
00108 <span class="comment">Return Value:</span>
00109 <span class="comment"></span>
00110 <span class="comment">    None.</span>
00111 <span class="comment"></span>
00112 <span class="comment">--*/</span>
00113 
00114 {
00115 
00116     KIRQL OldIrql;
00117     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
00118     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00119     KAFFINITY TargetProcessors;
00120 
00121     <span class="comment">//</span>
00122     <span class="comment">// Compute the target set of processors, disable context switching,</span>
00123     <span class="comment">// and send the flush entire parameters to the target processors,</span>
00124     <span class="comment">// if any, for execution.</span>
00125     <span class="comment">//</span>
00126 
00127 <span class="preprocessor">#if defined(NT_UP)</span>
00128 <span class="preprocessor"></span>
00129     __tbia();
00130 
00131 <span class="preprocessor">#else</span>
00132 <span class="preprocessor"></span>
00133     <span class="keywordflow">if</span> (AllProcessors != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00134         OldIrql = KeRaiseIrqlToSynchLevel();
00135         TargetProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a>;
00136 
00137     } <span class="keywordflow">else</span> {
00138         <a class="code" href="../../d0/d0/ki_8h.html#a11">KiLockContextSwap</a>(&amp;OldIrql);
00139         Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00140         Process = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>;
00141         TargetProcessors = Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o3">ActiveProcessors</a>;
00142         <span class="keywordflow">if</span> (TargetProcessors != Process-&gt;RunOnProcessors) {
00143             Process-&gt;ProcessSequence = KiMasterSequence - 1;
00144         }
00145     }
00146 
00147     TargetProcessors &amp;= PCR-&gt;NotMember;
00148     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00149         <a class="code" href="../../d0/d0/ki_8h.html#a91">KiIpiSendPacket</a>(TargetProcessors,
00150                         <a class="code" href="../../d7/d5/alpha_2flushtb_8c.html#a0">KiFlushEntireTbTarget</a>,
00151                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00152                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00153                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00154     }
00155 
00156     <a class="code" href="../../d0/d0/ki_8h.html#a21">IPI_INSTRUMENT_COUNT</a>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;Number, FlushEntireTb);
00157 
00158     <span class="comment">//</span>
00159     <span class="comment">// Flush TB on current processor.</span>
00160     <span class="comment">//</span>
00161 
00162     <span class="comment">// KeFlushCurrentTb();</span>
00163     __tbia();
00164 
00165     <span class="comment">//</span>
00166     <span class="comment">// Wait until all target processors have finished.</span>
00167     <span class="comment">//</span>
00168 
00169     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00170         <a class="code" href="../../d2/d1/xipi_8c.html#a2">KiIpiStallOnPacketTargets</a>(TargetProcessors);
00171     }
00172 
00173     <span class="keywordflow">if</span> (AllProcessors != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00174         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00175     } <span class="keywordflow">else</span> {
00176         <a class="code" href="../../d0/d0/ki_8h.html#a12">KiUnlockContextSwap</a>(OldIrql);
00177     }
00178 
00179 <span class="preprocessor">#endif</span>
00180 <span class="preprocessor"></span>
00181     <span class="keywordflow">return</span>;
00182 }
00183 
00184 <span class="preprocessor">#if !defined(NT_UP)</span>
00185 <span class="preprocessor"></span>
00186 
00187 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00188"></a><a class="code" href="../../d7/d5/alpha_2flushtb_8c.html#a0">00188</a> <a class="code" href="../../d4/d1/xxflshtb_8c.html#a0">KiFlushEntireTbTarget</a> (
00189     IN PKIPI_CONTEXT SignalDone,
00190     IN PVOID Parameter1,
00191     IN PVOID Parameter2,
00192     IN PVOID Parameter3
00193     )
00194 
00195 <span class="comment">/*++</span>
00196 <span class="comment"></span>
00197 <span class="comment">Routine Description:</span>
00198 <span class="comment"></span>
00199 <span class="comment">    This is the target function for flushing the entire TB.</span>
00200 <span class="comment"></span>
00201 <span class="comment">Arguments:</span>
00202 <span class="comment"></span>
00203 <span class="comment">    SignalDone - Supplies a pointer to a variable that is cleared when the</span>
00204 <span class="comment">        requested operation has been performed.</span>
00205 <span class="comment"></span>
00206 <span class="comment">    Parameter1 - Parameter3 - not used</span>
00207 <span class="comment"></span>
00208 <span class="comment">Return Value:</span>
00209 <span class="comment"></span>
00210 <span class="comment">    None.</span>
00211 <span class="comment"></span>
00212 <span class="comment">--*/</span>
00213 
00214 {
00215 
00216     <span class="comment">//</span>
00217     <span class="comment">// Flush the entire TB on the current processor</span>
00218     <span class="comment">//</span>
00219 
00220     <a class="code" href="../../d0/d0/ki_8h.html#a93">KiIpiSignalPacketDone</a>(SignalDone);
00221 
00222     <span class="comment">// KeFlushCurrentTb();</span>
00223     __tbia();
00224 
00225     <a class="code" href="../../d0/d0/ki_8h.html#a21">IPI_INSTRUMENT_COUNT</a>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;Number, FlushEntireTb);
00226 
00227     <span class="keywordflow">return</span>;
00228 }
00229 
00230 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00231"></a><a class="code" href="../../d7/d5/alpha_2flushtb_8c.html#a6">00231</a> <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a1">KeFlushMultipleTb</a> (
00232     IN ULONG Number,
00233     IN PVOID *Virtual,
00234     IN BOOLEAN Invalid,
00235     IN BOOLEAN AllProcessors,
00236     IN PHARDWARE_PTE *PtePointer OPTIONAL,
00237     IN HARDWARE_PTE PteValue
00238     )
00239 
00240 <span class="comment">/*++</span>
00241 <span class="comment"></span>
00242 <span class="comment">Routine Description:</span>
00243 <span class="comment"></span>
00244 <span class="comment">    This function flushes multiple entries from the translation buffer</span>
00245 <span class="comment">    on all processors that are currently running threads which are</span>
00246 <span class="comment">    children of the current process or flushes a multiple entries from</span>
00247 <span class="comment">    the translation buffer on all processors in the host configuration.</span>
00248 <span class="comment"></span>
00249 <span class="comment">Arguments:</span>
00250 <span class="comment"></span>
00251 <span class="comment">    Number - Supplies the number of TB entries to flush.</span>
00252 <span class="comment"></span>
00253 <span class="comment">    Virtual - Supplies a pointer to an array of virtual addresses that</span>
00254 <span class="comment">        are within the pages whose translation buffer entries are to be</span>
00255 <span class="comment">        flushed.</span>
00256 <span class="comment"></span>
00257 <span class="comment">    Invalid - Supplies a boolean value that specifies the reason for</span>
00258 <span class="comment">        flushing the translation buffer.</span>
00259 <span class="comment"></span>
00260 <span class="comment">    AllProcessors - Supplies a boolean value that determines which</span>
00261 <span class="comment">        translation buffers are to be flushed.</span>
00262 <span class="comment"></span>
00263 <span class="comment">    PtePointer - Supplies an optional pointer to an array of pointers to</span>
00264 <span class="comment">       page table entries that receive the specified page table entry</span>
00265 <span class="comment">       value.</span>
00266 <span class="comment"></span>
00267 <span class="comment">    PteValue - Supplies the the new page table entry value.</span>
00268 <span class="comment"></span>
00269 <span class="comment">Return Value:</span>
00270 <span class="comment"></span>
00271 <span class="comment">    The previous contents of the specified page table entry is returned</span>
00272 <span class="comment">    as the function value.</span>
00273 <span class="comment"></span>
00274 <span class="comment">--*/</span>
00275 
00276 {
00277 
00278     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00279     KIRQL OldIrql;
00280     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
00281     KAFFINITY TargetProcessors;
00282     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00283 
00284     <span class="comment">//</span>
00285     <span class="comment">// Compute the target set of processors and send the flush multiple</span>
00286     <span class="comment">// parameters to the target processors, if any, for execution.</span>
00287     <span class="comment">//</span>
00288 
00289     <span class="keywordflow">if</span> (AllProcessors != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00290         OldIrql = KeRaiseIrqlToSynchLevel();
00291         TargetProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a>;
00292 
00293     } <span class="keywordflow">else</span> {
00294         <a class="code" href="../../d0/d0/ki_8h.html#a11">KiLockContextSwap</a>(&amp;OldIrql);
00295         Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00296         Process = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>;
00297         TargetProcessors = Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o3">ActiveProcessors</a>;
00298         <span class="keywordflow">if</span> (TargetProcessors != Process-&gt;RunOnProcessors) {
00299             Process-&gt;ProcessSequence = KiMasterSequence - 1;
00300         }
00301     }
00302 
00303     <span class="comment">//</span>
00304     <span class="comment">// If a page table entry address address is specified, then set the</span>
00305     <span class="comment">// specified page table entries to the specific value.</span>
00306     <span class="comment">//</span>
00307 
00308     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PtePointer)) {
00309         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; Number; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00310             *PtePointer[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = PteValue;
00311         }
00312     }
00313 
00314     TargetProcessors &amp;= PCR-&gt;NotMember;
00315     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00316         <a class="code" href="../../d0/d0/ki_8h.html#a91">KiIpiSendPacket</a>(TargetProcessors,
00317                         <a class="code" href="../../d7/d5/alpha_2flushtb_8c.html#a1">KiFlushMultipleTbTarget</a>,
00318                         ULongToPtr(Number),
00319                         (PVOID)<a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>,
00320                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00321     }
00322 
00323     <a class="code" href="../../d0/d0/ki_8h.html#a21">IPI_INSTRUMENT_COUNT</a>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;Number, FlushMultipleTb);
00324 
00325     <span class="comment">//</span>
00326     <span class="comment">// Flush the specified entries from the TB on the current processor.</span>
00327     <span class="comment">//</span>
00328 
00329     <a class="code" href="../../d0/d0/ki_8h.html#a115">KiFlushMultipleTb</a>(Invalid, &amp;<a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>[0], Number);
00330 
00331     <span class="comment">//</span>
00332     <span class="comment">// Wait until all target processors have finished.</span>
00333     <span class="comment">//</span>
00334 
00335     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00336         <a class="code" href="../../d2/d1/xipi_8c.html#a2">KiIpiStallOnPacketTargets</a>(TargetProcessors);
00337     }
00338 
00339     <span class="comment">//</span>
00340     <span class="comment">// If the context swap lock was acquired, release it.</span>
00341     <span class="comment">//</span>
00342     <span class="keywordflow">if</span> (AllProcessors != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00343         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00344 
00345     } <span class="keywordflow">else</span> {
00346         <a class="code" href="../../d0/d0/ki_8h.html#a12">KiUnlockContextSwap</a>(OldIrql);
00347     }
00348 
00349     <span class="keywordflow">return</span>;
00350 }
00351 
00352 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00353"></a><a class="code" href="../../d7/d5/alpha_2flushtb_8c.html#a1">00353</a> <a class="code" href="../../d4/d1/xxflshtb_8c.html#a1">KiFlushMultipleTbTarget</a> (
00354     IN PKIPI_CONTEXT SignalDone,
00355     IN PVOID Number,
00356     IN PVOID Virtual,
00357     IN PVOID Pid
00358     )
00359 
00360 <span class="comment">/*++</span>
00361 <span class="comment"></span>
00362 <span class="comment">Routine Description:</span>
00363 <span class="comment"></span>
00364 <span class="comment">    This is the target function for flushing multiple TB entries.</span>
00365 <span class="comment"></span>
00366 <span class="comment">Arguments:</span>
00367 <span class="comment"></span>
00368 <span class="comment">    SignalDone Supplies a pointer to a variable that is cleared when the</span>
00369 <span class="comment">        requested operation has been performed.</span>
00370 <span class="comment"></span>
00371 <span class="comment">    Number - Supplies the number of TB entries to flush.</span>
00372 <span class="comment"></span>
00373 <span class="comment">    Virtual - Supplies a pointer to an array of virtual addresses that</span>
00374 <span class="comment">        are within the pages whose translation buffer entries are to be</span>
00375 <span class="comment">        flushed.</span>
00376 <span class="comment"></span>
00377 <span class="comment">    Pid - Supplies the PID of the TB entries to flush.</span>
00378 <span class="comment"></span>
00379 <span class="comment">Return Value:</span>
00380 <span class="comment"></span>
00381 <span class="comment">    None.</span>
00382 <span class="comment"></span>
00383 <span class="comment">--*/</span>
00384 
00385 {
00386 
00387     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00388     ULONG Limit;
00389     PVOID Array[FLUSH_MULTIPLE_MAXIMUM];
00390 
00391     <span class="comment">//</span>
00392     <span class="comment">// Flush multiple entries from the TB on the current processor</span>
00393     <span class="comment">//</span>
00394 
00395     <span class="comment">//</span>
00396     <span class="comment">// Capture the virtual addresses that are to be flushed from the TB</span>
00397     <span class="comment">// on the current processor and clear the packet address.</span>
00398     <span class="comment">//</span>
00399 
00400     Limit = (ULONG)((ULONG_PTR)Number);
00401     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; Limit; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00402         Array[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = ((PVOID *)(<a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>))[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00403     }
00404 
00405     <a class="code" href="../../d0/d0/ki_8h.html#a93">KiIpiSignalPacketDone</a>(SignalDone);
00406 
00407     <span class="comment">//</span>
00408     <span class="comment">// Flush the specified virtual addresses from the TB on the current</span>
00409     <span class="comment">// processor.</span>
00410     <span class="comment">//</span>
00411 
00412     <a class="code" href="../../d0/d0/ki_8h.html#a115">KiFlushMultipleTb</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, &amp;Array[0], Limit);
00413 
00414     <a class="code" href="../../d0/d0/ki_8h.html#a21">IPI_INSTRUMENT_COUNT</a>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;Number, FlushMultipleTb);
00415 
00416     <span class="keywordflow">return</span>;
00417 }
00418 
00419 HARDWARE_PTE
<a name="l00420"></a><a class="code" href="../../d7/d5/alpha_2flushtb_8c.html#a7">00420</a> <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (
00421     IN PVOID Virtual,
00422     IN BOOLEAN Invalid,
00423     IN BOOLEAN AllProcessors,
00424     IN PHARDWARE_PTE PtePointer,
00425     IN HARDWARE_PTE PteValue
00426     )
00427 
00428 <span class="comment">/*++</span>
00429 <span class="comment"></span>
00430 <span class="comment">Routine Description:</span>
00431 <span class="comment"></span>
00432 <span class="comment">    This function flushes a single entry from the translation buffer</span>
00433 <span class="comment">    on all processors that are currently running threads which are</span>
00434 <span class="comment">    children of the current process or flushes a single entry from</span>
00435 <span class="comment">    the translation buffer on all processors in the host configuration.</span>
00436 <span class="comment"></span>
00437 <span class="comment">Arguments:</span>
00438 <span class="comment"></span>
00439 <span class="comment">    Virtual - Supplies a virtual address that is within the page whose</span>
00440 <span class="comment">        translation buffer entry is to be flushed.</span>
00441 <span class="comment"></span>
00442 <span class="comment">    Invalid - Supplies a boolean value that specifies the reason for</span>
00443 <span class="comment">        flushing the translation buffer.</span>
00444 <span class="comment"></span>
00445 <span class="comment">    AllProcessors - Supplies a boolean value that determines which</span>
00446 <span class="comment">        translation buffers are to be flushed.</span>
00447 <span class="comment"></span>
00448 <span class="comment">    PtePointer - Supplies a pointer to the page table entry which</span>
00449 <span class="comment">        receives the specified value.</span>
00450 <span class="comment"></span>
00451 <span class="comment">    PteValue - Supplies the the new page table entry value.</span>
00452 <span class="comment"></span>
00453 <span class="comment">Return Value:</span>
00454 <span class="comment"></span>
00455 <span class="comment">    The previous contents of the specified page table entry is returned</span>
00456 <span class="comment">    as the function value.</span>
00457 <span class="comment"></span>
00458 <span class="comment">--*/</span>
00459 
00460 {
00461 
00462     KIRQL OldIrql;
00463     HARDWARE_PTE OldPte;
00464     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
00465     KAFFINITY TargetProcessors;
00466     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00467 
00468     <span class="comment">//</span>
00469     <span class="comment">// Compute the target set of processors and send the flush single</span>
00470     <span class="comment">// paramters to the target processors, if any, for execution.</span>
00471     <span class="comment">//</span>
00472 
00473     <span class="keywordflow">if</span> (AllProcessors != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00474         OldIrql = KeRaiseIrqlToSynchLevel();
00475         TargetProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a>;
00476 
00477     } <span class="keywordflow">else</span> {
00478         <a class="code" href="../../d0/d0/ki_8h.html#a11">KiLockContextSwap</a>(&amp;OldIrql);
00479         Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00480         Process = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>;
00481         TargetProcessors = Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o3">ActiveProcessors</a>;
00482         <span class="keywordflow">if</span> (TargetProcessors != Process-&gt;RunOnProcessors) {
00483             Process-&gt;ProcessSequence = KiMasterSequence - 1;
00484         }
00485     }
00486 
00487     <span class="comment">//</span>
00488     <span class="comment">// Capture the previous contents of the page table entry and set the</span>
00489     <span class="comment">// page table entry to the new value.</span>
00490     <span class="comment">//</span>
00491 
00492     OldPte = *PtePointer;
00493     *PtePointer = PteValue;
00494     TargetProcessors &amp;= PCR-&gt;NotMember;
00495     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00496         <a class="code" href="../../d0/d0/ki_8h.html#a91">KiIpiSendPacket</a>(TargetProcessors,
00497                         <a class="code" href="../../d7/d5/alpha_2flushtb_8c.html#a2">KiFlushSingleTbTarget</a>,
00498                         (PVOID)<a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>,
00499                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00500                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00501     }
00502 
00503     <a class="code" href="../../d0/d0/ki_8h.html#a21">IPI_INSTRUMENT_COUNT</a>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;Number, FlushSingleTb);
00504 
00505     <span class="comment">//</span>
00506     <span class="comment">// Flush the specified entry from the TB on the current processor.</span>
00507     <span class="comment">//</span>
00508 
00509 <span class="comment">//    KiFlushSingleTb(Invalid, Virtual);</span>
00510     __tbis(<a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>);
00511 
00512     <span class="comment">//</span>
00513     <span class="comment">// Wait until all target processors have finished.</span>
00514     <span class="comment">//</span>
00515 
00516     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00517         <a class="code" href="../../d2/d1/xipi_8c.html#a2">KiIpiStallOnPacketTargets</a>(TargetProcessors);
00518     }
00519 
00520     <span class="keywordflow">if</span> (AllProcessors != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00521         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00522 
00523     } <span class="keywordflow">else</span> {
00524         <a class="code" href="../../d0/d0/ki_8h.html#a12">KiUnlockContextSwap</a>(OldIrql);
00525     }
00526 
00527     <span class="comment">//</span>
00528     <span class="comment">// return the previous page table entry value.</span>
00529     <span class="comment">//</span>
00530 
00531     <span class="keywordflow">return</span> OldPte;
00532 }
00533 
00534 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00535"></a><a class="code" href="../../d7/d5/alpha_2flushtb_8c.html#a2">00535</a> <a class="code" href="../../d4/d1/xxflshtb_8c.html#a2">KiFlushSingleTbTarget</a> (
00536     IN PKIPI_CONTEXT SignalDone,
00537     IN PVOID Virtual,
00538     IN PVOID Pid,
00539     IN PVOID Parameter3
00540     )
00541 
00542 <span class="comment">/*++</span>
00543 <span class="comment"></span>
00544 <span class="comment">Routine Description:</span>
00545 <span class="comment"></span>
00546 <span class="comment">    This is the target function for flushing a single TB entry.</span>
00547 <span class="comment"></span>
00548 <span class="comment">Arguments:</span>
00549 <span class="comment"></span>
00550 <span class="comment">    SignalDone Supplies a pointer to a variable that is cleared when the</span>
00551 <span class="comment">        requested operation has been performed.</span>
00552 <span class="comment"></span>
00553 <span class="comment">    Virtual - Supplies a virtual address that is within the page whose</span>
00554 <span class="comment">        translation buffer entry is to be flushed.</span>
00555 <span class="comment"></span>
00556 <span class="comment">    RequestPacket - Supplies a pointer to a flush single TB packet address.</span>
00557 <span class="comment"></span>
00558 <span class="comment">    Pid - Supplies the PID of the TB entries to flush.</span>
00559 <span class="comment"></span>
00560 <span class="comment">    Parameter3 - Not used.</span>
00561 <span class="comment"></span>
00562 <span class="comment">Return Value:</span>
00563 <span class="comment"></span>
00564 <span class="comment">    None.</span>
00565 <span class="comment"></span>
00566 <span class="comment">--*/</span>
00567 
00568 {
00569 
00570     <span class="comment">//</span>
00571     <span class="comment">// Flush a single entry form the TB on the current processor.</span>
00572     <span class="comment">//</span>
00573 
00574     <a class="code" href="../../d0/d0/ki_8h.html#a93">KiIpiSignalPacketDone</a>(SignalDone);
00575 <span class="comment">//    KiFlushSingleTb(TRUE, Virtual);</span>
00576     __tbis(<a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>);
00577 
00578     <a class="code" href="../../d0/d0/ki_8h.html#a21">IPI_INSTRUMENT_COUNT</a>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;Number, FlushSingleTb);
00579 
00580     <span class="keywordflow">return</span>;
00581 }
00582 
00583 <span class="preprocessor">#endif // !defined(NT_UP)</span>
00584 <span class="preprocessor"></span>
00585 
00586 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00587"></a><a class="code" href="../../d7/d5/alpha_2flushtb_8c.html#a8">00587</a> <a class="code" href="../../d4/d1/xxflshtb_8c.html#a7">KeFlushMultipleTb64</a> (
00588     IN ULONG Number,
00589     IN PULONG_PTR Virtual,
00590     IN BOOLEAN Invalid,
00591     IN BOOLEAN AllProcessors,
00592     IN PHARDWARE_PTE *PtePointer OPTIONAL,
00593     IN HARDWARE_PTE PteValue
00594     )
00595 
00596 <span class="comment">/*++</span>
00597 <span class="comment"></span>
00598 <span class="comment">Routine Description:</span>
00599 <span class="comment"></span>
00600 <span class="comment">    This function flushes multiple entries from the translation buffer</span>
00601 <span class="comment">    on all processors that are currently running threads which are</span>
00602 <span class="comment">    children of the current process or flushes a multiple entries from</span>
00603 <span class="comment">    the translation buffer on all processors in the host configuration.</span>
00604 <span class="comment"></span>
00605 <span class="comment">Arguments:</span>
00606 <span class="comment"></span>
00607 <span class="comment">    Number - Supplies the number of TB entries to flush.</span>
00608 <span class="comment"></span>
00609 <span class="comment">    Virtual - Supplies a pointer to an array of virtual page numbers that</span>
00610 <span class="comment">        are flushed from the TB.</span>
00611 <span class="comment"></span>
00612 <span class="comment">    Invalid - Supplies a boolean value that specifies the reason for</span>
00613 <span class="comment">        flushing the translation buffer.</span>
00614 <span class="comment"></span>
00615 <span class="comment">    AllProcessors - Supplies a boolean value that determines which</span>
00616 <span class="comment">        translation buffers are to be flushed.</span>
00617 <span class="comment"></span>
00618 <span class="comment">    PtePointer - Supplies an optional pointer to an array of pointers to</span>
00619 <span class="comment">       page table entries that receive the specified page table entry</span>
00620 <span class="comment">       value.</span>
00621 <span class="comment"></span>
00622 <span class="comment">    PteValue - Supplies the the new page table entry value.</span>
00623 <span class="comment"></span>
00624 <span class="comment">Return Value:</span>
00625 <span class="comment"></span>
00626 <span class="comment">    The previous contents of the specified page table entry is returned</span>
00627 <span class="comment">    as the function value.</span>
00628 <span class="comment"></span>
00629 <span class="comment">--*/</span>
00630 
00631 {
00632 
00633     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00634     KIRQL OldIrql;
00635     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
00636     KAFFINITY TargetProcessors;
00637     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00638 
00639     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Number &lt;= FLUSH_MULTIPLE_MAXIMUM);
00640 
00641     <span class="comment">//</span>
00642     <span class="comment">// Compute the target set of processors.</span>
00643     <span class="comment">//</span>
00644 
00645 <span class="preprocessor">#if defined(NT_UP)</span>
00646 <span class="preprocessor"></span>
00647     OldIrql = KeRaiseIrqlToSynchLevel();
00648 
00649 <span class="preprocessor">#else</span>
00650 <span class="preprocessor"></span>
00651     <span class="keywordflow">if</span> (AllProcessors != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00652         OldIrql = KeRaiseIrqlToSynchLevel();
00653         TargetProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a>;
00654 
00655     } <span class="keywordflow">else</span> {
00656         <a class="code" href="../../d0/d0/ki_8h.html#a11">KiLockContextSwap</a>(&amp;OldIrql);
00657         Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00658         Process = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>;
00659         TargetProcessors = Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o3">ActiveProcessors</a>;
00660         <span class="keywordflow">if</span> (TargetProcessors != Process-&gt;RunOnProcessors) {
00661             Process-&gt;ProcessSequence = KiMasterSequence - 1;
00662         }
00663     }
00664 
00665     TargetProcessors &amp;= PCR-&gt;NotMember;
00666 
00667 <span class="preprocessor">#endif</span>
00668 <span class="preprocessor"></span>
00669     <span class="comment">//</span>
00670     <span class="comment">// If a page table entry address array is specified, then set the</span>
00671     <span class="comment">// specified page table entries to the specific value.</span>
00672     <span class="comment">//</span>
00673 
00674     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PtePointer)) {
00675         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; Number; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00676             *PtePointer[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = PteValue;
00677         }
00678     }
00679 
00680     <span class="comment">//</span>
00681     <span class="comment">// If any target processors are specified, then send a flush multiple</span>
00682     <span class="comment">// packet to the target set of processor.</span>
00683     <span class="comment">//</span>
00684 
00685 <span class="preprocessor">#if !defined(NT_UP)</span>
00686 <span class="preprocessor"></span>
00687     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00688         <a class="code" href="../../d0/d0/ki_8h.html#a91">KiIpiSendPacket</a>(TargetProcessors,
00689                         <a class="code" href="../../d7/d5/alpha_2flushtb_8c.html#a3">KiFlushMultipleTbTarget64</a>,
00690                         ULongToPtr(Number),
00691                         (PVOID)<a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>,
00692                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00693     }
00694 
00695 <span class="preprocessor">#endif</span>
00696 <span class="preprocessor"></span>
00697     <span class="comment">//</span>
00698     <span class="comment">// Flush the specified entries from the TB on the current processor.</span>
00699     <span class="comment">//</span>
00700 
00701     KiFlushMultipleTb64(Invalid, &amp;<a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>[0], Number);
00702 
00703     <span class="comment">//</span>
00704     <span class="comment">// Wait until all target processors have finished.</span>
00705     <span class="comment">//</span>
00706 
00707 <span class="preprocessor">#if defined(NT_UP)</span>
00708 <span class="preprocessor"></span>
00709     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00710 
00711 <span class="preprocessor">#else</span>
00712 <span class="preprocessor"></span>
00713     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00714         <a class="code" href="../../d2/d1/xipi_8c.html#a2">KiIpiStallOnPacketTargets</a>(TargetProcessors);
00715     }
00716 
00717     <span class="keywordflow">if</span> (AllProcessors != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00718         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00719 
00720     } <span class="keywordflow">else</span> {
00721         <a class="code" href="../../d0/d0/ki_8h.html#a12">KiUnlockContextSwap</a>(OldIrql);
00722     }
00723 
00724 <span class="preprocessor">#endif</span>
00725 <span class="preprocessor"></span>
00726     <span class="keywordflow">return</span>;
00727 }
00728 
00729 <span class="preprocessor">#if !defined(NT_UP)</span>
00730 <span class="preprocessor"></span>
00731 
00732 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00733"></a><a class="code" href="../../d7/d5/alpha_2flushtb_8c.html#a3">00733</a> <a class="code" href="../../d4/d1/xxflshtb_8c.html#a3">KiFlushMultipleTbTarget64</a> (
00734     IN PKIPI_CONTEXT SignalDone,
00735     IN PVOID Number,
00736     IN PVOID Virtual,
00737     IN PVOID Pid
00738     )
00739 
00740 <span class="comment">/*++</span>
00741 <span class="comment"></span>
00742 <span class="comment">Routine Description:</span>
00743 <span class="comment"></span>
00744 <span class="comment">    This is the target function for flushing multiple TB entries.</span>
00745 <span class="comment"></span>
00746 <span class="comment">Arguments:</span>
00747 <span class="comment"></span>
00748 <span class="comment">    SignalDone Supplies a pointer to a variable that is cleared when the</span>
00749 <span class="comment">        requested operation has been performed.</span>
00750 <span class="comment"></span>
00751 <span class="comment">    Number - Supplies the number of TB entries to flush.</span>
00752 <span class="comment"></span>
00753 <span class="comment">    Virtual - Supplies a pointer to an array of virtual page numbers that</span>
00754 <span class="comment">        are flushed from the TB.</span>
00755 <span class="comment"></span>
00756 <span class="comment">    Pid - Supplies the PID of the TB entries to flush.</span>
00757 <span class="comment"></span>
00758 <span class="comment">Return Value:</span>
00759 <span class="comment"></span>
00760 <span class="comment">    None.</span>
00761 <span class="comment"></span>
00762 <span class="comment">--*/</span>
00763 
00764 {
00765 
00766     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00767     ULONG Limit;
00768     ULONG_PTR Array[FLUSH_MULTIPLE_MAXIMUM];
00769 
00770     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((ULONG_PTR)Number &lt;= FLUSH_MULTIPLE_MAXIMUM);
00771 
00772     <span class="comment">//</span>
00773     <span class="comment">// Capture the virtual addresses that are to be flushed from the TB</span>
00774     <span class="comment">// on the current processor and clear the packet address.</span>
00775     <span class="comment">//</span>
00776 
00777     Limit = (ULONG)((ULONG_PTR)Number);
00778     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; Limit; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00779         Array[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = ((PULONG_PTR)(<a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>))[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00780     }
00781 
00782     <a class="code" href="../../d0/d0/ki_8h.html#a93">KiIpiSignalPacketDone</a>(SignalDone);
00783 
00784     <span class="comment">//</span>
00785     <span class="comment">// Flush the specified virtual addresses from the TB on the current</span>
00786     <span class="comment">// processor.</span>
00787     <span class="comment">//</span>
00788 
00789     KiFlushMultipleTb64(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, &amp;Array[0], Limit);
00790     <span class="keywordflow">return</span>;
00791 }
00792 
00793 <span class="preprocessor">#endif</span>
00794 <span class="preprocessor"></span>
00795 
00796 HARDWARE_PTE
<a name="l00797"></a><a class="code" href="../../d7/d5/alpha_2flushtb_8c.html#a9">00797</a> <a class="code" href="../../d4/d1/xxflshtb_8c.html#a9">KeFlushSingleTb64</a> (
00798     IN ULONG_PTR Virtual,
00799     IN BOOLEAN Invalid,
00800     IN BOOLEAN AllProcessors,
00801     IN PHARDWARE_PTE PtePointer,
00802     IN HARDWARE_PTE PteValue
00803     )
00804 
00805 <span class="comment">/*++</span>
00806 <span class="comment"></span>
00807 <span class="comment">Routine Description:</span>
00808 <span class="comment"></span>
00809 <span class="comment">    This function flushes a single entry from the translation buffer</span>
00810 <span class="comment">    on all processors that are currently running threads which are</span>
00811 <span class="comment">    children of the current process or flushes a single entry from</span>
00812 <span class="comment">    the translation buffer on all processors in the host configuration.</span>
00813 <span class="comment"></span>
00814 <span class="comment">Arguments:</span>
00815 <span class="comment"></span>
00816 <span class="comment">    Virtual - Supplies a virtual page number that is flushed from the TB.</span>
00817 <span class="comment"></span>
00818 <span class="comment">    Invalid - Supplies a boolean value that specifies the reason for</span>
00819 <span class="comment">        flushing the translation buffer.</span>
00820 <span class="comment"></span>
00821 <span class="comment">    AllProcessors - Supplies a boolean value that determines which</span>
00822 <span class="comment">        translation buffers are to be flushed.</span>
00823 <span class="comment"></span>
00824 <span class="comment">    PtePointer - Supplies a pointer to the page table entry which</span>
00825 <span class="comment">        receives the specified value.</span>
00826 <span class="comment"></span>
00827 <span class="comment">    PteValue - Supplies the the new page table entry value.</span>
00828 <span class="comment"></span>
00829 <span class="comment">Return Value:</span>
00830 <span class="comment"></span>
00831 <span class="comment">    The previous contents of the specified page table entry is returned</span>
00832 <span class="comment">    as the function value.</span>
00833 <span class="comment"></span>
00834 <span class="comment">--*/</span>
00835 
00836 {
00837 
00838     KIRQL OldIrql;
00839     HARDWARE_PTE OldPte;
00840     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
00841     KAFFINITY TargetProcessors;
00842     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00843 
00844     <span class="comment">//</span>
00845     <span class="comment">// Compute the target set of processors.</span>
00846     <span class="comment">//</span>
00847 
00848 <span class="preprocessor">#if defined(NT_UP)</span>
00849 <span class="preprocessor"></span>
00850     OldIrql = KeRaiseIrqlToSynchLevel();
00851 
00852 <span class="preprocessor">#else</span>
00853 <span class="preprocessor"></span>
00854     <span class="keywordflow">if</span> (AllProcessors != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00855         OldIrql = KeRaiseIrqlToSynchLevel();
00856         TargetProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a>;
00857 
00858     } <span class="keywordflow">else</span> {
00859         <a class="code" href="../../d0/d0/ki_8h.html#a11">KiLockContextSwap</a>(&amp;OldIrql);
00860         Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00861         Process = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>;
00862         TargetProcessors = Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o3">ActiveProcessors</a>;
00863         <span class="keywordflow">if</span> (TargetProcessors != Process-&gt;RunOnProcessors) {
00864             Process-&gt;ProcessSequence = KiMasterSequence - 1;
00865         }
00866     }
00867 
00868     TargetProcessors &amp;= PCR-&gt;NotMember;
00869 
00870 <span class="preprocessor">#endif</span>
00871 <span class="preprocessor"></span>
00872     <span class="comment">//</span>
00873     <span class="comment">// Capture the previous contents of the page table entry and set the</span>
00874     <span class="comment">// page table entry to the new value.</span>
00875     <span class="comment">//</span>
00876 
00877     OldPte = *PtePointer;
00878     *PtePointer = PteValue;
00879 
00880     <span class="comment">//</span>
00881     <span class="comment">// If any target processors are specified, then send a flush single</span>
00882     <span class="comment">// packet to the target set of processors.</span>
00883 
00884 <span class="preprocessor">#if !defined(NT_UP)</span>
00885 <span class="preprocessor"></span>
00886     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00887         <a class="code" href="../../d0/d0/ki_8h.html#a91">KiIpiSendPacket</a>(TargetProcessors,
00888                         <a class="code" href="../../d7/d5/alpha_2flushtb_8c.html#a4">KiFlushSingleTbTarget64</a>,
00889                         (PVOID)<a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>,
00890                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00891                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00892     }
00893 
00894 <span class="preprocessor">#endif</span>
00895 <span class="preprocessor"></span>
00896     <span class="comment">//</span>
00897     <span class="comment">// Flush the specified entry from the TB on the current processor.</span>
00898     <span class="comment">//</span>
00899 
00900     KiFlushSingleTb64(Invalid, <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>);
00901 
00902     <span class="comment">//</span>
00903     <span class="comment">// Wait until all target processors have finished.</span>
00904     <span class="comment">//</span>
00905 
00906 <span class="preprocessor">#if defined(NT_UP)</span>
00907 <span class="preprocessor"></span>
00908     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00909 
00910 <span class="preprocessor">#else</span>
00911 <span class="preprocessor"></span>
00912     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00913         <a class="code" href="../../d2/d1/xipi_8c.html#a2">KiIpiStallOnPacketTargets</a>(TargetProcessors);
00914     }
00915 
00916     <span class="keywordflow">if</span> (AllProcessors != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00917         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00918 
00919     } <span class="keywordflow">else</span> {
00920         <a class="code" href="../../d0/d0/ki_8h.html#a12">KiUnlockContextSwap</a>(OldIrql);
00921     }
00922 
00923 <span class="preprocessor">#endif</span>
00924 <span class="preprocessor"></span>
00925     <span class="keywordflow">return</span> OldPte;
00926 }
00927 
00928 <span class="preprocessor">#if !defined(NT_UP)</span>
00929 <span class="preprocessor"></span>
00930 
00931 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00932"></a><a class="code" href="../../d7/d5/alpha_2flushtb_8c.html#a4">00932</a> <a class="code" href="../../d4/d1/xxflshtb_8c.html#a4">KiFlushSingleTbTarget64</a> (
00933     IN PKIPI_CONTEXT SignalDone,
00934     IN PVOID Virtual,
00935     IN PVOID Pid,
00936     IN PVOID Parameter3
00937     )
00938 
00939 <span class="comment">/*++</span>
00940 <span class="comment"></span>
00941 <span class="comment">Routine Description:</span>
00942 <span class="comment"></span>
00943 <span class="comment">    This is the target function for flushing a single TB entry.</span>
00944 <span class="comment"></span>
00945 <span class="comment">Arguments:</span>
00946 <span class="comment"></span>
00947 <span class="comment">    SignalDone Supplies a pointer to a variable that is cleared when the</span>
00948 <span class="comment">        requested operation has been performed.</span>
00949 <span class="comment"></span>
00950 <span class="comment">    Virtual - Supplies a virtual page number that is flushed from the TB.</span>
00951 <span class="comment"></span>
00952 <span class="comment">    RequestPacket - Supplies a pointer to a flush single TB packet address.</span>
00953 <span class="comment"></span>
00954 <span class="comment">    Pid - Not used.</span>
00955 <span class="comment"></span>
00956 <span class="comment">    Parameter3 - Not used.</span>
00957 <span class="comment"></span>
00958 <span class="comment">Return Value:</span>
00959 <span class="comment"></span>
00960 <span class="comment">    None.</span>
00961 <span class="comment"></span>
00962 <span class="comment">--*/</span>
00963 
00964 {
00965 
00966     <span class="comment">//</span>
00967     <span class="comment">// Flush a single entry form the TB on the current processor.</span>
00968     <span class="comment">//</span>
00969 
00970     <a class="code" href="../../d0/d0/ki_8h.html#a93">KiIpiSignalPacketDone</a>(SignalDone);
00971     KiFlushSingleTb64(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, (ULONG_PTR)<a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>);
00972     <span class="keywordflow">return</span>;
00973 }
00974 
00975 <span class="preprocessor">#endif</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:02 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
