<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: pfnlist.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>pfnlist.c</h1><a href="../../d7/d5/pfnlist_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">   pfnlist.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the routines to manipulate pages within the</span>
00012 <span class="comment">    Page Frame Database.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Lou Perazzoli (loup) 4-Apr-1989</span>
00017 <span class="comment">    Landy Wang (landyw) 02-June-1997</span>
00018 <span class="comment"></span>
00019 <span class="comment">Revision History:</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00023 
<a name="l00024"></a><a class="code" href="../../d7/d5/pfnlist_8c.html#a0">00024</a> <span class="preprocessor">#define MM_LOW_LIMIT 2</span>
<a name="l00025"></a><a class="code" href="../../d7/d5/pfnlist_8c.html#a1">00025</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_HIGH_LIMIT 19</span>
00026 <span class="preprocessor"></span>
<a name="l00027"></a><a class="code" href="../../d7/d5/pfnlist_8c.html#a4">00027</a> <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d4/d8/mi_8h.html#a610">MmAvailablePagesEventHigh</a>;
00028 
<a name="l00029"></a><a class="code" href="../../d7/d5/pfnlist_8c.html#a5">00029</a> ULONG <a class="code" href="../../d7/d5/pfnlist_8c.html#a5">MmTransitionPrivatePages</a>;
<a name="l00030"></a><a class="code" href="../../d7/d5/pfnlist_8c.html#a6">00030</a> ULONG <a class="code" href="../../d6/d8/sysinfo_8c.html#a22">MmTransitionSharedPages</a>;
00031 
<a name="l00032"></a><a class="code" href="../../d7/d5/pfnlist_8c.html#a2">00032</a> <span class="preprocessor">#define MI_TALLY_TRANSITION_PAGE_ADDITION(Pfn) \</span>
00033 <span class="preprocessor">    if (Pfn-&gt;u3.e1.PrototypePte) { \</span>
00034 <span class="preprocessor">        MmTransitionSharedPages += 1; \</span>
00035 <span class="preprocessor">    } \</span>
00036 <span class="preprocessor">    else { \</span>
00037 <span class="preprocessor">        MmTransitionPrivatePages += 1; \</span>
00038 <span class="preprocessor">    } \</span>
00039 <span class="preprocessor">    ASSERT (MmTransitionPrivatePages + MmTransitionSharedPages == MmStandbyPageListHead.Total + MmModifiedPageListHead.Total + MmModifiedNoWritePageListHead.Total);</span>
00040 <span class="preprocessor"></span>
<a name="l00041"></a><a class="code" href="../../d7/d5/pfnlist_8c.html#a3">00041</a> <span class="preprocessor">#define MI_TALLY_TRANSITION_PAGE_REMOVAL(Pfn) \</span>
00042 <span class="preprocessor">    if (Pfn-&gt;u3.e1.PrototypePte) { \</span>
00043 <span class="preprocessor">        MmTransitionSharedPages -= 1; \</span>
00044 <span class="preprocessor">    } \</span>
00045 <span class="preprocessor">    else { \</span>
00046 <span class="preprocessor">        MmTransitionPrivatePages -= 1; \</span>
00047 <span class="preprocessor">    } \</span>
00048 <span class="preprocessor">    ASSERT (MmTransitionPrivatePages + MmTransitionSharedPages == MmStandbyPageListHead.Total + MmModifiedPageListHead.Total + MmModifiedNoWritePageListHead.Total);</span>
00049 <span class="preprocessor"></span>
00050 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00051 <a class="code" href="../../d7/d5/pfnlist_8c.html#a7">MiRemovePageByColor</a> (
00052     IN PFN_NUMBER Page,
00053     IN ULONG PageColor
00054     );
00055 
00056 
00057 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00058 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00059"></a><a class="code" href="../../d7/d5/pfnlist_8c.html#a8">00059</a> <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (
00060     IN <a class="code" href="../../d0/d4/struct__MMPFNLIST.html">PMMPFNLIST</a> ListHead,
00061     IN PFN_NUMBER PageFrameIndex
00062     )
00063 
00064 <span class="comment">/*++</span>
00065 <span class="comment"></span>
00066 <span class="comment">Routine Description:</span>
00067 <span class="comment"></span>
00068 <span class="comment">    This procedure inserts a page at the end of the specified list (free,</span>
00069 <span class="comment">    standby, bad, zeroed, modified).</span>
00070 <span class="comment"></span>
00071 <span class="comment"></span>
00072 <span class="comment">Arguments:</span>
00073 <span class="comment"></span>
00074 <span class="comment">    ListHead - Supplies the list of the list in which to insert the</span>
00075 <span class="comment">               specified physical page.</span>
00076 <span class="comment"></span>
00077 <span class="comment">    PageFrameIndex - Supplies the physical page number to insert in the</span>
00078 <span class="comment">                     list.</span>
00079 <span class="comment"></span>
00080 <span class="comment">Return Value:</span>
00081 <span class="comment"></span>
00082 <span class="comment">    none.</span>
00083 <span class="comment"></span>
00084 <span class="comment">Environment:</span>
00085 <span class="comment"></span>
00086 <span class="comment">    Must be holding the PFN database mutex with APCs disabled.</span>
00087 <span class="comment"></span>
00088 <span class="comment">--*/</span>
00089 
00090 {
00091     PFN_NUMBER last;
00092     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00093     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
00094     ULONG Color;
00095 
00096     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
00097     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((PageFrameIndex != 0) &amp;&amp;
00098             (PageFrameIndex &lt;= <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) &amp;&amp;
00099             (PageFrameIndex &gt;= <a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>));
00100 
00101     <span class="comment">//</span>
00102     <span class="comment">// Check to ensure the reference count for the page is zero.</span>
00103     <span class="comment">//</span>
00104 
00105     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageFrameIndex);
00106 
00107     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.LockCharged == 0);
00108 
00109     <a class="code" href="../../d2/d1/mm_8h.html#a67">PERFINFO_INSERTINLIST</a>(PageFrameIndex, ListHead);
00110 
00111 <span class="preprocessor">#if DBG</span>
00112 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a80">MM_DBG_PAGE_REF_COUNT</a>) {
00113 
00114         <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00115         KIRQL OldIrql = 99;
00116 
00117         <span class="keywordflow">if</span> ((ListHead-&gt;ListName == <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>) ||
00118             (ListHead-&gt;ListName == <a class="code" href="../../d2/d1/mm_8h.html#a345a174">ModifiedPageList</a>)) {
00119 
00120             <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte == 1)  &amp;&amp;
00121                     (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>))) {
00122                 PointerPte = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>;
00123             } <span class="keywordflow">else</span> {
00124 
00125                 <span class="comment">//</span>
00126                 <span class="comment">// The page containing the prototype PTE is not valid,</span>
00127                 <span class="comment">// map the page into hyperspace and reference it that way.</span>
00128                 <span class="comment">//</span>
00129 
00130                 PointerPte = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>, &amp;OldIrql);
00131                 PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)((PCHAR)PointerPte +
00132                                         <a class="code" href="../../d4/d8/mi_8h.html#a110">MiGetByteOffset</a>(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>));
00133             }
00134 
00135             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a> (PointerPte) == PageFrameIndex) ||
00136                     (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte) == PageFrameIndex));
00137             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;u.Soft.Transition == 1);
00138             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;u.Soft.Prototype == 0);
00139             <span class="keywordflow">if</span> (OldIrql != 99) {
00140                 <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql)
00141             }
00142         }
00143     }
00144 <span class="preprocessor">#endif</span>
00145 <span class="preprocessor"></span>
00146 <span class="preprocessor">#if PFN_CONSISTENCY</span>
00147 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (ListHead == &amp;<a class="code" href="../../d8/d5/kddata_8c.html#a37">MmFreePageListHead</a>) {
00148         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount != 0) {
00149             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (PFN_LIST_CORRUPT,
00150                           0x91,
00151                           PageFrameIndex,
00152                           Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount,
00153                           Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount);
00154         }
00155     }
00156     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ListHead == &amp;<a class="code" href="../../d8/d5/kddata_8c.html#a36">MmZeroedPageListHead</a>) {
00157         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount != 0) {
00158             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (PFN_LIST_CORRUPT,
00159                           0x92,
00160                           PageFrameIndex,
00161                           Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount,
00162                           Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount);
00163         }
00164     }
00165 <span class="preprocessor">#endif</span>
00166 <span class="preprocessor"></span>
00167 <span class="preprocessor">#if DBG</span>
00168 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((ListHead-&gt;ListName == <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>) ||
00169         (ListHead-&gt;ListName == <a class="code" href="../../d2/d1/mm_8h.html#a345a174">ModifiedPageList</a>)) {
00170         <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
00171            (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1)) {
00172             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT, 0x8888, 0,0,0);
00173         }
00174     }
00175 <span class="preprocessor">#endif</span>
00176 <span class="preprocessor"></span>
00177     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
00178 
00179     ListHead-&gt;Total += 1;  <span class="comment">// One more page on the list.</span>
00180 
00181     <span class="comment">//</span>
00182     <span class="comment">// On MIPS R4000 modified pages destined for the paging file are</span>
00183     <span class="comment">// kept on separate lists which group pages of the same color</span>
00184     <span class="comment">// together</span>
00185     <span class="comment">//</span>
00186 
00187     <span class="keywordflow">if</span> (ListHead == &amp;<a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>) {
00188 
00189 <span class="preprocessor">#if PFN_CONSISTENCY</span>
00190 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount != 0) {
00191             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (PFN_LIST_CORRUPT,
00192                           0x90,
00193                           PageFrameIndex,
00194                           Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount,
00195                           Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount);
00196         }
00197 <span class="preprocessor">#endif</span>
00198 <span class="preprocessor"></span>
00199         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) {
00200 
00201             <span class="comment">//</span>
00202             <span class="comment">// This page is destined for the paging file (not</span>
00203             <span class="comment">// a mapped file).  Change the list head to the</span>
00204             <span class="comment">// appropriate colored list head.</span>
00205             <span class="comment">//</span>
00206 
00207             ListHead = &amp;<a class="code" href="../../d4/d2/datalpha_8c.html#a21">MmModifiedPageListByColor</a> [Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor];
00208             ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> += 1;
00209             <a class="code" href="../../d4/d2/datalpha_8c.html#a23">MmTotalPagesForPagingFile</a> += 1;
00210         }
00211         <span class="keywordflow">else</span> {
00212 
00213             <span class="comment">//</span>
00214             <span class="comment">// This page is destined for a mapped file (not</span>
00215             <span class="comment">// the paging file).  If there are no other pages currently</span>
00216             <span class="comment">// destined for the mapped file, start our timer so that we can</span>
00217             <span class="comment">// ensure that these pages make it to disk even if we don't pile</span>
00218             <span class="comment">// up enough of them to trigger the modified page writer or need</span>
00219             <span class="comment">// the memory.  If we don't do this here, then for this scenario,</span>
00220             <span class="comment">// only an orderly system shutdown will write them out (days,</span>
00221             <span class="comment">// weeks, months or years later) and any power out in between</span>
00222             <span class="comment">// means we'll have lost the data.</span>
00223             <span class="comment">//</span>
00224 
00225             <span class="keywordflow">if</span> (ListHead-&gt;Total - <a class="code" href="../../d4/d2/datalpha_8c.html#a23">MmTotalPagesForPagingFile</a> == 1) {
00226 
00227                 <span class="comment">//</span>
00228                 <span class="comment">// Start the DPC timer because we're the first on the list.</span>
00229                 <span class="comment">//</span>
00230 
00231                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a735">MiTimerPending</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00232                     <a class="code" href="../../d4/d8/mi_8h.html#a735">MiTimerPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00233 
00234                     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d3/d2/timerobj_8c.html#a7">KeSetTimerEx</a>( &amp;<a class="code" href="../../d4/d8/mi_8h.html#a738">MiModifiedPageWriterTimer</a>, <a class="code" href="../../d4/d8/mi_8h.html#a734">MiModifiedPageLife</a>, 0, &amp;<a class="code" href="../../d4/d8/mi_8h.html#a737">MiModifiedPageWriterTimerDpc</a> );
00235                 }
00236             }
00237         }
00238     }
00239     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.RemovalRequested == 1) &amp;&amp;
00240              (ListHead-&gt;ListName &lt;= <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>)) {
00241 
00242         ListHead-&gt;Total -= 1;  <span class="comment">// Undo previous increment</span>
00243 
00244         <span class="keywordflow">if</span> (ListHead-&gt;ListName == <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>) {
00245             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>;
00246             <a class="code" href="../../d0/d2/mmsup_8c.html#a15">MiRestoreTransitionPte</a> (PageFrameIndex);
00247         }
00248 
00249         ListHead = <a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a176">BadPageList</a>];
00250         ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> += 1;  <span class="comment">// One more page on the list.</span>
00251     }
00252 
00253 
00254     last = ListHead-&gt;Blink;
00255     <span class="keywordflow">if</span> (last == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
00256 
00257         <span class="comment">//</span>
00258         <span class="comment">// List is empty add the page to the ListHead.</span>
00259         <span class="comment">//</span>
00260 
00261         ListHead-&gt;Flink = PageFrameIndex;
00262     } <span class="keywordflow">else</span> {
00263         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (last);
00264         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink = PageFrameIndex;
00265     }
00266 
00267     ListHead-&gt;Blink = PageFrameIndex;
00268     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
00269     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = last;
00270     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = ListHead-&gt;ListName;
00271 
00272     <span class="comment">//</span>
00273     <span class="comment">// If the page was placed on the free, standby or zeroed list,</span>
00274     <span class="comment">// update the count of usable pages in the system.  If the count</span>
00275     <span class="comment">// transitions from 0 to 1, the event associated with available</span>
00276     <span class="comment">// pages should become true.</span>
00277     <span class="comment">//</span>
00278 
00279     <span class="keywordflow">if</span> (ListHead-&gt;ListName &lt;= <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>) {
00280         <a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> += 1;
00281 
00282         <span class="comment">//</span>
00283         <span class="comment">// A page has just become available, check to see if the</span>
00284         <span class="comment">// page wait events should be signalled.</span>
00285         <span class="comment">//</span>
00286 
00287         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> == <a class="code" href="../../d7/d5/pfnlist_8c.html#a0">MM_LOW_LIMIT</a>) {
00288             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a609">MmAvailablePagesEvent</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00289         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> == <a class="code" href="../../d7/d5/pfnlist_8c.html#a1">MM_HIGH_LIMIT</a>) {
00290             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a610">MmAvailablePagesEventHigh</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00291         }
00292 
00293         <span class="keywordflow">if</span> (ListHead-&gt;ListName &lt;= <a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>) {
00294 
00295             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.InPageError == 0);
00296 
00297             <span class="comment">//</span>
00298             <span class="comment">// We are adding a page to the free or zeroed page list.</span>
00299             <span class="comment">// Add the page to the end of the correct colored page list.</span>
00300             <span class="comment">//</span>
00301 
00302             Color = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a131">MI_GET_SECONDARY_COLOR</a> (PageFrameIndex, Pfn1);
00303             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a132">MI_GET_COLOR_FROM_SECONDARY</a>(Color));
00304 
00305             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[ListHead-&gt;ListName][Color].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> ==
00306                                                             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
00307 
00308                 <span class="comment">//</span>
00309                 <span class="comment">// This list is empty, add this as the first and last</span>
00310                 <span class="comment">// entry.</span>
00311                 <span class="comment">//</span>
00312 
00313                 <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[ListHead-&gt;ListName][Color].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> =
00314                                                                 PageFrameIndex;
00315                 <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[ListHead-&gt;ListName][Color].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o1">Blink</a> =
00316                                                                 (PVOID)Pfn1;
00317             } <span class="keywordflow">else</span> {
00318                 Pfn2 = (<a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a>)<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[ListHead-&gt;ListName][Color].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o1">Blink</a>;
00319                 Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = PageFrameIndex;
00320                 <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[ListHead-&gt;ListName][Color].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o1">Blink</a> = (PVOID)Pfn1;
00321             }
00322             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
00323 
00324             <span class="keywordflow">if</span> (ListHead-&gt;ListName == <a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>) {
00325                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a198">MI_BARRIER_STAMP_ZEROED_PAGE</a> (&amp;Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
00326             }
00327         }
00328         <span class="keywordflow">else</span> {
00329 
00330             <span class="comment">//</span>
00331             <span class="comment">// Transition page list so tally it appropriately.</span>
00332             <span class="comment">//</span>
00333 
00334             <a class="code" href="../../d7/d5/pfnlist_8c.html#a2">MI_TALLY_TRANSITION_PAGE_ADDITION</a> (Pfn1);
00335         }
00336 
00337         <span class="keywordflow">if</span> ((ListHead-&gt;ListName == <a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>) &amp;&amp;
00338             (<a class="code" href="../../d8/d5/kddata_8c.html#a37">MmFreePageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a613">MmMinimumFreePagesToZero</a>) &amp;&amp;
00339             (<a class="code" href="../../d4/d8/mi_8h.html#a612">MmZeroingPageThreadActive</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00340 
00341             <span class="comment">//</span>
00342             <span class="comment">// There are enough pages on the free list, start</span>
00343             <span class="comment">// the zeroing page thread.</span>
00344             <span class="comment">//</span>
00345 
00346             <a class="code" href="../../d4/d8/mi_8h.html#a612">MmZeroingPageThreadActive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00347             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a611">MmZeroingPageEvent</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00348         }
00349         <span class="keywordflow">return</span>;
00350     }
00351 
00352     <span class="comment">//</span>
00353     <span class="comment">// Check to see if there are too many modified pages.</span>
00354     <span class="comment">//</span>
00355 
00356     <span class="keywordflow">if</span> (ListHead-&gt;ListName == <a class="code" href="../../d2/d1/mm_8h.html#a345a174">ModifiedPageList</a>) {
00357 
00358         <span class="comment">//</span>
00359         <span class="comment">// Transition page list so tally it appropriately.</span>
00360         <span class="comment">//</span>
00361 
00362         <a class="code" href="../../d7/d5/pfnlist_8c.html#a2">MI_TALLY_TRANSITION_PAGE_ADDITION</a> (Pfn1);
00363 
00364         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) {
00365             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh == 0);
00366         }
00367 
00368         <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ModifiedPageCount += 1;
00369         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a728">MmModifiedPageMaximum</a> ) {
00370 
00371             <span class="comment">//</span>
00372             <span class="comment">// Start the modified page writer.</span>
00373             <span class="comment">//</span>
00374 
00375             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a719">MmModifiedPageWriterEvent</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00376         }
00377     }
00378     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ListHead-&gt;ListName == <a class="code" href="../../d2/d1/mm_8h.html#a345a175">ModifiedNoWritePageList</a>) {
00379         <a class="code" href="../../d7/d5/pfnlist_8c.html#a2">MI_TALLY_TRANSITION_PAGE_ADDITION</a> (Pfn1);
00380     }
00381 
00382     <span class="keywordflow">return</span>;
00383 }
00384 
00385 
00386 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00387 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00388"></a><a class="code" href="../../d7/d5/pfnlist_8c.html#a9">00388</a> <a class="code" href="../../d7/d5/pfnlist_8c.html#a9">MiInsertStandbyListAtFront</a> (
00389     IN PFN_NUMBER PageFrameIndex
00390     )
00391 
00392 <span class="comment">/*++</span>
00393 <span class="comment"></span>
00394 <span class="comment">Routine Description:</span>
00395 <span class="comment"></span>
00396 <span class="comment">    This procedure inserts a page at the front of the standby list.</span>
00397 <span class="comment"></span>
00398 <span class="comment">Arguments:</span>
00399 <span class="comment"></span>
00400 <span class="comment">    PageFrameIndex - Supplies the physical page number to insert in the</span>
00401 <span class="comment">                     list.</span>
00402 <span class="comment"></span>
00403 <span class="comment">Return Value:</span>
00404 <span class="comment"></span>
00405 <span class="comment">    none.</span>
00406 <span class="comment"></span>
00407 <span class="comment">Environment:</span>
00408 <span class="comment"></span>
00409 <span class="comment">    Must be holding the PFN database mutex with APCs disabled.</span>
00410 <span class="comment"></span>
00411 <span class="comment">--*/</span>
00412 
00413 {
00414     PFN_NUMBER first;
00415     IN <a class="code" href="../../d0/d4/struct__MMPFNLIST.html">PMMPFNLIST</a> ListHead;
00416     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00417     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
00418 
00419     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
00420     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((PageFrameIndex != 0) &amp;&amp; (PageFrameIndex &lt;= <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) &amp;&amp;
00421         (PageFrameIndex &gt;= <a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>));
00422 
00423     <span class="comment">//</span>
00424     <span class="comment">// Check to ensure the reference count for the page</span>
00425     <span class="comment">// is zero.</span>
00426     <span class="comment">//</span>
00427 
00428     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageFrameIndex);
00429 
00430     <a class="code" href="../../d2/d1/mm_8h.html#a68">PERFINFO_INSERT_FRONT_STANDBY</a>(PageFrameIndex);
00431 
00432 <span class="preprocessor">#if DBG</span>
00433 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a80">MM_DBG_PAGE_REF_COUNT</a>) {
00434 
00435         <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00436         KIRQL OldIrql = 99;
00437 
00438         <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte == 1)  &amp;&amp;
00439                 (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>))) {
00440             PointerPte = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>;
00441         } <span class="keywordflow">else</span> {
00442 
00443             <span class="comment">//</span>
00444             <span class="comment">// The page containing the prototype PTE is not valid,</span>
00445             <span class="comment">// map the page into hyperspace and reference it that way.</span>
00446             <span class="comment">//</span>
00447 
00448             PointerPte = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>, &amp;OldIrql);
00449             PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)((PCHAR)PointerPte +
00450                                     <a class="code" href="../../d4/d8/mi_8h.html#a110">MiGetByteOffset</a>(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>));
00451         }
00452 
00453         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a> (PointerPte) == PageFrameIndex) ||
00454                 (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte) == PageFrameIndex));
00455         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;u.Soft.Transition == 1);
00456         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;u.Soft.Prototype == 0);
00457         <span class="keywordflow">if</span> (OldIrql != 99) {
00458             <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql)
00459         }
00460     }
00461 
00462     <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
00463        (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1)) {
00464         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT, 0x8889, 0,0,0);
00465     }
00466 <span class="preprocessor">#endif</span>
00467 <span class="preprocessor"></span>
00468     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
00469     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte == 1);
00470     <a class="code" href="../../d6/d8/sysinfo_8c.html#a22">MmTransitionSharedPages</a> += 1;
00471 
00472     <a class="code" href="../../d8/d5/kddata_8c.html#a38">MmStandbyPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> += 1;  <span class="comment">// One more page on the list.</span>
00473 
00474     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d7/d5/pfnlist_8c.html#a5">MmTransitionPrivatePages</a> + <a class="code" href="../../d6/d8/sysinfo_8c.html#a22">MmTransitionSharedPages</a> == <a class="code" href="../../d8/d5/kddata_8c.html#a38">MmStandbyPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> + <a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> + <a class="code" href="../../d8/d5/kddata_8c.html#a40">MmModifiedNoWritePageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a>);
00475 
00476     ListHead = &amp;<a class="code" href="../../d8/d5/kddata_8c.html#a38">MmStandbyPageListHead</a>;
00477 
00478     first = ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a>;
00479     <span class="keywordflow">if</span> (first == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
00480 
00481         <span class="comment">//</span>
00482         <span class="comment">// List is empty add the page to the ListHead.</span>
00483         <span class="comment">//</span>
00484 
00485         ListHead-&gt;Blink = PageFrameIndex;
00486     } <span class="keywordflow">else</span> {
00487         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (first);
00488         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = PageFrameIndex;
00489     }
00490 
00491     ListHead-&gt;Flink = PageFrameIndex;
00492     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
00493     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink = first;
00494     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>;
00495 
00496     <span class="comment">//</span>
00497     <span class="comment">// If the page was placed on the free, standby or zeroed list,</span>
00498     <span class="comment">// update the count of usable pages in the system.  If the count</span>
00499     <span class="comment">// transitions from 0 to 1, the event associated with available</span>
00500     <span class="comment">// pages should become true.</span>
00501     <span class="comment">//</span>
00502 
00503     <a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> += 1;
00504 
00505     <span class="comment">//</span>
00506     <span class="comment">// A page has just become available, check to see if the</span>
00507     <span class="comment">// page wait events should be signalled.</span>
00508     <span class="comment">//</span>
00509 
00510     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> == <a class="code" href="../../d7/d5/pfnlist_8c.html#a0">MM_LOW_LIMIT</a>) {
00511         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a609">MmAvailablePagesEvent</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00512     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> == <a class="code" href="../../d7/d5/pfnlist_8c.html#a1">MM_HIGH_LIMIT</a>) {
00513         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a610">MmAvailablePagesEventHigh</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00514     }
00515 
00516     <span class="keywordflow">return</span>;
00517 }
00518 
00519 PFN_NUMBER  <span class="comment">//PageFrameIndex</span>
00520 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00521"></a><a class="code" href="../../d7/d5/pfnlist_8c.html#a10">00521</a> <a class="code" href="../../d7/d5/pfnlist_8c.html#a10">MiRemovePageFromList</a> (
00522     IN <a class="code" href="../../d0/d4/struct__MMPFNLIST.html">PMMPFNLIST</a> ListHead
00523     )
00524 
00525 <span class="comment">/*++</span>
00526 <span class="comment"></span>
00527 <span class="comment">Routine Description:</span>
00528 <span class="comment"></span>
00529 <span class="comment">    This procedure removes a page from the head of the specified list (free,</span>
00530 <span class="comment">    standby, zeroed, modified).</span>
00531 <span class="comment"></span>
00532 <span class="comment">    This routine clears the flags word in the PFN database, hence the</span>
00533 <span class="comment">    PFN information for this page must be initialized.</span>
00534 <span class="comment"></span>
00535 <span class="comment">Arguments:</span>
00536 <span class="comment"></span>
00537 <span class="comment">    ListHead - Supplies the list of the list in which to remove the</span>
00538 <span class="comment">               specified physical page.</span>
00539 <span class="comment"></span>
00540 <span class="comment">Return Value:</span>
00541 <span class="comment"></span>
00542 <span class="comment">    The physical page number removed from the specified list.</span>
00543 <span class="comment"></span>
00544 <span class="comment">Environment:</span>
00545 <span class="comment"></span>
00546 <span class="comment">    Must be holding the PFN database mutex with APCs disabled.</span>
00547 <span class="comment"></span>
00548 <span class="comment">--*/</span>
00549 
00550 {
00551     PFN_NUMBER PageFrameIndex;
00552     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00553     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
00554     ULONG Color;
00555 
00556     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
00557 
00558     <span class="comment">//</span>
00559     <span class="comment">// If the specified list is empty return MM_EMPTY_LIST.</span>
00560     <span class="comment">//</span>
00561 
00562     <span class="keywordflow">if</span> (ListHead-&gt;Total == 0) {
00563 
00564         KdPrint((<span class="stringliteral">"MM:Attempting to remove page from empty list\n"</span>));
00565         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (PFN_LIST_CORRUPT, 1, (ULONG_PTR)ListHead, <a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a>, 0);
00566         <span class="keywordflow">return</span> 0;
00567     }
00568 
00569     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ListHead-&gt;ListName != <a class="code" href="../../d2/d1/mm_8h.html#a345a174">ModifiedPageList</a>);
00570 
00571     <span class="comment">//</span>
00572     <span class="comment">// Decrement the count of pages on the list and remove the first</span>
00573     <span class="comment">// page from the list.</span>
00574     <span class="comment">//</span>
00575 
00576     ListHead-&gt;Total -= 1;
00577     PageFrameIndex = ListHead-&gt;Flink;
00578     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
00579 
00580     <a class="code" href="../../d2/d1/mm_8h.html#a90">PERFINFO_REMOVEPAGE</a>(PageFrameIndex, PERFINFO_LOG_TYPE_REMOVEPAGEFROMLIST);
00581 
00582     ListHead-&gt;Flink = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink;
00583 
00584     <span class="comment">//</span>
00585     <span class="comment">// Zero the flink and blink in the pfn database element.</span>
00586     <span class="comment">//</span>
00587 
00588     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink = 0;         <span class="comment">// Assumes Flink width is &gt;= WsIndex width</span>
00589     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = 0;
00590 
00591     <span class="comment">//</span>
00592     <span class="comment">// If the last page was removed (the ListHead-&gt;Flink is now</span>
00593     <span class="comment">// MM_EMPTY_LIST) make the listhead-&gt;Blink MM_EMPTY_LIST as well.</span>
00594     <span class="comment">//</span>
00595 
00596     <span class="keywordflow">if</span> (ListHead-&gt;Flink == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
00597         ListHead-&gt;Blink = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
00598     } <span class="keywordflow">else</span> {
00599 
00600         <span class="comment">//</span>
00601         <span class="comment">// Make the PFN element point to MM_EMPTY_LIST signifying this</span>
00602         <span class="comment">// is the last page in the list.</span>
00603         <span class="comment">//</span>
00604 
00605         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (ListHead-&gt;Flink);
00606         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
00607     }
00608 
00609     <span class="comment">//</span>
00610     <span class="comment">// Check to see if we now have one less page available.</span>
00611     <span class="comment">//</span>
00612 
00613     <span class="keywordflow">if</span> (ListHead-&gt;ListName &lt;= <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>) {
00614         <a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> -= 1;
00615 
00616         <span class="keywordflow">if</span> (ListHead-&gt;ListName == <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>) {
00617 
00618             <span class="comment">//</span>
00619             <span class="comment">// This page is currently in transition, restore the PTE to</span>
00620             <span class="comment">// its original contents so this page can be reused.</span>
00621             <span class="comment">//</span>
00622 
00623             <a class="code" href="../../d7/d5/pfnlist_8c.html#a3">MI_TALLY_TRANSITION_PAGE_REMOVAL</a> (Pfn1);
00624             <a class="code" href="../../d0/d2/mmsup_8c.html#a15">MiRestoreTransitionPte</a> (PageFrameIndex);
00625         }
00626 
00627         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a726">MmMinimumFreePages</a>) {
00628 
00629             <span class="comment">//</span>
00630             <span class="comment">// Obtain free pages.</span>
00631             <span class="comment">//</span>
00632 
00633             <a class="code" href="../../d5/d0/wsmanage_8c.html#a40">MiObtainFreePages</a>();
00634         }
00635     }
00636 
00637     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((PageFrameIndex != 0) &amp;&amp;
00638             (PageFrameIndex &lt;= <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) &amp;&amp;
00639             (PageFrameIndex &gt;= <a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>));
00640 
00641     <span class="comment">//</span>
00642     <span class="comment">// Zero the PFN flags longword.</span>
00643     <span class="comment">//</span>
00644 
00645     Color = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor;
00646     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.RemovalRequested == 0);
00647     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ShortFlags = 0;
00648     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = Color;
00649     Color = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a131">MI_GET_SECONDARY_COLOR</a> (PageFrameIndex, Pfn1);
00650 
00651     <span class="keywordflow">if</span> (ListHead-&gt;ListName &lt;= <a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>) {
00652 
00653         <span class="comment">//</span>
00654         <span class="comment">// Update the color lists.</span>
00655         <span class="comment">//</span>
00656 
00657         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[ListHead-&gt;ListName][Color].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> == PageFrameIndex);
00658         <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[ListHead-&gt;ListName][Color].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> =
00659                                          (PFN_NUMBER) Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
00660     }
00661 
00662     <span class="keywordflow">return</span> PageFrameIndex;
00663 }
00664 
00665 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00666 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00667"></a><a class="code" href="../../d7/d5/pfnlist_8c.html#a11">00667</a> <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (
00668     IN <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn
00669     )
00670 
00671 <span class="comment">/*++</span>
00672 <span class="comment"></span>
00673 <span class="comment">Routine Description:</span>
00674 <span class="comment"></span>
00675 <span class="comment">    This procedure removes a page from the middle of a list.  This is</span>
00676 <span class="comment">    designed for the faulting of transition pages from the standby and</span>
00677 <span class="comment">    modified list and making them active and valid again.</span>
00678 <span class="comment"></span>
00679 <span class="comment">Arguments:</span>
00680 <span class="comment"></span>
00681 <span class="comment">    Pfn - Supplies a pointer to the PFN database element for the physical</span>
00682 <span class="comment">          page to remove from the list.</span>
00683 <span class="comment"></span>
00684 <span class="comment">Return Value:</span>
00685 <span class="comment"></span>
00686 <span class="comment">    none.</span>
00687 <span class="comment"></span>
00688 <span class="comment">Environment:</span>
00689 <span class="comment"></span>
00690 <span class="comment">    Must be holding the PFN database mutex with APCs disabled.</span>
00691 <span class="comment"></span>
00692 <span class="comment">--*/</span>
00693 
00694 {
00695     <a class="code" href="../../d0/d4/struct__MMPFNLIST.html">PMMPFNLIST</a> ListHead;
00696     PFN_NUMBER Previous;
00697     PFN_NUMBER Next;
00698     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
00699 
00700     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
00701 
00702     <a class="code" href="../../d2/d1/mm_8h.html#a97">PERFINFO_UNLINKPAGE</a>((ULONG_PTR)(Pfn - <a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>), Pfn-&gt;u3.e1.PageLocation);
00703 
00704     <span class="comment">//</span>
00705     <span class="comment">// Page not on standby or modified list, check to see if the</span>
00706     <span class="comment">// page is currently being written by the modified page</span>
00707     <span class="comment">// writer, if so, just return this page.  The reference</span>
00708     <span class="comment">// count for the page will be incremented, so when the modified</span>
00709     <span class="comment">// page write completes, the page will not be put back on</span>
00710     <span class="comment">// the list, rather, it will remain active and valid.</span>
00711     <span class="comment">//</span>
00712 
00713     <span class="keywordflow">if</span> (Pfn-&gt;u3.e2.ReferenceCount &gt; 0) {
00714 
00715         <span class="comment">//</span>
00716         <span class="comment">// The page was not on any "transition lists", check to see</span>
00717         <span class="comment">// if this has I/O in progress.</span>
00718         <span class="comment">//</span>
00719 
00720         <span class="keywordflow">if</span> (Pfn-&gt;u2.ShareCount == 0) {
00721 <span class="preprocessor">#if DBG</span>
00722 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a73">MM_DBG_PAGE_IN_LIST</a>) {
00723                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"unlinking page not in list...\n"</span>);
00724                 <a class="code" href="../../d4/d8/mi_8h.html#a971">MiFormatPfn</a>(Pfn);
00725             }
00726 <span class="preprocessor">#endif</span>
00727 <span class="preprocessor"></span>            <span class="keywordflow">return</span>;
00728         }
00729         KdPrint((<span class="stringliteral">"MM:attempt to remove page from wrong page list\n"</span>));
00730         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (PFN_LIST_CORRUPT,
00731                       2,
00732                       Pfn - <a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>,
00733                       <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>,
00734                       Pfn-&gt;u3.e2.ReferenceCount);
00735         <span class="keywordflow">return</span>;
00736     }
00737 
00738     ListHead = <a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[Pfn-&gt;u3.e1.PageLocation];
00739 
00740     <span class="comment">//</span>
00741     <span class="comment">// Must not remove pages from free or zeroed without updating</span>
00742     <span class="comment">// the colored lists.</span>
00743     <span class="comment">//</span>
00744 
00745     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o1">ListName</a> &gt;= <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>);
00746 
00747     <span class="comment">//</span>
00748     <span class="comment">// On MIPS R4000 modified pages destined for the paging file are</span>
00749     <span class="comment">// kept on separate lists which group pages of the same color</span>
00750     <span class="comment">// together</span>
00751     <span class="comment">//</span>
00752 
00753     <span class="keywordflow">if</span> ((ListHead == &amp;<a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>) &amp;&amp;
00754         (Pfn-&gt;OriginalPte.u.Soft.Prototype == 0)) {
00755 
00756         <span class="comment">//</span>
00757         <span class="comment">// This page is destined for the paging file (not</span>
00758         <span class="comment">// a mapped file).  Change the list head to the</span>
00759         <span class="comment">// appropriate colored list head.</span>
00760         <span class="comment">//</span>
00761 
00762         ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> -= 1;
00763         <a class="code" href="../../d4/d2/datalpha_8c.html#a23">MmTotalPagesForPagingFile</a> -= 1;
00764         ListHead = &amp;<a class="code" href="../../d4/d2/datalpha_8c.html#a21">MmModifiedPageListByColor</a> [Pfn-&gt;u3.e1.PageColor];
00765     }
00766 
00767     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn-&gt;u3.e1.WriteInProgress == 0);
00768     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn-&gt;u3.e1.ReadInProgress == 0);
00769     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> != 0);
00770 
00771     Next = Pfn-&gt;u1.Flink;
00772     Pfn-&gt;u1.Flink = 0;         <span class="comment">// Assumes Flink width is &gt;= WsIndex width</span>
00773     Previous = Pfn-&gt;u2.Blink;
00774     Pfn-&gt;u2.Blink = 0;
00775 
00776     <span class="keywordflow">if</span> (Next == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
00777         ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o3">Blink</a> = Previous;
00778     } <span class="keywordflow">else</span> {
00779         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Next);
00780         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = Previous;
00781     }
00782 
00783     <span class="keywordflow">if</span> (Previous == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
00784         ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a> = Next;
00785     } <span class="keywordflow">else</span> {
00786         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Previous);
00787         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink = Next;
00788     }
00789 
00790     ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> -= 1;
00791 
00792     <span class="comment">//</span>
00793     <span class="comment">// Check to see if we now have one less page available.</span>
00794     <span class="comment">//</span>
00795 
00796     <span class="keywordflow">if</span> (ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o1">ListName</a> &lt;= <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>) {
00797         <a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> -= 1;
00798 
00799         <span class="keywordflow">if</span> (ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o1">ListName</a> == <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>) {
00800             <a class="code" href="../../d7/d5/pfnlist_8c.html#a3">MI_TALLY_TRANSITION_PAGE_REMOVAL</a> (Pfn);
00801         }
00802 
00803         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a726">MmMinimumFreePages</a>) {
00804 
00805             <span class="comment">//</span>
00806             <span class="comment">// Obtain free pages.</span>
00807             <span class="comment">//</span>
00808 
00809             <a class="code" href="../../d5/d0/wsmanage_8c.html#a40">MiObtainFreePages</a>();
00810 
00811         }
00812     }
00813     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o1">ListName</a> == <a class="code" href="../../d2/d1/mm_8h.html#a345a174">ModifiedPageList</a> || ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o1">ListName</a> == <a class="code" href="../../d2/d1/mm_8h.html#a345a175">ModifiedNoWritePageList</a>) {
00814         <a class="code" href="../../d7/d5/pfnlist_8c.html#a3">MI_TALLY_TRANSITION_PAGE_REMOVAL</a> (Pfn);
00815     }
00816 
00817     <span class="keywordflow">return</span>;
00818 }
00819 
00820 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00821"></a><a class="code" href="../../d7/d5/pfnlist_8c.html#a12">00821</a> <a class="code" href="../../d7/d5/pfnlist_8c.html#a12">MiUnlinkFreeOrZeroedPage</a> (
00822     IN PFN_NUMBER Page
00823     )
00824 
00825 <span class="comment">/*++</span>
00826 <span class="comment"></span>
00827 <span class="comment">Routine Description:</span>
00828 <span class="comment"></span>
00829 <span class="comment">    This procedure removes a page from the middle of a list.  This is</span>
00830 <span class="comment">    designed for the removing of free or zeroed pages from the middle of</span>
00831 <span class="comment">    their lists.</span>
00832 <span class="comment"></span>
00833 <span class="comment">Arguments:</span>
00834 <span class="comment"></span>
00835 <span class="comment">    Pfn - Supplies a pointer to the PFN database element for the physical</span>
00836 <span class="comment">          page to remove from the list.</span>
00837 <span class="comment"></span>
00838 <span class="comment">Return Value:</span>
00839 <span class="comment"></span>
00840 <span class="comment">    None.</span>
00841 <span class="comment"></span>
00842 <span class="comment">Environment:</span>
00843 <span class="comment"></span>
00844 <span class="comment">    Must be holding the PFN database mutex with APCs disabled.</span>
00845 <span class="comment"></span>
00846 <span class="comment">--*/</span>
00847 
00848 {
00849     <a class="code" href="../../d0/d4/struct__MMPFNLIST.html">PMMPFNLIST</a> ListHead;
00850     PFN_NUMBER Previous;
00851     PFN_NUMBER Next;
00852     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
00853     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn;
00854     ULONG Color;
00855 
00856     Pfn = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (Page);
00857 
00858     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
00859 
00860     ListHead = <a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation];
00861     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> != 0);
00862     ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> -= 1;
00863 
00864     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o1">ListName</a> &lt;= <a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>);
00865     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress == 0);
00866     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.ReadInProgress == 0);
00867 
00868     <a class="code" href="../../d2/d1/mm_8h.html#a96">PERFINFO_UNLINKFREEPAGE</a>((ULONG_PTR)(Pfn - <a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>), Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation);
00869 
00870     Next = Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink;
00871     Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink = 0;         <span class="comment">// Assumes Flink width is &gt;= WsIndex width</span>
00872     Previous = Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink;
00873     Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = 0;
00874 
00875     <span class="keywordflow">if</span> (Next == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
00876         ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o3">Blink</a> = Previous;
00877     } <span class="keywordflow">else</span> {
00878         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Next);
00879         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = Previous;
00880     }
00881 
00882     <span class="keywordflow">if</span> (Previous == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
00883         ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a> = Next;
00884     } <span class="keywordflow">else</span> {
00885         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Previous);
00886         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink = Next;
00887     }
00888 
00889     <span class="comment">//</span>
00890     <span class="comment">// We are removing a page from the middle of the free or zeroed page list.</span>
00891     <span class="comment">// The secondary color tables must be updated at this time.</span>
00892     <span class="comment">//</span>
00893 
00894     Color = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a131">MI_GET_SECONDARY_COLOR</a> (Page, Pfn);
00895     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a132">MI_GET_COLOR_FROM_SECONDARY</a>(Color));
00896 
00897     <span class="comment">//</span>
00898     <span class="comment">// Walk down the list and remove the page.</span>
00899     <span class="comment">//</span>
00900 
00901     Next = <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o1">ListName</a>][Color].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a>;
00902     <span class="keywordflow">if</span> (Next == Page) {
00903         <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o1">ListName</a>][Color].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> =
00904                                                 (PFN_NUMBER) Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
00905     } <span class="keywordflow">else</span> {
00906 
00907         <span class="comment">//</span>
00908         <span class="comment">// Walk the list to find the parent.</span>
00909         <span class="comment">//</span>
00910 
00911         <span class="keywordflow">for</span> (; ; ) {
00912             Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (Next);
00913             Next = (PFN_NUMBER) Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
00914             <span class="keywordflow">if</span> (Page == Next) {
00915                 Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
00916                 <span class="keywordflow">if</span> ((PFN_NUMBER) Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
00917                     <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o1">ListName</a>][Color].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o1">Blink</a> = Pfn2;
00918                 }
00919                 <span class="keywordflow">break</span>;
00920             }
00921         }
00922     }
00923 
00924     <a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> -= 1;
00925 
00926     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a726">MmMinimumFreePages</a>) {
00927 
00928         <span class="comment">//</span>
00929         <span class="comment">// Obtain free pages.</span>
00930         <span class="comment">//</span>
00931 
00932         <a class="code" href="../../d5/d0/wsmanage_8c.html#a40">MiObtainFreePages</a>();
00933     }
00934 
00935     <span class="keywordflow">return</span>;
00936 }
00937 
00938 
00939 ULONG
00940 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00941"></a><a class="code" href="../../d7/d5/pfnlist_8c.html#a13">00941</a> <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (
00942     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00943     IN PVOID VirtualAddress
00944     )
00945 
00946 <span class="comment">/*++</span>
00947 <span class="comment"></span>
00948 <span class="comment">Routine Description:</span>
00949 <span class="comment"></span>
00950 <span class="comment">    This procedure ensures that a physical page is available on</span>
00951 <span class="comment">    the zeroed, free or standby list such that the next call the remove a</span>
00952 <span class="comment">    page absolutely will not block.  This is necessary as blocking would</span>
00953 <span class="comment">    require a wait which could cause a deadlock condition.</span>
00954 <span class="comment"></span>
00955 <span class="comment">    If a page is available the function returns immediately with a value</span>
00956 <span class="comment">    of FALSE indicating no wait operation was performed.  If no physical</span>
00957 <span class="comment">    page is available, the thread enters a wait state and the function</span>
00958 <span class="comment">    returns the value TRUE when the wait operation completes.</span>
00959 <span class="comment"></span>
00960 <span class="comment">Arguments:</span>
00961 <span class="comment"></span>
00962 <span class="comment">    Process - Supplies a pointer to the current process if, and only if,</span>
00963 <span class="comment">              the working set mutex is held currently held and should</span>
00964 <span class="comment">              be released if a wait operation is issued.  Supplies</span>
00965 <span class="comment">              the value NULL otherwise.</span>
00966 <span class="comment"></span>
00967 <span class="comment">    VirtualAddress - Supplies the virtual address for the faulting page.</span>
00968 <span class="comment">                     If the value is NULL, the page is treated as a</span>
00969 <span class="comment">                     user mode address.</span>
00970 <span class="comment"></span>
00971 <span class="comment">Return Value:</span>
00972 <span class="comment"></span>
00973 <span class="comment">    FALSE - if a page was immediately available.</span>
00974 <span class="comment">    TRUE - if a wait operation occurred before a page became available.</span>
00975 <span class="comment"></span>
00976 <span class="comment"></span>
00977 <span class="comment">Environment:</span>
00978 <span class="comment"></span>
00979 <span class="comment">    Must be holding the PFN database mutex with APCs disabled.</span>
00980 <span class="comment"></span>
00981 <span class="comment">--*/</span>
00982 
00983 {
00984     PVOID <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00985     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00986     KIRQL OldIrql;
00987     KIRQL Ignore;
00988     ULONG Limit;
00989     ULONG Relock;
00990     PFN_NUMBER StrandedPages;
00991     LOGICAL WsHeldSafe;
00992     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00993     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> EndPfn;
00994     LARGE_INTEGER WaitBegin;
00995     LARGE_INTEGER WaitEnd;
00996 
00997     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
00998 
00999     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt;= <a class="code" href="../../d7/d5/pfnlist_8c.html#a1">MM_HIGH_LIMIT</a>) {
01000 
01001         <span class="comment">//</span>
01002         <span class="comment">// Pages are available.</span>
01003         <span class="comment">//</span>
01004 
01005         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01006     }
01007 
01008     <span class="comment">//</span>
01009     <span class="comment">// If this fault is for paged pool (or pagable kernel space,</span>
01010     <span class="comment">// including page table pages), let it use the last page.</span>
01011     <span class="comment">//</span>
01012 
01013 <span class="preprocessor">#if defined(_IA64_)</span>
01014 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9/miia64_8h.html#a220">MI_IS_SYSTEM_ADDRESS</a>(VirtualAddress) ||
01015         (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a193">MI_IS_HYPER_SPACE_ADDRESS</a>(VirtualAddress))) {
01016 <span class="preprocessor">#else</span>
01017 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (((<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)VirtualAddress &gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a63">HYPER_SPACE</a>)) ||
01018         ((VirtualAddress &gt; MM_HIGHEST_USER_ADDRESS) &amp;&amp;
01019          (VirtualAddress &lt; (PVOID)PTE_BASE))) {
01020 <span class="preprocessor">#endif</span>
01021 <span class="preprocessor"></span>
01022         <span class="comment">//</span>
01023         <span class="comment">// This fault is in the system, use 1 page as the limit.</span>
01024         <span class="comment">//</span>
01025 
01026         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt;= <a class="code" href="../../d7/d5/pfnlist_8c.html#a0">MM_LOW_LIMIT</a>) {
01027 
01028             <span class="comment">//</span>
01029             <span class="comment">// Pages are available.</span>
01030             <span class="comment">//</span>
01031 
01032             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01033         }
01034 
01035         Limit = <a class="code" href="../../d7/d5/pfnlist_8c.html#a0">MM_LOW_LIMIT</a>;
01036         <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> = (PVOID)&amp;<a class="code" href="../../d4/d8/mi_8h.html#a609">MmAvailablePagesEvent</a>;
01037     } <span class="keywordflow">else</span> {
01038         Limit = <a class="code" href="../../d7/d5/pfnlist_8c.html#a1">MM_HIGH_LIMIT</a>;
01039         <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> = (PVOID)&amp;<a class="code" href="../../d4/d8/mi_8h.html#a610">MmAvailablePagesEventHigh</a>;
01040     }
01041 
01042     <span class="keywordflow">while</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; Limit) {
01043         <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> ((<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>)<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>);
01044 
01045         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
01046 
01047         <span class="keywordflow">if</span> (Process == <a class="code" href="../../d4/d8/mi_8h.html#a332">HYDRA_PROCESS</a>) {
01048             <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
01049         }
01050         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01051 
01052             <span class="comment">//</span>
01053             <span class="comment">// The working set lock may have been acquired safely or unsafely</span>
01054             <span class="comment">// by our caller.  Handle both cases here and below.</span>
01055             <span class="comment">//</span>
01056 
01057             <a class="code" href="../../d4/d8/mi_8h.html#a164">UNLOCK_WS_REGARDLESS</a> (Process, WsHeldSafe);
01058         }
01059         <span class="keywordflow">else</span> {
01060             Relock = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01061             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a434">MmSystemLockOwner</a> == <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()) {
01062                 <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
01063                 Relock = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01064             }
01065         }
01066 
01067         KiQueryInterruptTime(&amp;WaitBegin);
01068 
01069         <span class="comment">//</span>
01070         <span class="comment">// Wait 7 minutes for pages to become available.</span>
01071         <span class="comment">//</span>
01072 
01073         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>,
01074                                        <a class="code" href="../../d4/d9/ke_8h.html#a407a206">WrFreePage</a>,
01075                                        <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01076                                        <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01077                                        (PLARGE_INTEGER)&amp;<a class="code" href="../../d4/d8/mi_8h.html#a416">MmSevenMinutes</a>);
01078 
01079         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_TIMEOUT) {
01080 
01081             KiQueryInterruptTime(&amp;WaitEnd);
01082 
01083             <span class="comment">//</span>
01084             <span class="comment">// See how many transition pages have nonzero reference counts as</span>
01085             <span class="comment">// these indicate drivers that aren't unlocking the pages in their</span>
01086             <span class="comment">// MDLs.</span>
01087             <span class="comment">//</span>
01088 
01089             Limit = 0;
01090             StrandedPages = 0;
01091 
01092             <span class="keywordflow">do</span> {
01093         
01094                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (<a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[Limit].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>);
01095                 EndPfn = Pfn1 + <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[Limit].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a>;
01096 
01097                 <span class="keywordflow">while</span> (Pfn1 &lt; EndPfn) {
01098                     <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == <a class="code" href="../../d2/d1/mm_8h.html#a345a178">TransitionPage</a>) &amp;&amp;
01099                         (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount != 0)) {
01100                             StrandedPages += 1;
01101                     }
01102                     Pfn1 += 1;
01103                 }
01104                 Limit += 1;
01105         
01106             } <span class="keywordflow">while</span> (Limit != <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a>);
01107 
01108             <span class="comment">//</span>
01109             <span class="comment">// This bugcheck can occur for the following reasons:</span>
01110             <span class="comment">//</span>
01111             <span class="comment">// A driver has blocked, deadlocking the modified or mapped</span>
01112             <span class="comment">// page writers.  Examples of this include mutex deadlocks or</span>
01113             <span class="comment">// accesses to paged out memory in filesystem drivers, filter</span>
01114             <span class="comment">// drivers, etc.  This indicates a driver bug.</span>
01115             <span class="comment">//</span>
01116             <span class="comment">// The storage driver(s) are not processing requests.  Examples</span>
01117             <span class="comment">// of this are stranded queues, non-responding drives, etc.  This</span>
01118             <span class="comment">// indicates a driver bug.</span>
01119             <span class="comment">//</span>
01120             <span class="comment">// Not enough pool is available for the storage stack to write out</span>
01121             <span class="comment">// modified pages.  This indicates a driver bug.</span>
01122             <span class="comment">//</span>
01123             <span class="comment">// A high priority realtime thread has starved the balance set</span>
01124             <span class="comment">// manager from trimming pages and/or starved the modified writer</span>
01125             <span class="comment">// from writing them out.  This indicates a bug in the component</span>
01126             <span class="comment">// that created this thread.</span>
01127             <span class="comment">//</span>
01128             <span class="comment">// All the processes have been trimmed to their minimums and all</span>
01129             <span class="comment">// modified pages written, but still no memory is available.  The</span>
01130             <span class="comment">// freed memory must be stuck in transition pages with non-zero</span>
01131             <span class="comment">// reference counts - thus they cannot be put on the freelist.</span>
01132             <span class="comment">// A driver is neglecting to unlock the pages preventing the</span>
01133             <span class="comment">// reference counts from going to zero which would free the pages.</span>
01134             <span class="comment">// This may be due to transfers that never finish and the driver</span>
01135             <span class="comment">// never aborts or other driver bugs.</span>
01136             <span class="comment">//</span>
01137 
01138             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (NO_PAGES_AVAILABLE,
01139                           <a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a>,
01140                           <a class="code" href="../../d4/d2/datalpha_8c.html#a23">MmTotalPagesForPagingFile</a>,
01141                           (<a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>) - <a class="code" href="../../d9/d5/4_2kddata_8c.html#a52">MmAllocatedNonPagedPool</a>,
01142                           StrandedPages);
01143 
01144             <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d3/kd_8h.html#a12">KdDebuggerNotPresent</a>) {
01145                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MmEnsureAvailablePageOrWait: 7 min timeout %x %x %x %x\n"</span>, WaitEnd.HighPart, WaitEnd.LowPart, WaitBegin.HighPart, WaitBegin.LowPart);
01146                 DbgBreakPoint ();
01147             }
01148         }
01149 
01150         <span class="keywordflow">if</span> (Process == <a class="code" href="../../d4/d8/mi_8h.html#a332">HYDRA_PROCESS</a>) {
01151             <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (Ignore);
01152         }
01153         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01154 
01155             <span class="comment">//</span>
01156             <span class="comment">// The working set lock may have been acquired safely or unsafely</span>
01157             <span class="comment">// by our caller.  Reacquire it in the same manner our caller did.</span>
01158             <span class="comment">//</span>
01159 
01160             <a class="code" href="../../d4/d8/mi_8h.html#a165">LOCK_WS_REGARDLESS</a> (Process, WsHeldSafe);
01161         }
01162         <span class="keywordflow">else</span> {
01163             <span class="keywordflow">if</span> (Relock) {
01164                 <a class="code" href="../../d4/d8/mi_8h.html#a144">LOCK_SYSTEM_WS</a> (Ignore);
01165             }
01166         }
01167 
01168         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01169     }
01170 
01171     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01172 }
01173 
01174 
01175 PFN_NUMBER  <span class="comment">//PageFrameIndex</span>
01176 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l01177"></a><a class="code" href="../../d7/d5/pfnlist_8c.html#a14">01177</a> <a class="code" href="../../d7/d5/pfnlist_8c.html#a14">MiRemoveZeroPage</a> (
01178     IN ULONG PageColor
01179     )
01180 
01181 <span class="comment">/*++</span>
01182 <span class="comment"></span>
01183 <span class="comment">Routine Description:</span>
01184 <span class="comment"></span>
01185 <span class="comment">    This procedure removes a zero page from either the zeroed, free</span>
01186 <span class="comment">    or standby lists (in that order).  If no pages exist on the zeroed</span>
01187 <span class="comment">    or free list a transition page is removed from the standby list</span>
01188 <span class="comment">    and the PTE (may be a prototype PTE) which refers to this page is</span>
01189 <span class="comment">    changed from transition back to its original contents.</span>
01190 <span class="comment"></span>
01191 <span class="comment">    If the page is not obtained from the zeroed list, it is zeroed.</span>
01192 <span class="comment"></span>
01193 <span class="comment">Arguments:</span>
01194 <span class="comment"></span>
01195 <span class="comment">    PageColor - Supplies the page color for which this page is destined.</span>
01196 <span class="comment">                This is used for checking virtual address alignments to</span>
01197 <span class="comment">                determine if the D cache needs flushing before the page</span>
01198 <span class="comment">                can be reused.</span>
01199 <span class="comment"></span>
01200 <span class="comment">Return Value:</span>
01201 <span class="comment"></span>
01202 <span class="comment">    The physical page number removed from the specified list.</span>
01203 <span class="comment"></span>
01204 <span class="comment">Environment:</span>
01205 <span class="comment"></span>
01206 <span class="comment">    Must be holding the PFN database mutex with APCs disabled.</span>
01207 <span class="comment"></span>
01208 <span class="comment">--*/</span>
01209 
01210 {
01211     PFN_NUMBER Page;
01212     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01213     ULONG Color;
01214 
01215     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
01216     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> != 0);
01217 
01218     <span class="comment">//</span>
01219     <span class="comment">// Attempt to remove a page from the zeroed page list. If a page</span>
01220     <span class="comment">// is available, then remove it and return its page frame index.</span>
01221     <span class="comment">// Otherwise, attempt to remove a page from the free page list or</span>
01222     <span class="comment">// the standby list.</span>
01223     <span class="comment">//</span>
01224     <span class="comment">// N.B. It is not necessary to change page colors even if the old</span>
01225     <span class="comment">//      color is not equal to the new color. The zero page thread</span>
01226     <span class="comment">//      ensures that all zeroed pages are removed from all caches.</span>
01227     <span class="comment">//</span>
01228 
01229     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>][PageColor].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
01230 
01231         <span class="comment">//</span>
01232         <span class="comment">// Remove the first entry on the zeroed by color list.</span>
01233         <span class="comment">//</span>
01234 
01235         Page = <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>][PageColor].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a>;
01236 
01237 <span class="preprocessor">#if DBG</span>
01238 <span class="preprocessor"></span>        Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page);
01239         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == <a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>);
01240         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != <a class="code" href="../../d4/d8/mi_8h.html#a170">MI_MAGIC_AWE_PTEFRAME</a>);
01241 <span class="preprocessor">#endif</span>
01242 <span class="preprocessor"></span>
01243         <a class="code" href="../../d7/d5/pfnlist_8c.html#a7">MiRemovePageByColor</a> (Page, PageColor);
01244 
01245 <span class="preprocessor">#if DBG</span>
01246 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor == (PageColor &amp; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a57">MM_COLOR_MASK</a>));
01247         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
01248         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0);
01249         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != <a class="code" href="../../d4/d8/mi_8h.html#a170">MI_MAGIC_AWE_PTEFRAME</a>);
01250 <span class="preprocessor">#endif</span>
01251 <span class="preprocessor"></span>        <span class="keywordflow">return</span> Page;
01252 
01253     }
01254 
01255     <span class="comment">//</span>
01256     <span class="comment">// No previously zeroed page with the specified secondary color exists.</span>
01257     <span class="comment">// Try a zeroed page of the primary color.</span>
01258     <span class="comment">//</span>
01259 
01260     <span class="keywordflow">if</span>  (<a class="code" href="../../d8/d5/kddata_8c.html#a36">MmZeroedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a> != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
01261         Page = <a class="code" href="../../d8/d5/kddata_8c.html#a36">MmZeroedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a>;
01262 <span class="preprocessor">#if DBG</span>
01263 <span class="preprocessor"></span>        Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page);
01264         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == <a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>);
01265         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != <a class="code" href="../../d4/d8/mi_8h.html#a170">MI_MAGIC_AWE_PTEFRAME</a>);
01266 <span class="preprocessor">#endif</span>
01267 <span class="preprocessor"></span>        Color = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a131">MI_GET_SECONDARY_COLOR</a> (Page, <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page));
01268         <a class="code" href="../../d7/d5/pfnlist_8c.html#a7">MiRemovePageByColor</a> (Page, Color);
01269 <span class="preprocessor">#if DBG</span>
01270 <span class="preprocessor"></span>        Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page);
01271         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor == (PageColor &amp; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a57">MM_COLOR_MASK</a>));
01272         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
01273         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0);
01274         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != <a class="code" href="../../d4/d8/mi_8h.html#a170">MI_MAGIC_AWE_PTEFRAME</a>);
01275 <span class="preprocessor">#endif</span>
01276 <span class="preprocessor"></span>        <span class="keywordflow">return</span> Page;
01277     }
01278 
01279     <span class="comment">//</span>
01280     <span class="comment">// No zeroed page of the primary color exists, try a free page of the</span>
01281     <span class="comment">// secondary color.</span>
01282     <span class="comment">//</span>
01283 
01284     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>][PageColor].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
01285 
01286         <span class="comment">//</span>
01287         <span class="comment">// Remove the first entry on the free list by color.</span>
01288         <span class="comment">//</span>
01289 
01290         Page = <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>][PageColor].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a>;
01291 
01292 <span class="preprocessor">#if DBG</span>
01293 <span class="preprocessor"></span>        Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page);
01294         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == <a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>);
01295         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != <a class="code" href="../../d4/d8/mi_8h.html#a170">MI_MAGIC_AWE_PTEFRAME</a>);
01296 <span class="preprocessor">#endif</span>
01297 <span class="preprocessor"></span>
01298         <a class="code" href="../../d7/d5/pfnlist_8c.html#a7">MiRemovePageByColor</a> (Page, PageColor);
01299 <span class="preprocessor">#if DBG</span>
01300 <span class="preprocessor"></span>        Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page);
01301         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor == (PageColor &amp; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a57">MM_COLOR_MASK</a>));
01302         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
01303         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0);
01304         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != <a class="code" href="../../d4/d8/mi_8h.html#a170">MI_MAGIC_AWE_PTEFRAME</a>);
01305 <span class="preprocessor">#endif</span>
01306 <span class="preprocessor"></span>        <span class="keywordflow">goto</span> ZeroPage;
01307     }
01308 
01309     <span class="keywordflow">if</span>  (<a class="code" href="../../d8/d5/kddata_8c.html#a37">MmFreePageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a> != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
01310         Page = <a class="code" href="../../d8/d5/kddata_8c.html#a37">MmFreePageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a>;
01311 
01312         Color = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a131">MI_GET_SECONDARY_COLOR</a> (Page, <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page));
01313         <a class="code" href="../../d7/d5/pfnlist_8c.html#a7">MiRemovePageByColor</a> (Page, Color);
01314 <span class="preprocessor">#if DBG</span>
01315 <span class="preprocessor"></span>        Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page);
01316         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor == (PageColor &amp; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a57">MM_COLOR_MASK</a>));
01317         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
01318         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0);
01319         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != <a class="code" href="../../d4/d8/mi_8h.html#a170">MI_MAGIC_AWE_PTEFRAME</a>);
01320 <span class="preprocessor">#endif</span>
01321 <span class="preprocessor"></span>        <span class="keywordflow">goto</span> ZeroPage;
01322     }
01323 
01324     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d5/kddata_8c.html#a36">MmZeroedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> == 0);
01325     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d5/kddata_8c.html#a37">MmFreePageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> == 0);
01326 
01327     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a36">MmZeroedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> != 0) {
01328 
01329         Page = <a class="code" href="../../d7/d5/pfnlist_8c.html#a10">MiRemovePageFromList</a>(&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a36">MmZeroedPageListHead</a>);
01330         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a122">MI_CHECK_PAGE_ALIGNMENT</a>(Page, PageColor &amp; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a57">MM_COLOR_MASK</a>);
01331 
01332     } <span class="keywordflow">else</span> {
01333 
01334         <span class="comment">//</span>
01335         <span class="comment">// Attempt to remove a page from the free list. If a page is</span>
01336         <span class="comment">// available, then remove  it. Otherwise, attempt to remove a</span>
01337         <span class="comment">// page from the standby list.</span>
01338         <span class="comment">//</span>
01339 
01340         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a37">MmFreePageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> != 0) {
01341             Page = <a class="code" href="../../d7/d5/pfnlist_8c.html#a10">MiRemovePageFromList</a>(&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a37">MmFreePageListHead</a>);
01342             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page))-&gt;PteFrame != <a class="code" href="../../d4/d8/mi_8h.html#a170">MI_MAGIC_AWE_PTEFRAME</a>);
01343         } <span class="keywordflow">else</span> {
01344 
01345             <span class="comment">//</span>
01346             <span class="comment">// Remove a page from the standby list and restore the original</span>
01347             <span class="comment">// contents of the PTE to free the last reference to the physical</span>
01348             <span class="comment">// page.</span>
01349             <span class="comment">//</span>
01350 
01351             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d5/kddata_8c.html#a38">MmStandbyPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> != 0);
01352 
01353             Page = <a class="code" href="../../d7/d5/pfnlist_8c.html#a10">MiRemovePageFromList</a>(&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a38">MmStandbyPageListHead</a>);
01354             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page))-&gt;PteFrame != <a class="code" href="../../d4/d8/mi_8h.html#a170">MI_MAGIC_AWE_PTEFRAME</a>);
01355         }
01356 
01357         <span class="comment">//</span>
01358         <span class="comment">// Zero the page removed from the free or standby list.</span>
01359         <span class="comment">//</span>
01360 
01361 ZeroPage:
01362 
01363         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page);
01364 
01365 <span class="preprocessor">#if defined(_ALPHA_)</span>
01366 <span class="preprocessor"></span>        HalZeroPage((PVOID)ULongToPtr((PageColor &amp; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a57">MM_COLOR_MASK</a>) &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>),
01367                     (PVOID)ULongToPtr((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor) &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>),
01368                     Page);
01369 <span class="preprocessor">#else</span>
01370 <span class="preprocessor"></span>        <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (Page, 0);
01371 <span class="preprocessor">#endif</span>
01372 <span class="preprocessor"></span>
01373         <span class="comment">//</span>
01374         <span class="comment">// Note the stamping must occur after the page is zeroed.</span>
01375         <span class="comment">//</span>
01376 
01377         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a198">MI_BARRIER_STAMP_ZEROED_PAGE</a> (&amp;Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
01378 
01379         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = PageColor &amp; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a57">MM_COLOR_MASK</a>;
01380 
01381     }
01382 
01383 <span class="preprocessor">#if DBG</span>
01384 <span class="preprocessor"></span>    Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (Page);
01385     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
01386     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0);
01387     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != <a class="code" href="../../d4/d8/mi_8h.html#a170">MI_MAGIC_AWE_PTEFRAME</a>);
01388 <span class="preprocessor">#endif</span>
01389 <span class="preprocessor"></span>
01390     <span class="keywordflow">return</span> Page;
01391 }
01392 
01393 PFN_NUMBER  <span class="comment">//PageFrameIndex</span>
01394 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l01395"></a><a class="code" href="../../d7/d5/pfnlist_8c.html#a15">01395</a> <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (
01396     IN ULONG PageColor
01397     )
01398 
01399 <span class="comment">/*++</span>
01400 <span class="comment"></span>
01401 <span class="comment">Routine Description:</span>
01402 <span class="comment"></span>
01403 <span class="comment">    This procedure removes a page from either the free, zeroed,</span>
01404 <span class="comment">    or standby lists (in that order).  If no pages exist on the zeroed</span>
01405 <span class="comment">    or free list a transition page is removed from the standby list</span>
01406 <span class="comment">    and the PTE (may be a prototype PTE) which refers to this page is</span>
01407 <span class="comment">    changed from transition back to its original contents.</span>
01408 <span class="comment"></span>
01409 <span class="comment">    Note pages MUST exist to satisfy this request.  The caller ensures this</span>
01410 <span class="comment">    by first calling MiEnsureAvailablePageOrWait.</span>
01411 <span class="comment"></span>
01412 <span class="comment">Arguments:</span>
01413 <span class="comment"></span>
01414 <span class="comment">    PageColor - Supplies the page color for which this page is destined.</span>
01415 <span class="comment">                This is used for checking virtual address alignments to</span>
01416 <span class="comment">                determine if the D cache needs flushing before the page</span>
01417 <span class="comment">                can be reused.</span>
01418 <span class="comment"></span>
01419 <span class="comment">Return Value:</span>
01420 <span class="comment"></span>
01421 <span class="comment">    The physical page number removed from the specified list.</span>
01422 <span class="comment"></span>
01423 <span class="comment">Environment:</span>
01424 <span class="comment"></span>
01425 <span class="comment">    Must be holding the PFN database mutex with APCs disabled.</span>
01426 <span class="comment"></span>
01427 <span class="comment">--*/</span>
01428 
01429 {
01430     PFN_NUMBER Page;
01431     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01432     ULONG Color;
01433 
01434     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
01435     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> != 0);
01436 
01437     <span class="comment">//</span>
01438     <span class="comment">// Check the free page list, and if a page is available</span>
01439     <span class="comment">// remove it and return its value.</span>
01440     <span class="comment">//</span>
01441 
01442     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>][PageColor].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
01443 
01444         <span class="comment">//</span>
01445         <span class="comment">// Remove the first entry on the free by color list.</span>
01446         <span class="comment">//</span>
01447 
01448         Page = <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>][PageColor].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a>;
01449 <span class="preprocessor">#if DBG</span>
01450 <span class="preprocessor"></span>        Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page);
01451         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == <a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>);
01452         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor == (PageColor &amp; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a57">MM_COLOR_MASK</a>));
01453         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != <a class="code" href="../../d4/d8/mi_8h.html#a170">MI_MAGIC_AWE_PTEFRAME</a>);
01454 <span class="preprocessor">#endif</span>
01455 <span class="preprocessor"></span>        <a class="code" href="../../d7/d5/pfnlist_8c.html#a7">MiRemovePageByColor</a> (Page, PageColor);
01456 <span class="preprocessor">#if DBG</span>
01457 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor == (PageColor &amp; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a57">MM_COLOR_MASK</a>));
01458         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
01459         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0);
01460         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != <a class="code" href="../../d4/d8/mi_8h.html#a170">MI_MAGIC_AWE_PTEFRAME</a>);
01461 <span class="preprocessor">#endif</span>
01462 <span class="preprocessor"></span>        <span class="keywordflow">return</span> Page;
01463 
01464     }
01465 
01466     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>][PageColor].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a>
01467                                                         != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
01468 
01469         <span class="comment">//</span>
01470         <span class="comment">// Remove the first entry on the zeroed by color list.</span>
01471         <span class="comment">//</span>
01472 
01473         Page = <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>][PageColor].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a>;
01474 <span class="preprocessor">#if DBG</span>
01475 <span class="preprocessor"></span>        Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page);
01476         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor == (PageColor &amp; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a57">MM_COLOR_MASK</a>));
01477         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == <a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>);
01478         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != <a class="code" href="../../d4/d8/mi_8h.html#a170">MI_MAGIC_AWE_PTEFRAME</a>);
01479 <span class="preprocessor">#endif</span>
01480 <span class="preprocessor"></span>
01481         <a class="code" href="../../d7/d5/pfnlist_8c.html#a7">MiRemovePageByColor</a> (Page, PageColor);
01482         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != <a class="code" href="../../d4/d8/mi_8h.html#a170">MI_MAGIC_AWE_PTEFRAME</a>);
01483         <span class="keywordflow">return</span> Page;
01484     }
01485 
01486     <span class="comment">//</span>
01487     <span class="comment">// Try the free page list by primary color.</span>
01488     <span class="comment">//</span>
01489 
01490     <span class="keywordflow">if</span>  (<a class="code" href="../../d8/d5/kddata_8c.html#a37">MmFreePageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a> != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
01491         Page = <a class="code" href="../../d8/d5/kddata_8c.html#a37">MmFreePageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a>;
01492         Color = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a131">MI_GET_SECONDARY_COLOR</a> (Page, <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page));
01493 
01494 <span class="preprocessor">#if DBG</span>
01495 <span class="preprocessor"></span>        Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page);
01496         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor == (PageColor &amp; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a57">MM_COLOR_MASK</a>));
01497         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == <a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>);
01498         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != <a class="code" href="../../d4/d8/mi_8h.html#a170">MI_MAGIC_AWE_PTEFRAME</a>);
01499 <span class="preprocessor">#endif</span>
01500 <span class="preprocessor"></span>        <a class="code" href="../../d7/d5/pfnlist_8c.html#a7">MiRemovePageByColor</a> (Page, Color);
01501 <span class="preprocessor">#if DBG</span>
01502 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor == (PageColor &amp; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a57">MM_COLOR_MASK</a>));
01503         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
01504         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0);
01505         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != <a class="code" href="../../d4/d8/mi_8h.html#a170">MI_MAGIC_AWE_PTEFRAME</a>);
01506 <span class="preprocessor">#endif</span>
01507 <span class="preprocessor"></span>        <span class="keywordflow">return</span> Page;
01508 
01509     }
01510 
01511     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a36">MmZeroedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a> != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
01512         Page = <a class="code" href="../../d8/d5/kddata_8c.html#a36">MmZeroedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a>;
01513         Color = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a131">MI_GET_SECONDARY_COLOR</a> (Page, <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page));
01514         <a class="code" href="../../d7/d5/pfnlist_8c.html#a7">MiRemovePageByColor</a> (Page, Color);
01515 <span class="preprocessor">#if DBG</span>
01516 <span class="preprocessor"></span>        Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page);
01517         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor == (PageColor &amp; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a57">MM_COLOR_MASK</a>));
01518         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
01519         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0);
01520         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != <a class="code" href="../../d4/d8/mi_8h.html#a170">MI_MAGIC_AWE_PTEFRAME</a>);
01521 <span class="preprocessor">#endif</span>
01522 <span class="preprocessor"></span>        <span class="keywordflow">return</span> Page;
01523     }
01524 
01525     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a37">MmFreePageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> != 0) {
01526 
01527         Page = <a class="code" href="../../d7/d5/pfnlist_8c.html#a10">MiRemovePageFromList</a>(&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a37">MmFreePageListHead</a>);
01528         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page))-&gt;PteFrame != <a class="code" href="../../d4/d8/mi_8h.html#a170">MI_MAGIC_AWE_PTEFRAME</a>);
01529 
01530     } <span class="keywordflow">else</span> {
01531 
01532         <span class="comment">//</span>
01533         <span class="comment">// Check the zeroed page list, and if a page is available</span>
01534         <span class="comment">// remove it and return its value.</span>
01535         <span class="comment">//</span>
01536 
01537         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a36">MmZeroedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> != 0) {
01538 
01539             Page = <a class="code" href="../../d7/d5/pfnlist_8c.html#a10">MiRemovePageFromList</a>(&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a36">MmZeroedPageListHead</a>);
01540             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page))-&gt;PteFrame != <a class="code" href="../../d4/d8/mi_8h.html#a170">MI_MAGIC_AWE_PTEFRAME</a>);
01541 
01542         } <span class="keywordflow">else</span> {
01543 
01544             <span class="comment">//</span>
01545             <span class="comment">// No pages exist on the free or zeroed list, use the</span>
01546             <span class="comment">// standby list.</span>
01547             <span class="comment">//</span>
01548 
01549             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d5/kddata_8c.html#a38">MmStandbyPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> != 0);
01550 
01551             Page = <a class="code" href="../../d7/d5/pfnlist_8c.html#a10">MiRemovePageFromList</a>(&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a38">MmStandbyPageListHead</a>);
01552             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page))-&gt;PteFrame != <a class="code" href="../../d4/d8/mi_8h.html#a170">MI_MAGIC_AWE_PTEFRAME</a>);
01553         }
01554     }
01555 
01556     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a122">MI_CHECK_PAGE_ALIGNMENT</a>(Page, PageColor &amp; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a57">MM_COLOR_MASK</a>);
01557 <span class="preprocessor">#if DBG</span>
01558 <span class="preprocessor"></span>    Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (Page);
01559     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
01560     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0);
01561 <span class="preprocessor">#endif</span>
01562 <span class="preprocessor"></span>    <span class="keywordflow">return</span> Page;
01563 }
01564 
01565 
01566 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01567"></a><a class="code" href="../../d7/d5/pfnlist_8c.html#a7">01567</a> <a class="code" href="../../d7/d5/pfnlist_8c.html#a7">MiRemovePageByColor</a> (
01568     IN PFN_NUMBER Page,
01569     IN ULONG Color
01570     )
01571 
01572 <span class="comment">/*++</span>
01573 <span class="comment"></span>
01574 <span class="comment">Routine Description:</span>
01575 <span class="comment"></span>
01576 <span class="comment">    This procedure removes a page from the middle of the free or</span>
01577 <span class="comment">    zeroed page list.</span>
01578 <span class="comment"></span>
01579 <span class="comment">Arguments:</span>
01580 <span class="comment"></span>
01581 <span class="comment">    PageFrameIndex - Supplies the physical page number to unlink from the</span>
01582 <span class="comment">                     list.</span>
01583 <span class="comment"></span>
01584 <span class="comment">Return Value:</span>
01585 <span class="comment"></span>
01586 <span class="comment">    none.</span>
01587 <span class="comment"></span>
01588 <span class="comment">Environment:</span>
01589 <span class="comment"></span>
01590 <span class="comment">    Must be holding the PFN database mutex with APCs disabled.</span>
01591 <span class="comment"></span>
01592 <span class="comment">--*/</span>
01593 
01594 {
01595     <a class="code" href="../../d0/d4/struct__MMPFNLIST.html">PMMPFNLIST</a> ListHead;
01596     <a class="code" href="../../d0/d4/struct__MMPFNLIST.html">PMMPFNLIST</a> PrimaryListHead;
01597     PFN_NUMBER Previous;
01598     PFN_NUMBER Next;
01599     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01600     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
01601     ULONG PrimaryColor;
01602 
01603     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
01604 
01605     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (Page);
01606     PrimaryColor = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor;
01607 
01608     <a class="code" href="../../d2/d1/mm_8h.html#a90">PERFINFO_REMOVEPAGE</a>(Page, PERFINFO_LOG_TYPE_REMOVEPAGEBYCOLOR);
01609 
01610     ListHead = <a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation];
01611 
01612     ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> -= 1;
01613 
01614     PrimaryListHead = ListHead;
01615 
01616 <span class="preprocessor">#if PFN_CONSISTENCY</span>
01617 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[PrimaryListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o1">ListName</a>][Color].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> != Page) {
01618 
01619         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (PFN_LIST_CORRUPT,
01620                       0x9A,
01621                       Page,
01622                       Color,
01623                       (PFN_NUMBER)&amp;<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[PrimaryListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o1">ListName</a>][Color].Flink);
01624     }
01625 <span class="preprocessor">#endif</span>
01626 <span class="preprocessor"></span>
01627     Next = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink;
01628     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink = 0;         <span class="comment">// Assumes Flink width is &gt;= WsIndex width</span>
01629     Previous = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink;
01630     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = 0;
01631 
01632     <span class="keywordflow">if</span> (Next == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
01633         PrimaryListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o3">Blink</a> = Previous;
01634     } <span class="keywordflow">else</span> {
01635         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Next);
01636         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = Previous;
01637     }
01638 
01639     <span class="keywordflow">if</span> (Previous == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
01640         PrimaryListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a> = Next;
01641     } <span class="keywordflow">else</span> {
01642         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Previous);
01643         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink = Next;
01644     }
01645 
01646     <span class="comment">//</span>
01647     <span class="comment">// Zero the flags longword, but keep the color information.</span>
01648     <span class="comment">//</span>
01649 
01650     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.RemovalRequested == 0);
01651     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ShortFlags = 0;
01652     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = PrimaryColor;
01653 
01654     <span class="comment">//</span>
01655     <span class="comment">// Update the color lists.</span>
01656     <span class="comment">//</span>
01657 
01658     <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[ListHead-&gt;ListName][Color].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> =
01659                                         (PFN_NUMBER) Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
01660 
01661     <span class="comment">//</span>
01662     <span class="comment">// Note that we now have one less page available.</span>
01663     <span class="comment">//</span>
01664 
01665     <a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> -= 1;
01666 
01667     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a726">MmMinimumFreePages</a>) {
01668 
01669         <span class="comment">//</span>
01670         <span class="comment">// Obtain free pages.</span>
01671         <span class="comment">//</span>
01672 
01673         <a class="code" href="../../d5/d0/wsmanage_8c.html#a40">MiObtainFreePages</a>();
01674 
01675     }
01676 
01677     <span class="keywordflow">return</span>;
01678 }
01679 
01680 
01681 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01682 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l01683"></a><a class="code" href="../../d7/d5/pfnlist_8c.html#a16">01683</a> <a class="code" href="../../d7/d5/pfnlist_8c.html#a16">MiInsertFrontModifiedNoWrite</a> (
01684     IN PFN_NUMBER PageFrameIndex
01685     )
01686 
01687 <span class="comment">/*++</span>
01688 <span class="comment"></span>
01689 <span class="comment">Routine Description:</span>
01690 <span class="comment"></span>
01691 <span class="comment">    This procedure inserts a page at the FRONT of the modified no</span>
01692 <span class="comment">    write list.</span>
01693 <span class="comment"></span>
01694 <span class="comment">Arguments:</span>
01695 <span class="comment"></span>
01696 <span class="comment">    PageFrameIndex - Supplies the physical page number to insert in the</span>
01697 <span class="comment">                     list.</span>
01698 <span class="comment"></span>
01699 <span class="comment">Return Value:</span>
01700 <span class="comment"></span>
01701 <span class="comment">    none.</span>
01702 <span class="comment"></span>
01703 <span class="comment">Environment:</span>
01704 <span class="comment"></span>
01705 <span class="comment">    Must be holding the PFN database mutex with APCs disabled.</span>
01706 <span class="comment"></span>
01707 <span class="comment">--*/</span>
01708 
01709 {
01710     PFN_NUMBER first;
01711     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01712     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
01713 
01714     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
01715     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((PageFrameIndex != 0) &amp;&amp; (PageFrameIndex &lt;= <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) &amp;&amp;
01716         (PageFrameIndex &gt;= <a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>));
01717 
01718     <span class="comment">//</span>
01719     <span class="comment">// Check to ensure the reference count for the page</span>
01720     <span class="comment">// is zero.</span>
01721     <span class="comment">//</span>
01722 
01723     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageFrameIndex);
01724 
01725     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
01726 
01727     <a class="code" href="../../d8/d5/kddata_8c.html#a40">MmModifiedNoWritePageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> += 1;  <span class="comment">// One more page on the list.</span>
01728 
01729     <a class="code" href="../../d7/d5/pfnlist_8c.html#a2">MI_TALLY_TRANSITION_PAGE_ADDITION</a> (Pfn1);
01730 
01731     first = <a class="code" href="../../d8/d5/kddata_8c.html#a40">MmModifiedNoWritePageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a>;
01732     <span class="keywordflow">if</span> (first == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
01733 
01734         <span class="comment">//</span>
01735         <span class="comment">// List is empty add the page to the ListHead.</span>
01736         <span class="comment">//</span>
01737 
01738         <a class="code" href="../../d8/d5/kddata_8c.html#a40">MmModifiedNoWritePageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o3">Blink</a> = PageFrameIndex;
01739     } <span class="keywordflow">else</span> {
01740         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (first);
01741         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = PageFrameIndex;
01742     }
01743 
01744     <a class="code" href="../../d8/d5/kddata_8c.html#a40">MmModifiedNoWritePageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a> = PageFrameIndex;
01745     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink = first;
01746     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
01747     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a175">ModifiedNoWritePageList</a>;
01748     <span class="keywordflow">return</span>;
01749 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:09 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
