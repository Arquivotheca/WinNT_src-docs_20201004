<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: mtrr.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>mtrr.c File Reference</h1><code>#include "<a class="el" href="../../d1/d9/ki_8h-source.html">ki.h</a>"</code><br>
<code>#include "<a class="el" href="../../d0/d4/mtrr_8h-source.html">mtrr.h</a>"</code><br>

<p>
<a href="../../d9/d3/mtrr_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/struct__ONE__RANGE.html">_ONE_RANGE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/struct__MTRR__RANGE.html">_MTRR_RANGE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/struct__RANGE__INFO.html">_RANGE_INFO</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/struct__NEW__RANGE.html">_NEW_RANGE</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/mtrr_8c.html#a0">STATIC</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/mtrr_8c.html#a1">IDBG</a>&nbsp;&nbsp;&nbsp;0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/mtrr_8c.html#a2">DBGMSG</a>(a)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/mtrr_8c.html#a3">GROW_RANGE_TABLE</a>&nbsp;&nbsp;&nbsp;4</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/mtrr_8c.html#a4">MOV_EAX_CR4</a>&nbsp;&nbsp;&nbsp;_emit { 0Fh, 20h, E0h }</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/mtrr_8c.html#a5">MOV_CR4_EAX</a>&nbsp;&nbsp;&nbsp;_emit { 0Fh, 22h, E0h }</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d2/d7/struct__ONE__RANGE.html">_ONE_RANGE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/mtrr_8c.html#a6">ONE_RANGE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d2/d7/struct__ONE__RANGE.html">_ONE_RANGE</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/mtrr_8c.html#a7">PONE_RANGE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d5/d0/struct__MTRR__RANGE.html">_MTRR_RANGE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/mtrr_8c.html#a8">MTRR_RANGE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d5/d0/struct__MTRR__RANGE.html">_MTRR_RANGE</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/mtrr_8c.html#a9">PMTRR_RANGE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d5/d2/struct__RANGE__INFO.html">_RANGE_INFO</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/mtrr_8c.html#a10">RANGE_INFO</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d5/d2/struct__RANGE__INFO.html">_RANGE_INFO</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/mtrr_8c.html#a11">PRANGE_INFO</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d2/struct__NEW__RANGE.html">_NEW_RANGE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/mtrr_8c.html#a12">NEW_RANGE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d2/struct__NEW__RANGE.html">_NEW_RANGE</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/mtrr_8c.html#a13">PNEW_RANGE</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/mtrr_8c.html#a16">KiInitializeMTRR</a> (IN BOOLEAN LastProcessor)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/mtrr_8c.html#a17">KiRemoveRange</a> (IN <a class="el" href="../../d0/d2/struct__NEW__RANGE.html">PNEW_RANGE</a> NewRange, IN ULONGLONG Base, IN ULONGLONG Limit, IN PBOOLEAN RemoveThisType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/mtrr_8c.html#a18">KiAddRange</a> (IN <a class="el" href="../../d0/d2/struct__NEW__RANGE.html">PNEW_RANGE</a> NewRange, IN ULONGLONG Base, IN ULONGLONG Limit, IN UCHAR Type)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/mtrr_8c.html#a19">KiStartEffectiveRangeChange</a> (IN <a class="el" href="../../d0/d2/struct__NEW__RANGE.html">PNEW_RANGE</a> NewRange)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/mtrr_8c.html#a20">KiCompleteEffectiveRangeChange</a> (IN <a class="el" href="../../d0/d2/struct__NEW__RANGE.html">PNEW_RANGE</a> NewRange)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>STATIC ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/mtrr_8c.html#a21">KiRangeWeight</a> (IN <a class="el" href="../../d2/d7/struct__ONE__RANGE.html">PONE_RANGE</a> Range)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>STATIC ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/mtrr_8c.html#a22">KiFindFirstSetLeftBit</a> (IN ULONGLONG Set)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>STATIC ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/mtrr_8c.html#a23">KiFindFirstSetRightBit</a> (IN ULONGLONG Set)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/mtrr_8c.html#a24">KiLoadMTRRTarget</a> (IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a54">PKIPI_CONTEXT</a> SignalDone, IN PVOID Context, IN PVOID Parameter2, IN PVOID Parameter3)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/mtrr_8c.html#a25">KiLoadMTRR</a> (IN <a class="el" href="../../d0/d2/struct__NEW__RANGE.html">PNEW_RANGE</a> Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/mtrr_8c.html#a26">KiSynchronizeMTRRLoad</a> (IN <a class="el" href="../../d0/d2/struct__NEW__RANGE.html">PNEW_RANGE</a> Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONGLONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/mtrr_8c.html#a27">KiMaskToLength</a> (IN ULONGLONG Mask)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONGLONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/mtrr_8c.html#a28">KiLengthToMask</a> (IN ULONGLONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/mtrr_8c.html#a29">KiAmdK6MtrrSetMemoryType</a> (IN ULONG BaseAddress, IN ULONG NumberOfBytes, IN <a class="el" href="../../d4/d9/ke_8h.html#a156">MEMORY_CACHING_TYPE</a> CacheType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/mtrr_8c.html#a30">KiAmdK6MtrrWRMSR</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/mtrr_8c.html#a31">KeRestoreMtrr</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/mtrr_8c.html#a32">KeSetPhysicalCacheTypeRange</a> (IN PHYSICAL_ADDRESS PhysicalAddress, IN ULONG NumberOfBytes, IN <a class="el" href="../../d4/d9/ke_8h.html#a156">MEMORY_CACHING_TYPE</a> CacheType)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>KSPIN_LOCK&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/mtrr_8c.html#a14">KiRangeLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d5/d2/struct__RANGE__INFO.html">RANGE_INFO</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a2" doxytag="mtrr.c::DBGMSG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DBGMSG          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00038">38</a> of file <a class="el" href="../../d9/d3/mtrr_8c-source.html">mtrr.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="mtrr.c::GROW_RANGE_TABLE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define GROW_RANGE_TABLE&nbsp;&nbsp;&nbsp;4          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00055">55</a> of file <a class="el" href="../../d9/d3/mtrr_8c-source.html">mtrr.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00992">KiAddRange()</a>, and <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00275">KiInitializeMTRR()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="mtrr.c::IDBG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IDBG&nbsp;&nbsp;&nbsp;0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00033">33</a> of file <a class="el" href="../../d9/d3/mtrr_8c-source.html">mtrr.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="mtrr.c::MOV_CR4_EAX" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MOV_CR4_EAX&nbsp;&nbsp;&nbsp;_emit { 0Fh, 22h, E0h }          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01793">1793</a> of file <a class="el" href="../../d9/d3/mtrr_8c-source.html">mtrr.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="mtrr.c::MOV_EAX_CR4" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MOV_EAX_CR4&nbsp;&nbsp;&nbsp;_emit { 0Fh, 20h, E0h }          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01792">1792</a> of file <a class="el" href="../../d9/d3/mtrr_8c-source.html">mtrr.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="mtrr.c::STATIC" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define STATIC          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00031">31</a> of file <a class="el" href="../../d9/d3/mtrr_8c-source.html">mtrr.c</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a8" doxytag="mtrr.c::MTRR_RANGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d5/d0/struct__MTRR__RANGE.html">_MTRR_RANGE</a>  <a class="el" href="../../d5/d0/struct__MTRR__RANGE.html">MTRR_RANGE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="mtrr.c::NEW_RANGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d2/struct__NEW__RANGE.html">_NEW_RANGE</a>  <a class="el" href="../../d0/d2/struct__NEW__RANGE.html">NEW_RANGE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="mtrr.c::ONE_RANGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d2/d7/struct__ONE__RANGE.html">_ONE_RANGE</a>  <a class="el" href="../../d2/d7/struct__ONE__RANGE.html">ONE_RANGE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00275">KiInitializeMTRR()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="mtrr.c::PMTRR_RANGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d5/d0/struct__MTRR__RANGE.html">_MTRR_RANGE</a> * <a class="el" href="../../d5/d0/struct__MTRR__RANGE.html">PMTRR_RANGE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01112">KiCompleteEffectiveRangeChange()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="mtrr.c::PNEW_RANGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d2/struct__NEW__RANGE.html">_NEW_RANGE</a> * <a class="el" href="../../d0/d2/struct__NEW__RANGE.html">PNEW_RANGE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01766">KiLoadMTRRTarget()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="mtrr.c::PONE_RANGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d2/d7/struct__ONE__RANGE.html">_ONE_RANGE</a> * <a class="el" href="../../d2/d7/struct__ONE__RANGE.html">PONE_RANGE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00992">KiAddRange()</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01112">KiCompleteEffectiveRangeChange()</a>, and <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00855">KiRemoveRange()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="mtrr.c::PRANGE_INFO" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d5/d2/struct__RANGE__INFO.html">_RANGE_INFO</a> * <a class="el" href="../../d5/d2/struct__RANGE__INFO.html">PRANGE_INFO</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="mtrr.c::RANGE_INFO" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d5/d2/struct__RANGE__INFO.html">_RANGE_INFO</a>  <a class="el" href="../../d5/d2/struct__RANGE__INFO.html">RANGE_INFO</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a31" doxytag="mtrr.c::KeRestoreMtrr" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KeRestoreMtrr           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00526">526</a> of file <a class="el" href="../../d9/d3/mtrr_8c-source.html">mtrr.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02007">KeAcquireSpinLock</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02780">KeFeatureBits</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock()</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02717">KF_AMDK6MTRR</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01112">KiCompleteEffectiveRangeChange()</a>, <a class="el" href="../../d0/d5/mtrramd_8c.html#a23">KiLoadMTRR()</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00272">KiRangeInfo</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00265">KiRangeLock</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01060">KiStartEffectiveRangeChange()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00084">_RANGE_INFO::RangesValid</a>.
<p>
<pre class="fragment"><div>00531                    :
00532 
00533     This function reloads <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> MTRR registers to be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current
00534     known values.   This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used on a system wakeup to ensure <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00535     registers are sane.
00536 
00537     N.B. The caller must have <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PAGELK code locked
00538 
00539 Arguments:
00540 
00541     none
00542 
00543 Return Value:
00544 
00545     none
00546 
00547 --*/
00548 {
00549     <a class="code" href="../../d0/d2/struct__NEW__RANGE.html">NEW_RANGE</a>           NewRange;
00550     KIRQL               OldIrql;
00551 
00552     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o3">RangesValid</a>) {
00553         RtlZeroMemory (&amp;NewRange, <span class="keyword">sizeof</span> (NewRange));
00554         <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a> (&amp;KiRangeLock, &amp;OldIrql);
00555         <a class="code" href="../../d8/d4/mtrr_8c.html#a19">KiStartEffectiveRangeChange</a> (&amp;NewRange);
00556         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NewRange.<a class="code" href="../../d0/d2/struct__NEW__RANGE.html#o0">Status</a>));
00557         <a class="code" href="../../d8/d4/mtrr_8c.html#a20">KiCompleteEffectiveRangeChange</a> (&amp;NewRange);
00558         <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a> (&amp;KiRangeLock, OldIrql);
00559         <span class="keywordflow">return</span>;
00560     }
00561 
00562         <span class="comment">//</span>
00563         <span class="comment">// If the processor is a AMD K6 with MTRR support then perform</span>
00564         <span class="comment">// processor specific implentaiton.</span>
00565         <span class="comment">//</span>
00566 
00567         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a15">KF_AMDK6MTRR</a>) {
00568         <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a> (&amp;KiRangeLock, &amp;OldIrql);
00569                 <a class="code" href="../../d0/d5/mtrramd_8c.html#a23">KiLoadMTRR</a>(NULL);
00570         <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a> (&amp;KiRangeLock, OldIrql);
00571         }
00572 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="mtrr.c::KeSetPhysicalCacheTypeRange" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS KeSetPhysicalCacheTypeRange           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PHYSICAL_ADDRESS&nbsp;</td>
          <td class="mdname" nowrap> <em>PhysicalAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/ke_8h.html#a156">MEMORY_CACHING_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CacheType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00576">576</a> of file <a class="el" href="../../d9/d3/mtrr_8c-source.html">mtrr.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00077">_RANGE_INFO::Capabilities</a>, <a class="el" href="../../d8/d8/assign_8c-source.html#l00348">DBGMSG</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00078">_RANGE_INFO::DefaultCachedType</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02007">KeAcquireSpinLock</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02780">KeFeatureBits</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock()</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02717">KF_AMDK6MTRR</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00992">KiAddRange()</a>, <a class="el" href="../../d1/d4/mtrramd_8c-source.html#l00294">KiAmdK6MtrrSetMemoryType()</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01112">KiCompleteEffectiveRangeChange()</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00272">KiRangeInfo</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00265">KiRangeLock</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00855">KiRemoveRange()</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01060">KiStartEffectiveRangeChange()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a248">MmNonCached</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a253">MmUSWCCached</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a>, <a class="el" href="../../d0/d4/mtrr_8h-source.html#l00047">MTRR_TYPE_MAX</a>, <a class="el" href="../../d0/d4/mtrr_8h-source.html#l00042">MTRR_TYPE_UC</a>, <a class="el" href="../../d0/d4/mtrr_8h-source.html#l00043">MTRR_TYPE_USWC</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00085">_RANGE_INFO::MtrrWorkaround</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00084">_RANGE_INFO::RangesValid</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d9/d9/struct__MTRR__CAPABILITIES.html#o8">_MTRR_CAPABILITIES::u</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l03415">MmMapIoSpace()</a>.
<p>
<pre class="fragment"><div>00583                    :
00584 
00585     This function sets a physical range to a particular cache <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
00586     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system does not support setting cache policies based on
00587     physical ranges, no action <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> taken.
00588 
00589 Arguments:
00590 
00591     PhysicalAddress - The starting address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range being set
00592 
00593     NumberOfBytes   - The length, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range being set
00594 
00595     CacheType       - The caching <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <span class="keywordflow">for</span> which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical range <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00596                       to be set to.
00597 
00598                      NonCached:
00599                         Setting ranges to be NonCached <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done <span class="keywordflow">for</span>
00600                         book keeping reasons.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <span class="keywordflow">return</span> of SUCCESS when
00601                         setting a range NonCached does not mean <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> has
00602                         been physically set to as NonCached.  The caller
00603                         must use a cache-disabled <span class="keyword">virtual</span> pointer <span class="keywordflow">for</span>
00604                         any NonCached range.
00605 
00606                      Cached:
00607                         <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> successful <span class="keywordflow">return</span> indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical
00608                         range has been set to cached.   This mode requires
00609                         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller to be at irql &lt; dispatch_level.
00610 
00611                      FrameBuffer:
00612                         <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> successful <span class="keywordflow">return</span> indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical
00613                         range has been set to be framebuffer cached.
00614                         This mode requires <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller to be at irql &lt;
00615                         dispatch_level.
00616 
00617                      USWCCached:
00618                         This <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be satisfied <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> via <a class="code" href="../../d2/d9/union__PAT.html">PAT</a> and
00619                         fails <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> MTRR interface.
00620 
00621 Return Value:
00622 
00623     STATUS_SUCCESS - <span class="keywordflow">if</span> success, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cache attributes of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical range
00624                      have been set.
00625 
00626     STATUS_NOT_SUPPORTED - either feature not supported or not yet initialized,
00627                            or <a class="code" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> not supported and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00628                            requested, or input range does not match restrictions
00629                            imposed by workarounds <span class="keywordflow">for</span> current processor stepping
00630                            or <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> below 1M (in the fixed MTRR range), or not yet
00631                            initialized.
00632 
00633     STATUS_UNSUCCESSFUL - Unable to satisfy request due to
00634                         - Unable to map software image into limited # of
00635                           hardware MTRRs.
00636                         - irql was not &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>.
00637                         - Failure due to other internal error (out of memory).
00638 
00639   STATUS_INVALID_PARAMETER - Incorrect input memory <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
00640 
00641 --*/
00642 {
00643     KIRQL               OldIrql;
00644     <a class="code" href="../../d0/d2/struct__NEW__RANGE.html">NEW_RANGE</a>           NewRange;
00645     BOOLEAN             RemoveThisType[<a class="code" href="../../d9/d4/mtrr_8h.html#a11">MTRR_TYPE_MAX</a>];
00646     BOOLEAN             EffectRangeChange, AddToRangeDatabase;
00647 
00648     <span class="comment">//</span>
00649     <span class="comment">// If caller has requested the MmUSWCCached memory type then fail</span>
00650     <span class="comment">// - MmUSWCCached is supported via PAT and not otherwise</span>
00651     <span class="comment">//</span>
00652 
00653     <span class="keywordflow">if</span> (CacheType == <a class="code" href="../../d4/d9/ke_8h.html#a413a253">MmUSWCCached</a>) {
00654         <span class="keywordflow">return</span> STATUS_NOT_SUPPORTED;
00655     }
00656 
00657     <span class="comment">//</span>
00658     <span class="comment">// Addresses above 4GB, below 1MB or not page aligned and</span>
00659     <span class="comment">// page length are not supported.</span>
00660     <span class="comment">//</span>
00661 
00662     <span class="keywordflow">if</span> ((PhysicalAddress.HighPart != 0)               ||
00663         (PhysicalAddress.LowPart &lt; (1 * 1024 * 1024)) ||
00664         (PhysicalAddress.LowPart &amp; 0xfff)             ||
00665         (NumberOfBytes &amp; 0xfff)                          ) {
00666         <span class="keywordflow">return</span> STATUS_NOT_SUPPORTED;
00667     }
00668 
00669     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfBytes != 0);
00670 
00671         <span class="comment">//</span>
00672         <span class="comment">// If the processor is a AMD K6 with MTRR support then perform</span>
00673         <span class="comment">// processor specific implentaiton.</span>
00674         <span class="comment">//</span>
00675 
00676         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a15">KF_AMDK6MTRR</a>) {
00677 
00678             <span class="keywordflow">if</span> ((CacheType != <a class="code" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a>) &amp;&amp; (CacheType != <a class="code" href="../../d4/d9/ke_8h.html#a413a248">MmNonCached</a>)) {
00679             <span class="keywordflow">return</span> STATUS_NOT_SUPPORTED;
00680         }
00681 
00682                 <span class="keywordflow">return</span> <a class="code" href="../../d0/d5/mtrramd_8c.html#a26">KiAmdK6MtrrSetMemoryType</a>(PhysicalAddress.LowPart,
00683                                                     NumberOfBytes,
00684                                                     CacheType);
00685         }
00686 
00687     <span class="comment">//</span>
00688     <span class="comment">// If processor doesn't have the memory type range feature</span>
00689     <span class="comment">// return not supported.</span>
00690     <span class="comment">//</span>
00691 
00692     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o3">RangesValid</a>) {
00693         <span class="keywordflow">return</span> STATUS_NOT_SUPPORTED;
00694     }
00695 
00696     <span class="comment">//</span>
00697     <span class="comment">// Workaround for cpu signatures 611, 612, 616 and 617</span>
00698     <span class="comment">// - if the request for setting a variable MTRR specifies</span>
00699     <span class="comment">// an address which is not 4M aligned or length is not</span>
00700     <span class="comment">// a multiple of 4M then return status not supported</span>
00701     <span class="comment">//</span>
00702 
00703     <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o4">MtrrWorkaround</a>) &amp;&amp;
00704         ((PhysicalAddress.LowPart &amp; 0x3fffff) ||
00705          (NumberOfBytes &amp; 0x3fffff))) {
00706 
00707             <span class="keywordflow">return</span> STATUS_NOT_SUPPORTED;
00708     }
00709 
00710     RtlZeroMemory (&amp;NewRange, <span class="keyword">sizeof</span> (NewRange));
00711     NewRange.<a class="code" href="../../d0/d2/struct__NEW__RANGE.html#o1">Base</a>  = PhysicalAddress.QuadPart;
00712     NewRange.<a class="code" href="../../d0/d2/struct__NEW__RANGE.html#o2">Limit</a> = NewRange.<a class="code" href="../../d0/d2/struct__NEW__RANGE.html#o1">Base</a> + NumberOfBytes - 1;
00713 
00714     <span class="comment">//</span>
00715     <span class="comment">// Determine what the new mtrr range type is.   If setting NonCached then</span>
00716     <span class="comment">// the database need not be updated to reflect the virtual change.  This</span>
00717     <span class="comment">// is because non-cached virtual pointers are mapped as cache disabled.</span>
00718     <span class="comment">//</span>
00719 
00720     EffectRangeChange = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00721     AddToRangeDatabase = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00722     <span class="keywordflow">switch</span> (CacheType) {
00723         <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/ke_8h.html#a413a248">MmNonCached</a>:
00724             NewRange.<a class="code" href="../../d0/d2/struct__NEW__RANGE.html#o3">Type</a> = <a class="code" href="../../d9/d4/mtrr_8h.html#a6">MTRR_TYPE_UC</a>;
00725 
00726             <span class="comment">//</span>
00727             <span class="comment">// NonCached ranges do not need to be reflected into the h/w state</span>
00728             <span class="comment">// as all non-cached ranges are mapped with cache-disabled pointers.</span>
00729             <span class="comment">// This also means that cache-disabled ranges do not need to</span>
00730             <span class="comment">// be put into mtrrs, or held in the range, regardless of the default</span>
00731             <span class="comment">// range type.</span>
00732             <span class="comment">//</span>
00733 
00734             EffectRangeChange = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00735             AddToRangeDatabase = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00736             <span class="keywordflow">break</span>;
00737 
00738         <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>:
00739             NewRange.<a class="code" href="../../d0/d2/struct__NEW__RANGE.html#o3">Type</a> = <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o2">DefaultCachedType</a>;
00740             <span class="keywordflow">break</span>;
00741 
00742         <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a>:
00743             NewRange.<a class="code" href="../../d0/d2/struct__NEW__RANGE.html#o3">Type</a> = <a class="code" href="../../d9/d4/mtrr_8h.html#a7">MTRR_TYPE_USWC</a>;
00744 
00745             <span class="comment">//</span>
00746             <span class="comment">// If USWC type isn't supported, then request can not be honored</span>
00747             <span class="comment">//</span>
00748 
00749             <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o1">Capabilities</a>.<a class="code" href="../../d9/d9/struct__MTRR__CAPABILITIES.html#o8">u</a>.hw.UswcSupported) {
00750                 <a class="code" href="../../d7/d9/assign_8c.html#a19">DBGMSG</a> (<span class="stringliteral">"KeSetPhysicalCacheTypeRange: USWC not supported\n"</span>);
00751                 <span class="keywordflow">return</span> STATUS_NOT_SUPPORTED;
00752             }
00753             <span class="keywordflow">break</span>;
00754 
00755         <span class="keywordflow">default</span>:
00756             <a class="code" href="../../d7/d9/assign_8c.html#a19">DBGMSG</a> (<span class="stringliteral">"KeSetPhysicalCacheTypeRange: no such cache type\n"</span>);
00757             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00758             <span class="keywordflow">break</span>;
00759     }
00760 
00761     NewRange.<a class="code" href="../../d0/d2/struct__NEW__RANGE.html#o0">Status</a> = STATUS_SUCCESS;
00762 
00763     <span class="comment">//</span>
00764     <span class="comment">// The default type is UC thus the range is still mapped using</span>
00765     <span class="comment">// a Cache Disabled VirtualPointer and hence it need not be added.</span>
00766     <span class="comment">//</span>
00767 
00768     <span class="comment">//</span>
00769     <span class="comment">// If h/w needs updated, lock down the code required to effect the change</span>
00770     <span class="comment">//</span>
00771 
00772     <span class="keywordflow">if</span> (EffectRangeChange) {
00773         <span class="keywordflow">if</span> (KeGetCurrentIrql() &gt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
00774 
00775             <span class="comment">//</span>
00776             <span class="comment">// Code can not be locked down.   Supplying a new range type requires</span>
00777             <span class="comment">// that the caller calls at irql &lt; dispatch_level.</span>
00778             <span class="comment">//</span>
00779 
00780             <a class="code" href="../../d7/d9/assign_8c.html#a19">DBGMSG</a> (<span class="stringliteral">"KeSetPhysicalCacheTypeRange failed due to calling IRQL == DISPATCH_LEVEL\n"</span>);
00781             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00782         }
00783 
00784         <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(ExPageLockHandle);
00785     }
00786 
00787     <span class="comment">//</span>
00788     <span class="comment">// Serialize the range type database</span>
00789     <span class="comment">//</span>
00790 
00791     <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a> (&amp;KiRangeLock, &amp;OldIrql);
00792 
00793     <span class="comment">//</span>
00794     <span class="comment">// If h/w is going to need updated, then start an effective range change</span>
00795     <span class="comment">//</span>
00796 
00797     <span class="keywordflow">if</span> (EffectRangeChange) {
00798         <a class="code" href="../../d8/d4/mtrr_8c.html#a19">KiStartEffectiveRangeChange</a> (&amp;NewRange);
00799     }
00800 
00801     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (NewRange.<a class="code" href="../../d0/d2/struct__NEW__RANGE.html#o0">Status</a>)) {
00802 
00803         <span class="comment">//</span>
00804         <span class="comment">// If the new range is NonCached, then don't remove standard memory</span>
00805         <span class="comment">// caching types</span>
00806         <span class="comment">//</span>
00807 
00808         memset (RemoveThisType, TRUE, MTRR_TYPE_MAX);
00809         <span class="keywordflow">if</span> (NewRange.<a class="code" href="../../d0/d2/struct__NEW__RANGE.html#o3">Type</a> != <a class="code" href="../../d9/d4/mtrr_8h.html#a6">MTRR_TYPE_UC</a>) {
00810             <span class="comment">//</span>
00811             <span class="comment">// If the requested type is uncached then the physical</span>
00812             <span class="comment">// memory region is mapped using a cache disabled virtual pointer.</span>
00813             <span class="comment">// The effective memory type for that region will be the lowest</span>
00814             <span class="comment">// common denominator of the MTRR type and the cache type in the</span>
00815             <span class="comment">// PTE.  Therefore for a request of type UC, the effective type</span>
00816             <span class="comment">// will be UC irrespective of the MTRR settings in that range.</span>
00817             <span class="comment">// Hence it is not necessary to remove the existing MTRR settings</span>
00818             <span class="comment">// (if any) for that range.</span>
00819             <span class="comment">//</span>
00820 
00821             <span class="comment">//</span>
00822             <span class="comment">// Clip/remove any ranges in the target area</span>
00823             <span class="comment">//</span>
00824 
00825             <a class="code" href="../../d8/d4/mtrr_8c.html#a17">KiRemoveRange</a> (&amp;NewRange, NewRange.<a class="code" href="../../d0/d2/struct__NEW__RANGE.html#o1">Base</a>, NewRange.<a class="code" href="../../d0/d2/struct__NEW__RANGE.html#o2">Limit</a>, RemoveThisType);
00826         }
00827 
00828         <span class="comment">//</span>
00829         <span class="comment">// If needed, add new range type</span>
00830         <span class="comment">//</span>
00831 
00832         <span class="keywordflow">if</span> (AddToRangeDatabase) {
00833             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (EffectRangeChange == TRUE);
00834             <a class="code" href="../../d8/d4/mtrr_8c.html#a18">KiAddRange</a> (&amp;NewRange, NewRange.<a class="code" href="../../d0/d2/struct__NEW__RANGE.html#o1">Base</a>, NewRange.<a class="code" href="../../d0/d2/struct__NEW__RANGE.html#o2">Limit</a>, NewRange.<a class="code" href="../../d0/d2/struct__NEW__RANGE.html#o3">Type</a>);
00835         }
00836 
00837         <span class="comment">//</span>
00838         <span class="comment">// If this is an effect range change, then complete it</span>
00839         <span class="comment">//</span>
00840 
00841         <span class="keywordflow">if</span> (EffectRangeChange) {
00842             <a class="code" href="../../d8/d4/mtrr_8c.html#a20">KiCompleteEffectiveRangeChange</a> (&amp;NewRange);
00843         }
00844     }
00845 
00846     <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a> (&amp;KiRangeLock, OldIrql);
00847     <span class="keywordflow">if</span> (EffectRangeChange) {
00848         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
00849     }
00850 
00851     <span class="keywordflow">return</span> NewRange.<a class="code" href="../../d0/d2/struct__NEW__RANGE.html#o0">Status</a>;
00852 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="mtrr.c::KiAddRange" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiAddRange           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__NEW__RANGE.html">PNEW_RANGE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NewRange</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Base</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Limit</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00992">992</a> of file <a class="el" href="../../d9/d3/mtrr_8c-source.html">mtrr.c</a>.
<p>
References <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00050">_ONE_RANGE::Base</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00055">GROW_RANGE_TABLE</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00272">KiRangeInfo</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00051">_ONE_RANGE::Limit</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00087">_RANGE_INFO::MaxRange</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00086">_RANGE_INFO::NoRange</a>, <a class="el" href="../../d8/d4/mtrr_8c.html#a7">PONE_RANGE</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00088">_RANGE_INFO::Ranges</a>, and <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00052">_ONE_RANGE::Type</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00576">KeSetPhysicalCacheTypeRange()</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00275">KiInitializeMTRR()</a>, and <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00855">KiRemoveRange()</a>.
<p>
<pre class="fragment"><div>01000                    :
01001 
01002     This function adds <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed range to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> global range database.
01003 
01004 Arguments:
01005 
01006     NewRange        - Context information
01007 
01008     Base            - Base &amp; Limit signify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first &amp; last address of a range
01009     Limit           - which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be added to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range database
01010 
01011     Type            - Type of caching required <span class="keywordflow">for</span> <span class="keyword">this</span> range
01012 
01013 Return Value:
01014 
01015     None - Context <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> updated with an error <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> table has overflowed
01016 
01017 --*/
01018 {
01019     <a class="code" href="../../d2/d7/struct__ONE__RANGE.html">PONE_RANGE</a>      Range, OldRange;
01020     ULONG           size;
01021 
01022     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o5">NoRange</a> &gt;= <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o6">MaxRange</a>) {
01023 
01024         <span class="comment">//</span>
01025         <span class="comment">// Table is out of space, get a bigger one</span>
01026         <span class="comment">//</span>
01027 
01028         OldRange = <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>;
01029         size = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/struct__ONE__RANGE.html">ONE_RANGE</a>) * (<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o6">MaxRange</a> + <a class="code" href="../../d8/d4/mtrr_8c.html#a3">GROW_RANGE_TABLE</a>);
01030         Range  = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool, size, '  eK');
01031 
01032         <span class="keywordflow">if</span> (!Range) {
01033             NewRange-&gt;Status = STATUS_UNSUCCESSFUL;
01034             <span class="keywordflow">return</span> ;
01035         }
01036 
01037         <span class="comment">//</span>
01038         <span class="comment">// Grow table</span>
01039         <span class="comment">//</span>
01040 
01041         RtlZeroMemory (Range, size);
01042         RtlCopyMemory (Range, OldRange, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/struct__ONE__RANGE.html">ONE_RANGE</a>) * <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o6">MaxRange</a>);
01043         <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a> = Range;
01044         <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o6">MaxRange</a> += <a class="code" href="../../d8/d4/mtrr_8c.html#a3">GROW_RANGE_TABLE</a>;
01045         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (OldRange);
01046     }
01047 
01048     <span class="comment">//</span>
01049     <span class="comment">// Add new entry to table</span>
01050     <span class="comment">//</span>
01051 
01052     <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>[<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o5">NoRange</a>].<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o0">Base</a> = Base;
01053     <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>[<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o5">NoRange</a>].<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o1">Limit</a> = Limit;
01054     <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>[<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o5">NoRange</a>].<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o2">Type</a> = Type;
01055     <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o5">NoRange</a> += 1;
01056 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="mtrr.c::KiAmdK6MtrrSetMemoryType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS KiAmdK6MtrrSetMemoryType           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/ke_8h.html#a156">MEMORY_CACHING_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CacheType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="mtrr.c::KiAmdK6MtrrWRMSR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiAmdK6MtrrWRMSR           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/mtrramd_8c-source.html#l00754">754</a> of file <a class="el" href="../../d1/d4/mtrramd_8c-source.html">mtrramd.c</a>.
<p>
References <a class="el" href="../../d1/d4/mtrramd_8c-source.html#l00055">AMDK6_MTRR_MSR</a>, <a class="el" href="../../d1/d4/mtrramd_8c-source.html#l00163">KiAmdK6Mtrr</a>, <a class="el" href="../../d0/d7/struct__AMDK6__MTRR__MSR__IMAGE.html#o4">_AMDK6_MTRR_MSR_IMAGE::u</a>, and <a class="el" href="../../d5/d3/i386_8h.html#a53">WRMSR()</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01796">KiLoadMTRR()</a>.
<p>
<pre class="fragment"><div>00760                    :
00761 
00762     Write <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AMD K6 MTRRs.
00763 
00764     Note: Access to <a class="code" href="../../d0/d5/mtrramd_8c.html#a22">KiAmdK6Mtrr</a> has been <span class="keyword">synchronized</span> around <span class="keyword">this</span>
00765     call.
00766 
00767 Arguments:
00768 
00769     None.
00770 
00771 Return Value:
00772 
00773     None.
00774 
00775 --*/
00776 
00777 {
00778     <span class="comment">//</span>
00779     <span class="comment">// Write the MTRRs</span>
00780     <span class="comment">//</span>
00781 
00782     <a class="code" href="../../d5/d3/i386_8h.html#a53">WRMSR</a> (AMDK6_MTRR_MSR, <a class="code" href="../../d0/d5/mtrramd_8c.html#a22">KiAmdK6Mtrr</a>.<a class="code" href="../../d0/d7/struct__AMDK6__MTRR__MSR__IMAGE.html#o4">u</a>.QuadPart);
00783 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="mtrr.c::KiCompleteEffectiveRangeChange" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiCompleteEffectiveRangeChange           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__NEW__RANGE.html">PNEW_RANGE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>NewRange</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01112">1112</a> of file <a class="el" href="../../d9/d3/mtrr_8c-source.html">mtrr.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00062">_MTRR_RANGE::Base</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00050">_ONE_RANGE::Base</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00077">_RANGE_INFO::Capabilities</a>, <a class="el" href="../../d8/d8/assign_8c-source.html#l00348">DBGMSG</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00076">_RANGE_INFO::Default</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00091">HIGH_LEVEL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02766">KeActiveProcessors</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00069">KeGetCurrentPrcb</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01690">KiFindFirstSetLeftBit()</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01669">KiFindFirstSetRightBit()</a>, <a class="el" href="../../d3/d0/xipi_8c-source.html#l00182">KiIpiStallOnPacketTargets()</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01645">KiLengthToMask()</a>, <a class="el" href="../../d0/d5/mtrramd_8c.html#a23">KiLoadMTRR()</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01766">KiLoadMTRRTarget()</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00128">KiLockContextSwap</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01624">KiMaskToLength()</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00272">KiRangeInfo</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01586">KiRangeWeight()</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00855">KiRemoveRange()</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00131">KiUnlockContextSwap</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00051">_ONE_RANGE::Limit</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00063">_MTRR_RANGE::Mask</a>, <a class="el" href="../../d0/d4/mtrr_8h-source.html#l00112">MTRR_MASK_MASK</a>, <a class="el" href="../../d0/d4/mtrr_8h-source.html#l00122">MTRR_MAX_RANGE_SHIFT</a>, <a class="el" href="../../d0/d4/mtrr_8h-source.html#l00036">MTRR_PAGE_MASK</a>, <a class="el" href="../../d0/d4/mtrr_8h-source.html#l00035">MTRR_PAGE_SIZE</a>, <a class="el" href="../../d0/d4/mtrr_8h-source.html#l00047">MTRR_TYPE_MAX</a>, <a class="el" href="../../d0/d4/mtrr_8h-source.html#l00042">MTRR_TYPE_UC</a>, <a class="el" href="../../d0/d4/mtrr_8h-source.html#l00043">MTRR_TYPE_USWC</a>, <a class="el" href="../../d0/d4/mtrr_8h-source.html#l00046">MTRR_TYPE_WB</a>, <a class="el" href="../../d0/d4/mtrr_8h-source.html#l00044">MTRR_TYPE_WT</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00086">_RANGE_INFO::NoRange</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d4/mtrr_8c.html#a9">PMTRR_RANGE</a>, <a class="el" href="../../d8/d4/mtrr_8c.html#a7">PONE_RANGE</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00088">_RANGE_INFO::Ranges</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00052">_ONE_RANGE::Type</a>, <a class="el" href="../../d2/d0/struct__MTRR__DEFAULT.html#o8">_MTRR_DEFAULT::u</a>, <a class="el" href="../../d9/d9/struct__MTRR__CAPABILITIES.html#o8">_MTRR_CAPABILITIES::u</a>, <a class="el" href="../../d9/d0/struct__MTRR__VARIABLE__MASK.html#o7">_MTRR_VARIABLE_MASK::u</a>, and <a class="el" href="../../d6/d0/struct__MTRR__VARIABLE__BASE.html#o7">_MTRR_VARIABLE_BASE::u</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00526">KeRestoreMtrr()</a>, and <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00576">KeSetPhysicalCacheTypeRange()</a>.
<p>
<pre class="fragment"><div>01117                    :
01118 
01119     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a16">functions</a> commits <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range database to hardware, or backs
01120     <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current changes to <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
01121 
01122 Arguments:
01123 
01124     NewRange        - Context information
01125 
01126 Return Value:
01127 
01128     None
01129 
01130 --*/
01131 {
01132     BOOLEAN         Restart;
01133     ULONG           <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>, Index2, RemIndex2, NoMTRR;
01134     ULONGLONG       BestLength, WhichMtrr;
01135     ULONGLONG       CurrLength;
01136     ULONGLONG       l, Base, Length, MLength;
01137     <a class="code" href="../../d2/d7/struct__ONE__RANGE.html">PONE_RANGE</a>      Range;
01138     <a class="code" href="../../d2/d7/struct__ONE__RANGE.html">ONE_RANGE</a>       OneRange;
01139     <a class="code" href="../../d5/d0/struct__MTRR__RANGE.html">PMTRR_RANGE</a>     MTRR;
01140     BOOLEAN         RoundDown;
01141     BOOLEAN         RemoveThisType[<a class="code" href="../../d9/d4/mtrr_8h.html#a11">MTRR_TYPE_MAX</a>];
01142     PKPRCB          Prcb;
01143     KIRQL           OldIrql, OldIrql2;
01144     KAFFINITY       TargetProcessors;
01145 
01146 
01147     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == DISPATCH_LEVEL);
01148     Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
01149 
01150     <span class="comment">//</span>
01151     <span class="comment">// Round all ranges, according to type, to match what h/w can support</span>
01152     <span class="comment">//</span>
01153 
01154     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>=0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o5">NoRange</a>; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++) {
01155         Range = &amp;<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01156 
01157         <span class="comment">//</span>
01158         <span class="comment">// Determine rounding for this range type</span>
01159         <span class="comment">//</span>
01160 
01161         RoundDown = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01162         <span class="keywordflow">if</span> (Range-&gt;<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o2">Type</a> == <a class="code" href="../../d9/d4/mtrr_8h.html#a6">MTRR_TYPE_UC</a>) {
01163             RoundDown = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01164         }
01165 
01166         <span class="comment">//</span>
01167         <span class="comment">// Apply rounding</span>
01168         <span class="comment">//</span>
01169 
01170         <span class="keywordflow">if</span> (RoundDown) {
01171             Range-&gt;<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o0">Base</a>  = (Range-&gt;<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o0">Base</a>  + <a class="code" href="../../d9/d4/mtrr_8h.html#a4">MTRR_PAGE_SIZE</a> - 1) &amp; <a class="code" href="../../d9/d4/mtrr_8h.html#a5">MTRR_PAGE_MASK</a>;
01172             Range-&gt;<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o1">Limit</a> = ((Range-&gt;<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o1">Limit</a>+1) &amp; <a class="code" href="../../d9/d4/mtrr_8h.html#a5">MTRR_PAGE_MASK</a>)-1;
01173         } <span class="keywordflow">else</span> {
01174             Range-&gt;<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o0">Base</a>  = (Range-&gt;<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o0">Base</a>  &amp; <a class="code" href="../../d9/d4/mtrr_8h.html#a5">MTRR_PAGE_MASK</a>);
01175             Range-&gt;<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o1">Limit</a> = ((Range-&gt;<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o1">Limit</a> + <a class="code" href="../../d9/d4/mtrr_8h.html#a4">MTRR_PAGE_SIZE</a>) &amp; <a class="code" href="../../d9/d4/mtrr_8h.html#a5">MTRR_PAGE_MASK</a>)-1;
01176         }
01177     }
01178 
01179     <span class="keywordflow">do</span> {
01180         Restart = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01181 
01182         <span class="comment">//</span>
01183         <span class="comment">// Sort the ranges by base address</span>
01184         <span class="comment">//</span>
01185 
01186         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>=0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o5">NoRange</a>; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++) {
01187             Range = &amp;<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01188 
01189             <span class="keywordflow">for</span> (Index2=<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>+1; Index2 &lt; <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o5">NoRange</a>; Index2++) {
01190 
01191                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>[Index2].<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o0">Base</a> &lt; Range-&gt;<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o0">Base</a>) {
01192 
01193                     <span class="comment">//</span>
01194                     <span class="comment">// Swap KiRangeInfo.Ranges[Index] with KiRangeInfo.Ranges[Index2]</span>
01195                     <span class="comment">//</span>
01196 
01197                     OneRange = *Range;
01198                     *Range = <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>[Index2];
01199                     <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>[Index2] = OneRange;
01200                 }
01201             }
01202         }
01203 
01204         <span class="comment">//</span>
01205         <span class="comment">// At this point the range database is sorted on</span>
01206         <span class="comment">// base address. Scan range database combining adjacent and</span>
01207         <span class="comment">// overlapping ranges of the same type</span>
01208         <span class="comment">//</span>
01209 
01210         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>=0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; (ULONG) <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o5">NoRange</a>-1; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++) {
01211             Range = &amp;<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01212 
01213             <span class="comment">//</span>
01214             <span class="comment">// Scan the range database. If ranges are adjacent/overlap and are of</span>
01215             <span class="comment">// the same type, combine them.</span>
01216             <span class="comment">//</span>
01217 
01218             <span class="keywordflow">for</span> (Index2 = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>+1; Index2 &lt; (ULONG) <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o5">NoRange</a>; Index2++) {
01219 
01220                 l = Range[0].<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o1">Limit</a> + 1;
01221                 <span class="keywordflow">if</span> (l &lt; Range[0].Limit) {
01222                     l = Range[0].Limit;
01223                 }
01224 
01225                 <span class="keywordflow">if</span> (l &gt;= <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>[Index2].<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o0">Base</a>  &amp;&amp;
01226                     Range[0].Type == <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>[Index2].<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o2">Type</a>) {
01227 
01228                     <span class="comment">//</span>
01229                     <span class="comment">// Increase Range[0] limit to cover Range[Index2]</span>
01230                     <span class="comment">//</span>
01231 
01232                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>[Index2].<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o1">Limit</a> &gt; Range[0].Limit) {
01233                         Range[0].Limit = <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>[Index2].<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o1">Limit</a>;
01234                     }
01235 
01236                     <span class="comment">//</span>
01237                     <span class="comment">// Remove KiRangeInfo.Ranges[Index2]</span>
01238                     <span class="comment">//</span>
01239 
01240                     <span class="keywordflow">if</span> (Index2 &lt; (ULONG) <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o5">NoRange</a> - 1 ) {
01241 
01242                         <span class="comment">//</span>
01243                         <span class="comment">// Copy everything from Index2 till end</span>
01244                         <span class="comment">// of range list. # Entries to copy is</span>
01245                         <span class="comment">// (KiRangeInfo.NoRange -1) - (Index2+1) + 1</span>
01246                         <span class="comment">//</span>
01247 
01248                         RtlCopyMemory(
01249                             &amp;(<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>[Index2]),
01250                             &amp;(<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>[Index2+1]),
01251                             <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/struct__ONE__RANGE.html">ONE_RANGE</a>) * (<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o5">NoRange</a>-Index2-1)
01252                             );
01253                     }
01254 
01255                     <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o5">NoRange</a> -= 1;
01256 
01257                     <span class="comment">//</span>
01258                     <span class="comment">// Recheck current location</span>
01259                     <span class="comment">//</span>
01260 
01261                     Index2 -= 1;
01262                 }
01263             }
01264         }
01265 
01266         <span class="comment">//</span>
01267         <span class="comment">// At this point the range database is sorted on base</span>
01268         <span class="comment">// address and adjacent/overlapping ranges of the same</span>
01269         <span class="comment">// type are combined. Check for overlapping ranges -</span>
01270         <span class="comment">// If legal then allow else truncate the less "weighty" range</span>
01271         <span class="comment">//</span>
01272 
01273         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; (ULONG) <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o5">NoRange</a>-1  &amp;&amp;  !Restart; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++) {
01274 
01275             Range = &amp;<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01276 
01277             l = Range[0].<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o1">Limit</a> + 1;
01278             <span class="keywordflow">if</span> (l &lt; Range[0].Limit) {
01279                 l = Range[0].Limit;
01280             }
01281 
01282             <span class="comment">//</span>
01283             <span class="comment">// If ranges overlap and are not of same type, and if the</span>
01284             <span class="comment">// overlap is not legal then carve them to the best cache type</span>
01285             <span class="comment">// available.</span>
01286             <span class="comment">//</span>
01287 
01288             <span class="keywordflow">for</span> (Index2 = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>+1; Index2 &lt; (ULONG) <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o5">NoRange</a> &amp;&amp; !Restart; Index2++) {
01289 
01290                 <span class="keywordflow">if</span> (l &gt; <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>[Index2].<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o0">Base</a>) {
01291 
01292                     <span class="keywordflow">if</span> (Range[0].Type == <a class="code" href="../../d9/d4/mtrr_8h.html#a6">MTRR_TYPE_UC</a> ||
01293                         <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>[Index2].<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o2">Type</a> == <a class="code" href="../../d9/d4/mtrr_8h.html#a6">MTRR_TYPE_UC</a>) {
01294 
01295                         <span class="comment">//</span>
01296                         <span class="comment">// Overlap of a UC type with a range of any other type is</span>
01297                         <span class="comment">// legal</span>
01298                         <span class="comment">//</span>
01299 
01300                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Range[0].Type == <a class="code" href="../../d9/d4/mtrr_8h.html#a8">MTRR_TYPE_WT</a> &amp;&amp;
01301                                 <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>[Index2].<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o2">Type</a> == <a class="code" href="../../d9/d4/mtrr_8h.html#a10">MTRR_TYPE_WB</a>) ||
01302                                (Range[0].Type == <a class="code" href="../../d9/d4/mtrr_8h.html#a10">MTRR_TYPE_WB</a> &amp;&amp;
01303                                 <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>[Index2].<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o2">Type</a> == <a class="code" href="../../d9/d4/mtrr_8h.html#a8">MTRR_TYPE_WT</a>) ) {
01304                         <span class="comment">//</span>
01305                         <span class="comment">// Overlap of WT and WB range is legal. The overlap range will</span>
01306                         <span class="comment">// be WT.</span>
01307                         <span class="comment">//</span>
01308 
01309                     } <span class="keywordflow">else</span> {
01310 
01311                         <span class="comment">//</span>
01312                         <span class="comment">// This is an illegal overlap and we need to carve the ranges</span>
01313                         <span class="comment">// to remove the overlap.</span>
01314                         <span class="comment">//</span>
01315                         <span class="comment">// Pick range which has the cache type which should be used for</span>
01316                         <span class="comment">// the overlapped area</span>
01317                         <span class="comment">//</span>
01318 
01319                         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d4/mtrr_8c.html#a21">KiRangeWeight</a>(&amp;Range[0]) &gt; <a class="code" href="../../d8/d4/mtrr_8c.html#a21">KiRangeWeight</a>(&amp;(<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>[Index2]))){
01320                             RemIndex2 = Index2;
01321                         } <span class="keywordflow">else</span> {
01322                             RemIndex2 = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01323                         }
01324 
01325                         <span class="comment">//</span>
01326                         <span class="comment">// Remove ranges of type which do not belong in the overlapped area</span>
01327                         <span class="comment">//</span>
01328 
01329                         RtlZeroMemory (RemoveThisType, MTRR_TYPE_MAX);
01330                         RemoveThisType[<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>[RemIndex2].<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o2">Type</a>] = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01331 
01332                         <span class="comment">//</span>
01333                         <span class="comment">// Remove just the overlapped portion of the range.</span>
01334                         <span class="comment">//</span>
01335 
01336                         Restart = <a class="code" href="../../d8/d4/mtrr_8c.html#a17">KiRemoveRange</a> (
01337                            NewRange,
01338                            <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>[Index2].<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o0">Base</a>,
01339                            (Range[0].Limit &lt; <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>[Index2].<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o1">Limit</a> ?
01340                                     Range[0].Limit : <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>[Index2].<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o1">Limit</a>),
01341                            RemoveThisType
01342                            );
01343                     }
01344                 }
01345             }
01346         }
01347 
01348     } <span class="keywordflow">while</span> (Restart);
01349 
01350     <span class="comment">//</span>
01351     <span class="comment">// The range database is now rounded to fit in the h/w and sorted.</span>
01352     <span class="comment">// Attempt to build MTRR settings which exactly describe the ranges</span>
01353     <span class="comment">//</span>
01354 
01355     MTRR = NewRange-&gt;MTRR;
01356     NoMTRR = 0;
01357     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>=0;<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NewRange-&gt;Status)&amp;&amp; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>&lt;<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o5">NoRange</a>;<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++) {
01358         Range = &amp;<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01359 
01360         <span class="comment">//</span>
01361         <span class="comment">// Build MTRRs to fit this range</span>
01362         <span class="comment">//</span>
01363 
01364         Base   = Range-&gt;<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o0">Base</a>;
01365         Length = Range-&gt;<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o1">Limit</a> - Base + 1;
01366 
01367         <span class="keywordflow">while</span> (Length) {
01368 
01369             <span class="comment">//</span>
01370             <span class="comment">// Compute MTRR length for current range base &amp; length</span>
01371             <span class="comment">//</span>
01372 
01373             <span class="keywordflow">if</span> (Base == 0) {
01374                 MLength = Length;
01375             } <span class="keywordflow">else</span> {
01376                 MLength = (ULONGLONG) 1 &lt;&lt; <a class="code" href="../../d8/d4/mtrr_8c.html#a23">KiFindFirstSetRightBit</a>(Base);
01377             }
01378             <span class="keywordflow">if</span> (MLength &gt; Length) {
01379                 MLength = Length;
01380             }
01381 
01382             l = (ULONGLONG) 1 &lt;&lt; <a class="code" href="../../d8/d4/mtrr_8c.html#a22">KiFindFirstSetLeftBit</a> (MLength);
01383             <span class="keywordflow">if</span> (MLength &gt; l) {
01384                 MLength = l;
01385             }
01386 
01387             <span class="comment">//</span>
01388             <span class="comment">// Store it in the next MTRR</span>
01389             <span class="comment">//</span>
01390 
01391             MTRR[NoMTRR].<a class="code" href="../../d5/d0/struct__MTRR__RANGE.html#o0">Base</a>.<a class="code" href="../../d6/d0/struct__MTRR__VARIABLE__BASE.html#o7">u</a>.QuadPart = Base;
01392             MTRR[NoMTRR].<a class="code" href="../../d5/d0/struct__MTRR__RANGE.html#o0">Base</a>.<a class="code" href="../../d6/d0/struct__MTRR__VARIABLE__BASE.html#o7">u</a>.hw.Type  = Range-&gt;<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o2">Type</a>;
01393             MTRR[NoMTRR].<a class="code" href="../../d5/d0/struct__MTRR__RANGE.html#o1">Mask</a>.<a class="code" href="../../d9/d0/struct__MTRR__VARIABLE__MASK.html#o7">u</a>.QuadPart = <a class="code" href="../../d8/d4/mtrr_8c.html#a28">KiLengthToMask</a>(MLength);
01394             MTRR[NoMTRR].<a class="code" href="../../d5/d0/struct__MTRR__RANGE.html#o1">Mask</a>.<a class="code" href="../../d9/d0/struct__MTRR__VARIABLE__MASK.html#o7">u</a>.hw.Valid = 1;
01395             NoMTRR += 1;
01396 
01397             <span class="comment">//</span>
01398             <span class="comment">// Adjust off amount of data covered by that last MTRR</span>
01399             <span class="comment">//</span>
01400 
01401             Base += MLength;
01402             Length -= MLength;
01403 
01404             <span class="comment">//</span>
01405             <span class="comment">// If there are too many MTRRs, and currently setting a</span>
01406             <span class="comment">// Non-USWC range try to remove a USWC MTRR.</span>
01407             <span class="comment">// (ie, convert some MmWriteCombined to MmNonCached).</span>
01408             <span class="comment">//</span>
01409 
01410             <span class="keywordflow">if</span> (NoMTRR &gt; (ULONG) <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o1">Capabilities</a>.<a class="code" href="../../d9/d9/struct__MTRR__CAPABILITIES.html#o8">u</a>.hw.VarCnt) {
01411 
01412                 <span class="keywordflow">if</span> (Range-&gt;<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o2">Type</a> != <a class="code" href="../../d9/d4/mtrr_8h.html#a7">MTRR_TYPE_USWC</a>) {
01413 
01414                     <span class="comment">//</span>
01415                     <span class="comment">// Find smallest USWC type and drop it</span>
01416                     <span class="comment">//</span>
01417                     <span class="comment">// This is okay only if the default type is UC.</span>
01418                     <span class="comment">// Default type should always be UC unless BIOS changes</span>
01419                     <span class="comment">// it. Still ASSERT!</span>
01420                     <span class="comment">//</span>
01421 
01422                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o0">Default</a>.<a class="code" href="../../d2/d0/struct__MTRR__DEFAULT.html#o8">u</a>.hw.Type == MTRR_TYPE_UC);
01423 
01424                     BestLength = (ULONGLONG) 1 &lt;&lt; (<a class="code" href="../../d9/d4/mtrr_8h.html#a16">MTRR_MAX_RANGE_SHIFT</a> + 1);
01425 
01426                     <span class="keywordflow">for</span> (Index2=0; Index2 &lt; <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o1">Capabilities</a>.<a class="code" href="../../d9/d9/struct__MTRR__CAPABILITIES.html#o8">u</a>.hw.VarCnt; Index2++) {
01427 
01428                         <span class="keywordflow">if</span> (MTRR[Index2].<a class="code" href="../../d5/d0/struct__MTRR__RANGE.html#o0">Base</a>.<a class="code" href="../../d6/d0/struct__MTRR__VARIABLE__BASE.html#o7">u</a>.hw.Type == <a class="code" href="../../d9/d4/mtrr_8h.html#a7">MTRR_TYPE_USWC</a>) {
01429 
01430                             CurrLength = <a class="code" href="../../d8/d4/mtrr_8c.html#a27">KiMaskToLength</a>(MTRR[Index2].Mask.u.QuadPart &amp;
01431                                                  MTRR_MASK_MASK);
01432 
01433                             <span class="keywordflow">if</span> (CurrLength &lt; BestLength) {
01434                                 WhichMtrr = Index2;
01435                                 BestLength = CurrLength;
01436                             }
01437                         }
01438                     }
01439 
01440                     <span class="keywordflow">if</span> (BestLength == ((ULONGLONG) 1 &lt;&lt; (<a class="code" href="../../d9/d4/mtrr_8h.html#a16">MTRR_MAX_RANGE_SHIFT</a> + 1))) {
01441                         <span class="comment">//</span>
01442                         <span class="comment">// Range was not found which could be dropped.  Abort process</span>
01443                         <span class="comment">//</span>
01444 
01445                         NewRange-&gt;Status = STATUS_UNSUCCESSFUL;
01446                         Length = 0;
01447 
01448                     } <span class="keywordflow">else</span> {
01449                         <span class="comment">//</span>
01450                         <span class="comment">// Remove WhichMtrr</span>
01451                         <span class="comment">//</span>
01452 
01453                         NoMTRR -= 1;
01454                         MTRR[WhichMtrr] = MTRR[NoMTRR];
01455                     }
01456 
01457                 } <span class="keywordflow">else</span> {
01458 
01459                     NewRange-&gt;Status = STATUS_UNSUCCESSFUL;
01460                     Length =0;
01461                 }
01462             }
01463         }
01464     }
01465 
01466     <span class="comment">//</span>
01467     <span class="comment">// Done building new MTRRs</span>
01468     <span class="comment">//</span>
01469 
01470     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NewRange-&gt;Status)) {
01471 
01472         <span class="comment">//</span>
01473         <span class="comment">// Update the MTRRs on all processors</span>
01474         <span class="comment">//</span>
01475 
01476 <span class="preprocessor">#if IDBG</span>
01477 <span class="preprocessor"></span>        KiDumpMTRR (<span class="stringliteral">"Loading the following MTRR:"</span>, NewRange-&gt;MTRR);
01478 <span class="preprocessor">#endif</span>
01479 <span class="preprocessor"></span>
01480         NewRange-&gt;TargetCount = 0;
01481         NewRange-&gt;TargetPhase = &amp;Prcb-&gt;ReverseStall;
01482         NewRange-&gt;Processor = Prcb-&gt;Number;
01483 
01484         <span class="comment">//</span>
01485         <span class="comment">// Previously enabled MTRRs with index &gt; NoMTRR</span>
01486         <span class="comment">// which could conflict with existing setting should be disabled</span>
01487         <span class="comment">// This is taken care of by setting NewRange-&gt;NoMTRR to total</span>
01488         <span class="comment">// number of variable MTRRs.</span>
01489         <span class="comment">//</span>
01490 
01491         NewRange-&gt;NoMTRR = (ULONG) <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o1">Capabilities</a>.<a class="code" href="../../d9/d9/struct__MTRR__CAPABILITIES.html#o8">u</a>.hw.VarCnt;
01492 
01493         <span class="comment">//</span>
01494         <span class="comment">// Synchronize with other IPI functions which may stall</span>
01495         <span class="comment">//</span>
01496 
01497         <a class="code" href="../../d0/d0/ki_8h.html#a11">KiLockContextSwap</a>(&amp;OldIrql);
01498 
01499 <span class="preprocessor">#if !defined(NT_UP)</span>
01500 <span class="preprocessor"></span>        <span class="comment">//</span>
01501         <span class="comment">// Collect all the (other) processors</span>
01502         <span class="comment">//</span>
01503 
01504         TargetProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a> &amp; ~Prcb-&gt;SetMember;
01505         <span class="keywordflow">if</span> (TargetProcessors != 0) {
01506 
01507             KiIpiSendSynchronousPacket (
01508                 Prcb,
01509                 TargetProcessors,
01510                 KiLoadMTRRTarget,
01511                 (PVOID) NewRange,
01512                 NULL,
01513                 NULL
01514                 );
01515 
01516             <span class="comment">//</span>
01517             <span class="comment">// Wait for all processors to be collected</span>
01518             <span class="comment">//</span>
01519 
01520             <a class="code" href="../../d2/d1/xipi_8c.html#a2">KiIpiStallOnPacketTargets</a>(TargetProcessors);
01521 
01522             <span class="comment">//</span>
01523             <span class="comment">// All processors are now waiting.  Raise to high level to</span>
01524             <span class="comment">// ensure this processor doesn't enter the debugger due to</span>
01525             <span class="comment">// some interrupt service routine.</span>
01526             <span class="comment">//</span>
01527 
01528             <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (HIGH_LEVEL, &amp;OldIrql2);
01529 
01530             <span class="comment">//</span>
01531             <span class="comment">// There's no reason for any debug events now, so signal</span>
01532             <span class="comment">// the other processors that they can all disable interrupts</span>
01533             <span class="comment">// and being the MTRR update</span>
01534             <span class="comment">//</span>
01535 
01536             Prcb-&gt;ReverseStall += 1;
01537         }
01538 <span class="preprocessor">#endif</span>
01539 <span class="preprocessor"></span>
01540         <span class="comment">//</span>
01541         <span class="comment">// Update MTRRs</span>
01542         <span class="comment">//</span>
01543 
01544         <a class="code" href="../../d0/d5/mtrramd_8c.html#a23">KiLoadMTRR</a> (NewRange);
01545 
01546         <span class="comment">//</span>
01547         <span class="comment">// Release ContextSwap lock</span>
01548         <span class="comment">//</span>
01549 
01550         <a class="code" href="../../d0/d0/ki_8h.html#a12">KiUnlockContextSwap</a>(OldIrql);
01551 
01552 
01553 <span class="preprocessor">#if IDBG</span>
01554 <span class="preprocessor"></span>        KiDumpMTRR (<span class="stringliteral">"Processor MTRR:"</span>, NewRange-&gt;MTRR);
01555 <span class="preprocessor">#endif</span>
01556 <span class="preprocessor"></span>
01557     } <span class="keywordflow">else</span> {
01558 
01559         <span class="comment">//</span>
01560         <span class="comment">// There was an error, put original range database back</span>
01561         <span class="comment">//</span>
01562 
01563         <a class="code" href="../../d7/d9/assign_8c.html#a19">DBGMSG</a> (<span class="stringliteral">"KiCompleteEffectiveRangeChange: mtrr update did not occur\n"</span>);
01564 
01565         <span class="keywordflow">if</span> (NewRange-&gt;Ranges) {
01566             <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o5">NoRange</a> = NewRange-&gt;NoRange;
01567 
01568             RtlCopyMemory (
01569                 <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>,
01570                 NewRange-&gt;Ranges,
01571                 sizeof (<a class="code" href="../../d2/d7/struct__ONE__RANGE.html">ONE_RANGE</a>) * <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o5">NoRange</a>
01572                 );
01573         }
01574     }
01575 
01576     <span class="comment">//</span>
01577     <span class="comment">// Cleanup</span>
01578     <span class="comment">//</span>
01579 
01580     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (NewRange-&gt;Ranges);
01581     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (NewRange-&gt;MTRR);
01582 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="mtrr.c::KiFindFirstSetLeftBit" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> STATIC ULONG KiFindFirstSetLeftBit           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONGLONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Set</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01690">1690</a> of file <a class="el" href="../../d9/d3/mtrr_8c-source.html">mtrr.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, and <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00077">KiFindFirstSetLeft</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01112">KiCompleteEffectiveRangeChange()</a>.
<p>
<pre class="fragment"><div>01695                    :
01696 
01697     This function returns a bit position of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> most significant
01698     bit set in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed ULONGLONG parameter. Passed parameter
01699     must be non-zero.
01700 
01701 --*/
01702 {
01703     ULONG   bitno;
01704 
01705     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Set != 0);
01706     <span class="keywordflow">for</span> (bitno=56;!(Set &amp; 0xFF00000000000000); bitno -= 8, Set &lt;&lt;= 8) ;
01707     <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/hivecell_8c.html#a6">KiFindFirstSetLeft</a>[Set &gt;&gt; 56] + bitno;
01708 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="mtrr.c::KiFindFirstSetRightBit" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> STATIC ULONG KiFindFirstSetRightBit           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONGLONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Set</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01669">1669</a> of file <a class="el" href="../../d9/d3/mtrr_8c-source.html">mtrr.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, and <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00075">KiFindFirstSetRight</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01112">KiCompleteEffectiveRangeChange()</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01645">KiLengthToMask()</a>, and <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01624">KiMaskToLength()</a>.
<p>
<pre class="fragment"><div>01674                    :
01675 
01676     This function returns a bit position of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> least significant
01677     bit set in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed ULONGLONG parameter. Passed parameter
01678     must be non-zero.
01679 
01680 --*/
01681 {
01682     ULONG   bitno;
01683 
01684     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Set != 0);
01685     <span class="keywordflow">for</span> (bitno=0; !(Set &amp; 0xFF); bitno += 8, Set &gt;&gt;= 8) ;
01686     <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/hivecell_8c.html#a5">KiFindFirstSetRight</a>[Set &amp; 0xFF] + bitno;
01687 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="mtrr.c::KiInitializeMTRR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiInitializeMTRR           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN BOOLEAN&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LastProcessor</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d8/kernlini_8c-source.html#l01691">KiInitMachineDependent()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="mtrr.c::KiLengthToMask" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> STATIC ULONGLONG KiLengthToMask           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONGLONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Length</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01645">1645</a> of file <a class="el" href="../../d9/d3/mtrr_8c-source.html">mtrr.c</a>.
<p>
References <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01669">KiFindFirstSetRightBit()</a>, <a class="el" href="../../d0/d4/mtrr_8h-source.html#l00122">MTRR_MAX_RANGE_SHIFT</a>, and <a class="el" href="../../d0/d4/mtrr_8h-source.html#l00121">MTRR_RESVBIT_MASK</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01112">KiCompleteEffectiveRangeChange()</a>.
<p>
<pre class="fragment"><div>01650                    :
01651 
01652     This function constructs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mask corresponding to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input length
01653     to be set in a variable MTRR <span class="keyword">register</span>. The length <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed to be
01654     a multiple of 4K.
01655 
01656 --*/
01657 {
01658     ULONGLONG FullMask = 0xffffff;
01659 
01660     <span class="keywordflow">if</span> (Length == ((ULONGLONG) 1 &lt;&lt; <a class="code" href="../../d9/d4/mtrr_8h.html#a16">MTRR_MAX_RANGE_SHIFT</a>)) {
01661         <span class="keywordflow">return</span>(0);
01662     } <span class="keywordflow">else</span> {
01663         <span class="keywordflow">return</span>(((FullMask &lt;&lt; <a class="code" href="../../d8/d4/mtrr_8c.html#a23">KiFindFirstSetRightBit</a>(Length)) &amp;
01664             <a class="code" href="../../d9/d4/mtrr_8h.html#a15">MTRR_RESVBIT_MASK</a>));
01665     }
01666 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="mtrr.c::KiLoadMTRR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS KiLoadMTRR           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__NEW__RANGE.html">PNEW_RANGE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Context</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01796">1796</a> of file <a class="el" href="../../d9/d3/mtrr_8c-source.html">mtrr.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d4/d9/user32_8def-source.html#l00990">is</a>, <a class="el" href="../../d2/d8/icmui_8def-source.html#l00012">it</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02780">KeFeatureBits</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02717">KF_AMDK6MTRR</a>, <a class="el" href="../../d1/d4/mtrramd_8c-source.html#l00754">KiAmdK6MtrrWRMSR()</a>, <a class="el" href="../../d0/d0/ki_8h.html#a106">KiDisableInterrupts()</a>, <a class="el" href="../../d0/d0/ki_8h.html#a107">KiRestoreInterrupts()</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01993">KiSynchronizeMTRRLoad()</a>, <a class="el" href="../../d0/d4/mtrr_8h-source.html#l00031">MTRR_MSR_DEFAULT</a>, <a class="el" href="../../d0/d4/mtrr_8h-source.html#l00032">MTRR_MSR_VARIABLE_BASE</a>, <a class="el" href="../../d0/d4/mtrr_8h-source.html#l00033">MTRR_MSR_VARIABLE_MASK</a>, <a class="el" href="../../d5/d3/i386_8h.html#a52">RDMSR()</a>, <a class="el" href="../../d8/d0/genuedef_8c-source.html#l00006">the</a>, <a class="el" href="../../d2/d0/struct__MTRR__DEFAULT.html#o8">_MTRR_DEFAULT::u</a>, and <a class="el" href="../../d5/d3/i386_8h.html#a53">WRMSR()</a>.
<p>
<pre class="fragment"><div>01801                    :
01802 
01803     This function loads <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> range registers into all processors
01804 
01805 Arguments:
01806 
01807     Context     - Context which include <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> MTRRs to load
01808 
01809 Return Value:
01810 
01811     All processors are set into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> state
01812 
01813 --*/
01814 {
01815     <a class="code" href="../../d2/d0/struct__MTRR__DEFAULT.html">MTRR_DEFAULT</a>        Default;
01816     BOOLEAN             Enable;
01817     ULONG               HldCr0, HldCr4;
01818     ULONG               <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01819 
01820     <span class="comment">//</span>
01821     <span class="comment">// Disable interrupts</span>
01822     <span class="comment">//</span>
01823 
01824     Enable = <a class="code" href="../../d0/d0/ki_8h.html#a106">KiDisableInterrupts</a>();
01825 
01826     <span class="comment">//</span>
01827     <span class="comment">// Synchronize all processors</span>
01828     <span class="comment">//</span>
01829 
01830         <span class="keywordflow">if</span> (!(<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a15">KF_AMDK6MTRR</a>)) {
01831         <a class="code" href="../../d8/d4/mtrr_8c.html#a26">KiSynchronizeMTRRLoad</a> (Context);
01832     }
01833 
01834     _asm {
01835         ;
01836         ; Get current CR0
01837         ;
01838 
01839         mov     eax, cr0
01840         mov     HldCr0, eax
01841 
01842         ;
01843         ; Disable caching &amp; line fill
01844         ;
01845 
01846         and     eax, not CR0_NW
01847         or      eax, CR0_CD
01848         mov     cr0, eax
01849 
01850         ;
01851         ; Flush caches
01852         ;
01853 
01854         ;
01855         ; wbinvd
01856         ;
01857 
01858         _emit 0Fh
01859         _emit 09h
01860 
01861         ;
01862         ; Get current cr4
01863         ;
01864 
01865         _emit  0Fh
01866         _emit  20h
01867         _emit  0E0h             ; mov eax, cr4
01868         mov     HldCr4, eax
01869 
01870         ;
01871         ; Disable global page
01872         ;
01873 
01874         and     eax, not CR4_PGE
01875         _emit  0Fh
01876         _emit  22h
01877         _emit  0E0h             ; mov cr4, eax
01878 
01879         ;
01880         ; Flush TLB
01881         ;
01882 
01883         mov     eax, cr3
01884         mov     cr3, eax
01885     }
01886 
01887         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a15">KF_AMDK6MTRR</a>) {
01888 
01889         <span class="comment">//</span>
01890         <span class="comment">// Write the MTRRs</span>
01891         <span class="comment">//</span>
01892 
01893         <a class="code" href="../../d0/d5/mtrramd_8c.html#a32">KiAmdK6MtrrWRMSR</a>();
01894 
01895         } <span class="keywordflow">else</span> {
01896 
01897         <span class="comment">//</span>
01898         <span class="comment">// Disable MTRRs</span>
01899         <span class="comment">//</span>
01900 
01901         Default.<a class="code" href="../../d2/d0/struct__MTRR__DEFAULT.html#o8">u</a>.QuadPart = <a class="code" href="../../d5/d3/i386_8h.html#a52">RDMSR</a>(MTRR_MSR_DEFAULT);
01902         Default.<a class="code" href="../../d2/d0/struct__MTRR__DEFAULT.html#o8">u</a>.hw.MtrrEnabled = 0;
01903         <a class="code" href="../../d5/d3/i386_8h.html#a53">WRMSR</a> (MTRR_MSR_DEFAULT, Default.<a class="code" href="../../d2/d0/struct__MTRR__DEFAULT.html#o8">u</a>.QuadPart);
01904 
01905         <span class="comment">//</span>
01906         <span class="comment">// Synchronize all processors</span>
01907         <span class="comment">//</span>
01908 
01909         <a class="code" href="../../d8/d4/mtrr_8c.html#a26">KiSynchronizeMTRRLoad</a> (Context);
01910 
01911         <span class="comment">//</span>
01912         <span class="comment">// Load new MTRRs</span>
01913         <span class="comment">//</span>
01914 
01915         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>=0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; Context-&gt;NoMTRR; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++) {
01916             <a class="code" href="../../d5/d3/i386_8h.html#a53">WRMSR</a> (MTRR_MSR_VARIABLE_BASE+2*Index, Context-&gt;MTRR[Index].Base.u.QuadPart);
01917             <a class="code" href="../../d5/d3/i386_8h.html#a53">WRMSR</a> (MTRR_MSR_VARIABLE_MASK+2*Index, Context-&gt;MTRR[Index].Mask.u.QuadPart);
01918         }
01919 
01920         <span class="comment">//</span>
01921         <span class="comment">// Synchronize all processors</span>
01922         <span class="comment">//</span>
01923 
01924         <a class="code" href="../../d8/d4/mtrr_8c.html#a26">KiSynchronizeMTRRLoad</a> (Context);
01925         }
01926     _asm {
01927 
01928         ;
01929         ; Flush caches (<span class="keyword">this</span> should be a <span class="stringliteral">"nop"</span>, but it was in the Intel reference algorithm)
01930         ; This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required because of aggressive prefetch of both instr + data
01931         ;
01932 
01933         ;
01934         ; wbinvd
01935         ;
01936 
01937         _emit 0Fh
01938         _emit 09h
01939 
01940         ;
01941         ; Flush TLBs (same comment as above)
01942         ; Same explanation as above
01943         ;
01944 
01945         mov     eax, cr3
01946         mov     cr3, eax
01947     }
01948 
01949         <span class="keywordflow">if</span> (!(<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a15">KF_AMDK6MTRR</a>)) {
01950 
01951         <span class="comment">//</span>
01952         <span class="comment">// Enable MTRRs</span>
01953         <span class="comment">//</span>
01954 
01955         Default.<a class="code" href="../../d2/d0/struct__MTRR__DEFAULT.html#o8">u</a>.hw.MtrrEnabled = 1;
01956         <a class="code" href="../../d5/d3/i386_8h.html#a53">WRMSR</a> (MTRR_MSR_DEFAULT, Default.<a class="code" href="../../d2/d0/struct__MTRR__DEFAULT.html#o8">u</a>.QuadPart);
01957 
01958         <span class="comment">//</span>
01959         <span class="comment">// Synchronize all processors</span>
01960         <span class="comment">//</span>
01961 
01962         <a class="code" href="../../d8/d4/mtrr_8c.html#a26">KiSynchronizeMTRRLoad</a> (Context);
01963     }
01964 
01965     _asm {
01966         ;
01967         ; Restore CR4 (global page enable)
01968         ;
01969 
01970         mov     eax, HldCr4
01971         _emit  0Fh
01972         _emit  22h
01973         _emit  0E0h             ; mov cr4, eax
01974 
01975         ;
01976         ; Restore CR0 (cache enable)
01977         ;
01978 
01979         mov     eax, HldCr0
01980         mov     cr0, eax
01981     }
01982 
01983     <span class="comment">//</span>
01984     <span class="comment">// Restore interrupts and return</span>
01985     <span class="comment">//</span>
01986 
01987     <a class="code" href="../../d0/d0/ki_8h.html#a107">KiRestoreInterrupts</a> (Enable);
01988     <span class="keywordflow">return</span> STATUS_SUCCESS;
01989 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="mtrr.c::KiLoadMTRRTarget" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiLoadMTRRTarget           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a54">PKIPI_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SignalDone</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Parameter2</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Parameter3</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01766">1766</a> of file <a class="el" href="../../d9/d3/mtrr_8c-source.html">mtrr.c</a>.
<p>
References <a class="el" href="../../d0/d5/mtrramd_8c.html#a23">KiLoadMTRR()</a>, <a class="el" href="../../d8/d4/mtrr_8c.html#a13">PNEW_RANGE</a>, and <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00132">_NEW_RANGE::TargetPhase</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01112">KiCompleteEffectiveRangeChange()</a>.
<p>
<pre class="fragment"><div>01772 {
01773     <a class="code" href="../../d0/d2/struct__NEW__RANGE.html">PNEW_RANGE</a> Context;
01774 
01775     Context = (<a class="code" href="../../d0/d2/struct__NEW__RANGE.html">PNEW_RANGE</a>) NewRange;
01776 
01777     <span class="comment">//</span>
01778     <span class="comment">// Wait for all processors to be ready</span>
01779     <span class="comment">//</span>
01780 
01781     KiIpiSignalPacketDoneAndStall (SignalDone, Context-&gt;<a class="code" href="../../d0/d2/struct__NEW__RANGE.html#o10">TargetPhase</a>);
01782 
01783     <span class="comment">//</span>
01784     <span class="comment">// Update MTRRs</span>
01785     <span class="comment">//</span>
01786 
01787     <a class="code" href="../../d0/d5/mtrramd_8c.html#a23">KiLoadMTRR</a> (Context);
01788 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="mtrr.c::KiMaskToLength" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> STATIC ULONGLONG KiMaskToLength           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONGLONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Mask</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01624">1624</a> of file <a class="el" href="../../d9/d3/mtrr_8c-source.html">mtrr.c</a>.
<p>
References <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01669">KiFindFirstSetRightBit()</a>, and <a class="el" href="../../d0/d4/mtrr_8h-source.html#l00122">MTRR_MAX_RANGE_SHIFT</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01112">KiCompleteEffectiveRangeChange()</a>, and <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00275">KiInitializeMTRR()</a>.
<p>
<pre class="fragment"><div>01629                    :
01630 
01631     This function returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length specified by a particular
01632     mtrr variable <span class="keyword">register</span> mask.
01633 
01634 --*/
01635 {
01636     <span class="keywordflow">if</span> (Mask == 0) {
01637         <span class="comment">// Zero Mask signifies a length of      2**36</span>
01638         <span class="keywordflow">return</span>(((ULONGLONG) 1 &lt;&lt; <a class="code" href="../../d9/d4/mtrr_8h.html#a16">MTRR_MAX_RANGE_SHIFT</a>));
01639     } <span class="keywordflow">else</span> {
01640         <span class="keywordflow">return</span>(((ULONGLONG) 1 &lt;&lt; <a class="code" href="../../d8/d4/mtrr_8c.html#a23">KiFindFirstSetRightBit</a>(Mask)));
01641     }
01642 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="mtrr.c::KiRangeWeight" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> STATIC ULONG KiRangeWeight           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d7/struct__ONE__RANGE.html">PONE_RANGE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Range</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01586">1586</a> of file <a class="el" href="../../d9/d3/mtrr_8c-source.html">mtrr.c</a>.
<p>
References <a class="el" href="../../d0/d4/mtrr_8h-source.html#l00042">MTRR_TYPE_UC</a>, <a class="el" href="../../d0/d4/mtrr_8h-source.html#l00043">MTRR_TYPE_USWC</a>, <a class="el" href="../../d0/d4/mtrr_8h-source.html#l00046">MTRR_TYPE_WB</a>, <a class="el" href="../../d0/d4/mtrr_8h-source.html#l00045">MTRR_TYPE_WP</a>, and <a class="el" href="../../d0/d4/mtrr_8h-source.html#l00044">MTRR_TYPE_WT</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01112">KiCompleteEffectiveRangeChange()</a>.
<p>
<pre class="fragment"><div>01591                    :
01592 
01593     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a16">functions</a> returns a weighting of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed in range's cache
01594     <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.   When two or more regions collide within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same h/w region
01595     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> types are weighted and that cache <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> higher weight
01596     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> collision area.
01597 
01598 Arguments:
01599 
01600     Range   - Range to obtain weighting <span class="keywordflow">for</span>
01601 
01602 Return Value:
01603 
01604     The weight of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> particular cache <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>
01605 
01606 --*/
01607 {
01608     ULONG   Weight;
01609 
01610     <span class="keywordflow">switch</span> (Range-&gt;Type) {
01611         <span class="keywordflow">case</span> <a class="code" href="../../d9/d4/mtrr_8h.html#a6">MTRR_TYPE_UC</a>:      Weight = 5;     <span class="keywordflow">break</span>;
01612         <span class="keywordflow">case</span> <a class="code" href="../../d9/d4/mtrr_8h.html#a7">MTRR_TYPE_USWC</a>:    Weight = 4;     <span class="keywordflow">break</span>;
01613         <span class="keywordflow">case</span> <a class="code" href="../../d9/d4/mtrr_8h.html#a9">MTRR_TYPE_WP</a>:      Weight = 3;     <span class="keywordflow">break</span>;
01614         <span class="keywordflow">case</span> <a class="code" href="../../d9/d4/mtrr_8h.html#a8">MTRR_TYPE_WT</a>:      Weight = 2;     <span class="keywordflow">break</span>;
01615         <span class="keywordflow">case</span> <a class="code" href="../../d9/d4/mtrr_8h.html#a10">MTRR_TYPE_WB</a>:      Weight = 1;     <span class="keywordflow">break</span>;
01616         <span class="keywordflow">default</span>:                Weight = 0;     <span class="keywordflow">break</span>;
01617     }
01618 
01619     <span class="keywordflow">return</span> Weight;
01620 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="mtrr.c::KiRemoveRange" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KiRemoveRange           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__NEW__RANGE.html">PNEW_RANGE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NewRange</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Base</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Limit</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>RemoveThisType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00855">855</a> of file <a class="el" href="../../d9/d3/mtrr_8c-source.html">mtrr.c</a>.
<p>
References <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00050">_ONE_RANGE::Base</a>, <a class="el" href="../../d8/d8/assign_8c-source.html#l00348">DBGMSG</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00992">KiAddRange()</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00272">KiRangeInfo</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00051">_ONE_RANGE::Limit</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00086">_RANGE_INFO::NoRange</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d8/d4/mtrr_8c.html#a7">PONE_RANGE</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00088">_RANGE_INFO::Ranges</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00052">_ONE_RANGE::Type</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00576">KeSetPhysicalCacheTypeRange()</a>, and <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01112">KiCompleteEffectiveRangeChange()</a>.
<p>
<pre class="fragment"><div>00863                    :
00864 
00865     This function removes any range overlapping with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed range, of
00866     <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> supplied in RemoveThisType from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> global range database.
00867 
00868 Arguments:
00869 
00870     NewRange        - Context information
00871 
00872     Base            - Base &amp; Limit signify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first &amp; last address of a range
00873     Limit           - which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be removed from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range database
00874 
00875     RemoveThisType  - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> flag <span class="keywordflow">for</span> each <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> which can not overlap <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00876                       target range
00877 
00878 
00879 Return Value:
00880 
00881     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>  - <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range database was altered such that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> may no longer
00882             be sorted.
00883 
00884 --*/
00885 {
00886     ULONG       i;
00887     <a class="code" href="../../d2/d7/struct__ONE__RANGE.html">PONE_RANGE</a>  Range;
00888     BOOLEAN     DatabaseNeedsSorted;
00889 
00890 
00891     DatabaseNeedsSorted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00892 
00893     <span class="comment">//</span>
00894     <span class="comment">// Check each range</span>
00895     <span class="comment">//</span>
00896 
00897     <span class="keywordflow">for</span> (i=0, Range=<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>; i &lt; <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o5">NoRange</a>; i++, Range++) {
00898 
00899         <span class="comment">//</span>
00900         <span class="comment">// If this range type doesn't need to be altered, skip it</span>
00901         <span class="comment">//</span>
00902 
00903         <span class="keywordflow">if</span> (!RemoveThisType[Range-&gt;Type]) {
00904             <span class="keywordflow">continue</span>;
00905         }
00906 
00907         <span class="comment">//</span>
00908         <span class="comment">// Check range to see if it overlaps with range being removed</span>
00909         <span class="comment">//</span>
00910 
00911         <span class="keywordflow">if</span> (Range-&gt;Base &lt; Base) {
00912 
00913             <span class="keywordflow">if</span> (Range-&gt;Limit &gt;= Base  &amp;&amp;  Range-&gt;Limit &lt;= Limit) {
00914 
00915                 <span class="comment">//</span>
00916                 <span class="comment">// Truncate range to not overlap with area being removed</span>
00917                 <span class="comment">//</span>
00918 
00919                 Range-&gt;Limit = Base - 1;
00920             }
00921 
00922             <span class="keywordflow">if</span> (Range-&gt;Limit &gt; Limit) {
00923 
00924                 <span class="comment">//</span>
00925                 <span class="comment">// Target area is contained totally within this area.</span>
00926                 <span class="comment">// Split into two ranges</span>
00927                 <span class="comment">//</span>
00928 
00929                 <span class="comment">//</span>
00930                 <span class="comment">// Add range at end</span>
00931                 <span class="comment">//</span>
00932 
00933                 DatabaseNeedsSorted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00934                 <a class="code" href="../../d8/d4/mtrr_8c.html#a18">KiAddRange</a> (
00935                     NewRange,
00936                     Limit+1,
00937                     Range-&gt;Limit,
00938                     Range-&gt;Type
00939                     );
00940 
00941                 <span class="comment">//</span>
00942                 <span class="comment">// Turn current range into range at beginning</span>
00943                 <span class="comment">//</span>
00944 
00945                 Range-&gt;Limit = Base - 1;
00946             }
00947 
00948         } <span class="keywordflow">else</span> {
00949 
00950             <span class="comment">// Range-&gt;Base &gt;= Base</span>
00951 
00952             <span class="keywordflow">if</span> (Range-&gt;Base &lt;= Limit) {
00953                 <span class="keywordflow">if</span> (Range-&gt;Limit &lt;= Limit) {
00954                     <span class="comment">//</span>
00955                     <span class="comment">// This range is totally within the target area.  Remove it.</span>
00956                     <span class="comment">//</span>
00957 
00958                     DatabaseNeedsSorted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00959                     <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o5">NoRange</a> -= 1;
00960                     Range-&gt;Base  = <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>[<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o5">NoRange</a>].<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o0">Base</a>;
00961                     Range-&gt;Limit = <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>[<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o5">NoRange</a>].<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o1">Limit</a>;
00962                     Range-&gt;Type = <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>[<a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o5">NoRange</a>].<a class="code" href="../../d2/d7/struct__ONE__RANGE.html#o2">Type</a>;
00963 
00964                     <span class="comment">//</span>
00965                     <span class="comment">// recheck at current location</span>
00966                     <span class="comment">//</span>
00967 
00968                     i -= 1;
00969                     Range -= 1;
00970 
00971                 } <span class="keywordflow">else</span> {
00972 
00973                     <span class="comment">//</span>
00974                     <span class="comment">// Bump beginning past area being removed</span>
00975                     <span class="comment">//</span>
00976 
00977                     Range-&gt;Base = Limit + 1;
00978                 }
00979             }
00980         }
00981     }
00982 
00983     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (NewRange-&gt;Status)) {
00984         <a class="code" href="../../d7/d9/assign_8c.html#a19">DBGMSG</a> (<span class="stringliteral">"KiRemoveRange: failure\n"</span>);
00985     }
00986 
00987     <span class="keywordflow">return</span> DatabaseNeedsSorted;
00988 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="mtrr.c::KiStartEffectiveRangeChange" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiStartEffectiveRangeChange           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__NEW__RANGE.html">PNEW_RANGE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>NewRange</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01060">1060</a> of file <a class="el" href="../../d9/d3/mtrr_8c-source.html">mtrr.c</a>.
<p>
References <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00077">_RANGE_INFO::Capabilities</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00272">KiRangeInfo</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00086">_RANGE_INFO::NoRange</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00088">_RANGE_INFO::Ranges</a>, and <a class="el" href="../../d9/d9/struct__MTRR__CAPABILITIES.html#o8">_MTRR_CAPABILITIES::u</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00526">KeRestoreMtrr()</a>, and <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00576">KeSetPhysicalCacheTypeRange()</a>.
<p>
<pre class="fragment"><div>01065                    :
01066 
01067     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a16">functions</a> sets up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context information required to
01068     track &amp; later effect a range change in hardware
01069 
01070 Arguments:
01071 
01072     NewRange        - Context information
01073 
01074 Return Value:
01075 
01076     None
01077 
01078 --*/
01079 {
01080     ULONG   size;
01081 
01082     <span class="comment">//</span>
01083     <span class="comment">// Allocate working space for MTRR image</span>
01084     <span class="comment">//</span>
01085 
01086     size = <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d0/struct__MTRR__RANGE.html">MTRR_RANGE</a>) * ((ULONG) <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o1">Capabilities</a>.<a class="code" href="../../d9/d9/struct__MTRR__CAPABILITIES.html#o8">u</a>.hw.VarCnt + 1);
01087     NewRange-&gt;MTRR = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool, size, '  eK');
01088     <span class="keywordflow">if</span> (!NewRange-&gt;MTRR) {
01089         NewRange-&gt;Status = STATUS_UNSUCCESSFUL;
01090         <span class="keywordflow">return</span> ;
01091     }
01092 
01093     RtlZeroMemory (NewRange-&gt;MTRR, size);
01094 
01095     <span class="comment">//</span>
01096     <span class="comment">// Save current range information in case of an error</span>
01097     <span class="comment">//</span>
01098 
01099     size = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/struct__ONE__RANGE.html">ONE_RANGE</a>) * <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o5">NoRange</a>;
01100     NewRange-&gt;NoRange = <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o5">NoRange</a>;
01101     NewRange-&gt;Ranges = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool, size, '  eK');
01102     <span class="keywordflow">if</span> (!NewRange-&gt;Ranges) {
01103         NewRange-&gt;Status = STATUS_UNSUCCESSFUL;
01104         <span class="keywordflow">return</span> ;
01105     }
01106 
01107     RtlCopyMemory (NewRange-&gt;Ranges, <a class="code" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>.<a class="code" href="../../d5/d2/struct__RANGE__INFO.html#o7">Ranges</a>, size);
01108 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="mtrr.c::KiSynchronizeMTRRLoad" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiSynchronizeMTRRLoad           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__NEW__RANGE.html">PNEW_RANGE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Context</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01993">1993</a> of file <a class="el" href="../../d9/d3/mtrr_8c-source.html">mtrr.c</a>.
<p>
References <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00069">KeGetCurrentPrcb</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l02776">KeNumberProcessors</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01796">KiLoadMTRR()</a>.
<p>
<pre class="fragment"><div>01996 {
01997 
01998 <span class="preprocessor">#if !defined(NT_UP)</span>
01999 <span class="preprocessor"></span>
02000     ULONG               CurrentPhase;
02001     <span class="keyword">volatile</span> ULONG      *TargetPhase;
02002     PKPRCB              Prcb;
02003 
02004     TargetPhase = Context-&gt;TargetPhase;
02005     Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
02006 
02007     <span class="keywordflow">if</span> (Prcb-&gt;Number == (CCHAR) Context-&gt;Processor) {
02008 
02009         <span class="comment">//</span>
02010         <span class="comment">// Wait for all processors to signal</span>
02011         <span class="comment">//</span>
02012 
02013         <span class="keywordflow">while</span> (Context-&gt;TargetCount != (ULONG) <a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a> - 1) {
02014             KeYieldProcessor ();
02015         }
02016 
02017         <span class="comment">//</span>
02018         <span class="comment">// Reset count for next time</span>
02019         <span class="comment">//</span>
02020 
02021         Context-&gt;TargetCount = 0;
02022 
02023         <span class="comment">//</span>
02024         <span class="comment">// Let waiting processor go to next synchronization point</span>
02025         <span class="comment">//</span>
02026 
02027         InterlockedIncrement ((PULONG) TargetPhase);
02028 
02029 
02030     } <span class="keywordflow">else</span> {
02031 
02032         <span class="comment">//</span>
02033         <span class="comment">// Get current phase</span>
02034         <span class="comment">//</span>
02035 
02036         CurrentPhase = *TargetPhase;
02037 
02038         <span class="comment">//</span>
02039         <span class="comment">// Signal that we have completed the current phase</span>
02040         <span class="comment">//</span>
02041 
02042         InterlockedIncrement ((PULONG) &amp;Context-&gt;TargetCount);
02043 
02044         <span class="comment">//</span>
02045         <span class="comment">// Wait for new phase to begin</span>
02046         <span class="comment">//</span>
02047 
02048         <span class="keywordflow">while</span> (*TargetPhase == CurrentPhase) {
02049             KeYieldProcessor ();
02050         }
02051     }
02052 
02053 <span class="preprocessor">#endif</span>
02054 <span class="preprocessor"></span>
02055 }
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a15" doxytag="mtrr.c::KiRangeInfo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d5/d2/struct__RANGE__INFO.html">RANGE_INFO</a> <a class="el" href="../../d8/d4/mtrr_8c.html#a15">KiRangeInfo</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00272">272</a> of file <a class="el" href="../../d9/d3/mtrr_8c-source.html">mtrr.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00526">KeRestoreMtrr()</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00576">KeSetPhysicalCacheTypeRange()</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00992">KiAddRange()</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01112">KiCompleteEffectiveRangeChange()</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00275">KiInitializeMTRR()</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00855">KiRemoveRange()</a>, and <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01060">KiStartEffectiveRangeChange()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="mtrr.c::KiRangeLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> KSPIN_LOCK <a class="el" href="../../d0/d5/mtrramd_8c.html#a18">KiRangeLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00265">265</a> of file <a class="el" href="../../d9/d3/mtrr_8c-source.html">mtrr.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00526">KeRestoreMtrr()</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00576">KeSetPhysicalCacheTypeRange()</a>, <a class="el" href="../../d1/d4/mtrramd_8c-source.html#l00168">KiAmdK6InitializeMTRR()</a>, <a class="el" href="../../d1/d4/mtrramd_8c-source.html#l00294">KiAmdK6MtrrSetMemoryType()</a>, and <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00275">KiInitializeMTRR()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:48 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
