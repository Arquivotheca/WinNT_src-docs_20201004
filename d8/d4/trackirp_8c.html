<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: trackirp.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>trackirp.c File Reference</h1><code>#include "<a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>"</code><br>

<p>
<a href="../../d9/d3/trackirp_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a0">POOL_TAG_DEFERRED_CONTEXT</a>&nbsp;&nbsp;&nbsp;'dprI'</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a1">HACKHACK_FOR_MUP</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a2">HACKHACK_FOR_SCSIPORT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a3">HACKHACK_FOR_ACPI</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a4">HACKHACK_FOR_BOGUSIRPS</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a5">FAIL_CALLER_OF_IOFCALLDRIVER</a>(<a class="el" href="../../d2/d1/userexts_8c.html#a129">msg</a>, irpSp)&nbsp;&nbsp;&nbsp;WDM_FAIL_CALLER(<a class="el" href="../../d2/d1/userexts_8c.html#a129">msg</a>, 3+2*((irpSp)-&gt;MajorFunction == IRP_MJ_POWER))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a6">FAIL_CALLER_OF_IOFCALLDRIVER2</a>(<a class="el" href="../../d2/d1/userexts_8c.html#a129">msg</a>, irpSp)&nbsp;&nbsp;&nbsp;WDM_FAIL_CALLER(<a class="el" href="../../d2/d1/userexts_8c.html#a129">msg</a>, 4+2*((irpSp)-&gt;MajorFunction == IRP_MJ_POWER))</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a13">IovpInitIrpTracking</a> (IN ULONG Level, IN ULONG Flags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a14">IovpDoAssertIrps</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a15">IovpCallDriver1</a> (IN OUT <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> *IrpPointer, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN OUT <a class="el" href="../../d3/d0/struct__IOFCALLDRIVER__STACKDATA.html">PIOFCALLDRIVER_STACKDATA</a> IofCallDriverStackData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a16">IovpCallDriver2</a> (IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN PVOID DispatchRoutine, IN OUT NTSTATUS *FinalStatus, IN <a class="el" href="../../d3/d0/struct__IOFCALLDRIVER__STACKDATA.html">PIOFCALLDRIVER_STACKDATA</a> IofCallDriverStackData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a17">IovpCompleteRequest1</a> (IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN CCHAR <a class="el" href="../../d0/d6/iop_8h.html#a36">PriorityBoost</a>, IN OUT <a class="el" href="../../d4/d0/struct__IOFCOMPLETEREQUEST__STACKDATA.html">PIOFCOMPLETEREQUEST_STACKDATA</a> CompletionPacket)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a18">IovpCompleteRequest2</a> (IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN OUT <a class="el" href="../../d4/d0/struct__IOFCOMPLETEREQUEST__STACKDATA.html">PIOFCOMPLETEREQUEST_STACKDATA</a> CompletionPacket)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a19">IovpCompleteRequest3</a> (IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN PVOID Routine, IN OUT <a class="el" href="../../d4/d0/struct__IOFCOMPLETEREQUEST__STACKDATA.html">PIOFCOMPLETEREQUEST_STACKDATA</a> CompletionPacket)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a20">IovpCompleteRequest4</a> (IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN NTSTATUS ReturnedStatus, IN OUT <a class="el" href="../../d4/d0/struct__IOFCOMPLETEREQUEST__STACKDATA.html">PIOFCOMPLETEREQUEST_STACKDATA</a> CompletionPacket)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a21">IovpCompleteRequest5</a> (IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN OUT <a class="el" href="../../d4/d0/struct__IOFCOMPLETEREQUEST__STACKDATA.html">PIOFCOMPLETEREQUEST_STACKDATA</a> CompletionPacket)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a22">IovpCompleteRequestApc</a> (IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN PVOID BestStackOffset)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a23">IovpAdvanceStackDownwards</a> (IN <a class="el" href="../../d9/d1/struct__IOV__STACK__LOCATION.html">PIOV_STACK_LOCATION</a> StackDataArray, IN CCHAR CurrentLocation, IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp, IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpLastSp OPTIONAL, IN ULONG LocationsAdvanced, IN BOOLEAN IsNewRequest, IN BOOLEAN MarkAsTaken, OUT <a class="el" href="../../d9/d1/struct__IOV__STACK__LOCATION.html">PIOV_STACK_LOCATION</a> *StackLocationInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a24">IovpExamineIrpStackForwarding</a> (IN OUT <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> IovPacket, IN BOOLEAN IsNewSession, IN ULONG ForwardMethod, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN OUT <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> *IoCurrentStackLocation, OUT <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> *IoLastStackLocation, OUT ULONG *StackLocationsAdvanced)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a25">IovpInternalCompletionTrap</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a26">IovpInternalCompleteAtDPC</a> (IN <a class="el" href="../../d1/d6/struct__KDPC.html">PKDPC</a> Dpc, IN PVOID DeferredContext, IN PVOID SystemArgument1, IN PVOID SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a27">IovpInternalCompleteAfterWait</a> (IN PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a28">IovpInternalDeferredCompletion</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a29">IovpSwapSurrogateIrp</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a30">IovpCancelIrp</a> (IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, OUT PBOOLEAN CancelHandled, OUT PBOOLEAN ReturnValue)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a31">IovpFreeIrp</a> (IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN OUT PBOOLEAN FreeHandled)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a32">IovpAllocateIrp1</a> (IN CCHAR StackSize, IN BOOLEAN ChargeQuota, IN OUT <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> *IrpPointer)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a33">IovpAllocateIrp2</a> (IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a34">IovpInitializeIrp</a> (IN OUT <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> PacketSize, IN CCHAR StackSize, IN OUT PBOOLEAN InitializeHandled)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a35">IovpAttachDeviceToDeviceStack</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> NewDevice, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> ExistingDevice)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a36">IovpDetachDevice</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> LowerDevice)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a37">IovpDeleteDevice</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a38">IovpReexamineAllStacks</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a39">IovpEnumDevObjCallback</a> (IN PVOID Object, IN PUNICODE_STRING ObjectName, IN ULONG HandleCount, IN ULONG PointerCount, IN PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a40">IovpIsInterestingStack</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a41">IovpIsInterestingDriver</a> (IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a42">IovpExamineDevObjForwarding</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceBeingCalled, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceLastCalled, OUT PULONG ForwardTechnique)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a43">IovpGetDeviceAttachedTo</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a44">IovpGetLowestDevice</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a45">IovpAssertNonLegacyDevice</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN ULONG StackFramesToSkip, IN PUCHAR FailureTxt)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a46">IovpIsInFdoStack</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a47">IovpSeedOnePage</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a48">IovpSeedTwoPages</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a49">IovpSeedThreePages</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a50">IovpSeedStack</a> (VOID)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a7">IovpTrackingFlags</a> = 0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a8">IovpHackFlags</a> = (ULONG) -1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a9">IovpIrpTrackingEnabled</a> = FALSE</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a10">IovpInitFlags</a> = 0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a11">IovpCancelCount</a> = 0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/trackirp_8c.html#a12">IovpIrpDeferralTime</a> = 10 * 300</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a5" doxytag="trackirp.c::FAIL_CALLER_OF_IOFCALLDRIVER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FAIL_CALLER_OF_IOFCALLDRIVER          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d1/userexts_8c.html#a129">msg</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>irpSp&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;WDM_FAIL_CALLER(<a class="el" href="../../d2/d1/userexts_8c.html#a129">msg</a>, 3+2*((irpSp)-&gt;MajorFunction == IRP_MJ_POWER))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00485">485</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00493">IovpCallDriver1()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="trackirp.c::FAIL_CALLER_OF_IOFCALLDRIVER2" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FAIL_CALLER_OF_IOFCALLDRIVER2          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d1/userexts_8c.html#a129">msg</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>irpSp&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;WDM_FAIL_CALLER(<a class="el" href="../../d2/d1/userexts_8c.html#a129">msg</a>, 4+2*((irpSp)-&gt;MajorFunction == IRP_MJ_POWER))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00488">488</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02239">IovpExamineIrpStackForwarding()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="trackirp.c::HACKHACK_FOR_ACPI" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HACKHACK_FOR_ACPI          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00058">58</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="trackirp.c::HACKHACK_FOR_BOGUSIRPS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HACKHACK_FOR_BOGUSIRPS          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00059">59</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="trackirp.c::HACKHACK_FOR_MUP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HACKHACK_FOR_MUP          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00056">56</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="trackirp.c::HACKHACK_FOR_SCSIPORT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HACKHACK_FOR_SCSIPORT          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00057">57</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="trackirp.c::POOL_TAG_DEFERRED_CONTEXT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define POOL_TAG_DEFERRED_CONTEXT&nbsp;&nbsp;&nbsp;'dprI'          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00054">54</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01693">IovpCompleteRequest3()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a23" doxytag="trackirp.c::IovpAdvanceStackDownwards" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IovpAdvanceStackDownwards           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__IOV__STACK__LOCATION.html">PIOV_STACK_LOCATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>StackDataArray</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN CCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentLocation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpSp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpLastSp&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>LocationsAdvanced</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IsNewRequest</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>MarkAsTaken</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d9/d1/struct__IOV__STACK__LOCATION.html">PIOV_STACK_LOCATION</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>StackLocationInfo</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02023">2023</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00161">_IOV_STACK_LOCATION::CallStackData</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00158">_IOV_STACK_LOCATION::InUse</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00162">_IOV_STACK_LOCATION::IrpSp</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00163">_IOV_STACK_LOCATION::LastDispatch</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00164">_IOV_STACK_LOCATION::PerfDispatchStart</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00165">_IOV_STACK_LOCATION::PerfStackLocationStart</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00160">_IOV_STACK_LOCATION::RequestsFirstStackLocation</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00712">TRACKIRP_DBGPRINT</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00493">IovpCallDriver1()</a>, and <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01267">IovpCompleteRequest1()</a>.
<p>
<pre class="fragment"><div>02033 {
02034     <a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html">PIOV_STACK_LOCATION</a>  iovCurrentStackLocation, advancedLocationData, requestOriginalSLD;
02035     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>   irpSpTemp;
02036     PLARGE_INTEGER       dispatchTime, stackTime;
02037     BOOLEAN              isNewSession, wasInUse;
02038     PVOID                dispatchRoutine;
02039 
02040     isNewSession = (IrpLastSp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02041     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((!isNewSession) || (LocationsAdvanced == 1));
02042     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(isNewSession || ((ULONG) (IrpLastSp - IrpSp) == LocationsAdvanced));
02043 
02044     <span class="comment">//</span>
02045     <span class="comment">// The CurrentLocation will be decremented when we leave. If it hit's zero</span>
02046     <span class="comment">// we will bugcheck, therefore it should be at least two, and we'd need to</span>
02047     <span class="comment">// subtract two off it to make it an index into an array of slot locations</span>
02048     <span class="comment">// (our analog for stack locations). However we reserve an extra empty slot</span>
02049     <span class="comment">// at the head of the array to make our logic easier. Therefore we subtract</span>
02050     <span class="comment">// only one.</span>
02051     <span class="comment">//</span>
02052     iovCurrentStackLocation = StackDataArray + CurrentLocation -1;
02053 
02054     <a class="code" href="../../d9/d4/trackirp_8h.html#a88">TRACKIRP_DBGPRINT</a>((
02055         <span class="stringliteral">"  Smacking %lx (%lx) to valid in SD\n"</span>,
02056         CurrentLocation -1, iovCurrentStackLocation
02057         ), 2);
02058 
02059     <span class="comment">//</span>
02060     <span class="comment">// Note that we do set the InUse field. That's for the caller to do.</span>
02061     <span class="comment">//</span>
02062     <span class="keywordflow">if</span> (iovCurrentStackLocation-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o0">InUse</a>) {
02063 
02064         <span class="comment">//</span>
02065         <span class="comment">// The only way the stack slot could be in use is if we skipped before</span>
02066         <span class="comment">//</span>
02067         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!LocationsAdvanced); <span class="comment">// &amp;&amp; (!isNewSession)</span>
02068         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IrpSp == iovCurrentStackLocation-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o4">IrpSp</a>);
02069 
02070     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (MarkAsTaken) {
02071 
02072         <span class="comment">//</span>
02073         <span class="comment">// ADRIAO BUGBUG 01/02/1999 -</span>
02074         <span class="comment">//     Is the below assertion is not true in the case of an internally</span>
02075         <span class="comment">// forwarded, completed, and then externally forwarded IRP?</span>
02076         <span class="comment">//</span>
02077         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(LocationsAdvanced); <span class="comment">// || isNewSession</span>
02078         RtlZeroMemory(iovCurrentStackLocation, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html">IOV_STACK_LOCATION</a>));
02079         InitializeListHead(&amp;iovCurrentStackLocation-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o3">CallStackData</a>);
02080         iovCurrentStackLocation-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o4">IrpSp</a> = IrpSp;
02081     }
02082 
02083     <span class="comment">//</span>
02084     <span class="comment">// Determine the last original request. A "Request" is block of data in a</span>
02085     <span class="comment">// stack location that is progressively copied downwards as the IRP is</span>
02086     <span class="comment">// forwarded (ie, a forwarded START IRP, a forwarded IOCTL, etc). A clever</span>
02087     <span class="comment">// driver writer could use his own stack location to send down a quick</span>
02088     <span class="comment">// query before forwarding along the original request. We correctly</span>
02089     <span class="comment">// differentiate between those two unique requests within the IRP below.</span>
02090     <span class="comment">//</span>
02091     <span class="keywordflow">if</span> (isNewSession) {
02092 
02093         <span class="comment">//</span>
02094         <span class="comment">// *We* are the original request. None of these fields below should</span>
02095         <span class="comment">// be used.</span>
02096         <span class="comment">//</span>
02097         dispatchRoutine = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02098         requestOriginalSLD = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02099         stackTime = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02100         dispatchTime = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02101 
02102     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (LocationsAdvanced) {
02103 
02104         <span class="comment">//</span>
02105         <span class="comment">// To get the original request (the pointer to the Irp slot that</span>
02106         <span class="comment">// represents where we *first* saw this request), we go backwards to get</span>
02107         <span class="comment">// the most recent previous irp slot data (set up when the device above</span>
02108         <span class="comment">// forwarded this Irp to us), and we read what it's original request was.</span>
02109         <span class="comment">// We also get the dispatch routine for that slot, which we will use to</span>
02110         <span class="comment">// backfill skipped slots if we advanced more than one Irp stack</span>
02111         <span class="comment">// location this time (ie, someone called IoSetNextIrpStackLocation).</span>
02112         <span class="comment">//</span>
02113         dispatchTime       = &amp;iovCurrentStackLocation[LocationsAdvanced].<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o6">PerfDispatchStart</a>;
02114         stackTime          = &amp;iovCurrentStackLocation[LocationsAdvanced].PerfStackLocationStart;
02115         dispatchRoutine    = iovCurrentStackLocation[LocationsAdvanced].LastDispatch;
02116         requestOriginalSLD = iovCurrentStackLocation[LocationsAdvanced].<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o2">RequestsFirstStackLocation</a>;
02117 
02118         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(dispatchRoutine);
02119         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovCurrentStackLocation[LocationsAdvanced].InUse);
02120         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(requestOriginalSLD-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o2">RequestsFirstStackLocation</a> == requestOriginalSLD);
02121         iovCurrentStackLocation-&gt;RequestsFirstStackLocation = requestOriginalSLD;
02122 
02123     } <span class="keywordflow">else</span> {
02124 
02125         <span class="comment">//</span>
02126         <span class="comment">// We skipped. The slot should already be filled.</span>
02127         <span class="comment">//</span>
02128         dispatchRoutine = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02129         dispatchTime = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02130         stackTime = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02131         requestOriginalSLD = iovCurrentStackLocation-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o2">RequestsFirstStackLocation</a>;
02132         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(requestOriginalSLD);
02133         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(requestOriginalSLD-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o2">RequestsFirstStackLocation</a> == requestOriginalSLD);
02134     }
02135 
02136     <span class="comment">//</span>
02137     <span class="comment">// The previous request seen is in requestOriginalSLD (NULL if none). If</span>
02138     <span class="comment">// we advanced more than one stack location (ie, someone called</span>
02139     <span class="comment">// IoSetNextIrpStackLocation), we need to update the slots we never saw get</span>
02140     <span class="comment">// consumed. Note that the dispatch routine we set in the slot is for the</span>
02141     <span class="comment">// driver that owned the last slot - we do not use the device object at</span>
02142     <span class="comment">// that IrpSp because it might be stale (or perhaps even NULL).</span>
02143     <span class="comment">//</span>
02144     advancedLocationData = iovCurrentStackLocation;
02145     irpSpTemp = IrpSp;
02146     <span class="keywordflow">while</span>(LocationsAdvanced&gt;1) {
02147         advancedLocationData++ ;
02148         LocationsAdvanced-- ;
02149         irpSpTemp++ ;
02150         <a class="code" href="../../d9/d4/trackirp_8h.html#a88">TRACKIRP_DBGPRINT</a>((
02151             <span class="stringliteral">"  Late smacking %lx to valid in CD1\n"</span>,
02152             advancedLocationData - StackDataArray
02153             ), 3) ;
02154 
02155         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!advancedLocationData-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o0">InUse</a>) ;
02156         RtlZeroMemory(advancedLocationData, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html">IOV_STACK_LOCATION</a>)) ;
02157         InitializeListHead(&amp;advancedLocationData-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o3">CallStackData</a>) ;
02158         advancedLocationData-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o0">InUse</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
02159         advancedLocationData-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o4">IrpSp</a> = irpSpTemp ;
02160 
02161         advancedLocationData-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o2">RequestsFirstStackLocation</a> = requestOriginalSLD ;
02162         advancedLocationData-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o6">PerfDispatchStart</a> = *dispatchTime;
02163         advancedLocationData-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o7">PerfStackLocationStart</a> = *stackTime;
02164         advancedLocationData-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o5">LastDispatch</a> = dispatchRoutine ;
02165     }
02166 
02167     <span class="comment">//</span>
02168     <span class="comment">// For the assertion below...</span>
02169     <span class="comment">//</span>
02170     <span class="keywordflow">if</span> (LocationsAdvanced) {
02171         irpSpTemp++ ;
02172     }
02173     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((irpSpTemp == IrpLastSp)||(IrpLastSp == NULL)) ;
02174 
02175     <span class="comment">//</span>
02176     <span class="comment">// Write out the slot we're using.</span>
02177     <span class="comment">//</span>
02178     *StackLocationInfo = iovCurrentStackLocation;
02179 
02180     <span class="keywordflow">if</span> (!MarkAsTaken) {
02181         <span class="keywordflow">return</span> iovCurrentStackLocation-&gt;InUse;
02182     }
02183 
02184     <span class="comment">//</span>
02185     <span class="comment">// Record a pointer in this slot to the requests originating slot as</span>
02186     <span class="comment">// appropriate.</span>
02187     <span class="comment">//</span>
02188     <span class="keywordflow">if</span> (IsNewRequest) {
02189 
02190         <a class="code" href="../../d9/d4/trackirp_8h.html#a88">TRACKIRP_DBGPRINT</a>((
02191             <span class="stringliteral">"  CD1: %lx is a new request\n"</span>,
02192             advancedLocationData-StackDataArray
02193             ), 3) ;
02194 
02195         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(LocationsAdvanced == 1) ;
02196         <span class="comment">//</span>
02197         <span class="comment">// ADRIAO BUGBUG 01/02/1999 -</span>
02198         <span class="comment">//</span>
02199         <span class="comment">//     Why the **ll did I have this there? If this were correct then the</span>
02200         <span class="comment">// backfill logic above would need fixing. I think what I have now is</span>
02201         <span class="comment">// correct, not this:</span>
02202         <span class="comment">//</span>
02203         <span class="comment">// advancedLocationData-&gt;RequestsFirstStackLocation = advancedLocationData ;</span>
02204         <span class="comment">//</span>
02205         iovCurrentStackLocation-&gt;RequestsFirstStackLocation = iovCurrentStackLocation;
02206 
02207     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (LocationsAdvanced) {
02208 
02209         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!isNewSession) ;
02210         <span class="comment">//</span>
02211         <span class="comment">// ADRIAO BUGBUG 01/02/1999 -</span>
02212         <span class="comment">//     As per above, this should already have been handled.</span>
02213         <span class="comment">//</span>
02214         <span class="comment">//advancedLocationData-&gt;RequestsFirstStackLocation = requestOriginalSLD ;</span>
02215         <a class="code" href="../../d9/d4/trackirp_8h.html#a88">TRACKIRP_DBGPRINT</a>((
02216             <span class="stringliteral">"  CD1: %lx is a request for %lx\n"</span>,
02217             advancedLocationData-StackDataArray,
02218             requestOriginalSLD-StackDataArray
02219             ), 3) ;
02220 
02221     } <span class="keywordflow">else</span> {
02222 
02223         <span class="comment">//</span>
02224         <span class="comment">// As we skipped, the request should not have changed. If it did,</span>
02225         <span class="comment">// either guy we called trashed the stack given to him (giving none</span>
02226         <span class="comment">// to the dude under him), or we incorrectly saw a new request when</span>
02227         <span class="comment">// we shouldn't have (see previous comment).</span>
02228         <span class="comment">//</span>
02229         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!isNewSession) ;
02230         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(advancedLocationData-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o2">RequestsFirstStackLocation</a> == requestOriginalSLD) ;
02231     }
02232 
02233     wasInUse = iovCurrentStackLocation-&gt;InUse;
02234     iovCurrentStackLocation-&gt;InUse = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02235     <span class="keywordflow">return</span> wasInUse;
02236 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="trackirp.c::IovpAllocateIrp1" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovpAllocateIrp1           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN CCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>StackSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ChargeQuota</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpPointer</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03132">3132</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00209">_IOV_REQUEST_PACKET::AllocatorStack</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00028">ASSERTFLAG_MONITOR_ALLOCS</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00029">ASSERTFLAG_POLICEIRPS</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00197">_IOV_REQUEST_PACKET::Flags</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00930">IopInitializeIrp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04269">IoSizeOfIrp</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00686">IovpProtectedIrpAllocate()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00122">IovpTrackingDataCreateAndLock()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00584">IovpTrackingDataReference()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00454">IovpTrackingDataReleaseLock()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00121">IovpTrackingFlags</a>, <a class="el" href="../../d9/d8/hashirp_8h.html#a21a5">IOVREFTYPE_POINTER</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00124">IRP_ALLOC_COUNT</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00115">IRP_ALLOCATION_MONITORED</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00063">IRPFLAG_EXAMINE_TRACKED</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d6/d1/ppc_2getcalr_8c-source.html#l00181">RtlCaptureStackBackTrace()</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00081">TRACKFLAG_IO_ALLOCATED</a>, and <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00073">TRACKFLAG_PROTECTEDIRP</a>.
<p>
<pre class="fragment"><div>03139              :
03140 
03141     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by <a class="code" href="../../d0/d5/io_8h.html#a449">IoAllocateIrp</a> and returns an <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> iff
03142     we are handled <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocations ourselves.
03143 
03144     We may need to <span class="keywordflow">do</span> <span class="keyword">this</span> internally so we can turn off <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> lookaside lists
03145     and use <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> special <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> to <span class="keywordflow">catch</span> people reusing free'd IRPs.
03146 
03147   Arguments:
03148 
03149     StackSize              - <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> of stack locations to allocate <span class="keywordflow">for</span> <span class="keyword">this</span> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>.
03150 
03151     ChargeQuote            - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> quote should be charged against <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current
03152                              thread.
03153 
03154     IrpPointer             - Pointer to <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> <span class="keywordflow">if</span> one was allocated. This will
03155                              point to <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call iff <a class="code" href="../../d0/d5/io_8h.html#a449">IoAllocateIrp</a>
03156                              should use <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>'s normal lookaside list code.
03157 
03158   Return Value:
03159 
03160     None.
03161 
03162 --*/
03163 {
03164     <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> iovPacket;
03165     PVOID returnAddress[1];
03166     ULONG stackHash;
03167     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
03168 
03169     *IrpPointer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
03170     <span class="keywordflow">if</span> (!(<a class="code" href="../../d8/d4/trackirp_8c.html#a7">IovpTrackingFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a1">ASSERTFLAG_MONITOR_ALLOCS</a>)) {
03171 
03172         <span class="keywordflow">return</span> ;
03173     }
03174 
03175     <span class="keywordflow">if</span> (!(<a class="code" href="../../d8/d4/trackirp_8c.html#a7">IovpTrackingFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a2">ASSERTFLAG_POLICEIRPS</a>)) {
03176 
03177         <span class="keywordflow">return</span> ;
03178     }
03179 
03180     irp = <a class="code" href="../../d9/d8/hashirp_8h.html#a20">IovpProtectedIrpAllocate</a>(
03181         StackSize,
03182         ChargeQuota,
03183         <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()
03184         ) ;
03185 
03186     <span class="keywordflow">if</span> (irp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03187 
03188         <span class="keywordflow">return</span>;
03189     }
03190 
03191     <a class="code" href="../../d0/d6/iop_8h.html#a20">IopInitializeIrp</a>(irp, <a class="code" href="../../d0/d5/io_8h.html#a245">IoSizeOfIrp</a>(StackSize), StackSize);
03192     *IrpPointer = irp;
03193 
03194     iovPacket = <a class="code" href="../../d9/d8/hashirp_8h.html#a8">IovpTrackingDataCreateAndLock</a>(irp);
03195 
03196     <span class="keywordflow">if</span> (iovPacket == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03197 
03198         <span class="keywordflow">return</span>;
03199     }
03200 
03201     <a class="code" href="../../d9/d8/hashirp_8h.html#a13">IovpTrackingDataReference</a>(iovPacket, IOVREFTYPE_POINTER);
03202     iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a28">TRACKFLAG_PROTECTEDIRP</a> | <a class="code" href="../../d9/d4/trackirp_8h.html#a35">TRACKFLAG_IO_ALLOCATED</a>;
03203     irp-&gt;AllocationFlags |= <a class="code" href="../../d9/d4/trackirp_8h.html#a61">IRP_ALLOCATION_MONITORED</a> ;
03204     irp-&gt;Flags |= <a class="code" href="../../d9/d4/trackirp_8h.html#a21">IRPFLAG_EXAMINE_TRACKED</a>;
03205 
03206     <span class="comment">//</span>
03207     <span class="comment">// Record he who allocated this IRP (if we can get it)</span>
03208     <span class="comment">//</span>
03209     <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a1">RtlCaptureStackBackTrace</a>(3, IRP_ALLOC_COUNT, iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o15">AllocatorStack</a>, &amp;stackHash) ;
03210 
03211     <a class="code" href="../../d9/d8/hashirp_8h.html#a12">IovpTrackingDataReleaseLock</a>(iovPacket) ;
03212 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="trackirp.c::IovpAllocateIrp2" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovpAllocateIrp2           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Irp</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03216">3216</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01680">_IRP::AllocationFlags</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00209">_IOV_REQUEST_PACKET::AllocatorStack</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00028">ASSERTFLAG_MONITOR_ALLOCS</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00197">_IOV_REQUEST_PACKET::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00122">IovpTrackingDataCreateAndLock()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00584">IovpTrackingDataReference()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00454">IovpTrackingDataReleaseLock()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00121">IovpTrackingFlags</a>, <a class="el" href="../../d9/d8/hashirp_8h.html#a21a5">IOVREFTYPE_POINTER</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00124">IRP_ALLOC_COUNT</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00115">IRP_ALLOCATION_MONITORED</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00063">IRPFLAG_EXAMINE_TRACKED</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d1/ppc_2getcalr_8c-source.html#l00181">RtlCaptureStackBackTrace()</a>, and <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00081">TRACKFLAG_IO_ALLOCATED</a>.
<p>
<pre class="fragment"><div>03221              :
03222 
03223     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by <a class="code" href="../../d0/d5/io_8h.html#a449">IoAllocateIrp</a> and captures information <span class="keywordflow">if</span>
03224     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> was allocated by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> OS.
03225 
03226   Arguments:
03227 
03228     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>                    - Pointer to <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>
03229 
03230   Return Value:
03231 
03232     None.
03233 
03234 --*/
03235 {
03236     <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> iovPacket;
03237     PVOID returnAddress[1];
03238     ULONG stackHash;
03239 
03240     <span class="keywordflow">if</span> (!(<a class="code" href="../../d8/d4/trackirp_8c.html#a7">IovpTrackingFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a1">ASSERTFLAG_MONITOR_ALLOCS</a>)) {
03241 
03242         <span class="keywordflow">return</span>;
03243     }
03244 
03245 <span class="comment">//    ASSERT(!(IovpTrackingFlags&amp;ASSERTFLAG_POLICEIRPS));</span>
03246 
03247     iovPacket = <a class="code" href="../../d9/d8/hashirp_8h.html#a8">IovpTrackingDataCreateAndLock</a>(Irp);
03248     <span class="keywordflow">if</span> (iovPacket == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03249 
03250         <span class="keywordflow">return</span>;
03251     }
03252 
03253     <a class="code" href="../../d9/d8/hashirp_8h.html#a13">IovpTrackingDataReference</a>(iovPacket, IOVREFTYPE_POINTER);
03254     iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a35">TRACKFLAG_IO_ALLOCATED</a>;
03255     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o17">AllocationFlags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a61">IRP_ALLOCATION_MONITORED</a>;
03256     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a21">IRPFLAG_EXAMINE_TRACKED</a>;
03257 
03258     <span class="comment">//</span>
03259     <span class="comment">// Record he who allocated this IRP (if we can get it)</span>
03260     <span class="comment">//</span>
03261     <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a1">RtlCaptureStackBackTrace</a>(2, IRP_ALLOC_COUNT, iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o15">AllocatorStack</a>, &amp;stackHash) ;
03262 
03263     <a class="code" href="../../d9/d8/hashirp_8h.html#a12">IovpTrackingDataReleaseLock</a>(iovPacket) ;
03264 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a45" doxytag="trackirp.c::IovpAssertNonLegacyDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovpAssertNonLegacyDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>StackFramesToSkip</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>FailureTxt</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03680">3680</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00493">DNF_LEGACY_DRIVER</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03648">IovpGetLowestDevice()</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>.
<p>
<pre class="fragment"><div>03688 {
03689     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> pdoDeviceObject ;
03690     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> pDevNode ;
03691 
03692     pdoDeviceObject = <a class="code" href="../../d9/d4/trackirp_8h.html#a128">IovpGetLowestDevice</a>(DeviceObject) ;
03693 
03694     <span class="keywordflow">if</span> (pdoDeviceObject) {
03695 
03696         pDevNode = pdoDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a> ;
03697         <span class="keywordflow">if</span> (pDevNode&amp;&amp;(!(pDevNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a>&amp;<a class="code" href="../../d9/d0/pnpiop_8h.html#a24">DNF_LEGACY_DRIVER</a>))) {
03698 
03699             <span class="comment">//</span>
03700             <span class="comment">// ADRIAO BUGBUG 12/30/98 - More stuff to fix...</span>
03701             <span class="comment">//</span>
03702             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
03703 <span class="comment">/*</span>
03704 <span class="comment">            WDM_FAIL_CALLER(</span>
03705 <span class="comment">                (FailureTxt),</span>
03706 <span class="comment">                StackFramesToSkip+1,</span>
03707 <span class="comment">                NULL</span>
03708 <span class="comment">                );</span>
03709 <span class="comment">*/</span>
03710         }
03711         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pdoDeviceObject) ;
03712     }
03713 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="trackirp.c::IovpAttachDeviceToDeviceStack" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IovpAttachDeviceToDeviceStack           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NewDevice</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ExistingDevice</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03346">3346</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
<pre class="fragment"><div>03350 {
03351 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="trackirp.c::IovpCallDriver1" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovpCallDriver1           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpPointer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d3/d0/struct__IOFCALLDRIVER__STACKDATA.html">PIOFCALLDRIVER_STACKDATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IofCallDriverStackData</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00493">493</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00030">ASSERTFLAG_MONITORMAJORS</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00029">ASSERTFLAG_POLICEIRPS</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00027">ASSERTFLAG_TRACKIRPS</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00204">_IOV_REQUEST_PACKET::AssertFlags</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00101">CALLFLAG_IS_REMOVE_IRP</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00102">CALLFLAG_REMOVING_FDO_STACK_DO</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00104">CALLFLAG_TOPMOST_IN_SLOT</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00161">_IOV_STACK_LOCATION::CallStackData</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01661">_IRP::Cancel</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01701">_IRP::CancelRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02031">_IO_STACK_LOCATION::Control</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01655">_IRP::CurrentLocation</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a42">DCERROR_CANCELROUTINE_FORWARDED</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a43">DCERROR_NULL_DEVOBJ_FORWARDED</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a44">DCERROR_QUEUED_IRP_FORWARDED</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00130">DCPARAM_IRP</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00183">_IOV_SESSION_DATA::DeviceLastCalled</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00090">DOE_RAW_FDO</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00485">FAIL_CALLER_OF_IOFCALLDRIVER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00197">_IOV_REQUEST_PACKET::Flags</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00159">_IOV_STACK_LOCATION::Flags</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00184">_IOV_SESSION_DATA::ForwardMethod</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00168">_IOV_STACK_LOCATION::InitialStatusBlock</a>, <a class="el" href="../../d9/d4/trackirp_8h.html#a95">IOFCALLDRIVER_STACKDATA</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03977">IoSetNextIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04044">IoSkipCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04701">IOVERIFIERINIT_RANDOMLY_CANCEL_IRPS</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02023">IovpAdvanceStackDownwards()</a>, <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l00433">IovpAssertIrpStackDownward()</a>, <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l00089">IovpAssertIsNewRequest()</a>, <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l00173">IovpAssertNewIrps()</a>, <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l00191">IovpAssertNewRequest()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00140">IovpCancelCount</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03537">IovpExamineDevObjForwarding()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02239">IovpExamineIrpStackForwarding()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03620">IovpGetDeviceAttachedTo()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03648">IovpGetLowestDevice()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00135">IovpInitFlags</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03717">IovpIsInFdoStack()</a>, <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00140">IovpSessionDataAdvance()</a>, <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00027">IovpSessionDataCreate()</a>, <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00190">IovpSessionDataReference()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00122">IovpTrackingDataCreateAndLock()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00276">IovpTrackingDataFindAndLock()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00657">IovpTrackingDataGetCurrentSessionData()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00584">IovpTrackingDataReference()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00454">IovpTrackingDataReleaseLock()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00121">IovpTrackingFlags</a>, <a class="el" href="../../d9/d8/hashirp_8h.html#a21a5">IOVREFTYPE_POINTER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00162">IRP_MN_REMOVE_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01550">IRP_PAGING_IO</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00061">IRPFLAG_EXAMINE_MASK</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00062">IRPFLAG_EXAMINE_NOT_TRACKED</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00063">IRPFLAG_EXAMINE_TRACKED</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00064">IRPFLAG_EXAMINE_UNMARKED</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00153">KeQuerySystemTime()</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00163">_IOV_STACK_LOCATION::LastDispatch</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00217">_IOV_REQUEST_PACKET::LastLocation</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00169">_IOV_STACK_LOCATION::LastStatusBlock</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01414">_DRIVER_OBJECT::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00164">_IOV_STACK_LOCATION::PerfDispatchStart</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00165">_IOV_STACK_LOCATION::PerfStackLocationStart</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00139">PIOFCALLDRIVER_STACKDATA</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00140">PIOV_STACK_LOCATION</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00160">_IOV_STACK_LOCATION::RequestsFirstStackLocation</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00113">SL_NOTCOPIED</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00186">_IOV_SESSION_DATA::StackData</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00098">STACKFLAG_FIRST_REQUEST</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00097">STACKFLAG_REACHED_PDO</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00170">_IOV_STACK_LOCATION::ThreadDispatchedTo</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00192">_IOV_REQUEST_PACKET::TrackedIrp</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00070">TRACKFLAG_ACTIVE</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00075">TRACKFLAG_QUEUED_INTERNALLY</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00712">TRACKIRP_DBGPRINT</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00500              :
00501 
00502     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by <a class="code" href="../../d0/d5/io_8h.html#a463">IofCallDriver</a> just before adjusting
00503     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> stack and calling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver's dispatch routine.
00504 
00505   Arguments:
00506 
00507     IrpPointer             - a pointer* to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> passed in to
00508                              <a class="code" href="../../d0/d5/io_8h.html#a463">IofCallDriver</a>. This routine may
00509                              change <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer <span class="keywordflow">if</span> a surrogate
00510                              <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allocated.
00511 
00512     DeviceObject           - Device object passed into <a class="code" href="../../d0/d5/io_8h.html#a463">IofCallDriver</a>.
00513 
00514     IofCallDriverStackData - Pointer to a local variable on
00515                              <a class="code" href="../../d0/d5/io_8h.html#a463">IofCallDriver</a>'s stack to store data.
00516                              The stored information will be picked
00517                              up by <a class="code" href="../../d8/d4/trackirp_8c.html#a16">IovpCallDriver2</a>, and
00518                              may be adjusted at other times.
00519 
00520 
00521   Return Value:
00522 
00523      None.
00524 
00525 --*/
00526 {
00527     <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> iovPacket;
00528     <a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html">PIOV_SESSION_DATA</a> iovSessionData;
00529     <a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html">PIOV_STACK_LOCATION</a> iovCurrentStackLocation;
00530     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp, replacementIrp;
00531     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp, irpLastSp;
00532     BOOLEAN isNewSession, isNewRequest, previouslyInUse, surrogateSpawned;
00533     ULONG isSameStack;
00534     ULONG locationsAdvanced, completeStyle;
00535     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> pdo, lowerDeviceObject;
00536     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject;
00537     PVOID dispatchRoutine;
00538 
00539     irp = *IrpPointer;
00540     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
00541 
00542     <span class="comment">//</span>
00543     <span class="comment">// Preinitialize the CallStackData.</span>
00544     <span class="comment">//</span>
00545     RtlZeroMemory(IofCallDriverStackData, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d0/struct__IOFCALLDRIVER__STACKDATA.html">IOFCALLDRIVER_STACKDATA</a>));
00546 
00547     <span class="comment">//</span>
00548     <span class="comment">// If we are going to die shortly, kindly say so.</span>
00549     <span class="comment">//</span>
00550     <span class="keywordflow">if</span> (DeviceObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00551 
00552         <a class="code" href="../../d8/d4/trackirp_8c.html#a5">FAIL_CALLER_OF_IOFCALLDRIVER</a>(
00553             (DCERROR_NULL_DEVOBJ_FORWARDED, DCPARAM_IRP, irp),
00554             irpSp
00555             );
00556     }
00557 
00558     <span class="comment">//</span>
00559     <span class="comment">// The examined flag is set on any IRP that has come through</span>
00560     <span class="comment">// IofCallDriver. We use the flag to detect whether we have seen the IRP</span>
00561     <span class="comment">// before.</span>
00562     <span class="comment">//</span>
00563     <span class="keywordflow">switch</span>(irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a19">IRPFLAG_EXAMINE_MASK</a>) {
00564 
00565         <span class="keywordflow">case</span> <a class="code" href="../../d9/d4/trackirp_8h.html#a20">IRPFLAG_EXAMINE_NOT_TRACKED</a>:
00566 
00567             <span class="comment">//</span>
00568             <span class="comment">// This packet is marked do not touch. So we ignore it.</span>
00569             <span class="comment">//</span>
00570             iovPacket = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00571             <span class="keywordflow">break</span>;
00572 
00573         <span class="keywordflow">case</span> <a class="code" href="../../d9/d4/trackirp_8h.html#a21">IRPFLAG_EXAMINE_TRACKED</a>:
00574 
00575             <span class="comment">//</span>
00576             <span class="comment">// This packet has been marked. We should find it.</span>
00577             <span class="comment">//</span>
00578             iovPacket = <a class="code" href="../../d9/d8/hashirp_8h.html#a7">IovpTrackingDataFindAndLock</a>(irp);
00579             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovPacket != NULL);
00580             <span class="keywordflow">break</span>;
00581 
00582         <span class="keywordflow">case</span> <a class="code" href="../../d9/d4/trackirp_8h.html#a22">IRPFLAG_EXAMINE_UNMARKED</a>:
00583 
00584             iovPacket = <a class="code" href="../../d9/d8/hashirp_8h.html#a7">IovpTrackingDataFindAndLock</a>(irp);
00585             <span class="keywordflow">if</span> (iovPacket) {
00586 
00587                 <span class="comment">//</span>
00588                 <span class="comment">// Was tracked but cache flag got wiped. Replace.</span>
00589                 <span class="comment">//</span>
00590                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a21">IRPFLAG_EXAMINE_TRACKED</a>;
00591 
00592             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d4/trackirp_8c.html#a7">IovpTrackingFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a0">ASSERTFLAG_TRACKIRPS</a>) {
00593 
00594                 <span class="comment">//</span>
00595                 <span class="comment">// Create the packet</span>
00596                 <span class="comment">//</span>
00597                 iovPacket = <a class="code" href="../../d9/d8/hashirp_8h.html#a8">IovpTrackingDataCreateAndLock</a>(irp);
00598                 <span class="keywordflow">if</span> (iovPacket) {
00599 
00600                     <span class="comment">//</span>
00601                     <span class="comment">// Mark it</span>
00602                     <span class="comment">//</span>
00603                     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a21">IRPFLAG_EXAMINE_TRACKED</a>;
00604                 } <span class="keywordflow">else</span> {
00605 
00606                     <span class="comment">//</span>
00607                     <span class="comment">// No memory, try to keep it out of the IRP assert though.</span>
00608                     <span class="comment">//</span>
00609                     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a20">IRPFLAG_EXAMINE_NOT_TRACKED</a>;
00610                 }
00611             } <span class="keywordflow">else</span> {
00612 
00613                 <span class="comment">//</span>
00614                 <span class="comment">// Do as told, don't track through IofCallDriver.</span>
00615                 <span class="comment">//</span>
00616                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a20">IRPFLAG_EXAMINE_NOT_TRACKED</a>;
00617             }
00618             <span class="keywordflow">break</span>;
00619 
00620         <span class="keywordflow">default</span>:
00621             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
00622             <span class="keywordflow">break</span>;
00623     }
00624 
00625     <span class="keywordflow">if</span> (iovPacket == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00626 
00627         <span class="comment">//</span>
00628         <span class="comment">// Nothing to track, get out.</span>
00629         <span class="comment">//</span>
00630         <span class="keywordflow">return</span>;
00631     }
00632 
00633     <span class="comment">//</span>
00634     <span class="comment">// Find the current session. The session terminates when the final top-level</span>
00635     <span class="comment">// completion routine gets called.</span>
00636     <span class="comment">//</span>
00637     iovSessionData = <a class="code" href="../../d9/d8/hashirp_8h.html#a16">IovpTrackingDataGetCurrentSessionData</a>(iovPacket);
00638 
00639     <span class="keywordflow">if</span> (iovSessionData) {
00640 
00641         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a>&amp;TRACKFLAG_ACTIVE);
00642         isNewSession = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00643 
00644         <a class="code" href="../../d6/d7/sessnirp_8h.html#a1">IovpSessionDataAdvance</a>(
00645             DeviceObject,
00646             iovSessionData,      <span class="comment">// This param is optional.</span>
00647             &amp;iovPacket,
00648             &amp;surrogateSpawned
00649             );
00650 
00651     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a25">TRACKFLAG_ACTIVE</a>)){
00652 
00653         iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a25">TRACKFLAG_ACTIVE</a>;
00654         isNewSession = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00655 
00656         iovSessionData = <a class="code" href="../../d6/d7/sessnirp_8h.html#a0">IovpSessionDataCreate</a>(
00657             DeviceObject,
00658             &amp;iovPacket,
00659             &amp;surrogateSpawned
00660             );
00661 
00662     } <span class="keywordflow">else</span> {
00663 
00664         <span class="comment">//</span>
00665         <span class="comment">// Might hit this path under low memory, or we are tracking allocations</span>
00666         <span class="comment">// but not the IRP sessions themselves.</span>
00667         <span class="comment">//</span>
00668     }
00669 
00670     <span class="comment">//</span>
00671     <span class="comment">// Let IovpCallDriver2 know what it's tracking...</span>
00672     <span class="comment">//</span>
00673     IofCallDriverStackData-&gt;IovSessionData = iovSessionData;
00674 
00675     <span class="keywordflow">if</span> (iovSessionData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00676 
00677         <a class="code" href="../../d9/d8/hashirp_8h.html#a12">IovpTrackingDataReleaseLock</a>(iovPacket) ;
00678         <span class="keywordflow">return</span>;
00679     }
00680 
00681     <span class="keywordflow">if</span> (surrogateSpawned) {
00682 
00683         <span class="comment">//</span>
00684         <span class="comment">// iovPacket was changed to cover the surrogate IRP. Update our own</span>
00685         <span class="comment">// local variable and IofCallDriver's local variable appropriately.</span>
00686         <span class="comment">//</span>
00687         irp = iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o0">TrackedIrp</a>;
00688         irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>(irp);
00689         *IrpPointer = irp;
00690     }
00691 
00692     <span class="keywordflow">if</span> (isNewSession) {
00693 
00694         <a class="code" href="../../d9/d8/hashirp_8h.html#a13">IovpTrackingDataReference</a>(iovPacket, IOVREFTYPE_POINTER);
00695         <a class="code" href="../../d6/d7/sessnirp_8h.html#a2">IovpSessionDataReference</a>(iovSessionData);
00696     }
00697 
00698     <span class="keywordflow">if</span> (iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o11">AssertFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a2">ASSERTFLAG_POLICEIRPS</a>) {
00699 
00700         <span class="comment">//</span>
00701         <span class="comment">// If someone has given us an IRP with a cancel routine, beat them. Drivers</span>
00702         <span class="comment">// set cancel routines when they are going to be pending IRPs *themselves*</span>
00703         <span class="comment">// and should remove them before passing the IRP below. This is also true</span>
00704         <span class="comment">// as the driver will *not* call your cancel routine if he writes in his</span>
00705         <span class="comment">// own (which it may). Nor is the lower driver expected to put yours back</span>
00706         <span class="comment">// either...</span>
00707         <span class="comment">//</span>
00708         <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o25">CancelRoutine</a>) {
00709 
00710             <a class="code" href="../../d8/d4/trackirp_8c.html#a5">FAIL_CALLER_OF_IOFCALLDRIVER</a>(
00711                 (DCERROR_CANCELROUTINE_FORWARDED, DCPARAM_IRP, irp),
00712                 irpSp
00713                 );
00714 
00715             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o25">CancelRoutine</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00716         }
00717     }
00718 
00719     <span class="comment">//</span>
00720     <span class="comment">// Now do any checking that requires tracking data.</span>
00721     <span class="comment">//</span>
00722     <span class="keywordflow">if</span> (iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a29">TRACKFLAG_QUEUED_INTERNALLY</a>) {
00723 
00724         <span class="comment">//</span>
00725         <span class="comment">// We internally queue irps to catch bugs. When we are doing this, we</span>
00726         <span class="comment">// force the stack returned status to STATUS_PENDING, and we queue the</span>
00727         <span class="comment">// irp and release it on a timer. We also may make the IRP non-touchable.</span>
00728         <span class="comment">// This particular caller is trying to forward an IRP he doesn't own,</span>
00729         <span class="comment">// and we didn't actually end up with an untouchable irp.</span>
00730         <span class="comment">//</span>
00731         <a class="code" href="../../d8/d4/trackirp_8c.html#a5">FAIL_CALLER_OF_IOFCALLDRIVER</a>(
00732             (DCERROR_QUEUED_IRP_FORWARDED, DCPARAM_IRP, irp),
00733             irpSp
00734             );
00735     }
00736 
00737     <span class="comment">//</span>
00738     <span class="comment">// Figure out how many stack locations we've moved up since we've last seen</span>
00739     <span class="comment">// this IRP, and determine if the stack locations were copied appropriately.</span>
00740     <span class="comment">// We also need to see exactly how the IRP was forwarded (down the stack,</span>
00741     <span class="comment">// to another stack, straight to the PDO, etc).</span>
00742     <span class="comment">//</span>
00743     <span class="comment">// ADRIAO BUGBUG #07 05/11/98 - The only way to truely detect this is to</span>
00744     <span class="comment">//                              attach a filter at every layer in stack.</span>
00745     <span class="comment">//                              This is left as an exercise for later.</span>
00746     <span class="comment">//</span>
00747     <a class="code" href="../../d9/d4/trackirp_8h.html#a123">IovpExamineDevObjForwarding</a>(
00748         DeviceObject,
00749         iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o6">DeviceLastCalled</a>,
00750         &amp;iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o7">ForwardMethod</a>
00751         ) ;
00752 
00753     <a class="code" href="../../d9/d4/trackirp_8h.html#a121">IovpExamineIrpStackForwarding</a>(
00754         iovPacket,
00755         isNewSession,
00756         iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o7">ForwardMethod</a>,
00757         DeviceObject,
00758         irp,
00759         &amp;irpSp,
00760         &amp;irpLastSp,
00761         &amp;locationsAdvanced
00762         );
00763 
00764     <a class="code" href="../../d9/d4/trackirp_8h.html#a88">TRACKIRP_DBGPRINT</a>((
00765         <span class="stringliteral">"  CD1: Current, Last = (%x, %x)\n"</span>,
00766         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a>,
00767         iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o18">LastLocation</a>
00768         ), 3) ;
00769 
00770     <span class="comment">//</span>
00771     <span class="comment">// Figure out whether this is a new request or not, and record a</span>
00772     <span class="comment">// pointer in this slot to the requests originating slot as appropriate.</span>
00773     <span class="comment">//</span>
00774     isNewRequest = <a class="code" href="../../d8/d4/flunkirp_8h.html#a0">IovpAssertIsNewRequest</a>(irpLastSp, irpSp);
00775 
00776     <span class="comment">//</span>
00777     <span class="comment">// Record information in our private stack locations and</span>
00778     <span class="comment">// write that back into the "stack" data itself...</span>
00779     <span class="comment">//</span>
00780     previouslyInUse = <a class="code" href="../../d9/d4/trackirp_8h.html#a145">IovpAdvanceStackDownwards</a>(
00781         iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o9">StackData</a>,
00782         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a>,
00783         irpSp,
00784         irpLastSp,
00785         locationsAdvanced,
00786         isNewRequest,
00787         TRUE,
00788         &amp;iovCurrentStackLocation
00789         );
00790 
00791     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovCurrentStackLocation);
00792 
00793     <span class="keywordflow">if</span> (previouslyInUse) {
00794 
00795         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!isNewRequest);
00796         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!isNewSession);
00797         <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;iovCurrentStackLocation-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o6">PerfDispatchStart</a>) ;
00798 
00799     } <span class="keywordflow">else</span> {
00800 
00801         IofCallDriverStackData-&gt;Flags = <a class="code" href="../../d9/d4/trackirp_8h.html#a55">CALLFLAG_TOPMOST_IN_SLOT</a> ;
00802         InitializeListHead(&amp;IofCallDriverStackData-&gt;SharedLocationList) ;
00803 
00804         <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;iovCurrentStackLocation-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o6">PerfDispatchStart</a>) ;
00805         <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;iovCurrentStackLocation-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o7">PerfStackLocationStart</a>) ;
00806 
00807         <span class="comment">//</span>
00808         <span class="comment">// Record the first thread this IRP slot was dispatched to.</span>
00809         <span class="comment">//</span>
00810         iovCurrentStackLocation-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o12">ThreadDispatchedTo</a> = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00811         <span class="keywordflow">if</span> (isNewRequest) {
00812 
00813             iovCurrentStackLocation-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o10">InitialStatusBlock</a> = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>;
00814             iovCurrentStackLocation-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o11">LastStatusBlock</a> = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>;
00815             <span class="keywordflow">if</span> (isNewSession) {
00816 
00817                 iovCurrentStackLocation-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o1">Flags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a50">STACKFLAG_FIRST_REQUEST</a>;
00818             }
00819         }
00820     }
00821 
00822     <span class="comment">//</span>
00823     <span class="comment">// Record whether this is the last device object for this IRP...</span>
00824     <span class="comment">// PDO's have devnodes filled out, so look for that field.</span>
00825     <span class="comment">// Actually, we can't quite do that trick as during Bus</span>
00826     <span class="comment">// enumeration a bus filter might be sending down Irps before</span>
00827     <span class="comment">// the OS has ever seen the node. So we assume a devobj is a</span>
00828     <span class="comment">// PDO if he has never attached to anyone.</span>
00829     <span class="comment">//</span>
00830     lowerDeviceObject = <a class="code" href="../../d9/d4/trackirp_8h.html#a125">IovpGetDeviceAttachedTo</a>(DeviceObject) ;
00831     <span class="keywordflow">if</span> (lowerDeviceObject) {
00832         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(lowerDeviceObject) ;
00833     } <span class="keywordflow">else</span> {
00834         iovCurrentStackLocation-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o1">Flags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a49">STACKFLAG_REACHED_PDO</a> ;
00835     }
00836 
00837     <span class="comment">//</span>
00838     <span class="comment">// Record who is getting this IRP (we will blame any mistakes on him</span>
00839     <span class="comment">// if this request gets completed.) Note that we've already asserted</span>
00840     <span class="comment">// DeviceObject is non-NULL...</span>
00841     <span class="comment">//</span>
00842     driverObject = DeviceObject-&gt;DriverObject ;
00843     dispatchRoutine = driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o14">MajorFunction</a>[irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a>] ;
00844     iovCurrentStackLocation-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o5">LastDispatch</a> = dispatchRoutine ;
00845 
00846     <span class="comment">//</span>
00847     <span class="comment">// Uncomplete the request if we are heading back down with it...</span>
00848     <span class="comment">//</span>
00849     iovCurrentStackLocation-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o1">Flags</a> &amp;=~ STACKFLAG_REQUEST_COMPLETED ;
00850 
00851     <span class="comment">//</span>
00852     <span class="comment">// This IofCallDriver2 dude will need to be told what his status should</span>
00853     <span class="comment">// be later. Add him to the linked list of addresses to scribble away</span>
00854     <span class="comment">// stati when the appropriate level is completed.</span>
00855     <span class="comment">//</span>
00856     InsertHeadList(
00857         &amp;iovCurrentStackLocation-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o3">CallStackData</a>,
00858         &amp;IofCallDriverStackData-&gt;SharedLocationList
00859         ) ;
00860 
00861     <span class="comment">//</span>
00862     <span class="comment">// More IofCallDriver2 stuff, tell him the stack location.</span>
00863     <span class="comment">//</span>
00864     IofCallDriverStackData-&gt;IovStackLocation = iovCurrentStackLocation ;
00865 
00866     <span class="comment">// If it's a remove IRP, mark everyone appropriately</span>
00867     <span class="keywordflow">if</span> ((irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> == <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>)&amp;&amp;
00868         (irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> == <a class="code" href="../../d0/d5/io_8h.html#a67">IRP_MN_REMOVE_DEVICE</a>)) {
00869 
00870         IofCallDriverStackData-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o1">Flags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a52">CALLFLAG_IS_REMOVE_IRP</a> ;
00871 
00872         pdo = <a class="code" href="../../d9/d4/trackirp_8h.html#a128">IovpGetLowestDevice</a>(DeviceObject) ;
00873         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pdo) ;
00874         IofCallDriverStackData-&gt;RemovePdo = pdo ;
00875         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pdo) ;
00876         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d4/trackirp_8h.html#a130">IovpIsInFdoStack</a>(DeviceObject) &amp;&amp;
00877             (!(DeviceObject-&gt;DeviceObjectExtension-&gt;ExtensionFlags&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a43">DOE_RAW_FDO</a>))) {
00878             IofCallDriverStackData-&gt;Flags |= <a class="code" href="../../d9/d4/trackirp_8h.html#a53">CALLFLAG_REMOVING_FDO_STACK_DO</a> ;
00879         }
00880     }
00881 
00882     <span class="keywordflow">if</span> ((iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o11">AssertFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a2">ASSERTFLAG_POLICEIRPS</a>) &amp;&amp;
00883         (iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o11">AssertFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a3">ASSERTFLAG_MONITORMAJORS</a>)) {
00884 
00885         <span class="comment">//</span>
00886         <span class="comment">// Do IRP-major specific assertions as appropriate</span>
00887         <span class="comment">//</span>
00888         <span class="keywordflow">if</span> (isNewSession) {
00889 
00890             <a class="code" href="../../d8/d4/flunkirp_8h.html#a1">IovpAssertNewIrps</a>(iovPacket, irpSp, iovCurrentStackLocation) ;
00891         }
00892 
00893         <span class="keywordflow">if</span> (isNewRequest) {
00894 
00895             <a class="code" href="../../d8/d4/flunkirp_8h.html#a2">IovpAssertNewRequest</a>(iovPacket, DeviceObject, irpLastSp, irpSp, iovCurrentStackLocation) ;
00896         }
00897 
00898         <a class="code" href="../../d8/d4/flunkirp_8h.html#a4">IovpAssertIrpStackDownward</a>(iovPacket, DeviceObject, irpLastSp, irpSp, iovCurrentStackLocation) ;
00899     }
00900 
00901     <span class="comment">//</span>
00902     <span class="comment">// Update our fields</span>
00903     <span class="comment">//</span>
00904     iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o6">DeviceLastCalled</a> = DeviceObject ;
00905     iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o18">LastLocation</a> = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a> ;
00906     iovCurrentStackLocation-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o2">RequestsFirstStackLocation</a>-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o11">LastStatusBlock</a> = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>;
00907 
00908     <span class="comment">//</span>
00909     <span class="comment">// Dope the next stack location so we can detect usage of</span>
00910     <span class="comment">// IoCopyCurrentIrpStackLocationToNext or IoSetCompletionRoutine.</span>
00911     <span class="comment">//</span>
00912     <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a>&gt;1) {
00913         <a class="code" href="../../d0/d5/io_8h.html#a238">IoSetNextIrpStackLocation</a>( irp ) ;
00914         irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
00915         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o3">Control</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a60">SL_NOTCOPIED</a> ;
00916         <a class="code" href="../../d0/d5/io_8h.html#a240">IoSkipCurrentIrpStackLocation</a>( irp ) ;
00917     }
00918 
00919     <span class="comment">//</span>
00920     <span class="comment">// Randomly set the cancel flag on a percentage of forwarded IRPs. Many</span>
00921     <span class="comment">// drivers queue first and after dequeue assume the cancel routine they</span>
00922     <span class="comment">// set must have been cleared if Cancel = TRUE. They don't handle the case</span>
00923     <span class="comment">// were the Irp was cancelled in flight.</span>
00924     <span class="comment">//</span>
00925     <span class="comment">// ADRIAO BUGBUG 07/16/1999 -</span>
00926     <span class="comment">//     Do better spontaneous cancel logic later.</span>
00927     <span class="comment">//</span>
00928     <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d4/trackirp_8c.html#a10">IovpInitFlags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a265">IOVERIFIERINIT_RANDOMLY_CANCEL_IRPS</a>) &amp;&amp;
00929         (!(irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a174">IRP_PAGING_IO</a>))) {
00930 
00931         <span class="keywordflow">if</span> (((++<a class="code" href="../../d8/d4/trackirp_8c.html#a11">IovpCancelCount</a>) % 4000) == 0) {
00932 
00933             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00934         }
00935     }
00936 
00937     <span class="comment">//</span>
00938     <span class="comment">// Assert LastLocation is consistent with an IRP that may be completed.</span>
00939     <span class="comment">//</span>
00940     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o9">StackData</a>[iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o18">LastLocation</a>-1].InUse) ;
00941 
00942     <a class="code" href="../../d6/d7/sessnirp_8h.html#a2">IovpSessionDataReference</a>(iovSessionData);
00943     <a class="code" href="../../d9/d8/hashirp_8h.html#a12">IovpTrackingDataReleaseLock</a>(iovPacket) ;
00944 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="trackirp.c::IovpCallDriver2" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovpCallDriver2           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>DispatchRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT NTSTATUS *&nbsp;</td>
          <td class="mdname" nowrap> <em>FinalStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d0/struct__IOFCALLDRIVER__STACKDATA.html">PIOFCALLDRIVER_STACKDATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IofCallDriverStackData</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00948">948</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00034">ASSERTFLAG_FORCEPENDING</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00029">ASSERTFLAG_POLICEIRPS</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00180">_IOV_SESSION_DATA::AssertFlags</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00185">_IOV_SESSION_DATA::BestVisibleIrp</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00100">CALLFLAG_COMPLETED</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00101">CALLFLAG_IS_REMOVE_IRP</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00103">CALLFLAG_OVERRIDE_STATUS</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00102">CALLFLAG_REMOVING_FDO_STACK_DO</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00161">_IOV_STACK_LOCATION::CallStackData</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a74">DCERROR_BUS_FILTER_ERRONEOUSLY_DELETED</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a73">DCERROR_BUS_FILTER_ERRONEOUSLY_DETACHED</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a72">DCERROR_DELETED_PRESENT_PDO</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a75">DCERROR_INCONSISTANT_STATUS</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a77">DCERROR_IRP_RETURNED_WITHOUT_COMPLETION</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a69">DCERROR_SHOULDVE_DELETED</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a68">DCERROR_SHOULDVE_DETACHED</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a76">DCERROR_UNINITIALIZED_STATUS</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00132">DCPARAM_DEVOBJ</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00130">DCPARAM_IRP</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00131">DCPARAM_ROUTINE</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00133">DCPARAM_STATUS</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00563">DNF_DEVICE_GONE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01221">DOE_DELETE_PENDING</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00197">_IOV_REQUEST_PACKET::Flags</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00158">_IOV_STACK_LOCATION::InUse</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03620">IovpGetDeviceAttachedTo()</a>, <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00152">IovpSessionDataDereference()</a>, <a class="el" href="../../d9/d8/hashirp_8h.html#a11">IovpTrackingDataAcquireLock()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00454">IovpTrackingDataReleaseLock()</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00176">_IOV_SESSION_DATA::IovRequestPacket</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00108">SESSIONFLAG_UNWOUND_INCONSISTANT</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00179">_IOV_SESSION_DATA::SessionFlags</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00170">_IOV_STACK_LOCATION::ThreadDispatchedTo</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00082">TRACKFLAG_UNWOUND_BADLY</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00712">TRACKIRP_DBGPRINT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00160">WDM_FAIL_ROUTINE</a>.
<p>
<pre class="fragment"><div>00957              :
00958 
00959     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by <a class="code" href="../../d0/d5/io_8h.html#a463">IofCallDriver</a> just after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver's dispatch
00960     routine has been called. The <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> may not be touchable at <span class="keyword">this</span> time.
00961 
00962   Arguments:
00963 
00964     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>                    - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> passed into <a class="code" href="../../d0/d5/io_8h.html#a463">IofCallDriver</a>.
00965                              The <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> may not be touchable right now.
00966 
00967     DispatchRoutine        - Dispatch routine that was called by <a class="code" href="../../d0/d5/io_8h.html#a463">IofCallDriver</a>.
00968 
00969     FinalStatus            - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status returned by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dispatch
00970                              routine. This may be changed <span class="keywordflow">if</span> all IRPs are being
00971                              forced <span class="stringliteral">"pending"</span>.
00972 
00973     IofCallDriverStackData - Pointer to a local variable on <a class="code" href="../../d0/d5/io_8h.html#a463">IofCallDriver</a>'s
00974                              stack to retreive data stored by
00975                              <a class="code" href="../../d8/d4/trackirp_8c.html#a15">IovpCallDriver1</a>.
00976 
00977   Return Value:
00978 
00979      None.
00980 
00981 --*/
00982 {
00983     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status, lastStatus;
00984     <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> iovPacket;
00985     <a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html">PIOV_SESSION_DATA</a> iovSessionData;
00986     ULONG refCount;
00987     <a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html">PIOV_STACK_LOCATION</a> iovCurrentStackLocation;
00988     BOOLEAN mustDetachAndDelete;
00989     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> devNode;
00990     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> lowerDevObj;
00991 
00992     iovSessionData = IofCallDriverStackData-&gt;IovSessionData;
00993     <span class="keywordflow">if</span> (iovSessionData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00994 
00995         <span class="keywordflow">return</span>;
00996     }
00997 
00998     iovPacket = iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o0">IovRequestPacket</a>;
00999     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovPacket);
01000     <a class="code" href="../../d9/d8/hashirp_8h.html#a11">IovpTrackingDataAcquireLock</a>(iovPacket);
01001 
01002     <span class="comment">//</span>
01003     <span class="comment">// ADRIAO BUGBUG 08/10/1999 -</span>
01004     <span class="comment">//     This needs to be reenabled once the DNF_ flags are used in a</span>
01005     <span class="comment">// consistant manner.</span>
01006     <span class="comment">//</span>
01007 <span class="preprocessor">#if 0</span>
01008 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o4">AssertFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a2">ASSERTFLAG_POLICEIRPS</a>) {
01009 
01010         <span class="keywordflow">if</span> (IofCallDriverStackData-&gt;Flags&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a52">CALLFLAG_IS_REMOVE_IRP</a>) {
01011 
01012             <span class="keywordflow">if</span> ((*FinalStatus != STATUS_PENDING) &amp;&amp;
01013                 (iovCurrentStackLocation-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o12">ThreadDispatchedTo</a> == <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>())) {
01014 
01015                 lowerDevObj = <a class="code" href="../../d9/d4/trackirp_8h.html#a125">IovpGetDeviceAttachedTo</a>(DeviceObject) ;
01016 
01017                 <span class="comment">//</span>
01018                 <span class="comment">// We can look at this because the caller has committed to this being</span>
01019                 <span class="comment">// completed now, and we are on the original thread.</span>
01020                 <span class="comment">//</span>
01021                 <span class="comment">// N.B. This works because all the objects in the stack have been</span>
01022                 <span class="comment">// referenced during a remove. If we decide to only reference the</span>
01023                 <span class="comment">// top object, this logic would break...</span>
01024                 <span class="comment">//</span>
01025                 <span class="keywordflow">if</span> (IofCallDriverStackData-&gt;Flags&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a53">CALLFLAG_REMOVING_FDO_STACK_DO</a>) {
01026 
01027                     <span class="comment">//</span>
01028                     <span class="comment">// FDO, Upper, &amp; Lower filters *must* go. Note that lowerDevObj</span>
01029                     <span class="comment">// should be null as we should have detached.</span>
01030                     <span class="comment">//</span>
01031                     mustDetachAndDelete = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
01032 
01033                 } <span class="keywordflow">else</span> {
01034 
01035                     devNode = IofCallDriverStackData-&gt;RemovePdo-&gt;DeviceObjectExtension-&gt;DeviceNode ;
01036                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(devNode) ;
01037 
01038                     <span class="keywordflow">if</span> (devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a33">DNF_DEVICE_GONE</a>) {
01039 
01040                         <span class="comment">//</span>
01041                         <span class="comment">// It's been reported as missing. It *must* go!</span>
01042                         <span class="comment">//</span>
01043                         mustDetachAndDelete = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
01044 
01045                     } <span class="keywordflow">else</span> {
01046 
01047                         <span class="comment">//</span>
01048                         <span class="comment">// It must stay!</span>
01049                         <span class="comment">//</span>
01050                         mustDetachAndDelete = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
01051                     }
01052                 }
01053 
01054                 <span class="keywordflow">if</span> (mustDetachAndDelete) {
01055 
01056                     <span class="comment">//</span>
01057                     <span class="comment">// IoDetachDevice and IoDeleteDevice should have been called.</span>
01058                     <span class="comment">// First verify IoDetachDevice...</span>
01059                     <span class="comment">//</span>
01060                     <span class="keywordflow">if</span> (lowerDevObj) {
01061 
01062                         <a class="code" href="../../d2/d5/ioassert_8h.html#a21">WDM_FAIL_ROUTINE</a>((
01063                             DCERROR_SHOULDVE_DETACHED,
01064                             DCPARAM_IRP + DCPARAM_ROUTINE + DCPARAM_DEVOBJ,
01065                             iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o8">BestVisibleIrp</a>,
01066                             DispatchRoutine,
01067                             DeviceObject
01068                             ));
01069                     }
01070 
01071                     <span class="comment">//</span>
01072                     <span class="comment">// Now verify IoDeleteDevice</span>
01073                     <span class="comment">//</span>
01074                     <span class="keywordflow">if</span> (!(DeviceObject-&gt;DeviceObjectExtension-&gt;ExtensionFlags&amp;<a class="code" href="../../d0/d5/io_8h.html#a139">DOE_DELETE_PENDING</a>)) {
01075 
01076                         <a class="code" href="../../d2/d5/ioassert_8h.html#a21">WDM_FAIL_ROUTINE</a>((
01077                             DCERROR_SHOULDVE_DELETED,
01078                             DCPARAM_IRP + DCPARAM_ROUTINE + DCPARAM_DEVOBJ,
01079                             iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o8">BestVisibleIrp</a>,
01080                             DispatchRoutine,
01081                             DeviceObject
01082                             ));
01083                     }
01084 
01085                 } <span class="keywordflow">else</span> {
01086 
01087                     <span class="comment">//</span>
01088                     <span class="comment">// Did we mistakenly leave? Verify we aren't a bus filter that</span>
01089                     <span class="comment">// has been fooled. In that case, no checking can be done...</span>
01090                     <span class="comment">//</span>
01091                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(IofCallDriverStackData-&gt;Flags&amp;CALLFLAG_REMOVING_FDO_STACK_DO)) ;
01092 
01093                     <span class="keywordflow">if</span> (DeviceObject == IofCallDriverStackData-&gt;RemovePdo) {
01094 
01095                         <span class="comment">//</span>
01096                         <span class="comment">// Check PDO's - did we mistakenly delete ourselves?</span>
01097                         <span class="comment">//</span>
01098                         <span class="keywordflow">if</span> (DeviceObject-&gt;DeviceObjectExtension-&gt;ExtensionFlags&amp;<a class="code" href="../../d0/d5/io_8h.html#a139">DOE_DELETE_PENDING</a>) {
01099 
01100                             <a class="code" href="../../d2/d5/ioassert_8h.html#a21">WDM_FAIL_ROUTINE</a>((
01101                                 DCERROR_DELETED_PRESENT_PDO,
01102                                 DCPARAM_IRP + DCPARAM_ROUTINE + DCPARAM_DEVOBJ,
01103                                 iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o8">BestVisibleIrp</a>,
01104                                 DispatchRoutine,
01105                                 DeviceObject
01106                                 ));
01107                         }
01108 
01109                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(IofCallDriverStackData-&gt;RemovePdo-&gt;DeviceObjectExtension-&gt;ExtensionFlags&amp;<a class="code" href="../../d0/d5/io_8h.html#a139">DOE_DELETE_PENDING</a>)) {
01110 
01111                         <span class="comment">//</span>
01112                         <span class="comment">// Check bus filters. Bus filters better not have detached</span>
01113                         <span class="comment">// or deleted themselves, as the PDO is still present!</span>
01114                         <span class="comment">//</span>
01115                         <span class="keywordflow">if</span> (lowerDevObj == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01116 
01117                             <span class="comment">//</span>
01118                             <span class="comment">// Oops, it detached. Baad bus filter...</span>
01119                             <span class="comment">//</span>
01120                             <a class="code" href="../../d2/d5/ioassert_8h.html#a21">WDM_FAIL_ROUTINE</a>((
01121                                 DCERROR_BUS_FILTER_ERRONEOUSLY_DETACHED,
01122                                 DCPARAM_IRP + DCPARAM_ROUTINE + DCPARAM_DEVOBJ,
01123                                 iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o8">BestVisibleIrp</a>,
01124                                 DispatchRoutine,
01125                                 DeviceObject
01126                                 ));
01127                         }
01128 
01129                         <span class="keywordflow">if</span> (DeviceObject-&gt;DeviceObjectExtension-&gt;ExtensionFlags&amp;<a class="code" href="../../d0/d5/io_8h.html#a139">DOE_DELETE_PENDING</a>) {
01130 
01131                             <span class="comment">//</span>
01132                             <span class="comment">// It deleted itself. Also very bad...</span>
01133                             <span class="comment">//</span>
01134                             <a class="code" href="../../d2/d5/ioassert_8h.html#a21">WDM_FAIL_ROUTINE</a>((
01135                                 DCERROR_BUS_FILTER_ERRONEOUSLY_DELETED,
01136                                 DCPARAM_IRP + DCPARAM_ROUTINE + DCPARAM_DEVOBJ,
01137                                 iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o8">BestVisibleIrp</a>,
01138                                 DispatchRoutine,
01139                                 DeviceObject
01140                                 ));
01141                         }
01142                     }
01143                 }
01144 
01145                 <span class="keywordflow">if</span> (lowerDevObj) {
01146 
01147                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(lowerDevObj) ;
01148                 }
01149             }
01150         }
01151     }
01152 <span class="preprocessor">#endif</span>
01153 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (IofCallDriverStackData-&gt;Flags&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a51">CALLFLAG_COMPLETED</a>) {
01154 
01155         <a class="code" href="../../d9/d4/trackirp_8h.html#a88">TRACKIRP_DBGPRINT</a>((
01156             <span class="stringliteral">"  Verifying status in CD2\n"</span>
01157             ),2) ;
01158 
01159         <span class="keywordflow">if</span> ((*FinalStatus != IofCallDriverStackData-&gt;ExpectedStatus)&amp;&amp;
01160             (*FinalStatus != STATUS_PENDING)) {
01161 
01162             <span class="keywordflow">if</span> ((iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o4">AssertFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a2">ASSERTFLAG_POLICEIRPS</a>) &amp;&amp;
01163                 (!(iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o3">SessionFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a57">SESSIONFLAG_UNWOUND_INCONSISTANT</a>))) {
01164 
01165 
01166                 <span class="comment">//</span>
01167                 <span class="comment">// The completion routine and the return value don't match. Hey!</span>
01168                 <span class="comment">//</span>
01169                 <a class="code" href="../../d2/d5/ioassert_8h.html#a21">WDM_FAIL_ROUTINE</a>((
01170                     DCERROR_INCONSISTANT_STATUS,
01171                     DCPARAM_IRP + DCPARAM_ROUTINE + DCPARAM_STATUS*2,
01172                     iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o8">BestVisibleIrp</a>,
01173                     DispatchRoutine,
01174                     IofCallDriverStackData-&gt;ExpectedStatus,
01175                     *FinalStatus
01176                     ));
01177             }
01178 
01179             iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o3">SessionFlags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a57">SESSIONFLAG_UNWOUND_INCONSISTANT</a>;
01180 
01181         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*FinalStatus == 0xFFFFFFFF) {
01182 
01183             <span class="keywordflow">if</span> (iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o4">AssertFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a2">ASSERTFLAG_POLICEIRPS</a>) {
01184 
01185 
01186                 <span class="comment">//</span>
01187                 <span class="comment">// This status value is illegal. If we see it, we probably have</span>
01188                 <span class="comment">// an uninitialized variable...</span>
01189                 <span class="comment">//</span>
01190                 <a class="code" href="../../d2/d5/ioassert_8h.html#a21">WDM_FAIL_ROUTINE</a>((
01191                     DCERROR_UNINITIALIZED_STATUS,
01192                     DCPARAM_IRP + DCPARAM_ROUTINE,
01193                     iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o8">BestVisibleIrp</a>,
01194                     DispatchRoutine
01195                     ));
01196             }
01197         }
01198 
01199         <span class="comment">//</span>
01200         <span class="comment">// We do not need to remove ourselves from the list because</span>
01201         <span class="comment">// we will not be completed twice (InUse is NULL makes sure).</span>
01202         <span class="comment">//</span>
01203 
01204     } <span class="keywordflow">else</span> {
01205 
01206         <span class="comment">//</span>
01207         <span class="comment">// OK, we haven't completed yet. Status better</span>
01208         <span class="comment">// be pending...</span>
01209         <span class="comment">//</span>
01210         <a class="code" href="../../d9/d4/trackirp_8h.html#a88">TRACKIRP_DBGPRINT</a>((
01211             <span class="stringliteral">"  Verifying status is STATUS_PENDING in CR2\n"</span>
01212             ), 2) ;
01213 
01214         <span class="keywordflow">if</span> (*FinalStatus != STATUS_PENDING) {
01215 
01216             <span class="keywordflow">if</span> ((iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o4">AssertFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a2">ASSERTFLAG_POLICEIRPS</a>) &amp;&amp;
01217                 (!(iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a36">TRACKFLAG_UNWOUND_BADLY</a>))) {
01218 
01219                 <span class="comment">//</span>
01220                 <span class="comment">// We got control before this slot was completed. This is</span>
01221                 <span class="comment">// legal as long as STATUS_PENDING was returned (it was not),</span>
01222                 <span class="comment">// so it's bug time. Note that the IRP may not be safe to touch.</span>
01223                 <span class="comment">//</span>
01224                 <a class="code" href="../../d2/d5/ioassert_8h.html#a21">WDM_FAIL_ROUTINE</a>((
01225                     DCERROR_IRP_RETURNED_WITHOUT_COMPLETION,
01226                     DCPARAM_IRP + DCPARAM_ROUTINE,
01227                     iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o8">BestVisibleIrp</a>,
01228                     DispatchRoutine
01229                     ));
01230             }
01231 
01232             iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a36">TRACKFLAG_UNWOUND_BADLY</a>;
01233         }
01234 
01235         iovCurrentStackLocation = (<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html">PIOV_STACK_LOCATION</a>)(IofCallDriverStackData-&gt;IovStackLocation) ;
01236         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovCurrentStackLocation-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o0">InUse</a>) ;
01237         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!IsListEmpty(&amp;iovCurrentStackLocation-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o3">CallStackData</a>)) ;
01238 
01239         <span class="comment">//</span>
01240         <span class="comment">// We now extricate ourselves from the list.</span>
01241         <span class="comment">//</span>
01242         RemoveEntryList(&amp;IofCallDriverStackData-&gt;SharedLocationList) ;
01243     }
01244 
01245     <span class="keywordflow">if</span> ((IofCallDriverStackData-&gt;Flags&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a54">CALLFLAG_OVERRIDE_STATUS</a>)&amp;&amp;
01246         (*FinalStatus != STATUS_PENDING)) {
01247 
01248         *FinalStatus = IofCallDriverStackData-&gt;NewStatus ;
01249     }
01250 
01251     <span class="keywordflow">if</span> ((iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o4">AssertFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a7">ASSERTFLAG_FORCEPENDING</a>) &amp;&amp;
01252         (!(IofCallDriverStackData-&gt;Flags&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a52">CALLFLAG_IS_REMOVE_IRP</a>))) {
01253 
01254         <span class="comment">//</span>
01255         <span class="comment">// We also have the option of causing trouble by making every Irp</span>
01256         <span class="comment">// look as if were pending.</span>
01257         <span class="comment">//</span>
01258         *FinalStatus = STATUS_PENDING ;
01259     }
01260 
01261     <a class="code" href="../../d6/d7/sessnirp_8h.html#a3">IovpSessionDataDereference</a>(iovSessionData);
01262     <a class="code" href="../../d9/d8/hashirp_8h.html#a12">IovpTrackingDataReleaseLock</a>(iovPacket);
01263 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="trackirp.c::IovpCancelIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovpCancelIrp           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>CancelHandled</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnValue</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02872">2872</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00029">ASSERTFLAG_POLICEIRPS</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00204">_IOV_REQUEST_PACKET::AssertFlags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01661">_IRP::Cancel</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01701">_IRP::CancelRoutine</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a80">DCERROR_CANCELROUTINE_ON_FORWARDED_IRP</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00130">DCPARAM_IRP</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00131">DCPARAM_ROUTINE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00197">_IOV_REQUEST_PACKET::Flags</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02149">IoCancelIrp()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00807">IovpProtectedIrpMakeTouchable()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00276">IovpTrackingDataFindAndLock()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00454">IovpTrackingDataReleaseLock()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00219">_IOV_REQUEST_PACKET::RestoreHandle</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00199">_IOV_REQUEST_PACKET::SurrogateLink</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00192">_IOV_REQUEST_PACKET::TrackedIrp</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00070">TRACKFLAG_ACTIVE</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00072">TRACKFLAG_HAS_SURROGATE</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00075">TRACKFLAG_QUEUED_INTERNALLY</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00160">WDM_FAIL_ROUTINE</a>.
<p>
<pre class="fragment"><div>02879              :
02880 
02881     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by <a class="code" href="../../d0/d5/io_8h.html#a464">IoCancelIrp</a> and returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> iff
02882     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cancelation was handled internally here (in which <span class="keywordflow">case</span>
02883     IoCancelIrp should <span class="keywordflow">do</span> nothing).
02884 
02885     We need to handle <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call internally when we are currently
02886     dealing with a surrogate. In <span class="keyword">this</span> <span class="keywordflow">case</span>, we make sure <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02887     surrogate <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> cancelled instead.
02888 
02889   Arguments:
02890 
02891     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>                    - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> passed into
02892                              <a class="code" href="../../d0/d5/io_8h.html#a464">IoCancelIrp</a>.
02893 
02894     CancelHandled          - Indicates whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> cancellation
02895                              was handled entirely by <span class="keyword">this</span> routine.
02896 
02897     ReturnValue            - Set to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value <a class="code" href="../../d0/d5/io_8h.html#a464">IoCancelIrp</a>
02898                              should <span class="keywordflow">return</span> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> cancelation
02899                              was handled entirely by <span class="keyword">this</span> routine.
02900 
02901   Return Value:
02902 
02903      None.
02904 
02905 --*/
02906 {
02907     <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> iovPacket, iovNextPacket;
02908     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irpToCancel;
02909     KIRQL irql ;
02910 
02911     *CancelHandled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
02912 
02913     iovPacket = <a class="code" href="../../d9/d8/hashirp_8h.html#a7">IovpTrackingDataFindAndLock</a>(Irp) ;
02914     <span class="keywordflow">if</span> (!iovPacket) {
02915 
02916         <span class="keywordflow">return</span> ;
02917     }
02918 
02919     <span class="comment">//</span>
02920     <span class="comment">// If the IRP is queued internally, touching it is not very safe as we may</span>
02921     <span class="comment">// have temporarily removed the page's backing. Restore the backing while</span>
02922     <span class="comment">// under the IRPs track lock.</span>
02923     <span class="comment">//</span>
02924 
02925     <span class="keywordflow">if</span> (iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a29">TRACKFLAG_QUEUED_INTERNALLY</a>) {
02926 
02927         <a class="code" href="../../d9/d8/hashirp_8h.html#a18">IovpProtectedIrpMakeTouchable</a>(
02928             Irp,
02929             &amp;iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o20">RestoreHandle</a>
02930             );
02931 
02932         iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o20">RestoreHandle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
02933     }
02934 
02935     <span class="keywordflow">if</span> (!(iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a25">TRACKFLAG_ACTIVE</a>)) {
02936 
02937         <span class="comment">//</span>
02938         <span class="comment">// We've already completed the IRP, and the only reason it's</span>
02939         <span class="comment">// still being tracked is because of it's allocation.</span>
02940         <span class="comment">// So it is not ours to cancel.</span>
02941         <span class="comment">//</span>
02942         <a class="code" href="../../d9/d8/hashirp_8h.html#a12">IovpTrackingDataReleaseLock</a>(iovPacket);
02943         <span class="keywordflow">return</span>;
02944     }
02945 
02946     <span class="keywordflow">if</span> (!(iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a27">TRACKFLAG_HAS_SURROGATE</a>)) {
02947 
02948         <span class="comment">//</span>
02949         <span class="comment">// Cancel of an IRP that doesn't have an active surrogate. Let it</span>
02950         <span class="comment">// proceed normally.</span>
02951         <span class="comment">//</span>
02952         <a class="code" href="../../d9/d8/hashirp_8h.html#a12">IovpTrackingDataReleaseLock</a>(iovPacket);
02953         <span class="keywordflow">return</span>;
02954     }
02955 
02956     <span class="keywordflow">if</span> (iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o11">AssertFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a2">ASSERTFLAG_POLICEIRPS</a>) {
02957 
02958         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o25">CancelRoutine</a>) {
02959 
02960             <a class="code" href="../../d2/d5/ioassert_8h.html#a21">WDM_FAIL_ROUTINE</a>((
02961                 DCERROR_CANCELROUTINE_ON_FORWARDED_IRP,
02962                 DCPARAM_IRP + DCPARAM_ROUTINE,
02963                 Irp,
02964                 <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o25">CancelRoutine</a>
02965                 ));
02966 
02967             <span class="comment">//</span>
02968             <span class="comment">// We will ignore this routine. As we should...</span>
02969             <span class="comment">//</span>
02970         }
02971     }
02972 
02973     iovNextPacket = CONTAINING_RECORD(
02974         iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o7">SurrogateLink</a>.Flink,
02975         <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">IOV_REQUEST_PACKET</a>,
02976         SurrogateLink
02977         );
02978 
02979     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02980     *CancelHandled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
02981     irpToCancel = iovNextPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o0">TrackedIrp</a> ;
02982     <a class="code" href="../../d9/d8/hashirp_8h.html#a12">IovpTrackingDataReleaseLock</a>(iovPacket) ;
02983     *ReturnValue = <a class="code" href="../../d4/d6/iosubs_8c.html#a30">IoCancelIrp</a>(irpToCancel) ;
02984 
02985     <span class="keywordflow">return</span> ;
02986 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="trackirp.c::IovpCompleteRequest1" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovpCompleteRequest1           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN CCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>PriorityBoost</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d4/d0/struct__IOFCOMPLETEREQUEST__STACKDATA.html">PIOFCOMPLETEREQUEST_STACKDATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CompletionPacket</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01267">1267</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00034">ASSERTFLAG_FORCEPENDING</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00180">_IOV_SESSION_DATA::AssertFlags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01655">_IRP::CurrentLocation</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a48">DCERROR_QUEUED_IRP_COMPLETED</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a96">DCERROR_UNFORWARDED_IRP_COMPLETED</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00130">DCPARAM_IRP</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00183">_IOV_SESSION_DATA::DeviceLastCalled</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00197">_IOV_REQUEST_PACKET::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03620">IoMarkIrpPending</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02023">IovpAdvanceStackDownwards()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00276">IovpTrackingDataFindAndLock()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00657">IovpTrackingDataGetCurrentSessionData()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00454">IovpTrackingDataReleaseLock()</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00176">_IOV_SESSION_DATA::IovRequestPacket</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00066">IRP_DIAG_HAS_SURROGATE</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00217">_IOV_REQUEST_PACKET::LastLocation</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d4/trackirp_8h.html#a102">PIOFCOMPLETEREQUEST_STACKDATA</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00137">PriorityBoost</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00216">_IOV_REQUEST_PACKET::PriorityBoost</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01654">_IRP::StackCount</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00186">_IOV_SESSION_DATA::StackData</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00075">TRACKFLAG_QUEUED_INTERNALLY</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00712">TRACKIRP_DBGPRINT</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00151">WDM_CHASTISE_CALLER3</a>, and <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00156">WDM_FAIL_CALLER3</a>.
<p>
<pre class="fragment"><div>01280            :
01281 
01282     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>                    - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> passed into
01283                              <a class="code" href="../../d0/d5/io_8h.html#a473">IofCompleteRequest</a>.
01284 
01285     <a class="code" href="../../d0/d6/iop_8h.html#a36">PriorityBoost</a>          - The priority boost passed into
01286                              <a class="code" href="../../d0/d5/io_8h.html#a473">IofCompleteRequest</a>.
01287 
01288     CompletionPacket       - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to a local variable on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack of
01289                              <a class="code" href="../../d0/d5/io_8h.html#a473">IofCompleteRequest</a>. The information stored in
01290                              <span class="keyword">this</span> local variable will be picked up by
01291                              <a class="code" href="../../d8/d4/trackirp_8c.html#a18">IovpCompleteRequest2</a>-5.
01292   Return Value:
01293 
01294      None.
01295 --*/
01296 {
01297     <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> iovPacket;
01298     <a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html">PIOV_SESSION_DATA</a> iovSessionData;
01299     BOOLEAN slotIsInUse;
01300     <a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html">PIOV_STACK_LOCATION</a> iovCurrentStackLocation;
01301     ULONG locationsAdvanced;
01302     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
01303     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> lowerDevobj;
01304 
01305     iovPacket = <a class="code" href="../../d9/d8/hashirp_8h.html#a7">IovpTrackingDataFindAndLock</a>(Irp);
01306 
01307     CompletionPacket-&gt;RaisedCount = 0;
01308 
01309     <span class="keywordflow">if</span> (iovPacket == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01310 
01311         CompletionPacket-&gt;IovSessionData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01312         <span class="keywordflow">return</span>;
01313     }
01314 
01315     iovSessionData = <a class="code" href="../../d9/d8/hashirp_8h.html#a16">IovpTrackingDataGetCurrentSessionData</a>(iovPacket);
01316 
01317     CompletionPacket-&gt;IovSessionData = iovSessionData;
01318     CompletionPacket-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o0">IovRequestPacket</a> = iovPacket;
01319 
01320     <span class="keywordflow">if</span> (iovSessionData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01321 
01322         <span class="comment">//</span>
01323         <span class="comment">// We just got a look at the allocation, not the session itself.</span>
01324         <span class="comment">// This can happen if a driver calls IofCompleteRequest on an internally</span>
01325         <span class="comment">// generated IRP before calling IofCallDriver. NPFS does this.</span>
01326         <span class="comment">//</span>
01327         <a class="code" href="../../d9/d8/hashirp_8h.html#a12">IovpTrackingDataReleaseLock</a>(iovPacket);
01328         <span class="keywordflow">return</span>;
01329     }
01330 
01331     <a class="code" href="../../d9/d4/trackirp_8h.html#a88">TRACKIRP_DBGPRINT</a>((
01332         <span class="stringliteral">"  CR1: Current, Last = (%x, %x)\n"</span>,
01333         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a>, iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o18">LastLocation</a>
01334         ), 3);
01335 
01336     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>(Irp);
01337 
01338     <span class="keywordflow">if</span> (iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a29">TRACKFLAG_QUEUED_INTERNALLY</a>) {
01339 
01340         <span class="comment">//</span>
01341         <span class="comment">// We are probably going to die now. Anyway, it was a good life...</span>
01342         <span class="comment">//</span>
01343         <a class="code" href="../../d2/d5/ioassert_8h.html#a17">WDM_FAIL_CALLER3</a>((DCERROR_QUEUED_IRP_COMPLETED, DCPARAM_IRP, Irp));
01344     }
01345 
01346     <span class="comment">//</span>
01347     <span class="comment">// This would be *very* bad - someone is completing an IRP that is</span>
01348     <span class="comment">// currently in progress...</span>
01349     <span class="comment">//</span>
01350     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a>&amp;IRP_DIAG_HAS_SURROGATE));
01351 
01352     <span class="comment">//</span>
01353     <span class="comment">// Hmmm, someone is completing an IRP that IoCallDriver never called. These</span>
01354     <span class="comment">// is possible but rather gross, so we warn.</span>
01355     <span class="comment">//</span>
01356     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a> == ((CCHAR) <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o12">StackCount</a> + 1)) {
01357 
01358         <a class="code" href="../../d2/d5/ioassert_8h.html#a12">WDM_CHASTISE_CALLER3</a>((DCERROR_UNFORWARDED_IRP_COMPLETED, DCPARAM_IRP, Irp));
01359     }
01360 
01361     <span class="comment">//</span>
01362     <span class="comment">// Record priority for our own later recompletion...</span>
01363     <span class="comment">//</span>
01364     iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o17">PriorityBoost</a> = <a class="code" href="../../d0/d6/iop_8h.html#a36">PriorityBoost</a>;
01365 
01366     <span class="comment">//</span>
01367     <span class="comment">// We have the option of causing trouble by making every Irp look</span>
01368     <span class="comment">// as if were pending. It is best to do it here, as this also takes</span>
01369     <span class="comment">// care of anybody who has synchronized the IRP and thus does not need</span>
01370     <span class="comment">// to mark it pending in his completion routine.</span>
01371     <span class="comment">//</span>
01372     <span class="keywordflow">if</span> (iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o4">AssertFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a7">ASSERTFLAG_FORCEPENDING</a>) {
01373 
01374         <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>(Irp);
01375     }
01376 
01377     <span class="comment">//</span>
01378     <span class="comment">// Do this so that if the IRP comes down again, it looks like a new one</span>
01379     <span class="comment">// to the "forward them correctly" code.</span>
01380     <span class="comment">//</span>
01381     iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o6">DeviceLastCalled</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01382 
01383     locationsAdvanced = iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o18">LastLocation</a> - <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a>;
01384 
01385     <span class="comment">//</span>
01386     <span class="comment">// Remember this so that we can detect the case where someone is completing</span>
01387     <span class="comment">// to themselves.</span>
01388     <span class="comment">//</span>
01389     CompletionPacket-&gt;LocationsAdvanced = locationsAdvanced;
01390 
01391     <span class="comment">//</span>
01392     <span class="comment">// If this failed, somebody skipped then completed.</span>
01393     <span class="comment">//</span>
01394     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(locationsAdvanced);
01395 
01396     <span class="comment">//</span>
01397     <span class="comment">// If somebody called IoSetNextIrpStackLocation, and then completed,</span>
01398     <span class="comment">// update our internal stack locations (slots) as appropriate.</span>
01399     <span class="comment">//</span>
01400     slotIsInUse = <a class="code" href="../../d9/d4/trackirp_8h.html#a145">IovpAdvanceStackDownwards</a>(
01401          iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o9">StackData</a>,
01402          <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a>,
01403          irpSp,
01404          irpSp + locationsAdvanced,
01405          locationsAdvanced,
01406          FALSE,
01407          FALSE,
01408          &amp;iovCurrentStackLocation
01409          );
01410 
01411     <a class="code" href="../../d9/d8/hashirp_8h.html#a12">IovpTrackingDataReleaseLock</a>(iovPacket);
01412 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="trackirp.c::IovpCompleteRequest2" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovpCompleteRequest2           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d4/d0/struct__IOFCOMPLETEREQUEST__STACKDATA.html">PIOFCOMPLETEREQUEST_STACKDATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CompletionPacket</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01416">1416</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00035">ASSERTFLAG_COMPLETEATDPC</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00030">ASSERTFLAG_MONITORMAJORS</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00029">ASSERTFLAG_POLICEIRPS</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00038">ASSERTFLAG_ROTATE_STATUS</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00180">_IOV_SESSION_DATA::AssertFlags</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00100">CALLFLAG_COMPLETED</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00103">CALLFLAG_OVERRIDE_STATUS</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01701">_IRP::CancelRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02501">_IO_STACK_LOCATION::CompletionRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02508">_IO_STACK_LOCATION::Context</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02031">_IO_STACK_LOCATION::Control</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01655">_IRP::CurrentLocation</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00150">_IOFCALLDRIVER_STACKDATA::ExpectedStatus</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00159">_IOV_STACK_LOCATION::Flags</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00148">_IOFCALLDRIVER_STACKDATA::Flags</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00158">_IOV_STACK_LOCATION::InUse</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03913">IoSetCompletionRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l00120">IovpAssertDoAdvanceStatus()</a>, <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l00182">IovpAssertFinalIrpStack()</a>, <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l00870">IovpAssertIrpStackUpward()</a>, <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00220">IovpSessionDataClose()</a>, <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00152">IovpSessionDataDereference()</a>, <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00190">IovpSessionDataReference()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02751">IovpSwapSurrogateIrp()</a>, <a class="el" href="../../d9/d8/hashirp_8h.html#a11">IovpTrackingDataAcquireLock()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00612">IovpTrackingDataDereference()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00657">IovpTrackingDataGetCurrentSessionData()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00454">IovpTrackingDataReleaseLock()</a>, <a class="el" href="../../d9/d8/hashirp_8h.html#a21a5">IOVREFTYPE_POINTER</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00151">_IOFCALLDRIVER_STACKDATA::NewStatus</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00160">_IOV_STACK_LOCATION::RequestsFirstStackLocation</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00186">_IOV_SESSION_DATA::StackData</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00095">STACKFLAG_REQUEST_COMPLETED</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00071">TRACKFLAG_SURROGATE</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00712">TRACKIRP_DBGPRINT</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>01422              :
01423 
01424     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called <span class="keywordflow">for</span> each stack location that might have a completion
01425     routine.
01426 
01427   Arguments:
01428 
01429     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>                    - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> passed into
01430                              <a class="code" href="../../d0/d5/io_8h.html#a473">IofCompleteRequest</a>.
01431 
01432     CompletionPacket       - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to a local variable on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack of
01433                              <a class="code" href="../../d0/d5/io_8h.html#a473">IofCompleteRequest</a>. The information stored in
01434                              <span class="keyword">this</span> local variable will be picked up by
01435                              <a class="code" href="../../d8/d4/trackirp_8c.html#a20">IovpCompleteRequest4</a>&amp;5.
01436 
01437   Return Value:
01438 
01439      None.
01440 --*/
01441 {
01442     <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> iovPacket;
01443     <a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html">PIOV_SESSION_DATA</a> iovSessionData;
01444     BOOLEAN raiseToDPC, newlyCompleted, requestFinalized ;
01445     KIRQL oldIrql ;
01446     <a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html">PIOV_STACK_LOCATION</a> iovCurrentStackLocation, requestsFirstStackLocation ;
01447     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status, entranceStatus ;
01448     <a class="code" href="../../d3/d0/struct__IOFCALLDRIVER__STACKDATA.html">PIOFCALLDRIVER_STACKDATA</a> IofCallDriverStackData ;
01449     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp ;
01450     ULONG refAction ;
01451     PLIST_ENTRY listEntry ;
01452 
01453     iovSessionData = CompletionPacket-&gt;IovSessionData;
01454     <span class="keywordflow">if</span> (iovSessionData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01455 
01456         <span class="keywordflow">return</span>;
01457     }
01458 
01459     iovPacket = CompletionPacket-&gt;IovRequestPacket;
01460     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovPacket);
01461     <a class="code" href="../../d9/d8/hashirp_8h.html#a11">IovpTrackingDataAcquireLock</a>(iovPacket);
01462 
01463     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovSessionData == <a class="code" href="../../d9/d8/hashirp_8h.html#a16">IovpTrackingDataGetCurrentSessionData</a>(iovPacket));
01464 
01465     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o25">CancelRoutine</a>) ;
01466 
01467     status = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status ;
01468 
01469     <a class="code" href="../../d9/d4/trackirp_8h.html#a88">TRACKIRP_DBGPRINT</a>((
01470         <span class="stringliteral">"  CR2: Current, Last = (%x, %x)\n"</span>,
01471         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a>, iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o18">LastLocation</a>
01472         ), 3) ;
01473 
01474     iovCurrentStackLocation = iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o9">StackData</a> + <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a> -1 ;
01475     <a class="code" href="../../d9/d4/trackirp_8h.html#a88">TRACKIRP_DBGPRINT</a>((
01476         <span class="stringliteral">"  Smacking %lx in CR2\n"</span>,
01477         iovCurrentStackLocation-iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o9">StackData</a>
01478         ), 2) ;
01479 
01480     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a> &lt;= iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o16">TopStackLocation</a>) {
01481 
01482         <span class="comment">//</span>
01483         <span class="comment">// Might this be false if the completion routine is to an</span>
01484         <span class="comment">// internal stack loc as set up by IoSetNextIrpStackLocation?</span>
01485         <span class="comment">//</span>
01486         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovCurrentStackLocation-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o0">InUse</a>) ;
01487 
01488         <span class="comment">//</span>
01489         <span class="comment">// Determine if a request was newly completed. Note that</span>
01490         <span class="comment">// several requests may exist within an IRP if it is being</span>
01491         <span class="comment">// "reused". For instance, in response to a IRP_MJ_READ, a</span>
01492         <span class="comment">// driver might convert it into a IRP_MJ_PNP request for the</span>
01493         <span class="comment">// rest of the stack. The two are treated as seperate requests.</span>
01494         <span class="comment">//</span>
01495         requestsFirstStackLocation = iovCurrentStackLocation-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o2">RequestsFirstStackLocation</a> ;
01496         <a class="code" href="../../d9/d4/trackirp_8h.html#a88">TRACKIRP_DBGPRINT</a>((
01497             <span class="stringliteral">"  CR2: original request for %lx is %lx\n"</span>,
01498             iovCurrentStackLocation-iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o9">StackData</a>,
01499             requestsFirstStackLocation-iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o9">StackData</a>
01500             ), 3) ;
01501 
01502         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(requestsFirstStackLocation) ;
01503         <span class="keywordflow">if</span> (requestsFirstStackLocation-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o1">Flags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a47">STACKFLAG_REQUEST_COMPLETED</a>) {
01504             newlyCompleted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
01505         } <span class="keywordflow">else</span> {
01506             requestsFirstStackLocation-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o1">Flags</a>|=<a class="code" href="../../d9/d4/trackirp_8h.html#a47">STACKFLAG_REQUEST_COMPLETED</a> ;
01507             newlyCompleted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
01508             <a class="code" href="../../d9/d4/trackirp_8h.html#a88">TRACKIRP_DBGPRINT</a>((
01509                 <span class="stringliteral">"  CR2: Request %lx newly completed by %lx\n"</span>,
01510                 requestsFirstStackLocation-iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o9">StackData</a>,
01511                 iovCurrentStackLocation-iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o9">StackData</a>
01512                 ), 3) ;
01513         }
01514         requestFinalized = (iovCurrentStackLocation == requestsFirstStackLocation) ;
01515         <span class="keywordflow">if</span> (requestFinalized) {
01516 
01517             <a class="code" href="../../d9/d4/trackirp_8h.html#a88">TRACKIRP_DBGPRINT</a>((
01518                 <span class="stringliteral">"  CR2: Request %lx finalized\n"</span>,
01519                 iovCurrentStackLocation-iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o9">StackData</a>
01520                 ), 3) ;
01521         }
01522 
01523         <span class="comment">//</span>
01524         <span class="comment">// OK -</span>
01525         <span class="comment">//       If we haven't unwound yet, then IofCallDriverStackData will</span>
01526         <span class="comment">// start out non-NULL, in which case we will scribble away the final</span>
01527         <span class="comment">// completion routine status to everybody asking (could be multiple</span>
01528         <span class="comment">// if they IoSkip'd).</span>
01529         <span class="comment">//       On the other hand, everybody might have unwound, in which</span>
01530         <span class="comment">// case IofCallDriver(...) will start out NULL, and we will already have</span>
01531         <span class="comment">// asserted if STATUS_PENDING wasn't returned much much earlier...</span>
01532         <span class="comment">//       Finally, this slot may not have been "prepared" if an</span>
01533         <span class="comment">// internal stack location called IoSetNextIrpStackLocation, thus</span>
01534         <span class="comment">// consuming a stack location. In this case, IofCallDriverStackData</span>
01535         <span class="comment">// will come from a zero'd slot, and we will do nothing, which is</span>
01536         <span class="comment">// also fine.</span>
01537         <span class="comment">//</span>
01538         irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>(Irp) ;
01539 
01540         <span class="keywordflow">if</span> ((iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o11">AssertFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a2">ASSERTFLAG_POLICEIRPS</a>) &amp;&amp;
01541             (iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o11">AssertFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a3">ASSERTFLAG_MONITORMAJORS</a>)) {
01542 
01543             <a class="code" href="../../d8/d4/flunkirp_8h.html#a5">IovpAssertIrpStackUpward</a>(
01544                 iovPacket,
01545                 irpSp,
01546                 iovCurrentStackLocation,
01547                 newlyCompleted,
01548                 requestFinalized
01549                 );
01550         }
01551 
01552         entranceStatus = status ;
01553 
01554         <span class="keywordflow">while</span>(!IsListEmpty(&amp;iovCurrentStackLocation-&gt;CallStackData)) {
01555 
01556             <span class="comment">//</span>
01557             <span class="comment">// Pop off the list head.</span>
01558             <span class="comment">//</span>
01559             listEntry = RemoveHeadList(&amp;iovCurrentStackLocation-&gt;CallStackData) ;
01560             IofCallDriverStackData = CONTAINING_RECORD(
01561                 listEntry,
01562                 <a class="code" href="../../d3/d0/struct__IOFCALLDRIVER__STACKDATA.html">IOFCALLDRIVER_STACKDATA</a>,
01563                 SharedLocationList) ;
01564 
01565             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(IofCallDriverStackData-&gt;<a class="code" href="../../d3/d0/struct__IOFCALLDRIVER__STACKDATA.html#o2">Flags</a>&amp;CALLFLAG_COMPLETED)) ;
01566 
01567             IofCallDriverStackData-&gt;<a class="code" href="../../d3/d0/struct__IOFCALLDRIVER__STACKDATA.html#o2">Flags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a51">CALLFLAG_COMPLETED</a> ;
01568             IofCallDriverStackData-&gt;<a class="code" href="../../d3/d0/struct__IOFCALLDRIVER__STACKDATA.html#o4">ExpectedStatus</a> = status ;
01569 
01570             <span class="keywordflow">if</span> ((iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o4">AssertFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a11">ASSERTFLAG_ROTATE_STATUS</a>)&amp;&amp;
01571                  <a class="code" href="../../d8/d4/flunkirp_8h.html#a3">IovpAssertDoAdvanceStatus</a>(irpSp, entranceStatus, &amp;status)) {
01572 
01573                 <span class="comment">//</span>
01574                 <span class="comment">// Purposely munge the returned status for everyone at this</span>
01575                 <span class="comment">// layer to flush more bugs. We are specifically trolling for</span>
01576                 <span class="comment">// this buggy sequence:</span>
01577                 <span class="comment">//    Irp-&gt;IoStatus.Status = STATUS_SUCCESS ;</span>
01578                 <span class="comment">//    IoSkipCurrentIrpStackLocation(Irp);</span>
01579                 <span class="comment">//    IoCallDriver(DeviceBelow, Irp) ;</span>
01580                 <span class="comment">//    return STATUS_SUCCESS ;</span>
01581                 <span class="comment">//</span>
01582                 IofCallDriverStackData-&gt;<a class="code" href="../../d3/d0/struct__IOFCALLDRIVER__STACKDATA.html#o2">Flags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a54">CALLFLAG_OVERRIDE_STATUS</a> ;
01583                 IofCallDriverStackData-&gt;<a class="code" href="../../d3/d0/struct__IOFCALLDRIVER__STACKDATA.html#o5">NewStatus</a> = status ;
01584             }
01585         }
01586         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = status ;
01587 
01588         <span class="comment">//</span>
01589         <span class="comment">// Set InUse = FALSE  and  CallStackData = NULL</span>
01590         <span class="comment">//</span>
01591         RtlZeroMemory(iovCurrentStackLocation, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html">IOV_STACK_LOCATION</a>)) ;
01592         InitializeListHead(&amp;iovCurrentStackLocation-&gt;CallStackData) ;
01593     } <span class="keywordflow">else</span> {
01594 
01595         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0) ;
01596     }
01597 
01598     <span class="comment">//</span>
01599     <span class="comment">// Once we return, we may be completed again before IofCompleteRequest3</span>
01600     <span class="comment">// get's called, so we make sure we are at DPC level throughout.</span>
01601     <span class="comment">//</span>
01602     raiseToDPC = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
01603 
01604     <span class="keywordflow">if</span> (iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o4">AssertFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a8">ASSERTFLAG_COMPLETEATDPC</a>) {
01605 
01606         <span class="keywordflow">if</span> (!CompletionPacket-&gt;RaisedCount) {
01607 
01608             <span class="comment">//</span>
01609             <span class="comment">// Copy away the callers IRQL</span>
01610             <span class="comment">//</span>
01611             CompletionPacket-&gt;PreviousIrql = iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o2">CallerIrql</a>;
01612             raiseToDPC = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
01613         }
01614         CompletionPacket-&gt;RaisedCount++ ;
01615     }
01616 
01617     iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o18">LastLocation</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a>+1 ;
01618 
01619     <span class="keywordflow">if</span> (iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o16">TopStackLocation</a> == <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a>) {
01620 
01621         CompletionPacket-&gt;IovSessionData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01622 
01623         <span class="keywordflow">if</span> (iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a26">TRACKFLAG_SURROGATE</a>) {
01624 
01625             <span class="comment">//</span>
01626             <span class="comment">// Scribble away the real completion routine and corrosponding control</span>
01627             <span class="comment">//</span>
01628             irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>(Irp) ;
01629             iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o12">RealIrpCompletionRoutine</a> = irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o116">CompletionRoutine</a> ;
01630             iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o13">RealIrpControl</a> = irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o3">Control</a> ;
01631             iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o14">RealIrpContext</a> = irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o117">Context</a> ;
01632 
01633             <span class="comment">//</span>
01634             <span class="comment">// We want to peek at the Irp prior to completion. This is why we</span>
01635             <span class="comment">// have expanded the initial number of stack locations with the</span>
01636             <span class="comment">// driver verifier enabled.</span>
01637             <span class="comment">//</span>
01638             <a class="code" href="../../d0/d5/io_8h.html#a237">IoSetCompletionRoutine</a>(
01639                 Irp,
01640                 IovpSwapSurrogateIrp,
01641                 Irp,
01642                 TRUE,
01643                 TRUE,
01644                 TRUE
01645                 ) ;
01646 
01647         } <span class="keywordflow">else</span> {
01648 
01649             <span class="comment">//</span>
01650             <span class="comment">// Close this session as the IRP has entirely completed. We drop</span>
01651             <span class="comment">// the pointer count we added to the tracking data here for the</span>
01652             <span class="comment">// same reason.</span>
01653             <span class="comment">//</span>
01654             irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>(Irp) ;
01655             <span class="keywordflow">if</span> (iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o11">AssertFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a2">ASSERTFLAG_POLICEIRPS</a>) {
01656 
01657                 <a class="code" href="../../d8/d4/flunkirp_8h.html#a6">IovpAssertFinalIrpStack</a>(iovPacket, irpSp) ;
01658             }
01659 
01660             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o16">TopStackLocation</a> == <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a>);
01661             <a class="code" href="../../d6/d7/sessnirp_8h.html#a4">IovpSessionDataClose</a>(iovSessionData);
01662             <a class="code" href="../../d6/d7/sessnirp_8h.html#a3">IovpSessionDataDereference</a>(iovSessionData);
01663             <a class="code" href="../../d9/d8/hashirp_8h.html#a14">IovpTrackingDataDereference</a>(iovPacket, IOVREFTYPE_POINTER);
01664         }
01665 
01666     } <span class="keywordflow">else</span> {
01667 
01668         <span class="comment">//</span>
01669         <span class="comment">// We will be seeing this IRP again. Hold a session count against it.</span>
01670         <span class="comment">//</span>
01671         <a class="code" href="../../d6/d7/sessnirp_8h.html#a2">IovpSessionDataReference</a>(iovSessionData);
01672     }
01673 
01674     <span class="comment">//</span>
01675     <span class="comment">// Assert LastLocation is consistent with an IRP that may be completed.</span>
01676     <span class="comment">//</span>
01677     <span class="keywordflow">if</span> (iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o18">LastLocation</a> &lt; iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o16">TopStackLocation</a>) {
01678 
01679         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o9">StackData</a>[iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o18">LastLocation</a>-1].InUse) ;
01680     }
01681 
01682     <a class="code" href="../../d9/d8/hashirp_8h.html#a12">IovpTrackingDataReleaseLock</a>(iovPacket);
01683 
01684     <span class="keywordflow">if</span> (raiseToDPC) {
01685         <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(DISPATCH_LEVEL, &amp;oldIrql);
01686     }
01687 
01688     CompletionPacket-&gt;LocationsAdvanced --;
01689 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="trackirp.c::IovpCompleteRequest3" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovpCompleteRequest3           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Routine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d4/d0/struct__IOFCOMPLETEREQUEST__STACKDATA.html">PIOFCOMPLETEREQUEST_STACKDATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CompletionPacket</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01693">1693</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00036">ASSERTFLAG_COMPLETEATPASSIVE</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00037">ASSERTFLAG_DEFERCOMPLETION</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00034">ASSERTFLAG_FORCEPENDING</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00029">ASSERTFLAG_POLICEIRPS</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00180">_IOV_SESSION_DATA::AssertFlags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02501">_IO_STACK_LOCATION::CompletionRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02508">_IO_STACK_LOCATION::Context</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01655">_IRP::CurrentLocation</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a78">DCERROR_COMPLETION_ROUTINE_PAGABLE</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00130">DCPARAM_IRP</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00131">DCPARAM_ROUTINE</a>, <a class="el" href="../../d9/d4/trackirp_8h.html#a99">DEFERRAL_CONTEXT</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02555">IovpInternalDeferredCompletion()</a>, <a class="el" href="../../d9/d8/hashirp_8h.html#a11">IovpTrackingDataAcquireLock()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00584">IovpTrackingDataReference()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00454">IovpTrackingDataReleaseLock()</a>, <a class="el" href="../../d9/d8/hashirp_8h.html#a21a5">IOVREFTYPE_POINTER</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00176">_IOV_SESSION_DATA::IovRequestPacket</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00227">_DEFERRAL_CONTEXT::IovRequestPacket</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00162">IRP_MN_REMOVE_DEVICE</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00233">_DEFERRAL_CONTEXT::IrpSpNext</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d2/d1/mm_8h.html#a207">MmIsSystemAddressLocked()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00228">_DEFERRAL_CONTEXT::OriginalCompletionRoutine</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00229">_DEFERRAL_CONTEXT::OriginalContext</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00230">_DEFERRAL_CONTEXT::OriginalIrp</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00231">_DEFERRAL_CONTEXT::OriginalPriorityBoost</a>, <a class="el" href="../../d9/d4/trackirp_8h.html#a100">PDEFERRAL_CONTEXT</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00054">POOL_TAG_DEFERRED_CONTEXT</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00216">_IOV_REQUEST_PACKET::PriorityBoost</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01654">_IRP::StackCount</a>, and <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00160">WDM_FAIL_ROUTINE</a>.
<p>
<pre class="fragment"><div>01700              :
01701 
01702     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called just before each completion routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked.
01703 
01704   Arguments:
01705 
01706     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>                    - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> passed into
01707                              <a class="code" href="../../d0/d5/io_8h.html#a473">IofCompleteRequest</a>.
01708 
01709     Routine                - The completion routine about to be called.
01710 
01711     CompletionPacket       - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to data on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callers stack. This will
01712                              be picked up <a class="code" href="../../d8/d4/trackirp_8c.html#a20">IovpCompleteRequest4</a> and
01713                              <a class="code" href="../../d8/d4/trackirp_8c.html#a21">IovpCompleteRequest5</a>.
01714 
01715   Return Value:
01716 
01717      None.
01718 --*/
01719 {
01720     <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> iovPacket;
01721     <a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html">PIOV_SESSION_DATA</a> iovSessionData;
01722     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSpCur, irpSpNext ;
01723     <a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html">PDEFERRAL_CONTEXT</a> deferralContext ;
01724 
01725     iovSessionData = CompletionPacket-&gt;IovSessionData;
01726     <span class="keywordflow">if</span> (iovSessionData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01727 
01728         <span class="keywordflow">return</span>;
01729     }
01730 
01731     iovPacket = iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o0">IovRequestPacket</a>;
01732     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovPacket);
01733     <a class="code" href="../../d9/d8/hashirp_8h.html#a11">IovpTrackingDataAcquireLock</a>(iovPacket);
01734 
01735     <span class="comment">//</span>
01736     <span class="comment">// Verify all completion routines are in nonpaged code, exempting one</span>
01737     <span class="comment">// special case - when a driver completes the IRP to itself by calling</span>
01738     <span class="comment">// IoSetNextStackLocation before calling IoCompleteRequest.</span>
01739     <span class="comment">//</span>
01740     <span class="keywordflow">if</span> (iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o4">AssertFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a2">ASSERTFLAG_POLICEIRPS</a>) {
01741 
01742         <span class="keywordflow">if</span> ((CompletionPacket-&gt;LocationsAdvanced &lt;= 0) &amp;&amp;
01743             (<a class="code" href="../../d2/d1/mm_8h.html#a207">MmIsSystemAddressLocked</a>(Routine) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
01744 
01745             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(
01746                 <span class="stringliteral">"Verifier Notes: LocationsAdvanced %d\n"</span>,
01747                 CompletionPacket-&gt;LocationsAdvanced
01748                 );
01749 
01750             <a class="code" href="../../d2/d5/ioassert_8h.html#a21">WDM_FAIL_ROUTINE</a>((
01751                 DCERROR_COMPLETION_ROUTINE_PAGABLE,
01752                 DCPARAM_IRP + DCPARAM_ROUTINE,
01753                 Irp,
01754                 Routine
01755                 ));
01756         }
01757     }
01758 
01759     <span class="comment">//</span>
01760     <span class="comment">// Setup fields for those assertion functions that will be called *after*</span>
01761     <span class="comment">// the completion routine has been called.</span>
01762     <span class="comment">//</span>
01763     irpSpCur = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>(Irp) ;
01764     CompletionPacket-&gt;IsRemoveIrp =
01765        ((<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a> &lt;= (CCHAR) <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o12">StackCount</a>) &amp;&amp;
01766         (irpSpCur-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> == <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>) &amp;&amp;
01767         (irpSpCur-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> == <a class="code" href="../../d0/d5/io_8h.html#a67">IRP_MN_REMOVE_DEVICE</a>)) ;
01768 
01769     CompletionPacket-&gt;CompletionRoutine = Routine ;
01770 
01771     <span class="comment">//</span>
01772     <span class="comment">// Is this a completion routine that should be called later? Note that this</span>
01773     <span class="comment">// is only legal if we are pending the IRPs (because to the upper driver,</span>
01774     <span class="comment">// IofCallDriver is returning before it's completion routine has been called)</span>
01775     <span class="comment">//</span>
01776     <span class="keywordflow">if</span> ((!CompletionPacket-&gt;IsRemoveIrp)&amp;&amp;
01777        ((iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o4">AssertFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a10">ASSERTFLAG_DEFERCOMPLETION</a>)||
01778         (iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o4">AssertFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a9">ASSERTFLAG_COMPLETEATPASSIVE</a>))) {
01779 
01780         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o4">AssertFlags</a>&amp;ASSERTFLAG_FORCEPENDING) ;
01781 
01782         irpSpNext = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>(Irp) ;
01783 
01784         deferralContext = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
01785            NonPagedPool,
01786            <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html">DEFERRAL_CONTEXT</a>),
01787            POOL_TAG_DEFERRED_CONTEXT
01788            ) ;
01789 
01790         <span class="keywordflow">if</span> (deferralContext) {
01791 
01792             <span class="comment">//</span>
01793             <span class="comment">// Swap the original completion and context for our own.</span>
01794             <span class="comment">//</span>
01795             deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o0">IovRequestPacket</a>          = iovPacket;
01796             deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o6">IrpSpNext</a>                 = irpSpNext;
01797             deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o1">OriginalCompletionRoutine</a> = irpSpNext-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o116">CompletionRoutine</a>;
01798             deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o2">OriginalContext</a>           = irpSpNext-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o117">Context</a>;
01799             deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o3">OriginalIrp</a>               = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
01800             deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o4">OriginalPriorityBoost</a>     = iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o17">PriorityBoost</a>;
01801 
01802             irpSpNext-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o116">CompletionRoutine</a> = <a class="code" href="../../d8/d4/trackirp_8c.html#a28">IovpInternalDeferredCompletion</a>;
01803             irpSpNext-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o117">Context</a>           = deferralContext;
01804             <a class="code" href="../../d9/d8/hashirp_8h.html#a13">IovpTrackingDataReference</a>(iovPacket, IOVREFTYPE_POINTER);
01805         }
01806     }
01807 
01808     <a class="code" href="../../d9/d8/hashirp_8h.html#a12">IovpTrackingDataReleaseLock</a>(iovPacket) ;
01809 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="trackirp.c::IovpCompleteRequest4" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovpCompleteRequest4           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN NTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnedStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d4/d0/struct__IOFCOMPLETEREQUEST__STACKDATA.html">PIOFCOMPLETEREQUEST_STACKDATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CompletionPacket</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01813">1813</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00034">ASSERTFLAG_FORCEPENDING</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00180">_IOV_SESSION_DATA::AssertFlags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02031">_IO_STACK_LOCATION::Control</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a79">DCERROR_PENDING_BIT_NOT_MIGRATED</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00130">DCPARAM_IRP</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00131">DCPARAM_ROUTINE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03620">IoMarkIrpPending</a>, <a class="el" href="../../d9/d8/hashirp_8h.html#a11">IovpTrackingDataAcquireLock()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00454">IovpTrackingDataReleaseLock()</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00176">_IOV_SESSION_DATA::IovRequestPacket</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00221">_IOV_REQUEST_PACKET::pIovSessionData</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01845">SL_PENDING_RETURNED</a>, and <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00160">WDM_FAIL_ROUTINE</a>.
<p>
<pre class="fragment"><div>01820              :
01821 
01822     This assert routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called just after each completion routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01823     invoked (but not <span class="keywordflow">if</span> STATUS_MORE_PROCESSING is returned)
01824 
01825   Arguments:
01826 
01827     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>                    - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> passed into
01828                              <a class="code" href="../../d0/d5/io_8h.html#a473">IofCompleteRequest</a>.
01829 
01830     Routine                - The completion routine called.
01831 
01832     ReturnedStatus         - The status value returned.
01833 
01834     CompletionPacket       - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to data on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callers stack. This was
01835                              filled in by <a class="code" href="../../d8/d4/trackirp_8c.html#a19">IovpCompleteRequest3</a>.
01836 
01837   Return Value:
01838 
01839      None.
01840 --*/
01841 {
01842     <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> iovPacket;
01843     <a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html">PIOV_SESSION_DATA</a> iovSessionData;
01844     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
01845     PVOID routine;
01846 
01847     routine = CompletionPacket-&gt;CompletionRoutine;
01848     iovSessionData = CompletionPacket-&gt;IovSessionData;
01849 
01850     <span class="keywordflow">if</span> (iovSessionData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01851 
01852         <span class="keywordflow">return</span>;
01853     }
01854 
01855     iovPacket = iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o0">IovRequestPacket</a>;
01856     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovPacket);
01857     <a class="code" href="../../d9/d8/hashirp_8h.html#a11">IovpTrackingDataAcquireLock</a>(iovPacket);
01858 
01859     <span class="comment">//</span>
01860     <span class="comment">// ADRIAO BUGBUG 01/06/1999 -</span>
01861     <span class="comment">//     Check for leaked Cancel routines here.</span>
01862     <span class="comment">//</span>
01863     <span class="keywordflow">if</span> (iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o4">AssertFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a7">ASSERTFLAG_FORCEPENDING</a>) {
01864 
01865         <span class="comment">//</span>
01866         <span class="comment">// ADRIAO BUGBUG #05 05/12/98 - Find a way to do this in the non-pend</span>
01867         <span class="comment">//                              everything path...</span>
01868         <span class="comment">//</span>
01869         <span class="keywordflow">if</span> ((ReturnedStatus != STATUS_MORE_PROCESSING_REQUIRED)&amp;&amp;
01870             (iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o21">pIovSessionData</a> == iovSessionData)) {
01871 
01872             <span class="comment">//</span>
01873             <span class="comment">// At this point, we know the completion routine is required to have</span>
01874             <span class="comment">// set the IRP pending bit, because we've hardwired everyone below</span>
01875             <span class="comment">// him to return pending, and we've marked the pending returned bit.</span>
01876             <span class="comment">// Verify he did his part</span>
01877             <span class="comment">//</span>
01878             irpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>(Irp) ;
01879             <span class="keywordflow">if</span> (!(irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o3">Control</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a194">SL_PENDING_RETURNED</a> )) {
01880 
01881                  <a class="code" href="../../d2/d5/ioassert_8h.html#a21">WDM_FAIL_ROUTINE</a>((
01882                      DCERROR_PENDING_BIT_NOT_MIGRATED,
01883                      DCPARAM_IRP + DCPARAM_ROUTINE,
01884                      Irp,
01885                      routine
01886                      ));
01887 
01888                  <span class="comment">//</span>
01889                  <span class="comment">// This will keep the IRP above from erroneously asserting (and</span>
01890                  <span class="comment">// correctly hanging).</span>
01891                  <span class="comment">//</span>
01892                  <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>(Irp);
01893             }
01894         }
01895     }
01896     <a class="code" href="../../d9/d8/hashirp_8h.html#a12">IovpTrackingDataReleaseLock</a>(iovPacket);
01897 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="trackirp.c::IovpCompleteRequest5" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovpCompleteRequest5           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d4/d0/struct__IOFCOMPLETEREQUEST__STACKDATA.html">PIOFCOMPLETEREQUEST_STACKDATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CompletionPacket</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01901">1901</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00035">ASSERTFLAG_COMPLETEATDPC</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00180">_IOV_SESSION_DATA::AssertFlags</a>, <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00152">IovpSessionDataDereference()</a>, <a class="el" href="../../d9/d8/hashirp_8h.html#a11">IovpTrackingDataAcquireLock()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00454">IovpTrackingDataReleaseLock()</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00176">_IOV_SESSION_DATA::IovRequestPacket</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, and <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>.
<p>
<pre class="fragment"><div>01907              :
01908 
01909     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called <span class="keywordflow">for</span> each stack location that could have had a
01910     completion routine, after any possible completion routine has been
01911     called.
01912 
01913   Arguments:
01914 
01915     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>                    - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> passed into
01916                              <a class="code" href="../../d0/d5/io_8h.html#a473">IofCompleteRequest</a>.
01917 
01918     CompletionPacket       - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to a local variable on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack of
01919                              <a class="code" href="../../d0/d5/io_8h.html#a473">IofCompleteRequest</a>. This information was stored
01920                              by <a class="code" href="../../d8/d4/trackirp_8c.html#a18">IovpCompleteRequest2</a> and 3.
01921 
01922   Return Value:
01923 
01924      None.
01925 --*/
01926 {
01927     <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> iovPacket;
01928     <a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html">PIOV_SESSION_DATA</a> iovSessionData;
01929     <a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html">PIOV_STACK_LOCATION</a> iovCurrentStackLocation ;
01930     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status ;
01931 
01932     iovSessionData = CompletionPacket-&gt;IovSessionData;
01933 
01934     <span class="keywordflow">if</span> (iovSessionData) {
01935 
01936         iovPacket = iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o0">IovRequestPacket</a>;
01937         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovPacket);
01938         <a class="code" href="../../d9/d8/hashirp_8h.html#a11">IovpTrackingDataAcquireLock</a>(iovPacket);
01939 
01940         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((!CompletionPacket-&gt;RaisedCount) ||
01941                (iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o4">AssertFlags</a>&amp;ASSERTFLAG_COMPLETEATDPC)) ;
01942 
01943         <a class="code" href="../../d6/d7/sessnirp_8h.html#a3">IovpSessionDataDereference</a>(iovSessionData);
01944         <a class="code" href="../../d9/d8/hashirp_8h.html#a12">IovpTrackingDataReleaseLock</a>(iovPacket);
01945     }
01946 
01947     <span class="comment">//</span>
01948     <span class="comment">// When this count is at zero, we have unnested out of every</span>
01949     <span class="comment">// completion routine, so it is OK to return back to our original IRQL</span>
01950     <span class="comment">//</span>
01951     <span class="keywordflow">if</span> (CompletionPacket-&gt;RaisedCount) {
01952 
01953         <span class="keywordflow">if</span> (!(--CompletionPacket-&gt;RaisedCount)) {
01954             <span class="comment">//</span>
01955             <span class="comment">// Undo IRQL madness (wouldn't want to return to</span>
01956             <span class="comment">// the caller at DPC, would we now?)</span>
01957             <span class="comment">//</span>
01958             <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(CompletionPacket-&gt;PreviousIrql);
01959         }
01960     }
01961 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="trackirp.c::IovpCompleteRequestApc" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovpCompleteRequestApc           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BestStackOffset</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01965">1965</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00276">IovpTrackingDataFindAndLock()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00454">IovpTrackingDataReleaseLock()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d7/d8/assert_8c-source.html#l00036">RtlAssert()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>.
<p>
<pre class="fragment"><div>01971              :
01972 
01973     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC <span class="keywordflow">for</span> completing IRPs and fired.
01974 
01975   Arguments:
01976 
01977     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>                    - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> passed into retrieved from
01978                              <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC in <a class="code" href="../../d2/d4/internal_8c.html#a28">IopCompleteRequest</a>.
01979 
01980     BestStackOffset        - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to a last parameter passed on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack.
01981                              We use <span class="keyword">this</span> to detect <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">case</span> where a driver has
01982                              ignored STATUS_PENDING and left <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> UserIosb on
01983                              <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>'s stack.
01984 
01985   Return Value:
01986 
01987      None.
01988 --*/
01989 {
01990 <span class="preprocessor">#if DBG</span>
01991 <span class="preprocessor"></span><span class="preprocessor">#if defined(_X86_)</span>
01992 <span class="preprocessor"></span>    PUCHAR addr;
01993     <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> iovPacket;
01994 
01995     addr = (PUCHAR)<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a>;
01996     <span class="keywordflow">if</span> ((addr &gt; (PUCHAR)<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;StackLimit) &amp;&amp;
01997         (addr &lt;= (PUCHAR)BestStackOffset)) {
01998 
01999         iovPacket = <a class="code" href="../../d9/d8/hashirp_8h.html#a7">IovpTrackingDataFindAndLock</a>(Irp) ;
02000 
02001         <a class="code" href="../../d6/d9/assert_8c.html#a1">RtlAssert</a>(<span class="stringliteral">"UserIosb below stack pointer"</span>, __FILE__, (ULONG) iovPacket,
02002                   <span class="stringliteral">"Call AdriaO"</span>);
02003 
02004         <a class="code" href="../../d9/d8/hashirp_8h.html#a12">IovpTrackingDataReleaseLock</a>(iovPacket) ;
02005     }
02006 
02007     addr = (PUCHAR)<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a>;
02008     <span class="keywordflow">if</span> ((addr &gt; (PUCHAR)<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;StackLimit) &amp;&amp;
02009         (addr &lt;= (PUCHAR)BestStackOffset)) {
02010 
02011         iovPacket = <a class="code" href="../../d9/d8/hashirp_8h.html#a7">IovpTrackingDataFindAndLock</a>(Irp) ;
02012 
02013         <a class="code" href="../../d6/d9/assert_8c.html#a1">RtlAssert</a>(<span class="stringliteral">"UserEvent below stack pointer"</span>, __FILE__, (ULONG) iovPacket,
02014                   <span class="stringliteral">"Call AdriaO"</span>);
02015 
02016         <a class="code" href="../../d9/d8/hashirp_8h.html#a12">IovpTrackingDataReleaseLock</a>(iovPacket) ;
02017     }
02018 <span class="preprocessor">#endif</span>
02019 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02020 <span class="preprocessor"></span>}

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="trackirp.c::IovpDeleteDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IovpDeleteDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03379">3379</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d2/d5/ioassert_8h.html#a114a40">DCERROR_DELETE_WHILE_ATTACHED</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03620">IovpGetDeviceAttachedTo()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, and <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00154">WDM_FAIL_CALLER1</a>.
<p>
<pre class="fragment"><div>03382 {
03383     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceBelow;
03384 
03385     <span class="comment">//</span>
03386     <span class="comment">// ADRIAO BUGBUG 03/03/1999 -</span>
03387     <span class="comment">//     Complain if the dude already deleted himself.</span>
03388     <span class="comment">//</span>
03389 
03390     deviceBelow = <a class="code" href="../../d9/d4/trackirp_8h.html#a125">IovpGetDeviceAttachedTo</a>(DeviceObject);
03391     <span class="keywordflow">if</span> (deviceBelow) {
03392 
03393         <a class="code" href="../../d2/d5/ioassert_8h.html#a15">WDM_FAIL_CALLER1</a>((DCERROR_DELETE_WHILE_ATTACHED, 0));
03394         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceBelow);
03395     }
03396 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="trackirp.c::IovpDetachDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IovpDetachDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LowerDevice</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03354">3354</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d2/d5/ioassert_8h.html#a114a41">DCERROR_DETACH_NOT_ATTACHED</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00132">DCPARAM_DEVOBJ</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00091">DOE_EXAMINED</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00092">DOE_TRACKED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01268">_DEVOBJ_EXTENSION::ExtensionFlags</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00155">WDM_FAIL_CALLER2</a>.
<p>
<pre class="fragment"><div>03357 {
03358     <a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html">PDEVOBJ_EXTENSION</a> deviceExtension;
03359 
03360     <span class="keywordflow">if</span> (LowerDevice-&gt;AttachedDevice == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03361 
03362         <a class="code" href="../../d2/d5/ioassert_8h.html#a16">WDM_FAIL_CALLER2</a>((DCERROR_DETACH_NOT_ATTACHED, DCPARAM_DEVOBJ, LowerDevice));
03363     } <span class="keywordflow">else</span> {
03364 
03365         <span class="comment">//</span>
03366         <span class="comment">// ADRIAO BUGBUG 01/07/1999 -</span>
03367         <span class="comment">//     As the stack can be torn apart simulatenously from above and</span>
03368         <span class="comment">// below during a remove IRP, we cannot assert the below, and moreover</span>
03369         <span class="comment">// changes to the ExtensionFlags will have to involve walking the tree.</span>
03370         <span class="comment">//</span>
03371         <span class="comment">// ASSERT(LowerDevice-&gt;AttachedDevice-&gt;AttachedDevice == NULL);</span>
03372         <span class="comment">//</span>
03373         deviceExtension = LowerDevice-&gt;AttachedDevice-&gt;DeviceObjectExtension;
03374         deviceExtension-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> &amp;=~ (<a class="code" href="../../d9/d4/trackirp_8h.html#a44">DOE_EXAMINED</a> | <a class="code" href="../../d9/d4/trackirp_8h.html#a45">DOE_TRACKED</a>);
03375     }
03376 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="trackirp.c::IovpDoAssertIrps" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN FASTCALL IovpDoAssertIrps           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00404">404</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00091">IoVerifierInit()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04698">IOVERIFIERINIT_ASYNCHRONOUSINIT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04697">IOVERIFIERINIT_EVERYTHING_TRACKED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04699">IOVERIFIERINIT_NO_REINIT</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00130">IovpIrpTrackingEnabled</a>, and <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00121">IovpTrackingFlags</a>.
<p>
<pre class="fragment"><div>00409              :
00410 
00411     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to ensure we can <span class="keywordflow">do</span> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> assertions. When called we
00412     lock <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> neccessary data structures and code <span class="keywordflow">if</span> we haven'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> been initialized.
00413 
00414   Arguments: None
00415 
00416   Return Value:
00417 
00418     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> assertions can be done, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise (e.g.,
00419     called at DPC time and we weren't already enabled)
00420 
00421 --*/
00422 {
00423     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IovpTrackingFlags);
00424     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= DISPATCH_LEVEL) ;
00425 
00426     <span class="comment">//</span>
00427     <span class="comment">// If we aren't enabled, call the enabling function. This is harmless to</span>
00428     <span class="comment">// call repeatedly. We are not gaurenteed to be enabled when this function</span>
00429     <span class="comment">// returns (it can't block anyway, as paging might need to occur, and we'd</span>
00430     <span class="comment">// be sitting on file system IRPs). The IOVERIFIERINIT_EVERYTHING_TRACKED is</span>
00431     <span class="comment">// used to let us know we caught all IRPs, ie none are outstanding that</span>
00432     <span class="comment">// haven't been tracked/marked in some manner. We can set this here as</span>
00433     <span class="comment">// SPECIALIRP_MARK_NON_TRACKABLE() is called in the normal IofCallDriver</span>
00434     <span class="comment">// code paths if SPECIAL_IRP's are enabled.</span>
00435     <span class="comment">//</span>
00436     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/trackirp_8c.html#a9">IovpIrpTrackingEnabled</a>) {
00437 
00438 <span class="preprocessor">#if 0</span>
00439 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/ioverifier_8c.html#a26">IoVerifierInit</a>(
00440             DRIVER_VERIFIER_IO_CHECKING,
00441             IOVERIFIERINIT_EVERYTHING_TRACKED |
00442             IOVERIFIERINIT_ASYNCHRONOUSINIT |
00443             IOVERIFIERINIT_NO_REINIT
00444             );
00445 <span class="preprocessor">#endif</span>
00446 <span class="preprocessor"></span>    }
00447 
00448     <span class="comment">//</span>
00449     <span class="comment">// If enabled, return so.</span>
00450     <span class="comment">//</span>
00451     <span class="keywordflow">return</span> <a class="code" href="../../d8/d4/trackirp_8c.html#a9">IovpIrpTrackingEnabled</a>;
00452 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="trackirp.c::IovpEnumDevObjCallback" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IovpEnumDevObjCallback           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PointerCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03413">3413</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00091">DOE_EXAMINED</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00092">DOE_TRACKED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01268">_DEVOBJ_EXTENSION::ExtensionFlags</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03399">IovpReexamineAllStacks()</a>.
<p>
<pre class="fragment"><div>03420 {
03421     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>      deviceObject;
03422     <a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html">PDEVOBJ_EXTENSION</a>   deviceExtension;
03423 
03424     deviceObject = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>) Object;
03425     deviceExtension = deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>;
03426 
03427     <span class="keywordflow">if</span> (PointerCount || HandleCount) {
03428 
03429         deviceExtension-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> &amp;=~ (<a class="code" href="../../d9/d4/trackirp_8h.html#a44">DOE_EXAMINED</a> | <a class="code" href="../../d9/d4/trackirp_8h.html#a45">DOE_TRACKED</a>);
03430     }
03431 
03432     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03433 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a42" doxytag="trackirp.c::IovpExamineDevObjForwarding" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovpExamineDevObjForwarding           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceBeingCalled</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceLastCalled</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ForwardTechnique</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03537">3537</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01181">_DEVICE_OBJECT::AttachedDevice</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00121">CHANGED_STACKS_AT_BOTTOM</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00122">CHANGED_STACKS_MID_STACK</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00118">FORWARDED_TO_NEXT_DO</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00054">IopDatabaseLock</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03620">IovpGetDeviceAttachedTo()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00119">SKIPPED_A_DO</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00120">STARTED_INSIDE_STACK</a>, and <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00117">STARTED_TOP_OF_STACK</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00493">IovpCallDriver1()</a>.
<p>
<pre class="fragment"><div>03544            :
03545 
03546         <a class="code" href="../../d9/d4/trackirp_8h.html#a62">STARTED_TOP_OF_STACK</a>
03547         <a class="code" href="../../d9/d4/trackirp_8h.html#a63">FORWARDED_TO_NEXT_DO</a>
03548         <a class="code" href="../../d9/d4/trackirp_8h.html#a64">SKIPPED_A_DO</a>
03549         <a class="code" href="../../d9/d4/trackirp_8h.html#a65">STARTED_INSIDE_STACK</a>
03550         <a class="code" href="../../d9/d4/trackirp_8h.html#a66">CHANGED_STACKS_AT_BOTTOM</a>
03551         <a class="code" href="../../d9/d4/trackirp_8h.html#a67">CHANGED_STACKS_MID_STACK</a>
03552 
03553 --*/
03554 
03555 {
03556     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> upperDevobj, lowerObject ;
03557     ULONG result ;
03558     KIRQL irql;
03559 
03560     lowerObject = <a class="code" href="../../d9/d4/trackirp_8h.html#a125">IovpGetDeviceAttachedTo</a>(DeviceLastCalled) ;
03561 
03562     ExAcquireFastLock( &amp;IopDatabaseLock, &amp;irql );
03563 
03564     <span class="comment">//</span>
03565     <span class="comment">// Nice and simple. Walk the device being called</span>
03566     <span class="comment">// upwards and find either NULL or the last device</span>
03567     <span class="comment">// we called.</span>
03568     <span class="comment">//</span>
03569     upperDevobj = DeviceBeingCalled-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a> ;
03570     <span class="keywordflow">while</span>(upperDevobj &amp;&amp; (upperDevobj != DeviceLastCalled)) {
03571 
03572         upperDevobj = upperDevobj-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a> ;
03573     }
03574 
03575     <span class="keywordflow">if</span> (DeviceLastCalled == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03576 
03577         <span class="comment">//</span>
03578         <span class="comment">// This is a newly started IRP, was it targetted</span>
03579         <span class="comment">// at the top of a stack or at the middle/bottom?</span>
03580         <span class="comment">//</span>
03581         result = (DeviceBeingCalled-&gt;AttachedDevice) ? <a class="code" href="../../d9/d4/trackirp_8h.html#a65">STARTED_INSIDE_STACK</a> :
03582                                                        <a class="code" href="../../d9/d4/trackirp_8h.html#a62">STARTED_TOP_OF_STACK</a> ;
03583 
03584     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (upperDevobj == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03585 
03586         <span class="comment">//</span>
03587         <span class="comment">// We were forwarded the Irp beyond our own stack</span>
03588         <span class="comment">//</span>
03589         result = (lowerObject) ? <a class="code" href="../../d9/d4/trackirp_8h.html#a67">CHANGED_STACKS_MID_STACK</a> :
03590                                  <a class="code" href="../../d9/d4/trackirp_8h.html#a66">CHANGED_STACKS_AT_BOTTOM</a> ;
03591 
03592     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (DeviceBeingCalled-&gt;AttachedDevice == upperDevobj) {
03593 
03594         result = <a class="code" href="../../d9/d4/trackirp_8h.html#a63">FORWARDED_TO_NEXT_DO</a> ;
03595 
03596         <span class="comment">//</span>
03597         <span class="comment">// Quick assertion, if LastDevice was non-NULL, the</span>
03598         <span class="comment">// device under him should be the one we are calling...</span>
03599         <span class="comment">//</span>
03600         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(lowerObject == DeviceBeingCalled) ;
03601 
03602     } <span class="keywordflow">else</span> {
03603 
03604         <span class="comment">//</span>
03605         <span class="comment">// DeviceLastCalled was found higher in the stack, but wasn't</span>
03606         <span class="comment">// directly above DeviceBeingCalled</span>
03607         <span class="comment">//</span>
03608         result = <a class="code" href="../../d9/d4/trackirp_8h.html#a64">SKIPPED_A_DO</a> ;
03609     }
03610 
03611     ExReleaseFastLock( &amp;IopDatabaseLock, irql );
03612     <span class="keywordflow">if</span> (lowerObject) {
03613         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(lowerObject) ;
03614     }
03615     *ForwardTechnique = result ;
03616 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="trackirp.c::IovpExamineIrpStackForwarding" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IovpExamineIrpStackForwarding           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IovPacket</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IsNewSession</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ForwardMethod</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>IoCurrentStackLocation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>IoLastStackLocation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT ULONG *&nbsp;</td>
          <td class="mdname" nowrap> <em>StackLocationsAdvanced</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02239">2239</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00033">ASSERTFLAG_CONSUME_ALWAYS</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00029">ASSERTFLAG_POLICEIRPS</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02501">_IO_STACK_LOCATION::CompletionRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02508">_IO_STACK_LOCATION::Context</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02031">_IO_STACK_LOCATION::Control</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01655">_IRP::CurrentLocation</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a47">DCERROR_INSUFFICIENT_STACK_LOCATIONS</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a46">DCERROR_IRPSP_COPIED</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a45">DCERROR_NEXTIRPSP_DIRTY</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a67">DCERROR_UNNECCESSARY_COPY</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00130">DCPARAM_IRP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02488">_IO_STACK_LOCATION::DeviceObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01179">_DEVICE_OBJECT::DriverObject</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00488">FAIL_CALLER_OF_IOFCALLDRIVER2</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00118">FORWARDED_TO_NEXT_DO</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00051">HACKFLAG_FOR_SCSIPORT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04009">IoCopyCurrentIrpStackLocationToNext</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03913">IoSetCompletionRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03977">IoSetNextIrpStackLocation</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00122">IovpHackFlags</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02446">IovpInternalCompletionTrap()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02751">IovpSwapSurrogateIrp()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00077">IRP_MJ_POWER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00113">SL_NOTCOPIED</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00151">WDM_CHASTISE_CALLER3</a>, and <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00152">WDM_CHASTISE_CALLER5</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00493">IovpCallDriver1()</a>.
<p>
<pre class="fragment"><div>02249 {
02250     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
02251     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp, irpLastSp;
02252     BOOLEAN isSameStack;
02253     ULONG locationsAdvanced;
02254 
02255     irpSp = *IoCurrentStackLocation;
02256 
02257     <span class="keywordflow">if</span> (!IsNewSession) {
02258 
02259         <span class="comment">//</span>
02260         <span class="comment">// We are sitting on current next being one back (-1) from</span>
02261         <span class="comment">// CurrentStackLocation.</span>
02262         <span class="comment">//</span>
02263         locationsAdvanced = IovPacket-&gt;LastLocation-<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a> ;
02264         irpLastSp = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.CurrentStackLocation+(locationsAdvanced-1) ;
02265 
02266     } <span class="keywordflow">else</span> {
02267 
02268         <span class="comment">//</span>
02269         <span class="comment">// New IRP, so no last SP and we always advance "1"</span>
02270         <span class="comment">//</span>
02271         locationsAdvanced = 1 ;
02272         irpLastSp = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
02273     }
02274 
02275     <span class="keywordflow">if</span> ((!IsNewSession) &amp;&amp; (IovPacket-&gt;AssertFlags&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a2">ASSERTFLAG_POLICEIRPS</a>)) {
02276 
02277         <span class="comment">//</span>
02278         <span class="comment">// As the control field is zeroed by IoCopyCurrentStackLocation, we</span>
02279         <span class="comment">// dope each stack location with the value SL_NOTCOPIED. If it is</span>
02280         <span class="comment">// zeroed or the IRP stack location has stayed the same, the one of</span>
02281         <span class="comment">// the two API's was called. Otherwise the next stack location wasn't</span>
02282         <span class="comment">// set up properly (I have yet to find a case otherwise)...</span>
02283         <span class="comment">//</span>
02284         <span class="keywordflow">if</span> ((irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o3">Control</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a60">SL_NOTCOPIED</a>)&amp;&amp;
02285             IovPacket-&gt;LastLocation != <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a>) {
02286 
02287 <span class="preprocessor">#if 0</span>
02288 <span class="preprocessor"></span>            <a class="code" href="../../d8/d4/trackirp_8c.html#a6">FAIL_CALLER_OF_IOFCALLDRIVER2</a>(
02289                 (DCERROR_NEXTIRPSP_DIRTY, DCPARAM_IRP, Irp),
02290                 irpSp
02291                 );
02292 <span class="preprocessor">#endif</span>
02293 <span class="preprocessor"></span>        }
02294 
02295         <span class="comment">//</span>
02296         <span class="comment">// Now check for people who copy the stack locations and forget to</span>
02297         <span class="comment">// wipe out previous completion routines.</span>
02298         <span class="comment">//</span>
02299         <span class="keywordflow">if</span> (locationsAdvanced) {
02300 
02301             <span class="comment">//</span>
02302             <span class="comment">// IoCopyCurrentStackLocation copies everything but Completion,</span>
02303             <span class="comment">// Context, and Control</span>
02304             <span class="comment">//</span>
02305             isSameStack = RtlEqualMemory(irpSp, irpLastSp,
02306                 FIELD_OFFSET(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>, Control)) ;
02307 
02308             isSameStack &amp;= RtlEqualMemory(&amp;irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>, &amp;irpLastSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>,
02309                 FIELD_OFFSET(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>, DeviceObject)-
02310                 FIELD_OFFSET(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>, Parameters)) ;
02311 
02312             isSameStack &amp;= (irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> == irpLastSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>) ;
02313 
02314             <span class="comment">//</span>
02315             <span class="comment">// We should *never* see this on the stack! If we do, something</span>
02316             <span class="comment">// quite bizarre has happened...</span>
02317             <span class="comment">//</span>
02318             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o116">CompletionRoutine</a> != IovpSwapSurrogateIrp) ;
02319 
02320             <span class="keywordflow">if</span> (isSameStack) {
02321 
02322                 <span class="comment">//</span>
02323                 <span class="comment">// We caught them doing something either very bad or quite</span>
02324                 <span class="comment">// inefficient. We can tell which based on whether there is</span>
02325                 <span class="comment">// a completion routine.</span>
02326                 <span class="comment">//</span>
02327                 <span class="keywordflow">if</span> ((irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o116">CompletionRoutine</a> == irpLastSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o116">CompletionRoutine</a>)&amp;&amp;
02328                     (irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o117">Context</a> == irpLastSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o117">Context</a>) &amp;&amp;
02329                     (irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o3">Control</a> == irpLastSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o3">Control</a>) &amp;&amp;
02330                     (irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o116">CompletionRoutine</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
02331                     (DeviceObject-&gt;DriverObject != irpLastSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o57">DeviceObject</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>)
02332                     ) {
02333 
02334                     <span class="comment">//</span>
02335                     <span class="comment">// Duplication of both the completion and the context</span>
02336                     <span class="comment">// while not properly zeroing the control field is enough</span>
02337                     <span class="comment">// to make me believe the caller has made a vexing mistake.</span>
02338                     <span class="comment">//</span>
02339                     <a class="code" href="../../d8/d4/trackirp_8c.html#a6">FAIL_CALLER_OF_IOFCALLDRIVER2</a>(
02340                         (DCERROR_IRPSP_COPIED, DCPARAM_IRP, Irp),
02341                         irpSp
02342                         ) ;
02343 
02344                     <span class="comment">//</span>
02345                     <span class="comment">// Repair the stack</span>
02346                     <span class="comment">//</span>
02347                     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o116">CompletionRoutine</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
02348                     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o3">Control</a> = 0 ;
02349 
02350                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o116">CompletionRoutine</a>) {
02351 
02352                     <span class="keywordflow">if</span> (!(irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o3">Control</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a60">SL_NOTCOPIED</a>)
02353 <span class="preprocessor">#ifdef HACKHACKS_ENABLED</span>
02354 <span class="preprocessor"></span>                        &amp;&amp; (!(<a class="code" href="../../d8/d4/trackirp_8c.html#a8">IovpHackFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a16">HACKFLAG_FOR_SCSIPORT</a>))
02355 <span class="preprocessor">#endif</span>
02356 <span class="preprocessor"></span>                        ) {
02357 
02358                         <span class="comment">//</span>
02359                         <span class="comment">// ADRIAO HACKHACK 06/12/98 #10 - PeterWie does this for</span>
02360                         <span class="comment">// two reasons:</span>
02361                         <span class="comment">// 1) It's easier to debug</span>
02362                         <span class="comment">// 2) The space is not really recovered anyway.</span>
02363                         <span class="comment">//</span>
02364                         <span class="comment">// This will be an ongoing argument it seems, but #2 can</span>
02365                         <span class="comment">// be cleverly solved if one decrements their stack</span>
02366                         <span class="comment">// count, and #1 I've solved in Debug...</span>
02367                         <span class="comment">//</span>
02368                         <span class="keywordflow">if</span> (irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> == <a class="code" href="../../d0/d5/io_8h.html#a35">IRP_MJ_POWER</a>) {
02369 
02370                             <span class="comment">//</span>
02371                             <span class="comment">// Unwind back past PoCallDriver...</span>
02372                             <span class="comment">//</span>
02373                             <a class="code" href="../../d2/d5/ioassert_8h.html#a13">WDM_CHASTISE_CALLER5</a>(
02374                                 (DCERROR_UNNECCESSARY_COPY, DCPARAM_IRP, Irp)
02375                                 );
02376 
02377                         } <span class="keywordflow">else</span> {
02378 
02379                             <a class="code" href="../../d2/d5/ioassert_8h.html#a12">WDM_CHASTISE_CALLER3</a>(
02380                                 (DCERROR_UNNECCESSARY_COPY, DCPARAM_IRP, Irp)
02381                                 );
02382                         }
02383                     }
02384 
02385                     <a class="code" href="../../d0/d5/io_8h.html#a237">IoSetCompletionRoutine</a>(
02386                         Irp,
02387                         IovpInternalCompletionTrap,
02388                         <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp ),
02389                         TRUE,
02390                         TRUE,
02391                         TRUE
02392                         ) ;
02393                 }
02394             }
02395 
02396         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IovPacket-&gt;AssertFlags&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a6">ASSERTFLAG_CONSUME_ALWAYS</a>) {
02397 
02398             <span class="keywordflow">if</span> (ForwardMethod == <a class="code" href="../../d9/d4/trackirp_8h.html#a63">FORWARDED_TO_NEXT_DO</a>) {
02399 
02400                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a>&lt;2) {
02401 
02402                     <a class="code" href="../../d8/d4/trackirp_8c.html#a6">FAIL_CALLER_OF_IOFCALLDRIVER2</a>(
02403                         (DCERROR_INSUFFICIENT_STACK_LOCATIONS, DCPARAM_IRP, Irp),
02404                         irpSp
02405                         ) ;
02406 
02407                 } <span class="keywordflow">else</span> {
02408 
02409                     <span class="comment">//</span>
02410                     <span class="comment">// Back up the skip, then copy. Add a completion routine with</span>
02411                     <span class="comment">// unique and assertable context to catch people who clumsily</span>
02412                     <span class="comment">// Rtl-copy stack locations (we can't catch them if the caller</span>
02413                     <span class="comment">// above used an empty stack with no completion routine)...</span>
02414                     <span class="comment">//</span>
02415                     <a class="code" href="../../d0/d5/io_8h.html#a238">IoSetNextIrpStackLocation</a>( Irp ) ;
02416 
02417                     <span class="comment">//</span>
02418                     <span class="comment">// Set the trap...</span>
02419                     <span class="comment">//</span>
02420                     <a class="code" href="../../d0/d5/io_8h.html#a239">IoCopyCurrentIrpStackLocationToNext</a>( Irp ) ;
02421                     <a class="code" href="../../d0/d5/io_8h.html#a237">IoSetCompletionRoutine</a>(
02422                         Irp,
02423                         IovpInternalCompletionTrap,
02424                         <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp ),
02425                         TRUE,
02426                         TRUE,
02427                         TRUE
02428                         ) ;
02429 
02430                     <span class="comment">//</span>
02431                     <span class="comment">// This is our new reality...</span>
02432                     <span class="comment">//</span>
02433                     locationsAdvanced = 1 ;
02434                     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( Irp );
02435                 }
02436             }
02437         }
02438     }
02439 
02440     *IoCurrentStackLocation = irpSp;
02441     *IoLastStackLocation = irpLastSp;
02442     *StackLocationsAdvanced = locationsAdvanced;
02443 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="trackirp.c::IovpFreeIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovpFreeIrp           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>FreeHandled</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02990">2990</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01680">_IRP::AllocationFlags</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00029">ASSERTFLAG_POLICEIRPS</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00204">_IOV_REQUEST_PACKET::AssertFlags</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a50">DCERROR_FREE_OF_INUSE_IRP</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a51">DCERROR_FREE_OF_THREADED_IRP</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00130">DCPARAM_IRP</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00197">_IOV_REQUEST_PACKET::Flags</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00838">IovpProtectedIrpFree()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00744">IovpProtectedIrpMakeUntouchable()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00612">IovpTrackingDataDereference()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00276">IovpTrackingDataFindAndLock()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00657">IovpTrackingDataGetCurrentSessionData()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00454">IovpTrackingDataReleaseLock()</a>, <a class="el" href="../../d9/d8/hashirp_8h.html#a21a5">IOVREFTYPE_POINTER</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00115">IRP_ALLOCATION_MONITORED</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00196">_IOV_REQUEST_PACKET::PointerCount</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01629">_IRP::ThreadListEntry</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00081">TRACKFLAG_IO_ALLOCATED</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00073">TRACKFLAG_PROTECTEDIRP</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00082">TRACKFLAG_UNWOUND_BADLY</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01584">_IRP::Type</a>, and <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00155">WDM_FAIL_CALLER2</a>.
<p>
<pre class="fragment"><div>02996              :
02997 
02998     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by <a class="code" href="../../d0/d5/io_8h.html#a493">IoFreeIrp</a> and returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> iff
02999     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> free was handled internally here (in which <span class="keywordflow">case</span> IoFreeIrp
03000     should <span class="keywordflow">do</span> nothing).
03001 
03002     We need to handle <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call internally because we may turn off lookaside
03003     list cacheing to <span class="keywordflow">catch</span> people reusing IRPs after they are freed.
03004 
03005   Arguments:
03006 
03007     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>                    - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> passed into
03008                              <a class="code" href="../../d0/d5/io_8h.html#a464">IoCancelIrp</a>.
03009 
03010     FreeHandled            - Indicates whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> free operation was
03011                              handled entirely by <span class="keyword">this</span> routine.
03012 
03013   Return Value:
03014 
03015      None.
03016 
03017 --*/
03018 {
03019     <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> iovPacket;
03020     PVOID restoreHandle ;
03021 
03022     iovPacket = <a class="code" href="../../d9/d8/hashirp_8h.html#a7">IovpTrackingDataFindAndLock</a>(Irp);
03023 
03024     <span class="keywordflow">if</span> (iovPacket == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03025 
03026         <span class="comment">//</span>
03027         <span class="comment">// ADRIAO BUGBUG 01/06/1999 -</span>
03028         <span class="comment">//     Below assertion might fire if an IRP allocated then freed twice.</span>
03029         <span class="comment">//</span>
03030         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o17">AllocationFlags</a>&amp;IRP_ALLOCATION_MONITORED));
03031         *FreeHandled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
03032         <span class="keywordflow">return</span>;
03033     }
03034 
03035     <span class="keywordflow">if</span> (!IsListEmpty(&amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o8">ThreadListEntry</a>)) {
03036 
03037         <span class="keywordflow">if</span> (iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o11">AssertFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a2">ASSERTFLAG_POLICEIRPS</a>) {
03038 
03039             <a class="code" href="../../d2/d5/ioassert_8h.html#a16">WDM_FAIL_CALLER2</a>(
03040                 (DCERROR_FREE_OF_THREADED_IRP, DCPARAM_IRP, Irp)
03041                 );
03042         }
03043 
03044         <span class="comment">//</span>
03045         <span class="comment">// &lt;Grumble&gt; keep us alive by not actually freeing the IRP if someone did</span>
03046         <span class="comment">// this to us. We leak for life...</span>
03047         <span class="comment">//</span>
03048         *FreeHandled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
03049         <span class="keywordflow">return</span> ;
03050     }
03051 
03052     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d8/hashirp_8h.html#a16">IovpTrackingDataGetCurrentSessionData</a>(iovPacket)) {
03053 
03054         <span class="comment">//</span>
03055         <span class="comment">// If there's a current session, that means someone is freeing an IRP</span>
03056         <span class="comment">// that they don't own. Of course, if the stack unwound badly because</span>
03057         <span class="comment">// someone forgot to return PENDING or complete the IRP, then we don't</span>
03058         <span class="comment">// assert here (we'd probably end up blaiming kernel).</span>
03059         <span class="comment">//</span>
03060         <span class="keywordflow">if</span> ((iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o11">AssertFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a2">ASSERTFLAG_POLICEIRPS</a>) &amp;&amp;
03061             (!(iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a36">TRACKFLAG_UNWOUND_BADLY</a>))) {
03062 
03063             <a class="code" href="../../d2/d5/ioassert_8h.html#a16">WDM_FAIL_CALLER2</a>(
03064                 (DCERROR_FREE_OF_INUSE_IRP, DCPARAM_IRP, Irp)
03065                 );
03066         }
03067 
03068         <span class="comment">//</span>
03069         <span class="comment">// &lt;Grumble&gt; keep us alive by not actually freeing the IRP if someone did</span>
03070         <span class="comment">// this to us. We leak for life...</span>
03071         <span class="comment">//</span>
03072         <a class="code" href="../../d9/d8/hashirp_8h.html#a12">IovpTrackingDataReleaseLock</a>(iovPacket) ;
03073         *FreeHandled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
03074         <span class="keywordflow">return</span> ;
03075     }
03076 
03077     <span class="keywordflow">if</span> (!(iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a35">TRACKFLAG_IO_ALLOCATED</a>)) {
03078 
03079         <span class="comment">//</span>
03080         <span class="comment">// We weren't tracking this at allocation time. We shouldn't got our</span>
03081         <span class="comment">// packet unless the IRP had a pointer count still, meaning it's has</span>
03082         <span class="comment">// a session. And that should've been caught above.</span>
03083         <span class="comment">//</span>
03084         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
03085         <a class="code" href="../../d9/d8/hashirp_8h.html#a12">IovpTrackingDataReleaseLock</a>(iovPacket) ;
03086         *FreeHandled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
03087         <span class="keywordflow">return</span>;
03088     }
03089 
03090     <span class="comment">//</span>
03091     <span class="comment">// The IRP may have been reinitialized, possibly losing it's allocation</span>
03092     <span class="comment">// flags. We catch this bug in the IoInitializeIrp hook.</span>
03093     <span class="comment">//</span>
03094     <span class="comment">//ASSERT(Irp-&gt;AllocationFlags&amp;IRP_ALLOCATION_MONITORED) ;</span>
03095     <span class="comment">//</span>
03096 
03097     <span class="keywordflow">if</span> (!(iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a28">TRACKFLAG_PROTECTEDIRP</a>)) {
03098 
03099         <span class="comment">//</span>
03100         <span class="comment">// We're just tagging along this IRP. Drop our pointer count but bail.</span>
03101         <span class="comment">//</span>
03102         <a class="code" href="../../d9/d8/hashirp_8h.html#a14">IovpTrackingDataDereference</a>(iovPacket, IOVREFTYPE_POINTER);
03103         <a class="code" href="../../d9/d8/hashirp_8h.html#a12">IovpTrackingDataReleaseLock</a>(iovPacket);
03104         *FreeHandled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03105         <span class="keywordflow">return</span>;
03106     }
03107 
03108     <span class="comment">//</span>
03109     <span class="comment">// Set up a nice bugcheck for those who free their IRPs twice. This is done</span>
03110     <span class="comment">// because the special pool may have been exhausted, in which case the IRP</span>
03111     <span class="comment">// can be touched after it has been freed.</span>
03112     <span class="comment">//</span>
03113     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o0">Type</a> = 0;
03114 
03115     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovPacket) ;
03116     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o11">AssertFlags</a>&amp;ASSERTFLAG_POLICEIRPS);
03117     <a class="code" href="../../d9/d8/hashirp_8h.html#a14">IovpTrackingDataDereference</a>(iovPacket, IOVREFTYPE_POINTER);
03118     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o4">PointerCount</a> == 0);
03119     <a class="code" href="../../d9/d8/hashirp_8h.html#a12">IovpTrackingDataReleaseLock</a>(iovPacket) ;
03120     restoreHandle = <a class="code" href="../../d9/d8/hashirp_8h.html#a17">IovpProtectedIrpMakeUntouchable</a>(Irp, TRUE) ;
03121     <a class="code" href="../../d9/d8/hashirp_8h.html#a19">IovpProtectedIrpFree</a>(Irp, &amp;restoreHandle) ;
03122 
03123     <span class="comment">//</span>
03124     <span class="comment">// We handled allocation and initialization. There is nothing much more to</span>
03125     <span class="comment">// do.</span>
03126     <span class="comment">//</span>
03127     *FreeHandled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
03128 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a43" doxytag="trackirp.c::IovpGetDeviceAttachedTo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> FASTCALL IovpGetDeviceAttachedTo           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03620">3620</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01283">_DEVOBJ_EXTENSION::AttachedTo</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00054">IopDatabaseLock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00493">IovpCallDriver1()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00948">IovpCallDriver2()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03379">IovpDeleteDevice()</a>, and <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03537">IovpExamineDevObjForwarding()</a>.
<p>
<pre class="fragment"><div>03623 {
03624     <a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html">PDEVOBJ_EXTENSION</a> deviceExtension;
03625     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceAttachedTo ;
03626     KIRQL irql ;
03627 
03628     <span class="keywordflow">if</span> (DeviceObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03629 
03630         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
03631     }
03632 
03633     ExAcquireFastLock( &amp;IopDatabaseLock, &amp;irql );
03634 
03635     deviceExtension = DeviceObject-&gt;DeviceObjectExtension;
03636     deviceAttachedTo = deviceExtension-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o7">AttachedTo</a> ;
03637 
03638     <span class="keywordflow">if</span> (deviceAttachedTo) {
03639         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(deviceAttachedTo) ;
03640     }
03641 
03642     ExReleaseFastLock( &amp;IopDatabaseLock, irql );
03643     <span class="keywordflow">return</span> deviceAttachedTo ;
03644 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a44" doxytag="trackirp.c::IovpGetLowestDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> FASTCALL IovpGetLowestDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03648">3648</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01283">_DEVOBJ_EXTENSION::AttachedTo</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00054">IopDatabaseLock</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>.
<p>
Referenced by <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l00191">IovpAssertNewRequest()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03680">IovpAssertNonLegacyDevice()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00493">IovpCallDriver1()</a>, and <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l01392">IovpThrowChaffAtStartedPdoStack()</a>.
<p>
<pre class="fragment"><div>03656 {
03657     <a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html">PDEVOBJ_EXTENSION</a> deviceExtension;
03658     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> lowerDevobj, deviceAttachedTo ;
03659     KIRQL irql ;
03660 
03661     deviceAttachedTo = DeviceObject ;
03662 
03663     ExAcquireFastLock( &amp;IopDatabaseLock, &amp;irql );
03664 
03665     <span class="keywordflow">do</span> {
03666         lowerDevobj = deviceAttachedTo ;
03667         deviceExtension = lowerDevobj-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>;
03668         deviceAttachedTo = deviceExtension-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o7">AttachedTo</a> ;
03669 
03670     } <span class="keywordflow">while</span> ( deviceAttachedTo );
03671 
03672     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(lowerDevobj) ;
03673 
03674     ExReleaseFastLock( &amp;IopDatabaseLock, irql );
03675     <span class="keywordflow">return</span> lowerDevobj ;
03676 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="trackirp.c::IovpInitializeIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovpInitializeIrp           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PacketSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN CCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>StackSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>InitializeHandled</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03268">3268</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01680">_IRP::AllocationFlags</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00029">ASSERTFLAG_POLICEIRPS</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00204">_IOV_REQUEST_PACKET::AssertFlags</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a52">DCERROR_REINIT_OF_ALLOCATED_IRP_WITH_QUOTA</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00130">DCPARAM_IRP</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00197">_IOV_REQUEST_PACKET::Flags</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00276">IovpTrackingDataFindAndLock()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00454">IovpTrackingDataReleaseLock()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01574">IRP_QUOTA_CHARGED</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00081">TRACKFLAG_IO_ALLOCATED</a>, and <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00155">WDM_FAIL_CALLER2</a>.
<p>
<pre class="fragment"><div>03276              :
03277 
03278     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by <a class="code" href="../../d0/d5/io_8h.html#a514">IoInitializeIrp</a> and sets InitializeHandled to
03279     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entire initialization was handled internally.
03280 
03281     While here we verify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not Initializing an <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> allocated
03282     through <a class="code" href="../../d0/d5/io_8h.html#a449">IoAllocateIrp</a>, as doing so means we may leak quota/etc.
03283 
03284   Arguments:
03285 
03286     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>                    - <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to initialize
03287 
03288     PacketSize             - <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> in bytes.
03289 
03290     StackSize              - <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> of stack locations <span class="keywordflow">for</span> <span class="keyword">this</span> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>.
03291 
03292     InitializeHandled      - Pointer to a BOOLEAN that will be set to <span class="keyword">true</span> iff
03293                              <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initialization of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> was handled entirely
03294                              within <span class="keyword">this</span> routine. If <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d0/d5/io_8h.html#a514">IoInitializeIrp</a>
03295                              should initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> as normal.
03296 
03297   Return Value:
03298 
03299      None.
03300 
03301 --*/
03302 {
03303     <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> iovPacket ;
03304 
03305     iovPacket = <a class="code" href="../../d9/d8/hashirp_8h.html#a7">IovpTrackingDataFindAndLock</a>(Irp);
03306     <span class="keywordflow">if</span> (iovPacket == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03307 
03308         *InitializeHandled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
03309         <span class="keywordflow">return</span>;
03310     }
03311 
03312     <span class="keywordflow">if</span> ((iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o11">AssertFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a2">ASSERTFLAG_POLICEIRPS</a>) &amp;&amp;
03313        (iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a35">TRACKFLAG_IO_ALLOCATED</a>)) {
03314 
03315         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o17">AllocationFlags</a>&amp;<a class="code" href="../../d0/d5/io_8h.html#a190">IRP_QUOTA_CHARGED</a>) {
03316 
03317             <span class="comment">//</span>
03318             <span class="comment">// Don't let us leak quota now!</span>
03319             <span class="comment">//</span>
03320             <a class="code" href="../../d2/d5/ioassert_8h.html#a16">WDM_FAIL_CALLER2</a>(
03321                 (DCERROR_REINIT_OF_ALLOCATED_IRP_WITH_QUOTA, DCPARAM_IRP, Irp)
03322                 );
03323 
03324         } <span class="keywordflow">else</span> {
03325 
03326             <span class="comment">//</span>
03327             <span class="comment">// In this case we are draining our lookaside lists erroneously.</span>
03328             <span class="comment">//</span>
03329             <span class="comment">// WDM_CHASTISE_CALLER2(</span>
03330             <span class="comment">//    (DCERROR_REINIT_OF_ALLOCATED_IRP_WITHOUT_QUOTA, DCPARAM_IRP, Irp)</span>
03331             <span class="comment">//    );</span>
03332         }
03333     }
03334 
03335     *InitializeHandled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
03336     <a class="code" href="../../d9/d8/hashirp_8h.html#a12">IovpTrackingDataReleaseLock</a>(iovPacket) ;
03337 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="trackirp.c::IovpInitIrpTracking" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN FASTCALL IovpInitIrpTracking           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Level</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00257">257</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00035">ASSERTFLAG_COMPLETEATDPC</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00033">ASSERTFLAG_CONSUME_ALWAYS</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00037">ASSERTFLAG_DEFERCOMPLETION</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00034">ASSERTFLAG_FORCEPENDING</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00028">ASSERTFLAG_MONITOR_ALLOCS</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00030">ASSERTFLAG_MONITORMAJORS</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00029">ASSERTFLAG_POLICEIRPS</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00038">ASSERTFLAG_ROTATE_STATUS</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00041">ASSERTFLAG_SEEDSTACK</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00032">ASSERTFLAG_SMASH_SRBS</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00031">ASSERTFLAG_SURROGATE</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00027">ASSERTFLAG_TRACKIRPS</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00052">HACKFLAG_FOR_ACPI</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00053">HACKFLAG_FOR_BOGUSIRPS</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00050">HACKFLAG_FOR_MUP</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00051">HACKFLAG_FOR_SCSIPORT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04697">IOVERIFIERINIT_EVERYTHING_TRACKED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04699">IOVERIFIERINIT_NO_REINIT</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00122">IovpHackFlags</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00135">IovpInitFlags</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00130">IovpIrpTrackingEnabled</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00089">IovpTrackingDataInit()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00121">IovpTrackingFlags</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00091">IoVerifierInit()</a>.
<p>
<pre class="fragment"><div>00263              :
00264 
00265     Initialize that which needs to be initialized.
00266 
00267   Arguments:
00268 
00269     Level         - Level of testing to apply
00270                       0 - No checks
00271                       1 - Tracking with surrogate irp allocation
00272                       2 - Monitors basic <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> mistakes
00273                       3 - Monitors mistakes based on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> irp major
00274                           Surrogate IRPs used, status values rotated,
00275                           and various other checks.
00276                       4 - IRPs always completed at DPC.
00277                       5 - All IRPs pended with completion defered via timer.
00278                       6 - Any hacks turned off.
00279 
00280   Return Value:
00281 
00282     Returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> iff settings were successfully applied.
00283 
00284 --*/
00285 {
00286     PVOID sectionHeaderHandle;
00287     ULONG newTrackingFlags;
00288 
00289     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00290 
00291     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d4/trackirp_8c.html#a9">IovpIrpTrackingEnabled</a>) {
00292 
00293         <a class="code" href="../../d8/d4/trackirp_8c.html#a10">IovpInitFlags</a> = (Flags | (<a class="code" href="../../d8/d4/trackirp_8c.html#a10">IovpInitFlags</a>&amp;<a class="code" href="../../d0/d5/io_8h.html#a261">IOVERIFIERINIT_EVERYTHING_TRACKED</a>));
00294 
00295     } <span class="keywordflow">else</span> {
00296 
00297         <a class="code" href="../../d9/d8/hashirp_8h.html#a6">IovpTrackingDataInit</a>();
00298 
00299         <a class="code" href="../../d8/d4/trackirp_8c.html#a10">IovpInitFlags</a> = Flags;
00300         <a class="code" href="../../d8/d4/trackirp_8c.html#a9">IovpIrpTrackingEnabled</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00301     }
00302 
00303     newTrackingFlags = 0;
00304     <span class="keywordflow">switch</span>(Level) {
00305 
00306         <span class="keywordflow">default</span>:
00307         <span class="keywordflow">case</span> 7:
00308             <a class="code" href="../../d8/d4/trackirp_8c.html#a8">IovpHackFlags</a> = 0;
00309 
00310         <span class="keywordflow">case</span> 6:
00311             newTrackingFlags |= <a class="code" href="../../d9/d4/trackirp_8h.html#a7">ASSERTFLAG_FORCEPENDING</a> |
00312                                 <a class="code" href="../../d9/d4/trackirp_8h.html#a10">ASSERTFLAG_DEFERCOMPLETION</a>;
00313             <span class="comment">//</span>
00314             <span class="comment">// Fall through</span>
00315             <span class="comment">//</span>
00316 
00317         <span class="keywordflow">case</span> 5:
00318             newTrackingFlags |= <a class="code" href="../../d9/d4/trackirp_8h.html#a8">ASSERTFLAG_COMPLETEATDPC</a>;
00319             <span class="comment">//</span>
00320             <span class="comment">// Fall through</span>
00321             <span class="comment">//</span>
00322 
00323         <span class="keywordflow">case</span> 4:
00324             newTrackingFlags |= <a class="code" href="../../d9/d4/trackirp_8h.html#a4">ASSERTFLAG_SURROGATE</a> |
00325                                 <a class="code" href="../../d9/d4/trackirp_8h.html#a5">ASSERTFLAG_SMASH_SRBS</a> |
00326                                 <a class="code" href="../../d9/d4/trackirp_8h.html#a6">ASSERTFLAG_CONSUME_ALWAYS</a> |
00327                                 <a class="code" href="../../d9/d4/trackirp_8h.html#a11">ASSERTFLAG_ROTATE_STATUS</a> |
00328                                 <a class="code" href="../../d9/d4/trackirp_8h.html#a13">ASSERTFLAG_SEEDSTACK</a>;
00329             <span class="comment">//</span>
00330             <span class="comment">// Fall through</span>
00331             <span class="comment">//</span>
00332 
00333         <span class="keywordflow">case</span> 3:
00334             newTrackingFlags |= <a class="code" href="../../d9/d4/trackirp_8h.html#a3">ASSERTFLAG_MONITORMAJORS</a>;
00335             <span class="comment">//</span>
00336             <span class="comment">// Fall through</span>
00337             <span class="comment">//</span>
00338 
00339         <span class="keywordflow">case</span> 2:
00340             newTrackingFlags |= <a class="code" href="../../d9/d4/trackirp_8h.html#a2">ASSERTFLAG_POLICEIRPS</a>;
00341             <span class="comment">//</span>
00342             <span class="comment">// Fall through</span>
00343             <span class="comment">//</span>
00344 
00345         <span class="keywordflow">case</span> 1:
00346             newTrackingFlags |= <a class="code" href="../../d9/d4/trackirp_8h.html#a0">ASSERTFLAG_TRACKIRPS</a> |
00347                                 <a class="code" href="../../d9/d4/trackirp_8h.html#a1">ASSERTFLAG_MONITOR_ALLOCS</a>;
00348             <span class="comment">//</span>
00349             <span class="comment">// Fall through</span>
00350             <span class="comment">//</span>
00351 
00352         <span class="keywordflow">case</span> 0:
00353             <span class="keywordflow">break</span>;
00354     }
00355 
00356     <span class="keywordflow">if</span> ((Level == 0) &amp;&amp; (Flags&amp;<a class="code" href="../../d0/d5/io_8h.html#a263">IOVERIFIERINIT_NO_REINIT</a>)) {
00357 
00358         <span class="comment">//</span>
00359         <span class="comment">// Preinit flags</span>
00360         <span class="comment">//</span>
00361         newTrackingFlags = <a class="code" href="../../d8/d4/trackirp_8c.html#a7">IovpTrackingFlags</a>;
00362     }
00363 
00364     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d4/trackirp_8c.html#a8">IovpHackFlags</a> == (ULONG) -1) {
00365 
00366         <a class="code" href="../../d8/d4/trackirp_8c.html#a8">IovpHackFlags</a> =
00367 <span class="preprocessor">#ifdef HACKHACKS_ENABLED</span>
00368 <span class="preprocessor"></span><span class="preprocessor">#ifdef HACKHACK_FOR_MUP</span>
00369 <span class="preprocessor"></span>                         <a class="code" href="../../d9/d4/trackirp_8h.html#a15">HACKFLAG_FOR_MUP</a> |
00370 <span class="preprocessor">#endif</span>
00371 <span class="preprocessor"></span><span class="preprocessor">#ifdef HACKHACK_FOR_SCSIPORT</span>
00372 <span class="preprocessor"></span>                         <a class="code" href="../../d9/d4/trackirp_8h.html#a16">HACKFLAG_FOR_SCSIPORT</a> |
00373 <span class="preprocessor">#endif</span>
00374 <span class="preprocessor"></span><span class="preprocessor">#ifdef HACKHACK_FOR_ACPI</span>
00375 <span class="preprocessor"></span>                         <a class="code" href="../../d9/d4/trackirp_8h.html#a17">HACKFLAG_FOR_ACPI</a> |
00376 <span class="preprocessor">#endif</span>
00377 <span class="preprocessor"></span><span class="preprocessor">#ifdef HACKHACK_FOR_BOGUSIRPS</span>
00378 <span class="preprocessor"></span>                         <a class="code" href="../../d9/d4/trackirp_8h.html#a18">HACKFLAG_FOR_BOGUSIRPS</a> |
00379 <span class="preprocessor">#endif</span>
00380 <span class="preprocessor"></span><span class="preprocessor">#endif // HACKHACKS_ENABLED</span>
00381 <span class="preprocessor"></span>                         0;
00382     }
00383 
00384     <span class="keywordflow">if</span> (!(<a class="code" href="../../d8/d4/trackirp_8c.html#a10">IovpInitFlags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a261">IOVERIFIERINIT_EVERYTHING_TRACKED</a>)) {
00385 
00386         <span class="comment">//</span>
00387         <span class="comment">// These options aren't available unless we were marking IRPs since</span>
00388         <span class="comment">// boot.</span>
00389         <span class="comment">//</span>
00390         newTrackingFlags &amp;=~ (
00391                               <a class="code" href="../../d9/d4/trackirp_8h.html#a3">ASSERTFLAG_MONITORMAJORS</a> |
00392                               <a class="code" href="../../d9/d4/trackirp_8h.html#a4">ASSERTFLAG_SURROGATE</a> |
00393                               <a class="code" href="../../d9/d4/trackirp_8h.html#a5">ASSERTFLAG_SMASH_SRBS</a> |
00394                               <a class="code" href="../../d9/d4/trackirp_8h.html#a6">ASSERTFLAG_CONSUME_ALWAYS</a>
00395                              );
00396     }
00397 
00398     <a class="code" href="../../d8/d4/trackirp_8c.html#a7">IovpTrackingFlags</a> = newTrackingFlags;
00399     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00400 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="trackirp.c::IovpInternalCompleteAfterWait" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IovpInternalCompleteAfterWait           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Context</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02499">2499</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02501">_IO_STACK_LOCATION::CompletionRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02508">_IO_STACK_LOCATION::Context</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00237">_DEFERRAL_CONTEXT::DeferAction</a>, <a class="el" href="../../d9/d4/trackirp_8h.html#a146a104">DEFERACTION_QUEUE_PASSIVE_TIMER</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00236">_DEFERRAL_CONTEXT::DeferralTimer</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00232">_DEFERRAL_CONTEXT::DeviceObject</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00197">_IOV_REQUEST_PACKET::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02960">IoCompleteRequest</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00807">IovpProtectedIrpMakeTouchable()</a>, <a class="el" href="../../d9/d8/hashirp_8h.html#a11">IovpTrackingDataAcquireLock()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00612">IovpTrackingDataDereference()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00454">IovpTrackingDataReleaseLock()</a>, <a class="el" href="../../d9/d8/hashirp_8h.html#a21a5">IOVREFTYPE_POINTER</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00227">_DEFERRAL_CONTEXT::IovRequestPacket</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00233">_DEFERRAL_CONTEXT::IrpSpNext</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00228">_DEFERRAL_CONTEXT::OriginalCompletionRoutine</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00229">_DEFERRAL_CONTEXT::OriginalContext</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00230">_DEFERRAL_CONTEXT::OriginalIrp</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00231">_DEFERRAL_CONTEXT::OriginalPriorityBoost</a>, <a class="el" href="../../d2/d2/ppcdef_8h-source.html#l00079">PASSIVE_LEVEL</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00219">_IOV_REQUEST_PACKET::RestoreHandle</a>, and <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00075">TRACKFLAG_QUEUED_INTERNALLY</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02488">IovpInternalCompleteAtDPC()</a>, and <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02555">IovpInternalDeferredCompletion()</a>.
<p>
<pre class="fragment"><div>02502 {
02503     <a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html">PDEFERRAL_CONTEXT</a> deferralContext = (<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html">PDEFERRAL_CONTEXT</a>) Context ;
02504     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSpNext ;
02505     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status ;
02506 
02507     <span class="keywordflow">if</span> (deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o10">DeferAction</a> == <a class="code" href="../../d9/d4/trackirp_8h.html#a146a104">DEFERACTION_QUEUE_PASSIVE_TIMER</a>) {
02508 
02509         <span class="comment">//</span>
02510         <span class="comment">// Wait the appropriate amount of time if so ordered...</span>
02511         <span class="comment">//</span>
02512         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql()==PASSIVE_LEVEL) ;
02513         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(
02514             &amp;deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o9">DeferralTimer</a>,
02515             Executive,
02516             KernelMode,
02517             FALSE,
02518             NULL
02519             ) ;
02520     }
02521 
02522     <a class="code" href="../../d9/d8/hashirp_8h.html#a11">IovpTrackingDataAcquireLock</a>(deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o0">IovRequestPacket</a>) ;
02523 
02524     <a class="code" href="../../d9/d8/hashirp_8h.html#a18">IovpProtectedIrpMakeTouchable</a>(
02525         deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o3">OriginalIrp</a>,
02526         &amp;deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o0">IovRequestPacket</a>-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o20">RestoreHandle</a>
02527         );
02528 
02529     irpSpNext = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o3">OriginalIrp</a> ) ;
02530 
02531     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(irpSpNext == deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o6">IrpSpNext</a>) ;
02532     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(irpSpNext-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o116">CompletionRoutine</a> == deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o1">OriginalCompletionRoutine</a>) ;
02533     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(irpSpNext-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o117">Context</a> == deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o2">OriginalContext</a>) ;
02534 
02535     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o0">IovRequestPacket</a>-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a> &amp; TRACKFLAG_QUEUED_INTERNALLY) ;
02536     deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o0">IovRequestPacket</a>-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a> &amp;=~ TRACKFLAG_QUEUED_INTERNALLY ;
02537 
02538     <a class="code" href="../../d9/d8/hashirp_8h.html#a14">IovpTrackingDataDereference</a>(deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o0">IovRequestPacket</a>, IOVREFTYPE_POINTER) ;
02539     <a class="code" href="../../d9/d8/hashirp_8h.html#a12">IovpTrackingDataReleaseLock</a>(deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o0">IovRequestPacket</a>) ;
02540 
02541     status = irpSpNext-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o116">CompletionRoutine</a>(
02542         deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o5">DeviceObject</a>,
02543         deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o3">OriginalIrp</a>,
02544         irpSpNext-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o117">Context</a>
02545         ) ;
02546 
02547     <span class="keywordflow">if</span> (status!=STATUS_MORE_PROCESSING_REQUIRED) {
02548 
02549         <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>(deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o3">OriginalIrp</a>, deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o4">OriginalPriorityBoost</a>) ;
02550     }
02551     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deferralContext) ;
02552 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="trackirp.c::IovpInternalCompleteAtDPC" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IovpInternalCompleteAtDPC           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d6/struct__KDPC.html">PKDPC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Dpc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>DeferredContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02488">2488</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02499">IovpInternalCompleteAfterWait()</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02555">IovpInternalDeferredCompletion()</a>.
<p>
<pre class="fragment"><div>02494 {
02495     <a class="code" href="../../d9/d4/trackirp_8h.html#a136">IovpInternalCompleteAfterWait</a>(DeferredContext) ;
02496 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="trackirp.c::IovpInternalCompletionTrap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IovpInternalCompletionTrap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02446">2446</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03620">IoMarkIrpPending</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01648">_IRP::PendingReturned</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02239">IovpExamineIrpStackForwarding()</a>.
<p>
<pre class="fragment"><div>02453              :
02454 
02455     This routine does nothing but act as a trap <span class="keywordflow">for</span> people
02456     incorrectly copying stack locations...
02457 
02458   Arguments:
02459 
02460     DeviceObject           - Device object set at <span class="keyword">this</span> level of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> completion
02461                              routine - ignored.
02462 
02463     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>                    - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>.
02464 
02465     Context                - Context should equal <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>'s stack location -
02466                              <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> asserted.
02467 
02468   Return Value:
02469 
02470      STATUS_SUCCESS
02471 
02472 --*/
02473 {
02474     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp ;
02475 
02476     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o11">PendingReturned</a>) {
02477 
02478         <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( Irp ) ;
02479     }
02480     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp ) ;
02481 
02482     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((PVOID) irpSp == Context) ;
02483 
02484     <span class="keywordflow">return</span> STATUS_SUCCESS ;
02485 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="trackirp.c::IovpInternalDeferredCompletion" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IovpInternalDeferredCompletion           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02555">2555</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00035">ASSERTFLAG_COMPLETEATDPC</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00036">ASSERTFLAG_COMPLETEATPASSIVE</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00037">ASSERTFLAG_DEFERCOMPLETION</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00034">ASSERTFLAG_FORCEPENDING</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00029">ASSERTFLAG_POLICEIRPS</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00204">_IOV_REQUEST_PACKET::AssertFlags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02501">_IO_STACK_LOCATION::CompletionRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02508">_IO_STACK_LOCATION::Context</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a78">DCERROR_COMPLETION_ROUTINE_PAGABLE</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00130">DCPARAM_IRP</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00131">DCPARAM_ROUTINE</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00126">DEFER_ACTION</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00237">_DEFERRAL_CONTEXT::DeferAction</a>, <a class="el" href="../../d9/d4/trackirp_8h.html#a146a106">DEFERACTION_NORMAL</a>, <a class="el" href="../../d9/d4/trackirp_8h.html#a146a105">DEFERACTION_QUEUE_DISPATCH_TIMER</a>, <a class="el" href="../../d9/d4/trackirp_8h.html#a146a104">DEFERACTION_QUEUE_PASSIVE_TIMER</a>, <a class="el" href="../../d9/d4/trackirp_8h.html#a146a103">DEFERACTION_QUEUE_WORKITEM</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00236">_DEFERRAL_CONTEXT::DeferralTimer</a>, <a class="el" href="../../d5/d8/ex_8h.html#a332a206">DelayedWorkQueue</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00232">_DEFERRAL_CONTEXT::DeviceObject</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00235">_DEFERRAL_CONTEXT::DpcItem</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01961">ExInitializeWorkItem</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00375">ExQueueWorkItem()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00197">_IOV_REQUEST_PACKET::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02499">IovpInternalCompleteAfterWait()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02488">IovpInternalCompleteAtDPC()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02555">IovpInternalDeferredCompletion()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00147">IovpIrpDeferralTime</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00744">IovpProtectedIrpMakeUntouchable()</a>, <a class="el" href="../../d9/d8/hashirp_8h.html#a11">IovpTrackingDataAcquireLock()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00612">IovpTrackingDataDereference()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00454">IovpTrackingDataReleaseLock()</a>, <a class="el" href="../../d9/d8/hashirp_8h.html#a21a5">IOVREFTYPE_POINTER</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00227">_DEFERRAL_CONTEXT::IovRequestPacket</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00163">KDASSERT</a>, <a class="el" href="../../d5/d0/dpcobj_8c-source.html#l00039">KeInitializeDpc()</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00075">KeInitializeTimerEx()</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00285">KeSetTimerEx()</a>, <a class="el" href="../../d2/d1/mm_8h.html#a207">MmIsSystemAddressLocked()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00228">_DEFERRAL_CONTEXT::OriginalCompletionRoutine</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00229">_DEFERRAL_CONTEXT::OriginalContext</a>, <a class="el" href="../../d2/d2/ppcdef_8h-source.html#l00079">PASSIVE_LEVEL</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00219">_IOV_REQUEST_PACKET::RestoreHandle</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00075">TRACKFLAG_QUEUED_INTERNALLY</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00160">WDM_FAIL_ROUTINE</a>, and <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00234">_DEFERRAL_CONTEXT::WorkQueueItem</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01693">IovpCompleteRequest3()</a>, and <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02555">IovpInternalDeferredCompletion()</a>.
<p>
<pre class="fragment"><div>02562              :
02563 
02564     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> slipped in as a completion routine when we are
02565     <span class="stringliteral">"deferring"</span> completion via work item, etc.
02566 
02567   Arguments:
02568 
02569     DeviceObject           - Device object set at <span class="keyword">this</span> level of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> completion
02570                              routine - passed on.
02571 
02572     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>                    - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>.
02573 
02574     Context                - Context block that includes original completion
02575                              routine.
02576 
02577   Return Value:
02578 
02579      <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
02580 
02581 --*/
02582 {
02583     <a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html">PDEFERRAL_CONTEXT</a> deferralContext = (<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html">PDEFERRAL_CONTEXT</a>) Context;
02584     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSpNext;
02585     BOOLEAN passiveCompletionOK;
02586     <a class="code" href="../../d9/d4/trackirp_8h.html#a146">DEFER_ACTION</a> deferAction;
02587     ULONG refAction;
02588     ULONG trackingFlags;
02589     LARGE_INTEGER deltaTime;
02590 
02591     <span class="comment">//</span>
02592     <span class="comment">// Do delta time conversion.</span>
02593     <span class="comment">//</span>
02594     deltaTime.QuadPart = - <a class="code" href="../../d8/d4/trackirp_8c.html#a12">IovpIrpDeferralTime</a> ;
02595 
02596     <span class="comment">//</span>
02597     <span class="comment">// The *next* stack location holds our completion and context. The current</span>
02598     <span class="comment">// stack location has already been wiped.</span>
02599     <span class="comment">//</span>
02600     irpSpNext = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( Irp ) ;
02601 
02602     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((PVOID) irpSpNext-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o116">CompletionRoutine</a> == IovpInternalDeferredCompletion) ;
02603 
02604     <span class="comment">//</span>
02605     <span class="comment">// Put everything back in case someone is looking...</span>
02606     <span class="comment">//</span>
02607     irpSpNext-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o116">CompletionRoutine</a> = deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o1">OriginalCompletionRoutine</a> ;
02608     irpSpNext-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o117">Context</a> = deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o2">OriginalContext</a> ;
02609 
02610     <span class="comment">//</span>
02611     <span class="comment">// Some IRP dispatch routines cannot be called at passive. Two examples are</span>
02612     <span class="comment">// paging IRPs (cause we could switch) and Power IRPs. As we don't check yet,</span>
02613     <span class="comment">// if we "were" completed passive, continue to do so, but elsewhere...</span>
02614     <span class="comment">//</span>
02615     passiveCompletionOK = (KeGetCurrentIrql()==<a class="code" href="../../d1/d3/ppcdef_8h.html#a21">PASSIVE_LEVEL</a>) ;
02616 
02617     <a class="code" href="../../d9/d8/hashirp_8h.html#a11">IovpTrackingDataAcquireLock</a>(deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o0">IovRequestPacket</a>) ;
02618 
02619     <span class="comment">//</span>
02620     <span class="comment">// Verify all completion routines are in nonpaged code.</span>
02621     <span class="comment">//</span>
02622     <span class="keywordflow">if</span> (deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o0">IovRequestPacket</a>-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o11">AssertFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a2">ASSERTFLAG_POLICEIRPS</a>) {
02623 
02624         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a207">MmIsSystemAddressLocked</a>(irpSpNext-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o116">CompletionRoutine</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02625 
02626             <a class="code" href="../../d2/d5/ioassert_8h.html#a21">WDM_FAIL_ROUTINE</a>((
02627                 DCERROR_COMPLETION_ROUTINE_PAGABLE,
02628                 DCPARAM_IRP + DCPARAM_ROUTINE,
02629                 Irp,
02630                 irpSpNext-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o116">CompletionRoutine</a>
02631                 )) ;
02632         }
02633     }
02634 
02635     trackingFlags = deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o0">IovRequestPacket</a>-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o11">AssertFlags</a>;
02636 
02637     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(trackingFlags&amp;ASSERTFLAG_FORCEPENDING) ;
02638 
02639     <span class="keywordflow">switch</span>(trackingFlags&amp;(<a class="code" href="../../d9/d4/trackirp_8h.html#a10">ASSERTFLAG_DEFERCOMPLETION</a>|
02640                           <a class="code" href="../../d9/d4/trackirp_8h.html#a9">ASSERTFLAG_COMPLETEATPASSIVE</a>|
02641                           <a class="code" href="../../d9/d4/trackirp_8h.html#a8">ASSERTFLAG_COMPLETEATDPC</a>)) {
02642 
02643         <span class="keywordflow">case</span> <a class="code" href="../../d9/d4/trackirp_8h.html#a9">ASSERTFLAG_COMPLETEATPASSIVE</a>:
02644             deferAction = passiveCompletionOK ? <a class="code" href="../../d9/d4/trackirp_8h.html#a146a103">DEFERACTION_QUEUE_WORKITEM</a> :
02645                                                 <a class="code" href="../../d9/d4/trackirp_8h.html#a146a106">DEFERACTION_NORMAL</a> ;
02646             <span class="keywordflow">break</span>;
02647 
02648         <span class="keywordflow">case</span> <a class="code" href="../../d9/d4/trackirp_8h.html#a10">ASSERTFLAG_DEFERCOMPLETION</a> | <a class="code" href="../../d9/d4/trackirp_8h.html#a9">ASSERTFLAG_COMPLETEATPASSIVE</a>:
02649             deferAction = passiveCompletionOK ? <a class="code" href="../../d9/d4/trackirp_8h.html#a146a104">DEFERACTION_QUEUE_PASSIVE_TIMER</a> :
02650                                                 <a class="code" href="../../d9/d4/trackirp_8h.html#a146a106">DEFERACTION_NORMAL</a> ;
02651             <span class="keywordflow">break</span>;
02652 
02653         <span class="keywordflow">case</span> <a class="code" href="../../d9/d4/trackirp_8h.html#a10">ASSERTFLAG_DEFERCOMPLETION</a> | <a class="code" href="../../d9/d4/trackirp_8h.html#a8">ASSERTFLAG_COMPLETEATDPC</a>:
02654             deferAction = <a class="code" href="../../d9/d4/trackirp_8h.html#a146a105">DEFERACTION_QUEUE_DISPATCH_TIMER</a> ;
02655             <span class="keywordflow">break</span>;
02656 
02657         <span class="keywordflow">case</span> <a class="code" href="../../d9/d4/trackirp_8h.html#a10">ASSERTFLAG_DEFERCOMPLETION</a>:
02658             deferAction = (KeGetCurrentIrql()==<a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) ?
02659                 <a class="code" href="../../d9/d4/trackirp_8h.html#a146a105">DEFERACTION_QUEUE_DISPATCH_TIMER</a> :
02660                 <a class="code" href="../../d9/d4/trackirp_8h.html#a146a104">DEFERACTION_QUEUE_PASSIVE_TIMER</a> ;
02661             <span class="keywordflow">break</span>;
02662 
02663         <span class="keywordflow">default</span>:
02664             deferAction = <a class="code" href="../../d9/d4/trackirp_8h.html#a146a106">DEFERACTION_NORMAL</a> ;
02665             <a class="code" href="../../d2/d5/ioassert_8h.html#a23">KDASSERT</a>(0) ;
02666     }
02667 
02668     <span class="keywordflow">if</span> (deferAction != <a class="code" href="../../d9/d4/trackirp_8h.html#a146a106">DEFERACTION_NORMAL</a>) {
02669 
02670         <span class="comment">//</span>
02671         <span class="comment">// Set this flag. If anybody uses this IRP while this flag is on, complain</span>
02672         <span class="comment">// immediately!</span>
02673         <span class="comment">//</span>
02674         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(trackingFlags&amp;TRACKFLAG_QUEUED_INTERNALLY)) ;
02675         deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o0">IovRequestPacket</a>-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a29">TRACKFLAG_QUEUED_INTERNALLY</a> ;
02676         deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o5">DeviceObject</a> = DeviceObject ;
02677 
02678         deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o0">IovRequestPacket</a>-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o20">RestoreHandle</a> =
02679             <a class="code" href="../../d9/d8/hashirp_8h.html#a17">IovpProtectedIrpMakeUntouchable</a>(
02680                 Irp,
02681                 FALSE
02682                 ) ;
02683     } <span class="keywordflow">else</span> {
02684 
02685         <a class="code" href="../../d9/d8/hashirp_8h.html#a14">IovpTrackingDataDereference</a>(deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o0">IovRequestPacket</a>, IOVREFTYPE_POINTER);
02686     }
02687 
02688     <a class="code" href="../../d9/d8/hashirp_8h.html#a12">IovpTrackingDataReleaseLock</a>(deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o0">IovRequestPacket</a>) ;
02689 
02690     deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o10">DeferAction</a> = deferAction ;
02691 
02692     <span class="keywordflow">switch</span>(deferAction) {
02693 
02694         <span class="keywordflow">case</span> <a class="code" href="../../d9/d4/trackirp_8h.html#a146a104">DEFERACTION_QUEUE_PASSIVE_TIMER</a>:
02695             <a class="code" href="../../d3/d2/timerobj_8c.html#a2">KeInitializeTimerEx</a>(&amp;deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o9">DeferralTimer</a>, SynchronizationTimer) ;
02696             <a class="code" href="../../d3/d2/timerobj_8c.html#a7">KeSetTimerEx</a>(
02697                 &amp;deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o9">DeferralTimer</a>,
02698                 deltaTime,
02699                 0,
02700                 NULL
02701                 ) ;
02702 
02703             <span class="comment">//</span>
02704             <span class="comment">// Fall through...</span>
02705             <span class="comment">//</span>
02706 
02707         <span class="keywordflow">case</span> <a class="code" href="../../d9/d4/trackirp_8h.html#a146a103">DEFERACTION_QUEUE_WORKITEM</a>:
02708 
02709             <span class="comment">//</span>
02710             <span class="comment">// Queue this up so we can complete this passively.</span>
02711             <span class="comment">//</span>
02712             <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>(
02713                 (<a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">PWORK_QUEUE_ITEM</a>)&amp;deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o7">WorkQueueItem</a>,
02714                 IovpInternalCompleteAfterWait,
02715                 deferralContext
02716                 );
02717 
02718             <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>(
02719                 (<a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">PWORK_QUEUE_ITEM</a>)&amp;deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o7">WorkQueueItem</a>,
02720                 DelayedWorkQueue
02721                 );
02722 
02723             <span class="keywordflow">return</span> STATUS_MORE_PROCESSING_REQUIRED ;
02724 
02725         <span class="keywordflow">case</span> <a class="code" href="../../d9/d4/trackirp_8h.html#a146a105">DEFERACTION_QUEUE_DISPATCH_TIMER</a>:
02726 
02727             <a class="code" href="../../d4/d1/dpcobj_8c.html#a1">KeInitializeDpc</a>(
02728                 &amp;deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o8">DpcItem</a>,
02729                 IovpInternalCompleteAtDPC,
02730                 deferralContext
02731                 );
02732 
02733             <a class="code" href="../../d3/d2/timerobj_8c.html#a2">KeInitializeTimerEx</a>(&amp;deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o9">DeferralTimer</a>, SynchronizationTimer) ;
02734             <a class="code" href="../../d3/d2/timerobj_8c.html#a7">KeSetTimerEx</a>(
02735                 &amp;deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o9">DeferralTimer</a>,
02736                 deltaTime,
02737                 0,
02738                 &amp;deferralContext-&gt;<a class="code" href="../../d3/d2/struct__DEFERRAL__CONTEXT.html#o8">DpcItem</a>
02739                 ) ;
02740             <span class="keywordflow">return</span> STATUS_MORE_PROCESSING_REQUIRED ;
02741 
02742         <span class="keywordflow">case</span> <a class="code" href="../../d9/d4/trackirp_8h.html#a146a106">DEFERACTION_NORMAL</a>:
02743         <span class="keywordflow">default</span>:
02744 
02745             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deferralContext) ;
02746             <span class="keywordflow">return</span> irpSpNext-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o116">CompletionRoutine</a>(DeviceObject, Irp, irpSpNext-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o117">Context</a>) ;
02747     }
02748 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a46" doxytag="trackirp.c::IovpIsInFdoStack" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN FASTCALL IovpIsInFdoStack           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03717">3717</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01283">_DEVOBJ_EXTENSION::AttachedTo</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00089">DOE_BOTTOM_OF_FDO_STACK</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01268">_DEVOBJ_EXTENSION::ExtensionFlags</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00054">IopDatabaseLock</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00493">IovpCallDriver1()</a>.
<p>
<pre class="fragment"><div>03720 {
03721     <a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html">PDEVOBJ_EXTENSION</a> deviceExtension;
03722     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceAttachedTo, lowerDevobj ;
03723     KIRQL irql ;
03724 
03725     deviceAttachedTo = DeviceObject ;
03726 
03727     ExAcquireFastLock( &amp;IopDatabaseLock, &amp;irql );
03728 
03729     <span class="keywordflow">do</span> {
03730         <span class="keywordflow">if</span> (deviceAttachedTo-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a42">DOE_BOTTOM_OF_FDO_STACK</a>) {
03731             <span class="keywordflow">break</span>;
03732         }
03733         deviceAttachedTo = deviceAttachedTo-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o7">AttachedTo</a> ;
03734 
03735     } <span class="keywordflow">while</span> ( deviceAttachedTo );
03736 
03737     ExReleaseFastLock( &amp;IopDatabaseLock, irql );
03738     <span class="keywordflow">return</span> (deviceAttachedTo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ;
03739 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a41" doxytag="trackirp.c::IovpIsInterestingDriver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IovpIsInterestingDriver           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DriverObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03521">3521</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l04700">IOVERIFIERINIT_VERIFIER_DRIVER_LIST</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00135">IovpInitFlags</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l03802">MmIsDriverVerifying()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03436">IovpIsInterestingStack()</a>.
<p>
<pre class="fragment"><div>03524 {
03525     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d4/trackirp_8c.html#a10">IovpInitFlags</a>&amp;<a class="code" href="../../d0/d5/io_8h.html#a264">IOVERIFIERINIT_VERIFIER_DRIVER_LIST</a>) {
03526 
03527         <span class="keywordflow">return</span> (BOOLEAN) <a class="code" href="../../d9/d5/verifier_8c.html#a112">MmIsDriverVerifying</a>(DriverObject);
03528 
03529     } <span class="keywordflow">else</span> {
03530 
03531         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03532     }
03533 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="trackirp.c::IovpIsInterestingStack" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IovpIsInterestingStack           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03436">3436</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01181">_DEVICE_OBJECT::AttachedDevice</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01283">_DEVOBJ_EXTENSION::AttachedTo</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00091">DOE_EXAMINED</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00092">DOE_TRACKED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01179">_DEVICE_OBJECT::DriverObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01268">_DEVOBJ_EXTENSION::ExtensionFlags</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00054">IopDatabaseLock</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03521">IovpIsInterestingDriver()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00240">IovpSessionDataDeterminePolicy()</a>.
<p>
<pre class="fragment"><div>03439 {
03440     <a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html">PDEVOBJ_EXTENSION</a>   deviceExtension;
03441     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>      currentDevObj, deviceAttachedTo;
03442     BOOLEAN             stackIsInteresting;
03443     KIRQL               irql;
03444 
03445     <span class="comment">//</span>
03446     <span class="comment">// Walk downward until we find the PDO or an examined device object.</span>
03447     <span class="comment">//</span>
03448     ExAcquireFastLock( &amp;IopDatabaseLock, &amp;irql );
03449 
03450     <span class="comment">//</span>
03451     <span class="comment">// Quickly check the top of the stack...</span>
03452     <span class="comment">//</span>
03453     <span class="keywordflow">if</span> (DeviceObject-&gt;DeviceObjectExtension-&gt;ExtensionFlags &amp; <a class="code" href="../../d9/d4/trackirp_8h.html#a44">DOE_EXAMINED</a>) {
03454 
03455         stackIsInteresting =
03456            ((DeviceObject-&gt;DeviceObjectExtension-&gt;ExtensionFlags &amp; <a class="code" href="../../d9/d4/trackirp_8h.html#a45">DOE_TRACKED</a>) != 0);
03457 
03458         ExReleaseFastLock( &amp;IopDatabaseLock, irql );
03459         <span class="keywordflow">return</span> stackIsInteresting;
03460     }
03461 
03462     <span class="comment">//</span>
03463     <span class="comment">// OK, if the top hasn't been examined, odds are devices below it haven't</span>
03464     <span class="comment">// either. Walk downwards until we can determine whether the stack as a</span>
03465     <span class="comment">// whole should be tracked.</span>
03466     <span class="comment">//</span>
03467     stackIsInteresting = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03468     deviceAttachedTo = DeviceObject;
03469     <span class="keywordflow">do</span> {
03470         currentDevObj = deviceAttachedTo;
03471         deviceExtension = currentDevObj-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>;
03472         deviceAttachedTo = deviceExtension-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o7">AttachedTo</a>;
03473 
03474         <span class="comment">//</span>
03475         <span class="comment">// Remember this...</span>
03476         <span class="comment">//</span>
03477         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d4/trackirp_8h.html#a142">IovpIsInterestingDriver</a>(currentDevObj-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>)) {
03478 
03479             stackIsInteresting = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03480         }
03481 
03482     } <span class="keywordflow">while</span> (deviceAttachedTo &amp;&amp;
03483              (deviceAttachedTo-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> &amp; <a class="code" href="../../d9/d4/trackirp_8h.html#a44">DOE_EXAMINED</a>)
03484             );
03485 
03486     <span class="keywordflow">if</span> (deviceAttachedTo &amp;&amp;
03487         (deviceAttachedTo-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> &amp; <a class="code" href="../../d9/d4/trackirp_8h.html#a45">DOE_TRACKED</a>)) {
03488 
03489         <span class="comment">//</span>
03490         <span class="comment">// Propogate upwards the "interesting-ness" of the last examined device</span>
03491         <span class="comment">// in the stack...</span>
03492         <span class="comment">//</span>
03493         stackIsInteresting = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03494     }
03495 
03496     <span class="comment">//</span>
03497     <span class="comment">// Walk upwards, marking everything examined and appropriately tracked.</span>
03498     <span class="comment">//</span>
03499     <span class="keywordflow">do</span> {
03500         deviceExtension = currentDevObj-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>;
03501 
03502         <span class="keywordflow">if</span> (stackIsInteresting) {
03503 
03504             deviceExtension-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a45">DOE_TRACKED</a>;
03505         } <span class="keywordflow">else</span> {
03506 
03507             deviceExtension-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> &amp;=~ DOE_TRACKED;
03508         }
03509 
03510         deviceExtension-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a44">DOE_EXAMINED</a>;
03511 
03512         currentDevObj = currentDevObj-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>;
03513 
03514     } <span class="keywordflow">while</span> (currentDevObj);
03515 
03516     ExReleaseFastLock( &amp;IopDatabaseLock, irql );
03517     <span class="keywordflow">return</span> stackIsInteresting;
03518 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="trackirp.c::IovpReexamineAllStacks" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IovpReexamineAllStacks           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03399">3399</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d4/d4/iodata_8c-source.html#l00235">IoDeviceObjectType</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03413">IovpEnumDevObjCallback()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d1/obtype_8c-source.html#l00478">ObEnumerateObjectsByType()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
<pre class="fragment"><div>03402 {
03403     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03404 
03405     <a class="code" href="../../d0/d2/obtype_8c.html#a3">ObEnumerateObjectsByType</a>(
03406         IoDeviceObjectType,
03407         IovpEnumDevObjCallback,
03408         NULL
03409         );
03410 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a47" doxytag="trackirp.c::IovpSeedOnePage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovpSeedOnePage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03743">3743</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03784">IovpSeedStack()</a>.
<p>
<pre class="fragment"><div>03746 {
03747     ULONG StackSeed[(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>/<span class="keyword">sizeof</span>(ULONG))] ;
03748     ULONG <span class="keyword">register</span> i ;
03749 
03750     <span class="comment">//</span>
03751     <span class="comment">// We use the return value 0xFFFFFFFF, as it is an illegal return value. We</span>
03752     <span class="comment">// are trying to catch people who don't initialize NTSTATUS, and it's also</span>
03753     <span class="comment">// a good pointer trap too.</span>
03754     <span class="comment">//</span>
03755     <span class="keywordflow">for</span>(i=0; i&lt;(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>/<span class="keyword">sizeof</span>(ULONG)); i++) StackSeed[i]=0xFFFFFFFF ;
03756 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a50" doxytag="trackirp.c::IovpSeedStack" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovpSeedStack           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03784">3784</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00041">ASSERTFLAG_SEEDSTACK</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03743">IovpSeedOnePage()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03772">IovpSeedThreePages()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03760">IovpSeedTwoPages()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00121">IovpTrackingFlags</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>.
<p>
<pre class="fragment"><div>03789              :
03790 
03791     This routine <span class="stringliteral">"seeds"</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack so that uninitialized variables are
03792     more easily ferreted <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>.
03793 
03794     ADRIAO BUGBUG 08/17/98 - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a really neat idea that runs into a
03795                              memory manager optimization. While I <span class="keywordflow">do</span> find
03796                              <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate guard page, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory manager
03797                              <span class="keywordflow">throws</span> <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> above touched pages on a thread
03798                              <span class="keywordflow">switch</span> and bring in <span class="keyword">new</span> (and probably zero'd)
03799                              ones.
03800 
03801   Arguments: None
03802 
03803   Return Value: None
03804 
03805 --*/
03806 {
03807     <span class="keywordtype">int</span> i, interruptReservedOverhead ;
03808 
03809     <span class="keywordflow">if</span> (!(<a class="code" href="../../d8/d4/trackirp_8c.html#a7">IovpTrackingFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a13">ASSERTFLAG_SEEDSTACK</a>)) {
03810         <span class="keywordflow">return</span> ;
03811     }
03812 
03813     <span class="comment">//</span>
03814     <span class="comment">// Is there room to try this before we run out of stack? We will reserve</span>
03815     <span class="comment">// half a page for interrupt overhead...</span>
03816     <span class="comment">//</span>
03817     interruptReservedOverhead = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>/2 ;
03818 
03819     <span class="comment">//</span>
03820     <span class="comment">// There must be a guard page somewhere. Find it...</span>
03821     <span class="comment">//</span>
03822     <span class="keywordflow">for</span>(i=0; i&lt;4; i++) {
03823         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(((PUCHAR)&amp;i)-i*PAGE_SIZE-interruptReservedOverhead)) {
03824             <span class="keywordflow">break</span>;
03825         }
03826     }
03827 
03828     <span class="keywordflow">switch</span>(i) {
03829         <span class="keywordflow">case</span> 4: <a class="code" href="../../d9/d4/trackirp_8h.html#a135">IovpSeedThreePages</a>() ; <span class="keywordflow">break</span> ;
03830         <span class="keywordflow">case</span> 3: <a class="code" href="../../d9/d4/trackirp_8h.html#a134">IovpSeedTwoPages</a>() ; <span class="keywordflow">break</span> ;
03831         <span class="keywordflow">case</span> 2: <a class="code" href="../../d9/d4/trackirp_8h.html#a133">IovpSeedOnePage</a>() ; <span class="keywordflow">break</span> ;
03832         <span class="keywordflow">case</span> 1: <span class="keywordflow">break</span> ; <span class="comment">// Minimum is overhead</span>
03833         <span class="keywordflow">case</span> 0: <span class="keywordflow">break</span> ; <span class="comment">// Umm, we don't even have overhead!</span>
03834         <span class="keywordflow">default</span>: <span class="keywordflow">break</span> ;
03835     }
03836 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a49" doxytag="trackirp.c::IovpSeedThreePages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovpSeedThreePages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03772">3772</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03784">IovpSeedStack()</a>.
<p>
<pre class="fragment"><div>03775 {
03776     ULONG <span class="keyword">register</span> i ;
03777     ULONG StackSeed[(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>*3/<span class="keyword">sizeof</span>(ULONG))] ;
03778 
03779     <span class="keywordflow">for</span>(i=0; i&lt;(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>*3/<span class="keyword">sizeof</span>(ULONG)); i++) StackSeed[i]=0xFFFFFFFF ;
03780 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a48" doxytag="trackirp.c::IovpSeedTwoPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovpSeedTwoPages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03760">3760</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03784">IovpSeedStack()</a>.
<p>
<pre class="fragment"><div>03763 {
03764     ULONG StackSeed[(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>*2/<span class="keyword">sizeof</span>(ULONG))] ;
03765     ULONG <span class="keyword">register</span> i ;
03766 
03767     <span class="keywordflow">for</span>(i=0; i&lt;(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>*2/<span class="keyword">sizeof</span>(ULONG)); i++) StackSeed[i]=0xFFFFFFFF ;
03768 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="trackirp.c::IovpSwapSurrogateIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IovpSwapSurrogateIrp           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02751">2751</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00029">ASSERTFLAG_POLICEIRPS</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00204">_IOV_REQUEST_PACKET::AssertFlags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02501">_IO_STACK_LOCATION::CompletionRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02508">_IO_STACK_LOCATION::Context</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02031">_IO_STACK_LOCATION::Control</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01655">_IRP::CurrentLocation</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00197">_IOV_REQUEST_PACKET::Flags</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00201">_IOV_REQUEST_PACKET::HeadPacket</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02960">IoCompleteRequest</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03977">IoSetNextIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04269">IoSizeOfIrp</a>, <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l00182">IovpAssertFinalIrpStack()</a>, <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00220">IovpSessionDataClose()</a>, <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00152">IovpSessionDataDereference()</a>, <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00523">IovpSessionDataFinalizeSurrogate()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00612">IovpTrackingDataDereference()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00276">IovpTrackingDataFindAndLock()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00657">IovpTrackingDataGetCurrentSessionData()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00454">IovpTrackingDataReleaseLock()</a>, <a class="el" href="../../d9/d8/hashirp_8h.html#a21a5">IOVREFTYPE_POINTER</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00216">_IOV_REQUEST_PACKET::PriorityBoost</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00206">_IOV_REQUEST_PACKET::RealIrpCompletionRoutine</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00208">_IOV_REQUEST_PACKET::RealIrpContext</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00207">_IOV_REQUEST_PACKET::RealIrpControl</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01654">_IRP::StackCount</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00199">_IOV_REQUEST_PACKET::SurrogateLink</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00214">_IOV_REQUEST_PACKET::TopStackLocation</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00192">_IOV_REQUEST_PACKET::TrackedIrp</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00079">TRACKFLAG_SWAPPED_BACK</a>, and <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00712">TRACKIRP_DBGPRINT</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01416">IovpCompleteRequest2()</a>, and <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02239">IovpExamineIrpStackForwarding()</a>.
<p>
<pre class="fragment"><div>02758              :
02759 
02760     This completion routine will copy back <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> surrogate <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>
02761     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original and complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>.
02762 
02763   Arguments:
02764 
02765     DeviceObject           - Device object set at <span class="keyword">this</span> level
02766                              of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> completion routine - ignored.
02767 
02768     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>                    - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>.
02769 
02770     Context                - Context should equal <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> - <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02771                              asserted.
02772 
02773   Return Value:
02774 
02775      STATUS_MORE_PROCESSING_REQUIRED...
02776 
02777 --*/
02778 {
02779     <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> iovPacket, iovPrevPacket;
02780     <a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html">PIOV_SESSION_DATA</a> iovSessionData;
02781     ULONG irpSize ;
02782     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> realIrp ;
02783     BOOLEAN freeTrackingData ;
02784     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status, lockedStatus ;
02785     CCHAR priorityBoost ;
02786     PVOID completionRoutine ;
02787     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp ;
02788     BOOLEAN locked ;
02789 
02790     <span class="comment">//</span>
02791     <span class="comment">// If this one fails, somebody has probably copied the stack</span>
02792     <span class="comment">// inclusive with our completion routine. We should already</span>
02793     <span class="comment">// have caught this...</span>
02794     <span class="comment">//</span>
02795     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Irp == Context) ;
02796 
02797     iovPacket = <a class="code" href="../../d9/d8/hashirp_8h.html#a7">IovpTrackingDataFindAndLock</a>(Irp) ;
02798     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovPacket) ;
02799 
02800     <span class="keywordflow">if</span> (iovPacket == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02801 
02802         <span class="keywordflow">return</span> STATUS_SUCCESS ;
02803     }
02804 
02805     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o16">TopStackLocation</a> == <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a>) ;
02806 
02807     iovSessionData = <a class="code" href="../../d9/d8/hashirp_8h.html#a16">IovpTrackingDataGetCurrentSessionData</a>(iovPacket);
02808     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovSessionData);
02809 
02810     <span class="comment">//</span>
02811     <span class="comment">// Put everything back</span>
02812     <span class="comment">//</span>
02813     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o9">HeadPacket</a> != iovPacket);
02814 
02815     iovPrevPacket = CONTAINING_RECORD(
02816         iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o7">SurrogateLink</a>.Blink,
02817         <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">IOV_REQUEST_PACKET</a>,
02818         SurrogateLink
02819         );
02820 
02821     realIrp = iovPrevPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o0">TrackedIrp</a> ;
02822     irpSize = <a class="code" href="../../d0/d5/io_8h.html#a245">IoSizeOfIrp</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o12">StackCount</a> ) ;
02823 
02824     <span class="comment">//</span>
02825     <span class="comment">// Back the IRP stack up so that the original completion routine</span>
02826     <span class="comment">// is called if appropriate</span>
02827     <span class="comment">//</span>
02828     <a class="code" href="../../d0/d5/io_8h.html#a238">IoSetNextIrpStackLocation</a>(Irp);
02829     <a class="code" href="../../d0/d5/io_8h.html#a238">IoSetNextIrpStackLocation</a>(realIrp);
02830 
02831     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>(Irp) ;
02832     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o116">CompletionRoutine</a> = iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o12">RealIrpCompletionRoutine</a> ;
02833     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o3">Control</a>           = iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o13">RealIrpControl</a> ;
02834     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o117">Context</a>           = iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o14">RealIrpContext</a> ;
02835 
02836     <span class="comment">//</span>
02837     <span class="comment">// Record final data and make any accesses to the surrogate IRP</span>
02838     <span class="comment">// crash.</span>
02839     <span class="comment">//</span>
02840     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>(Irp) ;
02841     <span class="keywordflow">if</span> (iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o11">AssertFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a2">ASSERTFLAG_POLICEIRPS</a>) {
02842 
02843         <a class="code" href="../../d8/d4/flunkirp_8h.html#a6">IovpAssertFinalIrpStack</a>(iovPacket, irpSp) ;
02844     }
02845 
02846     priorityBoost = iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o17">PriorityBoost</a> ;
02847     <a class="code" href="../../d9/d8/hashirp_8h.html#a14">IovpTrackingDataDereference</a>(iovPacket, IOVREFTYPE_POINTER);
02848     <a class="code" href="../../d6/d7/sessnirp_8h.html#a7">IovpSessionDataFinalizeSurrogate</a>(iovSessionData, iovPacket, Irp);
02849     <a class="code" href="../../d6/d7/sessnirp_8h.html#a4">IovpSessionDataClose</a>(iovSessionData);
02850     <a class="code" href="../../d6/d7/sessnirp_8h.html#a3">IovpSessionDataDereference</a>(iovSessionData);
02851 
02852     <a class="code" href="../../d9/d4/trackirp_8h.html#a88">TRACKIRP_DBGPRINT</a>((
02853         <span class="stringliteral">"  Swapping surrogate IRP %lx back to %lx (Tracking data %lx)\n"</span>,
02854         Irp,
02855         realIrp,
02856         iovPacket
02857         ), 1) ;
02858 
02859     iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a33">TRACKFLAG_SWAPPED_BACK</a> ;
02860     <a class="code" href="../../d9/d8/hashirp_8h.html#a12">IovpTrackingDataReleaseLock</a>(iovPacket) ;
02861 
02862     <span class="comment">//</span>
02863     <span class="comment">// Send the IRP onwards and upwards.</span>
02864     <span class="comment">//</span>
02865     <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>(realIrp, priorityBoost) ;
02866 
02867     <span class="keywordflow">return</span> STATUS_MORE_PROCESSING_REQUIRED ;
02868 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a11" doxytag="trackirp.c::IovpCancelCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d8/d4/trackirp_8c.html#a11">IovpCancelCount</a> = 0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00140">140</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00493">IovpCallDriver1()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="trackirp.c::IovpHackFlags" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d9/d4/trackirp_8h.html#a89">IovpHackFlags</a> = (ULONG) -1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00122">122</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02239">IovpExamineIrpStackForwarding()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00257">IovpInitIrpTracking()</a>, <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00240">IovpSessionDataDeterminePolicy()</a>, and <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l01392">IovpThrowChaffAtStartedPdoStack()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="trackirp.c::IovpInitFlags" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d8/d4/trackirp_8c.html#a10">IovpInitFlags</a> = 0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00135">135</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00493">IovpCallDriver1()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00257">IovpInitIrpTracking()</a>, and <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03521">IovpIsInterestingDriver()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="trackirp.c::IovpIrpDeferralTime" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LONG <a class="el" href="../../d8/d4/trackirp_8c.html#a12">IovpIrpDeferralTime</a> = 10 * 300          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00147">147</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02555">IovpInternalDeferredCompletion()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="trackirp.c::IovpIrpTrackingEnabled" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d8/d4/trackirp_8c.html#a9">IovpIrpTrackingEnabled</a> = FALSE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00130">130</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00404">IovpDoAssertIrps()</a>, and <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00257">IovpInitIrpTracking()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="trackirp.c::IovpTrackingFlags" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d9/d4/trackirp_8h.html#a90">IovpTrackingFlags</a> = 0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00121">121</a> of file <a class="el" href="../../d9/d3/trackirp_8c-source.html">trackirp.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03132">IovpAllocateIrp1()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03216">IovpAllocateIrp2()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00493">IovpCallDriver1()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00404">IovpDoAssertIrps()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00257">IovpInitIrpTracking()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03784">IovpSeedStack()</a>, <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00027">IovpSessionDataCreate()</a>, <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00240">IovpSessionDataDeterminePolicy()</a>, and <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00122">IovpTrackingDataCreateAndLock()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:48 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
