<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: security.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>security.c</h1><a href="../../d7/d5/w32_2ntuser_2kernel_2security_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/**************************** Module Header ********************************\</span>
00002 <span class="comment">* Module Name: security.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Securable Object Routines</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 12-31-90 JimA       Created.</span>
00010 <span class="comment">* 04-14-92 RichardW   Changed ACE_HEADER</span>
00011 <span class="comment">\***************************************************************************/</span>
00012 
<a name="l00013"></a><a class="code" href="../../d7/d5/w32_2ntuser_2kernel_2security_8c.html#a0">00013</a> <span class="preprocessor">#define _SECURITY 1</span>
00014 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00015 <span class="preprocessor">#pragma hdrstop</span>
00016 <span class="preprocessor"></span>
00017 <span class="preprocessor">#pragma alloc_text(INIT, InitSecurity)</span>
00018 <span class="preprocessor"></span>
00019 <span class="comment">/*</span>
00020 <span class="comment"> * General security stuff</span>
00021 <span class="comment"> */</span>
<a name="l00022"></a><a class="code" href="../../d7/d5/w32_2ntuser_2kernel_2security_8c.html#a1">00022</a> PSECURITY_DESCRIPTOR <a class="code" href="../../d1/d0/kernel_2exitwin_8c.html#a5">gpsdInitWinSta</a>;
00023 
<a name="l00024"></a><a class="code" href="../../d7/d5/w32_2ntuser_2kernel_2security_8c.html#a2">00024</a> PRIVILEGE_SET <a class="code" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a248">psTcb</a> = { 1, PRIVILEGE_SET_ALL_NECESSARY,
00025     { SE_TCB_PRIVILEGE, 0 }
00026 };
00027 
00028 <span class="comment">/***************************************************************************\</span>
00029 <span class="comment">* AllocAce</span>
00030 <span class="comment">*</span>
00031 <span class="comment">* Allocates and initializes an ACE list.</span>
00032 <span class="comment">*</span>
00033 <span class="comment">* History:</span>
00034 <span class="comment">* 04-25-91 JimA         Created.</span>
00035 <span class="comment">\***************************************************************************/</span>
00036 
<a name="l00037"></a><a class="code" href="../../d4/d1/userk_8h.html#a1269">00037</a> PACCESS_ALLOWED_ACE <a class="code" href="../../d4/d1/userk_8h.html#a1269">AllocAce</a>(
00038     PACCESS_ALLOWED_ACE pace,
00039     BYTE bType,
00040     BYTE bFlags,
00041     ACCESS_MASK am,
00042     PSID psid,
00043     LPDWORD lpdwLength)
00044 {
00045     PACCESS_ALLOWED_ACE paceNew;
00046     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> iEnd;
00047     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwLength, dwLengthSid;
00048 
00049     <span class="comment">/*</span>
00050 <span class="comment">     * Allocate space for the ACE.</span>
00051 <span class="comment">     */</span>
00052     dwLengthSid = <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>(psid);
00053     dwLength = dwLengthSid + <span class="keyword">sizeof</span>(ACE_HEADER) + <span class="keyword">sizeof</span>(ACCESS_MASK);
00054     <span class="keywordflow">if</span> (pace == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00055         iEnd = 0;
00056         pace = UserAllocPoolWithQuota(dwLength, TAG_SECURITY);
00057         <span class="keywordflow">if</span> (pace == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00058             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00059     } <span class="keywordflow">else</span> {
00060         iEnd = *lpdwLength;
00061         paceNew = UserAllocPoolWithQuota(iEnd + dwLength, TAG_SECURITY);
00062         <span class="keywordflow">if</span> (paceNew == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00063             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00064         RtlCopyMemory(paceNew, pace, iEnd);
00065         UserFreePool(pace);
00066         pace = paceNew;
00067     }
00068     *lpdwLength = dwLength + iEnd;
00069 
00070     <span class="comment">/*</span>
00071 <span class="comment">     * Insert the new ACE.</span>
00072 <span class="comment">     */</span>
00073     paceNew = (PACCESS_ALLOWED_ACE)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pace + iEnd);
00074     paceNew-&gt;Header.AceType = bType;
00075     paceNew-&gt;Header.AceSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)dwLength;
00076     paceNew-&gt;Header.AceFlags = bFlags;
00077     paceNew-&gt;Mask = am;
00078     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>(dwLengthSid, &amp;paceNew-&gt;SidStart, psid);
00079     <span class="keywordflow">return</span> pace;
00080 }
00081 
00082 <span class="comment">/***************************************************************************\</span>
00083 <span class="comment">* CreateSecurityDescriptor</span>
00084 <span class="comment">*</span>
00085 <span class="comment">* Allocates and initializes a security descriptor.</span>
00086 <span class="comment">*</span>
00087 <span class="comment">* History:</span>
00088 <span class="comment">* 04-25-91 JimA         Created.</span>
00089 <span class="comment">\***************************************************************************/</span>
00090 
<a name="l00091"></a><a class="code" href="../../d4/d1/userk_8h.html#a1268">00091</a> PSECURITY_DESCRIPTOR <a class="code" href="../../d4/d1/userk_8h.html#a1268">CreateSecurityDescriptor</a>(
00092     PACCESS_ALLOWED_ACE paceList,
00093     DWORD cbAce,
00094     BOOLEAN fDaclDefaulted)
00095 {
00096     PSECURITY_DESCRIPTOR psd;
00097     PACL pacl;
00098     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00099 
00100     <span class="comment">/*</span>
00101 <span class="comment">     * Allocate the security descriptor</span>
00102 <span class="comment">     */</span>
00103     psd = (PSECURITY_DESCRIPTOR)UserAllocPoolWithQuota(
00104             cbAce + <span class="keyword">sizeof</span>(ACL) + SECURITY_DESCRIPTOR_MIN_LENGTH,
00105             TAG_SECURITY);
00106     <span class="keywordflow">if</span> (psd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00107         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00108     <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>(psd, SECURITY_DESCRIPTOR_REVISION);
00109 
00110     <span class="comment">/*</span>
00111 <span class="comment">     * Initialize the ACL</span>
00112 <span class="comment">     */</span>
00113     pacl = (PACL)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)psd + SECURITY_DESCRIPTOR_MIN_LENGTH);
00114     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>(pacl, <span class="keyword">sizeof</span>(ACL) + cbAce, ACL_REVISION);
00115     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00116 
00117         <span class="comment">/*</span>
00118 <span class="comment">         * Add the ACEs to the ACL.</span>
00119 <span class="comment">         */</span>
00120         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a10">RtlAddAce</a>(pacl, ACL_REVISION, MAXULONG, paceList, cbAce);
00121         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00122 
00123             <span class="comment">/*</span>
00124 <span class="comment">             * Initialize the SD</span>
00125 <span class="comment">             */</span>
00126             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a>(psd, (BOOLEAN)<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00127                     pacl, fDaclDefaulted);
00128             <a class="code" href="../../d8/d6/sertl_8c.html#a62">RtlSetSaclSecurityDescriptor</a>(psd, (BOOLEAN)<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00129                     (BOOLEAN)<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00130             <a class="code" href="../../d8/d6/sertl_8c.html#a64">RtlSetOwnerSecurityDescriptor</a>(psd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, (BOOLEAN)<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00131             <a class="code" href="../../d8/d6/sertl_8c.html#a66">RtlSetGroupSecurityDescriptor</a>(psd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, (BOOLEAN)<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00132         }
00133     }
00134 
00135     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00136         UserFreePool(psd);
00137         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00138     }
00139 
00140     <span class="keywordflow">return</span> psd;
00141 }
00142 
00143 <span class="comment">/***************************************************************************\</span>
00144 <span class="comment">* InitSecurity</span>
00145 <span class="comment">*</span>
00146 <span class="comment">* Initialize global security information.</span>
00147 <span class="comment">*</span>
00148 <span class="comment">* History:</span>
00149 <span class="comment">* 01-29-91 JimA         Created.</span>
00150 <span class="comment">\***************************************************************************/</span>
00151 
<a name="l00152"></a><a class="code" href="../../d4/d1/userk_8h.html#a1272">00152</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1272">InitSecurity</a>(
00153     VOID)
00154 {
00155     PACCESS_ALLOWED_ACE paceList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pace;
00156     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwLength;
00157 
00158     <span class="comment">/*</span>
00159 <span class="comment">     * Get access to exported constants</span>
00160 <span class="comment">     */</span>
00161     <a class="code" href="../../d0/d5/se_8h.html#a18">SeEnableAccessToExports</a>();
00162 
00163     <span class="comment">/*</span>
00164 <span class="comment">     * Create ACE list.</span>
00165 <span class="comment">     */</span>
00166     paceList = <a class="code" href="../../d4/d1/userk_8h.html#a1269">AllocAce</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00167             ACCESS_ALLOWED_ACE_TYPE,
00168             CONTAINER_INHERIT_ACE | INHERIT_ONLY_ACE | NO_PROPAGATE_INHERIT_ACE,
00169             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a304">WinStaMapping</a>.GenericAll,
00170             <a class="code" href="../../d0/d5/se_8h.html#a37">SeExports</a>-&gt;<a class="code" href="../../d2/d0/struct__SE__EXPORTS.html#o24">SeWorldSid</a>,
00171             &amp;dwLength);
00172     <span class="keywordflow">if</span> (paceList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00173         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00174 
00175     pace = <a class="code" href="../../d4/d1/userk_8h.html#a1269">AllocAce</a>(paceList,
00176             ACCESS_ALLOWED_ACE_TYPE,
00177             CONTAINER_INHERIT_ACE | INHERIT_ONLY_ACE | NO_PROPAGATE_INHERIT_ACE,
00178             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a304">WinStaMapping</a>.GenericAll,
00179             <a class="code" href="../../d0/d5/se_8h.html#a37">SeExports</a>-&gt;<a class="code" href="../../d2/d0/struct__SE__EXPORTS.html#o43">SeRestrictedSid</a>,
00180             &amp;dwLength);
00181     <span class="keywordflow">if</span> (pace == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00182         UserFreePool(paceList);
00183         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00184     }
00185     paceList = pace;
00186 
00187     pace = <a class="code" href="../../d4/d1/userk_8h.html#a1269">AllocAce</a>(paceList, ACCESS_ALLOWED_ACE_TYPE,
00188             OBJECT_INHERIT_ACE | INHERIT_ONLY_ACE,
00189             GENERIC_ALL, <a class="code" href="../../d0/d5/se_8h.html#a37">SeExports</a>-&gt;<a class="code" href="../../d2/d0/struct__SE__EXPORTS.html#o24">SeWorldSid</a>, &amp;dwLength);
00190     <span class="keywordflow">if</span> (pace == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00191         UserFreePool(paceList);
00192         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00193     }
00194     paceList = pace;
00195 
00196     pace = <a class="code" href="../../d4/d1/userk_8h.html#a1269">AllocAce</a>(paceList, ACCESS_ALLOWED_ACE_TYPE,
00197             OBJECT_INHERIT_ACE | INHERIT_ONLY_ACE,
00198             GENERIC_ALL, <a class="code" href="../../d0/d5/se_8h.html#a37">SeExports</a>-&gt;<a class="code" href="../../d2/d0/struct__SE__EXPORTS.html#o43">SeRestrictedSid</a>, &amp;dwLength);
00199     <span class="keywordflow">if</span> (pace == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00200         UserFreePool(paceList);
00201         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00202     }
00203     paceList = pace;
00204 
00205     pace = <a class="code" href="../../d4/d1/userk_8h.html#a1269">AllocAce</a>(paceList, ACCESS_ALLOWED_ACE_TYPE,
00206             0, DIRECTORY_QUERY | DIRECTORY_CREATE_OBJECT,
00207             <a class="code" href="../../d0/d5/se_8h.html#a37">SeExports</a>-&gt;<a class="code" href="../../d2/d0/struct__SE__EXPORTS.html#o34">SeAliasAdminsSid</a>, &amp;dwLength);
00208     <span class="keywordflow">if</span> (pace == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00209         UserFreePool(paceList);
00210         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00211     }
00212     paceList = pace;
00213 
00214     pace = <a class="code" href="../../d4/d1/userk_8h.html#a1269">AllocAce</a>(paceList, ACCESS_ALLOWED_ACE_TYPE,
00215             0, DIRECTORY_TRAVERSE, <a class="code" href="../../d0/d5/se_8h.html#a37">SeExports</a>-&gt;<a class="code" href="../../d2/d0/struct__SE__EXPORTS.html#o24">SeWorldSid</a>, &amp;dwLength);
00216     <span class="keywordflow">if</span> (pace == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00217         UserFreePool(paceList);
00218         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00219     }
00220     paceList = pace;
00221 
00222     pace = <a class="code" href="../../d4/d1/userk_8h.html#a1269">AllocAce</a>(paceList, ACCESS_ALLOWED_ACE_TYPE,
00223             0, DIRECTORY_TRAVERSE, <a class="code" href="../../d0/d5/se_8h.html#a37">SeExports</a>-&gt;<a class="code" href="../../d2/d0/struct__SE__EXPORTS.html#o43">SeRestrictedSid</a>, &amp;dwLength);
00224     <span class="keywordflow">if</span> (pace == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00225         UserFreePool(paceList);
00226         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00227     }
00228     paceList = pace;
00229 
00230     <span class="comment">/*</span>
00231 <span class="comment">     * Create the SD</span>
00232 <span class="comment">     */</span>
00233     <a class="code" href="../../d1/d0/kernel_2exitwin_8c.html#a5">gpsdInitWinSta</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1268">CreateSecurityDescriptor</a>(paceList, dwLength, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00234     UserFreePool(paceList);
00235 
00236     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/kernel_2exitwin_8c.html#a5">gpsdInitWinSta</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00237         RIPMSG0(RIP_WARNING, <span class="stringliteral">"Initial windowstation security was not created!"</span>);
00238     }
00239 
00240     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)(<a class="code" href="../../d1/d0/kernel_2exitwin_8c.html#a5">gpsdInitWinSta</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00241 }
00242 
00243 
00244 <span class="comment">/***************************************************************************\</span>
00245 <span class="comment">* TestForInteractiveUser</span>
00246 <span class="comment">*</span>
00247 <span class="comment">* Returns STATUS_SUCCESS if the LUID passed represents an</span>
00248 <span class="comment">* interactiveUser user logged on by winlogon, otherwise FALSE</span>
00249 <span class="comment">*</span>
00250 <span class="comment">* History:</span>
00251 <span class="comment">* 03-08-95 JimA         Created.</span>
00252 <span class="comment">\***************************************************************************/</span>
00253 
00254 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00255"></a><a class="code" href="../../d4/d1/userk_8h.html#a1277">00255</a> <a class="code" href="../../d4/d1/userk_8h.html#a1277">TestForInteractiveUser</a>(
00256     PLUID pluidCaller
00257     )
00258 {
00259     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta;
00260 
00261     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a241">grpWinStaList</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00262 
00263     <span class="comment">/*</span>
00264 <span class="comment">     * !!!</span>
00265 <span class="comment">     *</span>
00266 <span class="comment">     * This relies on the fact that there is only ONE interactive</span>
00267 <span class="comment">     * windowstation and that it is the first one in the list.</span>
00268 <span class="comment">     * If multiple windowstations are ever supported</span>
00269 <span class="comment">     * a lookup will have to be done here.</span>
00270 <span class="comment">     */</span>
00271     pwinsta = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a241">grpWinStaList</a>;
00272 
00273     <span class="comment">/*</span>
00274 <span class="comment">     * Compare it with the id of the logged on user.</span>
00275 <span class="comment">     */</span>
00276     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(pluidCaller, &amp;pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o18">luidUser</a>))
00277         <span class="keywordflow">return</span> STATUS_SUCCESS;
00278     <span class="keywordflow">else</span>
00279         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00280 }
00281 
00282 
00283 
00284 <span class="comment">/***************************************************************************\</span>
00285 <span class="comment">* _UserTestForWinStaAccess</span>
00286 <span class="comment">*</span>
00287 <span class="comment">* Returns STATUS_SUCCESS if the current user has GENERIC_EXECUTE access on</span>
00288 <span class="comment">*  WindowStation pstrWinSta</span>
00289 <span class="comment">*</span>
00290 <span class="comment">*</span>
00291 <span class="comment">* History:</span>
00292 <span class="comment">* 06-05-96  Created     SalimC</span>
00293 <span class="comment">\***************************************************************************/</span>
00294 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00295"></a><a class="code" href="../../d4/d1/userk_8h.html#a1278">00295</a> <a class="code" href="../../d4/d1/userk_8h.html#a1278">_UserTestForWinStaAccess</a>(
00296     PUNICODE_STRING pstrWinSta,
00297     BOOL fInherit
00298     )
00299 {
00300     PTOKEN_STATISTICS   pStats;
00301     ULONG               BytesRequired;
00302     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>      pwinsta;
00303     HWINSTA             hwsta = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00304     OBJECT_ATTRIBUTES   ObjAttr;
00305     POBJECT_ATTRIBUTES  pObjAttr = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00306     PUNICODE_STRING     pstrStatic;
00307     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> =  STATUS_SUCCESS;
00308     SIZE_T              cbObjA;
00309     UNICODE_STRING      strDefWinSta;
00310     HANDLE              htoken;
00311 
00312     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00313 
00314     UserAssert(NtCurrentTeb());
00315     UserAssert(pstrWinSta-&gt;Buffer == NtCurrentTeb()-&gt;StaticUnicodeBuffer);
00316 
00317     <span class="comment">/*</span>
00318 <span class="comment">     * If we are testing against Default WindowStation (WinSta0) retreive</span>
00319 <span class="comment">     * pwinsta from the top of the grpwinstaList instead of doing an</span>
00320 <span class="comment">     * OpenWindowStation()</span>
00321 <span class="comment">     *</span>
00322 <span class="comment">     * !!!</span>
00323 <span class="comment">     *</span>
00324 <span class="comment">     * This relies on the fact that there is only ONE interactive</span>
00325 <span class="comment">     * windowstation and that it is the first one in the list.</span>
00326 <span class="comment">     * If multiple windowstations are ever supported</span>
00327 <span class="comment">     * a lookup will have to be done instead.</span>
00328 <span class="comment">     */</span>
00329     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strDefWinSta, <a class="code" href="../../d4/d1/userk_8h.html#a521">DEFAULT_WINSTA</a>);
00330     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(pstrWinSta, &amp;strDefWinSta, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00331 
00332 
00333         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a960">OpenEffectiveToken</a>(&amp;htoken))) {
00334             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00335         }
00336 
00337         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQueryInformationToken(
00338                      htoken,                 <span class="comment">// Handle</span>
00339                      TokenStatistics,           <span class="comment">// TokenInformationClass</span>
00340                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                      <span class="comment">// TokenInformation</span>
00341                      0,                         <span class="comment">// TokenInformationLength</span>
00342                      &amp;BytesRequired             <span class="comment">// ReturnLength</span>
00343                      );
00344 
00345         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_BUFFER_TOO_SMALL) {
00346             ZwClose(htoken);
00347             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00348         }
00349 
00350         <span class="comment">//</span>
00351         <span class="comment">// Allocate space for the user info</span>
00352         <span class="comment">//</span>
00353 
00354         pStats = (PTOKEN_STATISTICS)UserAllocPoolWithQuota(BytesRequired, TAG_SECURITY);
00355         <span class="keywordflow">if</span> (pStats == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00356             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00357             ZwClose(htoken);
00358             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00359         }
00360 
00361         <span class="comment">//</span>
00362         <span class="comment">// Read in the user info</span>
00363         <span class="comment">//</span>
00364 
00365         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQueryInformationToken(
00366                      htoken,             <span class="comment">// Handle</span>
00367                      TokenStatistics,       <span class="comment">// TokenInformationClass</span>
00368                      pStats,                <span class="comment">// TokenInformation</span>
00369                      BytesRequired,         <span class="comment">// TokenInformationLength</span>
00370                      &amp;BytesRequired         <span class="comment">// ReturnLength</span>
00371                      ))) {
00372             ZwClose(htoken);
00373             UserFreePool(pStats);
00374             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00375         }
00376 
00377         <span class="comment">/*</span>
00378 <span class="comment">         * Make sure that current process has access to this window station</span>
00379 <span class="comment">         */</span>
00380         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
00381 
00382         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a241">grpWinStaList</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00383 
00384             <span class="comment">/*</span>
00385 <span class="comment">             * !!!</span>
00386 <span class="comment">             *</span>
00387 <span class="comment">             * This relies on the fact that there is only ONE interactive</span>
00388 <span class="comment">             * windowstation and that it is the first one in the list.</span>
00389 <span class="comment">             * If multiple windowstations are ever supported</span>
00390 <span class="comment">             * a lookup will have to be done here.</span>
00391 <span class="comment">             */</span>
00392             pwinsta = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a241">grpWinStaList</a>;
00393 
00394             <span class="comment">/*</span>
00395 <span class="comment">             * For now we will just do the user luid test till we figure out</span>
00396 <span class="comment">             * what fInherit means for a Multi-User system</span>
00397 <span class="comment">             */</span>
00398             <span class="keywordflow">if</span> (fInherit) {
00399                 <span class="keywordflow">if</span> ( (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;pStats-&gt;AuthenticationId, &amp;pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o18">luidUser</a>)) ||
00400                      (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;pStats-&gt;AuthenticationId, &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a244">luidSystem</a>)) ||
00401                      (<a class="code" href="../../d4/d1/userk_8h.html#a1271">AccessCheckObject</a>(pwinsta, GENERIC_EXECUTE, (<a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>)(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a332">gbSecureDesktop</a> ? <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>), &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a304">WinStaMapping</a>)) )  {
00402                    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00403                 }
00404             } <span class="keywordflow">else</span> {
00405                 <span class="comment">/* Bug 42905. Service Controller clears the flag</span>
00406 <span class="comment">                 * ScStartupInfo.dwFlags &amp;= (~STARTF_DESKTOPINHERIT) to make services</span>
00407 <span class="comment">                 * running under the context of system non-interactive. Hence if fInherit</span>
00408 <span class="comment">                 * is false don't do the SystemLuid and AccessCheckObject tests.</span>
00409 <span class="comment">                 */</span>
00410 
00411                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;pStats-&gt;AuthenticationId, &amp;pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o18">luidUser</a>)) {
00412                    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00413                 }
00414             }
00415         }
00416 
00417         ZwClose(htoken);
00418         UserFreePool(pStats);
00419         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00420     }
00421 
00422     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a332">gbSecureDesktop</a>) {
00423         <span class="comment">/*</span>
00424 <span class="comment">         * Since we don't have a pointer to the WindowStation Object we will do</span>
00425 <span class="comment">         * a OpenWindowStation() to make sure we have the desired access.</span>
00426 <span class="comment">         */</span>
00427         cbObjA = <span class="keyword">sizeof</span>(*pObjAttr) + <span class="keyword">sizeof</span>(*pstrStatic);
00428         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory(NtCurrentProcess(),
00429                 &amp;pObjAttr, 0, &amp;cbObjA, MEM_COMMIT, PAGE_READWRITE);
00430         pstrStatic = (PUNICODE_STRING)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pObjAttr + <span class="keyword">sizeof</span>(*pObjAttr));
00431 
00432         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00433 
00434             <span class="comment">/*</span>
00435 <span class="comment">             * Note -- the string must be in client-space or the</span>
00436 <span class="comment">             * address validation in OpenWindowStation will fail.</span>
00437 <span class="comment">             *</span>
00438 <span class="comment">             * This code is called from xxxResolveDesktop and the buffer of the passed-in string</span>
00439 <span class="comment">             * is in the teb already.</span>
00440 <span class="comment">             */</span>
00441             <span class="keywordflow">try</span> {
00442                 *pstrStatic = *pstrWinSta;
00443                 InitializeObjectAttributes( pObjAttr,
00444                                             pstrStatic,
00445                                             OBJ_CASE_INSENSITIVE,
00446                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00447                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00448                                             );
00449             } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
00450                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00451             }
00452 
00453             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00454                 hwsta = <a class="code" href="../../d8/d8/winsta_8c.html#a8">_OpenWindowStation</a>(pObjAttr, GENERIC_EXECUTE, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00455             }
00456         } <span class="keywordflow">else</span> {
00457             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00458         }
00459 
00460         <span class="keywordflow">if</span> (pObjAttr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00461             ZwFreeVirtualMemory(NtCurrentProcess(), &amp;pObjAttr, &amp;cbObjA,
00462                             MEM_RELEASE);
00463         }
00464     } <span class="keywordflow">else</span> {
00465         InitializeObjectAttributes( &amp;ObjAttr,
00466                                     pstrWinSta,
00467                                     OBJ_CASE_INSENSITIVE,
00468                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00469                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00470                                     );
00471         hwsta = <a class="code" href="../../d8/d8/winsta_8c.html#a8">_OpenWindowStation</a>(&amp;ObjAttr, GENERIC_EXECUTE, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>);
00472     }
00473 
00474     <span class="keywordflow">if</span> (!hwsta) {
00475         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00476     }
00477 
00478     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwClose(hwsta);
00479 
00480     UserAssert(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00481     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00482 }
00483 <span class="comment">/***************************************************************************\</span>
00484 <span class="comment">* CheckGrantedAccess</span>
00485 <span class="comment">*</span>
00486 <span class="comment">* Confirms all requested accesses are granted and sets error status.</span>
00487 <span class="comment">*</span>
00488 <span class="comment">* History:</span>
00489 <span class="comment">* 06-26-95 JimA       Created.</span>
00490 <span class="comment">\***************************************************************************/</span>
00491 
<a name="l00492"></a><a class="code" href="../../d4/d1/userk_8h.html#a1270">00492</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1270">CheckGrantedAccess</a>(
00493     ACCESS_MASK amGranted,
00494     ACCESS_MASK amRequest)
00495 {
00496 
00497     <span class="comment">/*</span>
00498 <span class="comment">     * Check the granted access.</span>
00499 <span class="comment">     */</span>
00500     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a68">RtlAreAllAccessesGranted</a>(amGranted, amRequest)) {
00501         RIPERR0(ERROR_ACCESS_DENIED, RIP_VERBOSE, <span class="stringliteral">""</span>);
00502         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00503     }
00504     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00505 }
00506 
00507 <span class="comment">/***************************************************************************\</span>
00508 <span class="comment">* CheckWinstaWriteAttributesAccess</span>
00509 <span class="comment">*</span>
00510 <span class="comment">* Checks if the current process has WINSTA_WRITEATTRIBUTES access</span>
00511 <span class="comment">* to its windowstation, and whether that windowstation is an</span>
00512 <span class="comment">* interactive windowstation.</span>
00513 <span class="comment">*</span>
00514 <span class="comment">* History:</span>
00515 <span class="comment">* 06-Jun-1996 adams     Created.</span>
00516 <span class="comment">\***************************************************************************/</span>
00517 
<a name="l00518"></a><a class="code" href="../../d4/d1/userk_8h.html#a1274">00518</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d7/d5/w32_2ntuser_2kernel_2security_8c.html#a9">CheckWinstaWriteAttributesAccess</a>(<span class="keywordtype">void</span>)
00519 {
00520     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>();
00521 
00522     <span class="comment">/*</span>
00523 <span class="comment">     * winlogon has rights to all windowstations.</span>
00524 <span class="comment">     */</span>
00525     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;UniqueProcessId == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a>)
00526         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00527 
00528     <span class="keywordflow">if</span> (!(ppiCurrent-&gt;W32PF_Flags &amp; W32PF_IOWINSTA)) {
00529         RIPERR0(ERROR_REQUIRES_INTERACTIVE_WINDOWSTATION,
00530                 RIP_WARNING,
00531                 <span class="stringliteral">"Operation invalid on a non-interactive WindowStation."</span>);
00532 
00533         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00534     }
00535 
00536     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a68">RtlAreAllAccessesGranted</a>(ppiCurrent-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o16">amwinsta</a>, WINSTA_WRITEATTRIBUTES)) {
00537         RIPERR0(ERROR_ACCESS_DENIED,
00538                 RIP_WARNING,
00539                 <span class="stringliteral">"WINSTA_WRITEATTRIBUTES access to WindowStation denied."</span>);
00540 
00541         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00542     }
00543     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00544 }
00545 
00546 <span class="comment">/***************************************************************************\</span>
00547 <span class="comment">* AccessCheckObject</span>
00548 <span class="comment">*</span>
00549 <span class="comment">* Performs an access check on an object</span>
00550 <span class="comment">*</span>
00551 <span class="comment">* History:</span>
00552 <span class="comment">* 12-31-90 JimA       Created.</span>
00553 <span class="comment">\***************************************************************************/</span>
00554 
<a name="l00555"></a><a class="code" href="../../d4/d1/userk_8h.html#a1271">00555</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1271">AccessCheckObject</a>(
00556     PVOID pobj,
00557     ACCESS_MASK amRequest,
00558     KPROCESSOR_MODE AccessMode,
00559     CONST GENERIC_MAPPING *pGenericMapping)
00560 {
00561     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00562     <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">ACCESS_STATE</a> AccessState;
00563     BOOLEAN fAccessGranted;
00564     <a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html">AUX_ACCESS_DATA</a> AuxData;
00565     BOOLEAN bMutexLocked = (pGenericMapping == (&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a303">KeyMapping</a>));
00566     <span class="comment">/*</span>
00567 <span class="comment">     * Due to a resource problem in the object manager, we must pass in a TRUE</span>
00568 <span class="comment">     * when checking access for registry keys, even if we do not explicitly have</span>
00569 <span class="comment">     * the object type mutex.  If we do not, we can get into a deadlock situation with this mutex</span>
00570 <span class="comment">     * and the CmpRegistry lock.</span>
00571 <span class="comment">     */</span>
00572 
00573     <a class="code" href="../../d2/d5/seastate_8c.html#a2">SeCreateAccessState</a>(&amp;AccessState, &amp;AuxData, amRequest, (PGENERIC_MAPPING)pGenericMapping);
00574     fAccessGranted = <a class="code" href="../../d9/d1/obse_8c.html#a3">ObCheckObjectAccess</a>(
00575             pobj,
00576             &amp;AccessState,
00577             bMutexLocked,
00578             AccessMode,
00579             &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00580     <a class="code" href="../../d2/d5/seastate_8c.html#a3">SeDeleteAccessState</a>(&amp;AccessState);
00581     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)(fAccessGranted == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00582 }
00583 
00584 <span class="comment">/***************************************************************************\</span>
00585 <span class="comment">* IsPrivileged</span>
00586 <span class="comment">*</span>
00587 <span class="comment">* Check to see if the client has the specified privileges</span>
00588 <span class="comment">*</span>
00589 <span class="comment">* History:</span>
00590 <span class="comment">* 01-02-91 JimA       Created.</span>
00591 <span class="comment">\***************************************************************************/</span>
00592 
<a name="l00593"></a><a class="code" href="../../d4/d1/userk_8h.html#a1273">00593</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a22">IsPrivileged</a>(
00594     PPRIVILEGE_SET ppSet)
00595 {
00596     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> Context;
00597     BOOLEAN bHeld;
00598 
00599     <a class="code" href="../../d0/d8/subject_8c.html#a0">SeCaptureSubjectContext</a>(&amp;Context);
00600     <a class="code" href="../../d0/d8/subject_8c.html#a1">SeLockSubjectContext</a>(&amp;Context);
00601 
00602     bHeld = <a class="code" href="../../d8/d4/privileg_8c.html#a1">SePrivilegeCheck</a>(ppSet, &amp;Context, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00603     <a class="code" href="../../d3/d5/seaudit_8c.html#a13">SePrivilegeObjectAuditAlarm</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;Context, 0, ppSet, bHeld, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00604 
00605     <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>(&amp;Context);
00606     <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a>(&amp;Context);
00607 
00608     <span class="keywordflow">if</span> (!bHeld)
00609         RIPERR0(ERROR_PRIVILEGE_NOT_HELD, RIP_VERBOSE, <span class="stringliteral">""</span>);
00610 
00611     <span class="comment">/*</span>
00612 <span class="comment">     * Return result of privilege check</span>
00613 <span class="comment">     */</span>
00614     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)bHeld;
00615 }
00616 
00617 <span class="comment">/***************************************************************************\</span>
00618 <span class="comment">* _GetUserObjectInformation (API)</span>
00619 <span class="comment">*</span>
00620 <span class="comment">* Gets information about a secure USER object</span>
00621 <span class="comment">*</span>
00622 <span class="comment">* History:</span>
00623 <span class="comment">* 04-25-94 JimA       Created.</span>
00624 <span class="comment">\***************************************************************************/</span>
00625 
<a name="l00626"></a><a class="code" href="../../d4/d1/userk_8h.html#a1118">00626</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1118">_GetUserObjectInformation</a>(
00627     HANDLE h,
00628     <span class="keywordtype">int</span> nIndex,
00629     PVOID ccxpvInfo,
00630     DWORD nLength,
00631     LPDWORD lpnLengthNeeded)
00632 {
00633     PUSEROBJECTFLAGS puof;
00634     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00635     PVOID pObject;
00636     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> pHead;
00637     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwLengthNeeded = 0;
00638     <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a> ohi;
00639     PUNICODE_STRING pstrInfo;
00640     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta;
00641     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00642 
00643     <span class="comment">/*</span>
00644 <span class="comment">     * Validate the object</span>
00645 <span class="comment">     */</span>
00646     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00647             h,
00648             0,
00649             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00650             <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,   <span class="comment">// this is always called from the client side</span>
00651             &amp;pObject,
00652             &amp;ohi);
00653     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00654         RIPNTERR0(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, RIP_VERBOSE, <span class="stringliteral">"ObReferenceObjectByHandle Failed"</span>);
00655         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00656     }
00657 
00658     pHead = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pObject);
00659     <span class="keywordflow">if</span> (pHead-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a> != *<a class="code" href="../../d3/d7/win32_8c.html#a0">ExWindowStationObjectType</a> &amp;&amp;
00660             pHead-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a> != *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>) {
00661         RIPERR0(ERROR_INVALID_FUNCTION, RIP_WARNING, <span class="stringliteral">"Object is not a USER object"</span>);
00662         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pObject);
00663         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00664     }
00665 
00666 <span class="preprocessor">#ifdef LOGDESKTOPLOCKS</span>
00667 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pObject)-&gt;Type == *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>) {
00668         <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pObject, LD_REF_FN_GETUSEROBJECTINFORMATION, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>());
00669     }
00670 <span class="preprocessor">#endif</span>
00671 <span class="preprocessor"></span>
00672     <span class="keywordflow">try</span> {
00673         <span class="keywordflow">switch</span> (nIndex) {
00674         <span class="keywordflow">case</span> UOI_FLAGS:
00675             dwLengthNeeded = <span class="keyword">sizeof</span>(USEROBJECTFLAGS);
00676             <span class="keywordflow">if</span> (nLength &lt; <span class="keyword">sizeof</span>(USEROBJECTFLAGS)) {
00677                 RIPERR0(ERROR_INSUFFICIENT_BUFFER, RIP_VERBOSE, <span class="stringliteral">""</span>);
00678                 fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00679                 <span class="keywordflow">break</span>;
00680             }
00681             puof = ccxpvInfo;
00682             puof-&gt;fInherit = (ohi.<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o0">HandleAttributes</a> &amp; OBJ_INHERIT) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00683             puof-&gt;fReserved = 0;
00684             puof-&gt;dwFlags = 0;
00685             <span class="keywordflow">if</span> (pHead-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a> == *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>) {
00686                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a2070">CheckHandleFlag</a>(h, <a class="code" href="../../d4/d1/userk_8h.html#a746">HF_DESKTOPHOOK</a>))
00687                     puof-&gt;dwFlags |= DF_ALLOWOTHERACCOUNTHOOK;
00688             } <span class="keywordflow">else</span> {
00689                 <span class="keywordflow">if</span> (!(((<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>)pObject)-&gt;dwWSF_Flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>))
00690                     puof-&gt;dwFlags |= WSF_VISIBLE;
00691             }
00692             <span class="keywordflow">break</span>;
00693 
00694         <span class="keywordflow">case</span> UOI_NAME:
00695             pstrInfo = <a class="code" href="../../d4/d1/userk_8h.html#a522">POBJECT_NAME</a>(pObject);
00696             <span class="keywordflow">goto</span> docopy;
00697 
00698         <span class="keywordflow">case</span> UOI_TYPE:
00699             pstrInfo = &amp;pHead-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o2">Name</a>;
00700 docopy:
00701             <span class="keywordflow">if</span> (pstrInfo) {
00702                 dwLengthNeeded = pstrInfo-&gt;Length + <span class="keyword">sizeof</span>(WCHAR);
00703                 <span class="keywordflow">if</span> (dwLengthNeeded &gt; nLength) {
00704                     RIPERR0(ERROR_INSUFFICIENT_BUFFER, RIP_VERBOSE, <span class="stringliteral">""</span>);
00705                     fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00706                     <span class="keywordflow">break</span>;
00707                 }
00708                 RtlCopyMemory(ccxpvInfo, pstrInfo-&gt;Buffer, pstrInfo-&gt;Length);
00709                 *(PWCHAR)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)ccxpvInfo + pstrInfo-&gt;Length) = 0;
00710             } <span class="keywordflow">else</span> {
00711                 dwLengthNeeded = 0;
00712             }
00713             <span class="keywordflow">break</span>;
00714 
00715         <span class="keywordflow">case</span> UOI_USER_SID:
00716             <span class="keywordflow">if</span> (pHead-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a> == *<a class="code" href="../../d3/d7/win32_8c.html#a0">ExWindowStationObjectType</a>)
00717                 pwinsta = pObject;
00718             <span class="keywordflow">else</span>
00719                 pwinsta = ((<a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>)pObject)-&gt;rpwinstaParent;
00720             <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o19">psidUser</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00721                 dwLengthNeeded = 0;
00722             } <span class="keywordflow">else</span> {
00723                 dwLengthNeeded = <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>(pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o19">psidUser</a>);
00724                 <span class="keywordflow">if</span> (dwLengthNeeded &gt; nLength) {
00725                     RIPERR0(ERROR_INSUFFICIENT_BUFFER, RIP_VERBOSE, <span class="stringliteral">""</span>);
00726                     fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00727                     <span class="keywordflow">break</span>;
00728                 }
00729                 RtlCopyMemory(ccxpvInfo, pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o19">psidUser</a>, dwLengthNeeded);
00730             }
00731             <span class="keywordflow">break</span>;
00732 
00733         <span class="keywordflow">default</span>:
00734             RIPERR0(ERROR_INVALID_PARAMETER, RIP_VERBOSE, <span class="stringliteral">""</span>);
00735             fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00736             <span class="keywordflow">break</span>;
00737         }
00738     } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, RIP_WARNING)) {
00739         fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00740     }
00741 
00742     *lpnLengthNeeded = dwLengthNeeded;
00743 
00744 <span class="preprocessor">#ifdef LOGDESKTOPLOCKS</span>
00745 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pObject)-&gt;Type == *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>) {
00746         <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pObject, LD_DEREF_FN_GETUSEROBJECTINFORMATION, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>());
00747     }
00748 <span class="preprocessor">#endif</span>
00749 <span class="preprocessor"></span>
00750     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pObject);
00751 
00752     <span class="keywordflow">return</span> fSuccess;
00753 }
00754 
00755 <span class="comment">/***************************************************************************\</span>
00756 <span class="comment">* _SetUserObjectInformation (API)</span>
00757 <span class="comment">*</span>
00758 <span class="comment">* Sets information about a secure USER object</span>
00759 <span class="comment">*</span>
00760 <span class="comment">* History:</span>
00761 <span class="comment">* 04-25-94 JimA       Created.</span>
00762 <span class="comment">\***************************************************************************/</span>
00763 
<a name="l00764"></a><a class="code" href="../../d4/d1/userk_8h.html#a1119">00764</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1119">_SetUserObjectInformation</a>(
00765     HANDLE h,
00766     <span class="keywordtype">int</span> nIndex,
00767     PVOID ccxpvInfo,
00768     DWORD nLength)
00769 {
00770     PUSEROBJECTFLAGS puof;
00771     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00772     PVOID pObject;
00773     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> pHead;
00774     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwLengthNeeded = 0;
00775     <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a> ohi;
00776     OBJECT_HANDLE_FLAG_INFORMATION ofi;
00777     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00778 
00779     <span class="comment">/*</span>
00780 <span class="comment">     * Validate the object</span>
00781 <span class="comment">     */</span>
00782     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00783             h,
00784             0,
00785             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00786             <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,   <span class="comment">// this is always called from the client side</span>
00787             &amp;pObject,
00788             &amp;ohi);
00789     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00790         RIPNTERR0(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, RIP_VERBOSE, <span class="stringliteral">"ObReferenceObjectByHandle Failed"</span>);
00791         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00792     }
00793 
00794     pHead = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pObject);
00795     <span class="keywordflow">if</span> (pHead-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a> != *<a class="code" href="../../d3/d7/win32_8c.html#a0">ExWindowStationObjectType</a> &amp;&amp;
00796             pHead-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a> != *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>) {
00797         RIPERR0(ERROR_INVALID_FUNCTION, RIP_WARNING, <span class="stringliteral">"Object is not a USER object"</span>);
00798         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pObject);
00799         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00800     }
00801 
00802 <span class="preprocessor">#ifdef LOGDESKTOPLOCKS</span>
00803 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pObject)-&gt;Type == *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>) {
00804         <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pObject, LD_REF_FN_SETUSEROBJECTINFORMATION, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
00805     }
00806 <span class="preprocessor">#endif</span>
00807 <span class="preprocessor"></span>
00808     <span class="keywordflow">try</span> {
00809         <span class="keywordflow">switch</span> (nIndex) {
00810         <span class="keywordflow">case</span> UOI_FLAGS:
00811             <span class="keywordflow">if</span> (nLength &lt; <span class="keyword">sizeof</span>(USEROBJECTFLAGS)) {
00812                 RIPERR0(ERROR_INVALID_DATA, RIP_VERBOSE, <span class="stringliteral">""</span>);
00813                 fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00814                 <span class="keywordflow">break</span>;
00815             }
00816             puof = ccxpvInfo;
00817             ZwQueryObject(h, ObjectHandleFlagInformation,
00818                     &amp;ofi, <span class="keyword">sizeof</span>(ofi), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00819             ofi.Inherit = (puof-&gt;fInherit != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00820             ZwSetInformationObject(h, ObjectHandleFlagInformation,
00821                     &amp;ofi, <span class="keyword">sizeof</span>(ofi));
00822             <span class="keywordflow">if</span> (pHead-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a> == *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>) {
00823                 <a class="code" href="../../d4/d1/userk_8h.html#a2069">SetHandleFlag</a>(h, <a class="code" href="../../d4/d1/userk_8h.html#a746">HF_DESKTOPHOOK</a>,
00824                         puof-&gt;dwFlags &amp; DF_ALLOWOTHERACCOUNTHOOK);
00825             }
00826             <span class="keywordflow">break</span>;
00827         <span class="keywordflow">default</span>:
00828             RIPERR0(ERROR_INVALID_PARAMETER, RIP_VERBOSE, <span class="stringliteral">""</span>);
00829             fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00830             <span class="keywordflow">break</span>;
00831         }
00832     } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, RIP_WARNING)) {
00833         fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00834     }
00835 
00836 <span class="preprocessor">#ifdef LOGDESKTOPLOCKS</span>
00837 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(pObject)-&gt;Type == *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>) {
00838         <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pObject, LD_DEREF_FN_SETUSEROBJECTINFORMATION, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
00839     }
00840 <span class="preprocessor">#endif</span>
00841 <span class="preprocessor"></span>
00842     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pObject);
00843 
00844     <span class="keywordflow">return</span> fSuccess;
00845 }
00846 
00847 <span class="comment">/***************************************************************************\</span>
00848 <span class="comment">* UserScreenAccessCheck</span>
00849 <span class="comment">*</span>
00850 <span class="comment">* Called from the engine to determine if the thread's desktop is</span>
00851 <span class="comment">* active and the process has WINSTA_READSCREEN access.</span>
00852 <span class="comment">*</span>
00853 <span class="comment">* Note that we may or may not be in USER's critical section when this</span>
00854 <span class="comment">* is called.  This is OK as long as we don't reference thing belonging</span>
00855 <span class="comment">* to other threads.  If we did try to enter the critical section here,</span>
00856 <span class="comment">* a deadlock may occur between the engine and user.</span>
00857 <span class="comment">*</span>
00858 <span class="comment">* History:</span>
00859 <span class="comment">* 05-20-93 JimA         Created.</span>
00860 <span class="comment">* 11-22-96 BradG        Brought back to life.</span>
00861 <span class="comment">\***************************************************************************/</span>
00862 
<a name="l00863"></a><a class="code" href="../../d7/d5/w32_2ntuser_2kernel_2security_8c.html#a14">00863</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a> <a class="code" href="../../d7/d5/w32_2ntuser_2kernel_2security_8c.html#a14">UserScreenAccessCheck</a>(VOID)
00864 {
00865     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>() != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00866 
00867     <span class="keywordflow">return</span> (
00868             <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>() != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>()-&gt;rpdesk == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> &amp;&amp;
00869             (W32GetCurrentProcess()-&gt;W32PF_Flags &amp; (W32PF_READSCREENACCESSGRANTED | W32PF_IOWINSTA)) ==
00870                     (W32PF_READSCREENACCESSGRANTED | W32PF_IOWINSTA));
00871 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:45 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
