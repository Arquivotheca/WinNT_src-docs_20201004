<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ioerr.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ioerr.c</h1><a href="../../d7/d5/ioerr_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1998  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    ioerr.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the code for the worker routines</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Michael Tsang (MikeTs) 2-Sep-1998</span>
00016 <span class="comment"></span>
00017 <span class="comment">Environment:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Kernel mode</span>
00020 <span class="comment"></span>
00021 <span class="comment">Revision History:</span>
00022 <span class="comment"></span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="../../d2/d4/ioe_2pch_8h.html">pch.h</a>"</span>
00027 
00028 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IoepHandleErrCase)</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IoepFindErrHandler)</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IoepMatchErrIDPath)</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IoepGetErrMessage)</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IoepCatMsgArg)</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IoepUnicodeStringCatN)</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IoepGetErrCaseDB)</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00037 <span class="preprocessor"></span>
00038 HANDLE
<a name="l00039"></a><a class="code" href="../../d7/d5/ioerr_8c.html#a0">00039</a> <a class="code" href="../../d7/d5/ioerr_8c.html#a0">IoepInitErrLog</a>(
00040     IN ULONG KeyType,
00041     IN PVOID Key,
00042     IN ULONG ulFlags
00043     )
00044 <span class="comment">/*++</span>
00045 <span class="comment"></span>
00046 <span class="comment">Routine Description:</span>
00047 <span class="comment">    This routine initializes an error logging session with the specified key.</span>
00048 <span class="comment"></span>
00049 <span class="comment">Arguments:</span>
00050 <span class="comment">    KeyType - specifies the key type</span>
00051 <span class="comment">    Key - points to the key</span>
00052 <span class="comment">    ulFlags - log session flags</span>
00053 <span class="comment"></span>
00054 <span class="comment">Return Value:</span>
00055 <span class="comment">    Success - returns the newly created error log handle.</span>
00056 <span class="comment">    Failure - returns NULL.</span>
00057 <span class="comment"></span>
00058 <span class="comment">--*/</span>
00059 {
00060     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoepInitErrLog"</span>);
00061     <a class="code" href="../../d4/d5/struct__errlog.html">PERRLOG</a> ErrLog;
00062 
00063     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00064     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ulFlags &amp; ~<a class="code" href="../../d6/d5/ioep_8h.html#a23">LOGF_INITMASK</a> == 0);
00065     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(2, (<span class="stringliteral">"(KeyType=%x,Key=%p,ulFlags=%x)\n"</span>, KeyType, <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>, ulFlags));
00066 
00067     ErrLog = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00068                                    <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/struct__errlog.html">ERRLOG</a>),
00069                                    <a class="code" href="../../d6/d5/ioep_8h.html#a0">IOETAG_ERRLOG</a>);
00070 
00071     <span class="keywordflow">if</span> (ErrLog != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00072     {
00073         <a class="code" href="../../d9/d5/struct__errthread.html">PERRTHREAD</a> ErrThread;
00074 
00075         ErrThread = <a class="code" href="../../d7/d5/ioerr_8c.html#a1">IoepFindErrThread</a>(KeyType, <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>);
00076         <span class="keywordflow">if</span> (ErrThread == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00077         {
00078             ErrThread = <a class="code" href="../../d7/d5/ioerr_8c.html#a2">IoepNewErrThread</a>(KeyType, <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>);
00079         }
00080 
00081         <span class="keywordflow">if</span> (ErrThread != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00082         {
00083             ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o0">Signature</a> = <a class="code" href="../../d6/d5/ioep_8h.html#a22">SIG_ERRLOG</a>;
00084             ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o1">ulFlags</a> = ulFlags &amp; <a class="code" href="../../d6/d5/ioep_8h.html#a23">LOGF_INITMASK</a>;
00085             ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o4">ErrThread</a> = ErrThread;
00086             ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o3">ErrStack</a>.Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00087             ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o5">ErrInfo</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00088             <a class="code" href="../../d5/d8/ex_8h.html#a237">ExInterlockedInsertHeadList</a>(&amp;ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o1">ErrLogListHead</a>,
00089                                         &amp;ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o2">list</a>,
00090                                         &amp;<a class="code" href="../../d0/d2/data_8c.html#a1">IoepErrListLock</a>);
00091         }
00092         <span class="keywordflow">else</span>
00093         {
00094             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ErrLog);
00095             ErrLog = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00096         }
00097     }
00098     <span class="keywordflow">else</span>
00099     {
00100         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to allocate new error log\n"</span>));
00101     }
00102 
00103     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(2, (<span class="stringliteral">"=%p\n"</span>, ErrLog));
00104     <span class="keywordflow">return</span> ErrLog;
00105 }       <span class="comment">//IoepInitErrLog</span>
00106 
00107 <a class="code" href="../../d9/d5/struct__errthread.html">PERRTHREAD</a>
<a name="l00108"></a><a class="code" href="../../d7/d5/ioerr_8c.html#a1">00108</a> <a class="code" href="../../d7/d5/ioerr_8c.html#a1">IoepFindErrThread</a>(
00109     IN ULONG KeyType,
00110     IN PVOID Key
00111     )
00112 <span class="comment">/*++</span>
00113 <span class="comment"></span>
00114 <span class="comment">Routine Description:</span>
00115 <span class="comment">    This routine finds the error thread keyed by the given Key.</span>
00116 <span class="comment"></span>
00117 <span class="comment">Arguments:</span>
00118 <span class="comment">    KeyType - specifies the type of key.</span>
00119 <span class="comment">    Key - points to the key that is used to locate the logging session.</span>
00120 <span class="comment"></span>
00121 <span class="comment">Return Value:</span>
00122 <span class="comment">    Success - returns the error thread handle found.</span>
00123 <span class="comment">    Failure - returns NULL.</span>
00124 <span class="comment"></span>
00125 <span class="comment">--*/</span>
00126 {
00127     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoepFindErrThread"</span>);
00128     <a class="code" href="../../d9/d5/struct__errthread.html">PERRTHREAD</a> ErrThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00129     PLIST_ENTRY list;
00130     KIRQL Irql;
00131 
00132     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(2, (<span class="stringliteral">"(KeyType=%x,Key=%p)\n"</span>, KeyType, <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>));
00133 
00134     ExAcquireSpinLock(&amp;<a class="code" href="../../d0/d2/data_8c.html#a1">IoepErrListLock</a>, &amp;Irql);
00135     <span class="keywordflow">for</span> (list = <a class="code" href="../../d0/d2/data_8c.html#a2">IoepErrThreadListHead</a>.Flink;
00136          list != &amp;<a class="code" href="../../d0/d2/data_8c.html#a2">IoepErrThreadListHead</a>;
00137          list = list-&gt;Flink)
00138     {
00139         ErrThread = CONTAINING_RECORD(list, <a class="code" href="../../d9/d5/struct__errthread.html">ERRTHREAD</a>, list);
00140         <span class="keywordflow">if</span> (ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o2">ThreadKeyType</a> == KeyType)
00141         {
00142             <span class="keywordflow">switch</span> (KeyType)
00143             {
00144                 <span class="keywordflow">case</span> <a class="code" href="../../d6/d5/ioep_8h.html#a12">THREADKEY_IRP</a>:
00145                     <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>)<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> == ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o11">ThreadKey</a>.IrpKey.Irp)
00146                     {
00147                         <span class="keywordflow">break</span>;
00148                     }
00149                     <span class="keywordflow">else</span>
00150                     {
00151                         <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
00152 
00153                         IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>((<a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>)<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>);
00154                         <span class="keywordflow">if</span> ((IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> ==
00155                              ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o11">ThreadKey</a>.IrpKey.MajorFunction) &amp;&amp;
00156                             (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> ==
00157                              ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o11">ThreadKey</a>.IrpKey.MinorFunction) &amp;&amp;
00158                             RtlEqualMemory(&amp;IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Others,
00159                                            ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o11">ThreadKey</a>.IrpKey.Arguments,
00160                                            <span class="keyword">sizeof</span>(PVOID)*4) &amp;&amp;
00161                             (IopDbgGetLowestDevice(IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o57">DeviceObject</a>) ==
00162                              ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o11">ThreadKey</a>.IrpKey.TargetDevice))
00163                         {
00164                             <span class="keywordflow">break</span>;
00165                         }
00166                     }
00167                     <span class="keywordflow">break</span>;
00168 
00169                 <span class="keywordflow">case</span> <a class="code" href="../../d6/d5/ioep_8h.html#a13">THREADKEY_THREADID</a>:
00170                     <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>)<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> == ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o11">ThreadKey</a>.ThIDKey.ThreadID)
00171                     {
00172                         <span class="keywordflow">break</span>;
00173                     }
00174                     <span class="keywordflow">break</span>;
00175             }
00176         }
00177         ErrThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00178     }
00179     ExReleaseSpinLock(&amp;<a class="code" href="../../d0/d2/data_8c.html#a1">IoepErrListLock</a>, Irql);
00180 
00181     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(2, (<span class="stringliteral">"=%p\n"</span>, ErrThread));
00182     <span class="keywordflow">return</span> ErrThread;
00183 }       <span class="comment">//IoepFindErrThread</span>
00184 
00185 <a class="code" href="../../d9/d5/struct__errthread.html">PERRTHREAD</a>
<a name="l00186"></a><a class="code" href="../../d7/d5/ioerr_8c.html#a2">00186</a> <a class="code" href="../../d7/d5/ioerr_8c.html#a2">IoepNewErrThread</a>(
00187     IN ULONG KeyType,
00188     IN PVOID Key
00189     )
00190 <span class="comment">/*++</span>
00191 <span class="comment"></span>
00192 <span class="comment">Routine Description:</span>
00193 <span class="comment">    This routine creates a new error thread with a given key.</span>
00194 <span class="comment"></span>
00195 <span class="comment">Arguments:</span>
00196 <span class="comment">    KeyType - specifies the type of key.</span>
00197 <span class="comment">    Key - points to the key that is used to create the new logging session.</span>
00198 <span class="comment"></span>
00199 <span class="comment">Return Value:</span>
00200 <span class="comment">    Success - returns the error thread handle created.</span>
00201 <span class="comment">    Failure - returns NULL.</span>
00202 <span class="comment"></span>
00203 <span class="comment">--*/</span>
00204 {
00205     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoepNewErrThread"</span>);
00206     <a class="code" href="../../d9/d5/struct__errthread.html">PERRTHREAD</a> ErrThread;
00207 
00208     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(2, (<span class="stringliteral">"(KeyType=%x,Key=%p)\n"</span>, KeyType, <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>));
00209 
00210     ErrThread = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00211                                       <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d5/struct__errthread.html">ERRTHREAD</a>),
00212                                       <a class="code" href="../../d6/d5/ioep_8h.html#a1">IOETAG_ERRTHREAD</a>);
00213 
00214     <span class="keywordflow">if</span> (ErrThread != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00215     {
00216         <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
00217 
00218         InitializeListHead(&amp;ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o1">ErrLogListHead</a>);
00219         ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o2">ThreadKeyType</a> = KeyType;
00220 
00221         <span class="keywordflow">switch</span> (KeyType)
00222         {
00223             <span class="keywordflow">case</span> <a class="code" href="../../d6/d5/ioep_8h.html#a12">THREADKEY_IRP</a>:
00224                 IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>((<a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>)<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>);
00225                 ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o11">ThreadKey</a>.IrpKey.Irp = (<a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>)<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
00226                 ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o11">ThreadKey</a>.IrpKey.MajorFunction =
00227                     IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a>;
00228                 ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o11">ThreadKey</a>.IrpKey.MinorFunction =
00229                     IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a>;
00230                 RtlCopyMemory(ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o11">ThreadKey</a>.IrpKey.Arguments,
00231                               &amp;IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Others,
00232                               <span class="keyword">sizeof</span>(PVOID)*4);
00233                 ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o11">ThreadKey</a>.IrpKey.TargetDevice =
00234                     IopDbgGetLowestDevice(IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o57">DeviceObject</a>);
00235                 <span class="keywordflow">break</span>;
00236 
00237             <span class="keywordflow">case</span> <a class="code" href="../../d6/d5/ioep_8h.html#a13">THREADKEY_THREADID</a>:
00238                 ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o11">ThreadKey</a>.ThIDKey.ThreadID = (<a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>)<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
00239                 <span class="keywordflow">break</span>;
00240         }
00241         <a class="code" href="../../d5/d8/ex_8h.html#a237">ExInterlockedInsertHeadList</a>(&amp;<a class="code" href="../../d0/d2/data_8c.html#a2">IoepErrThreadListHead</a>,
00242                                     &amp;ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o0">list</a>,
00243                                     &amp;<a class="code" href="../../d0/d2/data_8c.html#a1">IoepErrListLock</a>);
00244     }
00245     <span class="keywordflow">else</span>
00246     {
00247         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to allocate error thread\n"</span>));
00248     }
00249 
00250     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(2, (<span class="stringliteral">"=%p\n"</span>, ErrThread));
00251     <span class="keywordflow">return</span> ErrThread;
00252 }       <span class="comment">//IoepNewErrThread</span>
00253 
00254 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00255"></a><a class="code" href="../../d7/d5/ioerr_8c.html#a3">00255</a> <a class="code" href="../../d7/d5/ioerr_8c.html#a3">IoepLogErr</a>(
00256     IN ULONG       KeyType,
00257     IN PVOID       Key,
00258     IN CONST GUID *ComponentGuid,
00259     IN ULONG       ErrCode,
00260     IN PWSTR       TextData OPTIONAL,
00261     IN ULONG       DataBlkType,
00262     IN ULONG       DataBlkLen OPTIONAL,
00263     IN PVOID       DataBlock OPTIONAL,
00264     IN CONST GUID *MofGuid OPTIONAL
00265     )
00266 <span class="comment">/*++</span>
00267 <span class="comment"></span>
00268 <span class="comment">Routine Description:</span>
00269 <span class="comment">    This routine logs the error data to the error log session identified by</span>
00270 <span class="comment">    the given key.</span>
00271 <span class="comment"></span>
00272 <span class="comment">Arguments:</span>
00273 <span class="comment">    KeyType - specifies the type of key.</span>
00274 <span class="comment">    Key - points to the key that is used to locate the logging session.</span>
00275 <span class="comment">    ComponentGuid - points to the component GUID of the caller</span>
00276 <span class="comment">    ErrCode - unique error code</span>
00277 <span class="comment">    TextData - points to an optional WSTR of text data</span>
00278 <span class="comment">    DataBlkType - data type of the data block</span>
00279 <span class="comment">    DataBlkLen - length of the data block</span>
00280 <span class="comment">    DataBlock - points to the data block</span>
00281 <span class="comment">    MofGuid - points to the MOF GUID of the data block if applicable</span>
00282 <span class="comment"></span>
00283 <span class="comment">Return Value:</span>
00284 <span class="comment">    None</span>
00285 <span class="comment"></span>
00286 <span class="comment">--*/</span>
00287 {
00288     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoepLogErr"</span>);
00289     <a class="code" href="../../d9/d5/struct__errthread.html">PERRTHREAD</a> ErrThread;
00290 
00291     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00292     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ComponentGuid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00293     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((DataBlkType == <a class="code" href="../../d5/d5/ioeapi_8h.html#a4">IOEDATA_NONE</a>) ||
00294            (DataBlkLen &gt; 0) &amp;&amp; (DataBlock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>));
00295     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DataBlkType &lt;= <a class="code" href="../../d5/d5/ioeapi_8h.html#a7">IOEDATA_MAX</a>);
00296     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(2, (<span class="stringliteral">"(KeyType=%x,Key=%p,pGuid=%p,ErrCode=%x,Text=%S,Type=%x,Len=%d,DataBlk=%p,MofGuid=%p)\n"</span>,
00297               KeyType, <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>, ComponentGuid, ErrCode, TextData? TextData: <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>,
00298               DataBlkType, DataBlkLen, DataBlock, MofGuid));
00299 
00300     ErrThread = <a class="code" href="../../d7/d5/ioerr_8c.html#a1">IoepFindErrThread</a>(KeyType, <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>);
00301     <span class="keywordflow">if</span> (ErrThread != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00302     {
00303         <a class="code" href="../../d1/d5/struct__errentry.html">PERRENTRY</a> Err;
00304 
00305         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!IsListEmpty(&amp;ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o1">ErrLogListHead</a>));
00306         Err = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00307                                     <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d5/struct__errentry.html">ERRENTRY</a>),
00308                                     <a class="code" href="../../d6/d5/ioep_8h.html#a2">IOETAG_ERRENTRY</a>);
00309 
00310         <span class="keywordflow">if</span> (Err != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00311         {
00312             BOOLEAN fOK = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00313             PVOID Data = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00314             PWSTR pwstr = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00315 
00316             RtlZeroMemory(Err, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d5/ioep_8h.html#a27">ERRENTRY</a>));
00317             <span class="keywordflow">if</span> (DataBlkType != <a class="code" href="../../d5/d5/ioeapi_8h.html#a4">IOEDATA_NONE</a>)
00318             {
00319                 Data = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00320                                              DataBlkLen,
00321                                              <a class="code" href="../../d6/d5/ioep_8h.html#a3">IOETAG_DATABLOCK</a>);
00322 
00323                 <span class="keywordflow">if</span> (Data != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00324                 {
00325                     RtlCopyMemory(Data, DataBlock, DataBlkLen);
00326                 }
00327                 <span class="keywordflow">else</span>
00328                 {
00329                     fOK = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00330                     <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to allocate data block (len=%d)\n"</span>,
00331                               DataBlkLen));
00332                 }
00333             }
00334             <span class="keywordflow">else</span>
00335             {
00336                 <span class="comment">//</span>
00337                 <span class="comment">// Make sure DataLen does not have garbage.</span>
00338                 <span class="comment">//</span>
00339                 DataBlkLen = 0;
00340             }
00341 
00342             <span class="keywordflow">if</span> (TextData != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00343             {
00344                 ULONG len;
00345 
00346                 len = wcslen(TextData)*<span class="keyword">sizeof</span>(WCHAR) + <span class="keyword">sizeof</span>(UNICODE_NULL);
00347                 pwstr = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00348                                               len,
00349                                               <a class="code" href="../../d6/d5/ioep_8h.html#a7">IOETAG_DATATEXT</a>);
00350 
00351                 <span class="keywordflow">if</span> (pwstr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00352                 {
00353                     RtlCopyMemory(pwstr, TextData, len);
00354                     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o2">unicodeStr</a>, pwstr);
00355                 }
00356                 <span class="keywordflow">else</span>
00357                 {
00358                     fOK = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00359                     <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to allocate text data (len=%d)\n"</span>,
00360                               len));
00361                 }
00362             }
00363 
00364             <span class="keywordflow">if</span> (fOK)
00365             {
00366                 <a class="code" href="../../d4/d5/struct__errlog.html">PERRLOG</a> ErrLog;
00367                 KIRQL Irql;
00368 
00369                 Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o1">ErrID</a>.<a class="code" href="../../d2/d5/struct__errid.html#o0">ComponentGuid</a> = *ComponentGuid;
00370                 Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o1">ErrID</a>.<a class="code" href="../../d2/d5/struct__errid.html#o1">ErrCode</a> = ErrCode;
00371                 Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o3">DataBlkType</a> = DataBlkType;
00372                 Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o4">DataBlkLen</a> = DataBlkLen;
00373                 Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o5">DataBlk</a> = Data;
00374                 <span class="keywordflow">if</span> (MofGuid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00375                 {
00376                     Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o6">MofGuid</a> = *MofGuid;
00377                 }
00378 
00379                 ExAcquireSpinLock(&amp;<a class="code" href="../../d0/d2/data_8c.html#a1">IoepErrListLock</a>, &amp;Irql);
00380                 ErrLog = CONTAINING_RECORD(ErrThread-&gt;<a class="code" href="../../d9/d5/struct__errthread.html#o1">ErrLogListHead</a>.Flink,
00381                                            <a class="code" href="../../d4/d5/struct__errlog.html">ERRLOG</a>,
00382                                            list);
00383                 PushEntryList(&amp;ErrLog-&gt;<a class="code" href="../../d4/d5/struct__errlog.html#o3">ErrStack</a>, &amp;Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o0">slist</a>);
00384                 ExReleaseSpinLock(&amp;<a class="code" href="../../d0/d2/data_8c.html#a1">IoepErrListLock</a>, Irql);
00385             }
00386             <span class="keywordflow">else</span>
00387             {
00388                 <span class="keywordflow">if</span> (Data != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00389                 {
00390                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Data);
00391                 }
00392                 <span class="keywordflow">if</span> (pwstr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00393                 {
00394                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pwstr);
00395                 }
00396                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Err);
00397             }
00398         }
00399         <span class="keywordflow">else</span>
00400         {
00401             <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to allocate error entry\n"</span>));
00402         }
00403     }
00404     <span class="keywordflow">else</span>
00405     {
00406         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to find associated error thread (Type=%x,Key=%p)\n"</span>,
00407                   KeyType, <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>));
00408     }
00409 
00410     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(2, (<span class="stringliteral">"!\n"</span>));
00411 }       <span class="comment">//IoepLogErr</span>
00412 
00413 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00414"></a><a class="code" href="../../d7/d5/ioerr_8c.html#a4">00414</a> <a class="code" href="../../d7/d5/ioerr_8c.html#a4">IoepFreeErrStack</a>(
00415     IN <a class="code" href="../../d1/d5/struct__errentry.html">PERRENTRY</a> ErrStack
00416     )
00417 <span class="comment">/*++</span>
00418 <span class="comment"></span>
00419 <span class="comment">Routine Description:</span>
00420 <span class="comment">    This routine frees an error stack and the associated data blocks.</span>
00421 <span class="comment"></span>
00422 <span class="comment">Arguments:</span>
00423 <span class="comment">    ErrStack - points to the error stack to be freed</span>
00424 <span class="comment"></span>
00425 <span class="comment">Return Value:</span>
00426 <span class="comment">    None</span>
00427 <span class="comment"></span>
00428 <span class="comment">--*/</span>
00429 {
00430     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoepFreeErrStack"</span>);
00431     <a class="code" href="../../d1/d5/struct__errentry.html">PERRENTRY</a> Err, ErrNext;
00432     KIRQL Irql;
00433 
00434     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ErrStack != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00435     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(2, (<span class="stringliteral">"(ErrStack=%p)\n"</span>, ErrStack));
00436 
00437     ExAcquireSpinLock(&amp;<a class="code" href="../../d0/d2/data_8c.html#a1">IoepErrListLock</a>, &amp;Irql);
00438     <span class="keywordflow">for</span> (Err = ErrStack; Err != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; Err = ErrNext)
00439     {
00440         <span class="keywordflow">if</span> (Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o5">DataBlk</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00441         {
00442             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o5">DataBlk</a>);
00443             Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o5">DataBlk</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00444         }
00445         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o2">unicodeStr</a>);
00446         ErrNext = <a class="code" href="../../d6/d5/ioep_8h.html#a26">IoepGetNextErrEntry</a>(Err);
00447         Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o0">slist</a>.Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00448         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Err);
00449     }
00450     ExReleaseSpinLock(&amp;<a class="code" href="../../d0/d2/data_8c.html#a1">IoepErrListLock</a>, Irql);
00451 
00452     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(2, (<span class="stringliteral">"!\n"</span>));
00453 }       <span class="comment">//IoepFreeErrStack</span>
00454 
00455 <a class="code" href="../../d5/d5/struct__errmodule.html">PERRMODULE</a>
<a name="l00456"></a><a class="code" href="../../d7/d5/ioerr_8c.html#a5">00456</a> <a class="code" href="../../d7/d5/ioerr_8c.html#a5">IoepFindErrModule</a>(
00457     IN CONST GUID *ComponentGuid
00458     )
00459 <span class="comment">/*++</span>
00460 <span class="comment"></span>
00461 <span class="comment">Routine Description:</span>
00462 <span class="comment">    This routine finds a registered error module with a given module GUID.</span>
00463 <span class="comment"></span>
00464 <span class="comment">Arguments:</span>
00465 <span class="comment">    ComponentGuid - points to the GUID of the error module</span>
00466 <span class="comment"></span>
00467 <span class="comment">Return Value:</span>
00468 <span class="comment">    Success - returns pointer to error module found</span>
00469 <span class="comment">    Failure - returns NULL</span>
00470 <span class="comment"></span>
00471 <span class="comment">--*/</span>
00472 {
00473     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoepFindErrModule"</span>);
00474     <a class="code" href="../../d5/d5/struct__errmodule.html">PERRMODULE</a> ErrModule = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00475     PLIST_ENTRY list;
00476     KIRQL Irql;
00477 
00478     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(2, (<span class="stringliteral">"(pGuid=%p)\n"</span>, ComponentGuid));
00479 
00480     ExAcquireSpinLock(&amp;<a class="code" href="../../d0/d2/data_8c.html#a1">IoepErrListLock</a>, &amp;Irql);
00481     <span class="keywordflow">for</span> (list = <a class="code" href="../../d0/d2/data_8c.html#a3">IoepErrModuleListHead</a>.Flink;
00482          list != &amp;<a class="code" href="../../d0/d2/data_8c.html#a3">IoepErrModuleListHead</a>;
00483          list = list-&gt;Flink)
00484     {
00485         ErrModule = CONTAINING_RECORD(list, <a class="code" href="../../d5/d5/struct__errmodule.html">ERRMODULE</a>, list);
00486         <span class="keywordflow">if</span> (RtlEqualMemory(&amp;ErrModule-&gt;<a class="code" href="../../d5/d5/struct__errmodule.html#o1">ComponentGuid</a>,
00487                            ComponentGuid,
00488                            <span class="keyword">sizeof</span>(GUID)))
00489         {
00490             <span class="keywordflow">break</span>;
00491         }
00492         ErrModule = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00493     }
00494     ExReleaseSpinLock(&amp;<a class="code" href="../../d0/d2/data_8c.html#a1">IoepErrListLock</a>, Irql);
00495 
00496     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(2, (<span class="stringliteral">"=%p\n"</span>, ErrModule));
00497     <span class="keywordflow">return</span> ErrModule;
00498 }       <span class="comment">//IoepFindErrModule</span>
00499 
00500 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00501"></a><a class="code" href="../../d7/d5/ioerr_8c.html#a6">00501</a> <a class="code" href="../../d7/d5/ioerr_8c.html#a6">IoepExtractErrData</a>(
00502     IN <a class="code" href="../../d1/d5/struct__errentry.html">PERRENTRY</a> ErrStack,
00503     OUT PVOID    Buffer,
00504     IN  ULONG    BuffSize,
00505     OUT PULONG   DataSize OPTIONAL
00506     )
00507 <span class="comment">/*++</span>
00508 <span class="comment"></span>
00509 <span class="comment">Routine Description:</span>
00510 <span class="comment">    This routine stores the error stack data into a flat buffer.</span>
00511 <span class="comment"></span>
00512 <span class="comment">Arguments:</span>
00513 <span class="comment">    ErrStack - points to the error stack</span>
00514 <span class="comment">    Buffer - points to the buffer for the data</span>
00515 <span class="comment">    BuffSize - specifies the buffer size</span>
00516 <span class="comment">    DataSize - points to the variable to receive the actual data size</span>
00517 <span class="comment"></span>
00518 <span class="comment">Return Value:</span>
00519 <span class="comment">    Success - returns STATUS_SUCCESS</span>
00520 <span class="comment">    Failure - returns NT status code</span>
00521 <span class="comment"></span>
00522 <span class="comment">--*/</span>
00523 {
00524     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoepExtractErrData"</span>);
00525     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00526     <a class="code" href="../../d1/d5/struct__errentry.html">PERRENTRY</a> Err;
00527     ULONG len, i;
00528 
00529     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ErrStack != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00530     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (BuffSize &gt; 0) || (DataSize != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>));
00531     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(2, (<span class="stringliteral">"(ErrStack=%p,Buff=%p,BuffSize=%d,pDataSize=%p)\n"</span>,
00532               ErrStack, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, BuffSize, DataSize));
00533 
00534     <span class="keywordflow">for</span> (Err = ErrStack, len = <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d5/struct__errinfo.html">ERRINFO</a>) - <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/struct__errdata.html">ERRDATA</a>), i = 0;
00535          Err != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00536          Err = <a class="code" href="../../d6/d5/ioep_8h.html#a26">IoepGetNextErrEntry</a>(Err), i++)
00537     {
00538         len += <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/struct__errdata.html">ERRDATA</a>) +
00539                Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o4">DataBlkLen</a> +
00540                Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o2">unicodeStr</a>.MaximumLength;
00541     }
00542 
00543     <span class="keywordflow">if</span> (len &lt;= BuffSize)
00544     {
00545         <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (len &gt; 0))
00546         {
00547             <a class="code" href="../../d3/d5/struct__errinfo.html">PERRINFO</a> ErrInfo = (<a class="code" href="../../d3/d5/struct__errinfo.html">PERRINFO</a>)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00548             PUCHAR pBuff;
00549 
00550             ErrInfo-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o0">Signature</a> = <a class="code" href="../../d5/d5/ioeapi_8h.html#a12">SIG_ERRINFO</a>;
00551             ErrInfo-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o1">Version</a> = <a class="code" href="../../d6/d5/ioep_8h.html#a18">IOE_ERRINFO_VERSION</a>;
00552             ErrInfo-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o2">Size</a> = len;
00553             ErrInfo-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o3">DataTag</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00554             ErrInfo-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o4">TagFlags</a> = 0;
00555             ErrInfo-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o5">NumErrEntries</a> = i;
00556             pBuff = (PUCHAR)ErrInfo + <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d5/struct__errinfo.html">ERRINFO</a>) + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/struct__errdata.html">ERRDATA</a>)*(i - 1);
00557             <span class="keywordflow">for</span> (Err = ErrStack, i = 0;
00558                  Err != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00559                  Err = <a class="code" href="../../d6/d5/ioep_8h.html#a26">IoepGetNextErrEntry</a>(Err), i++)
00560             {
00561                 ErrInfo-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o6">ErrEntries</a>[i].<a class="code" href="../../d0/d5/struct__errdata.html#o0">ErrID</a> = Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o1">ErrID</a>;
00562                 ErrInfo-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o6">ErrEntries</a>[i].<a class="code" href="../../d0/d5/struct__errdata.html#o2">DataBlkType</a> = Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o3">DataBlkType</a>;
00563                 ErrInfo-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o6">ErrEntries</a>[i].<a class="code" href="../../d0/d5/struct__errdata.html#o3">DataBlkLen</a> = Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o4">DataBlkLen</a>;
00564                 ErrInfo-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o6">ErrEntries</a>[i].<a class="code" href="../../d0/d5/struct__errdata.html#o5">MofGuid</a> = Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o6">MofGuid</a>;
00565 
00566                 <span class="keywordflow">if</span> (Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o2">unicodeStr</a>.MaximumLength &gt; 0)
00567                 {
00568                     ErrInfo-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o6">ErrEntries</a>[i].<a class="code" href="../../d0/d5/struct__errdata.html#o1">TextDataOffset</a> = pBuff -
00569                                                             (PUCHAR)ErrInfo;
00570                     RtlCopyMemory(pBuff,
00571                                   Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o2">unicodeStr</a>.Buffer,
00572                                   Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o2">unicodeStr</a>.MaximumLength);
00573                     pBuff += Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o2">unicodeStr</a>.MaximumLength;
00574                 }
00575                 <span class="keywordflow">else</span>
00576                 {
00577                     ErrInfo-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o6">ErrEntries</a>[i].<a class="code" href="../../d0/d5/struct__errdata.html#o1">TextDataOffset</a> = 0;
00578                 }
00579 
00580                 <span class="keywordflow">if</span> (Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o5">DataBlk</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00581                 {
00582                     ErrInfo-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o6">ErrEntries</a>[i].<a class="code" href="../../d0/d5/struct__errdata.html#o4">DataBlkOffset</a> = pBuff -
00583                                                            (PUCHAR)ErrInfo;
00584                     RtlCopyMemory(pBuff, Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o5">DataBlk</a>, Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o4">DataBlkLen</a>);
00585                     pBuff += Err-&gt;<a class="code" href="../../d1/d5/struct__errentry.html#o4">DataBlkLen</a>;
00586                 }
00587                 <span class="keywordflow">else</span>
00588                 {
00589                     ErrInfo-&gt;<a class="code" href="../../d3/d5/struct__errinfo.html#o6">ErrEntries</a>[i].<a class="code" href="../../d0/d5/struct__errdata.html#o4">DataBlkOffset</a> = 0;
00590                 }
00591             }
00592         }
00593 
00594         status = STATUS_SUCCESS;
00595     }
00596     <span class="keywordflow">else</span>
00597     {
00598         status = STATUS_BUFFER_TOO_SMALL;
00599         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"buffer too small (size=%d,need=%d)\n"</span>, BuffSize, len));
00600     }
00601 
00602     <span class="keywordflow">if</span> (DataSize != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00603     {
00604         *DataSize = len;
00605     }
00606 
00607     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(2, (<span class="stringliteral">"=%x(len=%d)\n"</span>, status, len));
00608     <span class="keywordflow">return</span> status;
00609 }       <span class="comment">//IoepExtractErrData</span>
00610 
00611 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00612"></a><a class="code" href="../../d7/d5/ioerr_8c.html#a7">00612</a> <a class="code" href="../../d7/d5/ioerr_8c.html#a7">IoepFireWMIEvent</a>(
00613     IN <a class="code" href="../../d3/d5/struct__errinfo.html">PERRINFO</a> ErrInfo,
00614     IN PWSTR    InstanceName
00615     )
00616 <span class="comment">/*++</span>
00617 <span class="comment"></span>
00618 <span class="comment">Routine Description:</span>
00619 <span class="comment">    This routine fires a WMI event notifying the availability of an error info.</span>
00620 <span class="comment"></span>
00621 <span class="comment">Arguments:</span>
00622 <span class="comment">    ErrInfo - points to the error info.</span>
00623 <span class="comment">    InstanceName - points to the instance name string</span>
00624 <span class="comment"></span>
00625 <span class="comment">Return Value:</span>
00626 <span class="comment">    Success - returns STATUS_SUCCESS</span>
00627 <span class="comment">    Failure - returns NT status code</span>
00628 <span class="comment"></span>
00629 <span class="comment">--*/</span>
00630 {
00631     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoepFireWMIEvent"</span>);
00632     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00633 
00634     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(2, (<span class="stringliteral">"(ErrInfo=%p,InstanceName=%S)\n"</span>, ErrInfo, InstanceName));
00635 
00636     <span class="keywordflow">if</span> (ErrInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00637     {
00638         ULONG NameLen, EventSize;
00639         PWNODE_SINGLE_INSTANCE event;
00640 
00641         NameLen = wcslen(InstanceName)*<span class="keyword">sizeof</span>(WCHAR) + <span class="keyword">sizeof</span>(UNICODE_NULL);
00642         EventSize = <span class="keyword">sizeof</span>(WNODE_SINGLE_INSTANCE) + NameLen + ErrInfo-&gt;Size;
00643         event = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00644                                       EventSize,
00645                                       <a class="code" href="../../d6/d5/ioep_8h.html#a11">IOETAG_WMIEVENT</a>);
00646         <span class="keywordflow">if</span> (event != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00647         {
00648             event-&gt;WnodeHeader.BufferSize = EventSize;
00649             event-&gt;WnodeHeader.ProviderId = 0;
00650             event-&gt;WnodeHeader.Guid = <a class="code" href="../../d0/d2/data_8c.html#a0">IoepGuid</a>;
00651             event-&gt;WnodeHeader.Flags = WNODE_FLAG_SINGLE_INSTANCE |
00652                                        WNODE_FLAG_EVENT_ITEM;
00653             <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;event-&gt;WnodeHeader.TimeStamp);
00654             event-&gt;OffsetInstanceName = <span class="keyword">sizeof</span>(WNODE_SINGLE_INSTANCE);
00655             event-&gt;DataBlockOffset = <span class="keyword">sizeof</span>(WNODE_SINGLE_INSTANCE) + NameLen;
00656             event-&gt;SizeDataBlock = ErrInfo-&gt;Size;
00657             RtlCopyMemory(&amp;event-&gt;VariableData, InstanceName, NameLen);
00658             RtlCopyMemory(event-&gt;VariableData + NameLen,
00659                           ErrInfo,
00660                           ErrInfo-&gt;Size);
00661             status = <a class="code" href="../../d0/d5/io_8h.html#a575">IoWMIWriteEvent</a>(event);
00662         }
00663         <span class="keywordflow">else</span>
00664         {
00665             status = STATUS_INSUFFICIENT_RESOURCES;
00666             <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to allocate WMI event node (len=%d)\n"</span>,
00667                       EventSize));
00668         }
00669     }
00670     <span class="keywordflow">else</span>
00671     {
00672         status = STATUS_SUCCESS;
00673     }
00674 
00675     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(2, (<span class="stringliteral">"=%x\n"</span>, status));
00676     <span class="keywordflow">return</span> status;
00677 }       <span class="comment">//IoepFireWMIEvent</span>
00678 
00679 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00680"></a><a class="code" href="../../d7/d5/ioerr_8c.html#a8">00680</a> <a class="code" href="../../d7/d5/ioerr_8c.html#a8">IoepHandleErrCase</a>(
00681     IN <a class="code" href="../../d3/d5/struct__errinfo.html">PERRINFO</a> ErrInfo,
00682     IN <a class="code" href="../../d8/d4/struct__errcase.html">PERRCASE</a> ErrCase,
00683     IN ULONG    Method,
00684     OUT PUNICODE_STRING unicodeMsg OPTIONAL
00685     )
00686 <span class="comment">/*++</span>
00687 <span class="comment"></span>
00688 <span class="comment">Routine Description:</span>
00689 <span class="comment">    This routine handles an error case by executing the resolution method.</span>
00690 <span class="comment"></span>
00691 <span class="comment">Arguments:</span>
00692 <span class="comment">    ErrInfo - points to the error info</span>
00693 <span class="comment">    ErrCase - points to the error case</span>
00694 <span class="comment">    Method - specifying what method to use to handle the error case</span>
00695 <span class="comment">    unicodeMsg - point to unicodeStr to receive the error message</span>
00696 <span class="comment"></span>
00697 <span class="comment">Return Value:</span>
00698 <span class="comment">    Success - returns STATUS_SUCCESS</span>
00699 <span class="comment">    Failure - returns NT status code</span>
00700 <span class="comment"></span>
00701 <span class="comment">--*/</span>
00702 {
00703     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoepHandleErrCase"</span>);
00704     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00705     <a class="code" href="../../d9/d4/struct__errcasedb.html">PERRCASEDB</a> ErrCaseDB;
00706 
00707     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00708     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(2, (<span class="stringliteral">"(ErrInfo=%p,ErrCase=%p,Method=%x,unicodeMsg=%p)\n"</span>,
00709               ErrInfo, ErrCase, Method, unicodeMsg));
00710 
00711     ErrCaseDB = <a class="code" href="../../d7/d5/ioerr_8c.html#a14">IoepGetErrCaseDB</a>();
00712     <span class="keywordflow">if</span> (ErrCaseDB != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00713     {
00714         <a class="code" href="../../d4/d8/struct__method.html">PMETHOD</a> MethodTable;
00715         ULONG i;
00716         PVOID MethodData;
00717         UNICODE_STRING unicodeStr;
00718         <a class="code" href="../../d5/d5/ioeapi_8h.html#a22">PERRHANDLER</a> ErrHandler;
00719         PWSTR MsgTemplate;
00720 
00721         MethodTable = (<a class="code" href="../../d4/d8/struct__method.html">PMETHOD</a>)((ULONG_PTR)ErrCaseDB +
00722                                 ErrCaseDB-&gt;<a class="code" href="../../d9/d4/struct__errcasedb.html#o7">DataBlkOffset</a> +
00723                                 ErrCase-&gt;MethodOffset);
00724 
00725         <span class="keywordflow">for</span> (i = 0, status = STATUS_NOT_FOUND;
00726              (status == STATUS_NOT_FOUND) &amp;&amp; (i &lt; ErrCase-&gt;NumMethods);
00727              ++i)
00728         {
00729             <span class="keywordflow">if</span> ((Method != <a class="code" href="../../d6/d5/ioep_8h.html#a14">IOEMETHOD_ANY</a>) &amp;&amp;
00730                 (Method != MethodTable[i].<a class="code" href="../../d4/d8/struct__method.html#o0">MethodType</a>))
00731             {
00732                 <span class="keywordflow">continue</span>;
00733             }
00734 
00735             MethodData = (PVOID)((ULONG_PTR)ErrCaseDB +
00736                                  ErrCaseDB-&gt;<a class="code" href="../../d9/d4/struct__errcasedb.html#o7">DataBlkOffset</a> +
00737                                  MethodTable[i].<a class="code" href="../../d4/d8/struct__method.html#o1">MethodDataOffset</a>);
00738 
00739             <span class="keywordflow">switch</span> (MethodTable[i].<a class="code" href="../../d4/d8/struct__method.html#o0">MethodType</a>)
00740             {
00741                 <span class="keywordflow">case</span> <a class="code" href="../../d6/d5/ioep_8h.html#a15">IOEMETHOD_LONGMSG</a>:
00742                     status = <a class="code" href="../../d7/d5/ioerr_8c.html#a11">IoepGetErrMessage</a>((<a class="code" href="../../d8/d9/struct__msgdata.html">PMSGDATA</a>)MethodData,
00743                                                ErrInfo,
00744                                                unicodeMsg? unicodeMsg:
00745                                                            &amp;unicodeStr);
00746 
00747                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; (unicodeMsg == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))
00748                     {
00749                         <a class="code" href="../../d4/d6/iosubs_8c.html#a94">IoRaiseInformationalHardError</a>(<a class="code" href="../../d5/d5/ioeapi_8h.html#a0">STATUS_IOE_MESSAGE</a>,
00750                                                       &amp;unicodeStr,
00751                                                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00752                         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeStr);
00753                     }
00754                     <span class="keywordflow">break</span>;
00755 
00756                 <span class="keywordflow">case</span> <a class="code" href="../../d6/d5/ioep_8h.html#a16">IOEMETHOD_SHORTMSG</a>:
00757                     MsgTemplate =
00758                         (PWSTR)((ULONG_PTR)ErrCaseDB +
00759                                 ErrCaseDB-&gt;<a class="code" href="../../d9/d4/struct__errcasedb.html#o7">DataBlkOffset</a> +
00760                                 ((<a class="code" href="../../d8/d9/struct__msgdata.html">PMSGDATA</a>)MethodData)-&gt;MsgTemplateOffset);
00761 
00762                     <span class="keywordflow">if</span> (unicodeMsg == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00763                     {
00764                         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeStr, MsgTemplate);
00765                         <a class="code" href="../../d4/d6/iosubs_8c.html#a94">IoRaiseInformationalHardError</a>(<a class="code" href="../../d5/d5/ioeapi_8h.html#a0">STATUS_IOE_MESSAGE</a>,
00766                                                       &amp;unicodeStr,
00767                                                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00768                         status = STATUS_SUCCESS;
00769                     }
00770                     <span class="keywordflow">else</span>
00771                     {
00772                         ULONG len;
00773                         PWSTR pwstr;
00774 
00775                         len = wcslen(MsgTemplate)*<span class="keyword">sizeof</span>(WCHAR) +
00776                               <span class="keyword">sizeof</span>(UNICODE_NULL);
00777                         pwstr = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00778                                                       len,
00779                                                       <a class="code" href="../../d6/d5/ioep_8h.html#a8">IOETAG_DATAWSTR</a>);
00780                         <span class="keywordflow">if</span> (pwstr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00781                         {
00782                             RtlCopyMemory(pwstr, MsgTemplate, len);
00783                             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(unicodeMsg, pwstr);
00784                             status = STATUS_SUCCESS;
00785                         }
00786                         <span class="keywordflow">else</span>
00787                         {
00788                             status = STATUS_INSUFFICIENT_RESOURCES;
00789                             <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to allocate short message buffer (len=%d)\n"</span>,
00790                                       len));
00791                         }
00792                     }
00793                     <span class="keywordflow">break</span>;
00794 
00795                 <span class="keywordflow">case</span> <a class="code" href="../../d6/d5/ioep_8h.html#a17">IOEMETHOD_HANDLER</a>:
00796                     ErrHandler = <a class="code" href="../../d7/d5/ioerr_8c.html#a9">IoepFindErrHandler</a>(
00797                                     &amp;((<a class="code" href="../../d5/d4/struct__handlerdata.html">PHANDLERDATA</a>)MethodData)-&gt;ComponentGuid,
00798                                     ((<a class="code" href="../../d5/d4/struct__handlerdata.html">PHANDLERDATA</a>)MethodData)-&gt;HandlerIndex);
00799 
00800                     <span class="keywordflow">if</span> (ErrHandler != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00801                     {
00802                         status = ErrHandler(ErrInfo,
00803                                             ((<a class="code" href="../../d5/d4/struct__handlerdata.html">PHANDLERDATA</a>)MethodData)-&gt;Param);
00804                     }
00805                     <span class="keywordflow">break</span>;
00806 
00807                 <span class="keywordflow">default</span>:
00808                     <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"invalid method type %d\n"</span>,
00809                               MethodTable[i].MethodType));
00810             }
00811         }
00812     }
00813     <span class="keywordflow">else</span>
00814     {
00815         status = <a class="code" href="../../d5/d5/ioeapi_8h.html#a2">STATUS_IOE_DATABASE_NOT_READY</a>;
00816         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"error case database not ready\n"</span>));
00817     }
00818 
00819     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(2, (<span class="stringliteral">"=%x\n"</span>, status));
00820     <span class="keywordflow">return</span> status;
00821 }       <span class="comment">//IoepHandleErrCase</span>
00822 
00823 <a class="code" href="../../d5/d5/ioeapi_8h.html#a22">PERRHANDLER</a>
<a name="l00824"></a><a class="code" href="../../d7/d5/ioerr_8c.html#a9">00824</a> <a class="code" href="../../d7/d5/ioerr_8c.html#a9">IoepFindErrHandler</a>(
00825     IN CONST GUID *ComponentGuid,
00826     IN ULONG       HandlerIndex
00827     )
00828 <span class="comment">/*++</span>
00829 <span class="comment"></span>
00830 <span class="comment">Routine Description:</span>
00831 <span class="comment">    This routine find the error handler with the given module GUID and</span>
00832 <span class="comment">    handler index.</span>
00833 <span class="comment"></span>
00834 <span class="comment">Arguments:</span>
00835 <span class="comment">    ComponentGuid - points to the GUID of the handler module</span>
00836 <span class="comment">    HandlerIndex - index into handler table</span>
00837 <span class="comment"></span>
00838 <span class="comment">Return Value:</span>
00839 <span class="comment">    Success - returns pointer to error handler found</span>
00840 <span class="comment">    Failure - returns NULL</span>
00841 <span class="comment"></span>
00842 <span class="comment">--*/</span>
00843 {
00844     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoepFindErrHandler"</span>);
00845     <a class="code" href="../../d5/d5/ioeapi_8h.html#a22">PERRHANDLER</a> ErrHandler = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00846     <a class="code" href="../../d5/d5/struct__errmodule.html">PERRMODULE</a> ErrModule;
00847 
00848     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(2, (<span class="stringliteral">"(pGuid=%p,Index=%x)\n"</span>, ComponentGuid, HandlerIndex));
00849 
00850     ErrModule = <a class="code" href="../../d7/d5/ioerr_8c.html#a5">IoepFindErrModule</a>(ComponentGuid);
00851 
00852     <span class="keywordflow">if</span> ((ErrModule != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (HandlerIndex &lt; ErrModule-&gt;<a class="code" href="../../d5/d5/struct__errmodule.html#o2">NumErrHandlers</a>))
00853     {
00854         ErrHandler = ErrModule-&gt;<a class="code" href="../../d5/d5/struct__errmodule.html#o3">HandlerTable</a>[HandlerIndex];
00855     }
00856 
00857     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(2, (<span class="stringliteral">"=%p\n"</span>, ErrHandler));
00858     <span class="keywordflow">return</span> ErrHandler;
00859 }       <span class="comment">//IoepFindErrHandler</span>
00860 
00861 BOOLEAN
<a name="l00862"></a><a class="code" href="../../d7/d5/ioerr_8c.html#a10">00862</a> <a class="code" href="../../d7/d5/ioerr_8c.html#a10">IoepMatchErrIDPath</a>(
00863     IN <a class="code" href="../../d3/d5/struct__errinfo.html">PERRINFO</a> ErrInfo,
00864     IN <a class="code" href="../../d2/d5/struct__errid.html">PERRID</a>   ErrIDPath,
00865     IN ULONG    NumErrIDs
00866     )
00867 <span class="comment">/*++</span>
00868 <span class="comment"></span>
00869 <span class="comment">Routine Description:</span>
00870 <span class="comment">    This routine compares the error ID paths for a match.</span>
00871 <span class="comment"></span>
00872 <span class="comment">Arguments:</span>
00873 <span class="comment">    ErrInfo - points to the error info buffer</span>
00874 <span class="comment">    ErrIDPath - points to the error ID path of the error case</span>
00875 <span class="comment">    NumErrIDs - number of error IDs in the path</span>
00876 <span class="comment"></span>
00877 <span class="comment">Return Value:</span>
00878 <span class="comment">    Success - returns TRUE: matched</span>
00879 <span class="comment">    Failure - returns FALSE: no match</span>
00880 <span class="comment"></span>
00881 <span class="comment">--*/</span>
00882 {
00883     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoepMatchErrIDPath"</span>);
00884     BOOLEAN rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00885     BOOLEAN fWildCard = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00886     ULONG i, j;
00887 
00888     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00889     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(2, (<span class="stringliteral">"(ErrInfo=%p,pErrID=%p,NumIDs=%d)\n"</span>,
00890               ErrInfo, ErrIDPath, NumErrIDs));
00891 
00892     <span class="keywordflow">for</span> (i = j = 0; (i &lt; NumErrIDs) &amp;&amp; (j &lt; ErrInfo-&gt;NumErrEntries);)
00893     {
00894         <span class="keywordflow">if</span> (ErrIDPath[i].ErrCode == 0)
00895         {
00896             fWildCard = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00897             i++;
00898         }
00899         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (RtlEqualMemory(&amp;ErrIDPath[i].ComponentGuid,
00900                                 &amp;ErrInfo-&gt;ErrEntries[j].ErrID.ComponentGuid,
00901                                 <span class="keyword">sizeof</span>(GUID)) &amp;&amp;
00902                  (ErrIDPath[i].ErrCode == ErrInfo-&gt;ErrEntries[j].ErrID.ErrCode))
00903         {
00904             i++;
00905             j++;
00906             fWildCard = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00907         }
00908         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fWildCard)
00909         {
00910             j++;
00911         }
00912         <span class="keywordflow">else</span>
00913         {
00914             rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00915             <span class="keywordflow">break</span>;
00916         }
00917     }
00918 
00919     <span class="keywordflow">if</span> ((rc == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp; (i &lt; NumErrIDs))
00920     {
00921         <span class="comment">//</span>
00922         <span class="comment">// The database ID path is longer than the error stack ID path.</span>
00923         <span class="comment">// This is not a good match, so let's move on to find another match.</span>
00924         <span class="comment">// However, the reverse is OK though (i.e. error stack ID path is</span>
00925         <span class="comment">// longer than the database ID path).  In this case, the database</span>
00926         <span class="comment">// ID path has an implicit wild card at the end.</span>
00927         <span class="comment">//</span>
00928         rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00929     }
00930 
00931     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(2, (<span class="stringliteral">"=%x\n"</span>, rc));
00932     <span class="keywordflow">return</span> rc;
00933 }       <span class="comment">//IoepMatchErrIDPath</span>
00934 
00935 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00936"></a><a class="code" href="../../d7/d5/ioerr_8c.html#a11">00936</a> <a class="code" href="../../d7/d5/ioerr_8c.html#a11">IoepGetErrMessage</a>(
00937     IN  <a class="code" href="../../d8/d9/struct__msgdata.html">PMSGDATA</a>        MsgData,
00938     IN  <a class="code" href="../../d3/d5/struct__errinfo.html">PERRINFO</a>        ErrInfo,
00939     OUT PUNICODE_STRING unicodeMsg
00940     )
00941 <span class="comment">/*++</span>
00942 <span class="comment"></span>
00943 <span class="comment">Routine Description:</span>
00944 <span class="comment">    This routine constructs the error message from the message method data.</span>
00945 <span class="comment"></span>
00946 <span class="comment">Arguments:</span>
00947 <span class="comment">    MsgData - points to the message method data</span>
00948 <span class="comment">    ErrInfo - points to the error info</span>
00949 <span class="comment">    unicodeMsg - points to the uninitialized unicode string message buffer</span>
00950 <span class="comment"></span>
00951 <span class="comment">Return Value:</span>
00952 <span class="comment">    Success - returns STATUS_SUCCESS</span>
00953 <span class="comment">    Failure - returns NT status code</span>
00954 <span class="comment"></span>
00955 <span class="comment">Note:</span>
00956 <span class="comment">    This routine will allocate the actual string buffer of the unicode message.</span>
00957 <span class="comment">    Therefore, it is the caller's responsibility to free the message buffer</span>
00958 <span class="comment">    via RtlFreeUnicodeString.</span>
00959 <span class="comment"></span>
00960 <span class="comment">--*/</span>
00961 {
00962     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoepGetErrMessage"</span>);
00963     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
00964     <a class="code" href="../../d9/d4/struct__errcasedb.html">PERRCASEDB</a> ErrCaseDB;
00965 
00966     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00967     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(2, (<span class="stringliteral">"(pMsgData=%p,ErrInfo=%p,pMsg=%p)\n"</span>,
00968               MsgData, ErrInfo, unicodeMsg));
00969 
00970     ErrCaseDB = <a class="code" href="../../d7/d5/ioerr_8c.html#a14">IoepGetErrCaseDB</a>();
00971     <span class="keywordflow">if</span> (ErrCaseDB != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00972     {
00973         PWSTR MsgTemplate, MsgBuff, pwstr;
00974 
00975         MsgTemplate = (PWSTR)((ULONG_PTR)ErrCaseDB +
00976                               ErrCaseDB-&gt;<a class="code" href="../../d9/d4/struct__errcasedb.html#o7">DataBlkOffset</a> +
00977                               MsgData-&gt;MsgTemplateOffset);
00978 
00979         MsgBuff = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00980                                         <span class="keyword">sizeof</span>(WCHAR)*<a class="code" href="../../d5/d5/ioeapi_8h.html#a3">MAX_MSG_LEN</a> +
00981                                         <span class="keyword">sizeof</span>(UNICODE_NULL),
00982                                         <a class="code" href="../../d6/d5/ioep_8h.html#a5">IOETAG_MSGBUFF</a>);
00983 
00984         <span class="keywordflow">if</span> (MsgBuff != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00985         {
00986             MsgBuff[0] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00987             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(unicodeMsg, MsgBuff);
00988             unicodeMsg-&gt;MaximumLength = <span class="keyword">sizeof</span>(WCHAR)*<a class="code" href="../../d5/d5/ioeapi_8h.html#a3">MAX_MSG_LEN</a> +
00989                                         <span class="keyword">sizeof</span>(UNICODE_NULL);
00990 
00991             <span class="keywordflow">while</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
00992             {
00993                 pwstr = wcschr(MsgTemplate, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'%'</span>);
00994                 <span class="keywordflow">if</span> (pwstr == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00995                 {
00996                     status = <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(unicodeMsg, MsgTemplate);
00997                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
00998                     {
00999                         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to append unicode string (rc=%x)\n"</span>,
01000                                   status));
01001                     }
01002                     <span class="keywordflow">break</span>;
01003                 }
01004                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pwstr[1] &gt;= <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'0'</span>) &amp;&amp; (pwstr[1] &lt;= <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'9'</span>))
01005                 {
01006                     ULONG ArgIndex;
01007                     PWSTR pwstr2;
01008 
01009                     ArgIndex = wcstoul(&amp;pwstr[1], &amp;pwstr2, 10);
01010                     status = <a class="code" href="../../d7/d5/ioerr_8c.html#a13">IoepUnicodeStringCatN</a>(unicodeMsg,
01011                                                    MsgTemplate,
01012                                                    pwstr - MsgTemplate);
01013                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
01014                     {
01015                         MsgTemplate = pwstr2;
01016                         status = <a class="code" href="../../d7/d5/ioerr_8c.html#a12">IoepCatMsgArg</a>(unicodeMsg,
01017                                                &amp;MsgData-&gt;Args[ArgIndex],
01018                                                ErrInfo);
01019                     }
01020                 }
01021                 <span class="keywordflow">else</span>
01022                 {
01023                     pwstr++;
01024                     status = <a class="code" href="../../d7/d5/ioerr_8c.html#a13">IoepUnicodeStringCatN</a>(unicodeMsg,
01025                                                    MsgTemplate,
01026                                                    pwstr - MsgTemplate);
01027                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
01028                     {
01029                         MsgTemplate = pwstr;
01030                     }
01031                 }
01032             }
01033         }
01034         <span class="keywordflow">else</span>
01035         {
01036             status = STATUS_INSUFFICIENT_RESOURCES;
01037             <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to allocate message buffer\n"</span>));
01038         }
01039     }
01040     <span class="keywordflow">else</span>
01041     {
01042         status = <a class="code" href="../../d5/d5/ioeapi_8h.html#a2">STATUS_IOE_DATABASE_NOT_READY</a>;
01043         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"error case database not ready\n"</span>));
01044     }
01045 
01046     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(2, (<span class="stringliteral">"=%x(Msg=%S)\n"</span>,
01047              status, unicodeMsg-&gt;Buffer? unicodeMsg-&gt;Buffer: <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>));
01048     <span class="keywordflow">return</span> status;
01049 }       <span class="comment">//IoepGetErrMessage</span>
01050 
01051 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01052"></a><a class="code" href="../../d7/d5/ioerr_8c.html#a12">01052</a> <a class="code" href="../../d7/d5/ioerr_8c.html#a12">IoepCatMsgArg</a>(
01053     IN OUT PUNICODE_STRING unicodeMsg,
01054     IN <a class="code" href="../../d6/d9/struct__msgarg.html">PMSGARG</a> MsgArg,
01055     IN <a class="code" href="../../d3/d5/struct__errinfo.html">PERRINFO</a> ErrInfo
01056     )
01057 <span class="comment">/*++</span>
01058 <span class="comment"></span>
01059 <span class="comment">Routine Description:</span>
01060 <span class="comment">    This routine appends the substituted message argument to the unicode</span>
01061 <span class="comment">    string if there is enough space.  Otherwise, STATUS_BUFFER_TOO_SMALL is</span>
01062 <span class="comment">    returned.</span>
01063 <span class="comment"></span>
01064 <span class="comment">Arguments:</span>
01065 <span class="comment">    unicodeMsg - points to the target unicode message</span>
01066 <span class="comment">    MsgArg - points to the message argument structure</span>
01067 <span class="comment">    ErrInfo - points to the error info.</span>
01068 <span class="comment"></span>
01069 <span class="comment">Return Value:</span>
01070 <span class="comment">    Success - returns STATUS_SUCCESS</span>
01071 <span class="comment">    Failure - returns NT status code</span>
01072 <span class="comment"></span>
01073 <span class="comment">--*/</span>
01074 {
01075     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoepCatMsgArg"</span>);
01076     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
01077     <a class="code" href="../../d9/d4/struct__errcasedb.html">PERRCASEDB</a> ErrCaseDB;
01078 
01079     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01080     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(2, (<span class="stringliteral">"(Msg=%S,pMsgArg=%p,ErrInfo=%p)\n"</span>,
01081               unicodeMsg-&gt;Buffer, MsgArg, ErrInfo));
01082 
01083     ErrCaseDB = <a class="code" href="../../d7/d5/ioerr_8c.html#a14">IoepGetErrCaseDB</a>();
01084     <span class="keywordflow">if</span> (ErrCaseDB != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01085     {
01086         <span class="keywordflow">if</span> (MsgArg-&gt;ErrIDIndex &lt; ErrInfo-&gt;NumErrEntries)
01087         {
01088             <a class="code" href="../../d0/d5/struct__errdata.html">PERRDATA</a> ErrData;
01089             ANSI_STRING ansiStr;
01090             UNICODE_STRING unicodeStr;
01091             <a class="code" href="../../d5/d4/struct__handlerdata.html">PHANDLERDATA</a> HandlerData;
01092             <a class="code" href="../../d5/d5/ioeapi_8h.html#a22">PERRHANDLER</a> ErrHandler;
01093 
01094             ErrData = &amp;ErrInfo-&gt;ErrEntries[MsgArg-&gt;ErrIDIndex];
01095             <span class="keywordflow">switch</span> (MsgArg-&gt;ArgType)
01096             {
01097                 <span class="keywordflow">case</span> <a class="code" href="../../d5/d5/ioeapi_8h.html#a8">IOEDATA_TEXT</a>:
01098                     status = <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(
01099                                 unicodeMsg,
01100                                 (PWSTR)((PUCHAR)ErrInfo +
01101                                         ErrData-&gt;<a class="code" href="../../d0/d5/struct__errdata.html#o1">TextDataOffset</a>));
01102                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
01103                     {
01104                         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to append unicode string (rc=%x)\n"</span>,
01105                                   status));
01106                     }
01107                     <span class="keywordflow">break</span>;
01108 
01109                 <span class="keywordflow">case</span> <a class="code" href="../../d5/d5/ioeapi_8h.html#a6">IOEDATA_WSTRING</a>:
01110                     status = <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(
01111                                 unicodeMsg,
01112                                 (PWSTR)((PUCHAR)ErrInfo +
01113                                         ErrData-&gt;<a class="code" href="../../d0/d5/struct__errdata.html#o4">DataBlkOffset</a>));
01114                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
01115                     {
01116                         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to append unicode string argument (rc=%x)\n"</span>,
01117                                   status));
01118                     }
01119                     <span class="keywordflow">break</span>;
01120 
01121                 <span class="keywordflow">case</span> <a class="code" href="../../d5/d5/ioeapi_8h.html#a5">IOEDATA_PRIVATE</a>:
01122                     HandlerData = (<a class="code" href="../../d5/d4/struct__handlerdata.html">PHANDLERDATA</a>)((ULONG_PTR)ErrCaseDB +
01123                                                  ErrCaseDB-&gt;<a class="code" href="../../d9/d4/struct__errcasedb.html#o7">DataBlkOffset</a> +
01124                                                  MsgArg-&gt;ArgDataOffset);
01125                     ErrHandler = <a class="code" href="../../d7/d5/ioerr_8c.html#a9">IoepFindErrHandler</a>(&amp;HandlerData-&gt;<a class="code" href="../../d5/d4/struct__handlerdata.html#o0">ComponentGuid</a>,
01126                                                     HandlerData-&gt;<a class="code" href="../../d5/d4/struct__handlerdata.html#o1">HandlerIndex</a>);
01127                     <span class="keywordflow">if</span> (ErrHandler != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01128                     {
01129                         status = ErrHandler(ErrData, HandlerData-&gt;<a class="code" href="../../d5/d4/struct__handlerdata.html#o2">Param</a>);
01130                     }
01131                     <span class="keywordflow">break</span>;
01132 
01133                 <span class="keywordflow">default</span>:
01134                     <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"invalid message argument type %d\n"</span>,
01135                               MsgArg-&gt;ArgType));
01136             }
01137         }
01138         <span class="keywordflow">else</span>
01139         {
01140             status = STATUS_UNSUCCESSFUL;
01141             <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to find error entry\n"</span>));
01142         }
01143     }
01144     <span class="keywordflow">else</span>
01145     {
01146         status = <a class="code" href="../../d5/d5/ioeapi_8h.html#a2">STATUS_IOE_DATABASE_NOT_READY</a>;
01147         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"error case database not ready\n"</span>));
01148     }
01149 
01150     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(2, (<span class="stringliteral">"=%x(Msg=%S)\n"</span>, status, unicodeMsg-&gt;Buffer));
01151     <span class="keywordflow">return</span> status;
01152 }       <span class="comment">//IoepCatMsgArg</span>
01153 
01154 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01155"></a><a class="code" href="../../d7/d5/ioerr_8c.html#a13">01155</a> <a class="code" href="../../d7/d5/ioerr_8c.html#a13">IoepUnicodeStringCatN</a>(
01156     IN OUT PUNICODE_STRING unicodeStr,
01157     IN PWSTR pwstr,
01158     IN ULONG len
01159     )
01160 <span class="comment">/*++</span>
01161 <span class="comment"></span>
01162 <span class="comment">Routine Description:</span>
01163 <span class="comment">    This routine appends the wchar string to the unicode string if there is</span>
01164 <span class="comment">    enough space.  Otherwise, STATUS_BUFFER_TOO_SMALL is returned.</span>
01165 <span class="comment"></span>
01166 <span class="comment">Arguments:</span>
01167 <span class="comment">    unicodeStr - points to the target unicode string</span>
01168 <span class="comment">    pwstr - points to the wchar string</span>
01169 <span class="comment">    len - length of wstr in bytes to append</span>
01170 <span class="comment"></span>
01171 <span class="comment">Return Value:</span>
01172 <span class="comment">    Success - returns STATUS_SUCCESS</span>
01173 <span class="comment">    Failure - returns NT status code</span>
01174 <span class="comment"></span>
01175 <span class="comment">--*/</span>
01176 {
01177     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoepUnicodeStringCatN"</span>);
01178     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
01179 
01180     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01181     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(2, (<span class="stringliteral">"(Msg=%S,Str=%S,Len=%d)\n"</span>, unicodeStr-&gt;Buffer, pwstr, len));
01182 
01183     <span class="keywordflow">if</span> (len &lt; (ULONG)(unicodeStr-&gt;MaximumLength - unicodeStr-&gt;Length))
01184     {
01185         wcsncpy(unicodeStr-&gt;Buffer, pwstr, len/<span class="keyword">sizeof</span>(WCHAR));
01186         unicodeStr-&gt;Length += (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)len;
01187         unicodeStr-&gt;Buffer[len/<span class="keyword">sizeof</span>(WCHAR)] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
01188     }
01189     <span class="keywordflow">else</span>
01190     {
01191         status = STATUS_BUFFER_TOO_SMALL;
01192         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"unicode string too small\n"</span>));
01193     }
01194 
01195     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(2, (<span class="stringliteral">"=%x(Msg=%S)\n"</span>, status, unicodeStr-&gt;Buffer));
01196     <span class="keywordflow">return</span> status;
01197 }       <span class="comment">//IoepUnicodeStringCatN</span>
01198 
01199 <a class="code" href="../../d9/d4/struct__errcasedb.html">PERRCASEDB</a>
<a name="l01200"></a><a class="code" href="../../d7/d5/ioerr_8c.html#a14">01200</a> <a class="code" href="../../d7/d5/ioerr_8c.html#a14">IoepGetErrCaseDB</a>(
01201     VOID
01202     )
01203 <span class="comment">/*++</span>
01204 <span class="comment"></span>
01205 <span class="comment">Routine Description:</span>
01206 <span class="comment">    This routine checks if the ErrCase database has been read into memory.</span>
01207 <span class="comment">    If it has, it returns the pointer to the error case database.  Otherwise,</span>
01208 <span class="comment">    it tries to read the database in.</span>
01209 <span class="comment"></span>
01210 <span class="comment">Arguments:</span>
01211 <span class="comment">    None</span>
01212 <span class="comment"></span>
01213 <span class="comment">Return Value:</span>
01214 <span class="comment">    Success - returns pointer to the error case database</span>
01215 <span class="comment">    Failure - returns NULL</span>
01216 <span class="comment"></span>
01217 <span class="comment">--*/</span>
01218 {
01219     <a class="code" href="../../d6/d5/ioep_8h.html#a20">PROCNAME</a>(<span class="stringliteral">"IoepGetErrCaseDB"</span>);
01220 
01221     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01222     <a class="code" href="../../d7/d4/trace_8h.html#a0">ENTER</a>(2, (<span class="stringliteral">"()\n"</span>));
01223 
01224     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/data_8c.html#a6">IoepErrCaseDB</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01225     {
01226         OBJECT_ATTRIBUTES ObjAttr;
01227         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01228         HANDLE hReg, hFile;
01229 
01230         InitializeObjectAttributes(&amp;ObjAttr,
01231                                    &amp;<a class="code" href="../../d0/d2/data_8c.html#a5">IoepRegKeyStrIoErr</a>,
01232                                    OBJ_CASE_INSENSITIVE,
01233                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01234                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01235         status = ZwOpenKey(&amp;hReg, KEY_READ, &amp;ObjAttr);
01236         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
01237         {
01238             PKEY_VALUE_FULL_INFORMATION KeyValue;
01239 
01240             status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(hReg, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ErrCaseDB"</span>, &amp;KeyValue);
01241             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
01242             {
01243                 UNICODE_STRING unicodeStr;
01244                 IO_STATUS_BLOCK IoStatusBlk;
01245 
01246                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeStr,
01247                                      (PWSTR)((PUCHAR)KeyValue +
01248                                              KeyValue-&gt;DataOffset));
01249                 InitializeObjectAttributes(&amp;ObjAttr,
01250                                            &amp;unicodeStr,
01251                                            OBJ_CASE_INSENSITIVE,
01252                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01253                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01254                 status = <a class="code" href="../../d6/d9/restrfil_8c.html#a31">ZwCreateFile</a>(&amp;hFile,
01255                                       FILE_READ_DATA,
01256                                       &amp;ObjAttr,
01257                                       &amp;IoStatusBlk,
01258                                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01259                                       FILE_ATTRIBUTE_NORMAL,
01260                                       FILE_SHARE_READ,
01261                                       FILE_OPEN,
01262                                       FILE_NON_DIRECTORY_FILE |
01263                                       FILE_SEQUENTIAL_ONLY |
01264                                       FILE_SYNCHRONOUS_IO_NONALERT,
01265                                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01266                                       0);
01267 
01268                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp;
01269                     (IoStatusBlk.Information == FILE_OPENED))
01270                 {
01271                     <a class="code" href="../../d9/d4/struct__errcasedb.html">ERRCASEDB</a> DBHeader;
01272 
01273                     status = ZwReadFile(hFile,
01274                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01275                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01276                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01277                                         &amp;IoStatusBlk,
01278                                         &amp;DBHeader,
01279                                         <span class="keyword">sizeof</span>(DBHeader),
01280                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01281                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01282 
01283                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
01284                     {
01285                         <a class="code" href="../../d0/d2/data_8c.html#a6">IoepErrCaseDB</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01286                                                               DBHeader.Length,
01287                                                               <a class="code" href="../../d6/d5/ioep_8h.html#a6">IOETAG_ERRCASEDB</a>);
01288                         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/data_8c.html#a6">IoepErrCaseDB</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01289                         {
01290                             RtlCopyMemory(<a class="code" href="../../d0/d2/data_8c.html#a6">IoepErrCaseDB</a>,
01291                                           &amp;DBHeader,
01292                                           <span class="keyword">sizeof</span>(DBHeader));
01293                             status = ZwReadFile(hFile,
01294                                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01295                                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01296                                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01297                                                 &amp;IoStatusBlk,
01298                                                 (PUCHAR)<a class="code" href="../../d0/d2/data_8c.html#a6">IoepErrCaseDB</a> +
01299                                                 <span class="keyword">sizeof</span>(DBHeader),
01300                                                 DBHeader.<a class="code" href="../../d9/d4/struct__errcasedb.html#o3">Length</a> -
01301                                                 <span class="keyword">sizeof</span>(DBHeader),
01302                                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01303                                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01304 
01305                             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
01306                             {
01307                                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d0/d2/data_8c.html#a6">IoepErrCaseDB</a>);
01308                                 <a class="code" href="../../d0/d2/data_8c.html#a6">IoepErrCaseDB</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01309                                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to read error case database (rc=%x)\n"</span>,
01310                                           status));
01311                             }
01312                         }
01313                         <span class="keywordflow">else</span>
01314                         {
01315                             <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to allocate storage for error case database (len=%d)\n"</span>,
01316                                       DBHeader.Length));
01317                         }
01318                     }
01319                     <span class="keywordflow">else</span>
01320                     {
01321                         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to read database header (rc=%x)\n"</span>,
01322                                   status));
01323                     }
01324                     ZwClose(hFile);
01325                 }
01326                 <span class="keywordflow">else</span>
01327                 {
01328                     <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to open error case database (rc=%x)\n"</span>,
01329                               status));
01330                 }
01331                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(KeyValue);
01332             }
01333             <span class="keywordflow">else</span>
01334             {
01335                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to read registry value (rc=%x)\n"</span>, status));
01336             }
01337             ZwClose(hReg);
01338         }
01339         <span class="keywordflow">else</span>
01340         {
01341             <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"failed to open registry key (rc=%x)\n"</span>, status));
01342         }
01343     }
01344 
01345     <a class="code" href="../../d3/d9/arcinst_8c.html#a2">EXIT</a>(2, (<span class="stringliteral">"=%p\n"</span>, <a class="code" href="../../d0/d2/data_8c.html#a6">IoepErrCaseDB</a>));
01346     <span class="keywordflow">return</span> <a class="code" href="../../d0/d2/data_8c.html#a6">IoepErrCaseDB</a>;
01347 }       <span class="comment">//IoepGetErrCaseDB</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:29 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
