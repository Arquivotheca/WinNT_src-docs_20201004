<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: harderr.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>harderr.c</h1><a href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/**************************** Module Header ********************************\</span>
00002 <span class="comment">* Module Name: harderr.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Hard error handler</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 07-03-91 JimA                Created scaffolding.</span>
00010 <span class="comment">\***************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d2/d4/w32_2ntuser_2server_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span><span class="preprocessor">#include "ntlpcapi.h"</span>
00015 
00016 <span class="preprocessor">#include &lt;winsta.h&gt;</span>
<a name="l00017"></a><a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a0">00017</a> <span class="keyword">extern</span> BOOLEAN <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a340">gbExitInProgress</a>;
<a name="l00018"></a><a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a1">00018</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a1">gfTimedOut</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00019 
00020 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a11">UserHardErrorEx</a>(
00021     PCSR_THREAD pt,
00022     PHARDERROR_MSG pmsg,
00023     <a class="code" href="../../d5/d1/structtagCTXHARDERRORINFO.html">PCTXHARDERRORINFO</a> pCtxHEInfo);
00024 
00025 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a12">UserExitWorkerThread</a>(VOID);
00026 
00027 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a13">ProcessHardErrorRequest</a>(
00028     BOOL fNewThread);
00029 
00030 
<a name="l00031"></a><a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a2">00031</a> CONST <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a2">wIcons</a>[] = {
00032     0,
00033     MB_ICONINFORMATION,
00034     MB_ICONEXCLAMATION,
00035     MB_ICONSTOP
00036 };
<a name="l00037"></a><a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a3">00037</a> CONST <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a3">wOptions</a>[] = {
00038     MB_ABORTRETRYIGNORE,
00039     MB_OK,
00040     MB_OKCANCEL,
00041     MB_RETRYCANCEL,
00042     MB_YESNO,
00043     MB_YESNOCANCEL,
00044     MB_OK,              <span class="comment">// OptionShutdownSystem</span>
00045     MB_OK,              <span class="comment">// OptionOkNoWait</span>
00046     MB_CANCELTRYCONTINUE
00047 };
<a name="l00048"></a><a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a4">00048</a> CONST <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a4">dwResponses</a>[] = {
00049     ResponseNotHandled, <span class="comment">// MessageBox error</span>
00050     ResponseOk,         <span class="comment">// IDOK</span>
00051     ResponseCancel,     <span class="comment">// IDCANCEL</span>
00052     ResponseAbort,      <span class="comment">// IDABORT</span>
00053     ResponseRetry,      <span class="comment">// IDRETRY</span>
00054     ResponseIgnore,     <span class="comment">// IDIGNORE</span>
00055     ResponseYes,        <span class="comment">// IDYES</span>
00056     ResponseNo,         <span class="comment">// IDNO</span>
00057     ResponseNotHandled, <span class="comment">// Error as IDCLOSE can't show up</span>
00058     ResponseNotHandled, <span class="comment">// error as IDHELP can't show up</span>
00059     ResponseTryAgain,   <span class="comment">// IDTRYAGAIN</span>
00060     ResponseContinue    <span class="comment">// IDCONTINUE</span>
00061 };
<a name="l00062"></a><a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a5">00062</a> CONST <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a5">dwResponseDefault</a>[] = {
00063     ResponseAbort,      <span class="comment">// OptionAbortRetryIgnore</span>
00064     ResponseOk,         <span class="comment">// OptionOK</span>
00065     ResponseOk,         <span class="comment">// OptionOKCancel</span>
00066     ResponseCancel,     <span class="comment">// OptionRetryCancel</span>
00067     ResponseYes,        <span class="comment">// OptionYesNo</span>
00068     ResponseYes,        <span class="comment">// OptionYesNoCancel</span>
00069     ResponseOk,         <span class="comment">// OptionShutdownSystem</span>
00070     ResponseOk,         <span class="comment">// OptionOKNoWait</span>
00071     ResponseCancel      <span class="comment">// OptionCancelTryContinue</span>
00072 };
00073 
00074 <span class="comment">/*</span>
00075 <span class="comment"> *  Global timer id</span>
00076 <span class="comment"> */</span>
<a name="l00077"></a><a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a6">00077</a> <span class="keyword">static</span> UINT_PTR <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a6">gTimerId</a> = 0;
00078 
00079 <span class="comment">/*</span>
00080 <span class="comment"> *  Citrix SendMessage entry point to harderror handler and cleanup routine</span>
00081 <span class="comment"> */</span>
00082 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d4/icamsg_8c.html#a9">HardErrorInsert</a>(PCSR_THREAD, PHARDERROR_MSG, <a class="code" href="../../d5/d1/structtagCTXHARDERRORINFO.html">PCTXHARDERRORINFO</a>);
00083 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d4/icamsg_8c.html#a7">HardErrorRemove</a>(<a class="code" href="../../d5/d1/structtagCTXHARDERRORINFO.html">PCTXHARDERRORINFO</a>);
00084 
<a name="l00085"></a><a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a7">00085</a> FARPROC <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a7">gfnRegisterEventSource</a>;
<a name="l00086"></a><a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a8">00086</a> FARPROC <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a8">gfnDeregisterEventSource</a>;
<a name="l00087"></a><a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a9">00087</a> FARPROC <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a9">gfnReportEvent</a>;
00088 
00089 <span class="comment">/***************************************************************************\</span>
00090 <span class="comment">* UserRegisterEventSource</span>
00091 <span class="comment">*</span>
00092 <span class="comment">* Dynamically link to the event functions in advapi32.dll and register the</span>
00093 <span class="comment">* event source.</span>
00094 <span class="comment">*</span>
00095 <span class="comment">* History:</span>
00096 <span class="comment">* 04-13-98 JerrySh      Created.</span>
00097 <span class="comment">\***************************************************************************/</span>
00098 HANDLE
<a name="l00099"></a><a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a16">00099</a> <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a16">UserRegisterEventSource</a>(
00100     PCWSTR pwszSourceName)
00101 {
00102     <span class="comment">/*</span>
00103 <span class="comment">     * If we haven't already dynamically linked to advadpi32.dll, do it now.</span>
00104 <span class="comment">     */</span>
00105     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a7">gfnRegisterEventSource</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00106         HINSTANCE hAdvApiDll;
00107         FARPROC fnRegisterEventSource;
00108         FARPROC fnDeregisterEventSource;
00109         FARPROC fnReportEvent;
00110 
00111         <span class="comment">/*</span>
00112 <span class="comment">         * Try to load the DLL and function pointers.</span>
00113 <span class="comment">         */</span>
00114         <span class="keywordflow">if</span> ((hAdvApiDll = LoadLibrary(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"advapi32.dll"</span>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00115             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00116         }
00117         fnRegisterEventSource = GetProcAddress(hAdvApiDll, <span class="stringliteral">"RegisterEventSourceW"</span>);
00118         fnDeregisterEventSource = GetProcAddress(hAdvApiDll, <span class="stringliteral">"DeregisterEventSource"</span>);
00119         fnReportEvent = GetProcAddress(hAdvApiDll, <span class="stringliteral">"ReportEventW"</span>);
00120         <span class="keywordflow">if</span> (!fnRegisterEventSource || !fnDeregisterEventSource || !fnReportEvent) {
00121             FreeLibrary(hAdvApiDll);
00122             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00123         }
00124 
00125         <span class="comment">/*</span>
00126 <span class="comment">         * Update the global function pointers if they're not set already.</span>
00127 <span class="comment">         */</span>
00128         <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00129         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a7">gfnRegisterEventSource</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00130             <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a9">gfnReportEvent</a> = fnReportEvent;
00131             <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a8">gfnDeregisterEventSource</a> = fnDeregisterEventSource;
00132             <span class="comment">// This must be last since we test it above</span>
00133             <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a7">gfnRegisterEventSource</a> = fnRegisterEventSource;
00134             hAdvApiDll = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00135         }
00136         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00137 
00138         <span class="comment">/*</span>
00139 <span class="comment">         * If another thread beat us to it, free the library.</span>
00140 <span class="comment">         */</span>
00141         <span class="keywordflow">if</span> (hAdvApiDll) {
00142             FreeLibrary(hAdvApiDll);
00143         }
00144     }
00145 
00146     <span class="comment">/*</span>
00147 <span class="comment">     * Let's be paranoid and verify we loaded everything correctly.</span>
00148 <span class="comment">     */</span>
00149     UserAssert(<a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a7">gfnRegisterEventSource</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00150     UserAssert(<a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a8">gfnDeregisterEventSource</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00151     UserAssert(<a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a9">gfnReportEvent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00152 
00153     <span class="comment">/*</span>
00154 <span class="comment">     * Call the real function.</span>
00155 <span class="comment">     */</span>
00156     <span class="keywordflow">return</span> (HANDLE)<a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a7">gfnRegisterEventSource</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pwszSourceName);
00157 }
00158 
00159 <span class="comment">/***************************************************************************\</span>
00160 <span class="comment">* LogErrorPopup</span>
00161 <span class="comment">*</span>
00162 <span class="comment">* History:</span>
00163 <span class="comment">* 09-22-97 GerardoB     Added Header</span>
00164 <span class="comment">\***************************************************************************/</span>
00165 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00166"></a><a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a17">00166</a> <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a17">LogErrorPopup</a>(
00167     IN LPWSTR Caption,
00168     IN LPWSTR Message
00169     )
00170 {
00171 
00172     LPWSTR lps[2];
00173 
00174     lps[0] = Caption;
00175     lps[1] = Message;
00176 
00177     UserAssert(<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a14">gEventSource</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00178     <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a9">gfnReportEvent</a>(<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a14">gEventSource</a>, EVENTLOG_INFORMATION_TYPE, 0,
00179         STATUS_LOG_HARD_ERROR, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <span class="keyword">sizeof</span>(lps) / <span class="keyword">sizeof</span>(*lps),
00180         0, lps, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00181 }
00182 
00183 <span class="comment">/***************************************************************************\</span>
00184 <span class="comment">* SubstituteDeviceName</span>
00185 <span class="comment">*</span>
00186 <span class="comment">* History:</span>
00187 <span class="comment">* 09-22-97 GerardoB     Added Header</span>
00188 <span class="comment">\***************************************************************************/</span>
<a name="l00189"></a><a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a10">00189</a> <span class="keyword">static</span> WCHAR <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a10">wszDosDevices</a>[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\??\\A:"</span>;
00190 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00191"></a><a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a18">00191</a> <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a18">SubstituteDeviceName</a>(
00192     PUNICODE_STRING InputDeviceName,
00193     LPSTR OutputDriveLetter
00194     )
00195 {
00196     UNICODE_STRING LinkName;
00197     UNICODE_STRING DeviceName;
00198     OBJECT_ATTRIBUTES Obja;
00199     HANDLE LinkHandle;
00200     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00201     ULONG i;
00202     PWCHAR p;
00203     WCHAR DeviceNameBuffer[MAXIMUM_FILENAME_LENGTH];
00204 
00205     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;LinkName,<a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a10">wszDosDevices</a>);
00206     p = <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a10">wszDosDevices</a> + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(<a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a10">wszDosDevices</a>) - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"A:"</span>);
00207     <span class="keywordflow">for</span>(i=0;i&lt;26;i++){
00208         *p = (WCHAR)(<span class="charliteral">'A'</span> + i);
00209 
00210         InitializeObjectAttributes(
00211             &amp;Obja,
00212             &amp;LinkName,
00213             OBJ_CASE_INSENSITIVE,
00214             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00215             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00216             );
00217         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/oblink_8c.html#a6">NtOpenSymbolicLinkObject</a>(
00218                     &amp;LinkHandle,
00219                     SYMBOLIC_LINK_QUERY,
00220                     &amp;Obja
00221                     );
00222         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00223 
00224             <span class="comment">//</span>
00225             <span class="comment">// Open succeeded, Now get the link value</span>
00226             <span class="comment">//</span>
00227 
00228             DeviceName.Length = 0;
00229             DeviceName.MaximumLength = <span class="keyword">sizeof</span>(DeviceNameBuffer);
00230             DeviceName.Buffer = DeviceNameBuffer;
00231 
00232             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/oblink_8c.html#a7">NtQuerySymbolicLinkObject</a>(
00233                         LinkHandle,
00234                         &amp;DeviceName,
00235                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00236                         );
00237             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(LinkHandle);
00238             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00239                 <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(InputDeviceName,&amp;DeviceName,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) ) {
00240                     OutputDriveLetter[0]=(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>)(<span class="charliteral">'A'</span>+i);
00241                     OutputDriveLetter[1]=<span class="charliteral">':'</span>;
00242                     OutputDriveLetter[2]=<span class="charliteral">'\0'</span>;
00243                     <span class="keywordflow">return</span>;
00244                     }
00245                 }
00246             }
00247         }
00248 }
00249 <span class="comment">/***************************************************************************\</span>
00250 <span class="comment">* GetErrorMode</span>
00251 <span class="comment">*</span>
00252 <span class="comment">* History:</span>
00253 <span class="comment">* 09-22-97 GerardoB     Added Header</span>
00254 <span class="comment">\***************************************************************************/</span>
<a name="l00255"></a><a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a19">00255</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a19">GetErrorMode</a>(VOID)
00256 {
00257     HANDLE hKey;
00258     UNICODE_STRING UnicodeString;
00259     OBJECT_ATTRIBUTES OA;
00260     LONG <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00261     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> Buf[<span class="keyword">sizeof</span>(KEY_VALUE_PARTIAL_INFORMATION) + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)];
00262     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cbSize;
00263     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwRet = 0;
00264 
00265     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString,
00266             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\Windows"</span>);
00267     InitializeObjectAttributes(&amp;OA, &amp;UnicodeString, OBJ_CASE_INSENSITIVE, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00268 
00269     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;hKey, KEY_READ, &amp;OA);
00270     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00271         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ErrorMode"</span>);
00272         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(hKey,
00273                 &amp;UnicodeString,
00274                 KeyValuePartialInformation,
00275                 (PKEY_VALUE_PARTIAL_INFORMATION)Buf,
00276                 <span class="keyword">sizeof</span>(Buf),
00277                 &amp;cbSize);
00278         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00279             dwRet = *((PDWORD)((PKEY_VALUE_PARTIAL_INFORMATION)Buf)-&gt;Data);
00280         }
00281         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hKey);
00282     }
00283     <span class="keywordflow">return</span> dwRet;
00284 }
00285 <span class="comment">/***************************************************************************\</span>
00286 <span class="comment">* FreePhi</span>
00287 <span class="comment">*</span>
00288 <span class="comment">* History:</span>
00289 <span class="comment">* 09-18-97 GerardoB     Created</span>
00290 <span class="comment">\***************************************************************************/</span>
<a name="l00291"></a><a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a20">00291</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a20">FreePhi</a> (<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html">PHARDERRORINFO</a> phi)
00292 {
00293     <span class="keywordflow">if</span> (phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a23">HEIF_ALLOCATEDMSG</a>) {
00294         LocalFree(phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o3">pmsg</a>);
00295     }
00296 
00297     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o5">usText</a>);
00298     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o6">usCaption</a>);
00299 
00300     LocalFree(phi);
00301 }
00302 <span class="comment">/***************************************************************************\</span>
00303 <span class="comment">* ReplyHardError</span>
00304 <span class="comment">*</span>
00305 <span class="comment">* This function is called when we are done with a hard error.</span>
00306 <span class="comment">*</span>
00307 <span class="comment">* History:</span>
00308 <span class="comment">* 03-11-97 GerardoB     Created</span>
00309 <span class="comment">\***************************************************************************/</span>
<a name="l00310"></a><a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a21">00310</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a21">ReplyHardError</a> (<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html">PHARDERRORINFO</a> phi, DWORD dwResponse)
00311 {
00312     phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o3">pmsg</a>-&gt;Response = dwResponse;
00313     <span class="comment">/*</span>
00314 <span class="comment">     * Signal the event if any. If not, reply if we haven't done so</span>
00315 <span class="comment">     *  already.</span>
00316 <span class="comment">     */</span>
00317     <span class="keywordflow">if</span> (phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o2">hEventHardError</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00318         <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>(phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o2">hEventHardError</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00319     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a24">HEIF_REPLIED</a>)) {
00320         <a class="code" href="../../d5/d7/lpcreply_8c.html#a1">NtReplyPort</a>(((PCSR_THREAD)phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o1">pthread</a>)-&gt;Process-&gt;ClientPort,
00321                     (PPORT_MESSAGE)phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o3">pmsg</a>);
00322     }
00323     <span class="comment">/*</span>
00324 <span class="comment">     * If we had locked the thread or were holding the client port,</span>
00325 <span class="comment">     *   then let it go now.</span>
00326 <span class="comment">     */</span>
00327     <span class="keywordflow">if</span> (phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a25">HEIF_DEREFTHREAD</a>) {
00328         CsrDereferenceThread(phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o1">pthread</a>);
00329     }
00330     <span class="comment">/*</span>
00331 <span class="comment">     * We're done with this dude</span>
00332 <span class="comment">     */</span>
00333     <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a20">FreePhi</a>(phi);
00334 }
00335 <span class="comment">/***************************************************************************\</span>
00336 <span class="comment">* CheckDefaultDesktop</span>
00337 <span class="comment">*</span>
00338 <span class="comment">* This function is called by the HardErrorHandler when it's notified</span>
00339 <span class="comment">*  that we've switched desktops or upon waking up.</span>
00340 <span class="comment">*  If we're on the default desktop now, then we clear the HEIF_WRONGDESKTOP</span>
00341 <span class="comment">*  flag; this flag is set when we find a MB_DEFAULT_DESKTOP_ONLY request but</span>
00342 <span class="comment">*  we are not in the right (default) desktop.</span>
00343 <span class="comment">*</span>
00344 <span class="comment">* History:</span>
00345 <span class="comment">* 06-02-97 GerardoB     Created</span>
00346 <span class="comment">\***************************************************************************/</span>
<a name="l00347"></a><a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a22">00347</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a22">CheckDefaultDesktop</a>(<span class="keywordtype">void</span>)
00348 {
00349     <a class="code" href="../../d3/d6/structtagHARDERRORINFO.html">PHARDERRORINFO</a> phi;
00350 
00351     <span class="keywordflow">if</span> (HEC_WRONGDESKTOP == <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a82">NtUserHardErrorControl</a>(HardErrorInDefDesktop, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00352         <span class="keywordflow">return</span>;
00353     }
00354 
00355     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00356     phi = <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a11">gphiList</a>;
00357     <span class="keywordflow">while</span> (phi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00358         phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> &amp;= ~<a class="code" href="../../d7/d1/usersrv_8h.html#a26">HEIF_WRONGDESKTOP</a>;
00359         phi = phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o0">phiNext</a>;
00360     }
00361     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00362 }
00363 
00364 <span class="comment">/*****************************************************************************</span>
00365 <span class="comment"> *</span>
00366 <span class="comment"> *  MsgBoxTimerFunc</span>
00367 <span class="comment"> *</span>
00368 <span class="comment"> *  This function gets called when a timer fires on a GUI message box</span>
00369 <span class="comment"> *  is up that has a timeout set for it.</span>
00370 <span class="comment"> *</span>
00371 <span class="comment"> *  This function cancels the message box by posting a WM_QUIT into the</span>
00372 <span class="comment"> *  message queue of the Citrix Message box thread.</span>
00373 <span class="comment"> *</span>
00374 <span class="comment"> * ENTRY:</span>
00375 <span class="comment"> *</span>
00376 <span class="comment"> *</span>
00377 <span class="comment"> * EXIT:</span>
00378 <span class="comment"> *</span>
00379 <span class="comment"> *</span>
00380 <span class="comment"> ****************************************************************************/</span>
00381 
00382 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00383"></a><a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a23">00383</a> <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a23">MsgBoxTimerFunc</a>(
00384     HWND  hWnd,
00385     UINT  MessageType,
00386     UINT_PTR idEvent,
00387     DWORD TimeWhenCalled
00388     )
00389 {
00390     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> RetVal;
00391 
00392     RIPMSG0(RIP_WARNING, <span class="stringliteral">"MsgBoxTimerFunc: timer poped"</span>);
00393 
00394     <span class="comment">//</span>
00395     <span class="comment">// Post a WM_QUIT message into the messagebox threads queue</span>
00396     <span class="comment">//</span>
00397     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a12">gdwHardErrorThreadId</a> != 0 ) {
00398         <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a1">gfTimedOut</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00399         RetVal = <a class="code" href="../../d0/d8/ntcftxt_8h.html#a21">PostThreadMessage</a>(<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a12">gdwHardErrorThreadId</a>, WM_QUIT, 0, 0);
00400     }
00401 
00402     <span class="keywordflow">if</span>(- !RetVal ) {
00403         RIPMSG0(RIP_WARNING, <span class="stringliteral">"MsgBoxTimerFunc: PostMessageFailed"</span>);
00404     }
00405 
00406     UNREFERENCED_PARAMETER(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>);
00407     UNREFERENCED_PARAMETER(MessageType);
00408     UNREFERENCED_PARAMETER(idEvent);
00409     UNREFERENCED_PARAMETER(TimeWhenCalled);
00410 }
00411 
00412 <span class="comment">/***************************************************************************\</span>
00413 <span class="comment">* GetHardErrorText</span>
00414 <span class="comment">*</span>
00415 <span class="comment">* This function figures out the message box title, text and flags.</span>
00416 <span class="comment">* We want to do this up front so we can log this error when the hard error is</span>
00417 <span class="comment">*  raised. Previously we used to log it after the user had dismissed the message</span>
00418 <span class="comment">*  box -- but that was not when the error occurred (DCR Bug 107590)</span>
00419 <span class="comment">*</span>
00420 <span class="comment">* History:</span>
00421 <span class="comment">* 09-18-97 GerardoB     Extracted (and cleaned up) from HardErrorHandler</span>
00422 <span class="comment">\***************************************************************************/</span>
<a name="l00423"></a><a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a24">00423</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a24">GetHardErrorText</a> (<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html">PHARDERRORINFO</a> phi)
00424 {
00425     <span class="keyword">static</span> WCHAR wszUnkownSoftwareException [] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"unknown software exception"</span>;
00426     <span class="keyword">static</span> WCHAR wszException [] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"{EXCEPTION}"</span>;
00427     <span class="keyword">static</span> WCHAR wszUnknownHardError [] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Unknown Hard Error"</span>;
00428     ANSI_STRING asLocal, asMessage;
00429     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fFreeAppNameBuffer, fFreeCaption;
00430     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fResAllocated, fResAllocated1, fErrorIsFromSystem;
00431     WCHAR wszErrorMessage[WSPRINTF_LIMIT + 1];
00432     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwCounter, dwStringsToFreeMask, dwMBFlags;
00433     ULONG_PTR adwParameterVector[MAXIMUM_HARDERROR_PARAMETERS];
00434     HANDLE hClientProcess;
00435     HWND hwndOwner;
00436     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00437     PHARDERROR_MSG phemsg;
00438     PMESSAGE_RESOURCE_ENTRY MessageEntry;
00439     PWSTR pwszCaption, pwszFormatString;
00440     PWSTR pwszAppName, pwszResBuffer, pwszResBuffer1;
00441     PWSTR pwszMsg, pwszTitle, pwszFullCaption;
00442     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uMsgLen, uCaptionLen, uTitleLen;
00443     UNICODE_STRING usScratch, usLocal, usMessage, usCaption;
00444 
00445     <span class="comment">/*</span>
00446 <span class="comment">     * Initialize working variables</span>
00447 <span class="comment">     */</span>
00448     fFreeAppNameBuffer = fFreeCaption = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00449     hClientProcess = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00450     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;usCaption, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00451     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;usMessage, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00452     <span class="comment">/*</span>
00453 <span class="comment">     * Initialize response in case something goes wrong</span>
00454 <span class="comment">     */</span>
00455     phemsg = phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o3">pmsg</a>;
00456     phemsg-&gt;Response = ResponseNotHandled;
00457     <span class="comment">/*</span>
00458 <span class="comment">     * Make a copy of the parameters. Initialize unused ones to point to empty</span>
00459 <span class="comment">     *  strings (in case we expect a string there).</span>
00460 <span class="comment">     */</span>
00461     UserAssert(phemsg-&gt;NumberOfParameters &lt;= MAXIMUM_HARDERROR_PARAMETERS);
00462     RtlCopyMemory(adwParameterVector, phemsg-&gt;Parameters, phemsg-&gt;NumberOfParameters * <span class="keyword">sizeof</span>(*phemsg-&gt;Parameters));
00463     dwCounter = phemsg-&gt;NumberOfParameters;
00464     <span class="keywordflow">while</span> (dwCounter &lt; MAXIMUM_HARDERROR_PARAMETERS) {
00465         adwParameterVector[dwCounter++] = (ULONG_PTR)<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>;
00466     }
00467     <span class="comment">/*</span>
00468 <span class="comment">     * Open the client process so we can read the strings parameters, process</span>
00469 <span class="comment">     *  name, etc., from its address space</span>
00470 <span class="comment">     */</span>
00471     hClientProcess = OpenProcess(PROCESS_VM_READ | PROCESS_QUERY_INFORMATION,
00472                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, HandleToUlong(phemsg-&gt;h.ClientId.UniqueProcess));
00473     fErrorIsFromSystem = (hClientProcess == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00474     <span class="comment">/*</span>
00475 <span class="comment">     * If there are unicode strings, then we need to</span>
00476 <span class="comment">     * convert them to ansi and store them in the</span>
00477 <span class="comment">     * parameter vector</span>
00478 <span class="comment">     */</span>
00479     dwStringsToFreeMask = 0;
00480     <span class="keywordflow">if</span> (phemsg-&gt;UnicodeStringParameterMask) {
00481 
00482         <span class="keywordflow">for</span> (dwCounter = 0; dwCounter &lt; phemsg-&gt;NumberOfParameters; dwCounter++) {
00483             <span class="comment">/*</span>
00484 <span class="comment">             * if there is no string in this position, continue</span>
00485 <span class="comment">             */</span>
00486             <span class="keywordflow">if</span> (!(phemsg-&gt;UnicodeStringParameterMask &amp; (1 &lt;&lt; dwCounter))) {
00487                 <span class="keywordflow">continue</span>;
00488             }
00489             <span class="comment">/*</span>
00490 <span class="comment">             * Point to an empty string in case we don't have</span>
00491 <span class="comment">             * a client to read from or something fails later on.</span>
00492 <span class="comment">             */</span>
00493             adwParameterVector[dwCounter] = (ULONG_PTR)<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>;
00494             <span class="keywordflow">if</span> (hClientProcess == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00495                 <span class="keywordflow">continue</span>;
00496             }
00497 
00498             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a9">NtReadVirtualMemory</a>(hClientProcess,
00499                             (PVOID)phemsg-&gt;Parameters[dwCounter],
00500                             (PVOID)&amp;usScratch,
00501                              <span class="keyword">sizeof</span>(usScratch), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00502 
00503             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00504                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"Failed to read error string struct!"</span>);
00505                 <span class="keywordflow">continue</span>;
00506             }
00507 
00508             usLocal = usScratch;
00509             usLocal.Buffer = (PWSTR)LocalAlloc(<a class="code" href="../../d2/d3/ldrsnap_8c.html#a22">LMEM_ZEROINIT</a>, usLocal.Length + <span class="keyword">sizeof</span>(UNICODE_NULL));
00510             <span class="keywordflow">if</span> (usLocal.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00511                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"Failed to alloc string buffer!"</span>);
00512                 <span class="keywordflow">continue</span>;
00513             }
00514 
00515             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a9">NtReadVirtualMemory</a>(hClientProcess,
00516                             (PVOID)usScratch.Buffer,
00517                             (PVOID)usLocal.Buffer,
00518                             usLocal.Length,
00519                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00520 
00521             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00522                 LocalFree(usLocal.Buffer);
00523                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"Failed to read error string!"</span>);
00524                 <span class="keywordflow">continue</span>;
00525             }
00526 
00527             usLocal.MaximumLength = usLocal.Length;
00528             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a23">RtlUnicodeStringToAnsiString</a>(&amp;asLocal, &amp;usLocal, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00529             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00530                 LocalFree(usLocal.Buffer);
00531                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"Failed to translate error string!"</span>);
00532                 <span class="keywordflow">continue</span>;
00533             }
00534 
00535             <span class="comment">/*</span>
00536 <span class="comment">             * check to see if string contains an NT</span>
00537 <span class="comment">             * device name. If so, then attempt a</span>
00538 <span class="comment">             * drive letter substitution</span>
00539 <span class="comment">             */</span>
00540 
00541             <span class="keywordflow">if</span> (strstr(asLocal.Buffer,<span class="stringliteral">"\\Device"</span>) == asLocal.Buffer) {
00542                 <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a18">SubstituteDeviceName</a>(&amp;usLocal,asLocal.Buffer);
00543             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((asLocal.Length &gt; 4) &amp;&amp; !_strnicmp(asLocal.Buffer, <span class="stringliteral">"\\??\\"</span>, 4)) {
00544                 strcpy( asLocal.Buffer, asLocal.Buffer+4 );
00545                 asLocal.Length -= 4;
00546             } <span class="keywordflow">else</span> {
00547                 <span class="comment">/*</span>
00548 <span class="comment">                 * Processing some status code doesn't require ansi strings.</span>
00549 <span class="comment">                 * Since no substitution took place, let's ignore the translation</span>
00550 <span class="comment">                 * to avoid losing chars -- incorrect code page translation</span>
00551 <span class="comment">                 */</span>
00552                 <span class="keywordflow">switch</span> (phemsg-&gt;Status) {
00553                     <span class="keywordflow">case</span> STATUS_SERVICE_NOTIFICATION:
00554                     <span class="keywordflow">case</span> STATUS_VDM_HARD_ERROR:
00555                         adwParameterVector[dwCounter] = (ULONG_PTR)usLocal.Buffer;
00556                         <a class="code" href="../../d6/d6/nls_8c.html#a35">RtlFreeAnsiString</a>(&amp;asLocal);
00557                         <span class="keywordflow">continue</span>;
00558                 }
00559 
00560             }
00561 
00562             LocalFree(usLocal.Buffer);
00563 
00564             dwStringsToFreeMask |= (1 &lt;&lt; dwCounter);
00565             adwParameterVector[dwCounter] = (ULONG_PTR)asLocal.Buffer;
00566 
00567         } <span class="comment">/* for (dwCounter... */</span>
00568 
00569     } <span class="comment">/* if (phemsg-&gt;UnicodeStringParameterMask) */</span>
00570 
00571     <span class="comment">/*</span>
00572 <span class="comment">     * Read additional MB flags, if provided.</span>
00573 <span class="comment">     */</span>
00574 <span class="preprocessor">#if (HARDERROR_PARAMETERS_FLAGSPOS &gt;= MAXIMUM_HARDERROR_PARAMETERS)</span>
00575 <span class="preprocessor"></span><span class="preprocessor">#error Invalid HARDERROR_PARAMETERS_FLAGSPOS value.</span>
00576 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00577 <span class="preprocessor"></span><span class="preprocessor">#if (HARDERROR_FLAGS_DEFDESKTOPONLY != MB_DEFAULT_DESKTOP_ONLY)</span>
00578 <span class="preprocessor"></span><span class="preprocessor">#error Invalid HARDERROR_FLAGS_DEFDESKTOPONLY</span>
00579 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00580 <span class="preprocessor"></span>    dwMBFlags = 0;
00581     <span class="keywordflow">if</span> (phemsg-&gt;NumberOfParameters &gt; HARDERROR_PARAMETERS_FLAGSPOS) {
00582         <span class="comment">/*</span>
00583 <span class="comment">         * Currently we only use MB_DEFAULT_DESKTOP_ONLY</span>
00584 <span class="comment">         */</span>
00585         UserAssert(!(adwParameterVector[HARDERROR_PARAMETERS_FLAGSPOS] &amp; ~MB_DEFAULT_DESKTOP_ONLY));
00586         <span class="keywordflow">if</span> (adwParameterVector[HARDERROR_PARAMETERS_FLAGSPOS] &amp; MB_DEFAULT_DESKTOP_ONLY) {
00587             dwMBFlags |= MB_DEFAULT_DESKTOP_ONLY;
00588         }
00589     }
00590     <span class="comment">/*</span>
00591 <span class="comment">     * For some status codes, all MessageBox parameters are provided in the HardError parameters</span>
00592 <span class="comment">     */</span>
00593     <span class="keywordflow">switch</span> (phemsg-&gt;Status) {
00594         <span class="keywordflow">case</span> STATUS_SERVICE_NOTIFICATION:
00595             <span class="keywordflow">if</span> (phemsg-&gt;UnicodeStringParameterMask &amp; 0x1) {
00596                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;usMessage, (PWSTR)adwParameterVector[0]);
00597             } <span class="keywordflow">else</span> {
00598                 <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;asMessage, (PSTR)adwParameterVector[0]);
00599                 <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;usMessage, &amp;asMessage, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00600             }
00601 
00602             <span class="keywordflow">if</span> (phemsg-&gt;UnicodeStringParameterMask &amp; 0x2) {
00603                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;usCaption, (PWSTR)adwParameterVector[1]);
00604             } <span class="keywordflow">else</span> {
00605                 <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;asMessage, (PSTR)adwParameterVector[1]);
00606                 <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;usCaption, &amp;asMessage, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00607             }
00608 
00609             dwMBFlags = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)adwParameterVector[2] &amp; ~MB_SERVICE_NOTIFICATION;
00610             <span class="keywordflow">goto</span> CleanUpAndSaveParams;
00611 
00612         <span class="keywordflow">case</span> STATUS_VDM_HARD_ERROR:
00613             <span class="comment">/*</span>
00614 <span class="comment">             * Parameters[0] = (fForWOW &lt;&lt; 16) | wBtn1;</span>
00615 <span class="comment">             * Parameters[1] = (wBtn2   &lt;&lt; 16) | wBtn3;</span>
00616 <span class="comment">             * Parameters[2] = (DWORD) szTitle;</span>
00617 <span class="comment">             * Parameters[3] = (DWORD) szMessage;</span>
00618 <span class="comment">             */</span>
00619             phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> |= <a class="code" href="../../d7/d1/usersrv_8h.html#a28">HEIF_VDMERROR</a>;
00620             <span class="comment">/*</span>
00621 <span class="comment">             * Save VDM's Button(s) info to be used later.</span>
00622 <span class="comment">             */</span>
00623             phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o8">dwVDMParam0</a> = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)adwParameterVector[0];
00624             phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o9">dwVDMParam1</a> = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)adwParameterVector[1];
00625             <span class="comment">/*</span>
00626 <span class="comment">             * Get caption and text.</span>
00627 <span class="comment">             */</span>
00628             <span class="keywordflow">try</span> {
00629                 <span class="keywordflow">if</span> (phemsg-&gt;UnicodeStringParameterMask &amp; 0x4) {
00630                     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;usCaption, (PWSTR)adwParameterVector[2]);
00631                 } <span class="keywordflow">else</span> {
00632                     MBToWCS((LPSTR)adwParameterVector[2], -1, &amp;pwszTitle, -1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00633                     <a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(&amp;usCaption, pwszTitle);
00634                     <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, pwszTitle);
00635                 }
00636 
00637                 <span class="keywordflow">if</span> (phemsg-&gt;UnicodeStringParameterMask &amp; 0x8) {
00638                     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;usMessage, (PWSTR)adwParameterVector[3]);
00639                 } <span class="keywordflow">else</span> {
00640                     MBToWCS((LPSTR)adwParameterVector[3], -1, &amp;pwszMsg, -1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00641                     <a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(&amp;usMessage, pwszMsg);
00642                     <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, pwszMsg);
00643                 }
00644 
00645 
00646             } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00647 
00648                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"Exception reading STATUS_VDM_HARD_ERROR paramerters"</span>);
00649 
00650                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;usCaption);
00651                 <a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(&amp;usCaption, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"VDM Internal Error"</span>);
00652                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;usMessage);
00653                 <a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(&amp;usMessage, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Exception retrieving error text."</span>);
00654             }
00655             <span class="keywordflow">goto</span> CleanUpAndSaveParams;
00656     }
00657 
00658     <span class="comment">/*</span>
00659 <span class="comment">     * For all other status codes, we generate the information from the status code.</span>
00660 <span class="comment">     * First, Map status code and valid response to MessageBox flags.</span>
00661 <span class="comment">     */</span>
00662     dwMBFlags |= <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a2">wIcons</a>[(ULONG)(phemsg-&gt;Status) &gt;&gt; 30] | <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a3">wOptions</a>[phemsg-&gt;ValidResponseOptions];
00663 
00664 
00665     <span class="comment">/*</span>
00666 <span class="comment">     * If we have a client process, try to get the actual application name</span>
00667 <span class="comment">     */</span>
00668     pwszAppName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00669     <span class="keywordflow">if</span> (!fErrorIsFromSystem) {
00670         PPEB Peb;
00671         PROCESS_BASIC_INFORMATION BasicInfo;
00672         PLDR_DATA_TABLE_ENTRY LdrEntry;
00673         LDR_DATA_TABLE_ENTRY LdrEntryData;
00674         PLIST_ENTRY LdrHead, LdrNext;
00675         PPEB_LDR_DATA Ldr;
00676         PVOID ImageBaseAddress;
00677         PWSTR ClientApplicationName;
00678 
00679         <span class="comment">/*</span>
00680 <span class="comment">         * This is cumbersome, but basically, we locate the processes</span>
00681 <span class="comment">         * loader data table and get it's name directly out of the</span>
00682 <span class="comment">         * loader table</span>
00683 <span class="comment">         */</span>
00684 
00685         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/psquery_8c.html#a18">NtQueryInformationProcess</a>(hClientProcess, ProcessBasicInformation,
00686                     &amp;BasicInfo, <span class="keyword">sizeof</span>(BasicInfo), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00687 
00688         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00689             fErrorIsFromSystem = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00690             <span class="keywordflow">goto</span> noname;
00691         }
00692 
00693         Peb = BasicInfo.PebBaseAddress;
00694         <span class="keywordflow">if</span> (Peb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00695             fErrorIsFromSystem = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00696             <span class="keywordflow">goto</span> noname;
00697         }
00698 
00699         <span class="comment">/*</span>
00700 <span class="comment">         * ldr = Peb-&gt;Ldr</span>
00701 <span class="comment">         */</span>
00702         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a9">NtReadVirtualMemory</a>(hClientProcess, &amp;Peb-&gt;Ldr, &amp;Ldr,
00703                     <span class="keyword">sizeof</span>(Ldr), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00704 
00705         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00706             <span class="keywordflow">goto</span> noname;
00707         }
00708 
00709         LdrHead = &amp;Ldr-&gt;InLoadOrderModuleList;
00710 
00711         <span class="comment">/*</span>
00712 <span class="comment">         * LdrNext = Head-&gt;Flink;</span>
00713 <span class="comment">         */</span>
00714         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a9">NtReadVirtualMemory</a>(hClientProcess, &amp;LdrHead-&gt;Flink,
00715                     &amp;LdrNext, <span class="keyword">sizeof</span>(LdrNext), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00716 
00717         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00718             <span class="keywordflow">goto</span> noname;
00719         }
00720 
00721         <span class="keywordflow">if</span> (LdrNext == LdrHead) {
00722             <span class="keywordflow">goto</span> noname;
00723         }
00724         <span class="comment">/*</span>
00725 <span class="comment">         * This is the entry data for the image.</span>
00726 <span class="comment">         */</span>
00727         LdrEntry = CONTAINING_RECORD(LdrNext, LDR_DATA_TABLE_ENTRY, InLoadOrderLinks);
00728         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a9">NtReadVirtualMemory</a>(hClientProcess, LdrEntry,
00729                     &amp;LdrEntryData, <span class="keyword">sizeof</span>(LdrEntryData), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00730 
00731         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00732             <span class="keywordflow">goto</span> noname;
00733         }
00734 
00735         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a9">NtReadVirtualMemory</a>(hClientProcess, &amp;Peb-&gt;ImageBaseAddress,
00736                     &amp;ImageBaseAddress, <span class="keyword">sizeof</span>(ImageBaseAddress), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00737 
00738         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00739             <span class="keywordflow">goto</span> noname;
00740         }
00741 
00742         <span class="keywordflow">if</span> (ImageBaseAddress != LdrEntryData.DllBase) {
00743             <span class="keywordflow">goto</span> noname;
00744         }
00745 
00746         LdrNext = LdrEntryData.InLoadOrderLinks.Flink;
00747 
00748         ClientApplicationName = (PWSTR)LocalAlloc(<a class="code" href="../../d2/d3/ldrsnap_8c.html#a22">LMEM_ZEROINIT</a>, LdrEntryData.BaseDllName.MaximumLength);
00749         <span class="keywordflow">if</span> (ClientApplicationName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00750             <span class="keywordflow">goto</span> noname;
00751         }
00752 
00753         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a9">NtReadVirtualMemory</a>(hClientProcess, LdrEntryData.BaseDllName.Buffer,
00754                     ClientApplicationName, LdrEntryData.BaseDllName.MaximumLength,
00755                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00756 
00757         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00758             LocalFree(ClientApplicationName);
00759             <span class="keywordflow">goto</span> noname;
00760         }
00761 
00762         pwszAppName = ClientApplicationName;
00763         fFreeAppNameBuffer = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00764 
00765 noname:;
00766     } <span class="comment">/* if (!fErrorIsFromSystem) */</span>
00767 
00768     <span class="keywordflow">if</span> (pwszAppName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00769         <span class="comment">/*</span>
00770 <span class="comment">         * Load default application name (to be used in the caption).</span>
00771 <span class="comment">         */</span>
00772         pwszAppName = <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>(<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a0">ghModuleWin</a>, STR_UNKNOWN_APPLICATION,
00773                                         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"System Process"</span>, &amp;fFreeAppNameBuffer);
00774     }
00775 
00776     <span class="comment">/*</span>
00777 <span class="comment">     * Map status code to (optional) caption and format string.</span>
00778 <span class="comment">     * If a caption is provided, it's enclosed in {} and it's</span>
00779 <span class="comment">     *  the first thing in the format string</span>
00780 <span class="comment">     */</span>
00781     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00782     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a13">gNtDllHandle</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00783         <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a13">gNtDllHandle</a> = GetModuleHandle(TEXT(<span class="stringliteral">"ntdll"</span>));
00784         UserAssert(<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a13">gNtDllHandle</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00785     }
00786     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00787 
00788     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/message_8c.html#a1">RtlFindMessage</a>((PVOID)<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a13">gNtDllHandle</a>, (ULONG_PTR)RT_MESSAGETABLE,
00789                             LANG_NEUTRAL, phemsg-&gt;Status, &amp;MessageEntry);
00790 
00791     <span class="comment">/*</span>
00792 <span class="comment">     * Parse the caption (if any) and the format string.</span>
00793 <span class="comment">     */</span>
00794     pwszCaption = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00795     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00796         pwszFormatString = wszUnknownHardError;
00797     } <span class="keywordflow">else</span> {
00798         pwszFormatString = (PWSTR)MessageEntry-&gt;Text;
00799         <span class="comment">/*</span>
00800 <span class="comment">         * If the message starts with a '{', it has a caption.</span>
00801 <span class="comment">         */</span>
00802         <span class="keywordflow">if</span> (*pwszFormatString == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'{'</span>) {
00803             uCaptionLen = 0;
00804             pwszFormatString++;
00805             <span class="comment">/*</span>
00806 <span class="comment">             * Find the closing bracket</span>
00807 <span class="comment">             */</span>
00808             <span class="keywordflow">while</span> ((*pwszFormatString != (WCHAR)0) &amp;&amp; (*pwszFormatString++ != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'}'</span>)) {
00809                 uCaptionLen++;
00810             }
00811             <span class="comment">/*</span>
00812 <span class="comment">             * Eat any non-printable stuff (\r\n), up to the NULL</span>
00813 <span class="comment">             */</span>
00814             <span class="keywordflow">while</span> ((*pwszFormatString != (WCHAR)0) &amp;&amp; (*pwszFormatString &lt;= <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">' '</span>)) {
00815                 pwszFormatString++;
00816             }
00817             <span class="comment">/*</span>
00818 <span class="comment">             * Allocate a buffer an copy the caption string</span>
00819 <span class="comment">             */</span>
00820             <span class="keywordflow">if</span> ((uCaptionLen++ &gt; 0)
00821                 &amp;&amp; ((pwszCaption = (PWSTR)LocalAlloc(LPTR, uCaptionLen * <span class="keyword">sizeof</span>(WCHAR))) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00822 
00823                 RtlCopyMemory(pwszCaption, (PWSTR)MessageEntry-&gt;Text + 1, (uCaptionLen - 1) * <span class="keyword">sizeof</span>(WCHAR));
00824                 fFreeCaption = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00825             }
00826         } <span class="comment">/* if (*pszParsedCaption == '{') */</span>
00827 
00828         <span class="keywordflow">if</span> (*pwszFormatString == (WCHAR)0) {
00829             pwszFormatString = wszUnknownHardError;
00830         }
00831     } <span class="comment">/* if (!NT_SUCCESS(Status))  (Failed to read caption/format string) */</span>
00832 
00833 
00834     <span class="comment">/*</span>
00835 <span class="comment">     * If the message didn't include a caption (or we didn't find the message),</span>
00836 <span class="comment">     *  default to something</span>
00837 <span class="comment">     */</span>
00838     <span class="keywordflow">if</span> (pwszCaption == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00839         <span class="keywordflow">switch</span> (phemsg-&gt;Status &amp; ERROR_SEVERITY_ERROR) {
00840             <span class="keywordflow">case</span> ERROR_SEVERITY_SUCCESS:
00841                 pwszCaption = <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a15">gpwszaSUCCESS</a>;
00842                 <span class="keywordflow">break</span>;
00843             <span class="keywordflow">case</span> ERROR_SEVERITY_INFORMATIONAL:
00844                 pwszCaption = <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a16">gpwszaSYSTEM_INFORMATION</a>;
00845                 <span class="keywordflow">break</span>;
00846             <span class="keywordflow">case</span> ERROR_SEVERITY_WARNING:
00847                 pwszCaption = <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a17">gpwszaSYSTEM_WARNING</a>;
00848                 <span class="keywordflow">break</span>;
00849             <span class="keywordflow">case</span> ERROR_SEVERITY_ERROR:
00850                 pwszCaption = <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a18">gpwszaSYSTEM_ERROR</a>;
00851                 <span class="keywordflow">break</span>;
00852         }
00853     }
00854     UserAssert(pwszCaption != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00855     <span class="comment">/*</span>
00856 <span class="comment">     * If the client has a window, get its title so it can be added to</span>
00857 <span class="comment">     *  the caption.</span>
00858 <span class="comment">     */</span>
00859     hwndOwner = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00860     <a class="code" href="../../d0/d8/clenum_8c.html#a9">EnumThreadWindows</a>(HandleToUlong(phemsg-&gt;h.ClientId.UniqueThread),
00861                         <a class="code" href="../../d0/d7/server_2server_8c.html#a54">FindWindowFromThread</a>, (LPARAM)&amp;hwndOwner);
00862     <span class="keywordflow">if</span> (hwndOwner == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00863         uTitleLen = 0;
00864     } <span class="keywordflow">else</span> {
00865         uTitleLen = <a class="code" href="../../d5/d9/cltxt_8h.html#a22">GetWindowTextLength</a>(hwndOwner);
00866         <span class="keywordflow">if</span> (uTitleLen != 0) {
00867             pwszTitle = (PWSTR)LocalAlloc(LPTR, (uTitleLen + 3) * <span class="keyword">sizeof</span>(WCHAR));
00868             <span class="keywordflow">if</span> (pwszTitle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00869                 <a class="code" href="../../d5/d9/cltxt_8h.html#a21">GetWindowText</a>(hwndOwner, pwszTitle, uTitleLen + 1);
00870                 <span class="comment">/*</span>
00871 <span class="comment">                 * Add format chars.</span>
00872 <span class="comment">                 */</span>
00873                 *(pwszTitle + uTitleLen++) = (WCHAR)<span class="charliteral">':'</span>;
00874                 *(pwszTitle + uTitleLen++) = (WCHAR)<span class="charliteral">' '</span>;
00875             } <span class="keywordflow">else</span> {
00876                 <span class="comment">/*</span>
00877 <span class="comment">                 * We couldn't allocate a buffer to get the title</span>
00878 <span class="comment">                 */</span>
00879                 uTitleLen = 0;
00880             }
00881         } <span class="comment">/* if (uTitleLen != 0) */</span>
00882     } <span class="comment">/* else if (hwndOwner == NULL) */</span>
00883     <span class="comment">/*</span>
00884 <span class="comment">     * If we don't have a window title, make it an empty string so we won't</span>
00885 <span class="comment">     *  have to special case it later.</span>
00886 <span class="comment">     */</span>
00887     <span class="keywordflow">if</span> (uTitleLen == 0) {
00888         pwszTitle = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>;
00889     }
00890     <span class="comment">/*</span>
00891 <span class="comment">     * Finally we can build the caption string now.</span>
00892 <span class="comment">     * It looks like this: [WindowTile: ]ApplicationName - ErrorCaption</span>
00893 <span class="comment">     */</span>
00894     uCaptionLen = uTitleLen + wcslen(pwszAppName) + 3 + wcslen(pwszCaption) + 1;
00895     pwszFullCaption = (PWSTR)LocalAlloc(LPTR, uCaptionLen * <span class="keyword">sizeof</span>(WCHAR));
00896     <span class="keywordflow">if</span> (pwszFullCaption != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00897 <span class="preprocessor">        #if DBG</span>
00898 <span class="preprocessor"></span>        <span class="keywordtype">int</span> iLen =
00899 <span class="preprocessor">        #endif</span>
00900 <span class="preprocessor"></span>            <a class="code" href="../../d6/d0/wsprintf_8c.html#a10">wsprintfW</a>(pwszFullCaption, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"%s%s - %s"</span>, pwszTitle, pwszAppName, pwszCaption);
00901         UserAssert((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)iLen &lt; uCaptionLen);
00902         <a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(&amp;usCaption, pwszFullCaption);
00903         LocalFree(pwszFullCaption);
00904     }
00905     <span class="comment">/*</span>
00906 <span class="comment">     * Free caption working buffers, as appropriate.</span>
00907 <span class="comment">     */</span>
00908     <span class="keywordflow">if</span> (fFreeCaption) {
00909         LocalFree(pwszCaption);
00910     }
00911     <span class="keywordflow">if</span> (fFreeAppNameBuffer) {
00912         LocalFree(pwszAppName);
00913     }
00914     <span class="keywordflow">if</span> (uTitleLen != 0) {
00915         LocalFree(pwszTitle);
00916     }
00917     <span class="comment">/*</span>
00918 <span class="comment">     * Build the error message using pszFormatString and adwParameterVector.</span>
00919 <span class="comment">     * Special case UAE</span>
00920 <span class="comment">     */</span>
00921     <span class="keywordflow">if</span> (phemsg-&gt;Status == STATUS_UNHANDLED_EXCEPTION ) {
00922         <span class="comment">/*</span>
00923 <span class="comment">         * The first parameter has the exception status code. Map it to a</span>
00924 <span class="comment">         *  format string and build the error message with it and the</span>
00925 <span class="comment">         *  parameters.</span>
00926 <span class="comment">         */</span>
00927         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/message_8c.html#a1">RtlFindMessage</a>( (PVOID)<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a13">gNtDllHandle</a>, (ULONG_PTR)RT_MESSAGETABLE,
00928                                  LANG_NEUTRAL, (ULONG)adwParameterVector[0], &amp;MessageEntry);
00929 
00930         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00931             <span class="comment">/*</span>
00932 <span class="comment">             * We couldn't read the exception name so let's use unknown.</span>
00933 <span class="comment">             */</span>
00934             pwszResBuffer = <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>(<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a0">ghModuleWin</a>, STR_UNKNOWN_EXCEPTION,
00935                             wszUnkownSoftwareException, &amp;fResAllocated);
00936 
00937             <a class="code" href="../../d6/d0/wsprintf_8c.html#a10">wsprintfW</a>(wszErrorMessage, pwszFormatString, pwszResBuffer,
00938                       adwParameterVector[0], adwParameterVector[1]);
00939 
00940             <span class="keywordflow">if</span> (fResAllocated) {
00941                 LocalFree(pwszResBuffer);
00942             }
00943 
00944             <a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(&amp;usMessage, wszErrorMessage);
00945             UserAssert(usMessage.MaximumLength &lt;= <span class="keyword">sizeof</span>(wszErrorMessage));
00946 
00947         } <span class="keywordflow">else</span> {
00948             <span class="comment">/*</span>
00949 <span class="comment">             * Access Violations are handled a bit differently</span>
00950 <span class="comment">             */</span>
00951 
00952             <span class="keywordflow">if</span> (adwParameterVector[0] == STATUS_ACCESS_VIOLATION ) {
00953 
00954                 <a class="code" href="../../d6/d0/wsprintf_8c.html#a10">wsprintfW</a>(wszErrorMessage, (PWSTR)MessageEntry-&gt;Text, adwParameterVector[1],
00955                           adwParameterVector[3], adwParameterVector[2] ? <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"written"</span> : <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"read"</span>);
00956 
00957             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (adwParameterVector[0] == STATUS_IN_PAGE_ERROR) {
00958                 <a class="code" href="../../d6/d0/wsprintf_8c.html#a10">wsprintfW</a>(wszErrorMessage, (PWSTR)MessageEntry-&gt;Text, adwParameterVector[1],
00959                           adwParameterVector[3], adwParameterVector[2]);
00960 
00961             } <span class="keywordflow">else</span> {
00962                 <span class="comment">/*</span>
00963 <span class="comment">                 * If this is a marked exception, skip the mark;</span>
00964 <span class="comment">                 *  the exception name follows it.</span>
00965 <span class="comment">                 */</span>
00966                 pwszCaption = (PWSTR)MessageEntry-&gt;Text;
00967                 <span class="keywordflow">if</span> (!wcsncmp(pwszCaption, wszException, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(wszException) - 1)) {
00968                     pwszCaption += <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(wszException) - 1;
00969                     <span class="comment">/*</span>
00970 <span class="comment">                     * Skip not printable stuff (\r\n)</span>
00971 <span class="comment">                     */</span>
00972                     <span class="keywordflow">while</span> ((*pwszCaption != (WCHAR)0) &amp;&amp; (*pwszCaption &lt;= <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">' '</span>)) {
00973                         pwszCaption++;
00974                     }
00975 
00976                 } <span class="keywordflow">else</span> {
00977                     pwszCaption = wszUnkownSoftwareException;
00978                 }
00979 
00980                 <a class="code" href="../../d6/d0/wsprintf_8c.html#a10">wsprintfW</a>(wszErrorMessage, pwszFormatString, pwszCaption,
00981                           adwParameterVector[0], adwParameterVector[1]);
00982             }
00983 
00984             UserAssert(wcslen(wszErrorMessage) &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(wszErrorMessage));
00985 
00986             <span class="comment">/*</span>
00987 <span class="comment">             * Add button(s) explanation text.</span>
00988 <span class="comment">             */</span>
00989             pwszResBuffer = <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>(<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a0">ghModuleWin</a>, STR_OK_TO_TERMINATE,
00990                             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Click on OK to terminate the application"</span>,
00991                             &amp;fResAllocated);
00992 
00993 
00994             <span class="keywordflow">if</span> (phemsg-&gt;ValidResponseOptions == OptionOkCancel ) {
00995                 pwszResBuffer1 = <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>(<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a0">ghModuleWin</a>,
00996                                 STR_CANCEL_TO_DEBUG, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Click on CANCEL xx to debug the application"</span>,
00997                                 &amp;fResAllocated1);
00998             } <span class="keywordflow">else</span> {
00999                 pwszResBuffer1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01000                 fResAllocated1 = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01001             }
01002 
01003             <span class="comment">/*</span>
01004 <span class="comment">             * Conncatenate all strings, one per line.</span>
01005 <span class="comment">             */</span>
01006             uMsgLen = wcslen(wszErrorMessage)
01007                         + wcslen(pwszResBuffer) + 1
01008                         + (pwszResBuffer1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ? 0 : wcslen(pwszResBuffer1) + 1)
01009                         + 1;
01010 
01011             pwszMsg = (PWSTR) LocalAlloc(LPTR, uMsgLen * <span class="keyword">sizeof</span>(WCHAR));
01012             <span class="keywordflow">if</span> (pwszMsg != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01013 <span class="preprocessor">                #if DBG</span>
01014 <span class="preprocessor"></span>                <span class="keywordtype">int</span> iLen =
01015 <span class="preprocessor">                #endif</span>
01016 <span class="preprocessor"></span>                    <a class="code" href="../../d6/d0/wsprintf_8c.html#a10">wsprintfW</a>(pwszMsg, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"%s\n%s%s%s"</span>, wszErrorMessage, pwszResBuffer,
01017                               (pwszResBuffer1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ? <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span> : <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\n"</span>),
01018                               (pwszResBuffer1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ? <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span> : pwszResBuffer1));
01019 
01020                 UserAssert((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)iLen &lt; uMsgLen);
01021 
01022                 <a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(&amp;usMessage, pwszMsg);
01023                 LocalFree(pwszMsg);
01024             }
01025 
01026             <span class="comment">/*</span>
01027 <span class="comment">             * Free ServerLoadString allocations.</span>
01028 <span class="comment">             */</span>
01029             <span class="keywordflow">if</span> (fResAllocated) {
01030                 LocalFree(pwszResBuffer);
01031             }
01032 
01033             <span class="keywordflow">if</span> (fResAllocated1) {
01034                 LocalFree(pwszResBuffer1);
01035             }
01036 
01037 
01038         }
01039 
01040     } <span class="keywordflow">else</span> {
01041         <span class="comment">/*</span>
01042 <span class="comment">         * Default message text generation for all other status codes</span>
01043 <span class="comment">         */</span>
01044         <span class="keywordflow">try</span> {
01045 <span class="preprocessor">            #if DBG</span>
01046 <span class="preprocessor"></span>            <span class="keywordtype">int</span> iLen =
01047 <span class="preprocessor">            #endif</span>
01048 <span class="preprocessor"></span>                <a class="code" href="../../d6/d0/wsprintf_8c.html#a10">wsprintfW</a>(wszErrorMessage, pwszFormatString, adwParameterVector[0],
01049                                               adwParameterVector[1],
01050                                               adwParameterVector[2],
01051                                               adwParameterVector[3]);
01052             UserAssert((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)iLen &lt;  <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(wszErrorMessage));
01053 
01054             <span class="comment">/*</span>
01055 <span class="comment">             * Remove \r\n</span>
01056 <span class="comment">             */</span>
01057             pwszFormatString = wszErrorMessage;
01058             <span class="keywordflow">while</span> (*pwszFormatString != (WCHAR)0) {
01059                 <span class="keywordflow">if</span> (*pwszFormatString == (WCHAR)0xd) {
01060                     *pwszFormatString = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">' '</span>;
01061                     <span class="comment">/*</span>
01062 <span class="comment">                     * Move everything up if a CR LF sequence is found</span>
01063 <span class="comment">                     */</span>
01064                     <span class="keywordflow">if</span> (*(pwszFormatString+1) == (WCHAR)0xa) {
01065                         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uSize = (wcslen(pwszFormatString+1) + 1) * <span class="keyword">sizeof</span>(WCHAR);
01066                         RtlMoveMemory(pwszFormatString, pwszFormatString+1, uSize);
01067                     }
01068                  }
01069 
01070                 <span class="keywordflow">if</span> (*pwszFormatString == (WCHAR)0xa) {
01071                     *pwszFormatString = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">' '</span>;
01072                 }
01073 
01074                 pwszFormatString++;
01075             }
01076 
01077             <a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(&amp;usMessage, wszErrorMessage);
01078             UserAssert(usMessage.MaximumLength &lt;= <span class="keyword">sizeof</span>(wszErrorMessage));
01079         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01080 
01081             <a class="code" href="../../d6/d0/wsprintf_8c.html#a10">wsprintfW</a>(wszErrorMessage, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Exception Processing Message %lx Parameters %lx %lx %lx %lx"</span>,
01082                       phemsg-&gt;Status, adwParameterVector[0], adwParameterVector[1],
01083                       adwParameterVector[2], adwParameterVector[3]);
01084 
01085             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;usMessage);
01086             <a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(&amp;usMessage, wszErrorMessage);
01087             UserAssert(usMessage.MaximumLength &lt;= <span class="keyword">sizeof</span>(wszErrorMessage));
01088 
01089         } <span class="comment">/* try */</span>
01090 
01091     } <span class="comment">/* else if (phemsg-&gt;Status == STATUS_UNHANDLED_EXCEPTION) */</span>
01092 
01093 
01094 CleanUpAndSaveParams:
01095      <span class="keywordflow">if</span> (hClientProcess != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01096          <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hClientProcess);
01097      }
01098     <span class="comment">/*</span>
01099 <span class="comment">     * Free string parameters.</span>
01100 <span class="comment">     * Note that we're supposed to call RtlFreeAnsiString since these were</span>
01101 <span class="comment">     *  allocated by RtlUnicodeStringToAnsiString.... but we only saved the buffers...</span>
01102 <span class="comment">     */</span>
01103     <span class="keywordflow">if</span> (dwStringsToFreeMask != 0) {
01104         <span class="keywordflow">for</span> (dwCounter = 0; dwCounter &lt; phemsg-&gt;NumberOfParameters; dwCounter++) {
01105             <span class="keywordflow">if</span> (dwStringsToFreeMask &amp; (1 &lt;&lt; dwCounter)) {
01106                 <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, (PVOID)adwParameterVector[dwCounter]);
01107             }
01108         }
01109     }
01110     <span class="comment">/*</span>
01111 <span class="comment">     * Save MessageBox Parameters in phi to be used and freed later.</span>
01112 <span class="comment">     */</span>
01113     <span class="keywordflow">if</span> (fErrorIsFromSystem) {
01114         phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> |= <a class="code" href="../../d7/d1/usersrv_8h.html#a27">HEIF_SYSTEMERROR</a>;
01115     }
01116     phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o5">usText</a> = usMessage;
01117     phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o6">usCaption</a> = usCaption;
01118     phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o7">dwMBFlags</a> = dwMBFlags;
01119     <span class="keywordflow">return</span>;
01120 }
01121 <span class="comment">/***************************************************************************\</span>
01122 <span class="comment">* HardErrorHandler</span>
01123 <span class="comment">*</span>
01124 <span class="comment">* This routine processes hard error requests from the CSR exception port</span>
01125 <span class="comment">*</span>
01126 <span class="comment">* History:</span>
01127 <span class="comment">* 07-03-91 JimA             Created.</span>
01128 <span class="comment">\***************************************************************************/</span>
<a name="l01129"></a><a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a25">01129</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a25">HardErrorHandler</a>(<span class="keywordtype">void</span>)
01130 {
01131     <span class="keywordtype">int</span> idResponse;
01132     <a class="code" href="../../d3/d6/structtagHARDERRORINFO.html">PHARDERRORINFO</a> phi, *pphi;
01133     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwResponse;
01134     DESKRESTOREDATA drdRestore;
01135     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fNuked;
01136     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uHECRet;
01137     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwCmd;
01138     HANDLE hThread;
01139     <span class="keywordtype">int</span> aidButton[3], cButtons;
01140     LPWSTR apstrButton[3];
01141     <a class="code" href="../../d7/d9/struct__MSGBOXDATA.html">MSGBOXDATA</a> mbd;
01142     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bDoBlock;
01143     <a class="code" href="../../d5/d1/structtagCTXHARDERRORINFO.html">PCTXHARDERRORINFO</a> pCtxHEInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01144     MSG <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
01145 
01146 <span class="preprocessor">#if DBG</span>
01147 <span class="preprocessor"></span>    <span class="comment">/*</span>
01148 <span class="comment">     * We should have only one error handler at the time.</span>
01149 <span class="comment">     */</span>
01150     <span class="keyword">static</span> <span class="keywordtype">long</span> glReentered = -1;
01151     UserAssert(InterlockedIncrement(&amp;glReentered) == 0);
01152 <span class="preprocessor">#endif</span>
01153 <span class="preprocessor"></span>
01154     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
01155         bDoBlock = (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a340">gbExitInProgress</a> || (HEC_ERROR == <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a82">NtUserHardErrorControl</a>(HardErrorSetup, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)));
01156     } <span class="keywordflow">else</span> {
01157         bDoBlock = (HEC_ERROR == <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a82">NtUserHardErrorControl</a>(HardErrorSetup, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>));
01158     }
01159 
01160     drdRestore.pdeskRestore = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01161 
01162     <span class="keywordflow">if</span> (bDoBlock) {
01163         <span class="comment">/*</span>
01164 <span class="comment">         * We failed to set up to process hard errors.  Acknowledge all</span>
01165 <span class="comment">         * pending errors as NotHandled.</span>
01166 <span class="comment">         */</span>
01167         <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
01168         <span class="keywordflow">while</span> (<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a11">gphiList</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01169             phi = <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a11">gphiList</a>;
01170             <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a11">gphiList</a> = phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o0">phiNext</a>;
01171             <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01172             <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a21">ReplyHardError</a>(phi, ResponseNotHandled);
01173             <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
01174         }
01175         UserAssert(InterlockedDecrement(&amp;glReentered) &lt; 0);
01176         UserAssert(<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a12">gdwHardErrorThreadId</a> == HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread));
01177         <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a12">gdwHardErrorThreadId</a> = 0;
01178         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01179         <span class="keywordflow">return</span>;
01180     }
01181 
01182     <span class="comment">/*</span>
01183 <span class="comment">     * Process all hard error requests.</span>
01184 <span class="comment">     */</span>
01185 
01186     <span class="keywordflow">for</span> (;;) {
01187         <span class="comment">/*</span>
01188 <span class="comment">         * Grab the next request (for the current desktop)</span>
01189 <span class="comment">         * If we're done, reset gdwHardErrorThreadId so any request</span>
01190 <span class="comment">         *  after this point will be handled by someone else</span>
01191 <span class="comment">         */</span>
01192         <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
01193         phi = <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a11">gphiList</a>;
01194         <span class="keywordflow">if</span> (phi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01195             UserAssert(InterlockedDecrement(&amp;glReentered) &lt; 0);
01196             UserAssert(<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a12">gdwHardErrorThreadId</a> == HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread));
01197             <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a12">gdwHardErrorThreadId</a> = 0;
01198         } <span class="keywordflow">else</span> {
01199             <span class="keywordflow">while</span> ((phi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a26">HEIF_WRONGDESKTOP</a>)) {
01200                 phi = phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o0">phiNext</a>;
01201             }
01202             <span class="keywordflow">if</span> (phi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01203                 <span class="comment">/*</span>
01204 <span class="comment">                 * We're going to show this one.</span>
01205 <span class="comment">                 */</span>
01206                 phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> |= <a class="code" href="../../d7/d1/usersrv_8h.html#a21">HEIF_ACTIVE</a>;
01207             } <span class="keywordflow">else</span> {
01208                 <span class="comment">/*</span>
01209 <span class="comment">                 * We have some requests pending but they are not</span>
01210 <span class="comment">                 *  for the current desktop. Let's wait for another</span>
01211 <span class="comment">                 *  request (WM_NULL posted) or a desktop switch (PostQuitMessage)</span>
01212 <span class="comment">                 */</span>
01213                 <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01214                 <a class="code" href="../../d3/d8/client_8c.html#a57">MsgWaitForMultipleObjects</a>(0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, INFINITE, QS_POSTMESSAGE);
01215                 <a class="code" href="../../d5/d9/cltxt_8h.html#a14">PeekMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, 0, PM_REMOVE);
01216                 <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a22">CheckDefaultDesktop</a>();
01217                 <span class="keywordflow">continue</span>;
01218             }
01219         }
01220         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01221         <span class="comment">/*</span>
01222 <span class="comment">         * If no messages are pending, we're done.</span>
01223 <span class="comment">         */</span>
01224         <span class="keywordflow">if</span> (phi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01225             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a82">NtUserHardErrorControl</a>(HardErrorCleanup, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01226             <span class="keywordflow">return</span>;
01227         }
01228 
01229         <span class="comment">/*</span>
01230 <span class="comment">         * The Boost routine can mess with the list, so must get citrix info now.</span>
01231 <span class="comment">         */</span>
01232         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
01233             pCtxHEInfo = phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o10">pCtxHEInfo</a>;
01234             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a340">gbExitInProgress</a>) {
01235                 dwResponse = ResponseOk;
01236                 <span class="keywordflow">goto</span> Reply;
01237             }
01238         }
01239 
01240         <span class="comment">/*</span>
01241 <span class="comment">         * Get win32k attach parameters.</span>
01242 <span class="comment">         */</span>
01243         dwCmd = (phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o7">dwMBFlags</a> &amp; MB_DEFAULT_DESKTOP_ONLY) ? HardErrorAttachUser : HardErrorAttach;
01244         hThread = (phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o1">pthread</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ? phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o1">pthread</a>-&gt;ThreadHandle : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01245         <span class="comment">/*</span>
01246 <span class="comment">         * We have already handled the MB_SERVICE_NOTIFICATION flags.</span>
01247 <span class="comment">         * Clear it to prevent recursion.</span>
01248 <span class="comment">         * Also, don't let hard error boxes steal the foreground</span>
01249 <span class="comment">         */</span>
01250         phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o7">dwMBFlags</a> &amp;= ~(MB_SERVICE_NOTIFICATION | MB_SETFOREGROUND | MB_SYSTEMMODAL);
01251         <span class="comment">/*</span>
01252 <span class="comment">         * If this is a VDM error, figure out buttons, default id, style, etc</span>
01253 <span class="comment">         */</span>
01254         <span class="keywordflow">if</span> (phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a28">HEIF_VDMERROR</a>) {
01255             <span class="keywordtype">int</span> i;
01256             WORD rgwBtn[3], wBtn;
01257             <span class="comment">/*</span>
01258 <span class="comment">             * Initialize MSGBOXDATA with the information we</span>
01259 <span class="comment">             *  have already figured out.</span>
01260 <span class="comment">             */</span>
01261             RtlZeroMemory(&amp;mbd, <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html">MSGBOXDATA</a>));
01262             mbd.cbSize = <span class="keyword">sizeof</span>(MSGBOXPARAMS);
01263             mbd.lpszText = phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o5">usText</a>.Buffer;
01264             mbd.lpszCaption = phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o6">usCaption</a>.Buffer;
01265             <span class="comment">/*</span>
01266 <span class="comment">             * phi-&gt;dwVDMParam0 = (fForWOW &lt;&lt; 16) | wBtn1;</span>
01267 <span class="comment">             * phi-&gt;dwVDMParam1 = (wBtn2   &lt;&lt; 16) | wBtn3;</span>
01268 <span class="comment">             * Right now, only WOW does this.  If NTVDM does it,</span>
01269 <span class="comment">             * fForWOW will be false.</span>
01270 <span class="comment">             */</span>
01271             rgwBtn[0] = LOWORD(phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o8">dwVDMParam0</a>);
01272             rgwBtn[1] = HIWORD(phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o9">dwVDMParam1</a>);
01273             rgwBtn[2] = LOWORD(phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o9">dwVDMParam1</a>);
01274             cButtons = 0;
01275             <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++) {
01276                 wBtn = rgwBtn[i] &amp; ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a890">SEB_DEFBUTTON</a>;
01277                 <span class="keywordflow">if</span> (wBtn &amp;&amp; wBtn &lt;= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a880">MAX_SEB_STYLES</a>) {
01278                     apstrButton[cButtons] = <a class="code" href="../../d1/d0/inc_2user_8h.html#a1144">MB_GetString</a>(wBtn-1);
01279                     aidButton[cButtons] = i + 1;
01280                     <span class="keywordflow">if</span> (rgwBtn[i] &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a890">SEB_DEFBUTTON</a>) {
01281                         mbd.<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o6">DefButton</a> = cButtons;
01282                     }
01283                     <span class="keywordflow">if</span> (wBtn == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a882">SEB_CANCEL</a>) {
01284                         mbd.<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o7">CancelId</a> = cButtons;
01285                     }
01286                     cButtons++;
01287                 }
01288             }
01289             mbd.dwStyle = MB_TOPMOST;
01290             <span class="keywordflow">if</span> ((cButtons != 1) || (aidButton[0] != 1)) {
01291                 mbd.dwStyle |= MB_OKCANCEL;
01292             }
01293             mbd.<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o4">ppszButtonText</a> = apstrButton;
01294             mbd.<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o3">pidButton</a> = aidButton;
01295             mbd.<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o5">cButtons</a> = cButtons;
01296         }
01297         <span class="comment">/*</span>
01298 <span class="comment">         * Attach to win32k and show the dialog.</span>
01299 <span class="comment">         * If we switch desktops, (loop and) show it on the new desktop (if applicable)</span>
01300 <span class="comment">         */</span>
01301         <span class="keywordflow">do</span> {
01302             phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o3">pmsg</a>-&gt;Response = ResponseNotHandled;
01303 
01304             uHECRet = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a82">NtUserHardErrorControl</a>(dwCmd, hThread, &amp;drdRestore);
01305 
01306             <span class="keywordflow">if</span> (uHECRet == HEC_SUCCESS) {
01307                 <span class="keywordflow">if</span> (phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a28">HEIF_VDMERROR</a>) {
01308                     idResponse = <a class="code" href="../../d1/d0/inc_2user_8h.html#a1145">SoftModalMessageBox</a>(&amp;mbd);
01309                 } <span class="keywordflow">else</span> {
01310                     <span class="comment">/*</span>
01311 <span class="comment">                     * Bring up the message box. Or in MB_TOPMOST so</span>
01312 <span class="comment">                     * it comes up on top.</span>
01313 <span class="comment">                     * We want to preserve the MB_DEFAULT_DESKTOP_ONLY flag</span>
01314 <span class="comment">                     *  but don't want to pass it to MessageBox or we'll</span>
01315 <span class="comment">                     *  recurse due to a compatibility hack</span>
01316 <span class="comment">                     */</span>
01317 
01318                     <span class="comment">/*</span>
01319 <span class="comment">                     *  Really a Terminal Server message</span>
01320 <span class="comment">                     */</span>
01321                     <span class="keywordflow">if</span> (pCtxHEInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01322 
01323                         <span class="comment">/*</span>
01324 <span class="comment">                         * If timeout is not (-1), or 0, then we must queue</span>
01325 <span class="comment">                         * a system timer to call our timer callback function</span>
01326 <span class="comment">                         * to cancel the message box.</span>
01327 <span class="comment">                         */</span>
01328                         <span class="keywordflow">if</span> ((pCtxHEInfo-&gt;<a class="code" href="../../d5/d1/structtagCTXHARDERRORINFO.html#o5">Timeout</a> != (-1)) &amp;&amp; (pCtxHEInfo-&gt;<a class="code" href="../../d5/d1/structtagCTXHARDERRORINFO.html#o5">Timeout</a> != 0)) {
01329 
01330                             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> Timeout;
01331 
01332                             <span class="keywordflow">if</span> (((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)pCtxHEInfo-&gt;<a class="code" href="../../d5/d1/structtagCTXHARDERRORINFO.html#o5">Timeout</a>) &lt; (MAXLONG/1000)) {
01333                                 Timeout = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)pCtxHEInfo-&gt;<a class="code" href="../../d5/d1/structtagCTXHARDERRORINFO.html#o5">Timeout</a> * 1000<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
01334                             } <span class="keywordflow">else</span> {
01335                                 Timeout = MAXLONG;
01336                             }
01337 
01338                             <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a1">gfTimedOut</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01339                             <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a6">gTimerId</a> = <a class="code" href="../../d3/d0/user32_8def.html#a56">SetTimer</a>((HWND)0,
01340                                                 (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)0,
01341                                                 Timeout,
01342                                                 <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a23">MsgBoxTimerFunc</a>);
01343                             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a6">gTimerId</a> == 0) {
01344                                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"HardErrorHandler: Could not set system timer"</span>);
01345                             }
01346                         }
01347 
01348                         RIPMSG2(RIP_WARNING, <span class="stringliteral">"HardErrorHandler: MessageBoxEx( %S, %S )"</span>,
01349                                 phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o5">usText</a>.Buffer, phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o6">usCaption</a>.Buffer);
01350                     } <span class="keywordflow">else</span> {
01351                         RIPMSG2(RIP_WARNING, <span class="stringliteral">"HardErrorHandler: MessageBoxEx( %S, %S )"</span>,
01352                                 phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o5">usText</a>.Buffer, phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o6">usCaption</a>.Buffer);
01353                     }
01354 
01355                     idResponse = MessageBoxEx(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o5">usText</a>.Buffer, phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o6">usCaption</a>.Buffer,
01356                         (phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o7">dwMBFlags</a> | MB_TOPMOST) &amp; ~MB_DEFAULT_DESKTOP_ONLY, 0);
01357                 }
01358                 <span class="comment">/*</span>
01359 <span class="comment">                 * Restore hard error handler desktop; this will also</span>
01360 <span class="comment">                 *  tell us if the input desktop has changed; if so,</span>
01361 <span class="comment">                 *  we want to bring the error box again on the new</span>
01362 <span class="comment">                 *  desktop.</span>
01363 <span class="comment">                 */</span>
01364                 uHECRet = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a82">NtUserHardErrorControl</a>(HardErrorDetach, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;drdRestore);
01365 
01366                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
01367                     <span class="comment">/*</span>
01368 <span class="comment">                     * Kill the timer if set</span>
01369 <span class="comment">                     */</span>
01370                     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a6">gTimerId</a>) {
01371                         KillTimer((HWND)0, <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a6">gTimerId</a>);
01372                         <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a6">gTimerId</a> = 0;
01373                     }
01374                     <span class="comment">/*</span>
01375 <span class="comment">                     *  Really a citrix message</span>
01376 <span class="comment">                     */</span>
01377                     <span class="keywordflow">if</span> (uHECRet != HEC_DESKTOPSWITCH &amp;&amp; pCtxHEInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01378 
01379                         <span class="comment">/*</span>
01380 <span class="comment">                         * Check for message box timeout</span>
01381 <span class="comment">                         */</span>
01382                         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a1">gfTimedOut</a>) {
01383                            uHECRet = HEC_SUCCESS;
01384                            <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a1">gfTimedOut</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01385                            pCtxHEInfo-&gt;<a class="code" href="../../d5/d1/structtagCTXHARDERRORINFO.html#o6">Response</a> = IDTIMEOUT;
01386                         } <span class="keywordflow">else</span> {
01387                            pCtxHEInfo-&gt;<a class="code" href="../../d5/d1/structtagCTXHARDERRORINFO.html#o6">Response</a> = idResponse;
01388                         }
01389 
01390                     }
01391                     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a4">dwResponses</a>[idResponse] == ResponseNotHandled &amp;&amp;
01392                         uHECRet == HEC_DESKTOPSWITCH &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a327">gSessionId</a> == 0) {
01393 
01394                         RIPMSG2(RIP_WARNING, <span class="stringliteral">"HardErrorHandler: abort harderror, idResponse %u, uHECRet %u"</span>,
01395                                     idResponse, uHECRet);
01396 
01397                         <span class="keywordflow">break</span>;
01398                     }
01399                 }
01400             } <span class="keywordflow">else</span> {
01401                 idResponse = 0;
01402             }
01403             UserAssert((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)idResponse &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(<a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a4">dwResponses</a>));
01404             dwResponse = <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a4">dwResponses</a>[idResponse];
01405             <span class="comment">/*</span>
01406 <span class="comment">             * If we don't want to reshow this box, done</span>
01407 <span class="comment">             */</span>
01408             <span class="keywordflow">if</span> (uHECRet != HEC_DESKTOPSWITCH) {
01409                 <span class="keywordflow">break</span>;
01410             } <span class="keywordflow">else</span> {
01411                 <span class="comment">/*</span>
01412 <span class="comment">                 * We've switched desktops; if we're in the default one</span>
01413 <span class="comment">                 *  now, then we can show all MB_DEFAULT_DESKTOP_ONLY</span>
01414 <span class="comment">                 *  requests.</span>
01415 <span class="comment">                 */</span>
01416                 <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a22">CheckDefaultDesktop</a>();
01417             }
01418             <span class="comment">/*</span>
01419 <span class="comment">             * If BoostHardError nuked it, don't re-show it</span>
01420 <span class="comment">             */</span>
01421             <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
01422             fNuked = (phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a22">HEIF_NUKED</a>);
01423             <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01424         } <span class="keywordflow">while</span> (!fNuked);
01425 
01426         <span class="comment">/*</span>
01427 <span class="comment">         * If we didn't show this box because we're not in the</span>
01428 <span class="comment">         *  default desktop, mark this phi and continue</span>
01429 <span class="comment">         */</span>
01430         <span class="keywordflow">if</span> (uHECRet == HEC_WRONGDESKTOP) {
01431             UserAssert(phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o7">dwMBFlags</a> &amp; MB_DEFAULT_DESKTOP_ONLY);
01432             <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
01433             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a14">COPY_FLAG</a>(phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a>, <a class="code" href="../../d7/d1/usersrv_8h.html#a26">HEIF_WRONGDESKTOP</a>, <a class="code" href="../../d7/d1/usersrv_8h.html#a21">HEIF_ACTIVE</a> | <a class="code" href="../../d7/d1/usersrv_8h.html#a26">HEIF_WRONGDESKTOP</a>);
01434             <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01435             <span class="keywordflow">continue</span>;
01436         }
01437 
01438 Reply:
01439         <span class="comment">/*</span>
01440 <span class="comment">         * We're done with this phi.</span>
01441 <span class="comment">         * Unlink it if BoostHardError haven't done so already;</span>
01442 <span class="comment">         *  If unlinked, it is marked as nuked.</span>
01443 <span class="comment">         */</span>
01444         <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
01445         UserAssert(phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a21">HEIF_ACTIVE</a>);
01446         fNuked = (phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a22">HEIF_NUKED</a>);
01447         <span class="keywordflow">if</span> (!fNuked) {
01448             pphi = &amp;<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a11">gphiList</a>;
01449             <span class="keywordflow">while</span> ((*pphi != phi) &amp;&amp; (*pphi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01450                 pphi = &amp;(*pphi)-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o0">phiNext</a>;
01451             }
01452             UserAssert(*pphi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01453             *pphi = phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o0">phiNext</a>;
01454         }
01455 
01456 <span class="preprocessor">#if DBG</span>
01457 <span class="preprocessor"></span>         <span class="keywordflow">else</span> {
01458             <span class="comment">/*</span>
01459 <span class="comment">             * Let's make sure it was unlinked.</span>
01460 <span class="comment">             */</span>
01461             pphi = &amp;<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a11">gphiList</a>;
01462             <span class="keywordflow">while</span> ((*pphi != phi) &amp;&amp; (*pphi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01463                 UserAssert(!((*pphi)-&gt;dwHEIFFlags &amp; (<a class="code" href="../../d7/d1/usersrv_8h.html#a21">HEIF_ACTIVE</a> | <a class="code" href="../../d7/d1/usersrv_8h.html#a22">HEIF_NUKED</a>)));
01464                 pphi = &amp;(*pphi)-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o0">phiNext</a>;
01465             }
01466             UserAssert(*pphi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01467          }
01468 <span class="preprocessor">#endif</span>
01469 <span class="preprocessor"></span>
01470         <span class="keywordflow">if</span> (phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o10">pCtxHEInfo</a>) {
01471 
01472             <span class="comment">/*</span>
01473 <span class="comment">             * Clean up</span>
01474 <span class="comment">             */</span>
01475             <a class="code" href="../../d6/d4/icamsg_8c.html#a7">HardErrorRemove</a>(phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o10">pCtxHEInfo</a>);
01476 
01477             <span class="comment">/*</span>
01478 <span class="comment">             * Done</span>
01479 <span class="comment">             */</span>
01480             phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o10">pCtxHEInfo</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01481         }
01482 
01483         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01484 
01485         <span class="comment">/*</span>
01486 <span class="comment">         * Save the response, reply and free phi</span>
01487 <span class="comment">         */</span>
01488         <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a21">ReplyHardError</a>(phi, (fNuked ? ResponseNotHandled : dwResponse));
01489 
01490     } <span class="comment">/* for (;;) */</span>
01491 
01492     <span class="comment">/*</span>
01493 <span class="comment">     * Nobody should break out of the loop.</span>
01494 <span class="comment">     */</span>
01495     UserAssert(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01496 }
01497 
01498 
<a name="l01499"></a><a class="code" href="../../d7/d1/usersrv_8h.html#a57">01499</a> LPWSTR <a class="code" href="../../d7/d1/usersrv_8h.html#a57">RtlLoadStringOrError</a>(
01500     HANDLE hModule,
01501     UINT wID,
01502     LPWSTR lpDefault,
01503     PBOOL pAllocated,
01504     BOOL bAnsi
01505     )
01506 {
01507     LPTSTR lpsz;
01508     <span class="keywordtype">int</span> cch;
01509     LPWSTR lpw;
01510     PMESSAGE_RESOURCE_ENTRY MessageEntry;
01511     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01512 
01513     cch = 0;
01514     lpw = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01515 
01516     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/message_8c.html#a1">RtlFindMessage</a>((PVOID)hModule, (ULONG_PTR)RT_MESSAGETABLE,
01517             0, wID, &amp;MessageEntry);
01518     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01519 
01520         <span class="comment">/*</span>
01521 <span class="comment">         * Return two fewer chars so the crlf in the message will be</span>
01522 <span class="comment">         * stripped out.</span>
01523 <span class="comment">         */</span>
01524         cch = wcslen((PWCHAR)MessageEntry-&gt;Text) - 2;
01525         lpsz = (LPWSTR)MessageEntry-&gt;Text;
01526 
01527         <span class="keywordflow">if</span> (bAnsi) {
01528             <span class="keywordtype">int</span> ich;
01529 
01530             <span class="comment">/*</span>
01531 <span class="comment">             * Add one to zero terminate then force the termination</span>
01532 <span class="comment">             */</span>
01533             ich = WCSToMB(lpsz, cch+1, (<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> **)&amp;lpw, -1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01534             ((LPSTR)lpw)[ich-1] = 0;
01535 
01536             }
01537         <span class="keywordflow">else</span> {
01538             lpw = (LPWSTR)LocalAlloc(<a class="code" href="../../d2/d3/ldrsnap_8c.html#a22">LMEM_ZEROINIT</a>,(cch+1)*<span class="keyword">sizeof</span>(WCHAR));
01539             <span class="keywordflow">if</span> ( lpw ) {
01540 
01541                 <span class="comment">/*</span>
01542 <span class="comment">                 * Copy the string into the buffer.</span>
01543 <span class="comment">                 */</span>
01544                     RtlCopyMemory(lpw, lpsz, cch*<span class="keyword">sizeof</span>(WCHAR));
01545                 }
01546             }
01547         }
01548 
01549     <span class="keywordflow">if</span> ( !lpw ) {
01550         lpw = lpDefault;
01551         *pAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01552         } <span class="keywordflow">else</span> {
01553         *pAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01554         }
01555 
01556     <span class="keywordflow">return</span> lpw;
01557 }
01558 
01559 <span class="comment">/***************************************************************************\</span>
01560 <span class="comment">* HardErrorWorkerThread</span>
01561 <span class="comment">*</span>
01562 <span class="comment">* Worker thread to handle hard error requests.</span>
01563 <span class="comment">*</span>
01564 <span class="comment">* History:</span>
01565 <span class="comment">* 05-01-98 JerrySh      Created.</span>
01566 <span class="comment">\***************************************************************************/</span>
01567 
01568 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01569"></a><a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a27">01569</a> <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a27">HardErrorWorkerThread</a>(
01570     PVOID ThreadParameter
01571     )
01572 {
01573     PCSR_THREAD pt;
01574     UNREFERENCED_PARAMETER(ThreadParameter);
01575 
01576     pt = CsrConnectToUser();
01577     <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a13">ProcessHardErrorRequest</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01578     <span class="keywordflow">if</span> (pt) {
01579         CsrDereferenceThread(pt);
01580     }
01581     <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a12">UserExitWorkerThread</a>();
01582 
01583     <span class="keywordflow">return</span> STATUS_SUCCESS;
01584 }
01585 
01586 <span class="comment">/***************************************************************************\</span>
01587 <span class="comment">* ProcessHardErrorRequest</span>
01588 <span class="comment">*</span>
01589 <span class="comment">* Figures out who should process the hard error. There are 3 possible cases.</span>
01590 <span class="comment">* - If there is already a hard error thread, hand it off to him.</span>
01591 <span class="comment">* - If not and we don't want to wait, create a worker thread to deal with it.</span>
01592 <span class="comment">* - If we want to wait or thread creation fails, deal with it ourselves.</span>
01593 <span class="comment">*</span>
01594 <span class="comment">* History:</span>
01595 <span class="comment">* 05-01-98 JerrySh      Created.</span>
01596 <span class="comment">\***************************************************************************/</span>
01597 
01598 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01599"></a><a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a13">01599</a> <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a13">ProcessHardErrorRequest</a>(
01600     BOOL fNewThread
01601     )
01602 {
01603     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01604     CLIENT_ID ClientId;
01605     HANDLE hThread;
01606 
01607     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
01608 
01609     <span class="comment">/*</span>
01610 <span class="comment">     * If there's already a hard error handler, make sure he's awake.</span>
01611 <span class="comment">     */</span>
01612     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a12">gdwHardErrorThreadId</a>) {
01613         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwHardErrorHandler = <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a12">gdwHardErrorThreadId</a>;
01614         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01615         <a class="code" href="../../d0/d8/ntcftxt_8h.html#a21">PostThreadMessage</a>(dwHardErrorHandler, WM_NULL, 0, 0);
01616         <span class="keywordflow">return</span>;
01617     }
01618 
01619     <span class="comment">/*</span>
01620 <span class="comment">     * Create a worker thread to handle the hard error.</span>
01621 <span class="comment">     */</span>
01622     <span class="keywordflow">if</span> (fNewThread) {
01623         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01624         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/rtlexec_8c.html#a13">RtlCreateUserThread</a>(NtCurrentProcess(),
01625                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01626                                      <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01627                                      0,
01628                                      0,
01629                                      0,
01630                                      <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a27">HardErrorWorkerThread</a>,
01631                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01632                                      &amp;hThread,
01633                                      &amp;ClientId);
01634         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01635             CsrAddStaticServerThread(hThread, &amp;ClientId, 0);
01636             <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>(hThread, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01637             <span class="keywordflow">return</span>;
01638         }
01639         <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
01640     }
01641 
01642     <span class="comment">/*</span>
01643 <span class="comment">     * Let this thread handle the hard error.</span>
01644 <span class="comment">     */</span>
01645     <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a12">gdwHardErrorThreadId</a> = HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread);
01646     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01647     <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a25">HardErrorHandler</a>();
01648 
01649     <span class="keywordflow">return</span>;
01650 }
01651 
01652 <span class="comment">/***************************************************************************\</span>
01653 <span class="comment">* UserHardError</span>
01654 <span class="comment">*</span>
01655 <span class="comment">* Called from CSR to pop up hard error messages</span>
01656 <span class="comment">*</span>
01657 <span class="comment">* History:</span>
01658 <span class="comment">* 03/12/97 GerardoB         Rewritten to support OptionOkNoWait</span>
01659 <span class="comment">* 07-03-91 JimA             Created.</span>
01660 <span class="comment">\***************************************************************************/</span>
01661 
<a name="l01662"></a><a class="code" href="../../d0/d7/server_2server_8c.html#a36">01662</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a36">UserHardError</a>(
01663     PCSR_THREAD pt,
01664     PHARDERROR_MSG pmsg)
01665 {
01666     <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a11">UserHardErrorEx</a>(pt, pmsg, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01667 }
01668 
<a name="l01669"></a><a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a14">01669</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d4/icamsg_8c.html#a9">HardErrorInsert</a>(
01670     PCSR_THREAD pt,
01671     PHARDERROR_MSG pmsg,
01672     <a class="code" href="../../d5/d1/structtagCTXHARDERRORINFO.html">PCTXHARDERRORINFO</a> pCtxHEInfo)
01673 {
01674     <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a11">UserHardErrorEx</a>(pt, pmsg, pCtxHEInfo);
01675 }
01676 
01677 <span class="comment">/***************************************************************************\</span>
01678 <span class="comment">* UserHardErrorEx</span>
01679 <span class="comment">*</span>
01680 <span class="comment">* Called from CSR to pop up hard error messages</span>
01681 <span class="comment">*</span>
01682 <span class="comment">* History:</span>
01683 <span class="comment">* 07-03-91 JimA             Created.</span>
01684 <span class="comment">\***************************************************************************/</span>
01685 
<a name="l01686"></a><a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a11">01686</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a11">UserHardErrorEx</a>(
01687     PCSR_THREAD pt,
01688     PHARDERROR_MSG pmsg,
01689     <a class="code" href="../../d5/d1/structtagCTXHARDERRORINFO.html">PCTXHARDERRORINFO</a> pCtxHEInfo)
01690 {
01691     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fClientPort, fNoWait, fMsgBox, fLogEvent;
01692     <a class="code" href="../../d3/d6/structtagHARDERRORINFO.html">PHARDERRORINFO</a> phi = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, *pphiLast;
01693     HANDLE hEvent;
01694     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwReportMode, dwResponse;
01695 
01696     UserAssert((ULONG)pmsg-&gt;NumberOfParameters &lt;= MAXIMUM_HARDERROR_PARAMETERS);
01697     <span class="comment">/*</span>
01698 <span class="comment">     * Allocate memory to queue request.</span>
01699 <span class="comment">     */</span>
01700     phi = (<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html">PHARDERRORINFO</a>)LocalAlloc(LPTR, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html">HARDERRORINFO</a>));
01701     <span class="keywordflow">if</span> (phi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01702         <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01703     }
01704     phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o1">pthread</a> = pt;
01705 
01706     <span class="comment">/*</span>
01707 <span class="comment">     * Set up citrix specific stuff</span>
01708 <span class="comment">     */</span>
01709     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
01710         phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o10">pCtxHEInfo</a> = pCtxHEInfo;
01711     }
01712 
01713     <span class="comment">/*</span>
01714 <span class="comment">     * Determine reply type</span>
01715 <span class="comment">     */</span>
01716     fClientPort = ((pt != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (pt-&gt;Process-&gt;ClientPort != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>));
01717     fNoWait = (pmsg-&gt;ValidResponseOptions == OptionOkNoWait);
01718 
01719     <span class="comment">/*</span>
01720 <span class="comment">     * Capture HARDERROR_MSG data or create wait event as needed</span>
01721 <span class="comment">     */</span>
01722     <span class="keywordflow">if</span> (fClientPort || fNoWait) {
01723         phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o3">pmsg</a> = (PHARDERROR_MSG)LocalAlloc(LPTR, pmsg-&gt;h.u1.s1.TotalLength);
01724         <span class="keywordflow">if</span> (phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o3">pmsg</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01725             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01726         }
01727         phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> |= <a class="code" href="../../d7/d1/usersrv_8h.html#a23">HEIF_ALLOCATEDMSG</a>;
01728         RtlCopyMemory(phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o3">pmsg</a>, pmsg, pmsg-&gt;h.u1.s1.TotalLength);
01729         hEvent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01730         <span class="comment">/*</span>
01731 <span class="comment">         * Set the magic response value (-1) to let CsrApiRequestThread know</span>
01732 <span class="comment">         * that we'll take care of dereferencing and replying.</span>
01733 <span class="comment">         */</span>
01734         <span class="keywordflow">if</span> (pt != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01735             phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> |= <a class="code" href="../../d7/d1/usersrv_8h.html#a25">HEIF_DEREFTHREAD</a>;
01736         }
01737         pmsg-&gt;Response = (ULONG)-1;
01738         <span class="keywordflow">if</span> (fNoWait) {
01739             phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o3">pmsg</a>-&gt;ValidResponseOptions = OptionOk;
01740         }
01741     } <span class="keywordflow">else</span> {
01742         phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o3">pmsg</a> = pmsg;
01743         <span class="comment">/*</span>
01744 <span class="comment">         * There is no reply port but we need to wait; create an event.</span>
01745 <span class="comment">         */</span>
01746         hEvent = CreateEvent(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01747         <span class="keywordflow">if</span> (hEvent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01748             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01749         }
01750         phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o2">hEventHardError</a> = hEvent;
01751     }
01752 
01753     <span class="comment">/*</span>
01754 <span class="comment">     * Build hard error title, message and flags. Then log the event.</span>
01755 <span class="comment">     */</span>
01756     <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a24">GetHardErrorText</a>(phi);
01757 
01758     <span class="comment">/*</span>
01759 <span class="comment">     * Reply now if we're not going to wait.</span>
01760 <span class="comment">     */</span>
01761     <span class="keywordflow">if</span> (fNoWait) {
01762         phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> |= <a class="code" href="../../d7/d1/usersrv_8h.html#a24">HEIF_REPLIED</a>;
01763         phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o3">pmsg</a>-&gt;Response = ResponseOk;
01764         <span class="keywordflow">if</span> (fClientPort) {
01765             <a class="code" href="../../d5/d7/lpcreply_8c.html#a1">NtReplyPort</a>(pt-&gt;Process-&gt;ClientPort, (PPORT_MESSAGE)phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o3">pmsg</a>);
01766         } <span class="keywordflow">else</span> {
01767             <span class="comment">/*</span>
01768 <span class="comment">             * Must let CsrApiRequestThread reply since we don't have a port</span>
01769 <span class="comment">             */</span>
01770             pmsg-&gt;Response = ResponseOk;
01771             <span class="comment">/*</span>
01772 <span class="comment">             * If we have a thread, reference it because we're telling</span>
01773 <span class="comment">             *  CsrApiRequestThread that we're done with it.</span>
01774 <span class="comment">             */</span>
01775             <span class="keywordflow">if</span> (pt != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01776                 <span class="comment">/*</span>
01777 <span class="comment">                 * Later5.0 GerardoB. Let's stop to see how this happens.</span>
01778 <span class="comment">                 */</span>
01779                 UserAssert(pt == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01780                 CsrReferenceThread(pt);
01781             }
01782         }
01783     }
01784 
01785     <span class="comment">/*</span>
01786 <span class="comment">     * Register the event if we haven't done so already.</span>
01787 <span class="comment">     * Since RegisterEventSource is supported by a service, we must not hold</span>
01788 <span class="comment">     *  any locks while making this call. Hence we might have several threads</span>
01789 <span class="comment">     *  registering the event simultaneously.</span>
01790 <span class="comment">     */</span>
01791     fLogEvent = (<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a14">gEventSource</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01792     <span class="keywordflow">if</span> (!fLogEvent) {
01793         HANDLE hEventSource;
01794         hEventSource = <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a16">UserRegisterEventSource</a>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Application Popup"</span>);
01795         <span class="comment">/*</span>
01796 <span class="comment">         * Save the first handle, deregister all others.</span>
01797 <span class="comment">         */</span>
01798         <span class="keywordflow">if</span> (InterlockedCompareExchangePointer(&amp;<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a14">gEventSource</a>, hEventSource, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01799             <span class="comment">/*</span>
01800 <span class="comment">             * This is the first handle. If valid, we can log events.</span>
01801 <span class="comment">             */</span>
01802             fLogEvent = (hEventSource != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01803         } <span class="keywordflow">else</span> {
01804             <span class="comment">/*</span>
01805 <span class="comment">             * We had already saved another handle (so we can log events). Deregister this one.</span>
01806 <span class="comment">             */</span>
01807             <span class="keywordflow">if</span> (hEventSource != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01808                 UserVerify(<a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a8">gfnDeregisterEventSource</a>(hEventSource));
01809             }
01810             fLogEvent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01811         }
01812     }
01813 
01814     dwReportMode = (fLogEvent ? <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a19">GetErrorMode</a>() : 0);
01815     <span class="keywordflow">if</span> (fLogEvent) {
01816         <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a17">LogErrorPopup</a>(phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o6">usCaption</a>.Buffer, phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o5">usText</a>.Buffer);
01817     }
01818 
01819     <span class="comment">/*</span>
01820 <span class="comment">     * Determine if we need to display a message box.</span>
01821 <span class="comment">     */</span>
01822     <span class="keywordflow">if</span> ((phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o3">pmsg</a>-&gt;Status == STATUS_SERVICE_NOTIFICATION) || (dwReportMode == 0)) {
01823         fMsgBox = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01824     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o3">pmsg</a>-&gt;Status == STATUS_VDM_HARD_ERROR) {
01825         fMsgBox = (dwReportMode == 1);
01826         <span class="keywordflow">if</span> (!fMsgBox) {
01827             dwResponse = ResponseOk;
01828         }
01829     } <span class="keywordflow">else</span> {
01830         fMsgBox = ((dwReportMode == 1) &amp;&amp; !(phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a27">HEIF_SYSTEMERROR</a>));
01831         <span class="keywordflow">if</span> (!fMsgBox) {
01832             UserAssert((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o3">pmsg</a>-&gt;ValidResponseOptions &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(<a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a5">dwResponseDefault</a>));
01833             dwResponse = <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a5">dwResponseDefault</a>[phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o3">pmsg</a>-&gt;ValidResponseOptions];
01834         }
01835     }
01836     <span class="comment">/*</span>
01837 <span class="comment">     * If we don't have to display a message box, we're done.</span>
01838 <span class="comment">     */</span>
01839     <span class="keywordflow">if</span> (!fMsgBox) {
01840         <span class="keywordflow">goto</span> DontNeedErrorHandler;
01841     }
01842 
01843     <span class="comment">/*</span>
01844 <span class="comment">     * We want to display a message box. Queue the request and go for it.</span>
01845 <span class="comment">     */</span>
01846     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
01847     <span class="comment">/*</span>
01848 <span class="comment">     * Never mind if the process has terminated. Got to check this holding the</span>
01849 <span class="comment">     * critical section to make sure that no other thread makes it to BoostHardError</span>
01850 <span class="comment">     * before we add this phi to the list.</span>
01851 <span class="comment">     */</span>
01852     <span class="keywordflow">if</span> ((pt != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (pt-&gt;Process-&gt;Flags &amp; CSR_PROCESS_TERMINATED)) {
01853         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01854 DontNeedErrorHandler:
01855         <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a21">ReplyHardError</a>(phi, dwResponse);
01856         <span class="keywordflow">if</span> (hEvent != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01857             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hEvent);
01858         }
01859         <span class="keywordflow">return</span>;
01860     }
01861     <span class="comment">/*</span>
01862 <span class="comment">     * Add it to the end of the list.</span>
01863 <span class="comment">     */</span>
01864     pphiLast = &amp;<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a11">gphiList</a>;
01865     <span class="keywordflow">while</span> (*pphiLast != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01866         pphiLast = &amp;(*pphiLast)-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o0">phiNext</a>;
01867     }
01868     *pphiLast = phi;
01869     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01870 
01871     <span class="comment">/*</span>
01872 <span class="comment">     * Process the hard error request. If this is a NoWait request and there</span>
01873 <span class="comment">     * is no reply port, then we'll try to launch a new worker thread so this</span>
01874 <span class="comment">     * one can return.</span>
01875 <span class="comment">     */</span>
01876     <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a13">ProcessHardErrorRequest</a>(fNoWait &amp;&amp; !fClientPort);
01877 
01878     <span class="comment">/*</span>
01879 <span class="comment">     * If there is an event handle, wait for it.</span>
01880 <span class="comment">     */</span>
01881     <span class="keywordflow">if</span> (hEvent != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01882         <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>(hEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01883         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hEvent);
01884     }
01885     <span class="keywordflow">return</span>;
01886 
01887 <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>:
01888     <span class="keywordflow">if</span> (phi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01889         <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a20">FreePhi</a>(phi);
01890     }
01891     pmsg-&gt;Response = ResponseNotHandled;
01892 }
01893 
01894 <span class="comment">/***************************************************************************\</span>
01895 <span class="comment">* BoostHardError</span>
01896 <span class="comment">*</span>
01897 <span class="comment">* If one or more hard errors exist for the specified process, remove</span>
01898 <span class="comment">* them from the list if forced, otherwise bring the first one to the</span>
01899 <span class="comment">* top of the hard error list and display it.  Return TRUE if there</span>
01900 <span class="comment">* is a hard error.</span>
01901 <span class="comment">*</span>
01902 <span class="comment">* History:</span>
01903 <span class="comment">* 11-02-91 JimA             Created.</span>
01904 <span class="comment">\***************************************************************************/</span>
01905 
<a name="l01906"></a><a class="code" href="../../d7/d1/usersrv_8h.html#a53">01906</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d7/d1/usersrv_8h.html#a53">BoostHardError</a>(
01907     ULONG_PTR dwProcessId,
01908     DWORD dwCode)
01909 {
01910     DESKRESTOREDATA drdRestore;
01911     <a class="code" href="../../d3/d6/structtagHARDERRORINFO.html">PHARDERRORINFO</a> phi, *pphi;
01912     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fHasError = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01913 
01914     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
01915     <span class="comment">/*</span>
01916 <span class="comment">     * If the list is empty, nothing do to here.</span>
01917 <span class="comment">     */</span>
01918     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a11">gphiList</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01919         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01920         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01921     }
01922     drdRestore.pdeskRestore = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01923     <span class="comment">/*</span>
01924 <span class="comment">     * Walk the hard error list</span>
01925 <span class="comment">     */</span>
01926     pphi = &amp;<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a11">gphiList</a>;
01927     <span class="keywordflow">while</span> (*pphi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01928         <span class="comment">/*</span>
01929 <span class="comment">         * If not not nuking all and not owned by dwProcessId, continue walking</span>
01930 <span class="comment">         */</span>
01931         <span class="keywordflow">if</span> (dwProcessId != (ULONG_PTR)-1) {
01932             <span class="keywordflow">if</span> (((*pphi)-&gt;pthread == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01933                     || ((ULONG_PTR)((*pphi)-&gt;pthread-&gt;ClientId.UniqueProcess) != dwProcessId)) {
01934 
01935                 pphi = &amp;(*pphi)-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o0">phiNext</a>;
01936                 <span class="keywordflow">continue</span>;
01937             }
01938         } <span class="keywordflow">else</span> {
01939             UserAssert(dwCode == <a class="code" href="../../d7/d1/usersrv_8h.html#a30">BHE_FORCE</a>);
01940         }
01941         <span class="comment">/*</span>
01942 <span class="comment">         * Got one so we want to return TRUE</span>
01943 <span class="comment">         */</span>
01944         fHasError = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01945         <span class="comment">/*</span>
01946 <span class="comment">         * If nuking the request</span>
01947 <span class="comment">         */</span>
01948         <span class="keywordflow">if</span> (dwCode == <a class="code" href="../../d7/d1/usersrv_8h.html#a30">BHE_FORCE</a>) {
01949             <span class="comment">/*</span>
01950 <span class="comment">             * Unlink it from the list.</span>
01951 <span class="comment">             */</span>
01952             phi = *pphi;
01953             *pphi = phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o0">phiNext</a>;
01954 
01955             <span class="comment">/*</span>
01956 <span class="comment">             * If this box is being shown right now, signal it to go away.</span>
01957 <span class="comment">             * Otherwise, nuke it</span>
01958 <span class="comment">             */</span>
01959             <span class="keywordflow">if</span> (phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a21">HEIF_ACTIVE</a>) {
01960                 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwHardErrorHandler = <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a12">gdwHardErrorThreadId</a>;
01961                 phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> |= <a class="code" href="../../d7/d1/usersrv_8h.html#a22">HEIF_NUKED</a>;
01962                 <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01963                 <a class="code" href="../../d0/d8/ntcftxt_8h.html#a21">PostThreadMessage</a>(dwHardErrorHandler, WM_QUIT, 0, 0);
01964             } <span class="keywordflow">else</span> {
01965                 <span class="comment">/*</span>
01966 <span class="comment">                 * Acknowledge the error as not handled, reply and free</span>
01967 <span class="comment">                 */</span>
01968                 <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01969                 <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a21">ReplyHardError</a>(phi, ResponseNotHandled);
01970             }
01971 
01972             <span class="comment">/*</span>
01973 <span class="comment">             * Restart the search because we left the crit sect.</span>
01974 <span class="comment">             */</span>
01975             <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
01976             pphi = &amp;<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a11">gphiList</a>;
01977 
01978             <span class="comment">/* continue */</span>
01979 
01980         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dwCode == <a class="code" href="../../d7/d1/usersrv_8h.html#a29">BHE_ACTIVATE</a>) {
01981             <span class="comment">/*</span>
01982 <span class="comment">             * If it's active, find it and show it.</span>
01983 <span class="comment">             */</span>
01984             phi = *pphi;
01985             <span class="keywordflow">if</span> (phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o4">dwHEIFFlags</a> &amp; <a class="code" href="../../d7/d1/usersrv_8h.html#a21">HEIF_ACTIVE</a>) {
01986                 HWND hwndError = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01987                 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwHardErrorHandler = <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a12">gdwHardErrorThreadId</a>;
01988 
01989                 <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01990                 <a class="code" href="../../d0/d8/clenum_8c.html#a9">EnumThreadWindows</a>(dwHardErrorHandler, <a class="code" href="../../d0/d7/server_2server_8c.html#a54">FindWindowFromThread</a>, (LPARAM)&amp;hwndError);
01991 
01992                 <span class="keywordflow">if</span> ((hwndError != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01993                         &amp;&amp; (HEC_SUCCESS == <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a82">NtUserHardErrorControl</a>(HardErrorAttachNoQueue, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;drdRestore))) {
01994 
01995                     <a class="code" href="../../d3/d8/client_8c.html#a131">SetForegroundWindow</a>(hwndError);
01996 
01997                     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a82">NtUserHardErrorControl</a>(HardErrorDetachNoQueue, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;drdRestore);
01998                 }
01999                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02000             }
02001 
02002             <span class="comment">/*</span>
02003 <span class="comment">             * It's not active so move it to the head of the list</span>
02004 <span class="comment">             *  to make it show up next.</span>
02005 <span class="comment">             */</span>
02006             *pphi = phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o0">phiNext</a>;
02007             phi-&gt;<a class="code" href="../../d3/d6/structtagHARDERRORINFO.html#o0">phiNext</a> = <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a11">gphiList</a>;
02008             <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a11">gphiList</a> = phi;
02009             <span class="keywordflow">break</span>;
02010 
02011         } <span class="keywordflow">else</span> { <span class="comment">/* BHE_TEST */</span>
02012             <span class="comment">/*</span>
02013 <span class="comment">             * The caller just want to know if this process owns a hard error</span>
02014 <span class="comment">             */</span>
02015             <span class="keywordflow">break</span>;
02016         }
02017     } <span class="comment">/*  while (*pphi != NULL) */</span>
02018 
02019     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
02020 
02021     <span class="comment">/*</span>
02022 <span class="comment">     * Bug 284468. Wake up the hard error handler</span>
02023 <span class="comment">     */</span>
02024     <span class="keywordflow">if</span> (dwCode == <a class="code" href="../../d7/d1/usersrv_8h.html#a30">BHE_FORCE</a> &amp;&amp; <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a12">gdwHardErrorThreadId</a> != 0) {
02025         <a class="code" href="../../d0/d8/ntcftxt_8h.html#a21">PostThreadMessage</a>(<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a12">gdwHardErrorThreadId</a>, WM_NULL, 0, 0);
02026     }
02027 
02028     <span class="keywordflow">return</span> fHasError;
02029 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:15 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
