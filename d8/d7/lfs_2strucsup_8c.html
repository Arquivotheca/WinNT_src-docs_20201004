<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: lfs/strucsup.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>strucsup.c File Reference</h1><code>#include "<a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>"</code><br>

<p>
<a href="../../d9/d6/lfs_2strucsup_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d7/lfs_2strucsup_8c.html#a0">Dbg</a>&nbsp;&nbsp;&nbsp;(DEBUG_TRACE_STRUC_SUP)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d7/lfs_2strucsup_8c.html#a1">LfsAllocateLfcb</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d7/lfs_2strucsup_8c.html#a2">LfsDeallocateLfcb</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, IN BOOLEAN CompleteTeardown)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d7/lfs_2strucsup_8c.html#a3">LfsAllocateLbcb</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, OUT <a class="el" href="../../d4/d9/struct__LBCB.html">PLBCB</a> *Lbcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d7/lfs_2strucsup_8c.html#a4">LfsDeallocateLbcb</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, IN <a class="el" href="../../d4/d9/struct__LBCB.html">PLBCB</a> Lbcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d7/lfs_2strucsup_8c.html#a5">LfsAllocateLcb</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, OUT <a class="el" href="../../d5/d9/struct__LCB.html">PLCB</a> *NewLcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d7/lfs_2strucsup_8c.html#a6">LfsDeallocateLcb</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, IN <a class="el" href="../../d5/d9/struct__LCB.html">PLCB</a> Lcb)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="lfs/strucsup.c::Dbg" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define Dbg&nbsp;&nbsp;&nbsp;(DEBUG_TRACE_STRUC_SUP)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00028">28</a> of file <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html">lfs/strucsup.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a3" doxytag="lfs/strucsup.c::LfsAllocateLbcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsAllocateLbcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d4/d9/struct__LBCB.html">PLBCB</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>Lbcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00315">315</a> of file <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html">lfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d1/d4/lfsstruc_8h.html#a31">LBCB</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00610">LFCB_RESERVE_LBCB_COUNT</a>, <a class="el" href="../../d1/d6/lfs_2nodetype_8h-source.html#l00034">LFS_NTC_LBCB</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00188">_LBCB::NodeByteSize</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00187">_LBCB::NodeTypeCode</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/lbcbsup_8c-source.html#l00311">LfsGetLbcb()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02514">LfsUpdateLfcbFromNoRestart()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02697">LfsUpdateLfcbFromRestart()</a>, and <a class="el" href="../../d8/d9/rstrtsup_8c-source.html#l00036">LfsWriteLfsRestart()</a>.
<p>
<pre class="fragment"><div>00322                    :
00323 
00324     This routine will allocate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next Lbcb.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> allocation fails
00325     we will look at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">private</span> queue of Lbcb's.
00326 
00327 Arguments:
00328 
00329     Lfcb - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block.
00330 
00331     Lbcb - Address to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated Lbcb.
00332 
00333 Return Value:
00334 
00335     None
00336 
00337 --*/
00338 
00339 {
00340     <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> NewLbcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00341 
00342     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00343 
00344     <span class="comment">//</span>
00345     <span class="comment">//  If there are enough entries on the look-aside list then get one from</span>
00346     <span class="comment">//  there.</span>
00347     <span class="comment">//</span>
00348 
00349     <span class="keywordflow">if</span> (Lfcb-&gt;SpareLbcbCount &gt; <a class="code" href="../../d1/d4/lfsstruc_8h.html#a15">LFCB_RESERVE_LBCB_COUNT</a>) {
00350 
00351         NewLbcb = (<a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a>) Lfcb-&gt;SpareLbcbList.Flink;
00352 
00353         Lfcb-&gt;SpareLbcbCount -= 1;
00354         RemoveHeadList( &amp;Lfcb-&gt;SpareLbcbList );
00355 
00356     <span class="comment">//</span>
00357     <span class="comment">//  Otherwise try to allocate from pool.</span>
00358     <span class="comment">//</span>
00359 
00360     } <span class="keywordflow">else</span> {
00361 
00362         NewLbcb = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool, <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a> ), ' sfL' );
00363     }
00364 
00365     <span class="comment">//</span>
00366     <span class="comment">//  If we didn't get one then look at the look-aside list.</span>
00367     <span class="comment">//</span>
00368 
00369     <span class="keywordflow">if</span> (NewLbcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00370 
00371         <span class="keywordflow">if</span> (Lfcb-&gt;SpareLbcbCount != 0) {
00372 
00373             NewLbcb = (<a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a>) Lfcb-&gt;SpareLbcbList.Flink;
00374 
00375             Lfcb-&gt;SpareLbcbCount -= 1;
00376             RemoveHeadList( &amp;Lfcb-&gt;SpareLbcbList );
00377 
00378         } <span class="keywordflow">else</span> {
00379 
00380             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INSUFFICIENT_RESOURCES );
00381         }
00382     }
00383 
00384     <span class="comment">//</span>
00385     <span class="comment">//  Initialize the structure.</span>
00386     <span class="comment">//</span>
00387 
00388     RtlZeroMemory( NewLbcb, <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a> ));
00389     NewLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o0">NodeTypeCode</a> = <a class="code" href="../../d0/d7/lfs_2nodetype_8h.html#a3">LFS_NTC_LBCB</a>;
00390     NewLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o1">NodeByteSize</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a> );
00391 
00392     <span class="comment">//</span>
00393     <span class="comment">//  Return it to the user.</span>
00394     <span class="comment">//</span>
00395 
00396     *Lbcb = NewLbcb;
00397     <span class="keywordflow">return</span>;
00398 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="lfs/strucsup.c::LfsAllocateLcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsAllocateLcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d5/d9/struct__LCB.html">PLCB</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>NewLcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00463">463</a> of file <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html">lfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d1/d4/lfsstruc_8h.html#a25">LCB</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00613">LFCB_RESERVE_LCB_COUNT</a>, <a class="el" href="../../d1/d6/lfs_2nodetype_8h-source.html#l00032">LFS_NTC_LCB</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>.
<p>
Referenced by <a class="el" href="../../d4/d2/querylog_8c-source.html#l00072">LfsReadLogRecord()</a>.
<p>
<pre class="fragment"><div>00469                    :
00470 
00471     This routine will allocate an Lcb. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> fails we will fall back
00472     on our spare list. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> then will result in an exception
00473     
00474 Arguments:
00475 
00476     Lfcb - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block.
00477 
00478     Lcb - This will contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> lcb 
00479 
00480 Return Value:
00481 
00482     None
00483 
00484 --*/
00485 {
00486 
00487     ExAcquireFastMutex( &amp;(Lfcb-&gt;Sync-&gt;SpareListMutex) );
00488     
00489     <span class="keywordflow">try</span> {
00490         
00491         *NewLcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00492         <span class="keywordflow">if</span> (Lfcb-&gt;SpareLcbCount &lt; <a class="code" href="../../d1/d4/lfsstruc_8h.html#a17">LFCB_RESERVE_LCB_COUNT</a>) {                   
00493             (*NewLcb) = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool, <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d9/struct__LCB.html">LCB</a> ), ' sfL' );  
00494         }
00495         
00496         <span class="keywordflow">if</span> ((*NewLcb) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {                                                   
00497             <span class="keywordflow">if</span> (Lfcb-&gt;SpareLcbCount &gt; 0) {                                    
00498                 *NewLcb = (<a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a>) Lfcb-&gt;SpareLcbList.Flink;                     
00499                 Lfcb-&gt;SpareLcbCount -= 1;                                     
00500                 RemoveHeadList( &amp;Lfcb-&gt;SpareLcbList );                        
00501             } <span class="keywordflow">else</span> {                                                           
00502                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INSUFFICIENT_RESOURCES );                 
00503             }                                                                   
00504         }                                                                       
00505         
00506         RtlZeroMemory( (*NewLcb), <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d9/struct__LCB.html">LCB</a> ) );                      
00507         (*NewLcb)-&gt;NodeTypeCode = <a class="code" href="../../d0/d7/lfs_2nodetype_8h.html#a1">LFS_NTC_LCB</a>;                         
00508         (*NewLcb)-&gt;NodeByteSize = <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d9/struct__LCB.html">LCB</a> );                       
00509     
00510     } finally {
00511         ExReleaseFastMutex( &amp;(Lfcb-&gt;Sync-&gt;SpareListMutex) );
00512     }
00513 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="lfs/strucsup.c::LfsAllocateLfcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> LfsAllocateLfcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00041">41</a> of file <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html">lfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00099">_LFCB_SYNC::Event</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00367">ExInitializeFastMutex</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02473">ExInitializeResource</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00120">FsRtlAllocatePool</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00415">_LFCB::LbcbActive</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00414">_LFCB::LbcbWorkque</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00321">_LFCB::LchLinks</a>, <a class="el" href="../../d1/d4/lfsstruc_8h.html#a34">LFCB</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00610">LFCB_RESERVE_LBCB_COUNT</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00613">LFCB_RESERVE_LCB_COUNT</a>, <a class="el" href="../../d1/d6/lfs_2nodetype_8h-source.html#l00035">LFS_NTC_LFCB</a>, <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00188">LfsDeallocateLfcb()</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00040">LfsLi1</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00459">_LFCB::NextRestartLsn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00308">_LFCB::NodeByteSize</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00307">_LFCB::NodeTypeCode</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00091">_LFCB_SYNC::Resource</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00555">_LFCB::SpareLbcbCount</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00556">_LFCB::SpareLbcbList</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00563">_LFCB::SpareLcbCount</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00564">_LFCB::SpareLcbList</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00112">_LFCB_SYNC::SpareListMutex</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00570">_LFCB::Sync</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00106">_LFCB_SYNC::UserCount</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00150">LfsInitializeLogFile()</a>, and <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01534">LfsRestartLogFile()</a>.
<p>
<pre class="fragment"><div>00046                    :
00047 
00048     This routine allocates and initializes a log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block.
00049 
00050 Arguments:
00051 
00052 Return Value:
00053 
00054     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block just
00055                               allocated and initialized.
00056 
00057 --*/
00058 
00059 {
00060     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00061     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00062     <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> NextLbcb;
00063     <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a>  NextLcb;
00064 
00065     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00066 
00067     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsAllocateLfcb:  Entered\n"</span>, 0 );
00068 
00069     <span class="comment">//</span>
00070     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00071     <span class="comment">//</span>
00072 
00073     <span class="keywordflow">try</span> {
00074 
00075         <span class="comment">//</span>
00076         <span class="comment">//  Allocate and zero the structure for the Lfcb.</span>
00077         <span class="comment">//</span>
00078 
00079         Lfcb = <a class="code" href="../../d5/d5/cc_8h.html#a8">FsRtlAllocatePool</a>( PagedPool, <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d0/struct__LFCB.html">LFCB</a> ));
00080 
00081         <span class="comment">//</span>
00082         <span class="comment">//  Zero out the structure initially.</span>
00083         <span class="comment">//</span>
00084 
00085         RtlZeroMemory( Lfcb, <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d0/struct__LFCB.html">LFCB</a> ));
00086 
00087         <span class="comment">//</span>
00088         <span class="comment">//  Initialize the log file control block.</span>
00089         <span class="comment">//</span>
00090 
00091         Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o0">NodeTypeCode</a> = <a class="code" href="../../d0/d7/lfs_2nodetype_8h.html#a4">LFS_NTC_LFCB</a>;
00092         Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o1">NodeByteSize</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d0/struct__LFCB.html">LFCB</a> );
00093 
00094         <span class="comment">//</span>
00095         <span class="comment">//  Initialize the client links.</span>
00096         <span class="comment">//</span>
00097 
00098         InitializeListHead( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o3">LchLinks</a> );
00099 
00100         <span class="comment">//</span>
00101         <span class="comment">//  Initialize the Lbcb links.</span>
00102         <span class="comment">//</span>
00103 
00104         InitializeListHead( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o25">LbcbWorkque</a> );
00105         InitializeListHead( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o26">LbcbActive</a> );
00106 
00107         <span class="comment">//</span>
00108         <span class="comment">//  Initialize and allocate the spare Lbcb queue.</span>
00109         <span class="comment">//</span>
00110 
00111         InitializeListHead( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o56">SpareLbcbList</a> );
00112 
00113         <span class="keywordflow">for</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0; <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> &lt; <a class="code" href="../../d1/d4/lfsstruc_8h.html#a15">LFCB_RESERVE_LBCB_COUNT</a>; <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>++) {
00114 
00115             NextLbcb = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool, <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a> ), ' sfL' );
00116 
00117             <span class="keywordflow">if</span> (NextLbcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00118 
00119                 InsertHeadList( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o56">SpareLbcbList</a>, (PLIST_ENTRY) NextLbcb );
00120                 Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o55">SpareLbcbCount</a> += 1;
00121             }
00122         }
00123 
00124         <span class="comment">//</span>
00125         <span class="comment">//  Initialize and allocate the spare Lcb queue.</span>
00126         <span class="comment">//</span>
00127 
00128         InitializeListHead( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o58">SpareLcbList</a> );
00129 
00130         <span class="keywordflow">for</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0; <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> &lt; <a class="code" href="../../d1/d4/lfsstruc_8h.html#a17">LFCB_RESERVE_LCB_COUNT</a>; <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>++)  {
00131 
00132             NextLcb = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool, <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d9/struct__LCB.html">LCB</a> ), ' sfL' );
00133 
00134             <span class="keywordflow">if</span> (NextLcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00135 
00136                 InsertHeadList( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o58">SpareLcbList</a>, (PLIST_ENTRY) NextLcb );
00137                 Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o57">SpareLcbCount</a> += 1;
00138             }
00139         }
00140 
00141         <span class="comment">//</span>
00142         <span class="comment">//  Allocate the Lfcb synchronization event.</span>
00143         <span class="comment">//</span>
00144 
00145         Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o59">Sync</a> = <a class="code" href="../../d5/d5/cc_8h.html#a8">FsRtlAllocatePool</a>( NonPagedPool, <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d0/struct__LFCB__SYNC.html">LFCB_SYNC</a> ));
00146 
00147         <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a>( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o59">Sync</a>-&gt;<a class="code" href="../../d2/d0/struct__LFCB__SYNC.html#o0">Resource</a> );
00148 
00149         <span class="comment">//</span>
00150         <span class="comment">//  Initialize the pseudo Lsn for the restart Lbcb's</span>
00151         <span class="comment">//</span>
00152 
00153         Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o37">NextRestartLsn</a> = <a class="code" href="../../d7/d3/lfsdata_8c.html#a3">LfsLi1</a>;
00154 
00155         <span class="comment">//</span>
00156         <span class="comment">//  Initialize the event to the signalled state.</span>
00157         <span class="comment">//</span>
00158 
00159         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o59">Sync</a>-&gt;<a class="code" href="../../d2/d0/struct__LFCB__SYNC.html#o1">Event</a>, NotificationEvent, TRUE );
00160 
00161         Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o59">Sync</a>-&gt;<a class="code" href="../../d2/d0/struct__LFCB__SYNC.html#o2">UserCount</a> = 0;
00162 
00163         <span class="comment">//</span>
00164         <span class="comment">//  Initialize the spare list mutex</span>
00165         <span class="comment">//</span>
00166 
00167         <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>( &amp;(Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o59">Sync</a>-&gt;<a class="code" href="../../d2/d0/struct__LFCB__SYNC.html#o3">SpareListMutex</a>) );
00168 
00169     } finally {
00170 
00171         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsAllocateFileControlBlock );
00172 
00173         <span class="keywordflow">if</span> (AbnormalTermination()
00174             &amp;&amp; Lfcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00175 
00176             <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a2">LfsDeallocateLfcb</a>( Lfcb, TRUE );
00177             Lfcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00178         }
00179 
00180         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsAllocateLfcb:  Exit -&gt; %08lx\n"</span>, Lfcb );
00181     }
00182 
00183     <span class="keywordflow">return</span> Lfcb;
00184 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="lfs/strucsup.c::LfsDeallocateLbcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsDeallocateLbcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/struct__LBCB.html">PLBCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lbcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00402">402</a> of file <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html">lfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00287">LBCB_RESTART_LBCB</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00611">LFCB_MAX_LBCB_COUNT</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00442">LfsDeallocateRestartArea</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00706">LfsCloseLogFile()</a>, <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00188">LfsDeallocateLfcb()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00551">LfsFlushLfcb()</a>, and <a class="el" href="../../d8/d0/lbcbsup_8c-source.html#l00311">LfsGetLbcb()</a>.
<p>
<pre class="fragment"><div>00409                    :
00410 
00411     This routine will deallocate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lbcb.  If we need one <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> look-aside
00412     list we will put <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> there.
00413 
00414 Arguments:
00415 
00416     Lfcb - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block.
00417 
00418     Lbcb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lbcb to deallocate.
00419 
00420 Return Value:
00421 
00422     None
00423 
00424 --*/
00425 
00426 {
00427     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00428 
00429     <span class="comment">//</span>
00430     <span class="comment">//  Deallocate any restart area attached to this Lbcb.</span>
00431     <span class="comment">//</span>
00432 
00433     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lbcb-&gt;LbcbFlags, LBCB_RESTART_LBCB ) &amp;&amp;
00434         (Lbcb-&gt;PageHeader != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00435 
00436         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a19">LfsDeallocateRestartArea</a>( Lbcb-&gt;PageHeader );
00437     }
00438 
00439     <span class="comment">//</span>
00440     <span class="comment">//  Put this in the Lbcb queue if it is short.</span>
00441     <span class="comment">//</span>
00442 
00443     <span class="keywordflow">if</span> (Lfcb-&gt;SpareLbcbCount &lt; <a class="code" href="../../d1/d4/lfsstruc_8h.html#a16">LFCB_MAX_LBCB_COUNT</a>) {
00444 
00445         InsertHeadList( &amp;Lfcb-&gt;SpareLbcbList, (PLIST_ENTRY) Lbcb );
00446         Lfcb-&gt;SpareLbcbCount += 1;
00447 
00448     <span class="comment">//</span>
00449     <span class="comment">//  Otherwise just free the pool block.</span>
00450     <span class="comment">//</span>
00451 
00452     } <span class="keywordflow">else</span> {
00453 
00454         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Lbcb );
00455     }
00456 
00457     <span class="keywordflow">return</span>;
00458 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="lfs/strucsup.c::LfsDeallocateLcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsDeallocateLcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d9/struct__LCB.html">PLCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00518">518</a> of file <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html">lfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d3/d8/pinsup_8c-source.html#l01000">CcUnpinData()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00614">LFCB_MAX_LCB_COUNT</a>, <a class="el" href="../../d7/d4/logpgsup_8c-source.html#l00297">LfsFreeSpanningBuffer()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d4/d2/querylog_8c-source.html#l00072">LfsReadLogRecord()</a>, and <a class="el" href="../../d4/d2/querylog_8c-source.html#l00594">LfsTerminateLogQuery()</a>.
<p>
<pre class="fragment"><div>00524                    :
00525 
00526     This routine will deallocate an Lcb. We'll cache <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> old lcb <span class="keywordflow">if</span> there
00527     aren'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> too many already on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> spare list
00528     
00529 Arguments:
00530 
00531     Lfcb - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block.
00532 
00533     Lcb - This will contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lcb to release
00534 
00535 Return Value:
00536 
00537     None
00538 
00539 --*/
00540 
00541 {
00542     <span class="keywordflow">if</span> (Lcb-&gt;RecordHeaderBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {                               
00543         <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( Lcb-&gt;RecordHeaderBcb );                          
00544     }                                                                   
00545     <span class="keywordflow">if</span> ((Lcb-&gt;CurrentLogRecord != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; Lcb-&gt;AuxilaryBuffer) {                             
00546         <a class="code" href="../../d6/d5/logpgsup_8c.html#a4">LfsFreeSpanningBuffer</a>( Lcb-&gt;CurrentLogRecord );                          
00547     }                                                                   
00548 
00549     ExAcquireFastMutex( &amp;(Lfcb-&gt;Sync-&gt;SpareListMutex) );
00550 
00551     <span class="keywordflow">try</span> {
00552         <span class="keywordflow">if</span> (Lfcb-&gt;SpareLcbCount &lt; <a class="code" href="../../d1/d4/lfsstruc_8h.html#a18">LFCB_MAX_LCB_COUNT</a>) {                   
00553             InsertHeadList( &amp;Lfcb-&gt;SpareLcbList, (PLIST_ENTRY) Lcb );   
00554             Lfcb-&gt;SpareLcbCount += 1;                                     
00555         } <span class="keywordflow">else</span> {                                                            
00556             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Lcb );                                              
00557         }                                                                   
00558     } finally {
00559         ExReleaseFastMutex( &amp;(Lfcb-&gt;Sync-&gt;SpareListMutex) );    
00560     }
00561 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="lfs/strucsup.c::LfsDeallocateLfcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsDeallocateLfcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>CompleteTeardown</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00188">188</a> of file <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html">lfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02478">ExDeleteResource</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00402">LfsDeallocateLbcb()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00442">LfsDeallocateRestartArea</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00041">LfsAllocateLfcb()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00706">LfsCloseLogFile()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00150">LfsInitializeLogFile()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00366">LfsOpenLogFile()</a>, and <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01534">LfsRestartLogFile()</a>.
<p>
<pre class="fragment"><div>00195                    :
00196 
00197     This routine releases <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resources associated with a log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a>
00198     block.
00199 
00200 Arguments:
00201 
00202     Lfcb - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block.
00203 
00204     CompleteTeardown - Indicates <span class="keywordflow">if</span> we are to completely remove <span class="keyword">this</span> Lfcb.
00205 
00206 Return Value:
00207 
00208     None
00209 
00210 --*/
00211 
00212 {
00213     <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> NextLbcb;
00214     <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a>  NextLcb;
00215 
00216     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00217 
00218     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsDeallocateLfcb:  Entered\n"</span>, 0 );
00219     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lfcb  -&gt; %08lx\n"</span>, Lfcb );
00220 
00221     <span class="comment">//</span>
00222     <span class="comment">//  Check that there are no buffer blocks.</span>
00223     <span class="comment">//</span>
00224 
00225     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IsListEmpty( &amp;Lfcb-&gt;LbcbActive ));
00226     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IsListEmpty( &amp;Lfcb-&gt;LbcbWorkque ));
00227 
00228     <span class="comment">//</span>
00229     <span class="comment">//  Check that we have no clients.</span>
00230     <span class="comment">//</span>
00231 
00232     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IsListEmpty( &amp;Lfcb-&gt;LchLinks ));
00233 
00234     <span class="comment">//</span>
00235     <span class="comment">//  If there is a restart area we deallocate it.</span>
00236     <span class="comment">//</span>
00237 
00238     <span class="keywordflow">if</span> (Lfcb-&gt;RestartArea != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00239 
00240         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a19">LfsDeallocateRestartArea</a>( Lfcb-&gt;RestartArea );
00241     }
00242 
00243     <span class="comment">//</span>
00244     <span class="comment">//  If there are any of the tail Lbcb's, deallocate them now.</span>
00245     <span class="comment">//</span>
00246 
00247     <span class="keywordflow">if</span> (Lfcb-&gt;ActiveTail != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00248 
00249         <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a4">LfsDeallocateLbcb</a>( Lfcb, Lfcb-&gt;ActiveTail );
00250         Lfcb-&gt;ActiveTail = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00251     }
00252 
00253     <span class="keywordflow">if</span> (Lfcb-&gt;PrevTail != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00254 
00255         <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a4">LfsDeallocateLbcb</a>( Lfcb, Lfcb-&gt;PrevTail );
00256         Lfcb-&gt;PrevTail = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00257     }
00258 
00259     <span class="comment">//</span>
00260     <span class="comment">//  Only do the following if we are to remove the Lfcb completely.</span>
00261     <span class="comment">//</span>
00262 
00263     <span class="keywordflow">if</span> (CompleteTeardown) {
00264 
00265         <span class="comment">//</span>
00266         <span class="comment">//  If there is a resource structure we deallocate it.</span>
00267         <span class="comment">//</span>
00268 
00269         <span class="keywordflow">if</span> (Lfcb-&gt;Sync != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00270 
00271             <a class="code" href="../../d5/d8/ex_8h.html#a73">ExDeleteResource</a>( &amp;Lfcb-&gt;Sync-&gt;Resource );
00272 
00273             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Lfcb-&gt;Sync );
00274         }
00275     }
00276 
00277     <span class="comment">//</span>
00278     <span class="comment">//  Deallocate all of the spare Lbcb's.</span>
00279     <span class="comment">//</span>
00280 
00281     <span class="keywordflow">while</span> (!IsListEmpty( &amp;Lfcb-&gt;SpareLbcbList )) {
00282 
00283         NextLbcb = (<a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a>) Lfcb-&gt;SpareLbcbList.Flink;
00284 
00285         RemoveHeadList( &amp;Lfcb-&gt;SpareLbcbList );
00286 
00287         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NextLbcb );
00288     }
00289 
00290     <span class="comment">//</span>
00291     <span class="comment">//  Deallocate all of the spare Lcb's.</span>
00292     <span class="comment">//</span>
00293 
00294     <span class="keywordflow">while</span> (!IsListEmpty( &amp;Lfcb-&gt;SpareLcbList )) {
00295 
00296         NextLcb = (<a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a>) Lfcb-&gt;SpareLcbList.Flink;
00297 
00298         RemoveHeadList( &amp;Lfcb-&gt;SpareLcbList );
00299 
00300         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NextLcb );
00301     }
00302 
00303     <span class="comment">//</span>
00304     <span class="comment">//  Discard the Lfcb structure.</span>
00305     <span class="comment">//</span>
00306 
00307     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Lfcb );
00308 
00309     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsDeallocateLfcb:  Exit\n"</span>, 0 );
00310     <span class="keywordflow">return</span>;
00311 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:42 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
