<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: udfs/cleanup.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cleanup.c File Reference</h1><code>#include "UdfProcs.h"</code><br>

<p>
<a href="../../d9/d6/udfs_2cleanup_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d7/udfs_2cleanup_8c.html#a0">BugCheckFileId</a>&nbsp;&nbsp;&nbsp;(UDFS_BUG_CHECK_CLEANUP)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d7/udfs_2cleanup_8c.html#a1">Dbg</a>&nbsp;&nbsp;&nbsp;(UDFS_DEBUG_LEVEL_CLEANUP)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d7/udfs_2cleanup_8c.html#a2">UdfCommonCleanup</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="udfs/cleanup.c::BugCheckFileId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BugCheckFileId&nbsp;&nbsp;&nbsp;(UDFS_BUG_CHECK_CLEANUP)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d6/udfs_2cleanup_8c-source.html#l00028">28</a> of file <a class="el" href="../../d9/d6/udfs_2cleanup_8c-source.html">udfs/cleanup.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="udfs/cleanup.c::Dbg" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define Dbg&nbsp;&nbsp;&nbsp;(UDFS_DEBUG_LEVEL_CLEANUP)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d6/udfs_2cleanup_8c-source.html#l00034">34</a> of file <a class="el" href="../../d9/d6/udfs_2cleanup_8c-source.html">udfs/cleanup.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a2" doxytag="udfs/cleanup.c::UdfCommonCleanup" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfCommonCleanup           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d6/udfs_2cleanup_8c-source.html#l00042">42</a> of file <a class="el" href="../../d9/d6/udfs_2cleanup_8c-source.html">udfs/cleanup.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00356">ASSERT_IRP</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d4/d2/cache_8h.html#a59">CcUninitializeCacheMap()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00673">_VCB::DirNotifyList</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01533">_FILE_OBJECT::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01504">FO_CLEANUP_COMPLETE</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01425">FSRTL_VOLUME_UNLOCK</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00823">FsRtlCheckOplock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03770">FsRtlFastUnlockAll()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l01795">FsRtlNotifyCleanup()</a>, <a class="el" href="../../d4/d8/fsrtl_2pnp_8c-source.html#l00041">FsRtlNotifyVolumeEvent()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07374">IoGetRequestorProcess()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09675">IoRemoveShareAccess()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00667">_VCB::NotifySync</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a91">PCCB</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01033">_FCB::ShareAccess</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a114">StreamFileOpen</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01542">UdfAcquireFcbExclusive</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01515">UdfAcquireVcbExclusive</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00149">UdfBugCheck</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, <a class="el" href="../../d7/d2/filobsup_8c-source.html#l00133">UdfDecodeFileObject()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01756">UdfDecrementCleanupCounts</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00385">UdfIsFastIoPossible</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01567">UdfLockFcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01559">UdfLockVcb</a>, <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00417">UdfPurgeVolume()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01548">UdfReleaseFcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01521">UdfReleaseVcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01577">UdfUnlockFcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01563">UdfUnlockVcb</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a115">UserVolumeOpen</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00941">_FCB::Vcb</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00683">VCB_STATE_LOCKED</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00611">_VCB::VcbCleanup</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00559">_VCB::VcbCondition</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a117">VcbNotMounted</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00558">_VCB::VcbState</a>, and <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00565">_VCB::VolumeLockFileObject</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00218">UdfFsdDispatch()</a>, and <a class="el" href="../../d1/d7/fspdisp_8c-source.html#l00038">UdfFspDispatch()</a>.
<p>
<pre class="fragment"><div>00049                    :
00050 
00051     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> common routine <span class="keywordflow">for</span> cleanup of a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>/directory called by both
00052     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fsd and fsp threads.
00053 
00054     Cleanup <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked whenever <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last handle to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> closed.
00055     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> different than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Close operation which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last
00056     reference to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> deleted.
00057 
00058     The function of cleanup <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to essentially <span class="stringliteral">"cleanup"</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>/directory
00059     after a user <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done with <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.  The Fcb/Dcb remains around (because MM
00060     still has the file object referenced) but <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> now available <span class="keywordflow">for</span> another
00061     user to open (i.e., as far as the user is concerned the is now closed).
00062 
00063     See close <span class="keywordflow">for</span> a more complete description of what close does.
00064 
00065     We <span class="keywordflow">do</span> no synchronization in <span class="keyword">this</span> routine until we get to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> point
00066     where we modify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> counts, share access and volume lock field.
00067 
00068     We need to update <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb and Vcb to show that a user handle has been closed.
00069     The following structures and fields are affected.
00070 
00071     Vcb:
00072 
00073         VolumeLockFileObject - Did <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user lock <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume with <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.
00074         VcbState - Check <span class="keywordflow">if</span> we are unlocking <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume here.
00075         VcbCleanup - <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> of outstanding handles on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume.
00076         DirNotifyQueue - If <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object has pending DirNotify Irps.
00077 
00078     Fcb:
00079 
00080         ShareAccess - If <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a user handle.
00081         FcbCleanup - <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> of outstanding handles on <span class="keyword">this</span> Fcb.
00082         Oplock - Any outstanding oplocks on <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.
00083         FileLock - Any outstanding filelocks on <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.
00084 
00085 Arguments:
00086 
00087     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to process
00088 
00089 Return Value:
00090 
00091     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The <span class="keywordflow">return</span> status <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
00092 
00093 --*/
00094 
00095 {
00096     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject;
00097     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen;
00098 
00099     BOOLEAN SendUnlockNotification = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00100     BOOLEAN AttemptTeardown;
00101 
00102     <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb;
00103     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb;
00104     <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb;
00105 
00106     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00107 
00108     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00109     <a class="code" href="../../d1/d8/udfdata_8h.html#a32">ASSERT_IRP</a>( Irp );
00110 
00111     <span class="comment">//</span>
00112     <span class="comment">//  If we were called with our file system device object instead of a</span>
00113     <span class="comment">//  volume device object, just complete this request with STATUS_SUCCESS.</span>
00114     <span class="comment">//</span>
00115 
00116     <span class="keywordflow">if</span> (IrpContext-&gt;Vcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00117 
00118         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_SUCCESS );
00119         <span class="keywordflow">return</span> STATUS_SUCCESS;
00120     }
00121 
00122     <span class="comment">//</span>
00123     <span class="comment">//  Get the file object out of the Irp and decode the type of open.</span>
00124     <span class="comment">//</span>
00125 
00126     FileObject = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp )-&gt;FileObject;
00127 
00128     TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a174">UdfDecodeFileObject</a>( FileObject,
00129                                       &amp;Fcb,
00130                                       &amp;Ccb );
00131 
00132     <span class="comment">//</span>
00133     <span class="comment">//  No work here for either an UnopenedFile object or a StreamFileObject.</span>
00134     <span class="comment">//</span>
00135 
00136     <span class="keywordflow">if</span> (TypeOfOpen &lt;= <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a114">StreamFileOpen</a>) {
00137 
00138         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_SUCCESS );
00139 
00140         <span class="keywordflow">return</span> STATUS_SUCCESS;
00141     }
00142 
00143     <span class="comment">//</span>
00144     <span class="comment">//  Keep a local pointer to the Vcb.</span>
00145     <span class="comment">//</span>
00146 
00147     Vcb = Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o2">Vcb</a>;
00148 
00149     <span class="comment">//</span>
00150     <span class="comment">//  Acquire the current file.</span>
00151     <span class="comment">//</span>
00152 
00153     <a class="code" href="../../d3/d8/udfprocs_8h.html#a83">UdfAcquireFcbExclusive</a>( IrpContext, Fcb, FALSE );
00154 
00155     <span class="comment">//</span>
00156     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00157     <span class="comment">//</span>
00158 
00159     <span class="keywordflow">try</span> {
00160 
00161         <span class="comment">//</span>
00162         <span class="comment">//  Set the flag in the FileObject to indicate that cleanup is complete.</span>
00163         <span class="comment">//</span>
00164 
00165         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( FileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a>, FO_CLEANUP_COMPLETE );
00166 
00167         <span class="comment">//</span>
00168         <span class="comment">//  Case on the type of open that we are trying to cleanup.</span>
00169         <span class="comment">//</span>
00170 
00171         <span class="keywordflow">switch</span> (TypeOfOpen) {
00172 
00173         <span class="keywordflow">case</span> <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>:
00174 
00175             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg,
00176                          <span class="stringliteral">"UdfCommonCleanup, Fcb %08x FO %08x DIR\n"</span>,
00177                          Fcb,
00178                          FileObject ));
00179             
00180             <span class="comment">//</span>
00181             <span class="comment">//  Check if we need to complete any dir notify Irps on this file object.</span>
00182             <span class="comment">//</span>
00183 
00184             <a class="code" href="../../d1/d8/fsrtl_8h.html#a175">FsRtlNotifyCleanup</a>( Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o29">NotifySync</a>,
00185                                 &amp;Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o30">DirNotifyList</a>,
00186                                 Ccb );
00187 
00188             <span class="keywordflow">break</span>;
00189 
00190         <span class="keywordflow">case</span> <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>:
00191 
00192             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg,
00193                          <span class="stringliteral">"UdfCommonCleanup, Fcb %08x FO %08x FILE\n"</span>,
00194                          Fcb,
00195                          FileObject ));
00196             
00197             <span class="comment">//</span>
00198             <span class="comment">//  Coordinate the cleanup operation with the oplock state.</span>
00199             <span class="comment">//  Oplock cleanup operations can always cleanup immediately so no</span>
00200             <span class="comment">//  need to check for STATUS_PENDING.</span>
00201             <span class="comment">//</span>
00202 
00203             <a class="code" href="../../d1/d8/fsrtl_8h.html#a165">FsRtlCheckOplock</a>( &amp;Fcb-&gt;Oplock,
00204                               Irp,
00205                               IrpContext,
00206                               NULL,
00207                               NULL );
00208 
00209             <span class="comment">//</span>
00210             <span class="comment">//  Unlock all outstanding file locks.</span>
00211             <span class="comment">//</span>
00212 
00213             <span class="keywordflow">if</span> (Fcb-&gt;FileLock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00214 
00215                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a123">FsRtlFastUnlockAll</a>( Fcb-&gt;FileLock,
00216                                     FileObject,
00217                                     <a class="code" href="../../d0/d5/io_8h.html#a512">IoGetRequestorProcess</a>( Irp ),
00218                                     NULL );
00219             }
00220 
00221             <span class="comment">//</span>
00222             <span class="comment">//  Cleanup the cache map.</span>
00223             <span class="comment">//</span>
00224 
00225             <a class="code" href="../../d4/d2/cache_8h.html#a59">CcUninitializeCacheMap</a>( FileObject, NULL, NULL );
00226 
00227             <span class="comment">//</span>
00228             <span class="comment">//  Check the fast io state.</span>
00229             <span class="comment">//</span>
00230 
00231             <a class="code" href="../../d3/d8/udfprocs_8h.html#a90">UdfLockFcb</a>( IrpContext, Fcb );
00232             Fcb-&gt;IsFastIoPossible = <a class="code" href="../../d3/d8/udfprocs_8h.html#a63">UdfIsFastIoPossible</a>( Fcb );
00233             <a class="code" href="../../d3/d8/udfprocs_8h.html#a91">UdfUnlockFcb</a>( IrpContext, Fcb );
00234 
00235             <span class="keywordflow">break</span>;
00236 
00237         <span class="keywordflow">case</span> <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a115">UserVolumeOpen</a> :
00238 
00239             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg,
00240                          <span class="stringliteral">"UdfCommonCleanup, Fcb %08x FO %08x VOL\n"</span>,
00241                          Fcb,
00242                          FileObject ));
00243 
00244             <span class="keywordflow">break</span>;
00245 
00246         <span class="keywordflow">default</span> :
00247 
00248             <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a66">UdfBugCheck</a>( TypeOfOpen, 0, 0 );
00249         }
00250 
00251         <span class="comment">//</span>
00252         <span class="comment">//  Now lock the Vcb in order to modify the fields in the in-memory</span>
00253         <span class="comment">//  structures.</span>
00254         <span class="comment">//</span>
00255 
00256         <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
00257 
00258         <span class="comment">//</span>
00259         <span class="comment">//  Decrement the cleanup counts in the Vcb and Fcb.</span>
00260         <span class="comment">//</span>
00261 
00262         <a class="code" href="../../d3/d8/udfprocs_8h.html#a97">UdfDecrementCleanupCounts</a>( IrpContext, Fcb );
00263 
00264         <span class="comment">//</span>
00265         <span class="comment">//  If the cleanup count hit zero and the volume is not mounted, we</span>
00266         <span class="comment">//  will want to try to spark teardown.</span>
00267         <span class="comment">//</span>
00268 
00269         AttemptTeardown = (Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o15">VcbCleanup</a> == 0 &amp;&amp; Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> == <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a117">VcbNotMounted</a>);
00270         
00271         <span class="comment">//</span>
00272         <span class="comment">//  If this file object has locked the volume then perform the unlock operation.</span>
00273         <span class="comment">//</span>
00274 
00275         <span class="keywordflow">if</span> (FileObject == Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o9">VolumeLockFileObject</a>) {
00276 
00277             <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o7">VcbState</a>, VCB_STATE_LOCKED );
00278             Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o9">VolumeLockFileObject</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00279             SendUnlockNotification = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00280         }
00281 
00282         <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00283 
00284         <span class="comment">//</span>
00285         <span class="comment">//  We must clean up the share access at this time, since we may not</span>
00286         <span class="comment">//  get a Close call for awhile if the file was mapped through this</span>
00287         <span class="comment">//  File Object.</span>
00288         <span class="comment">//</span>
00289 
00290         <a class="code" href="../../d4/d6/iosubs_8c.html#a103">IoRemoveShareAccess</a>( FileObject, &amp;Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o18">ShareAccess</a> );
00291 
00292     } finally {
00293 
00294         <a class="code" href="../../d3/d8/udfprocs_8h.html#a85">UdfReleaseFcb</a>( IrpContext, Fcb );
00295 
00296         <span class="keywordflow">if</span> (SendUnlockNotification) {
00297 
00298             <a class="code" href="../../d1/d8/fsrtl_8h.html#a168">FsRtlNotifyVolumeEvent</a>( FileObject, FSRTL_VOLUME_UNLOCK );
00299         }
00300     }
00301 
00302     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg,
00303                  <span class="stringliteral">"UdfCommonCleanup, Fcb %08x FO %08x -&gt; SUCCESS\n"</span>,
00304                  Fcb,
00305                  FileObject ));
00306     
00307     <span class="comment">//</span>
00308     <span class="comment">//  If appropriate, try to spark teardown by purging the volume.  Should</span>
00309     <span class="comment">//  this very fileobject we were cleaning up be the last reason for the</span>
00310     <span class="comment">//  volume to remain, teardown will commence on completion of this Irp.</span>
00311     <span class="comment">//</span>
00312     
00313     <span class="keywordflow">if</span> (AttemptTeardown) {
00314 
00315         <a class="code" href="../../d3/d8/udfprocs_8h.html#a74">UdfAcquireVcbExclusive</a>( IrpContext, Vcb, FALSE );
00316 
00317         <span class="keywordflow">try</span> {
00318             
00319             <a class="code" href="../../d3/d8/udfprocs_8h.html#a158">UdfPurgeVolume</a>( IrpContext, Vcb, FALSE );
00320 
00321         } finally {
00322 
00323             <a class="code" href="../../d3/d8/udfprocs_8h.html#a76">UdfReleaseVcb</a>( IrpContext, Vcb );
00324         }
00325     }
00326 
00327     <span class="comment">//</span>
00328     <span class="comment">//  If this is a normal termination then complete the request</span>
00329     <span class="comment">//</span>
00330 
00331     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_SUCCESS );
00332 
00333     <span class="keywordflow">return</span> STATUS_SUCCESS;
00334 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:04 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
