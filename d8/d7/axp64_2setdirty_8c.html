<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: axp64/setdirty.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>setdirty.c File Reference</h1><code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">mi.h</a>"</code><br>

<p>
<a href="../../d9/d6/axp64_2setdirty_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d7/axp64_2setdirty_8c.html#a0">MiSetDirtyBit</a> (IN PVOID FaultingAddress, IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte, IN ULONG PfnHeld)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a0" doxytag="axp64/setdirty.c::MiSetDirtyBit" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiSetDirtyBit           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>FaultingAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PointerPte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PfnHeld</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d6/axp64_2setdirty_8c-source.html#l00028">28</a> of file <a class="el" href="../../d9/d6/axp64_2setdirty_8c-source.html">axp64/setdirty.c</a>.
<p>
References <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01313">MI_SET_ACCESSED_IN_PTE</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l01014">MiReleasePageFileSpace()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, and <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>.
<p>
<pre class="fragment"><div>00036                    :
00037 
00038     This routine sets dirty in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified PTE and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> modify bit in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00039     correpsonding PFN element.  If any page <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> space <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allocated, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
00040     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> deallocated.
00041 
00042 Arguments:
00043 
00044     FaultingAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> faulting address.
00045 
00046     PointerPte - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding valid PTE.
00047 
00048     PfnHeld - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN mutex <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already held.
00049 
00050 Return Value:
00051 
00052     None.
00053 
00054 Environment:
00055 
00056     Kernel mode, APC's disabled, Working set mutex held.
00057 
00058 --*/
00059 
00060 {
00061     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00062     PFN_NUMBER PageFrameIndex;
00063     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00064     KIRQL OldIrql;
00065 
00066     <span class="comment">//</span>
00067     <span class="comment">// The TB entry must be flushed as the valid PTE with the dirty bit clear</span>
00068     <span class="comment">// has been fetched into the TB. If it isn't flushed, another fault</span>
00069     <span class="comment">// is generated as the dirty bit is not set in the cached TB entry.</span>
00070     <span class="comment">//</span>
00071 
00072     <span class="comment">// KiFlushSingleDataTb( FaultingAddress );</span>
00073     __dtbis( FaultingAddress );
00074 
00075     <span class="comment">//</span>
00076     <span class="comment">// The page is NOT copy on write, update the PTE setting both the</span>
00077     <span class="comment">// dirty bit and the accessed bit. Note, that as this PTE is in</span>
00078     <span class="comment">// the TB, the TB must be flushed.</span>
00079     <span class="comment">//</span>
00080 
00081     PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(PointerPte);
00082     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
00083 
00084     TempPte = *PointerPte;
00085     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.FaultOnWrite = 0;
00086     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a137">MI_SET_ACCESSED_IN_PTE</a> (&amp;TempPte, 1);
00087     *PointerPte = TempPte;
00088 
00089     <span class="comment">//</span>
00090     <span class="comment">// If the PFN database lock is not held, then do not update the</span>
00091     <span class="comment">// PFN database.</span>
00092     <span class="comment">//</span>
00093 
00094     <span class="keywordflow">if</span>( PfnHeld ){
00095 
00096         <span class="comment">//</span>
00097         <span class="comment">// Set the modified field in the PFN database, also, if the physical</span>
00098         <span class="comment">// page is currently in a paging file, free up the page file space</span>
00099         <span class="comment">// as the contents are now worthless.</span>
00100         <span class="comment">//</span>
00101 
00102         <span class="keywordflow">if</span> ( (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
00103              (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress == 0) ) {
00104 
00105             <span class="comment">//</span>
00106             <span class="comment">// This page is in page file format, deallocate the page file space.</span>
00107             <span class="comment">//</span>
00108 
00109             <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
00110 
00111             <span class="comment">//</span>
00112             <span class="comment">// Change original PTE to indicate no page file space is reserved,</span>
00113             <span class="comment">// otherwise the space will be deallocated when the PTE is</span>
00114             <span class="comment">// deleted.</span>
00115             <span class="comment">//</span>
00116 
00117             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh = 0;
00118         }
00119 
00120         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 1;
00121 
00122     }
00123 
00124 
00125     <span class="keywordflow">return</span>;
00126 }
}
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:38 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
