<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: resource.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>resource.c</h1><a href="../../d7/d8/dll_2resource_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989-1993  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    Resource.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the executive functions to acquire and release</span>
00012 <span class="comment">    a shared resource.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Mark Lucovsky       (markl)     04-Aug-1989</span>
00017 <span class="comment"></span>
00018 <span class="comment">Environment:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    These routines are statically linked in the caller's executable and</span>
00021 <span class="comment">    are callable in only from user mode.  They make use of Nt system</span>
00022 <span class="comment">    services.</span>
00023 <span class="comment"></span>
00024 <span class="comment">Revision History:</span>
00025 <span class="comment"></span>
00026 <span class="comment">--*/</span>
00027 
00028 <span class="preprocessor">#include &lt;<a class="code" href="../../d9/d8/ntos_8h.html">ntos.h</a>&gt;</span>
00029 <span class="preprocessor">#include &lt;ntrtl.h&gt;</span>
00030 <span class="preprocessor">#include &lt;nturtl.h&gt;</span>
00031 <span class="preprocessor">#include &lt;<a class="code" href="../../d3/d9/heap_8h.html">heap.h</a>&gt;</span>
00032 <span class="preprocessor">#include "<a class="code" href="../../d9/d2/ldrp_8h.html">ldrp.h</a>"</span>
00033 
00034 <span class="comment">//</span>
00035 <span class="comment">// Define the desired access for semaphores.</span>
00036 <span class="comment">//</span>
00037 
<a name="l00038"></a><a class="code" href="../../d7/d8/dll_2resource_8c.html#a0">00038</a> <span class="preprocessor">#define DESIRED_EVENT_ACCESS \</span>
00039 <span class="preprocessor">                (EVENT_QUERY_STATE | EVENT_MODIFY_STATE | SYNCHRONIZE)</span>
00040 <span class="preprocessor"></span>
<a name="l00041"></a><a class="code" href="../../d7/d8/dll_2resource_8c.html#a1">00041</a> <span class="preprocessor">#define DESIRED_SEMAPHORE_ACCESS \</span>
00042 <span class="preprocessor">                (SEMAPHORE_QUERY_STATE | SEMAPHORE_MODIFY_STATE | SYNCHRONIZE)</span>
00043 <span class="preprocessor"></span>
00044 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d7/d8/dll_2resource_8c.html#a10">RtlDumpResource</a>( IN PRTL_RESOURCE Resource );
00045 
<a name="l00046"></a><a class="code" href="../../d7/d8/dll_2resource_8c.html#a4">00046</a> <span class="keyword">extern</span> BOOLEAN <a class="code" href="../../d8/d2/ldrinit_8c.html#a0">LdrpShutdownInProgress</a>;
<a name="l00047"></a><a class="code" href="../../d7/d8/dll_2resource_8c.html#a5">00047</a> <span class="keyword">extern</span> HANDLE <a class="code" href="../../d9/d2/ldrp_8h.html#a47">LdrpShutdownThreadId</a>;
00048 
00049 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00050 <a class="code" href="../../d7/d8/dll_2resource_8c.html#a11">RtlpInitDeferedCriticalSection</a>( VOID );
<a name="l00051"></a><a class="code" href="../../d7/d8/dll_2resource_8c.html#a6">00051</a> RTL_CRITICAL_SECTION <a class="code" href="../../d7/d8/dll_2resource_8c.html#a6">DeferedCriticalSection</a>;
00052 
00053 <span class="preprocessor">#if DBG</span>
00054 <span class="preprocessor"></span>BOOLEAN
00055 <a class="code" href="../../d4/d1/userk_8h.html#a966">ProtectHandle</a>(
00056     HANDLE hObject
00057     )
00058 {
00059     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00060     OBJECT_HANDLE_FLAG_INFORMATION HandleInfo;
00061 
00062     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/obquery_8c.html#a5">NtQueryObject</a>( hObject,
00063                             ObjectHandleFlagInformation,
00064                             &amp;HandleInfo,
00065                             <span class="keyword">sizeof</span>( HandleInfo ),
00066                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00067                           );
00068     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00069         HandleInfo.ProtectFromClose = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00070 
00071         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/obquery_8c.html#a6">NtSetInformationObject</a>( hObject,
00072                                          ObjectHandleFlagInformation,
00073                                          &amp;HandleInfo,
00074                                          <span class="keyword">sizeof</span>( HandleInfo )
00075                                        );
00076         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00077             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00078             }
00079         }
00080 
00081     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00082 }
00083 
00084 
00085 BOOLEAN
00086 <a class="code" href="../../d8/d5/consrv_8h.html#a77">UnProtectHandle</a>(
00087     HANDLE hObject
00088     )
00089 {
00090     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00091     OBJECT_HANDLE_FLAG_INFORMATION HandleInfo;
00092 
00093     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/obquery_8c.html#a5">NtQueryObject</a>( hObject,
00094                             ObjectHandleFlagInformation,
00095                             &amp;HandleInfo,
00096                             <span class="keyword">sizeof</span>( HandleInfo ),
00097                             NULL
00098                           );
00099     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00100         HandleInfo.ProtectFromClose = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00101 
00102         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/obquery_8c.html#a6">NtSetInformationObject</a>( hObject,
00103                                          ObjectHandleFlagInformation,
00104                                          &amp;HandleInfo,
00105                                          <span class="keyword">sizeof</span>( HandleInfo )
00106                                        );
00107         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00108             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00109             }
00110         }
00111 
00112     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00113 }
00114 <span class="preprocessor">#endif // DBG</span>
00115 <span class="preprocessor"></span>
<a name="l00116"></a><a class="code" href="../../d7/d8/dll_2resource_8c.html#a7">00116</a> RTL_CRITICAL_SECTION_DEBUG <a class="code" href="../../d7/d8/dll_2resource_8c.html#a7">RtlpStaticDebugInfo</a>[ 64 ];
<a name="l00117"></a><a class="code" href="../../d7/d8/dll_2resource_8c.html#a8">00117</a> PRTL_CRITICAL_SECTION_DEBUG <a class="code" href="../../d7/d8/dll_2resource_8c.html#a8">RtlpDebugInfoFreeList</a>;
<a name="l00118"></a><a class="code" href="../../d7/d8/dll_2resource_8c.html#a9">00118</a> BOOLEAN <a class="code" href="../../d7/d8/dll_2resource_8c.html#a9">RtlpCritSectInitialized</a>;
00119 
00120 PRTL_CRITICAL_SECTION_DEBUG
<a name="l00121"></a><a class="code" href="../../d7/d8/dll_2resource_8c.html#a12">00121</a> <a class="code" href="../../d7/d8/dll_2resource_8c.html#a12">RtlpChainDebugInfo</a>(
00122     IN PVOID BaseAddress,
00123     IN ULONG Size
00124     )
00125 {
00126     PRTL_CRITICAL_SECTION_DEBUG p, p1;
00127 
00128     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> / <span class="keyword">sizeof</span>( RTL_CRITICAL_SECTION_DEBUG )) {
00129         p = (PRTL_CRITICAL_SECTION_DEBUG)BaseAddress + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - 1;
00130         *(PRTL_CRITICAL_SECTION_DEBUG *)p = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00131         <span class="keywordflow">while</span> (--<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>) {
00132             p1 = p - 1;
00133             *(PRTL_CRITICAL_SECTION_DEBUG *)p1 = p;
00134             p = p1;
00135             }
00136         }
00137 
00138     <span class="keywordflow">return</span> p;
00139 }
00140 
00141 
00142 PVOID
00143 <a class="code" href="../../d7/d8/dll_2resource_8c.html#a13">RtlpAllocateDebugInfo</a>( VOID );
00144 
00145 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00146 <a class="code" href="../../d7/d8/dll_2resource_8c.html#a14">RtlpFreeDebugInfo</a>(
00147     IN PVOID DebugInfo
00148     );
00149 
00150 PVOID
<a name="l00151"></a><a class="code" href="../../d7/d8/dll_2resource_8c.html#a13">00151</a> <a class="code" href="../../d7/d8/dll_2resource_8c.html#a13">RtlpAllocateDebugInfo</a>( VOID )
00152 {
00153     PRTL_CRITICAL_SECTION_DEBUG p;
00154     PPEB Peb;
00155 
00156 
00157     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d8/dll_2resource_8c.html#a9">RtlpCritSectInitialized</a>) {
00158         RtlEnterCriticalSection(&amp;<a class="code" href="../../d7/d8/dll_2resource_8c.html#a6">DeferedCriticalSection</a>);
00159         }
00160     <span class="keywordflow">try</span> {
00161         p = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a8">RtlpDebugInfoFreeList</a>;
00162         <span class="keywordflow">if</span> (p == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00163             Peb = NtCurrentPeb();
00164             p = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(Peb-&gt;ProcessHeap,0,<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>-<a class="code" href="../../d3/d9/heap_8h.html#a3">HEAP_GRANULARITY</a>);
00165             <span class="keywordflow">if</span> ( !p ) {
00166                 KdPrint(( <span class="stringliteral">"NTDLL: Unable to allocate debug information from heap\n"</span>));
00167                 }
00168             <span class="keywordflow">else</span> {
00169                 p = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a12">RtlpChainDebugInfo</a>( p, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>-<a class="code" href="../../d3/d9/heap_8h.html#a3">HEAP_GRANULARITY</a> );
00170                 }
00171             }
00172 
00173         <span class="keywordflow">if</span> (p != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00174             <a class="code" href="../../d7/d8/dll_2resource_8c.html#a8">RtlpDebugInfoFreeList</a> = *(PRTL_CRITICAL_SECTION_DEBUG *)p;
00175             }
00176         }
00177     finally {
00178         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d8/dll_2resource_8c.html#a9">RtlpCritSectInitialized</a>) {
00179             RtlLeaveCriticalSection(&amp;<a class="code" href="../../d7/d8/dll_2resource_8c.html#a6">DeferedCriticalSection</a>);
00180             }
00181         }
00182 
00183     <span class="keywordflow">return</span> p;
00184 }
00185 
00186 
00187 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00188"></a><a class="code" href="../../d7/d8/dll_2resource_8c.html#a14">00188</a> <a class="code" href="../../d7/d8/dll_2resource_8c.html#a14">RtlpFreeDebugInfo</a>(
00189     IN PVOID DebugInfo
00190     )
00191 {
00192     RtlEnterCriticalSection(&amp;<a class="code" href="../../d7/d8/dll_2resource_8c.html#a6">DeferedCriticalSection</a>);
00193     <span class="keywordflow">try</span> {
00194         RtlZeroMemory( DebugInfo, <span class="keyword">sizeof</span>( RTL_CRITICAL_SECTION_DEBUG ) );
00195         *(PRTL_CRITICAL_SECTION_DEBUG *)DebugInfo = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a8">RtlpDebugInfoFreeList</a>;
00196         <a class="code" href="../../d7/d8/dll_2resource_8c.html#a8">RtlpDebugInfoFreeList</a> = (PRTL_CRITICAL_SECTION_DEBUG)DebugInfo;
00197         }
00198     finally {
00199         RtlLeaveCriticalSection(&amp;<a class="code" href="../../d7/d8/dll_2resource_8c.html#a6">DeferedCriticalSection</a>);
00200         }
00201 
00202     <span class="keywordflow">return</span>;
00203 }
00204 
00205 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00206 <a class="code" href="../../d7/d8/dll_2resource_8c.html#a15">RtlpCreateCriticalSectionSem</a>(
00207     IN PRTL_CRITICAL_SECTION CriticalSection
00208     );
00209 
00210 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00211"></a><a class="code" href="../../d8/d2/ldrinit_8c.html#a18">00211</a> <a class="code" href="../../d7/d8/dll_2resource_8c.html#a11">RtlpInitDeferedCriticalSection</a>( VOID )
00212 {
00213 
00214     InitializeListHead( &amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a34">RtlCriticalSectionList</a> );
00215 
00216     <span class="keywordflow">if</span> (<span class="keyword">sizeof</span>( RTL_CRITICAL_SECTION_DEBUG ) != <span class="keyword">sizeof</span>( RTL_RESOURCE_DEBUG )) {
00217         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"NTDLL: Critical Section &amp; Resource Debug Info length mismatch.\n"</span> );
00218         <span class="keywordflow">return</span>;
00219         }
00220 
00221     <a class="code" href="../../d7/d8/dll_2resource_8c.html#a8">RtlpDebugInfoFreeList</a> = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a12">RtlpChainDebugInfo</a>( <a class="code" href="../../d7/d8/dll_2resource_8c.html#a7">RtlpStaticDebugInfo</a>,
00222                                                 <span class="keyword">sizeof</span>( <a class="code" href="../../d7/d8/dll_2resource_8c.html#a7">RtlpStaticDebugInfo</a> )
00223                                               );
00224 
00225     <a class="code" href="../../d7/d8/dll_2resource_8c.html#a26">RtlInitializeCriticalSectionAndSpinCount</a>( &amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a35">RtlCriticalSectionLock</a>, 1000 );
00226     <a class="code" href="../../d7/d8/dll_2resource_8c.html#a26">RtlInitializeCriticalSectionAndSpinCount</a>( &amp;<a class="code" href="../../d7/d8/dll_2resource_8c.html#a6">DeferedCriticalSection</a>, 1000 );
00227 
00228     <a class="code" href="../../d7/d8/dll_2resource_8c.html#a15">RtlpCreateCriticalSectionSem</a>(&amp;<a class="code" href="../../d7/d8/dll_2resource_8c.html#a6">DeferedCriticalSection</a>);
00229 
00230     <a class="code" href="../../d7/d8/dll_2resource_8c.html#a9">RtlpCritSectInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00231     <span class="keywordflow">return</span>;
00232 }
00233 
00234 
00235 BOOLEAN
<a name="l00236"></a><a class="code" href="../../d7/d6/stktrace_8c.html#a5">00236</a> <a class="code" href="../../d1/d1/theap_8c.html#a18">NtdllOkayToLockRoutine</a>(
00237     IN PVOID Lock
00238     )
00239 {
00240     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00241 }
00242 
00243 
00244 
00245 
00246 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00247"></a><a class="code" href="../../d7/d8/dll_2resource_8c.html#a17">00247</a> <a class="code" href="../../d7/d8/dll_2resource_8c.html#a17">RtlInitializeResource</a>(
00248     IN PRTL_RESOURCE Resource
00249     )
00250 
00251 <span class="comment">/*++</span>
00252 <span class="comment"></span>
00253 <span class="comment">Routine Description:</span>
00254 <span class="comment"></span>
00255 <span class="comment">    This routine initializes the input resource variable</span>
00256 <span class="comment"></span>
00257 <span class="comment">Arguments:</span>
00258 <span class="comment"></span>
00259 <span class="comment">    Resource - Supplies the resource variable being initialized</span>
00260 <span class="comment"></span>
00261 <span class="comment">Return Value:</span>
00262 <span class="comment"></span>
00263 <span class="comment">    None</span>
00264 <span class="comment"></span>
00265 <span class="comment">--*/</span>
00266 
00267 {
00268     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00269     PRTL_RESOURCE_DEBUG ResourceDebugInfo;
00270 
00271     <span class="comment">//</span>
00272     <span class="comment">//  Initialize the lock fields, the count indicates how many are waiting</span>
00273     <span class="comment">//  to enter or are in the critical section, LockSemaphore is the object</span>
00274     <span class="comment">//  to wait on when entering the critical section.  SpinLock is used</span>
00275     <span class="comment">//  for the add interlock instruction.</span>
00276     <span class="comment">//</span>
00277 
00278     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a26">RtlInitializeCriticalSectionAndSpinCount</a>( &amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection, 1000 );
00279     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ){
00280         <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00281         }
00282 
00283     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection.DebugInfo-&gt;Type = RTL_RESOURCE_TYPE;
00284     ResourceDebugInfo = (PRTL_RESOURCE_DEBUG)
00285         <a class="code" href="../../d7/d8/dll_2resource_8c.html#a13">RtlpAllocateDebugInfo</a>();
00286 
00287     <span class="keywordflow">if</span> (ResourceDebugInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00288         <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(STATUS_NO_MEMORY);
00289         }
00290 
00291     ResourceDebugInfo-&gt;ContentionCount = 0;
00292     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;DebugInfo = ResourceDebugInfo;
00293 
00294     <span class="comment">//</span>
00295     <span class="comment">//  Initialize flags so there is a default value.</span>
00296     <span class="comment">//  (Some apps may set RTL_RESOURCE_FLAGS_LONG_TERM to affect timeouts.)</span>
00297     <span class="comment">//</span>
00298 
00299     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;Flags = 0;
00300 
00301 
00302     <span class="comment">//</span>
00303     <span class="comment">//  Initialize the shared and exclusive waiting counters and semaphore.</span>
00304     <span class="comment">//  The counters indicate how many are waiting for access to the resource</span>
00305     <span class="comment">//  and the semaphores are used to wait on the resource.  Note that</span>
00306     <span class="comment">//  the semaphores can also indicate the number waiting for a resource</span>
00307     <span class="comment">//  however there is a race condition in the alogrithm on the acquire</span>
00308     <span class="comment">//  side if count if not updated before the critical section is exited.</span>
00309     <span class="comment">//</span>
00310 
00311     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d6/semphore_8c.html#a4">NtCreateSemaphore</a>(
00312                  &amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;SharedSemaphore,
00313                  <a class="code" href="../../d7/d8/dll_2resource_8c.html#a1">DESIRED_SEMAPHORE_ACCESS</a>,
00314                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00315                  0,
00316                  MAXLONG
00317                  );
00318     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ){
00319         <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00320         }
00321 
00322     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingShared = 0;
00323 
00324     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d6/semphore_8c.html#a4">NtCreateSemaphore</a>(
00325                  &amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveSemaphore,
00326                  <a class="code" href="../../d7/d8/dll_2resource_8c.html#a1">DESIRED_SEMAPHORE_ACCESS</a>,
00327                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00328                  0,
00329                  MAXLONG
00330                  );
00331     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ){
00332         <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00333         }
00334 
00335     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingExclusive = 0;
00336 
00337     <span class="comment">//</span>
00338     <span class="comment">//  Initialize the current state of the resource</span>
00339     <span class="comment">//</span>
00340 
00341     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive = 0;
00342 
00343     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveOwnerThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00344 
00345     <span class="keywordflow">return</span>;
00346 }
00347 
00348 
00349 BOOLEAN
<a name="l00350"></a><a class="code" href="../../d7/d8/dll_2resource_8c.html#a18">00350</a> <a class="code" href="../../d7/d8/dll_2resource_8c.html#a18">RtlAcquireResourceShared</a>(
00351     IN PRTL_RESOURCE Resource,
00352     IN BOOLEAN Wait
00353     )
00354 
00355 <span class="comment">/*++</span>
00356 <span class="comment"></span>
00357 <span class="comment">Routine Description:</span>
00358 <span class="comment"></span>
00359 <span class="comment">    The routine acquires the resource for shared access.  Upon return from</span>
00360 <span class="comment">    the procedure the resource is acquired for shared access.</span>
00361 <span class="comment"></span>
00362 <span class="comment">Arguments:</span>
00363 <span class="comment"></span>
00364 <span class="comment">    Resource - Supplies the resource to acquire</span>
00365 <span class="comment"></span>
00366 <span class="comment">    Wait - Indicates if the call is allowed to wait for the resource</span>
00367 <span class="comment">        to become available for must return immediately</span>
00368 <span class="comment"></span>
00369 <span class="comment">Return Value:</span>
00370 <span class="comment"></span>
00371 <span class="comment">    BOOLEAN - TRUE if the resource is acquired and FALSE otherwise</span>
00372 <span class="comment"></span>
00373 <span class="comment">--*/</span>
00374 
00375 {
00376     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00377     ULONG TimeoutCount = 0;
00378     PLARGE_INTEGER TimeoutTime = &amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a32">RtlpTimeout</a>;
00379     <span class="comment">//</span>
00380     <span class="comment">//  Enter the critical section</span>
00381     <span class="comment">//</span>
00382 
00383     RtlEnterCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
00384 
00385     <span class="comment">//</span>
00386     <span class="comment">//  If it is not currently acquired for exclusive use then we can acquire</span>
00387     <span class="comment">//  the resource for shared access.  Note that this can potentially</span>
00388     <span class="comment">//  starve an exclusive waiter however, this is necessary given the</span>
00389     <span class="comment">//  ability to recursively acquire the resource shared.  Otherwise we</span>
00390     <span class="comment">//  might/will reach a deadlock situation where a thread tries to acquire</span>
00391     <span class="comment">//  the resource recusively shared but is blocked by an exclusive waiter.</span>
00392     <span class="comment">//</span>
00393     <span class="comment">//  The test to reanable not starving an exclusive waiter is:</span>
00394     <span class="comment">//</span>
00395     <span class="comment">//      if ((Resource-&gt;NumberOfWaitingExclusive == 0) &amp;&amp;</span>
00396     <span class="comment">//          (Resource-&gt;NumberOfActive &gt;= 0)) {</span>
00397     <span class="comment">//</span>
00398 
00399     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive &gt;= 0) {
00400 
00401         <span class="comment">//</span>
00402         <span class="comment">//  The resource is ours, so indicate that we have it and</span>
00403         <span class="comment">//  exit the critical section</span>
00404         <span class="comment">//</span>
00405 
00406         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive += 1;
00407 
00408         RtlLeaveCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
00409 
00410     <span class="comment">//</span>
00411     <span class="comment">//  Otherwise check to see if this thread is the one currently holding</span>
00412     <span class="comment">//  exclusive access to the resource.  And if it is then we change</span>
00413     <span class="comment">//  this shared request to an exclusive recusive request and grant</span>
00414     <span class="comment">//  access to the resource.</span>
00415     <span class="comment">//</span>
00416 
00417     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveOwnerThread == NtCurrentTeb()-&gt;ClientId.UniqueThread) {
00418 
00419         <span class="comment">//</span>
00420         <span class="comment">//  The resource is ours (recusively) so indicate that we have it</span>
00421         <span class="comment">//  and exit the critial section</span>
00422         <span class="comment">//</span>
00423 
00424         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive -= 1;
00425 
00426         RtlLeaveCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
00427 
00428     <span class="comment">//</span>
00429     <span class="comment">//  Otherwise we'll have to wait for access.</span>
00430     <span class="comment">//</span>
00431 
00432     } <span class="keywordflow">else</span> {
00433 
00434         <span class="comment">//</span>
00435         <span class="comment">//  Check if we are allowed to wait or must return immedately, and</span>
00436         <span class="comment">//  indicate that we didn't acquire the resource</span>
00437         <span class="comment">//</span>
00438 
00439         <span class="keywordflow">if</span> (!Wait) {
00440 
00441             RtlLeaveCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
00442 
00443             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00444 
00445         }
00446 
00447         <span class="comment">//</span>
00448         <span class="comment">//  Otherwise we need to wait to acquire the resource.</span>
00449         <span class="comment">//  To wait we will increment the number of waiting shared,</span>
00450         <span class="comment">//  release the lock, and wait on the shared semaphore</span>
00451         <span class="comment">//</span>
00452 
00453         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingShared += 1;
00454         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;DebugInfo-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o7">ContentionCount</a>++;
00455 
00456         RtlLeaveCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
00457 
00458 rewait:
00459         <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;Flags &amp; RTL_RESOURCE_FLAG_LONG_TERM ) {
00460             TimeoutTime = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00461         }
00462         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>(
00463                     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;SharedSemaphore,
00464                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00465                     TimeoutTime
00466                     );
00467         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_TIMEOUT ) {
00468             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"RTL: Acquire Shared Sem Timeout %d(2 minutes)\n"</span>,TimeoutCount);
00469             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"RTL: Resource at %p\n"</span>,<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>);
00470             TimeoutCount++;
00471             <span class="keywordflow">if</span> ( TimeoutCount &gt; 2 ) {
00472                 PIMAGE_NT_HEADERS NtHeaders;
00473 
00474                 <span class="comment">//</span>
00475                 <span class="comment">// If the image is a Win32 image, then raise an exception and try to get to the</span>
00476                 <span class="comment">// uae popup</span>
00477                 <span class="comment">//</span>
00478 
00479                 NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(NtCurrentPeb()-&gt;ImageBaseAddress);
00480 
00481                 <span class="keywordflow">if</span> (NtHeaders-&gt;OptionalHeader.Subsystem == IMAGE_SUBSYSTEM_WINDOWS_CUI ||
00482                     NtHeaders-&gt;OptionalHeader.Subsystem == IMAGE_SUBSYSTEM_WINDOWS_GUI) {
00483                     EXCEPTION_RECORD ExceptionRecord;
00484 
00485                     ExceptionRecord.ExceptionCode = STATUS_POSSIBLE_DEADLOCK;
00486                     ExceptionRecord.ExceptionFlags = 0;
00487                     ExceptionRecord.ExceptionRecord = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00488                     ExceptionRecord.ExceptionAddress = (PVOID)<a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a17">RtlRaiseException</a>;
00489                     ExceptionRecord.NumberParameters = 1;
00490                     ExceptionRecord.ExceptionInformation[0] = (ULONG_PTR)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>;
00491                     <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a9">RtlRaiseException</a>(&amp;ExceptionRecord);
00492                     }
00493                 <span class="keywordflow">else</span> {
00494                     DbgBreakPoint();
00495                     }
00496                 }
00497             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"RTL: Re-Waiting\n"</span>);
00498             <span class="keywordflow">goto</span> rewait;
00499         }
00500         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00501             <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00502             }
00503     }
00504 
00505     <span class="comment">//</span>
00506     <span class="comment">//  Now the resource is ours, for shared access</span>
00507     <span class="comment">//</span>
00508 
00509     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00510 
00511 }
00512 
00513 
00514 BOOLEAN
<a name="l00515"></a><a class="code" href="../../d7/d8/dll_2resource_8c.html#a19">00515</a> <a class="code" href="../../d7/d8/dll_2resource_8c.html#a19">RtlAcquireResourceExclusive</a>(
00516     IN PRTL_RESOURCE Resource,
00517     IN BOOLEAN Wait
00518     )
00519 
00520 <span class="comment">/*++</span>
00521 <span class="comment"></span>
00522 <span class="comment">Routine Description:</span>
00523 <span class="comment"></span>
00524 <span class="comment">    The routine acquires the resource for exclusive access.  Upon return from</span>
00525 <span class="comment">    the procedure the resource is acquired for exclusive access.</span>
00526 <span class="comment"></span>
00527 <span class="comment">Arguments:</span>
00528 <span class="comment"></span>
00529 <span class="comment">    Resource - Supplies the resource to acquire</span>
00530 <span class="comment"></span>
00531 <span class="comment">    Wait - Indicates if the call is allowed to wait for the resource</span>
00532 <span class="comment">        to become available for must return immediately</span>
00533 <span class="comment"></span>
00534 <span class="comment">Return Value:</span>
00535 <span class="comment"></span>
00536 <span class="comment">    BOOLEAN - TRUE if the resource is acquired and FALSE otherwise</span>
00537 <span class="comment"></span>
00538 <span class="comment">--*/</span>
00539 
00540 {
00541     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00542     ULONG TimeoutCount = 0;
00543     PLARGE_INTEGER TimeoutTime = &amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a32">RtlpTimeout</a>;
00544 
00545     <span class="comment">//</span>
00546     <span class="comment">//  Loop until the resource is ours or exit if we cannot wait.</span>
00547     <span class="comment">//</span>
00548 
00549     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00550 
00551         <span class="comment">//</span>
00552         <span class="comment">//  Enter the critical section</span>
00553         <span class="comment">//</span>
00554 
00555         RtlEnterCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
00556 
00557         <span class="comment">//</span>
00558         <span class="comment">//  If there are no shared users and it is not currently acquired for</span>
00559         <span class="comment">//  exclusive use then we can acquire the resource for exclusive</span>
00560         <span class="comment">//  access.  We also can acquire it if the resource indicates exclusive</span>
00561         <span class="comment">//  access but there isn't currently an owner.</span>
00562         <span class="comment">//</span>
00563 
00564         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive == 0)
00565 
00566                 ||
00567 
00568             ((<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive == -1) &amp;&amp;
00569              (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveOwnerThread == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))) {
00570 
00571             <span class="comment">//</span>
00572             <span class="comment">//  The resource is ours, so indicate that we have it and</span>
00573             <span class="comment">//  exit the critical section</span>
00574             <span class="comment">//</span>
00575 
00576             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive = -1;
00577 
00578             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveOwnerThread = NtCurrentTeb()-&gt;ClientId.UniqueThread;
00579 
00580             RtlLeaveCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
00581 
00582             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00583 
00584         }
00585 
00586         <span class="comment">//</span>
00587         <span class="comment">//  Otherwise check to see if we already have exclusive access to the</span>
00588         <span class="comment">//  resource and can simply recusively acquire it again.</span>
00589         <span class="comment">//</span>
00590 
00591         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveOwnerThread == NtCurrentTeb()-&gt;ClientId.UniqueThread) {
00592 
00593             <span class="comment">//</span>
00594             <span class="comment">//  The resource is ours (recusively) so indicate that we have it</span>
00595             <span class="comment">//  and exit the critial section</span>
00596             <span class="comment">//</span>
00597 
00598             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive -= 1;
00599 
00600             RtlLeaveCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
00601 
00602             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00603 
00604         }
00605 
00606         <span class="comment">//</span>
00607         <span class="comment">//  Check if we are allowed to wait or must return immedately, and</span>
00608         <span class="comment">//  indicate that we didn't acquire the resource</span>
00609         <span class="comment">//</span>
00610 
00611         <span class="keywordflow">if</span> (!Wait) {
00612 
00613             RtlLeaveCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
00614 
00615             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00616 
00617         }
00618 
00619         <span class="comment">//</span>
00620         <span class="comment">//  Otherwise we need to wait to acquire the resource.</span>
00621         <span class="comment">//  To wait we will increment the number of waiting exclusive,</span>
00622         <span class="comment">//  release the lock, and wait on the exclusive semaphore</span>
00623         <span class="comment">//</span>
00624 
00625         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingExclusive += 1;
00626         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;DebugInfo-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o7">ContentionCount</a>++;
00627 
00628         RtlLeaveCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
00629 
00630 rewait:
00631         <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;Flags &amp; RTL_RESOURCE_FLAG_LONG_TERM ) {
00632             TimeoutTime = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00633         }
00634         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>(
00635                     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveSemaphore,
00636                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00637                     TimeoutTime
00638                     );
00639         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_TIMEOUT ) {
00640             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"RTL: Acquire Exclusive Sem Timeout %d (2 minutes)\n"</span>,TimeoutCount);
00641             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"RTL: Resource at %p\n"</span>,<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>);
00642             TimeoutCount++;
00643             <span class="keywordflow">if</span> ( TimeoutCount &gt; 2 ) {
00644                 PIMAGE_NT_HEADERS NtHeaders;
00645 
00646                 <span class="comment">//</span>
00647                 <span class="comment">// If the image is a Win32 image, then raise an exception and try to get to the</span>
00648                 <span class="comment">// uae popup</span>
00649                 <span class="comment">//</span>
00650 
00651                 NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(NtCurrentPeb()-&gt;ImageBaseAddress);
00652 
00653                 <span class="keywordflow">if</span> (NtHeaders-&gt;OptionalHeader.Subsystem == IMAGE_SUBSYSTEM_WINDOWS_CUI ||
00654                     NtHeaders-&gt;OptionalHeader.Subsystem == IMAGE_SUBSYSTEM_WINDOWS_GUI) {
00655                     EXCEPTION_RECORD ExceptionRecord;
00656 
00657                     ExceptionRecord.ExceptionCode = STATUS_POSSIBLE_DEADLOCK;
00658                     ExceptionRecord.ExceptionFlags = 0;
00659                     ExceptionRecord.ExceptionRecord = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00660                     ExceptionRecord.ExceptionAddress = (PVOID)<a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a17">RtlRaiseException</a>;
00661                     ExceptionRecord.NumberParameters = 1;
00662                     ExceptionRecord.ExceptionInformation[0] = (ULONG_PTR)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>;
00663                     <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a9">RtlRaiseException</a>(&amp;ExceptionRecord);
00664                     }
00665                 <span class="keywordflow">else</span> {
00666                     DbgBreakPoint();
00667                     }
00668                 }
00669             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"RTL: Re-Waiting\n"</span>);
00670             <span class="keywordflow">goto</span> rewait;
00671         }
00672         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00673             <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00674             }
00675     }
00676 }
00677 
00678 
00679 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00680"></a><a class="code" href="../../d7/d8/dll_2resource_8c.html#a20">00680</a> <a class="code" href="../../d7/d8/dll_2resource_8c.html#a20">RtlReleaseResource</a>(
00681     IN PRTL_RESOURCE Resource
00682     )
00683 
00684 <span class="comment">/*++</span>
00685 <span class="comment"></span>
00686 <span class="comment">Routine Description:</span>
00687 <span class="comment"></span>
00688 <span class="comment">    This routine release the input resource.  The resource can have been</span>
00689 <span class="comment">    acquired for either shared or exclusive access.</span>
00690 <span class="comment"></span>
00691 <span class="comment">Arguments:</span>
00692 <span class="comment"></span>
00693 <span class="comment">    Resource - Supplies the resource to release</span>
00694 <span class="comment"></span>
00695 <span class="comment">Return Value:</span>
00696 <span class="comment"></span>
00697 <span class="comment">    None.</span>
00698 <span class="comment"></span>
00699 <span class="comment">--*/</span>
00700 
00701 {
00702     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00703     LONG PreviousCount;
00704 
00705     <span class="comment">//</span>
00706     <span class="comment">//  Enter the critical section</span>
00707     <span class="comment">//</span>
00708 
00709     RtlEnterCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
00710 
00711     <span class="comment">//</span>
00712     <span class="comment">//  Test if the resource is acquired for shared or exclusive access</span>
00713     <span class="comment">//</span>
00714 
00715     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive &gt; 0) {
00716 
00717         <span class="comment">//</span>
00718         <span class="comment">//  Releasing shared access to the resource, so decrement</span>
00719         <span class="comment">//  the number of shared users</span>
00720         <span class="comment">//</span>
00721 
00722         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive -= 1;
00723 
00724         <span class="comment">//</span>
00725         <span class="comment">//  If the resource is now available and there is a waiting</span>
00726         <span class="comment">//  exclusive user then give the resource to the waiting thread</span>
00727         <span class="comment">//</span>
00728 
00729         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive == 0) &amp;&amp;
00730             (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingExclusive &gt; 0)) {
00731 
00732             <span class="comment">//</span>
00733             <span class="comment">//  Set the resource state to exclusive (but not owned),</span>
00734             <span class="comment">//  decrement the number of waiting exclusive, and release</span>
00735             <span class="comment">//  one exclusive waiter</span>
00736             <span class="comment">//</span>
00737 
00738             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive = -1;
00739             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveOwnerThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00740 
00741             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingExclusive -= 1;
00742 
00743             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d6/semphore_8c.html#a7">NtReleaseSemaphore</a>(
00744                          <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveSemaphore,
00745                          1,
00746                          &amp;PreviousCount
00747                          );
00748             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00749                 <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00750                 }
00751         }
00752 
00753     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive &lt; 0) {
00754 
00755         <span class="comment">//</span>
00756         <span class="comment">//  Releasing exclusive access to the resource, so increment the</span>
00757         <span class="comment">//  number of active by one.  And continue testing only</span>
00758         <span class="comment">//  if the resource is now available.</span>
00759         <span class="comment">//</span>
00760 
00761         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive += 1;
00762 
00763         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive == 0) {
00764 
00765             <span class="comment">//</span>
00766             <span class="comment">//  The resource is now available.  Remove ourselves as the</span>
00767             <span class="comment">//  owner thread</span>
00768             <span class="comment">//</span>
00769 
00770             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveOwnerThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00771 
00772             <span class="comment">//</span>
00773             <span class="comment">//  If there is another waiting exclusive then give the resource</span>
00774             <span class="comment">//  to it.</span>
00775             <span class="comment">//</span>
00776 
00777             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingExclusive &gt; 0) {
00778 
00779                 <span class="comment">//</span>
00780                 <span class="comment">//  Set the resource to exclusive, and its owner undefined.</span>
00781                 <span class="comment">//  Decrement the number of waiting exclusive and release one</span>
00782                 <span class="comment">//  exclusive waiter</span>
00783                 <span class="comment">//</span>
00784 
00785                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive = -1;
00786                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingExclusive -= 1;
00787 
00788                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d6/semphore_8c.html#a7">NtReleaseSemaphore</a>(
00789                              <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveSemaphore,
00790                              1,
00791                              &amp;PreviousCount
00792                              );
00793                 <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00794                     <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00795                     }
00796 
00797             <span class="comment">//</span>
00798             <span class="comment">//  Check to see if there are waiting shared, who should now get</span>
00799             <span class="comment">//  the resource</span>
00800             <span class="comment">//</span>
00801 
00802             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingShared &gt; 0) {
00803 
00804                 <span class="comment">//</span>
00805                 <span class="comment">//  Set the new state to indicate that all of the shared</span>
00806                 <span class="comment">//  requesters have access and there are no more waiting</span>
00807                 <span class="comment">//  shared requesters, and then release all of the shared</span>
00808                 <span class="comment">//  requsters</span>
00809                 <span class="comment">//</span>
00810 
00811                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingShared;
00812 
00813                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingShared = 0;
00814 
00815                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d6/semphore_8c.html#a7">NtReleaseSemaphore</a>(
00816                              <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;SharedSemaphore,
00817                              <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive,
00818                              &amp;PreviousCount
00819                              );
00820                 <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00821                     <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00822                     }
00823             }
00824         }
00825 
00826 <span class="preprocessor">#if DBG</span>
00827 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
00828 
00829         <span class="comment">//</span>
00830         <span class="comment">//  The resource isn't current acquired, there is nothing to release</span>
00831         <span class="comment">//  so tell the user the mistake</span>
00832         <span class="comment">//</span>
00833 
00834 
00835         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"NTDLL - Resource released too many times %lx\n"</span>, <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>);
00836         DbgBreakPoint();
00837 <span class="preprocessor">#endif</span>
00838 <span class="preprocessor"></span>    }
00839 
00840     <span class="comment">//</span>
00841     <span class="comment">//  Exit the critical section, and return to the caller</span>
00842     <span class="comment">//</span>
00843 
00844     RtlLeaveCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
00845 
00846     <span class="keywordflow">return</span>;
00847 }
00848 
00849 
00850 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00851"></a><a class="code" href="../../d7/d8/dll_2resource_8c.html#a21">00851</a> <a class="code" href="../../d7/d8/dll_2resource_8c.html#a21">RtlConvertSharedToExclusive</a>(
00852     IN PRTL_RESOURCE Resource
00853     )
00854 
00855 <span class="comment">/*++</span>
00856 <span class="comment"></span>
00857 <span class="comment">Routine Description:</span>
00858 <span class="comment"></span>
00859 <span class="comment">    This routine converts a resource acquired for shared access into</span>
00860 <span class="comment">    one acquired for exclusive access.  Upon return from the procedure</span>
00861 <span class="comment">    the resource is acquired for exclusive access</span>
00862 <span class="comment"></span>
00863 <span class="comment">Arguments:</span>
00864 <span class="comment"></span>
00865 <span class="comment">    Resource - Supplies the resource to acquire for shared access, it</span>
00866 <span class="comment">        must already be acquired for shared access</span>
00867 <span class="comment"></span>
00868 <span class="comment">Return Value:</span>
00869 <span class="comment"></span>
00870 <span class="comment">    None</span>
00871 <span class="comment"></span>
00872 <span class="comment">--*/</span>
00873 
00874 {
00875     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00876     ULONG TimeoutCount = 0;
00877 
00878     <span class="comment">//</span>
00879     <span class="comment">//  Enter the critical section</span>
00880     <span class="comment">//</span>
00881 
00882     RtlEnterCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
00883 
00884     <span class="comment">//</span>
00885     <span class="comment">//  If there is only one shared user (it's us) and we can acquire the</span>
00886     <span class="comment">//  resource for exclusive access.</span>
00887     <span class="comment">//</span>
00888 
00889     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive == 1) {
00890 
00891         <span class="comment">//</span>
00892         <span class="comment">//  The resource is ours, so indicate that we have it and</span>
00893         <span class="comment">//  exit the critical section, and return</span>
00894         <span class="comment">//</span>
00895 
00896         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive = -1;
00897 
00898         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveOwnerThread = NtCurrentTeb()-&gt;ClientId.UniqueThread;
00899 
00900         RtlLeaveCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
00901 
00902         <span class="keywordflow">return</span>;
00903     }
00904 
00905     <span class="comment">//</span>
00906     <span class="comment">//  If the resource is currently acquired exclusive and it's us then</span>
00907     <span class="comment">//  we already have exclusive access</span>
00908     <span class="comment">//</span>
00909 
00910     <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive &lt; 0) &amp;&amp;
00911         (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveOwnerThread == NtCurrentTeb()-&gt;ClientId.UniqueThread)) {
00912 
00913         <span class="comment">//</span>
00914         <span class="comment">//  We already have exclusive access to the resource so we'll just</span>
00915         <span class="comment">//  exit the critical section and return</span>
00916         <span class="comment">//</span>
00917 
00918         RtlLeaveCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
00919 
00920         <span class="keywordflow">return</span>;
00921     }
00922 
00923     <span class="comment">//</span>
00924     <span class="comment">//  If the resource is acquired by more than one shared then we need</span>
00925     <span class="comment">//  to wait to get exclusive access to the resource</span>
00926     <span class="comment">//</span>
00927 
00928     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive &gt; 1) {
00929 
00930         <span class="comment">//</span>
00931         <span class="comment">//  To wait we will decrement the fact that we have the resource for</span>
00932         <span class="comment">//  shared, and then loop waiting on the exclusive lock, and then</span>
00933         <span class="comment">//  testing to see if we can get exclusive access to the resource</span>
00934         <span class="comment">//</span>
00935 
00936         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive -= 1;
00937 
00938         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00939 
00940             <span class="comment">//</span>
00941             <span class="comment">//  Increment the number of waiting exclusive, exit and critical</span>
00942             <span class="comment">//  section and wait on the exclusive semaphore</span>
00943             <span class="comment">//</span>
00944 
00945             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingExclusive += 1;
00946             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;DebugInfo-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o7">ContentionCount</a>++;
00947 
00948             RtlLeaveCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
00949 rewait:
00950         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>(
00951                     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveSemaphore,
00952                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00953                     &amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a32">RtlpTimeout</a>
00954                     );
00955         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_TIMEOUT ) {
00956             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"RTL: Convert Exclusive Sem Timeout %d (2 minutes)\n"</span>,TimeoutCount);
00957             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"RTL: Resource at %p\n"</span>,<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>);
00958             TimeoutCount++;
00959             <span class="keywordflow">if</span> ( TimeoutCount &gt; 2 ) {
00960                 PIMAGE_NT_HEADERS NtHeaders;
00961 
00962                 <span class="comment">//</span>
00963                 <span class="comment">// If the image is a Win32 image, then raise an exception and try to get to the</span>
00964                 <span class="comment">// uae popup</span>
00965                 <span class="comment">//</span>
00966 
00967                 NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(NtCurrentPeb()-&gt;ImageBaseAddress);
00968 
00969                 <span class="keywordflow">if</span> (NtHeaders-&gt;OptionalHeader.Subsystem == IMAGE_SUBSYSTEM_WINDOWS_CUI ||
00970                     NtHeaders-&gt;OptionalHeader.Subsystem == IMAGE_SUBSYSTEM_WINDOWS_GUI) {
00971                     EXCEPTION_RECORD ExceptionRecord;
00972 
00973                     ExceptionRecord.ExceptionCode = STATUS_POSSIBLE_DEADLOCK;
00974                     ExceptionRecord.ExceptionFlags = 0;
00975                     ExceptionRecord.ExceptionRecord = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00976                     ExceptionRecord.ExceptionAddress = (PVOID)<a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a17">RtlRaiseException</a>;
00977                     ExceptionRecord.NumberParameters = 1;
00978                     ExceptionRecord.ExceptionInformation[0] = (ULONG_PTR)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>;
00979                     <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a9">RtlRaiseException</a>(&amp;ExceptionRecord);
00980                     }
00981                 <span class="keywordflow">else</span> {
00982                     DbgBreakPoint();
00983                     }
00984                 }
00985             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"RTL: Re-Waiting\n"</span>);
00986             <span class="keywordflow">goto</span> rewait;
00987         }
00988             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00989                 <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00990                 }
00991 
00992             <span class="comment">//</span>
00993             <span class="comment">//  Enter the critical section</span>
00994             <span class="comment">//</span>
00995 
00996             RtlEnterCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
00997 
00998             <span class="comment">//</span>
00999             <span class="comment">//  If there are no shared users and it is not currently acquired</span>
01000             <span class="comment">//  for exclusive use then we can acquire the resource for</span>
01001             <span class="comment">//  exclusive access.  We can also acquire it if the resource</span>
01002             <span class="comment">//  indicates exclusive access but there isn't currently an owner</span>
01003             <span class="comment">//</span>
01004 
01005             <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive == 0)
01006 
01007                     ||
01008 
01009                 ((<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive == -1) &amp;&amp;
01010                  (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveOwnerThread == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))) {
01011 
01012                 <span class="comment">//</span>
01013                 <span class="comment">//  The resource is ours, so indicate that we have it and</span>
01014                 <span class="comment">//  exit the critical section and return.</span>
01015                 <span class="comment">//</span>
01016 
01017                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive = -1;
01018 
01019                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveOwnerThread = NtCurrentTeb()-&gt;ClientId.UniqueThread;
01020 
01021                 RtlLeaveCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
01022 
01023                 <span class="keywordflow">return</span>;
01024             }
01025 
01026             <span class="comment">//</span>
01027             <span class="comment">//  Otherwise check to see if we already have exclusive access to</span>
01028             <span class="comment">//  the resource and can simply recusively acquire it again.</span>
01029             <span class="comment">//</span>
01030 
01031             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveOwnerThread == NtCurrentTeb()-&gt;ClientId.UniqueThread) {
01032 
01033                 <span class="comment">//</span>
01034                 <span class="comment">//  The resource is ours (recusively) so indicate that we have</span>
01035                 <span class="comment">//  it and exit the critical section and return.</span>
01036                 <span class="comment">//</span>
01037 
01038                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive -= 1;
01039 
01040                 RtlLeaveCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
01041 
01042                 <span class="keywordflow">return</span>;
01043             }
01044         }
01045 
01046     }
01047 
01048     <span class="comment">//</span>
01049     <span class="comment">//  The resource is not currently acquired for shared so this is a</span>
01050     <span class="comment">//  spurious call</span>
01051     <span class="comment">//</span>
01052 
01053 <span class="preprocessor">#if DBG</span>
01054 <span class="preprocessor"></span>    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"NTDLL:  Failed error - SHARED_RESOURCE_CONV_ERROR\n"</span>);
01055     DbgBreakPoint();
01056 <span class="preprocessor">#endif</span>
01057 <span class="preprocessor"></span>}
01058 
01059 
01060 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01061"></a><a class="code" href="../../d7/d8/dll_2resource_8c.html#a22">01061</a> <a class="code" href="../../d7/d8/dll_2resource_8c.html#a22">RtlConvertExclusiveToShared</a>(
01062     IN PRTL_RESOURCE Resource
01063     )
01064 
01065 <span class="comment">/*++</span>
01066 <span class="comment"></span>
01067 <span class="comment">Routine Description:</span>
01068 <span class="comment"></span>
01069 <span class="comment">    This routine converts a resource acquired for exclusive access into</span>
01070 <span class="comment">    one acquired for shared access.  Upon return from the procedure</span>
01071 <span class="comment">    the resource is acquired for shared access</span>
01072 <span class="comment"></span>
01073 <span class="comment">Arguments:</span>
01074 <span class="comment"></span>
01075 <span class="comment">    Resource - Supplies the resource to acquire for shared access, it</span>
01076 <span class="comment">        must already be acquired for exclusive access</span>
01077 <span class="comment"></span>
01078 <span class="comment">Return Value:</span>
01079 <span class="comment"></span>
01080 <span class="comment">    None</span>
01081 <span class="comment"></span>
01082 <span class="comment">--*/</span>
01083 
01084 {
01085     LONG PreviousCount;
01086     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01087 
01088     <span class="comment">//</span>
01089     <span class="comment">//  Enter the critical section</span>
01090     <span class="comment">//</span>
01091 
01092     RtlEnterCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
01093 
01094     <span class="comment">//</span>
01095     <span class="comment">//  If there is only one shared user (it's us) and we can acquire the</span>
01096     <span class="comment">//  resource for exclusive access.</span>
01097     <span class="comment">//</span>
01098 
01099     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive == -1) {
01100 
01101         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveOwnerThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01102 
01103         <span class="comment">//</span>
01104         <span class="comment">//  Check to see if there are waiting shared, who should now get the</span>
01105         <span class="comment">//  resource along with us</span>
01106         <span class="comment">//</span>
01107 
01108         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingShared &gt; 0) {
01109 
01110             <span class="comment">//</span>
01111             <span class="comment">//  Set the new state to indicate that all of the shared requesters</span>
01112             <span class="comment">//  have access including us, and there are no more waiting shared</span>
01113             <span class="comment">//  requesters, and then release all of the shared requsters</span>
01114             <span class="comment">//</span>
01115 
01116             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingShared + 1;
01117 
01118             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingShared = 0;
01119 
01120             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d6/semphore_8c.html#a7">NtReleaseSemaphore</a>(
01121                          <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;SharedSemaphore,
01122                          <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive - 1,
01123                          &amp;PreviousCount
01124                          );
01125             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
01126                 <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01127                 }
01128 
01129         } <span class="keywordflow">else</span> {
01130 
01131             <span class="comment">//</span>
01132             <span class="comment">//  There is no one waiting for shared access so it's only ours</span>
01133             <span class="comment">//</span>
01134 
01135             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive = 1;
01136 
01137         }
01138 
01139         RtlLeaveCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
01140 
01141         <span class="keywordflow">return</span>;
01142 
01143     }
01144 
01145     <span class="comment">//</span>
01146     <span class="comment">//  The resource is not currently acquired for exclusive, or we've</span>
01147     <span class="comment">//  recursively acquired it, so this must be a spurious call</span>
01148     <span class="comment">//</span>
01149 
01150 <span class="preprocessor">#if DBG</span>
01151 <span class="preprocessor"></span>    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"NTDLL:  Failed error - SHARED_RESOURCE_CONV_ERROR\n"</span>);
01152     DbgBreakPoint();
01153 <span class="preprocessor">#endif</span>
01154 <span class="preprocessor"></span>}
01155 
01156 
01157 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01158"></a><a class="code" href="../../d7/d8/dll_2resource_8c.html#a23">01158</a> <a class="code" href="../../d7/d8/dll_2resource_8c.html#a23">RtlDeleteResource</a> (
01159     IN PRTL_RESOURCE Resource
01160     )
01161 
01162 <span class="comment">/*++</span>
01163 <span class="comment"></span>
01164 <span class="comment">Routine Description:</span>
01165 <span class="comment"></span>
01166 <span class="comment">    This routine deletes (i.e., uninitializes) the input resource variable</span>
01167 <span class="comment"></span>
01168 <span class="comment"></span>
01169 <span class="comment">Arguments:</span>
01170 <span class="comment"></span>
01171 <span class="comment">    Resource - Supplies the resource variable being deleted</span>
01172 <span class="comment"></span>
01173 <span class="comment">Return Value:</span>
01174 <span class="comment"></span>
01175 <span class="comment">    None</span>
01176 <span class="comment"></span>
01177 <span class="comment">--*/</span>
01178 
01179 {
01180     <a class="code" href="../../d7/d8/dll_2resource_8c.html#a29">RtlDeleteCriticalSection</a>( &amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection );
01181     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;SharedSemaphore);
01182     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveSemaphore);
01183 
01184     <a class="code" href="../../d7/d8/dll_2resource_8c.html#a14">RtlpFreeDebugInfo</a>( <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;DebugInfo );
01185     RtlZeroMemory( <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>, <span class="keyword">sizeof</span>( *<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> ) );
01186 
01187     <span class="keywordflow">return</span>;
01188 }
01189 
01190 
01191 
01192 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01193"></a><a class="code" href="../../d7/d8/dll_2resource_8c.html#a10">01193</a> <a class="code" href="../../d7/d8/dll_2resource_8c.html#a10">RtlDumpResource</a>(
01194     IN PRTL_RESOURCE Resource
01195     )
01196 
01197 {
01198     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Resource @ %lx\n"</span>, <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>);
01199 
01200     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">" NumberOfWaitingShared = %lx\n"</span>, <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingShared);
01201     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">" NumberOfWaitingExclusive = %lx\n"</span>, <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingExclusive);
01202 
01203     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">" NumberOfActive = %lx\n"</span>, <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive);
01204 
01205     <span class="keywordflow">return</span>;
01206 }
01207 
01208 
01209 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01210"></a><a class="code" href="../../d7/d8/dll_2resource_8c.html#a24">01210</a> <a class="code" href="../../d7/d8/dll_2resource_8c.html#a24">RtlInitializeCriticalSection</a>(
01211     IN PRTL_CRITICAL_SECTION CriticalSection
01212     )
01213 
01214 <span class="comment">/*++</span>
01215 <span class="comment"></span>
01216 <span class="comment">Routine Description:</span>
01217 <span class="comment"></span>
01218 <span class="comment">    This routine initializes the input critial section variable</span>
01219 <span class="comment"></span>
01220 <span class="comment">Arguments:</span>
01221 <span class="comment"></span>
01222 <span class="comment">    CriticalSection - Supplies the resource variable being initialized</span>
01223 <span class="comment"></span>
01224 <span class="comment">Return Value:</span>
01225 <span class="comment"></span>
01226 <span class="comment">    TBD - Status of semaphore creation.</span>
01227 <span class="comment"></span>
01228 <span class="comment">--*/</span>
01229 
01230 {
01231     <span class="keywordflow">return</span> <a class="code" href="../../d7/d8/dll_2resource_8c.html#a26">RtlInitializeCriticalSectionAndSpinCount</a>(CriticalSection,0);
01232 }
01233 
01234 
01235 
<a name="l01236"></a><a class="code" href="../../d7/d8/dll_2resource_8c.html#a2">01236</a> <span class="preprocessor">#define MAX_SPIN_COUNT          0x00ffffff</span>
<a name="l01237"></a><a class="code" href="../../d7/d8/dll_2resource_8c.html#a3">01237</a> <span class="preprocessor"></span><span class="preprocessor">#define PREALLOCATE_EVENT_MASK  0x80000000</span>
01238 <span class="preprocessor"></span>
01239 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01240"></a><a class="code" href="../../d7/d8/dll_2resource_8c.html#a25">01240</a> <a class="code" href="../../d7/d8/dll_2resource_8c.html#a25">RtlEnableEarlyCriticalSectionEventCreation</a>(
01241     VOID
01242     )
01243 <span class="comment">/*++</span>
01244 <span class="comment"></span>
01245 <span class="comment">Routine Description:</span>
01246 <span class="comment"></span>
01247 <span class="comment">    This routine marks the PEB of the calling process so critical section events</span>
01248 <span class="comment">    are created at critical section creation time rather than at contetion time.</span>
01249 <span class="comment">    This allows critical processes not to have to worry about error paths later</span>
01250 <span class="comment">    on at the expense of extra pool consumed.</span>
01251 <span class="comment"></span>
01252 <span class="comment">Arguments:</span>
01253 <span class="comment"></span>
01254 <span class="comment">    None</span>
01255 <span class="comment"></span>
01256 <span class="comment">Return Value:</span>
01257 <span class="comment"></span>
01258 <span class="comment">    None</span>
01259 <span class="comment"></span>
01260 <span class="comment">--*/</span>
01261 {
01262     NtCurrentPeb ()-&gt;NtGlobalFlag |= FLG_CRITSEC_EVENT_CREATION;
01263 }
01264 
01265 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01266"></a><a class="code" href="../../d7/d8/dll_2resource_8c.html#a26">01266</a> <a class="code" href="../../d7/d8/dll_2resource_8c.html#a26">RtlInitializeCriticalSectionAndSpinCount</a>(
01267     IN PRTL_CRITICAL_SECTION CriticalSection,
01268     ULONG SpinCount
01269     )
01270 
01271 <span class="comment">/*++</span>
01272 <span class="comment"></span>
01273 <span class="comment">Routine Description:</span>
01274 <span class="comment"></span>
01275 <span class="comment">    This routine initializes the input critial section variable</span>
01276 <span class="comment"></span>
01277 <span class="comment">Arguments:</span>
01278 <span class="comment"></span>
01279 <span class="comment">    CriticalSection - Supplies the resource variable being initialized</span>
01280 <span class="comment"></span>
01281 <span class="comment">Return Value:</span>
01282 <span class="comment"></span>
01283 <span class="comment">    TBD - Status of semaphore creation.</span>
01284 <span class="comment"></span>
01285 <span class="comment">--*/</span>
01286 
01287 {
01288     PRTL_CRITICAL_SECTION_DEBUG DebugInfo;
01289     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01290 
01291     <span class="comment">//</span>
01292     <span class="comment">//  Initialize the lock fields, the count indicates how many are waiting</span>
01293     <span class="comment">//  to enter or are in the critical section, LockSemaphore is the object</span>
01294     <span class="comment">//  to wait on when entering the critical section.  SpinLock is used</span>
01295     <span class="comment">//  for the add interlock instruction. Recursion count is the number of</span>
01296     <span class="comment">//  times the critical section has been recursively entered.</span>
01297     <span class="comment">//</span>
01298 
01299     CriticalSection-&gt;LockCount = -1;
01300     CriticalSection-&gt;RecursionCount = 0;
01301     CriticalSection-&gt;OwningThread = 0;
01302     CriticalSection-&gt;LockSemaphore = 0;
01303     <span class="keywordflow">if</span> ( NtCurrentPeb()-&gt;NumberOfProcessors &gt; 1 ) {
01304         CriticalSection-&gt;SpinCount = SpinCount &amp; <a class="code" href="../../d7/d8/dll_2resource_8c.html#a2">MAX_SPIN_COUNT</a>;
01305         }
01306     <span class="keywordflow">else</span> {
01307         CriticalSection-&gt;SpinCount = 0;
01308         }
01309 
01310     <span class="keywordflow">if</span> ( ( SpinCount &amp; <a class="code" href="../../d7/d8/dll_2resource_8c.html#a3">PREALLOCATE_EVENT_MASK</a> ) ||
01311          ( NtCurrentPeb ()-&gt;NtGlobalFlag &amp; FLG_CRITSEC_EVENT_CREATION ) ) {
01312         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/ex_2event_8c.html#a5">NtCreateEvent</a>(
01313                     &amp;CriticalSection-&gt;LockSemaphore,
01314                     <a class="code" href="../../d7/d8/dll_2resource_8c.html#a0">DESIRED_EVENT_ACCESS</a>,
01315                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01316                     SynchronizationEvent,
01317                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01318                     );
01319         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
01320             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01321             }
01322 <span class="preprocessor">#if DBG</span>
01323 <span class="preprocessor"></span>        <a class="code" href="../../d4/d1/userk_8h.html#a966">ProtectHandle</a>(CriticalSection-&gt;LockSemaphore);
01324 <span class="preprocessor">#endif // DBG</span>
01325 <span class="preprocessor"></span>        }
01326 
01327     <span class="comment">//</span>
01328     <span class="comment">// Initialize debugging information.</span>
01329     <span class="comment">//</span>
01330 
01331     DebugInfo = (PRTL_CRITICAL_SECTION_DEBUG)<a class="code" href="../../d7/d8/dll_2resource_8c.html#a13">RtlpAllocateDebugInfo</a>();
01332     <span class="keywordflow">if</span> (DebugInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01333         <span class="keywordflow">if</span> (CriticalSection-&gt;LockSemaphore) {
01334 <span class="preprocessor">#if DBG</span>
01335 <span class="preprocessor"></span>            <a class="code" href="../../d8/d5/consrv_8h.html#a77">UnProtectHandle</a>( CriticalSection-&gt;LockSemaphore );
01336 <span class="preprocessor">#endif // DBG</span>
01337 <span class="preprocessor"></span>            <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( CriticalSection-&gt;LockSemaphore );
01338             CriticalSection-&gt;LockSemaphore = 0;
01339             }
01340         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01341     }
01342 
01343     DebugInfo-&gt;Type = RTL_CRITSECT_TYPE;
01344     DebugInfo-&gt;ContentionCount = 0;
01345     DebugInfo-&gt;EntryCount = 0;
01346 
01347     <span class="comment">//</span>
01348     <span class="comment">// If the critical section lock itself is not being initialized, then</span>
01349     <span class="comment">// synchronize the insert of the critical section in the process locks</span>
01350     <span class="comment">// list. Otherwise, insert the critical section with no synchronization.</span>
01351     <span class="comment">//</span>
01352 
01353     <span class="keywordflow">if</span> ((CriticalSection != &amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a35">RtlCriticalSectionLock</a>) &amp;&amp;
01354          (<a class="code" href="../../d7/d8/dll_2resource_8c.html#a9">RtlpCritSectInitialized</a> != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
01355         RtlEnterCriticalSection(&amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a35">RtlCriticalSectionLock</a>);
01356         InsertTailList(&amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a34">RtlCriticalSectionList</a>, &amp;DebugInfo-&gt;ProcessLocksList);
01357         RtlLeaveCriticalSection(&amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a35">RtlCriticalSectionLock</a> );
01358 
01359     } <span class="keywordflow">else</span> {
01360         InsertTailList(&amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a34">RtlCriticalSectionList</a>, &amp;DebugInfo-&gt;ProcessLocksList);
01361     }
01362 
01363     DebugInfo-&gt;CriticalSection = CriticalSection;
01364     CriticalSection-&gt;DebugInfo = DebugInfo;
01365 <span class="preprocessor">#if i386</span>
01366 <span class="preprocessor"></span>    DebugInfo-&gt;CreatorBackTraceIndex = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)RtlLogStackBackTrace();
01367 <span class="preprocessor">#endif // i386</span>
01368 <span class="preprocessor"></span>
01369     <span class="keywordflow">return</span> STATUS_SUCCESS;
01370 }
01371 
01372 
01373 ULONG
<a name="l01374"></a><a class="code" href="../../d7/d8/dll_2resource_8c.html#a27">01374</a> <a class="code" href="../../d7/d8/dll_2resource_8c.html#a27">RtlSetCriticalSectionSpinCount</a>(
01375     IN PRTL_CRITICAL_SECTION CriticalSection,
01376     ULONG SpinCount
01377     )
01378 
01379 <span class="comment">/*++</span>
01380 <span class="comment"></span>
01381 <span class="comment">Routine Description:</span>
01382 <span class="comment"></span>
01383 <span class="comment">    This routine initializes the input critial section variable</span>
01384 <span class="comment"></span>
01385 <span class="comment">Arguments:</span>
01386 <span class="comment"></span>
01387 <span class="comment">    CriticalSection - Supplies the resource variable being initialized</span>
01388 <span class="comment"></span>
01389 <span class="comment">Return Value:</span>
01390 <span class="comment"></span>
01391 <span class="comment">    Returns the previous critical section spin count</span>
01392 <span class="comment"></span>
01393 <span class="comment">--*/</span>
01394 
01395 {
01396     ULONG OldSpinCount;
01397 
01398     OldSpinCount = (ULONG)CriticalSection-&gt;SpinCount;
01399 
01400     <span class="keywordflow">if</span> ( NtCurrentPeb()-&gt;NumberOfProcessors &gt; 1 ) {
01401         CriticalSection-&gt;SpinCount = SpinCount;
01402         }
01403     <span class="keywordflow">else</span> {
01404         CriticalSection-&gt;SpinCount = 0;
01405         }
01406 
01407     <span class="keywordflow">return</span> OldSpinCount;
01408 }
01409 
01410 
01411 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01412"></a><a class="code" href="../../d7/d8/dll_2resource_8c.html#a15">01412</a> <a class="code" href="../../d7/d8/dll_2resource_8c.html#a15">RtlpCreateCriticalSectionSem</a>(
01413     IN PRTL_CRITICAL_SECTION CriticalSection
01414     )
01415 {
01416     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01417     LARGE_INTEGER tmo = {(ULONG)   -100000, -1};         <span class="comment">// Start at 1/100th of a second</span>
01418     LONGLONG max_tmo  = (LONGLONG) -10000000 * 60 * 3; <span class="comment">// Wait for a max of 3 minutes</span>
01419 
01420     <span class="comment">//</span>
01421     <span class="comment">// Loop trying to create the event on failure.</span>
01422     <span class="comment">//</span>
01423     <span class="keywordflow">while</span> (1) {
01424         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/ex_2event_8c.html#a5">NtCreateEvent</a>(
01425                     &amp;CriticalSection-&gt;LockSemaphore,
01426                     <a class="code" href="../../d7/d8/dll_2resource_8c.html#a0">DESIRED_EVENT_ACCESS</a>,
01427                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01428                     SynchronizationEvent,
01429                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01430                 );
01431 
01432         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
01433            <span class="keywordflow">break</span>;
01434         } <span class="keywordflow">else</span> { 
01435             <span class="keywordflow">if</span> ( tmo.QuadPart &lt; max_tmo ) {
01436                 KdPrint(( <span class="stringliteral">"NTDLL: Warning. Unable to allocate lock semaphore for Cs %p. Status %x raising\n"</span>, CriticalSection,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ));
01437                 InterlockedDecrement(&amp;CriticalSection-&gt;LockCount);
01438                 <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01439             }
01440             KdPrint(( <span class="stringliteral">"NTDLL: Warning. Unable to allocate lock semaphore for Cs %p. Status %x retrying\n"</span>, CriticalSection,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ));
01441 
01442             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d6/delay_8c.html#a0">NtDelayExecution</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;tmo);
01443             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
01444                 InterlockedDecrement(&amp;CriticalSection-&gt;LockCount);
01445                 <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01446             }
01447             tmo.QuadPart *= 2;
01448         }
01449     }
01450 <span class="preprocessor">#if DBG</span>
01451 <span class="preprocessor"></span>    <a class="code" href="../../d4/d1/userk_8h.html#a966">ProtectHandle</a>(CriticalSection-&gt;LockSemaphore);
01452 <span class="preprocessor">#endif // DBG</span>
01453 <span class="preprocessor"></span>}
01454 
01455 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01456"></a><a class="code" href="../../d7/d8/dll_2resource_8c.html#a28">01456</a> <a class="code" href="../../d7/d8/dll_2resource_8c.html#a28">RtlpCheckDeferedCriticalSection</a>(
01457     IN PRTL_CRITICAL_SECTION CriticalSection
01458     )
01459 {
01460     RtlEnterCriticalSection(&amp;<a class="code" href="../../d7/d8/dll_2resource_8c.html#a6">DeferedCriticalSection</a>);
01461     <span class="keywordflow">try</span> {
01462         <span class="keywordflow">if</span> ( !CriticalSection-&gt;LockSemaphore ) {
01463             <a class="code" href="../../d7/d8/dll_2resource_8c.html#a15">RtlpCreateCriticalSectionSem</a>(CriticalSection);
01464             }
01465         }
01466     finally {
01467         RtlLeaveCriticalSection(&amp;<a class="code" href="../../d7/d8/dll_2resource_8c.html#a6">DeferedCriticalSection</a>);
01468         }
01469     <span class="keywordflow">return</span>;
01470 }
01471 
01472 
01473 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01474"></a><a class="code" href="../../d7/d8/dll_2resource_8c.html#a29">01474</a> <a class="code" href="../../d7/d8/dll_2resource_8c.html#a29">RtlDeleteCriticalSection</a>(
01475     IN PRTL_CRITICAL_SECTION CriticalSection
01476     )
01477 
01478 <span class="comment">/*++</span>
01479 <span class="comment"></span>
01480 <span class="comment">Routine Description:</span>
01481 <span class="comment"></span>
01482 <span class="comment">    This routine deletes (i.e., uninitializes) the input critical</span>
01483 <span class="comment">    section variable</span>
01484 <span class="comment"></span>
01485 <span class="comment"></span>
01486 <span class="comment">Arguments:</span>
01487 <span class="comment"></span>
01488 <span class="comment">    CriticalSection - Supplies the resource variable being deleted</span>
01489 <span class="comment"></span>
01490 <span class="comment">Return Value:</span>
01491 <span class="comment"></span>
01492 <span class="comment">    TBD - Status of semaphore close.</span>
01493 <span class="comment"></span>
01494 <span class="comment">--*/</span>
01495 
01496 {
01497     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01498     PRTL_CRITICAL_SECTION_DEBUG DebugInfo;
01499 
01500     <span class="keywordflow">if</span> ( CriticalSection-&gt;LockSemaphore ) {
01501 <span class="preprocessor">#if DBG</span>
01502 <span class="preprocessor"></span>        <a class="code" href="../../d8/d5/consrv_8h.html#a77">UnProtectHandle</a>( CriticalSection-&gt;LockSemaphore );
01503 <span class="preprocessor">#endif // DBG</span>
01504 <span class="preprocessor"></span>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( CriticalSection-&gt;LockSemaphore );
01505         }
01506     <span class="keywordflow">else</span> {
01507         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01508         }
01509 
01510     <span class="comment">//</span>
01511     <span class="comment">// Remove critical section from the list</span>
01512     <span class="comment">//</span>
01513 
01514     RtlEnterCriticalSection( &amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a35">RtlCriticalSectionLock</a> );
01515     <span class="keywordflow">try</span> {
01516         DebugInfo = CriticalSection-&gt;DebugInfo;
01517         <span class="keywordflow">if</span> (DebugInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01518             RemoveEntryList( &amp;DebugInfo-&gt;ProcessLocksList );
01519             RtlZeroMemory( DebugInfo, <span class="keyword">sizeof</span>( *DebugInfo ) );
01520             }
01521         }
01522     finally {
01523         RtlLeaveCriticalSection( &amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a35">RtlCriticalSectionLock</a> );
01524         }
01525     <span class="keywordflow">if</span> (DebugInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01526         <a class="code" href="../../d7/d8/dll_2resource_8c.html#a14">RtlpFreeDebugInfo</a>( DebugInfo );
01527         }
01528     RtlZeroMemory( CriticalSection,
01529                    FIELD_OFFSET(RTL_CRITICAL_SECTION, SpinCount) + <span class="keyword">sizeof</span>(ULONG) );
01530 
01531     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01532 }
01533 
01534 
01535 
01536 <span class="comment">//</span>
01537 <span class="comment">// The following support routines are called from the machine language</span>
01538 <span class="comment">// implementations of RtlEnterCriticalSection and RtlLeaveCriticalSection</span>
01539 <span class="comment">// to execute the slow path logic of either waiting for a critical section</span>
01540 <span class="comment">// or releasing a critical section to a waiting thread.</span>
01541 <span class="comment">//</span>
01542 
01543 <span class="keywordtype">void</span>
<a name="l01544"></a><a class="code" href="../../d7/d8/dll_2resource_8c.html#a30">01544</a> <a class="code" href="../../d7/d8/dll_2resource_8c.html#a30">RtlpWaitForCriticalSection</a>(
01545     IN PRTL_CRITICAL_SECTION CriticalSection
01546     )
01547 {
01548     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
01549     ULONG TimeoutCount = 0;
01550     PLARGE_INTEGER TimeoutTime;
01551     BOOLEAN CsIsLoaderLock;
01552 
01553     <span class="comment">//</span>
01554     <span class="comment">// critical sections are disabled during exit process so that</span>
01555     <span class="comment">// apps that are not carefull during shutdown don't hang</span>
01556     <span class="comment">//</span>
01557 
01558     CsIsLoaderLock = (CriticalSection == NtCurrentPeb()-&gt;LoaderLock);
01559     NtCurrentTeb()-&gt;WaitingOnLoaderLock = (ULONG)CsIsLoaderLock;
01560 
01561     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a0">LdrpShutdownInProgress</a> &amp;&amp;
01562         ((!CsIsLoaderLock) ||
01563          (CsIsLoaderLock &amp;&amp; <a class="code" href="../../d9/d2/ldrp_8h.html#a47">LdrpShutdownThreadId</a> == NtCurrentTeb()-&gt;ClientId.UniqueThread) ) ) {
01564 
01565         <span class="comment">//</span>
01566         <span class="comment">// slimey reinitialization of the critical section with the count biased by one</span>
01567         <span class="comment">// this is how the critical section would normally look to the thread coming out</span>
01568         <span class="comment">// of this function. Note that the semaphore handle is leaked, but since the</span>
01569         <span class="comment">// app is exiting, it's ok</span>
01570         <span class="comment">//</span>
01571 
01572         CriticalSection-&gt;LockCount = 0;
01573         CriticalSection-&gt;RecursionCount = 0;
01574         CriticalSection-&gt;OwningThread = 0;
01575         CriticalSection-&gt;LockSemaphore = 0;
01576 
01577         NtCurrentTeb()-&gt;WaitingOnLoaderLock = 0;
01578 
01579         <span class="keywordflow">return</span>;
01580 
01581         }
01582 
01583     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a31">RtlpTimoutDisable</a>) {
01584         TimeoutTime = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01585         }
01586     <span class="keywordflow">else</span> {
01587         TimeoutTime = &amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a32">RtlpTimeout</a>;
01588         }
01589 
01590     <span class="keywordflow">if</span> ( !CriticalSection-&gt;LockSemaphore ) {
01591         <a class="code" href="../../d7/d8/dll_2resource_8c.html#a28">RtlpCheckDeferedCriticalSection</a>(CriticalSection);
01592         }
01593 
01594     CriticalSection-&gt;DebugInfo-&gt;EntryCount++;
01595     <span class="keywordflow">while</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ) {
01596 
01597         CriticalSection-&gt;DebugInfo-&gt;ContentionCount++;
01598 
01599 <span class="preprocessor">#if 0</span>
01600 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"NTDLL: Waiting for CritSect: %p  owned by ThreadId: %X  Count: %u  Level: %u\n"</span>,
01601                   CriticalSection,
01602                   CriticalSection-&gt;OwningThread,
01603                   CriticalSection-&gt;LockCount,
01604                   CriticalSection-&gt;RecursionCount
01605                 );
01606 <span class="preprocessor">#endif</span>
01607 <span class="preprocessor"></span>
01608         st = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>( CriticalSection-&gt;LockSemaphore,
01609                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01610                                     TimeoutTime
01611                                   );
01612         <span class="keywordflow">if</span> ( st == STATUS_TIMEOUT ) {
01613             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"RTL: Enter Critical Section Timeout (2 minutes) %d\n"</span>,
01614                       TimeoutCount
01615                     );
01616             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"RTL: Pid.Tid %x.%x, owner tid %x Critical Section %p - ContentionCount == %lu\n"</span>,
01617                     NtCurrentTeb()-&gt;ClientId.UniqueProcess,
01618                     NtCurrentTeb()-&gt;ClientId.UniqueThread,
01619                     CriticalSection-&gt;OwningThread,
01620                     CriticalSection, CriticalSection-&gt;DebugInfo-&gt;ContentionCount
01621                     );
01622             TimeoutCount++;
01623             <span class="keywordflow">if</span> ( TimeoutCount &gt; 2 &amp;&amp; CriticalSection != NtCurrentPeb()-&gt;LoaderLock ) {
01624                 PIMAGE_NT_HEADERS NtHeaders;
01625 
01626                 <span class="comment">//</span>
01627                 <span class="comment">// If the image is a Win32 image, then raise an exception and try to get to the</span>
01628                 <span class="comment">// uae popup</span>
01629                 <span class="comment">//</span>
01630 
01631                 NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(NtCurrentPeb()-&gt;ImageBaseAddress);
01632 
01633                 <span class="keywordflow">if</span> (NtHeaders-&gt;OptionalHeader.Subsystem == IMAGE_SUBSYSTEM_WINDOWS_CUI ||
01634                     NtHeaders-&gt;OptionalHeader.Subsystem == IMAGE_SUBSYSTEM_WINDOWS_GUI) {
01635                     EXCEPTION_RECORD ExceptionRecord;
01636 
01637                     ExceptionRecord.ExceptionCode = STATUS_POSSIBLE_DEADLOCK;
01638                     ExceptionRecord.ExceptionFlags = 0;
01639                     ExceptionRecord.ExceptionRecord = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01640                     ExceptionRecord.ExceptionAddress = (PVOID)<a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a17">RtlRaiseException</a>;
01641                     ExceptionRecord.NumberParameters = 1;
01642                     ExceptionRecord.ExceptionInformation[0] = (ULONG_PTR)CriticalSection;
01643                     <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a9">RtlRaiseException</a>(&amp;ExceptionRecord);
01644                     }
01645                 <span class="keywordflow">else</span> {
01646                     DbgBreakPoint();
01647                     }
01648                 }
01649             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"RTL: Re-Waiting\n"</span>);
01650             }
01651         <span class="keywordflow">else</span> {
01652             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01653                 <span class="comment">//</span>
01654                 <span class="comment">// If some errant thread calls SetEvent on a bogus handle</span>
01655                 <span class="comment">// which happens to match the handle we are using in the critical</span>
01656                 <span class="comment">// section, everything gets really messed up since two threads</span>
01657                 <span class="comment">// now own the lock at the same time. ASSERT that no other thread</span>
01658                 <span class="comment">// owns the lock if we have been granted ownership.</span>
01659                 <span class="comment">//</span>
01660                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(CriticalSection-&gt;OwningThread == 0);
01661                 <span class="keywordflow">if</span> ( CsIsLoaderLock ) {
01662                     CriticalSection-&gt;OwningThread = NtCurrentTeb()-&gt;ClientId.UniqueThread;
01663                     NtCurrentTeb()-&gt;WaitingOnLoaderLock = 0;
01664                     }
01665                 <span class="keywordflow">return</span>;
01666                 }
01667             <span class="keywordflow">else</span> {
01668                 <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(st);
01669                 }
01670             }
01671     }
01672 }
01673 
01674 <span class="keywordtype">void</span>
<a name="l01675"></a><a class="code" href="../../d7/d8/dll_2resource_8c.html#a31">01675</a> <a class="code" href="../../d7/d8/dll_2resource_8c.html#a31">RtlpUnWaitCriticalSection</a>(
01676     IN PRTL_CRITICAL_SECTION CriticalSection
01677     )
01678 {
01679     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
01680 
01681 <span class="preprocessor">#if 0</span>
01682 <span class="preprocessor"></span>    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"NTDLL: Releasing CritSect: %p  ThreadId: %X\n"</span>,
01683               CriticalSection, CriticalSection-&gt;OwningThread
01684             );
01685 <span class="preprocessor">#endif</span>
01686 <span class="preprocessor"></span>
01687     <span class="keywordflow">if</span> ( !CriticalSection-&gt;LockSemaphore ) {
01688         <a class="code" href="../../d7/d8/dll_2resource_8c.html#a28">RtlpCheckDeferedCriticalSection</a>(CriticalSection);
01689         }
01690 
01691 <span class="preprocessor">#if DBG</span>
01692 <span class="preprocessor"></span>    <span class="comment">//</span>
01693     <span class="comment">// Sneaky trick here to catch sleazy apps (csrss) that erroneously call</span>
01694     <span class="comment">// NtSetEvent on an event that happens to be somebody else's</span>
01695     <span class="comment">// critical section. Only allow setting a protected handle if the low</span>
01696     <span class="comment">// bit of PreviousState is set.</span>
01697     <span class="comment">//</span>
01698     st = <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>( CriticalSection-&gt;LockSemaphore,
01699                      (PLONG)1
01700                      );
01701 <span class="preprocessor">#else</span>
01702 <span class="preprocessor"></span>    st = <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>( CriticalSection-&gt;LockSemaphore,
01703                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01704                      );
01705 <span class="preprocessor">#endif</span>
01706 <span class="preprocessor"></span>
01707     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01708         <span class="keywordflow">return</span>;
01709         }
01710     <span class="keywordflow">else</span> {
01711         <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(st);
01712         }
01713 }
01714 
01715 
01716 <span class="keywordtype">void</span>
<a name="l01717"></a><a class="code" href="../../d7/d8/dll_2resource_8c.html#a32">01717</a> <a class="code" href="../../d7/d8/dll_2resource_8c.html#a32">RtlpNotOwnerCriticalSection</a>(
01718     IN PRTL_CRITICAL_SECTION CriticalSection
01719     )
01720 {
01721     BOOLEAN CsIsLoaderLock;
01722 
01723     <span class="comment">//</span>
01724     <span class="comment">// critical sections are disabled during exit process so that</span>
01725     <span class="comment">// apps that are not carefull during shutdown don't hang</span>
01726     <span class="comment">//</span>
01727 
01728     CsIsLoaderLock = (CriticalSection == NtCurrentPeb()-&gt;LoaderLock);
01729 
01730     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a0">LdrpShutdownInProgress</a> &amp;&amp;
01731         ((!CsIsLoaderLock) ||
01732          (CsIsLoaderLock &amp;&amp; <a class="code" href="../../d9/d2/ldrp_8h.html#a47">LdrpShutdownThreadId</a> == NtCurrentTeb()-&gt;ClientId.UniqueThread) ) ) {
01733         <span class="keywordflow">return</span>;
01734         }
01735 
01736     <span class="keywordflow">if</span> (NtCurrentPeb()-&gt;BeingDebugged) {
01737         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"NTDLL: Calling thread (%X) not owner of CritSect: %p  Owner ThreadId: %X\n"</span>,
01738                   NtCurrentTeb()-&gt;ClientId.UniqueThread,
01739                   CriticalSection,
01740                   CriticalSection-&gt;OwningThread
01741                 );
01742 <span class="preprocessor">#if i386</span>
01743 <span class="preprocessor"></span>        _asm {  <span class="keywordtype">int</span> 3 }
01744 <span class="preprocessor">#else</span>
01745 <span class="preprocessor"></span>        DbgBreakPoint();
01746 <span class="preprocessor">#endif</span>
01747 <span class="preprocessor"></span>        }
01748     <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>( STATUS_RESOURCE_NOT_OWNED );
01749 }
01750 
01751 
01752 <span class="preprocessor">#if DBG</span>
01753 <span class="preprocessor"></span><span class="keywordtype">void</span>
01754 RtlpCriticalSectionIsOwned(
01755     IN PRTL_CRITICAL_SECTION CriticalSection
01756     )
01757 {
01758     <span class="comment">//</span>
01759     <span class="comment">// The loader lock gets handled differently, so don't assert on it</span>
01760     <span class="comment">//</span>
01761 
01762     <span class="keywordflow">if</span> ( CriticalSection == NtCurrentPeb()-&gt;LoaderLock &amp;&amp;
01763          CriticalSection-&gt;OwningThread == NtCurrentTeb()-&gt;ClientId.UniqueThread ) {
01764         <span class="keywordflow">return</span>;
01765         }
01766 
01767     <span class="comment">//</span>
01768     <span class="comment">// If we're being debugged, throw up a warning</span>
01769     <span class="comment">//</span>
01770 
01771     <span class="keywordflow">if</span> (NtCurrentPeb()-&gt;BeingDebugged) {
01772         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"NTDLL: Calling thread (%X) shouldn't enter CritSect: %p  Owner ThreadId: %X\n"</span>,
01773                   NtCurrentTeb()-&gt;ClientId.UniqueThread,
01774                   CriticalSection,
01775                   CriticalSection-&gt;OwningThread
01776                 );
01777 <span class="preprocessor">#if i386</span>
01778 <span class="preprocessor"></span>        _asm {  <span class="keywordtype">int</span> 3 }
01779 <span class="preprocessor">#else</span>
01780 <span class="preprocessor"></span>        DbgBreakPoint();
01781 <span class="preprocessor">#endif</span>
01782 <span class="preprocessor"></span>        }
01783 }
01784 <span class="preprocessor">#endif</span>
01785 <span class="preprocessor"></span>
01786 
01787 <span class="keywordtype">void</span>
<a name="l01788"></a><a class="code" href="../../d7/d8/dll_2resource_8c.html#a33">01788</a> <a class="code" href="../../d7/d8/dll_2resource_8c.html#a33">RtlCheckForOrphanedCriticalSections</a>(
01789     IN HANDLE hThread
01790     )
01791 <span class="comment">/*++</span>
01792 <span class="comment"></span>
01793 <span class="comment">Routine Description:</span>
01794 <span class="comment"></span>
01795 <span class="comment">    This routine is called from kernel32's ExitThread and TerminateThread</span>
01796 <span class="comment">    in an effort to track calls that kill threads while they own</span>
01797 <span class="comment">    critical sections.</span>
01798 <span class="comment"></span>
01799 <span class="comment">Arguments:</span>
01800 <span class="comment"></span>
01801 <span class="comment">    hThread     -- thread to be killed</span>
01802 <span class="comment"></span>
01803 <span class="comment">Return Value:</span>
01804 <span class="comment"></span>
01805 <span class="comment">    None.</span>
01806 <span class="comment"></span>
01807 <span class="comment">--*/</span>
01808 {
01809     <span class="comment">//</span>
01810     <span class="comment">// This whole routine should be called only on checked builds.</span>
01811     <span class="comment">// It is a stub in the free build, so that a checked kernel32.dll</span>
01812     <span class="comment">// can bind against a free ntdll.dll</span>
01813     <span class="comment">//</span>
01814 <span class="preprocessor">#if DBG</span>
01815 <span class="preprocessor"></span>    <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01816     THREAD_BASIC_INFORMATION ThreadInfo;
01817     PLIST_ENTRY Entry;
01818     PRTL_CRITICAL_SECTION_DEBUG DebugInfo;
01819     PRTL_CRITICAL_SECTION CriticalSection;
01820     BOOLEAN OrphanAboutToHappen;
01821     RTL_CRITICAL_SECTION CritSectCopy;
01822 
01823     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/ldrinit_8c.html#a0">LdrpShutdownInProgress</a>) {
01824         <span class="comment">//</span>
01825         <span class="comment">// In the middle of shutting down the process</span>
01826         <span class="comment">//</span>
01827         <span class="keywordflow">return</span>;
01828     }
01829 
01830     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/psquery_8c.html#a20">NtQueryInformationThread</a>(
01831                             hThread,
01832                             ThreadBasicInformation,
01833                             &amp;ThreadInfo,
01834                             <span class="keyword">sizeof</span>(ThreadInfo),
01835                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01836                             );
01837     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01838         <span class="keywordflow">return</span>;
01839     }
01840 
01841     OrphanAboutToHappen = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01842 
01843     RtlEnterCriticalSection( &amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a35">RtlCriticalSectionLock</a> );
01844 
01845     <span class="keywordflow">for</span> (Entry = <a class="code" href="../../d9/d2/ldrp_8h.html#a34">RtlCriticalSectionList</a>.Flink;
01846          Entry != &amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a34">RtlCriticalSectionList</a>;
01847          Entry = Entry-&gt;Flink) {
01848 
01849         DebugInfo = CONTAINING_RECORD(Entry,
01850                                       RTL_CRITICAL_SECTION_DEBUG,
01851                                       ProcessLocksList);
01852 
01853         CriticalSection = DebugInfo-&gt;CriticalSection;
01854 
01855         <span class="keywordflow">if</span> (CriticalSection == &amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a35">RtlCriticalSectionLock</a> ||
01856             CriticalSection == NtCurrentPeb()-&gt;LoaderLock) {
01857             <span class="comment">//</span>
01858             <span class="comment">// Skip these critsects.</span>
01859             <span class="comment">//</span>
01860             <span class="keywordflow">continue</span>;
01861         }
01862 
01863         <span class="comment">//</span>
01864         <span class="comment">// Call NtReadVirtualMemory() and make a copy of the critsect.</span>
01865         <span class="comment">// This won't AV and break to the debugger if the critsect's</span>
01866         <span class="comment">// memory has been freed without an RtlDeleteCriticalSection call.</span>
01867         <span class="comment">//</span>
01868         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a9">NtReadVirtualMemory</a>(NtCurrentProcess(),
01869                                      CriticalSection,
01870                                      &amp;CritSectCopy,
01871                                      <span class="keyword">sizeof</span>(CritSectCopy),
01872                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01873         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) || CritSectCopy.DebugInfo != DebugInfo) {
01874             <span class="comment">//</span>
01875             <span class="comment">// Error reading the contents of the critsect.  The critsect</span>
01876             <span class="comment">// has probably been decommitted without a call to</span>
01877             <span class="comment">// RtlDeleteCriticalSection.  Ignore it.</span>
01878             <span class="comment">//</span>
01879             <span class="comment">// You might think the entry could be deleted from the list,</span>
01880             <span class="comment">// but it can't... there may be another RTL_CRITICAL_SECTION</span>
01881             <span class="comment">// out there that is truly allocated, and who DebugInfo pointer</span>
01882             <span class="comment">// points at this DebugInfo.  In that case, when that critsect</span>
01883             <span class="comment">// is deleted, the RtlCriticalSectionList is corrupted.</span>
01884             <span class="comment">//</span>
01885         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CritSectCopy.OwningThread == ThreadInfo.ClientId.UniqueThread
01886                    &amp;&amp; CritSectCopy.LockCount != -1) {
01887             <span class="comment">//</span>
01888             <span class="comment">// The thread is about to die with a critical section locked.</span>
01889             <span class="comment">//</span>
01890             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"NTDLL:  Pid.Tid %x.%x Critsec %p about to be orphaned when owning thread is terminated.\n"</span>,
01891                      NtCurrentTeb()-&gt;ClientId.UniqueProcess,
01892                      NtCurrentTeb()-&gt;ClientId.UniqueThread,
01893                      CriticalSection);
01894             OrphanAboutToHappen = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01895         }
01896     }
01897 
01898     <span class="keywordflow">if</span> (OrphanAboutToHappen) {
01899 <span class="preprocessor">#if i386</span>
01900 <span class="preprocessor"></span>        _asm {  <span class="keywordtype">int</span> 3 }
01901 <span class="preprocessor">#else</span>
01902 <span class="preprocessor"></span>        DbgBreakPoint();
01903 <span class="preprocessor">#endif</span>
01904 <span class="preprocessor"></span>    }
01905 
01906     RtlLeaveCriticalSection( &amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a35">RtlCriticalSectionLock</a> );
01907 <span class="preprocessor">#endif</span>
01908 <span class="preprocessor"></span>}
01909 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:39 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
