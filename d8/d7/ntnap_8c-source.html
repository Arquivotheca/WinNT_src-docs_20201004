<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ntnap.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ntnap.c</h1><a href="../../d7/d8/ntnap_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    ntnap.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the routines for initializing and performing</span>
00012 <span class="comment">    profiling of NT API's.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Russ Blake (russbl) 22-Apr-1991</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include &lt;nt.h&gt;</span>
00023 <span class="preprocessor">#include &lt;ntrtl.h&gt;</span>
00024 <span class="preprocessor">#include &lt;nturtl.h&gt;</span>
00025 <span class="preprocessor">#include &lt;string.h&gt;</span>
00026 
00027 <span class="preprocessor">#include "ntnapdef.h"</span>
00028 <span class="preprocessor">#include "<a class="code" href="../../d8/d8/ntnap_8h.html">ntnap.h</a>"</span>
00029 
00030 <span class="comment">//</span>
00031 <span class="comment">// Initialization control: only want to initialize once; this</span>
00032 <span class="comment">// prevents multiple initializations before data segment and</span>
00033 <span class="comment">// global control are initialized.</span>
00034 <span class="comment">//</span>
00035 
<a name="l00036"></a><a class="code" href="../../d7/d8/ntnap_8c.html#a0">00036</a> BOOLEAN <a class="code" href="../../d7/d8/ntnap_8c.html#a0">NapInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00037 
00038 <span class="comment">//</span>
00039 <span class="comment">// Counter frequency constant</span>
00040 <span class="comment">//</span>
00041 
<a name="l00042"></a><a class="code" href="../../d7/d8/ntnap_8c.html#a1">00042</a> LARGE_INTEGER <a class="code" href="../../d7/d8/ntnap_8c.html#a1">NapFrequency</a>;
00043 
00044 <span class="comment">//</span>
00045 <span class="comment">// Profiling data structures</span>
00046 <span class="comment">//</span>
00047 
<a name="l00048"></a><a class="code" href="../../d7/d8/ntnap_8c.html#a2">00048</a> <a class="code" href="../../d4/d1/struct__NAPCONTROL.html">PNAPCONTROL</a> <a class="code" href="../../d7/d8/ntnap_8c.html#a2">NapControl</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00049 
00050 <span class="comment">//</span>
00051 <span class="comment">// The following array is indexed by Service Number + 1.  Service</span>
00052 <span class="comment">// Number -1 (element 0 of the following array) is reserved for</span>
00053 <span class="comment">// calibration.  Initialization of this to NULL kicks off the</span>
00054 <span class="comment">// NapDllInit sequence to create or open the data section.</span>
00055 <span class="comment">//</span>
00056 
<a name="l00057"></a><a class="code" href="../../d7/d8/ntnap_8c.html#a3">00057</a> PNAPDATA <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00058 
00059 
00060 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00061"></a><a class="code" href="../../d8/d8/ntnap_8h.html#a8">00061</a> <a class="code" href="../../d8/d8/ntnap_8h.html#a8">NapDllInit</a> (
00062     VOID
00063     )
00064 
00065 <span class="comment">/*++</span>
00066 <span class="comment"></span>
00067 <span class="comment">Routine Description:</span>
00068 <span class="comment"></span>
00069 <span class="comment">    NapDllInit() is called before calling any profiling api.  It</span>
00070 <span class="comment">    initializes profiling for the NT native API's.</span>
00071 <span class="comment"></span>
00072 <span class="comment">    NOTE:  Initialization occurs only once and is controlled by</span>
00073 <span class="comment">           the NapInitDone global flag.</span>
00074 <span class="comment"></span>
00075 <span class="comment">Arguments:</span>
00076 <span class="comment"></span>
00077 <span class="comment">    None</span>
00078 <span class="comment"></span>
00079 <span class="comment">Return Value:</span>
00080 <span class="comment"></span>
00081 <span class="comment">    None</span>
00082 <span class="comment"></span>
00083 <span class="comment">--*/</span>
00084 
00085 {
00086     ULONG i;
00087     LARGE_INTEGER CurrentCounter;
00088 
00089     <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d8/ntnap_8c.html#a0">NapInitialized</a>) {
00090 
00091         <span class="comment">//</span>
00092         <span class="comment">// Instance data for this process's ntdll.dll not yet initialized.</span>
00093         <span class="comment">//</span>
00094 
00095         <a class="code" href="../../d7/d8/ntnap_8c.html#a0">NapInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00096 
00097         <span class="comment">//</span>
00098         <span class="comment">// Get Counter frequency (current counter value is thrown away)</span>
00099         <span class="comment">// This call is not profiled because NapControl == NULL here.</span>
00100         <span class="comment">//</span>
00101 
00102         <a class="code" href="../../d9/d6/ex_2profile_8c.html#a14">NtQueryPerformanceCounter</a>(&amp;CurrentCounter,
00103                                   &amp;<a class="code" href="../../d7/d8/ntnap_8c.html#a1">NapFrequency</a>);
00104 
00105         <span class="comment">//</span>
00106         <span class="comment">// Allocate or open data section for api profiling data.</span>
00107         <span class="comment">//</span>
00108 
00109         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d8/ntnap_8h.html#a10">NapCreateDataSection</a>(&amp;<a class="code" href="../../d7/d8/ntnap_8c.html#a2">NapControl</a>))) {
00110 
00111             <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a> = (PNAPDATA)(<a class="code" href="../../d7/d8/ntnap_8c.html#a2">NapControl</a> + 1);
00112 
00113             <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d8/ntnap_8c.html#a2">NapControl</a>-&gt;<a class="code" href="../../d4/d1/struct__NAPCONTROL.html#o0">Initialized</a>) {
00114 
00115                 <span class="comment">//</span>
00116                 <span class="comment">// We are the first process to get here: we jsut</span>
00117                 <span class="comment">// allocated the section, so must initialize it.</span>
00118                 <span class="comment">//</span>
00119 
00120                 <a class="code" href="../../d7/d8/ntnap_8c.html#a2">NapControl</a>-&gt;<a class="code" href="../../d4/d1/struct__NAPCONTROL.html#o0">Initialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00121 
00122                 <a class="code" href="../../d7/d8/ntnap_8c.html#a2">NapControl</a>-&gt;<a class="code" href="../../d4/d1/struct__NAPCONTROL.html#o1">Paused</a> = 0;
00123 
00124                 <span class="comment">//</span>
00125                 <span class="comment">// Clear the data area used for calibration data.</span>
00126                 <span class="comment">//</span>
00127 
00128                 <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[0].NapLock = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00129                 <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[0].Calls = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00130                 <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[0].TimingErrors = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00131                 <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[0].TotalTime.HighPart = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00132                 <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[0].TotalTime.LowPart = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00133                 <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[0].FirstTime.HighPart = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00134                 <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[0].FirstTime.LowPart = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00135                 <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[0].MaxTime.HighPart = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00136                 <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[0].MaxTime.LowPart = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00137                 <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[0].MinTime.HighPart = <a class="code" href="../../d8/d8/ntnap_8h.html#a0">MAX_LONG</a>;
00138                 <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[0].MinTime.LowPart = <a class="code" href="../../d8/d8/ntnap_8h.html#a1">MAX_ULONG</a>;
00139 
00140                 <span class="comment">//</span>
00141                 <span class="comment">// Clear the rest of the data collection area</span>
00142                 <span class="comment">//</span>
00143 
00144                 <a class="code" href="../../d7/d8/ntnap_8c.html#a7">NapClearData</a>();
00145 
00146                 <span class="comment">//</span>
00147                 <span class="comment">//   Calibrate time overhead from profiling.  We care mostly</span>
00148                 <span class="comment">//   about the minimum time here, to avoid extra time from</span>
00149                 <span class="comment">//   interrupts etc.</span>
00150                 <span class="comment">//</span>
00151 
00152                 <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d8/d8/ntnap_8h.html#a2">NUM_ITERATIONS</a>; i++) {
00153                     <a class="code" href="../../d8/d8/ntnap_8h.html#a11">NapCalibrate</a>();
00154                 }
00155             }
00156         }
00157     }
00158 }
00159 
00160 
00161 
00162 
00163 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00164"></a><a class="code" href="../../d8/d8/ntnap_8h.html#a10">00164</a> <a class="code" href="../../d8/d8/ntnap_8h.html#a10">NapCreateDataSection</a>(
00165     <a class="code" href="../../d4/d1/struct__NAPCONTROL.html">PNAPCONTROL</a> *NapSectionPointer
00166     )
00167 <span class="comment">/*++</span>
00168 <span class="comment"></span>
00169 <span class="comment">Routine Description:</span>
00170 <span class="comment"></span>
00171 <span class="comment">    NapCreateData() is called to create the profiling data section.</span>
00172 <span class="comment">    One section, named "\NapDataSection", is used for the whole system.</span>
00173 <span class="comment">    It is accessible by anyone, so don't mess it up.</span>
00174 <span class="comment"></span>
00175 <span class="comment">Arguments:</span>
00176 <span class="comment"></span>
00177 <span class="comment">    NapSectionPointer - a pointer to a pointer which will be set to</span>
00178 <span class="comment">                        to point to the beginning of the section.</span>
00179 <span class="comment"></span>
00180 <span class="comment">Return Value:</span>
00181 <span class="comment"></span>
00182 <span class="comment">    Status</span>
00183 <span class="comment"></span>
00184 <span class="comment">--*/</span>
00185 
00186 
00187 {
00188     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00189     HANDLE NapSectionHandle;
00190     HANDLE MyProcess;
00191     STRING NapSectionName;
00192     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00193     LARGE_INTEGER AllocationSize;
00194     ULONG ViewSize;
00195     <a class="code" href="../../d4/d1/struct__NAPCONTROL.html">PNAPCONTROL</a> SectionPointer;
00196 
00197     <span class="comment">//</span>
00198     <span class="comment">// Initialize object attributes for the dump file</span>
00199     <span class="comment">//</span>
00200 
00201     NapSectionName.Length = 15;
00202     NapSectionName.MaximumLength = 15;
00203     NapSectionName.Buffer = <span class="stringliteral">"\\NapDataSection"</span>;
00204 
00205     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>.Length = <span class="keyword">sizeof</span>(OBJECT_ATTRIBUTES);
00206     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>.ObjectName = &amp;NapSectionName;
00207     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>.RootDirectory = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00208     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>.SecurityDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00209     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>.SecurityQualityOfService = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00210     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>.Attributes = OBJ_OPENIF |
00211                                   OBJ_CASE_INSENSITIVE;
00212 
00213 
00214     AllocationSize.HighPart = 0;
00215     AllocationSize.LowPart = (NAP_API_COUNT + 1) * <span class="keyword">sizeof</span>(NAPDATA);
00216 
00217     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/creasect_8c.html#a19">NtCreateSection</a>(&amp;NapSectionHandle,
00218                              SECTION_MAP_READ |
00219                              SECTION_MAP_WRITE,
00220                              &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00221                              &amp;AllocationSize,
00222                              PAGE_READWRITE,
00223                              SEC_COMMIT,
00224                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00225 
00226     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00227 
00228         MyProcess = NtCurrentProcess();
00229 
00230         ViewSize = AllocationSize.LowPart;
00231 
00232         SectionPointer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00233 
00234         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a20">NtMapViewOfSection</a>(NapSectionHandle,
00235                                     MyProcess,
00236                                     (PVOID *)&amp;SectionPointer,
00237                                     0,
00238                                     AllocationSize.LowPart,
00239                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00240                                     &amp;ViewSize,
00241                                     ViewUnmap,
00242                                     MEM_TOP_DOWN,
00243                                     PAGE_READWRITE);
00244 
00245         *NapSectionPointer = SectionPointer;
00246     }
00247 
00248     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00249 }
00250 
00251 
00252 
00253 
00254 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00255"></a><a class="code" href="../../d8/d8/ntnap_8h.html#a9">00255</a> <a class="code" href="../../d8/d8/ntnap_8h.html#a9">NapRecordInfo</a> (
00256     IN ULONG ServiceNumber,
00257     IN LARGE_INTEGER Counters[]
00258     )
00259 
00260 <span class="comment">/*++</span>
00261 <span class="comment"></span>
00262 <span class="comment">Routine Description:</span>
00263 <span class="comment"></span>
00264 <span class="comment">    NapRecordInfo() is called after the API being measured has</span>
00265 <span class="comment">    returned, and the value of the performance counter has been</span>
00266 <span class="comment">    obtained.</span>
00267 <span class="comment"></span>
00268 <span class="comment">    NOTE:  Initialization occurs only once and is controlled by</span>
00269 <span class="comment">           the NapInitDone global flag.</span>
00270 <span class="comment"></span>
00271 <span class="comment">Arguments:</span>
00272 <span class="comment"></span>
00273 <span class="comment">    ServiceNumber - the number of the service being measured.</span>
00274 <span class="comment">                    -1 is reserved for calibration.</span>
00275 <span class="comment"></span>
00276 <span class="comment">    Counters      - a pointer to the value of the counter after the call</span>
00277 <span class="comment">                    to the measured routine.  Followed immediately</span>
00278 <span class="comment">                    in memory by the value of the counter before the</span>
00279 <span class="comment">                    call to the measured routine.</span>
00280 <span class="comment"></span>
00281 <span class="comment">Return Value:</span>
00282 <span class="comment"></span>
00283 <span class="comment">    None</span>
00284 <span class="comment"></span>
00285 <span class="comment">--*/</span>
00286 
00287 
00288 {
00289     LARGE_INTEGER ElapsedTime;
00290     LARGE_INTEGER Difference;
00291 
00292 
00293     <span class="comment">//</span>
00294     <span class="comment">// First make sure we have been initialized</span>
00295     <span class="comment">//</span>
00296 
00297     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d8/ntnap_8c.html#a2">NapControl</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00298 
00299         <span class="comment">//</span>
00300         <span class="comment">// Check to be sure profiling is not paused</span>
00301 
00302         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d8/ntnap_8c.html#a2">NapControl</a>-&gt;<a class="code" href="../../d4/d1/struct__NAPCONTROL.html#o1">Paused</a> == 0) {
00303 
00304             <span class="comment">//</span>
00305             <span class="comment">// Since ServiceNumber -1 is used for calibration, bump same</span>
00306             <span class="comment">// so indexes start at 0.</span>
00307             <span class="comment">//</span>
00308 
00309             ServiceNumber++;
00310 
00311             <span class="comment">//</span>
00312             <span class="comment">// Prevent others from changing data at the same time</span>
00313             <span class="comment">// we are.</span>
00314             <span class="comment">//</span>
00315 
00316             NapAcquireSpinLock(&amp;(<a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[ServiceNumber].NapLock));
00317 
00318             <span class="comment">//</span>
00319             <span class="comment">// Record API info</span>
00320             <span class="comment">//</span>
00321 
00322             <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[ServiceNumber].Calls++;
00323 
00324             <span class="comment">//</span>
00325             <span class="comment">// Elapsed time is end time minus start time</span>
00326             <span class="comment">//</span>
00327 
00328             ElapsedTime =
00329                 RtlLargeIntegerSubtract(Counters[0],Counters[1]);
00330 
00331             <span class="comment">//</span>
00332             <span class="comment">// Now add elapsed time to total time</span>
00333             <span class="comment">//</span>
00334 
00335             <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[ServiceNumber].TotalTime =
00336                 RtlLargeIntegerAdd(<a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[ServiceNumber].TotalTime,
00337                                    ElapsedTime);
00338 
00339             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[ServiceNumber].Calls == 1) {
00340                 <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[ServiceNumber].FirstTime = ElapsedTime;
00341             }
00342             <span class="keywordflow">else</span> {
00343                 Difference =
00344                     RtlLargeIntegerSubtract(
00345                         <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[ServiceNumber].MaxTime,
00346                         ElapsedTime);
00347                 <span class="keywordflow">if</span> (Difference.HighPart &lt; 0) {
00348 
00349                     <span class="comment">//</span>
00350                     <span class="comment">// A new maximum was attained</span>
00351                     <span class="comment">//</span>
00352 
00353                     <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[ServiceNumber].MaxTime = ElapsedTime;
00354 
00355                 }
00356                 Difference =
00357                     RtlLargeIntegerSubtract(
00358                         ElapsedTime,
00359                         <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[ServiceNumber].MinTime);
00360                 <span class="keywordflow">if</span> (Difference.HighPart &lt; 0) {
00361 
00362                     <span class="comment">//</span>
00363                     <span class="comment">// A new minimum was attained</span>
00364                     <span class="comment">//</span>
00365 
00366                     <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[ServiceNumber].MinTime = ElapsedTime;
00367                 }
00368             }
00369 
00370             <a class="code" href="../../d8/d8/ntnap_8h.html#a13">NapReleaseSpinLock</a>(&amp;(<a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[ServiceNumber].NapLock));
00371         }
00372     }
00373 }
00374 
00375 
00376 
00377 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00378"></a><a class="code" href="../../d7/d8/ntnap_8c.html#a7">00378</a> <a class="code" href="../../d7/d8/ntnap_8c.html#a7">NapClearData</a> (
00379     VOID
00380     )
00381 
00382 <span class="comment">/*++</span>
00383 <span class="comment"></span>
00384 <span class="comment">Routine Description:</span>
00385 <span class="comment"></span>
00386 <span class="comment">    NapClearData() is called to clear all the counters and timers.</span>
00387 <span class="comment">    The calibration counters are not cleared.  For the rest,</span>
00388 <span class="comment">    if not previously collected, the data will be lost.</span>
00389 <span class="comment"></span>
00390 <span class="comment">Arguments:</span>
00391 <span class="comment"></span>
00392 <span class="comment">    None</span>
00393 <span class="comment"></span>
00394 <span class="comment">Return Value:</span>
00395 <span class="comment"></span>
00396 <span class="comment">    Status</span>
00397 <span class="comment"></span>
00398 <span class="comment">--*/</span>
00399 
00400 {
00401     ULONG ServiceNumber;
00402 
00403     <span class="comment">//</span>
00404     <span class="comment">// Initialize the first one after the calibration data</span>
00405     <span class="comment">//</span>
00406 
00407     NapAcquireSpinLock(&amp;(<a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[1].NapLock));
00408 
00409     <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[1].Calls = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00410     <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[1].TimingErrors = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00411     <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[1].TotalTime.HighPart = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00412     <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[1].TotalTime.LowPart = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00413     <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[1].FirstTime.HighPart = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00414     <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[1].FirstTime.LowPart = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00415     <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[1].MaxTime.HighPart = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00416     <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[1].MaxTime.LowPart = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00417     <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[1].MinTime.HighPart = <a class="code" href="../../d8/d8/ntnap_8h.html#a0">MAX_LONG</a>;
00418     <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[1].MinTime.LowPart = <a class="code" href="../../d8/d8/ntnap_8h.html#a1">MAX_ULONG</a>;
00419 
00420     <span class="comment">//</span>
00421     <span class="comment">// Now use the initialized first one to initialize the rest</span>
00422     <span class="comment">//</span>
00423 
00424 
00425     <span class="keywordflow">for</span> (ServiceNumber = 2; ServiceNumber &lt;= NAP_API_COUNT; ServiceNumber++) {
00426 
00427         NapAcquireSpinLock(&amp;(<a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[ServiceNumber].NapLock));
00428 
00429         <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[ServiceNumber] = <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[1];
00430 
00431         <a class="code" href="../../d8/d8/ntnap_8h.html#a13">NapReleaseSpinLock</a>(&amp;(<a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[ServiceNumber].NapLock));
00432     }
00433 
00434     <a class="code" href="../../d8/d8/ntnap_8h.html#a13">NapReleaseSpinLock</a>(&amp;(<a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[1].NapLock));
00435 
00436     <span class="keywordflow">return</span>(STATUS_SUCCESS);
00437 }
00438 
00439 
00440 
00441 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00442"></a><a class="code" href="../../d7/d8/ntnap_8c.html#a8">00442</a> <a class="code" href="../../d7/d8/ntnap_8c.html#a8">NapRetrieveData</a> (
00443     OUT NAPDATA *NapApiData,
00444     OUT PCHAR **NapApiNames,
00445     OUT PLARGE_INTEGER *NapCounterFrequency
00446     )
00447 
00448 <span class="comment">/*++</span>
00449 <span class="comment"></span>
00450 <span class="comment">Routine Description:</span>
00451 <span class="comment"></span>
00452 <span class="comment">    NapRetrieveData() is called to get all the relevant data</span>
00453 <span class="comment">    about API's that have been profiled.  It is wise to call</span>
00454 <span class="comment">    NapPause() before calling this, and NapResume() afterwards.</span>
00455 <span class="comment">    Can't just do these in here, 'cause you may be doing stuff outside</span>
00456 <span class="comment">    of this call you don't want profiled.</span>
00457 <span class="comment"></span>
00458 <span class="comment">Arguments:</span>
00459 <span class="comment"></span>
00460 <span class="comment">    NapApiData - a pointer to a buffer to which is copied</span>
00461 <span class="comment">                 the array of counters; must be large enough for</span>
00462 <span class="comment">                 NAP_API_COUNT+1; call NapGetApiCount to obtain needed</span>
00463 <span class="comment">                 size.</span>
00464 <span class="comment"></span>
00465 <span class="comment">    NapApiNames - a pointer to which is copied a pointer to</span>
00466 <span class="comment">                  an array of pointers to API names</span>
00467 <span class="comment"></span>
00468 <span class="comment">    NapCounterFrequency - a buffer to which is copied the frequency</span>
00469 <span class="comment">                          of the performance counter</span>
00470 <span class="comment"></span>
00471 <span class="comment">Return Value:</span>
00472 <span class="comment"></span>
00473 <span class="comment">    Status</span>
00474 <span class="comment"></span>
00475 <span class="comment">--*/</span>
00476 
00477 {
00478     ULONG ServiceNumber;
00479 
00480     *NapApiNames = <a class="code" href="../../d8/d8/ntnap_8h.html#a7">NapNames</a>;
00481 
00482     *NapCounterFrequency = &amp;<a class="code" href="../../d7/d8/ntnap_8c.html#a1">NapFrequency</a>;
00483 
00484     <span class="keywordflow">for</span> (ServiceNumber = 0; ServiceNumber &lt;= NAP_API_COUNT; ServiceNumber++) {
00485 
00486         NapAcquireSpinLock(&amp;(<a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[ServiceNumber].NapLock));
00487 
00488         NapApiData[ServiceNumber] = <a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[ServiceNumber];
00489 
00490         <a class="code" href="../../d8/d8/ntnap_8h.html#a13">NapReleaseSpinLock</a>(&amp;(<a class="code" href="../../d7/d8/ntnap_8c.html#a3">NapProfilingData</a>[ServiceNumber].NapLock));
00491         <a class="code" href="../../d8/d8/ntnap_8h.html#a13">NapReleaseSpinLock</a>(&amp;(NapApiData[ServiceNumber].NapLock));
00492     }
00493 
00494     <span class="keywordflow">return</span>(STATUS_SUCCESS);
00495 }
00496 
00497 
00498 
00499 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00500"></a><a class="code" href="../../d7/d8/ntnap_8c.html#a9">00500</a> <a class="code" href="../../d7/d8/ntnap_8c.html#a9">NapGetApiCount</a> (
00501     OUT PULONG NapApiCount
00502     )
00503 
00504 <span class="comment">/*++</span>
00505 <span class="comment"></span>
00506 <span class="comment">Routine Description:</span>
00507 <span class="comment"></span>
00508 <span class="comment">    NapGetApiCount() is called to get the number of API's which are</span>
00509 <span class="comment">    being profiled.  This can then be used to allocate an array for</span>
00510 <span class="comment">    receiving the data from NapReturnData.</span>
00511 <span class="comment"></span>
00512 <span class="comment">Arguments:</span>
00513 <span class="comment"></span>
00514 <span class="comment">    NapApiCount - A pointer throug which the count is returned.</span>
00515 <span class="comment"></span>
00516 <span class="comment">Return Value:</span>
00517 <span class="comment"></span>
00518 <span class="comment">    Status</span>
00519 <span class="comment"></span>
00520 <span class="comment">--*/</span>
00521 
00522 
00523 {
00524 
00525     *NapApiCount = NAP_API_COUNT;
00526 
00527     <span class="keywordflow">return</span>(STATUS_SUCCESS);
00528 
00529 }
00530 
00531 
00532 
00533 
00534 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00535"></a><a class="code" href="../../d7/d8/ntnap_8c.html#a10">00535</a> <a class="code" href="../../d7/d8/ntnap_8c.html#a10">NapPause</a> (
00536     VOID
00537     )
00538 
00539 <span class="comment">/*++</span>
00540 <span class="comment"></span>
00541 <span class="comment">Routine Description:</span>
00542 <span class="comment"></span>
00543 <span class="comment">    NapPause() is called to temporarily cease data collection.</span>
00544 <span class="comment">    Data collection is resumed by a companion call to NapResume.</span>
00545 <span class="comment"></span>
00546 <span class="comment">Arguments:</span>
00547 <span class="comment"></span>
00548 <span class="comment">    None</span>
00549 <span class="comment"></span>
00550 <span class="comment">Return Value:</span>
00551 <span class="comment"></span>
00552 <span class="comment">    Status</span>
00553 <span class="comment"></span>
00554 <span class="comment">--*/</span>
00555 
00556 
00557 {
00558     <a class="code" href="../../d7/d8/ntnap_8c.html#a2">NapControl</a>-&gt;<a class="code" href="../../d4/d1/struct__NAPCONTROL.html#o1">Paused</a>++;
00559 
00560     <span class="keywordflow">return</span>(STATUS_SUCCESS);
00561 }
00562 
00563 
00564 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00565"></a><a class="code" href="../../d7/d8/ntnap_8c.html#a11">00565</a> <a class="code" href="../../d7/d8/ntnap_8c.html#a11">NapResume</a> (
00566     VOID
00567     )
00568 
00569 <span class="comment">/*++</span>
00570 <span class="comment"></span>
00571 <span class="comment">Routine Description:</span>
00572 <span class="comment"></span>
00573 <span class="comment">    NapResume() is called to resume data collection after a companion</span>
00574 <span class="comment">    call to NapPause.</span>
00575 <span class="comment"></span>
00576 <span class="comment">Arguments:</span>
00577 <span class="comment"></span>
00578 <span class="comment">    None</span>
00579 <span class="comment"></span>
00580 <span class="comment">Return Value:</span>
00581 <span class="comment"></span>
00582 <span class="comment">    Status</span>
00583 <span class="comment"></span>
00584 <span class="comment">--*/</span>
00585 
00586 
00587 {
00588     <a class="code" href="../../d7/d8/ntnap_8c.html#a2">NapControl</a>-&gt;<a class="code" href="../../d4/d1/struct__NAPCONTROL.html#o1">Paused</a>--;
00589 
00590     <span class="keywordflow">return</span>(STATUS_SUCCESS);
00591 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:01 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
