<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: nlsboot.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>nlsboot.c</h1><a href="../../d7/d6/nlsboot_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1992  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    nlsboot.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains NLS routines for use by the OS Loader.  Before</span>
00012 <span class="comment">    the NLS tables are loaded, they convert between ANSI and Unicode by</span>
00013 <span class="comment">    zero-extending.</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    John Vert (jvert) 11-Nov-1992</span>
00018 <span class="comment"></span>
00019 <span class="comment">Revision History:</span>
00020 <span class="comment"></span>
00021 <span class="comment">    John Vert (jvert) 11-Nov-1992</span>
00022 <span class="comment">        created - mostly copied from old RTL routines</span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="../../d3/d3/arcinst_2precomp_8h.html">precomp.h</a>"</span>
00027 <span class="preprocessor">#pragma hdrstop</span>
00028 <span class="preprocessor"></span>
00029 <span class="comment">//</span>
00030 <span class="comment">// Hack-o-rama string routines to use before tables are loaded</span>
00031 <span class="comment">//</span>
00032 
<a name="l00033"></a><a class="code" href="../../d7/d6/nlsboot_8c.html#a0">00033</a> <span class="preprocessor">#define upcase(C) (WCHAR )(((C) &gt;= 'a' &amp;&amp; (C) &lt;= 'z' ? (C) - ('a' - 'A') : (C)))</span>
00034 <span class="preprocessor"></span>
00035 
00036 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00037"></a><a class="code" href="../../d7/d6/nlsboot_8c.html#a1">00037</a> <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
00038     OUT PUNICODE_STRING DestinationString,
00039     IN PANSI_STRING SourceString,
00040     IN BOOLEAN AllocateDestinationString
00041     )
00042 
00043 {
00044     ULONG UnicodeLength;
00045     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00046     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00047 
00048     UnicodeLength = (<a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a>-&gt;Length &lt;&lt; 1) + <span class="keyword">sizeof</span>(UNICODE_NULL);
00049 
00050     <span class="keywordflow">if</span> ( UnicodeLength &gt; MAXUSHORT ) {
00051         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_2;
00052         }
00053 
00054     DestinationString-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(UnicodeLength - <span class="keyword">sizeof</span>(UNICODE_NULL));
00055     <span class="keywordflow">if</span> ( AllocateDestinationString ) {
00056         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00057         }
00058     <span class="keywordflow">else</span> {
00059         <span class="keywordflow">if</span> ( DestinationString-&gt;Length &gt;= DestinationString-&gt;MaximumLength ) {
00060             <span class="keywordflow">return</span> STATUS_BUFFER_OVERFLOW;
00061             }
00062         }
00063 
00064     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
00065     <span class="keywordflow">while</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; DestinationString-&gt;Length ) {
00066         DestinationString-&gt;Buffer[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = (WCHAR)<a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a>-&gt;Buffer[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00067         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++;
00068         }
00069     DestinationString-&gt;Buffer[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = UNICODE_NULL;
00070 
00071     <span class="keywordflow">return</span> STATUS_SUCCESS;
00072 }
00073 
00074 LONG
<a name="l00075"></a><a class="code" href="../../d7/d6/nlsboot_8c.html#a2">00075</a> <a class="code" href="../../d6/d6/nls_8c.html#a41">RtlCompareUnicodeString</a>(
00076     IN PUNICODE_STRING String1,
00077     IN PUNICODE_STRING String2,
00078     IN BOOLEAN CaseInSensitive
00079     )
00080 
00081 <span class="comment">/*++</span>
00082 <span class="comment"></span>
00083 <span class="comment">Routine Description:</span>
00084 <span class="comment"></span>
00085 <span class="comment">    The RtlCompareUnicodeString function compares two counted strings.  The</span>
00086 <span class="comment">    return value indicates if the strings are equal or String1 is less than</span>
00087 <span class="comment">    String2 or String1 is greater than String2.</span>
00088 <span class="comment"></span>
00089 <span class="comment">    The CaseInSensitive parameter specifies if case is to be ignored when</span>
00090 <span class="comment">    doing the comparison.</span>
00091 <span class="comment"></span>
00092 <span class="comment">Arguments:</span>
00093 <span class="comment"></span>
00094 <span class="comment">    String1 - Pointer to the first string.</span>
00095 <span class="comment"></span>
00096 <span class="comment">    String2 - Pointer to the second string.</span>
00097 <span class="comment"></span>
00098 <span class="comment">    CaseInsensitive - TRUE if case should be ignored when doing the</span>
00099 <span class="comment">        comparison.</span>
00100 <span class="comment"></span>
00101 <span class="comment">Return Value:</span>
00102 <span class="comment"></span>
00103 <span class="comment">    Signed value that gives the results of the comparison:</span>
00104 <span class="comment"></span>
00105 <span class="comment">        Zero - String1 equals String2</span>
00106 <span class="comment"></span>
00107 <span class="comment">        &lt; Zero - String1 less than String2</span>
00108 <span class="comment"></span>
00109 <span class="comment">        &gt; Zero - String1 greater than String2</span>
00110 <span class="comment"></span>
00111 <span class="comment"></span>
00112 <span class="comment">--*/</span>
00113 
00114 {
00115 
00116     UNALIGNED WCHAR *s1, *s2;
00117     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> n1, n2;
00118     WCHAR c1, c2;
00119     LONG cDiff;
00120 
00121     s1 = <a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>-&gt;Buffer;
00122     s2 = <a class="code" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a>-&gt;Buffer;
00123     n1 = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> )(<a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>-&gt;Length / <span class="keyword">sizeof</span>(WCHAR));
00124     n2 = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> )(<a class="code" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a>-&gt;Length / <span class="keyword">sizeof</span>(WCHAR));
00125     <span class="keywordflow">while</span> (n1 &amp;&amp; n2) {
00126         c1 = *s1++;
00127         c2 = *s2++;
00128 
00129         <span class="keywordflow">if</span> (CaseInSensitive) {
00130             <span class="comment">//</span>
00131             <span class="comment">// Note that this needs to reference the translation table !</span>
00132             <span class="comment">//</span>
00133             c1 = <a class="code" href="../../d7/d6/nlsboot_8c.html#a0">upcase</a>(c1);
00134             c2 = <a class="code" href="../../d7/d6/nlsboot_8c.html#a0">upcase</a>(c2);
00135         }
00136 
00137         <span class="keywordflow">if</span> ((cDiff = ((LONG)c1 - (LONG)c2)) != 0) {
00138             <span class="keywordflow">return</span>( cDiff );
00139             }
00140 
00141         n1--;
00142         n2--;
00143         }
00144 
00145     <span class="keywordflow">return</span>( n1 - n2 );
00146 }
00147 
00148 BOOLEAN
<a name="l00149"></a><a class="code" href="../../d7/d6/nlsboot_8c.html#a3">00149</a> <a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(
00150     IN <span class="keyword">const</span> PUNICODE_STRING String1,
00151     IN <span class="keyword">const</span> PUNICODE_STRING String2,
00152     IN BOOLEAN CaseInSensitive
00153     )
00154 
00155 <span class="comment">/*++</span>
00156 <span class="comment"></span>
00157 <span class="comment">Routine Description:</span>
00158 <span class="comment"></span>
00159 <span class="comment">    The RtlEqualUnicodeString function compares two counted unicode strings for</span>
00160 <span class="comment">    equality.</span>
00161 <span class="comment"></span>
00162 <span class="comment">    The CaseInSensitive parameter specifies if case is to be ignored when</span>
00163 <span class="comment">    doing the comparison.</span>
00164 <span class="comment"></span>
00165 <span class="comment">Arguments:</span>
00166 <span class="comment"></span>
00167 <span class="comment">    String1 - Pointer to the first string.</span>
00168 <span class="comment"></span>
00169 <span class="comment">    String2 - Pointer to the second string.</span>
00170 <span class="comment"></span>
00171 <span class="comment">    CaseInsensitive - TRUE if case should be ignored when doing the</span>
00172 <span class="comment">        comparison.</span>
00173 <span class="comment"></span>
00174 <span class="comment">Return Value:</span>
00175 <span class="comment"></span>
00176 <span class="comment">    Boolean value that is TRUE if String1 equals String2 and FALSE otherwise.</span>
00177 <span class="comment"></span>
00178 <span class="comment">--*/</span>
00179 
00180 {
00181     UNALIGNED WCHAR *s1, *s2;
00182     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> n1, n2;
00183     WCHAR c1, c2;
00184 
00185     s1 = <a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>-&gt;Buffer;
00186     s2 = <a class="code" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a>-&gt;Buffer;
00187     n1 = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> )(<a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>-&gt;Length / <span class="keyword">sizeof</span>(WCHAR));
00188     n2 = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> )(<a class="code" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a>-&gt;Length / <span class="keyword">sizeof</span>(WCHAR));
00189 
00190     <span class="keywordflow">if</span> ( n1 != n2 ) {
00191         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00192         }
00193 
00194     <span class="keywordflow">if</span> (CaseInSensitive) {
00195 
00196         <span class="keywordflow">while</span> ( n1 ) {
00197 
00198             <span class="keywordflow">if</span> ( *s1++ != *s2++ ) {
00199                 c1 = <a class="code" href="../../d7/d6/nlsboot_8c.html#a0">upcase</a>(*(s1-1));
00200                 c2 = <a class="code" href="../../d7/d6/nlsboot_8c.html#a0">upcase</a>(*(s2-1));
00201                 <span class="keywordflow">if</span> (c1 != c2) {
00202                     <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00203                     }
00204                 }
00205             n1--;
00206             }
00207         }
00208     <span class="keywordflow">else</span> {
00209 
00210         <span class="keywordflow">while</span> ( n1 ) {
00211 
00212             <span class="keywordflow">if</span> (*s1++ != *s2++) {
00213                 <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00214                 }
00215 
00216             n1--;
00217             }
00218         }
00219 
00220     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00221 }
00222 
00223 
00224 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00225"></a><a class="code" href="../../d7/d6/nlsboot_8c.html#a4">00225</a> <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>(
00226     OUT PSTRING DestinationString,
00227     IN PCSZ SourceString OPTIONAL
00228     )
00229 
00230 <span class="comment">/*++</span>
00231 <span class="comment"></span>
00232 <span class="comment">Routine Description:</span>
00233 <span class="comment"></span>
00234 <span class="comment">    The RtlInitString function initializes an NT counted string.</span>
00235 <span class="comment">    The DestinationString is initialized to point to the SourceString</span>
00236 <span class="comment">    and the Length and MaximumLength fields of DestinationString are</span>
00237 <span class="comment">    initialized to the length of the SourceString, which is zero if</span>
00238 <span class="comment">    SourceString is not specified.</span>
00239 <span class="comment"></span>
00240 <span class="comment">Arguments:</span>
00241 <span class="comment"></span>
00242 <span class="comment">    DestinationString - Pointer to the counted string to initialize</span>
00243 <span class="comment"></span>
00244 <span class="comment">    SourceString - Optional pointer to a null terminated string that</span>
00245 <span class="comment">        the counted string is to point to.</span>
00246 <span class="comment"></span>
00247 <span class="comment"></span>
00248 <span class="comment">Return Value:</span>
00249 <span class="comment"></span>
00250 <span class="comment">    None.</span>
00251 <span class="comment"></span>
00252 <span class="comment">--*/</span>
00253 
00254 {
00255     DestinationString-&gt;Length = 0;
00256     DestinationString-&gt;Buffer = (PCHAR)<a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a>;
00257     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( <a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a> )) {
00258         <span class="keywordflow">while</span> (*<a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a>++) {
00259             DestinationString-&gt;Length++;
00260             }
00261 
00262         DestinationString-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(DestinationString-&gt;Length+1);
00263         }
00264     <span class="keywordflow">else</span> {
00265         DestinationString-&gt;MaximumLength = 0;
00266         }
00267 }
00268 
00269 
00270 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00271"></a><a class="code" href="../../d7/d6/nlsboot_8c.html#a5">00271</a> <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00272     OUT PUNICODE_STRING DestinationString,
00273     IN PCWSTR SourceString OPTIONAL
00274     )
00275 
00276 <span class="comment">/*++</span>
00277 <span class="comment"></span>
00278 <span class="comment">Routine Description:</span>
00279 <span class="comment"></span>
00280 <span class="comment">    The RtlInitUnicodeString function initializes an NT counted</span>
00281 <span class="comment">    unicode string.  The DestinationString is initialized to point to</span>
00282 <span class="comment">    the SourceString and the Length and MaximumLength fields of</span>
00283 <span class="comment">    DestinationString are initialized to the length of the SourceString,</span>
00284 <span class="comment">    which is zero if SourceString is not specified.</span>
00285 <span class="comment"></span>
00286 <span class="comment">Arguments:</span>
00287 <span class="comment"></span>
00288 <span class="comment">    DestinationString - Pointer to the counted string to initialize</span>
00289 <span class="comment"></span>
00290 <span class="comment">    SourceString - Optional pointer to a null terminated unicode string that</span>
00291 <span class="comment">        the counted string is to point to.</span>
00292 <span class="comment"></span>
00293 <span class="comment"></span>
00294 <span class="comment">Return Value:</span>
00295 <span class="comment"></span>
00296 <span class="comment">    None.</span>
00297 <span class="comment"></span>
00298 <span class="comment">--*/</span>
00299 
00300 {
00301     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Length = 0;
00302     DestinationString-&gt;Length = 0;
00303     DestinationString-&gt;Buffer = (PWSTR)<a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a>;
00304     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( <a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a> )) {
00305         <span class="keywordflow">while</span> (*<a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a>++) {
00306             Length += <span class="keyword">sizeof</span>(*SourceString);
00307             }
00308 
00309         DestinationString-&gt;Length = Length;
00310 
00311         DestinationString-&gt;MaximumLength = Length+(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>(UNICODE_NULL);
00312         }
00313     <span class="keywordflow">else</span> {
00314         DestinationString-&gt;MaximumLength = 0;
00315         }
00316 }
00317 
00318 
00319 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00320"></a><a class="code" href="../../d7/d6/nlsboot_8c.html#a6">00320</a> <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a> (
00321     IN PUNICODE_STRING Destination,
00322     IN PUNICODE_STRING Source
00323     )
00324 
00325 <span class="comment">/*++</span>
00326 <span class="comment"></span>
00327 <span class="comment">Routine Description:</span>
00328 <span class="comment"></span>
00329 <span class="comment">    This routine will concatinate two PSTRINGs together.  It will copy</span>
00330 <span class="comment">    bytes from the source up to the MaximumLength of the destination.</span>
00331 <span class="comment"></span>
00332 <span class="comment">Arguments:</span>
00333 <span class="comment"></span>
00334 <span class="comment">    IN PSTRING Destination, - Supplies the destination string</span>
00335 <span class="comment">    IN PSTRING Source - Supplies the source for the string copy</span>
00336 <span class="comment"></span>
00337 <span class="comment">Return Value:</span>
00338 <span class="comment"></span>
00339 <span class="comment">    STATUS_SUCCESS - The source string was successfully appended to the</span>
00340 <span class="comment">        destination counted string.</span>
00341 <span class="comment"></span>
00342 <span class="comment">    STATUS_BUFFER_TOO_SMALL - The destination string length was not big</span>
00343 <span class="comment">        enough to allow the source string to be appended.  The Destination</span>
00344 <span class="comment">        string length is not updated.</span>
00345 <span class="comment"></span>
00346 <span class="comment">--*/</span>
00347 
00348 {
00349     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = Source-&gt;Length;
00350     UNALIGNED WCHAR *dst;
00351 
00352     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>) {
00353         <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> + Destination-&gt;Length) &gt; Destination-&gt;MaximumLength) {
00354             <span class="keywordflow">return</span>( STATUS_BUFFER_TOO_SMALL );
00355             }
00356 
00357         dst = &amp;Destination-&gt;Buffer[ (Destination-&gt;Length / <span class="keyword">sizeof</span>( WCHAR )) ];
00358         RtlMoveMemory( dst, Source-&gt;Buffer, <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> );
00359 
00360         Destination-&gt;Length += <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
00361 
00362         <span class="keywordflow">if</span> (Destination-&gt;Length &lt; Destination-&gt;MaximumLength) {
00363             dst[ <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> / <span class="keyword">sizeof</span>( WCHAR ) ] = UNICODE_NULL;
00364             }
00365         }
00366 
00367     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00368 }
00369 
00370 
00371 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00372"></a><a class="code" href="../../d7/d6/nlsboot_8c.html#a7">00372</a> <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a> (
00373     IN PUNICODE_STRING Destination,
00374     IN PCWSTR Source OPTIONAL
00375     )
00376 
00377 <span class="comment">/*++</span>
00378 <span class="comment"></span>
00379 <span class="comment">Routine Description:</span>
00380 <span class="comment"></span>
00381 <span class="comment">    This routine appends the supplied UNICODE string to an existing</span>
00382 <span class="comment">    PUNICODE_STRING.</span>
00383 <span class="comment"></span>
00384 <span class="comment">    It will copy bytes from the Source PSZ to the destination PSTRING up to</span>
00385 <span class="comment">    the destinations PUNICODE_STRING-&gt;MaximumLength field.</span>
00386 <span class="comment"></span>
00387 <span class="comment">Arguments:</span>
00388 <span class="comment"></span>
00389 <span class="comment">    IN PUNICODE_STRING Destination, - Supplies a pointer to the destination</span>
00390 <span class="comment">                            string</span>
00391 <span class="comment">    IN PWSTR Source - Supplies the string to append to the destination</span>
00392 <span class="comment"></span>
00393 <span class="comment">Return Value:</span>
00394 <span class="comment"></span>
00395 <span class="comment">    STATUS_SUCCESS - The source string was successfully appended to the</span>
00396 <span class="comment">        destination counted string.</span>
00397 <span class="comment"></span>
00398 <span class="comment">    STATUS_BUFFER_TOO_SMALL - The destination string length was not big</span>
00399 <span class="comment">        enough to allow the source string to be appended.  The Destination</span>
00400 <span class="comment">        string length is not updated.</span>
00401 <span class="comment"></span>
00402 <span class="comment">--*/</span>
00403 
00404 {
00405     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
00406     UNALIGNED WCHAR *dst;
00407 
00408     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Source )) {
00409         UNICODE_STRING UniSource;
00410 
00411         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UniSource, Source);
00412 
00413         <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = UniSource.Length;
00414 
00415         <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> + Destination-&gt;Length) &gt; Destination-&gt;MaximumLength) {
00416             <span class="keywordflow">return</span>( STATUS_BUFFER_TOO_SMALL );
00417             }
00418 
00419         dst = &amp;Destination-&gt;Buffer[ (Destination-&gt;Length / <span class="keyword">sizeof</span>( WCHAR )) ];
00420         RtlMoveMemory( dst, Source, <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> );
00421 
00422         Destination-&gt;Length += <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
00423 
00424         <span class="keywordflow">if</span> (Destination-&gt;Length &lt; Destination-&gt;MaximumLength) {
00425             dst[ <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> / <span class="keyword">sizeof</span>( WCHAR ) ] = UNICODE_NULL;
00426             }
00427         }
00428 
00429     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00430 }
00431 
00432 WCHAR
<a name="l00433"></a><a class="code" href="../../d7/d6/nlsboot_8c.html#a8">00433</a> <a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(
00434     IN WCHAR SourceCharacter
00435     )
00436 
00437 <span class="comment">/*++</span>
00438 <span class="comment"></span>
00439 <span class="comment">Routine Description:</span>
00440 <span class="comment"></span>
00441 <span class="comment">    This function translates the specified unicode character to its</span>
00442 <span class="comment">    equivalent upcased unicode chararacter.  The purpose for this routine</span>
00443 <span class="comment">    is to allow for character by character upcase translation.  The</span>
00444 <span class="comment">    translation is done with respect to the current system locale</span>
00445 <span class="comment">    information.</span>
00446 <span class="comment"></span>
00447 <span class="comment"></span>
00448 <span class="comment">Arguments:</span>
00449 <span class="comment"></span>
00450 <span class="comment">    SourceCharacter - Supplies the unicode character to be upcased.</span>
00451 <span class="comment"></span>
00452 <span class="comment">Return Value:</span>
00453 <span class="comment"></span>
00454 <span class="comment">    Returns the upcased unicode equivalent of the specified input character.</span>
00455 <span class="comment"></span>
00456 <span class="comment">--*/</span>
00457 
00458 {
00459 
00460     <span class="keywordflow">return</span> (<a class="code" href="../../d7/d6/nlsboot_8c.html#a0">upcase</a>(SourceCharacter));
00461 }
00462 
00463 WCHAR
<a name="l00464"></a><a class="code" href="../../d7/d6/nlsboot_8c.html#a9">00464</a> <a class="code" href="../../d6/d6/nls_8c.html#a22">RtlAnsiCharToUnicodeChar</a>(
00465     IN OUT PUCHAR *SourceCharacter
00466     )
00467 
00468 <span class="comment">/*++</span>
00469 <span class="comment"></span>
00470 <span class="comment">Routine Description:</span>
00471 <span class="comment"></span>
00472 <span class="comment">    This function translates the specified ansi character to unicode and</span>
00473 <span class="comment">    returns the unicode value.  The purpose for this routine is to allow</span>
00474 <span class="comment">    for character by character ansi to unicode translation.  The</span>
00475 <span class="comment">    translation is done with respect to the current system locale</span>
00476 <span class="comment">    information.</span>
00477 <span class="comment"></span>
00478 <span class="comment"></span>
00479 <span class="comment">Arguments:</span>
00480 <span class="comment"></span>
00481 <span class="comment">    SourceCharacter - Supplies a pointer to an ansi character pointer.</span>
00482 <span class="comment">        Through two levels of indirection, this supplies an ansi</span>
00483 <span class="comment">        character that is to be translated to unicode.  After</span>
00484 <span class="comment">        translation, the ansi character pointer is modified to point to</span>
00485 <span class="comment">        the next character to be converted.  This is done to allow for</span>
00486 <span class="comment">        dbcs ansi characters.</span>
00487 <span class="comment"></span>
00488 <span class="comment">Return Value:</span>
00489 <span class="comment"></span>
00490 <span class="comment">    Returns the unicode equivalent of the specified ansi character.</span>
00491 <span class="comment"></span>
00492 <span class="comment">--*/</span>
00493 
00494 {
00495     WCHAR UnicodeCharacter;
00496     ULONG cbCharSize;
00497     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00498 
00499 
00500     UnicodeCharacter = (WCHAR)**SourceCharacter;
00501     (*SourceCharacter)++;
00502     <span class="keywordflow">return</span>(UnicodeCharacter);
00503 }
00504 
00505 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00506"></a><a class="code" href="../../d7/d6/nlsboot_8c.html#a10">00506</a> <a class="code" href="../../d9/d6/nlsxlat_8c.html#a38">RtlUpcaseUnicodeToMultiByteN</a>(
00507     OUT PCH MultiByteString,
00508     IN ULONG MaxBytesInMultiByteString,
00509     OUT PULONG BytesInMultiByteString OPTIONAL,
00510     IN PWCH UnicodeString,
00511     IN ULONG BytesInUnicodeString)
00512 
00513 <span class="comment">/*++</span>
00514 <span class="comment"></span>
00515 <span class="comment">Routine Description:</span>
00516 <span class="comment"></span>
00517 <span class="comment">    This functions upper cases the specified unicode source string and</span>
00518 <span class="comment">    converts it into an ansi string. The translation is done with respect</span>
00519 <span class="comment">    to the ANSI Code Page (ACP) loaded at boot time.</span>
00520 <span class="comment"></span>
00521 <span class="comment">Arguments:</span>
00522 <span class="comment"></span>
00523 <span class="comment">    MultiByteString - Returns an ansi string that is equivalent to the</span>
00524 <span class="comment">        upper case of the unicode source string.  If the translation can</span>
00525 <span class="comment">        not be done, an error is returned.</span>
00526 <span class="comment"></span>
00527 <span class="comment">    MaxBytesInMultiByteString - Supplies the maximum number of bytes to be</span>
00528 <span class="comment">        written to MultiByteString.  If this causes MultiByteString to be a</span>
00529 <span class="comment">        truncated equivalent of UnicodeString, no error condition results.</span>
00530 <span class="comment"></span>
00531 <span class="comment">    BytesInMultiByteString - Returns the number of bytes in the returned</span>
00532 <span class="comment">        ansi string pointed to by MultiByteString.</span>
00533 <span class="comment"></span>
00534 <span class="comment">    UnicodeString - Supplies the unicode source string that is to be</span>
00535 <span class="comment">        converted to ansi.</span>
00536 <span class="comment"></span>
00537 <span class="comment">    BytesInUnicodeString - The number of bytes in the the string pointed to by</span>
00538 <span class="comment">        UnicodeString.</span>
00539 <span class="comment"></span>
00540 <span class="comment">Return Value:</span>
00541 <span class="comment"></span>
00542 <span class="comment">    SUCCESS - The conversion was successful</span>
00543 <span class="comment"></span>
00544 <span class="comment">--*/</span>
00545 
00546 {
00547     ULONG TmpCount;
00548     ULONG LoopCount;
00549     ULONG CharsInUnicodeString;
00550     UCHAR SbChar;
00551     WCHAR UnicodeChar;
00552     ULONG i;
00553 
00554     <span class="comment">//</span>
00555     <span class="comment">// Convert Unicode byte count to character count. Byte count of</span>
00556     <span class="comment">// multibyte string is equivalent to character count.</span>
00557     <span class="comment">//</span>
00558     CharsInUnicodeString = BytesInUnicodeString / <span class="keyword">sizeof</span>(WCHAR);
00559 
00560     LoopCount = (CharsInUnicodeString &lt; MaxBytesInMultiByteString) ?
00561                  CharsInUnicodeString : MaxBytesInMultiByteString;
00562 
00563     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(BytesInMultiByteString))
00564         *BytesInMultiByteString = LoopCount;
00565 
00566 
00567     <span class="keywordflow">for</span> (i=0;i&lt;LoopCount;i++) {
00568 
00569         MultiByteString[i] = (UCHAR)<a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>((UCHAR)(UnicodeString[i]));
00570     }
00571 
00572     <span class="keywordflow">return</span> STATUS_SUCCESS;
00573 }
00574 
00575 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00576"></a><a class="code" href="../../d7/d6/nlsboot_8c.html#a11">00576</a> <a class="code" href="../../d9/d6/nlsxlat_8c.html#a33">RtlMultiByteToUnicodeN</a>(
00577     OUT PWCH UnicodeString,
00578     IN ULONG MaxBytesInUnicodeString,
00579     OUT PULONG BytesInUnicodeString OPTIONAL,
00580     IN PCH MultiByteString,
00581     IN ULONG BytesInMultiByteString)
00582 
00583 <span class="comment">/*++</span>
00584 <span class="comment"></span>
00585 <span class="comment">Routine Description:</span>
00586 <span class="comment"></span>
00587 <span class="comment">    This functions converts the specified ansi source string into a</span>
00588 <span class="comment">    Unicode string. The translation is done with respect to the</span>
00589 <span class="comment">    ANSI Code Page (ACP) installed at boot time.  Single byte characters</span>
00590 <span class="comment">    in the range 0x00 - 0x7f are simply zero extended as a performance</span>
00591 <span class="comment">    enhancement.  In some far eastern code pages 0x5c is defined as the</span>
00592 <span class="comment">    Yen sign.  For system translation we always want to consider 0x5c</span>
00593 <span class="comment">    to be the backslash character.  We get this for free by zero extending.</span>
00594 <span class="comment"></span>
00595 <span class="comment">    NOTE: This routine only supports precomposed Unicode characters.</span>
00596 <span class="comment"></span>
00597 <span class="comment">Arguments:</span>
00598 <span class="comment"></span>
00599 <span class="comment">    UnicodeString - Returns a unicode string that is equivalent to</span>
00600 <span class="comment">        the ansi source string.</span>
00601 <span class="comment"></span>
00602 <span class="comment">    MaxBytesInUnicodeString - Supplies the maximum number of bytes to be</span>
00603 <span class="comment">        written to UnicodeString.  If this causes UnicodeString to be a</span>
00604 <span class="comment">        truncated equivalent of MultiByteString, no error condition results.</span>
00605 <span class="comment"></span>
00606 <span class="comment">    BytesInUnicodeString - Returns the number of bytes in the returned</span>
00607 <span class="comment">        unicode string pointed to by UnicodeString.</span>
00608 <span class="comment"></span>
00609 <span class="comment">    MultiByteString - Supplies the ansi source string that is to be</span>
00610 <span class="comment">        converted to unicode.</span>
00611 <span class="comment"></span>
00612 <span class="comment">    BytesInMultiByteString - The number of bytes in the string pointed to</span>
00613 <span class="comment">        by MultiByteString.</span>
00614 <span class="comment"></span>
00615 <span class="comment">Return Value:</span>
00616 <span class="comment"></span>
00617 <span class="comment">    SUCCESS - The conversion was successful.</span>
00618 <span class="comment"></span>
00619 <span class="comment"></span>
00620 <span class="comment">--*/</span>
00621 
00622 {
00623     ULONG LoopCount;
00624     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a> TranslateTable;
00625     ULONG MaxCharsInUnicodeString;
00626     ULONG i;
00627 
00628     MaxCharsInUnicodeString = MaxBytesInUnicodeString / <span class="keyword">sizeof</span>(WCHAR);
00629 
00630     LoopCount = (MaxCharsInUnicodeString &lt; BytesInMultiByteString) ?
00631                  MaxCharsInUnicodeString : BytesInMultiByteString;
00632 
00633     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(BytesInUnicodeString))
00634         *BytesInUnicodeString = LoopCount * <span class="keyword">sizeof</span>(WCHAR);
00635 
00636     <span class="keywordflow">for</span> (i=0;i&lt;LoopCount;i++) {
00637         UnicodeString[i] = (WCHAR)((UCHAR)(MultiByteString[i]));
00638     }
00639 
00640     <span class="keywordflow">return</span>(STATUS_SUCCESS);
00641 }
00642 
00643 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00644"></a><a class="code" href="../../d7/d6/nlsboot_8c.html#a12">00644</a> <a class="code" href="../../d9/d6/nlsxlat_8c.html#a37">RtlUnicodeToMultiByteN</a>(
00645     OUT PCH MultiByteString,
00646     IN ULONG MaxBytesInMultiByteString,
00647     OUT PULONG BytesInMultiByteString OPTIONAL,
00648     IN PWCH UnicodeString,
00649     IN ULONG BytesInUnicodeString)
00650 
00651 <span class="comment">/*++</span>
00652 <span class="comment"></span>
00653 <span class="comment">Routine Description:</span>
00654 <span class="comment"></span>
00655 <span class="comment">    This functions converts the specified unicode source string into an</span>
00656 <span class="comment">    ansi string. The translation is done with respect to the</span>
00657 <span class="comment">    ANSI Code Page (ACP) loaded at boot time.</span>
00658 <span class="comment"></span>
00659 <span class="comment">Arguments:</span>
00660 <span class="comment"></span>
00661 <span class="comment">    MultiByteString - Returns an ansi string that is equivalent to the</span>
00662 <span class="comment">        unicode source string.  If the translation can not be done,</span>
00663 <span class="comment">        an error is returned.</span>
00664 <span class="comment"></span>
00665 <span class="comment">    MaxBytesInMultiByteString - Supplies the maximum number of bytes to be</span>
00666 <span class="comment">        written to MultiByteString.  If this causes MultiByteString to be a</span>
00667 <span class="comment">        truncated equivalent of UnicodeString, no error condition results.</span>
00668 <span class="comment"></span>
00669 <span class="comment">    BytesInMultiByteString - Returns the number of bytes in the returned</span>
00670 <span class="comment">        ansi string pointed to by MultiByteString.</span>
00671 <span class="comment"></span>
00672 <span class="comment">    UnicodeString - Supplies the unicode source string that is to be</span>
00673 <span class="comment">        converted to ansi.</span>
00674 <span class="comment"></span>
00675 <span class="comment">    BytesInUnicodeString - The number of bytes in the the string pointed to by</span>
00676 <span class="comment">        UnicodeString.</span>
00677 <span class="comment"></span>
00678 <span class="comment">Return Value:</span>
00679 <span class="comment"></span>
00680 <span class="comment">    SUCCESS - The conversion was successful</span>
00681 <span class="comment"></span>
00682 <span class="comment">--*/</span>
00683 
00684 {
00685     ULONG TmpCount;
00686     ULONG LoopCount;
00687     ULONG CharsInUnicodeString;
00688     UCHAR SbChar;
00689     WCHAR UnicodeChar;
00690     ULONG i;
00691 
00692     <span class="comment">//</span>
00693     <span class="comment">// Convert Unicode byte count to character count. Byte count of</span>
00694     <span class="comment">// multibyte string is equivalent to character count.</span>
00695     <span class="comment">//</span>
00696     CharsInUnicodeString = BytesInUnicodeString / <span class="keyword">sizeof</span>(WCHAR);
00697 
00698     LoopCount = (CharsInUnicodeString &lt; MaxBytesInMultiByteString) ?
00699                  CharsInUnicodeString : MaxBytesInMultiByteString;
00700 
00701     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(BytesInMultiByteString))
00702         *BytesInMultiByteString = LoopCount;
00703 
00704 
00705     <span class="keywordflow">for</span> (i=0;i&lt;LoopCount;i++) {
00706         MultiByteString[i] = (<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>)UnicodeString[i];
00707     }
00708 
00709     <span class="keywordflow">return</span> STATUS_SUCCESS;
00710 
00711 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:57 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
