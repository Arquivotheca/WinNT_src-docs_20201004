<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: logsup.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>logsup.c File Reference</h1><code>#include "<a class="el" href="../../d6/d4/cc_8h-source.html">cc.h</a>"</code><br>

<p>
<a href="../../d9/d4/logsup_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d5/logsup_8c.html#a0">me</a>&nbsp;&nbsp;&nbsp;0x0000040</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d5/logsup_8c.html#a1">CcSetAdditionalCacheAttributes</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN BOOLEAN DisableReadAhead, IN BOOLEAN DisableWriteBehind)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d5/logsup_8c.html#a2">CcSetLogHandleForFile</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN PVOID LogHandle, IN <a class="el" href="../../d4/d2/cache_8h.html#a23">PFLUSH_TO_LSN</a> FlushToLsnRoutine)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LARGE_INTEGER&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d5/logsup_8c.html#a3">CcGetDirtyPages</a> (IN PVOID LogHandle, IN <a class="el" href="../../d4/d2/cache_8h.html#a22">PDIRTY_PAGE_ROUTINE</a> DirtyPageRoutine, IN PVOID <a class="el" href="../../d3/d1/threads_8h.html#a107">Context1</a>, IN PVOID <a class="el" href="../../d3/d1/threads_8h.html#a108">Context2</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d5/logsup_8c.html#a4">CcIsThereDirtyData</a> (IN <a class="el" href="../../d7/d7/struct__VPB.html">PVPB</a> Vpb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LARGE_INTEGER&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d5/logsup_8c.html#a5">CcGetLsnForFileObject</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, OUT PLARGE_INTEGER OldestLsn OPTIONAL)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="logsup.c::me" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define me&nbsp;&nbsp;&nbsp;0x0000040          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d4/logsup_8c-source.html#l00028">28</a> of file <a class="el" href="../../d9/d4/logsup_8c-source.html">logsup.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a3" doxytag="logsup.c::CcGetDirtyPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LARGE_INTEGER CcGetDirtyPages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>LogHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d2/cache_8h.html#a22">PDIRTY_PAGE_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DirtyPageRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d4/logsup_8c-source.html#l00142">142</a> of file <a class="el" href="../../d9/d4/logsup_8c-source.html">logsup.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l01261">_BCB::BcbLinks</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00760">_SHARED_CACHE_MAP::BcbList</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00965">_SHARED_CACHE_MAP::BcbSpinLock</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01254">_BCB::ByteLength</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00155">CACHE_NTC_BCB</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00064">CcAcquireMasterLock</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01010">CcDecrementOpenCount</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00031">CcDirtySharedCacheMapList</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01003">CcIncrementOpenCount</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00067">CcReleaseMasterLock</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l00974">CcUnpinFileData()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00266">Context1</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00266">Context2</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01335">_BCB::Dirty</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00846">_SHARED_CACHE_MAP::DirtyPages</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00796">_SHARED_CACHE_MAP::FileObject</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01255">_BCB::FileOffset</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00832">_SHARED_CACHE_MAP::Flags</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01090">IS_CURSOR</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00918">_SHARED_CACHE_MAP::LogHandle</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01280">_BCB::NewestLsn</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01247">_BCB::NodeTypeCode</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01273">_BCB::OldestLsn</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01304">_BCB::PinCount</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01113">_SHARED_CACHE_MAP_LIST_CURSOR::SharedCacheMapLinks</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00826">_SHARED_CACHE_MAP::SharedCacheMapLinks</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d5/cc_8h.html#a211a171">UNPIN</a>, and <a class="el" href="../../d5/d5/cc_8h.html#a211a172">UNREF</a>.
<p>
<pre class="fragment"><div>00151                    :
00152 
00153     This routine may be called to <span class="keywordflow">return</span> all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dirty pages in all files
00154     <span class="keywordflow">for</span> a given log handle.  Each page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned by an individual call to
00155     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Dirty Page Routine.  The Dirty Page Routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> defined by a prototype
00156     in ntos\inc\cache.h.
00157 
00158 Arguments:
00159 
00160     LogHandle - Log <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> which must match <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log handle previously stored
00161                 <span class="keywordflow">for</span> all files which are to be returned.
00162 
00163     DirtyPageRoutine -- The routine to call as each dirty page <span class="keywordflow">for</span> <span class="keyword">this</span> log
00164                         handle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> found.
00165 
00166     <a class="code" href="../../d3/d1/threads_8h.html#a107">Context1</a> - First context parameter to be passed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Dirty Page Routine.
00167 
00168     <a class="code" href="../../d3/d1/threads_8h.html#a108">Context2</a> - First context parameter to be passed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Dirty Page Routine.
00169 
00170 Return Value:
00171 
00172     LARGE_INTEGER - Oldest Lsn found of all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dirty pages, or 0 <span class="keywordflow">if</span> no dirty pages
00173 
00174 --*/
00175 
00176 {
00177     <a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html">PSHARED_CACHE_MAP</a> SharedCacheMap;
00178     <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> Bcb, BcbToUnpin = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00179     KIRQL OldIrql;
00180     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> ExceptionStatus;
00181     LARGE_INTEGER SavedFileOffset, SavedOldestLsn, SavedNewestLsn;
00182     ULONG SavedByteLength;
00183     LARGE_INTEGER OldestLsn = {0,0};
00184 
00185     <span class="comment">//</span>
00186     <span class="comment">//  Synchronize with changes to the SharedCacheMap list.</span>
00187     <span class="comment">//</span>
00188 
00189     <a class="code" href="../../d5/d5/cc_8h.html#a0">CcAcquireMasterLock</a>( &amp;OldIrql );
00190 
00191     SharedCacheMap = CONTAINING_RECORD( <a class="code" href="../../d5/d2/cachedat_8c.html#a2">CcDirtySharedCacheMapList</a>.<a class="code" href="../../d1/d3/struct__SHARED__CACHE__MAP__LIST__CURSOR.html#o0">SharedCacheMapLinks</a>.Flink,
00192                                         <a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html">SHARED_CACHE_MAP</a>,
00193                                         SharedCacheMapLinks );
00194 
00195     <span class="comment">//</span>
00196     <span class="comment">//  Use try/finally for cleanup.  The only spot where we can raise is out of the</span>
00197     <span class="comment">//  filesystem callback, but we have the exception handler out here so we aren't</span>
00198     <span class="comment">//  constantly setting/unsetting it.</span>
00199     <span class="comment">//</span>
00200 
00201     <span class="keywordflow">try</span> {
00202 
00203         <span class="keywordflow">while</span> (&amp;SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o17">SharedCacheMapLinks</a> != &amp;<a class="code" href="../../d5/d2/cachedat_8c.html#a2">CcDirtySharedCacheMapList</a>.<a class="code" href="../../d1/d3/struct__SHARED__CACHE__MAP__LIST__CURSOR.html#o0">SharedCacheMapLinks</a>) {
00204 
00205             <span class="comment">//</span>
00206             <span class="comment">//  Skip over cursors, SharedCacheMaps for other LogHandles, and ones with</span>
00207             <span class="comment">//  no dirty pages</span>
00208             <span class="comment">//</span>
00209 
00210             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>(SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o18">Flags</a>, IS_CURSOR) &amp;&amp; (SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o30">LogHandle</a> == LogHandle) &amp;&amp;
00211                 (SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o20">DirtyPages</a> != 0)) {
00212 
00213                 <span class="comment">//</span>
00214                 <span class="comment">//  This SharedCacheMap should stick around for a while in the dirty list.</span>
00215                 <span class="comment">//</span>
00216 
00217                 <a class="code" href="../../d5/d5/cc_8h.html#a68">CcIncrementOpenCount</a>( SharedCacheMap, 'pdGS' );
00218                 SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o20">DirtyPages</a> += 1;
00219                 <a class="code" href="../../d5/d5/cc_8h.html#a1">CcReleaseMasterLock</a>( OldIrql );
00220 
00221                 <span class="comment">//</span>
00222                 <span class="comment">//  Set our initial resume point and point to first Bcb in List.</span>
00223                 <span class="comment">//</span>
00224 
00225                 ExAcquireFastLock( &amp;SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o36">BcbSpinLock</a>, &amp;OldIrql );
00226                 Bcb = CONTAINING_RECORD( SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o4">BcbList</a>.Flink, <a class="code" href="../../d4/d3/struct__BCB.html">BCB</a>, BcbLinks );
00227 
00228                 <span class="comment">//</span>
00229                 <span class="comment">//  Scan to the end of the Bcb list.</span>
00230                 <span class="comment">//</span>
00231 
00232                 <span class="keywordflow">while</span> (&amp;Bcb-&gt;<a class="code" href="../../d4/d3/struct__BCB.html#o4">BcbLinks</a> != &amp;SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o4">BcbList</a>) {
00233 
00234                     <span class="comment">//</span>
00235                     <span class="comment">//  If the Bcb is dirty, then capture the inputs for the</span>
00236                     <span class="comment">//  callback routine so we can call without holding a spinlock.</span>
00237                     <span class="comment">//</span>
00238 
00239                     <span class="keywordflow">if</span> ((Bcb-&gt;<a class="code" href="../../d4/d3/struct__BCB.html#o0">NodeTypeCode</a> == <a class="code" href="../../d5/d5/cc_8h.html#a14">CACHE_NTC_BCB</a>) &amp;&amp; Bcb-&gt;<a class="code" href="../../d4/d3/struct__BCB.html#o13">Dirty</a>) {
00240 
00241                         SavedFileOffset = Bcb-&gt;<a class="code" href="../../d4/d3/struct__BCB.html#o3">FileOffset</a>;
00242                         SavedByteLength = Bcb-&gt;<a class="code" href="../../d4/d3/struct__BCB.html#o2">ByteLength</a>;
00243                         SavedOldestLsn = Bcb-&gt;<a class="code" href="../../d4/d3/struct__BCB.html#o6">OldestLsn</a>;
00244                         SavedNewestLsn = Bcb-&gt;<a class="code" href="../../d4/d3/struct__BCB.html#o7">NewestLsn</a>;
00245 
00246                         <span class="comment">//</span>
00247                         <span class="comment">//  Increment PinCount so the Bcb sticks around</span>
00248                         <span class="comment">//</span>
00249 
00250                         Bcb-&gt;<a class="code" href="../../d4/d3/struct__BCB.html#o9">PinCount</a> += 1;
00251 
00252                         ExReleaseFastLock( &amp;SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o36">BcbSpinLock</a>, OldIrql );
00253 
00254                         <span class="comment">//</span>
00255                         <span class="comment">//  Any Bcb to unpin from a previous loop?</span>
00256                         <span class="comment">//</span>
00257 
00258                         <span class="keywordflow">if</span> (BcbToUnpin != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00259                             <a class="code" href="../../d5/d5/cc_8h.html#a176">CcUnpinFileData</a>( BcbToUnpin, TRUE, UNREF );
00260                             BcbToUnpin = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00261                         }
00262 
00263                         <span class="comment">//</span>
00264                         <span class="comment">//  Call the file system.  This callback may raise status.</span>
00265                         <span class="comment">//</span>
00266 
00267                         (*DirtyPageRoutine)( SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o10">FileObject</a>,
00268                                              &amp;SavedFileOffset,
00269                                              SavedByteLength,
00270                                              &amp;SavedOldestLsn,
00271                                              &amp;SavedNewestLsn,
00272                                              <a class="code" href="../../d3/d1/threads_8h.html#a107">Context1</a>,
00273                                              <a class="code" href="../../d3/d1/threads_8h.html#a108">Context2</a> );
00274 
00275                         <span class="comment">//</span>
00276                         <span class="comment">//  Possibly update OldestLsn</span>
00277                         <span class="comment">//</span>
00278 
00279                         <span class="keywordflow">if</span> ((SavedOldestLsn.QuadPart != 0) &amp;&amp;
00280                             ((OldestLsn.QuadPart == 0) || (SavedOldestLsn.QuadPart &lt; OldestLsn.QuadPart ))) {
00281                             OldestLsn = SavedOldestLsn;
00282                         }
00283 
00284                         <span class="comment">//</span>
00285                         <span class="comment">//  Now reacquire the spinlock and scan from the resume point</span>
00286                         <span class="comment">//  point to the next Bcb to return in the descending list.</span>
00287                         <span class="comment">//</span>
00288 
00289                         ExAcquireFastLock( &amp;SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o36">BcbSpinLock</a>, &amp;OldIrql );
00290 
00291                         <span class="comment">//</span>
00292                         <span class="comment">//  Normally the Bcb can stay around a while, but if not,</span>
00293                         <span class="comment">//  we will just remember it for the next time we do not</span>
00294                         <span class="comment">//  have the spin lock.  We cannot unpin it now, because</span>
00295                         <span class="comment">//  we would lose our place in the list.</span>
00296                         <span class="comment">//</span>
00297 
00298                         <span class="keywordflow">if</span> (Bcb-&gt;<a class="code" href="../../d4/d3/struct__BCB.html#o9">PinCount</a> &gt; 1) {
00299                             Bcb-&gt;<a class="code" href="../../d4/d3/struct__BCB.html#o9">PinCount</a> -= 1;
00300                         } <span class="keywordflow">else</span> {
00301                             BcbToUnpin = Bcb;
00302                         }
00303                     }
00304 
00305                     Bcb = CONTAINING_RECORD( Bcb-&gt;<a class="code" href="../../d4/d3/struct__BCB.html#o4">BcbLinks</a>.Flink, <a class="code" href="../../d4/d3/struct__BCB.html">BCB</a>, BcbLinks );
00306                 }
00307                 ExReleaseFastLock( &amp;SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o36">BcbSpinLock</a>, OldIrql );
00308 
00309                 <span class="comment">//</span>
00310                 <span class="comment">//  We need to unpin any Bcb we are holding before moving on to</span>
00311                 <span class="comment">//  the next SharedCacheMap, or else CcDeleteSharedCacheMap will</span>
00312                 <span class="comment">//  also delete this Bcb.</span>
00313                 <span class="comment">//</span>
00314 
00315                 <span class="keywordflow">if</span> (BcbToUnpin != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00316 
00317                     <a class="code" href="../../d5/d5/cc_8h.html#a176">CcUnpinFileData</a>( BcbToUnpin, TRUE, UNREF );
00318                     BcbToUnpin = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00319                 }
00320 
00321                 <a class="code" href="../../d5/d5/cc_8h.html#a0">CcAcquireMasterLock</a>( &amp;OldIrql );
00322 
00323                 <span class="comment">//</span>
00324                 <span class="comment">//  Now release the SharedCacheMap, leaving it in the dirty list.</span>
00325                 <span class="comment">//</span>
00326 
00327                 <a class="code" href="../../d5/d5/cc_8h.html#a69">CcDecrementOpenCount</a>( SharedCacheMap, 'pdGF' );
00328                 SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o20">DirtyPages</a> -= 1;
00329             }
00330 
00331             <span class="comment">//</span>
00332             <span class="comment">//  Now loop back for the next cache map.</span>
00333             <span class="comment">//</span>
00334 
00335             SharedCacheMap =
00336                 CONTAINING_RECORD( SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o17">SharedCacheMapLinks</a>.Flink,
00337                                    <a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html">SHARED_CACHE_MAP</a>,
00338                                    SharedCacheMapLinks );
00339         }
00340 
00341         <a class="code" href="../../d5/d5/cc_8h.html#a1">CcReleaseMasterLock</a>( OldIrql );
00342 
00343     } finally {
00344 
00345         <span class="comment">//</span>
00346         <span class="comment">//  Drop the Bcb if we are being ejected.  We are guaranteed that the</span>
00347         <span class="comment">//  only raise is from the callback, at which point we have an incremented</span>
00348         <span class="comment">//  pincount.</span>
00349         <span class="comment">//</span>
00350 
00351         <span class="keywordflow">if</span> (AbnormalTermination()) {
00352 
00353             <a class="code" href="../../d5/d5/cc_8h.html#a176">CcUnpinFileData</a>( Bcb, TRUE, UNPIN );
00354         }
00355     }
00356 
00357     <span class="keywordflow">return</span> OldestLsn;
00358 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="logsup.c::CcGetLsnForFileObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LARGE_INTEGER CcGetLsnForFileObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PLARGE_INTEGER OldestLsn&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d4/logsup_8c-source.html#l00450">450</a> of file <a class="el" href="../../d9/d4/logsup_8c-source.html">logsup.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l01261">_BCB::BcbLinks</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00760">_SHARED_CACHE_MAP::BcbList</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00965">_SHARED_CACHE_MAP::BcbSpinLock</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00155">CACHE_NTC_BCB</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01335">_BCB::Dirty</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01280">_BCB::NewestLsn</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01247">_BCB::NodeTypeCode</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d6/d4/cc_8h-source.html#l01273">_BCB::OldestLsn</a>.
<p>
<pre class="fragment"><div>00457                    :
00458 
00459     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>  oldest and newest LSNs <span class="keywordflow">for</span> a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.
00460 
00461 Arguments:
00462 
00463     FileObject - <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> <span class="keywordflow">for</span> which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log handle should be stored.
00464 
00465     OldestLsn - pointer to location to store oldest <a class="code" href="../../d6/d3/lfs_8h.html#a10">LSN</a> <span class="keywordflow">for</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.
00466 
00467 Return Value:
00468 
00469     The newest <a class="code" href="../../d6/d3/lfs_8h.html#a10">LSN</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.
00470 
00471 --*/
00472 
00473 {
00474     <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> Bcb;
00475     KIRQL OldIrql;
00476     LARGE_INTEGER Oldest, Newest;
00477     <a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html">PSHARED_CACHE_MAP</a> SharedCacheMap = FileObject-&gt;SectionObjectPointer-&gt;SharedCacheMap;
00478 
00479     <span class="comment">//</span>
00480     <span class="comment">// initialize lsn variables</span>
00481     <span class="comment">//</span>
00482 
00483     Oldest.LowPart = 0;
00484     Oldest.HighPart = 0;
00485     Newest.LowPart = 0;
00486     Newest.HighPart = 0;
00487 
00488     <span class="keywordflow">if</span>(SharedCacheMap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00489         <span class="keywordflow">return</span> Oldest;
00490     }
00491 
00492     ExAcquireFastLock(&amp;SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o36">BcbSpinLock</a>, &amp;OldIrql);
00493 
00494     <span class="comment">//</span>
00495     <span class="comment">//  Now point to first Bcb in List, and loop through it.</span>
00496     <span class="comment">//</span>
00497 
00498     Bcb = CONTAINING_RECORD( SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o4">BcbList</a>.Flink, <a class="code" href="../../d4/d3/struct__BCB.html">BCB</a>, BcbLinks );
00499 
00500     <span class="keywordflow">while</span> (&amp;Bcb-&gt;<a class="code" href="../../d4/d3/struct__BCB.html#o4">BcbLinks</a> != &amp;SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o4">BcbList</a>) {
00501 
00502         <span class="comment">//</span>
00503         <span class="comment">//  If the Bcb is dirty then capture the oldest and newest lsn</span>
00504         <span class="comment">//</span>
00505 
00506 
00507         <span class="keywordflow">if</span> ((Bcb-&gt;<a class="code" href="../../d4/d3/struct__BCB.html#o0">NodeTypeCode</a> == <a class="code" href="../../d5/d5/cc_8h.html#a14">CACHE_NTC_BCB</a>) &amp;&amp; Bcb-&gt;<a class="code" href="../../d4/d3/struct__BCB.html#o13">Dirty</a>) {
00508 
00509             LARGE_INTEGER BcbLsn, BcbNewest;
00510 
00511             BcbLsn = Bcb-&gt;<a class="code" href="../../d4/d3/struct__BCB.html#o6">OldestLsn</a>;
00512             BcbNewest = Bcb-&gt;<a class="code" href="../../d4/d3/struct__BCB.html#o7">NewestLsn</a>;
00513 
00514             <span class="keywordflow">if</span> ((BcbLsn.QuadPart != 0) &amp;&amp;
00515                 ((Oldest.QuadPart == 0) ||
00516                  (BcbLsn.QuadPart &lt; Oldest.QuadPart))) {
00517 
00518                  Oldest = BcbLsn;
00519             }
00520 
00521             <span class="keywordflow">if</span> ((BcbLsn.QuadPart != 0) &amp;&amp; (BcbNewest.QuadPart &gt; Newest.QuadPart)) {
00522 
00523                 Newest = BcbNewest;
00524             }
00525         }
00526 
00527 
00528         Bcb = CONTAINING_RECORD( Bcb-&gt;<a class="code" href="../../d4/d3/struct__BCB.html#o4">BcbLinks</a>.Flink, <a class="code" href="../../d4/d3/struct__BCB.html">BCB</a>, BcbLinks );
00529     }
00530 
00531     <span class="comment">//</span>
00532     <span class="comment">//  Now release the spin lock for this Bcb list and generate a callback</span>
00533     <span class="comment">//  if we got something.</span>
00534     <span class="comment">//</span>
00535 
00536     ExReleaseFastLock( &amp;SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o36">BcbSpinLock</a>, OldIrql );
00537 
00538     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(OldestLsn)) {
00539 
00540         *OldestLsn = Oldest;
00541     }
00542 
00543     <span class="keywordflow">return</span> Newest;
00544 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="logsup.c::CcIsThereDirtyData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CcIsThereDirtyData           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__VPB.html">PVPB</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Vpb</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d4/logsup_8c-source.html#l00362">362</a> of file <a class="el" href="../../d9/d4/logsup_8c-source.html">logsup.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00064">CcAcquireMasterLock</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00031">CcDirtySharedCacheMapList</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00067">CcReleaseMasterLock</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00846">_SHARED_CACHE_MAP::DirtyPages</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00796">_SHARED_CACHE_MAP::FileObject</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00832">_SHARED_CACHE_MAP::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01533">_FILE_OBJECT::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01505">FO_TEMPORARY_FILE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01090">IS_CURSOR</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01113">_SHARED_CACHE_MAP_LIST_CURSOR::SharedCacheMapLinks</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00826">_SHARED_CACHE_MAP::SharedCacheMapLinks</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01518">_FILE_OBJECT::Vpb</a>, and <a class="el" href="../../d6/d4/cc_8h-source.html#l01051">WRITE_QUEUED</a>.
<p>
<pre class="fragment"><div>00368                    :
00369 
00370     This routine returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified Vcb has any unwritten dirty
00371     data in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cache.
00372 
00373 Arguments:
00374 
00375     Vpb - specifies Vpb to check <span class="keywordflow">for</span>
00376 
00377 Return Value:
00378 
00379     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Vpb has no dirty data
00380     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Vpb has dirty data
00381 
00382 --*/
00383 
00384 {
00385     <a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html">PSHARED_CACHE_MAP</a> SharedCacheMap;
00386     KIRQL OldIrql;
00387     ULONG LoopsWithLockHeld = 0;
00388 
00389     <span class="comment">//</span>
00390     <span class="comment">//  Synchronize with changes to the SharedCacheMap list.</span>
00391     <span class="comment">//</span>
00392 
00393     <a class="code" href="../../d5/d5/cc_8h.html#a0">CcAcquireMasterLock</a>( &amp;OldIrql );
00394 
00395     SharedCacheMap = CONTAINING_RECORD( <a class="code" href="../../d5/d2/cachedat_8c.html#a2">CcDirtySharedCacheMapList</a>.<a class="code" href="../../d1/d3/struct__SHARED__CACHE__MAP__LIST__CURSOR.html#o0">SharedCacheMapLinks</a>.Flink,
00396                                         <a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html">SHARED_CACHE_MAP</a>,
00397                                         SharedCacheMapLinks );
00398 
00399     <span class="keywordflow">while</span> (&amp;SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o17">SharedCacheMapLinks</a> != &amp;<a class="code" href="../../d5/d2/cachedat_8c.html#a2">CcDirtySharedCacheMapList</a>.<a class="code" href="../../d1/d3/struct__SHARED__CACHE__MAP__LIST__CURSOR.html#o0">SharedCacheMapLinks</a>) {
00400 
00401         <span class="comment">//</span>
00402         <span class="comment">//  Look at this one if the Vpb matches and if there is dirty data.</span>
00403         <span class="comment">//  For what it's worth, don't worry about dirty data in temporary files,</span>
00404         <span class="comment">//  as that should not concern the caller if it wants to dismount.</span>
00405         <span class="comment">//</span>
00406 
00407         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>(SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o18">Flags</a>, IS_CURSOR) &amp;&amp;
00408             (SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o10">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o3">Vpb</a> == Vpb) &amp;&amp;
00409             (SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o20">DirtyPages</a> != 0) &amp;&amp;
00410             !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>(SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o10">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a>, FO_TEMPORARY_FILE)) {
00411 
00412             <a class="code" href="../../d5/d5/cc_8h.html#a1">CcReleaseMasterLock</a>( OldIrql );
00413             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00414         }
00415 
00416         <span class="comment">//</span>
00417         <span class="comment">//  Make sure we occassionally drop the lock.  Set WRITE_QUEUED</span>
00418         <span class="comment">//  to keep the guy from going away, and increment DirtyPages to</span>
00419         <span class="comment">//  keep in in this list.</span>
00420         <span class="comment">//</span>
00421 
00422         <span class="keywordflow">if</span> ((++LoopsWithLockHeld &gt;= 20) &amp;&amp;
00423             !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>(SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o18">Flags</a>, WRITE_QUEUED | IS_CURSOR)) {
00424 
00425             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( (<span class="keyword">volatile</span> ULONG) SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o18">Flags</a>, WRITE_QUEUED);
00426             (<span class="keyword">volatile</span> ULONG) SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o20">DirtyPages</a> += 1;
00427             <a class="code" href="../../d5/d5/cc_8h.html#a1">CcReleaseMasterLock</a>( OldIrql );
00428             LoopsWithLockHeld = 0;
00429             <a class="code" href="../../d5/d5/cc_8h.html#a0">CcAcquireMasterLock</a>( &amp;OldIrql );
00430             <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( (<span class="keyword">volatile</span> ULONG) SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o18">Flags</a>, WRITE_QUEUED);
00431             (<span class="keyword">volatile</span> ULONG) SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o20">DirtyPages</a> -= 1;
00432         }
00433 
00434         <span class="comment">//</span>
00435         <span class="comment">//  Now loop back for the next cache map.</span>
00436         <span class="comment">//</span>
00437 
00438         SharedCacheMap =
00439             CONTAINING_RECORD( SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o17">SharedCacheMapLinks</a>.Flink,
00440                                <a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html">SHARED_CACHE_MAP</a>,
00441                                SharedCacheMapLinks );
00442     }
00443 
00444     <a class="code" href="../../d5/d5/cc_8h.html#a1">CcReleaseMasterLock</a>( OldIrql );
00445 
00446     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00447 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="logsup.c::CcSetAdditionalCacheAttributes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CcSetAdditionalCacheAttributes           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>DisableReadAhead</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>DisableWriteBehind</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d4/logsup_8c-source.html#l00032">32</a> of file <a class="el" href="../../d9/d4/logsup_8c-source.html">logsup.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00064">CcAcquireMasterLock</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00067">CcReleaseMasterLock</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01025">DISABLE_READ_AHEAD</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01031">DISABLE_WRITE_BEHIND</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00832">_SHARED_CACHE_MAP::Flags</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01077">MODIFIED_WRITE_DISABLED</a>, and <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00150">LfsInitializeLogFile()</a>, and <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00366">LfsOpenLogFile()</a>.
<p>
<pre class="fragment"><div>00040                    :
00041 
00042     This routine supports <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> setting of disable read ahead or disable write
00043     behind flags to <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> Cache <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a79">Manager</a> operation.  This routine may be
00044     called any time after calling <a class="code" href="../../d5/d8/fssup_8c.html#a9">CcInitializeCacheMap</a>.  Initially both
00045     read ahead and write behind are enabled.  Note that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state of both
00046     of these flags must be specified on each call to <span class="keyword">this</span> routine.
00047 
00048 Arguments:
00049 
00050     FileObject - <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> object <span class="keywordflow">for</span> which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> respective flags are to be set.
00051 
00052     DisableReadAhead - <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> to enable read ahead, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> to disable <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
00053 
00054     DisableWriteBehind - <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> to enable write behind, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> to disable <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
00055 
00056 Return Value:
00057 
00058     None.
00059 
00060 --*/
00061 
00062 {
00063     <a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html">PSHARED_CACHE_MAP</a> SharedCacheMap;
00064     KIRQL OldIrql;
00065 
00066     <span class="comment">//</span>
00067     <span class="comment">//  Get pointer to SharedCacheMap.</span>
00068     <span class="comment">//</span>
00069 
00070     SharedCacheMap = FileObject-&gt;SectionObjectPointer-&gt;SharedCacheMap;
00071 
00072     <span class="comment">//</span>
00073     <span class="comment">//  Now set the flags and return.</span>
00074     <span class="comment">//</span>
00075 
00076     <a class="code" href="../../d5/d5/cc_8h.html#a0">CcAcquireMasterLock</a>( &amp;OldIrql );
00077     <span class="keywordflow">if</span> (DisableReadAhead) {
00078         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>(SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o18">Flags</a>, DISABLE_READ_AHEAD);
00079     } <span class="keywordflow">else</span> {
00080         <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>(SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o18">Flags</a>, DISABLE_READ_AHEAD);
00081     }
00082     <span class="keywordflow">if</span> (DisableWriteBehind) {
00083         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>(SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o18">Flags</a>, DISABLE_WRITE_BEHIND | MODIFIED_WRITE_DISABLED);
00084     } <span class="keywordflow">else</span> {
00085         <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>(SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o18">Flags</a>, DISABLE_WRITE_BEHIND);
00086     }
00087     <a class="code" href="../../d5/d5/cc_8h.html#a1">CcReleaseMasterLock</a>( OldIrql );
00088 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="logsup.c::CcSetLogHandleForFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CcSetLogHandleForFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>LogHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d2/cache_8h.html#a23">PFLUSH_TO_LSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FlushToLsnRoutine</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d4/logsup_8c-source.html#l00092">92</a> of file <a class="el" href="../../d9/d4/logsup_8c-source.html">logsup.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00924">_SHARED_CACHE_MAP::FlushToLsnRoutine</a>, and <a class="el" href="../../d6/d4/cc_8h-source.html#l00918">_SHARED_CACHE_MAP::LogHandle</a>.
<p>
<pre class="fragment"><div>00100                    :
00101 
00102     This routine may be called to instruct <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Cache <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a79">Manager</a> to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00103     specified log handle with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> shared cache map <span class="keywordflow">for</span> a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>, to support
00104     subsequent calls to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> other <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> in <span class="keyword">this</span> module which effectively
00105     perform an associative search <span class="keywordflow">for</span> files by log handle.
00106 
00107 Arguments:
00108 
00109     FileObject - <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> <span class="keywordflow">for</span> which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log handle should be stored.
00110 
00111     LogHandle - Log <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> to store.
00112 
00113     FlushToLsnRoutine - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> routine to call before flushing buffers <span class="keywordflow">for</span> <span class="keyword">this</span>
00114                         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>, to insure a log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> flushed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> most
00115                         recent Lsn <span class="keywordflow">for</span> any Bcb being flushed.
00116 
00117 Return Value:
00118 
00119     None.
00120 
00121 --*/
00122 
00123 {
00124     <a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html">PSHARED_CACHE_MAP</a> SharedCacheMap;
00125 
00126     <span class="comment">//</span>
00127     <span class="comment">//  Get pointer to SharedCacheMap.</span>
00128     <span class="comment">//</span>
00129 
00130     SharedCacheMap = FileObject-&gt;SectionObjectPointer-&gt;SharedCacheMap;
00131 
00132     <span class="comment">//</span>
00133     <span class="comment">//  Now set the log file handle and flush routine</span>
00134     <span class="comment">//</span>
00135 
00136     SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o30">LogHandle</a> = LogHandle;
00137     SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o31">FlushToLsnRoutine</a> = FlushToLsnRoutine;
00138 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:33 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
