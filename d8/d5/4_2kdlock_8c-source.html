<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: kdlock.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>kdlock.c</h1><a href="../../d7/d6/4_2kdlock_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1992  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    kdlock.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains code to synchronize the usage of the port</span>
00012 <span class="comment">    used by the kernel debugger.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Bryan M. Willman (bryanwi) 24-Sep-90</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include "<a class="code" href="../../d1/d7/4_2kdp_8h.html">kdp.h</a>"</span>
00023 
00024 
00025 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00026"></a><a class="code" href="../../d7/d6/4_2kdlock_8c.html#a0">00026</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a145">KdpPortLock</a>(
00027     VOID
00028     )
00029 
00030 <span class="comment">/*++</span>
00031 <span class="comment"></span>
00032 <span class="comment">Routine Description:</span>
00033 <span class="comment"></span>
00034 <span class="comment">    Acquire the spinlock for the debug port.</span>
00035 <span class="comment"></span>
00036 <span class="comment">    Note that user must call this explicitly, the get/put routines</span>
00037 <span class="comment">    do NOT make any use of the lock.</span>
00038 <span class="comment"></span>
00039 <span class="comment">    CALLER MUST HAVE SET PROPER IRQL BEFORE CALLING US.</span>
00040 <span class="comment"></span>
00041 <span class="comment">    We use KiAcquireSpinLock and NOT Ke... because our IRQL may</span>
00042 <span class="comment">    be above DISPATCH_LEVEL.</span>
00043 <span class="comment"></span>
00044 <span class="comment">Arguments:</span>
00045 <span class="comment"></span>
00046 <span class="comment">    None.</span>
00047 <span class="comment"></span>
00048 <span class="comment">Return value:</span>
00049 <span class="comment"></span>
00050 <span class="comment">    None.</span>
00051 <span class="comment"></span>
00052 <span class="comment">--*/</span>
00053 
00054 {
00055     KiAcquireSpinLock(&amp;<a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a9">KdpDebuggerLock</a>);
00056 }
00057 
00058 
00059 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00060"></a><a class="code" href="../../d7/d6/4_2kdlock_8c.html#a1">00060</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a146">KdpPortUnlock</a>(
00061     VOID
00062     )
00063 
00064 <span class="comment">/*++</span>
00065 <span class="comment"></span>
00066 <span class="comment">Routine Description:</span>
00067 <span class="comment"></span>
00068 <span class="comment">    Release the spinlock for the debug port.</span>
00069 <span class="comment"></span>
00070 <span class="comment">    Note that user must call this explicitly, the get/put routines</span>
00071 <span class="comment">    do NOT make any use of the lock.</span>
00072 <span class="comment"></span>
00073 <span class="comment">    CALLER MUST HAVE SET PROPER IRQL BEFORE CALLING US.</span>
00074 <span class="comment"></span>
00075 <span class="comment">    We use KiReleaseSpinLock and NOT Ke... because our IRQL may</span>
00076 <span class="comment">    be above DISPATCH_LEVEL.</span>
00077 <span class="comment"></span>
00078 <span class="comment">Arguments:</span>
00079 <span class="comment"></span>
00080 <span class="comment">    None.</span>
00081 <span class="comment"></span>
00082 <span class="comment">Return value:</span>
00083 <span class="comment"></span>
00084 <span class="comment">    None.</span>
00085 <span class="comment"></span>
00086 <span class="comment">--*/</span>
00087 
00088 {
00089     KiReleaseSpinLock(&amp;<a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a9">KdpDebuggerLock</a>);
00090 }
00091 
00092 BOOLEAN
<a name="l00093"></a><a class="code" href="../../d7/d6/4_2kdlock_8c.html#a2">00093</a> <a class="code" href="../../d7/d6/4_2kdlock_8c.html#a2">KdPollBreakIn</a>(
00094     VOID
00095     )
00096 
00097 <span class="comment">/*++</span>
00098 <span class="comment"></span>
00099 <span class="comment">Routine Description:</span>
00100 <span class="comment"></span>
00101 <span class="comment">    This procedure raises IRQL to high_level, seizes the Debug port</span>
00102 <span class="comment">    spinlock, and checks to see if a breakin packet is pending.</span>
00103 <span class="comment">    If a packet is present, return TRUE, else FALSE.</span>
00104 <span class="comment"></span>
00105 <span class="comment">    A packet is present if:</span>
00106 <span class="comment"></span>
00107 <span class="comment">    There is a valid character which matches BREAK_CHAR.</span>
00108 <span class="comment"></span>
00109 <span class="comment">    N.B.    Interrupts must be OFF around this call</span>
00110 <span class="comment"></span>
00111 <span class="comment">Return Value:</span>
00112 <span class="comment"></span>
00113 <span class="comment">    TRUE if breakin sequence present, caller should execute int-3.</span>
00114 <span class="comment">    FALSE if no breakin seen.</span>
00115 <span class="comment"></span>
00116 <span class="comment">--*/</span>
00117 
00118 {
00119     BOOLEAN BreakIn;
00120     BOOLEAN Enable;
00121     UCHAR   Input;
00122     KIRQL   OldIrql;
00123     ULONG   <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00124 
00125     <span class="comment">//</span>
00126     <span class="comment">// If the debugger is enabled, see if a breakin by the kernel</span>
00127     <span class="comment">// debugger is pending.</span>
00128     <span class="comment">//</span>
00129 
00130     BreakIn = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00131     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/kd_8h.html#a13">KdDebuggerEnabled</a> != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00132         Enable = <a class="code" href="../../d0/d0/ki_8h.html#a106">KiDisableInterrupts</a>();
00133 <span class="preprocessor">#ifndef _X86_</span>
00134 <span class="preprocessor"></span>        <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a57">HIGH_LEVEL</a>, &amp;OldIrql);
00135 <span class="preprocessor">#endif</span>
00136 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a89">KdpControlCPending</a> != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00137             <a class="code" href="../../d8/d5/kddata_8c.html#a90">KdpControlCPressed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00138             BreakIn = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00139             <a class="code" href="../../d8/d5/kddata_8c.html#a89">KdpControlCPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00140 
00141         } <span class="keywordflow">else</span> {
00142             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/ki_8h.html#a155">KiTryToAcquireSpinLock</a>(&amp;<a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a9">KdpDebuggerLock</a>) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00143                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d7/hal_8h.html#a201">KdPortPollByte</a>(&amp;Input);
00144                 <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d7/d3/kd_8h.html#a0">CP_GET_SUCCESS</a>) &amp;&amp;
00145                     (Input == BREAKIN_PACKET_BYTE)) {
00146                     BreakIn = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00147                     <a class="code" href="../../d8/d5/kddata_8c.html#a90">KdpControlCPressed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00148                 }
00149 
00150                 <a class="code" href="../../d1/d7/4_2kdp_8h.html#a146">KdpPortUnlock</a>();
00151             }
00152         }
00153 
00154 <span class="preprocessor">#ifndef _X86_</span>
00155 <span class="preprocessor"></span>        <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00156 <span class="preprocessor">#endif</span>
00157 <span class="preprocessor"></span>        <a class="code" href="../../d0/d0/ki_8h.html#a107">KiRestoreInterrupts</a>(Enable);
00158     }
00159 
00160     <span class="keywordflow">return</span> BreakIn;
00161 }
00162 
00163 
00164 BOOLEAN
<a name="l00165"></a><a class="code" href="../../d7/d6/4_2kdlock_8c.html#a3">00165</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a147">KdpPollBreakInWithPortLock</a>(
00166     VOID
00167     )
00168 
00169 <span class="comment">/*++</span>
00170 <span class="comment"></span>
00171 <span class="comment">Routine Description:</span>
00172 <span class="comment"></span>
00173 <span class="comment">    This procedure same as KdPollBreakIn, but assumes the caller</span>
00174 <span class="comment">    already holds the port lock.  Returns TRUE if a breakin packet</span>
00175 <span class="comment">    is pending.</span>
00176 <span class="comment"></span>
00177 <span class="comment">    A packet is present if:</span>
00178 <span class="comment"></span>
00179 <span class="comment">    There is a valid character which matches BREAK_CHAR.</span>
00180 <span class="comment"></span>
00181 <span class="comment">    N.B.    Interrupts must be OFF around this call</span>
00182 <span class="comment"></span>
00183 <span class="comment">Return Value:</span>
00184 <span class="comment"></span>
00185 <span class="comment">    TRUE if breakin sequence present, caller should execute int-3.</span>
00186 <span class="comment">    FALSE if no breakin seen.</span>
00187 <span class="comment"></span>
00188 <span class="comment">--*/</span>
00189 
00190 {
00191 
00192     BOOLEAN BreakIn;
00193     BOOLEAN Enable;
00194     UCHAR Input;
00195     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00196 
00197     <span class="comment">//</span>
00198     <span class="comment">// If the debugger is enabled, see if a breakin by the kernel</span>
00199     <span class="comment">// debugger is pending.</span>
00200     <span class="comment">//</span>
00201 
00202     BreakIn = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00203     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/kd_8h.html#a13">KdDebuggerEnabled</a> != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00204         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a89">KdpControlCPending</a> != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00205             BreakIn = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00206             <a class="code" href="../../d8/d5/kddata_8c.html#a89">KdpControlCPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00207 
00208         } <span class="keywordflow">else</span> {
00209             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d7/hal_8h.html#a201">KdPortPollByte</a>(&amp;Input);
00210             <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d7/d3/kd_8h.html#a0">CP_GET_SUCCESS</a>) &amp;&amp;
00211                 (Input == BREAKIN_PACKET_BYTE)) {
00212                 BreakIn = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00213             }
00214         }
00215     }
00216 
00217     <span class="keywordflow">return</span> BreakIn;
00218 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:34 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
