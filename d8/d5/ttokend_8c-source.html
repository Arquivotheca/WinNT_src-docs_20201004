<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ttokend.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ttokend.c</h1><a href="../../d7/d6/ttokend_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    tmachine.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module tests token duplication.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Jim Kelly    (JimK) 8-Feb-1994</span>
00016 <span class="comment"></span>
00017 <span class="comment">Environment:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    User Mode - Win32</span>
00020 <span class="comment"></span>
00021 <span class="comment">Revision History:</span>
00022 <span class="comment"></span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 
00027 
00028 
00029 
00030 
00031 
00033 <span class="comment">//                                                                           //</span>
00034 <span class="comment">// Includes                                                                  //</span>
00035 <span class="comment">//                                                                           //</span>
00037 <span class="comment"></span>
00038 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00039 <span class="preprocessor">#include &lt;nt.h&gt;</span>
00040 <span class="preprocessor">#include &lt;ntsam.h&gt;</span>
00041 <span class="preprocessor">#include &lt;ntsamp.h&gt;</span>
00042 <span class="preprocessor">#include &lt;ntlsa.h&gt;</span>
00043 <span class="preprocessor">#include &lt;ntrpcp.h&gt;</span>     <span class="comment">// prototypes for MIDL user functions</span>
00044 <span class="preprocessor">#include &lt;seopaque.h&gt;</span>
00045 <span class="preprocessor">#include &lt;string.h&gt;</span>
00046 
00047 
00048 
00049 <span class="preprocessor">#ifdef NOT_PART_OF_PROGRAM</span>
00050 <span class="preprocessor"></span>
00051 
00053 <span class="comment">//                                                                           //</span>
00054 <span class="comment">// Definitions                                                               //</span>
00055 <span class="comment">//                                                                           //</span>
00057 <span class="comment"></span>
00058 
00059 
00060 
00061 
00062 <span class="preprocessor">#define TMPP_USER_NAME_ADMIN           "Administrator"</span>
00063 <span class="preprocessor"></span><span class="preprocessor">#define TMPP_USER_NAME_GUEST           "Guest"</span>
00064 <span class="preprocessor"></span><span class="preprocessor">#define TMPP_GROUP_NAME_ADMINS         "Domain Admins"</span>
00065 <span class="preprocessor"></span><span class="preprocessor">#define TMPP_GROUP_NAME_USERS          "Domain Users"</span>
00066 <span class="preprocessor"></span><span class="preprocessor">#define TMPP_GROUP_NAME_NONE           "None"</span>
00067 <span class="preprocessor"></span><span class="preprocessor">#define TMPP_ALIAS_NAME_ADMINS         "Administrators"</span>
00068 <span class="preprocessor"></span><span class="preprocessor">#define TMPP_ALIAS_NAME_SYSTEM_OPS     "System Operators"</span>
00069 <span class="preprocessor"></span><span class="preprocessor">#define TMPP_ALIAS_NAME_POWER_USERS    "Power Users"</span>
00070 <span class="preprocessor"></span><span class="preprocessor">#define TMPP_ALIAS_NAME_USERS          "Users"</span>
00071 <span class="preprocessor"></span><span class="preprocessor">#define TMPP_ALIAS_NAME_GUESTS         "Guests"</span>
00072 <span class="preprocessor"></span><span class="preprocessor">#define TMPP_ALIAS_NAME_ACCOUNT_OPS    "Account Operators"</span>
00073 <span class="preprocessor"></span><span class="preprocessor">#define TMPP_ALIAS_NAME_PRINT_OPS      "Print Operators"</span>
00074 <span class="preprocessor"></span><span class="preprocessor">#define TMPP_ALIAS_NAME_BACKUP_OPS     "Backup Operators"</span>
00075 <span class="preprocessor"></span>
00076 
00077 
00078 <span class="preprocessor">#define GROUP_NAME1             "GROUP1"</span>
00079 <span class="preprocessor"></span><span class="preprocessor">#define ALIAS_NAME1             "ALIAS1"</span>
00080 <span class="preprocessor"></span><span class="preprocessor">#define ALIAS_NAME2             "ALIAS2"</span>
00081 <span class="preprocessor"></span><span class="preprocessor">#define USER_NAME1              "USER1"</span>
00082 <span class="preprocessor"></span><span class="preprocessor">#define USER_NAME2              "USER2"</span>
00083 <span class="preprocessor"></span><span class="preprocessor">#define USER_NAME3              "USER3"</span>
00084 <span class="preprocessor"></span>
00085 <span class="comment">// Keep these names not longer than 8 char's until long registry names supported</span>
00086 <span class="preprocessor">#define DUMMY_NAME1             "DName1"</span>
00087 <span class="preprocessor"></span><span class="preprocessor">#define DUMMY_NAME2             "2emaNuD"</span>
00088 <span class="preprocessor"></span>
00089 <span class="preprocessor">#define DUMMY_STRING1           "This is test string 1"</span>
00090 <span class="preprocessor"></span><span class="preprocessor">#define DUMMY_STRING2           "Test String2 - test string 2 - tEST sTRING 2"</span>
00091 <span class="preprocessor"></span>
00092 <span class="preprocessor">#define ALL_NAMES_COUNT         (3)</span>
00093 <span class="preprocessor"></span><span class="preprocessor">#define SOME_NAMES_COUNT        (7)</span>
00094 <span class="preprocessor"></span><span class="preprocessor">#define NO_NAMES_COUNT          (2)</span>
00095 <span class="preprocessor"></span>
00096 <span class="preprocessor">#define LOOKUP_KNOWN_NAME0      TMPP_USER_NAME_ADMIN</span>
00097 <span class="preprocessor"></span><span class="preprocessor">#define LOOKUP_KNOWN_NAME1_A    TMPP_GROUP_NAME_NONE</span>
00098 <span class="preprocessor"></span><span class="preprocessor">#define LOOKUP_KNOWN_NAME2_A    TMPP_GROUP_NAME_NONE</span>
00099 <span class="preprocessor"></span><span class="preprocessor">#define LOOKUP_KNOWN_NAME1_P    TMPP_GROUP_NAME_USERS</span>
00100 <span class="preprocessor"></span><span class="preprocessor">#define LOOKUP_KNOWN_NAME2_P    TMPP_GROUP_NAME_USERS</span>
00101 <span class="preprocessor"></span>
00102 <span class="preprocessor">#define LOOKUP_KNOWN_NAME0_RID  DOMAIN_USER_RID_ADMIN</span>
00103 <span class="preprocessor"></span><span class="preprocessor">#define LOOKUP_KNOWN_NAME1_RID  DOMAIN_GROUP_RID_USERS</span>
00104 <span class="preprocessor"></span><span class="preprocessor">#define LOOKUP_KNOWN_NAME2_RID  DOMAIN_GROUP_RID_USERS</span>
00105 <span class="preprocessor"></span>
00106 <span class="preprocessor">#define LOOKUP_UNKNOWN_NAME0    "JoeJoe"</span>
00107 <span class="preprocessor"></span><span class="preprocessor">#define LOOKUP_UNKNOWN_NAME1    "Tanya"</span>
00108 <span class="preprocessor"></span><span class="preprocessor">#define LOOKUP_UNKNOWN_NAME2    "Fred"</span>
00109 <span class="preprocessor"></span><span class="preprocessor">#define LOOKUP_UNKNOWN_NAME3    "Anyone"</span>
00110 <span class="preprocessor"></span>
00111 <span class="preprocessor">#define LOOKUP_KNOWN_NAME0_USE  (SidTypeUser)</span>
00112 <span class="preprocessor"></span><span class="preprocessor">#define LOOKUP_KNOWN_NAME1_USE  (SidTypeGroup)</span>
00113 <span class="preprocessor"></span><span class="preprocessor">#define LOOKUP_KNOWN_NAME2_USE  (SidTypeGroup)</span>
00114 <span class="preprocessor"></span>
00115 
00116 <span class="comment">//</span>
00117 <span class="comment">// This byte is expected to be different in the DummyLogonHours and</span>
00118 <span class="comment">// NoRestrictionLogonHours.</span>
00119 <span class="comment">//</span>
00120 
00121 <span class="preprocessor">#define LOGON_HOURS_DIFFERENT_OFFSET    (5)</span>
00122 <span class="preprocessor"></span>
00123 
00124 
00126 <span class="comment">//                                                                           //</span>
00127 <span class="comment">// Global variables                                                          //</span>
00128 <span class="comment">//                                                                           //</span>
00130 <span class="comment"></span>
00131 LARGE_INTEGER LargeInteger1,
00132               LargeInteger2;
00133 
00134 UNICODE_STRING DummyName1,
00135                DummyName2,
00136                DummyString1,
00137                DummyString2;
00138 
00139 STRING         DummyAnsiString1,
00140                DummyAnsiString2;
00141 
00142 LOGON_HOURS    NoLogonRestriction,
00143                DummyLogonHours;
00144 
00145 <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>           NoLogonRestrictionBitMask[21],
00146                DummyLogonHoursBitMask[21];
00147 
00148 
00149 UNICODE_STRING  AllNames[ALL_NAMES_COUNT],
00150                 SomeNames[SOME_NAMES_COUNT],
00151                 NoNames[NO_NAMES_COUNT];
00152 
00153 
00154 SID_NAME_USE    AllUses[ALL_NAMES_COUNT],
00155                 SomeUses[SOME_NAMES_COUNT],
00156                 NoUses[NO_NAMES_COUNT];
00157 
00158 ULONG           AllRids[ALL_NAMES_COUNT],
00159                 SomeRids[SOME_NAMES_COUNT],
00160                 NoRids[NO_NAMES_COUNT];
00161 
00162 
00163 PSID            BuiltinDomainSid,
00164                 AccountDomainSid,
00165                 PrimaryDomainSid,
00166                 <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>,
00167                 AdminsAliasSid,
00168                 AccountAliasSid;
00169 
00170 
00171 UNICODE_STRING  BuiltinDomainName,
00172                 AccountDomainName,
00173                 PrimaryDomainName;
00174 
00175 BOOLEAN         AccountDomainIsNotPrimaryDomain;
00176 
00177 
00178 <span class="comment">//</span>
00179 <span class="comment">// These are NOT mutually exclusive</span>
00180 <span class="comment">//</span>
00181 
00182 BOOLEAN         BuiltinDomainTest,      <span class="comment">// Test the builting domain</span>
00183                 SecurityOperatorTest,   <span class="comment">// Test auditing accessibility</span>
00184                 AccountOpAliasTest,     <span class="comment">// Test account operator functions</span>
00185                 AdminsAliasTest;        <span class="comment">// Test domain admin functions</span>
00186 
00187 
00188 
00190 <span class="comment">//                                                                           //</span>
00191 <span class="comment">// private macros                                                            //</span>
00192 <span class="comment">//                                                                           //</span>
00194 <span class="comment"></span>
00195 
00196 <span class="comment">//</span>
00197 <span class="comment">// VOID</span>
00198 <span class="comment">// TST_SUCCESS_ASSERT( IN NTSTATUS S );</span>
00199 <span class="comment">//</span>
00200 
00201 <span class="preprocessor">#define TST_SUCCESS_ASSERT( S )                                             \</span>
00202 <span class="preprocessor">{                                                                           \</span>
00203 <span class="preprocessor">    if ( !NT_SUCCESS((S)) ) {                                               \</span>
00204 <span class="preprocessor">        printf("\n** SUCCESS STATUS ASSERTION FAILURE **\n");             \</span>
00205 <span class="preprocessor">        printf("   Status is:  0x%lx\n", (S) );                           \</span>
00206 <span class="preprocessor">        ASSERT(NT_SUCCESS((S)));                                            \</span>
00207 <span class="preprocessor">    }                                                                       \</span>
00208 <span class="preprocessor">}</span>
00209 <span class="preprocessor"></span>
00210 
00211 
00213 <span class="comment">//                                                                           //</span>
00214 <span class="comment">// private service prototypes                                                //</span>
00215 <span class="comment">//                                                                           //</span>
00217 <span class="comment"></span>
00218 
00219 
00220 
00221 BOOLEAN
00222 TInitialize( VOID );
00223 
00224 BOOLEAN
00225 EnableSecurityPrivilege( VOID );
00226 
00227 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00228 DetermineTestsToRun( VOID );
00229 
00230 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00231 SeeIfSidIsSpecial(
00232     IN PSID Sid
00233     );
00234 
00235 BOOLEAN
00236 ServerTestSuite(
00237     PHANDLE ServerHandle,
00238     PHANDLE DomainHandle,
00239     PHANDLE BuiltinDomainHandle,
00240     PSID    *DomainSid
00241     );
00242 
00243 BOOLEAN
00244 SecurityTestSuite(
00245     HANDLE ServerHandle,
00246     HANDLE DomainHandle,
00247     ULONG Pass
00248     );
00249 
00250 BOOLEAN
00251 CheckReturnedSD(
00252     IN SECURITY_INFORMATION SI,
00253     IN PSECURITY_DESCRIPTOR SD,
00254     IN BOOLEAN              PrintTestSuccess
00255     );
00256 
00257 
00258 BOOLEAN
00259 DomainTestSuite(
00260     HANDLE DomainHandle
00261     );
00262 
00263 BOOLEAN
00264 GroupTestSuite(
00265     HANDLE DomainHandle,
00266     ULONG  Pass
00267     );
00268 
00269 BOOLEAN
00270 AliasTestSuite(
00271     HANDLE DomainHandle,
00272     HANDLE BuiltinDomainHandle,
00273     PSID DomainSid,
00274     ULONG  Pass
00275     );
00276 
00277 BOOLEAN
00278 UserTestSuite(
00279     HANDLE DomainHandle,
00280     ULONG Pass
00281     );
00282 
00283 
00284 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00285 SampSetDomainPolicy( VOID );
00286 
00287 
00288 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00289 SampGetLsaDomainInfo(
00290     PPOLICY_ACCOUNT_DOMAIN_INFO *PolicyAccountDomainInfo,
00291     PPOLICY_PRIMARY_DOMAIN_INFO *PolicyPrimaryDomainInfo
00292     );
00293 
00294 
00295 <span class="comment">//</span>
00296 <span class="comment">// The following are in WRAPPERS.C, but are prototyped here since this</span>
00297 <span class="comment">// test is the only thing that should ever call them.</span>
00298 <span class="comment">//</span>
00299 
00300 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00301 SamTestPrivateFunctionsDomain(
00302     IN HANDLE DomainHandle
00303     );
00304 
00305 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00306 SamTestPrivateFunctionsUser(
00307     IN HANDLE UserHandle
00308     );
00309 
00310 
00311 <span class="preprocessor">#endif // NOT_PART_OF_PROGRAM</span>
00312 <span class="preprocessor"></span>
00314 <span class="comment">//                                                                           //</span>
00315 <span class="comment">// Routines                                                                  //</span>
00316 <span class="comment">//                                                                           //</span>
00318 <span class="comment"></span>
00319 
00320 
00321 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00322"></a><a class="code" href="../../d7/d6/ttokend_8c.html#a0">00322</a> <a class="code" href="../../d2/d5/editreg_8c.html#a87">main</a> (argc, argv)
00323 int argc;
00324 <span class="keywordtype">char</span> **argv;
00325 
00326 <span class="comment">/*++</span>
00327 <span class="comment"></span>
00328 <span class="comment">Routine Description:</span>
00329 <span class="comment"></span>
00330 <span class="comment">    This is the main entry routine for this test.</span>
00331 <span class="comment"></span>
00332 <span class="comment">Arguments:</span>
00333 <span class="comment"></span>
00334 <span class="comment">    NONE</span>
00335 <span class="comment"></span>
00336 <span class="comment"></span>
00337 <span class="comment">Return Value:</span>
00338 <span class="comment"></span>
00339 <span class="comment"></span>
00340 <span class="comment"></span>
00341 <span class="comment"></span>
00342 <span class="comment">--*/</span>
00343 {
00344     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00345         NtStatus;
00346 
00347     HANDLE
00348         h1, h2, h3;
00349 
00350     OBJECT_ATTRIBUTES
00351         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00352 
00353     SECURITY_QUALITY_OF_SERVICE
00354         Qos;
00355 
00356     <span class="comment">//</span>
00357     <span class="comment">// Duplicate our primary token to get an impersonation token.</span>
00358     <span class="comment">// (no security QOS causes duplicate to have Anonymous level)</span>
00359     <span class="comment">//</span>
00360 
00361     NtStatus = <a class="code" href="../../d7/d3/tokenopn_8c.html#a1">NtOpenProcessToken</a>( NtCurrentProcess(),
00362                                    TOKEN_DUPLICATE,
00363                                    &amp;h1);
00364     printf(<span class="stringliteral">"Test: Open Process Token: 0x%lx\n"</span>, NtStatus);
00365 
00366     InitializeObjectAttributes( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00367     NtStatus = <a class="code" href="../../d6/d3/tokendup_8c.html#a1">NtDuplicateToken</a>( h1,
00368                                  TOKEN_DUPLICATE,
00369                                  &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00370                                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,         <span class="comment">// EffectiveOnly</span>
00371                                  TokenImpersonation,
00372                                  &amp;h2);
00373     printf(<span class="stringliteral">"Test: Duplicate Primary to anonymous Impersonation: 0x%lx\n"</span>, NtStatus);
00374 
00375 
00376     <span class="comment">//</span>
00377     <span class="comment">// Now duplicate that to get a primary</span>
00378     <span class="comment">//</span>
00379     NtStatus = <a class="code" href="../../d6/d3/tokendup_8c.html#a1">NtDuplicateToken</a>( h2,
00380                                  TOKEN_DUPLICATE,
00381                                  &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00382                                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,         <span class="comment">// EffectiveOnly</span>
00383                                  TokenPrimary,
00384                                  &amp;h3);
00385     printf(<span class="stringliteral">"Test: Duplicate anonymous Impersonation to Primary: 0x%lx\n"</span>, NtStatus);
00386 
00387     <span class="comment">//</span>
00388     <span class="comment">// Now try it again with Impersonate level.</span>
00389     <span class="comment">//</span>
00390 
00391     Qos.Length = <span class="keyword">sizeof</span>(Qos);
00392     Qos.ImpersonationLevel = SecurityImpersonation;
00393     Qos.ContextTrackingMode = SECURITY_STATIC_TRACKING;
00394     Qos.EffectiveOnly = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00395 
00396     InitializeObjectAttributes( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00397     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>.SecurityQualityOfService = &amp;Qos;
00398 
00399     NtStatus = <a class="code" href="../../d6/d3/tokendup_8c.html#a1">NtDuplicateToken</a>( h1,
00400                                  TOKEN_DUPLICATE,
00401                                  &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00402                                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,         <span class="comment">// EffectiveOnly</span>
00403                                  TokenImpersonation,
00404                                  &amp;h2);
00405     printf(<span class="stringliteral">"Test: Duplicate Primary to IMPERSONATE Impersonation: 0x%lx\n"</span>, NtStatus);
00406 
00407 
00408     <span class="comment">//</span>
00409     <span class="comment">// Now duplicate that to get a primary</span>
00410     <span class="comment">//</span>
00411     NtStatus = <a class="code" href="../../d6/d3/tokendup_8c.html#a1">NtDuplicateToken</a>( h2,
00412                                  TOKEN_DUPLICATE,
00413                                  &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00414                                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,         <span class="comment">// EffectiveOnly</span>
00415                                  TokenPrimary,
00416                                  &amp;h3);
00417     printf(<span class="stringliteral">"Test: Duplicate IMPERSONATE Impersonation to Primary: 0x%lx\n"</span>, NtStatus);
00418 
00419     <span class="keywordflow">return</span>;
00420 }
00421 
00422 <span class="preprocessor">#ifdef NOT_PART_OF_PROGRAM</span>
00423 <span class="preprocessor"></span>
00424 BOOLEAN
00425 TInitialize (
00426     VOID
00427     )
00428 
00429 <span class="comment">/*++</span>
00430 <span class="comment"></span>
00431 <span class="comment">Routine Description:</span>
00432 <span class="comment"></span>
00433 <span class="comment">    Initialize test variables, et cetera.</span>
00434 <span class="comment"></span>
00435 <span class="comment">Arguments:</span>
00436 <span class="comment"></span>
00437 <span class="comment">    None.</span>
00438 <span class="comment"></span>
00439 <span class="comment">Return Value:</span>
00440 <span class="comment"></span>
00441 <span class="comment"></span>
00442 <span class="comment">    Note:</span>
00443 <span class="comment"></span>
00444 <span class="comment"></span>
00445 <span class="comment">--*/</span>
00446 {
00447     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> NtStatus;
00448     STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
00449     ULONG i;
00450 
00451     SID_IDENTIFIER_AUTHORITY    WorldSidAuthority        = SECURITY_WORLD_SID_AUTHORITY;
00452     SID_IDENTIFIER_AUTHORITY    DomainSidAuthority       = {0,0,0,0,0,0};
00453     SID_IDENTIFIER_AUTHORITY    BuiltinAuthority         = SECURITY_NT_AUTHORITY;
00454 
00455 
00456     <span class="comment">//</span>
00457     <span class="comment">// Get the domain SIDs from the policy database...</span>
00458     <span class="comment">//</span>
00459 
00460     NtStatus = SampSetDomainPolicy();
00461     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
00462 
00463 
00464     <span class="comment">//</span>
00465     <span class="comment">// A random large integer value..</span>
00466     <span class="comment">//</span>
00467 
00468     LargeInteger1.LowPart = 1234;
00469     LargeInteger1.HighPart = 0;
00470 
00471     LargeInteger2.LowPart = 4321;
00472     LargeInteger2.HighPart = 0;
00473 
00474 
00475     <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;Name, DUMMY_NAME1 );
00476     NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;DummyName1, &amp;Name, TRUE );
00477     TST_SUCCESS_ASSERT(NtStatus);
00478 
00479     <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;Name, DUMMY_NAME2 );
00480     NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;DummyName2, &amp;Name, TRUE );
00481     TST_SUCCESS_ASSERT(NtStatus);
00482 
00483 
00484     <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;DummyAnsiString1, DUMMY_STRING1 );
00485     NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;DummyString1, &amp;DummyAnsiString1, TRUE );
00486     TST_SUCCESS_ASSERT(NtStatus);
00487 
00488     <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;DummyAnsiString2, DUMMY_STRING2 );
00489     NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;DummyString2, &amp;DummyAnsiString2, TRUE );
00490     TST_SUCCESS_ASSERT(NtStatus);
00491 
00492 
00493     DummyLogonHours.UnitsPerWeek = SAM_HOURS_PER_WEEK;
00494     DummyLogonHours.LogonHours   = &amp;DummyLogonHoursBitMask[0];
00495     DummyLogonHoursBitMask[LOGON_HOURS_DIFFERENT_OFFSET] = 103; <span class="comment">// Any non-zero value</span>
00496 
00497     NoLogonRestriction.UnitsPerWeek = SAM_HOURS_PER_WEEK;
00498     NoLogonRestriction.LogonHours   = &amp;NoLogonRestrictionBitMask[0];
00499     <span class="keywordflow">for</span> ( i=0; i&lt;(ULONG)((NoLogonRestriction.UnitsPerWeek+7)/8); i++) {
00500         NoLogonRestrictionBitMask[0] = 0;
00501     }
00502 
00503 
00504 
00505     <span class="comment">//</span>
00506     <span class="comment">//  Initialize some SIDs</span>
00507     <span class="comment">//</span>
00508 
00509 
00510     <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a> = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( RtlProcessHeap(), 0, <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>(1) );
00511     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(WorldSid != NULL);
00512     <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>( WorldSid, &amp;WorldSidAuthority, 1 );
00513     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>( WorldSid, 0 )) = SECURITY_WORLD_RID;
00514 
00515     AdminsAliasSid  = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(), 0,<a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( 2 ));
00516     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(AdminsAliasSid != NULL);
00517     <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>( AdminsAliasSid,   &amp;BuiltinAuthority, 2 );
00518     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>( AdminsAliasSid,  0 )) = SECURITY_BUILTIN_DOMAIN_RID;
00519     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>( AdminsAliasSid,  1 )) = DOMAIN_ALIAS_RID_ADMINS;
00520 
00521     AccountAliasSid  = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(), 0,<a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( 2 ));
00522     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(AccountAliasSid != NULL);
00523     <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>( AccountAliasSid,   &amp;BuiltinAuthority, 2 );
00524     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>( AccountAliasSid,  0 )) = SECURITY_BUILTIN_DOMAIN_RID;
00525     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>( AccountAliasSid,  1 )) = DOMAIN_ALIAS_RID_ACCOUNT_OPS;
00526 
00527 
00528 
00529 
00530     <span class="comment">//</span>
00531     <span class="comment">// Initialize some stuff for SID and NAME lookup operations</span>
00532     <span class="comment">//</span>
00533 
00534     <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;Name, LOOKUP_KNOWN_NAME0 );
00535 
00536     AllUses[0] = LOOKUP_KNOWN_NAME0_USE;  AllRids[0] = LOOKUP_KNOWN_NAME0_RID;
00537     NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AllNames[0], &amp;Name, TRUE ); TST_SUCCESS_ASSERT(NtStatus);
00538     SomeUses[0] = LOOKUP_KNOWN_NAME0_USE;  SomeRids[0] = LOOKUP_KNOWN_NAME0_RID;
00539     NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;SomeNames[0], &amp;Name, TRUE ); TST_SUCCESS_ASSERT(NtStatus);
00540 
00541 
00542     <span class="keywordflow">if</span> (AccountDomainIsNotPrimaryDomain == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00543         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;Name, LOOKUP_KNOWN_NAME1_A );
00544     } <span class="keywordflow">else</span> {
00545         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;Name, LOOKUP_KNOWN_NAME1_P );
00546     }
00547     AllUses[1] = LOOKUP_KNOWN_NAME1_USE;  AllRids[1] = LOOKUP_KNOWN_NAME1_RID;
00548     NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AllNames[1], &amp;Name, TRUE ); TST_SUCCESS_ASSERT(NtStatus);
00549     SomeUses[1] = LOOKUP_KNOWN_NAME1_USE;  SomeRids[1] = LOOKUP_KNOWN_NAME1_RID;
00550     NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;SomeNames[1], &amp;Name, TRUE ); TST_SUCCESS_ASSERT(NtStatus);
00551 
00552     <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;Name, LOOKUP_UNKNOWN_NAME0 );
00553 
00554     SomeUses[2] = SidTypeUnknown;
00555     NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;SomeNames[2], &amp;Name, TRUE ); TST_SUCCESS_ASSERT(NtStatus);
00556     NoUses[0] = SidTypeUnknown;
00557     NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;NoNames[0], &amp;Name, TRUE ); TST_SUCCESS_ASSERT(NtStatus);
00558 
00559 
00560     <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;Name, LOOKUP_UNKNOWN_NAME1 );
00561 
00562     SomeUses[3] = SidTypeUnknown;
00563     NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;SomeNames[3], &amp;Name, TRUE ); TST_SUCCESS_ASSERT(NtStatus);
00564     NoUses[1] = SidTypeUnknown;
00565     NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;NoNames[1], &amp;Name, TRUE ); TST_SUCCESS_ASSERT(NtStatus);
00566 
00567 
00568 
00569     <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;Name, LOOKUP_UNKNOWN_NAME2 );
00570 
00571     SomeUses[4] = SidTypeUnknown;
00572     NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;SomeNames[4], &amp;Name, TRUE ); TST_SUCCESS_ASSERT(NtStatus);
00573 
00574 
00575     <span class="keywordflow">if</span> (AccountDomainIsNotPrimaryDomain == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00576         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;Name, LOOKUP_KNOWN_NAME2_A );
00577     } <span class="keywordflow">else</span> {
00578         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;Name, LOOKUP_KNOWN_NAME2_P );
00579     }
00580     AllUses[2] = LOOKUP_KNOWN_NAME2_USE;  AllRids[2] = LOOKUP_KNOWN_NAME2_RID;
00581     NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AllNames[2], &amp;Name, TRUE ); TST_SUCCESS_ASSERT(NtStatus);
00582     SomeUses[5] = LOOKUP_KNOWN_NAME2_USE;  SomeRids[5] = LOOKUP_KNOWN_NAME2_RID;
00583     NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;SomeNames[5], &amp;Name, TRUE ); TST_SUCCESS_ASSERT(NtStatus);
00584 
00585 
00586 
00587     <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;Name, LOOKUP_UNKNOWN_NAME3 );
00588 
00589     SomeUses[6] = SidTypeUnknown;
00590     NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;SomeNames[6], &amp;Name, TRUE ); TST_SUCCESS_ASSERT(NtStatus);
00591 
00592 
00593     DetermineTestsToRun();
00594 
00595     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00596 }
00597 
00598 
00599 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00600 SampSetDomainPolicy(
00601     )
00602 <span class="comment">/*++</span>
00603 <span class="comment"></span>
00604 <span class="comment"></span>
00605 <span class="comment">Routine Description:</span>
00606 <span class="comment"></span>
00607 <span class="comment">    This routine sets the names and SIDs for the builtin and account domains.</span>
00608 <span class="comment">    The builtin account domain has a well known name and SID.</span>
00609 <span class="comment">    The account domain has these stored in the Policy database.</span>
00610 <span class="comment"></span>
00611 <span class="comment"></span>
00612 <span class="comment">    It places the information for these domains in:</span>
00613 <span class="comment"></span>
00614 <span class="comment">            BuiltinDomainSid</span>
00615 <span class="comment">            BuiltinDomainName</span>
00616 <span class="comment">            AccountDomainSid</span>
00617 <span class="comment">            AccountDomainName</span>
00618 <span class="comment">            PrimaryDomainSid</span>
00619 <span class="comment">            PrimaryDomainName</span>
00620 <span class="comment"></span>
00621 <span class="comment">    It also sets the boolean:</span>
00622 <span class="comment"></span>
00623 <span class="comment">            AccountDomainIsNotPrimaryDomain</span>
00624 <span class="comment"></span>
00625 <span class="comment">    to TRUE if the account domain is found to be different from the</span>
00626 <span class="comment">    Primary Domain.</span>
00627 <span class="comment"></span>
00628 <span class="comment">Arguments:</span>
00629 <span class="comment"></span>
00630 <span class="comment">    None.</span>
00631 <span class="comment"></span>
00632 <span class="comment">Return Value:</span>
00633 <span class="comment"></span>
00634 <span class="comment">--*/</span>
00635 
00636 {
00637     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> NtStatus;
00638     PPOLICY_ACCOUNT_DOMAIN_INFO PolicyAccountDomainInfo;
00639     PPOLICY_PRIMARY_DOMAIN_INFO PolicyPrimaryDomainInfo;
00640     SID_IDENTIFIER_AUTHORITY BuiltinAuthority = SECURITY_NT_AUTHORITY;
00641 
00642     <span class="comment">//</span>
00643     <span class="comment">// Builtin domain - well-known name and SID</span>
00644     <span class="comment">//</span>
00645 
00646     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;BuiltinDomainName, L<span class="stringliteral">"Builtin"</span>);
00647 
00648     BuiltinDomainSid  = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(), 0,<a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( 1 ));
00649     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( BuiltinDomainSid != NULL );
00650     <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>( BuiltinDomainSid,   &amp;BuiltinAuthority, 1 );
00651     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>( BuiltinDomainSid,  0 )) = SECURITY_BUILTIN_DOMAIN_RID;
00652 
00653     <span class="comment">//</span>
00654     <span class="comment">// Account domain</span>
00655     <span class="comment">//</span>
00656 
00657     NtStatus = SampGetLsaDomainInfo(
00658                    &amp;PolicyAccountDomainInfo,
00659                    &amp;PolicyPrimaryDomainInfo
00660                    );
00661 
00662     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
00663 
00664         <span class="keywordflow">return</span>(NtStatus);
00665     }
00666 
00667     AccountDomainSid = PolicyAccountDomainInfo-&gt;DomainSid;
00668     AccountDomainName = PolicyAccountDomainInfo-&gt;DomainName;
00669 
00670     PrimaryDomainSid = PolicyPrimaryDomainInfo-&gt;Sid;
00671     PrimaryDomainName = PolicyPrimaryDomainInfo-&gt;Name;
00672 
00673     <span class="comment">//</span>
00674     <span class="comment">// Determine whether the account domain is a primary domain.</span>
00675     <span class="comment">//</span>
00676 
00677     AccountDomainIsNotPrimaryDomain =
00678         !<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>( &amp;PrimaryDomainName, &amp;AccountDomainName, TRUE);
00679 
00680     <span class="keywordflow">return</span>(NtStatus);;
00681 }
00682 
00683 
00684 
00685 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00686 SampGetLsaDomainInfo(
00687     PPOLICY_ACCOUNT_DOMAIN_INFO *PolicyAccountDomainInfo,
00688     PPOLICY_PRIMARY_DOMAIN_INFO *PolicyPrimaryDomainInfo
00689     )
00690 
00691 <span class="comment">/*++</span>
00692 <span class="comment"></span>
00693 <span class="comment">Routine Description:</span>
00694 <span class="comment"></span>
00695 <span class="comment">    This routine retrieves ACCOUNT domain information from the LSA</span>
00696 <span class="comment">    policy database.</span>
00697 <span class="comment"></span>
00698 <span class="comment"></span>
00699 <span class="comment">Arguments:</span>
00700 <span class="comment"></span>
00701 <span class="comment">    PolicyAccountDomainInfo - Receives a pointer to a</span>
00702 <span class="comment">        POLICY_ACCOUNT_DOMAIN_INFO structure containing the account</span>
00703 <span class="comment">        domain info.</span>
00704 <span class="comment"></span>
00705 <span class="comment">    PolicyPrimaryDomainInfo - Receives a pointer to a</span>
00706 <span class="comment">        POLICY_PRIMARY_DOMAIN_INFO structure containing the Primary</span>
00707 <span class="comment">        domain info.</span>
00708 <span class="comment"></span>
00709 <span class="comment"></span>
00710 <span class="comment">Return Value:</span>
00711 <span class="comment"></span>
00712 <span class="comment">    STATUS_SUCCESS - Succeeded.</span>
00713 <span class="comment"></span>
00714 <span class="comment">    Other status values that may be returned from:</span>
00715 <span class="comment"></span>
00716 <span class="comment">             LsaOpenPolicy()</span>
00717 <span class="comment">             LsaQueryInformationPolicy()</span>
00718 <span class="comment">--*/</span>
00719 
00720 {
00721     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, IgnoreStatus;
00722 
00723     LSA_HANDLE PolicyHandle;
00724     OBJECT_ATTRIBUTES PolicyObjectAttributes;
00725 
00726     <span class="comment">//</span>
00727     <span class="comment">// Open the policy database</span>
00728     <span class="comment">//</span>
00729 
00730     InitializeObjectAttributes( &amp;PolicyObjectAttributes,
00731                                   NULL,             <span class="comment">// Name</span>
00732                                   0,                <span class="comment">// Attributes</span>
00733                                   NULL,             <span class="comment">// Root</span>
00734                                   NULL );           <span class="comment">// Security Descriptor</span>
00735 
00736     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = LsaOpenPolicy( NULL,
00737                             &amp;PolicyObjectAttributes,
00738                             POLICY_VIEW_LOCAL_INFORMATION,
00739                             &amp;PolicyHandle );
00740     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00741 
00742         <span class="comment">//</span>
00743         <span class="comment">// Query the account domain information</span>
00744         <span class="comment">//</span>
00745 
00746         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = LsaQueryInformationPolicy( PolicyHandle,
00747                                             PolicyAccountDomainInformation,
00748                                             (PVOID *)PolicyAccountDomainInfo );
00749 <span class="preprocessor">#if DBG</span>
00750 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00751             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (*PolicyAccountDomainInfo) != NULL );
00752             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (*PolicyAccountDomainInfo)-&gt;DomainSid != NULL );
00753             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (*PolicyAccountDomainInfo)-&gt;DomainName.Buffer != NULL );
00754         }
00755 <span class="preprocessor">#endif \\DBG</span>
00756 <span class="preprocessor"></span>
00757         <span class="comment">//</span>
00758         <span class="comment">// Query the Primary domain information</span>
00759         <span class="comment">//</span>
00760 
00761         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = LsaQueryInformationPolicy( PolicyHandle,
00762                                             PolicyPrimaryDomainInformation,
00763                                             (PVOID *)PolicyPrimaryDomainInfo );
00764 <span class="preprocessor">#if DBG</span>
00765 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00766             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (*PolicyPrimaryDomainInfo) != NULL );
00767             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (*PolicyPrimaryDomainInfo)-&gt;Sid != NULL );
00768             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (*PolicyPrimaryDomainInfo)-&gt;Name.Buffer != NULL );
00769         }
00770 <span class="preprocessor">#endif \\DBG</span>
00771 <span class="preprocessor"></span>
00772         IgnoreStatus = LsaClose( PolicyHandle );
00773         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus));
00774     }
00775 
00776     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00777 }
00778 
00779 
00780 
00781 
00782 PSID
00783 CreateUserSid(
00784     PSID    DomainSid,
00785     ULONG   Rid
00786     )
00787 
00788 <span class="comment">/*++</span>
00789 <span class="comment"></span>
00790 <span class="comment">Routine Description:</span>
00791 <span class="comment"></span>
00792 <span class="comment">    This function creates a domain account sid given a domain sid and</span>
00793 <span class="comment">    the relative id of the account within the domain.</span>
00794 <span class="comment"></span>
00795 <span class="comment">Arguments:</span>
00796 <span class="comment"></span>
00797 <span class="comment">    None.</span>
00798 <span class="comment"></span>
00799 <span class="comment">Return Value:</span>
00800 <span class="comment"></span>
00801 <span class="comment">    Pointer to Sid, or NULL on failure.</span>
00802 <span class="comment">    The returned Sid must be freed with DeleteUserSid</span>
00803 <span class="comment"></span>
00804 <span class="comment">--*/</span>
00805 {
00806 
00807     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> IgnoreStatus;
00808     PSID AccountSid;
00809     UCHAR AccountSubAuthorityCount = *<a class="code" href="../../d8/d6/sertl_8c.html#a44">RtlSubAuthorityCountSid</a>(DomainSid) + (UCHAR)1;
00810     ULONG AccountSidLength = <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>(AccountSubAuthorityCount);
00811     PULONG  RidLocation;
00812 
00813     <span class="comment">// Temp sanity check</span>
00814     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(AccountSidLength == <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(DomainSid) + <span class="keyword">sizeof</span>(ULONG));
00815 
00816     <span class="comment">//</span>
00817     <span class="comment">// Allocate space for the account sid</span>
00818     <span class="comment">//</span>
00819 
00820     AccountSid = MIDL_user_allocate(AccountSidLength);
00821 
00822     <span class="keywordflow">if</span> (AccountSid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00823 
00824         <span class="comment">//</span>
00825         <span class="comment">// Copy the domain sid into the first part of the account sid</span>
00826         <span class="comment">//</span>
00827 
00828         IgnoreStatus = <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>(AccountSidLength, AccountSid, DomainSid);
00829         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus));
00830 
00831         <span class="comment">//</span>
00832         <span class="comment">// Increment the account sid sub-authority count</span>
00833         <span class="comment">//</span>
00834 
00835         *<a class="code" href="../../d8/d6/sertl_8c.html#a44">RtlSubAuthorityCountSid</a>(AccountSid) = AccountSubAuthorityCount;
00836 
00837         <span class="comment">//</span>
00838         <span class="comment">// Add the rid as the final sub-authority</span>
00839         <span class="comment">//</span>
00840 
00841         RidLocation = <a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>(AccountSid, AccountSubAuthorityCount - 1);
00842         *RidLocation = Rid;
00843     }
00844 
00845     <span class="keywordflow">return</span>(AccountSid);
00846 }
00847 
00848 
00849 
00850 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00851 DeleteUserSid(
00852     PSID    UserSid
00853     )
00854 
00855 <span class="comment">/*++</span>
00856 <span class="comment"></span>
00857 <span class="comment">Routine Description:</span>
00858 <span class="comment"></span>
00859 <span class="comment">    Frees a sid returned by CreateUserSid.</span>
00860 <span class="comment"></span>
00861 <span class="comment">Arguments:</span>
00862 <span class="comment"></span>
00863 <span class="comment">    None.</span>
00864 <span class="comment"></span>
00865 <span class="comment">Return Value:</span>
00866 <span class="comment"></span>
00867 <span class="comment">    None.</span>
00868 <span class="comment"></span>
00869 <span class="comment">--*/</span>
00870 {
00871     MIDL_user_free(UserSid);
00872 }
00873 
00874 
00875 
00876 BOOLEAN
00877 EnableSecurityPrivilege(
00878     VOID
00879     )
00880 
00881 <span class="comment">/*++</span>
00882 <span class="comment"></span>
00883 <span class="comment">Routine Description:</span>
00884 <span class="comment"></span>
00885 <span class="comment">    This function enabled the SeSecurityPrivilege privilege.</span>
00886 <span class="comment"></span>
00887 <span class="comment">Arguments:</span>
00888 <span class="comment"></span>
00889 <span class="comment">    None.</span>
00890 <span class="comment"></span>
00891 <span class="comment">Return Value:</span>
00892 <span class="comment"></span>
00893 <span class="comment">    TRUE  if privilege successfully enabled.</span>
00894 <span class="comment">    FALSE if not successfully enabled.</span>
00895 <span class="comment"></span>
00896 <span class="comment">--*/</span>
00897 {
00898 
00899     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00900     HANDLE <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00901     LUID <a class="code" href="../../d4/d6/tsevars_8c.html#a46">SecurityPrivilege</a>;
00902     PTOKEN_PRIVILEGES NewState;
00903     ULONG ReturnLength;
00904 
00905 
00906     <span class="comment">//</span>
00907     <span class="comment">// Open our own token</span>
00908     <span class="comment">//</span>
00909 
00910     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a1">NtOpenProcessToken</a>(
00911                  NtCurrentProcess(),
00912                  TOKEN_ADJUST_PRIVILEGES,
00913                  &amp;Token
00914                  );
00915     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00916         printf(<span class="stringliteral">" \n\n\n"</span>);
00917         printf(<span class="stringliteral">"Tsamobj: Can't open process token to enable Security Privilege.\n"</span>);
00918         printf(<span class="stringliteral">"         Completion status of NtOpenProcessToken() is: 0x%lx\n"</span>, Status);
00919         printf(<span class="stringliteral">"\n"</span>);
00920         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00921     }
00922 
00923 
00924     <span class="comment">//</span>
00925     <span class="comment">// Initialize the adjustment structure</span>
00926     <span class="comment">//</span>
00927 
00928     <a class="code" href="../../d4/d6/tsevars_8c.html#a46">SecurityPrivilege</a> =
00929         RtlConvertLongToLargeInteger(SE_SECURITY_PRIVILEGE);
00930 
00931     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (<span class="keyword">sizeof</span>(TOKEN_PRIVILEGES) + <span class="keyword">sizeof</span>(LUID_AND_ATTRIBUTES)) &lt; 100);
00932     NewState = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( RtlProcessHeap(), 0, 100 );
00933 
00934     NewState-&gt;PrivilegeCount = 1;
00935     NewState-&gt;Privileges[0].Luid = <a class="code" href="../../d4/d6/tsevars_8c.html#a46">SecurityPrivilege</a>;
00936     NewState-&gt;Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;
00937 
00938 
00939     <span class="comment">//</span>
00940     <span class="comment">// Set the state of the privilege to ENABLED.</span>
00941     <span class="comment">//</span>
00942 
00943     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a0">NtAdjustPrivilegesToken</a>(
00944                  Token,                            <span class="comment">// TokenHandle</span>
00945                  FALSE,                            <span class="comment">// DisableAllPrivileges</span>
00946                  NewState,                         <span class="comment">// NewState</span>
00947                  0,                                <span class="comment">// BufferLength</span>
00948                  NULL,                             <span class="comment">// PreviousState (OPTIONAL)</span>
00949                  &amp;ReturnLength                     <span class="comment">// ReturnLength</span>
00950                  );
00951     <span class="comment">// don't use NT_SUCCESS here because STATUS_NOT_ALL_ASSIGNED is a success status</span>
00952     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00953         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00954     }
00955 
00956 
00957     <span class="comment">//</span>
00958     <span class="comment">// Clean up some stuff before returning</span>
00959     <span class="comment">//</span>
00960 
00961     <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( RtlProcessHeap(), 0, NewState );
00962     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( Token );
00963     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
00964 
00965 
00966     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00967 
00968 }
00969 
00970 
00971 
00972 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00973 printfSid(
00974     PSID    Sid
00975     )
00976 
00977 <span class="comment">/*++</span>
00978 <span class="comment"></span>
00979 <span class="comment">Routine Description:</span>
00980 <span class="comment"></span>
00981 <span class="comment">    Prints a sid</span>
00982 <span class="comment"></span>
00983 <span class="comment">Arguments:</span>
00984 <span class="comment"></span>
00985 <span class="comment">    None.</span>
00986 <span class="comment"></span>
00987 <span class="comment">Return Value:</span>
00988 <span class="comment"></span>
00989 <span class="comment">    None.</span>
00990 <span class="comment"></span>
00991 <span class="comment">--*/</span>
00992 {
00993     UCHAR   <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[128];
00994     UCHAR   <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>[128];
00995     UCHAR   i;
00996     ULONG   Tmp;
00997     PISID   iSid = (PISID)Sid;  <span class="comment">// pointer to opaque structure</span>
00998     PSID    NextSid = (PSID)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00999 
01000     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<span class="keyword">sizeof</span>(Buffer) &gt;= <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>(1));
01001 
01002     {
01003         SID_IDENTIFIER_AUTHORITY SidAuthority = SECURITY_WORLD_SID_AUTHORITY;
01004         <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>(NextSid, &amp;SidAuthority, 1 );
01005         *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>(NextSid, 0)) = SECURITY_WORLD_RID;
01006         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(Sid, NextSid)) {
01007             printf(<span class="stringliteral">"World"</span>);
01008             <span class="keywordflow">return</span>;
01009         }
01010     }
01011 
01012     {
01013         SID_IDENTIFIER_AUTHORITY SidAuthority = SECURITY_LOCAL_SID_AUTHORITY;
01014         <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>(NextSid, &amp;SidAuthority, 1 );
01015         *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>(NextSid, 0)) = SECURITY_LOCAL_RID;
01016         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(Sid, NextSid)) {
01017             printf(<span class="stringliteral">"Local"</span>);
01018             <span class="keywordflow">return</span>;
01019         }
01020     }
01021 
01022     {
01023         SID_IDENTIFIER_AUTHORITY SidAuthority = SECURITY_CREATOR_SID_AUTHORITY;
01024         <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>(NextSid, &amp;SidAuthority, 1 );
01025         *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>(NextSid, 0)) = SECURITY_CREATOR_OWNER_RID;
01026         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(Sid, NextSid)) {
01027             printf(<span class="stringliteral">"Creator"</span>);
01028             <span class="keywordflow">return</span>;
01029         }
01030     }
01031 
01032     {
01033         SID_IDENTIFIER_AUTHORITY SidAuthority = SECURITY_NT_AUTHORITY;
01034         <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>(NextSid, &amp;SidAuthority, 1 );
01035         *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>(NextSid, 0)) = SECURITY_DIALUP_RID;
01036         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(Sid, NextSid)) {
01037             printf(<span class="stringliteral">"Dialup"</span>);
01038             <span class="keywordflow">return</span>;
01039         }
01040     }
01041 
01042     {
01043         SID_IDENTIFIER_AUTHORITY SidAuthority = SECURITY_NT_AUTHORITY;
01044         <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>(NextSid, &amp;SidAuthority, 1 );
01045         *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>(NextSid, 0)) = SECURITY_NETWORK_RID;
01046         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(Sid, NextSid)) {
01047             printf(<span class="stringliteral">"Network"</span>);
01048             <span class="keywordflow">return</span>;
01049         }
01050     }
01051 
01052     {
01053         SID_IDENTIFIER_AUTHORITY SidAuthority = SECURITY_NT_AUTHORITY;
01054         <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>(NextSid, &amp;SidAuthority, 1 );
01055         *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>(NextSid, 0)) = SECURITY_BATCH_RID;
01056         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(Sid, NextSid)) {
01057             printf(<span class="stringliteral">"Batch"</span>);
01058             <span class="keywordflow">return</span>;
01059         }
01060     }
01061 
01062     {
01063         SID_IDENTIFIER_AUTHORITY SidAuthority = SECURITY_NT_AUTHORITY;
01064         <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>(NextSid, &amp;SidAuthority, 1 );
01065         *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>(NextSid, 0)) = SECURITY_INTERACTIVE_RID;
01066         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(Sid, NextSid)) {
01067             printf(<span class="stringliteral">"Interactive"</span>);
01068             <span class="keywordflow">return</span>;
01069         }
01070     }
01071 
01072 
01073     {
01074         SID_IDENTIFIER_AUTHORITY SidAuthority = SECURITY_NT_AUTHORITY;
01075         <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>(NextSid, &amp;SidAuthority, 1 );
01076         *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>(NextSid, 0)) = SECURITY_LOCAL_SYSTEM_RID;
01077         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(Sid, NextSid)) {
01078             printf(<span class="stringliteral">"Local System"</span>);
01079             <span class="keywordflow">return</span>;
01080         }
01081     }
01082 
01083 
01084 
01085     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(Buffer, <span class="stringliteral">"S-%u-"</span>, (USHORT)iSid-&gt;Revision );
01086     strcpy(String, Buffer);
01087 
01088     <span class="keywordflow">if</span> (  (iSid-&gt;IdentifierAuthority.Value[0] != 0)  ||
01089           (iSid-&gt;IdentifierAuthority.Value[1] != 0)     ){
01090         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(Buffer, <span class="stringliteral">"0x%02hx%02hx%02hx%02hx%02hx%02hx"</span>,
01091                     (USHORT)iSid-&gt;IdentifierAuthority.Value[0],
01092                     (USHORT)iSid-&gt;IdentifierAuthority.Value[1],
01093                     (USHORT)iSid-&gt;IdentifierAuthority.Value[2],
01094                     (USHORT)iSid-&gt;IdentifierAuthority.Value[3],
01095                     (USHORT)iSid-&gt;IdentifierAuthority.Value[4],
01096                     (USHORT)iSid-&gt;IdentifierAuthority.Value[5] );
01097         strcat(String, Buffer);
01098     } <span class="keywordflow">else</span> {
01099         Tmp = (ULONG)iSid-&gt;IdentifierAuthority.Value[5]          +
01100               (ULONG)(iSid-&gt;IdentifierAuthority.Value[4] &lt;&lt;  8)  +
01101               (ULONG)(iSid-&gt;IdentifierAuthority.Value[3] &lt;&lt; 16)  +
01102               (ULONG)(iSid-&gt;IdentifierAuthority.Value[2] &lt;&lt; 24);
01103         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(Buffer, <span class="stringliteral">"%lu"</span>, Tmp);
01104         strcat(String, Buffer);
01105     }
01106 
01107 
01108     <span class="keywordflow">for</span> (i=0;i&lt;iSid-&gt;SubAuthorityCount ;i++ ) {
01109         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(Buffer, <span class="stringliteral">"-%lu"</span>, iSid-&gt;SubAuthority[i]);
01110         strcat(String, Buffer);
01111     }
01112 
01113     printf(Buffer);
01114 
01115     <span class="keywordflow">return</span>;
01116 }
01117 
01118 
01119 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01120 DetermineTestsToRun(
01121     VOID
01122     )
01123 
01124 <span class="comment">/*++</span>
01125 <span class="comment"></span>
01126 <span class="comment">Routine Description:</span>
01127 <span class="comment"></span>
01128 <span class="comment">    This function determines which tests are to be run.</span>
01129 <span class="comment"></span>
01130 <span class="comment"></span>
01131 <span class="comment">Arguments:</span>
01132 <span class="comment"></span>
01133 <span class="comment">    None.</span>
01134 <span class="comment"></span>
01135 <span class="comment">Return Value:</span>
01136 <span class="comment"></span>
01137 <span class="comment">    None.</span>
01138 <span class="comment"></span>
01139 <span class="comment"></span>
01140 <span class="comment">--*/</span>
01141 {
01142 
01143     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01144     HANDLE              <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
01145 
01146     PTOKEN_USER         User;
01147     PTOKEN_GROUPS       Groups;
01148 
01149     ULONG               ReturnLength,
01150                         i;
01151 
01152 
01153 
01154     <span class="comment">//</span>
01155     <span class="comment">// See if we can play with auditing information</span>
01156     <span class="comment">//</span>
01157 
01158     SecurityOperatorTest = EnableSecurityPrivilege();
01159 
01160 
01161     <span class="comment">//</span>
01162     <span class="comment">// Open our own token</span>
01163     <span class="comment">//</span>
01164 
01165     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a1">NtOpenProcessToken</a>(
01166                  NtCurrentProcess(),
01167                  TOKEN_QUERY,
01168                  &amp;Token
01169                  );
01170     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01171         printf(<span class="stringliteral">" \n\n\n"</span>);
01172         printf(<span class="stringliteral">"Tsamobj: Can't open process token to query owner.\n"</span>);
01173         printf(<span class="stringliteral">"         Completion status of NtOpenProcessToken() is: 0x%lx\n"</span>, Status);
01174         printf(<span class="stringliteral">"\n"</span>);
01175         <span class="keywordflow">return</span>;
01176     }
01177 
01178 
01179     <span class="comment">//</span>
01180     <span class="comment">// Query the user id</span>
01181     <span class="comment">//</span>
01182 
01183     User   = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( RtlProcessHeap(), 0, 1000 ); <span class="comment">// should be plenty big</span>
01184     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>( Token, TokenUser, User, 1000, &amp;ReturnLength );
01185     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
01186 
01187     <span class="comment">//</span>
01188     <span class="comment">// See if the ID is one of the special IDs (e.g., local admin,</span>
01189     <span class="comment">// domain account operator, or domain admin)</span>
01190     <span class="comment">//</span>
01191 
01192     SeeIfSidIsSpecial( User-&gt;User.Sid );
01193 
01194 
01195 
01196     <span class="comment">//</span>
01197     <span class="comment">// Query the group ids</span>
01198     <span class="comment">//</span>
01199 
01200     Groups = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( RtlProcessHeap(), 0, 1000 ); <span class="comment">// should be plenty big</span>
01201     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>( Token, TokenGroups, Groups, 1000, &amp;ReturnLength );
01202     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
01203 
01204     <span class="comment">//</span>
01205     <span class="comment">// See if any of these IDs are special IDs</span>
01206     <span class="comment">//</span>
01207 
01208     <span class="keywordflow">for</span> (i=0; i&lt;Groups-&gt;GroupCount; i++) {
01209         SeeIfSidIsSpecial( Groups-&gt;Groups[i].Sid );
01210     }
01211 
01212 
01213 
01214 
01215 
01216     <span class="comment">//</span>
01217     <span class="comment">// Clean up some stuff before returning</span>
01218     <span class="comment">//</span>
01219 
01220     <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( RtlProcessHeap(), 0, User );
01221     <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( RtlProcessHeap(), 0, Groups );
01222     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( Token );
01223     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
01224 
01225 
01226 
01227     printf(<span class="stringliteral">"\n\n\n\nPerforming:\n\n"</span>);
01228 
01229     printf(<span class="stringliteral">"        Administrator Alias Test. . . . . "</span>);
01230     <span class="keywordflow">if</span> (AdminsAliasTest) {
01231         printf(<span class="stringliteral">"Yes\n\n"</span>);
01232     } <span class="keywordflow">else</span> {
01233         printf(<span class="stringliteral">"No\n\n"</span>);
01234     }
01235 
01236     printf(<span class="stringliteral">"        Account Operator Alias  Test  . . "</span>);
01237     <span class="keywordflow">if</span> (AccountOpAliasTest) {
01238         printf(<span class="stringliteral">"Yes\n\n"</span>);
01239     } <span class="keywordflow">else</span> {
01240         printf(<span class="stringliteral">"No\n\n"</span>);
01241     }
01242 
01243     printf(<span class="stringliteral">"        Security Operator  Test . . . . . "</span>);
01244     <span class="keywordflow">if</span> (SecurityOperatorTest) {
01245         printf(<span class="stringliteral">"Yes\n\n"</span>);
01246     } <span class="keywordflow">else</span> {
01247         printf(<span class="stringliteral">"No\n\n"</span>);
01248     }
01249 
01250     printf(<span class="stringliteral">"\n\n\n"</span>);
01251 
01252 
01253 
01254     <span class="keywordflow">return</span>;
01255 
01256 }
01257 
01258 
01259 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01260 SeeIfSidIsSpecial(
01261     IN PSID Sid
01262     )
01263 
01264 <span class="comment">/*++</span>
01265 <span class="comment"></span>
01266 <span class="comment">Routine Description:</span>
01267 <span class="comment"></span>
01268 <span class="comment">    This function determines whether the passed SID is one of the special</span>
01269 <span class="comment">    SIDs, such as ADMINISTRATORS alias, or DomainAccountOperator, and</span>
01270 <span class="comment">    sets test flags accordingly.</span>
01271 <span class="comment"></span>
01272 <span class="comment"></span>
01273 <span class="comment">Arguments:</span>
01274 <span class="comment"></span>
01275 <span class="comment">    Sid - Pointer to the SID to check.</span>
01276 <span class="comment"></span>
01277 <span class="comment">Return Value:</span>
01278 <span class="comment"></span>
01279 <span class="comment">    None.</span>
01280 <span class="comment"></span>
01281 <span class="comment"></span>
01282 <span class="comment">--*/</span>
01283 {
01284 
01285 
01286 
01287 
01288     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( Sid, AdminsAliasSid )){
01289         AdminsAliasTest = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01290     }
01291 
01292     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( Sid, AccountAliasSid )){
01293         AccountOpAliasTest = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01294     }
01295 
01296     <span class="keywordflow">return</span>;
01297 
01298 }
01299 
01300 
01302 <span class="comment">//                                                                           //</span>
01303 <span class="comment">// Server Object Test Suite                                                  //</span>
01304 <span class="comment">//                                                                           //</span>
01306 <span class="comment"></span>
01307 
01308 BOOLEAN
01309 ServerTestSuite(
01310     PHANDLE ServerHandle,
01311     PHANDLE DomainHandle,
01312     PHANDLE BuiltinDomainHandle,
01313     PSID    *DomainSid
01314     )
01315 
01316 {
01317     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                        NtStatus;
01318     OBJECT_ATTRIBUTES               <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
01319     BOOLEAN                         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01320     ULONG                           CountReturned;
01321     SAM_ENUMERATE_HANDLE            EnumerationContext;
01322     PSAM_RID_ENUMERATION            EnumerationBuffer;
01323     PSID                            BuiltinDomainSid;
01324     ACCESS_MASK                     ServerAccessMask, DomainAccessMask;
01325 
01326 
01327 
01328 
01329 
01330     printf(<span class="stringliteral">"\n"</span>);
01331     printf(<span class="stringliteral">"\n"</span>);
01332     printf(<span class="stringliteral">"  Server Object                                           Test\n"</span>);
01333 
01335     <span class="comment">//                                                                       //</span>
01336     <span class="comment">// Connect To Server                                                     //</span>
01337     <span class="comment">//                                                                       //</span>
01339 <span class="comment"></span>
01340     printf(<span class="stringliteral">"\n"</span>);
01341     printf(<span class="stringliteral">"    Connect / Disconnect. . . . . . . . . . . . . . . . .   Suite\n"</span>);
01342 
01343     printf(<span class="stringliteral">"      Connect . . . . . . . . . . . . . . . . . . . . . .     "</span>);
01344 
01345 
01346     ServerAccessMask = SAM_SERVER_READ | SAM_SERVER_EXECUTE;
01347     <span class="keywordflow">if</span> (AdminsAliasTest) {
01348         ServerAccessMask |= SAM_SERVER_ALL_ACCESS;
01349     }
01350     <span class="keywordflow">if</span> (SecurityOperatorTest) {
01351         ServerAccessMask |= ACCESS_SYSTEM_SECURITY;
01352     }
01353 
01354     InitializeObjectAttributes( &amp;ObjectAttributes, NULL, 0, 0, NULL );
01355 
01356 
01357     NtStatus = SamConnect(
01358                   NULL,                     <span class="comment">// ServerName (Local machine)</span>
01359                   ServerHandle,
01360                   ServerAccessMask,
01361                   &amp;ObjectAttributes
01362                   );
01363 
01364 
01365     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
01366         printf(<span class="stringliteral">"Failed\n"</span>);
01367         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
01368         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01369     } <span class="keywordflow">else</span> {
01370         printf(<span class="stringliteral">"Succeeded\n"</span>);
01371     }
01372 
01373 
01374     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
01375 
01376         printf(<span class="stringliteral">"      Disconnect  . . . . . . . . . . . . . . . . . . . .     "</span>);
01377 
01378         NtStatus = SamCloseHandle( (*ServerHandle) );
01379 
01380         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
01381             printf(<span class="stringliteral">"Failed\n"</span>);
01382             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
01383             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01384         } <span class="keywordflow">else</span> {
01385             printf(<span class="stringliteral">"Succeeded\n"</span>);
01386         }
01387     }
01388 
01389 
01390 
01391     printf(<span class="stringliteral">"      Re-Connect  . . . . . . . . . . . . . . . . . . . .     "</span>);
01392 
01393 
01394     NtStatus = SamConnect(
01395                   NULL,                     <span class="comment">// ServerName (Local machine)</span>
01396                   ServerHandle,
01397                   ServerAccessMask,
01398                   &amp;ObjectAttributes
01399                   );
01400 
01401 
01402     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
01403         printf(<span class="stringliteral">"Failed\n"</span>);
01404         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
01405         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01406     } <span class="keywordflow">else</span> {
01407         printf(<span class="stringliteral">"Succeeded\n"</span>);
01408     }
01409 
01410 
01412     <span class="comment">//                                                                       //</span>
01413     <span class="comment">// Lookup/Enumerate Domains Suite                                        //</span>
01414     <span class="comment">//                                                                       //</span>
01416 <span class="comment"></span>
01417 
01418     printf(<span class="stringliteral">"\n"</span>);
01419     printf(<span class="stringliteral">"    Domain Lookup/Enumerate/Open  . . . . . . . . . . . .   Suite\n"</span>);
01420 
01421 
01422 
01423     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
01424 
01425         printf(<span class="stringliteral">"      Lookup Account Domain . . . . . . . . . . . . . . .     "</span>);
01426 
01427 
01428         NtStatus = SamLookupDomainInSamServer(
01429                        (*ServerHandle),
01430                        &amp;AccountDomainName,
01431                        DomainSid
01432                        );
01433 
01434         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
01435             printf(<span class="stringliteral">"Failed\n"</span>);
01436             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
01437             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01438         } <span class="keywordflow">else</span> {
01439             <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> != <a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>((*DomainSid), AccountDomainSid)) {
01440                 printf(<span class="stringliteral">"Failed\n"</span>);
01441                 printf(<span class="stringliteral">"        The SID retrieved from the policy database did not\n"</span>);
01442                 printf(<span class="stringliteral">"        match the SID retrieved from SAM for the account\n"</span>);
01443                 printf(<span class="stringliteral">"        domain.\n"</span>);
01444                 printf(<span class="stringliteral">"        Sid from Policy Database is: "</span>);
01445                 printfSid(      AccountDomainSid ); printf(<span class="stringliteral">"\n"</span>);
01446                 printf(<span class="stringliteral">"        Sid from SAM is: "</span>);
01447                 printfSid(      (*DomainSid) ); printf(<span class="stringliteral">"\n"</span>);
01448                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01449             } <span class="keywordflow">else</span> {
01450                 printf(<span class="stringliteral">"Succeeded\n"</span>);
01451             }
01452         }
01453 
01454     }
01455 
01456 
01457 
01458 
01459 
01460 
01461     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
01462 
01463         printf(<span class="stringliteral">"      Enumerate Domain  . . . . . . . . . . . . . . . . .     "</span>);
01464 
01465 
01466         EnumerationContext = 0;
01467         EnumerationBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01468         NtStatus = SamEnumerateDomainsInSamServer(
01469                        (*ServerHandle),
01470                        &amp;EnumerationContext,
01471                        (PVOID *)&amp;EnumerationBuffer,
01472                        1024,                        <span class="comment">// PreferedMaximumLength</span>
01473                        &amp;CountReturned
01474                        );
01475 
01476         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
01477             printf(<span class="stringliteral">"Failed\n"</span>);
01478             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
01479             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01480         } <span class="keywordflow">else</span> {
01481 
01482             <span class="keywordflow">if</span> (CountReturned == 0) {
01483                 printf(<span class="stringliteral">"Failed\n"</span>);
01484                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
01485                 printf(<span class="stringliteral">"        CountReturned is: 0x%lx\n"</span>, CountReturned);
01486                 printf(<span class="stringliteral">"        EnumerationContext is: 0x%lx\n"</span>, EnumerationContext);
01487                 printf(<span class="stringliteral">"        EnumerationBuffer Address is: 0x%lx\n"</span>, (ULONG)EnumerationBuffer);
01488                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01489 
01490             } <span class="keywordflow">else</span> {
01491                 printf(<span class="stringliteral">"Succeeded\n"</span>);
01492             }
01493 
01494             SamFreeMemory( EnumerationBuffer );
01495         }
01496 
01497     }
01498 
01499 
01500 
01501 
01502 
01503 
01504     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
01505 
01506         printf(<span class="stringliteral">"      Open Account Domain . . . . . . . . . . . . . . . .     "</span>);
01507 
01508         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
01509 
01510             DomainAccessMask = DOMAIN_READ | DOMAIN_EXECUTE;
01511             <span class="keywordflow">if</span> (AccountOpAliasTest) {
01512                 DomainAccessMask |= DOMAIN_READ | DOMAIN_WRITE | DOMAIN_EXECUTE;
01513             }
01514             <span class="keywordflow">if</span> (AdminsAliasTest) {
01515                 DomainAccessMask |= DOMAIN_ALL_ACCESS;
01516             }
01517             <span class="keywordflow">if</span> (SecurityOperatorTest) {
01518                 DomainAccessMask |= ACCESS_SYSTEM_SECURITY;
01519             }
01520             NtStatus = SamOpenDomain(
01521                            (*ServerHandle),
01522                            DomainAccessMask,
01523                            *DomainSid,
01524                            DomainHandle
01525                            );
01526 
01527             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
01528                 printf(<span class="stringliteral">"Failed\n"</span>);
01529                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
01530                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01531             } <span class="keywordflow">else</span> {
01532                 printf(<span class="stringliteral">"Succeeded\n"</span>);
01533             }
01534         }
01535 
01536     }
01537 
01538     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
01539 
01540         printf(<span class="stringliteral">"      Open Builtin Domain . . . . . . . . . . . . . . . .     "</span>);
01541 
01542         NtStatus = SamLookupDomainInSamServer(
01543                        (*ServerHandle),
01544                        &amp;BuiltinDomainName,
01545                        &amp;BuiltinDomainSid
01546                        );
01547 
01548         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
01549 
01550             DomainAccessMask = DOMAIN_READ | DOMAIN_EXECUTE;
01551             <span class="keywordflow">if</span> (AccountOpAliasTest) {
01552                 DomainAccessMask |= DOMAIN_READ | DOMAIN_WRITE | DOMAIN_EXECUTE;
01553             }
01554             <span class="keywordflow">if</span> (AdminsAliasTest) {
01555                 DomainAccessMask |= (DOMAIN_EXECUTE | DOMAIN_READ |
01556                                      DOMAIN_READ_OTHER_PARAMETERS |
01557                                      DOMAIN_ADMINISTER_SERVER     |
01558                                      DOMAIN_CREATE_ALIAS);
01559             }
01560 <span class="comment">//            if (SecurityOperatorTest) {</span>
01561 <span class="comment">//                DomainAccessMask |= ACCESS_SYSTEM_SECURITY;</span>
01562 <span class="comment">//            }</span>
01563             NtStatus = SamOpenDomain(
01564                            (*ServerHandle),
01565                            DomainAccessMask,
01566                            BuiltinDomainSid,
01567                            BuiltinDomainHandle
01568                            );
01569 
01570             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
01571                 printf(<span class="stringliteral">"Failed\n"</span>);
01572                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
01573                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01574             } <span class="keywordflow">else</span> {
01575                 printf(<span class="stringliteral">"Succeeded\n"</span>);
01576             }
01577         }
01578 
01579     }
01580 
01581     <span class="keywordflow">return</span>(TestStatus);
01582 
01583 
01584 }
01585 
01586 
01588 <span class="comment">//                                                                           //</span>
01589 <span class="comment">// Security Manipulation Test Suite                                          //</span>
01590 <span class="comment">//                                                                           //</span>
01592 <span class="comment"></span>
01593 
01594 BOOLEAN
01595 SecurityTestSuite(
01596     HANDLE ServerHandle,
01597     HANDLE DomainHandle,
01598     ULONG Pass
01599     )
01600 {
01601 
01602     BOOLEAN                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01603     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                NtStatus;
01604 
01605     PSECURITY_DESCRIPTOR    OriginalServerSD,
01606                             OriginalDomainSD,
01607                             OriginalUserSD,
01608                             OriginalGroupSD,
01609                             SD1;
01610 
01611     SECURITY_INFORMATION    SI1;
01612     PVOID TmpPointer1;
01613 
01614     SECURITY_DESCRIPTOR     SD1_Body;
01615 
01616     HANDLE                  GroupHandle,
01617                             UserHandle;
01618 
01619 
01620 
01621 
01622     printf(<span class="stringliteral">"\n"</span>);
01623     printf(<span class="stringliteral">"\n"</span>);
01624     printf(<span class="stringliteral">"\n"</span>);
01625 
01626     <span class="keywordflow">if</span> (Pass == 1) {
01627 
01628         printf(<span class="stringliteral">"  Security Manipulation (Pass #1)                         Test\n"</span>);
01629 
01631         <span class="comment">//                                                                       //</span>
01632         <span class="comment">// Query Suite                                                           //</span>
01633         <span class="comment">//                                                                       //</span>
01635 <span class="comment"></span>
01636         printf(<span class="stringliteral">"\n"</span>);
01637         printf(<span class="stringliteral">"    Query Security  . . . . . . . . . . . . . . . . . . .   Suite\n"</span>);
01638 
01639 
01640         <span class="comment">//</span>
01641         <span class="comment">// Get Server's original SD</span>
01642         <span class="comment">//</span>
01643 
01644 
01645         SI1 = 0;
01646         <span class="keywordflow">if</span> (AdminsAliasTest) {
01647             SI1 |= OWNER_SECURITY_INFORMATION | GROUP_SECURITY_INFORMATION |
01648                    DACL_SECURITY_INFORMATION;
01649         }
01650         <span class="keywordflow">if</span> (SecurityOperatorTest) {
01651             SI1 |= SACL_SECURITY_INFORMATION;
01652         }
01653         <span class="keywordflow">if</span> (SI1 != 0) {
01654             printf(<span class="stringliteral">"      Query Server Security Descriptor  . . . . . . . . . .     "</span>);
01655             SD1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01656             NtStatus = SamQuerySecurityObject(
01657                            ServerHandle,
01658                            SI1,
01659                            &amp;SD1
01660                            );
01661             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
01662 
01663                 TestStatus = CheckReturnedSD( SI1, SD1, TRUE );
01664 
01665                 <span class="comment">//</span>
01666                 <span class="comment">// Normally we would do a "SamFreeMemory( SD1 )" here.</span>
01667                 <span class="comment">// However, we want to save this SD for future reference</span>
01668                 <span class="comment">// and use.</span>
01669                 <span class="comment">//</span>
01670 
01671                 OriginalServerSD = SD1;
01672 
01673             } <span class="keywordflow">else</span> {
01674                 printf(<span class="stringliteral">"Failed\n"</span>);
01675                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
01676                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01677             }
01678         }
01679 
01680 
01681 
01682 
01683 
01684         <span class="comment">//</span>
01685         <span class="comment">// Get domain's original SD</span>
01686         <span class="comment">//</span>
01687 
01688 
01689         SI1 = 0;
01690         <span class="keywordflow">if</span> (AdminsAliasTest) {
01691             SI1 |= OWNER_SECURITY_INFORMATION | GROUP_SECURITY_INFORMATION |
01692                    DACL_SECURITY_INFORMATION;
01693         }
01694         <span class="keywordflow">if</span> (SecurityOperatorTest) {
01695             SI1 |= SACL_SECURITY_INFORMATION;
01696         }
01697         <span class="keywordflow">if</span> (SI1 != 0) {
01698             printf(<span class="stringliteral">"      Query Domain Security Descriptor  . . . . . . . . . .     "</span>);
01699             SD1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01700             NtStatus = SamQuerySecurityObject(
01701                            DomainHandle,
01702                            SI1,
01703                            &amp;SD1
01704                            );
01705             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
01706 
01707                 TestStatus = CheckReturnedSD( SI1, SD1, TRUE );
01708 
01709                 <span class="comment">//</span>
01710                 <span class="comment">// Normally we would do a "SamFreeMemory( SD1 )" here.</span>
01711                 <span class="comment">// However, we want to save this SD for future reference</span>
01712                 <span class="comment">// and use.</span>
01713                 <span class="comment">//</span>
01714 
01715                 OriginalDomainSD = SD1;
01716 
01717             } <span class="keywordflow">else</span> {
01718                 printf(<span class="stringliteral">"Failed\n"</span>);
01719                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
01720                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01721             }
01722         }
01723 
01724 
01725 
01726 
01727 
01728 
01729         <span class="comment">//</span>
01730         <span class="comment">// Make sure the wrapper doesn't choke on a non-null pointer being passed</span>
01731         <span class="comment">// (assuming we have allocated memory).</span>
01732         <span class="comment">//</span>
01733 
01734 
01735         SI1 = 0;
01736         <span class="keywordflow">if</span> (AdminsAliasTest) {
01737             SI1 |= OWNER_SECURITY_INFORMATION | GROUP_SECURITY_INFORMATION |
01738                    DACL_SECURITY_INFORMATION;
01739         }
01740         <span class="keywordflow">if</span> (SecurityOperatorTest) {
01741             SI1 |= SACL_SECURITY_INFORMATION;
01742         }
01743         <span class="keywordflow">if</span> (SI1 != 0) {
01744             printf(<span class="stringliteral">"      Query Passing Non-null return buffer  . . . . . . . .     "</span>);
01745             SD1 = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( RtlProcessHeap(), 0, 1000 ); <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(SD1 != NULL);
01746             TmpPointer1 = SD1;
01747             NtStatus = SamQuerySecurityObject(
01748                            DomainHandle,
01749                            SI1,
01750                            &amp;SD1
01751                            );
01752             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
01753                 <span class="keywordflow">if</span> (SD1 != TmpPointer1) {
01754 
01755                     TestStatus = CheckReturnedSD( SI1, SD1, TRUE );
01756                     <span class="keywordflow">if</span> (TestStatus) {
01757                         SamFreeMemory( SD1 );
01758                     }
01759 
01760 
01761                 } <span class="keywordflow">else</span> {
01762                     printf(<span class="stringliteral">"Failed\n"</span>);
01763                     printf(<span class="stringliteral">"        Passed buffer address used on return.\n"</span>);
01764                     printf(<span class="stringliteral">"        RPC should have allocated another buffer.\n"</span>);
01765                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01766                 }
01767             } <span class="keywordflow">else</span> {
01768                 printf(<span class="stringliteral">"Failed\n"</span>);
01769                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
01770                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01771             }
01772 
01773 
01774             <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( RtlProcessHeap(), 0, TmpPointer1 );
01775 
01776         }
01777 
01778 
01779 
01780 
01781 
01782 
01783         <span class="comment">//</span>
01784         <span class="comment">// Make sure we can query nothing</span>
01785         <span class="comment">//</span>
01786 
01787         printf(<span class="stringliteral">"      Query Nothing . . . . . . . . . . . . . . . . . . . .     "</span>);
01788 
01789         SI1 = 0;
01790         SD1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01791         NtStatus = SamQuerySecurityObject(
01792                        DomainHandle,
01793                        SI1,
01794                        &amp;SD1
01795                        );
01796         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
01797 
01798             TestStatus = CheckReturnedSD( SI1, SD1, TRUE );
01799             <span class="keywordflow">if</span> (TestStatus) {
01800                 SamFreeMemory( SD1 );
01801             }
01802 
01803         } <span class="keywordflow">else</span> {
01804             printf(<span class="stringliteral">"Failed\n"</span>);
01805             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
01806             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01807         }
01808 
01809 
01810 
01811 
01812 
01813         <span class="comment">//</span>
01814         <span class="comment">// Query owner</span>
01815         <span class="comment">//</span>
01816 
01817 
01818         <span class="keywordflow">if</span> (AdminsAliasTest) {
01819             printf(<span class="stringliteral">"      Query Owner (Server Object) . . . . . . . . . . . . .     "</span>);
01820             SI1 = OWNER_SECURITY_INFORMATION;
01821             SD1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01822             NtStatus = SamQuerySecurityObject(
01823                            ServerHandle,
01824                            SI1,
01825                            &amp;SD1
01826                            );
01827             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
01828 
01829                 TestStatus = CheckReturnedSD( SI1, SD1, TRUE );
01830                 <span class="keywordflow">if</span> (TestStatus) {
01831                     SamFreeMemory( SD1 );
01832                 }
01833 
01834             } <span class="keywordflow">else</span> {
01835                 printf(<span class="stringliteral">"Failed\n"</span>);
01836                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
01837                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01838             }
01839         }
01840 
01841 
01842 
01843 
01844         <span class="keywordflow">if</span> (AdminsAliasTest) {
01845             printf(<span class="stringliteral">"      Query Owner (Domain Object) . . . . . . . . . . . . .     "</span>);
01846             SI1 = OWNER_SECURITY_INFORMATION;
01847             SD1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01848             NtStatus = SamQuerySecurityObject(
01849                            DomainHandle,
01850                            SI1,
01851                            &amp;SD1
01852                            );
01853             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
01854 
01855                 TestStatus = CheckReturnedSD( SI1, SD1, TRUE );
01856                 <span class="keywordflow">if</span> (TestStatus) {
01857                     SamFreeMemory( SD1 );
01858                 }
01859 
01860             } <span class="keywordflow">else</span> {
01861                 printf(<span class="stringliteral">"Failed\n"</span>);
01862                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
01863                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01864             }
01865         }
01866 
01867 
01868 
01869 
01870 
01871         <span class="keywordflow">if</span> (AdminsAliasTest) {
01872 
01873             <span class="comment">//</span>
01874             <span class="comment">// Query Group</span>
01875             <span class="comment">//</span>
01876 
01877             printf(<span class="stringliteral">"      Query Group . . . . . . . . . . . . . . . . . . . . .     "</span>);
01878 
01879             SI1 = GROUP_SECURITY_INFORMATION;
01880             SD1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01881             NtStatus = SamQuerySecurityObject(
01882                            DomainHandle,
01883                            SI1,
01884                            &amp;SD1
01885                            );
01886             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
01887 
01888                 TestStatus = CheckReturnedSD( SI1, SD1, TRUE );
01889                 <span class="keywordflow">if</span> (TestStatus) {
01890                     SamFreeMemory( SD1 );
01891                 }
01892 
01893             } <span class="keywordflow">else</span> {
01894                 printf(<span class="stringliteral">"Failed\n"</span>);
01895                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
01896                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01897             }
01898 
01899 
01900 
01901 
01902 
01903             <span class="comment">//</span>
01904             <span class="comment">// Query Dacl</span>
01905             <span class="comment">//</span>
01906 
01907             printf(<span class="stringliteral">"      Query DACL  . . . . . . . . . . . . . . . . . . . . .     "</span>);
01908 
01909             SI1 = DACL_SECURITY_INFORMATION;
01910             SD1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01911             NtStatus = SamQuerySecurityObject(
01912                            DomainHandle,
01913                            SI1,
01914                            &amp;SD1
01915                            );
01916             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
01917 
01918                 TestStatus = CheckReturnedSD( SI1, SD1, TRUE );
01919                 <span class="keywordflow">if</span> (TestStatus) {
01920                     SamFreeMemory( SD1 );
01921                 }
01922 
01923             } <span class="keywordflow">else</span> {
01924                 printf(<span class="stringliteral">"Failed\n"</span>);
01925                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
01926                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01927             }
01928 
01929 
01930 
01931 
01932 
01933             <span class="comment">//</span>
01934             <span class="comment">// Query Sacl</span>
01935             <span class="comment">//</span>
01936 
01937             printf(<span class="stringliteral">"      Query SACL  . . . . . . . . . . . . . . . . . . . . .     "</span>);
01938 
01939             SI1 = SACL_SECURITY_INFORMATION;
01940             SD1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01941             NtStatus = SamQuerySecurityObject(
01942                            DomainHandle,
01943                            SI1,
01944                            &amp;SD1
01945                            );
01946             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
01947 
01948                 TestStatus = CheckReturnedSD( SI1, SD1, TRUE );
01949                 <span class="keywordflow">if</span> (TestStatus) {
01950                     SamFreeMemory( SD1 );
01951                 }
01952 
01953             } <span class="keywordflow">else</span> {
01954                 printf(<span class="stringliteral">"Failed\n"</span>);
01955                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
01956                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01957             }
01958 
01959         }  <span class="comment">// end_if (AdminsAliasTest)</span>
01960 
01961 
01962 
01963 
01964 
01966         <span class="comment">//                                                                       //</span>
01967         <span class="comment">// Set Suite                                                             //</span>
01968         <span class="comment">//                                                                       //</span>
01970 <span class="comment"></span>
01971         printf(<span class="stringliteral">"\n"</span>);
01972         printf(<span class="stringliteral">"    Set Security  . . . . . . . . . . . . . . . . . . . .   Suite\n"</span>);
01973 
01974 
01975         <span class="comment">//</span>
01976         <span class="comment">// Make sure we can set nothing</span>
01977         <span class="comment">//</span>
01978 
01979         printf(<span class="stringliteral">"      Set Nothing . . . . . . . . . . . . . . . . . . . . .     "</span>);
01980 
01981         SI1 = 0;
01982         SD1 = &amp;SD1_Body;
01983         NtStatus = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>( SD1, SECURITY_DESCRIPTOR_REVISION1 );
01984         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
01985         NtStatus = SamSetSecurityObject(
01986                        DomainHandle,
01987                        SI1,     <span class="comment">// &lt;------ This is invalid</span>
01988                        SD1
01989                        );
01990         <span class="keywordflow">if</span> (NtStatus == STATUS_INVALID_PARAMETER) {
01991 
01992             printf(<span class="stringliteral">"Succeeded\n"</span>);
01993 
01994         } <span class="keywordflow">else</span> {
01995             printf(<span class="stringliteral">"Failed\n"</span>);
01996             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
01997             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01998         }
01999 
02000 
02001 
02002 
02003 
02004 
02005         <span class="comment">//</span>
02006         <span class="comment">// set something not passed</span>
02007         <span class="comment">//</span>
02008 
02009         printf(<span class="stringliteral">"      Set something not passed. . . . . . . . . . . . . . .     "</span>);
02010 
02011         SI1 = GROUP_SECURITY_INFORMATION;
02012         SD1 = &amp;SD1_Body;
02013         NtStatus = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>( SD1, SECURITY_DESCRIPTOR_REVISION1 );
02014         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
02015         NtStatus = SamSetSecurityObject(
02016                        DomainHandle,
02017                        SI1,
02018                        SD1
02019                        );
02020         <span class="keywordflow">if</span> (NtStatus == STATUS_BAD_DESCRIPTOR_FORMAT) {
02021 
02022             printf(<span class="stringliteral">"Succeeded\n"</span>);
02023 
02024         } <span class="keywordflow">else</span> {
02025             printf(<span class="stringliteral">"Failed\n"</span>);
02026             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
02027             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02028         }
02029 
02030 
02031 
02032 
02033 
02034 
02035         <span class="comment">//</span>
02036         <span class="comment">// set a non-existant DACL</span>
02037         <span class="comment">//</span>
02038 
02039         <span class="keywordflow">if</span> (AdminsAliasTest) {
02040             printf(<span class="stringliteral">"      Set non-existant DACL (Server object) . . . . . . . .     "</span>);
02041 
02042             SI1 = DACL_SECURITY_INFORMATION;
02043             SD1 = &amp;SD1_Body;
02044             NtStatus = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>( SD1, SECURITY_DESCRIPTOR_REVISION1 );
02045             SD1_Body.Control = SE_DACL_PRESENT;
02046             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
02047             NtStatus = SamSetSecurityObject(
02048                            ServerHandle,
02049                            SI1,
02050                            SD1
02051                            );
02052             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
02053 
02054                 printf(<span class="stringliteral">"Succeeded\n"</span>);
02055 
02056             } <span class="keywordflow">else</span> {
02057                 printf(<span class="stringliteral">"Failed\n"</span>);
02058                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
02059                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02060             }
02061         }
02062 
02063 
02064 
02065         <span class="keywordflow">if</span> (AdminsAliasTest) {
02066             printf(<span class="stringliteral">"      Set non-existant DACL (Domain Object) . . . . . . . .     "</span>);
02067 
02068             SI1 = DACL_SECURITY_INFORMATION;
02069             SD1 = &amp;SD1_Body;
02070             NtStatus = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>( SD1, SECURITY_DESCRIPTOR_REVISION1 );
02071             SD1_Body.Control = SE_DACL_PRESENT;
02072             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
02073             NtStatus = SamSetSecurityObject(
02074                            DomainHandle,
02075                            SI1,
02076                            SD1
02077                            );
02078             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
02079 
02080                 printf(<span class="stringliteral">"Succeeded\n"</span>);
02081 
02082             } <span class="keywordflow">else</span> {
02083                 printf(<span class="stringliteral">"Failed\n"</span>);
02084                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
02085                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02086             }
02087         }
02088 
02089 
02090 
02091 
02092 
02093         <span class="comment">//</span>
02094         <span class="comment">// set original DACL (From original SD)</span>
02095         <span class="comment">//</span>
02096 
02097         <span class="keywordflow">if</span> (AdminsAliasTest) {
02098 
02099             printf(<span class="stringliteral">"      Set original DACL (Server Object) . . . . . . . . . .     "</span>);
02100 
02101             SI1 = DACL_SECURITY_INFORMATION;
02102             SD1 = OriginalServerSD;
02103             NtStatus = SamSetSecurityObject(
02104                            ServerHandle,
02105                            SI1,
02106                            SD1
02107                            );
02108             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
02109 
02110                 printf(<span class="stringliteral">"Succeeded\n"</span>);
02111 
02112             } <span class="keywordflow">else</span> {
02113                 printf(<span class="stringliteral">"Failed\n"</span>);
02114                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
02115                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02116             }
02117         }
02118 
02119 
02120 
02121         <span class="keywordflow">if</span> (AdminsAliasTest) {
02122 
02123             printf(<span class="stringliteral">"      Set original DACL (Domain Object) . . . . . . . . . .     "</span>);
02124 
02125             SI1 = DACL_SECURITY_INFORMATION;
02126             SD1 = OriginalDomainSD;
02127             NtStatus = SamSetSecurityObject(
02128                            DomainHandle,
02129                            SI1,
02130                            SD1
02131                            );
02132             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
02133 
02134                 printf(<span class="stringliteral">"Succeeded\n"</span>);
02135 
02136             } <span class="keywordflow">else</span> {
02137                 printf(<span class="stringliteral">"Failed\n"</span>);
02138                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
02139                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02140             }
02141         }
02142 
02143 
02144 
02145 
02146 
02147         <span class="keywordflow">if</span> (AdminsAliasTest) {
02148 
02149             <span class="comment">//</span>
02150             <span class="comment">// set a non-existant SACL</span>
02151             <span class="comment">//</span>
02152 
02153             printf(<span class="stringliteral">"      Set non-existant SACL . . . . . . . . . . . . . . . .     "</span>);
02154 
02155             SI1 = SACL_SECURITY_INFORMATION;
02156             SD1 = &amp;SD1_Body;
02157             NtStatus = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>( SD1, SECURITY_DESCRIPTOR_REVISION1 );
02158             SD1_Body.Control = SE_SACL_PRESENT;
02159             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
02160             NtStatus = SamSetSecurityObject(
02161                            DomainHandle,
02162                            SI1,
02163                            SD1
02164                            );
02165             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
02166 
02167                 printf(<span class="stringliteral">"Succeeded\n"</span>);
02168 
02169             } <span class="keywordflow">else</span> {
02170                 printf(<span class="stringliteral">"Failed\n"</span>);
02171                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
02172                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02173             }
02174 
02175 
02176 
02177 
02178 
02179 
02180             <span class="comment">//</span>
02181             <span class="comment">// set original SACL (From original SD)</span>
02182             <span class="comment">//</span>
02183 
02184             printf(<span class="stringliteral">"      Set original SACL . . . . . . . . . . . . . . . . . .     "</span>);
02185 
02186             SI1 = SACL_SECURITY_INFORMATION;
02187             SD1 = OriginalDomainSD;
02188             NtStatus = SamSetSecurityObject(
02189                            DomainHandle,
02190                            SI1,
02191                            SD1
02192                            );
02193             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
02194 
02195                 printf(<span class="stringliteral">"Succeeded\n"</span>);
02196 
02197             } <span class="keywordflow">else</span> {
02198                 printf(<span class="stringliteral">"Failed\n"</span>);
02199                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
02200                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02201             }
02202 
02203 
02204 
02205 
02206 
02207             <span class="comment">//</span>
02208             <span class="comment">// set a owner to null</span>
02209             <span class="comment">//</span>
02210 
02211             printf(<span class="stringliteral">"      Set null Owner  . . . . . . . . . . . . . . . . . . .     "</span>);
02212 
02213             SI1 = OWNER_SECURITY_INFORMATION;
02214             SD1 = &amp;SD1_Body;
02215             NtStatus = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>( SD1, SECURITY_DESCRIPTOR_REVISION1 );
02216             SD1_Body.Owner = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02217             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
02218             NtStatus = SamSetSecurityObject(
02219                            DomainHandle,
02220                            SI1,
02221                            SD1
02222                            );
02223             <span class="keywordflow">if</span> (NtStatus = STATUS_BAD_DESCRIPTOR_FORMAT) {
02224 
02225                 printf(<span class="stringliteral">"Succeeded\n"</span>);
02226 
02227             } <span class="keywordflow">else</span> {
02228                 printf(<span class="stringliteral">"Failed\n"</span>);
02229                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
02230                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02231             }
02232 
02233 
02234 
02235 
02236 
02237             <span class="comment">//</span>
02238             <span class="comment">// set owner to invalid value</span>
02239             <span class="comment">//</span>
02240 
02241             printf(<span class="stringliteral">"      Set owner to invalid value  . . . . . . . . . . . . .     "</span>);
02242 
02243             SI1 = OWNER_SECURITY_INFORMATION;
02244             SD1 = &amp;SD1_Body;
02245             NtStatus = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>( SD1, SECURITY_DESCRIPTOR_REVISION1 );
02246             SD1_Body.Owner = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>;
02247             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
02248             NtStatus = SamSetSecurityObject(
02249                            DomainHandle,
02250                            SI1,
02251                            SD1
02252                            );
02253             <span class="keywordflow">if</span> (NtStatus = STATUS_INVALID_OWNER) {
02254 
02255                 printf(<span class="stringliteral">"Succeeded\n"</span>);
02256 
02257             } <span class="keywordflow">else</span> {
02258                 printf(<span class="stringliteral">"Failed\n"</span>);
02259                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
02260                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02261             }
02262 
02263 
02264 
02265 
02266             <span class="comment">//</span>
02267             <span class="comment">// set a owner to valid value</span>
02268             <span class="comment">//</span>
02269 
02270             printf(<span class="stringliteral">"      Set owner to valid value  . . . . . . . . . . . . . .     "</span>);
02271 
02272             printf(<span class="stringliteral">"Untested\n"</span>);
02273 
02274 
02275 
02276 
02277 
02278             <span class="comment">//</span>
02279             <span class="comment">// set group to null</span>
02280             <span class="comment">//</span>
02281 
02282             printf(<span class="stringliteral">"      Set null Group  . . . . . . . . . . . . . . . . . . .     "</span>);
02283 
02284             SI1 = GROUP_SECURITY_INFORMATION;
02285             SD1 = &amp;SD1_Body;
02286             NtStatus = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>( SD1, SECURITY_DESCRIPTOR_REVISION1 );
02287             SD1_Body.Group = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02288             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
02289             NtStatus = SamSetSecurityObject(
02290                            DomainHandle,
02291                            SI1,
02292                            SD1
02293                            );
02294             <span class="keywordflow">if</span> (NtStatus = STATUS_BAD_DESCRIPTOR_FORMAT) {
02295 
02296                 printf(<span class="stringliteral">"Succeeded\n"</span>);
02297 
02298             } <span class="keywordflow">else</span> {
02299                 printf(<span class="stringliteral">"Failed\n"</span>);
02300                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
02301                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02302             }
02303 
02304 
02305 
02306 
02307 
02308 
02309             <span class="comment">//</span>
02310             <span class="comment">// set Group to valid value</span>
02311             <span class="comment">//</span>
02312 
02313             printf(<span class="stringliteral">"      Set Group to valid value  . . . . . . . . . . . . . .     "</span>);
02314 
02315             SI1 = GROUP_SECURITY_INFORMATION;
02316             SD1 = &amp;SD1_Body;
02317             NtStatus = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>( SD1, SECURITY_DESCRIPTOR_REVISION1 );
02318             SD1_Body.Group = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>;
02319             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
02320             NtStatus = SamSetSecurityObject(
02321                            DomainHandle,
02322                            SI1,
02323                            SD1
02324                            );
02325             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
02326 
02327                 printf(<span class="stringliteral">"Succeeded\n"</span>);
02328 
02329             } <span class="keywordflow">else</span> {
02330                 printf(<span class="stringliteral">"Failed\n"</span>);
02331                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
02332                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02333             }
02334 
02335 
02336 
02337 
02338 
02339             <span class="comment">//</span>
02340             <span class="comment">// set Group back to original value</span>
02341             <span class="comment">//</span>
02342 
02343             printf(<span class="stringliteral">"      Set Group to original value . . . . . . . . . . . . .     "</span>);
02344 
02345             SI1 = GROUP_SECURITY_INFORMATION;
02346             SD1 = OriginalDomainSD;
02347             NtStatus = SamSetSecurityObject(
02348                            DomainHandle,
02349                            SI1,
02350                            SD1
02351                            );
02352             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
02353 
02354                 printf(<span class="stringliteral">"Succeeded\n"</span>);
02355 
02356             } <span class="keywordflow">else</span> {
02357                 printf(<span class="stringliteral">"Failed\n"</span>);
02358                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
02359                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02360             }
02361         }
02362 
02363 
02364 
02365 
02366     }   <span class="comment">// end Pass1</span>
02367 
02368 
02369     <span class="keywordflow">if</span> (Pass == 2) {
02370 
02371         ACCESS_MASK         AccessMask;
02372         PSID_NAME_USE       LookedUpUses;
02373         PULONG              LookedUpRids;
02374         UNICODE_STRING      AccountNames[10];
02375         STRING              AccountNameAnsi;
02376 
02377 
02378         <span class="comment">//</span>
02379         <span class="comment">// This pass depends upon user and group accounts established in pass #1</span>
02380         <span class="comment">//</span>
02381 
02382 
02383 
02384 
02385 
02386         <span class="keywordflow">if</span> (AdminsAliasTest) {
02387 
02388 
02389             printf(<span class="stringliteral">"  Security Manipulation (Pass #2)                         Test\n"</span>);
02390 
02392             <span class="comment">//                                                                       //</span>
02393             <span class="comment">// Query Suite                                                           //</span>
02394             <span class="comment">//                                                                       //</span>
02396 <span class="comment"></span>
02397             printf(<span class="stringliteral">"\n"</span>);
02398             printf(<span class="stringliteral">"    Query Security (User Object). . . . . . . . . . . . .   Suite\n"</span>);
02399 
02400 
02401             AccessMask = READ_CONTROL;
02402             <span class="keywordflow">if</span> (SecurityOperatorTest) {
02403                 AccessMask |= ACCESS_SYSTEM_SECURITY;
02404             }
02405 
02406             <span class="comment">//</span>
02407             <span class="comment">// Open the user created in pass #1</span>
02408             <span class="comment">//</span>
02409 
02410             <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, USER_NAME1 );
02411             NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountNames[0], &amp;AccountNameAnsi, TRUE );
02412             TST_SUCCESS_ASSERT(NtStatus);
02413 
02414             NtStatus = SamLookupNamesInDomain(
02415                            DomainHandle,
02416                            1,
02417                            &amp;AccountNames[0],
02418                            &amp;LookedUpRids,
02419                            &amp;LookedUpUses
02420                            );
02421             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountNames[0] );
02422             TST_SUCCESS_ASSERT(NtStatus);
02423             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(LookedUpUses[0] == SidTypeUser);
02424             NtStatus = SamOpenUser(
02425                            DomainHandle,
02426                            AccessMask,
02427                            LookedUpRids[0],
02428                            &amp;UserHandle);
02429             SamFreeMemory( LookedUpUses ); SamFreeMemory( LookedUpRids );
02430             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
02431                 printf(<span class="stringliteral">"Failed to open user account created in pass #1\n"</span>);
02432             }
02433             TST_SUCCESS_ASSERT(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
02434 
02435 
02436 
02437             <span class="comment">//</span>
02438             <span class="comment">// Get user's original SD</span>
02439             <span class="comment">//</span>
02440 
02441             SI1 |= OWNER_SECURITY_INFORMATION | GROUP_SECURITY_INFORMATION |
02442                    DACL_SECURITY_INFORMATION;
02443             <span class="keywordflow">if</span> (SecurityOperatorTest) {
02444                 SI1 |= SACL_SECURITY_INFORMATION;
02445             }
02446 
02447             printf(<span class="stringliteral">"      Query User Security Descriptor  . . . . . . . . . . .     "</span>);
02448             SD1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02449             NtStatus = SamQuerySecurityObject(
02450                            UserHandle,
02451                            SI1,
02452                            &amp;SD1
02453                            );
02454             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
02455 
02456                 TestStatus = CheckReturnedSD( SI1, SD1, TRUE );
02457 
02458                 <span class="comment">//</span>
02459                 <span class="comment">// Normally we would do a "SamFreeMemory( SD1 )" here.</span>
02460                 <span class="comment">// However, we want to save this SD for future reference</span>
02461                 <span class="comment">// and use.</span>
02462                 <span class="comment">//</span>
02463 
02464                 OriginalUserSD = SD1;
02465 
02466             } <span class="keywordflow">else</span> {
02467                 printf(<span class="stringliteral">"Failed\n"</span>);
02468                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
02469                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02470             }
02471 
02472 
02473 
02474 
02475 
02476             NtStatus = SamCloseHandle( UserHandle );
02477             TST_SUCCESS_ASSERT( UserHandle );
02478 
02479 
02480 
02482             <span class="comment">//                                                                       //</span>
02483             <span class="comment">// Set Suite                                                             //</span>
02484             <span class="comment">//                                                                       //</span>
02486 <span class="comment"></span>
02487             printf(<span class="stringliteral">"\n"</span>);
02488             printf(<span class="stringliteral">"    Set Security  (User Object) . . . . . . . . . . . . .   Suite\n"</span>);
02489 
02490             AccessMask = WRITE_DAC | WRITE_OWNER;
02491             <span class="keywordflow">if</span> (SecurityOperatorTest) {
02492                 AccessMask |= ACCESS_SYSTEM_SECURITY;
02493             }
02494 
02495             <span class="comment">//</span>
02496             <span class="comment">// Open the user created in pass #1</span>
02497             <span class="comment">//</span>
02498 
02499             <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, USER_NAME1 );
02500             NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountNames[0], &amp;AccountNameAnsi, TRUE );
02501             TST_SUCCESS_ASSERT(NtStatus);
02502 
02503             NtStatus = SamLookupNamesInDomain(
02504                            DomainHandle,
02505                            1,
02506                            &amp;AccountNames[0],
02507                            &amp;LookedUpRids,
02508                            &amp;LookedUpUses
02509                            );
02510             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountNames[0] );
02511             TST_SUCCESS_ASSERT(NtStatus);
02512             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(LookedUpUses[0] == SidTypeUser);
02513             NtStatus = SamOpenUser(
02514                            DomainHandle,
02515                            AccessMask,
02516                            LookedUpRids[0],
02517                            &amp;UserHandle);
02518             SamFreeMemory( LookedUpUses ); SamFreeMemory( LookedUpRids );
02519             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
02520                 printf(<span class="stringliteral">"Failed to open user account created in pass #1\n"</span>);
02521             }
02522             TST_SUCCESS_ASSERT(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
02523 
02524 
02525             <span class="comment">//</span>
02526             <span class="comment">// Make sure we can set nothing</span>
02527             <span class="comment">//</span>
02528 
02529             printf(<span class="stringliteral">"      Set Nothing . . . . . . . . . . . . . . . . . . . . .     "</span>);
02530 
02531             SI1 = 0;
02532             SD1 = &amp;SD1_Body;
02533             NtStatus = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>( SD1, SECURITY_DESCRIPTOR_REVISION1 );
02534             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
02535             NtStatus = SamSetSecurityObject(
02536                            UserHandle,
02537                            SI1,     <span class="comment">// &lt;------ This is invalid</span>
02538                            SD1
02539                            );
02540             <span class="keywordflow">if</span> (NtStatus == STATUS_INVALID_PARAMETER) {
02541 
02542                 printf(<span class="stringliteral">"Succeeded\n"</span>);
02543 
02544             } <span class="keywordflow">else</span> {
02545                 printf(<span class="stringliteral">"Failed\n"</span>);
02546                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
02547                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02548             }
02549 
02550 
02551 
02552 
02553 
02554 
02555             <span class="comment">//</span>
02556             <span class="comment">// set something not passed</span>
02557             <span class="comment">//</span>
02558 
02559             printf(<span class="stringliteral">"      Set something not passed. . . . . . . . . . . . . . .     "</span>);
02560 
02561             SI1 = GROUP_SECURITY_INFORMATION;
02562             SD1 = &amp;SD1_Body;
02563             NtStatus = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>( SD1, SECURITY_DESCRIPTOR_REVISION1 );
02564             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
02565             NtStatus = SamSetSecurityObject(
02566                            UserHandle,
02567                            SI1,
02568                            SD1
02569                            );
02570             <span class="keywordflow">if</span> (NtStatus == STATUS_BAD_DESCRIPTOR_FORMAT) {
02571 
02572                 printf(<span class="stringliteral">"Succeeded\n"</span>);
02573 
02574             } <span class="keywordflow">else</span> {
02575                 printf(<span class="stringliteral">"Failed\n"</span>);
02576                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
02577                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02578             }
02579 
02580 
02581 
02582 
02583 
02584 
02585 
02586 
02587             printf(<span class="stringliteral">"      Set non-existant DACL . . . . . . . . . . . . . . . .     "</span>);
02588 
02589             SI1 = DACL_SECURITY_INFORMATION;
02590             SD1 = &amp;SD1_Body;
02591             NtStatus = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>( SD1, SECURITY_DESCRIPTOR_REVISION1 );
02592             SD1_Body.Control = SE_DACL_PRESENT;
02593             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
02594             NtStatus = SamSetSecurityObject(
02595                            UserHandle,
02596                            SI1,
02597                            SD1
02598                            );
02599             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
02600 
02601                 printf(<span class="stringliteral">"Succeeded\n"</span>);
02602 
02603             } <span class="keywordflow">else</span> {
02604                 printf(<span class="stringliteral">"Failed\n"</span>);
02605                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
02606                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02607             }
02608 
02609 
02610 
02611 
02612 
02613 
02614             <span class="comment">//</span>
02615             <span class="comment">// set original DACL (From original SD)</span>
02616             <span class="comment">//</span>
02617 
02618 
02619             printf(<span class="stringliteral">"      Set original DACL . . . . . . . . . . . . . . . . . .     "</span>);
02620 
02621             SI1 = DACL_SECURITY_INFORMATION;
02622             SD1 = OriginalUserSD;
02623             NtStatus = SamSetSecurityObject(
02624                            UserHandle,
02625                            SI1,
02626                            SD1
02627                            );
02628             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
02629 
02630                 printf(<span class="stringliteral">"Succeeded\n"</span>);
02631 
02632             } <span class="keywordflow">else</span> {
02633                 printf(<span class="stringliteral">"Failed\n"</span>);
02634                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
02635                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02636             }
02637 
02638 
02639 
02640 
02641 
02642 
02643 
02644             NtStatus = SamCloseHandle( UserHandle );
02645             TST_SUCCESS_ASSERT( UserHandle );
02646 
02647 
02648 
02649         }
02650 
02651         DBG_UNREFERENCED_LOCAL_VARIABLE( GroupHandle );
02652         DBG_UNREFERENCED_LOCAL_VARIABLE( OriginalGroupSD );
02653     }
02654 
02655 
02656 
02657 
02658 
02659     <span class="keywordflow">return</span> TestStatus;
02660 }
02661 
02662 
02663 BOOLEAN
02664 CheckReturnedSD(
02665     IN SECURITY_INFORMATION SI,
02666     IN PSECURITY_DESCRIPTOR SD,
02667     IN BOOLEAN              PrintTestSuccess
02668     )
02669 
02670 
02671 {
02672     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> NtStatus;
02673 
02674     BOOLEAN  Failed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
02675              IgnoreBoolean,
02676              AclPresent,
02677              TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02678 
02679     PSID     SID;
02680     PACL     ACL;
02681 
02682 
02683 
02684     <span class="comment">//</span>
02685     <span class="comment">// Check a returned security descriptor agains the information requested.</span>
02686     <span class="comment">//</span>
02687 
02688     <span class="keywordflow">if</span> (SD == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02689         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02690         <span class="keywordflow">if</span> (PrintTestSuccess) {
02691             printf(<span class="stringliteral">"Failed\n"</span>);
02692             Failed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02693             printf(<span class="stringliteral">"        The SecurityDescriptor return address was not properly\n"</span>);
02694             printf(<span class="stringliteral">"        set.\n"</span>);
02695         }
02696     }
02697 
02698 
02699     <span class="keywordflow">if</span> (TestStatus) {
02700 
02701         <span class="comment">//</span>
02702         <span class="comment">// Check owner</span>
02703         <span class="comment">//</span>
02704 
02705         NtStatus = <a class="code" href="../../d8/d6/sertl_8c.html#a65">RtlGetOwnerSecurityDescriptor</a> ( SD, &amp;SID, &amp;IgnoreBoolean);
02706         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
02707         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d4/flpt_8h.html#a0">SI</a> &amp; OWNER_SECURITY_INFORMATION) {
02708             <span class="keywordflow">if</span> (SID == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02709                 <span class="keywordflow">if</span> (PrintTestSuccess) {
02710                     <span class="keywordflow">if</span> (!Failed) {
02711                         printf(<span class="stringliteral">"Failed\n"</span>);
02712                         printf(<span class="stringliteral">"        Security descriptor address is 0x%lx\n"</span>, SD );
02713                         Failed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02714                     }
02715                     printf(<span class="stringliteral">"        An owner was requested but the owner field of the\n"</span>);
02716                     printf(<span class="stringliteral">"        security descriptor is not set.\n"</span>);
02717                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02718 
02719                 }
02720             }
02721         } <span class="keywordflow">else</span> {    <span class="comment">// Owner not specified</span>
02722             <span class="keywordflow">if</span> (SID != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02723                 <span class="keywordflow">if</span> (PrintTestSuccess) {
02724                     <span class="keywordflow">if</span> (!Failed) {
02725                         printf(<span class="stringliteral">"Failed\n"</span>);
02726                         printf(<span class="stringliteral">"        Security descriptor address is 0x%lx\n"</span>, SD );
02727                         Failed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02728                     }
02729                     printf(<span class="stringliteral">"        An owner was not requested but the owner field of the\n"</span>);
02730                     printf(<span class="stringliteral">"        security descriptor is set.\n"</span>);
02731                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02732                 }
02733             }
02734         }
02735 
02736 
02737 
02738 
02739         <span class="comment">//</span>
02740         <span class="comment">// Check group</span>
02741         <span class="comment">//</span>
02742 
02743         NtStatus = <a class="code" href="../../d8/d6/sertl_8c.html#a67">RtlGetGroupSecurityDescriptor</a> ( SD, &amp;SID, &amp;IgnoreBoolean);
02744         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
02745         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d4/flpt_8h.html#a0">SI</a> &amp; GROUP_SECURITY_INFORMATION) {
02746             <span class="keywordflow">if</span> (SID == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02747                 <span class="keywordflow">if</span> (PrintTestSuccess) {
02748                     <span class="keywordflow">if</span> (!Failed) {
02749                         printf(<span class="stringliteral">"Failed\n"</span>);
02750                         printf(<span class="stringliteral">"        Security descriptor address is 0x%lx\n"</span>, SD );
02751                         Failed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02752                     }
02753                     printf(<span class="stringliteral">"        A group was requested but the group field of the\n"</span>);
02754                     printf(<span class="stringliteral">"        security descriptor is not set.\n"</span>);
02755                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02756 
02757                 }
02758             }
02759         } <span class="keywordflow">else</span> {    <span class="comment">// Group not specified</span>
02760             <span class="keywordflow">if</span> (SID != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02761                 <span class="keywordflow">if</span> (PrintTestSuccess) {
02762                     <span class="keywordflow">if</span> (!Failed) {
02763                         printf(<span class="stringliteral">"Failed\n"</span>);
02764                         printf(<span class="stringliteral">"        Security descriptor address is 0x%lx\n"</span>, SD );
02765                         Failed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02766                     }
02767                     printf(<span class="stringliteral">"        A group was not requested but the group field of the\n"</span>);
02768                     printf(<span class="stringliteral">"        security descriptor is set.\n"</span>);
02769                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02770                 }
02771             }
02772         }
02773 
02774 
02775 
02776 
02777         <span class="comment">//</span>
02778         <span class="comment">// Check sacl</span>
02779         <span class="comment">//</span>
02780 
02781         NtStatus = <a class="code" href="../../d8/d6/sertl_8c.html#a63">RtlGetSaclSecurityDescriptor</a> ( SD, &amp;AclPresent, &amp;ACL, &amp;IgnoreBoolean);
02782         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
02783         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d4/flpt_8h.html#a0">SI</a> &amp; SACL_SECURITY_INFORMATION) {
02784             <span class="keywordflow">if</span> (!AclPresent) {
02785                 <span class="keywordflow">if</span> (PrintTestSuccess) {
02786                     <span class="keywordflow">if</span> (!Failed) {
02787                         printf(<span class="stringliteral">"Failed\n"</span>);
02788                         printf(<span class="stringliteral">"        Security descriptor address is 0x%lx\n"</span>, SD );
02789                         Failed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02790                     }
02791                     printf(<span class="stringliteral">"        An SACL was requested but the SaclPresent flag\n"</span>);
02792                     printf(<span class="stringliteral">"        of the security descriptor is not set.\n"</span>);
02793                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02794 
02795                 }
02796             }
02797         } <span class="keywordflow">else</span> {    <span class="comment">// sacl not specified</span>
02798             <span class="keywordflow">if</span> (AclPresent) {
02799                 <span class="keywordflow">if</span> (PrintTestSuccess) {
02800                     <span class="keywordflow">if</span> (!Failed) {
02801                         printf(<span class="stringliteral">"Failed\n"</span>);
02802                         printf(<span class="stringliteral">"        Security descriptor address is 0x%lx\n"</span>, SD );
02803                         Failed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02804                     }
02805                     printf(<span class="stringliteral">"        An SACL was not requested but the SaclPresent flag\n"</span>);
02806                     printf(<span class="stringliteral">"        of the security descriptor is set.\n"</span>);
02807                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02808                 }
02809             }
02810         }
02811 
02812 
02813 
02814 
02815 
02816         <span class="comment">//</span>
02817         <span class="comment">// Check Dacl</span>
02818         <span class="comment">//</span>
02819 
02820         NtStatus = <a class="code" href="../../d8/d6/sertl_8c.html#a61">RtlGetDaclSecurityDescriptor</a> ( SD, &amp;AclPresent, &amp;ACL, &amp;IgnoreBoolean);
02821         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
02822         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d4/flpt_8h.html#a0">SI</a> &amp; DACL_SECURITY_INFORMATION) {
02823             <span class="keywordflow">if</span> (!AclPresent) {
02824                 <span class="keywordflow">if</span> (PrintTestSuccess) {
02825                     <span class="keywordflow">if</span> (!Failed) {
02826                         printf(<span class="stringliteral">"Failed\n"</span>);
02827                         printf(<span class="stringliteral">"        Security descriptor address is 0x%lx\n"</span>, SD );
02828                         Failed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02829                     }
02830                     printf(<span class="stringliteral">"        A DACL was requested but the DaclPresent flag\n"</span>);
02831                     printf(<span class="stringliteral">"        of the security descriptor is not set.\n"</span>);
02832                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02833 
02834                 }
02835             }
02836         } <span class="keywordflow">else</span> {    <span class="comment">// Dacl not specified</span>
02837             <span class="keywordflow">if</span> (AclPresent) {
02838                 <span class="keywordflow">if</span> (PrintTestSuccess) {
02839                     <span class="keywordflow">if</span> (!Failed) {
02840                         printf(<span class="stringliteral">"Failed\n"</span>);
02841                         printf(<span class="stringliteral">"        Security descriptor address is 0x%lx\n"</span>, SD );
02842                         Failed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02843                     }
02844                     printf(<span class="stringliteral">"        A DACL was not requested but the DaclPresent flag\n"</span>);
02845                     printf(<span class="stringliteral">"        of the security descriptor is set.\n"</span>);
02846                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02847                 }
02848             }
02849         }
02850 
02851 
02852 
02853 
02854 
02855     }
02856 
02857 
02858 
02859 
02860     <span class="keywordflow">if</span> (PrintTestSuccess) {
02861         <span class="keywordflow">if</span> (TestStatus) {
02862             printf(<span class="stringliteral">"Succeeded\n"</span>);
02863         }
02864     }
02865 
02866 
02867 
02868     <span class="keywordflow">return</span>(TestStatus);
02869 }
02870 
02871 
02873 <span class="comment">//                                                                           //</span>
02874 <span class="comment">// Domain Object Test Suite                                                  //</span>
02875 <span class="comment">//                                                                           //</span>
02877 <span class="comment"></span>
02878 
02879 BOOLEAN
02880 DomainTestSuite(
02881     HANDLE DomainHandle
02882     )
02883 {
02884 
02885     BOOLEAN  TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02886     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> NtStatus, IgnoreStatus;
02887     PVOID    <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>, <a class="code" href="../../d9/d0/tfilmem_8c.html#a2">Buffer2</a>;
02888     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>     UnusedBuffer[20];
02889     UNICODE_STRING      AccountName;
02890     STRING              AccountNameAnsi;
02891     HANDLE GroupHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02892     HANDLE AliasHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02893     HANDLE UserHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02894     HANDLE ValidUserHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02895     ULONG  GroupRid, AliasRid, UserRid, SavedGroupRid, SavedAliasRid, AccountCount, i;
02896     SAM_ENUMERATE_HANDLE EnumerationContext;
02897     ULONG   CountReturned;
02898     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> NameLength;
02899     PUNICODE_STRING  LookedUpNames;
02900     PSID_NAME_USE    LookedUpUses;
02901     PULONG           LookedUpRids;
02902 
02903 
02904     printf(<span class="stringliteral">"\n"</span>);
02905     printf(<span class="stringliteral">"\n"</span>);
02906     printf(<span class="stringliteral">"\n"</span>);
02907     printf(<span class="stringliteral">"  Domain                                                  Test\n"</span>);
02908 
02910     <span class="comment">//                                                                       //</span>
02911     <span class="comment">// Query Suite                                                           //</span>
02912     <span class="comment">//                                                                       //</span>
02914 <span class="comment"></span>
02915     printf(<span class="stringliteral">"\n"</span>);
02916     printf(<span class="stringliteral">"    Query Information . . . . . . . . . . . . . . . . . .   Suite\n"</span>);
02917 
02918 
02919     <span class="comment">//</span>
02920     <span class="comment">// Make sure the wrapper doesn't choke on a non-null pointer being passed</span>
02921     <span class="comment">// (assuming we have allocated memory).</span>
02922     <span class="comment">//</span>
02923 
02924     printf(<span class="stringliteral">"      Query Buffer Allocation Test  . . . . . . . . . . . .     "</span>);
02925 
02926     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = &amp;UnusedBuffer[0];
02927     NtStatus = SamQueryInformationDomain(
02928                    DomainHandle,
02929                    DomainStateInformation,
02930                    &amp;Buffer
02931                    );
02932     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
02933         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != &amp;UnusedBuffer[0]) {
02934             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02935                 printf(<span class="stringliteral">"Succeeded\n"</span>);
02936                 SamFreeMemory( Buffer );
02937             } <span class="keywordflow">else</span> {
02938                 printf(<span class="stringliteral">"Failed\n"</span>);
02939                 printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
02940                 printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
02941                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02942             }
02943         } <span class="keywordflow">else</span> {
02944             printf(<span class="stringliteral">"Failed\n"</span>);
02945             printf(<span class="stringliteral">"        Passed buffer address used on return.\n"</span>);
02946             printf(<span class="stringliteral">"        RPC should have allocated another buffer.\n"</span>);
02947             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02948         }
02949     } <span class="keywordflow">else</span> {
02950         printf(<span class="stringliteral">"Failed\n"</span>);
02951         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
02952         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02953     }
02954 
02955 
02956     <span class="comment">//</span>
02957     <span class="comment">// Query all the fixed length info levels</span>
02958     <span class="comment">//  Query - Password, Logoff, ServerRole, DomainState, ModifiedCount, LockoutInfo</span>
02959     <span class="comment">//</span>
02960 
02961     printf(<span class="stringliteral">"      Query DomainState . . . . . . . . . . . . . . . . . .     "</span>);
02962 
02963     NtStatus = SamQueryInformationDomain(
02964                    DomainHandle,
02965                    DomainStateInformation,
02966                    &amp;Buffer
02967                    );
02968     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
02969         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02970                 printf(<span class="stringliteral">"Succeeded\n"</span>);
02971                 SamFreeMemory( Buffer );
02972         } <span class="keywordflow">else</span> {
02973             printf(<span class="stringliteral">"Failed\n"</span>);
02974             printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
02975             printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
02976             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02977         }
02978     } <span class="keywordflow">else</span> {
02979         printf(<span class="stringliteral">"Failed\n"</span>);
02980         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
02981         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02982 
02983     }
02984 
02985 
02986     printf(<span class="stringliteral">"      Query ServerRole  . . . . . . . . . . . . . . . . . .     "</span>);
02987     NtStatus = SamQueryInformationDomain(
02988                    DomainHandle,
02989                    DomainServerRoleInformation,
02990                    &amp;Buffer
02991                    );
02992     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
02993         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02994                 printf(<span class="stringliteral">"Succeeded\n"</span>);
02995                 SamFreeMemory( Buffer );
02996         } <span class="keywordflow">else</span> {
02997             printf(<span class="stringliteral">"Failed\n"</span>);
02998             printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
02999             printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
03000             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03001         }
03002     } <span class="keywordflow">else</span> {
03003         printf(<span class="stringliteral">"Failed\n"</span>);
03004         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
03005         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03006 
03007     }
03008 
03009 
03010     printf(<span class="stringliteral">"      Query Password Information  . . . . . . . . . . . . .     "</span>);
03011     NtStatus = SamQueryInformationDomain(
03012                    DomainHandle,
03013                    DomainPasswordInformation,
03014                    &amp;Buffer
03015                    );
03016     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
03017         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03018                 printf(<span class="stringliteral">"Succeeded\n"</span>);
03019                 SamFreeMemory( Buffer );
03020         } <span class="keywordflow">else</span> {
03021             printf(<span class="stringliteral">"Failed\n"</span>);
03022             printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
03023             printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
03024             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03025         }
03026     } <span class="keywordflow">else</span> {
03027         printf(<span class="stringliteral">"Failed\n"</span>);
03028         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
03029         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03030 
03031     }
03032 
03033 
03034     printf(<span class="stringliteral">"      Query Logoff Information  . . . . . . . . . . . . . .     "</span>);
03035     NtStatus = SamQueryInformationDomain(
03036                    DomainHandle,
03037                    DomainLogoffInformation,
03038                    &amp;Buffer
03039                    );
03040     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
03041         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03042                 printf(<span class="stringliteral">"Succeeded\n"</span>);
03043                 SamFreeMemory( Buffer );
03044         } <span class="keywordflow">else</span> {
03045             printf(<span class="stringliteral">"Failed\n"</span>);
03046             printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
03047             printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
03048             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03049         }
03050     } <span class="keywordflow">else</span> {
03051         printf(<span class="stringliteral">"Failed\n"</span>);
03052         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
03053         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03054 
03055     }
03056 
03057 
03058     printf(<span class="stringliteral">"      Query Modified  . . . . . . . . . . . . . . . . . . .     "</span>);
03059     NtStatus = SamQueryInformationDomain(
03060                    DomainHandle,
03061                    DomainModifiedInformation,
03062                    &amp;Buffer
03063                    );
03064     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
03065         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03066                 printf(<span class="stringliteral">"Succeeded\n"</span>);
03067                 SamFreeMemory( Buffer );
03068         } <span class="keywordflow">else</span> {
03069             printf(<span class="stringliteral">"Failed\n"</span>);
03070             printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
03071             printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
03072             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03073         }
03074     } <span class="keywordflow">else</span> {
03075         printf(<span class="stringliteral">"Failed\n"</span>);
03076         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
03077         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03078 
03079     }
03080 
03081 
03082     printf(<span class="stringliteral">"      Query Lockout . . . . . . . . . . . . . . . . . . . .     "</span>);
03083     NtStatus = SamQueryInformationDomain(
03084                    DomainHandle,
03085                    DomainLockoutInformation,
03086                    &amp;Buffer
03087                    );
03088     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
03089         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03090                 printf(<span class="stringliteral">"Succeeded\n"</span>);
03091                 SamFreeMemory( Buffer );
03092         } <span class="keywordflow">else</span> {
03093             printf(<span class="stringliteral">"Failed\n"</span>);
03094             printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
03095             printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
03096             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03097         }
03098     } <span class="keywordflow">else</span> {
03099         printf(<span class="stringliteral">"Failed\n"</span>);
03100         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
03101         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03102 
03103     }
03104 
03105 
03106 
03107 
03108 
03109     <span class="comment">//</span>
03110     <span class="comment">// Query the name of the domain ...</span>
03111     <span class="comment">//</span>
03112 
03113     printf(<span class="stringliteral">"      Query Domain Name . . . . . . . . . . . . . . . . . .     "</span>);
03114 
03115     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03116     NtStatus = SamQueryInformationDomain(
03117                    DomainHandle,
03118                    DomainNameInformation,
03119                    &amp;Buffer
03120                    );
03121     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
03122         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03123             <span class="keywordflow">if</span> ( (((DOMAIN_NAME_INFORMATION *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;DomainName.MaximumLength &gt; 0) &amp;&amp;
03124                  (((DOMAIN_NAME_INFORMATION *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;DomainName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
03125 
03126                 printf(<span class="stringliteral">"Succeeded\n"</span>);
03127 
03128             } <span class="keywordflow">else</span> {
03129                 printf(<span class="stringliteral">"Failed\n"</span>);
03130                 printf(<span class="stringliteral">"        String body returned and allocated,\n"</span>);
03131                 printf(<span class="stringliteral">"        but character buffer pointer is NULL.\n"</span>);
03132                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03133             }
03134             SamFreeMemory( Buffer );
03135         } <span class="keywordflow">else</span> {
03136             printf(<span class="stringliteral">"Failed\n"</span>);
03137             printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
03138             printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
03139             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03140         }
03141     } <span class="keywordflow">else</span> {
03142         printf(<span class="stringliteral">"Failed\n"</span>);
03143         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
03144         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03145     }
03146 
03147 
03148 
03149     <span class="comment">//</span>
03150     <span class="comment">// Query whatever is in the OEM Information field ...</span>
03151     <span class="comment">//</span>
03152 
03153     printf(<span class="stringliteral">"      Query OEM Information . . . . . . . . . . . . . . . .     "</span>);
03154 
03155     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03156     NtStatus = SamQueryInformationDomain(
03157                    DomainHandle,
03158                    DomainOemInformation,
03159                    &amp;Buffer
03160                    );
03161     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
03162         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03163             <span class="keywordflow">if</span> ( (((DOMAIN_OEM_INFORMATION *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;OemInformation.MaximumLength &gt;= 0) &amp;&amp;
03164                  (((DOMAIN_OEM_INFORMATION *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;OemInformation.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
03165 
03166                 printf(<span class="stringliteral">"Succeeded\n"</span>);
03167 
03168             } <span class="keywordflow">else</span> {
03169                 printf(<span class="stringliteral">"Failed\n"</span>);
03170                 printf(<span class="stringliteral">"        String body returned and allocated,\n"</span>);
03171                 printf(<span class="stringliteral">"        but character buffer pointer is NULL.\n"</span>);
03172                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03173             }
03174             SamFreeMemory( Buffer );
03175         } <span class="keywordflow">else</span> {
03176             printf(<span class="stringliteral">"Failed\n"</span>);
03177             printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
03178             printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
03179             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03180         }
03181     } <span class="keywordflow">else</span> {
03182         printf(<span class="stringliteral">"Failed\n"</span>);
03183         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
03184         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03185     }
03186 
03187 
03188 
03189     <span class="comment">//</span>
03190     <span class="comment">// Query whatever is in the Replication Information field ...</span>
03191     <span class="comment">//</span>
03192 
03193     printf(<span class="stringliteral">"      Query Replication Information . . . . . . . . . . . .     "</span>);
03194 
03195     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03196     NtStatus = SamQueryInformationDomain(
03197                    DomainHandle,
03198                    DomainReplicationInformation,
03199                    &amp;Buffer
03200                    );
03201     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
03202         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03203             <span class="keywordflow">if</span> ( (((DOMAIN_REPLICATION_INFORMATION *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;ReplicaSourceNodeName.MaximumLength &gt;= 0) &amp;&amp;
03204                  (((DOMAIN_REPLICATION_INFORMATION *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;ReplicaSourceNodeName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
03205 
03206                 printf(<span class="stringliteral">"Succeeded\n"</span>);
03207 
03208             } <span class="keywordflow">else</span> {
03209                 printf(<span class="stringliteral">"Failed\n"</span>);
03210                 printf(<span class="stringliteral">"        String body returned and allocated,\n"</span>);
03211                 printf(<span class="stringliteral">"        but character buffer pointer is NULL.\n"</span>);
03212                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03213             }
03214             SamFreeMemory( Buffer );
03215         } <span class="keywordflow">else</span> {
03216             printf(<span class="stringliteral">"Failed\n"</span>);
03217             printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
03218             printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
03219             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03220         }
03221     } <span class="keywordflow">else</span> {
03222         printf(<span class="stringliteral">"Failed\n"</span>);
03223         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
03224         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03225     }
03226 
03227 
03228 
03229     <span class="comment">//</span>
03230     <span class="comment">// Query domain general Information...</span>
03231     <span class="comment">//</span>
03232 
03233     printf(<span class="stringliteral">"      Query General Information . . . . . . . . . . . . . .     "</span>);
03234 
03235     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03236     NtStatus = SamQueryInformationDomain(
03237                    DomainHandle,
03238                    DomainGeneralInformation,
03239                    &amp;Buffer
03240                    );
03241     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
03242         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03243 
03244             printf(<span class="stringliteral">"Succeeded\n"</span>);
03245             printf(<span class="stringliteral">"          Number of Users  is: 0x%lx\n"</span>,
03246                  ((DOMAIN_GENERAL_INFORMATION *)Buffer)-&gt;UserCount );
03247             printf(<span class="stringliteral">"          Number of groups is: 0x%lx\n"</span>,
03248                  ((DOMAIN_GENERAL_INFORMATION *)Buffer)-&gt;GroupCount);
03249             printf(<span class="stringliteral">"          Number of aliases is: 0x%lx\n"</span>,
03250                  ((DOMAIN_GENERAL_INFORMATION *)Buffer)-&gt;AliasCount);
03251 
03252 
03253             SamFreeMemory( Buffer );
03254 
03255         } <span class="keywordflow">else</span> {
03256             printf(<span class="stringliteral">"Failed\n"</span>);
03257             printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
03258             printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
03259             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03260         }
03261     } <span class="keywordflow">else</span> {
03262         printf(<span class="stringliteral">"Failed\n"</span>);
03263         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
03264         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03265     }
03266 
03267 
03268 
03269     <span class="comment">//</span>
03270     <span class="comment">// Query domain general Information...</span>
03271     <span class="comment">//</span>
03272 
03273     printf(<span class="stringliteral">"      Query General Information 2 . . . . . . . . . . . . .     "</span>);
03274 
03275     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03276     NtStatus = SamQueryInformationDomain(
03277                    DomainHandle,
03278                    DomainGeneralInformation2,
03279                    &amp;Buffer
03280                    );
03281     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
03282         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03283 
03284             printf(<span class="stringliteral">"Succeeded\n"</span>);
03285             printf(<span class="stringliteral">"          Number of Users  is: 0x%lx\n"</span>,
03286                  ((DOMAIN_GENERAL_INFORMATION2 *)Buffer)-&gt;I1.UserCount );
03287             printf(<span class="stringliteral">"          Number of groups is: 0x%lx\n"</span>,
03288                  ((DOMAIN_GENERAL_INFORMATION2 *)Buffer)-&gt;I1.GroupCount);
03289             printf(<span class="stringliteral">"          Number of aliases is: 0x%lx\n"</span>,
03290                  ((DOMAIN_GENERAL_INFORMATION2 *)Buffer)-&gt;I1.AliasCount);
03291 
03292 
03293             SamFreeMemory( Buffer );
03294 
03295         } <span class="keywordflow">else</span> {
03296             printf(<span class="stringliteral">"Failed\n"</span>);
03297             printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
03298             printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
03299             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03300         }
03301     } <span class="keywordflow">else</span> {
03302         printf(<span class="stringliteral">"Failed\n"</span>);
03303         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
03304         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03305     }
03306 
03307 
03308 
03309 
03310 
03311 
03312 
03313 
03315     <span class="comment">//                                                                       //</span>
03316     <span class="comment">// Set Suite                                                             //</span>
03317     <span class="comment">//                                                                       //</span>
03319 <span class="comment"></span>
03320     printf(<span class="stringliteral">"    Set Information . . . . . . . . . . . . . . . . . . .   Suite\n"</span>);
03321 
03322     <span class="comment">//</span>
03323     <span class="comment">// Set all the fixed length info levels</span>
03324     <span class="comment">//   - Password, Logoff, ServerRole, DomainState, ModifiedCount</span>
03325     <span class="comment">//</span>
03326 
03327 <span class="comment">/*</span>
03328 <span class="comment"> *  CANT TEST SERVER STATE SETTING WITHOUT BREAKING THE REST OF THE TEST.</span>
03329 <span class="comment"> *  THE REASON IS, ONCE THE STATE IS CHANGED, NOTHING ELSE CAN BE DONE.</span>
03330 <span class="comment"> *</span>
03331 <span class="comment"> *    printf("      Set DomainState . . . . . . . . . . . . . . . . . . .     ");</span>
03332 <span class="comment"> *</span>
03333 <span class="comment"> *    //</span>
03334 <span class="comment"> *    // Get the current value...</span>
03335 <span class="comment"> *    //</span>
03336 <span class="comment"> *</span>
03337 <span class="comment"> *    NtStatus = SamQueryInformationDomain(</span>
03338 <span class="comment"> *                   DomainHandle,</span>
03339 <span class="comment"> *                   DomainStateInformation,</span>
03340 <span class="comment"> *                   &amp;Buffer1</span>
03341 <span class="comment"> *                   );</span>
03342 <span class="comment"> *    ASSERT( NT_SUCCESS(NtStatus) );</span>
03343 <span class="comment"> *</span>
03344 <span class="comment"> *    //</span>
03345 <span class="comment"> *    // Change the field to a new value and write it out.</span>
03346 <span class="comment"> *    //</span>
03347 <span class="comment"> *</span>
03348 <span class="comment"> *    if ( ((DOMAIN_STATE_INFORMATION *)Buffer1)-&gt;DomainServerState ==</span>
03349 <span class="comment"> *         DomainServerEnabled ) {</span>
03350 <span class="comment"> *        ((DOMAIN_STATE_INFORMATION *)Buffer1)-&gt;DomainServerState =</span>
03351 <span class="comment"> *            DomainServerDisabled;</span>
03352 <span class="comment"> *    } else {</span>
03353 <span class="comment"> *        ((DOMAIN_STATE_INFORMATION *)Buffer1)-&gt;DomainServerState =</span>
03354 <span class="comment"> *            DomainServerEnabled;</span>
03355 <span class="comment"> *    }</span>
03356 <span class="comment"> *</span>
03357 <span class="comment"> *    NtStatus = SamSetInformationDomain(</span>
03358 <span class="comment"> *                   DomainHandle,</span>
03359 <span class="comment"> *                   DomainStateInformation,</span>
03360 <span class="comment"> *                   Buffer1</span>
03361 <span class="comment"> *                   );</span>
03362 <span class="comment"> *    if ( NT_SUCCESS(NtStatus) ) {</span>
03363 <span class="comment"> *</span>
03364 <span class="comment"> *        //</span>
03365 <span class="comment"> *        // Now check that the change was really made...</span>
03366 <span class="comment"> *        //</span>
03367 <span class="comment"> *</span>
03368 <span class="comment"> *        NtStatus = SamQueryInformationDomain(</span>
03369 <span class="comment"> *                       DomainHandle,</span>
03370 <span class="comment"> *                       DomainStateInformation,</span>
03371 <span class="comment"> *                       &amp;Buffer2</span>
03372 <span class="comment"> *                       );</span>
03373 <span class="comment"> *        ASSERT(NT_SUCCESS( NtStatus ) );</span>
03374 <span class="comment"> *        if (((DOMAIN_STATE_INFORMATION *)Buffer1)-&gt;DomainServerState ==</span>
03375 <span class="comment"> *            ((DOMAIN_STATE_INFORMATION *)Buffer2)-&gt;DomainServerState    ) {</span>
03376 <span class="comment"> *</span>
03377 <span class="comment"> *                printf("Succeeded\n");</span>
03378 <span class="comment"> *</span>
03379 <span class="comment"> *        } else {</span>
03380 <span class="comment"> *</span>
03381 <span class="comment"> *            printf("Failed\n");</span>
03382 <span class="comment"> *            printf("        Value queried doesn't match value written\n");</span>
03383 <span class="comment"> *            printf("        Value Written is   0x%lx\n",</span>
03384 <span class="comment"> *                (ULONG)((DOMAIN_STATE_INFORMATION *)Buffer1)-&gt;DomainServerState);</span>
03385 <span class="comment"> *            printf("        Value Retrieved is 0x%lx\n",</span>
03386 <span class="comment"> *                (ULONG)((DOMAIN_STATE_INFORMATION *)Buffer2)-&gt;DomainServerState);</span>
03387 <span class="comment"> *</span>
03388 <span class="comment"> *            TestStatus = FALSE;</span>
03389 <span class="comment"> *</span>
03390 <span class="comment"> *        }</span>
03391 <span class="comment"> *</span>
03392 <span class="comment"> *        SamFreeMemory( Buffer1 );</span>
03393 <span class="comment"> *        SamFreeMemory( Buffer2 );</span>
03394 <span class="comment"> *</span>
03395 <span class="comment"> *    } else {</span>
03396 <span class="comment"> *        printf("Failed\n");</span>
03397 <span class="comment"> *        printf("        Completion status is 0x%lx\n", NtStatus);</span>
03398 <span class="comment"> *        TestStatus = FALSE;</span>
03399 <span class="comment"> *        SamFreeMemory( Buffer1 );</span>
03400 <span class="comment"> *</span>
03401 <span class="comment"> *    }</span>
03402 <span class="comment"> */</span>
03403 
03404 
03405 
03406 <span class="comment">/*</span>
03407 <span class="comment"> *  CANT TEST SERVER ROLE SETTING WITHOUT BREAKING THE REST OF THE TEST.</span>
03408 <span class="comment"> *  THE REASON IS, ONCE THE ROLE IS SET TO BACKUP, NOTHING ELSE CAN BE</span>
03409 <span class="comment"> *  SET.</span>
03410 <span class="comment"> *</span>
03411 <span class="comment"> *   printf("      Set ServerRole  . . . . . . . . . . . . . . . . . . .     ");</span>
03412 <span class="comment"> *</span>
03413 <span class="comment"> *   //</span>
03414 <span class="comment"> *   // Get the current value...</span>
03415 <span class="comment"> *   //</span>
03416 <span class="comment"> *</span>
03417 <span class="comment"> *   NtStatus = SamQueryInformationDomain(</span>
03418 <span class="comment"> *                  DomainHandle,</span>
03419 <span class="comment"> *                  DomainServerRoleInformation,</span>
03420 <span class="comment"> *                  &amp;Buffer1</span>
03421 <span class="comment"> *                  );</span>
03422 <span class="comment"> *   ASSERT( NT_SUCCESS(NtStatus) );</span>
03423 <span class="comment"> *</span>
03424 <span class="comment"> *   //</span>
03425 <span class="comment"> *   // Change the field to a new value and write it out.</span>
03426 <span class="comment"> *   //</span>
03427 <span class="comment"> *</span>
03428 <span class="comment"> *   if ( ((DOMAIN_SERVER_ROLE_INFORMATION *)Buffer1)-&gt;DomainServerRole ==</span>
03429 <span class="comment"> *        DomainServerRolePrimary ) {</span>
03430 <span class="comment"> *       ((DOMAIN_SERVER_ROLE_INFORMATION *)Buffer1)-&gt;DomainServerRole =</span>
03431 <span class="comment"> *           DomainServerRoleBackup;</span>
03432 <span class="comment"> *   } else {</span>
03433 <span class="comment"> *       ((DOMAIN_SERVER_ROLE_INFORMATION *)Buffer1)-&gt;DomainServerRole =</span>
03434 <span class="comment"> *           DomainServerRolePrimary;</span>
03435 <span class="comment"> *   }</span>
03436 <span class="comment"> *</span>
03437 <span class="comment"> *   NtStatus = SamSetInformationDomain(</span>
03438 <span class="comment"> *                  DomainHandle,</span>
03439 <span class="comment"> *                  DomainServerRoleInformation,</span>
03440 <span class="comment"> *                  Buffer1</span>
03441 <span class="comment"> *                  );</span>
03442 <span class="comment"> *   if ( NT_SUCCESS(NtStatus) ) {</span>
03443 <span class="comment"> *</span>
03444 <span class="comment"> *       //</span>
03445 <span class="comment"> *       // Now check that the change was really made...</span>
03446 <span class="comment"> *       //</span>
03447 <span class="comment"> *</span>
03448 <span class="comment"> *       NtStatus = SamQueryInformationDomain(</span>
03449 <span class="comment"> *                      DomainHandle,</span>
03450 <span class="comment"> *                      DomainServerRoleInformation,</span>
03451 <span class="comment"> *                      &amp;Buffer2</span>
03452 <span class="comment"> *                      );</span>
03453 <span class="comment"> *       ASSERT(NT_SUCCESS( NtStatus ) );</span>
03454 <span class="comment"> *       if (((DOMAIN_SERVER_ROLE_INFORMATION *)Buffer1)-&gt;DomainServerRole ==</span>
03455 <span class="comment"> *           ((DOMAIN_SERVER_ROLE_INFORMATION *)Buffer2)-&gt;DomainServerRole    ) {</span>
03456 <span class="comment"> *</span>
03457 <span class="comment"> *               printf("Succeeded\n");</span>
03458 <span class="comment"> *</span>
03459 <span class="comment"> *       } else {</span>
03460 <span class="comment"> *</span>
03461 <span class="comment"> *           printf("Failed\n");</span>
03462 <span class="comment"> *           printf("        Value queried doesn't match value written\n");</span>
03463 <span class="comment"> *           printf("        Value Written is   0x%lx\n",</span>
03464 <span class="comment"> *               (ULONG)((DOMAIN_SERVER_ROLE_INFORMATION *)Buffer1)-&gt;DomainServerRole);</span>
03465 <span class="comment"> *           printf("        Value Retrieved is 0x%lx\n",</span>
03466 <span class="comment"> *               (ULONG)((DOMAIN_SERVER_ROLE_INFORMATION *)Buffer2)-&gt;DomainServerRole);</span>
03467 <span class="comment"> *</span>
03468 <span class="comment"> *           TestStatus = FALSE;</span>
03469 <span class="comment"> *</span>
03470 <span class="comment"> *       }</span>
03471 <span class="comment"> *</span>
03472 <span class="comment"> *       SamFreeMemory( Buffer1 );</span>
03473 <span class="comment"> *       SamFreeMemory( Buffer2 );</span>
03474 <span class="comment"> *</span>
03475 <span class="comment"> *   } else {</span>
03476 <span class="comment"> *       printf("Failed\n");</span>
03477 <span class="comment"> *       printf("        Completion status is 0x%lx\n", NtStatus);</span>
03478 <span class="comment"> *       TestStatus = FALSE;</span>
03479 <span class="comment"> *       SamFreeMemory( Buffer1 );</span>
03480 <span class="comment"> *</span>
03481 <span class="comment"> *   }</span>
03482 <span class="comment"> */</span>
03483 
03484 
03485 
03486     printf(<span class="stringliteral">"      Set Password Information  . . . . . . . . . . . . . .     "</span>);
03487 
03488 
03489     <span class="comment">//</span>
03490     <span class="comment">// Get the current value...</span>
03491     <span class="comment">//</span>
03492 
03493     NtStatus = SamQueryInformationDomain(
03494                    DomainHandle,
03495                    DomainPasswordInformation,
03496                    &amp;Buffer1
03497                    );
03498     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
03499 
03500     <span class="comment">//</span>
03501     <span class="comment">// Change a field to a new value and write it out.</span>
03502     <span class="comment">//</span>
03503 
03504     <span class="keywordflow">if</span> ( ((DOMAIN_PASSWORD_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;MinPasswordLength == 0 ) {
03505          ((DOMAIN_PASSWORD_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;MinPasswordLength =  6;
03506     } <span class="keywordflow">else</span> {
03507         ((DOMAIN_PASSWORD_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;MinPasswordLength =   0;
03508     }
03509 
03510     <span class="comment">//</span>
03511     <span class="comment">// Set PasswordProperties to COMPLEX so that tests run after this one</span>
03512     <span class="comment">// are a little more interesting.</span>
03513     <span class="comment">//</span>
03514 
03515     ((DOMAIN_PASSWORD_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;PasswordProperties |= DOMAIN_PASSWORD_COMPLEX;
03516 
03517     NtStatus = SamSetInformationDomain(
03518                    DomainHandle,
03519                    DomainPasswordInformation,
03520                    Buffer1
03521                    );
03522     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) ) {
03523 
03524         <span class="comment">//</span>
03525         <span class="comment">// Now check that the change was really made...</span>
03526         <span class="comment">//</span>
03527 
03528         NtStatus = SamQueryInformationDomain(
03529                        DomainHandle,
03530                        DomainPasswordInformation,
03531                        &amp;Buffer2
03532                        );
03533         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( NtStatus ) );
03534         <span class="keywordflow">if</span> (((DOMAIN_PASSWORD_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;MinPasswordLength ==
03535             ((DOMAIN_PASSWORD_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a2">Buffer2</a>)-&gt;MinPasswordLength    ) {
03536 
03537                 printf(<span class="stringliteral">"Succeeded\n"</span>);
03538 
03539         } <span class="keywordflow">else</span> {
03540 
03541             printf(<span class="stringliteral">"Failed\n"</span>);
03542             printf(<span class="stringliteral">"        Value queried doesn't match value written\n"</span>);
03543             printf(<span class="stringliteral">"        Value Written is   0x%lx\n"</span>,
03544                 (ULONG)((DOMAIN_PASSWORD_INFORMATION *)Buffer1)-&gt;MinPasswordLength);
03545             printf(<span class="stringliteral">"        Value Retrieved is 0x%lx\n"</span>,
03546                 (ULONG)((DOMAIN_PASSWORD_INFORMATION *)Buffer2)-&gt;MinPasswordLength);
03547 
03548             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03549 
03550         }
03551 
03552         SamFreeMemory( Buffer1 );
03553         SamFreeMemory( Buffer2 );
03554 
03555     } <span class="keywordflow">else</span> {
03556         printf(<span class="stringliteral">"Failed\n"</span>);
03557         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
03558         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03559         SamFreeMemory( Buffer1 );
03560 
03561     }
03562 
03563 
03564 
03565     printf(<span class="stringliteral">"      Set Logoff Information  . . . . . . . . . . . . . . .     "</span>);
03566 
03567     <span class="comment">//</span>
03568     <span class="comment">// Get the current value...</span>
03569     <span class="comment">//</span>
03570 
03571     NtStatus = SamQueryInformationDomain(
03572                    DomainHandle,
03573                    DomainLogoffInformation,
03574                    &amp;Buffer1
03575                    );
03576     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
03577 
03578     <span class="comment">//</span>
03579     <span class="comment">// Change the field to a new value and write it out.</span>
03580     <span class="comment">//</span>
03581 
03582     <span class="keywordflow">if</span> ( ((DOMAIN_LOGOFF_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;ForceLogoff.LowPart == 0 ) {
03583          ((DOMAIN_LOGOFF_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;ForceLogoff.LowPart = 1000;
03584     } <span class="keywordflow">else</span> {
03585         ((DOMAIN_LOGOFF_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;ForceLogoff.LowPart =   0;
03586     }
03587 
03588     NtStatus = SamSetInformationDomain(
03589                    DomainHandle,
03590                    DomainLogoffInformation,
03591                    Buffer1
03592                    );
03593     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) ) {
03594 
03595         <span class="comment">//</span>
03596         <span class="comment">// Now check that the change was really made...</span>
03597         <span class="comment">//</span>
03598 
03599         NtStatus = SamQueryInformationDomain(
03600                        DomainHandle,
03601                        DomainLogoffInformation,
03602                        &amp;Buffer2
03603                        );
03604         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( NtStatus ) );
03605         <span class="keywordflow">if</span> (((DOMAIN_LOGOFF_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;ForceLogoff.LowPart ==
03606             ((DOMAIN_LOGOFF_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a2">Buffer2</a>)-&gt;ForceLogoff.LowPart    ) {
03607 
03608                 printf(<span class="stringliteral">"Succeeded\n"</span>);
03609 
03610         } <span class="keywordflow">else</span> {
03611 
03612             printf(<span class="stringliteral">"Failed\n"</span>);
03613             printf(<span class="stringliteral">"        Value queried doesn't match value written\n"</span>);
03614             printf(<span class="stringliteral">"        Value Written is   0x%lx\n"</span>,
03615                 (ULONG)((DOMAIN_LOGOFF_INFORMATION *)Buffer1)-&gt;ForceLogoff.LowPart);
03616             printf(<span class="stringliteral">"        Value Retrieved is 0x%lx\n"</span>,
03617                 (ULONG)((DOMAIN_LOGOFF_INFORMATION *)Buffer2)-&gt;ForceLogoff.LowPart);
03618 
03619             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03620 
03621         }
03622 
03623         SamFreeMemory( Buffer1 );
03624         SamFreeMemory( Buffer2 );
03625 
03626     } <span class="keywordflow">else</span> {
03627         printf(<span class="stringliteral">"Failed\n"</span>);
03628         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
03629         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03630         SamFreeMemory( Buffer1 );
03631 
03632     }
03633 
03634 
03635 
03636     printf(<span class="stringliteral">"      Set Modified  . . . . . . . . . . . . . . . . . . . .     "</span>);
03637 
03638 
03639     NtStatus = SamSetInformationDomain(
03640                    DomainHandle,
03641                    DomainModifiedInformation,
03642                    &amp;LargeInteger1
03643                    );
03644 
03645     <span class="keywordflow">if</span> (NtStatus != STATUS_INVALID_INFO_CLASS) {
03646 
03647         printf(<span class="stringliteral">"Failed\n"</span>);
03648         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
03649         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03650     } <span class="keywordflow">else</span> {
03651         printf(<span class="stringliteral">"Succeeded\n"</span>);
03652     }
03653 
03654 
03655     printf(<span class="stringliteral">"      Set Lockout Information . . . . . . . . . . . . . . .     "</span>);
03656 
03657     <span class="comment">//</span>
03658     <span class="comment">// Get the current value...</span>
03659     <span class="comment">//</span>
03660 
03661     NtStatus = SamQueryInformationDomain(
03662                    DomainHandle,
03663                    DomainLockoutInformation,
03664                    &amp;Buffer1
03665                    );
03666     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
03667 
03668     <span class="comment">//</span>
03669     <span class="comment">// Change the field to a new value and write it out.</span>
03670     <span class="comment">//</span>
03671 
03672     <span class="keywordflow">if</span> ( ((DOMAIN_LOCKOUT_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;LockoutDuration.LowPart == 0 ) {
03673          ((DOMAIN_LOCKOUT_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;LockoutDuration.LowPart = 9000000;
03674     } <span class="keywordflow">else</span> {
03675         ((DOMAIN_LOCKOUT_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;LockoutDuration.LowPart =   0;
03676     }
03677     <span class="keywordflow">if</span> ( ((DOMAIN_LOCKOUT_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;LockoutObservationWindow.LowPart == 0 ) {
03678          ((DOMAIN_LOCKOUT_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;LockoutObservationWindow.LowPart = 8000000;
03679     } <span class="keywordflow">else</span> {
03680         ((DOMAIN_LOCKOUT_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;LockoutObservationWindow.LowPart =   0;
03681     }
03682     <span class="keywordflow">if</span> ( ((DOMAIN_LOCKOUT_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;LockoutThreshold == 0 ) {
03683          ((DOMAIN_LOCKOUT_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;LockoutThreshold =  2;
03684     } <span class="keywordflow">else</span> {
03685         ((DOMAIN_LOCKOUT_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;LockoutThreshold  =  0;
03686     }
03687 
03688     NtStatus = SamSetInformationDomain(
03689                    DomainHandle,
03690                    DomainLockoutInformation,
03691                    Buffer1
03692                    );
03693     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) ) {
03694 
03695         <span class="comment">//</span>
03696         <span class="comment">// Now check that the change was really made...</span>
03697         <span class="comment">//</span>
03698 
03699         NtStatus = SamQueryInformationDomain(
03700                        DomainHandle,
03701                        DomainLockoutInformation,
03702                        &amp;Buffer2
03703                        );
03704         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( NtStatus ) );
03705         <span class="keywordflow">if</span> ( (((DOMAIN_LOCKOUT_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;LockoutDuration.LowPart ==
03706              ((DOMAIN_LOCKOUT_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a2">Buffer2</a>)-&gt;LockoutDuration.LowPart    ) &amp;&amp;
03707              (((DOMAIN_LOCKOUT_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;LockoutObservationWindow.LowPart ==
03708              ((DOMAIN_LOCKOUT_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a2">Buffer2</a>)-&gt;LockoutObservationWindow.LowPart    ) &amp;&amp;
03709              (((DOMAIN_LOCKOUT_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;LockoutThreshold ==
03710              ((DOMAIN_LOCKOUT_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a2">Buffer2</a>)-&gt;LockoutThreshold    ) ) {
03711 
03712                 printf(<span class="stringliteral">"Succeeded\n"</span>);
03713 
03714         } <span class="keywordflow">else</span> {
03715 
03716             printf(<span class="stringliteral">"Failed\n"</span>);
03717             printf(<span class="stringliteral">"        Value queried doesn't match value written\n"</span>);
03718             printf(<span class="stringliteral">"        Duration Written is   0x%lx\n"</span>,
03719                 (ULONG)((DOMAIN_LOCKOUT_INFORMATION *)Buffer1)-&gt;LockoutDuration.LowPart);
03720             printf(<span class="stringliteral">"        Duration  Retrieved is 0x%lx\n"</span>,
03721                 (ULONG)((DOMAIN_LOCKOUT_INFORMATION *)Buffer2)-&gt;LockoutDuration.LowPart);
03722             printf(<span class="stringliteral">"        Window Written is   0x%lx\n"</span>,
03723                 (ULONG)((DOMAIN_LOCKOUT_INFORMATION *)Buffer1)-&gt;LockoutObservationWindow.LowPart);
03724             printf(<span class="stringliteral">"        Window  Retrieved is 0x%lx\n"</span>,
03725                 (ULONG)((DOMAIN_LOCKOUT_INFORMATION *)Buffer2)-&gt;LockoutObservationWindow.LowPart);
03726             printf(<span class="stringliteral">"        Duration Written is   0x%lx\n"</span>,
03727                 (ULONG)((DOMAIN_LOCKOUT_INFORMATION *)Buffer1)-&gt;LockoutThreshold);
03728             printf(<span class="stringliteral">"        Duration  Retrieved is 0x%lx\n"</span>,
03729                 (ULONG)((DOMAIN_LOCKOUT_INFORMATION *)Buffer2)-&gt;LockoutThreshold);
03730 
03731             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03732 
03733         }
03734 
03735         SamFreeMemory( Buffer1 );
03736         SamFreeMemory( Buffer2 );
03737 
03738     } <span class="keywordflow">else</span> {
03739         printf(<span class="stringliteral">"Failed\n"</span>);
03740         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
03741         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03742         SamFreeMemory( Buffer1 );
03743 
03744     }
03745 
03746 
03747 
03748 
03749     printf(<span class="stringliteral">"      Set Domain Name . . . . . . . . . . . . . . . . . . .     "</span>);
03750 
03751 
03752     NtStatus = SamSetInformationDomain(
03753                    DomainHandle,
03754                    DomainNameInformation,
03755                    &amp;DummyName1
03756                    );
03757 
03758     <span class="keywordflow">if</span> (NtStatus != STATUS_INVALID_INFO_CLASS) {
03759 
03760         printf(<span class="stringliteral">"Failed\n"</span>);
03761         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
03762         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03763     } <span class="keywordflow">else</span> {
03764         printf(<span class="stringliteral">"Succeeded\n"</span>);
03765     }
03766 
03767 
03768     printf(<span class="stringliteral">"      Set OEM Information . . . . . . . . . . . . . . . . .     "</span>);
03769 
03770     <span class="comment">//</span>
03771     <span class="comment">// Get the current value...</span>
03772     <span class="comment">//</span>
03773 
03774     NtStatus = SamQueryInformationDomain(
03775                    DomainHandle,
03776                    DomainOemInformation,
03777                    &amp;Buffer1
03778                    );
03779     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
03780 
03781     <span class="comment">//</span>
03782     <span class="comment">// Change the field to a new value and write it out.</span>
03783     <span class="comment">//</span>
03784 
03785     NameLength = ((DOMAIN_OEM_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;OemInformation.Length;
03786     <span class="keywordflow">if</span> (  NameLength == DummyName1.Length ) {
03787         ((DOMAIN_OEM_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;OemInformation = DummyName2;
03788     } <span class="keywordflow">else</span> {
03789         ((DOMAIN_OEM_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;OemInformation = DummyName1;
03790     }
03791 
03792     NtStatus = SamSetInformationDomain(
03793                    DomainHandle,
03794                    DomainOemInformation,
03795                    Buffer1
03796                    );
03797     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) ) {
03798 
03799         <span class="comment">//</span>
03800         <span class="comment">// Now check that the change was really made...</span>
03801         <span class="comment">//</span>
03802 
03803         NtStatus = SamQueryInformationDomain(
03804                        DomainHandle,
03805                        DomainOemInformation,
03806                        &amp;Buffer2
03807                        );
03808         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( NtStatus ) );
03809         <span class="keywordflow">if</span> (((DOMAIN_OEM_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;OemInformation.Length ==
03810             ((DOMAIN_OEM_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a2">Buffer2</a>)-&gt;OemInformation.Length    ) {
03811 
03812             printf(<span class="stringliteral">"Succeeded\n"</span>);
03813 
03814         } <span class="keywordflow">else</span> {
03815 
03816             printf(<span class="stringliteral">"Failed\n"</span>);
03817             printf(<span class="stringliteral">"        Value queried doesn't match value written\n"</span>);
03818             printf(<span class="stringliteral">"        Value Written is   0x%lx\n"</span>,
03819                 (ULONG)((DOMAIN_OEM_INFORMATION *)Buffer1)-&gt;OemInformation.Length);
03820             printf(<span class="stringliteral">"        Value Retrieved is 0x%lx\n"</span>,
03821                 (ULONG)((DOMAIN_OEM_INFORMATION *)Buffer2)-&gt;OemInformation.Length);
03822 
03823             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03824 
03825         }
03826 
03827         SamFreeMemory( Buffer1 );
03828         SamFreeMemory( Buffer2 );
03829 
03830     } <span class="keywordflow">else</span> {
03831         printf(<span class="stringliteral">"Failed\n"</span>);
03832         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
03833         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03834         SamFreeMemory( Buffer1 );
03835 
03836     }
03837 
03838 
03839 
03840 
03841     printf(<span class="stringliteral">"      Set Replication Information . . . . . . . . . . . . .     "</span>);
03842 
03843     <span class="comment">//</span>
03844     <span class="comment">// Get the current value...</span>
03845     <span class="comment">//</span>
03846 
03847     NtStatus = SamQueryInformationDomain(
03848                    DomainHandle,
03849                    DomainReplicationInformation,
03850                    &amp;Buffer1
03851                    );
03852     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
03853 
03854     <span class="comment">//</span>
03855     <span class="comment">// Change the field to a new value and write it out.</span>
03856     <span class="comment">//</span>
03857 
03858     NameLength = ((DOMAIN_REPLICATION_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;ReplicaSourceNodeName.Length;
03859     <span class="keywordflow">if</span> (  NameLength == DummyName1.Length ) {
03860         ((DOMAIN_REPLICATION_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;ReplicaSourceNodeName = DummyName2;
03861     } <span class="keywordflow">else</span> {
03862         ((DOMAIN_REPLICATION_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;ReplicaSourceNodeName = DummyName1;
03863     }
03864 
03865     NtStatus = SamSetInformationDomain(
03866                    DomainHandle,
03867                    DomainReplicationInformation,
03868                    Buffer1
03869                    );
03870     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) ) {
03871 
03872         <span class="comment">//</span>
03873         <span class="comment">// Now check that the change was really made...</span>
03874         <span class="comment">//</span>
03875 
03876         NtStatus = SamQueryInformationDomain(
03877                        DomainHandle,
03878                        DomainReplicationInformation,
03879                        &amp;Buffer2
03880                        );
03881         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( NtStatus ) );
03882         <span class="keywordflow">if</span> (((DOMAIN_REPLICATION_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;ReplicaSourceNodeName.Length ==
03883             ((DOMAIN_REPLICATION_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a2">Buffer2</a>)-&gt;ReplicaSourceNodeName.Length    ) {
03884 
03885             printf(<span class="stringliteral">"Succeeded\n"</span>);
03886 
03887         } <span class="keywordflow">else</span> {
03888 
03889             printf(<span class="stringliteral">"Failed\n"</span>);
03890             printf(<span class="stringliteral">"        Value queried doesn't match value written\n"</span>);
03891             printf(<span class="stringliteral">"        Value Written is   0x%lx\n"</span>,
03892                 (ULONG)((DOMAIN_REPLICATION_INFORMATION *)Buffer1)-&gt;ReplicaSourceNodeName.Length);
03893             printf(<span class="stringliteral">"        Value Retrieved is 0x%lx\n"</span>,
03894                 (ULONG)((DOMAIN_REPLICATION_INFORMATION *)Buffer2)-&gt;ReplicaSourceNodeName.Length);
03895 
03896             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03897 
03898         }
03899 
03900         SamFreeMemory( Buffer1 );
03901         SamFreeMemory( Buffer2 );
03902 
03903     } <span class="keywordflow">else</span> {
03904         printf(<span class="stringliteral">"Failed\n"</span>);
03905         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
03906         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03907         SamFreeMemory( Buffer1 );
03908 
03909     }
03910 
03911 
03912 
03913 
03915     <span class="comment">//                                                                       //</span>
03916     <span class="comment">// Create User/Group/Alias Suite                                         //</span>
03917     <span class="comment">//                                                                       //</span>
03919 <span class="comment"></span>
03920     printf(<span class="stringliteral">"    Create User/Group/Alias . . . . . . . . . . . . . . . .   Suite\n"</span>);
03921 
03922 
03923     printf(<span class="stringliteral">"      Create Group  . . . . . . . . . . . . . . . . . . . .     "</span>);
03924 
03925     <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, GROUP_NAME1 );
03926     NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountName, &amp;AccountNameAnsi, TRUE );
03927     TST_SUCCESS_ASSERT(NtStatus);
03928 
03929 
03930     <span class="comment">//InitializeObjectAttributes( &amp;ObjectAttributes, &amp;AccountName, 0, 0, NULL );</span>
03931 
03932     GroupRid = 0;
03933     GroupHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03934     NtStatus = SamCreateGroupInDomain(
03935                    DomainHandle,
03936                    &amp;AccountName,
03937                    GROUP_ALL_ACCESS,
03938                    &amp;GroupHandle,
03939                    &amp;GroupRid
03940                    );
03941     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountName );
03942 
03943     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
03944         <span class="keywordflow">if</span> ( (GroupHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (GroupRid == 0) ) {
03945 
03946         printf(<span class="stringliteral">"Failed\n"</span>);
03947         printf(<span class="stringliteral">"        Invalid GroupHandle or GroupRid returned.\n"</span>);
03948         printf(<span class="stringliteral">"        Completion status is  0x%lx\n"</span>, NtStatus);
03949         printf(<span class="stringliteral">"        GroupHandle value is: 0x%lx\n"</span>, (ULONG)GroupHandle);
03950         printf(<span class="stringliteral">"        GroupRid value is:    0x%lx\n"</span>, GroupRid);
03951         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03952         } <span class="keywordflow">else</span> {
03953 
03954             printf(<span class="stringliteral">"Succeeded\n"</span>);
03955             SavedGroupRid = GroupRid;
03956             NtStatus = SamCloseHandle( GroupHandle );
03957             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
03958                 printf(<span class="stringliteral">"        SamCloseHandle() completion status is: 0x%lx\n"</span>, NtStatus);
03959             }
03960             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
03961 
03962         }
03963 
03964     } <span class="keywordflow">else</span> {
03965         printf(<span class="stringliteral">"Failed\n"</span>);
03966         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
03967         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03968     }
03969 
03970 
03971 
03972 
03973     printf(<span class="stringliteral">"      Create Duplicate Group  . . . . . . . . . . . . . . .     "</span>);
03974     <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, GROUP_NAME1 );
03975     NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountName, &amp;AccountNameAnsi, TRUE );
03976     TST_SUCCESS_ASSERT(NtStatus);
03977 
03978     <span class="comment">//InitializeObjectAttributes( &amp;ObjectAttributes, &amp;AccountName, 0, 0, NULL );</span>
03979 
03980 
03981     GroupRid = 0;
03982     GroupHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03983     NtStatus = SamCreateGroupInDomain(
03984                    DomainHandle,
03985                    &amp;AccountName,
03986                    GROUP_ALL_ACCESS,
03987                    &amp;GroupHandle,
03988                    &amp;GroupRid
03989                    );
03990     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountName );
03991 
03992     <span class="keywordflow">if</span> (NtStatus != STATUS_GROUP_EXISTS) {
03993 
03994         printf(<span class="stringliteral">"Failed\n"</span>);
03995         printf(<span class="stringliteral">"        Completion status should be STATUS_GROUP_EXISTS\n"</span>);
03996         printf(<span class="stringliteral">"        Completion status is  0x%lx\n"</span>, NtStatus);
03997         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03998 
03999     } <span class="keywordflow">else</span> {
04000 
04001         printf(<span class="stringliteral">"Succeeded\n"</span>);
04002 
04003     }
04004 
04005 
04006 
04007     printf(<span class="stringliteral">"      Create Alias  . . . . . . . . . . . . . . . . . . . .     "</span>);
04008 
04009     <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, ALIAS_NAME1 );
04010     NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountName, &amp;AccountNameAnsi, TRUE );
04011     TST_SUCCESS_ASSERT(NtStatus);
04012 
04013 
04014     AliasRid = 0;
04015     AliasHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04016     NtStatus = SamCreateAliasInDomain(
04017                    DomainHandle,
04018                    &amp;AccountName,
04019                    ALIAS_ALL_ACCESS,
04020                    &amp;AliasHandle,
04021                    &amp;AliasRid
04022                    );
04023     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountName );
04024 
04025     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
04026         <span class="keywordflow">if</span> ( (AliasHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (AliasRid == 0) ) {
04027 
04028         printf(<span class="stringliteral">"Failed\n"</span>);
04029         printf(<span class="stringliteral">"        Invalid AliasHandle or AliasRid returned.\n"</span>);
04030         printf(<span class="stringliteral">"        Completion status is  0x%lx\n"</span>, NtStatus);
04031         printf(<span class="stringliteral">"        AliasHandle value is: 0x%lx\n"</span>, (ULONG)AliasHandle);
04032         printf(<span class="stringliteral">"        AliasRid value is:    0x%lx\n"</span>, AliasRid);
04033         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04034         } <span class="keywordflow">else</span> {
04035 
04036             printf(<span class="stringliteral">"Succeeded\n"</span>);
04037             SavedAliasRid = AliasRid;
04038             NtStatus = SamCloseHandle( AliasHandle );
04039             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
04040                 printf(<span class="stringliteral">"        SamCloseHandle() completion status is: 0x%lx\n"</span>, NtStatus);
04041             }
04042             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
04043 
04044 
04045             <span class="keywordflow">if</span> (AliasRid == SavedGroupRid) {
04046                 printf(<span class="stringliteral">"      Create Group/Alias Comparison. . . . . . . . . . . . .     Failed\n"</span>);
04047 
04048                 printf(<span class="stringliteral">"        Same RID assigned to new alias and group.\n"</span>);
04049                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04050             }
04051         }
04052 
04053     } <span class="keywordflow">else</span> {
04054         printf(<span class="stringliteral">"Failed\n"</span>);
04055         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
04056         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04057     }
04058 
04059 
04060 
04061 
04062     printf(<span class="stringliteral">"      Create another Alias  . . . . . . . . . . . . . . . .     "</span>);
04063 
04064     <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, ALIAS_NAME2 );
04065     NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountName, &amp;AccountNameAnsi, TRUE );
04066     TST_SUCCESS_ASSERT(NtStatus);
04067 
04068 
04069     AliasRid = 0;
04070     AliasHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04071     NtStatus = SamCreateAliasInDomain(
04072                    DomainHandle,
04073                    &amp;AccountName,
04074                    ALIAS_ALL_ACCESS,
04075                    &amp;AliasHandle,
04076                    &amp;AliasRid
04077                    );
04078     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountName );
04079 
04080     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
04081         <span class="keywordflow">if</span> ( (AliasHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (AliasRid == 0) ) {
04082 
04083         printf(<span class="stringliteral">"Failed\n"</span>);
04084         printf(<span class="stringliteral">"        Invalid AliasHandle or AliasRid returned.\n"</span>);
04085         printf(<span class="stringliteral">"        Completion status is  0x%lx\n"</span>, NtStatus);
04086         printf(<span class="stringliteral">"        AliasHandle value is: 0x%lx\n"</span>, (ULONG)AliasHandle);
04087         printf(<span class="stringliteral">"        AliasRid value is:    0x%lx\n"</span>, AliasRid);
04088         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04089         } <span class="keywordflow">else</span> {
04090 
04091             printf(<span class="stringliteral">"Succeeded\n"</span>);
04092             SavedAliasRid = AliasRid;
04093             NtStatus = SamCloseHandle( AliasHandle );
04094             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
04095                 printf(<span class="stringliteral">"        SamCloseHandle() completion status is: 0x%lx\n"</span>, NtStatus);
04096             }
04097             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
04098 
04099 
04100             <span class="keywordflow">if</span> (AliasRid == SavedGroupRid) {
04101                 printf(<span class="stringliteral">"      Create Group/Alias Comparison. . . . . . . . . . . . .     Failed\n"</span>);
04102 
04103                 printf(<span class="stringliteral">"        Same RID assigned to new alias and group.\n"</span>);
04104                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04105             }
04106         }
04107 
04108     } <span class="keywordflow">else</span> {
04109         printf(<span class="stringliteral">"Failed\n"</span>);
04110         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
04111         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04112     }
04113 
04114 
04115 
04116 
04117     printf(<span class="stringliteral">"      Create Duplicate Alias  . . . . . . . . . . . . . . .     "</span>);
04118     <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, ALIAS_NAME1 );
04119     NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountName, &amp;AccountNameAnsi, TRUE );
04120     TST_SUCCESS_ASSERT(NtStatus);
04121 
04122 
04123     AliasRid = 0;
04124     AliasHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04125     NtStatus = SamCreateAliasInDomain(
04126                    DomainHandle,
04127                    &amp;AccountName,
04128                    ALIAS_ALL_ACCESS,
04129                    &amp;AliasHandle,
04130                    &amp;AliasRid
04131                    );
04132     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountName );
04133 
04134     <span class="keywordflow">if</span> (NtStatus != STATUS_ALIAS_EXISTS) {
04135 
04136         printf(<span class="stringliteral">"Failed\n"</span>);
04137         printf(<span class="stringliteral">"        Completion status should be STATUS_ALIAS_EXISTS\n"</span>);
04138         printf(<span class="stringliteral">"        Completion status is  0x%lx\n"</span>, NtStatus);
04139         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04140 
04141     } <span class="keywordflow">else</span> {
04142 
04143         printf(<span class="stringliteral">"Succeeded\n"</span>);
04144 
04145     }
04146 
04147 
04148 
04149 
04150 
04151     printf(<span class="stringliteral">"      Create User . . . . . . . . . . . . . . . . . . . . .     "</span>);
04152 
04153     <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, USER_NAME1 );
04154     NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountName, &amp;AccountNameAnsi, TRUE );
04155     TST_SUCCESS_ASSERT(NtStatus);
04156 
04157 
04158     UserRid = 0;
04159     UserHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04160     NtStatus = SamCreateUserInDomain(
04161                    DomainHandle,
04162                    &amp;AccountName,
04163                    USER_ALL_ACCESS,
04164                    &amp;UserHandle,
04165                    &amp;UserRid
04166                    );
04167     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountName );
04168 
04169     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
04170         <span class="keywordflow">if</span> ( (UserHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (UserRid == 0) ) {
04171 
04172         printf(<span class="stringliteral">"Failed\n"</span>);
04173         printf(<span class="stringliteral">"        Invalid UserHandle or UserRid returned.\n"</span>);
04174         printf(<span class="stringliteral">"        Completion status is  0x%lx\n"</span>, NtStatus);
04175         printf(<span class="stringliteral">"        UserHandle value is: 0x%lx\n"</span>, (ULONG)UserHandle);
04176         printf(<span class="stringliteral">"        UserRid value is:    0x%lx\n"</span>, UserRid);
04177         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04178         } <span class="keywordflow">else</span> {
04179 
04180             printf(<span class="stringliteral">"Succeeded\n"</span>);
04181             ValidUserHandle = UserHandle;
04182 
04183 
04184             <span class="keywordflow">if</span> (UserRid == SavedGroupRid) {
04185                 printf(<span class="stringliteral">"      Create Group/User Comparison. . . . . . . . . . . . .     Failed\n"</span>);
04186 
04187                 printf(<span class="stringliteral">"        Same RID assigned to new user and group.\n"</span>);
04188                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04189             }
04190 
04191             <span class="keywordflow">if</span> (UserRid == SavedAliasRid) {
04192                 printf(<span class="stringliteral">"      Create Alias/User Comparison. . . . . . . . . . . . .     Failed\n"</span>);
04193 
04194                 printf(<span class="stringliteral">"        Same RID assigned to new user and alias.\n"</span>);
04195                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04196             }
04197         }
04198 
04199     } <span class="keywordflow">else</span> {
04200         printf(<span class="stringliteral">"Failed\n"</span>);
04201         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
04202         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04203     }
04204 
04205 
04206 
04207 
04208 
04209 
04210 
04211     printf(<span class="stringliteral">"      Create Duplicate User . . . . . . . . . . . . . . . .     "</span>);
04212 
04213     <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, USER_NAME1 );
04214     NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountName, &amp;AccountNameAnsi, TRUE );
04215     TST_SUCCESS_ASSERT(NtStatus);
04216 
04217 
04218     UserRid = 0;
04219     UserHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04220     NtStatus = SamCreateUserInDomain(
04221                    DomainHandle,
04222                    &amp;AccountName,
04223                    USER_ALL_ACCESS,
04224                    &amp;UserHandle,
04225                    &amp;UserRid
04226                    );
04227     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountName );
04228 
04229     <span class="keywordflow">if</span> (NtStatus != STATUS_USER_EXISTS) {
04230 
04231         printf(<span class="stringliteral">"Failed\n"</span>);
04232         printf(<span class="stringliteral">"        Completion status should be STATUS_USER_EXISTS\n"</span>);
04233         printf(<span class="stringliteral">"        Completion status is  0x%lx\n"</span>, NtStatus);
04234         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04235 
04236     } <span class="keywordflow">else</span> {
04237 
04238         printf(<span class="stringliteral">"Succeeded\n"</span>);
04239 
04240     }
04241 
04242 
04243 
04244 
04245     printf(<span class="stringliteral">"      Create Group With Same Name As User . . . . . . . . .     "</span>);
04246 
04247     <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, USER_NAME1 );
04248     NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountName, &amp;AccountNameAnsi, TRUE );
04249     TST_SUCCESS_ASSERT(NtStatus);
04250 
04251 
04252     GroupRid = 0;
04253     GroupHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04254     NtStatus = SamCreateGroupInDomain(
04255                    DomainHandle,
04256                    &amp;AccountName,
04257                    GROUP_ALL_ACCESS,
04258                    &amp;GroupHandle,
04259                    &amp;GroupRid
04260                    );
04261     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountName );
04262 
04263     <span class="keywordflow">if</span> (NtStatus != STATUS_USER_EXISTS) {
04264 
04265         printf(<span class="stringliteral">"Failed\n"</span>);
04266         printf(<span class="stringliteral">"        Completion status should be STATUS_USER_EXISTS\n"</span>);
04267         printf(<span class="stringliteral">"        Completion status is  0x%lx\n"</span>, NtStatus);
04268         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04269 
04270     } <span class="keywordflow">else</span> {
04271 
04272         printf(<span class="stringliteral">"Succeeded\n"</span>);
04273 
04274     }
04275 
04276 
04277 
04278 
04279     printf(<span class="stringliteral">"      Create Group With Same Name As Alias. . . . . . . . .     "</span>);
04280 
04281     <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, ALIAS_NAME1 );
04282     NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountName, &amp;AccountNameAnsi, TRUE );
04283     TST_SUCCESS_ASSERT(NtStatus);
04284 
04285 
04286     GroupRid = 0;
04287     GroupHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04288     NtStatus = SamCreateGroupInDomain(
04289                    DomainHandle,
04290                    &amp;AccountName,
04291                    GROUP_ALL_ACCESS,
04292                    &amp;GroupHandle,
04293                    &amp;GroupRid
04294                    );
04295     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountName );
04296 
04297     <span class="keywordflow">if</span> (NtStatus != STATUS_ALIAS_EXISTS) {
04298 
04299         printf(<span class="stringliteral">"Failed\n"</span>);
04300         printf(<span class="stringliteral">"        Completion status should be STATUS_ALIAS_EXISTS\n"</span>);
04301         printf(<span class="stringliteral">"        Completion status is  0x%lx\n"</span>, NtStatus);
04302         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04303 
04304     } <span class="keywordflow">else</span> {
04305 
04306         printf(<span class="stringliteral">"Succeeded\n"</span>);
04307 
04308     }
04309 
04310 
04311 
04312     printf(<span class="stringliteral">"      Create Alias With Same Name As Group. . . . . . . . .     "</span>);
04313 
04314     <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, GROUP_NAME1 );
04315     NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountName, &amp;AccountNameAnsi, TRUE );
04316     TST_SUCCESS_ASSERT(NtStatus);
04317 
04318 
04319     AliasRid = 0;
04320     AliasHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04321     NtStatus = SamCreateAliasInDomain(
04322                    DomainHandle,
04323                    &amp;AccountName,
04324                    GROUP_ALL_ACCESS,
04325                    &amp;AliasHandle,
04326                    &amp;AliasRid
04327                    );
04328     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountName );
04329 
04330     <span class="keywordflow">if</span> (NtStatus != STATUS_GROUP_EXISTS) {
04331 
04332         printf(<span class="stringliteral">"Failed\n"</span>);
04333         printf(<span class="stringliteral">"        Completion status should be STATUS_GROUP_EXISTS\n"</span>);
04334         printf(<span class="stringliteral">"        Completion status is  0x%lx\n"</span>, NtStatus);
04335         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04336 
04337     } <span class="keywordflow">else</span> {
04338 
04339         printf(<span class="stringliteral">"Succeeded\n"</span>);
04340 
04341     }
04342 
04343 
04344 
04345     printf(<span class="stringliteral">"      Create User With Same Name As Group . . . . . . . . .     "</span>);
04346 
04347     <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, GROUP_NAME1 );
04348     NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountName, &amp;AccountNameAnsi, TRUE );
04349     TST_SUCCESS_ASSERT(NtStatus);
04350 
04351     <span class="comment">//InitializeObjectAttributes( &amp;ObjectAttributes, &amp;AccountName, 0, 0, NULL );</span>
04352 
04353 
04354     UserRid = 0;
04355     UserHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04356     NtStatus = SamCreateUserInDomain(
04357                    DomainHandle,
04358                    &amp;AccountName,
04359                    USER_ALL_ACCESS,
04360                    &amp;UserHandle,
04361                    &amp;UserRid
04362                    );
04363     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountName );
04364 
04365     <span class="keywordflow">if</span> (NtStatus != STATUS_GROUP_EXISTS) {
04366 
04367         printf(<span class="stringliteral">"Failed\n"</span>);
04368         printf(<span class="stringliteral">"        Completion status should be STATUS_GROUP_EXISTS\n"</span>);
04369         printf(<span class="stringliteral">"        Completion status is  0x%lx\n"</span>, NtStatus);
04370         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04371 
04372     } <span class="keywordflow">else</span> {
04373 
04374         printf(<span class="stringliteral">"Succeeded\n"</span>);
04375 
04376     }
04377 
04378 
04379 
04380     printf(<span class="stringliteral">"      Create User With Same Name As Alias . . . . . . . . .     "</span>);
04381 
04382     <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, ALIAS_NAME1 );
04383     NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountName, &amp;AccountNameAnsi, TRUE );
04384     TST_SUCCESS_ASSERT(NtStatus);
04385 
04386 
04387     UserRid = 0;
04388     UserHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04389     NtStatus = SamCreateUserInDomain(
04390                    DomainHandle,
04391                    &amp;AccountName,
04392                    USER_ALL_ACCESS,
04393                    &amp;UserHandle,
04394                    &amp;UserRid
04395                    );
04396     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountName );
04397 
04398     <span class="keywordflow">if</span> (NtStatus != STATUS_ALIAS_EXISTS) {
04399 
04400         printf(<span class="stringliteral">"Failed\n"</span>);
04401         printf(<span class="stringliteral">"        Completion status should be STATUS_ALIAS_EXISTS\n"</span>);
04402         printf(<span class="stringliteral">"        Completion status is  0x%lx\n"</span>, NtStatus);
04403         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04404 
04405     } <span class="keywordflow">else</span> {
04406 
04407         printf(<span class="stringliteral">"Succeeded\n"</span>);
04408 
04409     }
04410 
04411 
04412 
04414     <span class="comment">//                                                                       //</span>
04415     <span class="comment">// Call server to test internal functions                                //</span>
04416     <span class="comment">//                                                                       //</span>
04418 <span class="comment"></span>
04419     printf(<span class="stringliteral">"\n"</span>);
04420     printf(<span class="stringliteral">"    Test internal functions . . . . . . . . . . . . . . .   Suite\n"</span>);
04421     printf(<span class="stringliteral">"      Test internal domain functions  . . . . . . . . . .       "</span>);
04422 
04423     NtStatus = SamTestPrivateFunctionsDomain( DomainHandle );
04424 
04425     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( NtStatus ) ) {
04426 
04427         printf(<span class="stringliteral">"Succeeded.\n"</span>);
04428 
04429     } <span class="keywordflow">else</span> {
04430 
04431         <span class="keywordflow">if</span> ( NtStatus == STATUS_NOT_IMPLEMENTED ) {
04432 
04433             printf(<span class="stringliteral">"Not Implemented\n"</span>);
04434 
04435         } <span class="keywordflow">else</span> {
04436 
04437             printf(<span class="stringliteral">"Failed.\n"</span>);
04438             printf(<span class="stringliteral">"    Status = %lx\n"</span>, NtStatus );
04439             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04440         }
04441     }
04442 
04443     printf(<span class="stringliteral">"      Test internal user functions  . . . . . . . . . . .       "</span>);
04444 
04445     <span class="keywordflow">if</span> (ValidUserHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04446 
04447         printf(<span class="stringliteral">"Test omitted - Valid User handle not available\n"</span>);
04448         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04449 
04450     } <span class="keywordflow">else</span> {
04451 
04452         NtStatus = SamTestPrivateFunctionsUser( ValidUserHandle );
04453         IgnoreStatus = SamCloseHandle( ValidUserHandle );
04454         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
04455 
04456         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( NtStatus ) ) {
04457 
04458             printf(<span class="stringliteral">"Succeeded.\n"</span>);
04459 
04460         } <span class="keywordflow">else</span> {
04461 
04462             <span class="keywordflow">if</span> ( NtStatus == STATUS_NOT_IMPLEMENTED ) {
04463 
04464                 printf(<span class="stringliteral">"Not Implemented\n"</span>);
04465 
04466             } <span class="keywordflow">else</span> {
04467 
04468                 printf(<span class="stringliteral">"Failed.\n"</span>);
04469                 printf(<span class="stringliteral">"    Status = %lx\n"</span>, NtStatus );
04470                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04471             }
04472         }
04473     }
04474 
04475 
04477     <span class="comment">//                                                                       //</span>
04478     <span class="comment">// Enumerate Users/Groups Suite                                          //</span>
04479     <span class="comment">//                                                                       //</span>
04481 <span class="comment"></span>
04482 
04483     printf(<span class="stringliteral">"    Enumerate Users/Groups/Aliases. . . . . . . . . . . .   Suite\n"</span>);
04484 
04485     printf(<span class="stringliteral">"      Enumerate Groups - large prefered length  . . . . . .     "</span>);
04486 
04487 
04488     EnumerationContext = 0;
04489     NtStatus = SamEnumerateGroupsInDomain(
04490                    DomainHandle,
04491                    &amp;EnumerationContext,
04492                    &amp;Buffer,
04493                    12000,                   <span class="comment">// PreferedMaximumLength</span>
04494                    &amp;CountReturned
04495                    );
04496     AccountCount = CountReturned;       <span class="comment">// Save for future test</span>
04497 
04498     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
04499         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04500             <span class="keywordflow">if</span> (NtStatus == STATUS_SUCCESS) {
04501 
04502                 <span class="keywordflow">if</span> (CountReturned &gt; 1) {
04503                     printf(<span class="stringliteral">"Succeeded\n"</span>);
04504                     <span class="keywordflow">for</span> (i=0; i&lt;CountReturned; i++) {
04505                         printf(<span class="stringliteral">"            Rid/Name(%ld): 0x%lx / %wZ\n"</span>,i,
04506                                ((PSAM_RID_ENUMERATION)(Buffer))[i].RelativeId,
04507                               &amp;((PSAM_RID_ENUMERATION)(Buffer))[i].Name
04508                               );
04509                     }
04510 
04511                 } <span class="keywordflow">else</span> {
04512                     printf(<span class="stringliteral">"Failed\n"</span>);
04513                     printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
04514                     printf(<span class="stringliteral">"        Expected several entries to be returned.\n"</span>);
04515                     printf(<span class="stringliteral">"        Received 0x%lx entries instead.\n"</span>, CountReturned);
04516                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04517                 }
04518 
04519             } <span class="keywordflow">else</span> {
04520 
04521                 printf(<span class="stringliteral">"Failed\n"</span>);
04522                 printf(<span class="stringliteral">"        Expected STATUS_MORE_ENTRIES to be returned.\n"</span>);
04523                 printf(<span class="stringliteral">"        Received 0x%lx instead.\n"</span>, NtStatus);
04524                 printf(<span class="stringliteral">"        Buffer        = 0x%lx\n"</span>, (ULONG)Buffer);
04525                 printf(<span class="stringliteral">"        CountReturned = 0x%lx\n"</span>, CountReturned);
04526                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04527             }
04528 
04529             SamFreeMemory( Buffer );
04530 
04531         } <span class="keywordflow">else</span> {
04532             printf(<span class="stringliteral">"Failed\n"</span>);
04533             printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
04534             printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
04535             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
04536             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04537         }
04538 
04539     } <span class="keywordflow">else</span> {
04540         printf(<span class="stringliteral">"Failed\n"</span>);
04541         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
04542         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04543 
04544     }
04545 
04546 
04547 
04548 
04549     printf(<span class="stringliteral">"      Enumerate Groups - small prefered length  . . . . . .     "</span>);
04550 
04551 
04552     <span class="keywordflow">for</span> ( i=0; i&lt;AccountCount; i++) {
04553         EnumerationContext = i;
04554         NtStatus = SamEnumerateGroupsInDomain(
04555                        DomainHandle,
04556                        &amp;EnumerationContext,
04557                        &amp;Buffer,
04558                        0,                   <span class="comment">// PreferedMaximumLength</span>
04559                        &amp;CountReturned
04560                        );
04561 
04562         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
04563             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04564                 <span class="keywordflow">if</span> ( ((i &gt;= AccountCount -1) &amp;&amp; (NtStatus == STATUS_SUCCESS)) ||
04565                      ((i &lt;= AccountCount -1) &amp;&amp; (NtStatus == STATUS_MORE_ENTRIES))  ) {
04566 
04567                     <span class="keywordflow">if</span> (CountReturned != 1) {
04568                         printf(<span class="stringliteral">"Failed\n"</span>);
04569                         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
04570                         printf(<span class="stringliteral">"        Expected one entry to be returned.\n"</span>);
04571                         printf(<span class="stringliteral">"        Received 0x%lx entries instead.\n"</span>, CountReturned);
04572                         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04573                         i = AccountCount + 100;
04574                     }
04575 
04576                 } <span class="keywordflow">else</span> {
04577 
04578                     printf(<span class="stringliteral">"Failed\n"</span>);
04579                     <span class="keywordflow">if</span> (i &lt; AccountCount -1 ) {
04580                         printf(<span class="stringliteral">"        Expected STATUS_MORE_ENTRIES to be returned.\n"</span>);
04581                     } <span class="keywordflow">else</span> {
04582                         printf(<span class="stringliteral">"        Expected STATUS_SUCCESS to be returned.\n"</span>);
04583                     }
04584                     printf(<span class="stringliteral">"        Received 0x%lx instead.\n"</span>, NtStatus);
04585                     printf(<span class="stringliteral">"        Buffer        = 0x%lx\n"</span>, (ULONG)Buffer);
04586                     printf(<span class="stringliteral">"        CountReturned = 0x%lx\n"</span>, CountReturned);
04587                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04588                     i = AccountCount + 100;
04589                 }
04590 
04591                 SamFreeMemory( Buffer );
04592 
04593             } <span class="keywordflow">else</span> {
04594                 printf(<span class="stringliteral">"Failed\n"</span>);
04595                 printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
04596                 printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
04597                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
04598                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04599                 i = AccountCount + 100;
04600             }
04601 
04602         } <span class="keywordflow">else</span> {
04603             printf(<span class="stringliteral">"Failed\n"</span>);
04604             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
04605             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04606             i = AccountCount + 100;
04607 
04608         }
04609     }
04610 
04611     <span class="keywordflow">if</span> ( i == AccountCount) {
04612         printf(<span class="stringliteral">"Succeeded\n"</span>);
04613     }
04614 
04615 
04616 
04617 
04618     printf(<span class="stringliteral">"      Enumerate Aliases - large prefered length . . . . . .     "</span>);
04619 
04620 
04621     EnumerationContext = 0;
04622     NtStatus = SamEnumerateAliasesInDomain(
04623                    DomainHandle,
04624                    &amp;EnumerationContext,
04625                    &amp;Buffer,
04626                    12000,                   <span class="comment">// PreferedMaximumLength</span>
04627                    &amp;CountReturned
04628                    );
04629     AccountCount = CountReturned;       <span class="comment">// Save for future test</span>
04630 
04631     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
04632         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04633             <span class="keywordflow">if</span> (NtStatus == STATUS_SUCCESS) {
04634 
04635                 <span class="keywordflow">if</span> (CountReturned &gt; 1) {
04636                     printf(<span class="stringliteral">"Succeeded\n"</span>);
04637                     <span class="keywordflow">for</span> (i=0; i&lt;CountReturned; i++) {
04638                         printf(<span class="stringliteral">"            Rid/Name(%ld): 0x%lx / %wZ\n"</span>,i,
04639                                ((PSAM_RID_ENUMERATION)(Buffer))[i].RelativeId,
04640                               &amp;((PSAM_RID_ENUMERATION)(Buffer))[i].Name
04641                               );
04642                     }
04643 
04644                 } <span class="keywordflow">else</span> {
04645                     printf(<span class="stringliteral">"Failed\n"</span>);
04646                     printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
04647                     printf(<span class="stringliteral">"        Expected several entries to be returned.\n"</span>);
04648                     printf(<span class="stringliteral">"        Received 0x%lx entries instead.\n"</span>, CountReturned);
04649                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04650                 }
04651 
04652             } <span class="keywordflow">else</span> {
04653 
04654                 printf(<span class="stringliteral">"Failed\n"</span>);
04655                 printf(<span class="stringliteral">"        Expected STATUS_MORE_ENTRIES to be returned.\n"</span>);
04656                 printf(<span class="stringliteral">"        Received 0x%lx instead.\n"</span>, NtStatus);
04657                 printf(<span class="stringliteral">"        Buffer        = 0x%lx\n"</span>, (ULONG)Buffer);
04658                 printf(<span class="stringliteral">"        CountReturned = 0x%lx\n"</span>, CountReturned);
04659                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04660             }
04661 
04662             SamFreeMemory( Buffer );
04663 
04664         } <span class="keywordflow">else</span> {
04665             printf(<span class="stringliteral">"Failed\n"</span>);
04666             printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
04667             printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
04668             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
04669             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04670         }
04671 
04672     } <span class="keywordflow">else</span> {
04673         printf(<span class="stringliteral">"Failed\n"</span>);
04674         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
04675         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04676 
04677     }
04678 
04679 
04680 
04681 
04682     printf(<span class="stringliteral">"      Enumerate Aliases - small prefered length . . . . . .     "</span>);
04683 
04684 
04685     <span class="keywordflow">for</span> ( i=0; i&lt;AccountCount; i++) {
04686         EnumerationContext = i;
04687         NtStatus = SamEnumerateAliasesInDomain(
04688                        DomainHandle,
04689                        &amp;EnumerationContext,
04690                        &amp;Buffer,
04691                        0,                   <span class="comment">// PreferedMaximumLength</span>
04692                        &amp;CountReturned
04693                        );
04694 
04695         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
04696             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04697                 <span class="keywordflow">if</span> ( ((i &gt;= AccountCount -1) &amp;&amp; (NtStatus == STATUS_SUCCESS)) ||
04698                      ((i &lt;= AccountCount -1) &amp;&amp; (NtStatus == STATUS_MORE_ENTRIES))  ) {
04699 
04700                     <span class="keywordflow">if</span> (CountReturned != 1) {
04701                         printf(<span class="stringliteral">"Failed\n"</span>);
04702                         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
04703                         printf(<span class="stringliteral">"        Expected one entry to be returned.\n"</span>);
04704                         printf(<span class="stringliteral">"        Received 0x%lx entries instead.\n"</span>, CountReturned);
04705                         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04706                         i = AccountCount + 100;
04707                     }
04708 
04709                 } <span class="keywordflow">else</span> {
04710 
04711                     printf(<span class="stringliteral">"Failed\n"</span>);
04712                     <span class="keywordflow">if</span> (i &lt; AccountCount -1 ) {
04713                         printf(<span class="stringliteral">"        Expected STATUS_MORE_ENTRIES to be returned.\n"</span>);
04714                     } <span class="keywordflow">else</span> {
04715                         printf(<span class="stringliteral">"        Expected STATUS_SUCCESS to be returned.\n"</span>);
04716                     }
04717                     printf(<span class="stringliteral">"        Received 0x%lx instead.\n"</span>, NtStatus);
04718                     printf(<span class="stringliteral">"        Buffer        = 0x%lx\n"</span>, (ULONG)Buffer);
04719                     printf(<span class="stringliteral">"        CountReturned = 0x%lx\n"</span>, CountReturned);
04720                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04721                     i = AccountCount + 100;
04722                 }
04723 
04724                 SamFreeMemory( Buffer );
04725 
04726             } <span class="keywordflow">else</span> {
04727                 printf(<span class="stringliteral">"Failed\n"</span>);
04728                 printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
04729                 printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
04730                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
04731                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04732                 i = AccountCount + 100;
04733             }
04734 
04735         } <span class="keywordflow">else</span> {
04736             printf(<span class="stringliteral">"Failed\n"</span>);
04737             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
04738             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04739             i = AccountCount + 100;
04740 
04741         }
04742     }
04743 
04744     <span class="keywordflow">if</span> ( i == AccountCount) {
04745         printf(<span class="stringliteral">"Succeeded\n"</span>);
04746     }
04747 
04748 
04749 
04750 
04751 
04752     printf(<span class="stringliteral">"      Enumerate Users  - large prefered length  . . . . . .     "</span>);
04753 
04754 
04755     EnumerationContext = 0;
04756     NtStatus = SamEnumerateUsersInDomain(
04757                    DomainHandle,
04758                    &amp;EnumerationContext,
04759                    0,
04760                    &amp;Buffer,
04761                    12000,                   <span class="comment">// PreferedMaximumLength</span>
04762                    &amp;CountReturned
04763                    );
04764     AccountCount = CountReturned;       <span class="comment">// Save for future test</span>
04765 
04766     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
04767         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04768             <span class="keywordflow">if</span> (NtStatus == STATUS_SUCCESS) {
04769 
04770                 <span class="keywordflow">if</span> (CountReturned &gt; 1) {
04771                     printf(<span class="stringliteral">"Succeeded\n"</span>);
04772                     <span class="keywordflow">for</span> (i=0; i&lt;CountReturned; i++) {
04773                         printf(<span class="stringliteral">"            Rid/Name(%ld): 0x%lx / %wZ\n"</span>,i,
04774                                ((PSAM_RID_ENUMERATION)(Buffer))[i].RelativeId,
04775                               &amp;((PSAM_RID_ENUMERATION)(Buffer))[i].Name
04776                               );
04777                     }
04778 
04779                 } <span class="keywordflow">else</span> {
04780                     printf(<span class="stringliteral">"Failed\n"</span>);
04781                     printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
04782                     printf(<span class="stringliteral">"        Expected several entries to be returned.\n"</span>);
04783                     printf(<span class="stringliteral">"        Received 0x%lx entries instead.\n"</span>, CountReturned);
04784                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04785                 }
04786 
04787             } <span class="keywordflow">else</span> {
04788 
04789                 printf(<span class="stringliteral">"Failed\n"</span>);
04790                 printf(<span class="stringliteral">"        Expected STATUS_MORE_ENTRIES to be returned.\n"</span>);
04791                 printf(<span class="stringliteral">"        Received 0x%lx instead.\n"</span>, NtStatus);
04792                 printf(<span class="stringliteral">"        Buffer        = 0x%lx\n"</span>, (ULONG)Buffer);
04793                 printf(<span class="stringliteral">"        CountReturned = 0x%lx\n"</span>, CountReturned);
04794                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04795             }
04796 
04797             SamFreeMemory( Buffer );
04798 
04799         } <span class="keywordflow">else</span> {
04800             printf(<span class="stringliteral">"Failed\n"</span>);
04801             printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
04802             printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
04803             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
04804             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04805         }
04806 
04807     } <span class="keywordflow">else</span> {
04808         printf(<span class="stringliteral">"Failed\n"</span>);
04809         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
04810         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04811 
04812     }
04813 
04814 
04815 
04816 
04817     printf(<span class="stringliteral">"      Enumerate Users  - small prefered length  . . . . . .     "</span>);
04818 
04819 
04820     <span class="keywordflow">for</span> ( i=0; i&lt;AccountCount; i++) {
04821         EnumerationContext = i;
04822         NtStatus = SamEnumerateUsersInDomain(
04823                        DomainHandle,
04824                        &amp;EnumerationContext,
04825                        0,
04826                        &amp;Buffer,
04827                        0,                   <span class="comment">// PreferedMaximumLength</span>
04828                        &amp;CountReturned
04829                        );
04830 
04831         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
04832             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04833                 <span class="keywordflow">if</span> ( ((i &gt;= AccountCount -1) &amp;&amp; (NtStatus == STATUS_SUCCESS)) ||
04834                      ((i &lt;= AccountCount -1) &amp;&amp; (NtStatus == STATUS_MORE_ENTRIES))  ) {
04835 
04836                     <span class="keywordflow">if</span> (CountReturned != 1) {
04837                         printf(<span class="stringliteral">"Failed\n"</span>);
04838                         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
04839                         printf(<span class="stringliteral">"        Expected one entry to be returned.\n"</span>);
04840                         printf(<span class="stringliteral">"        Received 0x%lx entries instead.\n"</span>, CountReturned);
04841                         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04842                         i = AccountCount + 100;
04843                     }
04844 
04845                 } <span class="keywordflow">else</span> {
04846 
04847                     printf(<span class="stringliteral">"Failed\n"</span>);
04848                     <span class="keywordflow">if</span> (i &lt; AccountCount -1 ) {
04849                         printf(<span class="stringliteral">"        Expected STATUS_MORE_ENTRIES to be returned.\n"</span>);
04850                     } <span class="keywordflow">else</span> {
04851                         printf(<span class="stringliteral">"        Expected STATUS_SUCCESS to be returned.\n"</span>);
04852                     }
04853                     printf(<span class="stringliteral">"        Received 0x%lx instead.\n"</span>, NtStatus);
04854                     printf(<span class="stringliteral">"        Buffer        = 0x%lx\n"</span>, (ULONG)Buffer);
04855                     printf(<span class="stringliteral">"        CountReturned = 0x%lx\n"</span>, CountReturned);
04856                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04857                     i = AccountCount + 100;
04858                 }
04859 
04860                 SamFreeMemory( Buffer );
04861 
04862             } <span class="keywordflow">else</span> {
04863                 printf(<span class="stringliteral">"Failed\n"</span>);
04864                 printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
04865                 printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
04866                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
04867                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04868                 i = AccountCount + 100;
04869             }
04870 
04871         } <span class="keywordflow">else</span> {
04872             printf(<span class="stringliteral">"Failed\n"</span>);
04873             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
04874             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04875             i = AccountCount + 100;
04876 
04877         }
04878     }
04879 
04880     <span class="keywordflow">if</span> ( i == AccountCount) {
04881         printf(<span class="stringliteral">"Succeeded\n"</span>);
04882     }
04883 
04884 
04885 
04886 
04887 
04888 
04889 
04890 
04891 
04892 
04894     <span class="comment">//                                                                       //</span>
04895     <span class="comment">// Lookup Names/IDs Suite                                                //</span>
04896     <span class="comment">//                                                                       //</span>
04898 <span class="comment"></span>
04899 
04900     <span class="comment">// LATER add alias search to lookup name suite.....</span>
04901 
04902 
04903     printf(<span class="stringliteral">"\n"</span>);
04904     printf(<span class="stringliteral">"    Lookup Names/IDs  . . . . . . . . . . . . . . . . . .   Suite\n"</span>);
04905 
04906 
04907     printf(<span class="stringliteral">"      Lookup Names (all existing) . . . . . . . . . . . . .     "</span>);
04908 
04909     NtStatus = SamLookupNamesInDomain(
04910                    DomainHandle,
04911                    ALL_NAMES_COUNT,
04912                    &amp;AllNames[0],
04913                    &amp;LookedUpRids,
04914                    &amp;LookedUpUses
04915                    );
04916 
04917 
04918     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
04919         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( LookedUpRids != NULL );
04920         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( LookedUpUses != NULL );
04921 
04922         <span class="keywordflow">if</span> (
04923             (LookedUpRids[0] == AllRids[0]) &amp;&amp; (LookedUpUses[0] == AllUses[0])
04924                                             &amp;&amp;
04925             (LookedUpRids[1] == AllRids[1]) &amp;&amp; (LookedUpUses[1] == AllUses[1])
04926                                             &amp;&amp;
04927             (LookedUpRids[2] == AllRids[2]) &amp;&amp; (LookedUpUses[2] == AllUses[2])
04928             ) {
04929 
04930 
04931             printf(<span class="stringliteral">"Succeeded\n"</span>);
04932 
04933 
04934         } <span class="keywordflow">else</span> {
04935             printf(<span class="stringliteral">"Failed\n"</span>);
04936             printf(<span class="stringliteral">"        Rids or Uses dont match expected values.\n"</span>);
04937             printf(<span class="stringliteral">"        Expected Rids:  0x%lx, 0x%lx, 0x%lx\n"</span>,
04938                 AllRids[0], AllRids[1], AllRids[2]);
04939             printf(<span class="stringliteral">"        Received Rids:  0x%lx, 0x%lx, 0x%lx\n"</span>,
04940                 LookedUpRids[0], LookedUpRids[1], LookedUpRids[2]);
04941             printf(<span class="stringliteral">"        Expected Uses:  0x%lx, 0x%lx, 0x%lx\n"</span>,
04942                 AllUses[0], AllUses[1], AllUses[2]);
04943             printf(<span class="stringliteral">"        Received Uses:  0x%lx, 0x%lx, 0x%lx\n"</span>,
04944                 LookedUpUses[0], LookedUpUses[1], LookedUpUses[2]);
04945             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04946         }
04947 
04948 
04949         SamFreeMemory( LookedUpRids );
04950         SamFreeMemory( LookedUpUses );
04951 
04952     } <span class="keywordflow">else</span> {
04953         printf(<span class="stringliteral">"Failed\n"</span>);
04954         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
04955         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04956     }
04957 
04958 
04959 
04960 
04961     printf(<span class="stringliteral">"      Lookup Names (Some existing)  . . . . . . . . . . . .     "</span>);
04962 
04963     NtStatus = SamLookupNamesInDomain(
04964                    DomainHandle,
04965                    SOME_NAMES_COUNT,
04966                    &amp;SomeNames[0],
04967                    &amp;LookedUpRids,
04968                    &amp;LookedUpUses
04969                    );
04970 
04971 
04972     <span class="keywordflow">if</span> (NtStatus == STATUS_SOME_NOT_MAPPED) {
04973         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( LookedUpRids != NULL );
04974         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( LookedUpUses != NULL );
04975 
04976         <span class="keywordflow">if</span> (
04977             (LookedUpRids[0] == SomeRids[0]) &amp;&amp; (LookedUpUses[0] == SomeUses[0])
04978                                              &amp;&amp;
04979             (LookedUpRids[1] == SomeRids[1]) &amp;&amp; (LookedUpUses[1] == SomeUses[1])
04980                                              &amp;&amp;
04981             (LookedUpRids[2] == SomeRids[2]) &amp;&amp; (LookedUpUses[2] == SomeUses[2])
04982                                              &amp;&amp;
04983             (LookedUpRids[3] == SomeRids[3]) &amp;&amp; (LookedUpUses[3] == SomeUses[3])
04984                                              &amp;&amp;
04985             (LookedUpRids[4] == SomeRids[4]) &amp;&amp; (LookedUpUses[4] == SomeUses[4])
04986                                              &amp;&amp;
04987             (LookedUpRids[5] == SomeRids[5]) &amp;&amp; (LookedUpUses[5] == SomeUses[5])
04988                                              &amp;&amp;
04989             (LookedUpRids[6] == SomeRids[6]) &amp;&amp; (LookedUpUses[6] == SomeUses[6])
04990             ) {
04991 
04992 
04993             printf(<span class="stringliteral">"Succeeded\n"</span>);
04994 
04995         } <span class="keywordflow">else</span> {
04996             printf(<span class="stringliteral">"Failed\n"</span>);
04997             printf(<span class="stringliteral">"        Rids or Uses dont match expected values.\n"</span>);
04998             printf(<span class="stringliteral">"        Expected Rids:  0x%lx, 0x%lx, 0x%lx, 0x%lx,  0x%lx, 0x%lx, 0x%lx\n"</span>,
04999                 SomeRids[0], SomeRids[1], SomeRids[2], SomeRids[3], SomeRids[4], SomeRids[5], SomeRids[6]);
05000             printf(<span class="stringliteral">"        Received Rids:  0x%lx, 0x%lx, 0x%lx, 0x%lx,  0x%lx, 0x%lx, 0x%lx\n"</span>,
05001                 LookedUpRids[0], LookedUpRids[1], LookedUpRids[2], LookedUpRids[3], LookedUpRids[4], LookedUpRids[5], LookedUpRids[6]);
05002             printf(<span class="stringliteral">"        Expected Uses:  0x%lx, 0x%lx, 0x%lx, 0x%lx,  0x%lx, 0x%lx, 0x%lx\n"</span>,
05003                 SomeUses[0], SomeUses[1], SomeUses[2], SomeUses[3], SomeUses[4], SomeUses[5], SomeUses[6]);
05004             printf(<span class="stringliteral">"        Received Uses:  0x%lx, 0x%lx, 0x%lx, 0x%lx,  0x%lx, 0x%lx, 0x%lx\n"</span>,
05005                 LookedUpUses[0], LookedUpUses[1], LookedUpUses[2], LookedUpUses[3], LookedUpUses[4], LookedUpUses[5], LookedUpUses[2]);
05006             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05007         }
05008 
05009 
05010         SamFreeMemory( LookedUpRids );
05011         SamFreeMemory( LookedUpUses );
05012 
05013     } <span class="keywordflow">else</span> {
05014         printf(<span class="stringliteral">"Failed\n"</span>);
05015         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
05016         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05017     }
05018 
05019 
05020 
05021     printf(<span class="stringliteral">"      Lookup Names (None existing)  . . . . . . . . . . . .     "</span>);
05022 
05023     NtStatus = SamLookupNamesInDomain(
05024                    DomainHandle,
05025                    NO_NAMES_COUNT,
05026                    &amp;NoNames[0],
05027                    &amp;LookedUpRids,
05028                    &amp;LookedUpUses
05029                    );
05030 
05031 
05032     <span class="keywordflow">if</span> (NtStatus == STATUS_NONE_MAPPED) {
05033         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( LookedUpRids == NULL );
05034         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( LookedUpUses == NULL );
05035 
05036         printf(<span class="stringliteral">"Succeeded\n"</span>);
05037 
05038     } <span class="keywordflow">else</span> {
05039         printf(<span class="stringliteral">"Failed\n"</span>);
05040         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
05041         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05042     }
05043 
05044 
05045  
05046     printf(<span class="stringliteral">"      Lookup SIDs (all existing)  . . . . . . . . . . . . .     "</span>);
05047 
05048     NtStatus = SamLookupIdsInDomain(
05049                    DomainHandle,
05050                    ALL_NAMES_COUNT,
05051                    &amp;AllRids[0],
05052                    &amp;LookedUpNames,
05053                    &amp;LookedUpUses
05054                    );
05055 
05056 
05057     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
05058         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( LookedUpUses  != NULL );
05059         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( LookedUpNames != NULL );
05060         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( LookedUpNames[0].Buffer != NULL );
05061         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( LookedUpNames[1].Buffer != NULL );
05062         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( LookedUpNames[2].Buffer != NULL );
05063 
05064         <span class="keywordflow">if</span> (
05065             (LookedUpUses[0] == AllUses[0]) &amp;&amp;
05066             (LookedUpUses[1] == AllUses[1]) &amp;&amp;
05067             (LookedUpUses[2] == AllUses[2]) &amp;&amp;
05068             !<a class="code" href="../../d2/d7/string_8c.html#a10">RtlCompareString</a>( (PSTRING)&amp;LookedUpNames[0], (PSTRING)&amp;AllNames[0], TRUE ) &amp;&amp;
05069             !<a class="code" href="../../d2/d7/string_8c.html#a10">RtlCompareString</a>( (PSTRING)&amp;LookedUpNames[1], (PSTRING)&amp;AllNames[1], TRUE ) &amp;&amp;
05070             !<a class="code" href="../../d2/d7/string_8c.html#a10">RtlCompareString</a>( (PSTRING)&amp;LookedUpNames[2], (PSTRING)&amp;AllNames[2], TRUE )
05071             ) {
05072 
05073 
05074             printf(<span class="stringliteral">"Succeeded\n"</span>);
05075 
05076         } <span class="keywordflow">else</span> {
05077             printf(<span class="stringliteral">"Failed\n"</span>);
05078             printf(<span class="stringliteral">"        Names or Uses dont match expected values.\n"</span>);
05079             printf(<span class="stringliteral">"        Expected Name[0]:  %wZ\n"</span>, &amp;AllNames[0] );
05080             printf(<span class="stringliteral">"        Received Name[0]:  %wZ\n"</span>, &amp;LookedUpNames[0] );
05081             printf(<span class="stringliteral">"        Expected Name[1]:  %wZ\n"</span>, &amp;AllNames[1] );
05082             printf(<span class="stringliteral">"        Received Name[1]:  %wZ\n"</span>, &amp;LookedUpNames[1] );
05083             printf(<span class="stringliteral">"        Expected Name[2]:  %wZ\n"</span>, &amp;AllNames[2] );
05084             printf(<span class="stringliteral">"        Received Name[2]:  %wZ\n"</span>, &amp;LookedUpNames[2] );
05085 
05086             printf(<span class="stringliteral">"        Expected Uses:  0x%lx, 0x%lx, 0x%lx\n"</span>,
05087                 AllUses[0], AllUses[1], AllUses[2]);
05088             printf(<span class="stringliteral">"        Received Uses:  0x%lx, 0x%lx, 0x%lx\n"</span>,
05089                 LookedUpUses[0], LookedUpUses[1], LookedUpUses[2]);
05090             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05091         }
05092 
05093 
05094         SamFreeMemory( LookedUpUses );
05095         SamFreeMemory( LookedUpNames );
05096 
05097     } <span class="keywordflow">else</span> {
05098         printf(<span class="stringliteral">"Failed\n"</span>);
05099         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
05100         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05101     }
05102 
05103 
05104 
05105 
05106     printf(<span class="stringliteral">"      Lookup SIDs (Some existing) . . . . . . . . . . . . .     "</span>);
05107 
05108     NtStatus = SamLookupIdsInDomain(
05109                    DomainHandle,
05110                    SOME_NAMES_COUNT,
05111                    &amp;SomeRids[0],
05112                    &amp;LookedUpNames,
05113                    &amp;LookedUpUses
05114                    );
05115 
05116 
05117     <span class="keywordflow">if</span> (NtStatus == STATUS_SOME_NOT_MAPPED) {
05118         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( LookedUpUses  != NULL );
05119         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( LookedUpNames != NULL );
05120         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( LookedUpNames[0].Buffer != NULL );
05121         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( LookedUpNames[1].Buffer != NULL );
05122         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( LookedUpNames[2].Buffer == NULL );  <span class="comment">// Unknown</span>
05123         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( LookedUpNames[3].Buffer == NULL );  <span class="comment">// Unknown</span>
05124         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( LookedUpNames[4].Buffer == NULL );  <span class="comment">// Unknown</span>
05125         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( LookedUpNames[5].Buffer != NULL );
05126         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( LookedUpNames[6].Buffer == NULL );  <span class="comment">// Unknown</span>
05127 
05128         <span class="keywordflow">if</span> (
05129             (LookedUpUses[0] == SomeUses[0]) &amp;&amp;
05130             (LookedUpUses[1] == SomeUses[1]) &amp;&amp;
05131             (LookedUpUses[2] == SomeUses[2]) &amp;&amp;
05132             !<a class="code" href="../../d2/d7/string_8c.html#a10">RtlCompareString</a>( (PSTRING)&amp;LookedUpNames[0], (PSTRING)&amp;SomeNames[0], TRUE ) &amp;&amp;
05133             !<a class="code" href="../../d2/d7/string_8c.html#a10">RtlCompareString</a>( (PSTRING)&amp;LookedUpNames[1], (PSTRING)&amp;SomeNames[1], TRUE ) &amp;&amp;
05134             !<a class="code" href="../../d2/d7/string_8c.html#a10">RtlCompareString</a>( (PSTRING)&amp;LookedUpNames[5], (PSTRING)&amp;SomeNames[5], TRUE )
05135             ) {
05136 
05137 
05138             printf(<span class="stringliteral">"Succeeded\n"</span>);
05139 
05140         } <span class="keywordflow">else</span> {
05141             printf(<span class="stringliteral">"Failed\n"</span>);
05142             printf(<span class="stringliteral">"        Names or Uses dont match expected values.\n"</span>);
05143             printf(<span class="stringliteral">"        Expected Name[0]:  %wZ\n"</span>, &amp;SomeNames[0] );
05144             printf(<span class="stringliteral">"        Received Name[0]:  %wZ\n"</span>, &amp;LookedUpNames[0] );
05145             printf(<span class="stringliteral">"        Expected Name[1]:  %wZ\n"</span>, &amp;SomeNames[1] );
05146             printf(<span class="stringliteral">"        Received Name[1]:  %wZ\n"</span>, &amp;LookedUpNames[1] );
05147             printf(<span class="stringliteral">"                 Name[2]:  (Unknown)\n"</span>);
05148             printf(<span class="stringliteral">"                 Name[3]:  (Unknown)\n"</span>);
05149             printf(<span class="stringliteral">"                 Name[4]:  (Unknown)\n"</span>);
05150             printf(<span class="stringliteral">"        Expected Name[5]:  %wZ\n"</span>, &amp;SomeNames[5] );
05151             printf(<span class="stringliteral">"        Received Name[5]:  %wZ\n"</span>, &amp;LookedUpNames[5] );
05152             printf(<span class="stringliteral">"                 Name[6]:  (Unknown)\n"</span>);
05153 
05154             printf(<span class="stringliteral">"        Expected Uses:  0x%lx, 0x%lx, 0x%lx, 0x%lx,  0x%lx, 0x%lx, 0x%lx\n"</span>,
05155                 SomeUses[0], SomeUses[1], SomeUses[2], SomeUses[3], SomeUses[4], SomeUses[5], SomeUses[6]);
05156             printf(<span class="stringliteral">"        Received Uses:  0x%lx, 0x%lx, 0x%lx, 0x%lx,  0x%lx, 0x%lx, 0x%lx\n"</span>,
05157                 LookedUpUses[0], LookedUpUses[1], LookedUpUses[2], LookedUpUses[3], LookedUpUses[4], LookedUpUses[5], LookedUpUses[2]);
05158             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05159         }
05160 
05161 
05162         SamFreeMemory( LookedUpUses );
05163         SamFreeMemory( LookedUpNames );
05164 
05165     } <span class="keywordflow">else</span> {
05166         printf(<span class="stringliteral">"Failed\n"</span>);
05167         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
05168         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05169     }
05170 
05171 
05172 
05173 
05174     printf(<span class="stringliteral">"      Lookup SIDs (None existing) . . . . . . . . . . . . .     "</span>);
05175 
05176     NtStatus = SamLookupIdsInDomain(
05177                    DomainHandle,
05178                    NO_NAMES_COUNT,
05179                    &amp;NoRids[0],
05180                    &amp;LookedUpNames,
05181                    &amp;LookedUpUses
05182                    );
05183 
05184 
05185     <span class="keywordflow">if</span> (NtStatus == STATUS_NONE_MAPPED) {
05186         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( LookedUpUses  == NULL );
05187         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( LookedUpNames == NULL );
05188 
05189         printf(<span class="stringliteral">"Succeeded\n"</span>);
05190 
05191     } <span class="keywordflow">else</span> {
05192         printf(<span class="stringliteral">"Failed\n"</span>);
05193         printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
05194         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05195     }
05196 
05197 
05198 
05199 
05200 
05201 
05202 
05203     <span class="keywordflow">return</span> TestStatus;
05204 }
05205 
05206 
05208 <span class="comment">//                                                                           //</span>
05209 <span class="comment">// Group  Object Test Suite                                                  //</span>
05210 <span class="comment">//                                                                           //</span>
05212 <span class="comment"></span>
05213 
05214 BOOLEAN
05215 GroupTestSuite(
05216     HANDLE DomainHandle,
05217     ULONG  Pass
05218     )
05219 
05220 {
05221     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            NtStatus, IgnoreStatus;
05222     HANDLE              GroupHandle1, GroupHandle2, UserHandle1;
05223     ULONG               CountReturned, NameLength, i, MemberCount;
05224     ULONG               UserRid, GroupRid;
05225     PVOID               <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>, <a class="code" href="../../d9/d0/tfilmem_8c.html#a2">Buffer2</a>;
05226     SAM_ENUMERATE_HANDLE EnumerationContext;
05227     PULONG              Members, Attributes;
05228     PSID_NAME_USE       LookedUpUses;
05229     PULONG              LookedUpRids;
05230     UNICODE_STRING      AccountNames[10], AccountName;
05231     STRING              AccountNameAnsi;
05232 
05233     BOOLEAN             IndividualTestSucceeded, DeleteUser;
05234     BOOLEAN             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05235 
05236 
05237     <span class="keywordflow">if</span> (Pass == 1) {
05238         <span class="comment">//</span>
05239         <span class="comment">// This test suite assumes that lookup and enumeration API funciton</span>
05240         <span class="comment">// properly.</span>
05241         <span class="comment">//</span>
05242 
05243         printf(<span class="stringliteral">"\n"</span>);
05244         printf(<span class="stringliteral">"\n"</span>);
05245         printf(<span class="stringliteral">"  Group (Pass #1) . . . . . . . . . . . . . . . . . . .   Test\n"</span>);
05246 
05248         <span class="comment">//                                                                       //</span>
05249         <span class="comment">// Open Group Suite                                                      //</span>
05250         <span class="comment">//                                                                       //</span>
05252 <span class="comment"></span>
05253         printf(<span class="stringliteral">"    Open Group  . . . . . . . . . . . . . . . . . . . . .   Suite\n"</span>);
05254         printf(<span class="stringliteral">"      Open Groups . . . . . . . . . . . . . . . . . . . . .     "</span>);
05255         IndividualTestSucceeded = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05256         EnumerationContext = 0;
05257         NtStatus = SamEnumerateGroupsInDomain(
05258                        DomainHandle,
05259                        &amp;EnumerationContext,
05260                        &amp;Buffer,
05261                        12000,                   <span class="comment">// PreferedMaximumLength</span>
05262                        &amp;CountReturned
05263                        );
05264 
05265         TST_SUCCESS_ASSERT(NtStatus);
05266         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Buffer != NULL);
05267         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(CountReturned &gt; 0);
05268 
05269         <span class="keywordflow">for</span> (i=0; i&lt;CountReturned; i++) {
05270 
05271             NtStatus = SamOpenGroup(
05272                            DomainHandle,
05273                            GROUP_ALL_ACCESS,
05274                            ((PSAM_RID_ENUMERATION)(Buffer))[i].RelativeId,
05275                            &amp;GroupHandle1
05276                            );
05277 
05278             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
05279 
05280                 NtStatus = SamOpenGroup(
05281                                DomainHandle,
05282                                GENERIC_READ,
05283                                ((PSAM_RID_ENUMERATION)(Buffer))[i].RelativeId,
05284                                &amp;GroupHandle2
05285                                );
05286 
05287                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
05288                     IgnoreStatus = SamCloseHandle( GroupHandle2 );
05289                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
05290                 } <span class="keywordflow">else</span> {
05291                     printf(<span class="stringliteral">"Failed\n"</span>);
05292                     printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
05293                     printf(<span class="stringliteral">"        Failed opening group second time.\n"</span>);
05294                     printf(<span class="stringliteral">"        Rid of account is:   0x%lx\n"</span>,
05295                         ((PSAM_RID_ENUMERATION)(Buffer))[i].RelativeId);
05296                     printf(<span class="stringliteral">"        Name of account is:  %wZ\n"</span>,
05297                         &amp;((PSAM_RID_ENUMERATION)(Buffer))[i].Name );
05298                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05299                     IndividualTestSucceeded = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05300                 }
05301 
05302                 IgnoreStatus = SamCloseHandle( GroupHandle1 );
05303                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
05304 
05305             } <span class="keywordflow">else</span> {
05306 
05307                 printf(<span class="stringliteral">"Failed\n"</span>);
05308                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
05309                 printf(<span class="stringliteral">"        Failed opening group for first time.\n"</span>);
05310                 printf(<span class="stringliteral">"        Rid of account is:   0x%lx\n"</span>,
05311                     ((PSAM_RID_ENUMERATION)(Buffer))[i].RelativeId);
05312                 printf(<span class="stringliteral">"        Name of account is:  %wZ\n"</span>,
05313                     &amp;((PSAM_RID_ENUMERATION)(Buffer))[i].Name );
05314                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05315                 IndividualTestSucceeded = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05316             }
05317 
05318             <span class="keywordflow">if</span> (!IndividualTestSucceeded) {
05319                 printf(<span class="stringliteral">"                                                                "</span>);
05320             }
05321         }
05322 
05323 
05324         SamFreeMemory( Buffer );
05325         <span class="keywordflow">if</span> (IndividualTestSucceeded) {
05326             printf(<span class="stringliteral">"Succeeded\n"</span>);
05327         }
05328 
05329 
05330 
05332         <span class="comment">//                                                                       //</span>
05333         <span class="comment">// Query     Group Suite                                                 //</span>
05334         <span class="comment">//                                                                       //</span>
05336 <span class="comment"></span>
05337         printf(<span class="stringliteral">"\n"</span>);
05338         printf(<span class="stringliteral">"    Query Group . . . . . . . . . . . . . . . . . . . . .   Suite\n"</span>);
05339 
05340         printf(<span class="stringliteral">"      Query Group General Information . . . . . . . . . . .     "</span>);
05341 
05342 
05343         NtStatus = SamOpenGroup(
05344                        DomainHandle,
05345                        GROUP_READ_INFORMATION,
05346                        DOMAIN_GROUP_RID_USERS,
05347                        &amp;GroupHandle1
05348                        );
05349         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
05350 
05351         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05352         NtStatus = SamQueryInformationGroup(
05353                        GroupHandle1,
05354                        GroupGeneralInformation,
05355                        &amp;Buffer
05356                        );
05357         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
05358             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05359 
05360                 <span class="keywordflow">if</span> ( (((GROUP_GENERAL_INFORMATION *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;Name.MaximumLength &gt; 0) &amp;&amp;
05361                      (((GROUP_GENERAL_INFORMATION *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;Name.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)  ) {
05362 
05363                     printf(<span class="stringliteral">"Succeeded\n"</span>);
05364 
05365                     printf(<span class="stringliteral">"        Member Count is:  0x%lx\n"</span>,
05366                      (((GROUP_GENERAL_INFORMATION *)Buffer)-&gt;MemberCount) );
05367                     printf(<span class="stringliteral">"        Attributes are:   0x%lx\n"</span>,
05368                      (((GROUP_GENERAL_INFORMATION *)Buffer)-&gt;Attributes) );
05369                     printf(<span class="stringliteral">"        Group Name is:    %wZ\n"</span>,
05370                      &amp;(((GROUP_GENERAL_INFORMATION *)Buffer)-&gt;Name) );
05371 
05372 
05373 
05374                 } <span class="keywordflow">else</span> {
05375                     printf(<span class="stringliteral">"Failed\n"</span>);
05376                     printf(<span class="stringliteral">"        Group Name not returned.\n"</span>);
05377                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05378                 }
05379                 SamFreeMemory( Buffer );
05380             } <span class="keywordflow">else</span> {
05381                 printf(<span class="stringliteral">"Failed\n"</span>);
05382                 printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
05383                 printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
05384                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05385             }
05386         } <span class="keywordflow">else</span> {
05387             printf(<span class="stringliteral">"Failed\n"</span>);
05388             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
05389             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05390         }
05391         IgnoreStatus = SamCloseHandle( GroupHandle1 );
05392         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
05393 
05394 
05395 
05396 
05397         printf(<span class="stringliteral">"      Query Group Name Information  . . . . . . . . . . . .     "</span>);
05398 
05399 
05400         NtStatus = SamOpenGroup(
05401                        DomainHandle,
05402                        GROUP_READ_INFORMATION,
05403                        DOMAIN_GROUP_RID_USERS,
05404                        &amp;GroupHandle1
05405                        );
05406         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
05407 
05408         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05409         NtStatus = SamQueryInformationGroup(
05410                        GroupHandle1,
05411                        GroupNameInformation,
05412                        &amp;Buffer
05413                        );
05414         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
05415             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05416 
05417                 <span class="keywordflow">if</span> ( (((GROUP_NAME_INFORMATION *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;Name.MaximumLength &gt; 0) &amp;&amp;
05418                      (((GROUP_NAME_INFORMATION *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;Name.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)  ) {
05419 
05420                     printf(<span class="stringliteral">"Succeeded\n"</span>);
05421 
05422                     printf(<span class="stringliteral">"        Group Name is:    %wZ\n"</span>,
05423                      &amp;(((GROUP_NAME_INFORMATION *)Buffer)-&gt;Name) );
05424 
05425 
05426 
05427                 } <span class="keywordflow">else</span> {
05428                     printf(<span class="stringliteral">"Failed\n"</span>);
05429                     printf(<span class="stringliteral">"        Group Name not returned.\n"</span>);
05430                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05431                 }
05432                 SamFreeMemory( Buffer );
05433             } <span class="keywordflow">else</span> {
05434                 printf(<span class="stringliteral">"Failed\n"</span>);
05435                 printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
05436                 printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
05437                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05438             }
05439         } <span class="keywordflow">else</span> {
05440             printf(<span class="stringliteral">"Failed\n"</span>);
05441             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
05442             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05443         }
05444         IgnoreStatus = SamCloseHandle( GroupHandle1 );
05445         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
05446 
05447 
05448 
05449 
05450         printf(<span class="stringliteral">"      Query Group Admin Comment Information . . . . . . . .     "</span>);
05451 
05452 
05453         NtStatus = SamOpenGroup(
05454                        DomainHandle,
05455                        GROUP_READ_INFORMATION,
05456                        DOMAIN_GROUP_RID_USERS,
05457                        &amp;GroupHandle1
05458                        );
05459         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
05460 
05461         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05462         NtStatus = SamQueryInformationGroup(
05463                        GroupHandle1,
05464                        GroupAdminCommentInformation,
05465                        &amp;Buffer
05466                        );
05467         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
05468             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05469 
05470                 <span class="keywordflow">if</span> ( (((GROUP_ADM_COMMENT_INFORMATION *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;AdminComment.MaximumLength &gt;= 0) ) {
05471 
05472                     printf(<span class="stringliteral">"Succeeded\n"</span>);
05473 
05474                     printf(<span class="stringliteral">"        Group Admin Comment is:    %wZ\n"</span>,
05475                      &amp;(((GROUP_ADM_COMMENT_INFORMATION *)Buffer)-&gt;AdminComment) );
05476 
05477 
05478 
05479                 } <span class="keywordflow">else</span> {
05480                     printf(<span class="stringliteral">"Failed\n"</span>);
05481                     printf(<span class="stringliteral">"        Group Admin Comment not returned.\n"</span>);
05482                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05483                 }
05484                 SamFreeMemory( Buffer );
05485             } <span class="keywordflow">else</span> {
05486                 printf(<span class="stringliteral">"Failed\n"</span>);
05487                 printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
05488                 printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
05489                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05490             }
05491         } <span class="keywordflow">else</span> {
05492             printf(<span class="stringliteral">"Failed\n"</span>);
05493             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
05494             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05495         }
05496         IgnoreStatus = SamCloseHandle( GroupHandle1 );
05497         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
05498 
05499 
05500 
05501 
05502         printf(<span class="stringliteral">"      Query Group Attribute Information . . . . . . . . . .     "</span>);
05503 
05504 
05505         NtStatus = SamOpenGroup(
05506                        DomainHandle,
05507                        GROUP_READ_INFORMATION,
05508                        DOMAIN_GROUP_RID_USERS,
05509                        &amp;GroupHandle1
05510                        );
05511         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
05512 
05513         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05514         NtStatus = SamQueryInformationGroup(
05515                        GroupHandle1,
05516                        GroupAttributeInformation,
05517                        &amp;Buffer
05518                        );
05519         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
05520             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05521 
05522 
05523                 printf(<span class="stringliteral">"Succeeded\n"</span>);
05524 
05525                 printf(<span class="stringliteral">"        Attributes are:   0x%lx\n"</span>,
05526                  (((GROUP_ATTRIBUTE_INFORMATION *)Buffer)-&gt;Attributes) );
05527 
05528 
05529                 SamFreeMemory( Buffer );
05530 
05531             } <span class="keywordflow">else</span> {
05532                 printf(<span class="stringliteral">"Failed\n"</span>);
05533                 printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
05534                 printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
05535                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05536             }
05537         } <span class="keywordflow">else</span> {
05538             printf(<span class="stringliteral">"Failed\n"</span>);
05539             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
05540             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05541         }
05542         IgnoreStatus = SamCloseHandle( GroupHandle1 );
05543         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
05544 
05545 
05546 
05547 
05549         <span class="comment">//                                                                       //</span>
05550         <span class="comment">// Get Members Of Group Suite                                            //</span>
05551         <span class="comment">//                                                                       //</span>
05553 <span class="comment"></span>
05554         printf(<span class="stringliteral">"\n"</span>);
05555         printf(<span class="stringliteral">"    Get Members . . . . . . . . . . . . . . . . . . . . .   Suite\n"</span>);
05556 
05557         printf(<span class="stringliteral">"      Get Members of Well-Known Account . . . . . . . . . .     "</span>);
05558 
05559         NtStatus = SamOpenGroup(
05560                        DomainHandle,
05561                        GROUP_LIST_MEMBERS,
05562                        DOMAIN_GROUP_RID_USERS,
05563                        &amp;GroupHandle1
05564                        );
05565         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
05566 
05567         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05568         NtStatus = SamGetMembersInGroup(
05569                        GroupHandle1,
05570                        &amp;Members,
05571                        &amp;Attributes,
05572                        &amp;MemberCount
05573                        );
05574         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
05575             <span class="keywordflow">if</span> (Members != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || Attributes != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05576 
05577                 printf(<span class="stringliteral">"Succeeded\n"</span>);
05578 
05579 
05580                 printf(<span class="stringliteral">"       Member Count:    %d Users\n"</span>, MemberCount);
05581                 <span class="keywordflow">for</span> ( i=0; i&lt;MemberCount; i++) {
05582 
05583                     printf(<span class="stringliteral">"       User[%d] Rid/Attributes:      0x%lx/0x%lx\n"</span>,
05584                         i, Members[i], Attributes[i]);
05585 
05586 
05587                 }
05588 
05589                 SamFreeMemory( Members );
05590                 SamFreeMemory( Attributes );
05591 
05592 
05593             } <span class="keywordflow">else</span> {
05594                 printf(<span class="stringliteral">"Failed\n"</span>);
05595                 printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
05596                 printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
05597                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05598             }
05599         } <span class="keywordflow">else</span> {
05600             printf(<span class="stringliteral">"Failed\n"</span>);
05601             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
05602             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05603         }
05604         IgnoreStatus = SamCloseHandle( GroupHandle1 );
05605         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
05606 
05607 
05608 
05609         printf(<span class="stringliteral">"      Get Members of Empty Group. . . . . . . . . . . . . .     "</span>);
05610 
05611         <span class="comment">//</span>
05612         <span class="comment">// This group was created earlier in the test</span>
05613         <span class="comment">//</span>
05614 
05615         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, GROUP_NAME1 );
05616         NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountNames[0], &amp;AccountNameAnsi, TRUE );
05617         TST_SUCCESS_ASSERT(NtStatus);
05618 
05619         NtStatus = SamLookupNamesInDomain(
05620                        DomainHandle,
05621                        1,
05622                        &amp;AccountNames[0],
05623                        &amp;LookedUpRids,
05624                        &amp;LookedUpUses
05625                        );
05626         TST_SUCCESS_ASSERT(NtStatus);
05627         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(LookedUpUses[0] == SidTypeGroup);
05628         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountNames[0] );
05629 
05630 
05631 
05632         GroupHandle1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05633 
05634         NtStatus = SamOpenGroup( DomainHandle, GROUP_LIST_MEMBERS, LookedUpRids[0], &amp;GroupHandle1 );
05635         TST_SUCCESS_ASSERT(NtStatus);
05636         SamFreeMemory( LookedUpUses ); SamFreeMemory( LookedUpRids );
05637 
05638         NtStatus = SamGetMembersInGroup(
05639                        GroupHandle1,
05640                        &amp;Members,
05641                        &amp;Attributes,
05642                        &amp;MemberCount
05643                        );
05644         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
05645             <span class="keywordflow">if</span> (MemberCount == 0) {
05646 
05647                 printf(<span class="stringliteral">"Succeeded\n"</span>);
05648 
05649 
05650 
05651 
05652             } <span class="keywordflow">else</span> {
05653                 printf(<span class="stringliteral">"Failed\n"</span>);
05654                 printf(<span class="stringliteral">"        Buffer addresses  set on return.\n"</span>);
05655                 printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
05656                 printf(<span class="stringliteral">"       Member Count:    %d\n"</span>, MemberCount);
05657                 <span class="keywordflow">for</span> ( i=0; i&lt;MemberCount; i++) {
05658 
05659                     printf(<span class="stringliteral">"       User[%d] Rid/Attributes:      0x%lx/0x%lx\n"</span>,
05660                         i, Members[i], Attributes[i]);
05661                 }
05662 
05663                 SamFreeMemory( Members );
05664                 SamFreeMemory( Attributes );
05665                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05666             }
05667         } <span class="keywordflow">else</span> {
05668             printf(<span class="stringliteral">"Failed\n"</span>);
05669             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
05670             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05671         }
05672         IgnoreStatus = SamCloseHandle( GroupHandle1 );
05673         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
05674 
05675 
05677         <span class="comment">//                                                                       //</span>
05678         <span class="comment">// Set Group Suite  (pass 1)                                             //</span>
05679         <span class="comment">//                                                                       //</span>
05681 <span class="comment"></span>
05682         printf(<span class="stringliteral">"\n"</span>);
05683         printf(<span class="stringliteral">"    Set Group . . . . . . . . . . . . . . . . . . . . . .   Suite\n"</span>);
05684 
05685 
05686         printf(<span class="stringliteral">"      Set Attribute . . . . . . . . . . . . . . . . . . . .     "</span>);
05687         NtStatus = SamOpenGroup(
05688                        DomainHandle,
05689                        GROUP_WRITE_ACCOUNT | GROUP_READ_INFORMATION,
05690                        DOMAIN_GROUP_RID_USERS,
05691                        &amp;GroupHandle1
05692                        );
05693         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
05694 
05695         <a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05696         NtStatus = SamQueryInformationGroup(
05697                        GroupHandle1,
05698                        GroupAttributeInformation,
05699                        &amp;Buffer1
05700                        );
05701         TST_SUCCESS_ASSERT(NtStatus);
05702         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Buffer1 != NULL);
05703 
05704         <span class="comment">//</span>
05705         <span class="comment">// Change the value and write it back</span>
05706         <span class="comment">//</span>
05707 
05708         ((GROUP_ATTRIBUTE_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;Attributes ^=
05709             SE_GROUP_ENABLED_BY_DEFAULT;
05710 
05711 
05712         NtStatus = SamSetInformationGroup(
05713                        GroupHandle1,
05714                        GroupAttributeInformation,
05715                        Buffer1
05716                        );
05717         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
05718 
05719             <span class="comment">//</span>
05720             <span class="comment">// Check the written value to make sure it stuck</span>
05721             <span class="comment">//</span>
05722 
05723             <a class="code" href="../../d9/d0/tfilmem_8c.html#a2">Buffer2</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05724             NtStatus = SamQueryInformationGroup(
05725                            GroupHandle1,
05726                            GroupAttributeInformation,
05727                            &amp;Buffer2
05728                            );
05729             TST_SUCCESS_ASSERT(NtStatus);
05730             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Buffer2 != NULL);
05731 
05732             <span class="keywordflow">if</span> (((GROUP_ATTRIBUTE_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;Attributes ==
05733                 ((GROUP_ATTRIBUTE_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a2">Buffer2</a>)-&gt;Attributes   ) {
05734 
05735                 printf(<span class="stringliteral">"Succeeded\n"</span>);
05736 
05737                 SamFreeMemory( Buffer2 );
05738 
05739             } <span class="keywordflow">else</span> {
05740                 printf(<span class="stringliteral">"Failed\n"</span>);
05741                 printf(<span class="stringliteral">"        Returned Value Doesn't Match Set Value.\n"</span>);
05742                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05743             }
05744         } <span class="keywordflow">else</span> {
05745             printf(<span class="stringliteral">"Failed\n"</span>);
05746             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
05747             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05748         }
05749         SamFreeMemory( Buffer1 );
05750         IgnoreStatus = SamCloseHandle( GroupHandle1 );
05751         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
05752 
05753 
05754 
05755 
05756 
05757         printf(<span class="stringliteral">"      Set Admin Comment . . . . . . . . . . . . . . . . . .     "</span>);
05758 
05759             NtStatus = SamOpenGroup(
05760                            DomainHandle,
05761                            GROUP_WRITE_ACCOUNT | GROUP_READ_INFORMATION,
05762                            DOMAIN_GROUP_RID_USERS,
05763                            &amp;GroupHandle1
05764                            );
05765             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
05766 
05767             <span class="comment">//</span>
05768             <span class="comment">// Get the current value...</span>
05769             <span class="comment">//</span>
05770 
05771             <a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05772             NtStatus = SamQueryInformationGroup(
05773                            GroupHandle1,
05774                            GroupAdminCommentInformation,
05775                            &amp;Buffer1
05776                            );
05777             TST_SUCCESS_ASSERT(NtStatus);
05778             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Buffer1 != NULL);
05779 
05780 
05781             <span class="comment">//</span>
05782             <span class="comment">// Change the field to a new value and write it out.</span>
05783             <span class="comment">//</span>
05784 
05785             NameLength = ((GROUP_ADM_COMMENT_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;AdminComment.Length;
05786             <span class="keywordflow">if</span> (  NameLength == DummyString1.Length ) {
05787                 ((GROUP_ADM_COMMENT_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;AdminComment = DummyString2;
05788             } <span class="keywordflow">else</span> {
05789                 ((GROUP_ADM_COMMENT_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;AdminComment = DummyString1;
05790             }
05791 
05792             NtStatus = SamSetInformationGroup(
05793                            GroupHandle1,
05794                            GroupAdminCommentInformation,
05795                            Buffer1
05796                            );
05797             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) ) {
05798 
05799                 <span class="comment">//</span>
05800                 <span class="comment">// Now check that the change was really made...</span>
05801                 <span class="comment">//</span>
05802 
05803                 <a class="code" href="../../d9/d0/tfilmem_8c.html#a2">Buffer2</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05804                 NtStatus = SamQueryInformationGroup(
05805                                GroupHandle1,
05806                                GroupAdminCommentInformation,
05807                                &amp;Buffer2
05808                                );
05809                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( NtStatus ) );
05810                 <span class="keywordflow">if</span> (
05811                     !<a class="code" href="../../d2/d7/string_8c.html#a10">RtlCompareString</a>(
05812                         (PSTRING)&amp;((GROUP_ADM_COMMENT_INFORMATION *)Buffer1)-&gt;AdminComment,
05813                         (PSTRING)&amp;((GROUP_ADM_COMMENT_INFORMATION *)Buffer2)-&gt;AdminComment,
05814                         TRUE)
05815                     ) {
05816 
05817                     printf(<span class="stringliteral">"Succeeded\n"</span>);
05818 
05819                 } <span class="keywordflow">else</span> {
05820 
05821                     printf(<span class="stringliteral">"Failed\n"</span>);
05822                     printf(<span class="stringliteral">"        Value queried doesn't match value written\n"</span>);
05823                     printf(<span class="stringliteral">"        Value Written is   %wZ\n"</span>,
05824                         (PUNICODE_STRING)&amp;((GROUP_ADM_COMMENT_INFORMATION *)Buffer1)-&gt;AdminComment);
05825                     printf(<span class="stringliteral">"        Value Retrieved is %wZ\n"</span>,
05826                         (PUNICODE_STRING)&amp;((GROUP_ADM_COMMENT_INFORMATION *)Buffer2)-&gt;AdminComment);
05827 
05828                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05829 
05830                 }
05831 
05832                 SamFreeMemory( Buffer1 );
05833                 SamFreeMemory( Buffer2 );
05834 
05835             } <span class="keywordflow">else</span> {
05836                 printf(<span class="stringliteral">"Failed\n"</span>);
05837                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
05838                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05839                 SamFreeMemory( Buffer1 );
05840 
05841             }
05842 
05843 
05844 
05845 
05846 
05847 
05848     } <span class="comment">// END PASS #1</span>
05849     <span class="keywordflow">if</span> (Pass == 2) {
05850 
05851         printf(<span class="stringliteral">"\n"</span>);
05852         printf(<span class="stringliteral">"\n"</span>);
05853         printf(<span class="stringliteral">"  Group (Pass #2) . . . . . . . . . . . . . . . . . . .   Test\n"</span>);
05854 
05856         <span class="comment">//                                                                       //</span>
05857         <span class="comment">// Delete Group Suite                                                    //</span>
05858         <span class="comment">//                                                                       //</span>
05860 <span class="comment"></span>
05861         printf(<span class="stringliteral">"\n"</span>);
05862         printf(<span class="stringliteral">"    Delete Group  . . . . . . . . . . . . . . . . . . . .   Suite\n"</span>);
05863 
05864         printf(<span class="stringliteral">"      Delete Normal Group . . . . . . . . . . . . . . . . .     "</span>);
05865 
05866         <span class="comment">//</span>
05867         <span class="comment">// This group was created in pass #1</span>
05868         <span class="comment">//</span>
05869 
05870         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, GROUP_NAME1 );
05871         NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountNames[0], &amp;AccountNameAnsi, TRUE );
05872         TST_SUCCESS_ASSERT(NtStatus);
05873 
05874         NtStatus = SamLookupNamesInDomain(
05875                        DomainHandle,
05876                        1,
05877                        &amp;AccountNames[0],
05878                        &amp;LookedUpRids,
05879                        &amp;LookedUpUses
05880                        );
05881         TST_SUCCESS_ASSERT(NtStatus);
05882         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(LookedUpUses[0] == SidTypeGroup);
05883         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountNames[0] );
05884 
05885 
05886 
05887         GroupHandle1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05888 
05889         NtStatus = SamOpenGroup( DomainHandle, DELETE, LookedUpRids[0], &amp;GroupHandle1 );
05890         TST_SUCCESS_ASSERT(NtStatus);
05891         SamFreeMemory( LookedUpUses ); SamFreeMemory( LookedUpRids );
05892 
05893         NtStatus = SamDeleteGroup( GroupHandle1 );
05894         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
05895             printf(<span class="stringliteral">"Succeeded\n"</span>);
05896 
05897         } <span class="keywordflow">else</span> {
05898             printf(<span class="stringliteral">"Failed\n"</span>);
05899             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
05900             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05901         }
05902 
05903 
05904 
05905 
05906         printf(<span class="stringliteral">"      Delete Well Known Group . . . . . . . . . . . . . . .     "</span>);
05907 
05908         GroupHandle1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05909 
05910         NtStatus = SamOpenGroup( DomainHandle, DELETE, DOMAIN_GROUP_RID_USERS, &amp;GroupHandle1 );
05911         TST_SUCCESS_ASSERT(NtStatus);
05912 
05913         NtStatus = SamDeleteGroup( GroupHandle1 );
05914         <span class="keywordflow">if</span> (NtStatus == STATUS_SPECIAL_ACCOUNT) {
05915 
05916             printf(<span class="stringliteral">"Succeeded\n"</span>);
05917 
05918         } <span class="keywordflow">else</span> {
05919             printf(<span class="stringliteral">"Failed\n"</span>);
05920             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
05921             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05922         }
05923 
05924         NtStatus = SamCloseHandle( GroupHandle1 );
05925         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
05926 
05927 
05928 
05929 
05930 
05931 
05932 
05933 
05934         printf(<span class="stringliteral">"      Delete Primary Group Of A User. . . . . . . . . . . .     "</span>);
05935 
05936         <span class="comment">//</span>
05937         <span class="comment">// Make a user (might already exist)</span>
05938         <span class="comment">// Make a group</span>
05939         <span class="comment">// Make the group the user's primary group</span>
05940         <span class="comment">// Attempt to delete the group</span>
05941         <span class="comment">// Change the user so the group isn't the primary group</span>
05942         <span class="comment">// delete the group</span>
05943         <span class="comment">// If we created the user, delete it.</span>
05944 
05945         <span class="comment">//</span>
05946         <span class="comment">// The following user might already exist (from earlier in the test)</span>
05947         <span class="comment">//</span>
05948 
05949         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, USER_NAME1 );
05950         NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountName, &amp;AccountNameAnsi, TRUE );
05951         TST_SUCCESS_ASSERT(NtStatus);
05952 
05953         <span class="comment">//InitializeObjectAttributes( &amp;ObjectAttributes, &amp;AccountName, 0, 0, NULL );</span>
05954 
05955 
05956         UserRid = 0;
05957         UserHandle1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05958         NtStatus = SamCreateUserInDomain(
05959                        DomainHandle,
05960                        &amp;AccountName,
05961                        USER_ALL_ACCESS,
05962                        &amp;UserHandle1,
05963                        &amp;UserRid
05964                        );
05965         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountName );
05966         DeleteUser = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05967         <span class="keywordflow">if</span> (NtStatus == STATUS_USER_EXISTS) {
05968             DeleteUser = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05969             <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, USER_NAME1 );
05970             NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountNames[0], &amp;AccountNameAnsi, TRUE );
05971             TST_SUCCESS_ASSERT(NtStatus);
05972 
05973             NtStatus = SamLookupNamesInDomain(
05974                            DomainHandle,
05975                            1,
05976                            &amp;AccountNames[0],
05977                            &amp;LookedUpRids,
05978                            &amp;LookedUpUses
05979                            );
05980             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountNames[0] );
05981             TST_SUCCESS_ASSERT(NtStatus);
05982             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(LookedUpUses[0] == SidTypeUser);
05983             UserRid = LookedUpRids[0];
05984             NtStatus = SamOpenUser(
05985                            DomainHandle,
05986                            USER_ALL_ACCESS,
05987                            UserRid,
05988                            &amp;UserHandle1);
05989             SamFreeMemory( LookedUpUses ); SamFreeMemory( LookedUpRids );
05990         }
05991 
05992         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
05993 
05994         <span class="comment">//</span>
05995         <span class="comment">// create the group</span>
05996         <span class="comment">//</span>
05997 
05998         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, GROUP_NAME1 );
05999         NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountName, &amp;AccountNameAnsi, TRUE );
06000         TST_SUCCESS_ASSERT(NtStatus);
06001 
06002         <span class="comment">//InitializeObjectAttributes( &amp;ObjectAttributes, &amp;AccountName, 0, 0, NULL );</span>
06003 
06004         GroupRid = 0;
06005         GroupHandle1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06006         NtStatus = SamCreateGroupInDomain(
06007                        DomainHandle,
06008                        &amp;AccountName,
06009                        GROUP_ALL_ACCESS,
06010                        &amp;GroupHandle1,
06011                        &amp;GroupRid
06012                        );
06013         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountName );
06014         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
06015 
06016         <span class="comment">//</span>
06017         <span class="comment">// Make the user a member of this group</span>
06018         <span class="comment">//</span>
06019 
06020         NtStatus = SamAddMemberToGroup(
06021                        GroupHandle1,
06022                        UserRid,
06023                        SE_GROUP_MANDATORY              |
06024                            SE_GROUP_ENABLED_BY_DEFAULT |
06025                            SE_GROUP_ENABLED
06026                        );
06027         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
06028 
06029 
06030 
06031 
06032         <span class="comment">//</span>
06033         <span class="comment">// Now try to delete the group</span>
06034         <span class="comment">//</span>
06035 
06036         NtStatus = SamDeleteGroup( GroupHandle1 );
06037         <span class="keywordflow">if</span> (NtStatus == STATUS_MEMBER_IN_GROUP) {
06038 
06039             printf(<span class="stringliteral">"Succeeded\n"</span>);
06040 
06041         } <span class="keywordflow">else</span> {
06042             printf(<span class="stringliteral">"Failed\n"</span>);
06043             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
06044             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06045         }
06046 
06047 
06048         <span class="comment">//</span>
06049         <span class="comment">// Now get rid of the group and possibly the user account</span>
06050         <span class="comment">//</span>
06051 
06052         NtStatus = SamRemoveMemberFromGroup(GroupHandle1, UserRid);
06053         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
06054 
06055 
06056         NtStatus = SamDeleteGroup( GroupHandle1 );
06057         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
06058 
06059         <span class="keywordflow">if</span> (DeleteUser == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
06060             NtStatus = SamDeleteUser( UserHandle1 );
06061             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
06062         } <span class="keywordflow">else</span> {
06063             NtStatus = SamCloseHandle( UserHandle1 );
06064             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
06065         }
06066 
06067 
06068 
06070         <span class="comment">//                                                                       //</span>
06071         <span class="comment">// Add/Remove Member Suite                                               //</span>
06072         <span class="comment">//                                                                       //</span>
06074 <span class="comment"></span>
06075         printf(<span class="stringliteral">"\n"</span>);
06076         printf(<span class="stringliteral">"    Add/Remove Member Suite . . . . . . . . . . . . . . .   Suite\n"</span>);
06077 
06078         printf(<span class="stringliteral">"      Add Member  . . . . . . . . . . . . . . . . . . . . .     "</span>);
06079 
06080         <span class="comment">//</span>
06081         <span class="comment">// This test sets things up for the next test</span>
06082         <span class="comment">//</span>
06083 
06084         <span class="comment">//</span>
06085         <span class="comment">// The following user might already exist (from earlier in the test)</span>
06086         <span class="comment">//</span>
06087 
06088         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, USER_NAME1 );
06089         NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountName, &amp;AccountNameAnsi, TRUE );
06090         TST_SUCCESS_ASSERT(NtStatus);
06091 
06092         <span class="comment">//InitializeObjectAttributes( &amp;ObjectAttributes, &amp;AccountName, 0, 0, NULL );</span>
06093 
06094         UserRid = 0;
06095         UserHandle1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06096         NtStatus = SamCreateUserInDomain(
06097                        DomainHandle,
06098                        &amp;AccountName,
06099                        USER_ALL_ACCESS,
06100                        &amp;UserHandle1,
06101                        &amp;UserRid
06102                        );
06103         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountName );
06104         DeleteUser = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06105         <span class="keywordflow">if</span> (NtStatus == STATUS_USER_EXISTS) {
06106             DeleteUser = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06107             <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, USER_NAME1 );
06108             NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountNames[0], &amp;AccountNameAnsi, TRUE );
06109             TST_SUCCESS_ASSERT(NtStatus);
06110 
06111             NtStatus = SamLookupNamesInDomain(
06112                            DomainHandle,
06113                            1,
06114                            &amp;AccountNames[0],
06115                            &amp;LookedUpRids,
06116                            &amp;LookedUpUses
06117                            );
06118             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountNames[0] );
06119             TST_SUCCESS_ASSERT(NtStatus);
06120             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(LookedUpUses[0] == SidTypeUser);
06121             UserRid = LookedUpRids[0];
06122             NtStatus = SamOpenUser(
06123                            DomainHandle,
06124                            USER_ALL_ACCESS,
06125                            UserRid,
06126                            &amp;UserHandle1);
06127             SamFreeMemory( LookedUpUses ); SamFreeMemory( LookedUpRids );
06128         }
06129 
06130         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
06131 
06132 
06133         <span class="comment">//</span>
06134         <span class="comment">// create the group</span>
06135         <span class="comment">//</span>
06136 
06137         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, GROUP_NAME1 );
06138         NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountName, &amp;AccountNameAnsi, TRUE );
06139         TST_SUCCESS_ASSERT(NtStatus);
06140 
06141         <span class="comment">//InitializeObjectAttributes( &amp;ObjectAttributes, &amp;AccountName, 0, 0, NULL );</span>
06142 
06143         GroupRid = 0;
06144         GroupHandle1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06145         NtStatus = SamCreateGroupInDomain(
06146                        DomainHandle,
06147                        &amp;AccountName,
06148                        GROUP_ALL_ACCESS,
06149                        &amp;GroupHandle1,
06150                        &amp;GroupRid
06151                        );
06152         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountName );
06153         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
06154 
06155         <span class="comment">//</span>
06156         <span class="comment">// Make the user a member of this group</span>
06157         <span class="comment">//</span>
06158 
06159         NtStatus = SamAddMemberToGroup(
06160                        GroupHandle1,
06161                        UserRid,
06162                        SE_GROUP_MANDATORY              |
06163                            SE_GROUP_ENABLED_BY_DEFAULT |
06164                            SE_GROUP_ENABLED
06165                        );
06166 
06167         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
06168 
06169             NtStatus = SamGetMembersInGroup(
06170                            GroupHandle1,
06171                            &amp;Members,
06172                            &amp;Attributes,
06173                            &amp;MemberCount
06174                            );
06175             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
06176 
06177             NtStatus = STATUS_MEMBER_NOT_IN_GROUP;
06178             <span class="keywordflow">for</span> ( i=0; i&lt;MemberCount; i++) {
06179                 <span class="keywordflow">if</span> (Members[i] == UserRid) {
06180                     NtStatus = STATUS_SUCCESS;
06181                     <span class="keywordflow">break</span>;
06182                 }
06183             }
06184 
06185             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
06186                 <span class="keywordflow">if</span> (Attributes[i] == SE_GROUP_MANDATORY          |
06187                                            SE_GROUP_ENABLED_BY_DEFAULT |
06188                                            SE_GROUP_ENABLED) {
06189                     printf(<span class="stringliteral">"Succeeded\n"</span>);
06190                 } <span class="keywordflow">else</span> {
06191                     printf(<span class="stringliteral">"Failed\n"</span>);
06192                     printf(<span class="stringliteral">"Member Added but attributes don't match expected value.\n"</span>);
06193                     printf(<span class="stringliteral">"Expected value:  0x%lx\n"</span>,(SE_GROUP_MANDATORY | SE_GROUP_ENABLED_BY_DEFAULT | SE_GROUP_ENABLED));
06194                     printf(<span class="stringliteral">"Retrieved value:  0x%lx\n"</span>,Attributes[i]);
06195                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06196                 }
06197             } <span class="keywordflow">else</span> {
06198                 printf(<span class="stringliteral">"Failed\n"</span>);
06199                 printf(<span class="stringliteral">"Service returned SUCCESS, but user not in member list for group.\n"</span>);
06200                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06201             }
06202 
06203 
06204             <span class="keywordflow">if</span> (Members != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06205                 SamFreeMemory( Members );
06206                 SamFreeMemory( Attributes );
06207             }
06208 
06209 
06210         } <span class="keywordflow">else</span> {
06211             printf(<span class="stringliteral">"Failed\n"</span>);
06212             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
06213             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06214         }
06215 
06216 
06217 
06218 
06219         printf(<span class="stringliteral">"      Remove Member . . . . . . . . . . . . . . . . . . . .     "</span>);
06220 
06221         <span class="comment">//</span>
06222         <span class="comment">// The previous test sets this one up.</span>
06223         <span class="comment">//</span>
06224 
06225         <span class="comment">//</span>
06226         <span class="comment">// Now try to remove the user from the group</span>
06227         <span class="comment">//</span>
06228 
06229         NtStatus = SamRemoveMemberFromGroup(GroupHandle1, UserRid);
06230         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
06231 
06232             NtStatus = SamGetMembersInGroup(
06233                            GroupHandle1,
06234                            &amp;Members,
06235                            &amp;Attributes,
06236                            &amp;MemberCount
06237                            );
06238             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
06239 
06240             <span class="keywordflow">for</span> ( i=0; i&lt;MemberCount; i++) {
06241                 <span class="keywordflow">if</span> (Members[i] == UserRid) {
06242                     NtStatus = STATUS_MEMBER_IN_GROUP;
06243                     <span class="keywordflow">break</span>;
06244                 }
06245             }
06246 
06247             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
06248                 printf(<span class="stringliteral">"Succeeded\n"</span>);
06249             } <span class="keywordflow">else</span> {
06250                 printf(<span class="stringliteral">"Failed\n"</span>);
06251                 printf(<span class="stringliteral">"Service returned SUCCESS, but user still in member list for group.\n"</span>);
06252                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06253             }
06254 
06255 
06256             SamFreeMemory( Members );
06257             SamFreeMemory( Attributes );
06258 
06259         } <span class="keywordflow">else</span> {
06260             printf(<span class="stringliteral">"Failed\n"</span>);
06261             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
06262             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06263         }
06264 
06265 
06266         <span class="comment">//</span>
06267         <span class="comment">// and clean up the user and group accounts</span>
06268         <span class="comment">//</span>
06269 
06270         NtStatus = SamDeleteGroup( GroupHandle1 );
06271         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
06272 
06273         <span class="keywordflow">if</span> (DeleteUser == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
06274             NtStatus = SamDeleteUser( UserHandle1 );
06275             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
06276         } <span class="keywordflow">else</span> {
06277             NtStatus = SamCloseHandle( UserHandle1 );
06278             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
06279         }
06280 
06281 
06282 
06283 
06284 
06285 
06286         printf(<span class="stringliteral">"      Add Non-Existant Member . . . . . . . . . . . . . . .     "</span>);
06287 
06288         <span class="comment">//</span>
06289         <span class="comment">// create the group</span>
06290         <span class="comment">//</span>
06291 
06292         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, GROUP_NAME1 );
06293         NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountName, &amp;AccountNameAnsi, TRUE );
06294         TST_SUCCESS_ASSERT(NtStatus);
06295 
06296         <span class="comment">//InitializeObjectAttributes( &amp;ObjectAttributes, &amp;AccountName, 0, 0, NULL );</span>
06297 
06298         GroupRid = 0;
06299         GroupHandle1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06300         NtStatus = SamCreateGroupInDomain(
06301                        DomainHandle,
06302                        &amp;AccountName,
06303                        GROUP_ALL_ACCESS,
06304                        &amp;GroupHandle1,
06305                        &amp;GroupRid
06306                        );
06307         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountName );
06308         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
06309 
06310         <span class="comment">//</span>
06311         <span class="comment">// Specify a non-existant user be added to this group</span>
06312         <span class="comment">//</span>
06313 
06314         UserRid = 30732579;             <span class="comment">// Pretty sure this user doesn't exist.</span>
06315         NtStatus = SamAddMemberToGroup(
06316                        GroupHandle1,
06317                        UserRid,
06318                        SE_GROUP_MANDATORY              |
06319                            SE_GROUP_ENABLED_BY_DEFAULT |
06320                            SE_GROUP_ENABLED
06321                        );
06322 
06323         <span class="keywordflow">if</span> (NtStatus == STATUS_NO_SUCH_USER) {
06324 
06325             printf(<span class="stringliteral">"Succeeded\n"</span>);
06326 
06327         } <span class="keywordflow">else</span> {
06328             printf(<span class="stringliteral">"Failed\n"</span>);
06329             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
06330             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06331         }
06332 
06333 
06334         NtStatus = SamDeleteGroup( GroupHandle1 );
06335         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
06336 
06337 
06338 
06339 
06340         printf(<span class="stringliteral">"      Remove Non-existant Member  . . . . . . . . . . . . .     "</span>);
06341 
06342         <span class="comment">//</span>
06343         <span class="comment">// create the group</span>
06344         <span class="comment">//</span>
06345 
06346         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, GROUP_NAME1 );
06347         NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountName, &amp;AccountNameAnsi, TRUE );
06348         TST_SUCCESS_ASSERT(NtStatus);
06349 
06350         <span class="comment">//InitializeObjectAttributes( &amp;ObjectAttributes, &amp;AccountName, 0, 0, NULL );</span>
06351 
06352         GroupRid = 0;
06353         GroupHandle1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06354         NtStatus = SamCreateGroupInDomain(
06355                        DomainHandle,
06356                        &amp;AccountName,
06357                        GROUP_ALL_ACCESS,
06358                        &amp;GroupHandle1,
06359                        &amp;GroupRid
06360                        );
06361         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountName );
06362         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
06363 
06364         <span class="comment">//</span>
06365         <span class="comment">// Specify a non-existant user be removed from this group</span>
06366         <span class="comment">//</span>
06367 
06368         UserRid = 30732579;             <span class="comment">// Pretty sure this user doesn't exist.</span>
06369         NtStatus = SamRemoveMemberFromGroup( GroupHandle1, UserRid );
06370 
06371         <span class="keywordflow">if</span> (NtStatus == STATUS_NO_SUCH_USER) {
06372 
06373             printf(<span class="stringliteral">"Succeeded\n"</span>);
06374 
06375         } <span class="keywordflow">else</span> {
06376             printf(<span class="stringliteral">"Failed\n"</span>);
06377             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
06378             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06379         }
06380 
06381 
06382         NtStatus = SamDeleteGroup( GroupHandle1 );
06383         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
06384 
06385 
06386 
06387 
06388         printf(<span class="stringliteral">"      Remove Primary Group Of Member  . . . . . . . . . . .     "</span>);
06389 
06390 
06391         <span class="comment">//</span>
06392         <span class="comment">// Make a user (might already exist)</span>
06393         <span class="comment">// Make a group</span>
06394         <span class="comment">// Make the group the user's primary group</span>
06395         <span class="comment">// Attempt to remove the group (should fail)</span>
06396         <span class="comment">// Change the user so the group isn't the primary group</span>
06397         <span class="comment">// remove the group</span>
06398         <span class="comment">// delete the group</span>
06399         <span class="comment">// If we created the user, delete it.</span>
06400 
06401         <span class="comment">//</span>
06402         <span class="comment">// The following user might already exist (from earlier in the test)</span>
06403         <span class="comment">//</span>
06404 
06405         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, USER_NAME1 );
06406         NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountName, &amp;AccountNameAnsi, TRUE );
06407         TST_SUCCESS_ASSERT(NtStatus);
06408 
06409         <span class="comment">//InitializeObjectAttributes( &amp;ObjectAttributes, &amp;AccountName, 0, 0, NULL );</span>
06410 
06411         UserRid = 0;
06412         UserHandle1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06413         NtStatus = SamCreateUserInDomain(
06414                        DomainHandle,
06415                        &amp;AccountName,
06416                        USER_ALL_ACCESS,
06417                        &amp;UserHandle1,
06418                        &amp;UserRid
06419                        );
06420         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountName );
06421         DeleteUser = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06422         <span class="keywordflow">if</span> (NtStatus == STATUS_USER_EXISTS) {
06423             DeleteUser = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06424             <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, USER_NAME1 );
06425             NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountNames[0], &amp;AccountNameAnsi, TRUE );
06426             TST_SUCCESS_ASSERT(NtStatus);
06427 
06428             NtStatus = SamLookupNamesInDomain(
06429                            DomainHandle,
06430                            1,
06431                            &amp;AccountNames[0],
06432                            &amp;LookedUpRids,
06433                            &amp;LookedUpUses
06434                            );
06435             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountNames[0] );
06436             TST_SUCCESS_ASSERT(NtStatus);
06437             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(LookedUpUses[0] == SidTypeUser);
06438             UserRid = LookedUpRids[0];
06439             NtStatus = SamOpenUser(
06440                            DomainHandle,
06441                            USER_ALL_ACCESS,
06442                            UserRid,
06443                            &amp;UserHandle1);
06444             SamFreeMemory( LookedUpUses ); SamFreeMemory( LookedUpRids );
06445         }
06446 
06447         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
06448 
06449 
06450         <span class="comment">//</span>
06451         <span class="comment">// create the group</span>
06452         <span class="comment">//</span>
06453 
06454         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, GROUP_NAME1 );
06455         NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountName, &amp;AccountNameAnsi, TRUE );
06456         TST_SUCCESS_ASSERT(NtStatus);
06457 
06458         <span class="comment">//InitializeObjectAttributes( &amp;ObjectAttributes, &amp;AccountName, 0, 0, NULL );</span>
06459 
06460         GroupRid = 0;
06461         GroupHandle1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06462         NtStatus = SamCreateGroupInDomain(
06463                        DomainHandle,
06464                        &amp;AccountName,
06465                        GROUP_ALL_ACCESS,
06466                        &amp;GroupHandle1,
06467                        &amp;GroupRid
06468                        );
06469         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountName );
06470         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
06471 
06472         <span class="comment">//</span>
06473         <span class="comment">// Make the user a member of this group</span>
06474         <span class="comment">//</span>
06475 
06476         NtStatus = SamAddMemberToGroup(
06477                        GroupHandle1,
06478                        UserRid,
06479                        SE_GROUP_MANDATORY              |
06480                            SE_GROUP_ENABLED_BY_DEFAULT |
06481                            SE_GROUP_ENABLED
06482                        );
06483         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
06484 
06485 
06486         <span class="comment">//</span>
06487         <span class="comment">// Set the user's primary group Id to be this group</span>
06488         <span class="comment">//</span>
06489 
06490         NtStatus = SamSetInformationUser(
06491                        UserHandle1,
06492                        UserPrimaryGroupInformation,
06493                        &amp;GroupRid
06494                        );
06495         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
06496 
06497 
06498 
06499         <span class="comment">//</span>
06500         <span class="comment">// Now try to remove the user from the group</span>
06501         <span class="comment">//</span>
06502 
06503         NtStatus = SamRemoveMemberFromGroup(GroupHandle1, UserRid);
06504         <span class="keywordflow">if</span> (NtStatus == STATUS_MEMBERS_PRIMARY_GROUP) {
06505 
06506             printf(<span class="stringliteral">"Succeeded\n"</span>);
06507 
06508         } <span class="keywordflow">else</span> {
06509             printf(<span class="stringliteral">"Failed\n"</span>);
06510             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
06511             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06512         }
06513 
06514 
06515         <span class="comment">//</span>
06516         <span class="comment">// Set the user's primary group Id back and remove the user</span>
06517         <span class="comment">// from the group</span>
06518         <span class="comment">//</span>
06519 
06520         GroupRid = DOMAIN_GROUP_RID_USERS;
06521         NtStatus = SamSetInformationUser(
06522                        UserHandle1,
06523                        UserPrimaryGroupInformation,
06524                        &amp;GroupRid
06525                        );
06526         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
06527         NtStatus = SamRemoveMemberFromGroup(GroupHandle1, UserRid);
06528         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
06529 
06530 
06531 
06532         <span class="comment">//</span>
06533         <span class="comment">// Now get rid of the group and possibly the user account</span>
06534         <span class="comment">//</span>
06535 
06536 
06537         NtStatus = SamDeleteGroup( GroupHandle1 );
06538         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
06539 
06540         <span class="keywordflow">if</span> (DeleteUser == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
06541             NtStatus = SamDeleteUser( UserHandle1 );
06542             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
06543         } <span class="keywordflow">else</span> {
06544             NtStatus = SamCloseHandle( UserHandle1 );
06545             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
06546         }
06547 
06548 
06549 
06550 
06551 
06552 
06554         <span class="comment">//                                                                       //</span>
06555         <span class="comment">// Set Group Suite  (pass 2)                                             //</span>
06556         <span class="comment">//                                                                       //</span>
06558 <span class="comment"></span>
06559         printf(<span class="stringliteral">"\n"</span>);
06560         printf(<span class="stringliteral">"    Set Group . . . . . . . . . . . . . . . . . . . . . .   Suite\n"</span>);
06561 
06562 
06563         printf(<span class="stringliteral">"      Set Name  . . . . . . . . . . . . . . . . . . . . . .     "</span>);
06564         printf(<span class="stringliteral">"(Untested)\n"</span>);
06565 
06566 
06567         printf(<span class="stringliteral">"      Set Name Of Well-Known Account  . . . . . . . . . . .     "</span>);
06568         printf(<span class="stringliteral">"(Untested)\n"</span>);
06569 
06570     }
06571 
06572     <span class="keywordflow">return</span>(TestStatus);
06573 
06574 }
06575 
06576 
06578 <span class="comment">//                                                                           //</span>
06579 <span class="comment">// Alias  Object Test Suite                                                  //</span>
06580 <span class="comment">//                                                                           //</span>
06582 <span class="comment"></span>
06583 
06584 BOOLEAN
06585 AliasTestSuite(
06586     HANDLE DomainHandle,
06587     HANDLE BuiltinDomainHandle,
06588     PSID   DomainSid,
06589     ULONG  Pass
06590     )
06591 
06592 {
06593     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            NtStatus, IgnoreStatus;
06594     HANDLE              AdminAliasHandle, AliasHandle1, AliasHandle2, UserHandle1, UserHandle2, UserHandle3;
06595     ULONG               CountReturned, i, MemberCount;
06596     ULONG               UserRid, UserRid2, UserRid3, AliasRid, AliasRid2;
06597     PVOID               <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>, <a class="code" href="../../d9/d0/tfilmem_8c.html#a2">Buffer2</a>;
06598     ULONG               NameLength;
06599     SAM_ENUMERATE_HANDLE EnumerationContext;
06600     PULONG              Members;
06601     PSID                *AliasMembers;
06602     PSID_NAME_USE       LookedUpUses;
06603     PULONG              LookedUpRids;
06604     UNICODE_STRING      AccountNames[10], AccountName;
06605     STRING              AccountNameAnsi;
06606     PSID                UserSid1, UserSid2, GroupSid;
06607 
06608     BOOLEAN             IndividualTestSucceeded, DeleteUser;
06609     BOOLEAN             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06610 
06611 
06612     <span class="keywordflow">if</span> (Pass == 1) {
06613         <span class="comment">//</span>
06614         <span class="comment">// This test suite assumes that lookup and enumeration API funciton</span>
06615         <span class="comment">// properly.</span>
06616         <span class="comment">//</span>
06617 
06618         printf(<span class="stringliteral">"\n"</span>);
06619         printf(<span class="stringliteral">"\n"</span>);
06620         printf(<span class="stringliteral">"  Alias (Pass #1) . . . . . . . . . . . . . . . . . . .   Test\n"</span>);
06621 
06623         <span class="comment">//                                                                       //</span>
06624         <span class="comment">// Open Alias Suite                                                      //</span>
06625         <span class="comment">//                                                                       //</span>
06627 <span class="comment"></span>
06628         printf(<span class="stringliteral">"    Open Alias  . . . . . . . . . . . . . . . . . . . . .   Suite\n"</span>);
06629         printf(<span class="stringliteral">"      Open Aliases . . . . . . . . . . . . . . . . . . . . .     "</span>);
06630         IndividualTestSucceeded = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06631         EnumerationContext = 0;
06632         NtStatus = SamEnumerateAliasesInDomain(
06633                        DomainHandle,
06634                        &amp;EnumerationContext,
06635                        &amp;Buffer,
06636                        12000,                   <span class="comment">// PreferedMaximumLength</span>
06637                        &amp;CountReturned
06638                        );
06639 
06640         TST_SUCCESS_ASSERT(NtStatus);
06641         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Buffer != NULL);
06642         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(CountReturned &gt; 0);
06643 
06644         <span class="keywordflow">for</span> (i=0; i&lt;CountReturned; i++) {
06645 
06646             NtStatus = SamOpenAlias(
06647                            DomainHandle,
06648                            ALIAS_ALL_ACCESS,
06649                            ((PSAM_RID_ENUMERATION)(Buffer))[i].RelativeId,
06650                            &amp;AliasHandle1
06651                            );
06652 
06653             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
06654 
06655                 NtStatus = SamOpenAlias(
06656                                DomainHandle,
06657                                GENERIC_READ,
06658                                ((PSAM_RID_ENUMERATION)(Buffer))[i].RelativeId,
06659                                &amp;AliasHandle2
06660                                );
06661 
06662                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
06663                     IgnoreStatus = SamCloseHandle( AliasHandle2 );
06664                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
06665                 } <span class="keywordflow">else</span> {
06666                     printf(<span class="stringliteral">"Failed\n"</span>);
06667                     printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
06668                     printf(<span class="stringliteral">"        Failed opening alias second time.\n"</span>);
06669                     printf(<span class="stringliteral">"        Rid of account is:   0x%lx\n"</span>,
06670                         ((PSAM_RID_ENUMERATION)(Buffer))[i].RelativeId);
06671                     printf(<span class="stringliteral">"        Name of account is:  %wZ\n"</span>,
06672                         &amp;((PSAM_RID_ENUMERATION)(Buffer))[i].Name );
06673                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06674                     IndividualTestSucceeded = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06675                 }
06676 
06677                 IgnoreStatus = SamCloseHandle( AliasHandle1 );
06678                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
06679 
06680             } <span class="keywordflow">else</span> {
06681 
06682                 printf(<span class="stringliteral">"Failed\n"</span>);
06683                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
06684                 printf(<span class="stringliteral">"        Failed opening alias for first time.\n"</span>);
06685                 printf(<span class="stringliteral">"        Rid of account is:   0x%lx\n"</span>,
06686                     ((PSAM_RID_ENUMERATION)(Buffer))[i].RelativeId);
06687                 printf(<span class="stringliteral">"        Name of account is:  %wZ\n"</span>,
06688                     &amp;((PSAM_RID_ENUMERATION)(Buffer))[i].Name );
06689                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06690                 IndividualTestSucceeded = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06691             }
06692 
06693             <span class="keywordflow">if</span> (!IndividualTestSucceeded) {
06694                 printf(<span class="stringliteral">"                                                                "</span>);
06695             }
06696         }
06697 
06698 
06699         SamFreeMemory( Buffer );
06700         <span class="keywordflow">if</span> (IndividualTestSucceeded) {
06701             printf(<span class="stringliteral">"Succeeded\n"</span>);
06702         }
06703 
06704 
06705 
06707         <span class="comment">//                                                                       //</span>
06708         <span class="comment">// Query     Alias Suite                                                 //</span>
06709         <span class="comment">//                                                                       //</span>
06711 <span class="comment"></span>
06712 
06713         <span class="comment">//</span>
06714         <span class="comment">// Get the rid of an alias created earlier in the test</span>
06715         <span class="comment">//</span>
06716 
06717         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, ALIAS_NAME1 );
06718         NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountNames[0], &amp;AccountNameAnsi, TRUE );
06719         TST_SUCCESS_ASSERT(NtStatus);
06720 
06721         NtStatus = SamLookupNamesInDomain(
06722                        DomainHandle,
06723                        1,
06724                        &amp;AccountNames[0],
06725                        &amp;LookedUpRids,
06726                        &amp;LookedUpUses
06727                        );
06728         TST_SUCCESS_ASSERT(NtStatus);
06729         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(LookedUpUses[0] == SidTypeAlias);
06730         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountNames[0] );
06731 
06732         AliasRid = LookedUpRids[0];
06733 
06734         SamFreeMemory( LookedUpUses ); SamFreeMemory( LookedUpRids );
06735 
06736 
06737         printf(<span class="stringliteral">"\n"</span>);
06738         printf(<span class="stringliteral">"    Query Alias . . . . . . . . . . . . . . . . . . . . .   Suite\n"</span>);
06739 
06740         printf(<span class="stringliteral">"      Query Alias General Information . . . . . . . . . . .     "</span>);
06741 
06742 
06743         NtStatus = SamOpenAlias(
06744                        DomainHandle,
06745                        ALIAS_READ_INFORMATION,
06746                        AliasRid,
06747                        &amp;AliasHandle1
06748                        );
06749         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
06750 
06751         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06752         NtStatus = SamQueryInformationAlias(
06753                        AliasHandle1,
06754                        AliasGeneralInformation,
06755                        &amp;Buffer
06756                        );
06757         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
06758             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06759 
06760                 <span class="keywordflow">if</span> ( (((ALIAS_GENERAL_INFORMATION *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;Name.MaximumLength &gt; 0) &amp;&amp;
06761                      (((ALIAS_GENERAL_INFORMATION *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;Name.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)  ) {
06762 
06763                     printf(<span class="stringliteral">"Succeeded\n"</span>);
06764 
06765                     printf(<span class="stringliteral">"        Member Count is:  0x%lx\n"</span>,
06766                      (((ALIAS_GENERAL_INFORMATION *)Buffer)-&gt;MemberCount) );
06767                     printf(<span class="stringliteral">"        Alias Name is:    %wZ\n"</span>,
06768                      &amp;(((ALIAS_GENERAL_INFORMATION *)Buffer)-&gt;Name) );
06769 
06770                 } <span class="keywordflow">else</span> {
06771                     printf(<span class="stringliteral">"Failed\n"</span>);
06772                     printf(<span class="stringliteral">"        Alias Name not returned.\n"</span>);
06773                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06774                 }
06775                 SamFreeMemory( Buffer );
06776             } <span class="keywordflow">else</span> {
06777                 printf(<span class="stringliteral">"Failed\n"</span>);
06778                 printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
06779                 printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
06780                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06781             }
06782         } <span class="keywordflow">else</span> {
06783             printf(<span class="stringliteral">"Failed\n"</span>);
06784             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
06785             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06786         }
06787         IgnoreStatus = SamCloseHandle( AliasHandle1 );
06788         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
06789 
06790 
06791 
06792 
06793         printf(<span class="stringliteral">"      Query Alias Name Information  . . . . . . . . . . . .     "</span>);
06794 
06795 
06796         NtStatus = SamOpenAlias(
06797                        DomainHandle,
06798                        ALIAS_READ_INFORMATION,
06799                        AliasRid,
06800                        &amp;AliasHandle1
06801                        );
06802         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
06803 
06804         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06805         NtStatus = SamQueryInformationAlias(
06806                        AliasHandle1,
06807                        AliasNameInformation,
06808                        &amp;Buffer
06809                        );
06810         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
06811             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06812 
06813                 <span class="keywordflow">if</span> ( (((ALIAS_NAME_INFORMATION *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;Name.MaximumLength &gt; 0) &amp;&amp;
06814                      (((ALIAS_NAME_INFORMATION *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;Name.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)  ) {
06815 
06816                     printf(<span class="stringliteral">"Succeeded\n"</span>);
06817 
06818                     printf(<span class="stringliteral">"        Alias Name is:    %wZ\n"</span>,
06819                      &amp;(((ALIAS_NAME_INFORMATION *)Buffer)-&gt;Name) );
06820                 } <span class="keywordflow">else</span> {
06821                     printf(<span class="stringliteral">"Failed\n"</span>);
06822                     printf(<span class="stringliteral">"        Alias Name not returned.\n"</span>);
06823                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06824                 }
06825                 SamFreeMemory( Buffer );
06826             } <span class="keywordflow">else</span> {
06827                 printf(<span class="stringliteral">"Failed\n"</span>);
06828                 printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
06829                 printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
06830                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06831             }
06832         } <span class="keywordflow">else</span> {
06833             printf(<span class="stringliteral">"Failed\n"</span>);
06834             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
06835             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06836         }
06837         IgnoreStatus = SamCloseHandle( AliasHandle1 );
06838         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
06839 
06840 
06841 
06842 
06843         printf(<span class="stringliteral">"      Query Alias Admin Comment Information . . . . . . . .     "</span>);
06844 
06845 
06846         NtStatus = SamOpenAlias(
06847                        DomainHandle,
06848                        ALIAS_READ_INFORMATION,
06849                        AliasRid,
06850                        &amp;AliasHandle1
06851                        );
06852         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
06853 
06854         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06855         NtStatus = SamQueryInformationAlias(
06856                        AliasHandle1,
06857                        AliasAdminCommentInformation,
06858                        &amp;Buffer
06859                        );
06860         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
06861             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06862 
06863                 <span class="keywordflow">if</span> ( (((ALIAS_ADM_COMMENT_INFORMATION *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;AdminComment.MaximumLength &gt;= 0) ) {
06864 
06865                     printf(<span class="stringliteral">"Succeeded\n"</span>);
06866 
06867                     printf(<span class="stringliteral">"        Alias Admin Comment is:    %wZ\n"</span>,
06868                      &amp;(((ALIAS_ADM_COMMENT_INFORMATION *)Buffer)-&gt;AdminComment) );
06869                 } <span class="keywordflow">else</span> {
06870                     printf(<span class="stringliteral">"Failed\n"</span>);
06871                     printf(<span class="stringliteral">"        Alias Admin Comment not returned.\n"</span>);
06872                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06873                 }
06874                 SamFreeMemory( Buffer );
06875             } <span class="keywordflow">else</span> {
06876                 printf(<span class="stringliteral">"Failed\n"</span>);
06877                 printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
06878                 printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
06879                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06880             }
06881         } <span class="keywordflow">else</span> {
06882             printf(<span class="stringliteral">"Failed\n"</span>);
06883             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
06884             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06885         }
06886         IgnoreStatus = SamCloseHandle( AliasHandle1 );
06887         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
06888 
06889 
06890 
06891 
06892 
06894         <span class="comment">//                                                                       //</span>
06895         <span class="comment">// Get Members Of Alias Suite                                            //</span>
06896         <span class="comment">//                                                                       //</span>
06898 <span class="comment"></span>
06899         printf(<span class="stringliteral">"\n"</span>);
06900         printf(<span class="stringliteral">"    Get Members . . . . . . . . . . . . . . . . . . . . .   Suite\n"</span>);
06901 
06902 <span class="preprocessor">#ifdef LATER // ALIAS_LATER - well-know aliases ?</span>
06903 <span class="preprocessor"></span>
06904 
06905         davidc/chads - <span class="keyword">this</span> needs to access <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> builtin domain.
06906 
06907         printf(<span class="stringliteral">"      Get Members of Well-Known Account . . . . . . . . . .     "</span>);
06908 
06909         NtStatus = SamOpenAlias(
06910                        DomainHandle,
06911                        ALIAS_LIST_MEMBERS,
06912                        DOMAIN_ALIAS_RID_ADMINS,
06913                        &amp;AliasHandle1
06914                        );
06915         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
06916 
06917         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06918         NtStatus = SamGetMembersInAlias(
06919                        AliasHandle1,
06920                        &amp;AliasMembers,
06921                        &amp;Attributes,
06922                        &amp;MemberCount
06923                        );
06924         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
06925             <span class="keywordflow">if</span> (Members != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || Attributes != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06926 
06927                 printf(<span class="stringliteral">"Succeeded\n"</span>);
06928 
06929 
06930                 printf(<span class="stringliteral">"       Member Count:    %d Users\n"</span>, MemberCount);
06931                 <span class="keywordflow">for</span> ( i=0; i&lt;MemberCount; i++) {
06932 
06933                     <span class="comment">// printf("       User[%d] Sid:      0x%lx\n",</span>
06934                     <span class="comment">//    i, Members[i]);</span>
06935 
06936 
06937                 }
06938 
06939                 SamFreeMemory( AliasMembers );
06940                 SamFreeMemory( Attributes );
06941 
06942 
06943             } <span class="keywordflow">else</span> {
06944                 printf(<span class="stringliteral">"Failed\n"</span>);
06945                 printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
06946                 printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
06947                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06948             }
06949         } <span class="keywordflow">else</span> {
06950             printf(<span class="stringliteral">"Failed\n"</span>);
06951             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
06952             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06953         }
06954         IgnoreStatus = SamCloseHandle( AliasHandle1 );
06955         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
06956 <span class="preprocessor">#endif</span>
06957 <span class="preprocessor"></span>
06958 
06959         printf(<span class="stringliteral">"      Get Members of Empty Alias. . . . . . . . . . . . . .     "</span>);
06960 
06961         <span class="comment">//</span>
06962         <span class="comment">// This alias was created earlier in the test</span>
06963         <span class="comment">//</span>
06964 
06965         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, ALIAS_NAME1 );
06966         NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountNames[0], &amp;AccountNameAnsi, TRUE );
06967         TST_SUCCESS_ASSERT(NtStatus);
06968 
06969         NtStatus = SamLookupNamesInDomain(
06970                        DomainHandle,
06971                        1,
06972                        &amp;AccountNames[0],
06973                        &amp;LookedUpRids,
06974                        &amp;LookedUpUses
06975                        );
06976         TST_SUCCESS_ASSERT(NtStatus);
06977         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(LookedUpUses[0] == SidTypeAlias);
06978         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountNames[0] );
06979 
06980 
06981 
06982         AliasHandle1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06983 
06984         NtStatus = SamOpenAlias( DomainHandle, ALIAS_LIST_MEMBERS, LookedUpRids[0], &amp;AliasHandle1 );
06985         TST_SUCCESS_ASSERT(NtStatus);
06986         SamFreeMemory( LookedUpUses ); SamFreeMemory( LookedUpRids );
06987 
06988         NtStatus = SamGetMembersInAlias(
06989                        AliasHandle1,
06990                        &amp;AliasMembers,
06991                        &amp;MemberCount
06992                        );
06993         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
06994             <span class="keywordflow">if</span> (MemberCount == 0) {
06995 
06996                 printf(<span class="stringliteral">"Succeeded\n"</span>);
06997 
06998 
06999 
07000 
07001             } <span class="keywordflow">else</span> {
07002                 printf(<span class="stringliteral">"Failed\n"</span>);
07003                 printf(<span class="stringliteral">"       Member Count &gt; 0 :    %d\n"</span>, MemberCount);
07004                 <span class="keywordflow">for</span> ( i=0; i&lt;MemberCount; i++) {
07005 
07006                     <span class="comment">// printf("       User[%d] Rid/Attributes:      0x%lx/0x%lx\n",</span>
07007                     <span class="comment">//    i, Members[i], Attributes[i]);</span>
07008                 }
07009 
07010                 SamFreeMemory( AliasMembers );
07011                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07012             }
07013         } <span class="keywordflow">else</span> {
07014             printf(<span class="stringliteral">"Failed\n"</span>);
07015             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
07016             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07017         }
07018         IgnoreStatus = SamCloseHandle( AliasHandle1 );
07019         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
07020 
07021 
07022 
07024         <span class="comment">//                                                                       //</span>
07025         <span class="comment">// Set Alias Suite  (pass 1)                                             //</span>
07026         <span class="comment">//                                                                       //</span>
07028 <span class="comment"></span>
07029         printf(<span class="stringliteral">"\n"</span>);
07030         printf(<span class="stringliteral">"    Set Alias . . . . . . . . . . . . . . . . . . . . . .   Suite\n"</span>);
07031         <span class="comment">//</span>
07032 
07033 
07034         <span class="comment">// Get the rid of an alias created earlier in the test</span>
07035         <span class="comment">//</span>
07036 
07037         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, ALIAS_NAME1 );
07038         NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountNames[0], &amp;AccountNameAnsi, TRUE );
07039         TST_SUCCESS_ASSERT(NtStatus);
07040 
07041         NtStatus = SamLookupNamesInDomain(
07042                        DomainHandle,
07043                        1,
07044                        &amp;AccountNames[0],
07045                        &amp;LookedUpRids,
07046                        &amp;LookedUpUses
07047                        );
07048         TST_SUCCESS_ASSERT(NtStatus);
07049         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(LookedUpUses[0] == SidTypeAlias);
07050         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountNames[0] );
07051 
07052         AliasRid = LookedUpRids[0];
07053 
07054         SamFreeMemory( LookedUpUses ); SamFreeMemory( LookedUpRids );
07055 
07056 
07057 
07058         printf(<span class="stringliteral">"      Set Admin Comment . . . . . . . . . . . . . . . . . .     "</span>);
07059 
07060         NtStatus = SamOpenAlias(
07061                        DomainHandle,
07062                        ALIAS_WRITE_ACCOUNT | ALIAS_READ_INFORMATION,
07063                        AliasRid,
07064                        &amp;AliasHandle1
07065                        );
07066         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
07067 
07068         <span class="comment">//</span>
07069         <span class="comment">// Get the current value...</span>
07070         <span class="comment">//</span>
07071 
07072         <a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07073         NtStatus = SamQueryInformationAlias(
07074                        AliasHandle1,
07075                        AliasAdminCommentInformation,
07076                        &amp;Buffer1
07077                        );
07078         TST_SUCCESS_ASSERT(NtStatus);
07079         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Buffer1 != NULL);
07080 
07081 
07082         <span class="comment">//</span>
07083         <span class="comment">// Change the field to a new value and write it out.</span>
07084         <span class="comment">//</span>
07085 
07086         NameLength = ((ALIAS_ADM_COMMENT_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;AdminComment.Length;
07087         <span class="keywordflow">if</span> (  NameLength == DummyString1.Length ) {
07088             ((ALIAS_ADM_COMMENT_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;AdminComment = DummyString2;
07089         } <span class="keywordflow">else</span> {
07090             ((ALIAS_ADM_COMMENT_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;AdminComment = DummyString1;
07091         }
07092 
07093         NtStatus = SamSetInformationAlias(
07094                        AliasHandle1,
07095                        AliasAdminCommentInformation,
07096                        Buffer1
07097                        );
07098         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) ) {
07099 
07100             <span class="comment">//</span>
07101             <span class="comment">// Now check that the change was really made...</span>
07102             <span class="comment">//</span>
07103 
07104             <a class="code" href="../../d9/d0/tfilmem_8c.html#a2">Buffer2</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07105             NtStatus = SamQueryInformationAlias(
07106                            AliasHandle1,
07107                            AliasAdminCommentInformation,
07108                            &amp;Buffer2
07109                            );
07110             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( NtStatus ) );
07111             <span class="keywordflow">if</span> (
07112                 !<a class="code" href="../../d2/d7/string_8c.html#a10">RtlCompareString</a>(
07113                     (PSTRING)&amp;((ALIAS_ADM_COMMENT_INFORMATION *)Buffer1)-&gt;AdminComment,
07114                     (PSTRING)&amp;((ALIAS_ADM_COMMENT_INFORMATION *)Buffer2)-&gt;AdminComment,
07115                     TRUE)
07116                 ) {
07117 
07118                 printf(<span class="stringliteral">"Succeeded\n"</span>);
07119 
07120             } <span class="keywordflow">else</span> {
07121 
07122                 printf(<span class="stringliteral">"Failed\n"</span>);
07123                 printf(<span class="stringliteral">"        Value queried doesn't match value written\n"</span>);
07124                 printf(<span class="stringliteral">"        Value Written is   %wZ\n"</span>,
07125                     (PUNICODE_STRING)&amp;((ALIAS_ADM_COMMENT_INFORMATION *)Buffer1)-&gt;AdminComment);
07126                 printf(<span class="stringliteral">"        Value Retrieved is %wZ\n"</span>,
07127                     (PUNICODE_STRING)&amp;((ALIAS_ADM_COMMENT_INFORMATION *)Buffer2)-&gt;AdminComment);
07128 
07129                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07130 
07131             }
07132 
07133             SamFreeMemory( Buffer1 );
07134             SamFreeMemory( Buffer2 );
07135 
07136         } <span class="keywordflow">else</span> {
07137             printf(<span class="stringliteral">"Failed\n"</span>);
07138             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
07139             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07140             SamFreeMemory( Buffer1 );
07141 
07142         }
07143 
07144 
07145 
07146 
07147 
07148     } <span class="comment">// END PASS #1</span>
07149     <span class="keywordflow">if</span> (Pass == 2) {
07150 
07151         printf(<span class="stringliteral">"\n"</span>);
07152         printf(<span class="stringliteral">"\n"</span>);
07153         printf(<span class="stringliteral">"  Alias (Pass #2) . . . . . . . . . . . . . . . . . . .   Test\n"</span>);
07154 
07156         <span class="comment">//                                                                       //</span>
07157         <span class="comment">// Delete Alias Suite                                                    //</span>
07158         <span class="comment">//                                                                       //</span>
07160 <span class="comment"></span>
07161         printf(<span class="stringliteral">"\n"</span>);
07162         printf(<span class="stringliteral">"    Delete Alias  . . . . . . . . . . . . . . . . . . . .   Suite\n"</span>);
07163 
07164         printf(<span class="stringliteral">"      Delete Normal Alias . . . . . . . . . . . . . . . . .     "</span>);
07165 
07166         <span class="comment">//</span>
07167         <span class="comment">// This alias was created in pass #1</span>
07168         <span class="comment">//</span>
07169 
07170         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, ALIAS_NAME1 );
07171         NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountNames[0], &amp;AccountNameAnsi, TRUE );
07172         TST_SUCCESS_ASSERT(NtStatus);
07173 
07174         NtStatus = SamLookupNamesInDomain(
07175                        DomainHandle,
07176                        1,
07177                        &amp;AccountNames[0],
07178                        &amp;LookedUpRids,
07179                        &amp;LookedUpUses
07180                        );
07181         TST_SUCCESS_ASSERT(NtStatus);
07182         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(LookedUpUses[0] == SidTypeAlias);
07183         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountNames[0] );
07184 
07185 
07186 
07187         AliasHandle1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07188 
07189         NtStatus = SamOpenAlias( DomainHandle, DELETE, LookedUpRids[0], &amp;AliasHandle1 );
07190         TST_SUCCESS_ASSERT(NtStatus);
07191         SamFreeMemory( LookedUpUses ); SamFreeMemory( LookedUpRids );
07192 
07193         NtStatus = SamDeleteAlias( AliasHandle1 );
07194         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
07195             printf(<span class="stringliteral">"Succeeded\n"</span>);
07196 
07197         } <span class="keywordflow">else</span> {
07198             printf(<span class="stringliteral">"Failed\n"</span>);
07199             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
07200             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07201         }
07202 
07203 
07204 <span class="preprocessor">#ifdef LATER // ALIAS_LATER - well know aliases ?</span>
07205 <span class="preprocessor"></span>
07206 
07207         printf(<span class="stringliteral">"      Delete Well Known Alias . . . . . . . . . . . . . . .     "</span>);
07208 
07209         AliasHandle1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07210 
07211         NtStatus = SamOpenAlias( DomainHandle, DELETE, DOMAIN_GROUP_RID_USERS, &amp;AliasHandle1 );
07212         TST_SUCCESS_ASSERT(NtStatus);
07213 
07214         NtStatus = SamDeleteAlias( AliasHandle1 );
07215         <span class="keywordflow">if</span> (NtStatus == STATUS_SPECIAL_ACCOUNT) {
07216 
07217             printf(<span class="stringliteral">"Succeeded\n"</span>);
07218 
07219         } <span class="keywordflow">else</span> {
07220             printf(<span class="stringliteral">"Failed\n"</span>);
07221             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
07222             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07223         }
07224 
07225         NtStatus = SamCloseHandle( AliasHandle1 );
07226         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
07227 
07228 
07229 
07230 
07231         printf(<span class="stringliteral">"      Delete Admin Alias. . . . . . . . . . . . . . . . . .     "</span>);
07232         AliasHandle1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07233 
07234         NtStatus = SamOpenAlias( DomainHandle, DELETE, DOMAIN_ALIAS_RID_ADMINS, &amp;AliasHandle1 );
07235         TST_SUCCESS_ASSERT(NtStatus);
07236 
07237         NtStatus = SamDeleteAlias( AliasHandle1 );
07238         <span class="keywordflow">if</span> (NtStatus == STATUS_SPECIAL_ACCOUNT) {
07239 
07240             printf(<span class="stringliteral">"Succeeded\n"</span>);
07241 
07242         } <span class="keywordflow">else</span> {
07243             printf(<span class="stringliteral">"Failed\n"</span>);
07244             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
07245             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07246         }
07247 
07248         NtStatus = SamCloseHandle( AliasHandle1 );
07249         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
07250 
07251 
07252 <span class="preprocessor">#endif</span>
07253 <span class="preprocessor"></span>
07254 
07255 
07257         <span class="comment">//                                                                       //</span>
07258         <span class="comment">// Add/Remove Member Suite                                               //</span>
07259         <span class="comment">//                                                                       //</span>
07261 <span class="comment"></span>
07262         printf(<span class="stringliteral">"\n"</span>);
07263         printf(<span class="stringliteral">"    Add/Remove Member Suite . . . . . . . . . . . . . . .   Suite\n"</span>);
07264 
07265         printf(<span class="stringliteral">"      Add Member  . . . . . . . . . . . . . . . . . . . . .     "</span>);
07266 
07267         <span class="comment">//</span>
07268         <span class="comment">// This test sets things up for the next test</span>
07269         <span class="comment">//</span>
07270 
07271         <span class="comment">//</span>
07272         <span class="comment">// The following user might already exist (from earlier in the test)</span>
07273         <span class="comment">//</span>
07274 
07275         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, USER_NAME1 );
07276         NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountName, &amp;AccountNameAnsi, TRUE );
07277         TST_SUCCESS_ASSERT(NtStatus);
07278 
07279         UserRid = 0;
07280         UserHandle1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07281         NtStatus = SamCreateUserInDomain(
07282                        DomainHandle,
07283                        &amp;AccountName,
07284                        USER_ALL_ACCESS,
07285                        &amp;UserHandle1,
07286                        &amp;UserRid
07287                        );
07288         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountName );
07289         DeleteUser = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
07290         <span class="keywordflow">if</span> (NtStatus == STATUS_USER_EXISTS) {
07291             DeleteUser = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07292             <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, USER_NAME1 );
07293             NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountNames[0], &amp;AccountNameAnsi, TRUE );
07294             TST_SUCCESS_ASSERT(NtStatus);
07295 
07296             NtStatus = SamLookupNamesInDomain(
07297                            DomainHandle,
07298                            1,
07299                            &amp;AccountNames[0],
07300                            &amp;LookedUpRids,
07301                            &amp;LookedUpUses
07302                            );
07303             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountNames[0] );
07304             TST_SUCCESS_ASSERT(NtStatus);
07305             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(LookedUpUses[0] == SidTypeUser);
07306             UserRid = LookedUpRids[0];
07307             NtStatus = SamOpenUser(
07308                            DomainHandle,
07309                            USER_ALL_ACCESS,
07310                            UserRid,
07311                            &amp;UserHandle1);
07312             SamFreeMemory( LookedUpUses ); SamFreeMemory( LookedUpRids );
07313         }
07314 
07315         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
07316 
07317         <span class="comment">//</span>
07318         <span class="comment">// This account won't exist yet</span>
07319         <span class="comment">//</span>
07320 
07321         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, USER_NAME2 );
07322         NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountName, &amp;AccountNameAnsi, TRUE );
07323         TST_SUCCESS_ASSERT(NtStatus);
07324 
07325         UserRid2 = 0;
07326         UserHandle2 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07327         NtStatus = SamCreateUserInDomain(
07328                        DomainHandle,
07329                        &amp;AccountName,
07330                        USER_ALL_ACCESS,
07331                        &amp;UserHandle2,
07332                        &amp;UserRid2
07333                        );
07334         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountName );
07335 
07336         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
07337 
07338 
07339         <span class="comment">//</span>
07340         <span class="comment">// create the alias</span>
07341         <span class="comment">//</span>
07342 
07343         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, ALIAS_NAME1 );
07344         NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountName, &amp;AccountNameAnsi, TRUE );
07345         TST_SUCCESS_ASSERT(NtStatus);
07346 
07347         AliasRid = 0;
07348         AliasHandle1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07349         NtStatus = SamCreateAliasInDomain(
07350                        DomainHandle,
07351                        &amp;AccountName,
07352                        ALIAS_ALL_ACCESS,
07353                        &amp;AliasHandle1,
07354                        &amp;AliasRid
07355                        );
07356         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountName );
07357         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
07358 
07359         <span class="comment">//</span>
07360         <span class="comment">// Make user1 a member of this alias</span>
07361         <span class="comment">//</span>
07362 
07363         UserSid1 = CreateUserSid(DomainSid, UserRid);
07364         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(UserSid1 != NULL);
07365 
07366         UserSid2 = CreateUserSid(DomainSid, UserRid2);
07367         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(UserSid2 != NULL);
07368 
07369 
07370 
07371         NtStatus = SamAddMemberToAlias(
07372                        AliasHandle1,
07373                        UserSid1
07374                        );
07375 
07376         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
07377 
07378             NtStatus = SamGetMembersInAlias(
07379                            AliasHandle1,
07380                            &amp;AliasMembers,
07381                            &amp;MemberCount
07382                            );
07383             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
07384 
07385             NtStatus = STATUS_MEMBER_NOT_IN_ALIAS;
07386             <span class="keywordflow">for</span> ( i=0; i&lt;MemberCount; i++) {
07387                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(AliasMembers[i], UserSid1)) {
07388                     NtStatus = STATUS_SUCCESS;
07389                     <span class="keywordflow">break</span>;
07390                 }
07391             }
07392 
07393             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
07394                 printf(<span class="stringliteral">"Failed\n"</span>);
07395                 printf(<span class="stringliteral">"Service returned SUCCESS, but user not in member list for alias.\n"</span>);
07396                 printf(<span class="stringliteral">"Member list :\n"</span>);
07397                 <span class="keywordflow">for</span> (i=0; i&lt;MemberCount; i++) {
07398                     printfSid(AliasMembers[i]);
07399                     printf(<span class="stringliteral">"\n"</span>);
07400                 }
07401                 DebugBreak();
07402                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07403             }
07404 
07405 
07406             <span class="keywordflow">if</span> (AliasMembers != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07407                 SamFreeMemory( AliasMembers );
07408             }
07409 
07410 
07411             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
07412 
07413                 NtStatus = SamGetAliasMembership(
07414                                DomainHandle,
07415                                1,
07416                                &amp;UserSid1,
07417                                &amp;MemberCount,
07418                                &amp;Members
07419                                );
07420                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
07421 
07422                 NtStatus = STATUS_MEMBER_NOT_IN_ALIAS;
07423                 <span class="keywordflow">for</span> ( i=0; i&lt;MemberCount; i++) {
07424                     <span class="keywordflow">if</span> (Members[i] == AliasRid) {
07425                         NtStatus = STATUS_SUCCESS;
07426                         <span class="keywordflow">break</span>;
07427                     }
07428                 }
07429 
07430                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
07431                     printf(<span class="stringliteral">"Failed\n"</span>);
07432                     printf(<span class="stringliteral">"Service returned SUCCESS, but alias not in account alias membership list.\n"</span>);
07433                     printf(<span class="stringliteral">"Alias Membership :\n"</span>);
07434                     <span class="keywordflow">for</span> (i=0; i&lt;MemberCount; i++) {
07435                         printf(<span class="stringliteral">"0x%lx\n"</span>, Members[i]);
07436                     }
07437                     DebugBreak();
07438                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07439                 }
07440 
07441                 <span class="keywordflow">if</span> (Members != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07442                     SamFreeMemory( Members );
07443                 }
07444 
07445 
07446                 <span class="comment">//</span>
07447                 <span class="comment">// Check for correct alias membership for multiple accounts</span>
07448                 <span class="comment">// User1 should be in alias1</span>
07449                 <span class="comment">// User2 should be no aliases.</span>
07450                 <span class="comment">//</span>
07451 
07452                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
07453 
07454                     PSID    SidArray[2];
07455                     SidArray[0] = UserSid1;
07456                     SidArray[1] = UserSid2;
07457 
07458                     NtStatus = SamGetAliasMembership(
07459                                    DomainHandle,
07460                                    2,
07461                                    SidArray,
07462                                    &amp;MemberCount,
07463                                    &amp;Members
07464                                    );
07465                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
07466 
07467                     <span class="keywordflow">if</span> (MemberCount != 1) {
07468 
07469                         printf(<span class="stringliteral">"Failed\n"</span>);
07470                         printf(<span class="stringliteral">"Service returned SUCCESS, but combined alias membership count for 2 accounts not correct.\n"</span>);
07471                         printf(<span class="stringliteral">"Combined Alias Membership :\n"</span>);
07472                         <span class="keywordflow">for</span> (i=0; i&lt;MemberCount; i++) {
07473                             printf(<span class="stringliteral">"0x%lx\n"</span>, Members[i]);
07474                         }
07475                         DebugBreak();
07476                         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07477 
07478                     } <span class="keywordflow">else</span> {
07479 
07480                         <span class="keywordflow">if</span> (Members[0] != AliasRid) {
07481                             printf(<span class="stringliteral">"Failed\n"</span>);
07482                             printf(<span class="stringliteral">"Service returned SUCCESS, but combined alias membership for 2 accounts not correct.\n"</span>);
07483                             printf(<span class="stringliteral">"Combined Alias Membership :\n"</span>);
07484                             <span class="keywordflow">for</span> (i=0; i&lt;MemberCount; i++) {
07485                                 printf(<span class="stringliteral">"0x%lx\n"</span>, Members[i]);
07486                             }
07487                             DebugBreak();
07488                             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07489 
07490                         } <span class="keywordflow">else</span> {
07491                             printf(<span class="stringliteral">"Succeeded\n"</span>);
07492                         }
07493                     }
07494 
07495                     <span class="keywordflow">if</span> (Members != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07496                         SamFreeMemory( Members );
07497                     }
07498                 }
07499             }
07500 
07501 
07502         } <span class="keywordflow">else</span> {
07503             printf(<span class="stringliteral">"Failed\n"</span>);
07504             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
07505             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07506         }
07507 
07508 
07509 
07510 
07511 
07512 
07513 
07514         printf(<span class="stringliteral">"      Add another member to another alias . . . . . . . . .     "</span>);
07515 
07516 
07517 
07518 
07519 
07520 
07521         <span class="comment">//</span>
07522         <span class="comment">// Make user2 a member of alias2</span>
07523         <span class="comment">//</span>
07524 
07525         <span class="comment">//</span>
07526         <span class="comment">// This alias was created in pass #1</span>
07527         <span class="comment">//</span>
07528 
07529         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, ALIAS_NAME2 );
07530         NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountNames[0], &amp;AccountNameAnsi, TRUE );
07531         TST_SUCCESS_ASSERT(NtStatus);
07532 
07533         NtStatus = SamLookupNamesInDomain(
07534                        DomainHandle,
07535                        1,
07536                        &amp;AccountNames[0],
07537                        &amp;LookedUpRids,
07538                        &amp;LookedUpUses
07539                        );
07540         TST_SUCCESS_ASSERT(NtStatus);
07541         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(LookedUpUses[0] == SidTypeAlias);
07542         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountNames[0] );
07543 
07544         AliasHandle2 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07545         AliasRid2 = LookedUpRids[0];
07546 
07547         NtStatus = SamOpenAlias( DomainHandle, ALIAS_ALL_ACCESS, LookedUpRids[0], &amp;AliasHandle2 );
07548         TST_SUCCESS_ASSERT(NtStatus);
07549         SamFreeMemory( LookedUpUses ); SamFreeMemory( LookedUpRids );
07550 
07551 
07552         NtStatus = SamAddMemberToAlias(
07553                        AliasHandle2,
07554                        UserSid2
07555                        );
07556 
07557         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
07558 
07559             NtStatus = SamGetMembersInAlias(
07560                            AliasHandle2,
07561                            &amp;AliasMembers,
07562                            &amp;MemberCount
07563                            );
07564             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
07565 
07566             NtStatus = STATUS_MEMBER_NOT_IN_ALIAS;
07567             <span class="keywordflow">for</span> ( i=0; i&lt;MemberCount; i++) {
07568                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(AliasMembers[i], UserSid2)) {
07569                     NtStatus = STATUS_SUCCESS;
07570                     <span class="keywordflow">break</span>;
07571                 }
07572             }
07573 
07574             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
07575                 printf(<span class="stringliteral">"Failed\n"</span>);
07576                 printf(<span class="stringliteral">"Service returned SUCCESS, but user not in member list for alias.\n"</span>);
07577                 printf(<span class="stringliteral">"Member list :\n"</span>);
07578                 <span class="keywordflow">for</span> (i=0; i&lt;MemberCount; i++) {
07579                     printfSid(AliasMembers[i]);
07580                     printf(<span class="stringliteral">"\n"</span>);
07581                 }
07582                 DebugBreak();
07583                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07584             }
07585 
07586 
07587             <span class="keywordflow">if</span> (AliasMembers != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07588                 SamFreeMemory( AliasMembers );
07589             }
07590 
07591 
07592             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
07593 
07594                 NtStatus = SamGetAliasMembership(
07595                                DomainHandle,
07596                                1,
07597                                &amp;UserSid2,
07598                                &amp;MemberCount,
07599                                &amp;Members
07600                                );
07601                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
07602 
07603                 NtStatus = STATUS_MEMBER_NOT_IN_ALIAS;
07604                 <span class="keywordflow">for</span> ( i=0; i&lt;MemberCount; i++) {
07605                     <span class="keywordflow">if</span> (Members[i] == AliasRid2) {
07606                         NtStatus = STATUS_SUCCESS;
07607                         <span class="keywordflow">break</span>;
07608                     }
07609                 }
07610 
07611                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
07612                     printf(<span class="stringliteral">"Failed\n"</span>);
07613                     printf(<span class="stringliteral">"Service returned SUCCESS, but alias not in account alias membership list.\n"</span>);
07614                     printf(<span class="stringliteral">"Alias Membership :\n"</span>);
07615                     <span class="keywordflow">for</span> (i=0; i&lt;MemberCount; i++) {
07616                         printf(<span class="stringliteral">"0x%lx\n"</span>, Members[i]);
07617                     }
07618                     DebugBreak();
07619                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07620                 }
07621 
07622                 <span class="keywordflow">if</span> (Members != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07623                     SamFreeMemory( Members );
07624                 }
07625 
07626                 <span class="comment">//</span>
07627                 <span class="comment">// Check for correct alias membership for multiple accounts</span>
07628                 <span class="comment">// User1 should be in alias1</span>
07629                 <span class="comment">// User2 should be in alias2.</span>
07630                 <span class="comment">//</span>
07631 
07632                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
07633 
07634                     PSID    SidArray[2];
07635                     SidArray[0] = UserSid1;
07636                     SidArray[1] = UserSid2;
07637 
07638                     NtStatus = SamGetAliasMembership(
07639                                    DomainHandle,
07640                                    2,
07641                                    SidArray,
07642                                    &amp;MemberCount,
07643                                    &amp;Members
07644                                    );
07645                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
07646 
07647                     <span class="keywordflow">if</span> (MemberCount != 2) {
07648 
07649                         printf(<span class="stringliteral">"Failed\n"</span>);
07650                         printf(<span class="stringliteral">"Service returned SUCCESS, but combined alias membership count for 2 accounts not correct.\n"</span>);
07651                         printf(<span class="stringliteral">"Combined Alias Membership :\n"</span>);
07652                         <span class="keywordflow">for</span> (i=0; i&lt;MemberCount; i++) {
07653                             printf(<span class="stringliteral">"0x%lx\n"</span>, Members[i]);
07654                         }
07655                         DebugBreak();
07656                         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07657 
07658                     } <span class="keywordflow">else</span> {
07659 
07660                         <span class="keywordflow">if</span> (((Members[0] == AliasRid) &amp;&amp; (Members[1] == AliasRid2)) ||
07661                             ((Members[0] == AliasRid2) &amp;&amp; (Members[1] == AliasRid)) ) {
07662                             printf(<span class="stringliteral">"Succeeded\n"</span>);
07663                         } <span class="keywordflow">else</span> {
07664                             printf(<span class="stringliteral">"Failed\n"</span>);
07665                             printf(<span class="stringliteral">"Service returned SUCCESS, but combined alias membership for 2 accounts not correct.\n"</span>);
07666                             printf(<span class="stringliteral">"Combined Alias Membership :\n"</span>);
07667                             <span class="keywordflow">for</span> (i=0; i&lt;MemberCount; i++) {
07668                                 printf(<span class="stringliteral">"0x%lx\n"</span>, Members[i]);
07669                             }
07670                             DebugBreak();
07671                             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07672                         }
07673                     }
07674 
07675                     <span class="keywordflow">if</span> (Members != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07676                         SamFreeMemory( Members );
07677                     }
07678                 }
07679             }
07680 
07681 
07682         } <span class="keywordflow">else</span> {
07683             printf(<span class="stringliteral">"Failed\n"</span>);
07684             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
07685             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07686         }
07687 
07688 
07689         <span class="comment">//</span>
07690         <span class="comment">// Remove user2 from alias2 again</span>
07691         <span class="comment">//</span>
07692 
07693         NtStatus = SamRemoveMemberFromAlias(
07694                        AliasHandle2,
07695                        UserSid2
07696                        );
07697 
07698         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
07699 
07700             NtStatus = SamGetMembersInAlias(
07701                            AliasHandle2,
07702                            &amp;AliasMembers,
07703                            &amp;MemberCount
07704                            );
07705             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
07706 
07707             NtStatus = STATUS_MEMBER_NOT_IN_ALIAS;
07708             <span class="keywordflow">for</span> ( i=0; i&lt;MemberCount; i++) {
07709                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(AliasMembers[i], UserSid2)) {
07710                     NtStatus = STATUS_SUCCESS;
07711                     <span class="keywordflow">break</span>;
07712                 }
07713             }
07714 
07715             <span class="keywordflow">if</span> (NtStatus != STATUS_MEMBER_NOT_IN_ALIAS) {
07716                 printf(<span class="stringliteral">"Failed\n"</span>);
07717                 printf(<span class="stringliteral">"Service returned SUCCESS, but user still in member list for alias.\n"</span>);
07718                 printf(<span class="stringliteral">"Member list :\n"</span>);
07719                 <span class="keywordflow">for</span> (i=0; i&lt;MemberCount; i++) {
07720                     printfSid(AliasMembers[i]);
07721                     printf(<span class="stringliteral">"\n"</span>);
07722                 }
07723                 DebugBreak();
07724                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07725             }
07726 
07727 
07728             <span class="keywordflow">if</span> (AliasMembers != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07729                 SamFreeMemory( AliasMembers );
07730             }
07731 
07732 
07733             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
07734 
07735                 NtStatus = SamGetAliasMembership(
07736                                DomainHandle,
07737                                1,
07738                                &amp;UserSid2,
07739                                &amp;MemberCount,
07740                                &amp;Members
07741                                );
07742                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
07743 
07744                 <span class="keywordflow">for</span> ( i=0; i&lt;MemberCount; i++) {
07745                     <span class="keywordflow">if</span> (Members[i] == AliasRid2) {
07746                         NtStatus = STATUS_MEMBER_IN_ALIAS;
07747                         <span class="keywordflow">break</span>;
07748                     }
07749                 }
07750 
07751                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
07752                     printf(<span class="stringliteral">"Failed\n"</span>);
07753                     printf(<span class="stringliteral">"Service returned SUCCESS, but alias still in account alias membership list.\n"</span>);
07754                     printf(<span class="stringliteral">"Alias Membership :\n"</span>);
07755                     <span class="keywordflow">for</span> (i=0; i&lt;MemberCount; i++) {
07756                         printf(<span class="stringliteral">"0x%lx\n"</span>, Members[i]);
07757                     }
07758                     DebugBreak();
07759                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07760                 }
07761 
07762                 <span class="keywordflow">if</span> (Members != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07763                     SamFreeMemory( Members );
07764                 }
07765 
07766                 <span class="comment">//</span>
07767                 <span class="comment">// Check for correct alias membership for multiple accounts</span>
07768                 <span class="comment">// User1 should be in alias1</span>
07769                 <span class="comment">// User2 should be in no aliases.</span>
07770                 <span class="comment">//</span>
07771 
07772                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
07773 
07774                     PSID    SidArray[2];
07775                     SidArray[0] = UserSid1;
07776                     SidArray[1] = UserSid2;
07777 
07778                     NtStatus = SamGetAliasMembership(
07779                                    DomainHandle,
07780                                    2,
07781                                    SidArray,
07782                                    &amp;MemberCount,
07783                                    &amp;Members
07784                                    );
07785                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
07786 
07787                     <span class="keywordflow">if</span> (MemberCount != 1) {
07788 
07789                         printf(<span class="stringliteral">"Failed\n"</span>);
07790                         printf(<span class="stringliteral">"Service returned SUCCESS, but combined alias membership count for 2 accounts not correct.\n"</span>);
07791                         printf(<span class="stringliteral">"Combined Alias Membership :\n"</span>);
07792                         <span class="keywordflow">for</span> (i=0; i&lt;MemberCount; i++) {
07793                             printf(<span class="stringliteral">"0x%lx\n"</span>, Members[i]);
07794                         }
07795                         DebugBreak();
07796                         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07797 
07798                     } <span class="keywordflow">else</span> {
07799 
07800                         <span class="keywordflow">if</span> (Members[0] == AliasRid) {
07801                             printf(<span class="stringliteral">"Succeeded\n"</span>);
07802                         } <span class="keywordflow">else</span> {
07803                             printf(<span class="stringliteral">"Failed\n"</span>);
07804                             printf(<span class="stringliteral">"Service returned SUCCESS, but combined alias membership for 2 accounts not correct.\n"</span>);
07805                             printf(<span class="stringliteral">"Combined Alias Membership :\n"</span>);
07806                             <span class="keywordflow">for</span> (i=0; i&lt;MemberCount; i++) {
07807                                 printf(<span class="stringliteral">"0x%lx\n"</span>, Members[i]);
07808                             }
07809                             DebugBreak();
07810                             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07811                         }
07812                     }
07813 
07814                     <span class="keywordflow">if</span> (Members != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07815                         SamFreeMemory( Members );
07816                     }
07817                 }
07818             }
07819 
07820 
07821         } <span class="keywordflow">else</span> {
07822             printf(<span class="stringliteral">"Failed\n"</span>);
07823             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
07824             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07825         }
07826 
07827 
07828         NtStatus = SamCloseHandle( AliasHandle2 );
07829         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
07830 
07831 
07832 
07833 
07834 
07835         printf(<span class="stringliteral">"      Add Another Member  . . . . . . . . . . . . . . . . .     "</span>);
07836 
07837 
07838         <span class="comment">//</span>
07839         <span class="comment">// Make user2 a member of this alias</span>
07840         <span class="comment">//</span>
07841 
07842         NtStatus = SamAddMemberToAlias(
07843                        AliasHandle1,
07844                        UserSid2
07845                        );
07846 
07847         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
07848 
07849             NtStatus = SamGetMembersInAlias(
07850                            AliasHandle1,
07851                            &amp;AliasMembers,
07852                            &amp;MemberCount
07853                            );
07854             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
07855 
07856             NtStatus = STATUS_MEMBER_NOT_IN_ALIAS;
07857             <span class="keywordflow">for</span> ( i=0; i&lt;MemberCount; i++) {
07858                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(AliasMembers[i], UserSid2)) {
07859                     NtStatus = STATUS_SUCCESS;
07860                     <span class="keywordflow">break</span>;
07861                 }
07862             }
07863 
07864             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
07865                 printf(<span class="stringliteral">"Failed\n"</span>);
07866                 printf(<span class="stringliteral">"Service returned SUCCESS, but user not in member list for alias.\n"</span>);
07867                 printf(<span class="stringliteral">"Member list :\n"</span>);
07868                 <span class="keywordflow">for</span> (i=0; i&lt;MemberCount; i++) {
07869                     printfSid(AliasMembers[i]);
07870                     printf(<span class="stringliteral">"\n"</span>);
07871                 }
07872                 DebugBreak();
07873                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07874             }
07875 
07876 
07877             <span class="keywordflow">if</span> (AliasMembers != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07878                 SamFreeMemory( AliasMembers );
07879             }
07880 
07881 
07882             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
07883 
07884                 NtStatus = SamGetAliasMembership(
07885                                DomainHandle,
07886                                1,
07887                                &amp;UserSid2,
07888                                &amp;MemberCount,
07889                                &amp;Members
07890                                );
07891                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
07892 
07893                 NtStatus = STATUS_MEMBER_NOT_IN_ALIAS;
07894                 <span class="keywordflow">for</span> ( i=0; i&lt;MemberCount; i++) {
07895                     <span class="keywordflow">if</span> (Members[i] == AliasRid) {
07896                         NtStatus = STATUS_SUCCESS;
07897                         <span class="keywordflow">break</span>;
07898                     }
07899                 }
07900 
07901                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
07902                     printf(<span class="stringliteral">"Failed\n"</span>);
07903                     printf(<span class="stringliteral">"Service returned SUCCESS, but alias not in account alias membership list.\n"</span>);
07904                     printf(<span class="stringliteral">"Alias Membership :\n"</span>);
07905                     <span class="keywordflow">for</span> (i=0; i&lt;MemberCount; i++) {
07906                         printf(<span class="stringliteral">"0x%lx\n"</span>, Members[i]);
07907                     }
07908                     DebugBreak();
07909                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07910                 }
07911 
07912                 <span class="keywordflow">if</span> (Members != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07913                     SamFreeMemory( Members );
07914                 }
07915 
07916                 <span class="comment">//</span>
07917                 <span class="comment">// Check for correct alias membership for multiple accounts</span>
07918                 <span class="comment">// User1 should be in alias1</span>
07919                 <span class="comment">// User2 should be in alias1.</span>
07920                 <span class="comment">//</span>
07921 
07922                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
07923 
07924                     PSID    SidArray[2];
07925                     SidArray[0] = UserSid1;
07926                     SidArray[1] = UserSid2;
07927 
07928                     NtStatus = SamGetAliasMembership(
07929                                    DomainHandle,
07930                                    2,
07931                                    SidArray,
07932                                    &amp;MemberCount,
07933                                    &amp;Members
07934                                    );
07935                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
07936 
07937                     <span class="keywordflow">if</span> (MemberCount != 1) {
07938 
07939                         printf(<span class="stringliteral">"Failed\n"</span>);
07940                         printf(<span class="stringliteral">"Service returned SUCCESS, but combined alias membership count for 2 accounts not correct.\n"</span>);
07941                         printf(<span class="stringliteral">"Combined Alias Membership :\n"</span>);
07942                         <span class="keywordflow">for</span> (i=0; i&lt;MemberCount; i++) {
07943                             printf(<span class="stringliteral">"0x%lx\n"</span>, Members[i]);
07944                         }
07945                         DebugBreak();
07946                         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07947 
07948                     } <span class="keywordflow">else</span> {
07949 
07950                         <span class="keywordflow">if</span> (Members[0] != AliasRid) {
07951                             printf(<span class="stringliteral">"Failed\n"</span>);
07952                             printf(<span class="stringliteral">"Service returned SUCCESS, but combined alias membership for 2 accounts not correct.\n"</span>);
07953                             printf(<span class="stringliteral">"Combined Alias Membership :\n"</span>);
07954                             <span class="keywordflow">for</span> (i=0; i&lt;MemberCount; i++) {
07955                                 printf(<span class="stringliteral">"0x%lx\n"</span>, Members[i]);
07956                             }
07957                             DebugBreak();
07958                             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07959 
07960                         } <span class="keywordflow">else</span> {
07961                             printf(<span class="stringliteral">"Succeeded\n"</span>);
07962                         }
07963                     }
07964 
07965                     <span class="keywordflow">if</span> (Members != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07966                         SamFreeMemory( Members );
07967                     }
07968                 }
07969             }
07970 
07971 
07972         } <span class="keywordflow">else</span> {
07973             printf(<span class="stringliteral">"Failed\n"</span>);
07974             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
07975             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07976         }
07977 
07978 
07979         printf(<span class="stringliteral">"      Remove Member . . . . . . . . . . . . . . . . . . . .     "</span>);
07980 
07981         <span class="comment">//</span>
07982         <span class="comment">// The previous test sets this one up.</span>
07983         <span class="comment">//</span>
07984 
07985         <span class="comment">//</span>
07986         <span class="comment">// Now try to remove the user from the alias</span>
07987         <span class="comment">//</span>
07988 
07989         NtStatus = SamRemoveMemberFromAlias(AliasHandle1, UserSid1);
07990         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
07991 
07992             NtStatus = SamGetMembersInAlias(
07993                            AliasHandle1,
07994                            &amp;AliasMembers,
07995                            &amp;MemberCount
07996                            );
07997             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
07998 
07999             <span class="keywordflow">for</span> ( i=0; i&lt;MemberCount; i++) {
08000                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(AliasMembers[i], UserSid1)) {
08001                     NtStatus = STATUS_MEMBER_IN_ALIAS;
08002                     <span class="keywordflow">break</span>;
08003                 }
08004             }
08005 
08006             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
08007                 printf(<span class="stringliteral">"Failed\n"</span>);
08008                 printf(<span class="stringliteral">"Service returned SUCCESS, but user still in member list for alias.\n"</span>);
08009                 printf(<span class="stringliteral">"Member list :\n"</span>);
08010                 <span class="keywordflow">for</span> (i=0; i&lt;MemberCount; i++) {
08011                     printfSid(AliasMembers[i]);
08012                     printf(<span class="stringliteral">"\n"</span>);
08013                 }
08014                 DebugBreak();
08015                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08016             }
08017 
08018             SamFreeMemory( AliasMembers );
08019 
08020             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
08021 
08022                 NtStatus = SamGetAliasMembership(
08023                                DomainHandle,
08024                                1,
08025                                &amp;UserSid1,
08026                                &amp;MemberCount,
08027                                &amp;Members
08028                                );
08029                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
08030 
08031                 <span class="keywordflow">for</span> ( i=0; i&lt;MemberCount; i++) {
08032                     <span class="keywordflow">if</span> (Members[i] == AliasRid) {
08033                         NtStatus = STATUS_MEMBER_IN_ALIAS;
08034                         <span class="keywordflow">break</span>;
08035                     }
08036                 }
08037 
08038                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
08039                     printf(<span class="stringliteral">"Failed\n"</span>);
08040                     printf(<span class="stringliteral">"Service returned SUCCESS, but alias still in account alias membership list.\n"</span>);
08041                     printf(<span class="stringliteral">"Alias Membership :\n"</span>);
08042                     <span class="keywordflow">for</span> (i=0; i&lt;MemberCount; i++) {
08043                         printf(<span class="stringliteral">"0x%lx\n"</span>, Members[i]);
08044                     }
08045                     DebugBreak();
08046                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08047                 }
08048 
08049                 <span class="keywordflow">if</span> (Members != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08050                     SamFreeMemory( Members );
08051                 }
08052 
08053                 <span class="comment">//</span>
08054                 <span class="comment">// Check for correct alias membership for multiple accounts</span>
08055                 <span class="comment">// User1 should be in no aliases</span>
08056                 <span class="comment">// User2 should be in alias1.</span>
08057                 <span class="comment">//</span>
08058 
08059                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
08060 
08061                     PSID    SidArray[2];
08062                     SidArray[0] = UserSid1;
08063                     SidArray[1] = UserSid2;
08064 
08065                     NtStatus = SamGetAliasMembership(
08066                                    DomainHandle,
08067                                    2,
08068                                    SidArray,
08069                                    &amp;MemberCount,
08070                                    &amp;Members
08071                                    );
08072                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
08073 
08074                     <span class="keywordflow">if</span> (MemberCount != 1) {
08075 
08076                         printf(<span class="stringliteral">"Failed\n"</span>);
08077                         printf(<span class="stringliteral">"Service returned SUCCESS, but combined alias membership count for 2 accounts not correct.\n"</span>);
08078                         printf(<span class="stringliteral">"Combined Alias Membership :\n"</span>);
08079                         <span class="keywordflow">for</span> (i=0; i&lt;MemberCount; i++) {
08080                             printf(<span class="stringliteral">"0x%lx\n"</span>, Members[i]);
08081                         }
08082                         DebugBreak();
08083                         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08084 
08085                     } <span class="keywordflow">else</span> {
08086 
08087                         <span class="keywordflow">if</span> (Members[0] != AliasRid) {
08088                             printf(<span class="stringliteral">"Failed\n"</span>);
08089                             printf(<span class="stringliteral">"Service returned SUCCESS, but combined alias membership for 2 accounts not correct.\n"</span>);
08090                             printf(<span class="stringliteral">"Combined Alias Membership :\n"</span>);
08091                             <span class="keywordflow">for</span> (i=0; i&lt;MemberCount; i++) {
08092                                 printf(<span class="stringliteral">"0x%lx\n"</span>, Members[i]);
08093                             }
08094                             DebugBreak();
08095                             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08096 
08097                         } <span class="keywordflow">else</span> {
08098                             printf(<span class="stringliteral">"Succeeded\n"</span>);
08099                         }
08100                     }
08101 
08102                     <span class="keywordflow">if</span> (Members != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08103                         SamFreeMemory( Members );
08104                     }
08105                 }
08106             }
08107 
08108         } <span class="keywordflow">else</span> {
08109             printf(<span class="stringliteral">"Failed\n"</span>);
08110             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
08111             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08112         }
08113 
08114 
08115 
08116 
08117         printf(<span class="stringliteral">"      Add A User to ADMIN Alias . . . . . . . . . . . . . .     "</span>);
08118 
08119         <span class="comment">//</span>
08120         <span class="comment">// Make user2 a member of the ADMIN alias</span>
08121         <span class="comment">//</span>
08122 
08123         NtStatus = SamOpenAlias(
08124                        BuiltinDomainHandle,
08125                        ALIAS_ALL_ACCESS,
08126                        DOMAIN_ALIAS_RID_ADMINS,
08127                        &amp;AdminAliasHandle
08128                        );
08129 
08130         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( NtStatus ) );
08131 
08132         NtStatus = SamAddMemberToAlias(
08133                        AdminAliasHandle,
08134                        UserSid2
08135                        );
08136 
08137         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
08138 
08139             NtStatus = SamGetMembersInAlias(
08140                            AdminAliasHandle,
08141                            &amp;AliasMembers,
08142                            &amp;MemberCount
08143                            );
08144             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
08145 
08146             NtStatus = STATUS_MEMBER_NOT_IN_ALIAS;
08147             <span class="keywordflow">for</span> ( i=0; i&lt;MemberCount; i++) {
08148                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(AliasMembers[i], UserSid2)) {
08149                     NtStatus = STATUS_SUCCESS;
08150                     <span class="keywordflow">break</span>;
08151                 }
08152             }
08153 
08154             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
08155                 printf(<span class="stringliteral">"Failed\n"</span>);
08156                 printf(<span class="stringliteral">"Service returned SUCCESS, but user not in member list for alias.\n"</span>);
08157                 printf(<span class="stringliteral">"Member list :\n"</span>);
08158                 <span class="keywordflow">for</span> (i=0; i&lt;MemberCount; i++) {
08159                     printfSid(AliasMembers[i]);
08160                     printf(<span class="stringliteral">"\n"</span>);
08161                 }
08162                 DebugBreak();
08163                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08164             }
08165 
08166 
08167             <span class="keywordflow">if</span> (AliasMembers != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08168                 SamFreeMemory( AliasMembers );
08169             }
08170 
08171 
08172             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
08173 
08174                 NtStatus = SamGetAliasMembership(
08175                                BuiltinDomainHandle,
08176                                1,
08177                                &amp;UserSid2,
08178                                &amp;MemberCount,
08179                                &amp;Members
08180                                );
08181                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
08182 
08183                 NtStatus = STATUS_MEMBER_NOT_IN_ALIAS;
08184                 <span class="keywordflow">for</span> ( i=0; i&lt;MemberCount; i++) {
08185                     <span class="keywordflow">if</span> (Members[i] == DOMAIN_ALIAS_RID_ADMINS) {
08186                         NtStatus = STATUS_SUCCESS;
08187                         <span class="keywordflow">break</span>;
08188                     }
08189                 }
08190 
08191                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
08192                     printf(<span class="stringliteral">"Failed\n"</span>);
08193                     printf(<span class="stringliteral">"Service returned SUCCESS, but alias not in account alias membership list.\n"</span>);
08194                     printf(<span class="stringliteral">"Alias Membership :\n"</span>);
08195                     <span class="keywordflow">for</span> (i=0; i&lt;MemberCount; i++) {
08196                         printf(<span class="stringliteral">"0x%lx\n"</span>, Members[i]);
08197                     }
08198                     DebugBreak();
08199                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08200 
08201                 } <span class="keywordflow">else</span> {
08202 
08203                     printf(<span class="stringliteral">"Succeeded\n"</span>);
08204                 }
08205 
08206                 <span class="keywordflow">if</span> (Members != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08207                     SamFreeMemory( Members );
08208                 }
08209             }
08210 
08211 
08212         } <span class="keywordflow">else</span> {
08213             printf(<span class="stringliteral">"Failed\n"</span>);
08214             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
08215             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08216         }
08217 
08218 
08219         printf(<span class="stringliteral">"      Add A Group to ADMIN Alias . . . . . . . . . . . . . .     "</span>);
08220 
08221         <span class="comment">//</span>
08222         <span class="comment">// Make a group a member of the ADMIN alias</span>
08223         <span class="comment">//</span>
08224 
08225         GroupSid = CreateUserSid(DomainSid, DOMAIN_GROUP_RID_USERS );
08226         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(GroupSid != NULL);
08227 
08228         NtStatus = SamAddMemberToAlias(
08229                        AdminAliasHandle,
08230                        GroupSid
08231                        );
08232 
08233         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
08234 
08235             NtStatus = SamGetMembersInAlias(
08236                            AdminAliasHandle,
08237                            &amp;AliasMembers,
08238                            &amp;MemberCount
08239                            );
08240             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
08241 
08242             NtStatus = STATUS_MEMBER_NOT_IN_ALIAS;
08243             <span class="keywordflow">for</span> ( i=0; i&lt;MemberCount; i++) {
08244                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(AliasMembers[i], GroupSid)) {
08245                     NtStatus = STATUS_SUCCESS;
08246                     <span class="keywordflow">break</span>;
08247                 }
08248             }
08249 
08250             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
08251                 printf(<span class="stringliteral">"Failed\n"</span>);
08252                 printf(<span class="stringliteral">"Service returned SUCCESS, but user not in member list for alias.\n"</span>);
08253                 printf(<span class="stringliteral">"Member list :\n"</span>);
08254                 <span class="keywordflow">for</span> (i=0; i&lt;MemberCount; i++) {
08255                     printfSid(AliasMembers[i]);
08256                     printf(<span class="stringliteral">"\n"</span>);
08257                 }
08258                 DebugBreak();
08259                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08260             }
08261 
08262 
08263             <span class="keywordflow">if</span> (AliasMembers != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08264                 SamFreeMemory( AliasMembers );
08265             }
08266 
08267 
08268             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
08269 
08270                 NtStatus = SamGetAliasMembership(
08271                                BuiltinDomainHandle,
08272                                1,
08273                                &amp;GroupSid,
08274                                &amp;MemberCount,
08275                                &amp;Members
08276                                );
08277                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
08278 
08279                 NtStatus = STATUS_MEMBER_NOT_IN_ALIAS;
08280                 <span class="keywordflow">for</span> ( i=0; i&lt;MemberCount; i++) {
08281                     <span class="keywordflow">if</span> (Members[i] == DOMAIN_ALIAS_RID_ADMINS) {
08282                         NtStatus = STATUS_SUCCESS;
08283                         <span class="keywordflow">break</span>;
08284                     }
08285                 }
08286 
08287                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
08288                     printf(<span class="stringliteral">"Failed\n"</span>);
08289                     printf(<span class="stringliteral">"Service returned SUCCESS, but alias not in account alias membership list.\n"</span>);
08290                     printf(<span class="stringliteral">"Alias Membership :\n"</span>);
08291                     <span class="keywordflow">for</span> (i=0; i&lt;MemberCount; i++) {
08292                         printf(<span class="stringliteral">"0x%lx\n"</span>, Members[i]);
08293                     }
08294                     DebugBreak();
08295                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08296 
08297                 } <span class="keywordflow">else</span> {
08298 
08299                     printf(<span class="stringliteral">"Succeeded\n"</span>);
08300                 }
08301 
08302                 <span class="keywordflow">if</span> (Members != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08303                     SamFreeMemory( Members );
08304                 }
08305             }
08306 
08307 
08308         } <span class="keywordflow">else</span> {
08309             printf(<span class="stringliteral">"Failed\n"</span>);
08310             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
08311             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08312         }
08313 
08314 
08315 <span class="comment">// NOTE: user is already created in the group below.  Should keep this</span>
08316 <span class="comment">// test, AND add another with an all-new group that's been added to the ADMIN</span>
08317 <span class="comment">// alias (then ADD user to group, rather than create in it).</span>
08318         printf(<span class="stringliteral">"      Create user in ADMIN ALIAS'd Group. . . . . . . . . . .     "</span>);
08319 
08320         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, USER_NAME3 );
08321         NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountName, &amp;AccountNameAnsi, TRUE );
08322         TST_SUCCESS_ASSERT(NtStatus);
08323 
08324         UserRid3 = 0;
08325         UserHandle3 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08326         NtStatus = SamCreateUserInDomain(
08327                        DomainHandle,
08328                        &amp;AccountName,
08329                        USER_ALL_ACCESS,
08330                        &amp;UserHandle3,
08331                        &amp;UserRid3
08332                        );
08333         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountName );
08334 
08335         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( NtStatus ) ) {
08336 
08337             printf(<span class="stringliteral">"Succeeded\n"</span>);
08338 
08339         } <span class="keywordflow">else</span> {
08340 
08341             printf(<span class="stringliteral">"Failed\n"</span>);
08342             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
08343             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08344         }
08345 
08346 
08347 
08348 <span class="comment">//NOTE: doesn't work because this is primary group.</span>
08349 <span class="comment">//put back in when all-new group is created, above</span>
08350 <span class="comment">//        printf("      Remove user from ADMIN ALIAS'd Group. . . . . . . . . . .     ");</span>
08351 <span class="comment">//</span>
08352 <span class="comment">//        NtStatus = SamOpenGroup(</span>
08353 <span class="comment">//                       DomainHandle,</span>
08354 <span class="comment">//                       GROUP_ALL_ACCESS,</span>
08355 <span class="comment">//                       DOMAIN_GROUP_RID_USERS,</span>
08356 <span class="comment">//                       &amp;GroupHandle</span>
08357 <span class="comment">//                       );</span>
08358 <span class="comment">//</span>
08359 <span class="comment">//        ASSERT(NT_SUCCESS(NtStatus));</span>
08360 <span class="comment">//</span>
08361 <span class="comment">//        NtStatus = SamRemoveMemberFromGroup(</span>
08362 <span class="comment">//                       GroupHandle,</span>
08363 <span class="comment">//                       UserRid3</span>
08364 <span class="comment">//                       );</span>
08365 <span class="comment">//</span>
08366 <span class="comment">//        if ( NT_SUCCESS( NtStatus ) ) {</span>
08367 <span class="comment">//</span>
08368 <span class="comment">//            printf("Succeeded\n");</span>
08369 <span class="comment">//</span>
08370 <span class="comment">//        } else {</span>
08371 <span class="comment">//</span>
08372 <span class="comment">//            printf("Failed\n");</span>
08373 <span class="comment">//            printf("        Completion status is 0x%lx\n", NtStatus);</span>
08374 <span class="comment">//            TestStatus = FALSE;</span>
08375 <span class="comment">//        }</span>
08376 <span class="comment">//</span>
08377 <span class="comment">//        IgnoreStatus = SamCloseHandle( GroupHandle );</span>
08378 <span class="comment">//        ASSERT(NT_SUCCESS(IgnoreStatus));</span>
08379         IgnoreStatus = SamCloseHandle( UserHandle3 );
08380         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus));
08381 
08382 
08383 
08384         printf(<span class="stringliteral">"      Remove User from ADMIN alias. . . . . . . . . . .     "</span>);
08385 
08386         <span class="comment">//</span>
08387         <span class="comment">// The previous test sets this one up.</span>
08388         <span class="comment">//</span>
08389         <span class="comment">// Now try to remove the user from the alias</span>
08390         <span class="comment">//</span>
08391 
08392         NtStatus = SamRemoveMemberFromAlias(AdminAliasHandle, UserSid2);
08393         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
08394 
08395             NtStatus = SamGetMembersInAlias(
08396                            AdminAliasHandle,
08397                            &amp;AliasMembers,
08398                            &amp;MemberCount
08399                            );
08400             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
08401 
08402             <span class="keywordflow">for</span> ( i=0; i&lt;MemberCount; i++) {
08403                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(AliasMembers[i], UserSid2)) {
08404                     NtStatus = STATUS_MEMBER_IN_ALIAS;
08405                     <span class="keywordflow">break</span>;
08406                 }
08407             }
08408 
08409             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
08410                 printf(<span class="stringliteral">"Failed\n"</span>);
08411                 printf(<span class="stringliteral">"Service returned SUCCESS, but user still in member list for alias.\n"</span>);
08412                 printf(<span class="stringliteral">"Member list :\n"</span>);
08413                 <span class="keywordflow">for</span> (i=0; i&lt;MemberCount; i++) {
08414                     printfSid(AliasMembers[i]);
08415                     printf(<span class="stringliteral">"\n"</span>);
08416                 }
08417                 DebugBreak();
08418                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08419             }
08420 
08421             SamFreeMemory( AliasMembers );
08422 
08423             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
08424 
08425                 NtStatus = SamGetAliasMembership(
08426                                BuiltinDomainHandle,
08427                                1,
08428                                &amp;UserSid2,
08429                                &amp;MemberCount,
08430                                &amp;Members
08431                                );
08432                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
08433 
08434                 <span class="keywordflow">for</span> ( i=0; i&lt;MemberCount; i++) {
08435                     <span class="keywordflow">if</span> (Members[i] == DOMAIN_ALIAS_RID_ADMINS) {
08436                         NtStatus = STATUS_MEMBER_IN_ALIAS;
08437                         <span class="keywordflow">break</span>;
08438                     }
08439                 }
08440 
08441                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
08442                     printf(<span class="stringliteral">"Failed\n"</span>);
08443                     printf(<span class="stringliteral">"Service returned SUCCESS, but alias still in account alias membership list.\n"</span>);
08444                     printf(<span class="stringliteral">"Alias Membership :\n"</span>);
08445                     <span class="keywordflow">for</span> (i=0; i&lt;MemberCount; i++) {
08446                         printf(<span class="stringliteral">"0x%lx\n"</span>, Members[i]);
08447                     }
08448                     DebugBreak();
08449                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08450 
08451                 } <span class="keywordflow">else</span> {
08452 
08453                     printf(<span class="stringliteral">"Succeeded\n"</span>);
08454                 }
08455 
08456                 <span class="keywordflow">if</span> (Members != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08457                     SamFreeMemory( Members );
08458                 }
08459             }
08460 
08461         } <span class="keywordflow">else</span> {
08462             printf(<span class="stringliteral">"Failed\n"</span>);
08463             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
08464             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08465         }
08466 
08467 
08468 
08469 
08470         <span class="comment">//</span>
08471         <span class="comment">// Make user2 a member of the ADMIN alias again, so we can test</span>
08472         <span class="comment">// the new function SamRemoveMemberFromForeignDomain().</span>
08473         <span class="comment">// NOTE: we should make this a real test item.</span>
08474         <span class="comment">//</span>
08475 
08476         NtStatus = SamAddMemberToAlias(
08477                        AdminAliasHandle,
08478                        UserSid2
08479                        );
08480 
08481         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
08482 
08483         NtStatus = SamRemoveMemberFromForeignDomain(
08484                        BuiltinDomainHandle,
08485                        UserSid2 );
08486 
08487         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
08488 
08489 
08490 
08491         printf(<span class="stringliteral">"      Remove Group from ADMIN alias. . . . . . . . . . .     "</span>);
08492 
08493         <span class="comment">//</span>
08494         <span class="comment">// The previous test sets this one up.</span>
08495         <span class="comment">//</span>
08496         <span class="comment">// Now try to remove the group from the alias</span>
08497         <span class="comment">//</span>
08498 
08499         NtStatus = SamRemoveMemberFromAlias(AdminAliasHandle, GroupSid);
08500         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
08501 
08502             NtStatus = SamGetMembersInAlias(
08503                            AdminAliasHandle,
08504                            &amp;AliasMembers,
08505                            &amp;MemberCount
08506                            );
08507             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
08508 
08509             <span class="keywordflow">for</span> ( i=0; i&lt;MemberCount; i++) {
08510                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(AliasMembers[i], GroupSid)) {
08511                     NtStatus = STATUS_MEMBER_IN_ALIAS;
08512                     <span class="keywordflow">break</span>;
08513                 }
08514             }
08515 
08516             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
08517                 printf(<span class="stringliteral">"Failed\n"</span>);
08518                 printf(<span class="stringliteral">"Service returned SUCCESS, but user still in member list for alias.\n"</span>);
08519                 printf(<span class="stringliteral">"Member list :\n"</span>);
08520                 <span class="keywordflow">for</span> (i=0; i&lt;MemberCount; i++) {
08521                     printfSid(AliasMembers[i]);
08522                     printf(<span class="stringliteral">"\n"</span>);
08523                 }
08524                 DebugBreak();
08525                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08526             }
08527 
08528             SamFreeMemory( AliasMembers );
08529 
08530             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
08531 
08532                 NtStatus = SamGetAliasMembership(
08533                                BuiltinDomainHandle,
08534                                1,
08535                                &amp;GroupSid,
08536                                &amp;MemberCount,
08537                                &amp;Members
08538                                );
08539                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
08540 
08541                 <span class="keywordflow">for</span> ( i=0; i&lt;MemberCount; i++) {
08542                     <span class="keywordflow">if</span> (Members[i] == DOMAIN_ALIAS_RID_ADMINS) {
08543                         NtStatus = STATUS_MEMBER_IN_ALIAS;
08544                         <span class="keywordflow">break</span>;
08545                     }
08546                 }
08547 
08548                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
08549                     printf(<span class="stringliteral">"Failed\n"</span>);
08550                     printf(<span class="stringliteral">"Service returned SUCCESS, but alias still in account alias membership list.\n"</span>);
08551                     printf(<span class="stringliteral">"Alias Membership :\n"</span>);
08552                     <span class="keywordflow">for</span> (i=0; i&lt;MemberCount; i++) {
08553                         printf(<span class="stringliteral">"0x%lx\n"</span>, Members[i]);
08554                     }
08555                     DebugBreak();
08556                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08557 
08558                 } <span class="keywordflow">else</span> {
08559 
08560                     printf(<span class="stringliteral">"Succeeded\n"</span>);
08561                 }
08562 
08563                 <span class="keywordflow">if</span> (Members != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08564                     SamFreeMemory( Members );
08565                 }
08566             }
08567 
08568         } <span class="keywordflow">else</span> {
08569             printf(<span class="stringliteral">"Failed\n"</span>);
08570             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
08571             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08572         }
08573 
08574         IgnoreStatus = SamCloseHandle( AdminAliasHandle );
08575         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
08576 
08577 
08578 
08579         printf(<span class="stringliteral">"      Delete account while member of alias. . . . . . . . .     "</span>);
08580 
08581 
08582         <span class="comment">//</span>
08583         <span class="comment">// Now delete user2 and check the alias member list is updated</span>
08584         <span class="comment">//</span>
08585 
08586         NtStatus = SamDeleteUser( UserHandle2 );
08587         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
08588 
08589         NtStatus = SamGetMembersInAlias(
08590                        AliasHandle1,
08591                        &amp;AliasMembers,
08592                        &amp;MemberCount
08593                        );
08594         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
08595 
08596         <span class="keywordflow">for</span> ( i=0; i&lt;MemberCount; i++) {
08597             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(AliasMembers[i], UserSid2)) {
08598                 NtStatus = STATUS_MEMBER_IN_ALIAS;
08599                 <span class="keywordflow">break</span>;
08600             }
08601         }
08602 
08603         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
08604             printf(<span class="stringliteral">"Failed\n"</span>);
08605             printf(<span class="stringliteral">"Service returned SUCCESS, but user still in member list for alias.\n"</span>);
08606             printf(<span class="stringliteral">"Member list :\n"</span>);
08607             <span class="keywordflow">for</span> (i=0; i&lt;MemberCount; i++) {
08608                 printfSid(AliasMembers[i]);
08609                 printf(<span class="stringliteral">"\n"</span>);
08610             }
08611             DebugBreak();
08612             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08613         }
08614 
08615         SamFreeMemory( AliasMembers );
08616 
08617         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
08618 
08619             NtStatus = SamGetAliasMembership(
08620                            DomainHandle,
08621                            1,
08622                            &amp;UserSid2,
08623                            &amp;MemberCount,
08624                            &amp;Members
08625                            );
08626             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
08627 
08628             <span class="keywordflow">if</span> (MemberCount != 0) {
08629                 printf(<span class="stringliteral">"Failed\n"</span>);
08630                 printf(<span class="stringliteral">"Service returned SUCCESS, but alias still in alias membership list for account.\n"</span>);
08631                 printf(<span class="stringliteral">"Alias Membership :\n"</span>);
08632                 <span class="keywordflow">for</span> (i=0; i&lt;MemberCount; i++) {
08633                     printf(<span class="stringliteral">"0x%lx\n"</span>, Members[i]);
08634                 }
08635                 DebugBreak();
08636                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08637             }
08638 
08639             <span class="keywordflow">if</span> (Members != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08640                 SamFreeMemory( Members );
08641             }
08642 
08643             <span class="comment">//</span>
08644             <span class="comment">// Check for correct alias membership for multiple accounts</span>
08645             <span class="comment">// User1 should be in no aliases</span>
08646             <span class="comment">// User2 should be in no aliases.</span>
08647             <span class="comment">//</span>
08648 
08649             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
08650 
08651                 PSID    SidArray[2];
08652                 SidArray[0] = UserSid1;
08653                 SidArray[1] = UserSid2;
08654 
08655                 NtStatus = SamGetAliasMembership(
08656                                DomainHandle,
08657                                2,
08658                                SidArray,
08659                                &amp;MemberCount,
08660                                &amp;Members
08661                                );
08662                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
08663 
08664                 <span class="keywordflow">if</span> (MemberCount != 0) {
08665 
08666                     printf(<span class="stringliteral">"Failed\n"</span>);
08667                     printf(<span class="stringliteral">"Service returned SUCCESS, but combined alias membership count for 2 accounts not correct.\n"</span>);
08668                     printf(<span class="stringliteral">"Combined Alias Membership :\n"</span>);
08669                     <span class="keywordflow">for</span> (i=0; i&lt;MemberCount; i++) {
08670                         printf(<span class="stringliteral">"0x%lx\n"</span>, Members[i]);
08671                     }
08672                     DebugBreak();
08673                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08674 
08675                 } <span class="keywordflow">else</span> {
08676                     printf(<span class="stringliteral">"Succeeded\n"</span>);
08677                 }
08678 
08679                 <span class="keywordflow">if</span> (Members != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08680                     SamFreeMemory( Members );
08681                 }
08682             }
08683         }
08684 
08685 
08686 
08687 
08688         printf(<span class="stringliteral">"      Delete alias with members . . . . . . . . . . . . . .     "</span>);
08689 
08690         <span class="comment">//</span>
08691         <span class="comment">// Make the user a member of this alias (again)</span>
08692         <span class="comment">//</span>
08693 
08694         NtStatus = SamAddMemberToAlias(
08695                        AliasHandle1,
08696                        UserSid1
08697                        );
08698         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
08699 
08700         <span class="comment">//</span>
08701         <span class="comment">// Now delete the alias and check the membership list for user is updated</span>
08702         <span class="comment">//</span>
08703 
08704         NtStatus = SamDeleteAlias( AliasHandle1 );
08705         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
08706 
08707         NtStatus = SamGetAliasMembership(
08708                        DomainHandle,
08709                        1,
08710                        &amp;UserSid1,
08711                        &amp;MemberCount,
08712                        &amp;Members
08713                        );
08714         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
08715 
08716         <span class="keywordflow">for</span> ( i=0; i&lt;MemberCount; i++) {
08717             <span class="keywordflow">if</span> (Members[i] == AliasRid) {
08718                 NtStatus = STATUS_MEMBER_IN_ALIAS;
08719                 <span class="keywordflow">break</span>;
08720             }
08721         }
08722 
08723         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
08724             printf(<span class="stringliteral">"Succeeded\n"</span>);
08725         } <span class="keywordflow">else</span> {
08726             printf(<span class="stringliteral">"Failed\n"</span>);
08727             printf(<span class="stringliteral">"Service returned SUCCESS, but alias still in account alias membership list.\n"</span>);
08728             printf(<span class="stringliteral">"Alias Membership :\n"</span>);
08729             <span class="keywordflow">for</span> (i=0; i&lt;MemberCount; i++) {
08730                 printf(<span class="stringliteral">"0x%lx\n"</span>, Members[i]);
08731             }
08732             DebugBreak();
08733             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08734         }
08735 
08736         <span class="keywordflow">if</span> (Members != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08737             SamFreeMemory( Members );
08738         }
08739 
08740 
08741 
08742         DeleteUserSid(UserSid1);
08743         DeleteUserSid(UserSid2);
08744 
08745         <span class="comment">//</span>
08746         <span class="comment">// and clean up</span>
08747         <span class="comment">//</span>
08748 
08749         <span class="keywordflow">if</span> (DeleteUser == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
08750             NtStatus = SamDeleteUser( UserHandle1 );
08751             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
08752         } <span class="keywordflow">else</span> {
08753             NtStatus = SamCloseHandle( UserHandle1 );
08754             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
08755         }
08756 
08757 
08758 
08759 
08760 
08761 
08762         printf(<span class="stringliteral">"      Add Foreign Domain Member . . . . . . . . . . . . . .     "</span>);
08763 
08764         <span class="comment">//</span>
08765         <span class="comment">// create the alias</span>
08766         <span class="comment">//</span>
08767 
08768         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, ALIAS_NAME1 );
08769         NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountName, &amp;AccountNameAnsi, TRUE );
08770         TST_SUCCESS_ASSERT(NtStatus);
08771 
08772         AliasRid = 0;
08773         AliasHandle1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08774         NtStatus = SamCreateAliasInDomain(
08775                        DomainHandle,
08776                        &amp;AccountName,
08777                        ALIAS_ALL_ACCESS,
08778                        &amp;AliasHandle1,
08779                        &amp;AliasRid
08780                        );
08781         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountName );
08782         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
08783 
08784         <span class="comment">//</span>
08785         <span class="comment">// Specify a non-existant user be added to this alias</span>
08786         <span class="comment">//</span>
08787 
08788 
08789         {
08790             PSID    ForeignDomainSid;
08791 
08792             ForeignDomainSid = CreateUserSid(DomainSid, 307333); <span class="comment">// random domain sub-authority</span>
08793             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ForeignDomainSid != NULL);
08794 
08795             UserRid = 45728;    <span class="comment">// Random user rid</span>
08796 
08797             UserSid1 = CreateUserSid(ForeignDomainSid, UserRid);
08798             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(UserSid1 != NULL);
08799 
08800             DeleteUserSid(ForeignDomainSid);
08801         }
08802 
08803 
08804         NtStatus = SamAddMemberToAlias(
08805                        AliasHandle1,
08806                        UserSid1
08807                        );
08808 
08809         <span class="keywordflow">if</span> (NtStatus == STATUS_SUCCESS) {
08810 
08811             NtStatus = SamGetMembersInAlias(
08812                            AliasHandle1,
08813                            &amp;AliasMembers,
08814                            &amp;MemberCount
08815                            );
08816             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
08817 
08818             NtStatus = STATUS_MEMBER_NOT_IN_ALIAS;
08819             <span class="keywordflow">for</span> ( i=0; i&lt;MemberCount; i++) {
08820                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(AliasMembers[i], UserSid1)) {
08821                     NtStatus = STATUS_SUCCESS;
08822                     <span class="keywordflow">break</span>;
08823                 }
08824             }
08825 
08826             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
08827                 printf(<span class="stringliteral">"Failed\n"</span>);
08828                 printf(<span class="stringliteral">"Service returned SUCCESS, but user not in member list for alias.\n"</span>);
08829                 printf(<span class="stringliteral">"Member list :\n"</span>);
08830                 <span class="keywordflow">for</span> (i=0; i&lt;MemberCount; i++) {
08831                     printfSid(AliasMembers[i]);
08832                     printf(<span class="stringliteral">"\n"</span>);
08833                 }
08834                 DebugBreak();
08835                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08836             }
08837 
08838 
08839             <span class="keywordflow">if</span> (AliasMembers != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08840                 SamFreeMemory( AliasMembers );
08841             }
08842 
08843 
08844             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
08845 
08846                 NtStatus = SamGetAliasMembership(
08847                                DomainHandle,
08848                                1,
08849                                &amp;UserSid1,
08850                                &amp;MemberCount,
08851                                &amp;Members
08852                                );
08853                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
08854 
08855                 NtStatus = STATUS_MEMBER_NOT_IN_ALIAS;
08856                 <span class="keywordflow">for</span> ( i=0; i&lt;MemberCount; i++) {
08857                     <span class="keywordflow">if</span> (Members[i] == AliasRid) {
08858                         NtStatus = STATUS_SUCCESS;
08859                         <span class="keywordflow">break</span>;
08860                     }
08861                 }
08862 
08863                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
08864                     printf(<span class="stringliteral">"Succeeded\n"</span>);
08865                 } <span class="keywordflow">else</span> {
08866                     printf(<span class="stringliteral">"Failed\n"</span>);
08867                     printf(<span class="stringliteral">"Service returned SUCCESS, but alias not in account alias membership list.\n"</span>);
08868                     printf(<span class="stringliteral">"Alias Membership :\n"</span>);
08869                     <span class="keywordflow">for</span> (i=0; i&lt;MemberCount; i++) {
08870                         printf(<span class="stringliteral">"0x%lx\n"</span>, Members[i]);
08871                     }
08872                     DebugBreak();
08873                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08874                 }
08875 
08876                 <span class="keywordflow">if</span> (Members != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08877                     SamFreeMemory( Members );
08878                 }
08879             }
08880 
08881         } <span class="keywordflow">else</span> {
08882             printf(<span class="stringliteral">"Failed\n"</span>);
08883             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
08884             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08885         }
08886 
08887         DeleteUserSid(UserSid1);
08888 
08889 
08890 
08891 
08892         printf(<span class="stringliteral">"      Add alias as member . . . . . . . . . . . . . . . . .     "</span>);
08893 
08894         <span class="comment">//</span>
08895         <span class="comment">// Specify an alias in the current domain be added to this alias</span>
08896         <span class="comment">//</span>
08897 
08898 
08899         UserSid1 = CreateUserSid(DomainSid, AliasRid2);
08900         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(UserSid1 != NULL);
08901 
08902 
08903         NtStatus = SamAddMemberToAlias(
08904                        AliasHandle1,
08905                        UserSid1
08906                        );
08907 
08908         <span class="keywordflow">if</span> (NtStatus != STATUS_INVALID_MEMBER) {
08909 
08910                 printf(<span class="stringliteral">"Failed\n"</span>);
08911                 printf(<span class="stringliteral">"Expected service to return STATUS_INVALID_MEMBER, actually returned 0x%lx.\n"</span>, NtStatus);
08912                 DebugBreak();
08913                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08914         } <span class="keywordflow">else</span> {
08915                 printf(<span class="stringliteral">"Succeeded\n"</span>);
08916         }
08917 
08918         DeleteUserSid(UserSid1);
08919 
08920 
08921 
08922         printf(<span class="stringliteral">"      Add non-existant account in this domain as member . .     "</span>);
08923 
08924         <span class="comment">//</span>
08925         <span class="comment">// Specify a non-existant account in the current domain be added to this alias</span>
08926         <span class="comment">//</span>
08927 
08928 
08929         UserSid1 = CreateUserSid(DomainSid, 32567); <span class="comment">// Random rid</span>
08930         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(UserSid1 != NULL);
08931 
08932 
08933         NtStatus = SamAddMemberToAlias(
08934                        AliasHandle1,
08935                        UserSid1
08936                        );
08937 
08938         <span class="keywordflow">if</span> (NtStatus != STATUS_NO_SUCH_MEMBER) {
08939 
08940                 printf(<span class="stringliteral">"Failed\n"</span>);
08941                 printf(<span class="stringliteral">"Expected service to return STATUS_NO_SUCH_MEMBER, actually returned 0x%lx.\n"</span>, NtStatus);
08942                 DebugBreak();
08943                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08944         } <span class="keywordflow">else</span> {
08945                 printf(<span class="stringliteral">"Succeeded\n"</span>);
08946         }
08947 
08948         DeleteUserSid(UserSid1);
08949 
08950 
08951 
08952         printf(<span class="stringliteral">"      Remove Non-member . . . . . . . . . . . . . . . . . .      "</span>);
08953 
08954         <span class="comment">//</span>
08955         <span class="comment">// Specify a non-existant user be removed from this alias</span>
08956         <span class="comment">//</span>
08957 
08958         {
08959             PSID    ForeignDomainSid;
08960 
08961             ForeignDomainSid = CreateUserSid(DomainSid, 35775); <span class="comment">// random domain sub-authority</span>
08962             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ForeignDomainSid != NULL);
08963 
08964             UserRid = 623545;    <span class="comment">// Random user rid</span>
08965 
08966             UserSid1 = CreateUserSid(ForeignDomainSid, UserRid);
08967             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(UserSid1 != NULL);
08968 
08969             DeleteUserSid(ForeignDomainSid);
08970         }
08971 
08972         NtStatus = SamRemoveMemberFromAlias( AliasHandle1, UserSid1 );
08973 
08974         <span class="keywordflow">if</span> (NtStatus == STATUS_MEMBER_NOT_IN_ALIAS) {
08975 
08976             printf(<span class="stringliteral">"Succeeded\n"</span>);
08977 
08978         } <span class="keywordflow">else</span> {
08979             printf(<span class="stringliteral">"Failed\n"</span>);
08980             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
08981             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08982         }
08983 
08984         DeleteUserSid(UserSid1);
08985 
08986         NtStatus = SamDeleteAlias( AliasHandle1 );
08987         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
08988 
08989 
08990 
08991 
08992     }
08993 
08994     <span class="keywordflow">return</span>(TestStatus);
08995 
08996 }
08997 
08998 
09000 <span class="comment">//                                                                           //</span>
09001 <span class="comment">// User Object Test Suite                                                    //</span>
09002 <span class="comment">//                                                                           //</span>
09004 <span class="comment"></span>
09005 
09006 BOOLEAN
09007 UserTestSuite(
09008     HANDLE DomainHandle,
09009     ULONG Pass
09010     )
09011 
09012 
09013 {
09014 
09015     PUSER_ALL_INFORMATION All, All2;
09016     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            NtStatus, IgnoreStatus, TmpStatus;
09017     HANDLE              UserHandle1, UserHandle2, GroupHandle1;
09018     ULONG               CountReturned, NameLength, MembershipCount, i;
09019     ULONG               UserRid, GroupRid;
09020     PVOID               <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>, <a class="code" href="../../d9/d0/tfilmem_8c.html#a2">Buffer2</a>;
09021     SAM_ENUMERATE_HANDLE EnumerationContext;
09022     USER_GENERAL_INFORMATION GeneralInformation;
09023     USER_LOGON_INFORMATION LogonInformation;
09024     USER_ACCOUNT_INFORMATION AccountInformation;
09025     PSID_NAME_USE       LookedUpUses;
09026     PULONG              LookedUpRids;
09027     UNICODE_STRING      AccountNames[10], AccountName;
09028     STRING              AccountNameAnsi, TmpAnsiString;
09029 
09030 
09031 
09032 
09033     BOOLEAN             IndividualTestSucceeded, DeleteUser;
09034     BOOLEAN             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
09035 
09036 
09037 
09038 
09039     <span class="keywordflow">if</span> (Pass == 1) {
09040         <span class="comment">// This test suite assumes that lookup and enumeration API funciton</span>
09041         <span class="comment">// properly.</span>
09042         <span class="comment">//</span>
09043 
09044         printf(<span class="stringliteral">"\n"</span>);
09045         printf(<span class="stringliteral">"\n"</span>);
09046         printf(<span class="stringliteral">"  User  (Pass #1) . . . . . . . . . . . . . . . . . . .   Test\n"</span>);
09047 
09049         <span class="comment">//                                                                       //</span>
09050         <span class="comment">// Open User  Suite                                                      //</span>
09051         <span class="comment">//                                                                       //</span>
09053 <span class="comment"></span>
09054         printf(<span class="stringliteral">"    Open User   . . . . . . . . . . . . . . . . . . . . .   Suite\n"</span>);
09055         printf(<span class="stringliteral">"      Open Users  . . . . . . . . . . . . . . . . . . . . .     "</span>);
09056         IndividualTestSucceeded = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
09057         EnumerationContext = 0;
09058         NtStatus = SamEnumerateUsersInDomain(
09059                        DomainHandle,
09060                        &amp;EnumerationContext,
09061                        0,
09062                        &amp;Buffer,
09063                        12000,                   <span class="comment">// PreferedMaximumLength</span>
09064                        &amp;CountReturned
09065                        );
09066 
09067         TST_SUCCESS_ASSERT(NtStatus);
09068         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Buffer != NULL);
09069         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(CountReturned &gt; 0);
09070 
09071         <span class="keywordflow">for</span> (i=0; i&lt;CountReturned; i++) {
09072 
09073             NtStatus = SamOpenUser(
09074                            DomainHandle,
09075                            USER_ALL_ACCESS,
09076                            ((PSAM_RID_ENUMERATION)(Buffer))[i].RelativeId,
09077                            &amp;UserHandle1
09078                            );
09079 
09080             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
09081 
09082                 NtStatus = SamOpenUser(
09083                                DomainHandle,
09084                                GENERIC_READ,
09085                                ((PSAM_RID_ENUMERATION)(Buffer))[i].RelativeId,
09086                                &amp;UserHandle2
09087                                );
09088 
09089                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
09090                     IgnoreStatus = SamCloseHandle( UserHandle2 );
09091                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
09092                 } <span class="keywordflow">else</span> {
09093                     printf(<span class="stringliteral">"Failed\n"</span>);
09094                     printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
09095                     printf(<span class="stringliteral">"        Failed opening User  second time.\n"</span>);
09096                     printf(<span class="stringliteral">"        Rid of account is:   0x%lx\n"</span>,
09097                         ((PSAM_RID_ENUMERATION)(Buffer))[i].RelativeId);
09098                     printf(<span class="stringliteral">"        Name of account is:  %wZ\n"</span>,
09099                         &amp;((PSAM_RID_ENUMERATION)(Buffer))[i].Name );
09100                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09101                     IndividualTestSucceeded = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09102                 }
09103 
09104                 IgnoreStatus = SamCloseHandle( UserHandle1 );
09105                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
09106 
09107             } <span class="keywordflow">else</span> {
09108 
09109                 printf(<span class="stringliteral">"Failed\n"</span>);
09110                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
09111                 printf(<span class="stringliteral">"        Failed opening User  for first time.\n"</span>);
09112                 printf(<span class="stringliteral">"        Rid of account is:   0x%lx\n"</span>,
09113                     ((PSAM_RID_ENUMERATION)(Buffer))[i].RelativeId);
09114                 printf(<span class="stringliteral">"        Name of account is:  %wZ\n"</span>,
09115                     &amp;((PSAM_RID_ENUMERATION)(Buffer))[i].Name );
09116                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09117                 IndividualTestSucceeded = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09118             }
09119 
09120         }
09121 
09122 
09123         SamFreeMemory( Buffer );
09124         <span class="keywordflow">if</span> (IndividualTestSucceeded) {
09125             printf(<span class="stringliteral">"Succeeded\n"</span>);
09126         }
09127 
09128 
09129 
09131         <span class="comment">//                                                                       //</span>
09132         <span class="comment">// Query User Suite                                                      //</span>
09133         <span class="comment">//                                                                       //</span>
09135 <span class="comment"></span>
09136         printf(<span class="stringliteral">"\n"</span>);
09137         printf(<span class="stringliteral">"    Query User  . . . . . . . . . . . . . . . . . . . . .   Suite\n"</span>);
09138 
09139         printf(<span class="stringliteral">"      Query User  General Information . . . . . . . . . . .     "</span>);
09140 
09141 
09142         NtStatus = SamOpenUser(
09143                        DomainHandle,
09144                        USER_READ_GENERAL,
09145                        DOMAIN_USER_RID_ADMIN,
09146                        &amp;UserHandle1
09147                        );
09148         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
09149 
09150         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09151         NtStatus = SamQueryInformationUser(
09152                        UserHandle1,
09153                        UserGeneralInformation,
09154                        &amp;Buffer
09155                        );
09156         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
09157             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09158 
09159                 <span class="keywordflow">if</span> ( (((USER_GENERAL_INFORMATION *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;UserName.MaximumLength
09160                     &gt;= 0) &amp;&amp;
09161                      (((USER_GENERAL_INFORMATION *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;UserName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
09162                          ) {
09163 
09164                     printf(<span class="stringliteral">"Succeeded\n"</span>);
09165 
09166                     printf(<span class="stringliteral">"      Primary Group is:   0x%lx\n"</span>,
09167                      (((USER_GENERAL_INFORMATION *)Buffer)-&gt;PrimaryGroupId) );
09168                     printf(<span class="stringliteral">"        User  Name is:    *%wZ*\n"</span>,
09169                      &amp;(((USER_GENERAL_INFORMATION *)Buffer)-&gt;UserName) );
09170                     printf(<span class="stringliteral">"        Full  Name is:    *%wZ*\n"</span>,
09171                      &amp;(((USER_GENERAL_INFORMATION *)Buffer)-&gt;FullName) );
09172                     printf(<span class="stringliteral">"     Admin Comment is:    *%wZ*\n"</span>,
09173                      &amp;(((USER_GENERAL_INFORMATION *)Buffer)-&gt;AdminComment) );
09174                     printf(<span class="stringliteral">"      User Comment is:    *%wZ*\n"</span>,
09175                      &amp;(((USER_GENERAL_INFORMATION *)Buffer)-&gt;UserComment) );
09176 
09177 
09178                 } <span class="keywordflow">else</span> {
09179                     printf(<span class="stringliteral">"Failed\n"</span>);
09180                     printf(<span class="stringliteral">"        One of the UNICODE_STRINGs  not returned.\n"</span>);
09181                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09182                 }
09183                 SamFreeMemory( Buffer );
09184             } <span class="keywordflow">else</span> {
09185                 printf(<span class="stringliteral">"Failed\n"</span>);
09186                 printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
09187                 printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
09188                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09189             }
09190         } <span class="keywordflow">else</span> {
09191             printf(<span class="stringliteral">"Failed\n"</span>);
09192             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
09193             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09194         }
09195         IgnoreStatus = SamCloseHandle( UserHandle1 );
09196         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
09197 
09198 
09199 
09200 
09201         printf(<span class="stringliteral">"      Query User Name Information . . . . . . . . . . . . .     "</span>);
09202 
09203 
09204         NtStatus = SamOpenUser(
09205                        DomainHandle,
09206                        USER_READ_GENERAL,
09207                        DOMAIN_USER_RID_ADMIN,
09208                        &amp;UserHandle1
09209                        );
09210         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
09211 
09212         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09213         NtStatus = SamQueryInformationUser(
09214                        UserHandle1,
09215                        UserNameInformation,
09216                        &amp;Buffer
09217                        );
09218         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
09219             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09220 
09221                 <span class="keywordflow">if</span> ( (((USER_NAME_INFORMATION *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;UserName.MaximumLength &gt; 0) &amp;&amp;
09222                      (((USER_NAME_INFORMATION *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;UserName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
09223                          ) {
09224 
09225                     printf(<span class="stringliteral">"Succeeded\n"</span>);
09226 
09227                     printf(<span class="stringliteral">"        User  Name is:    *%wZ*\n"</span>,
09228                      &amp;(((USER_NAME_INFORMATION *)Buffer)-&gt;UserName) );
09229                     printf(<span class="stringliteral">"        Full  Name is:    *%wZ*\n"</span>,
09230                      &amp;(((USER_NAME_INFORMATION *)Buffer)-&gt;FullName) );
09231 
09232 
09233 
09234                 } <span class="keywordflow">else</span> {
09235                     printf(<span class="stringliteral">"Failed\n"</span>);
09236                     printf(<span class="stringliteral">"        One of the UNICODE_STRINGs not returned.\n"</span>);
09237                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09238                 }
09239                 SamFreeMemory( Buffer );
09240             } <span class="keywordflow">else</span> {
09241                 printf(<span class="stringliteral">"Failed\n"</span>);
09242                 printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
09243                 printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
09244                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09245             }
09246         } <span class="keywordflow">else</span> {
09247             printf(<span class="stringliteral">"Failed\n"</span>);
09248             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
09249             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09250         }
09251         IgnoreStatus = SamCloseHandle( UserHandle1 );
09252         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
09253 
09254 
09255 
09256 
09257         printf(<span class="stringliteral">"      Query User Account Name Information . . . . . . . . .     "</span>);
09258 
09259 
09260         NtStatus = SamOpenUser(
09261                        DomainHandle,
09262                        USER_READ_GENERAL,
09263                        DOMAIN_USER_RID_ADMIN,
09264                        &amp;UserHandle1
09265                        );
09266         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
09267 
09268         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09269         NtStatus = SamQueryInformationUser(
09270                        UserHandle1,
09271                        UserAccountNameInformation,
09272                        &amp;Buffer
09273                        );
09274         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
09275             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09276 
09277                 <span class="keywordflow">if</span> ( (((USER_ACCOUNT_NAME_INFORMATION *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;UserName.MaximumLength &gt; 0) &amp;&amp;
09278                      (((USER_ACCOUNT_NAME_INFORMATION *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;UserName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
09279                          ) {
09280 
09281                     printf(<span class="stringliteral">"Succeeded\n"</span>);
09282 
09283                     printf(<span class="stringliteral">"        User  Name is:    *%wZ*\n"</span>,
09284                      &amp;(((USER_ACCOUNT_NAME_INFORMATION *)Buffer)-&gt;UserName) );
09285 
09286 
09287 
09288                 } <span class="keywordflow">else</span> {
09289                     printf(<span class="stringliteral">"Failed\n"</span>);
09290                     printf(<span class="stringliteral">"        UNICODE_STRING not returned.\n"</span>);
09291                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09292                 }
09293                 SamFreeMemory( Buffer );
09294             } <span class="keywordflow">else</span> {
09295                 printf(<span class="stringliteral">"Failed\n"</span>);
09296                 printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
09297                 printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
09298                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09299             }
09300         } <span class="keywordflow">else</span> {
09301             printf(<span class="stringliteral">"Failed\n"</span>);
09302             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
09303             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09304         }
09305         IgnoreStatus = SamCloseHandle( UserHandle1 );
09306         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
09307 
09308 
09309 
09310 
09311         printf(<span class="stringliteral">"      Query User Full Name Information  . . . . . . . . . .     "</span>);
09312 
09313 
09314         NtStatus = SamOpenUser(
09315                        DomainHandle,
09316                        USER_READ_GENERAL,
09317                        DOMAIN_USER_RID_ADMIN,
09318                        &amp;UserHandle1
09319                        );
09320         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
09321 
09322         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09323         NtStatus = SamQueryInformationUser(
09324                        UserHandle1,
09325                        UserFullNameInformation,
09326                        &amp;Buffer
09327                        );
09328         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
09329             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09330 
09331                 <span class="keywordflow">if</span> ( (((USER_FULL_NAME_INFORMATION *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;FullName.MaximumLength
09332                     &gt;= 0)
09333                          ) {
09334 
09335                     printf(<span class="stringliteral">"Succeeded\n"</span>);
09336 
09337                     printf(<span class="stringliteral">"        Full Name is:    *%wZ*\n"</span>,
09338                      &amp;(((USER_FULL_NAME_INFORMATION *)Buffer)-&gt;FullName) );
09339 
09340 
09341 
09342                 } <span class="keywordflow">else</span> {
09343                     printf(<span class="stringliteral">"Failed\n"</span>);
09344                     printf(<span class="stringliteral">"        UNICODE_STRING not returned.\n"</span>);
09345                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09346                 }
09347                 SamFreeMemory( Buffer );
09348             } <span class="keywordflow">else</span> {
09349                 printf(<span class="stringliteral">"Failed\n"</span>);
09350                 printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
09351                 printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
09352                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09353             }
09354         } <span class="keywordflow">else</span> {
09355             printf(<span class="stringliteral">"Failed\n"</span>);
09356             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
09357             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09358         }
09359         IgnoreStatus = SamCloseHandle( UserHandle1 );
09360         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
09361 
09362 
09363 
09364 
09365         printf(<span class="stringliteral">"      Query User  Admin Comment Information . . . . . . . .     "</span>);
09366 
09367 
09368         NtStatus = SamOpenUser(
09369                        DomainHandle,
09370                        USER_READ_GENERAL,
09371                        DOMAIN_USER_RID_ADMIN,
09372                        &amp;UserHandle1
09373                        );
09374         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
09375 
09376         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09377         NtStatus = SamQueryInformationUser(
09378                        UserHandle1,
09379                        UserAdminCommentInformation,
09380                        &amp;Buffer
09381                        );
09382         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
09383             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09384 
09385                 <span class="keywordflow">if</span> ( (((USER_ADMIN_COMMENT_INFORMATION *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;AdminComment.MaximumLength
09386                     &gt;= 0)
09387                          ) {
09388 
09389                     printf(<span class="stringliteral">"Succeeded\n"</span>);
09390 
09391                     printf(<span class="stringliteral">"     Admin Comment is:    *%wZ*\n"</span>,
09392                      &amp;(((USER_ADMIN_COMMENT_INFORMATION *)Buffer)-&gt;AdminComment) );
09393 
09394                 } <span class="keywordflow">else</span> {
09395                     printf(<span class="stringliteral">"Failed\n"</span>);
09396                     printf(<span class="stringliteral">"        User  Admin Comment not returned.\n"</span>);
09397                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09398                 }
09399                 SamFreeMemory( Buffer );
09400             } <span class="keywordflow">else</span> {
09401                 printf(<span class="stringliteral">"Failed\n"</span>);
09402                 printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
09403                 printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
09404                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09405             }
09406         } <span class="keywordflow">else</span> {
09407             printf(<span class="stringliteral">"Failed\n"</span>);
09408             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
09409             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09410         }
09411         IgnoreStatus = SamCloseHandle( UserHandle1 );
09412         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
09413 
09414 
09415 
09416 
09417         printf(<span class="stringliteral">"      Query User  Primary Group Information . . . . . . . .     "</span>);
09418 
09419 
09420         NtStatus = SamOpenUser(
09421                        DomainHandle,
09422                        USER_READ_GENERAL,
09423                        DOMAIN_USER_RID_ADMIN,
09424                        &amp;UserHandle1
09425                        );
09426         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
09427 
09428         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09429         NtStatus = SamQueryInformationUser(
09430                        UserHandle1,
09431                        UserPrimaryGroupInformation,
09432                        &amp;Buffer
09433                        );
09434         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
09435             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09436 
09437 
09438                 printf(<span class="stringliteral">"Succeeded\n"</span>);
09439 
09440                 printf(<span class="stringliteral">"     Primary Group  is:   0x%lx\n"</span>,
09441                  (((USER_PRIMARY_GROUP_INFORMATION *)Buffer)-&gt;PrimaryGroupId) );
09442 
09443                 SamFreeMemory( Buffer );
09444 
09445             } <span class="keywordflow">else</span> {
09446                 printf(<span class="stringliteral">"Failed\n"</span>);
09447                 printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
09448                 printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
09449                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09450             }
09451         } <span class="keywordflow">else</span> {
09452             printf(<span class="stringliteral">"Failed\n"</span>);
09453             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
09454             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09455         }
09456         IgnoreStatus = SamCloseHandle( UserHandle1 );
09457         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
09458 
09459 
09460 
09461 
09462         printf(<span class="stringliteral">"      Query User Control Information  . . . . . . . . . . .     "</span>);
09463 
09464 
09465         NtStatus = SamOpenUser(
09466                        DomainHandle,
09467                        USER_READ_ACCOUNT,
09468                        DOMAIN_USER_RID_ADMIN,
09469                        &amp;UserHandle1
09470                        );
09471         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
09472 
09473         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09474         NtStatus = SamQueryInformationUser(
09475                        UserHandle1,
09476                        UserControlInformation,
09477                        &amp;Buffer
09478                        );
09479         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
09480             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09481 
09482 
09483                 printf(<span class="stringliteral">"Succeeded\n"</span>);
09484 
09485                 printf(<span class="stringliteral">" Account Control is:      0x%lx\n"</span>,
09486                  (((USER_CONTROL_INFORMATION *)Buffer)-&gt;UserAccountControl) );
09487 
09488                 SamFreeMemory( Buffer );
09489 
09490 
09491             } <span class="keywordflow">else</span> {
09492                 printf(<span class="stringliteral">"Failed\n"</span>);
09493                 printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
09494                 printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
09495                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09496             }
09497         } <span class="keywordflow">else</span> {
09498             printf(<span class="stringliteral">"Failed\n"</span>);
09499             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
09500             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09501         }
09502         IgnoreStatus = SamCloseHandle( UserHandle1 );
09503         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
09504 
09505 
09506 
09507 
09508         printf(<span class="stringliteral">"      Query User Expiration Information . . . . . . . . . .     "</span>);
09509 
09510 
09511         NtStatus = SamOpenUser(
09512                        DomainHandle,
09513                        USER_READ_ACCOUNT,
09514                        DOMAIN_USER_RID_ADMIN,
09515                        &amp;UserHandle1
09516                        );
09517         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
09518 
09519         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09520         NtStatus = SamQueryInformationUser(
09521                        UserHandle1,
09522                        UserExpiresInformation,
09523                        &amp;Buffer
09524                        );
09525         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
09526             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09527 
09528 
09529                 printf(<span class="stringliteral">"Succeeded\n"</span>);
09530 
09531                 printf(<span class="stringliteral">" Account Expires on:      (0x%lx, 0x%lx)\n"</span>,
09532                  (((USER_EXPIRES_INFORMATION *)Buffer)-&gt;AccountExpires.HighPart),
09533                  (((USER_EXPIRES_INFORMATION *)Buffer)-&gt;AccountExpires.LowPart) );
09534 
09535                 SamFreeMemory( Buffer );
09536 
09537 
09538             } <span class="keywordflow">else</span> {
09539                 printf(<span class="stringliteral">"Failed\n"</span>);
09540                 printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
09541                 printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
09542                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09543             }
09544         } <span class="keywordflow">else</span> {
09545             printf(<span class="stringliteral">"Failed\n"</span>);
09546             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
09547             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09548         }
09549         IgnoreStatus = SamCloseHandle( UserHandle1 );
09550         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
09551 
09552 
09553         printf(<span class="stringliteral">"      Query User Preferences Information  . . . . . . . . .     "</span>);
09554 
09555 
09556         NtStatus = SamOpenUser(
09557                        DomainHandle,
09558                        USER_READ_PREFERENCES | USER_READ_GENERAL,
09559                        DOMAIN_USER_RID_ADMIN,
09560                        &amp;UserHandle1
09561                        );
09562         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
09563 
09564         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09565         NtStatus = SamQueryInformationUser(
09566                        UserHandle1,
09567                        UserPreferencesInformation,
09568                        &amp;Buffer
09569                        );
09570         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
09571             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09572 
09573                 <span class="keywordflow">if</span> ( (((USER_PREFERENCES_INFORMATION *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;UserComment.MaximumLength
09574                     &gt;= 0)
09575                          ) {
09576 
09577                     printf(<span class="stringliteral">"Succeeded\n"</span>);
09578 
09579                     printf(<span class="stringliteral">"     User Comment  is:    *%wZ*\n"</span>,
09580                      &amp;(((USER_PREFERENCES_INFORMATION *)Buffer)-&gt;UserComment) );
09581 
09582                 } <span class="keywordflow">else</span> {
09583                     printf(<span class="stringliteral">"Failed\n"</span>);
09584                     printf(<span class="stringliteral">"        One of the UNICODE_STRINGs not returned.\n"</span>);
09585                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09586                 }
09587                 SamFreeMemory( Buffer );
09588             } <span class="keywordflow">else</span> {
09589                 printf(<span class="stringliteral">"Failed\n"</span>);
09590                 printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
09591                 printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
09592                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09593             }
09594         } <span class="keywordflow">else</span> {
09595             printf(<span class="stringliteral">"Failed\n"</span>);
09596             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
09597             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09598         }
09599         IgnoreStatus = SamCloseHandle( UserHandle1 );
09600         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
09601 
09602 
09603 
09604 
09605 
09606         printf(<span class="stringliteral">"      Query User Home Directory Information . . . . . . . .     "</span>);
09607 
09608 
09609         NtStatus = SamOpenUser(
09610                        DomainHandle,
09611                        USER_READ_LOGON,
09612                        DOMAIN_USER_RID_ADMIN,
09613                        &amp;UserHandle1
09614                        );
09615         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
09616 
09617         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09618         NtStatus = SamQueryInformationUser(
09619                        UserHandle1,
09620                        UserHomeInformation,
09621                        &amp;Buffer
09622                        );
09623         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
09624             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09625 
09626                 <span class="keywordflow">if</span> ( (((USER_HOME_INFORMATION *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;HomeDirectory.MaximumLength
09627                     &gt;= 0) &amp;&amp;
09628                      (((USER_HOME_INFORMATION *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;HomeDirectoryDrive.MaximumLength
09629                      &gt;= 0)
09630                          ) {
09631 
09632                     printf(<span class="stringliteral">"Succeeded\n"</span>);
09633 
09634                     printf(<span class="stringliteral">"    Home Directory is:    *%wZ*\n"</span>,
09635                      &amp;(((USER_HOME_INFORMATION *)Buffer)-&gt;HomeDirectory) );
09636                     printf(<span class="stringliteral">"    Home Directory Drive is:    *%wZ*\n"</span>,
09637                      &amp;(((USER_HOME_INFORMATION *)Buffer)-&gt;HomeDirectoryDrive) );
09638 
09639 
09640                 } <span class="keywordflow">else</span> {
09641                     printf(<span class="stringliteral">"Failed\n"</span>);
09642                     printf(<span class="stringliteral">"        String not returned.\n"</span>);
09643                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09644                 }
09645                 SamFreeMemory( Buffer );
09646             } <span class="keywordflow">else</span> {
09647                 printf(<span class="stringliteral">"Failed\n"</span>);
09648                 printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
09649                 printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
09650                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09651             }
09652         } <span class="keywordflow">else</span> {
09653             printf(<span class="stringliteral">"Failed\n"</span>);
09654             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
09655             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09656         }
09657         IgnoreStatus = SamCloseHandle( UserHandle1 );
09658         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
09659 
09660 
09661 
09662 
09663         printf(<span class="stringliteral">"      Query User Script Path Information  . . . . . . . . .     "</span>);
09664 
09665 
09666         NtStatus = SamOpenUser(
09667                        DomainHandle,
09668                        USER_READ_LOGON,
09669                        DOMAIN_USER_RID_ADMIN,
09670                        &amp;UserHandle1
09671                        );
09672         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
09673 
09674         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09675         NtStatus = SamQueryInformationUser(
09676                        UserHandle1,
09677                        UserScriptInformation,
09678                        &amp;Buffer
09679                        );
09680         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
09681             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09682 
09683                 <span class="keywordflow">if</span> ( (((USER_SCRIPT_INFORMATION *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;ScriptPath.MaximumLength
09684                     &gt;= 0)
09685                          ) {
09686 
09687                     printf(<span class="stringliteral">"Succeeded\n"</span>);
09688 
09689                     printf(<span class="stringliteral">"      Script Path  is:    *%wZ*\n"</span>,
09690                      &amp;(((USER_SCRIPT_INFORMATION *)Buffer)-&gt;ScriptPath) );
09691 
09692 
09693                 } <span class="keywordflow">else</span> {
09694                     printf(<span class="stringliteral">"Failed\n"</span>);
09695                     printf(<span class="stringliteral">"        String not returned.\n"</span>);
09696                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09697                 }
09698                 SamFreeMemory( Buffer );
09699             } <span class="keywordflow">else</span> {
09700                 printf(<span class="stringliteral">"Failed\n"</span>);
09701                 printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
09702                 printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
09703                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09704             }
09705         } <span class="keywordflow">else</span> {
09706             printf(<span class="stringliteral">"Failed\n"</span>);
09707             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
09708             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09709         }
09710         IgnoreStatus = SamCloseHandle( UserHandle1 );
09711         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
09712 
09713 
09714 
09715         printf(<span class="stringliteral">"      Query User ProfilePath Information  . . . . . . . . .     "</span>);
09716 
09717 
09718         NtStatus = SamOpenUser(
09719                        DomainHandle,
09720                        USER_READ_LOGON,
09721                        DOMAIN_USER_RID_ADMIN,
09722                        &amp;UserHandle1
09723                        );
09724         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
09725 
09726         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09727         NtStatus = SamQueryInformationUser(
09728                        UserHandle1,
09729                        UserProfileInformation,
09730                        &amp;Buffer
09731                        );
09732         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
09733             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09734 
09735                 <span class="keywordflow">if</span> ( (((USER_PROFILE_INFORMATION *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;ProfilePath.MaximumLength
09736                     &gt;= 0)
09737                          ) {
09738 
09739                     printf(<span class="stringliteral">"Succeeded\n"</span>);
09740 
09741                     printf(<span class="stringliteral">"      Profile Path  is:    *%wZ*\n"</span>,
09742                      &amp;(((USER_PROFILE_INFORMATION *)Buffer)-&gt;ProfilePath) );
09743 
09744 
09745                 } <span class="keywordflow">else</span> {
09746                     printf(<span class="stringliteral">"Failed\n"</span>);
09747                     printf(<span class="stringliteral">"        String not returned.\n"</span>);
09748                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09749                 }
09750                 SamFreeMemory( Buffer );
09751             } <span class="keywordflow">else</span> {
09752                 printf(<span class="stringliteral">"Failed\n"</span>);
09753                 printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
09754                 printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
09755                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09756             }
09757         } <span class="keywordflow">else</span> {
09758             printf(<span class="stringliteral">"Failed\n"</span>);
09759             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
09760             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09761         }
09762         IgnoreStatus = SamCloseHandle( UserHandle1 );
09763         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
09764 
09765 
09766 
09767         printf(<span class="stringliteral">"      Query User Logon Information  . . . . . . . . . . . .     "</span>);
09768 
09769 
09770         NtStatus = SamOpenUser(
09771                        DomainHandle,
09772                        USER_READ_ACCOUNT | USER_READ_GENERAL | USER_READ_PREFERENCES | USER_READ_LOGON,
09773                        DOMAIN_USER_RID_ADMIN,
09774                        &amp;UserHandle1
09775                        );
09776         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
09777 
09778         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09779         NtStatus = SamQueryInformationUser(
09780                        UserHandle1,
09781                        UserLogonInformation,
09782                        &amp;Buffer
09783                        );
09784         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
09785             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09786 
09787                 <span class="keywordflow">if</span> ( (((USER_LOGON_INFORMATION *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;UserName.MaximumLength &gt; 0)       &amp;&amp;
09788                      (((USER_LOGON_INFORMATION *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;UserName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
09789                          ) {
09790 
09791                     printf(<span class="stringliteral">"Succeeded\n"</span>);
09792 
09793                     printf(<span class="stringliteral">"          User RID is:    0x%lx\n"</span>,
09794                      (((USER_LOGON_INFORMATION *)Buffer)-&gt;UserId) );
09795                     printf(<span class="stringliteral">"     Primary Group is:    0x%lx\n"</span>,
09796                      (((USER_LOGON_INFORMATION *)Buffer)-&gt;PrimaryGroupId) );
09797                     printf(<span class="stringliteral">"      Logon Units are:    0x%lx\n"</span>,
09798                      (((USER_LOGON_INFORMATION *)Buffer)-&gt;LogonHours.UnitsPerWeek) );
09799                     printf(<span class="stringliteral">"     Bad PWD count is:    0x%lx\n"</span>,
09800                      (((USER_LOGON_INFORMATION *)Buffer)-&gt;BadPasswordCount) );
09801                     printf(<span class="stringliteral">"       Logon count is:    0x%lx\n"</span>,
09802                      (((USER_LOGON_INFORMATION *)Buffer)-&gt;LogonCount) );
09803 
09804                     printf(<span class="stringliteral">"        last Logon is:    (0x%lx, 0x%lx)\n"</span>,
09805                      (((USER_LOGON_INFORMATION *)Buffer)-&gt;LastLogon.HighPart),
09806                      (((USER_LOGON_INFORMATION *)Buffer)-&gt;LastLogon.LowPart)  );
09807                     printf(<span class="stringliteral">"       last Logoff is:    (0x%lx, 0x%lx)\n"</span>,
09808                      (((USER_LOGON_INFORMATION *)Buffer)-&gt;LastLogoff.HighPart),
09809                      (((USER_LOGON_INFORMATION *)Buffer)-&gt;LastLogoff.LowPart)  );
09810 
09811 
09812                     printf(<span class="stringliteral">"        User  Name is:    *%wZ*\n"</span>,
09813                      &amp;(((USER_LOGON_INFORMATION *)Buffer)-&gt;UserName) );
09814                     printf(<span class="stringliteral">"        Full  Name is:    *%wZ*\n"</span>,
09815                      &amp;(((USER_LOGON_INFORMATION *)Buffer)-&gt;FullName) );
09816                     printf(<span class="stringliteral">"          Home Dir is:    *%wZ*\n"</span>,
09817                      &amp;(((USER_LOGON_INFORMATION *)Buffer)-&gt;HomeDirectory) );
09818                     printf(<span class="stringliteral">"    Home Dir Drive is:    *%wZ*\n"</span>,
09819                      &amp;(((USER_LOGON_INFORMATION *)Buffer)-&gt;HomeDirectoryDrive) );
09820                     printf(<span class="stringliteral">"      Script Path  is:    *%wZ*\n"</span>,
09821                      &amp;(((USER_LOGON_INFORMATION *)Buffer)-&gt;ScriptPath) );
09822                     printf(<span class="stringliteral">"      Profile Path is:    *%wZ*\n"</span>,
09823                      &amp;(((USER_LOGON_INFORMATION *)Buffer)-&gt;ProfilePath) );
09824                     printf(<span class="stringliteral">"     WorkStations are:    *%wZ*\n"</span>,
09825                      &amp;(((USER_LOGON_INFORMATION *)Buffer)-&gt;WorkStations) );
09826 
09827 
09828 
09829 
09830                 } <span class="keywordflow">else</span> {
09831                     printf(<span class="stringliteral">"Failed\n"</span>);
09832                     printf(<span class="stringliteral">"        One of the UNICODE_STRINGs  not returned.\n"</span>);
09833                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09834                 }
09835                 SamFreeMemory( Buffer );
09836             } <span class="keywordflow">else</span> {
09837                 printf(<span class="stringliteral">"Failed\n"</span>);
09838                 printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
09839                 printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
09840                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09841             }
09842         } <span class="keywordflow">else</span> {
09843             printf(<span class="stringliteral">"Failed\n"</span>);
09844             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
09845             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09846         }
09847         IgnoreStatus = SamCloseHandle( UserHandle1 );
09848         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
09849 
09850 
09851 
09852 
09853         printf(<span class="stringliteral">"      Query User Logon Hours  . . . . . . . . . . . . . . .     "</span>);
09854 
09855 
09856         NtStatus = SamOpenUser(
09857                        DomainHandle,
09858                        USER_READ_LOGON,
09859                        DOMAIN_USER_RID_ADMIN,
09860                        &amp;UserHandle1
09861                        );
09862         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
09863 
09864         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09865         NtStatus = SamQueryInformationUser(
09866                        UserHandle1,
09867                        UserLogonHoursInformation,
09868                        &amp;Buffer
09869                        );
09870         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
09871             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09872 
09873                 printf(<span class="stringliteral">"Succeeded\n"</span>);
09874 
09875                 printf(<span class="stringliteral">"      Logon Units are:    0x%lx\n"</span>,
09876                  (((USER_LOGON_HOURS_INFORMATION *)Buffer)-&gt;LogonHours.UnitsPerWeek) );
09877 
09878 
09879                 SamFreeMemory( Buffer );
09880 
09881             } <span class="keywordflow">else</span> {
09882                 printf(<span class="stringliteral">"Failed\n"</span>);
09883                 printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
09884                 printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
09885                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09886             }
09887         } <span class="keywordflow">else</span> {
09888             printf(<span class="stringliteral">"Failed\n"</span>);
09889             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
09890             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09891         }
09892         IgnoreStatus = SamCloseHandle( UserHandle1 );
09893         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
09894 
09895 
09896 
09897 
09898         printf(<span class="stringliteral">"      Query Account Information . . . . . . . . . . . . . .     "</span>);
09899 
09900         NtStatus = SamOpenUser(
09901                        DomainHandle,
09902                        USER_READ_GENERAL | USER_READ_PREFERENCES |
09903                        USER_READ_LOGON   | USER_READ_ACCOUNT,
09904                        DOMAIN_USER_RID_ADMIN,
09905                        &amp;UserHandle1
09906                        );
09907         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
09908 
09909         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09910         NtStatus = SamQueryInformationUser(
09911                        UserHandle1,
09912                        UserAccountInformation,
09913                        &amp;Buffer
09914                        );
09915         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
09916             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09917 
09918                 <span class="keywordflow">if</span> ( (((USER_ACCOUNT_INFORMATION *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;UserName.MaximumLength &gt; 0)       &amp;&amp;
09919                      (((USER_ACCOUNT_INFORMATION *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;UserName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
09920                          ) {
09921 
09922                     printf(<span class="stringliteral">"Succeeded\n"</span>);
09923 
09924                     printf(<span class="stringliteral">"          User RID is:    0x%lx\n"</span>,
09925                      (((USER_ACCOUNT_INFORMATION *)Buffer)-&gt;UserId) );
09926                     printf(<span class="stringliteral">"     Primary Group is:    0x%lx\n"</span>,
09927                      (((USER_ACCOUNT_INFORMATION *)Buffer)-&gt;PrimaryGroupId) );
09928                     printf(<span class="stringliteral">"      Logon Units are:    0x%lx\n"</span>,
09929                      (((USER_ACCOUNT_INFORMATION *)Buffer)-&gt;LogonHours.UnitsPerWeek) );
09930                     printf(<span class="stringliteral">"     Bad PWD count is:    0x%lx\n"</span>,
09931                      (((USER_ACCOUNT_INFORMATION *)Buffer)-&gt;BadPasswordCount) );
09932                     printf(<span class="stringliteral">"       Logon count is:    0x%lx\n"</span>,
09933                      (((USER_ACCOUNT_INFORMATION *)Buffer)-&gt;LogonCount) );
09934                     printf(<span class="stringliteral">"      Account Ctrl is:    0x%lx\n"</span>,
09935                      (((USER_ACCOUNT_INFORMATION *)Buffer)-&gt;UserAccountControl) );
09936 
09937                     printf(<span class="stringliteral">"        last Logon is:    (0x%lx, 0x%lx)\n"</span>,
09938                      (((USER_ACCOUNT_INFORMATION *)Buffer)-&gt;LastLogon.HighPart),
09939                      (((USER_ACCOUNT_INFORMATION *)Buffer)-&gt;LastLogon.LowPart)  );
09940                     printf(<span class="stringliteral">"       last Logoff is:    (0x%lx, 0x%lx)\n"</span>,
09941                      (((USER_ACCOUNT_INFORMATION *)Buffer)-&gt;LastLogoff.HighPart),
09942                      (((USER_ACCOUNT_INFORMATION *)Buffer)-&gt;LastLogoff.LowPart)  );
09943                     printf(<span class="stringliteral">"      Pwd Last Set is:    (0x%lx, 0x%lx)\n"</span>,
09944                      (((USER_ACCOUNT_INFORMATION *)Buffer)-&gt;PasswordLastSet.HighPart),
09945                      (((USER_ACCOUNT_INFORMATION *)Buffer)-&gt;PasswordLastSet.LowPart)  );
09946                     printf(<span class="stringliteral">"   Account Expires is:    (0x%lx, 0x%lx)\n"</span>,
09947                      (((USER_ACCOUNT_INFORMATION *)Buffer)-&gt;AccountExpires.HighPart),
09948                      (((USER_ACCOUNT_INFORMATION *)Buffer)-&gt;AccountExpires.LowPart)  );
09949 
09950 
09951                     printf(<span class="stringliteral">"        User  Name is:    *%wZ*\n"</span>,
09952                      &amp;(((USER_ACCOUNT_INFORMATION *)Buffer)-&gt;UserName) );
09953                     printf(<span class="stringliteral">"        Full  Name is:    *%wZ*\n"</span>,
09954                      &amp;(((USER_ACCOUNT_INFORMATION *)Buffer)-&gt;FullName) );
09955                     printf(<span class="stringliteral">"          Home Dir is:    *%wZ*\n"</span>,
09956                      &amp;(((USER_ACCOUNT_INFORMATION *)Buffer)-&gt;HomeDirectory) );
09957                     printf(<span class="stringliteral">"    Home Dir Drive is:    *%wZ*\n"</span>,
09958                      &amp;(((USER_ACCOUNT_INFORMATION *)Buffer)-&gt;HomeDirectoryDrive) );
09959                     printf(<span class="stringliteral">"      Script Path  is:    *%wZ*\n"</span>,
09960                      &amp;(((USER_ACCOUNT_INFORMATION *)Buffer)-&gt;ScriptPath) );
09961                     printf(<span class="stringliteral">"     Profile Path  is:    *%wZ*\n"</span>,
09962                      &amp;(((USER_ACCOUNT_INFORMATION *)Buffer)-&gt;ProfilePath) );
09963                     printf(<span class="stringliteral">"     Admin Comment is:    *%wZ*\n"</span>,
09964                      &amp;(((USER_ACCOUNT_INFORMATION *)Buffer)-&gt;AdminComment) );
09965                     printf(<span class="stringliteral">"     WorkStations are:    *%wZ*\n"</span>,
09966                      &amp;(((USER_ACCOUNT_INFORMATION *)Buffer)-&gt;WorkStations) );
09967 
09968 
09969 
09970                 } <span class="keywordflow">else</span> {
09971                     printf(<span class="stringliteral">"Failed\n"</span>);
09972                     printf(<span class="stringliteral">"        One of the UNICODE_STRINGs  not returned.\n"</span>);
09973                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09974                 }
09975                 SamFreeMemory( Buffer );
09976             } <span class="keywordflow">else</span> {
09977                 printf(<span class="stringliteral">"Failed\n"</span>);
09978                 printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
09979                 printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
09980                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09981             }
09982         } <span class="keywordflow">else</span> {
09983             printf(<span class="stringliteral">"Failed\n"</span>);
09984             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
09985             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09986         }
09987         IgnoreStatus = SamCloseHandle( UserHandle1 );
09988         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
09989 
09990 
09991 
09992 
09993 
09994 
09995 
09996 
09997         printf(<span class="stringliteral">"      Query Workstations Information  . . . . . . . . . . .     "</span>);
09998 
09999         NtStatus = SamOpenUser(
10000                        DomainHandle,
10001                        USER_READ_LOGON,
10002                        DOMAIN_USER_RID_ADMIN,
10003                        &amp;UserHandle1
10004                        );
10005         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
10006 
10007         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
10008         NtStatus = SamQueryInformationUser(
10009                        UserHandle1,
10010                        UserWorkStationsInformation,
10011                        &amp;Buffer
10012                        );
10013         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
10014             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
10015 
10016                 <span class="keywordflow">if</span> ( (((USER_WORKSTATIONS_INFORMATION *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;WorkStations.MaximumLength
10017                     &gt;= 0)
10018                          ) {
10019 
10020                     printf(<span class="stringliteral">"Succeeded\n"</span>);
10021 
10022                     printf(<span class="stringliteral">"      Workstations is:    *%wZ*\n"</span>,
10023                      &amp;(((USER_WORKSTATIONS_INFORMATION *)Buffer)-&gt;WorkStations) );
10024 
10025 
10026                 } <span class="keywordflow">else</span> {
10027                     printf(<span class="stringliteral">"Failed\n"</span>);
10028                     printf(<span class="stringliteral">"        String not returned.\n"</span>);
10029                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
10030                 }
10031                 SamFreeMemory( Buffer );
10032             } <span class="keywordflow">else</span> {
10033                 printf(<span class="stringliteral">"Failed\n"</span>);
10034                 printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
10035                 printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
10036                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
10037             }
10038         } <span class="keywordflow">else</span> {
10039             printf(<span class="stringliteral">"Failed\n"</span>);
10040             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
10041             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
10042         }
10043         IgnoreStatus = SamCloseHandle( UserHandle1 );
10044         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
10045 
10046 
10047 
10048 
10049 
10050         printf(<span class="stringliteral">"      Query Internal1 Information  . . . . . . . . . . .     "</span>);
10051 
10052         NtStatus = SamOpenUser(
10053                        DomainHandle,
10054                        USER_READ_LOGON,
10055                        DOMAIN_USER_RID_ADMIN,
10056                        &amp;UserHandle1
10057                        );
10058         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
10059 
10060         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
10061         NtStatus = SamQueryInformationUser(
10062                        UserHandle1,
10063                        UserInternal1Information,
10064                        &amp;Buffer
10065                        );
10066 
10067         <span class="keywordflow">if</span> ( NtStatus == STATUS_INVALID_INFO_CLASS ) {
10068 
10069             <span class="comment">//</span>
10070             <span class="comment">// We're not a trusted client, so we expected this to fail.</span>
10071             <span class="comment">//</span>
10072 
10073             printf(<span class="stringliteral">"Succeeded\n"</span>);
10074 
10075         } <span class="keywordflow">else</span> {
10076 
10077             printf(<span class="stringliteral">"Failed\n"</span>);
10078             printf(<span class="stringliteral">"        Status was %lx.\n"</span>, NtStatus );
10079             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
10080             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( NtStatus ) ) {
10081 
10082                 SamFreeMemory( Buffer );
10083             }
10084         }
10085 
10086 <span class="comment">// This is the code that USED to test this function, when it was allowed</span>
10087 <span class="comment">// for non-trusted clients.</span>
10088 <span class="comment">//</span>
10089 <span class="comment">//        if (NT_SUCCESS(NtStatus)) {</span>
10090 <span class="comment">//            if (Buffer != NULL) {</span>
10091 <span class="comment">//</span>
10092 <span class="comment">//                if ( (((USER_INTERNAL1_INFORMATION *)Buffer)-&gt;CaseInsensitiveDbcs.MaximumLength &gt; 0) &amp;&amp;</span>
10093 <span class="comment">//                     (((USER_INTERNAL1_INFORMATION *)Buffer)-&gt;CaseInsensitiveDbcs.Buffer != NULL) &amp;&amp;</span>
10094 <span class="comment">//                     (((USER_INTERNAL1_INFORMATION *)Buffer)-&gt;CaseSensitiveUnicode.MaximumLength &gt; 0) &amp;&amp;</span>
10095 <span class="comment">//                     (((USER_INTERNAL1_INFORMATION *)Buffer)-&gt;CaseSensitiveUnicode.Buffer != NULL)</span>
10096 <span class="comment">//                         ) {</span>
10097 <span class="comment">//</span>
10098 <span class="comment">//                     printf("Succeeded\n");</span>
10099 <span class="comment">//</span>
10100 <span class="comment">//                     //</span>
10101 <span class="comment">//                     // Print them out as strings, even though they've been</span>
10102 <span class="comment">//                     // through a OWF.</span>
10103 <span class="comment">//                     //</span>
10104 <span class="comment">//</span>
10105 <span class="comment">//                     printf("      CaseInsensitiveDbcs is:    *%s*\n",</span>
10106 <span class="comment">//                      &amp;(((USER_INTERNAL1_INFORMATION *)Buffer)-&gt;CaseInsensitiveDbcs) );</span>
10107 <span class="comment">//</span>
10108 <span class="comment">//                     printf("      CaseSensitiveUnicode is:    *%s*\n",</span>
10109 <span class="comment">//                      &amp;(((USER_INTERNAL1_INFORMATION *)Buffer)-&gt;CaseSensitiveUnicode) );</span>
10110 <span class="comment">//</span>
10111 <span class="comment">//</span>
10112 <span class="comment">//                } else {</span>
10113 <span class="comment">//                    printf("Failed\n");</span>
10114 <span class="comment">//                    printf("        One of the strings not returned.\n");</span>
10115 <span class="comment">//                    TestStatus = FALSE;</span>
10116 <span class="comment">//                }</span>
10117 <span class="comment">//                SamFreeMemory( Buffer );</span>
10118 <span class="comment">//            } else {</span>
10119 <span class="comment">//                printf("Failed\n");</span>
10120 <span class="comment">//                printf("        Buffer address not set on return.\n");</span>
10121 <span class="comment">//                printf("        RPC should have allocated a buffer.\n");</span>
10122 <span class="comment">//                TestStatus = FALSE;</span>
10123 <span class="comment">//            }</span>
10124 <span class="comment">//        } else {</span>
10125 <span class="comment">//            printf("Failed\n");</span>
10126 <span class="comment">//            printf("        Completion status is 0x%lx\n", NtStatus);</span>
10127 <span class="comment">//            TestStatus = FALSE;</span>
10128 <span class="comment">//        }</span>
10129 
10130         IgnoreStatus = SamCloseHandle( UserHandle1 );
10131         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
10132 
10133 
10134 
10135 
10136 
10137         printf(<span class="stringliteral">"      Query Internal2 Information  . . . . . . . . . . .     "</span>);
10138 
10139         NtStatus = SamOpenUser(
10140                        DomainHandle,
10141                        USER_READ_LOGON,
10142                        DOMAIN_USER_RID_ADMIN,
10143                        &amp;UserHandle1
10144                        );
10145         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
10146 
10147         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
10148         NtStatus = SamQueryInformationUser(
10149                        UserHandle1,
10150                        UserInternal2Information,
10151                        &amp;Buffer
10152                        );
10153 
10154         <span class="keywordflow">if</span> ( NtStatus == STATUS_INVALID_INFO_CLASS ) {
10155 
10156             <span class="comment">//</span>
10157             <span class="comment">// We're not a trusted client, so we don't expect to be able</span>
10158             <span class="comment">// to do this.</span>
10159             <span class="comment">//</span>
10160 
10161             printf(<span class="stringliteral">"Succeeded.\n"</span>);
10162 
10163         } <span class="keywordflow">else</span> {
10164 
10165             printf(<span class="stringliteral">"Failed\n"</span>);
10166             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
10167             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
10168             SamFreeMemory( Buffer );
10169         }
10170 
10171 <span class="comment">// This is the code that USED to test this function, when non-trusted</span>
10172 <span class="comment">// clients were allowed to do this...</span>
10173 <span class="comment">//</span>
10174 <span class="comment">//        if (NT_SUCCESS(NtStatus)) {</span>
10175 <span class="comment">//            if (Buffer != NULL) {</span>
10176 <span class="comment">//</span>
10177 <span class="comment">//                printf("Succeeded\n");</span>
10178 <span class="comment">//</span>
10179 <span class="comment">//                printf("        last Logon is:    (0x%lx, 0x%lx)\n",</span>
10180 <span class="comment">//                 (((USER_INTERNAL2_INFORMATION *)Buffer)-&gt;LastLogon.HighPart),</span>
10181 <span class="comment">//                 (((USER_INTERNAL2_INFORMATION *)Buffer)-&gt;LastLogon.LowPart)  );</span>
10182 <span class="comment">//                printf("       last Logoff is:    (0x%lx, 0x%lx)\n",</span>
10183 <span class="comment">//                 (((USER_INTERNAL2_INFORMATION *)Buffer)-&gt;LastLogoff.HighPart),</span>
10184 <span class="comment">//                 (((USER_INTERNAL2_INFORMATION *)Buffer)-&gt;LastLogoff.LowPart)  );</span>
10185 <span class="comment">//                printf("       BadPwdCount is:    (0x%x)\n",</span>
10186 <span class="comment">//                 ((USER_INTERNAL2_INFORMATION *)Buffer)-&gt;BadPasswordCount );</span>
10187 <span class="comment">//                printf("       LogonCount  is:    (0x%x)\n",</span>
10188 <span class="comment">//                 ((USER_INTERNAL2_INFORMATION *)Buffer)-&gt;LogonCount );</span>
10189 <span class="comment">//</span>
10190 <span class="comment">//                SamFreeMemory( Buffer );</span>
10191 <span class="comment">//            } else {</span>
10192 <span class="comment">//                printf("Failed\n");</span>
10193 <span class="comment">//                printf("        Buffer address not set on return.\n");</span>
10194 <span class="comment">//                printf("        RPC should have allocated a buffer.\n");</span>
10195 <span class="comment">//                TestStatus = FALSE;</span>
10196 <span class="comment">//            }</span>
10197 <span class="comment">//        } else {</span>
10198 <span class="comment">//            printf("Failed\n");</span>
10199 <span class="comment">//            printf("        Completion status is 0x%lx\n", NtStatus);</span>
10200 <span class="comment">//            TestStatus = FALSE;</span>
10201 <span class="comment">//        }</span>
10202 
10203         IgnoreStatus = SamCloseHandle( UserHandle1 );
10204         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
10205 
10206 
10207 
10208 
10209 
10210         printf(<span class="stringliteral">"      Query Set Password Information  . . . . . . . . . . .     "</span>);
10211 
10212 
10213 
10214 
10215         NtStatus = SamOpenUser(
10216                        DomainHandle,
10217                        USER_READ_LOGON,
10218                        DOMAIN_USER_RID_ADMIN,
10219                        &amp;UserHandle1
10220                        );
10221         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
10222 
10223         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
10224         NtStatus = SamQueryInformationUser(
10225                        UserHandle1,
10226                        UserSetPasswordInformation,
10227                        &amp;Buffer
10228                        );
10229         <span class="keywordflow">if</span> (NtStatus == STATUS_INVALID_INFO_CLASS ) {
10230 
10231             printf(<span class="stringliteral">"Succeeded\n"</span>);
10232 
10233         } <span class="keywordflow">else</span> {
10234             printf(<span class="stringliteral">"Failed\n"</span>);
10235             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
10236             printf(<span class="stringliteral">"        Expected 0x%lx (INVALID_INFO_CLASS)\n"</span>, STATUS_INVALID_INFO_CLASS);
10237             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
10238         }
10239         IgnoreStatus = SamCloseHandle( UserHandle1 );
10240         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
10241 
10242 
10243 
10244 
10246         <span class="comment">//                                                                       //</span>
10247         <span class="comment">// Get Groups For User Suite                                             //</span>
10248         <span class="comment">//                                                                       //</span>
10250 <span class="comment"></span>
10251         printf(<span class="stringliteral">"\n"</span>);
10252         printf(<span class="stringliteral">"    Get Groups For User . . . . . . . . . . . . . . . . .   Suite\n"</span>);
10253 
10254         printf(<span class="stringliteral">"      Get Groups For Well-Known Account . . . . . . . . . .     "</span>);
10255 
10256         NtStatus = SamOpenUser(
10257                        DomainHandle,
10258                        USER_LIST_GROUPS,
10259                        DOMAIN_USER_RID_ADMIN,
10260                        &amp;UserHandle1
10261                        );
10262         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
10263 
10264         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
10265         NtStatus = SamGetGroupsForUser(
10266                        UserHandle1,
10267                        (PGROUP_MEMBERSHIP *)&amp;Buffer,
10268                        &amp;MembershipCount
10269                        );
10270         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
10271             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
10272 
10273                 printf(<span class="stringliteral">"Succeeded\n"</span>);
10274 
10275 
10276                 printf(<span class="stringliteral">"          Member of:    %d groups\n"</span>, MembershipCount);
10277                 <span class="keywordflow">for</span> ( i=0; i&lt;MembershipCount; i++) {
10278 
10279                     printf(<span class="stringliteral">"      Group[%d] Rid/Attributes:      0x%lx/0x%lx\n"</span>,
10280                         i,
10281                         (((PGROUP_MEMBERSHIP)Buffer)[i].RelativeId),
10282                         (((PGROUP_MEMBERSHIP)Buffer)[i].Attributes)
10283                         );
10284 
10285                 }
10286 
10287                 SamFreeMemory( Buffer );
10288 
10289 
10290             } <span class="keywordflow">else</span> {
10291                 printf(<span class="stringliteral">"Failed\n"</span>);
10292                 printf(<span class="stringliteral">"        Buffer address not set on return.\n"</span>);
10293                 printf(<span class="stringliteral">"        RPC should have allocated a buffer.\n"</span>);
10294                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
10295             }
10296         } <span class="keywordflow">else</span> {
10297             printf(<span class="stringliteral">"Failed\n"</span>);
10298             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
10299             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
10300         }
10301         IgnoreStatus = SamCloseHandle( UserHandle1 );
10302         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
10303 
10304 
10305 
10307         <span class="comment">//                                                                       //</span>
10308         <span class="comment">// Set User Suite                                                        //</span>
10309         <span class="comment">//                                                                       //</span>
10311 <span class="comment"></span>
10312         printf(<span class="stringliteral">"\n"</span>);
10313         printf(<span class="stringliteral">"    Set User  . . . . . . . . . . . . . . . . . . . . . .   Suite\n"</span>);
10314 
10315         printf(<span class="stringliteral">"      Set General Information . . . . . . . . . . . . . . .     "</span>);
10316         NtStatus = SamOpenUser(
10317                        DomainHandle,
10318                        USER_ALL_ACCESS,
10319                        DOMAIN_USER_RID_ADMIN,
10320                        &amp;UserHandle1
10321                        );
10322         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
10323 
10324         <span class="comment">//</span>
10325         <span class="comment">// Make the parameter marshallable, but don't worry about values.</span>
10326         <span class="comment">//</span>
10327 
10328         GeneralInformation.UserName = DummyName1;
10329         GeneralInformation.FullName = DummyName1;
10330         GeneralInformation.AdminComment = DummyName1;
10331         GeneralInformation.UserComment  = DummyName1;
10332 
10333         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = &amp;GeneralInformation;
10334         NtStatus = SamSetInformationUser(
10335                        UserHandle1,
10336                        UserGeneralInformation,
10337                        Buffer
10338                        );
10339         <span class="keywordflow">if</span> (NtStatus == STATUS_INVALID_INFO_CLASS ) {
10340 
10341             printf(<span class="stringliteral">"Succeeded\n"</span>);
10342 
10343         } <span class="keywordflow">else</span> {
10344             printf(<span class="stringliteral">"Failed\n"</span>);
10345             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
10346             printf(<span class="stringliteral">"        Expected 0x%lx (INVALID_INFO_CLASS)\n"</span>, STATUS_INVALID_INFO_CLASS);
10347             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
10348         }
10349         IgnoreStatus = SamCloseHandle( UserHandle1 );
10350         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
10351 
10352 
10353 
10354         printf(<span class="stringliteral">"      Set Preferences Information . . . . . . . . . . . . .     "</span>);
10355             NtStatus = SamOpenUser(
10356                            DomainHandle,
10357                            USER_READ_GENERAL | USER_WRITE_PREFERENCES | USER_READ_PREFERENCES,
10358                            DOMAIN_USER_RID_ADMIN,
10359                            &amp;UserHandle1
10360                            );
10361             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
10362 
10363             <span class="comment">//</span>
10364             <span class="comment">// Get the current value...</span>
10365             <span class="comment">//</span>
10366 
10367             <a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
10368             NtStatus = SamQueryInformationUser(
10369                            UserHandle1,
10370                            UserPreferencesInformation,
10371                            &amp;Buffer1
10372                            );
10373             TST_SUCCESS_ASSERT(NtStatus);
10374             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Buffer1 != NULL);
10375 
10376 
10377             <span class="comment">//</span>
10378             <span class="comment">// Change the fields to  new values and write them out.</span>
10379             <span class="comment">//</span>
10380 
10381             NameLength = ((USER_PREFERENCES_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;UserComment.Length;
10382             <span class="keywordflow">if</span> (  NameLength == DummyString1.Length ) {
10383                 ((USER_PREFERENCES_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;UserComment = DummyString2;
10384             } <span class="keywordflow">else</span> {
10385                 ((USER_PREFERENCES_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;UserComment = DummyString1;
10386             }
10387 
10388             ((USER_PREFERENCES_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;CountryCode += 1;
10389             ((USER_PREFERENCES_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;CodePage += 1;
10390 
10391             NtStatus = SamSetInformationUser(
10392                            UserHandle1,
10393                            UserPreferencesInformation,
10394                            Buffer1
10395                            );
10396             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) ) {
10397 
10398                 <span class="comment">//</span>
10399                 <span class="comment">// Now check that the change was really made...</span>
10400                 <span class="comment">//</span>
10401 
10402                 NtStatus = SamQueryInformationUser(
10403                                UserHandle1,
10404                                UserPreferencesInformation,
10405                                &amp;Buffer2
10406                                );
10407                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( NtStatus ) );
10408                 <span class="keywordflow">if</span> (
10409                     !<a class="code" href="../../d2/d7/string_8c.html#a10">RtlCompareString</a>(
10410                         (PSTRING)&amp;((USER_PREFERENCES_INFORMATION *)Buffer1)-&gt;UserComment,
10411                         (PSTRING)&amp;((USER_PREFERENCES_INFORMATION *)Buffer2)-&gt;UserComment,
10412                         TRUE)
10413                         &amp;&amp;
10414                         (((USER_PREFERENCES_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;CountryCode ==
10415                          ((USER_PREFERENCES_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a2">Buffer2</a>)-&gt;CountryCode)
10416                         &amp;&amp;
10417                         (((USER_PREFERENCES_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;CodePage ==
10418                          ((USER_PREFERENCES_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a2">Buffer2</a>)-&gt;CodePage)
10419                     ) {
10420 
10421                     printf(<span class="stringliteral">"Succeeded\n"</span>);
10422 
10423                     <span class="comment">//</span>
10424                     <span class="comment">// Change back some fields to keep from screwing up our database</span>
10425                     <span class="comment">//</span>
10426 
10427                     ((USER_PREFERENCES_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;CountryCode -= 1;
10428                     ((USER_PREFERENCES_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;CodePage    -= 1;
10429 
10430                     IgnoreStatus = SamSetInformationUser(
10431                                        UserHandle1,
10432                                        UserPreferencesInformation,
10433                                        Buffer1
10434                                        );
10435                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus));
10436 
10437                 } <span class="keywordflow">else</span> {
10438 
10439                     printf(<span class="stringliteral">"Failed\n"</span>);
10440                     printf(<span class="stringliteral">"        Values queried don't match values written\n"</span>);
10441                     printf(<span class="stringliteral">"        UserComment Written is   %wZ\n"</span>,
10442                         (PUNICODE_STRING)&amp;((USER_PREFERENCES_INFORMATION *)Buffer1)-&gt;UserComment);
10443                     printf(<span class="stringliteral">"        UserComment Retrieved is %wZ\n"</span>,
10444                         (PUNICODE_STRING)&amp;((USER_PREFERENCES_INFORMATION *)Buffer2)-&gt;UserComment);
10445                     printf(<span class="stringliteral">"        CountryCode Written is   0x%lx\n"</span>,
10446                         (ULONG)((USER_PREFERENCES_INFORMATION *)Buffer1)-&gt;CountryCode);
10447                     printf(<span class="stringliteral">"        CountryCode Retrieved is 0x%lx\n"</span>,
10448                         (ULONG)((USER_PREFERENCES_INFORMATION *)Buffer2)-&gt;CountryCode);
10449                     printf(<span class="stringliteral">"        CodePage Written is   0x%lx\n"</span>,
10450                         (ULONG)((USER_PREFERENCES_INFORMATION *)Buffer1)-&gt;CodePage);
10451                     printf(<span class="stringliteral">"        CodePage Retrieved is 0x%lx\n"</span>,
10452                         (ULONG)((USER_PREFERENCES_INFORMATION *)Buffer2)-&gt;CodePage);
10453 
10454                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
10455 
10456                 }
10457 
10458                 SamFreeMemory( Buffer1 );
10459                 SamFreeMemory( Buffer2 );
10460 
10461             } <span class="keywordflow">else</span> {
10462                 printf(<span class="stringliteral">"Failed\n"</span>);
10463                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
10464                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
10465                 SamFreeMemory( Buffer1 );
10466 
10467             }
10468 
10469 
10470 
10471 
10472         printf(<span class="stringliteral">"      Set Logon Information . . . . . . . . . . . . . . . .     "</span>);
10473         NtStatus = SamOpenUser(
10474                        DomainHandle,
10475                        USER_ALL_ACCESS,
10476                        DOMAIN_USER_RID_ADMIN,
10477                        &amp;UserHandle1
10478                        );
10479         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
10480 
10481         <span class="comment">//</span>
10482         <span class="comment">// Make the parameter marshallable, but don't worry about values.</span>
10483         <span class="comment">//</span>
10484 
10485         LogonInformation.UserName       = DummyName1;
10486         LogonInformation.FullName       = DummyName1;
10487         LogonInformation.HomeDirectory  = DummyName1;
10488         LogonInformation.HomeDirectoryDrive = DummyName1;
10489         LogonInformation.ScriptPath     = DummyName1;
10490         LogonInformation.ProfilePath    = DummyName1;
10491         LogonInformation.WorkStations   = DummyName1;
10492 
10493         LogonInformation.LogonHours     = DummyLogonHours;
10494 
10495         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = &amp;LogonInformation;
10496         NtStatus = SamSetInformationUser(
10497                        UserHandle1,
10498                        UserLogonInformation,
10499                        Buffer
10500                        );
10501         <span class="keywordflow">if</span> (NtStatus == STATUS_INVALID_INFO_CLASS ) {
10502 
10503             printf(<span class="stringliteral">"Succeeded\n"</span>);
10504 
10505         } <span class="keywordflow">else</span> {
10506             printf(<span class="stringliteral">"Failed\n"</span>);
10507             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
10508             printf(<span class="stringliteral">"        Expected 0x%lx (INVALID_INFO_CLASS)\n"</span>, STATUS_INVALID_INFO_CLASS);
10509             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
10510         }
10511         IgnoreStatus = SamCloseHandle( UserHandle1 );
10512         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
10513 
10514 
10515 
10516         printf(<span class="stringliteral">"      Set Logon Hours Information . . . . . . . . . . . . .     "</span>);
10517             NtStatus = SamOpenUser(
10518                            DomainHandle,
10519                            USER_WRITE_ACCOUNT | USER_READ_LOGON,
10520                            DOMAIN_USER_RID_ADMIN,
10521                            &amp;UserHandle1
10522                            );
10523             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
10524 
10525             <span class="comment">//</span>
10526             <span class="comment">// Get the current value...</span>
10527             <span class="comment">//</span>
10528 
10529             <a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
10530             NtStatus = SamQueryInformationUser(
10531                            UserHandle1,
10532                            UserLogonHoursInformation,
10533                            &amp;Buffer1
10534                            );
10535             TST_SUCCESS_ASSERT(NtStatus);
10536             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Buffer1 != NULL);
10537             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ((USER_LOGON_HOURS_INFORMATION *)Buffer1)-&gt;LogonHours.LogonHours
10538                     != NULL);  <span class="comment">//Don't support zero length bit masks in this test yet.</span>
10539 
10540 
10541             <span class="comment">//</span>
10542             <span class="comment">// Change the field to a new value and write it out.</span>
10543             <span class="comment">// We have two choices for out test:</span>
10544             <span class="comment">//                                      NoLogonRestriction</span>
10545             <span class="comment">//                                      DummyLogonHours</span>
10546             <span class="comment">//</span>
10547             <span class="comment">// They are guaranteed to have different values in the</span>
10548             <span class="comment">// LOGON_HOURS_DIFFERENT_OFFSET byte of their respective bit masks.</span>
10549             <span class="comment">//</span>
10550 
10551             <span class="keywordflow">if</span> ( 0 == ((USER_LOGON_HOURS_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;LogonHours.LogonHours[LOGON_HOURS_DIFFERENT_OFFSET]) {
10552                 ((USER_LOGON_HOURS_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;LogonHours = DummyLogonHours;
10553             } <span class="keywordflow">else</span> {
10554                 ((USER_LOGON_HOURS_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;LogonHours = NoLogonRestriction;
10555             }
10556 
10557             NtStatus = SamSetInformationUser(
10558                            UserHandle1,
10559                            UserLogonHoursInformation,
10560                            Buffer1
10561                            );
10562             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) ) {
10563 
10564                 <span class="comment">//</span>
10565                 <span class="comment">// Now check that the change was really made...</span>
10566                 <span class="comment">//</span>
10567 
10568                 NtStatus = SamQueryInformationUser(
10569                                UserHandle1,
10570                                UserLogonHoursInformation,
10571                                &amp;Buffer2
10572                                );
10573                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( NtStatus ) );
10574                 <span class="keywordflow">if</span> (
10575                     ((USER_LOGON_HOURS_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;LogonHours.LogonHours[LOGON_HOURS_DIFFERENT_OFFSET]
10576                     ==
10577                     ((USER_LOGON_HOURS_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a2">Buffer2</a>)-&gt;LogonHours.LogonHours[LOGON_HOURS_DIFFERENT_OFFSET]
10578                     ) {
10579 
10580                     printf(<span class="stringliteral">"Succeeded\n"</span>);
10581 
10582                 } <span class="keywordflow">else</span> {
10583 
10584                     printf(<span class="stringliteral">"Failed\n"</span>);
10585                     printf(<span class="stringliteral">"        Value queried doesn't match value written\n"</span>);
10586                     printf(<span class="stringliteral">"        Units Written are   0x%lx\n"</span>,
10587                         ((USER_LOGON_HOURS_INFORMATION *)Buffer1)-&gt;LogonHours.UnitsPerWeek);
10588                     printf(<span class="stringliteral">"        Units Retrieved are 0x%lx\n"</span>,
10589                         ((USER_LOGON_HOURS_INFORMATION *)Buffer2)-&gt;LogonHours.UnitsPerWeek);
10590 
10591                     printf(<span class="stringliteral">"        Byte 0x%lx of the written bit mask is    0x%lx\n"</span>,
10592                         LOGON_HOURS_DIFFERENT_OFFSET,
10593                         (ULONG)((USER_LOGON_HOURS_INFORMATION *)Buffer1)-&gt;LogonHours.LogonHours[LOGON_HOURS_DIFFERENT_OFFSET]
10594                         );
10595                     printf(<span class="stringliteral">"        Byte 0x%lx of the retrieved bit mask is  0x%lx\n"</span>,
10596                         LOGON_HOURS_DIFFERENT_OFFSET,
10597                         (ULONG)((USER_LOGON_HOURS_INFORMATION *)Buffer2)-&gt;LogonHours.LogonHours[LOGON_HOURS_DIFFERENT_OFFSET]
10598                         );
10599 
10600                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
10601 
10602                 }
10603 
10604                 SamFreeMemory( Buffer1 );
10605                 SamFreeMemory( Buffer2 );
10606 
10607             } <span class="keywordflow">else</span> {
10608                 printf(<span class="stringliteral">"Failed\n"</span>);
10609                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
10610                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
10611                 SamFreeMemory( Buffer1 );
10612 
10613             }
10614 
10615 
10616 
10617 
10618 
10619         printf(<span class="stringliteral">"      Set Account Information . . . . . . . . . . . . . . .     "</span>);
10620         NtStatus = SamOpenUser(
10621                        DomainHandle,
10622                        USER_WRITE_ACCOUNT        |
10623                            USER_READ_GENERAL     |
10624                            USER_READ_PREFERENCES |
10625                            USER_READ_LOGON,
10626                        DOMAIN_USER_RID_ADMIN,
10627                        &amp;UserHandle1
10628                        );
10629         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
10630 
10631         <span class="comment">//</span>
10632         <span class="comment">// Make the parameter marshallable, but don't worry about values.</span>
10633         <span class="comment">//</span>
10634 
10635         AccountInformation.UserName       = DummyName1;
10636         AccountInformation.FullName       = DummyName1;
10637         AccountInformation.HomeDirectory  = DummyName1;
10638         AccountInformation.HomeDirectoryDrive = DummyName1;
10639         AccountInformation.ScriptPath     = DummyName1;
10640         AccountInformation.ProfilePath    = DummyName1;
10641         AccountInformation.AdminComment   = DummyName1;
10642         AccountInformation.WorkStations   = DummyName1;
10643 
10644         AccountInformation.LogonHours     = DummyLogonHours;
10645 
10646         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = &amp;AccountInformation;
10647         NtStatus = SamSetInformationUser(
10648                        UserHandle1,
10649                        UserAccountInformation,
10650                        Buffer
10651                        );
10652         <span class="keywordflow">if</span> (NtStatus == STATUS_INVALID_INFO_CLASS ) {
10653 
10654             printf(<span class="stringliteral">"Succeeded\n"</span>);
10655 
10656         } <span class="keywordflow">else</span> {
10657             printf(<span class="stringliteral">"Failed\n"</span>);
10658             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
10659             printf(<span class="stringliteral">"        Expected 0x%lx (INVALID_INFO_CLASS)\n"</span>, STATUS_INVALID_INFO_CLASS);
10660             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
10661         }
10662         IgnoreStatus = SamCloseHandle( UserHandle1 );
10663         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
10664 
10665 
10666         printf(<span class="stringliteral">"      Set Home  . . . . . . . . . . . . . . . . . . . . . .     "</span>);
10667             NtStatus = SamOpenUser(
10668                            DomainHandle,
10669                            USER_WRITE_ACCOUNT | USER_READ_LOGON,
10670                            DOMAIN_USER_RID_ADMIN,
10671                            &amp;UserHandle1
10672                            );
10673             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
10674 
10675             <span class="comment">//</span>
10676             <span class="comment">// Get the current value...</span>
10677             <span class="comment">//</span>
10678 
10679             <a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
10680             NtStatus = SamQueryInformationUser(
10681                            UserHandle1,
10682                            UserHomeInformation,
10683                            &amp;Buffer1
10684                            );
10685             TST_SUCCESS_ASSERT(NtStatus);
10686             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Buffer1 != NULL);
10687 
10688 
10689             <span class="comment">//</span>
10690             <span class="comment">// Change the field to a new value and write it out.</span>
10691             <span class="comment">//</span>
10692 
10693             NameLength = ((USER_HOME_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;HomeDirectory.Length;
10694             <span class="keywordflow">if</span> (  NameLength == DummyString1.Length ) {
10695                 ((USER_HOME_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;HomeDirectory = DummyString2;
10696             } <span class="keywordflow">else</span> {
10697                 ((USER_HOME_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;HomeDirectory = DummyString1;
10698             }
10699 
10700             NameLength = ((USER_HOME_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;HomeDirectoryDrive.Length;
10701             <span class="keywordflow">if</span> (  NameLength == DummyString1.Length ) {
10702                 ((USER_HOME_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;HomeDirectoryDrive = DummyString2;
10703             } <span class="keywordflow">else</span> {
10704                 ((USER_HOME_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;HomeDirectoryDrive = DummyString1;
10705             }
10706 
10707             NtStatus = SamSetInformationUser(
10708                            UserHandle1,
10709                            UserHomeInformation,
10710                            Buffer1
10711                            );
10712             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) ) {
10713 
10714                 <span class="comment">//</span>
10715                 <span class="comment">// Now check that the change was really made...</span>
10716                 <span class="comment">//</span>
10717 
10718                 NtStatus = SamQueryInformationUser(
10719                                UserHandle1,
10720                                UserHomeInformation,
10721                                &amp;Buffer2
10722                                );
10723                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( NtStatus ) );
10724 
10725                 <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d7/string_8c.html#a10">RtlCompareString</a>(
10726                         (PSTRING)&amp;((USER_HOME_INFORMATION *)Buffer1)-&gt;HomeDirectory,
10727                         (PSTRING)&amp;((USER_HOME_INFORMATION *)Buffer2)-&gt;HomeDirectory,
10728                         TRUE) ) {
10729 
10730                     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d7/string_8c.html#a10">RtlCompareString</a>(
10731                             (PSTRING)&amp;((USER_HOME_INFORMATION *)Buffer1)-&gt;HomeDirectoryDrive,
10732                             (PSTRING)&amp;((USER_HOME_INFORMATION *)Buffer2)-&gt;HomeDirectoryDrive,
10733                             TRUE)
10734                     ) {
10735                         printf(<span class="stringliteral">"Succeeded\n"</span>);
10736                     } <span class="keywordflow">else</span> {
10737 
10738                         printf(<span class="stringliteral">"Failed\n"</span>);
10739                         printf(<span class="stringliteral">"        Drive Value queried doesn't match value written\n"</span>);
10740                         printf(<span class="stringliteral">"        Value Written is   %wZ\n"</span>,
10741                             (PUNICODE_STRING)&amp;((USER_HOME_INFORMATION *)Buffer1)-&gt;HomeDirectoryDrive);
10742                         printf(<span class="stringliteral">"        Value Retrieved is %wZ\n"</span>,
10743                             (PUNICODE_STRING)&amp;((USER_HOME_INFORMATION *)Buffer2)-&gt;HomeDirectoryDrive);
10744 
10745                         TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
10746                     }
10747 
10748                 } <span class="keywordflow">else</span> {
10749 
10750                     printf(<span class="stringliteral">"Failed\n"</span>);
10751                     printf(<span class="stringliteral">"        Directory Value queried doesn't match value written\n"</span>);
10752                     printf(<span class="stringliteral">"        Value Written is   %wZ\n"</span>,
10753                         (PUNICODE_STRING)&amp;((USER_HOME_INFORMATION *)Buffer1)-&gt;HomeDirectory);
10754                     printf(<span class="stringliteral">"        Value Retrieved is %wZ\n"</span>,
10755                         (PUNICODE_STRING)&amp;((USER_HOME_INFORMATION *)Buffer2)-&gt;HomeDirectory);
10756 
10757                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
10758 
10759                 }
10760 
10761                 SamFreeMemory( Buffer1 );
10762                 SamFreeMemory( Buffer2 );
10763 
10764             } <span class="keywordflow">else</span> {
10765                 printf(<span class="stringliteral">"Failed\n"</span>);
10766                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
10767                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
10768                 SamFreeMemory( Buffer1 );
10769 
10770             }
10771 
10772 
10773 
10774 
10775         printf(<span class="stringliteral">"      Set Script  . . . . . . . . . . . . . . . . . . . . .     "</span>);
10776             NtStatus = SamOpenUser(
10777                            DomainHandle,
10778                            USER_WRITE_ACCOUNT | USER_READ_LOGON,
10779                            DOMAIN_USER_RID_ADMIN,
10780                            &amp;UserHandle1
10781                            );
10782             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
10783 
10784             <span class="comment">//</span>
10785             <span class="comment">// Get the current value...</span>
10786             <span class="comment">//</span>
10787 
10788             <a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
10789             NtStatus = SamQueryInformationUser(
10790                            UserHandle1,
10791                            UserScriptInformation,
10792                            &amp;Buffer1
10793                            );
10794             TST_SUCCESS_ASSERT(NtStatus);
10795             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Buffer1 != NULL);
10796 
10797 
10798             <span class="comment">//</span>
10799             <span class="comment">// Change the field to a new value and write it out.</span>
10800             <span class="comment">//</span>
10801 
10802             NameLength = ((USER_SCRIPT_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;ScriptPath.Length;
10803             <span class="keywordflow">if</span> (  NameLength == DummyString1.Length ) {
10804                 ((USER_SCRIPT_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;ScriptPath = DummyString2;
10805             } <span class="keywordflow">else</span> {
10806                 ((USER_SCRIPT_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;ScriptPath = DummyString1;
10807             }
10808 
10809             NtStatus = SamSetInformationUser(
10810                            UserHandle1,
10811                            UserScriptInformation,
10812                            Buffer1
10813                            );
10814             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) ) {
10815 
10816                 <span class="comment">//</span>
10817                 <span class="comment">// Now check that the change was really made...</span>
10818                 <span class="comment">//</span>
10819 
10820                 NtStatus = SamQueryInformationUser(
10821                                UserHandle1,
10822                                UserScriptInformation,
10823                                &amp;Buffer2
10824                                );
10825                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( NtStatus ) );
10826                 <span class="keywordflow">if</span> (
10827                     !<a class="code" href="../../d2/d7/string_8c.html#a10">RtlCompareString</a>(
10828                         (PSTRING)&amp;((USER_SCRIPT_INFORMATION *)Buffer1)-&gt;ScriptPath,
10829                         (PSTRING)&amp;((USER_SCRIPT_INFORMATION *)Buffer2)-&gt;ScriptPath,
10830                         TRUE)
10831                     ) {
10832 
10833                     printf(<span class="stringliteral">"Succeeded\n"</span>);
10834 
10835                 } <span class="keywordflow">else</span> {
10836 
10837                     printf(<span class="stringliteral">"Failed\n"</span>);
10838                     printf(<span class="stringliteral">"        Value queried doesn't match value written\n"</span>);
10839                     printf(<span class="stringliteral">"        Value Written is   %wZ\n"</span>,
10840                         (PUNICODE_STRING)&amp;((USER_SCRIPT_INFORMATION *)Buffer1)-&gt;ScriptPath);
10841                     printf(<span class="stringliteral">"        Value Retrieved is %wZ\n"</span>,
10842                         (PUNICODE_STRING)&amp;((USER_SCRIPT_INFORMATION *)Buffer2)-&gt;ScriptPath);
10843 
10844                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
10845 
10846                 }
10847 
10848                 SamFreeMemory( Buffer1 );
10849                 SamFreeMemory( Buffer2 );
10850 
10851             } <span class="keywordflow">else</span> {
10852                 printf(<span class="stringliteral">"Failed\n"</span>);
10853                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
10854                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
10855                 SamFreeMemory( Buffer1 );
10856 
10857             }
10858 
10859 
10860 
10861 
10862         printf(<span class="stringliteral">"      Set Profile . . . . . . . . . . . . . . . . . . . . .     "</span>);
10863             NtStatus = SamOpenUser(
10864                            DomainHandle,
10865                            USER_WRITE_ACCOUNT | USER_READ_LOGON,
10866                            DOMAIN_USER_RID_ADMIN,
10867                            &amp;UserHandle1
10868                            );
10869             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
10870 
10871             <span class="comment">//</span>
10872             <span class="comment">// Get the current value...</span>
10873             <span class="comment">//</span>
10874 
10875             <a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
10876             NtStatus = SamQueryInformationUser(
10877                            UserHandle1,
10878                            UserProfileInformation,
10879                            &amp;Buffer1
10880                            );
10881             TST_SUCCESS_ASSERT(NtStatus);
10882             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Buffer1 != NULL);
10883 
10884 
10885             <span class="comment">//</span>
10886             <span class="comment">// Change the field to a new value and write it out.</span>
10887             <span class="comment">//</span>
10888 
10889             NameLength = ((USER_PROFILE_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;ProfilePath.Length;
10890             <span class="keywordflow">if</span> (  NameLength == DummyString1.Length ) {
10891                 ((USER_PROFILE_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;ProfilePath = DummyString2;
10892             } <span class="keywordflow">else</span> {
10893                 ((USER_PROFILE_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;ProfilePath = DummyString1;
10894             }
10895 
10896             NtStatus = SamSetInformationUser(
10897                            UserHandle1,
10898                            UserProfileInformation,
10899                            Buffer1
10900                            );
10901             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) ) {
10902 
10903                 <span class="comment">//</span>
10904                 <span class="comment">// Now check that the change was really made...</span>
10905                 <span class="comment">//</span>
10906 
10907                 NtStatus = SamQueryInformationUser(
10908                                UserHandle1,
10909                                UserProfileInformation,
10910                                &amp;Buffer2
10911                                );
10912                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( NtStatus ) );
10913                 <span class="keywordflow">if</span> (
10914                     !<a class="code" href="../../d2/d7/string_8c.html#a10">RtlCompareString</a>(
10915                         (PSTRING)&amp;((USER_PROFILE_INFORMATION *)Buffer1)-&gt;ProfilePath,
10916                         (PSTRING)&amp;((USER_PROFILE_INFORMATION *)Buffer2)-&gt;ProfilePath,
10917                         TRUE)
10918                     ) {
10919 
10920                     printf(<span class="stringliteral">"Succeeded\n"</span>);
10921 
10922                 } <span class="keywordflow">else</span> {
10923 
10924                     printf(<span class="stringliteral">"Failed\n"</span>);
10925                     printf(<span class="stringliteral">"        Value queried doesn't match value written\n"</span>);
10926                     printf(<span class="stringliteral">"        Value Written is   %wZ\n"</span>,
10927                         (PUNICODE_STRING)&amp;((USER_PROFILE_INFORMATION *)Buffer1)-&gt;ProfilePath);
10928                     printf(<span class="stringliteral">"        Value Retrieved is %wZ\n"</span>,
10929                         (PUNICODE_STRING)&amp;((USER_PROFILE_INFORMATION *)Buffer2)-&gt;ProfilePath);
10930 
10931                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
10932 
10933                 }
10934 
10935                 SamFreeMemory( Buffer1 );
10936                 SamFreeMemory( Buffer2 );
10937 
10938             } <span class="keywordflow">else</span> {
10939                 printf(<span class="stringliteral">"Failed\n"</span>);
10940                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
10941                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
10942                 SamFreeMemory( Buffer1 );
10943 
10944             }
10945 
10946 
10947 
10948 
10949         printf(<span class="stringliteral">"      Set Admin Comment . . . . . . . . . . . . . . . . . .     "</span>);
10950 
10951             NtStatus = SamOpenUser(
10952                            DomainHandle,
10953                            USER_WRITE_ACCOUNT | USER_READ_GENERAL,
10954                            DOMAIN_USER_RID_ADMIN,
10955                            &amp;UserHandle1
10956                            );
10957             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
10958 
10959             <span class="comment">//</span>
10960             <span class="comment">// Get the current value...</span>
10961             <span class="comment">//</span>
10962 
10963             <a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
10964             NtStatus = SamQueryInformationUser(
10965                            UserHandle1,
10966                            UserAdminCommentInformation,
10967                            &amp;Buffer1
10968                            );
10969             TST_SUCCESS_ASSERT(NtStatus);
10970             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Buffer1 != NULL);
10971 
10972 
10973             <span class="comment">//</span>
10974             <span class="comment">// Change the field to a new value and write it out.</span>
10975             <span class="comment">//</span>
10976 
10977             NameLength = ((USER_ADMIN_COMMENT_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;AdminComment.Length;
10978             <span class="keywordflow">if</span> (  NameLength == DummyString1.Length ) {
10979                 ((USER_ADMIN_COMMENT_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;AdminComment = DummyString2;
10980             } <span class="keywordflow">else</span> {
10981                 ((USER_ADMIN_COMMENT_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;AdminComment = DummyString1;
10982             }
10983 
10984             NtStatus = SamSetInformationUser(
10985                            UserHandle1,
10986                            UserAdminCommentInformation,
10987                            Buffer1
10988                            );
10989             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) ) {
10990 
10991                 <span class="comment">//</span>
10992                 <span class="comment">// Now check that the change was really made...</span>
10993                 <span class="comment">//</span>
10994 
10995                 NtStatus = SamQueryInformationUser(
10996                                UserHandle1,
10997                                UserAdminCommentInformation,
10998                                &amp;Buffer2
10999                                );
11000                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( NtStatus ) );
11001                 <span class="keywordflow">if</span> (
11002                     !<a class="code" href="../../d2/d7/string_8c.html#a10">RtlCompareString</a>(
11003                         (PSTRING)&amp;((USER_ADMIN_COMMENT_INFORMATION *)Buffer1)-&gt;AdminComment,
11004                         (PSTRING)&amp;((USER_ADMIN_COMMENT_INFORMATION *)Buffer2)-&gt;AdminComment,
11005                         TRUE)
11006                     ) {
11007 
11008                     printf(<span class="stringliteral">"Succeeded\n"</span>);
11009 
11010                 } <span class="keywordflow">else</span> {
11011 
11012                     printf(<span class="stringliteral">"Failed\n"</span>);
11013                     printf(<span class="stringliteral">"        Value queried doesn't match value written\n"</span>);
11014                     printf(<span class="stringliteral">"        Value Written is   %wZ\n"</span>,
11015                         (PUNICODE_STRING)&amp;((USER_ADMIN_COMMENT_INFORMATION *)Buffer1)-&gt;AdminComment);
11016                     printf(<span class="stringliteral">"        Value Retrieved is %wZ\n"</span>,
11017                         (PUNICODE_STRING)&amp;((USER_ADMIN_COMMENT_INFORMATION *)Buffer2)-&gt;AdminComment);
11018 
11019                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11020 
11021                 }
11022 
11023                 SamFreeMemory( Buffer1 );
11024                 SamFreeMemory( Buffer2 );
11025 
11026             } <span class="keywordflow">else</span> {
11027                 printf(<span class="stringliteral">"Failed\n"</span>);
11028                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
11029                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11030                 SamFreeMemory( Buffer1 );
11031 
11032             }
11033 
11034 
11035         printf(<span class="stringliteral">"      Set Workstations  . . . . . . . . . . . . . . . . . .     "</span>);
11036         printf(<span class="stringliteral">"BROKEN TEST - NOT TESTED\n"</span>);
11037 <span class="preprocessor">#ifdef BROKEN</span>
11038 <span class="preprocessor"></span>            NtStatus = SamOpenUser(
11039                            DomainHandle,
11040                            USER_WRITE_ACCOUNT | USER_READ_LOGON,
11041                            DOMAIN_USER_RID_ADMIN,
11042                            &amp;UserHandle1
11043                            );
11044             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
11045 
11046             <span class="comment">//</span>
11047             <span class="comment">// Get the current value...</span>
11048             <span class="comment">//</span>
11049 
11050             <a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
11051             NtStatus = SamQueryInformationUser(
11052                            UserHandle1,
11053                            UserWorkStationsInformation,
11054                            &amp;Buffer1
11055                            );
11056             TST_SUCCESS_ASSERT(NtStatus);
11057             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Buffer1 != NULL);
11058 
11059 
11060             <span class="comment">//</span>
11061             <span class="comment">// Change the field to a new value and write it out.</span>
11062             <span class="comment">//</span>
11063 
11064             NameLength = ((USER_WORKSTATIONS_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;WorkStations.Length;
11065             <span class="keywordflow">if</span> (  NameLength == DummyString1.Length ) {
11066                 ((USER_WORKSTATIONS_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;WorkStations = DummyString2;
11067             } <span class="keywordflow">else</span> {
11068                 ((USER_WORKSTATIONS_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;WorkStations = DummyString1;
11069             }
11070 
11071             NtStatus = SamSetInformationUser(
11072                            UserHandle1,
11073                            UserWorkStationsInformation,
11074                            Buffer1
11075                            );
11076             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) ) {
11077 
11078                 <span class="comment">//</span>
11079                 <span class="comment">// Now check that the change was really made...</span>
11080                 <span class="comment">//</span>
11081 
11082                 NtStatus = SamQueryInformationUser(
11083                                UserHandle1,
11084                                UserWorkStationsInformation,
11085                                &amp;Buffer2
11086                                );
11087                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( NtStatus ) );
11088                 <span class="keywordflow">if</span> (
11089                     !<a class="code" href="../../d2/d7/string_8c.html#a10">RtlCompareString</a>(
11090                         (PSTRING)&amp;((USER_WORKSTATIONS_INFORMATION *)Buffer1)-&gt;WorkStations,
11091                         (PSTRING)&amp;((USER_WORKSTATIONS_INFORMATION *)Buffer2)-&gt;WorkStations,
11092                         TRUE)
11093                     ) {
11094 
11095                     printf(<span class="stringliteral">"Succeeded\n"</span>);
11096 
11097                 } <span class="keywordflow">else</span> {
11098 
11099                     printf(<span class="stringliteral">"Failed\n"</span>);
11100                     printf(<span class="stringliteral">"        Value queried doesn't match value written\n"</span>);
11101                     printf(<span class="stringliteral">"        Value Written is   %wZ\n"</span>,
11102                         (PUNICODE_STRING)&amp;((USER_WORKSTATIONS_INFORMATION *)Buffer1)-&gt;WorkStations);
11103                     printf(<span class="stringliteral">"        Value Retrieved is %wZ\n"</span>,
11104                         (PUNICODE_STRING)&amp;((USER_WORKSTATIONS_INFORMATION *)Buffer2)-&gt;WorkStations);
11105 
11106                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11107 
11108                 }
11109 
11110                 SamFreeMemory( Buffer1 );
11111                 SamFreeMemory( Buffer2 );
11112 
11113             } <span class="keywordflow">else</span> {
11114                 printf(<span class="stringliteral">"Failed\n"</span>);
11115                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
11116                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11117                 SamFreeMemory( Buffer1 );
11118 
11119             }
11120 <span class="preprocessor">#endif //BROKEN</span>
11121 <span class="preprocessor"></span>
11122 
11123         printf(<span class="stringliteral">"      Set Internal1   . . . . . . . . . . . . . . . . . . .     "</span>);
11124 
11125             NtStatus = SamOpenUser(
11126                            DomainHandle,
11127                            USER_WRITE_ACCOUNT | USER_READ_LOGON | USER_FORCE_PASSWORD_CHANGE,
11128                            DOMAIN_USER_RID_ADMIN,
11129                            &amp;UserHandle1
11130                            );
11131             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
11132 
11133             <span class="comment">//</span>
11134             <span class="comment">// We can't get the current values, since this level is only</span>
11135             <span class="comment">// queryable by trusted clients.  So just try setting a couple</span>
11136             <span class="comment">// of values and make sure that we don't get an error.</span>
11137             <span class="comment">//</span>
11138 
11139             <a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a> = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( RtlProcessHeap(), 0, <span class="keyword">sizeof</span>(USER_INTERNAL1_INFORMATION) );
11140             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Buffer1 != NULL );
11141 
11142             ((PUSER_INTERNAL1_INFORMATION)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;NtPasswordPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11143             ((PUSER_INTERNAL1_INFORMATION)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;LmPasswordPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11144 
11145             NtStatus = SamSetInformationUser(
11146                            UserHandle1,
11147                            UserInternal1Information,
11148                            Buffer1
11149                            );
11150 
11151             <span class="keywordflow">if</span> (NtStatus != STATUS_PASSWORD_RESTRICTION) {
11152 
11153                 printf(<span class="stringliteral">"Failed\n"</span>);
11154                 printf(<span class="stringliteral">"    Expected Status = 0x%lx\n"</span>, STATUS_PASSWORD_RESTRICTION);
11155                 printf(<span class="stringliteral">"    Received Status = 0x%lx\n"</span>, NtStatus );
11156                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11157 
11158             } <span class="keywordflow">else</span> {
11159 
11160                 <span class="comment">//</span>
11161                 <span class="comment">// The NULL password worked, so let's try a real password.</span>
11162                 <span class="comment">//</span>
11163 
11164                 NtStatus = RtlCalculateNtOwfPassword(
11165                     &amp;DummyName1,
11166                     &amp;((PUSER_INTERNAL1_INFORMATION)Buffer1)-&gt;NtOwfPassword
11167                     );
11168                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
11169 
11170                 ((PUSER_INTERNAL1_INFORMATION)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;NtPasswordPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
11171 
11172                 NtStatus = RtlCalculateLmOwfPassword(
11173                     DUMMY_STRING1,
11174                     &amp;((PUSER_INTERNAL1_INFORMATION)Buffer1)-&gt;LmOwfPassword
11175                     );
11176                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
11177 
11178                 ((PUSER_INTERNAL1_INFORMATION)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;LmPasswordPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
11179 
11180                 NtStatus = SamSetInformationUser(
11181                                UserHandle1,
11182                                UserInternal1Information,
11183                                Buffer1
11184                                );
11185 
11186                 <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) ) {
11187 
11188                     printf(<span class="stringliteral">"Succeeded\n"</span>);
11189 
11190                 } <span class="keywordflow">else</span> {
11191 
11192                     printf(<span class="stringliteral">"Failed\n"</span>);
11193                     printf(<span class="stringliteral">"    Return status was %lx\n"</span>, NtStatus );
11194                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11195                 }
11196             }
11197 
11198             <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( RtlProcessHeap(), 0, Buffer1 );
11199 
11200 
11201 <span class="comment">// This is the code that used to be here, when UserInternal1Information was</span>
11202 <span class="comment">// queryable by non-trusted clients...</span>
11203 <span class="comment">//</span>
11204 <span class="comment">//            Buffer1 = NULL;</span>
11205 <span class="comment">//            NtStatus = SamQueryInformationUser(</span>
11206 <span class="comment">//                           UserHandle1,</span>
11207 <span class="comment">//                           UserInternal1Information,</span>
11208 <span class="comment">//                           &amp;Buffer1</span>
11209 <span class="comment">//                           );</span>
11210 <span class="comment">//            TST_SUCCESS_ASSERT(NtStatus);</span>
11211 <span class="comment">//            ASSERT(Buffer1 != NULL);</span>
11212 <span class="comment">//</span>
11213 <span class="comment">//            //</span>
11214 <span class="comment">//            // The passwords were initially empty.  Put in some random</span>
11215 <span class="comment">//            // OWF passwords, and have them written out.</span>
11216 <span class="comment">//            //</span>
11217 <span class="comment">//</span>
11218 <span class="comment">//            NtStatus = RtlCalculateNtOwfPassword(</span>
11219 <span class="comment">//                (PNT_PASSWORD)&amp;DummyName1,</span>
11220 <span class="comment">//                &amp;EncryptedPasswordBuffer</span>
11221 <span class="comment">//                );</span>
11222 <span class="comment">//</span>
11223 <span class="comment">//            ((USER_INTERNAL1_INFORMATION *)Buffer1)-&gt;CaseSensitiveUnicode.Buffer = (PCHAR)&amp;EncryptedPasswordBuffer;</span>
11224 <span class="comment">//            ((USER_INTERNAL1_INFORMATION *)Buffer1)-&gt;CaseSensitiveUnicode.Length = 16;</span>
11225 <span class="comment">//            ((USER_INTERNAL1_INFORMATION *)Buffer1)-&gt;CaseSensitiveUnicode.MaximumLength = 16;</span>
11226 <span class="comment">//</span>
11227 <span class="comment">//            NtStatus = RtlCalculateNtOwfPassword(</span>
11228 <span class="comment">//                (PNT_PASSWORD)&amp;DummyName2,</span>
11229 <span class="comment">//                &amp;EncryptedPasswordBuffer2</span>
11230 <span class="comment">//                );</span>
11231 <span class="comment">//</span>
11232 <span class="comment">//            ((USER_INTERNAL1_INFORMATION *)Buffer1)-&gt;CaseInsensitiveDbcs.Buffer = (PCHAR)&amp;EncryptedPasswordBuffer2;</span>
11233 <span class="comment">//            ((USER_INTERNAL1_INFORMATION *)Buffer1)-&gt;CaseInsensitiveDbcs.Length = 16;</span>
11234 <span class="comment">//            ((USER_INTERNAL1_INFORMATION *)Buffer1)-&gt;CaseInsensitiveDbcs.MaximumLength = 16;</span>
11235 <span class="comment">//</span>
11236 <span class="comment">//            NtStatus = SamSetInformationUser(</span>
11237 <span class="comment">//                           UserHandle1,</span>
11238 <span class="comment">//                           UserInternal1Information,</span>
11239 <span class="comment">//                           Buffer1</span>
11240 <span class="comment">//                           );</span>
11241 <span class="comment">//            if ( NT_SUCCESS(NtStatus) ) {</span>
11242 <span class="comment">//</span>
11243 <span class="comment">//                //</span>
11244 <span class="comment">//                // Now check that the change was really made...</span>
11245 <span class="comment">//                //</span>
11246 <span class="comment">//</span>
11247 <span class="comment">//                NtStatus = SamQueryInformationUser(</span>
11248 <span class="comment">//                               UserHandle1,</span>
11249 <span class="comment">//                               UserInternal1Information,</span>
11250 <span class="comment">//                               &amp;Buffer2</span>
11251 <span class="comment">//                               );</span>
11252 <span class="comment">//                ASSERT(NT_SUCCESS( NtStatus ) );</span>
11253 <span class="comment">//</span>
11254 <span class="comment">//                if ( (</span>
11255 <span class="comment">//                    !RtlCompareString(</span>
11256 <span class="comment">//                        (PSTRING)&amp;((USER_INTERNAL1_INFORMATION *)Buffer1)-&gt;CaseSensitiveUnicode,</span>
11257 <span class="comment">//                        (PSTRING)&amp;((USER_INTERNAL1_INFORMATION *)Buffer2)-&gt;CaseSensitiveUnicode,</span>
11258 <span class="comment">//                        TRUE)</span>
11259 <span class="comment">//                    ) || (</span>
11260 <span class="comment">//                    !RtlCompareString(</span>
11261 <span class="comment">//                        (PSTRING)&amp;((USER_INTERNAL1_INFORMATION *)Buffer1)-&gt;CaseInsensitiveDbcs,</span>
11262 <span class="comment">//                        (PSTRING)&amp;((USER_INTERNAL1_INFORMATION *)Buffer2)-&gt;CaseInsensitiveDbcs,</span>
11263 <span class="comment">//                        TRUE)</span>
11264 <span class="comment">//                    ) ) {</span>
11265 <span class="comment">//</span>
11266 <span class="comment">//                    printf("Succeeded\n");</span>
11267 <span class="comment">//</span>
11268 <span class="comment">//                } else {</span>
11269 <span class="comment">//</span>
11270 <span class="comment">//                    printf("Failed\n");</span>
11271 <span class="comment">//                    printf("        Value queried doesn't match value written\n");</span>
11272 <span class="comment">//                    printf("        CaseInsensitiveDbcs Written is   %wZ\n",</span>
11273 <span class="comment">//                        (PUNICODE_STRING)&amp;((USER_INTERNAL1_INFORMATION *)Buffer1)-&gt;CaseInsensitiveDbcs);</span>
11274 <span class="comment">//                    printf("        CaseInsensitiveDbcs Retrieved is %wZ\n",</span>
11275 <span class="comment">//                        (PUNICODE_STRING)&amp;((USER_INTERNAL1_INFORMATION *)Buffer2)-&gt;CaseInsensitiveDbcs);</span>
11276 <span class="comment">//                    printf("        CaseSensitiveUnicode Written is   %wZ\n",</span>
11277 <span class="comment">//                        (PUNICODE_STRING)&amp;((USER_INTERNAL1_INFORMATION *)Buffer1)-&gt;CaseSensitiveUnicode);</span>
11278 <span class="comment">//                    printf("        CaseSensitiveUnicode Retrieved is %wZ\n",</span>
11279 <span class="comment">//                        (PUNICODE_STRING)&amp;((USER_INTERNAL1_INFORMATION *)Buffer2)-&gt;CaseSensitiveUnicode);</span>
11280 <span class="comment">//</span>
11281 <span class="comment">//                    TestStatus = FALSE;</span>
11282 <span class="comment">//</span>
11283 <span class="comment">//                }</span>
11284 <span class="comment">//</span>
11285 <span class="comment">//                SamFreeMemory( Buffer1 );</span>
11286 <span class="comment">//                SamFreeMemory( Buffer2 );</span>
11287 <span class="comment">//</span>
11288 <span class="comment">//            } else {</span>
11289 <span class="comment">//                printf("Failed\n");</span>
11290 <span class="comment">//                printf("        Completion status is 0x%lx\n", NtStatus);</span>
11291 <span class="comment">//                TestStatus = FALSE;</span>
11292 <span class="comment">//                SamFreeMemory( Buffer1 );</span>
11293 <span class="comment">//</span>
11294 <span class="comment">//            }</span>
11295 
11296 
11297 
11298         printf(<span class="stringliteral">"      Set Internal2   . . . . . . . . . . . . . . . . . . .     "</span>);
11299 
11300             NtStatus = SamOpenUser(
11301                            DomainHandle,
11302                            USER_WRITE_ACCOUNT | USER_READ_LOGON,
11303                            DOMAIN_USER_RID_ADMIN,
11304                            &amp;UserHandle1
11305                            );
11306             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
11307 
11308             <span class="comment">//</span>
11309             <span class="comment">// We can't get the current values, since this level is only</span>
11310             <span class="comment">// queryable by trusted clients.  We can't set either, but</span>
11311             <span class="comment">// try it and make sure we get the correct error.</span>
11312             <span class="comment">//</span>
11313 
11314             <a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a> = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( RtlProcessHeap(), 0, <span class="keyword">sizeof</span>(USER_INTERNAL2_INFORMATION) );
11315             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Buffer1 != NULL );
11316 
11317             ((USER_INTERNAL2_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;LastLogon.HighPart = 1;
11318             ((USER_INTERNAL2_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;LastLogoff.HighPart = 2;
11319             ((USER_INTERNAL2_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;LastLogon.LowPart = 3;
11320             ((USER_INTERNAL2_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;LastLogoff.LowPart = 4;
11321             ((USER_INTERNAL2_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;BadPasswordCount = 5;
11322             ((USER_INTERNAL2_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;LogonCount = 6;
11323 
11324             NtStatus = SamSetInformationUser(
11325                            UserHandle1,
11326                            UserInternal2Information,
11327                            Buffer1
11328                            );
11329 
11330             <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( RtlProcessHeap(), 0, Buffer1 );
11331 
11332             <span class="keywordflow">if</span> ( NtStatus == STATUS_INVALID_INFO_CLASS ) {
11333 
11334                 printf(<span class="stringliteral">"Succeeded\n"</span>);
11335 
11336             } <span class="keywordflow">else</span> {
11337 
11338                 printf(<span class="stringliteral">"Failed\n"</span>);
11339                 printf(<span class="stringliteral">"    Expected Status = 0x%lx\n"</span>, STATUS_INVALID_INFO_CLASS);
11340                 printf(<span class="stringliteral">"    Received Status = 0x%lx\n"</span>, NtStatus );
11341                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11342             }
11343 
11344 <span class="comment">// This is the code that was here when UserInternal2Information could be</span>
11345 <span class="comment">// queried and set by non-trusted clients...</span>
11346 <span class="comment">//</span>
11347 <span class="comment">//            //</span>
11348 <span class="comment">//            // Get the current values...</span>
11349 <span class="comment">//            //</span>
11350 <span class="comment">//</span>
11351 <span class="comment">//            Buffer1 = NULL;</span>
11352 <span class="comment">//            NtStatus = SamQueryInformationUser(</span>
11353 <span class="comment">//                           UserHandle1,</span>
11354 <span class="comment">//                           UserInternal2Information,</span>
11355 <span class="comment">//                           &amp;Buffer1</span>
11356 <span class="comment">//                           );</span>
11357 <span class="comment">//            TST_SUCCESS_ASSERT(NtStatus);</span>
11358 <span class="comment">//            ASSERT(Buffer1 != NULL);</span>
11359 <span class="comment">//</span>
11360 <span class="comment">//            //</span>
11361 <span class="comment">//            // Now change the fields and write them out.</span>
11362 <span class="comment">//            //</span>
11363 <span class="comment">//</span>
11364 <span class="comment">//            ((USER_INTERNAL2_INFORMATION *)Buffer1)-&gt;LastLogon.HighPart += 1;</span>
11365 <span class="comment">//            ((USER_INTERNAL2_INFORMATION *)Buffer1)-&gt;LastLogoff.HighPart += 1;</span>
11366 <span class="comment">//            ((USER_INTERNAL2_INFORMATION *)Buffer1)-&gt;LastLogon.LowPart += 2;</span>
11367 <span class="comment">//            ((USER_INTERNAL2_INFORMATION *)Buffer1)-&gt;LastLogoff.LowPart += 2;</span>
11368 <span class="comment">//            ((USER_INTERNAL2_INFORMATION *)Buffer1)-&gt;BadPasswordCount += 1;</span>
11369 <span class="comment">//            ((USER_INTERNAL2_INFORMATION *)Buffer1)-&gt;LogonCount += 1;</span>
11370 <span class="comment">//</span>
11371 <span class="comment">//            NtStatus = SamSetInformationUser(</span>
11372 <span class="comment">//                           UserHandle1,</span>
11373 <span class="comment">//                           UserInternal2Information,</span>
11374 <span class="comment">//                           Buffer1</span>
11375 <span class="comment">//                           );</span>
11376 <span class="comment">//            if ( NT_SUCCESS(NtStatus) ) {</span>
11377 <span class="comment">//</span>
11378 <span class="comment">//                //</span>
11379 <span class="comment">//                // Now check that the change was really made...</span>
11380 <span class="comment">//                //</span>
11381 <span class="comment">//</span>
11382 <span class="comment">//                NtStatus = SamQueryInformationUser(</span>
11383 <span class="comment">//                               UserHandle1,</span>
11384 <span class="comment">//                               UserInternal2Information,</span>
11385 <span class="comment">//                               &amp;Buffer2</span>
11386 <span class="comment">//                               );</span>
11387 <span class="comment">//                ASSERT(NT_SUCCESS( NtStatus ) );</span>
11388 <span class="comment">//                if (</span>
11389 <span class="comment">//                    (((USER_INTERNAL2_INFORMATION *)Buffer1)-&gt;LastLogon.HighPart ==</span>
11390 <span class="comment">//                    ((USER_INTERNAL2_INFORMATION *)Buffer2)-&gt;LastLogon.HighPart) &amp;&amp;</span>
11391 <span class="comment">//                    (((USER_INTERNAL2_INFORMATION *)Buffer1)-&gt;LastLogon.LowPart ==</span>
11392 <span class="comment">//                    ((USER_INTERNAL2_INFORMATION *)Buffer2)-&gt;LastLogon.LowPart) &amp;&amp;</span>
11393 <span class="comment">//                    (((USER_INTERNAL2_INFORMATION *)Buffer1)-&gt;LastLogoff.HighPart ==</span>
11394 <span class="comment">//                    ((USER_INTERNAL2_INFORMATION *)Buffer2)-&gt;LastLogoff.HighPart) &amp;&amp;</span>
11395 <span class="comment">//                    (((USER_INTERNAL2_INFORMATION *)Buffer1)-&gt;LastLogoff.LowPart ==</span>
11396 <span class="comment">//                    ((USER_INTERNAL2_INFORMATION *)Buffer2)-&gt;LastLogoff.LowPart) &amp;&amp;</span>
11397 <span class="comment">//                    (((USER_INTERNAL2_INFORMATION *)Buffer1)-&gt;BadPasswordCount ==</span>
11398 <span class="comment">//                    ((USER_INTERNAL2_INFORMATION *)Buffer2)-&gt;BadPasswordCount) &amp;&amp;</span>
11399 <span class="comment">//                    (((USER_INTERNAL2_INFORMATION *)Buffer1)-&gt;LogonCount ==</span>
11400 <span class="comment">//                    ((USER_INTERNAL2_INFORMATION *)Buffer2)-&gt;LogonCount)</span>
11401 <span class="comment">//                     ) {</span>
11402 <span class="comment">//</span>
11403 <span class="comment">//                    printf("Succeeded\n");</span>
11404 <span class="comment">//</span>
11405 <span class="comment">//                } else {</span>
11406 <span class="comment">//</span>
11407 <span class="comment">//                    printf("Failed\n");</span>
11408 <span class="comment">//                    printf("        Value queried doesn't match value written\n");</span>
11409 <span class="comment">//</span>
11410 <span class="comment">//                    TestStatus = FALSE;</span>
11411 <span class="comment">//</span>
11412 <span class="comment">//                }</span>
11413 <span class="comment">//</span>
11414 <span class="comment">//                SamFreeMemory( Buffer1 );</span>
11415 <span class="comment">//                SamFreeMemory( Buffer2 );</span>
11416 <span class="comment">//</span>
11417 <span class="comment">//            } else {</span>
11418 <span class="comment">//                printf("Failed\n");</span>
11419 <span class="comment">//                printf("        Completion status is 0x%lx\n", NtStatus);</span>
11420 <span class="comment">//                TestStatus = FALSE;</span>
11421 <span class="comment">//                SamFreeMemory( Buffer1 );</span>
11422 <span class="comment">//</span>
11423 <span class="comment">//            }</span>
11424 
11425 
11426 
11427         printf(<span class="stringliteral">"      Set Password  . . . . . . . . . . . . . . . . . . . .     "</span>);
11428 
11429             NtStatus = SamOpenUser(
11430                            DomainHandle,
11431                            USER_FORCE_PASSWORD_CHANGE,
11432                            DOMAIN_USER_RID_ADMIN,
11433                            &amp;UserHandle1
11434                            );
11435             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
11436 
11437             <span class="comment">//</span>
11438             <span class="comment">// Create a fake cleartext UNICODE password and write it out.</span>
11439             <span class="comment">//</span>
11440 
11441             NtStatus = SamSetInformationUser(
11442                            UserHandle1,
11443                            UserSetPasswordInformation,
11444                            &amp;DummyName2
11445                            );
11446             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) ) {
11447 
11448                 <span class="comment">//</span>
11449                 <span class="comment">// We can't verify that it really worked, so we just have</span>
11450                 <span class="comment">// to trust the return code.</span>
11451                 <span class="comment">//</span>
11452 
11453                 printf(<span class="stringliteral">"Succeeded\n"</span>);
11454 
11455             } <span class="keywordflow">else</span> {
11456 
11457                 printf(<span class="stringliteral">"Failed\n"</span>);
11458                 printf(<span class="stringliteral">"    Return code was %lx\n"</span>, NtStatus );
11459                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11460             }
11461 
11462 
11463 
11464         printf(<span class="stringliteral">"      Set Control . . . . . . . . . . . . . . . . . . . . .     "</span>);
11465             NtStatus = SamOpenUser(
11466                            DomainHandle,
11467                            USER_WRITE_ACCOUNT | USER_READ_ACCOUNT,
11468                            DOMAIN_USER_RID_ADMIN,
11469                            &amp;UserHandle1
11470                            );
11471             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
11472 
11473             <a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
11474             NtStatus = SamQueryInformationUser(
11475                            UserHandle1,
11476                            UserControlInformation,
11477                            &amp;Buffer1
11478                            );
11479             TST_SUCCESS_ASSERT(NtStatus);
11480             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Buffer1 != NULL);
11481 
11482             <span class="comment">//</span>
11483             <span class="comment">// Change the value and write it back</span>
11484             <span class="comment">//</span>
11485 
11486             ((USER_CONTROL_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;UserAccountControl ^= USER_HOME_DIRECTORY_REQUIRED;
11487 
11488 
11489             NtStatus = SamSetInformationUser(
11490                            UserHandle1,
11491                            UserControlInformation,
11492                            Buffer1
11493                            );
11494             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
11495 
11496                 <span class="comment">//</span>
11497                 <span class="comment">// Check the written value to make sure it stuck</span>
11498                 <span class="comment">//</span>
11499 
11500                 <a class="code" href="../../d9/d0/tfilmem_8c.html#a2">Buffer2</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
11501                 NtStatus = SamQueryInformationUser(
11502                                UserHandle1,
11503                                UserControlInformation,
11504                                &amp;Buffer2
11505                                );
11506                 TST_SUCCESS_ASSERT(NtStatus);
11507                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Buffer2 != NULL);
11508 
11509                 <span class="keywordflow">if</span> ( ((USER_CONTROL_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;UserAccountControl  ==
11510                      ((USER_CONTROL_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a2">Buffer2</a>)-&gt;UserAccountControl ) {
11511 
11512                     printf(<span class="stringliteral">"Succeeded\n"</span>);
11513 
11514                     SamFreeMemory( Buffer2 );
11515 
11516                     <span class="comment">//</span>
11517                     <span class="comment">// Make sure the account is left enabled to prevent problems.</span>
11518                     <span class="comment">//</span>
11519 
11520                     ((USER_CONTROL_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;UserAccountControl &amp;= ~USER_ACCOUNT_DISABLED;
11521 
11522                     IgnoreStatus = SamSetInformationUser(
11523                                        UserHandle1,
11524                                        UserControlInformation,
11525                                        Buffer1
11526                                        );
11527                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus));
11528 
11529                 } <span class="keywordflow">else</span> {
11530                     printf(<span class="stringliteral">"Failed\n"</span>);
11531                     printf(<span class="stringliteral">"        Returned Value Doesn't Match Set Value.\n"</span>);
11532                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11533                 }
11534             } <span class="keywordflow">else</span> {
11535                 printf(<span class="stringliteral">"Failed\n"</span>);
11536                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
11537                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11538             }
11539             SamFreeMemory( Buffer1 );
11540             IgnoreStatus = SamCloseHandle( UserHandle1 );
11541             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
11542 
11543 
11544         printf(<span class="stringliteral">"      Set Expires . . . . . . . . . . . . . . . . . . . . .     "</span>);
11545         printf(<span class="stringliteral">"BROKEN TEST - NOT TESTED\n"</span>);
11546 <span class="preprocessor">#ifdef BROKEN</span>
11547 <span class="preprocessor"></span>            NtStatus = SamOpenUser(
11548                            DomainHandle,
11549                            USER_WRITE_ACCOUNT | USER_READ_ACCOUNT,
11550                            DOMAIN_USER_RID_ADMIN,
11551                            &amp;UserHandle1
11552                            );
11553             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
11554 
11555             <a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
11556             NtStatus = SamQueryInformationUser(
11557                            UserHandle1,
11558                            UserExpiresInformation,
11559                            &amp;Buffer1
11560                            );
11561             TST_SUCCESS_ASSERT(NtStatus);
11562             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Buffer1 != NULL);
11563 
11564             <span class="comment">//</span>
11565             <span class="comment">// Change the value and write it back</span>
11566             <span class="comment">//</span>
11567 
11568             ((USER_EXPIRES_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;AccountExpires.LowPart  += 1234;
11569             ((USER_EXPIRES_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;AccountExpires.HighPart += 1234;
11570 
11571 
11572             NtStatus = SamSetInformationUser(
11573                            UserHandle1,
11574                            UserExpiresInformation,
11575                            Buffer1
11576                            );
11577             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
11578 
11579                 <span class="comment">//</span>
11580                 <span class="comment">// Check the written value to make sure it stuck</span>
11581                 <span class="comment">//</span>
11582 
11583                 <a class="code" href="../../d9/d0/tfilmem_8c.html#a2">Buffer2</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
11584                 NtStatus = SamQueryInformationUser(
11585                                UserHandle1,
11586                                UserExpiresInformation,
11587                                &amp;Buffer2
11588                                );
11589                 TST_SUCCESS_ASSERT(NtStatus);
11590                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Buffer2 != NULL);
11591 
11592                 <span class="keywordflow">if</span> ( ( ((USER_EXPIRES_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;AccountExpires.LowPart  ==
11593                        ((USER_EXPIRES_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a2">Buffer2</a>)-&gt;AccountExpires.LowPart )  &amp;&amp;
11594                      ( ((USER_EXPIRES_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;AccountExpires.HighPart  ==
11595                        ((USER_EXPIRES_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a2">Buffer2</a>)-&gt;AccountExpires.HighPart ) ) {
11596 
11597                     printf(<span class="stringliteral">"Succeeded\n"</span>);
11598 
11599                     SamFreeMemory( Buffer2 );
11600 
11601                     <span class="comment">//</span>
11602                     <span class="comment">// Change the values back</span>
11603                     <span class="comment">//</span>
11604 
11605                     ((USER_EXPIRES_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;AccountExpires.LowPart  += 1234;
11606                     ((USER_EXPIRES_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;AccountExpires.HighPart += 1234;
11607 
11608                     IgnoreStatus = SamSetInformationUser(
11609                                        UserHandle1,
11610                                        UserExpiresInformation,
11611                                        Buffer1
11612                                        );
11613                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus));
11614 
11615                 } <span class="keywordflow">else</span> {
11616                     printf(<span class="stringliteral">"Failed\n"</span>);
11617                     printf(<span class="stringliteral">"        Returned Value Doesn't Match Set Value.\n"</span>);
11618                     TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11619                 }
11620             } <span class="keywordflow">else</span> {
11621                 printf(<span class="stringliteral">"Failed\n"</span>);
11622                 printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
11623                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11624             }
11625             SamFreeMemory( Buffer1 );
11626             IgnoreStatus = SamCloseHandle( UserHandle1 );
11627             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
11628 <span class="preprocessor">#endif //BROKEN</span>
11629 <span class="preprocessor"></span>
11630 
11631 
11633         <span class="comment">//                                                                       //</span>
11634         <span class="comment">// Change Password For User Suite                                        //</span>
11635         <span class="comment">//                                                                       //</span>
11637 <span class="comment"></span>
11638         printf(<span class="stringliteral">"\n"</span>);
11639         printf(<span class="stringliteral">"    Change Password For User  . . . . . . . . . . . . . .   Suite\n"</span>);
11640 
11641         printf(<span class="stringliteral">"      Change Password For Well-Known User . . . . . . . . .     "</span>);
11642 
11643         NtStatus = SamOpenUser(
11644                        DomainHandle,
11645                        USER_CHANGE_PASSWORD,
11646                        DOMAIN_USER_RID_ADMIN,
11647                        &amp;UserHandle1
11648                        );
11649         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus) );
11650 
11651         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
11652 
11653         <span class="comment">//</span>
11654         <span class="comment">// The current password is DummyName2.  Using DummyName2 as the</span>
11655         <span class="comment">// old password, change it to DummyName1 and make sure we get</span>
11656         <span class="comment">// STATUS_SUCCESS.</span>
11657         <span class="comment">//</span>
11658 
11659         NtStatus = SamChangePasswordUser(
11660                        UserHandle1,
11661                        &amp;DummyName2,
11662                        &amp;DummyName1
11663                        );
11664 
11665         <span class="comment">//</span>
11666         <span class="comment">// The current password is DummyName1.  Using something WRONG for</span>
11667         <span class="comment">// the old password, try to change it to DummyName2 and make sure</span>
11668         <span class="comment">// it doesn't succeed.</span>
11669         <span class="comment">//</span>
11670 
11671         <span class="keywordflow">if</span> ( NtStatus == STATUS_SUCCESS ) {
11672 
11673             NtStatus = SamChangePasswordUser(
11674                            UserHandle1,
11675                            &amp;DummyName2,
11676                            &amp;DummyName2
11677                            );
11678 
11679             <span class="keywordflow">if</span> ( NtStatus == STATUS_SUCCESS ) {
11680 
11681                 NtStatus = STATUS_UNSUCCESSFUL;
11682 
11683             } <span class="keywordflow">else</span> {
11684 
11685                 NtStatus = STATUS_SUCCESS;
11686             }
11687         }
11688 
11689         <span class="comment">//</span>
11690         <span class="comment">// The current password is DummyName1.  Using DummyName1 as the</span>
11691         <span class="comment">// old password, change it to DummyName2 and make sure it works</span>
11692         <span class="comment">// since by default there is no password history.</span>
11693         <span class="comment">//</span>
11694 
11695         <span class="keywordflow">if</span> ( NtStatus == STATUS_SUCCESS ) {
11696 
11697             NtStatus = SamChangePasswordUser(
11698                            UserHandle1,
11699                            &amp;DummyName1,
11700                            &amp;DummyName2
11701                            );
11702         }
11703 
11704         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( NtStatus ) ) {
11705 
11706             printf(<span class="stringliteral">"Succeeded\n"</span>);
11707 
11708         } <span class="keywordflow">else</span> {
11709 
11710             printf(<span class="stringliteral">"Failed\n"</span>);
11711             printf(<span class="stringliteral">"        Status is %lx\n"</span>, NtStatus);
11712 
11713             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11714         }
11715 
11716         IgnoreStatus = SamCloseHandle( UserHandle1 );
11717         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus) );
11718 
11719     }
11720 
11721 <span class="comment">// END PASS #1</span>
11722 
11723     <span class="keywordflow">if</span> (Pass == 2) {
11724 
11725         printf(<span class="stringliteral">"\n"</span>);
11726         printf(<span class="stringliteral">"\n"</span>);
11727         printf(<span class="stringliteral">"  User  (Pass #2) . . . . . . . . . . . . . . . . . . .   Test\n"</span>);
11728 
11729 
11731         <span class="comment">//                                                                       //</span>
11732         <span class="comment">// Delete User  Suite                                                    //</span>
11733         <span class="comment">//                                                                       //</span>
11735 <span class="comment"></span>
11736         printf(<span class="stringliteral">"\n"</span>);
11737         printf(<span class="stringliteral">"    Delete User   . . . . . . . . . . . . . . . . . . . .   Suite\n"</span>);
11738 
11739 
11740 
11741         printf(<span class="stringliteral">"      Delete Normal User  . . . . . . . . . . . . . . . . .     "</span>);
11742 
11743         <span class="comment">//</span>
11744         <span class="comment">// This User was created in pass #1</span>
11745         <span class="comment">//</span>
11746 
11747         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, USER_NAME1 );
11748         NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountNames[0], &amp;AccountNameAnsi, TRUE );
11749         TST_SUCCESS_ASSERT(NtStatus);
11750 
11751         NtStatus = SamLookupNamesInDomain(
11752                        DomainHandle,
11753                        1,
11754                        &amp;AccountNames[0],
11755                        &amp;LookedUpRids,
11756                        &amp;LookedUpUses
11757                        );
11758         TST_SUCCESS_ASSERT(NtStatus);
11759         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(LookedUpUses[0] == SidTypeUser);
11760         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountNames[0] );
11761 
11762 
11763 
11764         UserHandle1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
11765 
11766         NtStatus = SamOpenUser( DomainHandle, DELETE, LookedUpRids[0], &amp;UserHandle1 );
11767         TST_SUCCESS_ASSERT(NtStatus);
11768         SamFreeMemory( LookedUpUses ); SamFreeMemory( LookedUpRids );
11769 
11770         NtStatus = SamDeleteUser( UserHandle1 );
11771         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
11772             printf(<span class="stringliteral">"Succeeded\n"</span>);
11773 
11774         } <span class="keywordflow">else</span> {
11775             printf(<span class="stringliteral">"Failed\n"</span>);
11776             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
11777             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11778         }
11779 
11780 
11781 
11782 
11783         printf(<span class="stringliteral">"      Delete Admin Group Member . . . . . . . . . . . . . .     "</span>);
11784         printf(<span class="stringliteral">"(Unimplemented)\n"</span>);
11785 
11786         printf(<span class="stringliteral">"      Delete Last Admin Group Member  . . . . . . . . . . .     "</span>);
11787         printf(<span class="stringliteral">"(Unimplemented)\n"</span>);
11788 
11789 
11790 
11791 
11792 
11794         <span class="comment">//                                                                       //</span>
11795         <span class="comment">// Set User Suite                                                        //</span>
11796         <span class="comment">//                                                                       //</span>
11798 <span class="comment"></span>
11799         printf(<span class="stringliteral">"\n"</span>);
11800         printf(<span class="stringliteral">"    Set User (Pass 2) . . . . . . . . . . . . . . . . . .   Suite\n"</span>);
11801 
11802         printf(<span class="stringliteral">"      Set ALL information. . . . . . . . . . . .     "</span>);
11803         printf(<span class="stringliteral">"BROKEN TEST - NOT TESTED\n"</span>);
11804 <span class="preprocessor">#ifdef BROKEN</span>
11805 <span class="preprocessor"></span>
11806         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, <span class="stringliteral">"AllUser"</span> );
11807         NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountName, &amp;AccountNameAnsi, TRUE );
11808         TST_SUCCESS_ASSERT(NtStatus);
11809 
11810         UserRid = 0;
11811         UserHandle1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
11812         NtStatus = SamCreateUserInDomain(
11813                        DomainHandle,
11814                        &amp;AccountName,
11815                        USER_ALL_ACCESS,
11816                        &amp;UserHandle1,
11817                        &amp;UserRid
11818                        );
11819         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountName );
11820 
11821         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
11822 
11823         All = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
11824 
11825         NtStatus = SamQueryInformationUser(
11826                        UserHandle1,
11827                        UserAllInformation,
11828                        &amp;All
11829                        );
11830 
11831         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( NtStatus ) ) {
11832 
11833             <span class="comment">//</span>
11834             <span class="comment">// Now change some of the data, and set it</span>
11835             <span class="comment">//</span>
11836 
11837             <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;TmpAnsiString, <span class="stringliteral">"FullName"</span> );
11838             TmpStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
11839                             (PUNICODE_STRING)(&amp;All-&gt;FullName),
11840                             &amp;TmpAnsiString,
11841                             TRUE );
11842             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( TmpStatus ) );
11843 
11844             <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;TmpAnsiString, <span class="stringliteral">"HomeDirectory"</span> );
11845             TmpStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
11846                             (PUNICODE_STRING)(&amp;All-&gt;HomeDirectory),
11847                             &amp;TmpAnsiString,
11848                             TRUE );
11849             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( TmpStatus ) );
11850 
11851             <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;TmpAnsiString, <span class="stringliteral">"HomeDirectoryDrive"</span> );
11852             TmpStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
11853                             (PUNICODE_STRING)(&amp;All-&gt;HomeDirectoryDrive),
11854                             &amp;TmpAnsiString,
11855                             TRUE );
11856             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( TmpStatus ) );
11857 
11858             <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;TmpAnsiString, <span class="stringliteral">"ScriptPath"</span> );
11859             TmpStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
11860                             (PUNICODE_STRING)(&amp;All-&gt;ScriptPath),
11861                             &amp;TmpAnsiString,
11862                             TRUE );
11863             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( TmpStatus ) );
11864 
11865             <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;TmpAnsiString, <span class="stringliteral">"ProfilePath"</span> );
11866             TmpStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
11867                             (PUNICODE_STRING)(&amp;All-&gt;ProfilePath),
11868                             &amp;TmpAnsiString,
11869                             TRUE );
11870             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( TmpStatus ) );
11871 
11872             <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;TmpAnsiString, <span class="stringliteral">"AdminComment"</span> );
11873             TmpStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
11874                             (PUNICODE_STRING)(&amp;All-&gt;AdminComment),
11875                             &amp;TmpAnsiString,
11876                             TRUE );
11877             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( TmpStatus ) );
11878 
11879             <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;TmpAnsiString, <span class="stringliteral">"WorkStations"</span> );
11880             TmpStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
11881                             (PUNICODE_STRING)(&amp;All-&gt;WorkStations),
11882                             &amp;TmpAnsiString,
11883                             TRUE );
11884             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( TmpStatus ) );
11885 
11886             <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;TmpAnsiString, <span class="stringliteral">"UserComment"</span> );
11887             TmpStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
11888                             (PUNICODE_STRING)(&amp;All-&gt;UserComment),
11889                             &amp;TmpAnsiString,
11890                             TRUE );
11891             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( TmpStatus ) );
11892 
11893             <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;TmpAnsiString, <span class="stringliteral">"Parameters"</span> );
11894             TmpStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
11895                             (PUNICODE_STRING)(&amp;All-&gt;Parameters),
11896                             &amp;TmpAnsiString,
11897                             TRUE );
11898             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( TmpStatus ) );
11899 
11900             All-&gt;CountryCode = 7;
11901             All-&gt;CodePage = 8;
11902 
11903             All-&gt;PasswordExpired = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
11904             All-&gt;NtPasswordPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
11905             All-&gt;LmPasswordPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
11906 
11907             <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;TmpAnsiString, <span class="stringliteral">"NtPassword"</span> );
11908             TmpStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
11909                             (PUNICODE_STRING)(&amp;All-&gt;NtPassword),
11910                             &amp;TmpAnsiString,
11911                             TRUE );
11912             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( TmpStatus ) );
11913 
11914             All-&gt;LogonHours.UnitsPerWeek = 7;
11915 
11916             All-&gt;WhichFields =  ( USER_ALL_FULLNAME |
11917                                 USER_ALL_HOMEDIRECTORY |
11918                                 USER_ALL_HOMEDIRECTORYDRIVE |
11919                                 USER_ALL_SCRIPTPATH |
11920                                 USER_ALL_PROFILEPATH |
11921                                 USER_ALL_ADMINCOMMENT |
11922                                 USER_ALL_WORKSTATIONS |
11923                                 USER_ALL_USERCOMMENT |
11924                                 USER_ALL_PARAMETERS |
11925                                 USER_ALL_COUNTRYCODE |
11926                                 USER_ALL_CODEPAGE |
11927                                 USER_ALL_PASSWORDEXPIRED |
11928                                 USER_ALL_NTPASSWORDPRESENT |
11929                                 USER_ALL_LOGONHOURS );
11930 
11931             NtStatus = SamSetInformationUser(
11932                            UserHandle1,
11933                            UserAllInformation,
11934                            All
11935                            );
11936 
11937             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( NtStatus ) ) {
11938 
11939                 NtStatus = SamQueryInformationUser(
11940                                UserHandle1,
11941                                UserAllInformation,
11942                                &amp;All2
11943                                );
11944 
11945                 <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( NtStatus ) ) {
11946 
11947                     <span class="comment">//</span>
11948                     <span class="comment">// Verify that queried info is as we set it</span>
11949                     <span class="comment">//</span>
11950 
11951                     <span class="keywordflow">if</span> (
11952 
11953                         <span class="comment">//</span>
11954                         <span class="comment">// Fields that we didn't touch.  Note that</span>
11955                         <span class="comment">// PasswordMustChange changed anyway, since we</span>
11956                         <span class="comment">// changed from a null to a non-null password.</span>
11957                         <span class="comment">//</span>
11958 
11959                         ( All2-&gt;WhichFields != (USER_ALL_READ_GENERAL_MASK    |
11960                                                USER_ALL_READ_PREFERENCES_MASK |
11961                                                USER_ALL_READ_ACCOUNT_MASK     |
11962                                                USER_ALL_READ_LOGON_MASK) ) ||
11963                         ( !(All-&gt;LastLogon.QuadPart ==
11964                             All2-&gt;LastLogon.QuadPart ) ) ||
11965                         ( !(All-&gt;LastLogoff.QuadPart ==
11966                             All2-&gt;LastLogoff.QuadPart ) ) ||
11967                         ( !(All-&gt;PasswordLastSet.QuadPart ==
11968                             All2-&gt;PasswordLastSet.QuadPart ) ) ||
11969                         ( !(All-&gt;AccountExpires.QuadPart ==
11970                             All2-&gt;AccountExpires.QuadPart ) ) ||
11971                         ( !(All-&gt;PasswordCanChange.QuadPart ==
11972                             All2-&gt;PasswordCanChange.QuadPart ) ) ||
11973                         (  (All-&gt;PasswordMustChange.QuadPart ==
11974                             All2-&gt;PasswordMustChange.QuadPart ) ) ||
11975                         (<a class="code" href="../../d6/d6/nls_8c.html#a41">RtlCompareUnicodeString</a>(
11976                             &amp;(All-&gt;UserName),
11977                             &amp;(All2-&gt;UserName),
11978                             FALSE) != 0) ||
11979                         ( All-&gt;UserId != All2-&gt;UserId ) ||
11980                         ( All-&gt;PrimaryGroupId != All2-&gt;PrimaryGroupId ) ||
11981                         ( All-&gt;UserAccountControl != All2-&gt;UserAccountControl ) ||
11982                         ( All-&gt;PrivateDataSensitive !=
11983                             All2-&gt;PrivateDataSensitive ) ||
11984 
11985                         <span class="comment">// Fields that we changed.  Note that we set</span>
11986                         <span class="comment">// NtPasswordSet, but it shouldn't be set on return.</span>
11987 
11988                         (<a class="code" href="../../d6/d6/nls_8c.html#a41">RtlCompareUnicodeString</a>(
11989                             &amp;(All-&gt;FullName),
11990                             &amp;(All2-&gt;FullName),
11991                             FALSE) != 0) ||
11992                         (<a class="code" href="../../d6/d6/nls_8c.html#a41">RtlCompareUnicodeString</a>(
11993                             &amp;(All-&gt;HomeDirectory),
11994                             &amp;(All2-&gt;HomeDirectory),
11995                             FALSE) != 0) ||
11996                         (<a class="code" href="../../d6/d6/nls_8c.html#a41">RtlCompareUnicodeString</a>(
11997                             &amp;(All-&gt;HomeDirectoryDrive),
11998                             &amp;(All2-&gt;HomeDirectoryDrive),
11999                             FALSE) != 0) ||
12000                         (<a class="code" href="../../d6/d6/nls_8c.html#a41">RtlCompareUnicodeString</a>(
12001                             &amp;(All-&gt;ScriptPath),
12002                             &amp;(All2-&gt;ScriptPath),
12003                             FALSE) != 0) ||
12004                         (<a class="code" href="../../d6/d6/nls_8c.html#a41">RtlCompareUnicodeString</a>(
12005                             &amp;(All-&gt;ProfilePath),
12006                             &amp;(All2-&gt;ProfilePath),
12007                             FALSE) != 0) ||
12008                         (<a class="code" href="../../d6/d6/nls_8c.html#a41">RtlCompareUnicodeString</a>(
12009                             &amp;(All-&gt;AdminComment),
12010                             &amp;(All2-&gt;AdminComment),
12011                             FALSE) != 0) ||
12012                         (<a class="code" href="../../d6/d6/nls_8c.html#a41">RtlCompareUnicodeString</a>(
12013                             &amp;(All-&gt;WorkStations),
12014                             &amp;(All2-&gt;WorkStations),
12015                             FALSE) != 0) ||
12016                         (<a class="code" href="../../d6/d6/nls_8c.html#a41">RtlCompareUnicodeString</a>(
12017                             &amp;(All-&gt;UserComment),
12018                             &amp;(All2-&gt;UserComment),
12019                             FALSE) != 0) ||
12020                         (<a class="code" href="../../d6/d6/nls_8c.html#a41">RtlCompareUnicodeString</a>(
12021                             &amp;(All-&gt;Parameters),
12022                             &amp;(All2-&gt;Parameters),
12023                             FALSE) != 0) ||
12024                         ( All-&gt;CountryCode != All2-&gt;CountryCode ) ||
12025                         ( All-&gt;CodePage != All2-&gt;CodePage ) ||
12026                         ( All-&gt;LmPasswordPresent != All2-&gt;LmPasswordPresent ) ||
12027                         ( All-&gt;NtPasswordPresent == All2-&gt;NtPasswordPresent ) ||
12028                         ( All-&gt;LogonHours.UnitsPerWeek !=
12029                             All2-&gt;LogonHours.UnitsPerWeek )
12030                         ) {
12031 
12032                         NtStatus = STATUS_DATA_ERROR;
12033                     }
12034 
12035                     SamFreeMemory( All2 );
12036                 }
12037             }
12038 
12039             SamFreeMemory( All );
12040         }
12041 
12042         <span class="keywordflow">if</span> (NtStatus == STATUS_SUCCESS) {
12043 
12044             printf(<span class="stringliteral">"Succeeded\n"</span>);
12045 
12046         } <span class="keywordflow">else</span> {
12047             printf(<span class="stringliteral">"Failed\n"</span>);
12048             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
12049             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
12050         }
12051 
12052         <span class="comment">//</span>
12053         <span class="comment">// Now get rid of the user account if necessary</span>
12054         <span class="comment">//</span>
12055 
12056         NtStatus = SamDeleteUser( UserHandle1 );
12057         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
12058 <span class="preprocessor">#endif //BROKEN</span>
12059 <span class="preprocessor"></span>
12060 
12061         printf(<span class="stringliteral">"      Set Primary Group (non member). . . . . . . . . . . .     "</span>);
12062         <span class="comment">//</span>
12063         <span class="comment">// The following user might already exist (from earlier in the test)</span>
12064         <span class="comment">//</span>
12065 
12066         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, USER_NAME1 );
12067         NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountName, &amp;AccountNameAnsi, TRUE );
12068         TST_SUCCESS_ASSERT(NtStatus);
12069 
12070         <span class="comment">//InitializeObjectAttributes( &amp;ObjectAttributes, &amp;AccountName, 0, 0, NULL );</span>
12071 
12072 
12073         UserRid = 0;
12074         UserHandle1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
12075         NtStatus = SamCreateUserInDomain(
12076                        DomainHandle,
12077                        &amp;AccountName,
12078                        USER_ALL_ACCESS,
12079                        &amp;UserHandle1,
12080                        &amp;UserRid
12081                        );
12082         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountName );
12083         DeleteUser = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
12084         <span class="keywordflow">if</span> (NtStatus == STATUS_USER_EXISTS) {
12085             DeleteUser = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
12086             <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, USER_NAME1 );
12087             NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountNames[0], &amp;AccountNameAnsi, TRUE );
12088             TST_SUCCESS_ASSERT(NtStatus);
12089 
12090             NtStatus = SamLookupNamesInDomain(
12091                            DomainHandle,
12092                            1,
12093                            &amp;AccountNames[0],
12094                            &amp;LookedUpRids,
12095                            &amp;LookedUpUses
12096                            );
12097             TST_SUCCESS_ASSERT(NtStatus);
12098             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(LookedUpUses[0] == SidTypeUser);
12099             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountNames[0] );
12100             NtStatus = SamOpenUser(
12101                            DomainHandle,
12102                            USER_ALL_ACCESS,
12103                            LookedUpRids[0],
12104                            &amp;UserHandle1);
12105             SamFreeMemory( LookedUpUses ); SamFreeMemory( LookedUpRids );
12106         }
12107 
12108         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
12109 
12110 
12111         <span class="comment">//</span>
12112         <span class="comment">// The user is not a member of DOMAIN_GROUP_RID_ADMINS.</span>
12113         <span class="comment">// See if we can make this group the user's primary group</span>
12114         <span class="comment">//</span>
12115 
12116         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<span class="keyword">sizeof</span>(GroupRid) == <span class="keyword">sizeof</span>(USER_PRIMARY_GROUP_INFORMATION));
12117         GroupRid = DOMAIN_GROUP_RID_ADMINS;
12118         NtStatus = SamSetInformationUser(
12119                        UserHandle1,
12120                        UserPrimaryGroupInformation,
12121                        &amp;GroupRid
12122                        );
12123 
12124         <span class="keywordflow">if</span> (NtStatus == STATUS_MEMBER_NOT_IN_GROUP) {
12125 
12126             printf(<span class="stringliteral">"Succeeded\n"</span>);
12127 
12128         } <span class="keywordflow">else</span> {
12129             printf(<span class="stringliteral">"Failed\n"</span>);
12130             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
12131             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
12132         }
12133 
12134 
12135         <span class="comment">//</span>
12136         <span class="comment">// Now get rid of the user account if necessary</span>
12137         <span class="comment">//</span>
12138 
12139         <span class="keywordflow">if</span> (DeleteUser == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
12140             NtStatus = SamDeleteUser( UserHandle1 );
12141             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
12142         } <span class="keywordflow">else</span> {
12143             NtStatus = SamCloseHandle( UserHandle1 );
12144             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
12145         }
12146 
12147 
12148 
12149         printf(<span class="stringliteral">"      Set Primary Group (member). . . . . . . . . . . . . .     "</span>);
12150 
12151         <span class="comment">//</span>
12152         <span class="comment">// Make a user (might already exist)</span>
12153         <span class="comment">// Make a group</span>
12154         <span class="comment">// Make the group the user's primary group</span>
12155         <span class="comment">// Change the user so the group isn't the primary group</span>
12156         <span class="comment">// remove the group</span>
12157         <span class="comment">// delete the group</span>
12158         <span class="comment">// If we created the user, delete it.</span>
12159 
12160         <span class="comment">//</span>
12161         <span class="comment">// The following user might already exist (from earlier in the test)</span>
12162         <span class="comment">//</span>
12163 
12164         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, USER_NAME1 );
12165         NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountName, &amp;AccountNameAnsi, TRUE );
12166         TST_SUCCESS_ASSERT(NtStatus);
12167 
12168         <span class="comment">//InitializeObjectAttributes( &amp;ObjectAttributes, &amp;AccountName, 0, 0, NULL );</span>
12169 
12170         UserRid = 0;
12171         UserHandle1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
12172         NtStatus = SamCreateUserInDomain(
12173                        DomainHandle,
12174                        &amp;AccountName,
12175                        USER_ALL_ACCESS,
12176                        &amp;UserHandle1,
12177                        &amp;UserRid
12178                        );
12179         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountName );
12180         DeleteUser = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
12181         <span class="keywordflow">if</span> (NtStatus == STATUS_USER_EXISTS) {
12182             DeleteUser = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
12183             <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, USER_NAME1 );
12184             NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountNames[0], &amp;AccountNameAnsi, TRUE );
12185             TST_SUCCESS_ASSERT(NtStatus);
12186 
12187             NtStatus = SamLookupNamesInDomain(
12188                            DomainHandle,
12189                            1,
12190                            &amp;AccountNames[0],
12191                            &amp;LookedUpRids,
12192                            &amp;LookedUpUses
12193                            );
12194             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountNames[0] );
12195             TST_SUCCESS_ASSERT(NtStatus);
12196             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(LookedUpUses[0] == SidTypeUser);
12197             UserRid = LookedUpRids[0];
12198             NtStatus = SamOpenUser(
12199                            DomainHandle,
12200                            USER_ALL_ACCESS,
12201                            UserRid,
12202                            &amp;UserHandle1);
12203             SamFreeMemory( LookedUpUses ); SamFreeMemory( LookedUpRids );
12204         }
12205 
12206         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
12207 
12208 
12209         <span class="comment">//</span>
12210         <span class="comment">// create the group</span>
12211         <span class="comment">//</span>
12212 
12213         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( &amp;AccountNameAnsi, GROUP_NAME1 );
12214         NtStatus = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;AccountName, &amp;AccountNameAnsi, TRUE );
12215         TST_SUCCESS_ASSERT(NtStatus);
12216 
12217         <span class="comment">//InitializeObjectAttributes( &amp;ObjectAttributes, &amp;AccountName, 0, 0, NULL );</span>
12218 
12219         GroupRid = 0;
12220         GroupHandle1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
12221         NtStatus = SamCreateGroupInDomain(
12222                        DomainHandle,
12223                        &amp;AccountName,
12224                        GROUP_ALL_ACCESS,
12225                        &amp;GroupHandle1,
12226                        &amp;GroupRid
12227                        );
12228         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;AccountName );
12229         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
12230 
12231         <span class="comment">//</span>
12232         <span class="comment">// Make the user a member of this group</span>
12233         <span class="comment">//</span>
12234 
12235         NtStatus = SamAddMemberToGroup(
12236                        GroupHandle1,
12237                        UserRid,
12238                        SE_GROUP_MANDATORY              |
12239                            SE_GROUP_ENABLED_BY_DEFAULT |
12240                            SE_GROUP_ENABLED
12241                        );
12242         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
12243 
12244 
12245         <span class="comment">//</span>
12246         <span class="comment">// Set the user's primary group Id to be this group</span>
12247         <span class="comment">//</span>
12248 
12249         NtStatus = SamSetInformationUser(
12250                        UserHandle1,
12251                        UserPrimaryGroupInformation,
12252                        &amp;GroupRid
12253                        );
12254         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus)) {
12255 
12256             <a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
12257             NtStatus = SamQueryInformationUser(
12258                            UserHandle1,
12259                            UserPrimaryGroupInformation,
12260                            &amp;Buffer1
12261                            );
12262             TST_SUCCESS_ASSERT(NtStatus);
12263             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Buffer1 != NULL);
12264 
12265             <span class="keywordflow">if</span> ( ((USER_PRIMARY_GROUP_INFORMATION *)<a class="code" href="../../d9/d0/tfilmem_8c.html#a1">Buffer1</a>)-&gt;PrimaryGroupId  ==
12266                  GroupRid ) {
12267 
12268                 printf(<span class="stringliteral">"Succeeded\n"</span>);
12269 
12270                 SamFreeMemory( Buffer1 );
12271             } <span class="keywordflow">else</span> {
12272 
12273                 printf(<span class="stringliteral">"Failed\n"</span>);
12274                 printf(<span class="stringliteral">"        Returned Value Doesn't Match Set Value.\n"</span>);
12275                 printf(<span class="stringliteral">"        Value written is: 0x%lx\n"</span>, GroupRid);
12276                 printf(<span class="stringliteral">"      Value retrieved is: 0x%lx\n"</span>,
12277                     ((USER_PRIMARY_GROUP_INFORMATION *)Buffer1)-&gt;PrimaryGroupId);
12278                 TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
12279 
12280             }
12281 
12282         } <span class="keywordflow">else</span> {
12283             printf(<span class="stringliteral">"Failed\n"</span>);
12284             printf(<span class="stringliteral">"        Completion status is 0x%lx\n"</span>, NtStatus);
12285             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
12286         }
12287 
12288 
12289         <span class="comment">//</span>
12290         <span class="comment">// Set the user's primary group Id back and remove the user</span>
12291         <span class="comment">// from the group</span>
12292         <span class="comment">//</span>
12293 
12294         GroupRid = DOMAIN_GROUP_RID_USERS;
12295         NtStatus = SamSetInformationUser(
12296                        UserHandle1,
12297                        UserPrimaryGroupInformation,
12298                        &amp;GroupRid
12299                        );
12300         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
12301         NtStatus = SamRemoveMemberFromGroup(GroupHandle1, UserRid);
12302         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
12303 
12304 
12305 
12306         <span class="comment">//</span>
12307         <span class="comment">// Now get rid of the group and possibly the user account</span>
12308         <span class="comment">//</span>
12309 
12310 
12311         NtStatus = SamDeleteGroup( GroupHandle1 );
12312         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
12313 
12314         <span class="keywordflow">if</span> (DeleteUser == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
12315             NtStatus = SamDeleteUser( UserHandle1 );
12316             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
12317         } <span class="keywordflow">else</span> {
12318             NtStatus = SamCloseHandle( UserHandle1 );
12319             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(NtStatus));
12320         }
12321 
12322 
12323 
12324 
12325 
12326 
12327 
12328 
12329 
12330         printf(<span class="stringliteral">"      Set Name Information  . . . . . . . . . . . . . . . .     "</span>);
12331         printf(<span class="stringliteral">"(Untested)\n"</span>);
12332 
12333 
12334     }
12335 
12336     <span class="keywordflow">return</span>(TestStatus);
12337 
12338 }
12339 <span class="preprocessor">#endif // NOT_PART_OF_PROGRAM</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:09 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
