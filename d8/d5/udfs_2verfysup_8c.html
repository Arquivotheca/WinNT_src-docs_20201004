<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: udfs/verfysup.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>verfysup.c File Reference</h1><code>#include "UdfProcs.h"</code><br>

<p>
<a href="../../d9/d4/udfs_2verfysup_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d5/udfs_2verfysup_8c.html#a0">BugCheckFileId</a>&nbsp;&nbsp;&nbsp;(UDFS_BUG_CHECK_VERFYSUP)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d5/udfs_2verfysup_8c.html#a1">Dbg</a>&nbsp;&nbsp;&nbsp;(UDFS_DEBUG_LEVEL_VERFYSUP)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d5/udfs_2verfysup_8c.html#a2">UdfPerformVerify</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceToVerify)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d5/udfs_2verfysup_8c.html#a3">UdfCheckForDismount</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb, IN BOOLEAN Force)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d5/udfs_2verfysup_8c.html#a4">UdfDismountVcb</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d5/udfs_2verfysup_8c.html#a5">UdfVerifyVcb</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d5/udfs_2verfysup_8c.html#a6">UdfVerifyFcbOperation</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext OPTIONAL, IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="udfs/verfysup.c::BugCheckFileId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BugCheckFileId&nbsp;&nbsp;&nbsp;(UDFS_BUG_CHECK_VERFYSUP)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00027">27</a> of file <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html">udfs/verfysup.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="udfs/verfysup.c::Dbg" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define Dbg&nbsp;&nbsp;&nbsp;(UDFS_DEBUG_LEVEL_VERFYSUP)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00033">33</a> of file <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html">udfs/verfysup.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a3" doxytag="udfs/verfysup.c::UdfCheckForDismount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfCheckForDismount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Force</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00236">236</a> of file <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html">udfs/verfysup.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00363">ASSERT_EXCLUSIVE_UDFDATA</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00336">ASSERT_VCB</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00134">IoAcquireVpbSpinLock()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09644">IoReleaseVpbSpinLock()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01515">UdfAcquireVcbExclusive</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01210">UdfDeleteVcb()</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00365">UdfDismountVcb()</a>, <a class="el" href="../../d3/d8/close_8c-source.html#l00099">UdfFspClose()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01559">UdfLockVcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01521">UdfReleaseVcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01563">UdfUnlockVcb</a>, and <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a121">VcbDismountInProgress</a>.
<p>
Referenced by <a class="el" href="../../d3/d8/close_8c-source.html#l00319">UdfCommonClose()</a>, <a class="el" href="../../d3/d8/close_8c-source.html#l00099">UdfFspClose()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01271">UdfInvalidateVolumes()</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00042">UdfPerformVerify()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00194">UdfPnpQueryRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00350">UdfPnpRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00500">UdfPnpSurpriseRemove()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l03749">UdfScanForDismountedVcb()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02043">UdfVerifyVolume()</a>.
<p>
<pre class="fragment"><div>00244                    :
00245 
00246     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to check <span class="keywordflow">if</span> a volume <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ready <span class="keywordflow">for</span> dismount.  This
00247     occurs when <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system references are left on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume.
00248 
00249     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dismount <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not currently underway and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user reference count
00250     has gone to zero then we can begin <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dismount.
00251 
00252     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dismount <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in progress and there are no references left on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00253     volume (we check the Vpb <span class="keywordflow">for</span> outstanding references as well to <span class="keywordflow">catch</span>
00254     any create calls dispatched to the file system) then we can <span class="keyword">delete</span>
00255     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Vcb.
00256 
00257 Arguments:
00258 
00259     Vcb - Vcb <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume to <span class="keywordflow">try</span> to dismount.
00260     
00261     Force - Whether we will force <span class="keyword">this</span> volume to be dismounted.
00262 
00263 Return Value:
00264 
00265     BOOLEAN - True <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Vcb was not gone by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> time <span class="keyword">this</span> function finished,
00266         False <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> was deleted.
00267         
00268     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> a trustworthy indication to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> had <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> vcb
00269     exclusive itself.
00270 
00271 --*/
00272 
00273 {
00274     BOOLEAN UnlockVcb = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00275     BOOLEAN VcbPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00276     KIRQL SavedIrql;
00277 
00278     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00279     <a class="code" href="../../d1/d8/udfdata_8h.html#a12">ASSERT_VCB</a>( Vcb );
00280 
00281     <a class="code" href="../../d1/d8/udfdata_8h.html#a39">ASSERT_EXCLUSIVE_UDFDATA</a>;
00282 
00283     <span class="comment">//</span>
00284     <span class="comment">//  Acquire and lock this Vcb to check the dismount state.</span>
00285     <span class="comment">//</span>
00286 
00287     <a class="code" href="../../d3/d8/udfprocs_8h.html#a74">UdfAcquireVcbExclusive</a>( IrpContext, Vcb, FALSE );
00288 
00289     <span class="comment">//</span>
00290     <span class="comment">//  Lets get rid of any pending closes for this volume.</span>
00291     <span class="comment">//</span>
00292 
00293     <a class="code" href="../../d3/d8/udfprocs_8h.html#a250">UdfFspClose</a>( Vcb );
00294 
00295     <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
00296 
00297     <span class="comment">//</span>
00298     <span class="comment">//  If the dismount is not already underway then check if the</span>
00299     <span class="comment">//  user reference count has gone to zero or we are being forced</span>
00300     <span class="comment">//  to disconnect.  If so start the teardown on the Vcb.</span>
00301     <span class="comment">//</span>
00302 
00303     <span class="keywordflow">if</span> (Vcb-&gt;VcbCondition != <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a121">VcbDismountInProgress</a>) {
00304 
00305         <span class="keywordflow">if</span> (Vcb-&gt;VcbUserReference &lt;= Vcb-&gt;VcbResidualUserReference || Force) {
00306 
00307             <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00308             UnlockVcb = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00309             VcbPresent = <a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a4">UdfDismountVcb</a>( IrpContext, Vcb );
00310         }
00311 
00312     <span class="comment">//</span>
00313     <span class="comment">//  If the teardown is underway and there are absolutely no references</span>
00314     <span class="comment">//  remaining then delete the Vcb.  References here include the</span>
00315     <span class="comment">//  references in the Vcb and Vpb.</span>
00316     <span class="comment">//</span>
00317 
00318     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Vcb-&gt;VcbReference == 0) {
00319 
00320         <a class="code" href="../../d4/d6/iosubs_8c.html#a10">IoAcquireVpbSpinLock</a>( &amp;SavedIrql );
00321 
00322         <span class="comment">//</span>
00323         <span class="comment">//  If there are no file objects and no reference counts in the</span>
00324         <span class="comment">//  Vpb we can delete the Vcb.  Don't forget that we have the</span>
00325         <span class="comment">//  last reference in the Vpb.</span>
00326         <span class="comment">//</span>
00327 
00328         <span class="keywordflow">if</span> (Vcb-&gt;Vpb-&gt;ReferenceCount == 1) {
00329 
00330             <a class="code" href="../../d4/d6/iosubs_8c.html#a102">IoReleaseVpbSpinLock</a>( SavedIrql );
00331             <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00332             UnlockVcb = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00333             <a class="code" href="../../d3/d8/udfprocs_8h.html#a206">UdfDeleteVcb</a>( IrpContext, Vcb );
00334             VcbPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00335 
00336         } <span class="keywordflow">else</span> {
00337 
00338             <a class="code" href="../../d4/d6/iosubs_8c.html#a102">IoReleaseVpbSpinLock</a>( SavedIrql );
00339         }
00340     }
00341 
00342     <span class="comment">//</span>
00343     <span class="comment">//  Unlock the Vcb if still held.</span>
00344     <span class="comment">//</span>
00345 
00346     <span class="keywordflow">if</span> (UnlockVcb) {
00347 
00348         <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00349     }
00350 
00351     <span class="comment">//</span>
00352     <span class="comment">//  Release any resources still acquired.</span>
00353     <span class="comment">//</span>
00354 
00355     <span class="keywordflow">if</span> (VcbPresent) {
00356 
00357         <a class="code" href="../../d3/d8/udfprocs_8h.html#a76">UdfReleaseVcb</a>( IrpContext, Vcb );
00358     }
00359 
00360     <span class="keywordflow">return</span> VcbPresent;
00361 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="udfs/verfysup.c::UdfDismountVcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfDismountVcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00365">365</a> of file <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html">udfs/verfysup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00363">ASSERT_EXCLUSIVE_UDFDATA</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00364">ASSERT_EXCLUSIVE_VCB</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01072">_VPB::DeviceObject</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01070">_VPB::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00044">IO_TYPE_VPB</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00134">IoAcquireVpbSpinLock()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09644">IoReleaseVpbSpinLock()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01073">_VPB::RealDevice</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01075">_VPB::ReferenceCount</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01069">_VPB::Size</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00174">TAG_VPB</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01068">_VPB::Type</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01210">UdfDeleteVcb()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00453">UdfFreePool()</a>, <a class="el" href="../../d3/d8/close_8c-source.html#l00099">UdfFspClose()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01559">UdfLockVcb</a>, <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00417">UdfPurgeVolume()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01563">UdfUnlockVcb</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a121">VcbDismountInProgress</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01186">_DEVICE_OBJECT::Vpb</a>, <a class="el" href="../../d0/d5/io_8h.html#a332">VPB</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01054">VPB_MOUNTED</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01057">VPB_REMOVE_PENDING</a>.
<p>
Referenced by <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00236">UdfCheckForDismount()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01444">UdfMountVolume()</a>.
<p>
<pre class="fragment"><div>00372                    :
00373 
00374     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user references to a volume are
00375     gone.  We will initiate all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> teardown any system resources.
00376 
00377     If all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> references to <span class="keyword">this</span> volume are gone at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <span class="keyword">this</span> routine
00378     then we will complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> teardown of <span class="keyword">this</span> Vcb and mark <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current Vpb
00379     as not mounted.  Otherwise we will allocated a <span class="keyword">new</span> Vpb <span class="keywordflow">for</span> <span class="keyword">this</span> device
00380     and keep <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current Vpb attached to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Vcb.
00381 
00382 Arguments:
00383 
00384     Vcb - Vcb <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume to dismount.
00385 
00386 Return Value:
00387 
00388     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> we didn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> <span class="keyword">delete</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Vcb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
00389 
00390 --*/
00391 
00392 {
00393     <a class="code" href="../../d7/d7/struct__VPB.html">PVPB</a> OldVpb;
00394     <a class="code" href="../../d7/d7/struct__VPB.html">PVPB</a> NewVpb;
00395     BOOLEAN VcbPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00396     KIRQL SavedIrql;
00397 
00398     BOOLEAN FinalReference;
00399 
00400     <a class="code" href="../../d1/d8/udfdata_8h.html#a39">ASSERT_EXCLUSIVE_UDFDATA</a>;
00401     <a class="code" href="../../d1/d8/udfdata_8h.html#a40">ASSERT_EXCLUSIVE_VCB</a>( Vcb );
00402 
00403     <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
00404 
00405     <span class="comment">//</span>
00406     <span class="comment">//  We should only take this path once.</span>
00407     <span class="comment">//</span>
00408 
00409     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Vcb-&gt;VcbCondition != VcbDismountInProgress );
00410 
00411     <span class="comment">//</span>
00412     <span class="comment">//  Mark the Vcb as DismountInProgress.</span>
00413     <span class="comment">//</span>
00414 
00415     Vcb-&gt;VcbCondition = <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a121">VcbDismountInProgress</a>;
00416 
00417     <span class="comment">//</span>
00418     <span class="comment">//  Remove our reference to the internal Fcb's.  The Fcb's will then</span>
00419     <span class="comment">//  be removed in the purge path below.</span>
00420     <span class="comment">//</span>
00421 
00422     <span class="keywordflow">if</span> (Vcb-&gt;RootIndexFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00423 
00424         Vcb-&gt;RootIndexFcb-&gt;FcbReference -= 1;
00425         Vcb-&gt;RootIndexFcb-&gt;FcbUserReference -= 1;
00426     }
00427 
00428     <span class="keywordflow">if</span> (Vcb-&gt;MetadataFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00429 
00430         Vcb-&gt;MetadataFcb-&gt;FcbReference -= 1;
00431         Vcb-&gt;MetadataFcb-&gt;FcbUserReference -= 1;
00432     }
00433 
00434     <span class="keywordflow">if</span> (Vcb-&gt;VatFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00435 
00436         Vcb-&gt;VatFcb-&gt;FcbReference -= 1;
00437         Vcb-&gt;VatFcb-&gt;FcbUserReference -= 1;
00438     }
00439 
00440     <span class="keywordflow">if</span> (Vcb-&gt;VolumeDasdFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00441 
00442         Vcb-&gt;VolumeDasdFcb-&gt;FcbReference -= 1;
00443         Vcb-&gt;VolumeDasdFcb-&gt;FcbUserReference -= 1;
00444     }
00445 
00446     <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00447 
00448     <span class="comment">//</span>
00449     <span class="comment">//  Purge the volume.</span>
00450     <span class="comment">//</span>
00451 
00452     <a class="code" href="../../d3/d8/udfprocs_8h.html#a158">UdfPurgeVolume</a>( IrpContext, Vcb, TRUE );
00453 
00454     <span class="comment">//</span>
00455     <span class="comment">//  Empty the delayed and async close queues.</span>
00456     <span class="comment">//</span>
00457 
00458     <a class="code" href="../../d3/d8/udfprocs_8h.html#a250">UdfFspClose</a>( Vcb );
00459 
00460     <span class="comment">//</span>
00461     <span class="comment">//  Allocate a new Vpb in case we will need it.</span>
00462     <span class="comment">//</span>
00463 
00464     NewVpb = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( NonPagedPoolMustSucceed, <span class="keyword">sizeof</span>( <a class="code" href="../../d7/d7/struct__VPB.html">VPB</a> ), TAG_VPB );
00465     RtlZeroMemory( NewVpb, <span class="keyword">sizeof</span>( <a class="code" href="../../d7/d7/struct__VPB.html">VPB</a> ) );
00466 
00467     OldVpb = Vcb-&gt;Vpb;
00468 
00469     <span class="comment">//</span>
00470     <span class="comment">//  Remove the mount volume reference.</span>
00471     <span class="comment">//</span>
00472 
00473     <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
00474     Vcb-&gt;VcbReference -= 1;
00475 
00476     <span class="comment">//</span>
00477     <span class="comment">//  Acquire the Vpb spinlock to check for Vpb references.</span>
00478     <span class="comment">//</span>
00479 
00480     <a class="code" href="../../d4/d6/iosubs_8c.html#a10">IoAcquireVpbSpinLock</a>( &amp;SavedIrql );
00481 
00482     <span class="comment">//</span>
00483     <span class="comment">//  Remember if this is the last reference on this Vcb.  We incremented</span>
00484     <span class="comment">//  the count on the Vpb earlier so we get one last crack it.  If our</span>
00485     <span class="comment">//  reference has gone to zero but the vpb reference count is greater</span>
00486     <span class="comment">//  than zero then the Io system will be responsible for deleting the</span>
00487     <span class="comment">//  Vpb.</span>
00488     <span class="comment">//</span>
00489 
00490     FinalReference = (BOOLEAN) ((Vcb-&gt;VcbReference == 0) &amp;&amp;
00491                                 (OldVpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o7">ReferenceCount</a> == 1));
00492 
00493     <span class="comment">//</span>
00494     <span class="comment">//  There is a reference count in the Vpb and in the Vcb.  We have</span>
00495     <span class="comment">//  incremented the reference count in the Vpb to make sure that</span>
00496     <span class="comment">//  we have last crack at it.  If this is a failed mount then we</span>
00497     <span class="comment">//  want to return the Vpb to the IO system to use for the next</span>
00498     <span class="comment">//  mount request.</span>
00499     <span class="comment">//</span>
00500 
00501     <span class="keywordflow">if</span> (OldVpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o5">RealDevice</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o10">Vpb</a> == OldVpb) {
00502 
00503         <span class="comment">//</span>
00504         <span class="comment">//  If not the final reference then swap out the Vpb.  We must</span>
00505         <span class="comment">//  preserve the REMOVE_PENDING flag so that the device is</span>
00506         <span class="comment">//  not remounted in the middle of a PnP remove operation.</span>
00507         <span class="comment">//</span>
00508 
00509         <span class="keywordflow">if</span> (!FinalReference) {
00510 
00511             NewVpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o0">Type</a> = <a class="code" href="../../d0/d5/io_8h.html#a9">IO_TYPE_VPB</a>;
00512             NewVpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o1">Size</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d7/d7/struct__VPB.html">VPB</a> );
00513             NewVpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o5">RealDevice</a> = OldVpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o5">RealDevice</a>;
00514 
00515             NewVpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o5">RealDevice</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o10">Vpb</a> = NewVpb;
00516 
00517             NewVpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o2">Flags</a> = <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( OldVpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o2">Flags</a>, VPB_REMOVE_PENDING );
00518             
00519             NewVpb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00520             <a class="code" href="../../d4/d6/iosubs_8c.html#a102">IoReleaseVpbSpinLock</a>( SavedIrql );
00521             <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00522 
00523         <span class="comment">//</span>
00524         <span class="comment">//  We want to leave the Vpb for the IO system.  Mark it</span>
00525         <span class="comment">//  as being not mounted.  Go ahead and delete the Vcb as</span>
00526         <span class="comment">//  well.</span>
00527         <span class="comment">//</span>
00528 
00529         } <span class="keywordflow">else</span> {
00530 
00531             <span class="comment">//</span>
00532             <span class="comment">//  Make sure to remove the last reference on the Vpb.</span>
00533             <span class="comment">//</span>
00534 
00535             OldVpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o7">ReferenceCount</a> -= 1;
00536 
00537             OldVpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o4">DeviceObject</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00538             <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( Vcb-&gt;Vpb-&gt;Flags, VPB_MOUNTED );
00539 
00540             <span class="comment">//</span>
00541             <span class="comment">//  Clear the Vpb flag so we know not to delete it.</span>
00542             <span class="comment">//</span>
00543 
00544             Vcb-&gt;Vpb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00545 
00546             <a class="code" href="../../d4/d6/iosubs_8c.html#a102">IoReleaseVpbSpinLock</a>( SavedIrql );
00547             <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00548             <a class="code" href="../../d3/d8/udfprocs_8h.html#a206">UdfDeleteVcb</a>( IrpContext, Vcb );
00549             VcbPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00550         }
00551 
00552     <span class="comment">//</span>
00553     <span class="comment">//  Someone has already swapped in a new Vpb.  If this is the final reference</span>
00554     <span class="comment">//  then the file system is responsible for deleting the Vpb.</span>
00555     <span class="comment">//</span>
00556 
00557     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (FinalReference) {
00558 
00559         <span class="comment">//</span>
00560         <span class="comment">//  Make sure to remove the last reference on the Vpb.</span>
00561         <span class="comment">//</span>
00562 
00563         OldVpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o7">ReferenceCount</a> -= 1;
00564 
00565         <a class="code" href="../../d4/d6/iosubs_8c.html#a102">IoReleaseVpbSpinLock</a>( SavedIrql );
00566         <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00567         <a class="code" href="../../d3/d8/udfprocs_8h.html#a206">UdfDeleteVcb</a>( IrpContext, Vcb );
00568         VcbPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00569 
00570     <span class="comment">//</span>
00571     <span class="comment">//  The current Vpb is no longer the Vpb for the device (the IO system</span>
00572     <span class="comment">//  has already allocated a new one).  We leave our reference in the</span>
00573     <span class="comment">//  Vpb and will be responsible for deleting it at a later time.</span>
00574     <span class="comment">//</span>
00575 
00576     } <span class="keywordflow">else</span> {
00577 
00578         OldVpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o4">DeviceObject</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00579         <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( Vcb-&gt;Vpb-&gt;Flags, VPB_MOUNTED );
00580 
00581         <a class="code" href="../../d4/d6/iosubs_8c.html#a102">IoReleaseVpbSpinLock</a>( SavedIrql );
00582         <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00583     }
00584 
00585     <span class="comment">//</span>
00586     <span class="comment">//  Deallocate the new Vpb if we don't need it.</span>
00587     <span class="comment">//</span>
00588 
00589     <span class="keywordflow">if</span> (NewVpb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00590 
00591         <a class="code" href="../../d3/d8/udfprocs_8h.html#a124">UdfFreePool</a>( &amp;NewVpb );
00592     }
00593 
00594     <span class="comment">//</span>
00595     <span class="comment">//  Let our caller know whether the Vcb is still present.</span>
00596     <span class="comment">//</span>
00597 
00598     <span class="keywordflow">return</span> VcbPresent;
00599 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="udfs/verfysup.c::UdfPerformVerify" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfPerformVerify           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceToVerify</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00042">42</a> of file <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html">udfs/verfysup.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00356">ASSERT_IRP</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02488">_IO_STACK_LOCATION::DeviceObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01153">DO_VERIFY_VOLUME</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01534">_FILE_OBJECT::FileName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00251">IO_REMOUNT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03528">IoIsErrorUserInduced</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09796">IoSetHardErrorOrVerifyDevice()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l11389">IoVerifyVolume()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00055">IRP_MJ_CREATE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00068">IRP_MJ_FILE_SYSTEM_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00113">IRP_MN_MOUNT_VOLUME</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00114">IRP_MN_VERIFY_VOLUME</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01524">_FILE_OBJECT::RelatedFileObject</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01509">UdfAcquireUdfData</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00236">UdfCheckForDismount()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00448">UdfExceptionFilter()</a>, <a class="el" href="../../d3/d8/workque_8c-source.html#l00061">UdfFsdPostRequest()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00418">UdfNormalizeAndRaiseStatus()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00539">UdfProcessException()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01512">UdfReleaseUdfData</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00559">_VCB::VcbCondition</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a121">VcbDismountInProgress</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a120">VcbInvalid</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a119">VcbMounted</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a117">VcbNotMounted</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00612">_VCB::VcbReference</a>, and <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00620">_VCB::VcbResidualReference</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00539">UdfProcessException()</a>.
<p>
<pre class="fragment"><div>00050                    :
00051 
00052     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> performs an <a class="code" href="../../d0/d5/io_8h.html#a564">IoVerifyVolume</a> operation and takes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00053     appropriate action.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> verify <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> successful then we send <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> originating
00054     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> off to an Ex Worker Thread.  This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception handler.
00055 
00056     No <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system resources are held when <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called.
00057 
00058 Arguments:
00059 
00060     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - The irp to send off after all <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> well and done.
00061 
00062     Device - The real device needing verification.
00063 
00064 Return Value:
00065 
00066     None.
00067 
00068 --*/
00069 
00070 {
00071     <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb;
00072     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00073     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
00074 
00075     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00076     <a class="code" href="../../d1/d8/udfdata_8h.html#a32">ASSERT_IRP</a>( Irp );
00077 
00078     <span class="comment">//</span>
00079     <span class="comment">//  Check if this Irp has a status of Verify required and if it does</span>
00080     <span class="comment">//  then call the I/O system to do a verify.</span>
00081     <span class="comment">//</span>
00082     <span class="comment">//  Skip the IoVerifyVolume if this is a mount or verify request</span>
00083     <span class="comment">//  itself.  Trying a recursive mount will cause a deadlock with</span>
00084     <span class="comment">//  the DeviceObject-&gt;DeviceLock.</span>
00085     <span class="comment">//</span>
00086 
00087     <span class="keywordflow">if</span> ((IrpContext-&gt;MajorFunction == <a class="code" href="../../d0/d5/io_8h.html#a26">IRP_MJ_FILE_SYSTEM_CONTROL</a>) &amp;&amp;
00088         ((IrpContext-&gt;MinorFunction == <a class="code" href="../../d0/d5/io_8h.html#a47">IRP_MN_MOUNT_VOLUME</a>) ||
00089          (IrpContext-&gt;MinorFunction == <a class="code" href="../../d0/d5/io_8h.html#a48">IRP_MN_VERIFY_VOLUME</a>))) {
00090 
00091         <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/workque_8c.html#a4">UdfFsdPostRequest</a>( IrpContext, Irp );
00092     }
00093 
00094     <span class="comment">//</span>
00095     <span class="comment">//  Extract a pointer to the Vcb from the VolumeDeviceObject.</span>
00096     <span class="comment">//  Note that since we have specifically excluded mount,</span>
00097     <span class="comment">//  requests, we know that IrpSp-&gt;DeviceObject is indeed a</span>
00098     <span class="comment">//  volume device object.</span>
00099     <span class="comment">//</span>
00100 
00101     IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00102 
00103     Vcb = &amp;CONTAINING_RECORD( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o57">DeviceObject</a>,
00104                               <a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html">VOLUME_DEVICE_OBJECT</a>,
00105                               DeviceObject )-&gt;Vcb;
00106 
00107     <span class="comment">//</span>
00108     <span class="comment">//  Check if the volume still thinks it needs to be verified,</span>
00109     <span class="comment">//  if it doesn't then we can skip doing a verify because someone</span>
00110     <span class="comment">//  else beat us to it.</span>
00111     <span class="comment">//</span>
00112 
00113     <span class="keywordflow">try</span> {
00114 
00115         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( DeviceToVerify-&gt;Flags, DO_VERIFY_VOLUME )) {
00116 
00117             BOOLEAN AllowRawMount = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00118 
00119             <span class="comment">//</span>
00120             <span class="comment">//  We will allow Raw to mount this volume if we were doing a</span>
00121             <span class="comment">//  an absolute DASD open.</span>
00122             <span class="comment">//</span>
00123 
00124             <span class="keywordflow">if</span> ((IrpContext-&gt;MajorFunction == <a class="code" href="../../d0/d5/io_8h.html#a13">IRP_MJ_CREATE</a>) &amp;&amp;
00125                 (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>.Length == 0) &amp;&amp;
00126                 (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o9">RelatedFileObject</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00127 
00128                 AllowRawMount = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00129             }
00130 
00131             <span class="comment">//</span>
00132             <span class="comment">//  If the IopMount in IoVerifyVolume did something, and</span>
00133             <span class="comment">//  this is an absolute open, force a reparse.</span>
00134             <span class="comment">//</span>
00135 
00136             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a122">IoVerifyVolume</a>( DeviceToVerify, AllowRawMount );
00137 
00138             <span class="comment">//</span>
00139             <span class="comment">//  If the verify operation completed it will return</span>
00140             <span class="comment">//  either STATUS_SUCCESS or STATUS_WRONG_VOLUME, exactly.</span>
00141             <span class="comment">//</span>
00142             <span class="comment">//  If UdfVerifyVolume encountered an error during</span>
00143             <span class="comment">//  processing, it will return that error.  If we got</span>
00144             <span class="comment">//  STATUS_WRONG_VOLUME from the verify, and our volume</span>
00145             <span class="comment">//  is now mounted, commute the status to STATUS_SUCCESS.</span>
00146             <span class="comment">//</span>
00147 
00148             <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_WRONG_VOLUME) &amp;&amp;
00149                 (Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> == <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a119">VcbMounted</a>)) {
00150 
00151                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00152             }
00153 
00154             <span class="comment">//</span>
00155             <span class="comment">//  Do a quick unprotected check here.  The routine will do</span>
00156             <span class="comment">//  a safe check.  After here we can release the resource.</span>
00157             <span class="comment">//  Note that if the volume really went away, we will be taking</span>
00158             <span class="comment">//  the Reparse path.</span>
00159             <span class="comment">//</span>
00160 
00161             <span class="comment">//</span>
00162             <span class="comment">//  If the device might need to go away then call our dismount routine.</span>
00163             <span class="comment">//</span>
00164 
00165             <span class="keywordflow">if</span> (((Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> == <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a117">VcbNotMounted</a>) ||
00166                  (Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> == <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a120">VcbInvalid</a>) ||
00167                  (Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> == <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a121">VcbDismountInProgress</a>)) &amp;&amp;
00168                 (Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o16">VcbReference</a> &lt;= Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o18">VcbResidualReference</a>)) {
00169 
00170                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a72">UdfAcquireUdfData</a>( IrpContext );
00171                 <a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a3">UdfCheckForDismount</a>( IrpContext, Vcb, FALSE );
00172                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a73">UdfReleaseUdfData</a>( IrpContext );
00173             }
00174 
00175             <span class="comment">//</span>
00176             <span class="comment">//  If this is a create and the verify succeeded then complete the</span>
00177             <span class="comment">//  request with a REPARSE status.</span>
00178             <span class="comment">//</span>
00179 
00180             <span class="keywordflow">if</span> ((IrpContext-&gt;MajorFunction == <a class="code" href="../../d0/d5/io_8h.html#a13">IRP_MJ_CREATE</a>) &amp;&amp;
00181                 (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o9">RelatedFileObject</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00182                 ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) || (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_WRONG_VOLUME))) {
00183 
00184                 <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = <a class="code" href="../../d0/d5/io_8h.html#a109">IO_REMOUNT</a>;
00185 
00186                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_REPARSE );
00187                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REPARSE;
00188                 <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00189                 IrpContext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00190 
00191             <span class="comment">//</span>
00192             <span class="comment">//  If there is still an error to process then call the Io system</span>
00193             <span class="comment">//  for a popup.</span>
00194             <span class="comment">//</span>
00195 
00196             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00197 
00198                 <span class="comment">//</span>
00199                 <span class="comment">//  Fill in the device object if required.</span>
00200                 <span class="comment">//</span>
00201 
00202                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/io_8h.html#a232">IoIsErrorUserInduced</a>( Status ) ) {
00203 
00204                     <a class="code" href="../../d4/d6/iosubs_8c.html#a105">IoSetHardErrorOrVerifyDevice</a>( Irp, DeviceToVerify );
00205                 }
00206 
00207                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a123">UdfNormalizeAndRaiseStatus</a>( IrpContext, Status );
00208             }
00209         }
00210 
00211         <span class="comment">//</span>
00212         <span class="comment">//  If there is still an Irp, send it off to an Ex Worker thread.</span>
00213         <span class="comment">//</span>
00214 
00215         <span class="keywordflow">if</span> (IrpContext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00216 
00217             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d9/workque_8c.html#a4">UdfFsdPostRequest</a>( IrpContext, Irp );
00218         }
00219 
00220     } except(<a class="code" href="../../d3/d8/udfprocs_8h.html#a127">UdfExceptionFilter</a>( IrpContext, GetExceptionInformation() )) {
00221 
00222         <span class="comment">//</span>
00223         <span class="comment">//  We had some trouble trying to perform the verify or raised</span>
00224         <span class="comment">//  an error ourselves.  So we'll abort the I/O request with</span>
00225         <span class="comment">//  the error status that we get back from the execption code.</span>
00226         <span class="comment">//</span>
00227 
00228         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a128">UdfProcessException</a>( IrpContext, Irp, GetExceptionCode() );
00229     }
00230 
00231     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00232 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="udfs/verfysup.c::UdfVerifyFcbOperation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfVerifyFcbOperation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Fcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00760">760</a> of file <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html">udfs/verfysup.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01153">DO_VERIFY_VOLUME</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01184">_DEVICE_OBJECT::Flags</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09796">IoSetHardErrorOrVerifyDevice()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01073">_VPB::RealDevice</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00559">_VCB::VcbCondition</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a121">VcbDismountInProgress</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a120">VcbInvalid</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a119">VcbMounted</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a118">VcbMountInProgress</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a117">VcbNotMounted</a>, and <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00529">_VCB::Vpb</a>.
<p>
Referenced by <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00046">UdfCommonLockControl()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00156">UdfCommonQueryInfo()</a>, <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00385">UdfCommonSetInfo()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00152">UdfFastLock()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00496">UdfFastQueryBasicInfo()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00740">UdfFastQueryNetworkInfo()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00614">UdfFastQueryStdInfo()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00436">UdfFastUnlockAll()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00557">UdfFastUnlockAllByKey()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00297">UdfFastUnlockSingle()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00470">UdfOplockRequest()</a>, and <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00334">UdfQueryDirectory()</a>.
<p>
<pre class="fragment"><div>00767                    :
00768 
00769     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to verify that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid
00770     to allow <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current operation to <span class="keywordflow">continue</span>.  We use <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00771     Vcb, target device and <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of operation to determine <span class="keyword">this</span>.
00772 
00773 Arguments:
00774 
00775     IrpContext - IrpContext <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request.  If not present then we
00776         were called from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fast IO <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.
00777 
00778     Fcb - Fcb to perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request on.
00779 
00780 Return Value:
00781 
00782     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request can <span class="keywordflow">continue</span>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
00783 
00784 --*/
00785 
00786 {
00787     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00788     <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb = Fcb-&gt;Vcb;
00789     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> RealDevice = Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o2">Vpb</a>-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o5">RealDevice</a>;
00790 
00791     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00792 
00793     <span class="comment">//</span>
00794     <span class="comment">//  Fail immediately if the volume is in the progress of being dismounted</span>
00795     <span class="comment">//  or has been marked invalid.</span>
00796     <span class="comment">//</span>
00797 
00798     <span class="keywordflow">if</span> ((Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> == <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a120">VcbInvalid</a>) ||
00799         (Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> == <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a121">VcbDismountInProgress</a>)) {
00800 
00801         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( IrpContext )) {
00802 
00803             <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_FILE_INVALID );
00804         }
00805 
00806         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00807     }
00808 
00809     <span class="comment">//</span>
00810     <span class="comment">//  Always fail if the volume needs to be verified.</span>
00811     <span class="comment">//</span>
00812 
00813     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( RealDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a>, DO_VERIFY_VOLUME )) {
00814 
00815         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( IrpContext )) {
00816 
00817             <a class="code" href="../../d4/d6/iosubs_8c.html#a105">IoSetHardErrorOrVerifyDevice</a>( IrpContext-&gt;Irp,
00818                                           RealDevice );
00819 
00820             <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_VERIFY_REQUIRED );
00821         }
00822 
00823         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00824 
00825     <span class="comment">//</span>
00826     <span class="comment">//  All operations are allowed on mounted volumes.</span>
00827     <span class="comment">//</span>
00828 
00829     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> == <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a119">VcbMounted</a>) ||
00830                (Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> == <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a118">VcbMountInProgress</a>)) {
00831 
00832         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00833 
00834     <span class="comment">//</span>
00835     <span class="comment">//  Fail all requests for fast Io on other Vcb conditions.</span>
00836     <span class="comment">//</span>
00837 
00838     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( IrpContext )) {
00839 
00840         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00841 
00842     <span class="comment">//</span>
00843     <span class="comment">//  The remaining case is VcbNotMounted.</span>
00844     <span class="comment">//  Mark the device to be verified and raise WRONG_VOLUME.</span>
00845     <span class="comment">//</span>
00846 
00847     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> == <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a117">VcbNotMounted</a>) {
00848 
00849         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( IrpContext )) {
00850 
00851             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>(RealDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a>, DO_VERIFY_VOLUME);
00852 
00853             <a class="code" href="../../d4/d6/iosubs_8c.html#a105">IoSetHardErrorOrVerifyDevice</a>( IrpContext-&gt;Irp, RealDevice );
00854             <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_WRONG_VOLUME );
00855         }
00856 
00857         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00858     }
00859 
00860     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00861 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="udfs/verfysup.c::UdfVerifyVcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfVerifyVcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00603">603</a> of file <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html">udfs/verfysup.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01153">DO_VERIFY_VOLUME</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09796">IoSetHardErrorOrVerifyDevice()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l02115">UdfIsRawDevice</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00418">UdfNormalizeAndRaiseStatus()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00573">UdfPerformDevIoCtrl()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00684">VCB_STATE_REMOVABLE_MEDIA</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a121">VcbDismountInProgress</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a120">VcbInvalid</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a119">VcbMounted</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a118">VcbMountInProgress</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a117">VcbNotMounted</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00108">UdfCommonCreate()</a>, <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00069">UdfCommonDevControl()</a>, <a class="el" href="../../d8/d5/volinfo_8c-source.html#l00082">UdfCommonQueryVolInfo()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01175">UdfIsVolumeMounted()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00780">UdfLockVolume()</a>, and <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00904">UdfNotifyChangeDirectory()</a>.
<p>
<pre class="fragment"><div>00610                    :
00611 
00612     This routine checks that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current Vcb <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid and currently mounted
00613     on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device.  It will raise on an error condition.
00614 
00615     We check whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume needs verification and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current state
00616     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Vcb.
00617 
00618 Arguments:
00619 
00620     Vcb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume to verify.
00621 
00622 Return Value:
00623 
00624     None
00625 
00626 --*/
00627 
00628 {
00629     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00630     IO_STATUS_BLOCK Iosb;
00631     ULONG MediaChangeCount = 0;
00632 
00633     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00634 
00635     <span class="comment">//</span>
00636     <span class="comment">//  Fail immediately if the volume is in the progress of being dismounted</span>
00637     <span class="comment">//  or has been marked invalid.</span>
00638     <span class="comment">//</span>
00639 
00640     <span class="keywordflow">if</span> ((Vcb-&gt;VcbCondition == <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a120">VcbInvalid</a>) ||
00641         (Vcb-&gt;VcbCondition == <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a121">VcbDismountInProgress</a>)) {
00642 
00643         <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_FILE_INVALID );
00644     }
00645 
00646     <span class="comment">//</span>
00647     <span class="comment">//  If the media is removable and the verify volume flag in the</span>
00648     <span class="comment">//  device object is not set then we want to ping the device</span>
00649     <span class="comment">//  to see if it needs to be verified</span>
00650     <span class="comment">//</span>
00651 
00652     <span class="keywordflow">if</span> ((Vcb-&gt;VcbCondition != <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a118">VcbMountInProgress</a>) &amp;&amp;
00653         <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Vcb-&gt;VcbState, VCB_STATE_REMOVABLE_MEDIA ) &amp;&amp;
00654         !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Vcb-&gt;Vpb-&gt;RealDevice-&gt;Flags, DO_VERIFY_VOLUME )) {
00655 
00656         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a159">UdfPerformDevIoCtrl</a>( IrpContext,
00657                                       ( Vcb-&gt;Vpb-&gt;RealDevice-&gt;DeviceType == FILE_DEVICE_CD_ROM ?
00658                                         IOCTL_CDROM_CHECK_VERIFY :
00659                                         IOCTL_DISK_CHECK_VERIFY ),
00660                                       Vcb-&gt;TargetDeviceObject,
00661                                       &amp;MediaChangeCount,
00662                                       <span class="keyword">sizeof</span>(ULONG),
00663                                       FALSE,
00664                                       FALSE,
00665                                       &amp;Iosb );
00666 
00667         <span class="keywordflow">if</span> (Iosb.Information != <span class="keyword">sizeof</span>(ULONG)) {
00668     
00669             <span class="comment">//</span>
00670             <span class="comment">//  Be safe about the count in case the driver didn't fill it in</span>
00671             <span class="comment">//</span>
00672     
00673             MediaChangeCount = 0;
00674         }
00675 
00676         <span class="comment">//</span>
00677         <span class="comment">//  If the volume is now an empty device, or we have receieved a</span>
00678         <span class="comment">//  bare STATUS_VERIFY_REQUIRED (various hardware conditions such</span>
00679         <span class="comment">//  as bus resets, etc., will trigger this in the drivers), or the</span>
00680         <span class="comment">//  media change count has moved since we last inspected the device,</span>
00681         <span class="comment">//  then mark the volume to be verified.</span>
00682         <span class="comment">//      </span>
00683 
00684         <span class="keywordflow">if</span> ((Vcb-&gt;VcbCondition == <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a119">VcbMounted</a> &amp;&amp;
00685              <a class="code" href="../../d3/d8/udfprocs_8h.html#a100">UdfIsRawDevice</a>( IrpContext, Status )) ||
00686             (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_VERIFY_REQUIRED) ||
00687             (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) &amp;&amp;
00688              (Vcb-&gt;MediaChangeCount != MediaChangeCount))) {
00689 
00690             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Vcb-&gt;Vpb-&gt;RealDevice-&gt;Flags, DO_VERIFY_VOLUME );
00691 
00692             <span class="comment">//</span>
00693             <span class="comment">//  If the volume is not mounted and we got a media change count,</span>
00694             <span class="comment">//  update the Vcb so we do not trigger a verify again at this</span>
00695             <span class="comment">//  count value.  If the verify-&gt;mount path detects that the media</span>
00696             <span class="comment">//  has actually changed and this Vcb is valid again, this will have</span>
00697             <span class="comment">//  done nothing.  We are already synchronized since the caller has</span>
00698             <span class="comment">//  the Vcb.</span>
00699             <span class="comment">//</span>
00700 
00701             <span class="keywordflow">if</span> ((Vcb-&gt;VcbCondition == <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a117">VcbNotMounted</a>) &amp;&amp;
00702                 <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00703 
00704                 Vcb-&gt;MediaChangeCount = MediaChangeCount;
00705             }
00706 
00707         <span class="comment">//</span>
00708         <span class="comment">//  Raise the error condition otherwise.</span>
00709         <span class="comment">//</span>
00710 
00711         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00712 
00713             <a class="code" href="../../d3/d8/udfprocs_8h.html#a123">UdfNormalizeAndRaiseStatus</a>( IrpContext, Status );
00714         }
00715 
00716     }
00717 
00718     <span class="comment">//</span>
00719     <span class="comment">//  The Vcb may be mounted but the underlying real device may need to be verified.</span>
00720     <span class="comment">//  If it does then we'll set the Iosb in the irp to be our real device</span>
00721     <span class="comment">//  and raise Verify required</span>
00722     <span class="comment">//</span>
00723 
00724     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Vcb-&gt;Vpb-&gt;RealDevice-&gt;Flags, DO_VERIFY_VOLUME )) {
00725 
00726         <a class="code" href="../../d4/d6/iosubs_8c.html#a105">IoSetHardErrorOrVerifyDevice</a>( IrpContext-&gt;Irp,
00727                                       Vcb-&gt;Vpb-&gt;RealDevice );
00728 
00729         <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_VERIFY_REQUIRED );
00730     }
00731 
00732     <span class="comment">//</span>
00733     <span class="comment">//  Based on the condition of the Vcb we'll either return to our</span>
00734     <span class="comment">//  caller or raise an error condition</span>
00735     <span class="comment">//</span>
00736 
00737     <span class="keywordflow">switch</span> (Vcb-&gt;VcbCondition) {
00738 
00739     <span class="keywordflow">case</span> <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a117">VcbNotMounted</a>:
00740 
00741         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Vcb-&gt;Vpb-&gt;RealDevice-&gt;Flags, DO_VERIFY_VOLUME );
00742 
00743         <a class="code" href="../../d4/d6/iosubs_8c.html#a105">IoSetHardErrorOrVerifyDevice</a>( IrpContext-&gt;Irp, Vcb-&gt;Vpb-&gt;RealDevice );
00744 
00745         <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_WRONG_VOLUME );
00746         <span class="keywordflow">break</span>;
00747 
00748     <span class="keywordflow">case</span> <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a120">VcbInvalid</a>:
00749     <span class="keywordflow">case</span> <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a121">VcbDismountInProgress</a> :
00750 
00751         <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_FILE_INVALID );
00752         <span class="keywordflow">break</span>;
00753     }
00754 
00755     <span class="keywordflow">return</span>;
00756 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:46:07 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
