<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: context.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>context.c</h1><a href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/**************************************************************************\</span>
00002 <span class="comment">* Module Name: context.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Context management routines for imm32 dll</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 03-Jan-1996 wkwok       Created</span>
00010 <span class="comment">\**************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d8/d3/w32_2ntuser_2imm_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span>
<a name="l00015"></a><a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a0">00015</a> <span class="preprocessor">#define IMCC_ALLOC_TOOLARGE             0x1000</span>
00016 <span class="preprocessor"></span>
00017 
00018 <span class="comment">/**************************************************************************\</span>
00019 <span class="comment">* ImmCreateContext</span>
00020 <span class="comment">*</span>
00021 <span class="comment">* Creates and initializes an input context.</span>
00022 <span class="comment">*</span>
00023 <span class="comment">* 17-Jan-1996 wkwok       Created</span>
00024 <span class="comment">\**************************************************************************/</span>
00025 
<a name="l00026"></a><a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a1">00026</a> HIMC WINAPI <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a1">ImmCreateContext</a>(<span class="keywordtype">void</span>)
00027 {
00028     <a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a> pClientImc;
00029     HIMC       hImc = <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>;
00030 
00031     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
00032         <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>;
00033     }
00034 
00035     pClientImc = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(HEAP_ZERO_MEMORY, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d0/structtagCLIENTIMC.html">CLIENTIMC</a>));
00036 
00037     <span class="keywordflow">if</span> (pClientImc != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00038 
00039         hImc = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a385">NtUserCreateInputContext</a>((ULONG_PTR)pClientImc);
00040         <span class="keywordflow">if</span> (hImc == <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>) {
00041             <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(pClientImc);
00042             <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>;
00043         }
00044 
00045         <a class="code" href="../../d9/d0/immuser_8h.html#a0">InitImcCrit</a>(pClientImc);
00046         pClientImc-&gt;dwImeCompatFlags = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a287">NtUserGetThreadState</a>(UserThreadStateImeCompatFlags);
00047     }
00048 
00049     <span class="keywordflow">return</span> hImc;
00050 }
00051 
00052 
00053 <span class="comment">/**************************************************************************\</span>
00054 <span class="comment">* ImmDestroyContext</span>
00055 <span class="comment">*</span>
00056 <span class="comment">* Destroys an input context.</span>
00057 <span class="comment">*</span>
00058 <span class="comment">* 17-Jan-1996 wkwok       Created</span>
00059 <span class="comment">\**************************************************************************/</span>
00060 
<a name="l00061"></a><a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a2">00061</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a2">ImmDestroyContext</a>(
00062     HIMC hImc)
00063 {
00064     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
00065         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00066     }
00067 
00068     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/immcli_8h.html#a15">GetInputContextThread</a>(hImc) != GetCurrentThreadId()) {
00069         RIPMSG1(RIP_WARNING,
00070               <span class="stringliteral">"ImmDestroyContext: Invalid input context access %lx."</span>, hImc);
00071         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00072     }
00073 
00074     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a2031">DestroyInputContext</a>(hImc, <a class="code" href="../../d3/d8/client_8c.html#a154">GetKeyboardLayout</a>(0), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00075 }
00076 
00077 
00078 <span class="comment">/**************************************************************************\</span>
00079 <span class="comment">* ImmAssociateContext</span>
00080 <span class="comment">*</span>
00081 <span class="comment">* Associates an input context to the specified window handle.</span>
00082 <span class="comment">*</span>
00083 <span class="comment">* 17-Jan-1996 wkwok       Created</span>
00084 <span class="comment">\**************************************************************************/</span>
00085 
<a name="l00086"></a><a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a3">00086</a> HIMC WINAPI <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a3">ImmAssociateContext</a>(
00087     HWND hWnd,
00088     HIMC hImc)
00089 {
00090     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pWnd;
00091     HIMC  hPrevImc;
00092     <a class="code" href="../../d8/d0/immstruc_8h.html#a39">AIC_STATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00093 
00094     <span class="comment">// early out</span>
00095     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
00096         <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>;
00097     }
00098 
00099     <span class="keywordflow">if</span> ((pWnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>)) == (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00100         RIPMSG1(RIP_WARNING,
00101               <span class="stringliteral">"ImmAssociateContext: invalid window handle %x"</span>, <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>);
00102         <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>;
00103     }
00104 
00105 
00106 
00107     <span class="keywordflow">if</span> (hImc != <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a> &amp;&amp;
00108             <a class="code" href="../../d4/d0/immcli_8h.html#a15">GetInputContextThread</a>(hImc) != GetCurrentThreadId()) {
00109         RIPMSG1(RIP_WARNING,
00110               <span class="stringliteral">"ImmAssociateContext: Invalid input context access %lx."</span>, hImc);
00111         <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>;
00112     }
00113 
00114     <span class="comment">/*</span>
00115 <span class="comment">     * associate to the same input context, do nothing.</span>
00116 <span class="comment">     */</span>
00117     <span class="keywordflow">if</span> (pWnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o20">hImc</a> == hImc)
00118         <span class="keywordflow">return</span> hImc;
00119 
00120     hPrevImc = pWnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o20">hImc</a>;
00121 
00122     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a387">NtUserAssociateInputContext</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, hImc, 0);
00123 
00124     <span class="keywordflow">switch</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
00125     <span class="keywordflow">case</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a72a44">AIC_FOCUSCONTEXTCHANGED</a>:
00126         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/immcli_8h.html#a22">IsWndEqual</a>(<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a328">NtUserQueryWindow</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, WindowFocusWindow), <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>)) {
00127             <a class="code" href="../../d9/d0/immuser_8h.html#a36">ImmSetActiveContext</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, hPrevImc, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00128             <a class="code" href="../../d9/d0/immuser_8h.html#a36">ImmSetActiveContext</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, hImc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00129         }
00130 
00131         <span class="comment">// Fall thru.</span>
00132 
00133     <span class="keywordflow">case</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a72a43">AIC_SUCCESS</a>:
00134         <span class="keywordflow">return</span> hPrevImc;
00135 
00136     <span class="keywordflow">default</span>:
00137         <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>;
00138     }
00139 }
00140 
00141 
<a name="l00142"></a><a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a4">00142</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a4">ImmAssociateContextEx</a>(
00143     HWND hWnd,
00144     HIMC hImc,
00145     DWORD dwFlag)
00146 {
00147     HWND hWndFocus;
00148     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pWndFocus;
00149     HIMC hImcFocusOld;
00150     <a class="code" href="../../d8/d0/immstruc_8h.html#a39">AIC_STATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00151 
00152     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
00153         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00154     }
00155 
00156     hWndFocus = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a328">NtUserQueryWindow</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, WindowFocusWindow);
00157 
00158     <span class="keywordflow">if</span> (hImc != <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a> &amp;&amp; !(dwFlag &amp; IACE_DEFAULT) &amp;&amp;
00159             <a class="code" href="../../d4/d0/immcli_8h.html#a15">GetInputContextThread</a>(hImc) != GetCurrentThreadId()) {
00160         RIPMSG1(RIP_WARNING,
00161               <span class="stringliteral">"ImmAssociateContextEx: Invalid input context access %lx."</span>, hImc);
00162         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00163     }
00164 
00165     <span class="keywordflow">if</span> ((pWndFocus = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hWndFocus)) != (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00166         hImcFocusOld = pWndFocus-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o20">hImc</a>;
00167     <span class="keywordflow">else</span>
00168         hImcFocusOld = <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>;
00169 
00170     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a387">NtUserAssociateInputContext</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, hImc, dwFlag);
00171 
00172     <span class="keywordflow">switch</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
00173     <span class="keywordflow">case</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a72a44">AIC_FOCUSCONTEXTCHANGED</a>:
00174         <span class="keywordflow">if</span> ((pWndFocus = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hWndFocus)) != (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00175             hImc = pWndFocus-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o20">hImc</a>;
00176             <span class="keywordflow">if</span> (hImc != hImcFocusOld) {
00177                 <a class="code" href="../../d9/d0/immuser_8h.html#a36">ImmSetActiveContext</a>(hWndFocus, hImcFocusOld, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00178                 <a class="code" href="../../d9/d0/immuser_8h.html#a36">ImmSetActiveContext</a>(hWndFocus, hImc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00179             };
00180         };
00181 
00182         <span class="comment">// Fall thru.</span>
00183 
00184     <span class="keywordflow">case</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a72a43">AIC_SUCCESS</a>:
00185         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00186 
00187     <span class="keywordflow">default</span>:
00188         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00189     }
00190 }
00191 
00192 
00193 <span class="comment">/**************************************************************************\</span>
00194 <span class="comment">* ImmGetContext</span>
00195 <span class="comment">*</span>
00196 <span class="comment">* Retrieves the input context that is associated to the given window.</span>
00197 <span class="comment">*</span>
00198 <span class="comment">* 17-Jan-1996 wkwok       Created</span>
00199 <span class="comment">\**************************************************************************/</span>
00200 
<a name="l00201"></a><a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a5">00201</a> HIMC WINAPI <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a5">ImmGetContext</a>(
00202     HWND hWnd)
00203 {
00204     <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00205         RIPMSG1(RIP_WARNING,
00206               <span class="stringliteral">"ImmGetContext: invalid window handle %x"</span>, <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>);
00207         <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>;
00208     }
00209     <span class="comment">/*</span>
00210 <span class="comment">     * for non-NULL hWnd, ImmGetSaveContext will do the</span>
00211 <span class="comment">     * validation and "same process" checking.</span>
00212 <span class="comment">     */</span>
00213     <span class="keywordflow">return</span> <a class="code" href="../../d4/d0/immcli_8h.html#a72">ImmGetSaveContext</a>( <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, <a class="code" href="../../d8/d0/immstruc_8h.html#a14">IGSC_WINNLSCHECK</a> );
00214 }
00215 
00216 
00217 <span class="comment">/**************************************************************************\</span>
00218 <span class="comment">* ImmGetSaveContext</span>
00219 <span class="comment">*</span>
00220 <span class="comment">* Retrieves the input context that is associated to the given window.</span>
00221 <span class="comment">*</span>
00222 <span class="comment">* 15-Mar-1996 wkwok       Created</span>
00223 <span class="comment">\**************************************************************************/</span>
00224 
<a name="l00225"></a><a class="code" href="../../d4/d0/immcli_8h.html#a72">00225</a> HIMC <a class="code" href="../../d4/d0/immcli_8h.html#a72">ImmGetSaveContext</a>(
00226     HWND  hWnd,
00227     DWORD dwFlag)
00228 {
00229     HIMC       hRetImc;
00230     <a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a> pClientImc;
00231     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwnd;
00232 
00233     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
00234         <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>;
00235     }
00236 
00237     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00238         <span class="comment">/*</span>
00239 <span class="comment">         * Retrieves the default input context of current thread.</span>
00240 <span class="comment">         */</span>
00241         hRetImc = (HIMC)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a287">NtUserGetThreadState</a>(UserThreadStateDefaultInputContext);
00242     }
00243     <span class="keywordflow">else</span> {
00244         <span class="comment">/*</span>
00245 <span class="comment">         * Retrieves the input context associated to the given window.</span>
00246 <span class="comment">         */</span>
00247         <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>)) == (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00248             RIPMSG1(RIP_WARNING,
00249                   <span class="stringliteral">"ImmGetSaveContext: invalid window handle %x"</span>, <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>);
00250             <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>;
00251         }
00252         <span class="comment">/*</span>
00253 <span class="comment">         * Don't allow other process to access input context</span>
00254 <span class="comment">         */</span>
00255         <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a16">TestWindowProcess</a>(pwnd)) {
00256             RIPMSG0(RIP_WARNING,
00257                   <span class="stringliteral">"ImmGetSaveContext: can not get input context of other process"</span>);
00258             <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>;
00259         }
00260         hRetImc = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o20">hImc</a>;
00261 
00262         <span class="keywordflow">if</span> (hRetImc == <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a> &amp;&amp; (dwFlag &amp; <a class="code" href="../../d8/d0/immstruc_8h.html#a13">IGSC_DEFIMCFALLBACK</a>)) {
00263             <span class="comment">/*</span>
00264 <span class="comment">             * hWnd associated with NULL input context, retrieves the</span>
00265 <span class="comment">             * default input context of the hWnd's creator thread.</span>
00266 <span class="comment">             */</span>
00267             hRetImc = (HIMC)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a328">NtUserQueryWindow</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, WindowDefaultInputContext);
00268         }
00269     }
00270 
00271     pClientImc = <a class="code" href="../../d9/d0/immuser_8h.html#a43">ImmLockClientImc</a>(hRetImc);
00272     <span class="keywordflow">if</span> (pClientImc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00273         <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>;
00274 
00275     <span class="keywordflow">if</span> ((dwFlag &amp; <a class="code" href="../../d8/d0/immstruc_8h.html#a14">IGSC_WINNLSCHECK</a>) &amp;&amp; <a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a11">IMCF_WINNLSDISABLE</a>))
00276         hRetImc = <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>;
00277 
00278     <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>(pClientImc);
00279 
00280     <span class="keywordflow">return</span> hRetImc;
00281 }
00282 
00283 
00284 <span class="comment">/**************************************************************************\</span>
00285 <span class="comment">* ImmReleaseContext</span>
00286 <span class="comment">*</span>
00287 <span class="comment">* Releases the input context retrieved by ImmGetContext().</span>
00288 <span class="comment">*</span>
00289 <span class="comment">* 17-Jan-1996 wkwok       Created</span>
00290 <span class="comment">\**************************************************************************/</span>
00291 
<a name="l00292"></a><a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a7">00292</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a7">ImmReleaseContext</a>(
00293     HWND hWnd,
00294     HIMC hImc)
00295 {
00296     UNREFERENCED_PARAMETER(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>);
00297     UNREFERENCED_PARAMETER(hImc);
00298 
00299     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00300 }
00301 
00302 
00303 <span class="comment">/**************************************************************************\</span>
00304 <span class="comment">* ImmSetActiveContext</span>
00305 <span class="comment">*</span>
00306 <span class="comment">* 15-Mar-1996 wkwok       Created</span>
00307 <span class="comment">\**************************************************************************/</span>
00308 
<a name="l00309"></a><a class="code" href="../../d9/d0/immuser_8h.html#a36">00309</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d0/immuser_8h.html#a36">ImmSetActiveContext</a>(
00310     HWND hWnd,
00311     HIMC hImc,
00312     BOOL fActivate)
00313 {
00314     <a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a>    pClientImc;
00315     PINPUTCONTEXT pInputContext;
00316     <a class="code" href="../../d2/d7/structtagIMEDPI.html">PIMEDPI</a>       pImeDpi;
00317     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>         dwISC;
00318     HIMC          hSaveImc;
00319     HWND          hDefImeWnd;
00320     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>         dwOpenStatus = 0;
00321     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>         dwConversion = 0;
00322 <span class="preprocessor">#ifdef DEBUG</span>
00323 <span class="preprocessor"></span>    <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>          pWnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>);
00324 
00325     <span class="keywordflow">if</span> (pWnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pWnd) != <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()) {
00326         RIPMSG1(RIP_WARNING, <span class="stringliteral">"hWnd (=%lx) is not of current thread."</span>, <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>);
00327     }
00328 <span class="preprocessor">#endif</span>
00329 <span class="preprocessor"></span>
00330     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
00331         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00332     }
00333 
00334     dwISC = ISC_SHOWUIALL;
00335 
00336     pClientImc = <a class="code" href="../../d9/d0/immuser_8h.html#a43">ImmLockClientImc</a>(hImc);
00337 
00338     <span class="keywordflow">if</span> (!fActivate) {
00339         <span class="keywordflow">if</span> (pClientImc != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00340             <a class="code" href="../../d4/d0/immcli_8h.html#a20">ClrICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a5">IMCF_ACTIVE</a>);
00341         <span class="keywordflow">goto</span> NotifySetActive;
00342     }
00343 
00344     <span class="keywordflow">if</span> (hImc == <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>) {
00345         hSaveImc = <a class="code" href="../../d4/d0/immcli_8h.html#a72">ImmGetSaveContext</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, <a class="code" href="../../d8/d0/immstruc_8h.html#a13">IGSC_DEFIMCFALLBACK</a>);
00346         pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hSaveImc);
00347         <span class="keywordflow">if</span> (pInputContext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00348             pInputContext-&gt;hWnd = <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>;
00349             <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hSaveImc);
00350         }
00351         <span class="keywordflow">goto</span> NotifySetActive;
00352     }
00353 
00354     <span class="comment">/*</span>
00355 <span class="comment">     * Non-NULL input context, window handle have to be updated.</span>
00356 <span class="comment">     */</span>
00357     <span class="keywordflow">if</span> (pClientImc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00358         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00359 
00360     pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hImc);
00361     <span class="keywordflow">if</span> (pInputContext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00362         <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>(pClientImc);
00363         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00364     }
00365 
00366     pInputContext-&gt;hWnd = <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>;
00367     <a class="code" href="../../d4/d0/immcli_8h.html#a19">SetICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a5">IMCF_ACTIVE</a>);
00368 
00369 <span class="preprocessor">#ifdef LATER</span>
00370 <span class="preprocessor"></span>    <span class="comment">// Do uNumLangVKey checking later</span>
00371 <span class="preprocessor">#endif</span>
00372 <span class="preprocessor"></span>
00373     <span class="keywordflow">if</span> (pInputContext-&gt;fdw31Compat &amp; F31COMPAT_MCWHIDDEN)
00374         dwISC = ISC_SHOWUIALL - ISC_SHOWUICOMPOSITIONWINDOW;
00375 
00376     dwOpenStatus = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)pInputContext-&gt;fOpen;
00377     dwConversion = pInputContext-&gt;fdwConversion;
00378     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
00379 
00380 NotifySetActive:
00381 
00382     pImeDpi = <a class="code" href="../../d9/d0/immuser_8h.html#a45">ImmLockImeDpi</a>(<a class="code" href="../../d3/d8/client_8c.html#a154">GetKeyboardLayout</a>(0));
00383     <span class="keywordflow">if</span> (pImeDpi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00384         (*pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o8">pfn</a>.<a class="code" href="../../d3/d7/structtagIMEDPI_1_1__tagImeFunctions.html#o24">ImeSetActiveContext</a>)(hImc, fActivate);
00385         <a class="code" href="../../d9/d0/immuser_8h.html#a46">ImmUnlockImeDpi</a>(pImeDpi);
00386     }
00387 
00388     <span class="comment">/*</span>
00389 <span class="comment">     * Notify UI</span>
00390 <span class="comment">     */</span>
00391     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>)) {
00392         <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, WM_IME_SETCONTEXT, fActivate, dwISC);
00393 
00394         <span class="comment">/*</span>
00395 <span class="comment">         * send notify to shell / keyboard driver</span>
00396 <span class="comment">         */</span>
00397         <span class="keywordflow">if</span> ( fActivate )
00398             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a400">NtUserNotifyIMEStatus</a>( <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, dwOpenStatus, dwConversion );
00399     }
00400     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!fActivate) {
00401         <span class="comment">/*</span>
00402 <span class="comment">         * Because hWnd is not there (maybe destroyed), we send</span>
00403 <span class="comment">         * WM_IME_SETCONTEXT to the default IME window.</span>
00404 <span class="comment">         */</span>
00405         <span class="keywordflow">if</span> ((hDefImeWnd = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a4">ImmGetDefaultIMEWnd</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00406             <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hDefImeWnd, WM_IME_SETCONTEXT, fActivate, dwISC);
00407         }
00408         <span class="keywordflow">else</span> {
00409             RIPMSG0(RIP_WARNING,
00410                   <span class="stringliteral">"ImmSetActiveContext: can't send WM_IME_SETCONTEXT(FALSE)."</span>);
00411         }
00412     }
00413 <span class="preprocessor">#ifdef DEBUG</span>
00414 <span class="preprocessor"></span>    <span class="keywordflow">else</span> {
00415         RIPMSG0(RIP_WARNING,
00416               <span class="stringliteral">"ImmSetActiveContext: can't send WM_IME_SETCONTEXT(TRUE)."</span>);
00417     }
00418 <span class="preprocessor">#endif</span>
00419 <span class="preprocessor"></span>
00420 <span class="preprocessor">#ifdef LATER</span>
00421 <span class="preprocessor"></span>    <span class="comment">// Implements ProcessIMCEvent() later.</span>
00422 <span class="preprocessor">#endif</span>
00423 <span class="preprocessor"></span>
00424     <span class="keywordflow">if</span> (pClientImc != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00425         <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>(pClientImc);
00426 
00427     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00428 }
00429 
00430 <span class="comment">/**************************************************************************\</span>
00431 <span class="comment">* ModeSaver related routines</span>
00432 <span class="comment">*</span>
00433 <span class="comment">* Dec-1998 hiroyama     Created</span>
00434 <span class="comment">\**************************************************************************/</span>
00435 
<a name="l00436"></a><a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a9">00436</a> <a class="code" href="../../d2/d8/structtagIMEMODESAVER.html">PIMEMODESAVER</a> <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a9">GetImeModeSaver</a>(
00437     PINPUTCONTEXT pInputContext,
00438     HKL hkl)
00439 {
00440     <a class="code" href="../../d2/d8/structtagIMEMODESAVER.html">PIMEMODESAVER</a> pModeSaver;
00441     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> langId = PRIMARYLANGID(<a class="code" href="../../d4/d5/conimep_8h.html#a50">HKL_TO_LANGID</a>(hkl));
00442 
00443     <span class="keywordflow">for</span> (pModeSaver = pInputContext-&gt;pImeModeSaver; pModeSaver; pModeSaver = pModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o0">next</a>) {
00444         <span class="keywordflow">if</span> (pModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o1">langId</a> == langId) {
00445             <span class="keywordflow">break</span>;
00446         }
00447     }
00448 
00449     <span class="keywordflow">if</span> (pModeSaver == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00450         TAGMSG1(DBGTAG_IMM, <span class="stringliteral">"GetImeModeSaver: creating ModeSaver for langId=%04x"</span>, langId);
00451         pModeSaver = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(HEAP_ZERO_MEMORY, <span class="keyword">sizeof</span> *pModeSaver);
00452         <span class="keywordflow">if</span> (pModeSaver == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00453             RIPMSG1(RIP_WARNING, <span class="stringliteral">"GetImeModeSaver: failed to create ModeSaver for langId=%04x"</span>, langId);
00454             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00455         }
00456         pModeSaver-&gt;langId = langId;
00457         pModeSaver-&gt;next = pInputContext-&gt;pImeModeSaver;
00458         pInputContext-&gt;pImeModeSaver = pModeSaver;
00459     }
00460 
00461     <span class="keywordflow">return</span> pModeSaver;
00462 }
00463 
<a name="l00464"></a><a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a10">00464</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a10">DestroyImeModeSaver</a>(
00465     PINPUTCONTEXT pInputContext)
00466 {
00467     <a class="code" href="../../d2/d8/structtagIMEMODESAVER.html">PIMEMODESAVER</a> pModeSaver = pInputContext-&gt;pImeModeSaver;
00468 
00469     <span class="comment">//</span>
00470     <span class="comment">// Destroy mode savers</span>
00471     <span class="comment">//</span>
00472     <span class="keywordflow">while</span> (pModeSaver) {
00473         <a class="code" href="../../d2/d8/structtagIMEMODESAVER.html">PIMEMODESAVER</a> pNext = pModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o0">next</a>;
00474         <a class="code" href="../../d3/d8/structtagIMEPRIVATESAVER.html">PIMEPRIVATEMODESAVER</a> pPrivateModeSaver = pModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o6">pImePrivateModeSaver</a>;
00475 
00476         <span class="comment">//</span>
00477         <span class="comment">// Destroy private mode savers</span>
00478         <span class="comment">//</span>
00479         <span class="keywordflow">while</span> (pPrivateModeSaver) {
00480             <a class="code" href="../../d3/d8/structtagIMEPRIVATESAVER.html">PIMEPRIVATEMODESAVER</a> pPrivateNext = pPrivateModeSaver-&gt;<a class="code" href="../../d3/d8/structtagIMEPRIVATESAVER.html#o0">next</a>;
00481             <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(pPrivateModeSaver);
00482             pPrivateModeSaver = pPrivateNext;
00483         }
00484 
00485         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(pModeSaver);
00486         pModeSaver = pNext;
00487     }
00488 
00489     pInputContext-&gt;pImeModeSaver = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00490 }
00491 
<a name="l00492"></a><a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a11">00492</a> <a class="code" href="../../d3/d8/structtagIMEPRIVATESAVER.html">PIMEPRIVATEMODESAVER</a> <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a11">GetImePrivateModeSaver</a>(
00493     <a class="code" href="../../d2/d8/structtagIMEMODESAVER.html">PIMEMODESAVER</a> pImeModeSaver,
00494     HKL hkl)
00495 {
00496     <a class="code" href="../../d3/d8/structtagIMEPRIVATESAVER.html">PIMEPRIVATEMODESAVER</a> pPrivateModeSaver;
00497 
00498     <span class="keywordflow">for</span> (pPrivateModeSaver = pImeModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o6">pImePrivateModeSaver</a>; pPrivateModeSaver; pPrivateModeSaver = pPrivateModeSaver-&gt;<a class="code" href="../../d3/d8/structtagIMEPRIVATESAVER.html#o0">next</a>) {
00499         <span class="keywordflow">if</span> (pPrivateModeSaver-&gt;<a class="code" href="../../d3/d8/structtagIMEPRIVATESAVER.html#o1">hkl</a> == hkl) {
00500             <span class="keywordflow">break</span>;
00501         }
00502     }
00503 
00504     <span class="keywordflow">if</span> (pPrivateModeSaver == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00505         TAGMSG1(DBGTAG_IMM, <span class="stringliteral">"GetImePrivateModeSaver: creating private mode saver for hkl=%08x"</span>, hkl);
00506         pPrivateModeSaver = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, <span class="keyword">sizeof</span> *pPrivateModeSaver);
00507         <span class="keywordflow">if</span> (pPrivateModeSaver == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00508             RIPMSG1(RIP_WARNING, <span class="stringliteral">"GetImePrivateModeSaver: failed to create PrivateModeSaver for hlk=%08x"</span>, hkl);
00509             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00510         }
00511         pPrivateModeSaver-&gt;hkl = hkl;
00512         pPrivateModeSaver-&gt;fdwSentence = 0;
00513         pPrivateModeSaver-&gt;next = pImeModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o6">pImePrivateModeSaver</a>;
00514         pImeModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o6">pImePrivateModeSaver</a> = pPrivateModeSaver;
00515     }
00516 
00517     <span class="keywordflow">return</span> pPrivateModeSaver;
00518 }
00519 
<a name="l00520"></a><a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a12">00520</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a12">SavePrivateMode</a>(
00521     PINPUTCONTEXT pInputContext,
00522     <a class="code" href="../../d2/d8/structtagIMEMODESAVER.html">PIMEMODESAVER</a> pImeModeSaver,
00523     HKL hkl)
00524 {
00525     <a class="code" href="../../d3/d8/structtagIMEPRIVATESAVER.html">PIMEPRIVATEMODESAVER</a> pPrivateModeSaver = <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a11">GetImePrivateModeSaver</a>(pImeModeSaver, hkl);
00526 
00527     <span class="keywordflow">if</span> (pPrivateModeSaver == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00528         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00529     }
00530 
00531     <span class="comment">//</span>
00532     <span class="comment">// Save private sentence mode</span>
00533     <span class="comment">//</span>
00534     pPrivateModeSaver-&gt;<a class="code" href="../../d3/d8/structtagIMEPRIVATESAVER.html#o2">fdwSentence</a> = pInputContext-&gt;fdwSentence &amp; 0xffff0000;
00535     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00536 }
00537 
<a name="l00538"></a><a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a13">00538</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a13">RestorePrivateMode</a>(
00539     PINPUTCONTEXT pInputContext,
00540     <a class="code" href="../../d2/d8/structtagIMEMODESAVER.html">PIMEMODESAVER</a> pImeModeSaver,
00541     HKL hkl)
00542 {
00543     <a class="code" href="../../d3/d8/structtagIMEPRIVATESAVER.html">PIMEPRIVATEMODESAVER</a> pPrivateModeSaver = <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a11">GetImePrivateModeSaver</a>(pImeModeSaver, hkl);
00544 
00545     <span class="keywordflow">if</span> (pPrivateModeSaver == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00546         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00547     }
00548 
00549     <span class="comment">//</span>
00550     <span class="comment">// Restore private sentence mode</span>
00551     <span class="comment">//</span>
00552     <a class="code" href="../../d4/d0/immcli_8h.html#a2">ImmAssert</a>(LOWORD(pPrivateModeSaver-&gt;<a class="code" href="../../d3/d8/structtagIMEPRIVATESAVER.html#o2">fdwSentence</a>) == 0);
00553     pInputContext-&gt;fdwSentence |= pPrivateModeSaver-&gt;<a class="code" href="../../d3/d8/structtagIMEPRIVATESAVER.html#o2">fdwSentence</a>;
00554     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00555 }
00556 
00557 <span class="comment">/**************************************************************************\</span>
00558 <span class="comment">* CreateInputContext</span>
00559 <span class="comment">*</span>
00560 <span class="comment">* 20-Feb-1996 wkwok       Created</span>
00561 <span class="comment">\**************************************************************************/</span>
00562 
<a name="l00563"></a><a class="code" href="../../d4/d0/immcli_8h.html#a68">00563</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a2030">CreateInputContext</a>(
00564     HIMC hImc,
00565     HKL  hKL,
00566     BOOL fCanCallImeSelect)
00567 {
00568     <a class="code" href="../../d2/d7/structtagIMEDPI.html">PIMEDPI</a>            pImeDpi;
00569     <a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a>         pClientImc;
00570     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>              dwPrivateDataSize;
00571     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>              fdwInitConvMode = 0;    <span class="comment">// do it later</span>
00572     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>               fInitOpen = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;      <span class="comment">// do it later</span>
00573     PINPUTCONTEXT      pInputContext;
00574     PCOMPOSITIONSTRING pCompStr;
00575     PCANDIDATEINFO     pCandInfo;
00576     PGUIDELINE         pGuideLine;
00577     <span class="keywordtype">int</span>                i;
00578 
00579     pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hImc);
00580     <span class="keywordflow">if</span> (!pInputContext) {
00581         RIPMSG1(RIP_WARNING, <span class="stringliteral">"CreateContext: Lock hIMC %x failure"</span>, hImc);
00582         <span class="keywordflow">goto</span> CrIMCLockErrOut;
00583     }
00584 
00585     <span class="comment">/*</span>
00586 <span class="comment">     * Initialize the member of INPUTCONTEXT</span>
00587 <span class="comment">     */</span>
00588     pInputContext-&gt;hCompStr = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a15">ImmCreateIMCC</a>(<span class="keyword">sizeof</span>(COMPOSITIONSTRING));
00589     <span class="keywordflow">if</span> (!pInputContext-&gt;hCompStr) {
00590         RIPMSG0(RIP_WARNING, <span class="stringliteral">"CreateContext: Create hCompStr failure"</span>);
00591         <span class="keywordflow">goto</span> CrIMCUnlockIMC;
00592     }
00593 
00594     pCompStr = (PCOMPOSITIONSTRING)<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a17">ImmLockIMCC</a>(pInputContext-&gt;hCompStr);
00595     <span class="keywordflow">if</span> (!pCompStr) {
00596         RIPMSG1(RIP_WARNING,
00597               <span class="stringliteral">"CreateContext: Lock hCompStr %x failure"</span>, pInputContext-&gt;hCompStr);
00598         <span class="keywordflow">goto</span> CrIMCFreeCompStr;
00599     }
00600 
00601     pCompStr-&gt;dwSize = <span class="keyword">sizeof</span>(COMPOSITIONSTRING);
00602     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a18">ImmUnlockIMCC</a>(pInputContext-&gt;hCompStr);
00603 
00604     pInputContext-&gt;hCandInfo = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a15">ImmCreateIMCC</a>(<span class="keyword">sizeof</span>(CANDIDATEINFO));
00605     <span class="keywordflow">if</span> (!pInputContext-&gt;hCandInfo) {
00606         RIPMSG0(RIP_WARNING, <span class="stringliteral">"CreateContext: Create hCandInfo failure"</span>);
00607         <span class="keywordflow">goto</span> CrIMCFreeCompStr;
00608     }
00609 
00610     pCandInfo = (PCANDIDATEINFO)<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a17">ImmLockIMCC</a>(pInputContext-&gt;hCandInfo);
00611     <span class="keywordflow">if</span> (!pCandInfo) {
00612         RIPMSG1(RIP_WARNING,
00613               <span class="stringliteral">"CreateContext: Lock hCandInfo %x failure"</span>, pInputContext-&gt;hCandInfo);
00614         <span class="keywordflow">goto</span> CrIMCFreeCandInfo;
00615     }
00616 
00617     pCandInfo-&gt;dwSize = <span class="keyword">sizeof</span>(CANDIDATEINFO);
00618     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a18">ImmUnlockIMCC</a>(pInputContext-&gt;hCandInfo);
00619 
00620     pInputContext-&gt;hGuideLine = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a15">ImmCreateIMCC</a>(<span class="keyword">sizeof</span>(GUIDELINE));
00621     <span class="keywordflow">if</span> (!pInputContext-&gt;hGuideLine) {
00622         RIPMSG0(RIP_WARNING, <span class="stringliteral">"CreateContext: Create hGuideLine failure"</span>);
00623         <span class="keywordflow">goto</span> CrIMCFreeCandInfo;
00624     }
00625 
00626     pGuideLine = (PGUIDELINE)<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a17">ImmLockIMCC</a>(pInputContext-&gt;hGuideLine);
00627     <span class="keywordflow">if</span> (!pGuideLine) {
00628         RIPMSG1(RIP_WARNING,
00629               <span class="stringliteral">"CreateContext: Lock hGuideLine %x failure"</span>, pInputContext-&gt;hGuideLine);
00630         <span class="keywordflow">goto</span> CrIMCFreeGuideLine;
00631     }
00632 
00633     pGuideLine-&gt;dwSize = <span class="keyword">sizeof</span>(GUIDELINE);
00634     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a18">ImmUnlockIMCC</a>(pInputContext-&gt;hGuideLine);
00635 
00636     pInputContext-&gt;hMsgBuf = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a15">ImmCreateIMCC</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>));
00637     <span class="keywordflow">if</span> (!pInputContext-&gt;hMsgBuf) {
00638         RIPMSG0(RIP_WARNING, <span class="stringliteral">"CreateContext: Create hMsgBuf failure"</span>);
00639         <span class="keywordflow">goto</span> CrIMCFreeGuideLine;
00640     }
00641 
00642     pInputContext-&gt;dwNumMsgBuf = 0;
00643     pInputContext-&gt;fOpen = fInitOpen;
00644     pInputContext-&gt;fdwConversion = fdwInitConvMode;
00645     pInputContext-&gt;fdwSentence = 0;
00646 
00647     <span class="keywordflow">for</span> (i = 0; i &lt; 4; i++) {
00648         pInputContext-&gt;cfCandForm[i].dwIndex = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(-1);
00649     }
00650 
00651     pImeDpi = <a class="code" href="../../d9/d0/immuser_8h.html#a45">ImmLockImeDpi</a>(hKL);
00652     <span class="keywordflow">if</span> (pImeDpi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00653         <span class="keywordflow">if</span> ((pClientImc = <a class="code" href="../../d9/d0/immuser_8h.html#a43">ImmLockClientImc</a>(hImc)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00654             RIPMSG0(RIP_WARNING, <span class="stringliteral">"CreateContext: ImmLockClientImc() failure"</span>);
00655             <a class="code" href="../../d9/d0/immuser_8h.html#a46">ImmUnlockImeDpi</a>(pImeDpi);
00656             <span class="keywordflow">goto</span> CrIMCFreeMsgBuf;
00657         }
00658 
00659         <span class="comment">/*</span>
00660 <span class="comment">         * Unicode based IME expects an Uncode based input context.</span>
00661 <span class="comment">         */</span>
00662         <span class="keywordflow">if</span> (pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o3">ImeInfo</a>.fdwProperty &amp; IME_PROP_UNICODE)
00663             <a class="code" href="../../d4/d0/immcli_8h.html#a19">SetICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a4">IMCF_UNICODE</a>);
00664 
00665         pClientImc-&gt;<a class="code" href="../../d3/d0/structtagCLIENTIMC.html#o5">dwCodePage</a> = <a class="code" href="../../d4/d0/immcli_8h.html#a25">IMECodePage</a>(pImeDpi);
00666 
00667         <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>(pClientImc);
00668 
00669         dwPrivateDataSize = pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o3">ImeInfo</a>.dwPrivateDataSize;
00670     }
00671     <span class="keywordflow">else</span> {
00672         dwPrivateDataSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>);
00673     }
00674 
00675     pInputContext-&gt;hPrivate = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a15">ImmCreateIMCC</a>(dwPrivateDataSize);
00676     <span class="keywordflow">if</span> (!pInputContext-&gt;hPrivate) {
00677         RIPMSG0(RIP_WARNING, <span class="stringliteral">"CreateContext: Create hPrivate failure"</span>);
00678         <a class="code" href="../../d9/d0/immuser_8h.html#a46">ImmUnlockImeDpi</a>(pImeDpi);
00679         <span class="keywordflow">goto</span> CrIMCFreeMsgBuf;
00680     }
00681 
00682     pInputContext-&gt;pImeModeSaver = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00683 
00684     <span class="keywordflow">if</span> (pImeDpi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00685         <span class="keywordflow">if</span> (fCanCallImeSelect) {
00686             (*pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o8">pfn</a>.<a class="code" href="../../d3/d7/structtagIMEDPI_1_1__tagImeFunctions.html#o23">ImeSelect</a>)(hImc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00687         }
00688         <a class="code" href="../../d9/d0/immuser_8h.html#a46">ImmUnlockImeDpi</a>(pImeDpi);
00689     }
00690 
00691     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
00692     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00693 
00694     <span class="comment">/*</span>
00695 <span class="comment">     * context failure case</span>
00696 <span class="comment">     */</span>
00697 CrIMCFreeMsgBuf:
00698     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a16">ImmDestroyIMCC</a>(pInputContext-&gt;hMsgBuf);
00699 CrIMCFreeGuideLine:
00700     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a16">ImmDestroyIMCC</a>(pInputContext-&gt;hGuideLine);
00701 CrIMCFreeCandInfo:
00702     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a16">ImmDestroyIMCC</a>(pInputContext-&gt;hCandInfo);
00703 CrIMCFreeCompStr:
00704     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a16">ImmDestroyIMCC</a>(pInputContext-&gt;hCompStr);
00705 CrIMCUnlockIMC:
00706     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
00707 CrIMCLockErrOut:
00708     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00709 }
00710 
00711 
00712 <span class="comment">/**************************************************************************\</span>
00713 <span class="comment">* DestroyInputContext</span>
00714 <span class="comment">*</span>
00715 <span class="comment">* 20-Feb-1996 wkwok       Created</span>
00716 <span class="comment">\**************************************************************************/</span>
00717 
<a name="l00718"></a><a class="code" href="../../d4/d0/immcli_8h.html#a69">00718</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a2031">DestroyInputContext</a>(
00719     HIMC      hImc,
00720     HKL       hKL,
00721     BOOL      bTerminate)
00722 {
00723     PINPUTCONTEXT pInputContext;
00724     <a class="code" href="../../d2/d7/structtagIMEDPI.html">PIMEDPI</a>       pImeDpi;
00725     <a class="code" href="../../d1/d7/structtagIMC.html">PIMC</a>          pImc;
00726     <a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a>    pClientImc;
00727 
00728     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
00729         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00730 
00731     }
00732     <span class="keywordflow">if</span> (hImc == <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>) {
00733         RIPMSG0(RIP_VERBOSE, <span class="stringliteral">"DestroyInputContext: hImc is NULL."</span>);
00734         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00735     }
00736 
00737     pImc = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a6">HMValidateHandle</a>((HANDLE)hImc, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a253">TYPE_INPUTCONTEXT</a>);
00738 
00739     <span class="comment">/*</span>
00740 <span class="comment">     * Cannot destroy input context from other thread.</span>
00741 <span class="comment">     */</span>
00742     <span class="keywordflow">if</span> (pImc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pImc) != <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>())
00743         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00744 
00745     <span class="comment">/*</span>
00746 <span class="comment">     * We are destroying this hImc so we don't bother calling</span>
00747 <span class="comment">     * ImmLockClientImc() to get the pClientImc. Instead, we</span>
00748 <span class="comment">     * reference the pImc-&gt;dwClientImcData directly and call</span>
00749 <span class="comment">     * InterlockedIncrement(&amp;pClientImc-&gt;cLockObj) right after</span>
00750 <span class="comment">     * several quick checks.</span>
00751 <span class="comment">     */</span>
00752     pClientImc = (<a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a>)pImc-&gt;<a class="code" href="../../d1/d7/structtagIMC.html#o2">dwClientImcData</a>;
00753 
00754     <span class="keywordflow">if</span> (pClientImc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00755         <span class="comment">/*</span>
00756 <span class="comment">         * Client side Imc has not been initialzed yet.</span>
00757 <span class="comment">         * We simply destroy this input context from kernel.</span>
00758 <span class="comment">         */</span>
00759         <span class="keywordflow">if</span> (bTerminate) {
00760             <span class="comment">/*</span>
00761 <span class="comment">             * If called from THREAD_DETACH, we don't</span>
00762 <span class="comment">             * have to destroy kernel side Input Context.</span>
00763 <span class="comment">             */</span>
00764             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00765         }
00766         <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a386">NtUserDestroyInputContext</a>(hImc);
00767     }
00768 
00769     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a12">IMCF_DEFAULTIMC</a>) &amp;&amp; !bTerminate) {
00770         <span class="comment">/*</span>
00771 <span class="comment">         * Cannot destroy default input context unless the</span>
00772 <span class="comment">         * thread is terminating.</span>
00773 <span class="comment">         */</span>
00774         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00775     }
00776 
00777     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a10">IMCF_INDESTROY</a>)) {
00778         <span class="comment">/*</span>
00779 <span class="comment">         * This hImc is being destroyed. Returns as success.</span>
00780 <span class="comment">         */</span>
00781         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00782     }
00783 
00784     <span class="comment">/*</span>
00785 <span class="comment">     * Time to lock up the pClientImc.</span>
00786 <span class="comment">     */</span>
00787     InterlockedIncrement(&amp;pClientImc-&gt;<a class="code" href="../../d3/d0/structtagCLIENTIMC.html#o1">cLockObj</a>);
00788 
00789     <span class="keywordflow">if</span> (pClientImc-&gt;<a class="code" href="../../d3/d0/structtagCLIENTIMC.html#o0">hInputContext</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00790 
00791         pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hImc);
00792         <span class="keywordflow">if</span> (!pInputContext) {
00793             RIPMSG1(RIP_WARNING, <span class="stringliteral">"DestroyContext: Lock hImc %x failure"</span>, hImc);
00794             <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>(pClientImc);
00795             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00796         }
00797 
00798         pImeDpi = <a class="code" href="../../d9/d0/immuser_8h.html#a45">ImmLockImeDpi</a>(hKL);
00799         <span class="keywordflow">if</span> (pImeDpi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00800             (*pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o8">pfn</a>.<a class="code" href="../../d3/d7/structtagIMEDPI_1_1__tagImeFunctions.html#o23">ImeSelect</a>)(hImc, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00801             <a class="code" href="../../d9/d0/immuser_8h.html#a46">ImmUnlockImeDpi</a>(pImeDpi);
00802         }
00803 
00804         <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a16">ImmDestroyIMCC</a>(pInputContext-&gt;hPrivate);
00805         <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a16">ImmDestroyIMCC</a>(pInputContext-&gt;hMsgBuf);
00806         <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a16">ImmDestroyIMCC</a>(pInputContext-&gt;hGuideLine);
00807         <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a16">ImmDestroyIMCC</a>(pInputContext-&gt;hCandInfo);
00808         <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a16">ImmDestroyIMCC</a>(pInputContext-&gt;hCompStr);
00809 
00810         <span class="comment">/*</span>
00811 <span class="comment">         * Free all ImeModeSaver.</span>
00812 <span class="comment">         */</span>
00813         <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a10">DestroyImeModeSaver</a>(pInputContext);
00814 
00815         <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
00816     }
00817 
00818     <a class="code" href="../../d4/d0/immcli_8h.html#a19">SetICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a10">IMCF_INDESTROY</a>);
00819 
00820     <span class="comment">/*</span>
00821 <span class="comment">     * ImmUnlockClientImc() will free up the pClientImc</span>
00822 <span class="comment">     * when InterlockedDecrement(&amp;pClientImc-&gt;cLockObj)</span>
00823 <span class="comment">     * reaches 0.</span>
00824 <span class="comment">     */</span>
00825     <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>(pClientImc);
00826 
00827     <span class="keywordflow">return</span> (bTerminate) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a386">NtUserDestroyInputContext</a>(hImc);
00828 }
00829 
00830 
00831 <span class="comment">/**************************************************************************\</span>
00832 <span class="comment">* SelectInputContext</span>
00833 <span class="comment">*</span>
00834 <span class="comment">* 20-Feb-1996 wkwok       Created</span>
00835 <span class="comment">\**************************************************************************/</span>
00836 
<a name="l00837"></a><a class="code" href="../../d4/d0/immcli_8h.html#a70">00837</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d0/immcli_8h.html#a70">SelectInputContext</a>(
00838     HKL  hSelKL,
00839     HKL  hUnSelKL,
00840     HIMC hImc)
00841 {
00842     <a class="code" href="../../d2/d7/structtagIMEDPI.html">PIMEDPI</a>            pSelImeDpi, pUnSelImeDpi;
00843     <a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a>         pClientImc;
00844     PINPUTCONTEXT      pInputContext;
00845     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>              dwSelPriv = 0, dwUnSelPriv = 0, dwSize;
00846     HIMCC              hImcc;
00847     PCOMPOSITIONSTRING pCompStr;
00848     PCANDIDATEINFO     pCandInfo;
00849     PGUIDELINE         pGuideLine;
00850     BOOLEAN            fLogFontInited;
00851 
00852     TAGMSG3(DBGTAG_IMM, <span class="stringliteral">"SelectInputContext: called for sel=%08p unsel=%08p hImc=%08p"</span>,
00853             hSelKL, hUnSelKL, hImc);
00854 
00855     pClientImc = <a class="code" href="../../d9/d0/immuser_8h.html#a43">ImmLockClientImc</a>(hImc);
00856     <span class="keywordflow">if</span> (pClientImc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00857         RIPMSG0(RIP_VERBOSE, <span class="stringliteral">"SelectInputContext: cannot lock client Imc. Bailing out."</span>);
00858         <span class="keywordflow">return</span>;
00859     }
00860 
00861     pSelImeDpi   = <a class="code" href="../../d9/d0/immuser_8h.html#a45">ImmLockImeDpi</a>(hSelKL);
00862 
00863     <span class="keywordflow">if</span> (hSelKL != hUnSelKL) {
00864         <span class="comment">/*</span>
00865 <span class="comment">         * If those new sel and unsel do no match but</span>
00866 <span class="comment">         * somehow SelectInput is called, that means</span>
00867 <span class="comment">         * we should initialize the input contex again</span>
00868 <span class="comment">         * without dumping the old information.</span>
00869 <span class="comment">         */</span>
00870         pUnSelImeDpi = <a class="code" href="../../d9/d0/immuser_8h.html#a45">ImmLockImeDpi</a>(hUnSelKL);
00871     } <span class="keywordflow">else</span> {
00872         pUnSelImeDpi = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00873     }
00874 
00875     <span class="keywordflow">if</span> (pSelImeDpi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00876         <span class="comment">/*</span>
00877 <span class="comment">         * According to private memory size of the two layout, we decide</span>
00878 <span class="comment">         * whether we nee to reallocate this memory block</span>
00879 <span class="comment">         */</span>
00880         dwSelPriv = pSelImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o3">ImeInfo</a>.dwPrivateDataSize;
00881 
00882         <span class="comment">/*</span>
00883 <span class="comment">         * Setup the code page of the newly selected IME.</span>
00884 <span class="comment">         */</span>
00885         pClientImc-&gt;<a class="code" href="../../d3/d0/structtagCLIENTIMC.html#o5">dwCodePage</a> = <a class="code" href="../../d4/d0/immcli_8h.html#a25">IMECodePage</a>(pSelImeDpi);
00886     }
00887     <span class="keywordflow">else</span> {
00888         pClientImc-&gt;<a class="code" href="../../d3/d0/structtagCLIENTIMC.html#o5">dwCodePage</a> = CP_ACP;
00889     }
00890 
00891     <span class="keywordflow">if</span> (pUnSelImeDpi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00892         dwUnSelPriv = pUnSelImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o3">ImeInfo</a>.dwPrivateDataSize;
00893 
00894     dwSelPriv   = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(dwSelPriv,   <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>));
00895     dwUnSelPriv = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(dwUnSelPriv, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>));
00896 
00897     <span class="comment">/*</span>
00898 <span class="comment">     * Unselect the input context.</span>
00899 <span class="comment">     */</span>
00900     <span class="keywordflow">if</span> (pUnSelImeDpi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00901         (*pUnSelImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o8">pfn</a>.<a class="code" href="../../d3/d7/structtagIMEDPI_1_1__tagImeFunctions.html#o23">ImeSelect</a>)(hImc, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00902 
00903     <span class="comment">/*</span>
00904 <span class="comment">     * Reinitialize the client side input context for the selected layout.</span>
00905 <span class="comment">     */</span>
00906     <span class="keywordflow">if</span> ((pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a11">InternalImmLockIMC</a>(hImc, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00907         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> fdwOldConversion = pInputContext-&gt;fdwConversion;
00908         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> fdwOldSentence = pInputContext-&gt;fdwSentence;
00909         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fOldOpen = pInputContext-&gt;fOpen;
00910         <a class="code" href="../../d2/d8/structtagIMEMODESAVER.html">PIMEMODESAVER</a> pUnSelModeSaver, pSelModeSaver;
00911         <span class="keyword">const</span> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> fdwConvPreserve = IME_CMODE_EUDC;
00912 
00913         fLogFontInited = ((pInputContext-&gt;fdwInit &amp; INIT_LOGFONT) == INIT_LOGFONT);
00914 
00915         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a4">IMCF_UNICODE</a>) &amp;&amp; pSelImeDpi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00916                 !(pSelImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o3">ImeInfo</a>.fdwProperty &amp; IME_PROP_UNICODE)) {
00917             <span class="comment">/*</span>
00918 <span class="comment">             * Check if there is any LOGFONT to be converted.</span>
00919 <span class="comment">             */</span>
00920             <span class="keywordflow">if</span> (fLogFontInited) {
00921                 LOGFONTA LogFontA;
00922 
00923                 <a class="code" href="../../d4/d0/immcli_8h.html#a84">LFontWtoLFontA</a>(&amp;pInputContext-&gt;lfFont.W, &amp;LogFontA);
00924                 RtlCopyMemory(&amp;pInputContext-&gt;lfFont.A, &amp;LogFontA, <span class="keyword">sizeof</span>(LOGFONTA));
00925             }
00926 
00927             <a class="code" href="../../d4/d0/immcli_8h.html#a20">ClrICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a4">IMCF_UNICODE</a>);
00928         }
00929         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a4">IMCF_UNICODE</a>) &amp;&amp; pSelImeDpi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00930                  (pSelImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o3">ImeInfo</a>.fdwProperty &amp; IME_PROP_UNICODE)) {
00931             <span class="comment">/*</span>
00932 <span class="comment">             * Check if there is any LOGFONT to be converted.</span>
00933 <span class="comment">             */</span>
00934             <span class="keywordflow">if</span> (fLogFontInited) {
00935                 LOGFONTW LogFontW;
00936 
00937                 <a class="code" href="../../d4/d0/immcli_8h.html#a83">LFontAtoLFontW</a>(&amp;pInputContext-&gt;lfFont.A, &amp;LogFontW);
00938                 RtlCopyMemory(&amp;pInputContext-&gt;lfFont.W, &amp;LogFontW, <span class="keyword">sizeof</span>(LOGFONTW));
00939             }
00940 
00941             <a class="code" href="../../d4/d0/immcli_8h.html#a19">SetICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a4">IMCF_UNICODE</a>);
00942         }
00943 
00944         <span class="comment">/*</span>
00945 <span class="comment">         * hPrivate</span>
00946 <span class="comment">         */</span>
00947         <span class="keywordflow">if</span> (dwUnSelPriv != dwSelPriv) {
00948             hImcc = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a20">ImmReSizeIMCC</a>(pInputContext-&gt;hPrivate, dwSelPriv);
00949             <span class="keywordflow">if</span> (hImcc) {
00950                 pInputContext-&gt;hPrivate = hImcc;
00951             }
00952             <span class="keywordflow">else</span> {
00953                 RIPMSG1(RIP_WARNING,
00954                       <span class="stringliteral">"SelectContext: resize hPrivate %lX failure"</span>,
00955                       pInputContext-&gt;hPrivate);
00956                 <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a16">ImmDestroyIMCC</a>(pInputContext-&gt;hPrivate);
00957                 pInputContext-&gt;hPrivate = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a15">ImmCreateIMCC</a>(dwSelPriv);
00958             }
00959         }
00960 
00961         <span class="comment">/*</span>
00962 <span class="comment">         * hMsgBuf</span>
00963 <span class="comment">         */</span>
00964         dwSize = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a21">ImmGetIMCCSize</a>(pInputContext-&gt;hMsgBuf);
00965 
00966         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a19">ImmGetIMCCLockCount</a>(pInputContext-&gt;hMsgBuf) != 0 ||
00967                 dwSize &gt; <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a0">IMCC_ALLOC_TOOLARGE</a>) {
00968 
00969             RIPMSG0(RIP_WARNING, <span class="stringliteral">"SelectContext: create new hMsgBuf"</span>);
00970             <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a16">ImmDestroyIMCC</a>(pInputContext-&gt;hMsgBuf);
00971             pInputContext-&gt;hMsgBuf = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a15">ImmCreateIMCC</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>));
00972             pInputContext-&gt;dwNumMsgBuf = 0;
00973         }
00974 
00975         <span class="comment">/*</span>
00976 <span class="comment">         * hGuideLine</span>
00977 <span class="comment">         */</span>
00978         dwSize = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a21">ImmGetIMCCSize</a>(pInputContext-&gt;hGuideLine);
00979 
00980         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a19">ImmGetIMCCLockCount</a>(pInputContext-&gt;hGuideLine) != 0 ||
00981                 dwSize &lt; sizeof(GUIDELINE) || dwSize &gt; <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a0">IMCC_ALLOC_TOOLARGE</a>) {
00982 
00983             RIPMSG0(RIP_WARNING, <span class="stringliteral">"SelectContext: create new hGuideLine"</span>);
00984             <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a16">ImmDestroyIMCC</a>(pInputContext-&gt;hGuideLine);
00985             pInputContext-&gt;hGuideLine = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a15">ImmCreateIMCC</a>(<span class="keyword">sizeof</span>(GUIDELINE));
00986             pGuideLine = (PGUIDELINE)<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a17">ImmLockIMCC</a>(pInputContext-&gt;hGuideLine);
00987 
00988             <span class="keywordflow">if</span> (pGuideLine != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00989                 pGuideLine-&gt;dwSize = <span class="keyword">sizeof</span>(GUIDELINE);
00990                 <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a18">ImmUnlockIMCC</a>(pInputContext-&gt;hGuideLine);
00991             }
00992         }
00993 
00994         <span class="comment">/*</span>
00995 <span class="comment">         * hCandInfo</span>
00996 <span class="comment">         */</span>
00997         dwSize = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a21">ImmGetIMCCSize</a>(pInputContext-&gt;hCandInfo);
00998 
00999         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a19">ImmGetIMCCLockCount</a>(pInputContext-&gt;hCandInfo) != 0 ||
01000                 dwSize &lt; sizeof(CANDIDATEINFO) || dwSize &gt; <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a0">IMCC_ALLOC_TOOLARGE</a>) {
01001 
01002             RIPMSG0(RIP_WARNING, <span class="stringliteral">"SelectContext: create new hCandInfo"</span>);
01003             <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a16">ImmDestroyIMCC</a>(pInputContext-&gt;hCandInfo);
01004             pInputContext-&gt;hCandInfo = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a15">ImmCreateIMCC</a>(<span class="keyword">sizeof</span>(CANDIDATEINFO));
01005             pCandInfo = (PCANDIDATEINFO)<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a17">ImmLockIMCC</a>(pInputContext-&gt;hCandInfo);
01006 
01007             <span class="keywordflow">if</span> (pCandInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01008                 pCandInfo-&gt;dwSize = <span class="keyword">sizeof</span>(CANDIDATEINFO);
01009                 <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a18">ImmUnlockIMCC</a>(pInputContext-&gt;hCandInfo);
01010             }
01011         }
01012 
01013         <span class="comment">/*</span>
01014 <span class="comment">         * hCompStr</span>
01015 <span class="comment">         */</span>
01016         dwSize = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a21">ImmGetIMCCSize</a>(pInputContext-&gt;hCompStr);
01017 
01018         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a19">ImmGetIMCCLockCount</a>(pInputContext-&gt;hCompStr) != 0 ||
01019                 dwSize &lt; sizeof(COMPOSITIONSTRING) || dwSize &gt; <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a0">IMCC_ALLOC_TOOLARGE</a>) {
01020 
01021             RIPMSG0(RIP_WARNING, <span class="stringliteral">"SelectContext: create new hCompStr"</span>);
01022             <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a16">ImmDestroyIMCC</a>(pInputContext-&gt;hCompStr);
01023             pInputContext-&gt;hCompStr = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a15">ImmCreateIMCC</a>(<span class="keyword">sizeof</span>(COMPOSITIONSTRING));
01024             pCompStr = (PCOMPOSITIONSTRING)<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a17">ImmLockIMCC</a>(pInputContext-&gt;hCompStr);
01025 
01026             <span class="keywordflow">if</span> (pCompStr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01027                 pCompStr-&gt;dwSize = <span class="keyword">sizeof</span>(COMPOSITIONSTRING);
01028                 <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a18">ImmUnlockIMCC</a>(pInputContext-&gt;hCompStr);
01029             }
01030         }
01031 
01032         <span class="comment">//</span>
01033         <span class="comment">// Save and restore the IME modes when the primary</span>
01034         <span class="comment">// language changes.</span>
01035         <span class="comment">//</span>
01036 
01037         <span class="keywordflow">if</span> (pUnSelImeDpi) {
01038             <span class="comment">//</span>
01039             <span class="comment">// If UnSelKL is IME, get ModeSaver per language.</span>
01040             <span class="comment">//</span>
01041             pUnSelModeSaver = <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a9">GetImeModeSaver</a>(pInputContext, hUnSelKL);
01042             TAGMSG1(DBGTAG_IMM, <span class="stringliteral">"pUnSelModeSaver=%p"</span>, pUnSelModeSaver);
01043 
01044             <span class="comment">//</span>
01045             <span class="comment">// Firstly save the private sentence mode per IME.</span>
01046             <span class="comment">//</span>
01047             <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a12">SavePrivateMode</a>(pInputContext, pUnSelModeSaver, hUnSelKL);
01048         }
01049         <span class="keywordflow">else</span> {
01050             pUnSelModeSaver = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01051         }
01052 
01053         <span class="keywordflow">if</span> (pSelImeDpi) {
01054             <span class="comment">//</span>
01055             <span class="comment">// If SelKL is IME, get is ModeSaver per language.</span>
01056             <span class="comment">//</span>
01057             pSelModeSaver = <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a9">GetImeModeSaver</a>(pInputContext, hSelKL);
01058             TAGMSG1(DBGTAG_IMM, <span class="stringliteral">"pSelImeDpi. pImeModeSaver=%p"</span>, pSelModeSaver);
01059         }
01060         <span class="keywordflow">else</span> {
01061             pSelModeSaver = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01062         }
01063 
01064         <span class="comment">//</span>
01065         <span class="comment">// If the primary language of KL changes, save the current mode</span>
01066         <span class="comment">// and restore the previous modes of new language.</span>
01067         <span class="comment">//</span>
01068         <span class="keywordflow">if</span> (pUnSelModeSaver != pSelModeSaver) {
01069             <span class="comment">//</span>
01070             <span class="comment">// If old KL is IME, save the current conversion, sentence and open mode.</span>
01071             <span class="comment">//</span>
01072             <span class="keywordflow">if</span> (pUnSelModeSaver) {
01073                 pUnSelModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o2">fOpen</a> = (pInputContext-&gt;fOpen != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01074 
01075                 <span class="comment">//</span>
01076                 <span class="comment">// Don't have to save the preserved bits for conversion mode.</span>
01077                 <span class="comment">//</span>
01078                 pUnSelModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o3">fdwConversion</a> = pInputContext-&gt;fdwConversion &amp; ~fdwConvPreserve;
01079 
01080                 pUnSelModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o4">fdwSentence</a> = LOWORD(pInputContext-&gt;fdwSentence);
01081                 pUnSelModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o5">fdwInit</a> = pInputContext-&gt;fdwInit;
01082             }
01083 
01084             <span class="comment">//</span>
01085             <span class="comment">// If new KL is IME, restore the previous conversion, sentence and open mode.</span>
01086             <span class="comment">//</span>
01087             <span class="keywordflow">if</span> (pSelModeSaver) {
01088                 <span class="keywordflow">if</span> (pInputContext-&gt;fdwDirty &amp; IMSS_INIT_OPEN) {
01089                     <span class="comment">//</span>
01090                     <span class="comment">// HKL change may be kicked from private IME hotkey, and</span>
01091                     <span class="comment">// a user wants it opened when switched.</span>
01092                     <span class="comment">//</span>
01093                     pInputContext-&gt;fOpen = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01094                     pInputContext-&gt;fdwDirty &amp;= ~IMSS_INIT_OPEN;
01095                 } <span class="keywordflow">else</span> {
01096                     pInputContext-&gt;fOpen = pSelModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o2">fOpen</a>;
01097                 }
01098 
01099                 <span class="comment">//</span>
01100                 <span class="comment">// Some bits are preserved across the languages.</span>
01101                 <span class="comment">//</span>
01102                 pInputContext-&gt;fdwConversion &amp;= fdwConvPreserve;
01103                 <a class="code" href="../../d4/d0/immcli_8h.html#a2">ImmAssert</a>((pSelModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o3">fdwConversion</a> &amp; fdwConvPreserve) == 0);
01104                 pInputContext-&gt;fdwConversion |= pSelModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o3">fdwConversion</a> &amp; ~fdwConvPreserve;
01105 
01106                 <a class="code" href="../../d4/d0/immcli_8h.html#a2">ImmAssert</a>(HIWORD(pSelModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o4">fdwSentence</a>) == 0);
01107                 pInputContext-&gt;fdwSentence = pSelModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o4">fdwSentence</a>;
01108                 pInputContext-&gt;fdwInit = pSelModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o5">fdwInit</a>;
01109             }
01110         }
01111         <span class="keywordflow">if</span> (pSelModeSaver) {
01112             <span class="comment">//</span>
01113             <span class="comment">// Restore the private sentence mode per IME.</span>
01114             <span class="comment">//</span>
01115             <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a13">RestorePrivateMode</a>(pInputContext, pSelModeSaver, hSelKL);
01116         }
01117 
01118         <span class="comment">/*</span>
01119 <span class="comment">         * Select the input context.</span>
01120 <span class="comment">         */</span>
01121         <span class="keywordflow">if</span> (pSelImeDpi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01122             (*pSelImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o8">pfn</a>.<a class="code" href="../../d3/d7/structtagIMEDPI_1_1__tagImeFunctions.html#o23">ImeSelect</a>)(hImc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01123 
01124         <span class="comment">//</span>
01125         <span class="comment">// Set the dirty bits so that IMM can send notifications later.</span>
01126         <span class="comment">// See SendNotificatonProc.</span>
01127         <span class="comment">//</span>
01128         pInputContext-&gt;fdwDirty = 0;
01129         <span class="keywordflow">if</span> (pInputContext-&gt;fOpen != fOldOpen) {
01130             pInputContext-&gt;fdwDirty |= IMSS_UPDATE_OPEN;
01131         }
01132         <span class="keywordflow">if</span> (pInputContext-&gt;fdwConversion != fdwOldConversion) {
01133             pInputContext-&gt;fdwDirty |= IMSS_UPDATE_CONVERSION;
01134         }
01135         <span class="keywordflow">if</span> (pInputContext-&gt;fdwSentence != fdwOldSentence) {
01136             pInputContext-&gt;fdwDirty |= IMSS_UPDATE_SENTENCE;
01137         }
01138         TAGMSG4(DBGTAG_IMM, <span class="stringliteral">"fOpen:%d fdwConv:%08x fdwSent:%08x dirty:%02x"</span>,
01139                 pInputContext-&gt;fOpen, pInputContext-&gt;fdwConversion, pInputContext-&gt;fdwSentence, pInputContext-&gt;fdwDirty);
01140 
01141         <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
01142     }
01143     <span class="keywordflow">else</span> {
01144         <span class="comment">//</span>
01145         <span class="comment">// To keep the backward compatibility,</span>
01146         <span class="comment">// select the input context here.</span>
01147         <span class="comment">//</span>
01148         <span class="keywordflow">if</span> (pSelImeDpi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01149             (*pSelImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o8">pfn</a>.<a class="code" href="../../d3/d7/structtagIMEDPI_1_1__tagImeFunctions.html#o23">ImeSelect</a>)(hImc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01150     }
01151 
01152     <a class="code" href="../../d9/d0/immuser_8h.html#a46">ImmUnlockImeDpi</a>(pUnSelImeDpi);
01153     <a class="code" href="../../d9/d0/immuser_8h.html#a46">ImmUnlockImeDpi</a>(pSelImeDpi);
01154     <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>(pClientImc);
01155 }
01156 
<a name="l01157"></a><a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a17">01157</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a17">SendNotificationProc</a>(
01158     HIMC hImc,
01159     LPARAM lParam)
01160 {
01161     PINPUTCONTEXT pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hImc);
01162 
01163     UNREFERENCED_PARAMETER(lParam);
01164 
01165     <span class="keywordflow">if</span> (pInputContext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01166         HWND hwnd = pInputContext-&gt;hWnd;
01167 
01168         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(hwnd)) {
01169             TAGMSG2(DBGTAG_IMM, <span class="stringliteral">"SendNotificationProc: updating hImc=%08x dirty=%04x"</span>,
01170                     hImc, pInputContext-&gt;fdwDirty);
01171 
01172             <span class="keywordflow">if</span> (pInputContext-&gt;fdwDirty &amp; IMSS_UPDATE_OPEN) {
01173                 SendMessageW(hwnd, WM_IME_NOTIFY, IMN_SETOPENSTATUS, 0);
01174             }
01175             <span class="keywordflow">if</span> (pInputContext-&gt;fdwDirty &amp; IMSS_UPDATE_CONVERSION) {
01176                 SendMessageW(hwnd, WM_IME_NOTIFY, IMN_SETCONVERSIONMODE, 0);
01177             }
01178             <span class="keywordflow">if</span> (pInputContext-&gt;fdwDirty &amp; (IMSS_UPDATE_OPEN | IMSS_UPDATE_CONVERSION)) {
01179                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a400">NtUserNotifyIMEStatus</a>(hwnd, pInputContext-&gt;fOpen, pInputContext-&gt;fdwConversion);
01180             }
01181             <span class="keywordflow">if</span> (pInputContext-&gt;fdwDirty &amp; IMSS_UPDATE_SENTENCE) {
01182                 SendMessageW(hwnd, WM_IME_NOTIFY, IMN_SETSENTENCEMODE, 0);
01183             }
01184         }
01185         pInputContext-&gt;fdwDirty = 0;
01186     }
01187 
01188     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01189 }
01190 
<a name="l01191"></a><a class="code" href="../../d4/d0/immcli_8h.html#a86">01191</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d0/immcli_8h.html#a86">ImmSendNotification</a>(
01192     BOOL fForProcess)
01193 {
01194     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwThreadId;
01195 
01196     <span class="keywordflow">if</span> (fForProcess) {
01197         dwThreadId = -1;
01198     } <span class="keywordflow">else</span> {
01199         dwThreadId = 0;
01200     }
01201 
01202     <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a19">ImmEnumInputContext</a>(dwThreadId, (IMCENUMPROC)<a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a17">SendNotificationProc</a>, 0);
01203 }
01204 
01205 <span class="comment">/**************************************************************************\</span>
01206 <span class="comment">* ImmEnumInputContext</span>
01207 <span class="comment">*</span>
01208 <span class="comment">* 20-Feb-1996 wkwok       Created</span>
01209 <span class="comment">\**************************************************************************/</span>
01210 
<a name="l01211"></a><a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a19">01211</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a19">ImmEnumInputContext</a>(
01212     DWORD idThread,
01213     IMCENUMPROC lpfn,
01214     LPARAM lParam)
01215 {
01216     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> i;
01217     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> cHimc;
01218     HIMC *phimcT;
01219     HIMC *phimcFirst;
01220     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01221 
01222     <span class="comment">/*</span>
01223 <span class="comment">     * Get the himc list.  It is returned in a block of memory</span>
01224 <span class="comment">     * allocated with ImmLocalAlloc.</span>
01225 <span class="comment">     */</span>
01226     <span class="keywordflow">if</span> ((cHimc = <a class="code" href="../../d4/d1/userk_8h.html#a2037">BuildHimcList</a>(idThread, &amp;phimcFirst)) == 0) {
01227         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01228     }
01229 
01230     <span class="comment">/*</span>
01231 <span class="comment">     * Loop through the input contexts, call the function pointer back for</span>
01232 <span class="comment">     * each one. End loop if either FALSE is returned or the end-of-list is</span>
01233 <span class="comment">     * reached.</span>
01234 <span class="comment">     */</span>
01235     phimcT = phimcFirst;
01236     <span class="keywordflow">for</span> (i = 0; i &lt; cHimc; i++) {
01237         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/immcli_8h.html#a6">RevalidateHimc</a>(*phimcT)) {
01238             <span class="keywordflow">if</span> (!(fSuccess = (*lpfn)(*phimcT, lParam)))
01239                 <span class="keywordflow">break</span>;
01240         }
01241         phimcT++;
01242     }
01243 
01244     <span class="comment">/*</span>
01245 <span class="comment">     * Free up buffer and return status - TRUE if entire list was enumerated,</span>
01246 <span class="comment">     * FALSE otherwise.</span>
01247 <span class="comment">     */</span>
01248     <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(phimcFirst);
01249 
01250     <span class="keywordflow">return</span> fSuccess;
01251 }
01252 
01253 <span class="comment">/**************************************************************************\</span>
01254 <span class="comment">* BuildHimcList</span>
01255 <span class="comment">*</span>
01256 <span class="comment">* 20-Feb-1996 wkwok       Created</span>
01257 <span class="comment">\**************************************************************************/</span>
01258 
<a name="l01259"></a><a class="code" href="../../d4/d0/immcli_8h.html#a71">01259</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d1/userk_8h.html#a2037">BuildHimcList</a>(
01260     DWORD idThread,
01261     HIMC **pphimcFirst)
01262 {
01263     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> cHimc;
01264     HIMC *phimcFirst;
01265     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01266     <span class="keywordtype">int</span> cTries;
01267 
01268     <span class="comment">/*</span>
01269 <span class="comment">     * Allocate a buffer to hold the names.</span>
01270 <span class="comment">     */</span>
01271     cHimc = 64;
01272     phimcFirst = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, cHimc * <span class="keyword">sizeof</span>(HIMC));
01273     <span class="keywordflow">if</span> (phimcFirst == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01274         <span class="keywordflow">return</span> 0;
01275 
01276     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a390">NtUserBuildHimcList</a>(idThread, cHimc, phimcFirst, &amp;cHimc);
01277 
01278     <span class="comment">/*</span>
01279 <span class="comment">     * If the buffer wasn't big enough, reallocate</span>
01280 <span class="comment">     * the buffer and try again.</span>
01281 <span class="comment">     */</span>
01282     cTries = 0;
01283     <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
01284         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(phimcFirst);
01285 
01286         <span class="comment">/*</span>
01287 <span class="comment">         * If we can't seem to get it right,</span>
01288 <span class="comment">         * call it quits</span>
01289 <span class="comment">         */</span>
01290         <span class="keywordflow">if</span> (cTries++ == 10)
01291             <span class="keywordflow">return</span> 0;
01292 
01293         phimcFirst = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, cHimc * <span class="keyword">sizeof</span>(HIMC));
01294         <span class="keywordflow">if</span> (phimcFirst == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01295             <span class="keywordflow">return</span> 0;
01296 
01297         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a390">NtUserBuildHimcList</a>(idThread, cHimc, phimcFirst, &amp;cHimc);
01298     }
01299 
01300     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) || cHimc == 0) {
01301         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(phimcFirst);
01302         <span class="keywordflow">return</span> 0;
01303     }
01304 
01305     *pphimcFirst = phimcFirst;
01306 
01307     <span class="keywordflow">return</span> cHimc;
01308 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:34 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
