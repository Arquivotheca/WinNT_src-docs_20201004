<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: sepaudit.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>sepaudit.c</h1><a href="../../d7/d6/sepaudit_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    sepaudit.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This Module implements the audit and alarm procedures that are</span>
00012 <span class="comment">    private to the security component.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Robert Reichel      (robertre)     September 10, 1991</span>
00017 <span class="comment"></span>
00018 <span class="comment">Environment:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Kernel Mode</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="preprocessor">#include &lt;nt.h&gt;</span>
00027 <span class="preprocessor">#include &lt;ntlsa.h&gt;</span>
00028 <span class="preprocessor">#include &lt;msaudite.h&gt;</span>
00029 <span class="preprocessor">#include "<a class="code" href="../../d8/d3/tokenp_8h.html">tokenp.h</a>"</span>
00030 <span class="preprocessor">#include "<a class="code" href="../../d7/d4/adt_8h.html">adt.h</a>"</span>
00031 <span class="preprocessor">#include "<a class="code" href="../../d1/d5/adtp_8h.html">adtp.h</a>"</span>
00032 
00033 
00034 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeAuditHandleDuplication)</span>
00036 <span class="preprocessor"></span><span class="comment">// #pragma alloc_text(PAGE,SepAdtAuditThisEvent)</span>
00037 <span class="preprocessor">#pragma alloc_text(PAGE,SepAdtPrivilegeObjectAuditAlarm)</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepAdtPrivilegedServiceAuditAlarm)</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepAdtOpenObjectAuditAlarm)</span>
00040 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepAdtOpenObjectForDeleteAuditAlarm)</span>
00041 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepAdtHandleAuditAlarm)</span>
00042 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepAdtObjectReferenceAuditAlarm)</span>
00043 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepQueryNameString)</span>
00044 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepQueryTypeString)</span>
00045 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeAuditProcessCreation)</span>
00046 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeAuditProcessExit)</span>
00047 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepAdtGenerateDiscardAudit)</span>
00048 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00049 <span class="preprocessor"></span>
00050 
<a name="l00051"></a><a class="code" href="../../d7/d6/sepaudit_8c.html#a0">00051</a> <span class="preprocessor">#define SepSetParmTypeSid( AuditParameters, Index, Sid )                       \</span>
00052 <span class="preprocessor">    {                                                                          \</span>
00053 <span class="preprocessor">        (AuditParameters).Parameters[(Index)].Type = SeAdtParmTypeSid;         \</span>
00054 <span class="preprocessor">        (AuditParameters).Parameters[(Index)].Length = SeLengthSid( (Sid) );   \</span>
00055 <span class="preprocessor">        (AuditParameters).Parameters[(Index)].Address = (Sid);                 \</span>
00056 <span class="preprocessor">    }</span>
00057 <span class="preprocessor"></span>
00058 
<a name="l00059"></a><a class="code" href="../../d7/d6/sepaudit_8c.html#a1">00059</a> <span class="preprocessor">#define SepSetParmTypeString( AuditParameters, Index, String )                 \</span>
00060 <span class="preprocessor">    {                                                                          \</span>
00061 <span class="preprocessor">        (AuditParameters).Parameters[(Index)].Type = SeAdtParmTypeString;      \</span>
00062 <span class="preprocessor">        (AuditParameters).Parameters[(Index)].Length =                         \</span>
00063 <span class="preprocessor">                sizeof(UNICODE_STRING)+(String)-&gt;Length;                       \</span>
00064 <span class="preprocessor">        (AuditParameters).Parameters[(Index)].Address = (String);              \</span>
00065 <span class="preprocessor">    }</span>
00066 <span class="preprocessor"></span>
00067 
<a name="l00068"></a><a class="code" href="../../d7/d6/sepaudit_8c.html#a2">00068</a> <span class="preprocessor">#define SepSetParmTypeFileSpec( AuditParameters, Index, String )               \</span>
00069 <span class="preprocessor">    {                                                                          \</span>
00070 <span class="preprocessor">        (AuditParameters).Parameters[(Index)].Type = SeAdtParmTypeFileSpec;    \</span>
00071 <span class="preprocessor">        (AuditParameters).Parameters[(Index)].Length =                         \</span>
00072 <span class="preprocessor">                sizeof(UNICODE_STRING)+(String)-&gt;Length;                       \</span>
00073 <span class="preprocessor">        (AuditParameters).Parameters[(Index)].Address = (String);              \</span>
00074 <span class="preprocessor">    }</span>
00075 <span class="preprocessor"></span>
<a name="l00076"></a><a class="code" href="../../d7/d6/sepaudit_8c.html#a3">00076</a> <span class="preprocessor">#define SepSetParmTypeUlong( AuditParameters, Index, Ulong )                   \</span>
00077 <span class="preprocessor">    {                                                                          \</span>
00078 <span class="preprocessor">        (AuditParameters).Parameters[(Index)].Type = SeAdtParmTypeUlong;       \</span>
00079 <span class="preprocessor">        (AuditParameters).Parameters[(Index)].Length =  sizeof( (Ulong) );     \</span>
00080 <span class="preprocessor">        (AuditParameters).Parameters[(Index)].Data[0] = (ULONG)(Ulong);        \</span>
00081 <span class="preprocessor">    }</span>
00082 <span class="preprocessor"></span>
<a name="l00083"></a><a class="code" href="../../d7/d6/sepaudit_8c.html#a4">00083</a> <span class="preprocessor">#define SepSetParmTypeNoLogon( AuditParameters, Index )                        \</span>
00084 <span class="preprocessor">    {                                                                          \</span>
00085 <span class="preprocessor">        (AuditParameters).Parameters[(Index)].Type = SeAdtParmTypeNoLogonId;   \</span>
00086 <span class="preprocessor">    }</span>
00087 <span class="preprocessor"></span>
<a name="l00088"></a><a class="code" href="../../d7/d6/sepaudit_8c.html#a5">00088</a> <span class="preprocessor">#define SepSetParmTypeLogonId( AuditParameters, Index, LogonId )                   \</span>
00089 <span class="preprocessor">    {                                                                          \</span>
00090 <span class="preprocessor">        LUID UNALIGNED * TmpLuid;                                                           \</span>
00091 <span class="preprocessor">                                                                                 \</span>
00092 <span class="preprocessor">        (AuditParameters).Parameters[(Index)].Type = SeAdtParmTypeLogonId;       \</span>
00093 <span class="preprocessor">        (AuditParameters).Parameters[(Index)].Length =  sizeof( (LogonId) );     \</span>
00094 <span class="preprocessor">        TmpLuid = (LUID UNALIGNED *)(&amp;(AuditParameters).Parameters[(Index)].Data[0]);                  \</span>
00095 <span class="preprocessor">        *TmpLuid = (LogonId);                                                     \</span>
00096 <span class="preprocessor">    }</span>
00097 <span class="preprocessor"></span>
<a name="l00098"></a><a class="code" href="../../d7/d6/sepaudit_8c.html#a6">00098</a> <span class="preprocessor">#define SepSetParmTypeAccessMask( AuditParameters, Index, AccessMask, ObjectTypeIndex )  \</span>
00099 <span class="preprocessor">    {                                                                                    \</span>
00100 <span class="preprocessor">        (AuditParameters).Parameters[(Index)].Type = SeAdtParmTypeAccessMask;            \</span>
00101 <span class="preprocessor">        (AuditParameters).Parameters[(Index)].Length = sizeof( ACCESS_MASK );            \</span>
00102 <span class="preprocessor">        (AuditParameters).Parameters[(Index)].Data[0] = (AccessMask);                    \</span>
00103 <span class="preprocessor">        (AuditParameters).Parameters[(Index)].Data[1] = (ObjectTypeIndex);               \</span>
00104 <span class="preprocessor">    }</span>
00105 <span class="preprocessor"></span>
<a name="l00106"></a><a class="code" href="../../d7/d6/sepaudit_8c.html#a7">00106</a> <span class="preprocessor">#define SepSetParmTypePrivileges( AuditParameters, Index, Privileges )                      \</span>
00107 <span class="preprocessor">    {                                                                                       \</span>
00108 <span class="preprocessor">        (AuditParameters).Parameters[(Index)].Type = SeAdtParmTypePrivs;                    \</span>
00109 <span class="preprocessor">        (AuditParameters).Parameters[(Index)].Length = SepPrivilegeSetSize( (Privileges) ); \</span>
00110 <span class="preprocessor">        (AuditParameters).Parameters[(Index)].Address = (Privileges);                       \</span>
00111 <span class="preprocessor">    }</span>
00112 <span class="preprocessor"></span>
<a name="l00113"></a><a class="code" href="../../d7/d6/sepaudit_8c.html#a8">00113</a> <span class="preprocessor">#define SepSetParmTypeObjectTypes( AuditParameters, Index, ObjectTypes, ObjectTypeCount, ObjectTypeIndex )             \</span>
00114 <span class="preprocessor">    {                                                                               \</span>
00115 <span class="preprocessor">        (AuditParameters).Parameters[(Index)].Type = SeAdtParmTypeObjectTypes;            \</span>
00116 <span class="preprocessor">        (AuditParameters).Parameters[(Index)].Length = sizeof( SE_ADT_OBJECT_TYPE ) * (ObjectTypeCount);\</span>
00117 <span class="preprocessor">        (AuditParameters).Parameters[(Index)].Address = (ObjectTypes);                    \</span>
00118 <span class="preprocessor">        (AuditParameters).Parameters[(Index)].Data[1] = (ObjectTypeIndex);               \</span>
00119 <span class="preprocessor">    }</span>
00120 <span class="preprocessor"></span>
00121 
00122 
00123 
00124 BOOLEAN
<a name="l00125"></a><a class="code" href="../../d7/d6/sepaudit_8c.html#a9">00125</a> <a class="code" href="../../d7/d6/sepaudit_8c.html#a9">SepAdtPrivilegeObjectAuditAlarm</a> (
00126     IN PUNICODE_STRING CapturedSubsystemName OPTIONAL,
00127     IN PVOID HandleId,
00128     IN PTOKEN ClientToken OPTIONAL,
00129     IN PTOKEN PrimaryToken,
00130     IN PVOID ProcessId,
00131     IN ACCESS_MASK DesiredAccess,
00132     IN PPRIVILEGE_SET CapturedPrivileges,
00133     IN BOOLEAN AccessGranted
00134     )
00135 
00136 <span class="comment">/*++</span>
00137 <span class="comment"></span>
00138 <span class="comment">Routine Description:</span>
00139 <span class="comment"></span>
00140 <span class="comment">    Implements NtPrivilegeObjectAuditAlarm after parameters have been</span>
00141 <span class="comment">    captured.</span>
00142 <span class="comment"></span>
00143 <span class="comment">    This routine is used to generate audit and alarm messages when an</span>
00144 <span class="comment">    attempt is made to perform privileged operations on a protected</span>
00145 <span class="comment">    subsystem object after the object is already opened.  This routine may</span>
00146 <span class="comment">    result in several messages being generated and sent to Port objects.</span>
00147 <span class="comment">    This may result in a significant latency before returning.  Design of</span>
00148 <span class="comment">    routines that must call this routine must take this potential latency</span>
00149 <span class="comment">    into account.  This may have an impact on the approach taken for data</span>
00150 <span class="comment">    structure mutex locking, for example.</span>
00151 <span class="comment"></span>
00152 <span class="comment">    This API requires the caller have SeTcbPrivilege privilege.  The test</span>
00153 <span class="comment">    for this privilege is always against the primary token of the calling</span>
00154 <span class="comment">    process, allowing the caller to be impersonating a client during the</span>
00155 <span class="comment">    call with no ill effects.</span>
00156 <span class="comment"></span>
00157 <span class="comment">    This routine will create an SE_ADT_PARAMETERS array organized as follows:</span>
00158 <span class="comment"></span>
00159 <span class="comment">    Parameter[0] - User Sid</span>
00160 <span class="comment"></span>
00161 <span class="comment">    Parameter[1] - Subsystem name (if available)</span>
00162 <span class="comment"></span>
00163 <span class="comment">    Parameter[2] - New handle ID</span>
00164 <span class="comment"></span>
00165 <span class="comment">    Parameter[3] - Subject's process id</span>
00166 <span class="comment"></span>
00167 <span class="comment">    Parameter[4] - Subject's primary authentication ID</span>
00168 <span class="comment"></span>
00169 <span class="comment">    Parameter[5] - Subject's client authentication ID</span>
00170 <span class="comment"></span>
00171 <span class="comment">    Parameter[6] - Privileges used for open</span>
00172 <span class="comment"></span>
00173 <span class="comment">Arguments:</span>
00174 <span class="comment"></span>
00175 <span class="comment">    CapturedSubsystemName - Supplies a name string identifying the</span>
00176 <span class="comment">        subsystem calling the routine.</span>
00177 <span class="comment"></span>
00178 <span class="comment">    HandleId - A unique value representing the client's handle to the</span>
00179 <span class="comment">        object.</span>
00180 <span class="comment"></span>
00181 <span class="comment">    ClientToken - Optionally provides a pointer to the client token</span>
00182 <span class="comment">        (only if the caller is currently impersonating)</span>
00183 <span class="comment"></span>
00184 <span class="comment">    PrimaryToken - Provides a pointer to the caller's primary token.</span>
00185 <span class="comment"></span>
00186 <span class="comment">    DesiredAccess - The desired access mask.  This mask must have been</span>
00187 <span class="comment">        previously mapped to contain no generic accesses.</span>
00188 <span class="comment"></span>
00189 <span class="comment">    CapturedPrivileges - The set of privileges required for the requested</span>
00190 <span class="comment">        operation.  Those privileges that were held by the subject are</span>
00191 <span class="comment">        marked using the UsedForAccess flag of the attributes</span>
00192 <span class="comment">        associated with each privilege.</span>
00193 <span class="comment"></span>
00194 <span class="comment">    AccessGranted - Indicates whether the requested access was granted or</span>
00195 <span class="comment">        not.  A value of TRUE indicates the access was granted.  A value of</span>
00196 <span class="comment">        FALSE indicates the access was not granted.</span>
00197 <span class="comment"></span>
00198 <span class="comment">Return value:</span>
00199 <span class="comment"></span>
00200 <span class="comment">--*/</span>
00201 {
00202     SE_ADT_PARAMETER_ARRAY AuditParameters;
00203     PSID CapturedUserSid;
00204     LUID ClientAuthenticationId;
00205     LUID PrimaryAuthenticationId;
00206 
00207     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00208 
00209     <span class="comment">//</span>
00210     <span class="comment">// Determine if we are auditing the use of privileges</span>
00211     <span class="comment">//</span>
00212 
00213     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d5/adtp_8h.html#a1">SepAdtAuditThisEvent</a>( AuditCategoryPrivilegeUse, &amp;AccessGranted ) &amp;&amp;
00214          <a class="code" href="../../d6/d6/sep_8h.html#a67">SepFilterPrivilegeAudits</a>( CapturedPrivileges )) {
00215 
00216         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> )) {
00217 
00218             CapturedUserSid = <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> );
00219             ClientAuthenticationId =  <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> );
00220 
00221         } <span class="keywordflow">else</span> {
00222 
00223             CapturedUserSid = <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a> );
00224         }
00225 
00226         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( <a class="code" href="../../d0/d5/se_8h.html#a54">SeLocalSystemSid</a>, CapturedUserSid )) {
00227 
00228             <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00229         }
00230 
00231         PrimaryAuthenticationId = <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a> );
00232 
00233         <span class="comment">//</span>
00234         <span class="comment">// A completely zero'd entry will be interpreted</span>
00235         <span class="comment">// as a "null string" or not supplied parameter.</span>
00236         <span class="comment">//</span>
00237         <span class="comment">// Initializing the entire array up front will allow</span>
00238         <span class="comment">// us to avoid filling in each not supplied entry.</span>
00239         <span class="comment">//</span>
00240 
00241         RtlZeroMemory (
00242            (PVOID) &amp;AuditParameters,
00243            <span class="keyword">sizeof</span>( AuditParameters )
00244            );
00245 
00246         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SeAdtParmTypeNone == 0 );
00247 
00248         AuditParameters.CategoryId = SE_CATEGID_PRIVILEGE_USE;
00249         AuditParameters.AuditId = SE_AUDITID_PRIVILEGED_OBJECT;
00250         AuditParameters.ParameterCount = 0;
00251 
00252         <span class="keywordflow">if</span> ( AccessGranted ) {
00253 
00254             AuditParameters.Type = EVENTLOG_AUDIT_SUCCESS;
00255 
00256         } <span class="keywordflow">else</span> {
00257 
00258             AuditParameters.Type = EVENTLOG_AUDIT_FAILURE;
00259         }
00260 
00261         <span class="comment">//</span>
00262         <span class="comment">//    Parameter[0] - User Sid</span>
00263         <span class="comment">//</span>
00264 
00265         <a class="code" href="../../d7/d6/sepaudit_8c.html#a0">SepSetParmTypeSid</a>( AuditParameters, AuditParameters.ParameterCount, CapturedUserSid );
00266 
00267         AuditParameters.ParameterCount++;
00268 
00269         <span class="comment">//</span>
00270         <span class="comment">//    Parameter[1] - Subsystem name (if available)</span>
00271         <span class="comment">//</span>
00272 
00273         <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, CapturedSubsystemName );
00274 
00275         AuditParameters.ParameterCount++;
00276 
00277         <span class="comment">//</span>
00278         <span class="comment">//    Parameter[1] - Subsystem name (if available)</span>
00279         <span class="comment">//</span>
00280 
00281         <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, CapturedSubsystemName );
00282 
00283         AuditParameters.ParameterCount++;
00284 
00285         <span class="comment">//</span>
00286         <span class="comment">//    Parameter[2] - New handle ID</span>
00287         <span class="comment">//</span>
00288 
00289         <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)HandleId) );
00290 
00291         AuditParameters.ParameterCount++;
00292 
00293         <span class="comment">//</span>
00294         <span class="comment">//    Parameter[3] - Subject's process id</span>
00295         <span class="comment">//</span>
00296 
00297         <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)ProcessId) );
00298 
00299         AuditParameters.ParameterCount++;
00300 
00301         <span class="comment">//</span>
00302         <span class="comment">//    Parameter[4] - Subject's primary authentication ID</span>
00303         <span class="comment">//</span>
00304 
00305         <a class="code" href="../../d7/d6/sepaudit_8c.html#a5">SepSetParmTypeLogonId</a>( AuditParameters, AuditParameters.ParameterCount, PrimaryAuthenticationId );
00306 
00307         AuditParameters.ParameterCount++;
00308 
00309         <span class="comment">//</span>
00310         <span class="comment">//    Parameter[5] - Subject's client authentication ID</span>
00311         <span class="comment">//</span>
00312 
00313         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> )) {
00314 
00315             <a class="code" href="../../d7/d6/sepaudit_8c.html#a5">SepSetParmTypeLogonId</a>( AuditParameters, AuditParameters.ParameterCount, ClientAuthenticationId );
00316 
00317         } <span class="keywordflow">else</span> {
00318 
00319             <a class="code" href="../../d7/d6/sepaudit_8c.html#a4">SepSetParmTypeNoLogon</a>( AuditParameters, AuditParameters.ParameterCount );
00320         }
00321 
00322         AuditParameters.ParameterCount++;
00323 
00324         <span class="comment">//</span>
00325         <span class="comment">//    Parameter[6] - Privileges used for open</span>
00326         <span class="comment">//</span>
00327 
00328         <span class="keywordflow">if</span> ( (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (CapturedPrivileges-&gt;PrivilegeCount &gt; 0) ) {
00329 
00330             <a class="code" href="../../d7/d6/sepaudit_8c.html#a7">SepSetParmTypePrivileges</a>( AuditParameters, AuditParameters.ParameterCount, CapturedPrivileges );
00331         }
00332 
00333         AuditParameters.ParameterCount++;
00334 
00335         <a class="code" href="../../d0/d5/adtlog_8c.html#a0">SepAdtLogAuditRecord</a>( &amp;AuditParameters );
00336 
00337         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00338 
00339     }
00340 
00341     <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00342 }
00343 
00344 
00345 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00346"></a><a class="code" href="../../d7/d6/sepaudit_8c.html#a10">00346</a> <a class="code" href="../../d7/d6/sepaudit_8c.html#a10">SepAdtPrivilegedServiceAuditAlarm</a> (
00347     IN PUNICODE_STRING CapturedSubsystemName,
00348     IN PUNICODE_STRING CapturedServiceName,
00349     IN PTOKEN ClientToken OPTIONAL,
00350     IN PTOKEN PrimaryToken,
00351     IN PPRIVILEGE_SET CapturedPrivileges,
00352     IN BOOLEAN AccessGranted
00353     )
00354 
00355 <span class="comment">/*++</span>
00356 <span class="comment"></span>
00357 <span class="comment">Routine Description:</span>
00358 <span class="comment"></span>
00359 <span class="comment">    This routine is the active part of NtPrivilegedServiceAuditAlarm.</span>
00360 <span class="comment"></span>
00361 <span class="comment">    This routine is used to generate audit and alarm messages when an</span>
00362 <span class="comment">    attempt is made to perform privileged system service operations.  This</span>
00363 <span class="comment">    routine may result in several messages being generated and sent to Port</span>
00364 <span class="comment">    objects.  This may result in a significant latency before returning.</span>
00365 <span class="comment">    Design of routines that must call this routine must take this potential</span>
00366 <span class="comment">    latency into account.  This may have an impact on the approach taken</span>
00367 <span class="comment">    for data structure mutex locking, for example.</span>
00368 <span class="comment"></span>
00369 <span class="comment">    This API requires the caller have SeTcbPrivilege privilege.  The test</span>
00370 <span class="comment">    for this privilege is always against the primary token of the calling</span>
00371 <span class="comment">    process, allowing the caller to be impersonating a client during the</span>
00372 <span class="comment">    call with no ill effects.  The test for this privilege is assumed to</span>
00373 <span class="comment">    have occurred at a higher level.</span>
00374 <span class="comment"></span>
00375 <span class="comment">    This routine will create an SE_ADT_PARAMETERS array organized as follows:</span>
00376 <span class="comment"></span>
00377 <span class="comment">    Parameter[0] - User Sid</span>
00378 <span class="comment"></span>
00379 <span class="comment">    Parameter[1] - Subsystem name (if available)</span>
00380 <span class="comment"></span>
00381 <span class="comment">    Parameter[2] - Subject's primary authentication ID</span>
00382 <span class="comment"></span>
00383 <span class="comment">    Parameter[3] - Subject's client authentication ID</span>
00384 <span class="comment"></span>
00385 <span class="comment">    Parameter[4] - Privileges used for open</span>
00386 <span class="comment"></span>
00387 <span class="comment">Arguments:</span>
00388 <span class="comment"></span>
00389 <span class="comment">    SubsystemName - Supplies a name string identifying the subsystem</span>
00390 <span class="comment">        calling the routine.</span>
00391 <span class="comment"></span>
00392 <span class="comment">    ServiceName - Supplies a name of the privileged subsystem service.  For</span>
00393 <span class="comment">        example, "RESET RUNTIME LOCAL SECURITY POLICY" might be specified</span>
00394 <span class="comment">        by a Local Security Authority service used to update the local</span>
00395 <span class="comment">        security policy database.</span>
00396 <span class="comment"></span>
00397 <span class="comment">    ClientToken - Optionally provides a pointer to the client token</span>
00398 <span class="comment">        (only if the caller is currently impersonating)</span>
00399 <span class="comment"></span>
00400 <span class="comment">    PrimaryToken - Provides a pointer to the caller's primary token.</span>
00401 <span class="comment"></span>
00402 <span class="comment">    Privileges - Points to a set of privileges required to perform the</span>
00403 <span class="comment">        privileged operation.  Those privileges that were held by the</span>
00404 <span class="comment">        subject are marked using the UsedForAccess flag of the</span>
00405 <span class="comment">        attributes associated with each privilege.</span>
00406 <span class="comment"></span>
00407 <span class="comment">    AccessGranted - Indicates whether the requested access was granted or</span>
00408 <span class="comment">        not.  A value of TRUE indicates the access was granted.  A value of</span>
00409 <span class="comment">        FALSE indicates the access was not granted.</span>
00410 <span class="comment"></span>
00411 <span class="comment"></span>
00412 <span class="comment">Return value:</span>
00413 <span class="comment"></span>
00414 <span class="comment"></span>
00415 <span class="comment">--*/</span>
00416 
00417 {
00418 
00419     SE_ADT_PARAMETER_ARRAY AuditParameters;
00420     PSID CapturedUserSid;
00421     LUID ClientAuthenticationId;
00422     LUID PrimaryAuthenticationId;
00423     PUNICODE_STRING SubsystemName;
00424 
00425     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00426 
00427     <span class="comment">//</span>
00428     <span class="comment">// Determine if we are auditing privileged services</span>
00429     <span class="comment">//</span>
00430 
00431     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d5/adtp_8h.html#a1">SepAdtAuditThisEvent</a>( AuditCategoryPrivilegeUse, &amp;AccessGranted )) {
00432 
00433         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> )) {
00434 
00435             CapturedUserSid = <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> );
00436             ClientAuthenticationId =  <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> );
00437 
00438         } <span class="keywordflow">else</span> {
00439 
00440             CapturedUserSid = <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a> );
00441         }
00442 
00443         PrimaryAuthenticationId = <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a> );
00444 
00445         <span class="keywordflow">if</span> ( !ARGUMENT_PRESENT( CapturedSubsystemName )) {
00446 
00447             SubsystemName = &amp;<a class="code" href="../../d0/d5/se_8h.html#a107">SeSubsystemName</a>;
00448 
00449         } <span class="keywordflow">else</span> {
00450 
00451             SubsystemName = CapturedSubsystemName;
00452         }
00453 
00454         <span class="comment">//</span>
00455         <span class="comment">// A completely zero'd entry will be interpreted</span>
00456         <span class="comment">// as a "null string" or not supplied parameter.</span>
00457         <span class="comment">//</span>
00458         <span class="comment">// Initializing the entire array up front will allow</span>
00459         <span class="comment">// us to avoid filling in each not supplied entry.</span>
00460         <span class="comment">//</span>
00461 
00462         RtlZeroMemory (
00463            (PVOID) &amp;AuditParameters,
00464            <span class="keyword">sizeof</span>( AuditParameters )
00465            );
00466 
00467         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SeAdtParmTypeNone == 0 );
00468 
00469         AuditParameters.CategoryId = SE_CATEGID_PRIVILEGE_USE;
00470         AuditParameters.AuditId = SE_AUDITID_PRIVILEGED_SERVICE;
00471         AuditParameters.ParameterCount = 0;
00472 
00473         <span class="keywordflow">if</span> ( AccessGranted ) {
00474 
00475             AuditParameters.Type = EVENTLOG_AUDIT_SUCCESS;
00476 
00477         } <span class="keywordflow">else</span> {
00478 
00479             AuditParameters.Type = EVENTLOG_AUDIT_FAILURE;
00480         }
00481 
00482 
00483     <span class="comment">//</span>
00484     <span class="comment">//    Parameter[0] - User Sid</span>
00485     <span class="comment">//</span>
00486 
00487         <a class="code" href="../../d7/d6/sepaudit_8c.html#a0">SepSetParmTypeSid</a>( AuditParameters, AuditParameters.ParameterCount, CapturedUserSid );
00488 
00489         AuditParameters.ParameterCount++;
00490 
00491     <span class="comment">//</span>
00492     <span class="comment">//    Parameter[1] - Subsystem name (if available)</span>
00493     <span class="comment">//</span>
00494 
00495     <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, SubsystemName );
00496 
00497     AuditParameters.ParameterCount++;
00498 
00499 
00500     <span class="comment">//</span>
00501     <span class="comment">//    Parameter[2] - Server</span>
00502     <span class="comment">//</span>
00503 
00504     <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, SubsystemName );
00505 
00506     AuditParameters.ParameterCount++;
00507 
00508 
00509     <span class="comment">//</span>
00510     <span class="comment">//    Parameter[3] - Service name (if available)</span>
00511     <span class="comment">//</span>
00512 
00513     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( CapturedServiceName )) {
00514 
00515         <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, CapturedServiceName );
00516     }
00517 
00518     AuditParameters.ParameterCount++;
00519 
00520     <span class="comment">//</span>
00521     <span class="comment">//    Parameter[3] - Subject's primary authentication ID</span>
00522     <span class="comment">//</span>
00523 
00524 
00525     <a class="code" href="../../d7/d6/sepaudit_8c.html#a5">SepSetParmTypeLogonId</a>( AuditParameters, AuditParameters.ParameterCount, PrimaryAuthenticationId );
00526 
00527     AuditParameters.ParameterCount++;
00528 
00529 
00530     <span class="comment">//</span>
00531     <span class="comment">//    Parameter[4] - Subject's client authentication ID</span>
00532     <span class="comment">//</span>
00533 
00534     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> )) {
00535 
00536         <a class="code" href="../../d7/d6/sepaudit_8c.html#a5">SepSetParmTypeLogonId</a>( AuditParameters, AuditParameters.ParameterCount, ClientAuthenticationId );
00537 
00538     } <span class="keywordflow">else</span> {
00539 
00540         <a class="code" href="../../d7/d6/sepaudit_8c.html#a4">SepSetParmTypeNoLogon</a>( AuditParameters, AuditParameters.ParameterCount );
00541     }
00542 
00543     AuditParameters.ParameterCount++;
00544 
00545 
00546     <span class="comment">//</span>
00547     <span class="comment">//    Parameter[5] - Privileges used for open</span>
00548     <span class="comment">//</span>
00549 
00550 
00551     <span class="keywordflow">if</span> ( (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (CapturedPrivileges-&gt;PrivilegeCount &gt; 0) ) {
00552 
00553         <a class="code" href="../../d7/d6/sepaudit_8c.html#a7">SepSetParmTypePrivileges</a>( AuditParameters, AuditParameters.ParameterCount, CapturedPrivileges );
00554     }
00555 
00556     AuditParameters.ParameterCount++;
00557 
00558 
00559     <a class="code" href="../../d0/d5/adtlog_8c.html#a0">SepAdtLogAuditRecord</a>( &amp;AuditParameters );
00560 
00561     }
00562 
00563 }
00564 
00565 
00566 
00567 
00568 
00569 
00570 BOOLEAN
<a name="l00571"></a><a class="code" href="../../d7/d6/sepaudit_8c.html#a11">00571</a> <a class="code" href="../../d7/d6/sepaudit_8c.html#a11">SepAdtOpenObjectAuditAlarm</a> (
00572     IN PUNICODE_STRING CapturedSubsystemName,
00573     IN PVOID *HandleId OPTIONAL,
00574     IN PUNICODE_STRING CapturedObjectTypeName,
00575     IN PVOID Object OPTIONAL,
00576     IN PUNICODE_STRING CapturedObjectName OPTIONAL,
00577     IN PTOKEN ClientToken OPTIONAL,
00578     IN PTOKEN PrimaryToken,
00579     IN ACCESS_MASK DesiredAccess,
00580     IN ACCESS_MASK GrantedAccess,
00581     IN PLUID OperationId,
00582     IN PPRIVILEGE_SET CapturedPrivileges OPTIONAL,
00583     IN BOOLEAN ObjectCreated,
00584     IN BOOLEAN AccessGranted,
00585     IN BOOLEAN GenerateAudit,
00586     IN BOOLEAN GenerateAlarm,
00587     IN HANDLE ProcessID,
00588     IN POLICY_AUDIT_EVENT_TYPE AuditType,
00589     IN <a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> ObjectTypeList OPTIONAL,
00590     IN ULONG ObjectTypeListLength,
00591     IN PACCESS_MASK GrantedAccessArray OPTIONAL
00592     )
00593 
00594 <span class="comment">/*++</span>
00595 <span class="comment"></span>
00596 <span class="comment">    Routine Description:</span>
00597 <span class="comment"></span>
00598 <span class="comment">    Implements NtOpenObjectAuditAlarm after parameters have been captured.</span>
00599 <span class="comment"></span>
00600 <span class="comment">    This routine is used to generate audit and alarm messages when an</span>
00601 <span class="comment">    attempt is made to access an existing protected subsystem object or</span>
00602 <span class="comment">    create a new one.  This routine may result in several messages being</span>
00603 <span class="comment">    generated and sent to Port objects.  This may result in a significant</span>
00604 <span class="comment">    latency before returning.  Design of routines that must call this</span>
00605 <span class="comment">    routine must take this potential latency into account.  This may have</span>
00606 <span class="comment">    an impact on the approach taken for data structure mutex locking, for</span>
00607 <span class="comment">    example.  This API requires the caller have SeTcbPrivilege privilege.</span>
00608 <span class="comment">    The test for this privilege is always against the primary token of the</span>
00609 <span class="comment">    calling process, not the impersonation token of the thread.</span>
00610 <span class="comment"></span>
00611 <span class="comment"></span>
00612 <span class="comment">    This routine will create an SE_ADT_PARAMETERS array organized as follows:</span>
00613 <span class="comment"></span>
00614 <span class="comment">    Parameter[0] - User Sid</span>
00615 <span class="comment"></span>
00616 <span class="comment">    Parameter[1] - Subsystem name (if available)</span>
00617 <span class="comment"></span>
00618 <span class="comment">    Parameter[2] - Server name (if available)</span>
00619 <span class="comment"></span>
00620 <span class="comment">    Parameter[3] - Object Type Name</span>
00621 <span class="comment"></span>
00622 <span class="comment">    Parameter[4] - Object Name</span>
00623 <span class="comment"></span>
00624 <span class="comment">    Parameter[5] - New handle ID</span>
00625 <span class="comment"></span>
00626 <span class="comment">    Parameter[6] - Subject's process id</span>
00627 <span class="comment"></span>
00628 <span class="comment">    Parameter[7] - Subject's primary authentication ID</span>
00629 <span class="comment"></span>
00630 <span class="comment">    Parameter[8] - Subject's client authentication ID</span>
00631 <span class="comment"></span>
00632 <span class="comment">    Parameter[9] - DesiredAccess mask</span>
00633 <span class="comment"></span>
00634 <span class="comment">    Parameter[10] - Privileges used for open</span>
00635 <span class="comment"></span>
00636 <span class="comment">    Parameter[11] - Guid/Level/AccessMask of objects/property sets/properties accesses.</span>
00637 <span class="comment"></span>
00638 <span class="comment">Arguments:</span>
00639 <span class="comment"></span>
00640 <span class="comment">    CapturedSubsystemName - Supplies a name string identifying the</span>
00641 <span class="comment">        subsystem calling the routine.</span>
00642 <span class="comment"></span>
00643 <span class="comment">    HandleId - A unique value representing the client's handle to the</span>
00644 <span class="comment">        object.  If the access attempt was not successful (AccessGranted is</span>
00645 <span class="comment">        FALSE), then this parameter is ignored.</span>
00646 <span class="comment"></span>
00647 <span class="comment">    CapturedObjectTypeName - Supplies the name of the type of object being</span>
00648 <span class="comment">        accessed.</span>
00649 <span class="comment"></span>
00650 <span class="comment">    CapturedObjectName - Supplies the name of the object the client</span>
00651 <span class="comment">        accessed or attempted to access.</span>
00652 <span class="comment"></span>
00653 <span class="comment">    CapturedSecurityDescriptor - A pointer to the security descriptor of</span>
00654 <span class="comment">        the object being accessed.</span>
00655 <span class="comment"></span>
00656 <span class="comment">    ClientToken - Optionally provides a pointer to the client token</span>
00657 <span class="comment">        (only if the caller is currently impersonating)</span>
00658 <span class="comment"></span>
00659 <span class="comment">    PrimaryToken - Provides a pointer to the caller's primary token.</span>
00660 <span class="comment"></span>
00661 <span class="comment">    DesiredAccess - The desired access mask.  This mask must have been</span>
00662 <span class="comment">        previously mapped to contain no generic accesses.</span>
00663 <span class="comment"></span>
00664 <span class="comment">    GrantedAccess - The mask of accesses that were actually granted.</span>
00665 <span class="comment"></span>
00666 <span class="comment">    CapturedPrivileges - Optionally points to a set of privileges that were</span>
00667 <span class="comment">        required for the access attempt.  Those privileges that were held</span>
00668 <span class="comment">        by the subject are marked using the UsedForAccess flag of the</span>
00669 <span class="comment">        attributes associated with each privilege.</span>
00670 <span class="comment"></span>
00671 <span class="comment">    ObjectCreation - A boolean flag indicating whether the access will</span>
00672 <span class="comment">        result in a new object being created if granted.  A value of TRUE</span>
00673 <span class="comment">        indicates an object will be created, FALSE indicates an existing</span>
00674 <span class="comment">        object will be opened.</span>
00675 <span class="comment"></span>
00676 <span class="comment">    AccessGranted - Indicates whether the requested access was granted or</span>
00677 <span class="comment">        not.  A value of TRUE indicates the access was granted.  A value of</span>
00678 <span class="comment">        FALSE indicates the access was not granted.</span>
00679 <span class="comment"></span>
00680 <span class="comment">    GenerateOnClose - Points to a boolean that is set by the audit</span>
00681 <span class="comment">        generation routine and must be passed to NtCloseObjectAuditAlarm()</span>
00682 <span class="comment">        when the object handle is closed.</span>
00683 <span class="comment"></span>
00684 <span class="comment">    GenerateAudit - Indicates if we should generate an audit for this operation.</span>
00685 <span class="comment"></span>
00686 <span class="comment">    GenerateAlarm - Indicates if we should generate an alarm for this operation.</span>
00687 <span class="comment"></span>
00688 <span class="comment">    AuditType - Specifies the type of audit to be generated.  Valid values</span>
00689 <span class="comment">        are: AuditCategoryObjectAccess and AuditCategoryDirectoryServiceAccess.</span>
00690 <span class="comment"></span>
00691 <span class="comment">    ObjectTypeList - Supplies a list of GUIDs representing the object (and</span>
00692 <span class="comment">        sub-objects) being accessed.</span>
00693 <span class="comment"></span>
00694 <span class="comment">    ObjectTypeListLength - Specifies the number of elements in the ObjectTypeList.</span>
00695 <span class="comment"></span>
00696 <span class="comment">    GrantedAccessArray - If non NULL, specifies an array of access mask granted</span>
00697 <span class="comment">        to each object in ObjectTypeList.</span>
00698 <span class="comment"></span>
00699 <span class="comment">Return Value:</span>
00700 <span class="comment"></span>
00701 <span class="comment">    Returns TRUE if audit is generated, FALSE otherwise.</span>
00702 <span class="comment"></span>
00703 <span class="comment">--*/</span>
00704 
00705 {
00706     SE_ADT_PARAMETER_ARRAY AuditParameters;
00707     ULONG ObjectTypeIndex;
00708     PSID CapturedUserSid;
00709     LUID PrimaryAuthenticationId;
00710     LUID ClientAuthenticationId;
00711     PSE_ADT_OBJECT_TYPE AdtObjectTypeBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00712 
00713     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00714 
00715     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> )) {
00716 
00717         CapturedUserSid = <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> );
00718         ClientAuthenticationId =  <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> );
00719 
00720     } <span class="keywordflow">else</span> {
00721 
00722         CapturedUserSid = <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a> );
00723     }
00724 
00725     PrimaryAuthenticationId = <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a> );
00726 
00727     <span class="comment">//</span>
00728     <span class="comment">// A completely zero'd entry will be interpreted</span>
00729     <span class="comment">// as a "null string" or not supplied parameter.</span>
00730     <span class="comment">//</span>
00731     <span class="comment">// Initializing the entire array up front will allow</span>
00732     <span class="comment">// us to avoid filling in each not supplied entry.</span>
00733     <span class="comment">//</span>
00734 
00735     RtlZeroMemory (
00736        (PVOID) &amp;AuditParameters,
00737        <span class="keyword">sizeof</span>( AuditParameters )
00738        );
00739 
00740     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SeAdtParmTypeNone == 0 );
00741 
00742     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ( AuditType == AuditCategoryObjectAccess ) ||
00743             ( AuditType == AuditCategoryDirectoryServiceAccess ) );
00744     
00745     <span class="keywordflow">if</span> (AuditType == AuditCategoryObjectAccess) {
00746         
00747         AuditParameters.CategoryId = SE_CATEGID_OBJECT_ACCESS;
00748     } <span class="keywordflow">else</span> {
00749 
00750         AuditParameters.CategoryId = SE_CATEGID_DS_ACCESS;
00751     }
00752 
00753     AuditParameters.AuditId = SE_AUDITID_OPEN_HANDLE;
00754     AuditParameters.ParameterCount = 0;
00755 
00756     <span class="keywordflow">if</span> ( AccessGranted ) {
00757 
00758         AuditParameters.Type = EVENTLOG_AUDIT_SUCCESS;
00759 
00760     } <span class="keywordflow">else</span> {
00761 
00762         AuditParameters.Type = EVENTLOG_AUDIT_FAILURE;
00763     }
00764 
00765     <span class="comment">//</span>
00766     <span class="comment">//  Parameter[0] - User Sid</span>
00767     <span class="comment">//</span>
00768 
00769     <a class="code" href="../../d7/d6/sepaudit_8c.html#a0">SepSetParmTypeSid</a>( AuditParameters, AuditParameters.ParameterCount, CapturedUserSid );
00770 
00771     AuditParameters.ParameterCount++;
00772 
00773     <span class="comment">//</span>
00774     <span class="comment">//  Parameter[1] - Subsystem name (if available)</span>
00775     <span class="comment">//</span>
00776 
00777     <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, CapturedSubsystemName );
00778 
00779     AuditParameters.ParameterCount++;
00780 
00781     <span class="comment">//</span>
00782     <span class="comment">//  Parameter[2] - Object Server (if available)</span>
00783     <span class="comment">//</span>
00784 
00785     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( CapturedSubsystemName )) {
00786 
00787         <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, CapturedSubsystemName );
00788     }
00789 
00790     AuditParameters.ParameterCount++;
00791 
00792     <span class="comment">//</span>
00793     <span class="comment">//  Parameter[3] - Object Type Name</span>
00794     <span class="comment">//</span>
00795 
00796     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( CapturedObjectTypeName )) {
00797 
00798         <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, CapturedObjectTypeName );
00799         ObjectTypeIndex = AuditParameters.ParameterCount;
00800     }
00801 
00802     AuditParameters.ParameterCount++;
00803 
00804     <span class="comment">//</span>
00805     <span class="comment">//  Parameter[4] - Object Name</span>
00806     <span class="comment">//</span>
00807 
00808     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( CapturedObjectName )) {
00809 
00810         <a class="code" href="../../d7/d6/sepaudit_8c.html#a2">SepSetParmTypeFileSpec</a>( AuditParameters, AuditParameters.ParameterCount, CapturedObjectName );
00811     }
00812 
00813     AuditParameters.ParameterCount++;
00814 
00815     <span class="comment">//</span>
00816     <span class="comment">//  Parameter[5] - New handle ID</span>
00817     <span class="comment">//</span>
00818 
00819     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( HandleId )) {
00820 
00821         <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)*HandleId) );
00822     }
00823 
00824     AuditParameters.ParameterCount++;
00825 
00826     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( OperationId )) {
00827 
00828         <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (*OperationId).HighPart );
00829 
00830         AuditParameters.ParameterCount++;
00831 
00832         <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (*OperationId).LowPart );
00833 
00834         AuditParameters.ParameterCount++;
00835 
00836     } <span class="keywordflow">else</span> {
00837 
00838         AuditParameters.ParameterCount += 2;
00839     }
00840 
00841     <span class="comment">//</span>
00842     <span class="comment">//  Parameter[6] - Subject's process id</span>
00843     <span class="comment">//</span>
00844 
00845     <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)ProcessID) );
00846 
00847     AuditParameters.ParameterCount++;
00848 
00849     <span class="comment">//</span>
00850     <span class="comment">//  Parameter[7] - Subject's primary authentication ID</span>
00851     <span class="comment">//</span>
00852 
00853     <a class="code" href="../../d7/d6/sepaudit_8c.html#a5">SepSetParmTypeLogonId</a>( AuditParameters, AuditParameters.ParameterCount, PrimaryAuthenticationId );
00854 
00855     AuditParameters.ParameterCount++;
00856 
00857     <span class="comment">//</span>
00858     <span class="comment">//  Parameter[8] - Subject's client authentication ID</span>
00859     <span class="comment">//</span>
00860 
00861     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> )) {
00862 
00863         <a class="code" href="../../d7/d6/sepaudit_8c.html#a5">SepSetParmTypeLogonId</a>( AuditParameters, AuditParameters.ParameterCount, ClientAuthenticationId );
00864 
00865     } <span class="keywordflow">else</span> {
00866 
00867         <a class="code" href="../../d7/d6/sepaudit_8c.html#a4">SepSetParmTypeNoLogon</a>( AuditParameters, AuditParameters.ParameterCount  );
00868     }
00869 
00870     AuditParameters.ParameterCount++;
00871 
00872     <span class="comment">//</span>
00873     <span class="comment">//  Parameter[9] - DesiredAccess mask</span>
00874     <span class="comment">//</span>
00875 
00876     <span class="keywordflow">if</span> ( AccessGranted ) {
00877 
00878         <a class="code" href="../../d7/d6/sepaudit_8c.html#a6">SepSetParmTypeAccessMask</a>( AuditParameters, AuditParameters.ParameterCount, GrantedAccess, ObjectTypeIndex );
00879 
00880     } <span class="keywordflow">else</span> {
00881 
00882         <a class="code" href="../../d7/d6/sepaudit_8c.html#a6">SepSetParmTypeAccessMask</a>( AuditParameters, AuditParameters.ParameterCount, DesiredAccess, ObjectTypeIndex );
00883     }
00884 
00885     AuditParameters.ParameterCount++;
00886 
00887     <span class="comment">//</span>
00888     <span class="comment">//    Parameter[10] - Privileges used for open</span>
00889     <span class="comment">//</span>
00890 
00891     <span class="keywordflow">if</span> ( (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (CapturedPrivileges-&gt;PrivilegeCount &gt; 0) ) {
00892 
00893         <a class="code" href="../../d7/d6/sepaudit_8c.html#a7">SepSetParmTypePrivileges</a>( AuditParameters, AuditParameters.ParameterCount, CapturedPrivileges );
00894     }
00895 
00896     AuditParameters.ParameterCount++;
00897 
00898     <span class="comment">//</span>
00899     <span class="comment">//    Parameter[11] - ObjectTypes of Audited objects/parameter sets/parameters</span>
00900     <span class="comment">//</span>
00901 
00902     <span class="keywordflow">if</span> ( ObjectTypeListLength != 0 ) {
00903         ULONG GuidCount;
00904         ULONG i;
00905         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a5">FlagMask</a> = AccessGranted ? <a class="code" href="../../d8/d3/tokenp_8h.html#a4">OBJECT_SUCCESS_AUDIT</a> : <a class="code" href="../../d8/d3/tokenp_8h.html#a5">OBJECT_FAILURE_AUDIT</a>;
00906 
00907         <span class="comment">//</span>
00908         <span class="comment">// Count the number of GUIDs to audit.</span>
00909         <span class="comment">//</span>
00910 
00911         GuidCount = 0;
00912         <span class="keywordflow">for</span> ( i=0; i&lt;ObjectTypeListLength; i++ ) {
00913 
00914             <span class="keywordflow">if</span> ( i == 0 ) {
00915                 GuidCount++;
00916             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ObjectTypeList[i].Flags &amp; <a class="code" href="../../d3/d8/udfprocs_8h.html#a5">FlagMask</a> ) {
00917                 GuidCount ++;
00918             } 
00919         }
00920 
00921         <span class="comment">//</span>
00922         <span class="comment">// If there are any Guids to audit,</span>
00923         <span class="comment">//  copy them into a locally allocated buffer.</span>
00924         <span class="comment">//</span>
00925 
00926         <span class="keywordflow">if</span> ( GuidCount &gt; 0 ) {
00927 
00928             AdtObjectTypeBuffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, GuidCount * <span class="keyword">sizeof</span>(SE_ADT_OBJECT_TYPE), 'pAeS' );
00929 
00930             <span class="comment">//</span>
00931             <span class="comment">// If the buffer can be allocated,</span>
00932             <span class="comment">//  fill it in.</span>
00933             <span class="comment">// If not,</span>
00934             <span class="comment">//  generate a truncated audit.</span>
00935             <span class="comment">//</span>
00936 
00937             <span class="keywordflow">if</span> ( AdtObjectTypeBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00938 
00939                 <span class="comment">//</span>
00940                 <span class="comment">// Copy the GUIDs and optional access masks to the buffer.</span>
00941                 <span class="comment">//</span>
00942 
00943                 GuidCount = 0;
00944                 <span class="keywordflow">for</span> ( i=0; i&lt;ObjectTypeListLength; i++ ) {
00945 
00946                     <span class="keywordflow">if</span> ( ( i &gt; 0 ) &amp;&amp; !( ObjectTypeList[i].Flags &amp; <a class="code" href="../../d3/d8/udfprocs_8h.html#a5">FlagMask</a> ) ) {
00947 
00948                         <span class="keywordflow">continue</span>;
00949                         
00950                     } <span class="keywordflow">else</span> {
00951                     
00952                         AdtObjectTypeBuffer[GuidCount].ObjectType = ObjectTypeList[i].ObjectType;
00953                         AdtObjectTypeBuffer[GuidCount].Level      = ObjectTypeList[i].Level;
00954 
00955                         <span class="keywordflow">if</span> ( i == 0 ) {
00956                             <span class="comment">//</span>
00957                             <span class="comment">// Always copy the GUID representing the object itself.</span>
00958                             <span class="comment">//  Mark it as a such to avoid including it in the audit.</span>
00959                             <span class="comment">//</span>
00960                             AdtObjectTypeBuffer[GuidCount].Flags      = SE_ADT_OBJECT_ONLY;
00961                             AdtObjectTypeBuffer[GuidCount].AccessMask = 0;
00962 
00963                         } <span class="keywordflow">else</span>  {
00964 
00965                             AdtObjectTypeBuffer[GuidCount].Flags = 0;
00966                             <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(GrantedAccessArray) &amp;&amp; AccessGranted ) {
00967 
00968                                 AdtObjectTypeBuffer[GuidCount].AccessMask = GrantedAccessArray[i];
00969                             }
00970                         }
00971                         GuidCount ++;
00972                     }
00973                 }
00974 
00975                 <span class="comment">//</span>
00976                 <span class="comment">// Store the Object Types.</span>
00977                 <span class="comment">//</span>
00978 
00979                 <a class="code" href="../../d7/d6/sepaudit_8c.html#a8">SepSetParmTypeObjectTypes</a>( AuditParameters, AuditParameters.ParameterCount, AdtObjectTypeBuffer, GuidCount, ObjectTypeIndex );
00980                 AuditParameters.ParameterCount ++;
00981                 AuditParameters.AuditId = SE_AUDITID_OPEN_HANDLE_OBJECT_TYPE;
00982             }
00983         }
00984 
00985     }
00986 
00987 
00988 
00989     <span class="comment">//</span>
00990     <span class="comment">// Audit it.</span>
00991     <span class="comment">//</span>
00992     <a class="code" href="../../d0/d5/adtlog_8c.html#a0">SepAdtLogAuditRecord</a>( &amp;AuditParameters );
00993 
00994     <span class="keywordflow">if</span> ( AdtObjectTypeBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00995         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( AdtObjectTypeBuffer );
00996     }
00997 
00998     <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00999 }
01000 
01001 
01002 BOOLEAN
<a name="l01003"></a><a class="code" href="../../d7/d6/sepaudit_8c.html#a12">01003</a> <a class="code" href="../../d7/d6/sepaudit_8c.html#a12">SepAdtOpenObjectForDeleteAuditAlarm</a> (
01004     IN PUNICODE_STRING CapturedSubsystemName,
01005     IN PVOID *HandleId OPTIONAL,
01006     IN PUNICODE_STRING CapturedObjectTypeName,
01007     IN PVOID Object OPTIONAL,
01008     IN PUNICODE_STRING CapturedObjectName OPTIONAL,
01009     IN PTOKEN ClientToken OPTIONAL,
01010     IN PTOKEN PrimaryToken,
01011     IN ACCESS_MASK DesiredAccess,
01012     IN ACCESS_MASK GrantedAccess,
01013     IN PLUID OperationId,
01014     IN PPRIVILEGE_SET CapturedPrivileges OPTIONAL,
01015     IN BOOLEAN ObjectCreated,
01016     IN BOOLEAN AccessGranted,
01017     IN BOOLEAN GenerateAudit,
01018     IN BOOLEAN GenerateAlarm,
01019     IN HANDLE ProcessID
01020     )
01021 
01022 <span class="comment">/*++</span>
01023 <span class="comment"></span>
01024 <span class="comment">    Routine Description:</span>
01025 <span class="comment"></span>
01026 <span class="comment">    Implements SeOpenObjectForDeleteAuditAlarm after parameters have been</span>
01027 <span class="comment">    captured.</span>
01028 <span class="comment"></span>
01029 <span class="comment">    This routine is used to generate audit and alarm messages when an</span>
01030 <span class="comment">    attempt is made to access an existing protected subsystem object or</span>
01031 <span class="comment">    create a new one.  This routine may result in several messages being</span>
01032 <span class="comment">    generated and sent to Port objects.  This may result in a significant</span>
01033 <span class="comment">    latency before returning.  Design of routines that must call this</span>
01034 <span class="comment">    routine must take this potential latency into account.  This may have</span>
01035 <span class="comment">    an impact on the approach taken for data structure mutex locking, for</span>
01036 <span class="comment">    example.  This API requires the caller have SeTcbPrivilege privilege.</span>
01037 <span class="comment">    The test for this privilege is always against the primary token of the</span>
01038 <span class="comment">    calling process, not the impersonation token of the thread.</span>
01039 <span class="comment"></span>
01040 <span class="comment"></span>
01041 <span class="comment">    This routine will create an SE_ADT_PARAMETERS array organized as follows:</span>
01042 <span class="comment"></span>
01043 <span class="comment">    Parameter[0] - User Sid</span>
01044 <span class="comment"></span>
01045 <span class="comment">    Parameter[1] - Subsystem name (if available)</span>
01046 <span class="comment"></span>
01047 <span class="comment">    Parameter[2] - Server name (if available)</span>
01048 <span class="comment"></span>
01049 <span class="comment">    Parameter[3] - Object Type Name</span>
01050 <span class="comment"></span>
01051 <span class="comment">    Parameter[4] - Object Name</span>
01052 <span class="comment"></span>
01053 <span class="comment">    Parameter[5] - New handle ID</span>
01054 <span class="comment"></span>
01055 <span class="comment">    Parameter[6] - Subject's process id</span>
01056 <span class="comment"></span>
01057 <span class="comment">    Parameter[7] - Subject's primary authentication ID</span>
01058 <span class="comment"></span>
01059 <span class="comment">    Parameter[8] - Subject's client authentication ID</span>
01060 <span class="comment"></span>
01061 <span class="comment">    Parameter[9] - DesiredAccess mask</span>
01062 <span class="comment"></span>
01063 <span class="comment">    Parameter[10] - Privileges used for open</span>
01064 <span class="comment"></span>
01065 <span class="comment">Arguments:</span>
01066 <span class="comment"></span>
01067 <span class="comment">    CapturedSubsystemName - Supplies a name string identifying the</span>
01068 <span class="comment">        subsystem calling the routine.</span>
01069 <span class="comment"></span>
01070 <span class="comment">    HandleId - A unique value representing the client's handle to the</span>
01071 <span class="comment">        object.  If the access attempt was not successful (AccessGranted is</span>
01072 <span class="comment">        FALSE), then this parameter is ignored.</span>
01073 <span class="comment"></span>
01074 <span class="comment">    CapturedObjectTypeName - Supplies the name of the type of object being</span>
01075 <span class="comment">        accessed.</span>
01076 <span class="comment"></span>
01077 <span class="comment">    CapturedObjectName - Supplies the name of the object the client</span>
01078 <span class="comment">        accessed or attempted to access.</span>
01079 <span class="comment"></span>
01080 <span class="comment">    CapturedSecurityDescriptor - A pointer to the security descriptor of</span>
01081 <span class="comment">        the object being accessed.</span>
01082 <span class="comment"></span>
01083 <span class="comment">    ClientToken - Optionally provides a pointer to the client token</span>
01084 <span class="comment">        (only if the caller is currently impersonating)</span>
01085 <span class="comment"></span>
01086 <span class="comment">    PrimaryToken - Provides a pointer to the caller's primary token.</span>
01087 <span class="comment"></span>
01088 <span class="comment">    DesiredAccess - The desired access mask.  This mask must have been</span>
01089 <span class="comment">        previously mapped to contain no generic accesses.</span>
01090 <span class="comment"></span>
01091 <span class="comment">    GrantedAccess - The mask of accesses that were actually granted.</span>
01092 <span class="comment"></span>
01093 <span class="comment">    CapturedPrivileges - Optionally points to a set of privileges that were</span>
01094 <span class="comment">        required for the access attempt.  Those privileges that were held</span>
01095 <span class="comment">        by the subject are marked using the UsedForAccess flag of the</span>
01096 <span class="comment">        attributes associated with each privilege.</span>
01097 <span class="comment"></span>
01098 <span class="comment">    ObjectCreation - A boolean flag indicating whether the access will</span>
01099 <span class="comment">        result in a new object being created if granted.  A value of TRUE</span>
01100 <span class="comment">        indicates an object will be created, FALSE indicates an existing</span>
01101 <span class="comment">        object will be opened.</span>
01102 <span class="comment"></span>
01103 <span class="comment">    AccessGranted - Indicates whether the requested access was granted or</span>
01104 <span class="comment">        not.  A value of TRUE indicates the access was granted.  A value of</span>
01105 <span class="comment">        FALSE indicates the access was not granted.</span>
01106 <span class="comment"></span>
01107 <span class="comment">    GenerateOnClose - Points to a boolean that is set by the audit</span>
01108 <span class="comment">        generation routine and must be passed to NtCloseObjectAuditAlarm()</span>
01109 <span class="comment">        when the object handle is closed.</span>
01110 <span class="comment"></span>
01111 <span class="comment">    GenerateAudit - Indicates if we should generate an audit for this operation.</span>
01112 <span class="comment"></span>
01113 <span class="comment">    GenerateAlarm - Indicates if we should generate an alarm for this operation.</span>
01114 <span class="comment"></span>
01115 <span class="comment">Return Value:</span>
01116 <span class="comment"></span>
01117 <span class="comment">    Returns TRUE if audit is generated, FALSE otherwise.</span>
01118 <span class="comment"></span>
01119 <span class="comment">--*/</span>
01120 
01121 {
01122     SE_ADT_PARAMETER_ARRAY AuditParameters;
01123     ULONG ObjectTypeIndex;
01124     PSID CapturedUserSid;
01125     LUID PrimaryAuthenticationId;
01126     LUID ClientAuthenticationId;
01127 
01128     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01129 
01130     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> )) {
01131 
01132         CapturedUserSid = <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> );
01133         ClientAuthenticationId =  <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> );
01134 
01135     } <span class="keywordflow">else</span> {
01136 
01137         CapturedUserSid = <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a> );
01138     }
01139 
01140     PrimaryAuthenticationId = <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a> );
01141 
01142     <span class="comment">//</span>
01143     <span class="comment">// A completely zero'd entry will be interpreted</span>
01144     <span class="comment">// as a "null string" or not supplied parameter.</span>
01145     <span class="comment">//</span>
01146     <span class="comment">// Initializing the entire array up front will allow</span>
01147     <span class="comment">// us to avoid filling in each not supplied entry.</span>
01148     <span class="comment">//</span>
01149 
01150     RtlZeroMemory (
01151        (PVOID) &amp;AuditParameters,
01152        <span class="keyword">sizeof</span>( AuditParameters )
01153        );
01154 
01155     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SeAdtParmTypeNone == 0 );
01156 
01157     AuditParameters.CategoryId = SE_CATEGID_OBJECT_ACCESS;
01158     AuditParameters.AuditId = SE_AUDITID_OPEN_OBJECT_FOR_DELETE;
01159     AuditParameters.ParameterCount = 0;
01160 
01161     <span class="keywordflow">if</span> ( AccessGranted ) {
01162 
01163         AuditParameters.Type = EVENTLOG_AUDIT_SUCCESS;
01164 
01165     } <span class="keywordflow">else</span> {
01166 
01167         AuditParameters.Type = EVENTLOG_AUDIT_FAILURE;
01168     }
01169 
01170     <span class="comment">//</span>
01171     <span class="comment">//  Parameter[0] - User Sid</span>
01172     <span class="comment">//</span>
01173 
01174     <a class="code" href="../../d7/d6/sepaudit_8c.html#a0">SepSetParmTypeSid</a>( AuditParameters, AuditParameters.ParameterCount, CapturedUserSid );
01175 
01176     AuditParameters.ParameterCount++;
01177 
01178     <span class="comment">//</span>
01179     <span class="comment">//  Parameter[1] - Subsystem name (if available)</span>
01180     <span class="comment">//</span>
01181 
01182     <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, CapturedSubsystemName );
01183 
01184     AuditParameters.ParameterCount++;
01185 
01186     <span class="comment">//</span>
01187     <span class="comment">//  Parameter[2] - Object Server (if available)</span>
01188     <span class="comment">//</span>
01189 
01190     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( CapturedSubsystemName )) {
01191 
01192         <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, CapturedSubsystemName );
01193     }
01194 
01195     AuditParameters.ParameterCount++;
01196 
01197     <span class="comment">//</span>
01198     <span class="comment">//  Parameter[3] - Object Type Name</span>
01199     <span class="comment">//</span>
01200 
01201     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( CapturedObjectTypeName )) {
01202 
01203         <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, CapturedObjectTypeName );
01204         ObjectTypeIndex = AuditParameters.ParameterCount;
01205     }
01206 
01207     AuditParameters.ParameterCount++;
01208 
01209     <span class="comment">//</span>
01210     <span class="comment">//  Parameter[4] - Object Name</span>
01211     <span class="comment">//</span>
01212 
01213     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( CapturedObjectName )) {
01214 
01215         <a class="code" href="../../d7/d6/sepaudit_8c.html#a2">SepSetParmTypeFileSpec</a>( AuditParameters, AuditParameters.ParameterCount, CapturedObjectName );
01216     }
01217 
01218     AuditParameters.ParameterCount++;
01219 
01220     <span class="comment">//</span>
01221     <span class="comment">//  Parameter[5] - New handle ID</span>
01222     <span class="comment">//</span>
01223 
01224     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( HandleId )) {
01225 
01226         <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)*HandleId) );
01227     }
01228 
01229     AuditParameters.ParameterCount++;
01230 
01231     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( OperationId )) {
01232 
01233         <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (*OperationId).HighPart );
01234 
01235         AuditParameters.ParameterCount++;
01236 
01237         <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (*OperationId).LowPart );
01238 
01239         AuditParameters.ParameterCount++;
01240 
01241     } <span class="keywordflow">else</span> {
01242 
01243         AuditParameters.ParameterCount += 2;
01244     }
01245 
01246     <span class="comment">//</span>
01247     <span class="comment">//  Parameter[6] - Subject's process id</span>
01248     <span class="comment">//</span>
01249 
01250     <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)ProcessID) );
01251 
01252     AuditParameters.ParameterCount++;
01253 
01254     <span class="comment">//</span>
01255     <span class="comment">//  Parameter[7] - Subject's primary authentication ID</span>
01256     <span class="comment">//</span>
01257 
01258     <a class="code" href="../../d7/d6/sepaudit_8c.html#a5">SepSetParmTypeLogonId</a>( AuditParameters, AuditParameters.ParameterCount, PrimaryAuthenticationId );
01259 
01260     AuditParameters.ParameterCount++;
01261 
01262     <span class="comment">//</span>
01263     <span class="comment">//  Parameter[8] - Subject's client authentication ID</span>
01264     <span class="comment">//</span>
01265 
01266     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> )) {
01267 
01268         <a class="code" href="../../d7/d6/sepaudit_8c.html#a5">SepSetParmTypeLogonId</a>( AuditParameters, AuditParameters.ParameterCount, ClientAuthenticationId );
01269 
01270     } <span class="keywordflow">else</span> {
01271 
01272         <a class="code" href="../../d7/d6/sepaudit_8c.html#a4">SepSetParmTypeNoLogon</a>( AuditParameters, AuditParameters.ParameterCount  );
01273     }
01274 
01275     AuditParameters.ParameterCount++;
01276 
01277     <span class="comment">//</span>
01278     <span class="comment">//  Parameter[9] - DesiredAccess mask</span>
01279     <span class="comment">//</span>
01280 
01281     <span class="keywordflow">if</span> ( AccessGranted ) {
01282 
01283         <a class="code" href="../../d7/d6/sepaudit_8c.html#a6">SepSetParmTypeAccessMask</a>( AuditParameters, AuditParameters.ParameterCount, GrantedAccess, ObjectTypeIndex );
01284 
01285     } <span class="keywordflow">else</span> {
01286 
01287         <a class="code" href="../../d7/d6/sepaudit_8c.html#a6">SepSetParmTypeAccessMask</a>( AuditParameters, AuditParameters.ParameterCount, DesiredAccess, ObjectTypeIndex );
01288     }
01289 
01290     AuditParameters.ParameterCount++;
01291 
01292     <span class="comment">//</span>
01293     <span class="comment">//    Parameter[10] - Privileges used for open</span>
01294     <span class="comment">//</span>
01295 
01296     <span class="keywordflow">if</span> ( (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (CapturedPrivileges-&gt;PrivilegeCount &gt; 0) ) {
01297 
01298         <a class="code" href="../../d7/d6/sepaudit_8c.html#a7">SepSetParmTypePrivileges</a>( AuditParameters, AuditParameters.ParameterCount, CapturedPrivileges );
01299     }
01300 
01301     AuditParameters.ParameterCount++;
01302 
01303     <a class="code" href="../../d0/d5/adtlog_8c.html#a0">SepAdtLogAuditRecord</a>( &amp;AuditParameters );
01304 
01305     <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01306 }
01307 
01308 
01309 
01310 
01311 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01312"></a><a class="code" href="../../d7/d6/sepaudit_8c.html#a13">01312</a> <a class="code" href="../../d7/d6/sepaudit_8c.html#a13">SepAdtCloseObjectAuditAlarm</a> (
01313     IN PUNICODE_STRING CapturedSubsystemName,
01314     IN PVOID HandleId,
01315     IN PVOID Object,
01316     IN PSID UserSid,
01317     IN LUID AuthenticationId
01318     )
01319 
01320 <span class="comment">/*++</span>
01321 <span class="comment"></span>
01322 <span class="comment">Routine Description:</span>
01323 <span class="comment"></span>
01324 <span class="comment">    This routine implements NtCloseObjectAuditAlarm after parameters have</span>
01325 <span class="comment">    been captured.</span>
01326 <span class="comment"></span>
01327 <span class="comment">    This routine is used to generate audit and alarm messages when a handle</span>
01328 <span class="comment">    to a protected subsystem object is deleted.  This routine may result in</span>
01329 <span class="comment">    several messages being generated and sent to Port objects.  This may</span>
01330 <span class="comment">    result in a significant latency before returning.  Design of routines</span>
01331 <span class="comment">    that must call this routine must take this potential latency into</span>
01332 <span class="comment">    account.  This may have an impact on the approach taken for data</span>
01333 <span class="comment">    structure mutex locking, for example.</span>
01334 <span class="comment"></span>
01335 <span class="comment">    This API requires the caller have SeTcbPrivilege privilege.  The test</span>
01336 <span class="comment">    for this privilege is always against the primary token of the calling</span>
01337 <span class="comment">    process, allowing the caller to be impersonating a client during the</span>
01338 <span class="comment">    call with no ill effects.  It is assumed that this privilege has been</span>
01339 <span class="comment">    tested at a higher level.</span>
01340 <span class="comment"></span>
01341 <span class="comment">    This routine will create an SE_ADT_PARAMETERS array organized as follows:</span>
01342 <span class="comment"></span>
01343 <span class="comment">    Parameter[0] - User Sid</span>
01344 <span class="comment"></span>
01345 <span class="comment">    Parameter[1] - Subsystem name (if available)</span>
01346 <span class="comment"></span>
01347 <span class="comment">    Parameter[2] - New handle ID</span>
01348 <span class="comment"></span>
01349 <span class="comment">    Parameter[3] - Subject's process id</span>
01350 <span class="comment"></span>
01351 <span class="comment">Arguments:</span>
01352 <span class="comment"></span>
01353 <span class="comment">    CapturedSubsystemName - Supplies a name string identifying the</span>
01354 <span class="comment">        subsystem calling the routine.</span>
01355 <span class="comment"></span>
01356 <span class="comment">    HandleId - A unique value representing the client's handle to the</span>
01357 <span class="comment">        object.</span>
01358 <span class="comment"></span>
01359 <span class="comment">    Object - The address of the object being closed</span>
01360 <span class="comment"></span>
01361 <span class="comment">    UserSid - The Sid identifying the current caller.</span>
01362 <span class="comment"></span>
01363 <span class="comment"></span>
01364 <span class="comment"></span>
01365 <span class="comment">Return value:</span>
01366 <span class="comment"></span>
01367 <span class="comment">    None.</span>
01368 <span class="comment"></span>
01369 <span class="comment"></span>
01370 <span class="comment">--*/</span>
01371 
01372 {
01373 
01374     SE_ADT_PARAMETER_ARRAY AuditParameters;
01375     BOOLEAN AccessGranted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01376     HANDLE ProcessId;
01377 
01378     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01379 
01380     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d5/adtp_8h.html#a14">SepAuditOptions</a>.<a class="code" href="../../d4/d1/struct__SEP__AUDIT__OPTIONS.html#o0">DoNotAuditCloseObjectEvents</a> ) {
01381 
01382         <span class="keywordflow">return</span>;
01383     }
01384     
01385     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d5/adtp_8h.html#a1">SepAdtAuditThisEvent</a>( AuditCategoryObjectAccess, &amp;AccessGranted ) ) {
01386 
01387         <span class="comment">//</span>
01388         <span class="comment">// A completely zero'd entry will be interpreted</span>
01389         <span class="comment">// as a "null string" or not supplied parameter.</span>
01390         <span class="comment">//</span>
01391         <span class="comment">// Initializing the entire array up front will allow</span>
01392         <span class="comment">// us to avoid filling in each not supplied entry.</span>
01393         <span class="comment">//</span>
01394 
01395         RtlZeroMemory (
01396            (PVOID) &amp;AuditParameters,
01397            <span class="keyword">sizeof</span>( AuditParameters )
01398            );
01399 
01400         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SeAdtParmTypeNone == 0 );
01401 
01402         AuditParameters.CategoryId = SE_CATEGID_OBJECT_ACCESS;
01403         AuditParameters.AuditId = SE_AUDITID_CLOSE_HANDLE;
01404         AuditParameters.ParameterCount = 0;
01405         AuditParameters.Type = EVENTLOG_AUDIT_SUCCESS;
01406 
01407 
01408         <span class="comment">//</span>
01409         <span class="comment">//  Parameter[0] - User Sid</span>
01410         <span class="comment">//</span>
01411 
01412         <a class="code" href="../../d7/d6/sepaudit_8c.html#a0">SepSetParmTypeSid</a>( AuditParameters, AuditParameters.ParameterCount, UserSid );
01413 
01414         AuditParameters.ParameterCount++;
01415 
01416 
01417         <span class="comment">//</span>
01418         <span class="comment">//  Parameter[1] - Subsystem name (if available)</span>
01419         <span class="comment">//</span>
01420 
01421         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( CapturedSubsystemName )) {
01422 
01423             <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, CapturedSubsystemName );
01424         }
01425 
01426         AuditParameters.ParameterCount++;
01427 
01428         <span class="comment">//</span>
01429         <span class="comment">//  Parameter[2] - Subsystem name (if available)</span>
01430         <span class="comment">//</span>
01431 
01432         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( CapturedSubsystemName )) {
01433 
01434             <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, CapturedSubsystemName );
01435         }
01436 
01437         AuditParameters.ParameterCount++;
01438 
01439         <span class="comment">//</span>
01440         <span class="comment">//    Parameter[3] - New handle ID</span>
01441         <span class="comment">//</span>
01442 
01443         <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)HandleId) );
01444 
01445         AuditParameters.ParameterCount++;
01446 
01447         <span class="comment">//</span>
01448         <span class="comment">//    Parameter[4] - Subject's process id</span>
01449         <span class="comment">//</span>
01450 
01451         ProcessId =  <a class="code" href="../../d1/d9/ps_8h.html#a25">PsProcessAuditId</a>( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() );
01452 
01453         <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)ProcessId) );
01454 
01455         AuditParameters.ParameterCount++;
01456 
01457         <a class="code" href="../../d0/d5/adtlog_8c.html#a0">SepAdtLogAuditRecord</a>( &amp;AuditParameters );
01458 
01459     }
01460 }
01461 
01462 
01463 
01464 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01465"></a><a class="code" href="../../d7/d6/sepaudit_8c.html#a14">01465</a> <a class="code" href="../../d7/d6/sepaudit_8c.html#a14">SepAdtDeleteObjectAuditAlarm</a> (
01466     IN PUNICODE_STRING CapturedSubsystemName,
01467     IN PVOID HandleId,
01468     IN PVOID Object,
01469     IN PSID UserSid,
01470     IN LUID AuthenticationId
01471     )
01472 
01473 <span class="comment">/*++</span>
01474 <span class="comment"></span>
01475 <span class="comment">Routine Description:</span>
01476 <span class="comment"></span>
01477 <span class="comment">    This routine implements NtDeleteObjectAuditAlarm after parameters have</span>
01478 <span class="comment">    been captured.</span>
01479 <span class="comment"></span>
01480 <span class="comment">    This routine is used to generate audit and alarm messages when an object</span>
01481 <span class="comment">    in a protected subsystem object is deleted.  This routine may result in</span>
01482 <span class="comment">    several messages being generated and sent to Port objects.  This may</span>
01483 <span class="comment">    result in a significant latency before returning.  Design of routines</span>
01484 <span class="comment">    that must call this routine must take this potential latency into</span>
01485 <span class="comment">    account.  This may have an impact on the approach taken for data</span>
01486 <span class="comment">    structure mutex locking, for example.</span>
01487 <span class="comment"></span>
01488 <span class="comment">    This API requires the caller have SeTcbPrivilege privilege.  The test</span>
01489 <span class="comment">    for this privilege is always against the primary token of the calling</span>
01490 <span class="comment">    process, allowing the caller to be impersonating a client during the</span>
01491 <span class="comment">    call with no ill effects.  It is assumed that this privilege has been</span>
01492 <span class="comment">    tested at a higher level.</span>
01493 <span class="comment"></span>
01494 <span class="comment">    This routine will create an SE_ADT_PARAMETERS array organized as follows:</span>
01495 <span class="comment"></span>
01496 <span class="comment">    Parameter[0] - User Sid</span>
01497 <span class="comment"></span>
01498 <span class="comment">    Parameter[1] - Subsystem name (if available)</span>
01499 <span class="comment"></span>
01500 <span class="comment">    Parameter[2] - Handle ID</span>
01501 <span class="comment"></span>
01502 <span class="comment">    Parameter[3] - Subject's process id</span>
01503 <span class="comment"></span>
01504 <span class="comment">Arguments:</span>
01505 <span class="comment"></span>
01506 <span class="comment">    CapturedSubsystemName - Supplies a name string identifying the</span>
01507 <span class="comment">        subsystem calling the routine.</span>
01508 <span class="comment"></span>
01509 <span class="comment">    HandleId - A unique value representing the client's handle to the</span>
01510 <span class="comment">        object.</span>
01511 <span class="comment"></span>
01512 <span class="comment">    Object - The address of the object being closed</span>
01513 <span class="comment"></span>
01514 <span class="comment">    UserSid - The Sid identifying the current caller.</span>
01515 <span class="comment"></span>
01516 <span class="comment"></span>
01517 <span class="comment"></span>
01518 <span class="comment">Return value:</span>
01519 <span class="comment"></span>
01520 <span class="comment">    None.</span>
01521 <span class="comment"></span>
01522 <span class="comment"></span>
01523 <span class="comment">--*/</span>
01524 
01525 {
01526 
01527     SE_ADT_PARAMETER_ARRAY AuditParameters;
01528     BOOLEAN AccessGranted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01529     HANDLE ProcessId;
01530 
01531     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01532 
01533     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d5/adtp_8h.html#a1">SepAdtAuditThisEvent</a>( AuditCategoryObjectAccess, &amp;AccessGranted ) ) {
01534 
01535         <span class="comment">//</span>
01536         <span class="comment">// A completely zero'd entry will be interpreted</span>
01537         <span class="comment">// as a "null string" or not supplied parameter.</span>
01538         <span class="comment">//</span>
01539         <span class="comment">// Initializing the entire array up front will allow</span>
01540         <span class="comment">// us to avoid filling in each not supplied entry.</span>
01541         <span class="comment">//</span>
01542 
01543         RtlZeroMemory (
01544            (PVOID) &amp;AuditParameters,
01545            <span class="keyword">sizeof</span>( AuditParameters )
01546            );
01547 
01548         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SeAdtParmTypeNone == 0 );
01549 
01550         AuditParameters.CategoryId = SE_CATEGID_OBJECT_ACCESS;
01551         AuditParameters.AuditId = SE_AUDITID_DELETE_OBJECT;
01552         AuditParameters.ParameterCount = 0;
01553         AuditParameters.Type = EVENTLOG_AUDIT_SUCCESS;
01554 
01555 
01556         <span class="comment">//</span>
01557         <span class="comment">//  Parameter[0] - User Sid</span>
01558         <span class="comment">//</span>
01559 
01560         <a class="code" href="../../d7/d6/sepaudit_8c.html#a0">SepSetParmTypeSid</a>( AuditParameters, AuditParameters.ParameterCount, UserSid );
01561 
01562         AuditParameters.ParameterCount++;
01563 
01564 
01565         <span class="comment">//</span>
01566         <span class="comment">//  Parameter[1] - Subsystem name (if available)</span>
01567         <span class="comment">//</span>
01568 
01569         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( CapturedSubsystemName )) {
01570 
01571             <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, CapturedSubsystemName );
01572         }
01573 
01574         AuditParameters.ParameterCount++;
01575 
01576         <span class="comment">//</span>
01577         <span class="comment">//  Parameter[2] - Subsystem name (if available)</span>
01578         <span class="comment">//</span>
01579 
01580         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( CapturedSubsystemName )) {
01581 
01582             <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, CapturedSubsystemName );
01583         }
01584 
01585         AuditParameters.ParameterCount++;
01586 
01587         <span class="comment">//</span>
01588         <span class="comment">//    Parameter[3] - New handle ID</span>
01589         <span class="comment">//</span>
01590 
01591         <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)HandleId) );
01592 
01593         AuditParameters.ParameterCount++;
01594 
01595         <span class="comment">//</span>
01596         <span class="comment">//    Parameter[4] - Subject's process id</span>
01597         <span class="comment">//</span>
01598 
01599         ProcessId =  <a class="code" href="../../d1/d9/ps_8h.html#a25">PsProcessAuditId</a>( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() );
01600 
01601         <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)ProcessId) );
01602 
01603         AuditParameters.ParameterCount++;
01604 
01605         <a class="code" href="../../d0/d5/adtlog_8c.html#a0">SepAdtLogAuditRecord</a>( &amp;AuditParameters );
01606 
01607     }
01608 }
01609 
01610 
01611 
01612 <span class="comment">//</span>
01613 <span class="comment">//VOID</span>
01614 <span class="comment">//SepAdtTraverseAuditAlarm(</span>
01615 <span class="comment">//    IN PLUID OperationId,</span>
01616 <span class="comment">//    IN PVOID DirectoryObject,</span>
01617 <span class="comment">//    IN PSID UserSid,</span>
01618 <span class="comment">//    IN LUID AuthenticationId,</span>
01619 <span class="comment">//    IN ACCESS_MASK DesiredAccess,</span>
01620 <span class="comment">//    IN PPRIVILEGE_SET Privileges OPTIONAL,</span>
01621 <span class="comment">//    IN BOOLEAN AccessGranted,</span>
01622 <span class="comment">//    IN BOOLEAN GenerateAudit,</span>
01623 <span class="comment">//    IN BOOLEAN GenerateAlarm</span>
01624 <span class="comment">//    )</span>
01626 <span class="comment"></span><span class="comment">//</span>
01627 <span class="comment">//Routine Description:</span>
01628 <span class="comment">//</span>
01629 <span class="comment">//    This routine constructs an audit record to record that a request</span>
01630 <span class="comment">//    to traverse a directory has occurred.</span>
01631 <span class="comment">//</span>
01632 <span class="comment">//Arguments:</span>
01633 <span class="comment">//</span>
01634 <span class="comment">//    OperationID - LUID identifying the operation in progress</span>
01635 <span class="comment">//</span>
01636 <span class="comment">//    DirectoryObject - Pointer to the directory being traversed.</span>
01637 <span class="comment">//</span>
01638 <span class="comment">//    UserSid - Provides the User Sid for the caller.</span>
01639 <span class="comment">//</span>
01640 <span class="comment">//    DesiredAccess - Mask to indicate the traverse access for this object</span>
01641 <span class="comment">//        type.</span>
01642 <span class="comment">//</span>
01643 <span class="comment">//    Privileges - Optional parameter to indicate any privilges that the</span>
01644 <span class="comment">//        subject may have used to gain access to the object.</span>
01645 <span class="comment">//</span>
01646 <span class="comment">//    AccessGranted - Indicates if the access was granted or denied based on</span>
01647 <span class="comment">//        the access check or privilege check.</span>
01648 <span class="comment">//</span>
01649 <span class="comment">//    GenerateAudit - Indicates if we should generate an audit for this operation.</span>
01650 <span class="comment">//</span>
01651 <span class="comment">//    GenerateAlarm - Indicates if we should generate an alarm for this operation.</span>
01652 <span class="comment">//</span>
01653 <span class="comment">//Return Value:</span>
01654 <span class="comment">//</span>
01655 <span class="comment">//    None.</span>
01656 <span class="comment">//</span>
01657 <span class="comment">//--*/</span>
01658 <span class="comment">//{</span>
01659 <span class="comment">//    POLICY_AUDIT_TRAVERSE AuditTraverse;</span>
01660 <span class="comment">//</span>
01661 <span class="comment">//    UNREFERENCED_PARAMETER( GenerateAudit );</span>
01662 <span class="comment">//    UNREFERENCED_PARAMETER( GenerateAlarm );</span>
01663 <span class="comment">//    UNREFERENCED_PARAMETER( DirectoryObject );</span>
01664 <span class="comment">//    UNREFERENCED_PARAMETER( DesiredAccess );</span>
01665 <span class="comment">//</span>
01666 <span class="comment">//    //</span>
01667 <span class="comment">//    // BUGWARNING need a way to get the directory name from</span>
01668 <span class="comment">//    // the directory object</span>
01669 <span class="comment">//    //</span>
01670 <span class="comment">//</span>
01671 <span class="comment">//    AuditTraverse.AccessGranted = AccessGranted;</span>
01672 <span class="comment">//    AuditTraverse.DirectoryName = NULL;</span>
01673 <span class="comment">//    AuditTraverse.OperationId = *OperationId;</span>
01674 <span class="comment">//    AuditTraverse.PrivilegeSet = Privileges;</span>
01675 <span class="comment">//    AuditTraverse.UserSid = UserSid;</span>
01676 <span class="comment">//    AuditTraverse.AuthenticationId = AuthenticationId;</span>
01677 <span class="comment">//</span>
01679 <span class="comment"></span><span class="comment">//}</span>
01680 
01681 
01682 
01683 
01684 <span class="comment">//</span>
01685 <span class="comment">//VOID</span>
01686 <span class="comment">//SepAdtCreateObjectAuditAlarm(</span>
01687 <span class="comment">//    IN PLUID OperationID,</span>
01688 <span class="comment">//    IN PUNICODE_STRING DirectoryName,</span>
01689 <span class="comment">//    IN PUNICODE_STRING ComponentName,</span>
01690 <span class="comment">//    IN PSID UserSid,</span>
01691 <span class="comment">//    IN LUID AuthenticationId,</span>
01692 <span class="comment">//    IN ACCESS_MASK DesiredAccess,</span>
01693 <span class="comment">//    IN BOOLEAN AccessGranted,</span>
01694 <span class="comment">//    IN BOOLEAN GenerateAudit,</span>
01695 <span class="comment">//    IN BOOLEAN GenerateAlarm</span>
01696 <span class="comment">//    )</span>
01698 <span class="comment"></span><span class="comment">//</span>
01699 <span class="comment">//Routine Description:</span>
01700 <span class="comment">//</span>
01701 <span class="comment">//    description-of-function.</span>
01702 <span class="comment">//</span>
01703 <span class="comment">//Arguments:</span>
01704 <span class="comment">//</span>
01705 <span class="comment">//</span>
01706 <span class="comment">//    GenerateAudit - Indicates if we should generate an audit for this operation.</span>
01707 <span class="comment">//</span>
01708 <span class="comment">//    GenerateAlarm - Indicates if we should generate an alarm for this operation.</span>
01709 <span class="comment">//</span>
01710 <span class="comment">//Return Value:</span>
01711 <span class="comment">//</span>
01712 <span class="comment">//    return-value - Description of conditions needed to return value. - or -</span>
01713 <span class="comment">//    None.</span>
01714 <span class="comment">//</span>
01715 <span class="comment">//--*/</span>
01716 <span class="comment">//</span>
01717 <span class="comment">//{</span>
01718 <span class="comment">//    POLICY_AUDIT_CREATE_OBJECT AuditCreateObject;</span>
01719 <span class="comment">//</span>
01720 <span class="comment">//    UNREFERENCED_PARAMETER( GenerateAudit );</span>
01721 <span class="comment">//    UNREFERENCED_PARAMETER( GenerateAlarm );</span>
01722 <span class="comment">//</span>
01723 <span class="comment">//</span>
01724 <span class="comment">//    AuditCreateObject.AccessGranted = AccessGranted;</span>
01725 <span class="comment">//    AuditCreateObject.DesiredAccess = DesiredAccess;</span>
01726 <span class="comment">//    AuditCreateObject.DirectoryName = DirectoryName;</span>
01727 <span class="comment">//    AuditCreateObject.ComponentName = ComponentName;</span>
01728 <span class="comment">//    AuditCreateObject.OperationId = *OperationID;</span>
01729 <span class="comment">//    AuditCreateObject.UserSid = UserSid;</span>
01730 <span class="comment">//    AuditCreateObject.AuthenticationId = AuthenticationId;</span>
01731 <span class="comment">//</span>
01733 <span class="comment"></span><span class="comment">//}</span>
01734 
01735 
01736 
01737 <span class="comment">//</span>
01738 <span class="comment">//VOID</span>
01739 <span class="comment">//SepAdtImplicitObjectAuditAlarm(</span>
01740 <span class="comment">//    IN PLUID OperationId OPTIONAL,</span>
01741 <span class="comment">//    IN PVOID Object,</span>
01742 <span class="comment">//    IN PSID UserSid,</span>
01743 <span class="comment">//    IN ACCESS_MASK DesiredAccess,</span>
01744 <span class="comment">//    IN PPRIVILEGE_SET Privileges OPTIONAL,</span>
01745 <span class="comment">//    IN BOOLEAN AccessGranted,</span>
01746 <span class="comment">//    IN BOOLEAN GenerateAudit,</span>
01747 <span class="comment">//    IN BOOLEAN GenerateAlarm</span>
01748 <span class="comment">//    )</span>
01750 <span class="comment"></span><span class="comment">//</span>
01751 <span class="comment">//Routine Description:</span>
01752 <span class="comment">//</span>
01753 <span class="comment">//    description-of-function.</span>
01754 <span class="comment">//</span>
01755 <span class="comment">//Arguments:</span>
01756 <span class="comment">//</span>
01757 <span class="comment">//    GenerateAudit - Indicates if we should generate an audit for this operation.</span>
01758 <span class="comment">//</span>
01759 <span class="comment">//    GenerateAlarm - Indicates if we should generate an alarm for this operation.</span>
01760 <span class="comment">//</span>
01761 <span class="comment">//</span>
01762 <span class="comment">//Return Value:</span>
01763 <span class="comment">//</span>
01764 <span class="comment">//    None</span>
01765 <span class="comment">//</span>
01766 <span class="comment">//--*/</span>
01767 <span class="comment">//</span>
01768 <span class="comment">//{</span>
01769 <span class="comment">//    POLICY_AUDIT_IMPLICIT_ACCESS AuditImplicitAccess;</span>
01770 <span class="comment">//</span>
01771 <span class="comment">//    UNREFERENCED_PARAMETER( GenerateAudit );</span>
01772 <span class="comment">//    UNREFERENCED_PARAMETER( GenerateAlarm );</span>
01773 <span class="comment">//</span>
01774 <span class="comment">//</span>
01775 <span class="comment">//    //</span>
01776 <span class="comment">//    // BUGWARNING need a way to obtain the object type</span>
01777 <span class="comment">//    //</span>
01778 <span class="comment">//</span>
01779 <span class="comment">//    AuditImplicitAccess.AccessGranted = AccessGranted;</span>
01780 <span class="comment">//    AuditImplicitAccess.DesiredAccess = DesiredAccess;</span>
01781 <span class="comment">//    AuditImplicitAccess.ObjectTypeName = NULL;</span>
01782 <span class="comment">//    AuditImplicitAccess.OperationId = *OperationId;</span>
01783 <span class="comment">//    AuditImplicitAccess.PrivilegeSet = Privileges;</span>
01784 <span class="comment">//    AuditImplicitAccess.UserSid = UserSid;</span>
01785 <span class="comment">//</span>
01786 <span class="comment">//    SepAdtLogAuditRecord( AuditEventImplicitAccess, &amp;AuditImplicitAccess );</span>
01787 <span class="comment">//}</span>
01788 
01789 
01790 
01791 
01792 
01793 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01794"></a><a class="code" href="../../d7/d6/sepaudit_8c.html#a15">01794</a> <a class="code" href="../../d7/d6/sepaudit_8c.html#a15">SepAdtHandleAuditAlarm</a>(
01795     IN PUNICODE_STRING Source,
01796     IN LUID OperationId,
01797     IN HANDLE Handle,
01798     IN PSID UserSid
01799     )
01800 
01801 <span class="comment">/*++</span>
01802 <span class="comment"></span>
01803 <span class="comment">Routine Description:</span>
01804 <span class="comment"></span>
01805 <span class="comment">    Creates an audit record for the creation of an object handle.</span>
01806 <span class="comment"></span>
01807 <span class="comment">Arguments:</span>
01808 <span class="comment"></span>
01809 <span class="comment"></span>
01810 <span class="comment">Return Value:</span>
01811 <span class="comment"></span>
01812 <span class="comment">    None.</span>
01813 <span class="comment"></span>
01814 <span class="comment">--*/</span>
01815 
01816 {
01817     BOOLEAN AccessGranted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01818     SE_ADT_PARAMETER_ARRAY AuditParameters;
01819     HANDLE ProcessID;
01820 
01821     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01822 
01823     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d5/adtp_8h.html#a1">SepAdtAuditThisEvent</a>( AuditCategoryObjectAccess, &amp;AccessGranted )) {
01824 
01825         <span class="comment">//</span>
01826         <span class="comment">// A completely zero'd entry will be interpreted</span>
01827         <span class="comment">// as a "null string" or not supplied parameter.</span>
01828         <span class="comment">//</span>
01829         <span class="comment">// Initializing the entire array up front will allow</span>
01830         <span class="comment">// us to avoid filling in each not supplied entry.</span>
01831         <span class="comment">//</span>
01832 
01833         RtlZeroMemory (
01834            (PVOID) &amp;AuditParameters,
01835            <span class="keyword">sizeof</span>( AuditParameters )
01836            );
01837 
01838         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SeAdtParmTypeNone == 0 );
01839 
01840         AuditParameters.CategoryId = SE_CATEGID_OBJECT_ACCESS;
01841         AuditParameters.AuditId = SE_AUDITID_CREATE_HANDLE;
01842         AuditParameters.ParameterCount = 0;
01843         AuditParameters.Type = EVENTLOG_AUDIT_SUCCESS;
01844 
01845 
01846         <span class="comment">//</span>
01847         <span class="comment">//  Parameter[0] - User Sid</span>
01848         <span class="comment">//</span>
01849 
01850         <a class="code" href="../../d7/d6/sepaudit_8c.html#a0">SepSetParmTypeSid</a>( AuditParameters, AuditParameters.ParameterCount, UserSid );
01851 
01852         AuditParameters.ParameterCount++;
01853 
01854 
01855         <span class="comment">//</span>
01856         <span class="comment">//  Parameter[1] - Subsystem name (if available)</span>
01857         <span class="comment">//</span>
01858 
01859         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( Source )) {
01860 
01861             <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, Source );
01862         }
01863 
01864         AuditParameters.ParameterCount++;
01865 
01866         <span class="comment">//</span>
01867         <span class="comment">//    Parameter[2] - New handle ID</span>
01868         <span class="comment">//</span>
01869 
01870         <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>) );
01871 
01872         AuditParameters.ParameterCount++;
01873 
01874         <span class="comment">//</span>
01875         <span class="comment">//    Parameters 3,4 - Operation ID</span>
01876         <span class="comment">//</span>
01877 
01878 
01879         <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, OperationId.HighPart );
01880 
01881         AuditParameters.ParameterCount++;
01882 
01883         <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, OperationId.LowPart );
01884 
01885         AuditParameters.ParameterCount++;
01886 
01887 
01888         <span class="comment">//</span>
01889         <span class="comment">//    Parameter[5] - Subject's process id</span>
01890         <span class="comment">//</span>
01891 
01892         ProcessID =  <a class="code" href="../../d1/d9/ps_8h.html#a25">PsProcessAuditId</a>( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() );
01893 
01894         <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)ProcessID) );
01895 
01896         AuditParameters.ParameterCount++;
01897 
01898         <a class="code" href="../../d0/d5/adtlog_8c.html#a0">SepAdtLogAuditRecord</a>( &amp;AuditParameters );
01899 
01900     }
01901 }
01902 
01903 
01904 
01905 
01906 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01907"></a><a class="code" href="../../d7/d6/sepaudit_8c.html#a16">01907</a> <a class="code" href="../../d7/d6/sepaudit_8c.html#a16">SepAdtObjectReferenceAuditAlarm</a>(
01908     IN PLUID OperationId OPTIONAL,
01909     IN PVOID Object,
01910     IN <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext,
01911     IN ACCESS_MASK DesiredAccess,
01912     IN PPRIVILEGE_SET Privileges OPTIONAL,
01913     IN BOOLEAN AccessGranted,
01914     IN BOOLEAN GenerateAudit,
01915     IN BOOLEAN GenerateAlarm
01916     )
01917 
01918 <span class="comment">/*++</span>
01919 <span class="comment"></span>
01920 <span class="comment">Routine Description:</span>
01921 <span class="comment"></span>
01922 <span class="comment">    description-of-function.</span>
01923 <span class="comment"></span>
01924 <span class="comment">    This routine will create an SE_ADT_PARAMETERS array organized as follows:</span>
01925 <span class="comment"></span>
01926 <span class="comment">    Parameter[0] - User Sid</span>
01927 <span class="comment"></span>
01928 <span class="comment">    Parameter[1] - Subsystem name (if available)</span>
01929 <span class="comment"></span>
01930 <span class="comment">    Parameter[2] - Object Type Name</span>
01931 <span class="comment"></span>
01932 <span class="comment">    Parameter[3] - Object Name</span>
01933 <span class="comment"></span>
01934 <span class="comment">    Parameter[4] - Subject's process id</span>
01935 <span class="comment"></span>
01936 <span class="comment">    Parameter[5] - Subject's primary authentication ID</span>
01937 <span class="comment"></span>
01938 <span class="comment">    Parameter[6] - Subject's client authentication ID</span>
01939 <span class="comment"></span>
01940 <span class="comment">    Parameter[7] - DesiredAccess mask</span>
01941 <span class="comment"></span>
01942 <span class="comment"></span>
01943 <span class="comment">Arguments:</span>
01944 <span class="comment"></span>
01945 <span class="comment">    GenerateAudit - Indicates if we should generate an audit for this operation.</span>
01946 <span class="comment"></span>
01947 <span class="comment">    GenerateAlarm - Indicates if we should generate an alarm for this operation.</span>
01948 <span class="comment"></span>
01949 <span class="comment">Return Value:</span>
01950 <span class="comment"></span>
01951 <span class="comment">    return-value - Description of conditions needed to return value. - or -</span>
01952 <span class="comment">    None.</span>
01953 <span class="comment"></span>
01954 <span class="comment">--*/</span>
01955 
01956 {
01957     SE_ADT_PARAMETER_ARRAY AuditParameters;
01958     ULONG ObjectTypeIndex;
01959     POBJECT_NAME_INFORMATION ObjectNameInformation;
01960     PUNICODE_STRING ObjectTypeInformation;
01961     PSID UserSid;
01962     LUID PrimaryAuthenticationId;
01963     LUID ClientAuthenticationId;
01964 
01965     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)SubjectSecurityContext-&gt;ClientToken;
01966     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a> = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)SubjectSecurityContext-&gt;PrimaryToken;
01967 
01968     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01969 
01970 
01971     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> )) {
01972 
01973         UserSid = <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> );
01974         ClientAuthenticationId =  <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> );
01975 
01976     } <span class="keywordflow">else</span> {
01977 
01978         UserSid = <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a> );
01979     }
01980 
01981     PrimaryAuthenticationId = <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a> );
01982 
01983     <span class="comment">//</span>
01984     <span class="comment">// A completely zero'd entry will be interpreted</span>
01985     <span class="comment">// as a "null string" or not supplied parameter.</span>
01986     <span class="comment">//</span>
01987     <span class="comment">// Initializing the entire array up front will allow</span>
01988     <span class="comment">// us to avoid filling in each not supplied entry.</span>
01989     <span class="comment">//</span>
01990 
01991     RtlZeroMemory (
01992        (PVOID) &amp;AuditParameters,
01993        <span class="keyword">sizeof</span>( AuditParameters )
01994        );
01995 
01996     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SeAdtParmTypeNone == 0 );
01997 
01998     AuditParameters.CategoryId = SE_CATEGID_DETAILED_TRACKING;
01999     AuditParameters.AuditId = SE_AUDITID_INDIRECT_REFERENCE;
02000     AuditParameters.ParameterCount = 8;
02001 
02002     <span class="keywordflow">if</span> ( AccessGranted ) {
02003 
02004         AuditParameters.Type = EVENTLOG_AUDIT_SUCCESS;
02005 
02006     } <span class="keywordflow">else</span> {
02007 
02008         AuditParameters.Type = EVENTLOG_AUDIT_FAILURE;
02009     }
02010 
02011     <span class="comment">//</span>
02012     <span class="comment">// Obtain the object name and object type name from the</span>
02013     <span class="comment">// object.</span>
02014     <span class="comment">//</span>
02015 
02016     ObjectNameInformation = <a class="code" href="../../d7/d6/sepaudit_8c.html#a17">SepQueryNameString</a>( Object );
02017 
02018 
02019     ObjectTypeInformation = <a class="code" href="../../d7/d6/sepaudit_8c.html#a18">SepQueryTypeString</a>( Object );
02020 
02021 
02022 
02023 
02024     <span class="comment">//</span>
02025     <span class="comment">//  Parameter[0] - User Sid</span>
02026     <span class="comment">//</span>
02027 
02028     <a class="code" href="../../d7/d6/sepaudit_8c.html#a0">SepSetParmTypeSid</a>( AuditParameters, 0, UserSid );
02029 
02030 
02031     <span class="comment">//</span>
02032     <span class="comment">//  Parameter[1] - Subsystem name (if available)</span>
02033     <span class="comment">//</span>
02034 
02035     <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, 1, &amp;<a class="code" href="../../d0/d5/se_8h.html#a107">SeSubsystemName</a> );
02036 
02037 
02038     <span class="comment">//</span>
02039     <span class="comment">//  Parameter[2] - Object Type Name</span>
02040     <span class="comment">//</span>
02041 
02042     <span class="keywordflow">if</span> ( ObjectTypeInformation != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02043 
02044         <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, 2, ObjectTypeInformation );
02045         ObjectTypeIndex = 2;
02046     }
02047 
02048 
02049 
02050     <span class="comment">//</span>
02051     <span class="comment">//  Parameter[3] - Object Name</span>
02052     <span class="comment">//</span>
02053 
02054     <span class="keywordflow">if</span> ( ObjectNameInformation != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02055 
02056         <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, 3, &amp;ObjectNameInformation-&gt;Name );
02057     }
02058 
02059 
02060 
02061 
02062     <span class="comment">//</span>
02063     <span class="comment">//  Parameter[4] - Subject's process id</span>
02064     <span class="comment">//</span>
02065 
02066     <span class="comment">//</span>
02067     <span class="comment">// BUGWARNING: The process Id is currently unavailable.</span>
02068     <span class="comment">//</span>
02069 
02070     <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, 4, (ULONG)((ULONG_PTR)(SubjectSecurityContext-&gt;ProcessAuditId)) );
02071 
02072 
02073 
02074 
02075     <span class="comment">//</span>
02076     <span class="comment">//  Parameter[5] - Subject's primary authentication ID</span>
02077     <span class="comment">//</span>
02078 
02079 
02080     <a class="code" href="../../d7/d6/sepaudit_8c.html#a5">SepSetParmTypeLogonId</a>( AuditParameters, 5, PrimaryAuthenticationId );
02081 
02082 
02083 
02084 
02085     <span class="comment">//</span>
02086     <span class="comment">//  Parameter[6] - Subject's client authentication ID</span>
02087     <span class="comment">//</span>
02088 
02089     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> )) {
02090 
02091         <a class="code" href="../../d7/d6/sepaudit_8c.html#a5">SepSetParmTypeLogonId</a>( AuditParameters, 6, ClientAuthenticationId );
02092 
02093     } <span class="keywordflow">else</span> {
02094 
02095         <a class="code" href="../../d7/d6/sepaudit_8c.html#a4">SepSetParmTypeNoLogon</a>( AuditParameters, 6 );
02096 
02097     }
02098 
02099     <span class="comment">//</span>
02100     <span class="comment">//  Parameter[7] - DesiredAccess mask</span>
02101     <span class="comment">//</span>
02102 
02103 
02104     <a class="code" href="../../d7/d6/sepaudit_8c.html#a6">SepSetParmTypeAccessMask</a>( AuditParameters, 7, DesiredAccess, ObjectTypeIndex );
02105 
02106 
02107     <a class="code" href="../../d0/d5/adtlog_8c.html#a0">SepAdtLogAuditRecord</a>( &amp;AuditParameters );
02108 
02109     <span class="keywordflow">if</span> ( ObjectNameInformation != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02110         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( ObjectNameInformation );
02111     }
02112 
02113     <span class="keywordflow">if</span> ( ObjectTypeInformation != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02114         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( ObjectTypeInformation );
02115     }
02116 
02117 }
02118 
02119 
02120 <span class="comment">//VOID</span>
02121 <span class="comment">//SepAdtCreateInstanceAuditAlarm(</span>
02122 <span class="comment">//    IN PLUID OperationID,</span>
02123 <span class="comment">//    IN PVOID Object,</span>
02124 <span class="comment">//    IN PSID UserSid,</span>
02125 <span class="comment">//    IN LUID AuthenticationId,</span>
02126 <span class="comment">//    IN ACCESS_MASK DesiredAccess,</span>
02127 <span class="comment">//    IN PPRIVILEGE_SET Privileges OPTIONAL,</span>
02128 <span class="comment">//    IN BOOLEAN AccessGranted,</span>
02129 <span class="comment">//    IN BOOLEAN GenerateAudit,</span>
02130 <span class="comment">//    IN BOOLEAN GenerateAlarm</span>
02131 <span class="comment">//    )</span>
02132 <span class="comment">//</span>
02134 <span class="comment"></span><span class="comment">//</span>
02135 <span class="comment">//Routine Description:</span>
02136 <span class="comment">//</span>
02137 <span class="comment">//    description-of-function.</span>
02138 <span class="comment">//</span>
02139 <span class="comment">//Arguments:</span>
02140 <span class="comment">//</span>
02141 <span class="comment">//    GenerateAudit - Indicates if we should generate an audit for this operation.</span>
02142 <span class="comment">//</span>
02143 <span class="comment">//    GenerateAlarm - Indicates if we should generate an alarm for this operation.</span>
02144 <span class="comment">//</span>
02145 <span class="comment">//</span>
02146 <span class="comment">//Return Value:</span>
02147 <span class="comment">//</span>
02148 <span class="comment">//    return-value - Description of conditions needed to return value. - or -</span>
02149 <span class="comment">//    None.</span>
02150 <span class="comment">//</span>
02151 <span class="comment">//--*/</span>
02152 <span class="comment">//</span>
02153 <span class="comment">//{</span>
02154 <span class="comment">//    POLICY_AUDIT_CREATE_INSTANCE AuditCreateInstance;</span>
02155 <span class="comment">//</span>
02156 <span class="comment">//    UNREFERENCED_PARAMETER( GenerateAudit );</span>
02157 <span class="comment">//    UNREFERENCED_PARAMETER( GenerateAlarm );</span>
02158 <span class="comment">//</span>
02159 <span class="comment">//    //</span>
02160 <span class="comment">//    // BUGWARNING Must obtain the object type object from the passed</span>
02161 <span class="comment">//    // object</span>
02162 <span class="comment">//    //</span>
02163 <span class="comment">//</span>
02164 <span class="comment">//    AuditCreateInstance.AccessGranted = AccessGranted;</span>
02165 <span class="comment">//    AuditCreateInstance.ObjectTypeName = NULL;</span>
02166 <span class="comment">//    AuditCreateInstance.OperationId = *OperationID;</span>
02167 <span class="comment">//    AuditCreateInstance.UserSid = UserSid;</span>
02168 <span class="comment">//    AuditCreateInstance.AuthenticationId = AuthenticationId;</span>
02169 <span class="comment">//</span>
02171 <span class="comment"></span><span class="comment">//</span>
02172 <span class="comment">//    return;</span>
02173 <span class="comment">//}</span>
02174 
02175 
02176 
02177 <span class="comment">//</span>
02178 <span class="comment">//VOID</span>
02179 <span class="comment">//SeShutdownAuditAlarm(</span>
02180 <span class="comment">//    VOID</span>
02181 <span class="comment">//    )</span>
02182 <span class="comment">//</span>
02184 <span class="comment"></span><span class="comment">//</span>
02185 <span class="comment">//Routine Description:</span>
02186 <span class="comment">//</span>
02187 <span class="comment">//    This routine will can a shutdown audit record to be generated.</span>
02188 <span class="comment">//</span>
02189 <span class="comment">//    There must be a forced delay after this routine is called to ensure</span>
02190 <span class="comment">//    that the generated audit record actually makes it to disk.</span>
02191 <span class="comment">//</span>
02192 <span class="comment">//Arguments:</span>
02193 <span class="comment">//</span>
02194 <span class="comment">//    None</span>
02195 <span class="comment">//</span>
02196 <span class="comment">//Return Value:</span>
02197 <span class="comment">//</span>
02198 <span class="comment">//    None.</span>
02199 <span class="comment">//</span>
02200 <span class="comment">//--*/</span>
02201 <span class="comment">//</span>
02202 <span class="comment">//{</span>
02203 <span class="comment">//    SECURITY_SUBJECT_CONTEXT SubjectSecurityContext;</span>
02204 <span class="comment">//    SE_ADT_PARAMETER_ARRAY AuditParameters;</span>
02205 <span class="comment">//    UNICODE_STRING SubsystemName;</span>
02206 <span class="comment">//    PSID UserSid;</span>
02207 <span class="comment">//</span>
02208 <span class="comment">//    //</span>
02209 <span class="comment">//    // Make sure we're auditing shutdown events.</span>
02210 <span class="comment">//    //</span>
02211 <span class="comment">//</span>
02212 <span class="comment">//    if ( SepAdtAuditThisEvent( AuditEventShutdown, NULL )) {</span>
02213 <span class="comment">//</span>
02214 <span class="comment">//        SeCaptureSubjectContext( &amp;SubjectSecurityContext );</span>
02215 <span class="comment">//</span>
02216 <span class="comment">//</span>
02217 <span class="comment">//        //</span>
02218 <span class="comment">//        // A completely zero'd entry will be interpreted</span>
02219 <span class="comment">//        // as a "null string" or not supplied parameter.</span>
02220 <span class="comment">//        //</span>
02221 <span class="comment">//        // Initializing the entire array up front will allow</span>
02222 <span class="comment">//        // us to avoid filling in each not supplied entry.</span>
02223 <span class="comment">//        //</span>
02224 <span class="comment">//</span>
02225 <span class="comment">//        RtlZeroMemory (</span>
02226 <span class="comment">//           (PVOID) &amp;AuditParameters,</span>
02227 <span class="comment">//           sizeof( AuditParameters )</span>
02228 <span class="comment">//           );</span>
02229 <span class="comment">//</span>
02230 <span class="comment">//        ASSERT( SeAdtParmTypeNone == 0 );</span>
02231 <span class="comment">//</span>
02232 <span class="comment">//        AuditParameters.CategoryId = SE_CATEGID_SYSTEM;</span>
02233 <span class="comment">//        AuditParameters.AuditId = SE_AUDITID_SYSTEM_SHUTDOWN;</span>
02234 <span class="comment">//        AuditParameters.ParameterCount = 2;</span>
02235 <span class="comment">//</span>
02236 <span class="comment">//        UserSid = SepTokenUserSid(EffectiveToken( &amp;SubjectSecurityContext ));</span>
02237 <span class="comment">//</span>
02238 <span class="comment">//</span>
02239 <span class="comment">//        RtlInitUnicodeString( &amp;SubsystemName, L"Security" );</span>
02240 <span class="comment">//</span>
02241 <span class="comment">//</span>
02242 <span class="comment">//        //</span>
02243 <span class="comment">//        //  Parameter[0] - User Sid</span>
02244 <span class="comment">//        //</span>
02245 <span class="comment">//</span>
02246 <span class="comment">//        SepSetParmTypeSid( AuditParameters, 0, UserSid );</span>
02247 <span class="comment">//</span>
02248 <span class="comment">//</span>
02249 <span class="comment">//        //</span>
02250 <span class="comment">//        //  Parameter[1] - Subsystem name (if available)</span>
02251 <span class="comment">//        //</span>
02252 <span class="comment">//</span>
02253 <span class="comment">//        SepSetParmTypeString( AuditParameters, 1, &amp;SubsystemName );</span>
02254 <span class="comment">//</span>
02255 <span class="comment">//</span>
02256 <span class="comment">//        SepAdtLogAuditRecord( &amp;AuditParameters );</span>
02257 <span class="comment">//</span>
02258 <span class="comment">//        SeReleaseSubjectContext( &amp;SubjectSecurityContext );</span>
02259 <span class="comment">//</span>
02260 <span class="comment">//    }</span>
02261 <span class="comment">//</span>
02262 <span class="comment">//}</span>
02263 
02264 
02265 
02266 
02267 
02268 <span class="comment">// </span>
02269 <span class="comment">// BOOLEAN</span>
02270 <span class="comment">// SepAdtAuditThisEvent(</span>
02271 <span class="comment">//     IN POLICY_AUDIT_EVENT_TYPE AuditType,</span>
02272 <span class="comment">//     IN PBOOLEAN AccessGranted OPTIONAL</span>
02273 <span class="comment">//     )</span>
02274 <span class="comment">//</span>
02275 <span class="comment">// /*++</span>
02276 <span class="comment">//</span>
02277 <span class="comment">// Routine Description:</span>
02278 <span class="comment">//</span>
02279 <span class="comment">//     This routine will return whether or not to generate an audit log</span>
02280 <span class="comment">//     record for the passed event type.</span>
02281 <span class="comment">//</span>
02282 <span class="comment">// Arguments:</span>
02283 <span class="comment">//</span>
02284 <span class="comment">//     AuditType - The type of event to be audited.</span>
02285 <span class="comment">//</span>
02286 <span class="comment">//     AccessGranted - An optional flag indicating whether or not</span>
02287 <span class="comment">//         the operation was successful.  This does not all apply to all</span>
02288 <span class="comment">//         types of audit events.</span>
02289 <span class="comment">//</span>
02290 <span class="comment">//         Note that a pointer to the flag is passed rather than the</span>
02291 <span class="comment">//         flag itself, so that we may tell whether or not the argument</span>
02292 <span class="comment">//         is present.</span>
02293 <span class="comment">//</span>
02294 <span class="comment">// Return Value:</span>
02295 <span class="comment">//</span>
02296 <span class="comment">//     Flag indicating whether or not to proceed with the audit.</span>
02297 <span class="comment">//</span>
02298 <span class="comment">// --*/</span>
02299 <span class="comment">//</span>
02300 <span class="comment">// {</span>
02301 <span class="comment">//     PAGED_CODE();</span>
02302 <span class="comment">//</span>
02303 <span class="comment">//     if (SepAdtAuditingEnabled) {</span>
02304 <span class="comment">//</span>
02305 <span class="comment">//         if ( ARGUMENT_PRESENT( AccessGranted )) {</span>
02306 <span class="comment">//</span>
02307 <span class="comment">//             if ((SeAuditingState[AuditType].AuditOnSuccess &amp;&amp; *AccessGranted) ||</span>
02308 <span class="comment">//                  SeAuditingState[AuditType].AuditOnFailure &amp;&amp; !(*AccessGranted)) {</span>
02309 <span class="comment">//</span>
02310 <span class="comment">//                 return( TRUE );</span>
02311 <span class="comment">//</span>
02312 <span class="comment">//             }</span>
02313 <span class="comment">//         }</span>
02314 <span class="comment">//     }</span>
02315 <span class="comment">//</span>
02316 <span class="comment">//     return( FALSE );</span>
02317 <span class="comment">// }</span>
02318 
02319 
02320 
02321 
02322 
02323 POBJECT_NAME_INFORMATION
<a name="l02324"></a><a class="code" href="../../d7/d6/sepaudit_8c.html#a17">02324</a> <a class="code" href="../../d7/d6/sepaudit_8c.html#a17">SepQueryNameString</a>(
02325     IN PVOID Object
02326     )
02327 
02328 <span class="comment">/*++</span>
02329 <span class="comment"></span>
02330 <span class="comment">Routine Description:</span>
02331 <span class="comment"></span>
02332 <span class="comment">    Takes a pointer to an object and returns the name of the object.</span>
02333 <span class="comment"></span>
02334 <span class="comment">Arguments:</span>
02335 <span class="comment"></span>
02336 <span class="comment">    Object - a pointer to an object.</span>
02337 <span class="comment"></span>
02338 <span class="comment"></span>
02339 <span class="comment">Return Value:</span>
02340 <span class="comment"></span>
02341 <span class="comment">    A pointer to a buffer containing a POBJECT_NAME_INFORMATION</span>
02342 <span class="comment">    structure containing the name of the object.  The string is</span>
02343 <span class="comment">    allocated out of paged pool and should be freed by the caller.</span>
02344 <span class="comment"></span>
02345 <span class="comment">    NULL may also be returned.</span>
02346 <span class="comment"></span>
02347 <span class="comment"></span>
02348 <span class="comment">--*/</span>
02349 
02350 {
02351     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02352     ULONG ReturnLength = 0;
02353     POBJECT_NAME_INFORMATION ObjectNameInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02354     PUNICODE_STRING ObjectName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02355 
02356     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02357 
02358     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/obquery_8c.html#a7">ObQueryNameString</a>(
02359                  Object,
02360                  ObjectNameInfo,
02361                  0,
02362                  &amp;ReturnLength
02363                  );
02364 
02365     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INFO_LENGTH_MISMATCH ) {
02366 
02367         ObjectNameInfo = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, ReturnLength, 'nOeS' );
02368 
02369         <span class="keywordflow">if</span> ( ObjectNameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02370 
02371             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/obquery_8c.html#a7">ObQueryNameString</a>(
02372                         Object,
02373                         ObjectNameInfo,
02374                         ReturnLength,
02375                         &amp;ReturnLength
02376                         );
02377 
02378             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
02379 
02380                 <span class="keywordflow">if</span> (ObjectNameInfo-&gt;Name.Length != 0) {
02381 
02382                     <span class="keywordflow">return</span>( ObjectNameInfo );
02383 
02384                 } <span class="keywordflow">else</span> {
02385 
02386                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( ObjectNameInfo );
02387                     <span class="keywordflow">return</span>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
02388                 }
02389             }
02390         }
02391     }
02392 
02393     <span class="keywordflow">return</span>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
02394 }
02395 
02396 
02397 
02398 
02399 PUNICODE_STRING
<a name="l02400"></a><a class="code" href="../../d7/d6/sepaudit_8c.html#a18">02400</a> <a class="code" href="../../d7/d6/sepaudit_8c.html#a18">SepQueryTypeString</a>(
02401     IN PVOID Object
02402     )
02403 <span class="comment">/*++</span>
02404 <span class="comment"></span>
02405 <span class="comment">Routine Description:</span>
02406 <span class="comment"></span>
02407 <span class="comment">    Takes a pointer to an object and returns the type of the object.</span>
02408 <span class="comment"></span>
02409 <span class="comment">Arguments:</span>
02410 <span class="comment"></span>
02411 <span class="comment">    Object - a pointer to an object.</span>
02412 <span class="comment"></span>
02413 <span class="comment"></span>
02414 <span class="comment">Return Value:</span>
02415 <span class="comment"></span>
02416 <span class="comment">    A pointer to a UNICODE_STRING that contains the name of the object</span>
02417 <span class="comment">    type.  The string is allocated out of paged pool and should be freed</span>
02418 <span class="comment">    by the caller.</span>
02419 <span class="comment"></span>
02420 <span class="comment">    NULL may also be returned.</span>
02421 <span class="comment"></span>
02422 <span class="comment"></span>
02423 <span class="comment">--*/</span>
02424 
02425 {
02426 
02427     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02428     PUNICODE_STRING TypeName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02429     ULONG ReturnLength;
02430 
02431     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02432 
02433     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/obquery_8c.html#a8">ObQueryTypeName</a>(
02434                  Object,
02435                  TypeName,
02436                  0,
02437                  &amp;ReturnLength
02438                  );
02439 
02440     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INFO_LENGTH_MISMATCH ) {
02441 
02442         TypeName = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, ReturnLength, 'nTeS' );
02443 
02444         <span class="keywordflow">if</span> ( TypeName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02445 
02446             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/obquery_8c.html#a8">ObQueryTypeName</a>(
02447                         Object,
02448                         TypeName,
02449                         ReturnLength,
02450                         &amp;ReturnLength
02451                         );
02452 
02453             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
02454 
02455                 <span class="keywordflow">return</span>( TypeName );
02456             }
02457         }
02458     }
02459 
02460     <span class="keywordflow">return</span>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
02461 }
02462 
02463 
02464 
02465 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02466"></a><a class="code" href="../../d7/d6/sepaudit_8c.html#a19">02466</a> <a class="code" href="../../d7/d6/sepaudit_8c.html#a19">SeAuditProcessCreation</a>(
02467     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
02468     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Parent,
02469     PUNICODE_STRING ImageFileName
02470     )
02471 <span class="comment">/*++</span>
02472 <span class="comment"></span>
02473 <span class="comment">Routine Description:</span>
02474 <span class="comment"></span>
02475 <span class="comment">    Audits the creation of a process.  It is the caller's responsibility</span>
02476 <span class="comment">    to determine if process auditing is in progress.</span>
02477 <span class="comment"></span>
02478 <span class="comment"></span>
02479 <span class="comment">Arguments:</span>
02480 <span class="comment"></span>
02481 <span class="comment">    Process - Points to the new process object.</span>
02482 <span class="comment"></span>
02483 <span class="comment">    Parent - Points to the creator (parent) process object.</span>
02484 <span class="comment">    </span>
02485 <span class="comment">    ImageFileName - the name of the image</span>
02486 <span class="comment"></span>
02487 <span class="comment">Return Value:</span>
02488 <span class="comment"></span>
02489 <span class="comment">    None.</span>
02490 <span class="comment"></span>
02491 <span class="comment">--*/</span>
02492 
02493 {
02494     ANSI_STRING Ansi;
02495     LUID UserAuthenticationId;
02496     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02497     PSID UserSid;
02498     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext;
02499     SE_ADT_PARAMETER_ARRAY AuditParameters;
02500     
02501     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02502 
02503     <span class="keywordflow">if</span> ( ImageFileName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )
02504     {
02505         <span class="keywordflow">return</span> ;
02506     }
02507 
02508     <span class="comment">//</span>
02509     <span class="comment">// NtCreateProcess with no section will cause this to be NULL</span>
02510     <span class="comment">// fork() for posix will do this, or someone calling NtCreateProcess</span>
02511     <span class="comment">// directly.</span>
02512     <span class="comment">//</span>
02513 
02514     <span class="keywordflow">if</span> ( ImageFileName-&gt;Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )
02515     {
02516         <span class="keywordflow">return</span>;
02517     }
02518 
02519     <a class="code" href="../../d0/d8/subject_8c.html#a0">SeCaptureSubjectContext</a>( &amp;SubjectSecurityContext );
02520 
02521     RtlZeroMemory (
02522        (PVOID) &amp;AuditParameters,
02523        <span class="keyword">sizeof</span>( AuditParameters )
02524        );
02525 
02526     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SeAdtParmTypeNone == 0 );
02527 
02528     AuditParameters.CategoryId = SE_CATEGID_DETAILED_TRACKING;
02529     AuditParameters.AuditId = SE_AUDITID_PROCESS_CREATED;
02530     AuditParameters.ParameterCount = 0;
02531     AuditParameters.Type = EVENTLOG_AUDIT_SUCCESS;
02532 
02533     <span class="comment">//</span>
02534     <span class="comment">// Use the primary token here, because that's what's going to show up</span>
02535     <span class="comment">// when the created process exits.</span>
02536     <span class="comment">//</span>
02537 
02538     UserSid = <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o2">PrimaryToken</a> );
02539 
02540     UserAuthenticationId = <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>( SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o2">PrimaryToken</a> );
02541 
02542     <span class="comment">//</span>
02543     <span class="comment">// Fill in the AuditParameters structure.</span>
02544     <span class="comment">//</span>
02545 
02546     <a class="code" href="../../d7/d6/sepaudit_8c.html#a0">SepSetParmTypeSid</a>( AuditParameters, AuditParameters.ParameterCount, UserSid );
02547     AuditParameters.ParameterCount++;
02548 
02549     <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, &amp;<a class="code" href="../../d0/d5/se_8h.html#a107">SeSubsystemName</a> );
02550     AuditParameters.ParameterCount++;
02551 
02552     <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)Process) );
02553     AuditParameters.ParameterCount++;
02554 
02555     <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, ImageFileName );
02556     AuditParameters.ParameterCount++;
02557 
02558     <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)Parent) );
02559     AuditParameters.ParameterCount++;
02560 
02561     <a class="code" href="../../d7/d6/sepaudit_8c.html#a5">SepSetParmTypeLogonId</a>( AuditParameters, AuditParameters.ParameterCount, UserAuthenticationId );
02562     AuditParameters.ParameterCount++;
02563 
02564     <a class="code" href="../../d0/d5/adtlog_8c.html#a0">SepAdtLogAuditRecord</a>( &amp;AuditParameters );
02565 
02566     <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a>( &amp;SubjectSecurityContext );
02567 
02568     <span class="keywordflow">return</span>;
02569 }
02570 
02571 
02572 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02573"></a><a class="code" href="../../d7/d6/sepaudit_8c.html#a20">02573</a> <a class="code" href="../../d7/d6/sepaudit_8c.html#a20">SeAuditHandleDuplication</a>(
02574     PVOID SourceHandle,
02575     PVOID NewHandle,
02576     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> SourceProcess,
02577     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess
02578     )
02579 
02580 <span class="comment">/*++</span>
02581 <span class="comment"></span>
02582 <span class="comment">Routine Description:</span>
02583 <span class="comment"></span>
02584 <span class="comment">    This routine generates a handle duplication audit.  It is up to the caller</span>
02585 <span class="comment">    to determine if this routine should be called or not.</span>
02586 <span class="comment"></span>
02587 <span class="comment">Arguments:</span>
02588 <span class="comment"></span>
02589 <span class="comment">    SourceHandle -  Original handle</span>
02590 <span class="comment"></span>
02591 <span class="comment">    NewHandle - New handle</span>
02592 <span class="comment"></span>
02593 <span class="comment">    SourceProcess - Process containing SourceHandle</span>
02594 <span class="comment"></span>
02595 <span class="comment">    TargetProcess - Process containing NewHandle</span>
02596 <span class="comment"></span>
02597 <span class="comment">Return Value:</span>
02598 <span class="comment"></span>
02599 <span class="comment">    None.</span>
02600 <span class="comment"></span>
02601 <span class="comment">--*/</span>
02602 
02603 {
02604     SE_ADT_PARAMETER_ARRAY AuditParameters;
02605     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext;
02606     PSID UserSid;
02607 
02608     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02609 
02610     <a class="code" href="../../d0/d8/subject_8c.html#a0">SeCaptureSubjectContext</a>( &amp;SubjectSecurityContext );
02611 
02612     UserSid = <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( &amp;SubjectSecurityContext ));
02613 
02614     RtlZeroMemory (
02615        (PVOID) &amp;AuditParameters,
02616        <span class="keyword">sizeof</span>( AuditParameters )
02617        );
02618 
02619 
02620     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SeAdtParmTypeNone == 0 );
02621 
02622     AuditParameters.CategoryId = SE_CATEGID_DETAILED_TRACKING;
02623     AuditParameters.AuditId = SE_AUDITID_DUPLICATE_HANDLE;
02624     AuditParameters.ParameterCount = 0;
02625     AuditParameters.Type = EVENTLOG_AUDIT_SUCCESS;
02626 
02627     <a class="code" href="../../d7/d6/sepaudit_8c.html#a0">SepSetParmTypeSid</a>( AuditParameters, AuditParameters.ParameterCount, UserSid );
02628     AuditParameters.ParameterCount++;
02629 
02630     <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, &amp;<a class="code" href="../../d0/d5/se_8h.html#a107">SeSubsystemName</a> );
02631     AuditParameters.ParameterCount++;
02632 
02633     <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)SourceHandle) );
02634     AuditParameters.ParameterCount++;
02635 
02636     <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)<a class="code" href="../../d1/d9/ps_8h.html#a25">PsProcessAuditId</a>( SourceProcess )));
02637     AuditParameters.ParameterCount++;
02638 
02639     <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)NewHandle) );
02640     AuditParameters.ParameterCount++;
02641 
02642     <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)<a class="code" href="../../d1/d9/ps_8h.html#a25">PsProcessAuditId</a>( TargetProcess )));
02643     AuditParameters.ParameterCount++;
02644 
02645 
02646     <a class="code" href="../../d0/d5/adtlog_8c.html#a0">SepAdtLogAuditRecord</a>( &amp;AuditParameters );
02647 
02648     <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a>( &amp;SubjectSecurityContext );
02649 }
02650 
02651 
02652 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02653"></a><a class="code" href="../../d7/d6/sepaudit_8c.html#a21">02653</a> <a class="code" href="../../d7/d6/sepaudit_8c.html#a21">SeAuditProcessExit</a>(
02654     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
02655     )
02656 <span class="comment">/*++</span>
02657 <span class="comment"></span>
02658 <span class="comment">Routine Description:</span>
02659 <span class="comment"></span>
02660 <span class="comment">    Audits the exit of a process.  The caller is responsible for</span>
02661 <span class="comment">    determining if this should be called.</span>
02662 <span class="comment"></span>
02663 <span class="comment">Arguments:</span>
02664 <span class="comment"></span>
02665 <span class="comment">    Process - Pointer to the process object that is exiting.</span>
02666 <span class="comment"></span>
02667 <span class="comment">Return Value:</span>
02668 <span class="comment"></span>
02669 <span class="comment">    None.</span>
02670 <span class="comment"></span>
02671 <span class="comment">--*/</span>
02672 
02673 {
02674     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
02675     SE_ADT_PARAMETER_ARRAY AuditParameters;
02676     PSID UserSid;
02677     LUID LogonId;
02678 
02679     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02680 
02681     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o21">Token</a>;
02682 
02683     UserSid = <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
02684     LogonId = <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
02685 
02686     RtlZeroMemory (
02687        (PVOID) &amp;AuditParameters,
02688        <span class="keyword">sizeof</span>( AuditParameters )
02689        );
02690 
02691 
02692     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SeAdtParmTypeNone == 0 );
02693 
02694     AuditParameters.CategoryId = SE_CATEGID_DETAILED_TRACKING;
02695     AuditParameters.AuditId = SE_AUDITID_PROCESS_EXIT;
02696     AuditParameters.ParameterCount = 0;
02697     AuditParameters.Type = EVENTLOG_AUDIT_SUCCESS;
02698 
02699     <a class="code" href="../../d7/d6/sepaudit_8c.html#a0">SepSetParmTypeSid</a>( AuditParameters, AuditParameters.ParameterCount, UserSid );
02700     AuditParameters.ParameterCount++;
02701 
02702     <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, &amp;<a class="code" href="../../d0/d5/se_8h.html#a107">SeSubsystemName</a> );
02703     AuditParameters.ParameterCount++;
02704 
02705     <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)<a class="code" href="../../d1/d9/ps_8h.html#a25">PsProcessAuditId</a>( Process )));
02706     AuditParameters.ParameterCount++;
02707 
02708     <a class="code" href="../../d7/d6/sepaudit_8c.html#a5">SepSetParmTypeLogonId</a>( AuditParameters, AuditParameters.ParameterCount, LogonId );
02709     AuditParameters.ParameterCount++;
02710 
02711     <a class="code" href="../../d0/d5/adtlog_8c.html#a0">SepAdtLogAuditRecord</a>( &amp;AuditParameters );
02712 }
02713 
02714 
02715 
02716 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02717"></a><a class="code" href="../../d7/d6/sepaudit_8c.html#a22">02717</a> <a class="code" href="../../d7/d6/sepaudit_8c.html#a22">SepAdtGenerateDiscardAudit</a>(
02718     VOID
02719     )
02720 
02721 <span class="comment">/*++</span>
02722 <span class="comment"></span>
02723 <span class="comment">Routine Description:</span>
02724 <span class="comment"></span>
02725 <span class="comment">    Generates an 'audits discarded' audit.</span>
02726 <span class="comment"></span>
02727 <span class="comment">Arguments:</span>
02728 <span class="comment"></span>
02729 <span class="comment">    none</span>
02730 <span class="comment"></span>
02731 <span class="comment">Return Value:</span>
02732 <span class="comment"></span>
02733 <span class="comment">    None.</span>
02734 <span class="comment"></span>
02735 <span class="comment">--*/</span>
02736 
02737 {
02738 
02739     SE_ADT_PARAMETER_ARRAY AuditParameters;
02740     PSID UserSid;
02741 
02742     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02743 
02744     UserSid = <a class="code" href="../../d0/d5/se_8h.html#a54">SeLocalSystemSid</a>;
02745 
02746     RtlZeroMemory (
02747        (PVOID) &amp;AuditParameters,
02748        <span class="keyword">sizeof</span>( AuditParameters )
02749        );
02750 
02751 
02752     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SeAdtParmTypeNone == 0 );
02753 
02754     AuditParameters.CategoryId = SE_CATEGID_SYSTEM;
02755     AuditParameters.AuditId = SE_AUDITID_AUDITS_DISCARDED;
02756     AuditParameters.ParameterCount = 0;
02757     AuditParameters.Type = EVENTLOG_AUDIT_SUCCESS;
02758 
02759     <a class="code" href="../../d7/d6/sepaudit_8c.html#a0">SepSetParmTypeSid</a>( AuditParameters, AuditParameters.ParameterCount, UserSid );
02760     AuditParameters.ParameterCount++;
02761 
02762     <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, &amp;<a class="code" href="../../d0/d5/se_8h.html#a107">SeSubsystemName</a> );
02763     AuditParameters.ParameterCount++;
02764 
02765     <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, <a class="code" href="../../d1/d5/adtp_8h.html#a9">SepAdtCountEventsDiscarded</a> );
02766     AuditParameters.ParameterCount++;
02767 
02768     <a class="code" href="../../d0/d5/adtlog_8c.html#a0">SepAdtLogAuditRecord</a>( &amp;AuditParameters );
02769 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:46 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
