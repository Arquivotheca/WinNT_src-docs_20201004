<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: trigger.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>trigger.c File Reference</h1><code>#include "<a class="el" href="../../d1/d9/ki_8h-source.html">ki.h</a>"</code><br>
<code>#include "alphaops.h"</code><br>

<p>
<a href="../../d9/d4/trigger_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d5/trigger_8c.html#a0">DBGPRINT</a>&nbsp;&nbsp;&nbsp;0 &amp;&amp; DbgPrint</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d5/trigger_8c.html#a1">NON_IEEE</a>(ExceptionRecord, Reason)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d5/trigger_8c.html#a2">TRIGGER_FLOATING_REGISTER_MASK_CLEAR</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d5/trigger_8c.html#a3">TRIGGER_INTEGER_REGISTER_MASK_SET</a>&nbsp;&nbsp;&nbsp;2</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d5/trigger_8c.html#a4">TRIGGER_NO_SOFTWARE_COMPLETION</a>&nbsp;&nbsp;&nbsp;3</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d5/trigger_8c.html#a5">TRIGGER_INVALID_INSTRUCTION_FOUND</a>&nbsp;&nbsp;&nbsp;4</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d5/trigger_8c.html#a6">TRIGGER_INSTRUCTION_FETCH_ERROR</a>&nbsp;&nbsp;&nbsp;5</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d5/trigger_8c.html#a7">TRIGGER_INSTRUCTION_NOT_FOUND</a>&nbsp;&nbsp;&nbsp;6</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d5/trigger_8c.html#a8">TRIGGER_SOURCE_IS_DESTINATION</a>&nbsp;&nbsp;&nbsp;7</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d5/trigger_8c.html#a9">TRIGGER_WRONG_INSTRUCTION</a>&nbsp;&nbsp;&nbsp;8</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d5/trigger_8c.html#a10">KiLocateTriggerPc</a> (IN OUT PEXCEPTION_RECORD ExceptionRecord, IN OUT PKTRAP_FRAME TrapFrame)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d5/trigger_8c.html#a11">KiFloatingException</a> (IN OUT PEXCEPTION_RECORD ExceptionRecord, IN OUT PKEXCEPTION_FRAME ExceptionFrame, IN OUT PKTRAP_FRAME TrapFrame, IN BOOLEAN ImpreciseTrap, IN OUT PULONG SoftFpcrCopy)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d5/trigger_8c.html#a12">KiSetFloatingStatus</a> (IN OUT PEXCEPTION_RECORD ExceptionRecord)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="trigger.c::DBGPRINT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DBGPRINT&nbsp;&nbsp;&nbsp;0 &amp;&amp; DbgPrint          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d4/trigger_8c-source.html#l00055">55</a> of file <a class="el" href="../../d9/d4/trigger_8c-source.html">trigger.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="trigger.c::NON_IEEE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define NON_IEEE          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ExceptionRecord,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Reason&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(ExceptionRecord)-&gt;NumberParameters = 4; \
    (ExceptionRecord)-&gt;ExceptionInformation[3] = (Reason);
</div></pre>
<p>
Definition at line <a class="el" href="../../d9/d4/trigger_8c-source.html#l00065">65</a> of file <a class="el" href="../../d9/d4/trigger_8c-source.html">trigger.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d4/trigger_8c-source.html#l00244">KiLocateTriggerPc()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="trigger.c::TRIGGER_FLOATING_REGISTER_MASK_CLEAR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define TRIGGER_FLOATING_REGISTER_MASK_CLEAR&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d4/trigger_8c-source.html#l00069">69</a> of file <a class="el" href="../../d9/d4/trigger_8c-source.html">trigger.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d4/trigger_8c-source.html#l00244">KiLocateTriggerPc()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="trigger.c::TRIGGER_INSTRUCTION_FETCH_ERROR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define TRIGGER_INSTRUCTION_FETCH_ERROR&nbsp;&nbsp;&nbsp;5          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d4/trigger_8c-source.html#l00073">73</a> of file <a class="el" href="../../d9/d4/trigger_8c-source.html">trigger.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d4/trigger_8c-source.html#l00244">KiLocateTriggerPc()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="trigger.c::TRIGGER_INSTRUCTION_NOT_FOUND" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define TRIGGER_INSTRUCTION_NOT_FOUND&nbsp;&nbsp;&nbsp;6          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d4/trigger_8c-source.html#l00074">74</a> of file <a class="el" href="../../d9/d4/trigger_8c-source.html">trigger.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d4/trigger_8c-source.html#l00244">KiLocateTriggerPc()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="trigger.c::TRIGGER_INTEGER_REGISTER_MASK_SET" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define TRIGGER_INTEGER_REGISTER_MASK_SET&nbsp;&nbsp;&nbsp;2          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d4/trigger_8c-source.html#l00070">70</a> of file <a class="el" href="../../d9/d4/trigger_8c-source.html">trigger.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d4/trigger_8c-source.html#l00244">KiLocateTriggerPc()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="trigger.c::TRIGGER_INVALID_INSTRUCTION_FOUND" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define TRIGGER_INVALID_INSTRUCTION_FOUND&nbsp;&nbsp;&nbsp;4          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d4/trigger_8c-source.html#l00072">72</a> of file <a class="el" href="../../d9/d4/trigger_8c-source.html">trigger.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d4/trigger_8c-source.html#l00244">KiLocateTriggerPc()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="trigger.c::TRIGGER_NO_SOFTWARE_COMPLETION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define TRIGGER_NO_SOFTWARE_COMPLETION&nbsp;&nbsp;&nbsp;3          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d4/trigger_8c-source.html#l00071">71</a> of file <a class="el" href="../../d9/d4/trigger_8c-source.html">trigger.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d4/trigger_8c-source.html#l00244">KiLocateTriggerPc()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="trigger.c::TRIGGER_SOURCE_IS_DESTINATION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define TRIGGER_SOURCE_IS_DESTINATION&nbsp;&nbsp;&nbsp;7          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d4/trigger_8c-source.html#l00075">75</a> of file <a class="el" href="../../d9/d4/trigger_8c-source.html">trigger.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d4/trigger_8c-source.html#l00244">KiLocateTriggerPc()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="trigger.c::TRIGGER_WRONG_INSTRUCTION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define TRIGGER_WRONG_INSTRUCTION&nbsp;&nbsp;&nbsp;8          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d4/trigger_8c-source.html#l00076">76</a> of file <a class="el" href="../../d9/d4/trigger_8c-source.html">trigger.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d4/trigger_8c-source.html#l00244">KiLocateTriggerPc()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a11" doxytag="trigger.c::KiFloatingException" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KiFloatingException           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PEXCEPTION_RECORD&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PKEXCEPTION_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ImpreciseTrap</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SoftFpcrCopy</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d4/trigger_8c-source.html#l00079">79</a> of file <a class="el" href="../../d9/d4/trigger_8c-source.html">trigger.c</a>.
<p>
References <a class="el" href="../../d7/d4/ioep_8h-source.html#l00067">DBGPRINT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d3/mips_2floatem_8c-source.html#l00251">KiEmulateFloating()</a>, <a class="el" href="../../d9/d4/trigger_8c-source.html#l00244">KiLocateTriggerPc()</a>, <a class="el" href="../../d9/d4/trigger_8c-source.html#l00535">KiSetFloatingStatus()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/alpha_2exceptn_8c-source.html#l00412">KiDispatchException()</a>.
<p>
<pre class="fragment"><div>00089                    :
00090 
00091     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to emulate a floating operation and convert <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00092     exception status to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> proper value. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a fault, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00093     faulting floating point instruction <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> emulated. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an
00094     imprecise trap, an attempt <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to locate and to emulate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original
00095     trapping floating point instruction.
00096 
00097 Arguments:
00098 
00099     ExceptionRecord - Supplies a pointer to an exception record.
00100 
00101     ExceptionFrame - Supplies a pointer to an exception frame.
00102 
00103     TrapFrame - Supplies a pointer to a trap frame.
00104 
00105     ImpreciseTrap - Supplies a <span class="keywordtype">boolean</span> value that specifies whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00106         exception <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an imprecise trap.
00107 
00108     SoftFpcrCopy - Supplies a pointer to a longword variable that receives
00109         a copy of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> software FPCR.
00110 
00111 Return Value:
00112 
00113     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> floating exception <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> successfully
00114     emulated. Otherwise, a value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00115 
00116 --*/
00117 
00118 {
00119 
00120     BOOLEAN <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00121     PSW_FPCR SoftwareFpcr;
00122     PTEB Teb;
00123 
00124     <span class="keywordflow">try</span> {
00125 
00126         <span class="comment">//</span>
00127         <span class="comment">// Obtain a copy of the software FPCR longword from the TEB.</span>
00128         <span class="comment">//</span>
00129 
00130         Teb = NtCurrentTeb();
00131         *SoftFpcrCopy = Teb-&gt;FpSoftwareStatusRegister;
00132         SoftwareFpcr = (PSW_FPCR)SoftFpcrCopy;
00133         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>(<span class="stringliteral">"KiFloatingException: SoftFpcr = %.8lx\n"</span>, *SoftFpcrCopy);
00134 
00135 <span class="preprocessor">#if DBG</span>
00136 <span class="preprocessor"></span>        <span class="comment">//</span>
00137         <span class="comment">// If the floating emulation inhibit flag is set, then bypass all</span>
00138         <span class="comment">// software emulation by the kernel and return FALSE to raise the</span>
00139         <span class="comment">// original PALcode exception.</span>
00140         <span class="comment">//</span>
00141         <span class="comment">// N.B. This is for user-mode development and testing and is not</span>
00142         <span class="comment">//      part of the API.</span>
00143         <span class="comment">//</span>
00144 
00145         <span class="keywordflow">if</span> (SoftwareFpcr-&gt;NoSoftwareEmulation != 0) {
00146             <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>(<span class="stringliteral">"KiFloatingException: NoSoftwareEmulation\n"</span>);
00147             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00148         }
00149 <span class="preprocessor">#endif</span>
00150 <span class="preprocessor"></span>
00151         <span class="comment">//</span>
00152         <span class="comment">// If the arithmetic exception is an imprecise trap, the address of</span>
00153         <span class="comment">// the trapping instruction is somewhere before the exception address.</span>
00154         <span class="comment">//</span>
00155         <span class="comment">// Otherwise the exception is a fault and the address of the faulting</span>
00156         <span class="comment">// instruction is the exception address.</span>
00157         <span class="comment">//</span>
00158 
00159         <span class="keywordflow">if</span> (ImpreciseTrap != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00160 
00161             <span class="comment">//</span>
00162             <span class="comment">// If the arithmetic trap ignore mode is enabled, then do not</span>
00163             <span class="comment">// spend time to locate or to emulate the trapping instruction,</span>
00164             <span class="comment">// leave unpredictable results in the destination register, do</span>
00165             <span class="comment">// not set correct IEEE sticky bits in the software FPCR, leave</span>
00166             <span class="comment">// the hardware FPCR sticky status bits as they are, and return</span>
00167             <span class="comment">// TRUE to continue execution. It is assumed that user code will</span>
00168             <span class="comment">// check the hardware FPCR exception status bits to determine if</span>
00169             <span class="comment">// the instruction succeeded or not (Insignia SoftPc feature).</span>
00170             <span class="comment">//</span>
00171 
00172             <span class="keywordflow">if</span> (SoftwareFpcr-&gt;ArithmeticTrapIgnore != 0) {
00173                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00174             }
00175 
00176             <span class="comment">//</span>
00177             <span class="comment">// Attempt to locate the trapping instruction. If the instruction</span>
00178             <span class="comment">// stream is such that this is not possible or was not intended,</span>
00179             <span class="comment">// then set an exception code that best reflects the exception</span>
00180             <span class="comment">// summary register bits and return FALSE to raise the exception.</span>
00181             <span class="comment">//</span>
00182             <span class="comment">// Otherwise emulate the trigger instruction in order to compute</span>
00183             <span class="comment">// the correct destination result value, the correct IEEE status</span>
00184             <span class="comment">// bits, and raise any enabled IEEE exceptions.</span>
00185             <span class="comment">//</span>
00186 
00187             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/trigger_8c.html#a10">KiLocateTriggerPc</a>(ExceptionRecord, TrapFrame) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00188                 <a class="code" href="../../d8/d5/trigger_8c.html#a12">KiSetFloatingStatus</a>(ExceptionRecord);
00189                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00190             }
00191             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d4/mips_2floatem_8c.html#a32">KiEmulateFloating</a>(ExceptionRecord,
00192                                        ExceptionFrame,
00193                                        TrapFrame,
00194                                        SoftwareFpcr);
00195 
00196         } <span class="keywordflow">else</span> {
00197 
00198             <span class="comment">//</span>
00199             <span class="comment">// Attempt to emulate the faulting instruction in order to perform</span>
00200             <span class="comment">// floating operations not supported by EV4, to compute the correct</span>
00201             <span class="comment">// destination result value, the correct IEEE status bits, and</span>
00202             <span class="comment">// raise any enabled IEEE exceptions.</span>
00203             <span class="comment">//</span>
00204 
00205             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d4/mips_2floatem_8c.html#a32">KiEmulateFloating</a>(ExceptionRecord,
00206                                        ExceptionFrame,
00207                                        TrapFrame,
00208                                        SoftwareFpcr);
00209 
00210             <span class="comment">//</span>
00211             <span class="comment">// If the emulation resulted in a floating point exception and</span>
00212             <span class="comment">// the arithmetic trap ignore mode is enabled, then set the return</span>
00213             <span class="comment">// value to TRUE to suppress the exception and continue execution.</span>
00214             <span class="comment">//</span>
00215 
00216             <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
00217                 (SoftwareFpcr-&gt;ArithmeticTrapIgnore != 0) &amp;&amp;
00218                 (ExceptionRecord-&gt;ExceptionCode != STATUS_ILLEGAL_INSTRUCTION)) {
00219                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00220             }
00221         }
00222 
00223         <span class="comment">//</span>
00224         <span class="comment">// Store the updated software FPCR longword in the TEB.</span>
00225         <span class="comment">//</span>
00226 
00227         Teb-&gt;FpSoftwareStatusRegister = *SoftFpcrCopy;
00228         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>(<span class="stringliteral">"KiFloatingException: SoftFpcr = %.8lx\n"</span>, *SoftFpcrCopy);
00229 
00230     } except (EXCEPTION_EXECUTE_HANDLER) {
00231 
00232         <span class="comment">//</span>
00233         <span class="comment">// An exception occurred accessing the TEB.</span>
00234         <span class="comment">//</span>
00235 
00236         ExceptionRecord-&gt;ExceptionCode = GetExceptionCode();
00237         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00238     }
00239 
00240     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00241 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="trigger.c::KiLocateTriggerPc" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KiLocateTriggerPc           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PEXCEPTION_RECORD&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d4/trigger_8c-source.html#l00244">244</a> of file <a class="el" href="../../d9/d4/trigger_8c-source.html">trigger.c</a>.
<p>
References <a class="el" href="../../d7/d4/ioep_8h-source.html#l00067">DBGPRINT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d9/d4/trigger_8c-source.html#l00065">NON_IEEE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01339">ProbeAndReadUlong</a>, <a class="el" href="../../d0/d2/festate_8h-source.html#l00021">PSR</a>, <a class="el" href="../../d9/d4/trigger_8c-source.html#l00069">TRIGGER_FLOATING_REGISTER_MASK_CLEAR</a>, <a class="el" href="../../d9/d4/trigger_8c-source.html#l00073">TRIGGER_INSTRUCTION_FETCH_ERROR</a>, <a class="el" href="../../d9/d4/trigger_8c-source.html#l00074">TRIGGER_INSTRUCTION_NOT_FOUND</a>, <a class="el" href="../../d9/d4/trigger_8c-source.html#l00070">TRIGGER_INTEGER_REGISTER_MASK_SET</a>, <a class="el" href="../../d9/d4/trigger_8c-source.html#l00072">TRIGGER_INVALID_INSTRUCTION_FOUND</a>, <a class="el" href="../../d9/d4/trigger_8c-source.html#l00071">TRIGGER_NO_SOFTWARE_COMPLETION</a>, <a class="el" href="../../d9/d4/trigger_8c-source.html#l00075">TRIGGER_SOURCE_IS_DESTINATION</a>, <a class="el" href="../../d9/d4/trigger_8c-source.html#l00076">TRIGGER_WRONG_INSTRUCTION</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d4/trigger_8c-source.html#l00079">KiFloatingException()</a>.
<p>
<pre class="fragment"><div>00251                    :
00252 
00253     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to <span class="keywordflow">try</span> to determine <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> precise location of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00254     instruction that caused an arithmetic exception. The instruction that
00255     caused <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap to occur <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> known as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trigger instruction. On entry,
00256     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trigger instruction <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> unknown and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception
00257     address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> continuation address. The continuation address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00258     address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> instruction that would have executed had <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap not
00259     occurred. The instructions following <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trigger instruction up to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00260     continuation address are known as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap shadow of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trigger
00261     instruction.
00262 
00263     Alpha AXP produces imprecise, asynchronous arithmetic exceptions. The
00264     exceptions are imprecise because <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception address when a trap <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00265     taken may be more than one instruction beyond <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00266     instruction that actually caused <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap to occur.
00267 
00268     The arithmetic exceptions are traps (rather than faults) because <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00269     exception address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trapping instruction
00270     itself, but <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next instruction to execute, which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00271     always (at least) one instruction beyond <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trapping
00272     instruction.
00273 
00274     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> possible <span class="keywordflow">for</span> multiple exceptions to occur and result in a single
00275     trap. This function <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> determines <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first trapping
00276     instruction.
00277 
00278     Unpredictable values may have been stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> destination <span class="keyword">register</span>
00279     of trapping instructions. Thus to insure that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trigger instruction
00280     can be located, and that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trigger instruction and any instructions
00281     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap shadow can be re-executed, certain restrictions are placed
00282     on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of instructions or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mix of operands in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap shadow.
00283 
00284     The code generation rules serve <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> to guarantee that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> instruction
00285     backup algorithm and subsequent re-execution can always be successful.
00286     Hence <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> restrictions on such constructs as branches, jumps, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00287     re-use of source or destination operands within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap shadow.
00288 
00289 Arguments:
00290 
00291     ExceptionRecord - Supplies a pointer to an exception record.
00292 
00293     TrapFrame - Supplies a pointer to a trap frame.
00294 
00295 Return Value:
00296 
00297     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trigger PC was precisely determined, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception address in
00298     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception record <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trigger PC, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> continuation address
00299     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap frame <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> updated, and a value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned. Otherwise
00300     no values are stored and a value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00301 
00302 --*/
00303 
00304 {
00305 
00306     PEXC_SUM ExceptionSummary;
00307     ULONG Fa;
00308     ULONG Fb;
00309     ULONG Fc;
00310     ULONG FloatRegisterTrashMask;
00311     ULONG FloatRegisterWriteMask;
00312     ALPHA_INSTRUCTION Instruction;
00313     ULONG IntegerRegisterWriteMask;
00314     ULONG Opcode;
00315     ULONG_PTR TrapShadowLowLimit;
00316     ULONG_PTR TriggerPc;
00317     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00318 
00319     <span class="comment">//</span>
00320     <span class="comment">// Obtain a copy of the float and integer register write mask registers</span>
00321     <span class="comment">// and the exception summary register from the exception record built by</span>
00322     <span class="comment">// PALcode.</span>
00323     <span class="comment">//</span>
00324 
00325     FloatRegisterWriteMask = (ULONG)ExceptionRecord-&gt;ExceptionInformation[0];
00326     IntegerRegisterWriteMask = (ULONG)ExceptionRecord-&gt;ExceptionInformation[1];
00327     ExceptionSummary = (PEXC_SUM)&amp;(ExceptionRecord-&gt;ExceptionInformation[2]);
00328     <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>(<span class="stringliteral">"KiLocateTriggerPc: WriteMask %.8lx.%.8lx, ExceptionSummary %.8lx\n"</span>,
00329              FloatRegisterWriteMask, IntegerRegisterWriteMask,
00330              *(PULONG)ExceptionSummary);
00331 
00332     <span class="comment">//</span>
00333     <span class="comment">// Capture previous mode from trap frame not current thread.</span>
00334     <span class="comment">//</span>
00335 
00336     PreviousMode = (<a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>)(((<a class="code" href="../../d9/d2/festate_8h.html#a2">PSR</a> *)(&amp;TrapFrame-&gt;Psr))-&gt;MODE);
00337 
00338     <span class="keywordflow">if</span> (FloatRegisterWriteMask == 0) {
00339 
00340         <span class="comment">//</span>
00341         <span class="comment">// It should not be possible to have a floating point exception without</span>
00342         <span class="comment">// at least one of the destination float register bits set. The trap</span>
00343         <span class="comment">// shadow is invalid.</span>
00344         <span class="comment">//</span>
00345 
00346         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>(<span class="stringliteral">"KiLocateTriggerPc: FloatRegisterWriteMask clear\n"</span>);
00347         <a class="code" href="../../d8/d5/trigger_8c.html#a1">NON_IEEE</a>(ExceptionRecord, TRIGGER_FLOATING_REGISTER_MASK_CLEAR);
00348         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00349     }
00350     <span class="keywordflow">if</span> (IntegerRegisterWriteMask != 0) {
00351 
00352         <span class="comment">//</span>
00353         <span class="comment">// It is not possible to precisely locate the trigger instruction</span>
00354         <span class="comment">// when the integer overflow bit is set. The trap shadow is invalid.</span>
00355         <span class="comment">//</span>
00356 
00357         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>(<span class="stringliteral">"KiLocateTriggerPc: IntegerRegisterMask set.\n"</span>);
00358         <a class="code" href="../../d8/d5/trigger_8c.html#a1">NON_IEEE</a>(ExceptionRecord, TRIGGER_INTEGER_REGISTER_MASK_SET);
00359         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00360     }
00361     <span class="keywordflow">if</span> (ExceptionSummary-&gt;SoftwareCompletion == 0) {
00362 
00363         <span class="comment">//</span>
00364         <span class="comment">// The exception summary software completion bit is the AND of the</span>
00365         <span class="comment">// /S bits of all trapping instructions in the trap shadow. Since</span>
00366         <span class="comment">// the software completion bit is not set, it can be assumed the</span>
00367         <span class="comment">// code that was executing does not want precise exceptions, or if</span>
00368         <span class="comment">// it does, the code does not comply with the Alpha AXP guidelines</span>
00369         <span class="comment">// for locating the trigger PC. The trap shadow is invalid.</span>
00370         <span class="comment">//</span>
00371 
00372         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>(<span class="stringliteral">"KiLocateTriggerPc: SoftwareCompletion clear\n"</span>);
00373         <a class="code" href="../../d8/d5/trigger_8c.html#a1">NON_IEEE</a>(ExceptionRecord, TRIGGER_NO_SOFTWARE_COMPLETION);
00374         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00375     }
00376 
00377     <span class="comment">//</span>
00378     <span class="comment">// Search for the trigger instruction starting with the instruction before</span>
00379     <span class="comment">// the continuation PC (the instruction pointed to by Fir either did not</span>
00380     <span class="comment">// complete or did not even start). Limit the search to the arbitrary</span>
00381     <span class="comment">// limit of N instructions back from the current PC to prevent unbounded</span>
00382     <span class="comment">// searches. The search is complete when all trapping destination register</span>
00383     <span class="comment">// bits in the float write mask register have been accounted for.</span>
00384     <span class="comment">//</span>
00385 
00386     FloatRegisterTrashMask = 0;
00387     TriggerPc = (ULONG_PTR)TrapFrame-&gt;Fir;
00388     TrapShadowLowLimit = TriggerPc - (500 * <span class="keyword">sizeof</span>(ULONG));
00389 
00390     <span class="keywordflow">try</span> {
00391         <span class="keywordflow">do</span> {
00392             TriggerPc -= 4;
00393             <span class="keywordflow">if</span> (TriggerPc &lt; TrapShadowLowLimit) {
00394 
00395                 <span class="comment">//</span>
00396                 <span class="comment">// The trigger PC is too far away from the exception PC to</span>
00397                 <span class="comment">// be reasonable. The trap shadow is invalid.</span>
00398                 <span class="comment">//</span>
00399 
00400                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>(<span class="stringliteral">"KiLocateTriggerPc: Trap shadow too long\n"</span>);
00401                 <a class="code" href="../../d8/d5/trigger_8c.html#a1">NON_IEEE</a>(ExceptionRecord, TRIGGER_INSTRUCTION_NOT_FOUND);
00402                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00403             }
00404 
00405             <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00406                 Instruction.Long = <a class="code" href="../../d5/d8/ex_8h.html#a20">ProbeAndReadUlong</a>((PULONG)TriggerPc);
00407             } <span class="keywordflow">else</span> {
00408                 Instruction.Long = *((PULONG)TriggerPc);
00409             }
00410 
00411             <span class="comment">//</span>
00412             <span class="comment">// Examine the opcode of this instruction to determine if the</span>
00413             <span class="comment">// trap shadow is invalid.</span>
00414             <span class="comment">//</span>
00415 
00416             Opcode = Instruction.Memory.Opcode;
00417             <span class="keywordflow">if</span> (Opcode == JMP_OP) {
00418 
00419                 <span class="comment">//</span>
00420                 <span class="comment">// This is one of the jump instructions: jump, return, or</span>
00421                 <span class="comment">// either form of jsr. The trap shadow is invalid.</span>
00422                 <span class="comment">//</span>
00423 
00424                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>(<span class="stringliteral">"KiLocateTriggerPc: Jump within Trap Shadow\n"</span>);
00425                 <a class="code" href="../../d8/d5/trigger_8c.html#a1">NON_IEEE</a>(ExceptionRecord, TRIGGER_INVALID_INSTRUCTION_FOUND);
00426                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00427 
00428             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Opcode &gt;= BR_OP) &amp;&amp; (Opcode &lt;= BGT_OP)) {
00429 
00430                 <span class="comment">//</span>
00431                 <span class="comment">// The instruction is one of 16 branch opcodes that consists</span>
00432                 <span class="comment">// of BR, the 6 floating point branch, BSR, and the 8 integer</span>
00433                 <span class="comment">// branch instructions. The trap shadow is invalid.</span>
00434                 <span class="comment">//</span>
00435 
00436                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>(<span class="stringliteral">"KiLocateTriggerPc: Branch within Trap Shadow\n"</span>);
00437                 <a class="code" href="../../d8/d5/trigger_8c.html#a1">NON_IEEE</a>(ExceptionRecord, TRIGGER_INVALID_INSTRUCTION_FOUND);
00438                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00439 
00440             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Instruction.Memory.Opcode == MEMSPC_OP) &amp;&amp;
00441                 ((Instruction.Memory.MemDisp == TRAPB_FUNC) ||
00442                  (Instruction.Memory.MemDisp == EXCB_FUNC))) {
00443 
00444                 <span class="comment">//</span>
00445                 <span class="comment">// The instruction is a type of TRAPB instruction. The trap</span>
00446                 <span class="comment">// shadow is invalid.</span>
00447                 <span class="comment">//</span>
00448 
00449                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>(<span class="stringliteral">"KiLocateTriggerPc: Trapb within Trap Shadow\n"</span>);
00450                 <a class="code" href="../../d8/d5/trigger_8c.html#a1">NON_IEEE</a>(ExceptionRecord, TRIGGER_INVALID_INSTRUCTION_FOUND);
00451                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00452 
00453             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Opcode == CALLPAL_OP) {
00454 
00455                 <span class="comment">//</span>
00456                 <span class="comment">// The instruction is a Call PAL. The trap shadow is invalid.</span>
00457                 <span class="comment">//</span>
00458 
00459                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>(<span class="stringliteral">"KiLocateTriggerPc: Call PAL within Trap Shadow\n"</span>);
00460                 <a class="code" href="../../d8/d5/trigger_8c.html#a1">NON_IEEE</a>(ExceptionRecord, TRIGGER_INVALID_INSTRUCTION_FOUND);
00461                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00462 
00463             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Opcode == IEEEFP_OP) || (Opcode == FPOP_OP)) {
00464 
00465                 <span class="comment">//</span>
00466                 <span class="comment">// The instruction is an IEEE floating point instruction.</span>
00467                 <span class="comment">// Decode the destination register of the floating point</span>
00468                 <span class="comment">// instruction in order to check against the register mask.</span>
00469                 <span class="comment">//</span>
00470 
00471                 Fc = Instruction.FpOp.Fc;
00472                 <span class="keywordflow">if</span> (Fc != FZERO_REG) {
00473                     FloatRegisterTrashMask |= (1 &lt;&lt; Fc);
00474                 }
00475                 FloatRegisterWriteMask &amp;= ~(1 &lt;&lt; Fc);
00476             }
00477 
00478         } <span class="keywordflow">while</span> (FloatRegisterWriteMask != 0);
00479 
00480         <span class="comment">//</span>
00481         <span class="comment">// If the instruction thought to be the trigger instruction does not</span>
00482         <span class="comment">// have the /S bit set, then the trap shadow is invalid (some other</span>
00483         <span class="comment">// instruction must have caused software completion bit to be set).</span>
00484         <span class="comment">//</span>
00485 
00486         <span class="keywordflow">if</span> ((Instruction.FpOp.Function &amp; FP_TRAP_ENABLE_S) == 0) {
00487             <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>(<span class="stringliteral">"KiLocateTriggerPc: Trigger instruction missing /S\n"</span>);
00488             <a class="code" href="../../d8/d5/trigger_8c.html#a1">NON_IEEE</a>(ExceptionRecord, TRIGGER_WRONG_INSTRUCTION);
00489             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00490         }
00491 
00492         <span class="comment">//</span>
00493         <span class="comment">// If either of the operand registers of the trigger instruction is</span>
00494         <span class="comment">// also the destination register of the trigger instruction or any</span>
00495         <span class="comment">// instruction in the trap shadow, then the trap shadow in invalid.</span>
00496         <span class="comment">// This is because the original value of the operand register(s) may</span>
00497         <span class="comment">// have been destroyed making it impossible to re-execute the trigger</span>
00498         <span class="comment">// instruction.</span>
00499         <span class="comment">//</span>
00500 
00501         Fa = Instruction.FpOp.Fa;
00502         Fb = Instruction.FpOp.Fb;
00503         <span class="keywordflow">if</span> ((FloatRegisterTrashMask &amp; ((1 &lt;&lt; Fa) | (1 &lt;&lt; Fb))) != 0) {
00504             <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>(<span class="stringliteral">"KiLocateTriggerPc: Source is destination\n"</span>);
00505             <a class="code" href="../../d8/d5/trigger_8c.html#a1">NON_IEEE</a>(ExceptionRecord, TRIGGER_SOURCE_IS_DESTINATION);
00506             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00507         }
00508 
00509     } except (EXCEPTION_EXECUTE_HANDLER) {
00510 
00511         <span class="comment">//</span>
00512         <span class="comment">// An exception occurred while fetching the value of the</span>
00513         <span class="comment">// next previous instruction. The trap shadow is invalid.</span>
00514         <span class="comment">//</span>
00515 
00516         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>(<span class="stringliteral">"KiLocateTriggerPc: Instruction fetch error\n"</span>);
00517         <a class="code" href="../../d8/d5/trigger_8c.html#a1">NON_IEEE</a>(ExceptionRecord, TRIGGER_INSTRUCTION_FETCH_ERROR);
00518         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00519     }
00520 
00521     <span class="comment">//</span>
00522     <span class="comment">// The trigger instruction was successfully located. Set the precise</span>
00523     <span class="comment">// exception address in the exception record, set the new continuation</span>
00524     <span class="comment">// address in the trap frame, and return a value of TRUE.</span>
00525     <span class="comment">//</span>
00526 
00527     <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>(<span class="stringliteral">"KiLocateTriggerPc: Exception PC = %p, Trigger PC = %p\n"</span>,
00528              ExceptionRecord-&gt;ExceptionAddress, TriggerPc);
00529     ExceptionRecord-&gt;ExceptionAddress = (PVOID)TriggerPc;
00530     TrapFrame-&gt;Fir = (ULONGLONG)(LONG_PTR)(TriggerPc + 4);
00531     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00532 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="trigger.c::KiSetFloatingStatus" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiSetFloatingStatus           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PEXCEPTION_RECORD&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ExceptionRecord</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d4/trigger_8c-source.html#l00535">535</a> of file <a class="el" href="../../d9/d4/trigger_8c-source.html">trigger.c</a>.
<p>
References <a class="el" href="../../d7/d4/ioep_8h-source.html#l00067">DBGPRINT</a>.
<p>
Referenced by <a class="el" href="../../d9/d4/trigger_8c-source.html#l00079">KiFloatingException()</a>.
<p>
<pre class="fragment"><div>00541                    :
00542 
00543     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to convert <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception summary <span class="keyword">register</span> bits
00544     into a status code value.
00545 
00546 Arguments:
00547 
00548     ExceptionRecord - Supplies a pointer to an exception record.
00549 
00550 Return Value:
00551 
00552     None.
00553 
00554 --*/
00555 
00556 {
00557 
00558     PEXC_SUM ExceptionSummary;
00559 
00560     <span class="comment">//</span>
00561     <span class="comment">// Perform the following triage on the exception summary register to</span>
00562     <span class="comment">// report the type of exception, even if though the PC reported is</span>
00563     <span class="comment">// imprecise.</span>
00564     <span class="comment">//</span>
00565 
00566     <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>(<span class="stringliteral">"KiSetFloatingStatus: ExceptionSummary = %.8lx\n"</span>,
00567              ExceptionRecord-&gt;ExceptionInformation[2]);
00568 
00569     ExceptionSummary = (PEXC_SUM)(&amp;ExceptionRecord-&gt;ExceptionInformation[2]);
00570     <span class="keywordflow">if</span> (ExceptionSummary-&gt;InvalidOperation != 0) {
00571         ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_INVALID_OPERATION;
00572 
00573     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ExceptionSummary-&gt;DivisionByZero != 0) {
00574         ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_DIVIDE_BY_ZERO;
00575 
00576     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ExceptionSummary-&gt;Overflow != 0) {
00577         ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_OVERFLOW;
00578 
00579     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ExceptionSummary-&gt;Underflow != 0) {
00580         ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_UNDERFLOW;
00581 
00582     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ExceptionSummary-&gt;InexactResult != 0) {
00583         ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_INEXACT_RESULT;
00584 
00585     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ExceptionSummary-&gt;IntegerOverflow != 0) {
00586         ExceptionRecord-&gt;ExceptionCode = STATUS_INTEGER_OVERFLOW;
00587 
00588     } <span class="keywordflow">else</span> {
00589         ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_STACK_CHECK;
00590     }
00591 }
}
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:49 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
