<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: region.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>region.c</h1><a href="../../d7/d6/ke_2ia64_2region_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Module Name:</span>
00004 <span class="comment"></span>
00005 <span class="comment">    session.c</span>
00006 <span class="comment"></span>
00007 <span class="comment">Abstract:</span>
00008 <span class="comment"></span>
00009 <span class="comment">    This module implements the region space management code.</span>
00010 <span class="comment"></span>
00011 <span class="comment">Author:</span>
00012 <span class="comment"></span>
00013 <span class="comment">    18-Feb-1999</span>
00014 <span class="comment"></span>
00015 <span class="comment">Environment:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    Kernel mode only.</span>
00018 <span class="comment"></span>
00019 <span class="comment">Revision History:</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 
00023 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00024 <span class="preprocessor">#include "<a class="code" href="../../d2/d1/mm_8h.html">mm.h</a>"</span>
00025 <span class="preprocessor">#include "..\..\mm\mi.h"</span>
00026 
00027 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00028 <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a2">KiSetRegionRegister</a> (
00029     PVOID VirtualAddress,
00030     ULONGLONG Contents
00031     );
00032 
00033 
<a name="l00034"></a><a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a0">00034</a> <span class="preprocessor">#define KiMakeValidRegionRegister(Rid, Ps) \</span>
00035 <span class="preprocessor">   (((ULONGLONG)Rid &lt;&lt; RR_RID) | (Ps &lt;&lt; RR_PS) | (1 &lt;&lt; RR_VE))</span>
00036 <span class="preprocessor"></span>
<a name="l00037"></a><a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a1">00037</a> ULONG <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a1">KiMaximumRid</a> = MAXIMUM_RID;
00038 
00039 
00040 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00041"></a><a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a3">00041</a> <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a3">KiSyncNewRegionIdTarget</a> (
00042     IN PULONG SignalDone,
00043     IN PVOID Parameter1,
00044     IN PVOID Parameter2,
00045     IN PVOID Parameter3
00046     )
00047 
00048 <span class="comment">/*++</span>
00049 <span class="comment"></span>
00050 <span class="comment">Routine Description:</span>
00051 <span class="comment"></span>
00052 <span class="comment">    This is the target function for synchronizing the region Ids</span>
00053 <span class="comment"></span>
00054 <span class="comment">Arguments:</span>
00055 <span class="comment"></span>
00056 <span class="comment">    SignalDone Supplies a pointer to a variable that is cleared when the</span>
00057 <span class="comment">        requested operation has been performed.</span>
00058 <span class="comment"></span>
00059 <span class="comment">    Parameter1 - Parameter3 - Not used.</span>
00060 <span class="comment"></span>
00061 <span class="comment">Return Value:</span>
00062 <span class="comment"></span>
00063 <span class="comment">    None.</span>
00064 <span class="comment"></span>
00065 <span class="comment">--*/</span>
00066 
00067 {
00068 <span class="preprocessor">#if !defined(NT_UP)</span>
00069 <span class="preprocessor"></span>
00070     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00071     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
00072     PREGION_MAP_INFO ProcessRegion;
00073     PREGION_MAP_INFO MappedSession;
00074     ULONG NewRid;
00075  
00076     <span class="comment">//</span>
00077     <span class="comment">// Flush the entire TB on the current processor.</span>
00078     <span class="comment">//</span>
00079 
00080     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00081     Process = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>;
00082     ProcessRegion = &amp;Process-&gt;ProcessRegion;
00083     MappedSession = Process-&gt;SessionMapInfo;
00084 
00085     KiAcquireSpinLock(&amp;<a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a8">KiMasterRidLock</a>);
00086 
00087     <span class="keywordflow">if</span> (ProcessRegion-&gt;SequenceNumber != KiMasterSequence) {
00088         
00089         KiMasterRid += 1;
00090 
00091         ProcessRegion-&gt;RegionId = KiMasterRid;
00092         ProcessRegion-&gt;SequenceNumber = KiMasterSequence;
00093 
00094         <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a2">KiSetRegionRegister</a>(MM_LOWEST_USER_ADDRESS,
00095             <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a0">KiMakeValidRegionRegister</a>(ProcessRegion-&gt;RegionId, <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>));
00096 
00097     }
00098 
00099     <span class="keywordflow">if</span> (MappedSession-&gt;SequenceNumber != KiMasterSequence) {
00100 
00101         KiMasterRid += 1;
00102         
00103         MappedSession-&gt;RegionId = KiMasterRid;
00104         MappedSession-&gt;SequenceNumber = KiMasterSequence;
00105 
00106         <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a2">KiSetRegionRegister</a>((PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a14">MM_SESSION_SPACE_DEFAULT</a>,
00107             <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a0">KiMakeValidRegionRegister</a>(MappedSession-&gt;RegionId, <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>));
00108     }
00109 
00110 
00111     KiReleaseSpinLock(&amp;<a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a8">KiMasterRidLock</a>);
00112 
00113     <a class="code" href="../../d0/d0/ki_8h.html#a93">KiIpiSignalPacketDone</a>(SignalDone);
00114 
00115     <a class="code" href="../../d4/d9/ke_8h.html#a374">KeFlushCurrentTb</a>();
00116 
00117 <span class="preprocessor">#endif</span>
00118 <span class="preprocessor"></span>    <span class="keywordflow">return</span>;
00119 }
00120 
00121 BOOLEAN
<a name="l00122"></a><a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a4">00122</a> <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a4">KiSyncNewRegionId</a>(
00123     IN PREGION_MAP_INFO ProcessRegion,
00124     IN PREGION_MAP_INFO SessionRegion
00125     )
00126 <span class="comment">/*++</span>
00127 <span class="comment"></span>
00128 <span class="comment"> Routine Description:</span>
00129 <span class="comment"></span>
00130 <span class="comment">    Generate a new region id and synchronze the region Ids on all the processors</span>
00131 <span class="comment">    if necessary. If the region ids wrap then flush all processor TLB's.</span>
00132 <span class="comment"></span>
00133 <span class="comment"> Arguments:</span>
00134 <span class="comment"></span>
00135 <span class="comment">    ProcessRegion - Supplies a pointer to REGION_MAP_INFO for the user space.</span>
00136 <span class="comment">    SessionRegion - Supplies a pointer to REGION_MAP_INFO for the session space.</span>
00137 <span class="comment"></span>
00138 <span class="comment"> Return Value:</span>
00139 <span class="comment"></span>
00140 <span class="comment">    FALSE -- when region id has not been recycled.</span>
00141 <span class="comment"></span>
00142 <span class="comment">    TRUE -- when region id has been recycled.</span>
00143 <span class="comment"></span>
00144 <span class="comment"> Notes:</span>
00145 <span class="comment"></span>
00146 <span class="comment">    This routine called by KiSwapProcess, KeAttachSessionSpace and </span>
00147 <span class="comment">    KeCreateSessionSpace.</span>
00148 <span class="comment"></span>
00149 <span class="comment"> Environment:</span>
00150 <span class="comment"></span>
00151 <span class="comment">    Kernel mode.</span>
00152 <span class="comment">    KiLockDispaterLock or LockQueuedDispatcherLock is held</span>
00153 <span class="comment"></span>
00154 <span class="comment">--*/</span>
00155 
00156 {
00157     BOOLEAN RidRecycled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00158     KAFFINITY TargetProcessors;
00159     ULONG i;
00160 
00161     <span class="comment">//</span>
00162     <span class="comment">// Invalidate the ForwardProgressTb buffer</span>
00163     <span class="comment">//</span>
00164 
00165     <span class="keywordflow">for</span> (i = 0; i &lt; MAXIMUM_FWP_BUFFER_ENTRY; i += 1) {
00166         
00167         PCR-&gt;ForwardProgressBuffer[(i*2)+1] = 0;
00168 
00169     }
00170     
00171     KiAcquireSpinLock(&amp;<a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a8">KiMasterRidLock</a>);
00172 
00173     <span class="keywordflow">if</span> ((ProcessRegion-&gt;SequenceNumber == KiMasterSequence) &amp;&amp; 
00174         (SessionRegion-&gt;SequenceNumber == KiMasterSequence)) {
00175         
00176         <span class="keywordflow">goto</span> not_recycled;
00177 
00178     }
00179 
00180     <span class="keywordflow">if</span> (ProcessRegion-&gt;SequenceNumber != KiMasterSequence) {
00181 
00182         <span class="keywordflow">if</span> (KiMasterRid + 1 &gt; <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a1">KiMaximumRid</a>) {
00183 
00184             RidRecycled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00185 
00186         } <span class="keywordflow">else</span> {
00187 
00188             KiMasterRid += 1;
00189             ProcessRegion-&gt;RegionId = KiMasterRid;
00190             ProcessRegion-&gt;SequenceNumber = KiMasterSequence;
00191         }
00192                 
00193     }
00194 
00195     <span class="keywordflow">if</span> ((RidRecycled == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp; 
00196         (SessionRegion-&gt;SequenceNumber != KiMasterSequence)) {
00197         
00198         <span class="keywordflow">if</span> (KiMasterRid + 1 &gt; <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a1">KiMaximumRid</a>) {
00199 
00200             RidRecycled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00201 
00202         } <span class="keywordflow">else</span> {
00203 
00204             KiMasterRid += 1;
00205             SessionRegion-&gt;RegionId = KiMasterRid;
00206             SessionRegion-&gt;SequenceNumber = KiMasterSequence;
00207         }
00208     }
00209 
00210     <span class="keywordflow">if</span> (RidRecycled == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00211     
00212         <span class="keywordflow">goto</span> not_recycled;
00213 
00214     }
00215 
00216     <span class="comment">//</span>
00217     <span class="comment">//  Region Id must be recycled</span>
00218     <span class="comment">//</span>
00219 
00220     KiMasterRid = START_PROCESS_RID;
00221 
00222     <span class="comment">//</span>
00223     <span class="comment">// Since KiMasterSequence is 64-bit wide, it will not be recycled in your life time.</span>
00224     <span class="comment">//</span>
00225 
00226     <span class="keywordflow">if</span> (KiMasterSequence + 1 &gt; MAXIMUM_SEQUENCE) {
00227 
00228         KiMasterSequence = START_SEQUENCE;
00229 
00230     } <span class="keywordflow">else</span> {
00231 
00232         KiMasterSequence += 1;
00233     }
00234         
00235     <span class="comment">//</span>
00236     <span class="comment">// update new process's ProcessRid and ProcessSequence</span>
00237     <span class="comment">//</span>
00238 
00239     ProcessRegion-&gt;RegionId = KiMasterRid;
00240     ProcessRegion-&gt;SequenceNumber = KiMasterSequence;
00241 
00242     <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a2">KiSetRegionRegister</a>(MM_LOWEST_USER_ADDRESS,
00243                         <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a0">KiMakeValidRegionRegister</a>(ProcessRegion-&gt;RegionId, <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>));
00244 
00245     KiMasterRid += 1;
00246 
00247     SessionRegion-&gt;RegionId = KiMasterRid;
00248     SessionRegion-&gt;SequenceNumber = KiMasterSequence;
00249 
00250     <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a2">KiSetRegionRegister</a>((PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a14">MM_SESSION_SPACE_DEFAULT</a>,
00251                         <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a0">KiMakeValidRegionRegister</a>(SessionRegion-&gt;RegionId, <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>));
00252 
00253     <span class="comment">//</span>
00254     <span class="comment">// release mutex for master region id lock</span>
00255     <span class="comment">//</span>
00256 
00257     KiReleaseSpinLock(&amp;<a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a8">KiMasterRidLock</a>);
00258 
00259 <span class="preprocessor">#if !defined(NT_UP)</span>
00260 <span class="preprocessor"></span>
00261     <span class="comment">//</span>
00262     <span class="comment">// broadcast Region Id sync</span>
00263     <span class="comment">//</span>
00264 
00265     TargetProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a>;
00266     TargetProcessors &amp;= PCR-&gt;NotMember;
00267 
00268     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00269         <a class="code" href="../../d0/d0/ki_8h.html#a91">KiIpiSendPacket</a>(TargetProcessors,
00270                         <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a3">KiSyncNewRegionIdTarget</a>,
00271                         (PVOID)<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00272                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00273                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00274     }
00275 
00276 <span class="preprocessor">#endif</span>
00277 <span class="preprocessor"></span>
00278     <a class="code" href="../../d4/d9/ke_8h.html#a374">KeFlushCurrentTb</a>();
00279 
00280 
00281 <span class="preprocessor">#if !defined(NT_UP)</span>
00282 <span class="preprocessor"></span>
00283     <span class="comment">//</span>
00284     <span class="comment">// Wait until all target processors have finished.</span>
00285     <span class="comment">//</span>
00286 
00287     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00288         <a class="code" href="../../d2/d1/xipi_8c.html#a2">KiIpiStallOnPacketTargets</a>(TargetProcessors);
00289     }
00290 
00291 <span class="preprocessor">#endif</span>
00292 <span class="preprocessor"></span>
00293     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00294 
00295 
00296 not_recycled:
00297 
00298     <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a2">KiSetRegionRegister</a>(MM_LOWEST_USER_ADDRESS,
00299                         <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a0">KiMakeValidRegionRegister</a>(ProcessRegion-&gt;RegionId, <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>));
00300 
00301     <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a2">KiSetRegionRegister</a>((PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a14">MM_SESSION_SPACE_DEFAULT</a>,
00302                             <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a0">KiMakeValidRegionRegister</a>(SessionRegion-&gt;RegionId, <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>));
00303 
00304     <span class="comment">//</span>
00305     <span class="comment">// release mutex for master region id lock</span>
00306     <span class="comment">//</span>
00307 
00308     KiReleaseSpinLock(&amp;<a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a8">KiMasterRidLock</a>);
00309         
00310     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00311 
00312 }
00313 
00314 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00315"></a><a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a5">00315</a> <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a5">KeEnableSessionSharing</a>(
00316     PREGION_MAP_INFO SessionMapInfo
00317     )
00318 <span class="comment">/*++</span>
00319 <span class="comment"></span>
00320 <span class="comment"> Routine Description:</span>
00321 <span class="comment"></span>
00322 <span class="comment">    This routine enables session sharing by the other processes.</span>
00323 <span class="comment"></span>
00324 <span class="comment"> Arguments: </span>
00325 <span class="comment"></span>
00326 <span class="comment">    SessionMapInfo - Supplies a session map info to be shared.</span>
00327 <span class="comment"></span>
00328 <span class="comment"> Return Value:</span>
00329 <span class="comment"></span>
00330 <span class="comment">    None.</span>
00331 <span class="comment"></span>
00332 <span class="comment"> Environment:</span>
00333 <span class="comment"></span>
00334 <span class="comment">    Kernel mode.</span>
00335 <span class="comment"></span>
00336 <span class="comment">--*/</span>
00337 {
00338     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
00339     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00340     KIRQL OldIrql;
00341 
00342     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00343     Process = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>;
00344 
00345     <span class="comment">//</span>
00346     <span class="comment">// Raise IRQL to dispatcher level and lock the dispatcher database.</span>
00347     <span class="comment">//</span>
00348 
00349     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00350 
00351     SessionMapInfo-&gt;RegionId = Process-&gt;SessionRegion.RegionId;
00352     SessionMapInfo-&gt;SequenceNumber = Process-&gt;SessionRegion.SequenceNumber;
00353 
00354     Process-&gt;SessionMapInfo = SessionMapInfo;
00355 
00356     <span class="comment">//</span>
00357     <span class="comment">// unlock the dispatcher database</span>
00358     <span class="comment">//</span>
00359 
00360     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00361 }
00362 
00363 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00364"></a><a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a6">00364</a> <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a6">KeDisableSessionSharing</a>(
00365     PREGION_MAP_INFO SessionMapInfo
00366     )
00367 <span class="comment">/*++</span>
00368 <span class="comment"></span>
00369 <span class="comment"> Routine Description:</span>
00370 <span class="comment"></span>
00371 <span class="comment">    This routine disables session sharing by the other process.</span>
00372 <span class="comment"></span>
00373 <span class="comment"> Arguments: </span>
00374 <span class="comment"></span>
00375 <span class="comment">    SessionMapInfo - Supplies a session map info to be disabled </span>
00376 <span class="comment">           for sharing.</span>
00377 <span class="comment"></span>
00378 <span class="comment"> Return Value:</span>
00379 <span class="comment"></span>
00380 <span class="comment">    None.</span>
00381 <span class="comment"></span>
00382 <span class="comment"> Environment:</span>
00383 <span class="comment"></span>
00384 <span class="comment">    Kernel mode.</span>
00385 <span class="comment"></span>
00386 <span class="comment">--*/</span>
00387 {
00388     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
00389     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00390     KIRQL OldIrql;
00391 
00392     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00393     Process = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>;
00394 
00395     <span class="comment">//</span>
00396     <span class="comment">// Raise IRQL to dispatcher level and lock the dispatcher database.</span>
00397     <span class="comment">//</span>
00398 
00399     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00400 
00401     Process-&gt;SessionRegion.RegionId = SessionMapInfo-&gt;RegionId;
00402     Process-&gt;SessionRegion.SequenceNumber = SessionMapInfo-&gt;SequenceNumber;
00403     Process-&gt;SessionMapInfo = &amp;Process-&gt;SessionRegion;
00404 
00405     <span class="comment">//</span>
00406     <span class="comment">// unlock the dispatcher database</span>
00407     <span class="comment">//</span>
00408 
00409     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00410 }
00411 
00412 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00413"></a><a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a7">00413</a> <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a7">KeAttachSessionSpace</a>(
00414     PREGION_MAP_INFO SessionMapInfo
00415     )
00416 <span class="comment">/*++</span>
00417 <span class="comment"></span>
00418 <span class="comment"> Routine Description:</span>
00419 <span class="comment"></span>
00420 <span class="comment">    This routine attaches a session map info to the current process.</span>
00421 <span class="comment"></span>
00422 <span class="comment"> Arguments: </span>
00423 <span class="comment"></span>
00424 <span class="comment">    SessionMapInfo - Supplies a session map info to be attached.</span>
00425 <span class="comment"></span>
00426 <span class="comment"> Return Value:</span>
00427 <span class="comment"></span>
00428 <span class="comment">    None.</span>
00429 <span class="comment"></span>
00430 <span class="comment"> Environment:</span>
00431 <span class="comment"></span>
00432 <span class="comment">    Kernel mode.</span>
00433 <span class="comment"></span>
00434 <span class="comment">--*/</span>
00435 {
00436     KIRQL OldIrql;
00437     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00438     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
00439 
00440     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00441     Process = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>;
00442 
00443     <span class="comment">//</span>
00444     <span class="comment">// Raise IRQL to dispatcher level and lock the dispatcher database.</span>
00445     <span class="comment">//</span>
00446 
00447     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00448 
00449     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(SessionMapInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00450 
00451     <span class="comment">//</span>
00452     <span class="comment">// Attach the given session map</span>
00453     <span class="comment">//</span>
00454 
00455     Process-&gt;SessionMapInfo = SessionMapInfo;
00456 
00457     <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a4">KiSyncNewRegionId</a>(&amp;Process-&gt;ProcessRegion, SessionMapInfo);
00458 
00459     <span class="comment">//</span>
00460     <span class="comment">// unlock the dispatcher database</span>
00461     <span class="comment">//</span>
00462 
00463     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00464     
00465 }
00466 
00467 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00468"></a><a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a8">00468</a> <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a8">KiSyncSessionTarget</a>(
00469     IN PULONG SignalDone,
00470     IN <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process,
00471     IN PVOID Parameter1,
00472     IN PVOID Parameter2
00473     )
00474 <span class="comment">/*++</span>
00475 <span class="comment"></span>
00476 <span class="comment"> Routine Description:</span>
00477 <span class="comment"></span>
00478 <span class="comment">    This is the target function for synchronizing the new session </span>
00479 <span class="comment">    region id.  This routine is called when the session space is removed </span>
00480 <span class="comment">    and all the processors need to be notified.</span>
00481 <span class="comment"></span>
00482 <span class="comment"> Arguments:</span>
00483 <span class="comment"></span>
00484 <span class="comment">    SignalDone - Supplies a pointer to a variable that is cleared when the</span>
00485 <span class="comment">        requested operation has been performed.</span>
00486 <span class="comment"></span>
00487 <span class="comment">    Process - Supplies a KPROCESS pointer which needs to be sync'ed.</span>
00488 <span class="comment"></span>
00489 <span class="comment"> Return Value:</span>
00490 <span class="comment"></span>
00491 <span class="comment">    None.</span>
00492 <span class="comment"></span>
00493 <span class="comment"> Environment:</span>
00494 <span class="comment"></span>
00495 <span class="comment">    Kernel mode.</span>
00496 <span class="comment"></span>
00497 <span class="comment">--*/</span>
00498 {
00499 <span class="preprocessor">#if !defined(NT_UP)</span>
00500 <span class="preprocessor"></span>
00501     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00502     ULONG NewRid;
00503  
00504     <span class="comment">//</span>
00505     <span class="comment">// Flush the entire TB on the current processor.</span>
00506     <span class="comment">//</span>
00507 
00508     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00509 
00510     <span class="comment">//</span>
00511     <span class="comment">// check to see if the current process is the process that needs to be </span>
00512     <span class="comment">// sync'ed</span>
00513     <span class="comment">//</span>
00514 
00515     <span class="keywordflow">if</span> (Process == Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>) {
00516         
00517         KiAcquireSpinLock(&amp;<a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a8">KiMasterRidLock</a>);
00518 
00519         <span class="comment">//</span>
00520         <span class="comment">// disable the session region.</span>
00521         <span class="comment">//</span>
00522 
00523         <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a2">KiSetRegionRegister</a>((PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a14">MM_SESSION_SPACE_DEFAULT</a>, 
00524                             <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a0">KiMakeValidRegionRegister</a>(Process-&gt;SessionMapInfo-&gt;RegionId, <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>));
00525 
00526         KiReleaseSpinLock(&amp;<a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a8">KiMasterRidLock</a>);
00527 
00528         <span class="comment">//</span>
00529         <span class="comment">// flush the entire tb.</span>
00530         <span class="comment">//</span>
00531 
00532         <a class="code" href="../../d4/d9/ke_8h.html#a374">KeFlushCurrentTb</a>();
00533     }
00534 
00535     <a class="code" href="../../d0/d0/ki_8h.html#a93">KiIpiSignalPacketDone</a>(SignalDone);
00536 
00537 <span class="preprocessor">#endif</span>
00538 <span class="preprocessor"></span>    <span class="keywordflow">return</span>;
00539 }
00540 
00541 
00542 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> 
<a name="l00543"></a><a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a9">00543</a> <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a9">KeDetachSessionSpace</a>(
00544     VOID
00545     )
00546 <span class="comment">/*++</span>
00547 <span class="comment"></span>
00548 <span class="comment"> Routine Description:</span>
00549 <span class="comment">    </span>
00550 <span class="comment">    This routine removes the session space and synchronize the all threads on </span>
00551 <span class="comment">    the other processors.</span>
00552 <span class="comment"></span>
00553 <span class="comment"> Arguments:</span>
00554 <span class="comment"> </span>
00555 <span class="comment">    DeleteSessionMapInfo - if TRUE, the session map info will be deleted.</span>
00556 <span class="comment">        if FALSE, the session map info will not be deleted.</span>
00557 <span class="comment"></span>
00558 <span class="comment"> Return Value:</span>
00559 <span class="comment">  </span>
00560 <span class="comment">    None.</span>
00561 <span class="comment"></span>
00562 <span class="comment"> Environment:</span>
00563 <span class="comment"> </span>
00564 <span class="comment">    Kernel mode.</span>
00565 <span class="comment"></span>
00566 <span class="comment">--*/</span>
00567 {
00568     KIRQL OldIrql;
00569     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00570     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
00571 <span class="preprocessor">#if !defined(NT_UP)</span>
00572 <span class="preprocessor"></span>    KAFFINITY TargetProcessors;
00573 <span class="preprocessor">#endif</span>
00574 <span class="preprocessor"></span>
00575     <span class="comment">//</span>
00576     <span class="comment">// Raise IRQL to dispatcher level and lock the dispatcher database.</span>
00577     <span class="comment">//</span>
00578 
00579     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00580 
00581     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00582     Process = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>;
00583 
00584     <span class="comment">//</span>
00585     <span class="comment">// Lock the region Id resource.</span>
00586     <span class="comment">//</span>
00587     
00588     KiAcquireSpinLock(&amp;<a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a8">KiMasterRidLock</a>);
00589 
00590     Process-&gt;SessionMapInfo = &amp;Process-&gt;SessionRegion;
00591     
00592     <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a2">KiSetRegionRegister</a>((PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a14">MM_SESSION_SPACE_DEFAULT</a>, 
00593                         <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a0">KiMakeValidRegionRegister</a>(Process-&gt;SessionMapInfo-&gt;RegionId, <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>));
00594 
00595     <span class="comment">//</span>
00596     <span class="comment">// Unlock the region Id resource.</span>
00597     <span class="comment">//</span>
00598 
00599     KiReleaseSpinLock(&amp;<a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a8">KiMasterRidLock</a>);
00600 
00601 <span class="preprocessor">#if !defined(NT_UP)</span>
00602 <span class="preprocessor"></span>
00603     <span class="comment">//</span>
00604     <span class="comment">// broadcast Region Id sync</span>
00605     <span class="comment">//</span>
00606 
00607     TargetProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a>;
00608     TargetProcessors &amp;= PCR-&gt;NotMember;
00609 
00610     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00611         <a class="code" href="../../d0/d0/ki_8h.html#a91">KiIpiSendPacket</a>(TargetProcessors,
00612                         <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a8">KiSyncSessionTarget</a>,
00613                         Process,
00614                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00615                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00616     }
00617 
00618 <span class="preprocessor">#endif</span>
00619 <span class="preprocessor"></span>
00620     <span class="comment">//</span>
00621     <span class="comment">// Unlock the dispatcher database</span>
00622     <span class="comment">//</span>
00623 
00624     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00625 }    
00626 
00627 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00628"></a><a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a10">00628</a> <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a10">KeAddSessionSpace</a>(
00629     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process,
00630     PREGION_MAP_INFO SessionMapInfo
00631     )
00632 <span class="comment">/*++</span>
00633 <span class="comment"></span>
00634 <span class="comment">Routine Description:</span>
00635 <span class="comment">    </span>
00636 <span class="comment">    Add the session map info to the KPROCESS of the new process.</span>
00637 <span class="comment"></span>
00638 <span class="comment">Arguments:</span>
00639 <span class="comment"></span>
00640 <span class="comment">    Process - Supplies a pointer to the process being created.</span>
00641 <span class="comment"></span>
00642 <span class="comment">    SessionMapInfo - Supplies a pointer to the SessionMapInfo.</span>
00643 <span class="comment"></span>
00644 <span class="comment">Return Value: </span>
00645 <span class="comment"></span>
00646 <span class="comment">    None.</span>
00647 <span class="comment"></span>
00648 <span class="comment">Environment:</span>
00649 <span class="comment"></span>
00650 <span class="comment">    Kernel mode, APCs disabled.  </span>
00651 <span class="comment"></span>
00652 <span class="comment">Remarks:</span>
00653 <span class="comment">    </span>
00654 <span class="comment">    KiLockDispaterLock or LockQueuedDispatcherLock is not necessary </span>
00655 <span class="comment">    since the process has not run yet.</span>
00656 <span class="comment"></span>
00657 <span class="comment">--*/</span>
00658 {
00659     KIRQL OldIrql;
00660 
00661     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Process-&gt;SessionMapInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00662 
00663 <span class="comment">//    KiLockDispatcherDatabase(&amp;OldIrql);</span>
00664 
00665     Process-&gt;SessionMapInfo = SessionMapInfo;
00666 
00667 <span class="comment">//    KiUnLockDispatherDatabase(OldIrql);</span>
00668 
00669 }
00670 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:37 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
