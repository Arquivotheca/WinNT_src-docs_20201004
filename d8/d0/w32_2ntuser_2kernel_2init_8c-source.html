<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: init.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>init.c</h1><a href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: init.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains all the init code for the USERSRV.DLL.  When</span>
00007 <span class="comment">* the DLL is dynlinked by the SERVER EXE its initialization procedure</span>
00008 <span class="comment">* (xxxUserServerDllInitialize) is called by the loader.</span>
00009 <span class="comment">*</span>
00010 <span class="comment">* History:</span>
00011 <span class="comment">* 18-Sep-1990 DarrinM   Created.</span>
00012 <span class="comment">\***************************************************************************/</span>
00013 
<a name="l00014"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a0">00014</a> <span class="preprocessor">#define OEMRESOURCE 1</span>
00015 <span class="preprocessor"></span>
00016 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00017 <span class="preprocessor">#pragma hdrstop</span>
00018 <span class="preprocessor"></span>
00019 <span class="preprocessor">#if DBG</span>
00020 <span class="preprocessor"></span>LIST_ENTRY gDesktopList;
00021 <span class="preprocessor">#endif</span>
00022 <span class="preprocessor"></span>
00023 <span class="comment">//</span>
00024 <span class="comment">// External references</span>
00025 <span class="comment">//</span>
<a name="l00026"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a4">00026</a> <span class="keyword">extern</span> PVOID *<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a4">apObjects</a>;
<a name="l00027"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a5">00027</a> <span class="keyword">extern</span> <a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html">PKWAIT_BLOCK</a>   <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a5">gWaitBlockArray</a>;
<a name="l00028"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a6">00028</a> <span class="keyword">extern</span> PVOID <a class="code" href="../../d1/d0/w32_2ntuser_2kernel_2atom_8c.html#a0">UserAtomTableHandle</a>;
<a name="l00029"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a7">00029</a> <span class="keyword">extern</span> <a class="code" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a7">gptmrWD</a>;
00030 
<a name="l00031"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a8">00031</a> <span class="keyword">extern</span> UNICODE_STRING* <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a8">gpastrSetupExe</a>;
<a name="l00032"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a9">00032</a> <span class="keyword">extern</span> WCHAR* <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a9">glpSetupPrograms</a>;
00033 
<a name="l00034"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a10">00034</a> <span class="keyword">extern</span> <a class="code" href="../../d4/d4/struct__HANDLEPAGE.html">PHANDLEPAGE</a> <a class="code" href="../../d4/d8/handtabl_8c.html#a8">gpHandlePages</a>;
00035 
<a name="l00036"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a11">00036</a> <span class="keyword">extern</span> <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a> <a class="code" href="../../d4/d7/enumwin_8c.html#a2">pbwlCache</a>;
00037 
00038 <span class="comment">//</span>
00039 <span class="comment">// Forward references</span>
00040 <span class="comment">//</span>
00041 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00042 <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a21">Win32kNtUserCleanup</a>();
00043 
00044 <span class="preprocessor">#if DBG</span>
00045 <span class="preprocessor"></span><span class="keywordtype">void</span> InitGlobalThreadLockArray(DWORD dwIndex);
00046 <span class="preprocessor">#endif // DBG</span>
00047 <span class="preprocessor"></span>
00048 <span class="comment">/*</span>
00049 <span class="comment"> * Local Constants.</span>
00050 <span class="comment"> */</span>
<a name="l00051"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a1">00051</a> <span class="preprocessor">#define GRAY_STRLEN         40</span>
00052 <span class="preprocessor"></span>
00053 <span class="comment">/*</span>
00054 <span class="comment"> * Globals local to this file only.</span>
00055 <span class="comment"> */</span>
<a name="l00056"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a12">00056</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a12">bPermanentFontsLoaded</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
<a name="l00057"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a13">00057</a> <span class="keywordtype">int</span>  <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a13">LastFontLoaded</a> = -1;
00058 
00059 <span class="comment">/*</span>
00060 <span class="comment"> * Globals shared with W32</span>
00061 <span class="comment"> */</span>
<a name="l00062"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a14">00062</a> ULONG <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a14">W32ProcessSize</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PROCESSINFO</a>);
<a name="l00063"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a15">00063</a> ULONG <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a15">W32ProcessTag</a> = TAG_PROCESSINFO;
<a name="l00064"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a16">00064</a> ULONG <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a16">W32ThreadSize</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d8/structtagTHREADINFO.html">THREADINFO</a>);
<a name="l00065"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a17">00065</a> ULONG <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a17">W32ThreadTag</a> = TAG_THREADINFO;
<a name="l00066"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a18">00066</a> <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a> <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a18">gpW32FastMutex</a>;
00067 
00068 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00069 <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a22">DriverEntry</a>(
00070     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject,
00071     IN PUNICODE_STRING RegistryPath);
00072 
00073 <span class="preprocessor">#pragma alloc_text(INIT, DriverEntry)</span>
00074 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, LW_LoadSomeStrings)</span>
00075 <span class="preprocessor"></span>
00076 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d9/d6/kernel_2server_8c.html#a59">Win32UserInitialize</a>(VOID);
00077 
00078 <span class="preprocessor">#if defined(_X86_)</span>
00079 <span class="preprocessor"></span>ULONG Win32UserProbeAddress;
00080 <span class="preprocessor">#endif</span>
00081 <span class="preprocessor"></span>
00082 <span class="keywordtype">void</span> <a class="code" href="../../d3/d6/kernel_2sendmsg_8c.html#a16">FreeSMS</a>(PSMS psms);
00083 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a25">FreeImeHotKeys</a>(VOID);
00084 
00085 <span class="comment">/***************************************************************************\</span>
00086 <span class="comment">* Win32kNtUserCleanup</span>
00087 <span class="comment">*</span>
00088 <span class="comment">* History:</span>
00089 <span class="comment">* 5-Jan-1997 CLupu   Created.</span>
00090 <span class="comment">\***************************************************************************/</span>
<a name="l00091"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a19">00091</a> <span class="keyword">extern</span> <a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html">PPAGED_LOOKASIDE_LIST</a> <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a19">SMSLookaside</a>;
<a name="l00092"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a20">00092</a> <span class="keyword">extern</span> <a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html">PPAGED_LOOKASIDE_LIST</a> <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a20">QEntryLookaside</a>;
00093 
00094 <span class="comment">// Max time is 10 minutes, and the count is 10 min * 60 sec * 4 for 250 mili seconds</span>
<a name="l00095"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a2">00095</a> <span class="preprocessor">#define MAX_TIME_OUT    (10*60*4)</span>
00096 <span class="preprocessor"></span>
<a name="l00097"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a26">00097</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a21">Win32kNtUserCleanup</a>(
00098     VOID)
00099 {
00100     <span class="keywordtype">int</span> i;
00101 
00102     <a class="code" href="../../d4/d1/userk_8h.html#a777">TRACE_HYDAPI</a>((<span class="stringliteral">"Win32kNtUserCleanup: Cleanup Resources\n"</span>));
00103 
00104     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00105 
00106     <a class="code" href="../../d4/d1/userk_8h.html#a776">DbgDumpTrackedDesktops</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00107 
00108     <span class="comment">/*</span>
00109 <span class="comment">     * Anything in this list must be cleaned up when threads go away.</span>
00110 <span class="comment">     */</span>
00111     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a99">gpbwlList</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00112 
00113     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a255">gpWinEventHooks</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00114 
00115     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a171">gpScancodeMap</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00116 
00117     <span class="comment">/*</span>
00118 <span class="comment">     * Free IME hotkeys</span>
00119 <span class="comment">     */</span>
00120     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a25">FreeImeHotKeys</a>();
00121 
00122     <span class="comment">/*</span>
00123 <span class="comment">     * Free the wallpaper name string</span>
00124 <span class="comment">     */</span>
00125     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a6">gpszWall</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00126         UserFreePool(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a6">gpszWall</a>);
00127         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a6">gpszWall</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00128     }
00129     <span class="comment">/*</span>
00130 <span class="comment">     * Free the hung redraw stuff</span>
00131 <span class="comment">     */</span>
00132     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a182">gpvwplHungRedraw</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00133         UserFreePool(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a182">gpvwplHungRedraw</a>);
00134         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a182">gpvwplHungRedraw</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00135     }
00136 
00137     <span class="comment">/*</span>
00138 <span class="comment">     * Free the arrary of setup app names</span>
00139 <span class="comment">     */</span>
00140     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a8">gpastrSetupExe</a>) {
00141         UserFreePool(<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a8">gpastrSetupExe</a>);
00142         <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a8">gpastrSetupExe</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00143     }
00144 
00145     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a9">glpSetupPrograms</a>) {
00146         UserFreePool(<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a9">glpSetupPrograms</a>);
00147         <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a9">glpSetupPrograms</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00148     }
00149 
00150     <span class="comment">/*</span>
00151 <span class="comment">     * Free the cached window list</span>
00152 <span class="comment">     */</span>
00153     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d7/enumwin_8c.html#a2">pbwlCache</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00154         UserFreePool(<a class="code" href="../../d4/d7/enumwin_8c.html#a2">pbwlCache</a>);
00155         <a class="code" href="../../d4/d7/enumwin_8c.html#a2">pbwlCache</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00156     }
00157 
00158     <span class="comment">/*</span>
00159 <span class="comment">     * Free outstanding timers</span>
00160 <span class="comment">     */</span>
00161     <span class="keywordflow">while</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a247">gptmrFirst</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00162         <a class="code" href="../../d4/d1/userk_8h.html#a1045">FreeTimer</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a247">gptmrFirst</a>);
00163     }
00164 
00165     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a7">gptmrWD</a>) {
00166         <a class="code" href="../../d3/d2/timerobj_8c.html#a4">KeCancelTimer</a>(<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a7">gptmrWD</a>);
00167         UserFreePool(<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a7">gptmrWD</a>);
00168         <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a7">gptmrWD</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00169     }
00170 
00171     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a248">gptmrMaster</a>) {
00172         <a class="code" href="../../d3/d2/timerobj_8c.html#a4">KeCancelTimer</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a248">gptmrMaster</a>);
00173         UserFreePool(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a248">gptmrMaster</a>);
00174         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a248">gptmrMaster</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00175     }
00176 
00177     <span class="comment">/*</span>
00178 <span class="comment">     * Cleanup mouse &amp; kbd change events</span>
00179 <span class="comment">     */</span>
00180     <span class="keywordflow">for</span> (i = 0; i &lt;= <a class="code" href="../../d4/d1/userk_8h.html#a177">DEVICE_TYPE_MAX</a>; i++) {
00181         UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00182         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a2">aDeviceTemplate</a>[i].<a class="code" href="../../d4/d3/structtagDEVICE__TEMPLATE.html#o12">pkeHidChange</a>) {
00183             <a class="code" href="../../d4/d1/userk_8h.html#a967">FreeKernelEvent</a>(&amp;<a class="code" href="../../d5/d9/w32_2ntuser_2kernel_2pnp_8c.html#a2">aDeviceTemplate</a>[i].pkeHidChange);
00184         }
00185     }
00186 
00187     <a class="code" href="../../d4/d1/userk_8h.html#a2065">EnterDeviceInfoListCrit</a>();
00188     <span class="keywordflow">while</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a205">gpDeviceInfoList</a>) {
00189         <span class="comment">/*</span>
00190 <span class="comment">         * Assert that there is no outstanding read or PnP thread waiting</span>
00191 <span class="comment">         * in RequestDeviceChanges() for this device.</span>
00192 <span class="comment">         * Clear these flags anyway, to force the free.</span>
00193 <span class="comment">         */</span>
00194         UserAssert((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a205">gpDeviceInfoList</a>-&gt;bFlags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a189">GDIF_READING</a>) == 0);
00195         UserAssert((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a205">gpDeviceInfoList</a>-&gt;usActions &amp; <a class="code" href="../../d4/d1/userk_8h.html#a185">GDIAF_PNPWAITING</a>) == 0);
00196         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a205">gpDeviceInfoList</a>-&gt;bFlags &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a189">GDIF_READING</a>;
00197         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a205">gpDeviceInfoList</a>-&gt;usActions &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a185">GDIAF_PNPWAITING</a>;
00198         <a class="code" href="../../d4/d1/userk_8h.html#a1032">FreeDeviceInfo</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a205">gpDeviceInfoList</a>);
00199     }
00200     <a class="code" href="../../d4/d1/userk_8h.html#a2066">LeaveDeviceInfoListCrit</a>();
00201 
00202     <span class="comment">/*</span>
00203 <span class="comment">     * Cleanup object references</span>
00204 <span class="comment">     */</span>
00205     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a353">gThinwireFileObject</a>)
00206         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a353">gThinwireFileObject</a>);
00207 
00208     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a352">gVideoFileObject</a>)
00209         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a352">gVideoFileObject</a>);
00210 
00211     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a336">gpRemoteBeepDevice</a>)
00212         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a336">gpRemoteBeepDevice</a>);
00213 
00214     <span class="comment">/*</span>
00215 <span class="comment">     * Cleanup our resources. There should be no threads in here</span>
00216 <span class="comment">     * when we get called.</span>
00217 <span class="comment">     */</span>
00218     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a212">gpresMouseEventQueue</a>) {
00219         <a class="code" href="../../d5/d8/ex_8h.html#a73">ExDeleteResource</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a212">gpresMouseEventQueue</a>);
00220         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a212">gpresMouseEventQueue</a>);
00221         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a212">gpresMouseEventQueue</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00222     }
00223 
00224     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a206">gpresDeviceInfoList</a>) {
00225         <a class="code" href="../../d5/d8/ex_8h.html#a73">ExDeleteResource</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a206">gpresDeviceInfoList</a>);
00226         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a206">gpresDeviceInfoList</a>);
00227         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a206">gpresDeviceInfoList</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00228     }
00229 
00230     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a177">gpkeMouseData</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00231         <a class="code" href="../../d4/d1/userk_8h.html#a967">FreeKernelEvent</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a177">gpkeMouseData</a>);
00232     }
00233 
00234     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a4">apObjects</a>) {
00235         UserFreePool(<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a4">apObjects</a>);
00236         <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a4">apObjects</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00237     }
00238 
00239     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a5">gWaitBlockArray</a>) {
00240         UserFreePool(<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a5">gWaitBlockArray</a>);
00241         <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a5">gWaitBlockArray</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00242     }
00243 
00244     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a19">gpEventDiconnectDesktop</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00245         <a class="code" href="../../d4/d1/userk_8h.html#a967">FreeKernelEvent</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a19">gpEventDiconnectDesktop</a>);
00246     }
00247 
00248     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a346">gpevtDesktopDestroyed</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00249         <a class="code" href="../../d4/d1/userk_8h.html#a967">FreeKernelEvent</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a346">gpevtDesktopDestroyed</a>);
00250     }
00251 
00252     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/w32_2ntuser_2kernel_2atom_8c.html#a0">UserAtomTableHandle</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00253         <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a14">RtlDestroyAtomTable</a>(<a class="code" href="../../d1/d0/w32_2ntuser_2kernel_2atom_8c.html#a0">UserAtomTableHandle</a>);
00254         <a class="code" href="../../d1/d0/w32_2ntuser_2kernel_2atom_8c.html#a0">UserAtomTableHandle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00255     }
00256 
00257     <span class="comment">/*</span>
00258 <span class="comment">     * cleanup the SMS lookaside buffer</span>
00259 <span class="comment">     */</span>
00260     {
00261         <a class="code" href="../../d4/d1/userk_8h.html#a871">PSMS</a> psmsNext;
00262 
00263         <span class="keywordflow">while</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a238">gpsmsList</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00264             psmsNext = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a238">gpsmsList</a>-&gt;psmsNext;
00265             UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a238">gpsmsList</a>-&gt;spwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00266             <a class="code" href="../../d3/d6/kernel_2sendmsg_8c.html#a16">FreeSMS</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a238">gpsmsList</a>);
00267             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a238">gpsmsList</a> = psmsNext;
00268         }
00269 
00270         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a19">SMSLookaside</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00271             <a class="code" href="../../d5/d8/ex_8h.html#a251">ExDeletePagedLookasideList</a>(<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a19">SMSLookaside</a>);
00272             UserFreePool(<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a19">SMSLookaside</a>);
00273             <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a19">SMSLookaside</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00274         }
00275     }
00276 
00277     <span class="comment">/*</span>
00278 <span class="comment">     * Let go of the attached queue for hard error handling.</span>
00279 <span class="comment">     * Do this before we free the Qlookaside !</span>
00280 <span class="comment">     */</span>
00281     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a227">gHardErrorHandler</a>.<a class="code" href="../../d2/d6/structtagHARDERRORHANDLER.html#o1">pqAttach</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00282 
00283         UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a227">gHardErrorHandler</a>.<a class="code" href="../../d2/d6/structtagHARDERRORHANDLER.html#o1">pqAttach</a> &gt; 0);
00284         UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a227">gHardErrorHandler</a>.<a class="code" href="../../d2/d6/structtagHARDERRORHANDLER.html#o1">pqAttach</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a864">QF_INDESTROY</a>);
00285 
00286         <a class="code" href="../../d4/d1/userk_8h.html#a1205">FreeQueue</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a227">gHardErrorHandler</a>.<a class="code" href="../../d2/d6/structtagHARDERRORHANDLER.html#o1">pqAttach</a>);
00287         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a227">gHardErrorHandler</a>.<a class="code" href="../../d2/d6/structtagHARDERRORHANDLER.html#o1">pqAttach</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00288     }
00289 
00290     <span class="comment">/*</span>
00291 <span class="comment">     * Free the cached array of queues</span>
00292 <span class="comment">     */</span>
00293     <a class="code" href="../../d4/d1/userk_8h.html#a1206">FreeCachedQueues</a>();
00294 
00295     <span class="comment">/*</span>
00296 <span class="comment">     * cleanup the QEntry lookaside buffer</span>
00297 <span class="comment">     */</span>
00298     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a20">QEntryLookaside</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00299         <a class="code" href="../../d5/d8/ex_8h.html#a251">ExDeletePagedLookasideList</a>(<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a20">QEntryLookaside</a>);
00300         UserFreePool(<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a20">QEntryLookaside</a>);
00301         <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a20">QEntryLookaside</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00302     }
00303 
00304     <span class="comment">/*</span>
00305 <span class="comment">     * Unlock the keyboard layouts</span>
00306 <span class="comment">     */</span>
00307     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a62">gspklBaseLayout</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00308 
00309         <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pkl;
00310         <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pklNext;
00311 
00312         pkl = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a62">gspklBaseLayout</a>-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o1">pklNext</a>;
00313 
00314         <span class="keywordflow">while</span> (pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o1">pklNext</a> != pkl) {
00315             pklNext = pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o1">pklNext</a>;
00316 
00317             <a class="code" href="../../d4/d1/userk_8h.html#a1184">DestroyKL</a>(pkl);
00318 
00319             pkl = pklNext;
00320         }
00321 
00322         UserAssert(pkl == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a62">gspklBaseLayout</a>);
00323 
00324         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a438">HMIsMarkDestroy</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a62">gspklBaseLayout</a>)) {
00325             <a class="code" href="../../d4/d1/userk_8h.html#a971">HMMarkObjectDestroy</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a62">gspklBaseLayout</a>);
00326         }
00327 
00328         <a class="code" href="../../d4/d1/userk_8h.html#a773">HYDRA_HINT</a>(<a class="code" href="../../d4/d1/userk_8h.html#a768">HH_KBDLYOUTGLOBALCLEANUP</a>);
00329 
00330         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a62">gspklBaseLayout</a>)) {
00331             <a class="code" href="../../d4/d1/userk_8h.html#a1184">DestroyKL</a>(pkl);
00332         }
00333     }
00334 
00335     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a245">gpkfList</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00336 
00337     {
00338         <a class="code" href="../../d8/d9/structtagWOWTHREADINFO.html">PWOWTHREADINFO</a> pwti;
00339 
00340         <span class="comment">/*</span>
00341 <span class="comment">         * Cleanup gpwtiFirst list. This list is supposed to be empty</span>
00342 <span class="comment">         * at this point. In one case during stress we hit the case where</span>
00343 <span class="comment">         * it was not empty. The assert is to catch that case in</span>
00344 <span class="comment">         * checked builds.</span>
00345 <span class="comment">         */</span>
00346 
00347         <span class="keywordflow">while</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a27">gpwtiFirst</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00348             pwti = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a27">gpwtiFirst</a>;
00349             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a27">gpwtiFirst</a> = pwti-&gt;<a class="code" href="../../d8/d9/structtagWOWTHREADINFO.html#o0">pwtiNext</a>;
00350             UserFreePool(pwti);
00351         }
00352     }
00353 
00354     <span class="comment">/*</span>
00355 <span class="comment">     * Cleanup cached SMWP array</span>
00356 <span class="comment">     */</span>
00357     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a149">gSMWP</a>.<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00358         UserFreePool(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a149">gSMWP</a>.<a class="code" href="../../d8/d6/structtagSMWP.html#o5">acvr</a>);
00359     }
00360 
00361     <span class="comment">/*</span>
00362 <span class="comment">     * Free gpsdInitWinSta. This is != NULL only if the session didn't</span>
00363 <span class="comment">     * make it to UserInitialize.</span>
00364 <span class="comment">     */</span>
00365     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/kernel_2exitwin_8c.html#a5">gpsdInitWinSta</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00366         UserFreePool(<a class="code" href="../../d1/d0/kernel_2exitwin_8c.html#a5">gpsdInitWinSta</a>);
00367         <a class="code" href="../../d1/d0/kernel_2exitwin_8c.html#a5">gpsdInitWinSta</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00368     }
00369 
00370     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a279">gpHandleFlagsMutex</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00371         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a279">gpHandleFlagsMutex</a>);
00372         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a279">gpHandleFlagsMutex</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00373     }
00374 
00375     <span class="comment">/*</span>
00376 <span class="comment">     * Delete the power request structures.</span>
00377 <span class="comment">     */</span>
00378     <a class="code" href="../../d4/d1/userk_8h.html#a1968">DeletePowerRequestList</a>();
00379 
00380     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00381 
00382     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a278">gpresUser</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00383         <a class="code" href="../../d5/d8/ex_8h.html#a73">ExDeleteResource</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a278">gpresUser</a>);
00384         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a278">gpresUser</a>);
00385         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a278">gpresUser</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00386     }
00387 <span class="preprocessor">#if DBG</span>
00388 <span class="preprocessor"></span>    <span class="comment">/*</span>
00389 <span class="comment">     * Cleanup the global thread lock structures</span>
00390 <span class="comment">     */</span>
00391     <span class="keywordflow">for</span> (i = 0; i &lt; gcThreadLocksArraysAllocated; i++) {
00392         UserFreePool(gpaThreadLocksArrays[i]);
00393         gpaThreadLocksArrays[i] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00394     }
00395 <span class="preprocessor">#endif // DBG</span>
00396 <span class="preprocessor"></span>
00397     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00398 }
00399 
00400 <span class="preprocessor">#if DBG</span>
00401 <span class="preprocessor"></span>
00402 <span class="comment">/***************************************************************************\</span>
00403 <span class="comment">* TrackAddDesktop</span>
00404 <span class="comment">*</span>
00405 <span class="comment">* Track desktops for cleanup purposes</span>
00406 <span class="comment">*</span>
00407 <span class="comment">* History:</span>
00408 <span class="comment">* 04-Dec-1997 clupu     Created.</span>
00409 <span class="comment">\***************************************************************************/</span>
00410 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> TrackAddDesktop(
00411     PVOID pDesktop)
00412 {
00413     PLIST_ENTRY Entry;
00414     PVOID       Atom;
00415 
00416     <a class="code" href="../../d4/d1/userk_8h.html#a777">TRACE_HYDAPI</a>((<span class="stringliteral">"TrackAddDesktop %#p\n"</span>, pDesktop));
00417 
00418     Atom = (PVOID)UserAllocPool(<span class="keyword">sizeof</span>(PVOID) + <span class="keyword">sizeof</span>(LIST_ENTRY),
00419                                 TAG_TRACKDESKTOP);
00420     <span class="keywordflow">if</span> (Atom) {
00421 
00422         *(PVOID*)Atom = pDesktop;
00423 
00424         Entry = (PLIST_ENTRY)(((PCHAR)Atom) + <span class="keyword">sizeof</span>(PVOID));
00425 
00426         InsertTailList(&amp;gDesktopList, Entry);
00427     }
00428 }
00429 
00430 <span class="comment">/***************************************************************************\</span>
00431 <span class="comment">* TrackRemoveDesktop</span>
00432 <span class="comment">*</span>
00433 <span class="comment">* Track desktops for cleanup purposes</span>
00434 <span class="comment">*</span>
00435 <span class="comment">* History:</span>
00436 <span class="comment">* 04-Dec-1997 clupu     Created.</span>
00437 <span class="comment">\***************************************************************************/</span>
00438 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> TrackRemoveDesktop(
00439     PVOID pDesktop)
00440 {
00441     PLIST_ENTRY NextEntry;
00442     PVOID       Atom;
00443 
00444     <a class="code" href="../../d4/d1/userk_8h.html#a777">TRACE_HYDAPI</a>((<span class="stringliteral">"TrackRemoveDesktop %#p\n"</span>, pDesktop));
00445 
00446     NextEntry = gDesktopList.Flink;
00447 
00448     <span class="keywordflow">while</span> (NextEntry != &amp;gDesktopList) {
00449 
00450         Atom = (PVOID)(((PCHAR)NextEntry) - <span class="keyword">sizeof</span>(PVOID));
00451 
00452         <span class="keywordflow">if</span> (pDesktop == *(PVOID*)Atom) {
00453 
00454             RemoveEntryList(NextEntry);
00455 
00456             UserFreePool(Atom);
00457 
00458             <span class="keywordflow">break</span>;
00459         }
00460 
00461         NextEntry = NextEntry-&gt;Flink;
00462     }
00463 }
00464 
00465 <span class="comment">/***************************************************************************\</span>
00466 <span class="comment">* DumpTrackedDesktops</span>
00467 <span class="comment">*</span>
00468 <span class="comment">* Dumps the tracked desktops</span>
00469 <span class="comment">*</span>
00470 <span class="comment">* History:</span>
00471 <span class="comment">* 04-Dec-1997 clupu     Created.</span>
00472 <span class="comment">\***************************************************************************/</span>
00473 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> DumpTrackedDesktops(
00474     BOOL bBreak)
00475 {
00476     PLIST_ENTRY NextEntry;
00477     PVOID       pdesk;
00478     PVOID       Atom;
00479     <span class="keywordtype">int</span>         nAlive = 0;
00480 
00481     <a class="code" href="../../d4/d1/userk_8h.html#a777">TRACE_HYDAPI</a>((<span class="stringliteral">"DumpTrackedDesktops\n"</span>));
00482 
00483     NextEntry = gDesktopList.Flink;
00484 
00485     <span class="keywordflow">while</span> (NextEntry != &amp;gDesktopList) {
00486 
00487         Atom = (PVOID)(((PCHAR)NextEntry) - <span class="keyword">sizeof</span>(PVOID));
00488 
00489         pdesk = *(PVOID*)Atom;
00490 
00491         KdPrint((<span class="stringliteral">"pdesk %#p\n"</span>, pdesk));
00492 
00493         <span class="comment">/*</span>
00494 <span class="comment">         * Restart at the begining of the list since our</span>
00495 <span class="comment">         * entry got deleted</span>
00496 <span class="comment">         */</span>
00497         NextEntry = NextEntry-&gt;Flink;
00498 
00499         nAlive++;
00500     }
00501     <span class="keywordflow">if</span> (bBreak &amp;&amp; nAlive &gt; 0) {
00502         RIPMSG0(RIP_ERROR, <span class="stringliteral">"Desktop objects still around\n"</span>);
00503     }
00504 }
00505 
00506 <span class="preprocessor">#endif // DBG</span>
00507 <span class="preprocessor"></span>
<a name="l00508"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a27">00508</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a27">DestroyRegion</a>(
00509     HRGN* prgn)
00510 {
00511     <span class="keywordflow">if</span> (*prgn != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00512         GreSetRegionOwner(*prgn, OBJECT_OWNER_CURRENT);
00513         GreDeleteObject(*prgn);
00514         *prgn = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00515     }
00516 }
00517 
<a name="l00518"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a28">00518</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a28">DestroyBrush</a>(
00519     HBRUSH* pbr)
00520 {
00521     <span class="keywordflow">if</span> (*pbr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00522         <span class="comment">//GreSetBrushOwner(*pbr, OBJECT_OWNER_CURRENT);</span>
00523         GreDeleteObject(*pbr);
00524         *pbr = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00525     }
00526 }
00527 
<a name="l00528"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a29">00528</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a29">DestroyBitmap</a>(
00529     HBITMAP* pbm)
00530 {
00531     <span class="keywordflow">if</span> (*pbm != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00532         GreSetBitmapOwner(*pbm, OBJECT_OWNER_CURRENT);
00533         GreDeleteObject(*pbm);
00534         *pbm = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00535     }
00536 }
00537 
<a name="l00538"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a30">00538</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a30">DestroyDC</a>(
00539     HDC* phdc)
00540 {
00541     <span class="keywordflow">if</span> (*phdc != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00542         GreSetDCOwner(*phdc, OBJECT_OWNER_CURRENT);
00543         GreDeleteDC(*phdc);
00544         *phdc = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00545     }
00546 }
00547 
<a name="l00548"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a31">00548</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a31">DestroyFont</a>(
00549     HFONT* pfnt)
00550 {
00551     <span class="keywordflow">if</span> (*pfnt != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00552         GreDeleteObject(*pfnt);
00553         *pfnt = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00554     }
00555 }
00556 
00557 <span class="comment">/***************************************************************************\</span>
00558 <span class="comment">* CleanupGDI</span>
00559 <span class="comment">*</span>
00560 <span class="comment">* Cleanup all the GDI global objects used in USERK</span>
00561 <span class="comment">*</span>
00562 <span class="comment">* History:</span>
00563 <span class="comment">* 29-Jan-1998 clupu     Created.</span>
00564 <span class="comment">\***************************************************************************/</span>
<a name="l00565"></a><a class="code" href="../../d4/d1/userk_8h.html#a1207">00565</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1207">CleanupGDI</a>(
00566     VOID)
00567 {
00568     <span class="keywordtype">int</span> i;
00569 
00570     <span class="comment">/*</span>
00571 <span class="comment">     * Free gpDispInfo stuff</span>
00572 <span class="comment">     */</span>
00573     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a30">DestroyDC</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o3">hdcScreen</a>);
00574     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a30">DestroyDC</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o4">hdcBits</a>);
00575     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a30">DestroyDC</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o5">hdcGray</a>);
00576     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a30">DestroyDC</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>);
00577     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a30">DestroyDC</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a193">ghdcMem2</a>);
00578     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a30">DestroyDC</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a40">gfade</a>.<a class="code" href="../../d0/d5/structtagFADE.html#o1">hdc</a>);
00579 
00580     <span class="comment">/*</span>
00581 <span class="comment">     * Free the cache DC stuff before the GRE cleanup.</span>
00582 <span class="comment">     * Also notice that we call DelayedDestroyCacheDC which</span>
00583 <span class="comment">     * we usualy call from DestroyProcessInfo. We do it</span>
00584 <span class="comment">     * here because this is the last WIN32 thread.</span>
00585 <span class="comment">     */</span>
00586     <a class="code" href="../../d4/d1/userk_8h.html#a1553">DestroyCacheDCEntries</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
00587     <a class="code" href="../../d4/d1/userk_8h.html#a1553">DestroyCacheDCEntries</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00588     <a class="code" href="../../d4/d1/userk_8h.html#a1705">DelayedDestroyCacheDC</a>();
00589 
00590     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00591 
00592     <span class="comment">/*</span>
00593 <span class="comment">     * Free bitmaps</span>
00594 <span class="comment">     */</span>
00595     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a29">DestroyBitmap</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o6">hbmGray</a>);
00596     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a29">DestroyBitmap</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a130">ghbmBits</a>);
00597     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a29">DestroyBitmap</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a131">ghbmCaption</a>);
00598 
00599     <span class="comment">/*</span>
00600 <span class="comment">     * Cleanup brushes</span>
00601 <span class="comment">     */</span>
00602     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a28">DestroyBrush</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a129">ghbrHungApp</a>);
00603     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a28">DestroyBrush</a>(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;hbrGray);
00604     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a28">DestroyBrush</a>(&amp;<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1134">ghbrWhite</a>);
00605     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a28">DestroyBrush</a>(&amp;<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1135">ghbrBlack</a>);
00606 
00607     <span class="keywordflow">for</span> (i = 0; i &lt; COLOR_MAX; i++) {
00608         <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a28">DestroyBrush</a>(&amp;(<a class="code" href="../../d1/d0/inc_2user_8h.html#a15">SYSHBRUSH</a>(i)));
00609     }
00610 
00611     <span class="comment">/*</span>
00612 <span class="comment">     * Cleanup regions</span>
00613 <span class="comment">     */</span>
00614     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a27">DestroyRegion</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o15">hrgnScreen</a>);
00615     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a27">DestroyRegion</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a183">ghrgnInvalidSum</a>);
00616     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a27">DestroyRegion</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a184">ghrgnVisNew</a>);
00617     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a27">DestroyRegion</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a185">ghrgnSWP1</a>);
00618     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a27">DestroyRegion</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a186">ghrgnValid</a>);
00619     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a27">DestroyRegion</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a187">ghrgnValidSum</a>);
00620     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a27">DestroyRegion</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a188">ghrgnInvalid</a>);
00621     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a27">DestroyRegion</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a189">ghrgnInv0</a>);
00622     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a27">DestroyRegion</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a190">ghrgnInv1</a>);
00623     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a27">DestroyRegion</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a191">ghrgnInv2</a>);
00624     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a27">DestroyRegion</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a194">ghrgnGDC</a>);
00625     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a27">DestroyRegion</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a195">ghrgnSCR</a>);
00626     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a27">DestroyRegion</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a196">ghrgnSPB1</a>);
00627     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a27">DestroyRegion</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a197">ghrgnSPB2</a>);
00628     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a27">DestroyRegion</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a198">ghrgnSW</a>);
00629     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a27">DestroyRegion</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a199">ghrgnScrl1</a>);
00630     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a27">DestroyRegion</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a200">ghrgnScrl2</a>);
00631     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a27">DestroyRegion</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a201">ghrgnScrlVis</a>);
00632     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a27">DestroyRegion</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a202">ghrgnScrlSrc</a>);
00633     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a27">DestroyRegion</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a203">ghrgnScrlDst</a>);
00634     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a27">DestroyRegion</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a204">ghrgnScrlValid</a>);
00635 
00636     <span class="comment">/*</span>
00637 <span class="comment">     * Cleanup fonts</span>
00638 <span class="comment">     */</span>
00639     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a31">DestroyFont</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a134">ghSmCaptionFont</a>);
00640     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a31">DestroyFont</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a137">ghMenuFont</a>);
00641     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a31">DestroyFont</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a138">ghMenuFontDef</a>);
00642     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a31">DestroyFont</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a147">ghStatusFont</a>);
00643     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a31">DestroyFont</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a148">ghIconFont</a>);
00644     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a31">DestroyFont</a>(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a28">ghFontSys</a>);
00645 
00646     <span class="comment">/*</span>
00647 <span class="comment">     * wallpaper stuff.</span>
00648 <span class="comment">     */</span>
00649     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a2">ghpalWallpaper</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00650         GreSetPaletteOwner(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a2">ghpalWallpaper</a>, OBJECT_OWNER_CURRENT);
00651         GreDeleteObject(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a2">ghpalWallpaper</a>);
00652         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a2">ghpalWallpaper</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00653     }
00654     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a29">DestroyBitmap</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a1">ghbmWallpaper</a>);
00655 
00656     <span class="comment">/*</span>
00657 <span class="comment">     * Unload the video driver</span>
00658 <span class="comment">     */</span>
00659     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>) {
00660         DrvDestroyMDEV(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>);
00661         GreFreePool(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>);
00662         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00663         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00664     }
00665 
00666     <span class="comment">/*</span>
00667 <span class="comment">     * Free the monitor stuff</span>
00668 <span class="comment">     */</span>
00669     {
00670         <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a> pMonitor;
00671         <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a> pMonitorNext;
00672 
00673         pMonitor = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o13">pMonitorFirst</a>;
00674 
00675         <span class="keywordflow">while</span> (pMonitor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00676             pMonitorNext = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o1">pMonitorNext</a>;
00677             <a class="code" href="../../d4/d1/userk_8h.html#a2079">DestroyMonitor</a>(pMonitor);
00678             pMonitor = pMonitorNext;
00679         }
00680 
00681         UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o13">pMonitorFirst</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00682 
00683         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a16">gpMonitorCached</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00684             <a class="code" href="../../d4/d1/userk_8h.html#a2079">DestroyMonitor</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a16">gpMonitorCached</a>);
00685         }
00686     }
00687 }
00688 
00689 
00690 <span class="comment">/***************************************************************************\</span>
00691 <span class="comment">*   DestroyHandleTableObjects</span>
00692 <span class="comment">*</span>
00693 <span class="comment">*   Destroy any object still in the handle table.</span>
00694 <span class="comment">*</span>
00695 <span class="comment">\***************************************************************************/</span>
<a name="l00696"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a33">00696</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a33">DestroyHandleTableObjects</a>(VOID)
00697 {
00698     <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">HANDLEENTRY</a> <span class="keyword">volatile</span> * (*pphe);
00699     <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a>         pheT;
00700     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       i;
00701 
00702     <span class="comment">/*</span>
00703 <span class="comment">     * Make sure the handle table was created !</span>
00704 <span class="comment">     */</span>
00705     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00706         <span class="keywordflow">return</span>;
00707     }
00708 
00709     <span class="comment">/*</span>
00710 <span class="comment">     * Loop through the table destroying all remaining objects.</span>
00711 <span class="comment">     */</span>
00712     pphe = &amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>;
00713 
00714     <span class="keywordflow">for</span> (i = 0; i &lt;= <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a308">giheLast</a>; i++) {
00715 
00716         pheT = (<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a>)((*pphe) + i);
00717 
00718         <span class="keywordflow">if</span> (pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a236">TYPE_FREE</a>)
00719             <span class="keywordflow">continue</span>;
00720 
00721         UserAssert(!(<a class="code" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a241">gahti</a>[pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a>].bObjectCreateFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a414">OCF_PROCESSOWNED</a>) &amp;&amp;
00722                    !(<a class="code" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a241">gahti</a>[pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a>].bObjectCreateFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a413">OCF_THREADOWNED</a>));
00723 
00724         UserAssert(!(pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o3">bFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a421">HANDLEF_DESTROY</a>));
00725 
00726         <span class="comment">/*</span>
00727 <span class="comment">         * Destroy the object.</span>
00728 <span class="comment">         */</span>
00729         <span class="keywordflow">if</span> (pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a>-&gt;<a class="code" href="../../d4/d5/struct__HEAD.html#o1">cLockObj</a> &gt; 0) {
00730 
00731             RIPMSG1(RIP_ERROR, <span class="stringliteral">"pheT %#p still locked !"</span>, pheT);
00732 
00733             <span class="comment">/*</span>
00734 <span class="comment">             * We're going to die, why bothered by the lock count?</span>
00735 <span class="comment">             * We're forcing the lockcount to 0, and call the destroy routine.</span>
00736 <span class="comment">             */</span>
00737             pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a>-&gt;<a class="code" href="../../d4/d5/struct__HEAD.html#o1">cLockObj</a> = 0;
00738         }
00739         <a class="code" href="../../d4/d1/userk_8h.html#a977">HMDestroyUnlockedObject</a>(pheT);
00740         UserAssert(pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a236">TYPE_FREE</a>);
00741     }
00742 }
00743 
00744 <span class="comment">/***************************************************************************\</span>
00745 <span class="comment">* Win32KDriverUnload</span>
00746 <span class="comment">*</span>
00747 <span class="comment">*     Exit point for win32k.sys</span>
00748 <span class="comment">*</span>
00749 <span class="comment">\***************************************************************************/</span>
00750 <span class="preprocessor">#ifdef TRACE_MAP_VIEWS</span>
00751 <span class="preprocessor"></span>    <span class="keyword">extern</span> PWin32Section gpSections;
00752 <span class="preprocessor">#endif // TRACE_MAP_VIEWS;</span>
00753 <span class="preprocessor"></span>
00754 <span class="preprocessor">#if DBG</span>
00755 <span class="preprocessor"></span>ULONG DriverUnloadExceptionHandler(PEXCEPTION_POINTERS pexi)
00756 {
00757     KdPrint((<span class="stringliteral">"\nEXCEPTION IN Win32kDriverUnload !!!\n\n"</span>
00758              <span class="stringliteral">"Exception:  %#x\n"</span>
00759              <span class="stringliteral">"at address: %#p\n"</span>
00760              <span class="stringliteral">"flags:      %#x\n\n"</span>
00761              <span class="stringliteral">"!exr %#p\n"</span>
00762              <span class="stringliteral">"!cxr %#p\n\n"</span>,
00763              pexi-&gt;ExceptionRecord-&gt;ExceptionCode,
00764              CONTEXT_TO_PROGRAM_COUNTER(pexi-&gt;ContextRecord),
00765              pexi-&gt;ExceptionRecord-&gt;ExceptionFlags,
00766              pexi-&gt;ExceptionRecord,
00767              pexi-&gt;ContextRecord));
00768 
00769     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>;
00770 }
00771 <span class="preprocessor">#endif // DBG</span>
00772 <span class="preprocessor"></span>
<a name="l00773"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a34">00773</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a34">Win32KDriverUnload</a>(
00774     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject)
00775 {
00776     <a class="code" href="../../d4/d1/userk_8h.html#a777">TRACE_HYDAPI</a>((<span class="stringliteral">"Win32KDriverUnload\n"</span>));
00777 
00778 <span class="preprocessor">#if DBG</span>
00779 <span class="preprocessor"></span>    <span class="comment">/*</span>
00780 <span class="comment">     * Have a try/except around the driver unload code to catch</span>
00781 <span class="comment">     * bugs. We need to do this because NtSetSystemInformation which</span>
00782 <span class="comment">     * smss calls has a try/except when calling the driver entry and</span>
00783 <span class="comment">     * the driver unload routines which does nothing but returns the</span>
00784 <span class="comment">     * status code to the caller and doesn't break in the debugger!</span>
00785 <span class="comment">     * So w/o this try/except here we wouldn't even know we hit</span>
00786 <span class="comment">     * an AV !!!</span>
00787 <span class="comment">     */</span>
00788     <span class="keywordflow">try</span> {
00789 <span class="preprocessor">#endif // DBG</span>
00790 <span class="preprocessor"></span>
00791     <a class="code" href="../../d4/d1/userk_8h.html#a773">HYDRA_HINT</a>(<a class="code" href="../../d4/d1/userk_8h.html#a760">HH_DRIVERUNLOAD</a>);
00792 
00793     <span class="comment">/*</span>
00794 <span class="comment">     * Cleanup all resources in GRE</span>
00795 <span class="comment">     */</span>
00796     MultiUserNtGreCleanup();
00797 
00798     <a class="code" href="../../d4/d1/userk_8h.html#a773">HYDRA_HINT</a>(<a class="code" href="../../d4/d1/userk_8h.html#a761">HH_GRECLEANUP</a>);
00799 
00800     <span class="comment">/*</span>
00801 <span class="comment">     * BUG 305965. There might be cases when we end up with DCEs still</span>
00802 <span class="comment">     * in the list. Go ahead and clean it up here.</span>
00803 <span class="comment">     */</span>
00804     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00805 
00806         <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a> pdce;
00807         <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a> pdceNext;
00808 
00809         RIPMSG0(RIP_ERROR, <span class="stringliteral">"Win32KDriverUnload: the DCE list is not empty !"</span>);
00810 
00811         pdce = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a>;
00812 
00813         <span class="keywordflow">while</span> (pdce != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00814             pdceNext = pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o0">pdceNext</a>;
00815 
00816             UserFreePool(pdce);
00817 
00818             pdce = pdceNext;
00819         }
00820         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00821     }
00822 
00823     <span class="comment">/*</span>
00824 <span class="comment">     * Cleanup all resources in ntuser</span>
00825 <span class="comment">     */</span>
00826     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a21">Win32kNtUserCleanup</a>();
00827 
00828     <span class="comment">/*</span>
00829 <span class="comment">     * Cleanup the handle table for any object that is neither process</span>
00830 <span class="comment">     * owned nor thread owned</span>
00831 <span class="comment">     */</span>
00832     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a33">DestroyHandleTableObjects</a>();
00833 
00834 
00835     <a class="code" href="../../d4/d1/userk_8h.html#a773">HYDRA_HINT</a>(<a class="code" href="../../d4/d1/userk_8h.html#a762">HH_USERKCLEANUP</a>);
00836 
00837 <span class="preprocessor">#if DBG</span>
00838 <span class="preprocessor"></span>    HMCleanUpHandleTable();
00839 <span class="preprocessor">#endif</span>
00840 <span class="preprocessor"></span>
00841     <span class="comment">/*</span>
00842 <span class="comment">     * Free the handle page array</span>
00843 <span class="comment">     */</span>
00844 
00845     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/handtabl_8c.html#a8">gpHandlePages</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00846         UserFreePool(<a class="code" href="../../d4/d8/handtabl_8c.html#a8">gpHandlePages</a>);
00847         <a class="code" href="../../d4/d8/handtabl_8c.html#a8">gpHandlePages</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00848     }
00849 
00850     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a243">CsrApiPort</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00851         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a243">CsrApiPort</a>);
00852         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a243">CsrApiPort</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00853     }
00854 
00855     <span class="comment">/*</span>
00856 <span class="comment">     * destroy the shared memory</span>
00857 <span class="comment">     */</span>
00858     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a320">ghSectionShared</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00859 
00860         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00861 
00862         <span class="comment">/*</span>
00863 <span class="comment">         * Set gpsi to NULL</span>
00864 <span class="comment">         */</span>
00865         <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00866 
00867         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a321">gpvSharedBase</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00868             Win32HeapDestroy(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a322">gpvSharedAlloc</a>);
00869             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = Win32UnmapViewInSessionSpace(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a321">gpvSharedBase</a>);
00870             UserAssert(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00871         }
00872         Win32DestroySection(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a320">ghSectionShared</a>);
00873     }
00874 
00875     CleanupWin32HeapStubs();
00876 
00877 <span class="preprocessor">#ifdef TRACE_MAP_VIEWS</span>
00878 <span class="preprocessor"></span><span class="preprocessor">#if DBG</span>
00879 <span class="preprocessor"></span>    UserAssert(gpSections == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00880 <span class="preprocessor">#else</span>
00881 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (gpSections != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00882         DbgBreakPoint();
00883     }
00884 <span class="preprocessor">#endif // DBG</span>
00885 <span class="preprocessor"></span><span class="preprocessor">#endif // TRACE_MAP_VIEWS</span>
00886 <span class="preprocessor"></span>
00887     <span class="comment">/*</span>
00888 <span class="comment">     * Cleanup all the user pool allocations by hand</span>
00889 <span class="comment">     */</span>
00890     <a class="code" href="../../d4/d1/userk_8h.html#a218">CleanupPoolAllocations</a>();
00891 
00892     <a class="code" href="../../d4/d1/userk_8h.html#a220">CleanUpPoolLimitations</a>();
00893     <a class="code" href="../../d4/d1/userk_8h.html#a222">CleanUpSections</a>();
00894 
00895     <span class="comment">/*</span>
00896 <span class="comment">     * Cleanup W32 structures.</span>
00897 <span class="comment">     */</span>
00898     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a18">gpW32FastMutex</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00899         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a18">gpW32FastMutex</a>);
00900         <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a18">gpW32FastMutex</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00901     }
00902 
00903 <span class="preprocessor">#if DBG</span>
00904 <span class="preprocessor"></span>    } except (DriverUnloadExceptionHandler(GetExceptionInformation())) {
00905         DbgBreakPoint();
00906     }
00907 <span class="preprocessor">#endif // DBG</span>
00908 <span class="preprocessor"></span>
00909     <span class="keywordflow">return</span>;
00910     UNREFERENCED_PARAMETER(DriverObject);
00911 }
00912 
00913 <span class="comment">/***************************************************************************\</span>
00914 <span class="comment">* DriverEntry</span>
00915 <span class="comment">*</span>
00916 <span class="comment">* Entry point needed to initialize win32k.sys</span>
00917 <span class="comment">*</span>
00918 <span class="comment">\***************************************************************************/</span>
00919 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a22">DriverEntry</a>(
00920     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject,
00921     IN PUNICODE_STRING RegistryPath)
00922 {
00923     PVOID             countTable;
00924     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>          <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00925     OBJECT_ATTRIBUTES obja;
00926     UNICODE_STRING    strName;
00927     HANDLE            hEventFirstSession;
00928 
00929     <a class="code" href="../../d4/d1/userk_8h.html#a773">HYDRA_HINT</a>(HH_DRIVERENTRY);
00930 
00931     <span class="comment">/*</span>
00932 <span class="comment">     * Find out if this is a remote session</span>
00933 <span class="comment">     */</span>
00934     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strName, L<span class="stringliteral">"\\UniqueSessionIdEvent"</span>);
00935 
00936     InitializeObjectAttributes(&amp;obja,
00937                                &amp;strName,
00938                                OBJ_CASE_INSENSITIVE,
00939                                NULL,
00940                                NULL);
00941 
00942     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwCreateEvent(&amp;hEventFirstSession,
00943                            EVENT_ALL_ACCESS,
00944                            &amp;obja,
00945                            SynchronizationEvent,
00946                            FALSE);
00947 
00948     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_OBJECT_NAME_EXISTS ||
00949         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_OBJECT_NAME_COLLISION) {
00950 
00951         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00952     } <span class="keywordflow">else</span> {
00953         UserAssert(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
00954         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00955     }
00956 
00957     <span class="comment">/*</span>
00958 <span class="comment">     * Set the unload address</span>
00959 <span class="comment">     */</span>
00960     DriverObject-&gt;DriverUnload = <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a34">Win32KDriverUnload</a>;
00961 
00962     <span class="comment">/*</span>
00963 <span class="comment">     * Initialize data used for the timers.  We want to do this really early,</span>
00964 <span class="comment">     * before any Win32 Timer will be created.  We need to be very careful to</span>
00965 <span class="comment">     * not do anything that will need Win32 initialized yet.</span>
00966 <span class="comment">     */</span>
00967 
00968     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a250">gcmsLastTimer</a> = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>();
00969 
00970     <span class="comment">/*</span>
00971 <span class="comment">     * Initialize the Win32 structures. We need to do this before we create</span>
00972 <span class="comment">     * any threads.</span>
00973 <span class="comment">     */</span>
00974     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a18">gpW32FastMutex</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(NonPagedPool,
00975                                            <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a>),
00976                                            TAG_SYSTEM);
00977     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a18">gpW32FastMutex</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00978         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00979         <span class="keywordflow">goto</span> Failure;
00980     }
00981     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(gpW32FastMutex);
00982 
00983     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>)
00984         <span class="keywordflow">goto</span> executeAlsoForRemote;
00985 
00986 <span class="preprocessor">#if !DBG</span>
00987 <span class="preprocessor"></span>    countTable = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00988 <span class="preprocessor">#else</span>
00989 <span class="preprocessor"></span>
00990     <span class="comment">/*</span>
00991 <span class="comment">     * Allocate and zero the system service count table.</span>
00992 <span class="comment">     * Do not use UserAllocPool for this one !</span>
00993 <span class="comment">     */</span>
00994     countTable = (PULONG)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(NonPagedPool,
00995                                                W32pServiceLimit * <span class="keyword">sizeof</span>(ULONG),
00996                                                'llac');
00997     <span class="keywordflow">if</span> (countTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00998         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00999         <span class="keywordflow">goto</span> Failure;
01000     }
01001 
01002     RtlZeroMemory(countTable, W32pServiceLimit * <span class="keyword">sizeof</span>(ULONG));
01003 <span class="preprocessor">#endif  // #else DBG</span>
01004 <span class="preprocessor"></span>
01005     <span class="comment">/*</span>
01006 <span class="comment">     * We only establish the system entry table once for the</span>
01007 <span class="comment">     * whole system, even though WIN32K.SYS is instanced on a winstation</span>
01008 <span class="comment">     * basis. This is because the VM changes assure that all loads of</span>
01009 <span class="comment">     * WIN32K.SYS are at the exact same address, even if a fixup had</span>
01010 <span class="comment">     * to occur.</span>
01011 <span class="comment">     */</span>
01012     UserVerify(<a class="code" href="../../d7/d0/ke_2miscc_8c.html#a11">KeAddSystemServiceTable</a>(W32pServiceTable,
01013                                        countTable,
01014                                        W32pServiceLimit,
01015                                        W32pArgumentTable,
01016                                        W32_SERVICE_NUMBER));
01017 
01018     <span class="comment">/*</span>
01019 <span class="comment">     * Initialize the critical section before establishing the callouts so</span>
01020 <span class="comment">     *  we can assume that it's always valid</span>
01021 <span class="comment">     */</span>
01022     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1263">InitCreateUserCrit</a>()) {
01023         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
01024         <span class="keywordflow">goto</span> Failure;
01025     }
01026 
01027     <a class="code" href="../../d9/d1/psquery_8c.html#a23">PsEstablishWin32Callouts</a>(W32pProcessCallout,
01028                              W32pThreadCallout,
01029                              UserGlobalAtomTableCallout,
01030                              UserPowerEventCallout,
01031                              UserPowerStateCallout,
01032                              UserJobCallout,
01033                              (PVOID)NtGdiFlushUserBatch);
01034 
01035 executeAlsoForRemote:
01036 
01037     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>) {
01038 
01039         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1263">InitCreateUserCrit</a>()) {
01040             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
01041             <span class="keywordflow">goto</span> Failure;
01042         }
01043     }
01044 
01045     <a class="code" href="../../d4/d1/userk_8h.html#a221">InitSectionTrace</a>();
01046 
01047     InitWin32HeapStubs();
01048 
01049     <span class="comment">/*</span>
01050 <span class="comment">     * Initialize pool limitation array.</span>
01051 <span class="comment">     */</span>
01052     <a class="code" href="../../d4/d1/userk_8h.html#a219">InitPoolLimitations</a>();
01053 
01054 <span class="preprocessor">#if defined(_X86_)</span>
01055 <span class="preprocessor"></span>    <span class="comment">/*</span>
01056 <span class="comment">     * Keep our own copy of this to avoid double indirections on probing</span>
01057 <span class="comment">     */</span>
01058     Win32UserProbeAddress = *<a class="code" href="../../d0/d9/miglobal_8c.html#a2">MmUserProbeAddress</a>;
01059 <span class="preprocessor">#endif</span>
01060 <span class="preprocessor"></span>
01061     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a> = <a class="code" href="../../d8/d8/sysload_8c.html#a56">MmPageEntireDriver</a>(DriverEntry)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01062         RIPMSG0(RIP_WARNING, <span class="stringliteral">"MmPageEntireDriver failed"</span>);
01063         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
01064         <span class="keywordflow">goto</span> Failure;
01065     }
01066 
01067 <span class="preprocessor">#if DBG</span>
01068 <span class="preprocessor"></span>    <span class="comment">/*</span>
01069 <span class="comment">     * Initialize the desktop tracking list</span>
01070 <span class="comment">     */</span>
01071     InitializeListHead(&amp;gDesktopList);
01072     <span class="comment">/*</span>
01073 <span class="comment">     * Initialize the gpaThreadLocksArray mechanism</span>
01074 <span class="comment">     */</span>
01075     gFreeTLList = gpaThreadLocksArrays[gcThreadLocksArraysAllocated] =
01076     UserAllocPoolZInit(<span class="keyword">sizeof</span>(<a class="code" href="../../d5/d1/struct__TL.html">TL</a>)*MAX_THREAD_LOCKS, TAG_GLOBALTHREADLOCK);
01077     <span class="keywordflow">if</span> (gFreeTLList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01078         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
01079         <span class="keywordflow">goto</span> Failure;
01080     }
01081     InitGlobalThreadLockArray(0);
01082     gcThreadLocksArraysAllocated = 1;
01083 <span class="preprocessor">#endif // DBG</span>
01084 <span class="preprocessor"></span>
01085     <span class="keywordflow">if</span> (!InitializeGre()) {
01086         RIPMSG0(RIP_WARNING, <span class="stringliteral">"InitializeGre failed"</span>);
01087         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
01088         <span class="keywordflow">goto</span> Failure;
01089     }
01090 
01091     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d6/kernel_2server_8c.html#a59">Win32UserInitialize</a>();
01092 
01093     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01094         RIPMSG1(RIP_WARNING, <span class="stringliteral">"Win32UserInitialize failed with Status %x"</span>,
01095                 Status);
01096         <span class="keywordflow">goto</span> Failure;
01097     }
01098 
01099     <span class="keywordflow">return</span> STATUS_SUCCESS;
01100 
01101 Failure:
01102 
01103     RIPMSG1(RIP_WARNING, <span class="stringliteral">"Initialization of WIN32K.SYS failed with Status = 0x%x!!!"</span>,
01104             Status);
01105 
01106     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a34">Win32KDriverUnload</a>(NULL);
01107     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01108 
01109     UNREFERENCED_PARAMETER(RegistryPath);
01110 }
01111 
01112 <span class="comment">/***************************************************************************\</span>
01113 <span class="comment">* xxxAddFontResourceW</span>
01114 <span class="comment">*</span>
01115 <span class="comment">*</span>
01116 <span class="comment">* History:</span>
01117 <span class="comment">\***************************************************************************/</span>
01118 
<a name="l01119"></a><a class="code" href="../../d4/d1/userk_8h.html#a1851">01119</a> <span class="keywordtype">int</span> <a class="code" href="../../d4/d1/userk_8h.html#a1851">xxxAddFontResourceW</a>(
01120     LPWSTR lpFile,
01121     FLONG  flags,
01122     DESIGNVECTOR *pdv)
01123 {
01124     UNICODE_STRING strFile;
01125 
01126     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strFile, lpFile);
01127 
01128     <span class="comment">/*</span>
01129 <span class="comment">     * Callbacks leave the critsec, so make sure that we're in it.</span>
01130 <span class="comment">     */</span>
01131 
01132     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1010">xxxClientAddFontResourceW</a>(&amp;strFile, flags, pdv);
01133 }
01134 
01135 <span class="comment">/***************************************************************************\</span>
01136 <span class="comment">* LW_DriversInit</span>
01137 <span class="comment">*</span>
01138 <span class="comment">*</span>
01139 <span class="comment">* History:</span>
01140 <span class="comment">\***************************************************************************/</span>
01141 
<a name="l01142"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a36">01142</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a36">LW_DriversInit</a>(VOID)
01143 {
01144     <span class="comment">/*</span>
01145 <span class="comment">     * Initialize the keyboard typematic rate.</span>
01146 <span class="comment">     */</span>
01147     <a class="code" href="../../d4/d1/userk_8h.html#a1176">SetKeyboardRate</a>((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a97">gnKeyboardSpeed</a>);
01148 
01149     <span class="comment">/*</span>
01150 <span class="comment">     * Adjust VK modification table if not default (type 4) kbd.</span>
01151 <span class="comment">     */</span>
01152     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a214">gKeyboardInfo</a>.KeyboardIdentifier.Type == 3)
01153         <a class="code" href="../../d7/d8/kbd_8c.html#a13">gapulCvt_VK</a> = <a class="code" href="../../d7/d8/kbd_8c.html#a11">gapulCvt_VK_84</a>;
01154 
01155     <span class="comment">/*</span>
01156 <span class="comment">     * Adjust VK modification table for IBM 5576 002/003 keyboard.</span>
01157 <span class="comment">     */</span>
01158     <span class="keywordflow">if</span> (JAPANESE_KEYBOARD(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a214">gKeyboardInfo</a>.KeyboardIdentifier) &amp;&amp;
01159         (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a214">gKeyboardInfo</a>.KeyboardIdentifier.Subtype == 3))
01160         <a class="code" href="../../d7/d8/kbd_8c.html#a13">gapulCvt_VK</a> = <a class="code" href="../../d7/d8/kbd_8c.html#a12">gapulCvt_VK_IBM02</a>;
01161 
01162     <span class="comment">/*</span>
01163 <span class="comment">     * Initialize NLS keyboard globals.</span>
01164 <span class="comment">     */</span>
01165     <a class="code" href="../../d4/d2/fekbd_8c.html#a46">NlsKbdInitializePerSystem</a>();
01166 }
01167 
01168 <span class="comment">/***************************************************************************\</span>
01169 <span class="comment">* LoadCPUserPreferences</span>
01170 <span class="comment">*</span>
01171 <span class="comment">* 06/07/96  GerardoB  Created</span>
01172 <span class="comment">\***************************************************************************/</span>
<a name="l01173"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a37">01173</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a37">LoadCPUserPreferences</a>(PUNICODE_STRING pProfileUserName)
01174 {
01175     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> pdwValue [SPI_BOOLMASKDWORDSIZE];
01176     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dw;
01177     <a class="code" href="../../d9/d3/structtagPROFILEVALUEINFO.html">PPROFILEVALUEINFO</a> <a class="code" href="../../d4/d5/rare_8c.html#a6">ppvi</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a151">gpviCPUserPreferences</a>;
01178 
01179     UserAssert(1 + SPI_DWORDRANGECOUNT == <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a151">gpviCPUserPreferences</a>) / <span class="keyword">sizeof</span>(*<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a151">gpviCPUserPreferences</a>));
01180 
01181     <span class="comment">/*</span>
01182 <span class="comment">     * The first value in gpviCPUserPreferences corresponds to the bit mask</span>
01183 <span class="comment">     */</span>
01184     dw =  <a class="code" href="../../d4/d1/userk_8h.html#a2013">FastGetProfileValue</a>(pProfileUserName,
01185             <a class="code" href="../../d4/d5/rare_8c.html#a6">ppvi</a>-&gt;uSection,
01186             <a class="code" href="../../d4/d5/rare_8c.html#a6">ppvi</a>-&gt;pwszKeyName,
01187             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01188             (LPBYTE)pdwValue,
01189             <span class="keyword">sizeof</span>(*pdwValue)
01190             );
01191 
01192     <span class="comment">/*</span>
01193 <span class="comment">     * Copy only the amount of data read and no more than what we expect</span>
01194 <span class="comment">     */</span>
01195     <span class="keywordflow">if</span> (dw != 0) {
01196         <span class="keywordflow">if</span> (dw &gt; <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a150">gpdwCPUserPreferencesMask</a>)) {
01197             dw = <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a150">gpdwCPUserPreferencesMask</a>);
01198         }
01199         RtlCopyMemory(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a150">gpdwCPUserPreferencesMask</a>, pdwValue, dw);
01200     }
01201 
01202     <a class="code" href="../../d4/d5/rare_8c.html#a6">ppvi</a>++;
01203 
01204     <span class="comment">/*</span>
01205 <span class="comment">     * DWORD values</span>
01206 <span class="comment">     */</span>
01207     <span class="keywordflow">for</span> (dw = 1; dw &lt; 1 + SPI_DWORDRANGECOUNT; dw++, <a class="code" href="../../d4/d5/rare_8c.html#a6">ppvi</a>++) {
01208         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a2013">FastGetProfileValue</a>(pProfileUserName,
01209                 <a class="code" href="../../d4/d5/rare_8c.html#a6">ppvi</a>-&gt;uSection,
01210                 <a class="code" href="../../d4/d5/rare_8c.html#a6">ppvi</a>-&gt;pwszKeyName,
01211                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01212                 (LPBYTE)pdwValue,
01213                 <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)
01214                 )) {
01215 
01216             <a class="code" href="../../d4/d5/rare_8c.html#a6">ppvi</a>-&gt;dwValue = *pdwValue;
01217         }
01218     }
01219 
01220     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>) {
01221 
01222         <span class="comment">/*</span>
01223 <span class="comment">         * Default is w/o UIEFFECTS for remote connections</span>
01224 <span class="comment">         */</span>
01225         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a150">gpdwCPUserPreferencesMask</a>[0] &amp;= ~0x80000000;
01226     }
01227 
01228     <span class="comment">/*</span>
01229 <span class="comment">     * Propagate gpsi flags</span>
01230 <span class="comment">     */</span>
01231     <a class="code" href="../../d4/d1/userk_8h.html#a569">PropagetUPBOOLTogpsi</a>(COMBOBOXANIMATION);
01232     <a class="code" href="../../d4/d1/userk_8h.html#a569">PropagetUPBOOLTogpsi</a>(LISTBOXSMOOTHSCROLLING);
01233     <a class="code" href="../../d4/d1/userk_8h.html#a569">PropagetUPBOOLTogpsi</a>(KEYBOARDCUES);
01234     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;bKeyboardPref = <a class="code" href="../../d4/d1/userk_8h.html#a652">TEST_BOOL_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a637">ACCF_KEYBOARDPREF</a>);
01235 
01236     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;uCaretWidth = <a class="code" href="../../d4/d1/userk_8h.html#a743">UP</a>(CARETWIDTH);
01237 
01238     <a class="code" href="../../d4/d1/userk_8h.html#a569">PropagetUPBOOLTogpsi</a>(UIEFFECTS);
01239 
01240     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a61">EnforceColorDependentSettings</a>();
01241 
01242     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01243 }
01244 
01245 <span class="comment">/***************************************************************************\</span>
01246 <span class="comment">* LW_LoadProfileInitData</span>
01247 <span class="comment">*</span>
01248 <span class="comment">* Only stuff that gets initialized at boot should go here. Per user settings</span>
01249 <span class="comment">* should be initialized in xxxUpdatePerUserSystemParameters.</span>
01250 <span class="comment">*</span>
01251 <span class="comment">* History:</span>
01252 <span class="comment">\***************************************************************************/</span>
<a name="l01253"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a38">01253</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1837">LW_LoadProfileInitData</a>(PUNICODE_STRING pProfileUserName)
01254 {
01255     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a125">guDdeSendTimeout</a> = <a class="code" href="../../d4/d1/userk_8h.html#a2010">FastGetProfileIntFromID</a>(pProfileUserName,
01256                                                <a class="code" href="../../d4/d1/userk_8h.html#a696">PMAP_WINDOWSM</a>,
01257                                                STR_DDESENDTIMEOUT,
01258                                                0);
01259 }
01260 
01261 <span class="comment">/***************************************************************************\</span>
01262 <span class="comment">* LW_LoadResources</span>
01263 <span class="comment">*</span>
01264 <span class="comment">*</span>
01265 <span class="comment">* History:</span>
01266 <span class="comment">\***************************************************************************/</span>
01267 
<a name="l01268"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a39">01268</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a39">LW_LoadResources</a>(PUNICODE_STRING pProfileUserName)
01269 {
01270     WCHAR rgch[4];
01271 
01272     <span class="comment">/*</span>
01273 <span class="comment">     * See if the Mouse buttons need swapping.</span>
01274 <span class="comment">     */</span>
01275     <a class="code" href="../../d4/d1/userk_8h.html#a2011">FastGetProfileStringFromIDW</a>(pProfileUserName,
01276                                 <a class="code" href="../../d4/d1/userk_8h.html#a707">PMAP_MOUSE</a>,
01277                                 STR_SWAPBUTTONS,
01278                                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a269">szN</a>,
01279                                 rgch,
01280                                 <span class="keyword">sizeof</span>(rgch) / <span class="keyword">sizeof</span>(WCHAR));
01281     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(SWAPBUTTON) = (*rgch == <span class="charliteral">'1'</span> || *rgch == *<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a267">szY</a> || *rgch == *<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a268">szy</a>);
01282 
01283     <span class="comment">/*</span>
01284 <span class="comment">     * See if we should beep.</span>
01285 <span class="comment">     */</span>
01286     <a class="code" href="../../d4/d1/userk_8h.html#a2011">FastGetProfileStringFromIDW</a>(pProfileUserName,
01287                                 <a class="code" href="../../d4/d1/userk_8h.html#a706">PMAP_BEEP</a>,
01288                                 STR_BEEP,
01289                                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a267">szY</a>,
01290                                 rgch,
01291                                 <span class="keyword">sizeof</span>(rgch) / <span class="keyword">sizeof</span>(WCHAR)
01292                                 );
01293 
01294     <a class="code" href="../../d4/d1/userk_8h.html#a661">SET_OR_CLEAR_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a639">PUDF_BEEP</a>, (rgch[0] == *<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a267">szY</a>) || (rgch[0] == *<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a268">szy</a>));
01295 
01296     <span class="comment">/*</span>
01297 <span class="comment">     * See if we should have extended sounds.</span>
01298 <span class="comment">     */</span>
01299     <a class="code" href="../../d4/d1/userk_8h.html#a2011">FastGetProfileStringFromIDW</a>(pProfileUserName,
01300                                 <a class="code" href="../../d4/d1/userk_8h.html#a706">PMAP_BEEP</a>,
01301                                 STR_EXTENDEDSOUNDS,
01302                                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a269">szN</a>,
01303                                 rgch,
01304                                 <span class="keyword">sizeof</span>(rgch) / <span class="keyword">sizeof</span>(WCHAR)
01305                                 );
01306 
01307     <a class="code" href="../../d4/d1/userk_8h.html#a661">SET_OR_CLEAR_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a640">PUDF_EXTENDEDSOUNDS</a>, (rgch[0] == *<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a267">szY</a> || rgch[0] == *<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a268">szy</a>));
01308 
01309 }
01310 <span class="comment">/***************************************************************************\</span>
01311 <span class="comment">* xxxInitWindowStation</span>
01312 <span class="comment">*</span>
01313 <span class="comment">* History:</span>
01314 <span class="comment">* 6-Sep-1996 CLupu   Created.</span>
01315 <span class="comment">* 21-Jan-98  SamerA  Renamed to xxxInitWindowStation since it may leave the</span>
01316 <span class="comment">*                    critical section.</span>
01317 <span class="comment">\***************************************************************************/</span>
01318 
<a name="l01319"></a><a class="code" href="../../d4/d1/userk_8h.html#a1178">01319</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1178">xxxInitWindowStation</a>(
01320     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta)
01321 {
01322     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlName;
01323     PUNICODE_STRING pProfileUserName = <a class="code" href="../../d4/d1/userk_8h.html#a2000">CreateProfileUserName</a>(&amp;tlName);
01324     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRet;
01325 
01326     <span class="comment">/*</span>
01327 <span class="comment">     * Load all profile data first</span>
01328 <span class="comment">     */</span>
01329     <a class="code" href="../../d4/d1/userk_8h.html#a1837">LW_LoadProfileInitData</a>(pProfileUserName);
01330 
01331     <span class="comment">/*</span>
01332 <span class="comment">     * Initialize User in a specific order.</span>
01333 <span class="comment">     */</span>
01334     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a36">LW_DriversInit</a>();
01335 
01336     <span class="comment">/*</span>
01337 <span class="comment">     * This is the initialization from Chicago</span>
01338 <span class="comment">     */</span>
01339     <span class="keywordflow">if</span> (!(fRet = <a class="code" href="../../d4/d1/userk_8h.html#a1857">xxxSetWindowNCMetrics</a>(pProfileUserName, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, -1))) {
01340         RIPMSG0(RIP_WARNING, <span class="stringliteral">"xxxInitWindowStation failed in xxxSetWindowNCMetrics"</span>);
01341         <span class="keywordflow">goto</span> Exit;
01342     }
01343 
01344     <a class="code" href="../../d4/d1/userk_8h.html#a1856">SetMinMetrics</a>(pProfileUserName, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01345 
01346     <span class="keywordflow">if</span> (!(fRet = <a class="code" href="../../d4/d1/userk_8h.html#a1858">SetIconMetrics</a>(pProfileUserName, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))) {
01347         RIPMSG0(RIP_WARNING, <span class="stringliteral">"xxxInitWindowStation failed in SetIconMetrics"</span>);
01348         <span class="keywordflow">goto</span> Exit;
01349     }
01350 
01351     <span class="keywordflow">if</span> (!(fRet = <a class="code" href="../../d4/d1/userk_8h.html#a1491">FinalUserInit</a>())) {
01352         RIPMSG0(RIP_WARNING, <span class="stringliteral">"xxxInitWindowStation failed in FinalUserInit"</span>);
01353         <span class="keywordflow">goto</span> Exit;
01354     }
01355 
01356     <span class="comment">/*</span>
01357 <span class="comment">     * Initialize the key cache index.</span>
01358 <span class="comment">     */</span>
01359     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;dwKeyCache = 1;
01360 
01361 Exit:
01362     <a class="code" href="../../d4/d1/userk_8h.html#a2001">FreeProfileUserName</a>(pProfileUserName, &amp;tlName);
01363 
01364     <span class="keywordflow">return</span> fRet;
01365     UNREFERENCED_PARAMETER(pwinsta);
01366 }
01367 
01368 <span class="comment">/***************************************************************************\</span>
01369 <span class="comment">* CreateTerminalInput</span>
01370 <span class="comment">*</span>
01371 <span class="comment">*</span>
01372 <span class="comment">* History:</span>
01373 <span class="comment">* 6-Sep-1996 CLupu   Created.</span>
01374 <span class="comment">\***************************************************************************/</span>
01375 
<a name="l01376"></a><a class="code" href="../../d4/d1/userk_8h.html#a1835">01376</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1835">CreateTerminalInput</a>(
01377     <a class="code" href="../../d1/d8/structtagTERMINAL.html">PTERMINAL</a> pTerm)
01378 {
01379     UserAssert(pTerm != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01380 
01381     <span class="comment">/*</span>
01382 <span class="comment">     * call to the client side to clean up the [Fonts] section</span>
01383 <span class="comment">     * of the registry. This will only take significant chunk of time</span>
01384 <span class="comment">     * if the [Fonts] key changed during since the last boot and if</span>
01385 <span class="comment">     * there are lots of fonts loaded</span>
01386 <span class="comment">     */</span>
01387     <a class="code" href="../../d4/d1/userk_8h.html#a1011">ClientFontSweep</a>();
01388 
01389     <span class="comment">/*</span>
01390 <span class="comment">     * Load the standard fonts before we create any DCs.</span>
01391 <span class="comment">     * At this time we can only add the fonts that do not</span>
01392 <span class="comment">     * reside on the net. They may be needed by winlogon.</span>
01393 <span class="comment">     * Our winlogon needs only ms sans serif, but private</span>
01394 <span class="comment">     * winlogon's may need some other fonts as well.</span>
01395 <span class="comment">     * The fonts on the net will be added later, right</span>
01396 <span class="comment">     * after all the net connections have been restored.</span>
01397 <span class="comment">     */</span>
01398     <span class="comment">/*</span>
01399 <span class="comment">     * This call should be made in UserInitialize.</span>
01400 <span class="comment">     */</span>
01401     <a class="code" href="../../d4/d1/userk_8h.html#a1845">xxxLW_LoadFonts</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01402 
01403     <span class="comment">/*</span>
01404 <span class="comment">     * Initialize the input system.</span>
01405 <span class="comment">     */</span>
01406     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1168">xxxInitInput</a>(pTerm))
01407         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01408 
01409     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01410 }
01411 
01412 <span class="comment">/***************************************************************************\</span>
01413 <span class="comment">* LW_LoadSomeStrings</span>
01414 <span class="comment">*</span>
01415 <span class="comment">* This function loads a bunch of strings from the string table</span>
01416 <span class="comment">* into DS or INTDS. This is done to keep all localizable strings</span>
01417 <span class="comment">* in the .RC file.</span>
01418 <span class="comment">*</span>
01419 <span class="comment">* History:</span>
01420 <span class="comment">\***************************************************************************/</span>
01421 
<a name="l01422"></a><a class="code" href="../../d4/d1/userk_8h.html#a1836">01422</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1836">LW_LoadSomeStrings</a>(VOID)
01423 {
01424    <span class="keywordtype">int</span> i, str, <span class="keywordtype">id</span>;
01425 
01426    <span class="comment">/*</span>
01427 <span class="comment">    * MessageBox strings</span>
01428 <span class="comment">    */</span>
01429    <span class="keywordflow">for</span> (i = 0, str = STR_OK, <span class="keywordtype">id</span> = IDOK; i&lt;<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a32">MAX_MB_STRINGS</a>; i++, str++, <span class="keywordtype">id</span>++) {
01430        <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o38">MBStrings</a>[i].<a class="code" href="../../d7/d0/structtagMBSTRING.html#o2">uStr</a> = str;
01431        <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o38">MBStrings</a>[i].<a class="code" href="../../d7/d0/structtagMBSTRING.html#o1">uID</a> = <span class="keywordtype">id</span>;
01432        <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>, str, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o38">MBStrings</a>[i].<a class="code" href="../../d7/d0/structtagMBSTRING.html#o0">szName</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o38">MBStrings</a>[i].<a class="code" href="../../d7/d0/structtagMBSTRING.html#o0">szName</a>) / <span class="keyword">sizeof</span>(WCHAR));
01433    }
01434 
01435    <span class="comment">/*</span>
01436 <span class="comment">    * Tooltips strings</span>
01437 <span class="comment">    */</span>
01438    <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>, STR_MIN,    <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a314">gszMIN</a>,    <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a314">gszMIN</a>)    / <span class="keyword">sizeof</span>(WCHAR));
01439    <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>, STR_MAX,    <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a315">gszMAX</a>,    <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a315">gszMAX</a>)    / <span class="keyword">sizeof</span>(WCHAR));
01440    <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>, STR_RESUP,  <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a316">gszRESUP</a>,  <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a316">gszRESUP</a>)  / <span class="keyword">sizeof</span>(WCHAR));
01441    <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>, STR_RESDOWN,<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a317">gszRESDOWN</a>,<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a317">gszRESDOWN</a>)/ <span class="keyword">sizeof</span>(WCHAR));
01442    <span class="comment">/* Commented out due to TandyT ...</span>
01443 <span class="comment">    * ServerLoadString(hModuleWin, STR_SMENU,  gszSMENU,  sizeof(gszSMENU)  / sizeof(WCHAR));</span>
01444 <span class="comment">    */</span>
01445    <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>, STR_SCLOSE, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a318">gszSCLOSE</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a318">gszSCLOSE</a>) / <span class="keyword">sizeof</span>(WCHAR));
01446 }
01447 
01448 <span class="comment">/***************************************************************************\</span>
01449 <span class="comment">* CI_GetClrVal</span>
01450 <span class="comment">*</span>
01451 <span class="comment">* Returns the RGB value of a color string from WIN.INI.</span>
01452 <span class="comment">*</span>
01453 <span class="comment">* History:</span>
01454 <span class="comment">\***************************************************************************/</span>
01455 
<a name="l01456"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a43">01456</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a43">CI_GetClrVal</a>(
01457     LPWSTR p)
01458 {
01459     LPBYTE pl;
01460     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>   val;
01461     <span class="keywordtype">int</span>    i;
01462     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  clrval;
01463 
01464     <span class="comment">/*</span>
01465 <span class="comment">     * Initialize the pointer to the LONG return value.  Set to MSB.</span>
01466 <span class="comment">     */</span>
01467     pl = (LPBYTE)&amp;clrval;
01468 
01469     <span class="comment">/*</span>
01470 <span class="comment">     * Get three goups of numbers seprated by non-numeric characters.</span>
01471 <span class="comment">     */</span>
01472     <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++) {
01473 
01474         <span class="comment">/*</span>
01475 <span class="comment">         * Skip over any non-numeric characters.</span>
01476 <span class="comment">         */</span>
01477         <span class="keywordflow">while</span> (!(*p &gt;= TEXT(<span class="charliteral">'0'</span>) &amp;&amp; *p &lt;= TEXT(<span class="charliteral">'9'</span>)))
01478             p++;
01479 
01480         <span class="comment">/*</span>
01481 <span class="comment">         * Get the next series of digits.</span>
01482 <span class="comment">         */</span>
01483         val = 0;
01484         <span class="keywordflow">while</span> (*p &gt;= TEXT(<span class="charliteral">'0'</span>) &amp;&amp; *p &lt;= TEXT(<span class="charliteral">'9'</span>))
01485             val = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)((<span class="keywordtype">int</span>)val*10 + (<span class="keywordtype">int</span>)*p++ - <span class="charliteral">'0'</span>);
01486 
01487         <span class="comment">/*</span>
01488 <span class="comment">         * HACK! Store the group in the LONG return value.</span>
01489 <span class="comment">         */</span>
01490         *pl++ = val;
01491     }
01492 
01493     <span class="comment">/*</span>
01494 <span class="comment">     * Force the MSB to zero for GDI.</span>
01495 <span class="comment">     */</span>
01496     *pl = 0;
01497 
01498     <span class="keywordflow">return</span> clrval;
01499 }
01500 
01501 <span class="comment">/***************************************************************************\</span>
01502 <span class="comment">* xxxODI_ColorInit</span>
01503 <span class="comment">*</span>
01504 <span class="comment">*</span>
01505 <span class="comment">* History:</span>
01506 <span class="comment">\***************************************************************************/</span>
01507 
<a name="l01508"></a><a class="code" href="../../d4/d1/userk_8h.html#a1838">01508</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1838">xxxODI_ColorInit</a>(PUNICODE_STRING pProfileUserName)
01509 {
01510     <span class="keywordtype">int</span>      i;
01511     COLORREF colorVals[<a class="code" href="../../d4/d1/userk_8h.html#a683">STR_COLOREND</a> - <a class="code" href="../../d4/d1/userk_8h.html#a682">STR_COLORSTART</a> + 1];
01512     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>      colorIndex[<a class="code" href="../../d4/d1/userk_8h.html#a683">STR_COLOREND</a> - <a class="code" href="../../d4/d1/userk_8h.html#a682">STR_COLORSTART</a> + 1];
01513     WCHAR    rgchValue[25];
01514 
01515 <span class="preprocessor">#if COLOR_MAX - (STR_COLOREND - STR_COLORSTART + 1)</span>
01516 <span class="preprocessor"></span><span class="preprocessor">#error "COLOR_MAX value conflicts with STR_COLOREND - STR_COLORSTART"</span>
01517 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01518 <span class="preprocessor"></span>
01519     <span class="comment">/*</span>
01520 <span class="comment">     * Now set up default color values.</span>
01521 <span class="comment">     * These are not in display drivers anymore since we just want default.</span>
01522 <span class="comment">     * The real values are stored in the profile.</span>
01523 <span class="comment">     */</span>
01524     RtlCopyMemory(<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;argbSystem, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a312">gargbInitial</a>, <span class="keyword">sizeof</span>(COLORREF) * COLOR_MAX);
01525 
01526     <span class="keywordflow">for</span> (i = 0; i &lt; COLOR_MAX; i++) {
01527 
01528         <span class="comment">/*</span>
01529 <span class="comment">         * Try to find a WIN.INI entry for this object.</span>
01530 <span class="comment">         */</span>
01531         *rgchValue = 0;
01532         <a class="code" href="../../d4/d1/userk_8h.html#a2011">FastGetProfileStringFromIDW</a>(pProfileUserName,
01533                                     <a class="code" href="../../d4/d1/userk_8h.html#a694">PMAP_COLORS</a>,
01534                                     <a class="code" href="../../d4/d1/userk_8h.html#a682">STR_COLORSTART</a> + i,
01535                                     <a class="code" href="../../d1/d8/clglobal_8c.html#a13">szNull</a>,
01536                                     rgchValue,
01537                                     <span class="keyword">sizeof</span>(rgchValue) / <span class="keyword">sizeof</span>(WCHAR)
01538                                     );
01539 
01540         <span class="comment">/*</span>
01541 <span class="comment">         * Convert the string into an RGB value and store.  Use the</span>
01542 <span class="comment">         * default RGB value if the profile value is missing.</span>
01543 <span class="comment">         */</span>
01544         colorVals[i]  = *rgchValue ? <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a43">CI_GetClrVal</a>(rgchValue) : <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;argbSystem[i];
01545         colorIndex[i] = i;
01546     }
01547 
01548     <a class="code" href="../../d4/d1/userk_8h.html#a1774">xxxSetSysColors</a>(pProfileUserName,
01549                     i,
01550                     colorIndex,
01551                     colorVals,
01552                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a411">SSCF_FORCESOLIDCOLOR</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a412">SSCF_SETMAGICCOLORS</a>);
01553 }
01554 
01555 
01556 <span class="comment">/***********************************************************************\</span>
01557 <span class="comment">* _LoadIconsAndCursors</span>
01558 <span class="comment">*</span>
01559 <span class="comment">* Used in parallel with the client side - LoadIconsAndCursors.  This</span>
01560 <span class="comment">* assumes that only the default configurable cursors and icons have</span>
01561 <span class="comment">* been loaded and searches the global icon cache for them to fixup</span>
01562 <span class="comment">* the default resource ids to standard ids.  Also initializes the</span>
01563 <span class="comment">* rgsys arrays allowing SYSCUR and SYSICO macros to work.</span>
01564 <span class="comment">*</span>
01565 <span class="comment">* 14-Oct-1995 SanfordS  created.</span>
01566 <span class="comment">\***********************************************************************/</span>
01567 
<a name="l01568"></a><a class="code" href="../../d4/d1/userk_8h.html#a1846">01568</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1846">_LoadCursorsAndIcons</a>(VOID)
01569 {
01570     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcur;
01571     <span class="keywordtype">int</span>     i;
01572 
01573     pcur = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a155">gpcurFirst</a>;
01574 
01575     <span class="comment">/*</span>
01576 <span class="comment">     * Only CSR can call this (and only once).</span>
01577 <span class="comment">     */</span>
01578     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a>) {
01579         <span class="keywordflow">return</span>;
01580     }
01581 
01582     <a class="code" href="../../d4/d1/userk_8h.html#a773">HYDRA_HINT</a>(<a class="code" href="../../d4/d1/userk_8h.html#a767">HH_LOADCURSORS</a>);
01583 
01584     <span class="keywordflow">while</span> (pcur) {
01585 
01586         UserAssert(!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(pcur-&gt;strName.Buffer));
01587 
01588         <span class="keywordflow">switch</span> (pcur-&gt;rt) {
01589         <span class="keywordflow">case</span> RT_ICON:
01590             UserAssert((LONG_PTR)pcur-&gt;strName.Buffer &gt;= OIC_FIRST_DEFAULT);
01591 
01592             UserAssert((LONG_PTR)pcur-&gt;strName.Buffer &lt;
01593                     OIC_FIRST_DEFAULT + COIC_CONFIGURABLE);
01594 
01595             i = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(pcur-&gt;strName.Buffer) - OIC_FIRST_DEFAULT;
01596             pcur-&gt;strName.Buffer = (LPWSTR)<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a157">gasysico</a>[i].<a class="code" href="../../d9/d7/structtagSYSCFGICO.html#o0">Id</a>;
01597 
01598             <span class="keywordflow">if</span> (pcur-&gt;CURSORF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a536">CURSORF_LRSHARED</a>) {
01599                 UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a157">gasysico</a>[i].spcur == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01600                 <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a157">gasysico</a>[i].spcur, pcur);
01601             } <span class="keywordflow">else</span> {
01602                 UserAssert(<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;hIconSmWindows == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01603                 UserAssert((<span class="keywordtype">int</span>)pcur-&gt;cx == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXSMICON));
01604                 <span class="comment">/*</span>
01605 <span class="comment">                 * The special small winlogo icon is not shared.</span>
01606 <span class="comment">                 */</span>
01607                 <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;hIconSmWindows = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pcur);
01608             }
01609             <span class="keywordflow">break</span>;
01610 
01611         <span class="keywordflow">case</span> RT_CURSOR:
01612             UserAssert((LONG_PTR)pcur-&gt;strName.Buffer &gt;= OCR_FIRST_DEFAULT);
01613 
01614             UserAssert((LONG_PTR)pcur-&gt;strName.Buffer &lt;
01615                     OCR_FIRST_DEFAULT + COCR_CONFIGURABLE);
01616 
01617             i = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(pcur-&gt;strName.Buffer) - OCR_FIRST_DEFAULT;
01618             pcur-&gt;strName.Buffer = (LPWSTR)<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a156">gasyscur</a>[i].<a class="code" href="../../d9/d7/structtagSYSCFGICO.html#o0">Id</a>;
01619             <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a156">gasyscur</a>[i].spcur ,pcur);
01620             <span class="keywordflow">break</span>;
01621 
01622         <span class="keywordflow">default</span>:
01623             UserAssert(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);  <span class="comment">// should be nothing in the cache but these!</span>
01624         }
01625 
01626         pcur = pcur-&gt;pcurNext;
01627     }
01628 
01629     <span class="comment">/*</span>
01630 <span class="comment">     * copy special icon handles to global spots for later use.</span>
01631 <span class="comment">     */</span>
01632     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;hIcoWindows = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(<a class="code" href="../../d4/d1/userk_8h.html#a320">SYSICO</a>(WINLOGO));
01633 }
01634 
01635 <span class="comment">/***********************************************************************\</span>
01636 <span class="comment">* UnloadCursorsAndIcons</span>
01637 <span class="comment">*</span>
01638 <span class="comment">* used for cleanup of win32k</span>
01639 <span class="comment">*</span>
01640 <span class="comment">* Dec-10-1997 clupu  created.</span>
01641 <span class="comment">\***********************************************************************/</span>
<a name="l01642"></a><a class="code" href="../../d4/d1/userk_8h.html#a1847">01642</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1847">UnloadCursorsAndIcons</a>(
01643     VOID)
01644 {
01645     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcur;
01646     <span class="keywordtype">int</span>     ind;
01647 
01648     <a class="code" href="../../d4/d1/userk_8h.html#a777">TRACE_HYDAPI</a>((<span class="stringliteral">"UnloadCursorsAndIcons\n"</span>));
01649 
01650     <span class="comment">/*</span>
01651 <span class="comment">     * unlock the icons</span>
01652 <span class="comment">     */</span>
01653     <span class="keywordflow">for</span> (ind = 0; ind &lt; COIC_CONFIGURABLE; ind++) {
01654         pcur = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a157">gasysico</a>[ind].<a class="code" href="../../d9/d7/structtagSYSCFGICO.html#o2">spcur</a>;
01655 
01656         <span class="keywordflow">if</span> (pcur == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01657             <span class="keywordflow">continue</span>;
01658 
01659         pcur-&gt;head.ppi = <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>();
01660         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a157">gasysico</a>[ind].spcur);
01661     }
01662 
01663     <span class="comment">/*</span>
01664 <span class="comment">     * unlock the cursors</span>
01665 <span class="comment">     */</span>
01666     <span class="keywordflow">for</span> (ind = 0; ind &lt; COCR_CONFIGURABLE; ind++) {
01667         pcur = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a156">gasyscur</a>[ind].<a class="code" href="../../d9/d7/structtagSYSCFGICO.html#o2">spcur</a>;
01668 
01669         <span class="keywordflow">if</span> (pcur == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01670             <span class="keywordflow">continue</span>;
01671 
01672         pcur-&gt;head.ppi = <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>();
01673         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a156">gasyscur</a>[ind].spcur);
01674     }
01675 }
01676 
01677 <span class="comment">/***********************************************************************\</span>
01678 <span class="comment">* xxxUpdateSystemCursorsFromRegistry</span>
01679 <span class="comment">*</span>
01680 <span class="comment">* Reloads all customizable cursors from the registry.</span>
01681 <span class="comment">*</span>
01682 <span class="comment">* 09-Oct-1995 SanfordS  created.</span>
01683 <span class="comment">\***********************************************************************/</span>
01684 
<a name="l01685"></a><a class="code" href="../../d4/d1/userk_8h.html#a1840">01685</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1840">xxxUpdateSystemCursorsFromRegistry</a>(PUNICODE_STRING pProfileUserName)
01686 {
01687     <span class="keywordtype">int</span>            i;
01688     UNICODE_STRING strName;
01689     TCHAR          szFilename[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
01690     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a>        pCursor;
01691     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>           LR_flags;
01692 
01693     <span class="keywordflow">for</span> (i = 0; i &lt; COCR_CONFIGURABLE; i++) {
01694 
01695         <a class="code" href="../../d4/d1/userk_8h.html#a2011">FastGetProfileStringFromIDW</a>(pProfileUserName,
01696                                     <a class="code" href="../../d4/d1/userk_8h.html#a695">PMAP_CURSORS</a>,
01697                                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a156">gasyscur</a>[i].StrId,
01698                                     TEXT(<span class="stringliteral">""</span>),
01699                                     szFilename,
01700                                     <span class="keyword">sizeof</span>(szFilename) / <span class="keyword">sizeof</span>(TCHAR));
01701 
01702         <span class="keywordflow">if</span> (*szFilename) {
01703             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strName, szFilename);
01704             LR_flags = LR_LOADFROMFILE | LR_ENVSUBST;
01705         } <span class="keywordflow">else</span> {
01706             <a class="code" href="../../d4/d1/userk_8h.html#a1005">RtlInitUnicodeStringOrId</a>(&amp;strName,
01707                                      MAKEINTRESOURCE(i + OCR_FIRST_DEFAULT));
01708             LR_flags = LR_ENVSUBST;
01709         }
01710 
01711         pCursor = <a class="code" href="../../d4/d1/userk_8h.html#a1007">xxxClientLoadImage</a>(&amp;strName,
01712                                      0,
01713                                      IMAGE_CURSOR,
01714                                      0,
01715                                      0,
01716                                      LR_flags,
01717                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01718 
01719         <span class="keywordflow">if</span> (pCursor) {
01720             <a class="code" href="../../d4/d1/userk_8h.html#a1111">zzzSetSystemImage</a>(pCursor, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a156">gasyscur</a>[i].spcur);
01721         } <span class="keywordflow">else</span> {
01722             RIPMSG1(RIP_WARNING, <span class="stringliteral">"Unable to update cursor. id=%x."</span>, i + OCR_FIRST_DEFAULT);
01723 
01724         }
01725     }
01726 }
01727 
01728 <span class="comment">/***********************************************************************\</span>
01729 <span class="comment">* xxxUpdateSystemIconsFromRegistry</span>
01730 <span class="comment">*</span>
01731 <span class="comment">* Reloads all customizable icons from the registry.</span>
01732 <span class="comment">*</span>
01733 <span class="comment">* 09-Oct-1995 SanfordS  created.</span>
01734 <span class="comment">\***********************************************************************/</span>
<a name="l01735"></a><a class="code" href="../../d4/d1/userk_8h.html#a1841">01735</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1841">xxxUpdateSystemIconsFromRegistry</a>(PUNICODE_STRING pProfileUserName)
01736 {
01737     <span class="keywordtype">int</span>            i;
01738     UNICODE_STRING strName;
01739     TCHAR          szFilename[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
01740     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a>        pCursor;
01741     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>           LR_flags;
01742 
01743     <span class="keywordflow">for</span> (i = 0; i &lt; COIC_CONFIGURABLE; i++) {
01744 
01745         <a class="code" href="../../d4/d1/userk_8h.html#a2011">FastGetProfileStringFromIDW</a>(pProfileUserName,
01746                                     <a class="code" href="../../d4/d1/userk_8h.html#a699">PMAP_ICONS</a>,
01747                                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a157">gasysico</a>[i].StrId,
01748                                     TEXT(<span class="stringliteral">""</span>),
01749                                     szFilename,
01750                                     <span class="keyword">sizeof</span>(szFilename) / <span class="keyword">sizeof</span>(TCHAR));
01751 
01752         <span class="keywordflow">if</span> (*szFilename) {
01753             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strName, szFilename);
01754             LR_flags = LR_LOADFROMFILE | LR_ENVSUBST;
01755         } <span class="keywordflow">else</span> {
01756             <a class="code" href="../../d4/d1/userk_8h.html#a1005">RtlInitUnicodeStringOrId</a>(&amp;strName,
01757                                      MAKEINTRESOURCE(i + OIC_FIRST_DEFAULT));
01758             LR_flags = LR_ENVSUBST;
01759         }
01760 
01761         pCursor = <a class="code" href="../../d4/d1/userk_8h.html#a1007">xxxClientLoadImage</a>(&amp;strName,
01762                                      0,
01763                                      IMAGE_ICON,
01764                                      0,
01765                                      0,
01766                                      LR_flags,
01767                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01768 
01769         RIPMSG3(RIP_VERBOSE,
01770                 (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(strName.Buffer)) ?
01771                         <span class="stringliteral">"%#.8lx = Loaded id %ld"</span> :
01772                         <span class="stringliteral">"%#.8lx = Loaded file %ws for id %ld"</span>,
01773                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pCursor),
01774                 strName.Buffer,
01775                 i + OIC_FIRST_DEFAULT);
01776 
01777         <span class="keywordflow">if</span> (pCursor) {
01778             <a class="code" href="../../d4/d1/userk_8h.html#a1111">zzzSetSystemImage</a>(pCursor, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a157">gasysico</a>[i].spcur);
01779         } <span class="keywordflow">else</span> {
01780             RIPMSG1(RIP_WARNING, <span class="stringliteral">"Unable to update icon. id=%ld"</span>, i + OIC_FIRST_DEFAULT);
01781         }
01782 
01783         <span class="comment">/*</span>
01784 <span class="comment">         * update the small winlogo icon which is referenced by gpsi.</span>
01785 <span class="comment">         * Seems like we should load the small version for all configurable</span>
01786 <span class="comment">         * icons anyway.  What is needed is for CopyImage to support</span>
01787 <span class="comment">         * copying of images loaded from files with LR_COPYFROMRESOURCE</span>
01788 <span class="comment">         * allowing a reaload of the bits. (SAS)</span>
01789 <span class="comment">         */</span>
01790         <span class="keywordflow">if</span> (i == OIC_WINLOGO_DEFAULT - OIC_FIRST_DEFAULT) {
01791 
01792             <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pCurSys = <a class="code" href="../../d4/d1/userk_8h.html#a102">HtoP</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;hIconSmWindows);
01793 
01794             <span class="keywordflow">if</span> (pCurSys != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01795                 pCursor = <a class="code" href="../../d4/d1/userk_8h.html#a1007">xxxClientLoadImage</a>(&amp;strName,
01796                                              0,
01797                                              IMAGE_ICON,
01798                                              <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXSMICON),
01799                                              <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYSMICON),
01800                                              LR_flags,
01801                                              <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01802 
01803                 <span class="keywordflow">if</span> (pCursor) {
01804                     <a class="code" href="../../d4/d1/userk_8h.html#a1111">zzzSetSystemImage</a>(pCursor, pCurSys);
01805                 } <span class="keywordflow">else</span> {
01806                     RIPMSG0(RIP_WARNING, <span class="stringliteral">"Unable to update small winlogo icon."</span>);
01807                 }
01808             }
01809         }
01810     }
01811 }
01812 
01813 <span class="comment">/***************************************************************************\</span>
01814 <span class="comment">* LW_BrushInit</span>
01815 <span class="comment">*</span>
01816 <span class="comment">*</span>
01817 <span class="comment">* History:</span>
01818 <span class="comment">\***************************************************************************/</span>
01819 
<a name="l01820"></a><a class="code" href="../../d4/d1/userk_8h.html#a1844">01820</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1844">LW_BrushInit</a>(VOID)
01821 {
01822     HBITMAP hbmGray;
01823     CONST <span class="keyword">static</span> WORD patGray[8] = {0x55, 0xaa, 0x55, 0xaa, 0x55, 0xaa, 0x55, 0xaa};
01824 
01825     <span class="comment">/*</span>
01826 <span class="comment">     * Create a gray brush to be used with GrayString</span>
01827 <span class="comment">     */</span>
01828     hbmGray   = GreCreateBitmap(8, 8, 1, 1, (LPBYTE)patGray);
01829 
01830     <span class="keywordflow">if</span> (hbmGray == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01831         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01832     }
01833 
01834     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;hbrGray  = GreCreatePatternBrush(hbmGray);
01835     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1134">ghbrWhite</a> = GreGetStockObject(WHITE_BRUSH);
01836     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1135">ghbrBlack</a> = GreGetStockObject(BLACK_BRUSH);
01837 
01838     UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1134">ghbrWhite</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1135">ghbrBlack</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01839 
01840     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;hbrGray == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01841         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01842     }
01843 
01844     GreDeleteObject(hbmGray);
01845     GreSetBrushOwnerPublic(<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;hbrGray);
01846     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a129">ghbrHungApp</a> = GreCreateSolidBrush(0);
01847 
01848     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a129">ghbrHungApp</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01849         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01850     }
01851 
01852     GreSetBrushOwnerPublic(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a129">ghbrHungApp</a>);
01853 
01854     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01855 }
01856 
01857 <span class="comment">/***************************************************************************\</span>
01858 <span class="comment">* LW_RegisterWindows</span>
01859 <span class="comment">*</span>
01860 <span class="comment">*</span>
01861 <span class="comment">* History:</span>
01862 <span class="comment">\***************************************************************************/</span>
<a name="l01863"></a><a class="code" href="../../d4/d1/userk_8h.html#a1492">01863</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1492">LW_RegisterWindows</a>(
01864     BOOL fSystem)
01865 {
01866 <span class="preprocessor">#ifdef HUNGAPP_GHOSTING</span>
01867 <span class="preprocessor"></span><span class="preprocessor">#define CCLASSES 9</span>
01868 <span class="preprocessor"></span><span class="preprocessor">#else // HUNGAPP_GHOSTING</span>
01869 <span class="preprocessor"></span><span class="preprocessor">#define CCLASSES 8</span>
01870 <span class="preprocessor"></span><span class="preprocessor">#endif // HUNGAPP_GHOSTING</span>
01871 <span class="preprocessor"></span>
01872     <span class="keywordtype">int</span>        i;
01873     WNDCLASSEX wndcls;
01874 
01875     CONST <span class="keyword">static</span> <span class="keyword">struct </span>{
01876         BOOLEAN     fSystem;
01877         BOOLEAN     fGlobalClass;
01878         WORD        fnid;
01879         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>        style;
01880         WNDPROC     lpfnWndProc;
01881         <span class="keywordtype">int</span>         cbWndExtra;
01882         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fNormalCursor : 1;
01883         HBRUSH      hbrBackground;
01884         LPCTSTR     lpszClassName;
01885     } rc[<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a3">CCLASSES</a>] = {
01886         { <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a196">FNID_DESKTOP</a>,
01887             CS_DBLCLKS,
01888             (WNDPROC)<a class="code" href="../../d9/d6/desktop_8c.html#a10">xxxDesktopWndProc</a>,
01889             <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d3/structtagDESKWND.html">DESKWND</a>) - <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagWND.html">WND</a>),
01890             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01891             (HBRUSH)(COLOR_BACKGROUND + 1),
01892             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a39">DESKTOPCLASS</a>},
01893         { <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a221">FNID_SWITCH</a>,
01894             CS_VREDRAW | CS_HREDRAW | CS_SAVEBITS,
01895             (WNDPROC)<a class="code" href="../../d1/d3/tmswitch_8c.html#a28">xxxSwitchWndProc</a>,
01896             <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d7/structtagSWITCHWND.html">SWITCHWND</a>) - <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagWND.html">WND</a>),
01897             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01898             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01899             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a41">SWITCHWNDCLASS</a>},
01900         { <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a195">FNID_MENU</a>,
01901             CS_DBLCLKS | CS_SAVEBITS,
01902             (WNDPROC)<a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a43">xxxMenuWindowProc</a>,
01903             <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a>),
01904             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01905             (HBRUSH)(COLOR_MENU + 1),
01906             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a45">MENUCLASS</a>},
01907         { <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a193">FNID_SCROLLBAR</a>,
01908             CS_VREDRAW | CS_HREDRAW | CS_DBLCLKS | CS_PARENTDC,
01909             (WNDPROC)<a class="code" href="../../d8/d4/sbctl_8c.html#a47">xxxSBWndProc</a>,
01910             <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d5/structtagSBWND.html">SBWND</a>) - <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagWND.html">WND</a>),
01911             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01912             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01913             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ScrollBar"</span>},
01914         { <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a222">FNID_TOOLTIP</a>,
01915             CS_DBLCLKS | CS_SAVEBITS,
01916             (WNDPROC)<a class="code" href="../../d1/d4/tooltips_8c.html#a31">xxxTooltipWndProc</a>,
01917             <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html">TOOLTIPWND</a>) - <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagWND.html">WND</a>),
01918             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01919             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01920             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a44">TOOLTIPCLASS</a>},
01921         { <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a194">FNID_ICONTITLE</a>,
01922             0,
01923             (WNDPROC)<a class="code" href="../../d8/d3/dwp_8c.html#a17">xxxDefWindowProc</a>,
01924             0,
01925             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01926             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01927             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a42">ICONTITLECLASS</a>},
01928         { <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, 0,
01929             0,
01930             (WNDPROC)<a class="code" href="../../d2/d4/ddemlsvr_8h.html#a5">xxxEventWndProc</a>,
01931             <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html">PSVR_INSTANCE_INFO</a>),
01932             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01933             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01934             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"DDEMLEvent"</span>},
01935 <span class="preprocessor">#ifdef HUNGAPP_GHOSTING</span>
01936 <span class="preprocessor"></span>        { <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, 0,
01937             0,
01938             (WNDPROC)xxxGhostWndProc,
01939             0,
01940             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01941             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01942             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Ghost"</span>},
01943 <span class="preprocessor">#endif // HUNGAPP_GHOSTING</span>
01944 <span class="preprocessor"></span>        { <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, 0,
01945             0,
01946             (WNDPROC)<a class="code" href="../../d8/d3/dwp_8c.html#a17">xxxDefWindowProc</a>,
01947             4,
01948             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01949             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01950             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Message"</span>}
01951     };
01952 
01953 
01954     <span class="comment">/*</span>
01955 <span class="comment">     * All other classes are registered via the table.</span>
01956 <span class="comment">     */</span>
01957     wndcls.cbClsExtra   = 0;
01958     wndcls.hInstance    = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>;
01959     wndcls.hIcon        = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01960     wndcls.hIconSm      = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01961     wndcls.lpszMenuName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01962 
01963     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a3">CCLASSES</a>; i++) {
01964         <span class="keywordflow">if</span> (fSystem &amp;&amp; !rc[i].fSystem) {
01965             <span class="keywordflow">continue</span>;
01966         }
01967         wndcls.style        = rc[i].style;
01968         wndcls.lpfnWndProc  = rc[i].lpfnWndProc;
01969         wndcls.cbWndExtra   = rc[i].cbWndExtra;
01970         wndcls.hCursor      = rc[i].fNormalCursor ? <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(<a class="code" href="../../d4/d1/userk_8h.html#a321">SYSCUR</a>(ARROW)) : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01971         wndcls.hbrBackground= rc[i].hbrBackground;
01972         wndcls.lpszClassName= rc[i].lpszClassName;
01973 
01974         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1569">InternalRegisterClassEx</a>(&amp;wndcls,
01975                                     rc[i].fnid,
01976                                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a492">CSF_SERVERSIDEPROC</a> | <a class="code" href="../../d1/d0/inc_2user_8h.html#a491">CSF_WIN40COMPAT</a>) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01977             RIPMSG0(RIP_WARNING, <span class="stringliteral">"LW_RegisterWindows: InternalRegisterClassEx failed"</span>);
01978             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01979         }
01980 
01981         <span class="keywordflow">if</span> (fSystem &amp;&amp; rc[i].fGlobalClass) {
01982             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1569">InternalRegisterClassEx</a>(&amp;wndcls,
01983                                     rc[i].fnid,
01984                                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a492">CSF_SERVERSIDEPROC</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a495">CSF_SYSTEMCLASS</a> | <a class="code" href="../../d1/d0/inc_2user_8h.html#a491">CSF_WIN40COMPAT</a>) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01985 
01986                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"LW_RegisterWindows: InternalRegisterClassEx failed"</span>);
01987                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01988             }
01989         }
01990     }
01991     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01992 }
01993 
01994 <span class="comment">/**********************************************************\</span>
01995 <span class="comment">* VOID vCheckMMInstance</span>
01996 <span class="comment">*</span>
01997 <span class="comment">* History:</span>
01998 <span class="comment">*  Feb-06-98    Xudong Wu [TessieW]</span>
01999 <span class="comment">* Wrote it.</span>
02000 <span class="comment">\**********************************************************/</span>
<a name="l02001"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a51">02001</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a51">vCheckMMInstance</a>(
02002     LPWSTR pchSrch,
02003     DESIGNVECTOR  *pdv)
02004 {
02005     LPWSTR  pKeyName;
02006     WCHAR   <a class="code" href="../../d4/d9/icmupg_8c.html#a20">szName</a>[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>], *pszName = <a class="code" href="../../d4/d9/icmupg_8c.html#a20">szName</a>;
02007     WCHAR   szCannonicalName[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
02008     ULONG   NumAxes;
02009 
02010     pdv-&gt;dvNumAxes = 0;
02011     pKeyName = pchSrch;
02012     <span class="keywordflow">while</span> (*pKeyName &amp;&amp; (*pKeyName++ != TEXT(<span class="charliteral">'('</span>)))
02013         ;
02014 
02015     <span class="keywordflow">if</span> (*pKeyName){
02016         <span class="keywordflow">if</span> (!_wcsicmp(pKeyName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"OpenType)"</span>))
02017         {
02018             pKeyName = pchSrch;
02019             <span class="keywordflow">while</span>(*pKeyName != TEXT(<span class="charliteral">'('</span>))
02020                 *pszName++ = *pKeyName++;
02021             *pszName = 0;
02022 
02023             GreGetCannonicalName(<a class="code" href="../../d4/d9/icmupg_8c.html#a20">szName</a>, szCannonicalName, &amp;NumAxes, pdv);
02024         }
02025     }
02026 }
02027 
02028 
02029 <span class="comment">/***************************************************************************\</span>
02030 <span class="comment">* LW_LoadFonts</span>
02031 <span class="comment">*</span>
02032 <span class="comment">*</span>
02033 <span class="comment">* History:</span>
02034 <span class="comment">\***************************************************************************/</span>
02035 
<a name="l02036"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a52">02036</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a52">bEnumerateRegistryFonts</a>(
02037     BOOL bPermanent)
02038 {
02039     LPWSTR pchKeys;
02040     LPWSTR pchSrch;
02041     LPWSTR lpchT;
02042     <span class="keywordtype">int</span>    cchReal;
02043     <span class="keywordtype">int</span>    cFont;
02044     WCHAR  szFontFile[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
02045     FLONG  flAFRW;
02046     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>     tlPool;
02047     DESIGNVECTOR  dv;
02048 
02049     WCHAR  szPreloadFontFile[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
02050 
02051     <span class="comment">/*</span>
02052 <span class="comment">     * if we are not just checking whether this is a registry font</span>
02053 <span class="comment">     */</span>
02054     flAFRW = (bPermanent ? AFRW_ADD_LOCAL_FONT : AFRW_ADD_REMOTE_FONT);
02055 
02056     cchReal = (<span class="keywordtype">int</span>)<a class="code" href="../../d4/d1/userk_8h.html#a2005">FastGetProfileKeysW</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02057             <a class="code" href="../../d4/d1/userk_8h.html#a700">PMAP_FONTS</a>,
02058             TEXT(<span class="stringliteral">"vgasys.fnt"</span>),
02059             &amp;pchKeys
02060             );
02061 
02062 <span class="preprocessor">#if DBG</span>
02063 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (cchReal == 0) {
02064         RIPMSG0(RIP_WARNING, <span class="stringliteral">"bEnumerateRegistryFonts: cchReal is 0"</span>);
02065     }
02066 <span class="preprocessor">#endif</span>
02067 <span class="preprocessor"></span>
02068     <span class="keywordflow">if</span> (!pchKeys)
02069         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02070 
02071     <a class="code" href="../../d4/d1/userk_8h.html#a137">ThreadLockPool</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), pchKeys, &amp;tlPool);
02072 
02073     <span class="comment">/*</span>
02074 <span class="comment">     * If we got here first, we load the fonts until this preload font.</span>
02075 <span class="comment">     * Preload fonts will be used by Winlogon UI, then we need to make sure</span>
02076 <span class="comment">     * the font is available when Winlogon UI comes up.</span>
02077 <span class="comment">     */</span>
02078     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a13">LastFontLoaded</a> == -1) {
02079         <a class="code" href="../../d4/d1/userk_8h.html#a2007">FastGetProfileStringW</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d1/userk_8h.html#a721">PMAP_WINLOGON</a>,
02080                               TEXT(<span class="stringliteral">"PreloadFontFile"</span>),
02081                               TEXT(<span class="stringliteral">"Micross.ttf"</span>),
02082                               szPreloadFontFile,
02083                               <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>
02084                               );
02085         RIPMSG1(RIP_VERBOSE, <span class="stringliteral">"Winlogon preload font = %ws\n"</span>,szPreloadFontFile);
02086     }
02087 
02088     <span class="comment">/*</span>
02089 <span class="comment">     * Now we have all the key names in pchKeys.</span>
02090 <span class="comment">     */</span>
02091     <span class="keywordflow">if</span> (cchReal != 0) {
02092 
02093         cFont   = 0;
02094         pchSrch = pchKeys;
02095 
02096         <span class="keywordflow">do</span> {
02097             <span class="comment">// check to see whether this is MM(OpenType) instance</span>
02098             <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a51">vCheckMMInstance</a>(pchSrch, &amp;dv);
02099 
02100             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a2007">FastGetProfileStringW</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02101                                       <a class="code" href="../../d4/d1/userk_8h.html#a700">PMAP_FONTS</a>,
02102                                       pchSrch,
02103                                       TEXT(<span class="stringliteral">"vgasys.fon"</span>),
02104                                       szFontFile,
02105                                       (<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a> - 5)
02106                                       )) {
02107 
02108                 <span class="comment">/*</span>
02109 <span class="comment">                 * If no extension, append ".FON"</span>
02110 <span class="comment">                 */</span>
02111                 <span class="keywordflow">for</span> (lpchT = szFontFile; *lpchT != TEXT(<span class="charliteral">'.'</span>); lpchT++) {
02112 
02113                     <span class="keywordflow">if</span> (*lpchT == 0) {
02114                         wcscat(szFontFile, TEXT(<span class="stringliteral">".FON"</span>));
02115                         <span class="keywordflow">break</span>;
02116                     }
02117                 }
02118 
02119                 <span class="keywordflow">if</span> ((cFont &gt; <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a13">LastFontLoaded</a>) &amp;&amp; bPermanent) {
02120 
02121                     <span class="comment">/*</span>
02122 <span class="comment">                     * skip if we've already loaded this local font.</span>
02123 <span class="comment">                     */</span>
02124                     <a class="code" href="../../d4/d1/userk_8h.html#a1851">xxxAddFontResourceW</a>(szFontFile, flAFRW, dv.dvNumAxes ? &amp;dv : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02125                 }
02126 
02127                 <span class="keywordflow">if</span> (!bPermanent)
02128                     <a class="code" href="../../d4/d1/userk_8h.html#a1851">xxxAddFontResourceW</a>(szFontFile, flAFRW, dv.dvNumAxes ? &amp;dv : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02129 
02130                 <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a13">LastFontLoaded</a> == -1) &amp;&amp;
02131                     <span class="comment">/*</span>
02132 <span class="comment">                     * Compare with the font file name from Registry.</span>
02133 <span class="comment">                     */</span>
02134                     (!_wcsnicmp(szFontFile, szPreloadFontFile, wcslen(szPreloadFontFile))) &amp;&amp;
02135                     (bPermanent)) {
02136 
02137                     <span class="comment">/*</span>
02138 <span class="comment">                     * On the first time through only load up until</span>
02139 <span class="comment">                     * ms sans serif for winlogon to use.       Later we</span>
02140 <span class="comment">                     * will spawn off a thread which loads the remaining</span>
02141 <span class="comment">                     * fonts in the background.</span>
02142 <span class="comment">                     */</span>
02143                     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a13">LastFontLoaded</a> = cFont;
02144 
02145                     <a class="code" href="../../d4/d1/userk_8h.html#a139">ThreadUnlockAndFreePool</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), &amp;tlPool);
02146                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02147                 }
02148             }
02149 
02150             <span class="comment">/*</span>
02151 <span class="comment">             * Skip to the next key.</span>
02152 <span class="comment">             */</span>
02153             <span class="keywordflow">while</span> (*pchSrch++);
02154 
02155             cFont += 1;
02156 
02157         } <span class="keywordflow">while</span> (pchSrch &lt; ((LPWSTR)pchKeys + cchReal));
02158     }
02159 
02160     <span class="comment">/*</span>
02161 <span class="comment">     * signal that all the permanent fonts have been loaded</span>
02162 <span class="comment">     */</span>
02163     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a12">bPermanentFontsLoaded</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02164 
02165     <a class="code" href="../../d4/d1/userk_8h.html#a139">ThreadUnlockAndFreePool</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), &amp;tlPool);
02166 
02167     <span class="keywordflow">if</span> (!bPermanent)
02168         <a class="code" href="../../d4/d1/userk_8h.html#a659">SET_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a643">PUDF_FONTSARELOADED</a>);
02169 
02170     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02171 
02172 }
02173 
02174 <span class="keyword">extern</span> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a53">CloseFNTCache</a>(VOID);
02175 
02176 <span class="comment">/***************************************************************************\</span>
02177 <span class="comment">* xxxLW_LoadFonts</span>
02178 <span class="comment">*</span>
02179 <span class="comment">*</span>
02180 <span class="comment">* History:</span>
02181 <span class="comment">\***************************************************************************/</span>
02182 
02183 
<a name="l02184"></a><a class="code" href="../../d4/d1/userk_8h.html#a1845">02184</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1845">xxxLW_LoadFonts</a>(
02185     BOOL bRemote)
02186 {
02187     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    bTimeOut = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02188 
02189     <span class="keywordflow">if</span>(bRemote) {
02190 
02191         LARGE_INTEGER li;
02192         ULONG         ulWaitCount = 0;
02193 
02194         <span class="comment">/*</span>
02195 <span class="comment">         * Before we can proceed we must make sure that all the permanent</span>
02196 <span class="comment">         * fonts  have been loaded.</span>
02197 <span class="comment">         */</span>
02198 
02199         <span class="keywordflow">while</span> (!<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a12">bPermanentFontsLoaded</a>) {
02200 
02201             <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a> || (ulWaitCount &lt; <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a2">MAX_TIME_OUT</a>))
02202             {
02203                 <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
02204                 li.QuadPart = (LONGLONG)-10000 * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a911">CMSSLEEP</a>;
02205                 <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;li);
02206                 <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
02207             }
02208             <span class="keywordflow">else</span>
02209             {
02210                 bTimeOut = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02211                 <span class="keywordflow">break</span>;
02212             }
02213 
02214             ulWaitCount++;
02215         }
02216 
02217         <span class="keywordflow">if</span> (!bTimeOut)
02218         {
02219             <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a52">bEnumerateRegistryFonts</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>))
02220                 <span class="keywordflow">return</span>; <span class="comment">// nothing you can do</span>
02221 
02222         <span class="comment">// add  remote type 1 fonts.</span>
02223 
02224             <a class="code" href="../../d4/d1/userk_8h.html#a1013">ClientLoadRemoteT1Fonts</a>();
02225         }
02226 
02227     } <span class="keywordflow">else</span> {
02228 
02229         <a class="code" href="../../d4/d1/userk_8h.html#a1851">xxxAddFontResourceW</a>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"marlett.ttf"</span>, AFRW_ADD_LOCAL_FONT,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02230         <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a52">bEnumerateRegistryFonts</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))
02231             <span class="keywordflow">return</span>; <span class="comment">// nothing you can do</span>
02232 
02233     <span class="comment">// add local type 1 fonts.</span>
02234 
02235     <span class="comment">// only want to be called once, the second time after ms sans serif was installed</span>
02236 
02237         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a12">bPermanentFontsLoaded</a>)
02238         {
02239             <a class="code" href="../../d4/d1/userk_8h.html#a1012">ClientLoadLocalT1Fonts</a>();
02240 
02241     <span class="comment">// All the fonts loaded, we can close the FNTCache</span>
02242 
02243             <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a53">CloseFNTCache</a>();
02244         }
02245 
02246     }
02247 }
02248 
02249 <span class="comment">/***************************************************************************\</span>
02250 <span class="comment">* FinalUserInit</span>
02251 <span class="comment">*</span>
02252 <span class="comment">* History:</span>
02253 <span class="comment">\***************************************************************************/</span>
<a name="l02254"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a55">02254</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1491">FinalUserInit</a>(VOID)
02255 {
02256     HBITMAP hbm;
02257     <a class="code" href="../../d7/d0/structtagCLS.html">PPCLS</a>   ppcls;
02258 
02259     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o5">hdcGray</a> = GreCreateCompatibleDC(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o3">hdcScreen</a>);
02260 
02261     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o5">hdcGray</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02262         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02263     }
02264 
02265     GreSelectFont(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o5">hdcGray</a>, <a class="code" href="../../d1/d8/clglobal_8c.html#a28">ghFontSys</a>);
02266     GreSetDCOwner(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o5">hdcGray</a>, OBJECT_OWNER_PUBLIC);
02267 
02268     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o7">cxGray</a> = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cxSysFontChar * <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a1">GRAY_STRLEN</a>;
02269     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o8">cyGray</a> = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cySysFontChar + 2;
02270     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o6">hbmGray</a> = GreCreateBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o7">cxGray</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o8">cyGray</a>, 1, 1, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
02271 
02272     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o6">hbmGray</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02273         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02274     }
02275 
02276     GreSetBitmapOwner(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o6">hbmGray</a>, OBJECT_OWNER_PUBLIC);
02277 
02278     hbm = GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o5">hdcGray</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o6">hbmGray</a>);
02279     GreSetTextColor(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o5">hdcGray</a>, 0x00000000L);
02280     GreSelectBrush(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o5">hdcGray</a>, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;hbrGray);
02281     GreSetBkMode(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o5">hdcGray</a>, OPAQUE);
02282     GreSetBkColor(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o5">hdcGray</a>, 0x00FFFFFFL);
02283 
02284     <span class="comment">/*</span>
02285 <span class="comment">     * Setup menu animation dc for global menu state</span>
02286 <span class="comment">     */</span>
02287     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1347">MNSetupAnimationDC</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a146">gMenuState</a>)) {
02288         GreSetDCOwner(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a146">gMenuState</a>.hdcAni, OBJECT_OWNER_PUBLIC);
02289     } <span class="keywordflow">else</span> {
02290         RIPMSG0(RIP_WARNING, <span class="stringliteral">"FinalUserInit: MNSetupAnimationDC failed"</span>);
02291     }
02292 
02293     <span class="comment">/*</span>
02294 <span class="comment">     * Creation of the queue registers some bogus classes.  Get rid</span>
02295 <span class="comment">     * of them and register the real ones.</span>
02296 <span class="comment">     */</span>
02297     ppcls = &amp;<a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()-&gt;pclsPublicList;
02298     <span class="keywordflow">while</span> ((*ppcls != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; !((*ppcls)-&gt;style &amp; CS_GLOBALCLASS))
02299         <a class="code" href="../../d4/d1/userk_8h.html#a1551">DestroyClass</a>(ppcls);
02300 
02301     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02302 }
02303 
02304 <span class="comment">/***************************************************************************\</span>
02305 <span class="comment">* InitializeClientPfnArrays</span>
02306 <span class="comment">*</span>
02307 <span class="comment">* This routine gets called by the client to tell the kernel where</span>
02308 <span class="comment">* its important functions can be located.</span>
02309 <span class="comment">*</span>
02310 <span class="comment">* 18-Apr-1995 JimA  Created.</span>
02311 <span class="comment">\***************************************************************************/</span>
02312 
<a name="l02313"></a><a class="code" href="../../d4/d1/userk_8h.html#a1014">02313</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d4/d1/userk_8h.html#a1014">InitializeClientPfnArrays</a>(
02314     CONST <a class="code" href="../../d0/d5/struct__PFNCLIENT.html">PFNCLIENT</a> *ppfnClientA,
02315     CONST <a class="code" href="../../d0/d5/struct__PFNCLIENT.html">PFNCLIENT</a> *ppfnClientW,
02316     CONST <a class="code" href="../../d1/d5/struct__PFNCLIENTWORKER.html">PFNCLIENTWORKER</a> *ppfnClientWorker,
02317     HANDLE hModUser)
02318 {
02319     <span class="keyword">static</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fHaveClientPfns = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02320     <span class="comment">/*</span>
02321 <span class="comment">     * Remember client side addresses in this global structure.  These are</span>
02322 <span class="comment">     * always constant, so this is ok.  Note that if either of the</span>
02323 <span class="comment">     * pointers are invalid, the exception will be handled in</span>
02324 <span class="comment">     * the thunk and fHaveClientPfns will not be set.</span>
02325 <span class="comment">     */</span>
02326     <span class="keywordflow">if</span> (!fHaveClientPfns &amp;&amp; ppfnClientA != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02327         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>()) {
02328             RIPMSG0(RIP_WARNING, <span class="stringliteral">"InitializeClientPfnArrays failed !csrss"</span>);
02329             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
02330         }
02331         <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o8">apfnClientA</a> = *ppfnClientA;
02332         <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o9">apfnClientW</a> = *ppfnClientW;
02333         <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o10">apfnClientWorker</a> = *ppfnClientWorker;
02334 
02335         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a280">gpfnwp</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a68">ICLS_BUTTON</a>]  = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o9">apfnClientW</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o5">pfnButtonWndProc</a>;
02336         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a280">gpfnwp</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a69">ICLS_EDIT</a>]  = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o9">apfnClientW</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o4">pfnDefWindowProc</a>;
02337         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a280">gpfnwp</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a70">ICLS_STATIC</a>]  = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o9">apfnClientW</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o12">pfnStaticWndProc</a>;
02338         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a280">gpfnwp</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a71">ICLS_LISTBOX</a>]  = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o9">apfnClientW</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o10">pfnListBoxWndProc</a>;
02339         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a280">gpfnwp</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a72">ICLS_SCROLLBAR</a>]  = (PROC)<a class="code" href="../../d8/d4/sbctl_8c.html#a47">xxxSBWndProc</a>;
02340         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a280">gpfnwp</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a73">ICLS_COMBOBOX</a>]  = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o9">apfnClientW</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o6">pfnComboBoxWndProc</a>;
02341         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a280">gpfnwp</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a75">ICLS_DESKTOP</a>]  = (PROC)<a class="code" href="../../d9/d6/desktop_8c.html#a10">xxxDesktopWndProc</a>;
02342         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a280">gpfnwp</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a76">ICLS_DIALOG</a>]  = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o9">apfnClientW</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o8">pfnDialogWndProc</a>;
02343         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a280">gpfnwp</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a77">ICLS_MENU</a>]  = (PROC)<a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a43">xxxMenuWindowProc</a>;
02344         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a280">gpfnwp</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a78">ICLS_SWITCH</a>]  = (PROC)<a class="code" href="../../d1/d3/tmswitch_8c.html#a28">xxxSwitchWndProc</a>;
02345         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a280">gpfnwp</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a79">ICLS_ICONTITLE</a>] = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o9">apfnClientW</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o1">pfnTitleWndProc</a>;
02346         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a280">gpfnwp</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a80">ICLS_MDICLIENT</a>] = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o9">apfnClientW</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o11">pfnMDIClientWndProc</a>;
02347         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a280">gpfnwp</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a81">ICLS_COMBOLISTBOX</a>] = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o9">apfnClientW</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o7">pfnComboListBoxProc</a>;
02348         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a280">gpfnwp</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a82">ICLS_DDEMLEVENT</a>] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02349         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a280">gpfnwp</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a83">ICLS_DDEMLMOTHER</a>] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02350         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a280">gpfnwp</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a84">ICLS_DDEML16BIT</a>] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02351         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a280">gpfnwp</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a85">ICLS_DDEMLCLIENTA</a>] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02352         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a280">gpfnwp</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a86">ICLS_DDEMLCLIENTW</a>] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02353         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a280">gpfnwp</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a87">ICLS_DDEMLSERVERA</a>] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02354         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a280">gpfnwp</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a88">ICLS_DDEMLSERVERW</a>] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02355         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a280">gpfnwp</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a89">ICLS_IME</a>] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02356         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a280">gpfnwp</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a90">ICLS_TOOLTIP</a>] = (PROC)<a class="code" href="../../d1/d4/tooltips_8c.html#a31">xxxTooltipWndProc</a>;
02357 
02358         <span class="comment">/*</span>
02359 <span class="comment">         * Change this assert when new classes are added.</span>
02360 <span class="comment">         */</span>
02361         UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a91">ICLS_MAX</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a90">ICLS_TOOLTIP</a>+1);
02362 
02363         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a274">hModClient</a> = hModUser;
02364         fHaveClientPfns = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02365     }
02366 <span class="preprocessor">#if DBG</span>
02367 <span class="preprocessor"></span>    <span class="comment">/*</span>
02368 <span class="comment">     * BradG - Verify that user32.dll on the client side has loaded</span>
02369 <span class="comment">     *   at the correct address.  If not, do an RIPMSG.</span>
02370 <span class="comment">     */</span>
02371 
02372     <span class="keywordflow">if</span>((ppfnClientA != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
02373        (<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o8">apfnClientA</a>.<a class="code" href="../../d0/d5/struct__PFNCLIENT.html#o5">pfnButtonWndProc</a> != ppfnClientA-&gt;pfnButtonWndProc))
02374         RIPMSG0(RIP_ERROR, <span class="stringliteral">"Client side user32.dll not loaded at same address."</span>);
02375 <span class="preprocessor">#endif</span>
02376 <span class="preprocessor"></span>
02377     <span class="keywordflow">return</span> STATUS_SUCCESS;
02378 }
02379 
02380 <span class="comment">/***************************************************************************\</span>
02381 <span class="comment">* GetKbdLangSwitch</span>
02382 <span class="comment">*</span>
02383 <span class="comment">* read the kbd language hotkey setting - if any - from the registry and set</span>
02384 <span class="comment">* LangToggle[] appropriately.</span>
02385 <span class="comment">*</span>
02386 <span class="comment">* values are:</span>
02387 <span class="comment">*              1 : VK_MENU     (this is the default)</span>
02388 <span class="comment">*              2 : VK_CONTROL</span>
02389 <span class="comment">*              3 : none</span>
02390 <span class="comment">* History:</span>
02391 <span class="comment">\***************************************************************************/</span>
02392 
<a name="l02393"></a><a class="code" href="../../d4/d1/userk_8h.html#a1305">02393</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1305">GetKbdLangSwitch</a>(PUNICODE_STRING pProfileUserName)
02394 {
02395     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwToggle;
02396     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  bStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02397     LCID  lcid;
02398 
02399     dwToggle = <a class="code" href="../../d4/d1/userk_8h.html#a2008">FastGetProfileIntW</a>(pProfileUserName,
02400                                   <a class="code" href="../../d4/d1/userk_8h.html#a720">PMAP_UKBDLAYOUTTOGGLE</a>,
02401                                   TEXT(<span class="stringliteral">"Hotkey"</span>),
02402                                   1);
02403 
02404     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a69">gbGraveKeyToggle</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02405 
02406     <span class="keywordflow">switch</span> (dwToggle) {
02407     <span class="keywordflow">case</span> 4:
02408         <span class="comment">/*</span>
02409 <span class="comment">         * Grave accent keyboard switch for thai locales</span>
02410 <span class="comment">         */</span>
02411         ZwQueryDefaultLocale(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;lcid);
02412         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a69">gbGraveKeyToggle</a> = (PRIMARYLANGID(lcid) == LANG_THAI) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02413         <span class="comment">/*</span>
02414 <span class="comment">         * fall through (intentional) and disable the ctrl/alt toggle mechanism</span>
02415 <span class="comment">         */</span>
02416     <span class="keywordflow">case</span> 3:
02417         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a65">gLangToggle</a>[0].<a class="code" href="../../d2/d9/structtagKBDLANGTOGGLE.html#o0">bVkey</a> = 0;
02418         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a65">gLangToggle</a>[0].<a class="code" href="../../d2/d9/structtagKBDLANGTOGGLE.html#o1">bScan</a> = 0;
02419         <span class="keywordflow">break</span>;
02420 
02421     <span class="keywordflow">case</span> 2:
02422         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a65">gLangToggle</a>[0].<a class="code" href="../../d2/d9/structtagKBDLANGTOGGLE.html#o0">bVkey</a> = VK_CONTROL;
02423         <span class="keywordflow">break</span>;
02424 
02425     <span class="keywordflow">default</span>:
02426         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a65">gLangToggle</a>[0].<a class="code" href="../../d2/d9/structtagKBDLANGTOGGLE.html#o0">bVkey</a> = VK_MENU;
02427         <span class="keywordflow">break</span>;
02428     }
02429 
02430     <span class="keywordflow">return</span> bStatus;
02431 }
02432 
02433 <span class="comment">/***************************************************************************\</span>
02434 <span class="comment">* xxxUpdatePerUserSystemParameters</span>
02435 <span class="comment">*</span>
02436 <span class="comment">* Called by winlogon to set Window system parameters to the current user's</span>
02437 <span class="comment">* profile.</span>
02438 <span class="comment">*</span>
02439 <span class="comment">* != 0 is failure.</span>
02440 <span class="comment">*</span>
02441 <span class="comment">* 18-Sep-1992 IanJa     Created.</span>
02442 <span class="comment">* 18-Nov-1993 SanfordS  Moved more winlogon init code to here for speed.</span>
02443 <span class="comment">\***************************************************************************/</span>
02444 
<a name="l02445"></a><a class="code" href="../../d4/d1/userk_8h.html#a1538">02445</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1538">xxxUpdatePerUserSystemParameters</a>(
02446     HANDLE hToken,
02447     BOOL   bUserLoggedOn)
02448 {
02449     <span class="keywordtype">int</span>            i;
02450     HANDLE         hKey;
02451     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>          dwFontSmoothing;
02452     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>           fDragFullWindows;
02453     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlName;
02454     PUNICODE_STRING pProfileUserName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02455 
02456 
02457     <span class="keyword">static</span> <span class="keyword">struct </span>{
02458         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> idSection;
02459         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <span class="keywordtype">id</span>;
02460         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> idRes;
02461         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> def;
02462     } spi[] = {
02463         { <a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>,  SPI_SETSCREENSAVETIMEOUT, STR_SCREENSAVETIMEOUT, 0 },
02464         { <a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>,  SPI_SETSCREENSAVEACTIVE,  STR_SCREENSAVEACTIVE,  0 },
02465         { <a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>,  SPI_SETDRAGHEIGHT,        STR_DRAGHEIGHT,        4 },
02466         { <a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>,  SPI_SETDRAGWIDTH,         STR_DRAGWIDTH,         4 },
02467         { <a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>,  SPI_SETWHEELSCROLLLINES,  STR_WHEELSCROLLLINES,  3 },
02468         { <a class="code" href="../../d4/d1/userk_8h.html#a708">PMAP_KEYBOARD</a>, SPI_SETKEYBOARDDELAY,     STR_KEYDELAY,          0 },
02469         { <a class="code" href="../../d4/d1/userk_8h.html#a708">PMAP_KEYBOARD</a>, SPI_SETKEYBOARDSPEED,     STR_KEYSPEED,         15 },
02470         { <a class="code" href="../../d4/d1/userk_8h.html#a707">PMAP_MOUSE</a>,    SPI_SETDOUBLECLICKTIME,   STR_DBLCLKSPEED,     500 },
02471         { <a class="code" href="../../d4/d1/userk_8h.html#a707">PMAP_MOUSE</a>,    SPI_SETDOUBLECLKWIDTH,    STR_DOUBLECLICKWIDTH,  4 },
02472         { <a class="code" href="../../d4/d1/userk_8h.html#a707">PMAP_MOUSE</a>,    SPI_SETDOUBLECLKHEIGHT,   STR_DOUBLECLICKHEIGHT, 4 },
02473         { <a class="code" href="../../d4/d1/userk_8h.html#a707">PMAP_MOUSE</a>,    SPI_SETSNAPTODEFBUTTON,   STR_SNAPTO,            0 },
02474         { <a class="code" href="../../d4/d1/userk_8h.html#a697">PMAP_WINDOWSU</a>, SPI_SETMENUDROPALIGNMENT, STR_MENUDROPALIGNMENT, 0 },
02475         { <a class="code" href="../../d4/d1/userk_8h.html#a730">PMAP_INPUTMETHOD</a>, SPI_SETSHOWIMEUI,      STR_SHOWIMESTATUS,     1 },
02476     };
02477 
02478     <a class="code" href="../../d0/d4/structtagPROFINTINFO.html">PROFINTINFO</a> apii[] = {
02479         { <a class="code" href="../../d4/d1/userk_8h.html#a707">PMAP_MOUSE</a>,    (LPWSTR)STR_MOUSETHRESH1,          6, &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a121">gMouseThresh1</a> },
02480         { <a class="code" href="../../d4/d1/userk_8h.html#a707">PMAP_MOUSE</a>,    (LPWSTR)STR_MOUSETHRESH2,         10, &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a122">gMouseThresh2</a> },
02481         { <a class="code" href="../../d4/d1/userk_8h.html#a707">PMAP_MOUSE</a>,    (LPWSTR)STR_MOUSESPEED,            1, &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a120">gMouseSpeed</a> },
02482         { <a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>,  (LPWSTR)STR_MENUSHOWDELAY,       400, &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a94">gdtMNDropDown</a> },
02483         { <a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>,  (LPWSTR)STR_DRAGFULLWINDOWS,       2, &amp;fDragFullWindows },
02484         { <a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>,  (LPWSTR)STR_FASTALTTABROWS,        3, &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a126">gnFastAltTabRows</a> },
02485         { <a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>,  (LPWSTR)STR_FASTALTTABCOLUMNS,     7, &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a127">gnFastAltTabColumns</a> },
02486         { <a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>,  (LPWSTR)STR_MAXLEFTOVERLAPCHARS,   3, &amp;(<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;wMaxLeftOverlapChars) },
02487         { <a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>,  (LPWSTR)STR_MAXRIGHTOVERLAPCHARS,  3, &amp;(<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;wMaxRightOverlapChars) },
02488         { <a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>,  (LPWSTR)STR_FONTSMOOTHING,         0, &amp;dwFontSmoothing },
02489         { <a class="code" href="../../d4/d1/userk_8h.html#a730">PMAP_INPUTMETHOD</a>, (LPWSTR)STR_HEXNUMPAD,          0, &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a68">gfEnableHexNumpad</a> },
02490         { 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> }
02491     };
02492 
02493     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
02494 
02495     UNREFERENCED_PARAMETER(hToken);
02496 
02497     <span class="comment">/*</span>
02498 <span class="comment">     * Make sure the caller is the logon process</span>
02499 <span class="comment">     */</span>
02500     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a19">GetCurrentProcessId</a>() != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a>) {
02501         RIPMSG0(RIP_WARNING, <span class="stringliteral">"Access denied in xxxUpdatePerUserSystemParameters"</span>);
02502         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02503     }
02504 
02505     pProfileUserName = <a class="code" href="../../d4/d1/userk_8h.html#a2000">CreateProfileUserName</a>(&amp;tlName);
02506 
02507     <span class="comment">/*</span>
02508 <span class="comment">     * Check for new policy.</span>
02509 <span class="comment">     */</span>
02510     <a class="code" href="../../d4/d1/userk_8h.html#a2004">CheckDesktopPolicyChange</a>(pProfileUserName);
02511 
02512     <span class="comment">/*</span>
02513 <span class="comment">     * Get the timeout for low level hooks from the registry</span>
02514 <span class="comment">     */</span>
02515     <a class="code" href="../../d4/d1/userk_8h.html#a2013">FastGetProfileValue</a>(pProfileUserName,
02516             <a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>,
02517             (LPWSTR)STR_LLHOOKSTIMEOUT,
02518             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02519             (LPBYTE)&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a259">gnllHooksTimeout</a>,
02520             <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)
02521             );
02522 
02523     <span class="comment">/*</span>
02524 <span class="comment">     * Control Panel User Preferences</span>
02525 <span class="comment">     */</span>
02526     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a37">LoadCPUserPreferences</a>(pProfileUserName);
02527 
02528     <span class="comment">/*</span>
02529 <span class="comment">     * Set syscolors from registry.</span>
02530 <span class="comment">     */</span>
02531 
02532     <a class="code" href="../../d4/d1/userk_8h.html#a1838">xxxODI_ColorInit</a>(pProfileUserName);
02533 
02534     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a39">LW_LoadResources</a>(pProfileUserName);
02535 
02536     <span class="comment">/*</span>
02537 <span class="comment">     * This is the initialization from Chicago</span>
02538 <span class="comment">     */</span>
02539     <a class="code" href="../../d4/d1/userk_8h.html#a1857">xxxSetWindowNCMetrics</a>(pProfileUserName, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, -1); <span class="comment">// Colors must be set first</span>
02540     <a class="code" href="../../d4/d1/userk_8h.html#a1856">SetMinMetrics</a>(pProfileUserName, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02541     <a class="code" href="../../d4/d1/userk_8h.html#a1858">SetIconMetrics</a>(pProfileUserName, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02542 
02543     <span class="comment">/*</span>
02544 <span class="comment">     * Read the keyboard layout switching hot key</span>
02545 <span class="comment">     */</span>
02546     <a class="code" href="../../d4/d1/userk_8h.html#a1305">GetKbdLangSwitch</a>(pProfileUserName);
02547 
02548     <span class="comment">/*</span>
02549 <span class="comment">     * Set the default thread locale for the system based on the value</span>
02550 <span class="comment">     * in the current user's registry profile.</span>
02551 <span class="comment">     */</span>
02552     ZwSetDefaultLocale( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, 0 );
02553 
02554     <span class="comment">/*</span>
02555 <span class="comment">     * Set the default UI language based on the value in the current</span>
02556 <span class="comment">     * user's registry profile.</span>
02557 <span class="comment">     */</span>
02558     ZwSetDefaultUILanguage(0);
02559 
02560     <span class="comment">/*</span>
02561 <span class="comment">     * And then Get it.</span>
02562 <span class="comment">     */</span>
02563     ZwQueryDefaultUILanguage(&amp;(<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;UILangID));
02564 
02565 
02566     <span class="comment">/*</span>
02567 <span class="comment">     * Destroy the desktop system menus, so that they're recreated with</span>
02568 <span class="comment">     * the correct UI language if the current user's UI language is different</span>
02569 <span class="comment">     * from the previous one. This is done by finding the interactive</span>
02570 <span class="comment">     * window station and destroying all its desktops's system menus.</span>
02571 <span class="comment">     */</span>
02572     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a241">grpWinStaList</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02573         <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>        pdesk;
02574         <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a>           pmenu;
02575 
02576         UserAssert(!(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a241">grpWinStaList</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>));
02577         <span class="keywordflow">for</span> (pdesk = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a241">grpWinStaList</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o1">rpdeskList</a>; pdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pdesk = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o2">rpdeskNext</a>) {
02578             <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o7">spmenuSys</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02579                 pmenu = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o7">spmenuSys</a>;
02580                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1606">UnlockDesktopSysMenu</a>(&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o7">spmenuSys</a>))
02581                     <a class="code" href="../../d4/d1/userk_8h.html#a1887">_DestroyMenu</a>(pmenu);
02582             }
02583             <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o8">spmenuDialogSys</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02584                 pmenu = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o8">spmenuDialogSys</a>;
02585                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1606">UnlockDesktopSysMenu</a>(&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o8">spmenuDialogSys</a>))
02586                     <a class="code" href="../../d4/d1/userk_8h.html#a1887">_DestroyMenu</a>(pmenu);
02587             }
02588         }
02589     }
02590 
02591     <a class="code" href="../../d4/d1/userk_8h.html#a1840">xxxUpdateSystemCursorsFromRegistry</a>(pProfileUserName);
02592 
02593     <span class="comment">/*</span>
02594 <span class="comment">     * desktop Pattern now.  Note no parameters.  It just goes off</span>
02595 <span class="comment">     * and reads win.ini and sets the desktop pattern.</span>
02596 <span class="comment">     */</span>
02597     <a class="code" href="../../d4/d1/userk_8h.html#a1493">xxxSystemParametersInfo</a>(SPI_SETDESKPATTERN, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, 0); <span class="comment">// 265 version</span>
02598 
02599     <span class="comment">/*</span>
02600 <span class="comment">     * Initialize IME show status</span>
02601 <span class="comment">     */</span>
02602     <span class="keywordflow">if</span> (bUserLoggedOn) {
02603         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a234">gfIMEShowStatus</a> = <a class="code" href="../../d4/d1/userk_8h.html#a744">IMESHOWSTATUS_NOTINITIALIZED</a>;
02604     }
02605 
02606     <span class="comment">/*</span>
02607 <span class="comment">     * now go set a bunch of random values from the win.ini file.</span>
02608 <span class="comment">     */</span>
02609     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(spi); i++) {
02610 
02611         <a class="code" href="../../d4/d1/userk_8h.html#a1493">xxxSystemParametersInfo</a>(
02612                 spi[i].<span class="keywordtype">id</span>,
02613                 <a class="code" href="../../d4/d1/userk_8h.html#a2010">FastGetProfileIntFromID</a>(pProfileUserName,
02614                                          spi[i].idSection,
02615                                          spi[i].idRes,
02616                                          spi[i].def
02617                                          ),
02618                 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
02619                 0
02620                 );
02621     }
02622 
02623     <span class="comment">/*</span>
02624 <span class="comment">     * read profile integers and do any fixups</span>
02625 <span class="comment">     */</span>
02626     <a class="code" href="../../d4/d1/userk_8h.html#a2014">FastGetProfileIntsW</a>(pProfileUserName, apii);
02627 
02628     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a127">gnFastAltTabColumns</a> &lt; 2)
02629         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a127">gnFastAltTabColumns</a> = 7;
02630 
02631     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a126">gnFastAltTabRows</a> &lt; 1)
02632         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a126">gnFastAltTabRows</a> = 3;
02633 
02634     <span class="comment">/*</span>
02635 <span class="comment">     * If this is the first time the user logs on, set the DragFullWindows</span>
02636 <span class="comment">     * to the default. If we have an accelerated device, enable full drag.</span>
02637 <span class="comment">     */</span>
02638     <span class="keywordflow">if</span> (fDragFullWindows == 2) {
02639 
02640         LPWSTR pwszd = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"%d"</span>;
02641         WCHAR  szTemp[40];
02642         WCHAR  szDragFullWindows[40];
02643 
02644         <a class="code" href="../../d4/d1/userk_8h.html#a661">SET_OR_CLEAR_PUDF</a>(
02645                 <a class="code" href="../../d4/d1/userk_8h.html#a641">PUDF_DRAGFULLWINDOWS</a>,
02646                 GreGetDeviceCaps(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o3">hdcScreen</a>, BLTALIGNMENT) == 0);
02647 
02648         <span class="keywordflow">if</span> (bUserLoggedOn) {
02649             swprintf(szTemp, pwszd, <a class="code" href="../../d4/d1/userk_8h.html#a658">TEST_BOOL_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a641">PUDF_DRAGFULLWINDOWS</a>));
02650 
02651             <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>,
02652                              STR_DRAGFULLWINDOWS,
02653                              szDragFullWindows,
02654                              <span class="keyword">sizeof</span>(szDragFullWindows) / <span class="keyword">sizeof</span>(WCHAR));
02655 
02656             <a class="code" href="../../d4/d1/userk_8h.html#a2009">FastWriteProfileStringW</a>(pProfileUserName,
02657                                     <a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>,
02658                                     szDragFullWindows,
02659                                     szTemp);
02660         }
02661     } <span class="keywordflow">else</span> {
02662         <a class="code" href="../../d4/d1/userk_8h.html#a661">SET_OR_CLEAR_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a641">PUDF_DRAGFULLWINDOWS</a>, fDragFullWindows);
02663     }
02664 
02665     <span class="comment">/*</span>
02666 <span class="comment">     * !!!LATER!!! (adams) See if the following profile retrievals can't</span>
02667 <span class="comment">     * be done in the "spi" array above (e.g. SPI_SETSNAPTO).</span>
02668 <span class="comment">     */</span>
02669 
02670     <span class="comment">/*</span>
02671 <span class="comment">     * Set mouse settings</span>
02672 <span class="comment">     */</span>
02673     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a124">gMouseSensitivity</a> = <a class="code" href="../../d4/d1/userk_8h.html#a2010">FastGetProfileIntFromID</a>(pProfileUserName,<a class="code" href="../../d4/d1/userk_8h.html#a707">PMAP_MOUSE</a>, STR_MOUSESENSITIVITY, <a class="code" href="../../d4/d1/userk_8h.html#a484">MOUSE_SENSITIVITY_DEFAULT</a>);
02674     <span class="keywordflow">if</span> ((gMouseSensitivity &lt; MOUSE_SENSITIVITY_MIN) || (gMouseSensitivity &gt; <a class="code" href="../../d4/d1/userk_8h.html#a485">MOUSE_SENSITIVITY_MAX</a>)) {
02675         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a124">gMouseSensitivity</a> = <a class="code" href="../../d4/d1/userk_8h.html#a484">MOUSE_SENSITIVITY_DEFAULT</a> ;
02676     }
02677     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a123">gMouseSensitivityFactor</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1031">CalculateMouseSensitivity</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a124">gMouseSensitivity</a>) ;
02678 
02679     <a class="code" href="../../d4/d1/userk_8h.html#a1727">_SetCaretBlinkTime</a>(<a class="code" href="../../d4/d1/userk_8h.html#a2010">FastGetProfileIntFromID</a>(pProfileUserName,<a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>, STR_BLINK, 500));
02680 
02681     <span class="comment">/*</span>
02682 <span class="comment">     * Font Information</span>
02683 <span class="comment">     */</span>
02684     GreSetFontEnumeration( <a class="code" href="../../d4/d1/userk_8h.html#a2008">FastGetProfileIntW</a>(pProfileUserName,<a class="code" href="../../d4/d1/userk_8h.html#a701">PMAP_TRUETYPE</a>, TEXT(<span class="stringliteral">"TTOnly"</span>), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>));
02685 
02686     <span class="comment">/*</span>
02687 <span class="comment">     * Mouse tracking variables</span>
02688 <span class="comment">     */</span>
02689     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a102">gcxMouseHover</a> = <a class="code" href="../../d4/d1/userk_8h.html#a2010">FastGetProfileIntFromID</a>(pProfileUserName,<a class="code" href="../../d4/d1/userk_8h.html#a707">PMAP_MOUSE</a>, STR_MOUSEHOVERWIDTH, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXDOUBLECLK));
02690     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a103">gcyMouseHover</a> = <a class="code" href="../../d4/d1/userk_8h.html#a2010">FastGetProfileIntFromID</a>(pProfileUserName,<a class="code" href="../../d4/d1/userk_8h.html#a707">PMAP_MOUSE</a>, STR_MOUSEHOVERHEIGHT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYDOUBLECLK));
02691     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a104">gdtMouseHover</a> = <a class="code" href="../../d4/d1/userk_8h.html#a2010">FastGetProfileIntFromID</a>(pProfileUserName,<a class="code" href="../../d4/d1/userk_8h.html#a707">PMAP_MOUSE</a>, STR_MOUSEHOVERTIME, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a94">gdtMNDropDown</a>);
02692 
02693     <span class="comment">/*</span>
02694 <span class="comment">     * Window animation</span>
02695 <span class="comment">     */</span>
02696     <a class="code" href="../../d4/d1/userk_8h.html#a661">SET_OR_CLEAR_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a636">PUDF_ANIMATE</a>,
02697                       <a class="code" href="../../d4/d1/userk_8h.html#a2010">FastGetProfileIntFromID</a>(pProfileUserName,<a class="code" href="../../d4/d1/userk_8h.html#a718">PMAP_METRICS</a>, STR_MINANIMATE, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
02698 
02699     <span class="comment">/*</span>
02700 <span class="comment">     * Initial Keyboard state:  ScrollLock, NumLock and CapsLock state;</span>
02701 <span class="comment">     * global (per-user) kbd layout attributes (such as ShiftLock/CapsLock)</span>
02702 <span class="comment">     */</span>
02703     <a class="code" href="../../d4/d1/userk_8h.html#a1718">UpdatePerUserKeyboardIndicators</a>(pProfileUserName);
02704 
02705     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a73">gdwKeyboardAttributes</a> = KLL_GLOBAL_ATTR_FROM_KLF(<a class="code" href="../../d4/d1/userk_8h.html#a2006">FastGetProfileDwordW</a>(pProfileUserName,<a class="code" href="../../d4/d1/userk_8h.html#a719">PMAP_UKBDLAYOUT</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Attributes"</span>, 0));
02706 
02707     <a class="code" href="../../d4/d1/userk_8h.html#a1853">xxxUpdatePerUserAccessPackSettings</a>(pProfileUserName);
02708 
02709     <span class="comment">/*</span>
02710 <span class="comment">     * If we successfully opened this, we assume we have a network.</span>
02711 <span class="comment">     */</span>
02712     <span class="keywordflow">if</span> (hKey = <a class="code" href="../../d4/d1/userk_8h.html#a2002">OpenCacheKeyEx</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d1/userk_8h.html#a717">PMAP_NETWORK</a>, KEY_READ, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02713         RIPMSG0(RIP_WARNING | RIP_NONAME, <span class="stringliteral">""</span>);
02714         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(NETWORK) = RNC_NETWORKS;
02715 
02716         ZwClose(hKey);
02717     }
02718 
02719     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(NETWORK) |= RNC_LOGON;
02720 
02721     <span class="comment">/*</span>
02722 <span class="comment">     * Font smoothing</span>
02723 <span class="comment">     */</span>
02724     UserAssert ((dwFontSmoothing == 0) || (dwFontSmoothing == FE_AA_ON));
02725     GreSetFontEnumeration( dwFontSmoothing | FE_SET_AA );
02726 
02727     <span class="comment">/*</span>
02728 <span class="comment">     * Desktop Build Number Painting</span>
02729 <span class="comment">     */</span>
02730     <span class="keywordflow">if</span> (USER_SHARED_DATA-&gt;SystemExpirationDate.QuadPart || <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a8">gfUnsignedDrivers</a>) {
02731         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a358">gdwCanPaintDesktop</a> = 1;
02732     } <span class="keywordflow">else</span> {
02733         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a358">gdwCanPaintDesktop</a> = <a class="code" href="../../d4/d1/userk_8h.html#a2006">FastGetProfileDwordW</a>(pProfileUserName, <a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"PaintDesktopVersion"</span>, 0);
02734     }
02735 
02736     <a class="code" href="../../d4/d1/userk_8h.html#a2001">FreeProfileUserName</a>(pProfileUserName, &amp;tlName);
02737     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02738 }
02739 
02740 <span class="comment">/*</span>
02741 <span class="comment"> * Called by InitOemXlateTables via SFI_INITANSIOEM</span>
02742 <span class="comment"> */</span>
<a name="l02743"></a><a class="code" href="../../d4/d1/userk_8h.html#a1850">02743</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1850">InitAnsiOem</a>(PCHAR pOemToAnsi, PCHAR pAnsiToOem) {
02744 
02745     UserAssert(<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>);
02746     UserAssert(pOemToAnsi);
02747     UserAssert(pAnsiToOem);
02748 
02749     <span class="keywordflow">try</span> {
02750         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(pOemToAnsi, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a362">NCHARS</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>));
02751         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(pAnsiToOem, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a362">NCHARS</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>));
02752 
02753         RtlCopyMemory(<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o31">acOemToAnsi</a>, pOemToAnsi, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a362">NCHARS</a>);
02754         RtlCopyMemory(<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o32">acAnsiToOem</a>, pAnsiToOem, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a362">NCHARS</a>);
02755 
02756 
02757     } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
02758     }
02759 }
02760 
02761 <span class="comment">/***************************************************************************\</span>
02762 <span class="comment">* RegisterLPK</span>
02763 <span class="comment">*</span>
02764 <span class="comment">* Called by InitializeLpkHooks on the client side after an LPK is</span>
02765 <span class="comment">* loaded for the current process.</span>
02766 <span class="comment">*</span>
02767 <span class="comment">* 05-Nov-1996 GregoryW  Created.</span>
02768 <span class="comment">\***************************************************************************/</span>
<a name="l02769"></a><a class="code" href="../../d4/d1/userk_8h.html#a1842">02769</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1842">RegisterLPK</a>(
02770     DWORD dwLpkEntryPoints)
02771 {
02772     <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()-&gt;dwLpkEntryPoints = dwLpkEntryPoints;
02773 }
02774 
02775 <span class="comment">/***************************************************************************\</span>
02776 <span class="comment">* Enforce color-depth dependent settings on systems with less</span>
02777 <span class="comment">* then 256 colors.</span>
02778 <span class="comment">*</span>
02779 <span class="comment">* 2/13/1998   vadimg          created</span>
02780 <span class="comment">\***************************************************************************/</span>
02781 
<a name="l02782"></a><a class="code" href="../../d4/d1/userk_8h.html#a1852">02782</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a61">EnforceColorDependentSettings</a>(<span class="keywordtype">void</span>)
02783 {
02784     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o19">fAnyPalette</a>) {
02785         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a252">gbDisableAlpha</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02786     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (GreGetDeviceCaps(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o3">hdcScreen</a>, NUMCOLORS) == -1) {
02787         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a252">gbDisableAlpha</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02788     } <span class="keywordflow">else</span> {
02789         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a252">gbDisableAlpha</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02790     }
02791 }
02792 
02793 <span class="preprocessor">#if DBG</span>
02794 <span class="preprocessor"></span><span class="keywordtype">void</span> InitGlobalThreadLockArray(DWORD dwIndex)
02795 {
02796     <a class="code" href="../../d5/d1/struct__TL.html">PTL</a> pTLArray = gpaThreadLocksArrays[dwIndex];
02797     <span class="keywordtype">int</span> i;
02798     <span class="keywordflow">for</span> (i = 0; i &lt; MAX_THREAD_LOCKS-1; i++) {
02799         pTLArray[i].next = &amp;pTLArray[i+1];
02800     }
02801     pTLArray[MAX_THREAD_LOCKS-1].next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02802 }
02803 <span class="preprocessor">#endif // DBG</span>
02804 <span class="preprocessor"></span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:22 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
