<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cmindex.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cmindex.c</h1><a href="../../d7/d1/cmindex_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    cmindex.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains cm routines that understand the structure</span>
00012 <span class="comment">    of child subkey indicies.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Bryan M. Willman (bryanwi) 21-Apr-92</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="comment">/*</span>
00023 <span class="comment"></span>
00024 <span class="comment">The Structure:</span>
00025 <span class="comment"></span>
00026 <span class="comment">    Use a 1 or 2 level tree.  Leaf nodes are arrays of pointers to</span>
00027 <span class="comment">    cells, sorted.  Binary search to find cell of interest.  Directory</span>
00028 <span class="comment">    node (can be only one) is an array of pointers to leaf blocks.</span>
00029 <span class="comment">    Do compare on last entry of each leaf block.</span>
00030 <span class="comment"></span>
00031 <span class="comment">    One Level:</span>
00032 <span class="comment"></span>
00033 <span class="comment">        Key---&gt;+----+</span>
00034 <span class="comment">               |    |</span>
00035 <span class="comment">               |  x----------&gt;&lt;key whose name is "apple", string in key&gt;</span>
00036 <span class="comment">               |    |</span>
00037 <span class="comment">               +----+</span>
00038 <span class="comment">               |    |</span>
00039 <span class="comment">               |  x----------&gt;&lt;as above, but key named "banana"&gt;</span>
00040 <span class="comment">               |    |</span>
00041 <span class="comment">               +----+</span>
00042 <span class="comment">               |    |</span>
00043 <span class="comment">               |    |</span>
00044 <span class="comment">               |    |</span>
00045 <span class="comment">               +----+</span>
00046 <span class="comment">               |    |</span>
00047 <span class="comment">               |    |</span>
00048 <span class="comment">               |    |</span>
00049 <span class="comment">               +----+</span>
00050 <span class="comment">               |    |</span>
00051 <span class="comment">               |  x----------&gt;&lt;as above, but key named "zumwat"&gt;</span>
00052 <span class="comment">               |    |</span>
00053 <span class="comment">               +----+</span>
00054 <span class="comment"></span>
00055 <span class="comment"></span>
00056 <span class="comment">    Two Level:</span>
00057 <span class="comment"></span>
00058 <span class="comment">        Key---&gt;+----+</span>
00059 <span class="comment">               |    |    +-----+</span>
00060 <span class="comment">               |  x-----&gt;|     |</span>
00061 <span class="comment">               |    |    |  x-----------------&gt;"aaa"</span>
00062 <span class="comment">               +----+    |     |</span>
00063 <span class="comment">               |    |    +-----+</span>
00064 <span class="comment">               |    |    |     |</span>
00065 <span class="comment">               |    |    |     |</span>
00066 <span class="comment">               +----+    |     |</span>
00067 <span class="comment">               |    |    +-----+</span>
00068 <span class="comment">               |    |    |     |</span>
00069 <span class="comment">               |    |    |  x-----------------&gt;"abc"</span>
00070 <span class="comment">               +----+    |     |</span>
00071 <span class="comment">               |    |    +-----+</span>
00072 <span class="comment">               |    |</span>
00073 <span class="comment">               |    |</span>
00074 <span class="comment">               +----+</span>
00075 <span class="comment">               |    |    +-----+</span>
00076 <span class="comment">               |  x-----&gt;|     |</span>
00077 <span class="comment">               |    |    |  x-----------------&gt;"w"</span>
00078 <span class="comment">               +----+    |     |</span>
00079 <span class="comment">                         +-----+</span>
00080 <span class="comment">                         |     |</span>
00081 <span class="comment">                         |     |</span>
00082 <span class="comment">                         |     |</span>
00083 <span class="comment">                         +-----+</span>
00084 <span class="comment">                         |     |</span>
00085 <span class="comment">                         |  x-----------------&gt;"z"</span>
00086 <span class="comment">                         |     |</span>
00087 <span class="comment">                         +-----+</span>
00088 <span class="comment"></span>
00089 <span class="comment"></span>
00090 <span class="comment">    Never more than two levels.</span>
00091 <span class="comment"></span>
00092 <span class="comment">    Each block must fix in on HBLOCK_SIZE Cell.  Allows about 1000</span>
00093 <span class="comment">    entries.  Max of 1 million total, best case.  Worst case something</span>
00094 <span class="comment">    like 1/4 of that.</span>
00095 <span class="comment"></span>
00096 <span class="comment">*/</span>
00097 
00098 <span class="preprocessor">#include    "<a class="code" href="../../d1/d2/cmp_8h.html">cmp.h</a>"</span>
00099 
00100 ULONG
00101 <a class="code" href="../../d7/d1/cmindex_8c.html#a2">CmpFindSubKeyInRoot</a>(
00102     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
00103     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   Index,
00104     PUNICODE_STRING SearchName,
00105     PHCELL_INDEX    Child
00106     );
00107 
00108 ULONG
00109 <a class="code" href="../../d7/d1/cmindex_8c.html#a3">CmpFindSubKeyInLeaf</a>(
00110     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
00111     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   Index,
00112     ULONG           IndexHint,
00113     PUNICODE_STRING SearchName,
00114     PHCELL_INDEX    Child
00115     );
00116 
00117 LONG
00118 <a class="code" href="../../d7/d1/cmindex_8c.html#a4">CmpCompareInIndex</a>(
00119     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
00120     PUNICODE_STRING SearchName,
00121     ULONG           Count,
00122     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   Index,
00123     PHCELL_INDEX    Child
00124     );
00125 
00126 LONG
00127 <a class="code" href="../../d7/d1/cmindex_8c.html#a5">CmpDoCompareKeyName</a>(
00128     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
00129     PUNICODE_STRING SearchName,
00130     HCELL_INDEX     Cell
00131     );
00132 
00133 <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>
00134 <a class="code" href="../../d7/d1/cmindex_8c.html#a6">CmpDoFindSubKeyByNumber</a>(
00135     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
00136     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   Index,
00137     ULONG           Number
00138     );
00139 
00140 <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>
00141 <a class="code" href="../../d7/d1/cmindex_8c.html#a7">CmpAddToLeaf</a>(
00142     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
00143     HCELL_INDEX     LeafCell,
00144     HCELL_INDEX     NewKey,
00145     PUNICODE_STRING NewName
00146     );
00147 
00148 <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>
00149 <a class="code" href="../../d7/d1/cmindex_8c.html#a8">CmpSelectLeaf</a>(
00150     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
00151     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>    ParentKey,
00152     PUNICODE_STRING NewName,
00153     HSTORAGE_TYPE   Type,
00154     PHCELL_INDEX    *RootPointer
00155     );
00156 
00157 <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>
00158 <a class="code" href="../../d7/d1/cmindex_8c.html#a9">CmpSplitLeaf</a>(
00159     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
00160     HCELL_INDEX     RootCell,
00161     ULONG           RootSelect,
00162     HSTORAGE_TYPE   Type
00163     );
00164 
00165 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00166 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpFindSubKeyByName)</span>
00167 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpFindSubKeyInRoot)</span>
00168 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpFindSubKeyInLeaf)</span>
00169 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpDoCompareKeyName)</span>
00170 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpCompareInIndex)</span>
00171 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpFindSubKeyByNumber)</span>
00172 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpDoFindSubKeyByNumber)</span>
00173 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpAddSubKey)</span>
00174 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpAddToLeaf)</span>
00175 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpSelectLeaf)</span>
00176 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpSplitLeaf)</span>
00177 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpMarkIndexDirty)</span>
00178 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpRemoveSubKey)</span>
00179 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00180 <span class="preprocessor"></span>
<a name="l00181"></a><a class="code" href="../../d7/d1/cmindex_8c.html#a0">00181</a> ULONG <a class="code" href="../../d7/d1/cmindex_8c.html#a0">CmpHintHits</a>=0;
<a name="l00182"></a><a class="code" href="../../d7/d1/cmindex_8c.html#a1">00182</a> ULONG <a class="code" href="../../d7/d1/cmindex_8c.html#a1">CmpHintMisses</a>=0;
00183 
00184 
00185 <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>
<a name="l00186"></a><a class="code" href="../../d1/d2/cmp_8h.html#a303">00186</a> <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(
00187     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
00188     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>    Parent,
00189     PUNICODE_STRING SearchName
00190     )
00191 <span class="comment">/*++</span>
00192 <span class="comment"></span>
00193 <span class="comment">Routine Description:</span>
00194 <span class="comment"></span>
00195 <span class="comment">    Find the child cell (either subkey or value) specified by name.</span>
00196 <span class="comment"></span>
00197 <span class="comment">Arguments:</span>
00198 <span class="comment"></span>
00199 <span class="comment">    Hive - pointer to hive control structure for hive of interest</span>
00200 <span class="comment"></span>
00201 <span class="comment">    Parent - cell of key body which is parent of child of interest</span>
00202 <span class="comment"></span>
00203 <span class="comment">    SearchName - name of child of interest</span>
00204 <span class="comment"></span>
00205 <span class="comment">Return Value:</span>
00206 <span class="comment"></span>
00207 <span class="comment">    Cell of matching child key, or HCELL_NIL if none.</span>
00208 <span class="comment"></span>
00209 <span class="comment">--*/</span>
00210 {
00211     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   IndexRoot;
00212     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     Child;
00213     ULONG           i;
00214     ULONG           FoundIndex;
00215 
00216     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a39">CMS_INDEX</a>) {
00217         KdPrint((<span class="stringliteral">"CmpFindSubKeyByName:\n\t"</span>));
00218         KdPrint((<span class="stringliteral">"Hive=%08lx Parent=%08lx SearchName=%08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Parent, SearchName));
00219     }
00220 
00221     <span class="comment">//</span>
00222     <span class="comment">// Try first the Stable, then the Volatile store.  Assumes that</span>
00223     <span class="comment">// all Volatile refs in Stable space are zeroed out at boot.</span>
00224     <span class="comment">//</span>
00225     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o20">StorageTypeCount</a>; i++) {
00226         <span class="keywordflow">if</span> (Parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[i] != 0) {
00227             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d0/hivecell_8c.html#a21">HvIsCellAllocated</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[i]));
00228             IndexRoot = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[i]);
00229 
00230             <span class="keywordflow">if</span> (IndexRoot-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a18">CM_KEY_INDEX_ROOT</a>) {
00231                 <a class="code" href="../../d7/d1/cmindex_8c.html#a2">CmpFindSubKeyInRoot</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, IndexRoot, SearchName, &amp;Child);
00232                 <span class="keywordflow">if</span> (Child == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00233                     <span class="keywordflow">continue</span>;
00234                 }
00235                 IndexRoot = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Child);
00236             }
00237             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((IndexRoot-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a19">CM_KEY_INDEX_LEAF</a>) ||
00238                    (IndexRoot-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a20">CM_KEY_FAST_LEAF</a>));
00239 
00240             FoundIndex = <a class="code" href="../../d7/d1/cmindex_8c.html#a3">CmpFindSubKeyInLeaf</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00241                                              IndexRoot,
00242                                              Parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o15">WorkVar</a>,
00243                                              SearchName,
00244                                              &amp;Child);
00245             <span class="keywordflow">if</span> (Child != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00246                 <span class="comment">//</span>
00247                 <span class="comment">// WorkVar is used as a hint for the last successful lookup</span>
00248                 <span class="comment">// to improve our locality when similar keys are opened</span>
00249                 <span class="comment">// repeatedly.</span>
00250                 <span class="comment">//</span>
00251                 <span class="keywordflow">if</span> (FoundIndex == Parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o15">WorkVar</a>) {
00252                     <a class="code" href="../../d7/d1/cmindex_8c.html#a0">CmpHintHits</a>++;
00253                 } <span class="keywordflow">else</span> {
00254                     <a class="code" href="../../d7/d1/cmindex_8c.html#a1">CmpHintMisses</a>++;
00255                 }
00256                 Parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o15">WorkVar</a> = FoundIndex;
00257                 <span class="keywordflow">return</span> Child;
00258             }
00259         }
00260     }
00261     <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00262 }
00263 
00264 
00265 ULONG
<a name="l00266"></a><a class="code" href="../../d7/d1/cmindex_8c.html#a2">00266</a> <a class="code" href="../../d7/d1/cmindex_8c.html#a2">CmpFindSubKeyInRoot</a>(
00267     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
00268     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   Index,
00269     PUNICODE_STRING SearchName,
00270     PHCELL_INDEX    Child
00271     )
00272 <span class="comment">/*++</span>
00273 <span class="comment"></span>
00274 <span class="comment">Routine Description:</span>
00275 <span class="comment"></span>
00276 <span class="comment">    Find the leaf index that would contain a key, if there is one.</span>
00277 <span class="comment"></span>
00278 <span class="comment">Arguments:</span>
00279 <span class="comment"></span>
00280 <span class="comment">    Hive - pointer to hive control structure for hive of interest</span>
00281 <span class="comment"></span>
00282 <span class="comment">    Index - pointer to root index block</span>
00283 <span class="comment"></span>
00284 <span class="comment">    SearchName - pointer to name of key of interest</span>
00285 <span class="comment"></span>
00286 <span class="comment">    Child - pointer to variable to receive hcell_index of found leaf index</span>
00287 <span class="comment">            block, HCELL_NIL if none.  Non nil does not necessarily mean</span>
00288 <span class="comment">            the key is present, call FindSubKeyInLeaf to decide that.</span>
00289 <span class="comment"></span>
00290 <span class="comment">Return Value:</span>
00291 <span class="comment"></span>
00292 <span class="comment">    Index in List of last Leaf Cell entry examined.  If Child != HCELL_NIL,</span>
00293 <span class="comment">    Index is entry that matched, else, index is for last entry we looked</span>
00294 <span class="comment">    at.  (Target Leaf will be this value plus or minus 1)</span>
00295 <span class="comment"></span>
00296 <span class="comment">--*/</span>
00297 {
00298     ULONG           High;
00299     ULONG           Low;
00300     ULONG           CanCount;
00301     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     LeafCell;
00302     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   Leaf;
00303     LONG            Result;
00304 
00305     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a39">CMS_INDEX</a>) {
00306         KdPrint((<span class="stringliteral">"CmpFindSubKeyInRoot:\n\t"</span>));
00307         KdPrint((<span class="stringliteral">"Hive=%08lx Index=%08lx SearchName=%08lx\n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>,SearchName));
00308     }
00309 
00310 
00311     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Count != 0);
00312     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == <a class="code" href="../../d9/d0/cmdata_8h.html#a18">CM_KEY_INDEX_ROOT</a>);
00313 
00314     High = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Count - 1;
00315     Low = 0;
00316 
00317     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00318 
00319         <span class="comment">//</span>
00320         <span class="comment">// Compute where to look next, get correct pointer, do compare</span>
00321         <span class="comment">//</span>
00322         CanCount = ((High-Low)/2)+Low;
00323         LeafCell = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[CanCount];
00324         Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, LeafCell);
00325 
00326         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a19">CM_KEY_INDEX_LEAF</a>) ||
00327                (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a20">CM_KEY_FAST_LEAF</a>));
00328         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> != 0);
00329 
00330         Result = <a class="code" href="../../d7/d1/cmindex_8c.html#a4">CmpCompareInIndex</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00331                                    SearchName,
00332                                    Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a>-1,
00333                                    Leaf,
00334                                    Child);
00335 
00336         <span class="keywordflow">if</span> (Result == 0) {
00337 
00338             <span class="comment">//</span>
00339             <span class="comment">// SearchName == KeyName of last key in leaf, so</span>
00340             <span class="comment">//  this is our leaf</span>
00341             <span class="comment">//</span>
00342             *Child = LeafCell;
00343             <span class="keywordflow">return</span> CanCount;
00344         }
00345 
00346         <span class="keywordflow">if</span> (Result &lt; 0) {
00347 
00348             <span class="comment">//</span>
00349             <span class="comment">// SearchName &lt; KeyName, so this may still be our leaf</span>
00350             <span class="comment">//</span>
00351             Result = <a class="code" href="../../d7/d1/cmindex_8c.html#a4">CmpCompareInIndex</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00352                                        SearchName,
00353                                        0,
00354                                        Leaf,
00355                                        Child);
00356 
00357             <span class="keywordflow">if</span> (Result &gt;= 0) {
00358 
00359                 <span class="comment">//</span>
00360                 <span class="comment">// we know from above that SearchName is less than</span>
00361                 <span class="comment">// last key in leaf.</span>
00362                 <span class="comment">// since it is also &gt;= first key in leaf, it must</span>
00363                 <span class="comment">// reside in leaf somewhere, and we are done</span>
00364                 <span class="comment">//</span>
00365                 *Child = LeafCell;
00366                 <span class="keywordflow">return</span> CanCount;
00367             }
00368 
00369             High = CanCount;
00370 
00371         } <span class="keywordflow">else</span> {
00372 
00373             <span class="comment">//</span>
00374             <span class="comment">// SearchName &gt; KeyName</span>
00375             <span class="comment">//</span>
00376             Low = CanCount;
00377         }
00378 
00379         <span class="keywordflow">if</span> ((High - Low) &lt;= 1) {
00380             <span class="keywordflow">break</span>;
00381         }
00382     }
00383 
00384     <span class="comment">//</span>
00385     <span class="comment">// If we get here, High - Low = 1 or High == Low</span>
00386     <span class="comment">//</span>
00387     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((High - Low == 1) || (High == Low));
00388     LeafCell = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[Low];
00389     Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, LeafCell);
00390     Result = <a class="code" href="../../d7/d1/cmindex_8c.html#a4">CmpCompareInIndex</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00391                                SearchName,
00392                                Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a>-1,
00393                                Leaf,
00394                                Child);
00395 
00396     <span class="keywordflow">if</span> (Result == 0) {
00397 
00398         <span class="comment">//</span>
00399         <span class="comment">// found it</span>
00400         <span class="comment">//</span>
00401         *Child = LeafCell;
00402         <span class="keywordflow">return</span> Low;
00403     }
00404 
00405     <span class="keywordflow">if</span> (Result &lt; 0) {
00406 
00407         <span class="comment">//</span>
00408         <span class="comment">// SearchName &lt; KeyName, so this may still be our leaf</span>
00409         <span class="comment">//</span>
00410         Result = <a class="code" href="../../d7/d1/cmindex_8c.html#a4">CmpCompareInIndex</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00411                                    SearchName,
00412                                    0,
00413                                    Leaf,
00414                                    Child);
00415 
00416         <span class="keywordflow">if</span> (Result &gt;= 0) {
00417 
00418             <span class="comment">//</span>
00419             <span class="comment">// we know from above that SearchName is less than</span>
00420             <span class="comment">// last key in leaf.</span>
00421             <span class="comment">// since it is also &gt;= first key in leaf, it must</span>
00422             <span class="comment">// reside in leaf somewhere, and we are done</span>
00423             <span class="comment">//</span>
00424             *Child = LeafCell;
00425             <span class="keywordflow">return</span> Low;
00426         }
00427 
00428         <span class="comment">//</span>
00429         <span class="comment">// does not exist, but belongs in Low or Leaf below low</span>
00430         <span class="comment">//</span>
00431         *Child = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00432         <span class="keywordflow">return</span> Low;
00433     }
00434 
00435     <span class="comment">//</span>
00436     <span class="comment">// see if High matches</span>
00437     <span class="comment">//</span>
00438     LeafCell = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[High];
00439     Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, LeafCell);
00440     Result = <a class="code" href="../../d7/d1/cmindex_8c.html#a4">CmpCompareInIndex</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00441                                SearchName,
00442                                Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> - 1,
00443                                Leaf,
00444                                Child);
00445     <span class="keywordflow">if</span> (Result == 0) {
00446 
00447         <span class="comment">//</span>
00448         <span class="comment">// found it</span>
00449         <span class="comment">//</span>
00450         *Child = LeafCell;
00451         <span class="keywordflow">return</span> High;
00452 
00453     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Result &lt; 0) {
00454 
00455         <span class="comment">//</span>
00456         <span class="comment">// Clearly greater than low, or we wouldn't be here.</span>
00457         <span class="comment">// So regardless of whether it's below the start</span>
00458         <span class="comment">// of this leaf, it would be in this leaf if it were</span>
00459         <span class="comment">// where, so report this leaf.</span>
00460         <span class="comment">//</span>
00461         *Child = LeafCell;
00462         <span class="keywordflow">return</span> High;
00463 
00464     }
00465 
00466     <span class="comment">//</span>
00467     <span class="comment">// Off the high end</span>
00468     <span class="comment">//</span>
00469     *Child = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00470     <span class="keywordflow">return</span> High;
00471 }
00472 
00473 
00474 ULONG
<a name="l00475"></a><a class="code" href="../../d7/d1/cmindex_8c.html#a3">00475</a> <a class="code" href="../../d7/d1/cmindex_8c.html#a3">CmpFindSubKeyInLeaf</a>(
00476     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
00477     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   Index,
00478     ULONG           HintIndex,
00479     PUNICODE_STRING SearchName,
00480     PHCELL_INDEX    Child
00481     )
00482 <span class="comment">/*++</span>
00483 <span class="comment"></span>
00484 <span class="comment">Routine Description:</span>
00485 <span class="comment"></span>
00486 <span class="comment">    Find a named key in a leaf index, if it exists. The supplied index</span>
00487 <span class="comment">    may be either a fast index or a slow one.</span>
00488 <span class="comment"></span>
00489 <span class="comment">Arguments:</span>
00490 <span class="comment"></span>
00491 <span class="comment">    Hive - pointer to hive control structure for hive of interest</span>
00492 <span class="comment"></span>
00493 <span class="comment">    Index - pointer to leaf block</span>
00494 <span class="comment"></span>
00495 <span class="comment">    HintIndex - Supplies hint for first key to check.</span>
00496 <span class="comment"></span>
00497 <span class="comment">    SearchName - pointer to name of key of interest</span>
00498 <span class="comment"></span>
00499 <span class="comment">    Child - pointer to variable to receive hcell_index of found key</span>
00500 <span class="comment">            HCELL_NIL if none found</span>
00501 <span class="comment"></span>
00502 <span class="comment">Return Value:</span>
00503 <span class="comment"></span>
00504 <span class="comment">    Index in List of last cell.  If Child != HCELL_NIL, is offset in</span>
00505 <span class="comment">    list at which Child was found.  Else, is offset of last place</span>
00506 <span class="comment">    we looked.</span>
00507 <span class="comment"></span>
00508 <span class="comment">--*/</span>
00509 {
00510     ULONG       High;
00511     ULONG       Low;
00512     ULONG       CanCount;
00513     LONG        Result;
00514 
00515     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a39">CMS_INDEX</a>) {
00516         KdPrint((<span class="stringliteral">"CmpFindSubKeyInLeaf:\n\t"</span>));
00517         KdPrint((<span class="stringliteral">"Hive=%08lx Index=%08lx SearchName=%08lx\n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>,SearchName));
00518     }
00519 
00520     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == <a class="code" href="../../d9/d0/cmdata_8h.html#a19">CM_KEY_INDEX_LEAF</a>) ||
00521            (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == <a class="code" href="../../d9/d0/cmdata_8h.html#a20">CM_KEY_FAST_LEAF</a>));
00522 
00523     High = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Count - 1;
00524     Low = 0;
00525     <span class="keywordflow">if</span> (HintIndex &lt; High) {
00526         CanCount = HintIndex;
00527     } <span class="keywordflow">else</span> {
00528         CanCount = High/2;
00529     }
00530 
00531     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Count == 0) {
00532         *Child = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00533         <span class="keywordflow">return</span> 0;
00534     }
00535 
00536     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00537 
00538         <span class="comment">//</span>
00539         <span class="comment">// Compute where to look next, get correct pointer, do compare</span>
00540         <span class="comment">//</span>
00541         Result = <a class="code" href="../../d7/d1/cmindex_8c.html#a4">CmpCompareInIndex</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00542                                    SearchName,
00543                                    CanCount,
00544                                    <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>,
00545                                    Child);
00546 
00547         <span class="keywordflow">if</span> (Result == 0) {
00548 
00549             <span class="comment">//</span>
00550             <span class="comment">// SearchName == KeyName</span>
00551             <span class="comment">//</span>
00552             <span class="keywordflow">return</span> CanCount;
00553         }
00554 
00555         <span class="keywordflow">if</span> (Result &lt; 0) {
00556 
00557             <span class="comment">//</span>
00558             <span class="comment">// SearchName &lt; KeyName</span>
00559             <span class="comment">//</span>
00560             High = CanCount;
00561 
00562         } <span class="keywordflow">else</span> {
00563 
00564             <span class="comment">//</span>
00565             <span class="comment">// SearchName &gt; KeyName</span>
00566             <span class="comment">//</span>
00567             Low = CanCount;
00568         }
00569 
00570         <span class="keywordflow">if</span> ((High - Low) &lt;= 1) {
00571             <span class="keywordflow">break</span>;
00572         }
00573         CanCount = ((High-Low)/2)+Low;
00574     }
00575 
00576     <span class="comment">//</span>
00577     <span class="comment">// If we get here, High - Low = 1 or High == Low</span>
00578     <span class="comment">// Simply look first at Low, then at High</span>
00579     <span class="comment">//</span>
00580     Result = <a class="code" href="../../d7/d1/cmindex_8c.html#a4">CmpCompareInIndex</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00581                                SearchName,
00582                                Low,
00583                                <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>,
00584                                Child);
00585     <span class="keywordflow">if</span> (Result == 0) {
00586 
00587         <span class="comment">//</span>
00588         <span class="comment">// found it</span>
00589         <span class="comment">//</span>
00590         <span class="keywordflow">return</span> Low;
00591     }
00592 
00593     <span class="keywordflow">if</span> (Result &lt; 0) {
00594 
00595         <span class="comment">//</span>
00596         <span class="comment">// does not exist, under</span>
00597         <span class="comment">//</span>
00598         <span class="keywordflow">return</span> Low;
00599     }
00600 
00601     <span class="comment">//</span>
00602     <span class="comment">// see if High matches, we will return High as the</span>
00603     <span class="comment">// closest key regardless.</span>
00604     <span class="comment">//</span>
00605     Result = <a class="code" href="../../d7/d1/cmindex_8c.html#a4">CmpCompareInIndex</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00606                                SearchName,
00607                                High,
00608                                <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>,
00609                                Child);
00610     <span class="keywordflow">return</span> High;
00611 }
00612 
00613 
00614 LONG
<a name="l00615"></a><a class="code" href="../../d7/d1/cmindex_8c.html#a4">00615</a> <a class="code" href="../../d7/d1/cmindex_8c.html#a4">CmpCompareInIndex</a>(
00616     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
00617     PUNICODE_STRING SearchName,
00618     ULONG           Count,
00619     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   Index,
00620     PHCELL_INDEX    Child
00621     )
00622 <span class="comment">/*++</span>
00623 <span class="comment"></span>
00624 <span class="comment">Routine Description:</span>
00625 <span class="comment"></span>
00626 <span class="comment">    Do a compare of a name in an index. This routine handles both</span>
00627 <span class="comment">    fast leafs and slow ones.</span>
00628 <span class="comment"></span>
00629 <span class="comment">Arguments:</span>
00630 <span class="comment"></span>
00631 <span class="comment">    Hive - pointer to hive control structure for hive of interest</span>
00632 <span class="comment"></span>
00633 <span class="comment">    SearchName - pointer to name of key we are searching for</span>
00634 <span class="comment"></span>
00635 <span class="comment">    Count - supplies index that we are searching at.</span>
00636 <span class="comment"></span>
00637 <span class="comment">    Index - Supplies pointer to either a CM_KEY_INDEX or</span>
00638 <span class="comment">            a CM_KEY_FAST_INDEX. This routine will determine which</span>
00639 <span class="comment">            type of index it is passed.</span>
00640 <span class="comment"></span>
00641 <span class="comment">    Child - pointer to variable to receive hcell_index of found key</span>
00642 <span class="comment">            HCELL_NIL if result != 0</span>
00643 <span class="comment"></span>
00644 <span class="comment">Return Value:</span>
00645 <span class="comment"></span>
00646 <span class="comment">    0 = SearchName == KeyName (of Cell)</span>
00647 <span class="comment"></span>
00648 <span class="comment">    &lt; 0 = SearchName &lt; KeyName</span>
00649 <span class="comment"></span>
00650 <span class="comment">    &gt; 0 = SearchName &gt; KeyName</span>
00651 <span class="comment"></span>
00652 <span class="comment">--*/</span>
00653 {
00654     <a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a> FastIndex;
00655     LONG Result;
00656     ULONG i;
00657     WCHAR c1;
00658     WCHAR c2;
00659     ULONG HintLength;
00660     ULONG ValidChars;
00661     ULONG NameLength;
00662     <a class="code" href="../../d2/d4/struct__CM__INDEX.html">PCM_INDEX</a> Hint;
00663 
00664     *Child = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00665     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == <a class="code" href="../../d9/d0/cmdata_8h.html#a20">CM_KEY_FAST_LEAF</a>) {
00666         FastIndex = (<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a>)<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00667         Hint = &amp;FastIndex-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>];
00668 
00669         <span class="comment">//</span>
00670         <span class="comment">// Compute the number of valid characters in the hint to compare.</span>
00671         <span class="comment">//</span>
00672         HintLength = 4;
00673         <span class="keywordflow">for</span> (i=0;i&lt;4;i++) {
00674             <span class="keywordflow">if</span> (Hint-&gt;<a class="code" href="../../d2/d4/struct__CM__INDEX.html#o1">NameHint</a>[i] == 0) {
00675                 HintLength = i;
00676                 <span class="keywordflow">break</span>;
00677             }
00678         }
00679         NameLength = SearchName-&gt;Length / <span class="keyword">sizeof</span>(WCHAR);
00680         <span class="keywordflow">if</span> (NameLength &lt; HintLength) {
00681             ValidChars = NameLength;
00682         } <span class="keywordflow">else</span> {
00683             ValidChars = HintLength;
00684         }
00685         <span class="keywordflow">for</span> (i=0; i&lt;ValidChars; i++) {
00686             c1 = SearchName-&gt;Buffer[i];
00687             c2 = FastIndex-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>].<a class="code" href="../../d2/d4/struct__CM__INDEX.html#o1">NameHint</a>[i];
00688             Result = (LONG)<a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(c1) -
00689                      (LONG)<a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(c2);
00690             <span class="keywordflow">if</span> (Result != 0) {
00691 
00692                 <span class="comment">//</span>
00693                 <span class="comment">// We have found a mismatched character in the hint,</span>
00694                 <span class="comment">// we can now tell which direction to go.</span>
00695                 <span class="comment">//</span>
00696                 <span class="keywordflow">return</span>(Result);
00697             }
00698         }
00699 
00700         <span class="comment">//</span>
00701         <span class="comment">// We have compared all the available characters without a</span>
00702         <span class="comment">// discrepancy. Go ahead and do the actual comparison now.</span>
00703         <span class="comment">//</span>
00704         Result = <a class="code" href="../../d7/d1/cmindex_8c.html#a5">CmpDoCompareKeyName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,SearchName,FastIndex-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>].Cell);
00705         <span class="keywordflow">if</span> (Result == 0) {
00706             *Child = Hint-&gt;<a class="code" href="../../d2/d4/struct__CM__INDEX.html#o0">Cell</a>;
00707         }
00708     } <span class="keywordflow">else</span> {
00709         <span class="comment">//</span>
00710         <span class="comment">// This is just a normal old slow index.</span>
00711         <span class="comment">//</span>
00712         Result = <a class="code" href="../../d7/d1/cmindex_8c.html#a5">CmpDoCompareKeyName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,SearchName,<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>]);
00713         <span class="keywordflow">if</span> (Result == 0) {
00714             *Child = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>];
00715         }
00716     }
00717     <span class="keywordflow">return</span>(Result);
00718 }
00719 
00720 
00721 LONG
<a name="l00722"></a><a class="code" href="../../d7/d1/cmindex_8c.html#a5">00722</a> <a class="code" href="../../d7/d1/cmindex_8c.html#a5">CmpDoCompareKeyName</a>(
00723     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
00724     PUNICODE_STRING SearchName,
00725     HCELL_INDEX     Cell
00726     )
00727 <span class="comment">/*++</span>
00728 <span class="comment"></span>
00729 <span class="comment">Routine Description:</span>
00730 <span class="comment"></span>
00731 <span class="comment">    Do a compare of a name with a key.</span>
00732 <span class="comment"></span>
00733 <span class="comment">Arguments:</span>
00734 <span class="comment"></span>
00735 <span class="comment">    Hive - pointer to hive control structure for hive of interest</span>
00736 <span class="comment"></span>
00737 <span class="comment">    SearchName - pointer to name of key we are searching for</span>
00738 <span class="comment"></span>
00739 <span class="comment">    Cell - cell of key we are to compare with</span>
00740 <span class="comment"></span>
00741 <span class="comment">Return Value:</span>
00742 <span class="comment"></span>
00743 <span class="comment">    0 = SearchName == KeyName (of Cell)</span>
00744 <span class="comment"></span>
00745 <span class="comment">    &lt; 0 = SearchName &lt; KeyName</span>
00746 <span class="comment"></span>
00747 <span class="comment">    &gt; 0 = SearchName &gt; KeyName</span>
00748 <span class="comment"></span>
00749 <span class="comment">--*/</span>
00750 {
00751     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>    Pcan;
00752     UNICODE_STRING  <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
00753 
00754     Pcan = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00755     <span class="keywordflow">if</span> (Pcan-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>) {
00756         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d2/cmp_8h.html#a319">CmpCompareCompressedName</a>(SearchName,
00757                                         Pcan-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>,
00758                                         Pcan-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>));
00759     } <span class="keywordflow">else</span> {
00760         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer = &amp;(Pcan-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>[0]);
00761         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length = Pcan-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>;
00762         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.MaximumLength = <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length;
00763         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d6/nls_8c.html#a41">RtlCompareUnicodeString</a>(SearchName,
00764                                         &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>,
00765                                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
00766     }
00767 }
00768 
00769 
00770 <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>
<a name="l00771"></a><a class="code" href="../../d1/d2/cmp_8h.html#a304">00771</a> <a class="code" href="../../d1/d2/cmp_8h.html#a304">CmpFindSubKeyByNumber</a>(
00772     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
00773     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>    Node,
00774     ULONG           Number
00775     )
00776 <span class="comment">/*++</span>
00777 <span class="comment"></span>
00778 <span class="comment">Routine Description:</span>
00779 <span class="comment"></span>
00780 <span class="comment">    Find the Number'th entry in the index, starting from 0.</span>
00781 <span class="comment"></span>
00782 <span class="comment">Arguments:</span>
00783 <span class="comment"></span>
00784 <span class="comment">    Hive - pointer to hive control structure for hive of interest</span>
00785 <span class="comment"></span>
00786 <span class="comment">    Node - pointer to key body which is parent of child of interest</span>
00787 <span class="comment"></span>
00788 <span class="comment">    Number - ordinal of child key to return</span>
00789 <span class="comment"></span>
00790 <span class="comment">Return Value:</span>
00791 <span class="comment"></span>
00792 <span class="comment">    Cell of matching child key, or HCELL_NIL if none.</span>
00793 <span class="comment"></span>
00794 <span class="comment">--*/</span>
00795 {
00796     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00797 
00798     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a39">CMS_INDEX</a>) {
00799         KdPrint((<span class="stringliteral">"CmpFindSubKeyByNumber:\n\t"</span>));
00800         KdPrint((<span class="stringliteral">"Hive=%08lx Node=%08lx Number=%08lx\n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,Node,Number));
00801     }
00802 
00803     <span class="keywordflow">if</span> (Number &lt; Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>]) {
00804 
00805         <span class="comment">//</span>
00806         <span class="comment">// It's in the stable set</span>
00807         <span class="comment">//</span>
00808         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>]);
00809         <span class="keywordflow">return</span> (<a class="code" href="../../d7/d1/cmindex_8c.html#a6">CmpDoFindSubKeyByNumber</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>, Number));
00810 
00811     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o20">StorageTypeCount</a> &gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>) {
00812 
00813         <span class="comment">//</span>
00814         <span class="comment">// It's in the volatile set</span>
00815         <span class="comment">//</span>
00816         Number = Number - Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>];
00817         <span class="keywordflow">if</span> (Number &lt; Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>]) {
00818 
00819             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>]);
00820             <span class="keywordflow">return</span> (<a class="code" href="../../d7/d1/cmindex_8c.html#a6">CmpDoFindSubKeyByNumber</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>, Number));
00821 
00822         }
00823     }
00824 
00825     <span class="comment">//</span>
00826     <span class="comment">// It's nowhere</span>
00827     <span class="comment">//</span>
00828     <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00829 }
00830 
00831 
00832 <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>
<a name="l00833"></a><a class="code" href="../../d7/d1/cmindex_8c.html#a6">00833</a> <a class="code" href="../../d7/d1/cmindex_8c.html#a6">CmpDoFindSubKeyByNumber</a>(
00834     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
00835     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   Index,
00836     ULONG           Number
00837     )
00838 <span class="comment">/*++</span>
00839 <span class="comment"></span>
00840 <span class="comment">Routine Description:</span>
00841 <span class="comment"></span>
00842 <span class="comment">    Helper for CmpFindSubKeyByNumber,</span>
00843 <span class="comment">    Find the Number'th entry in the index, starting from 0.</span>
00844 <span class="comment"></span>
00845 <span class="comment">Arguments:</span>
00846 <span class="comment"></span>
00847 <span class="comment">    Hive - pointer to hive control structure for hive of interest</span>
00848 <span class="comment"></span>
00849 <span class="comment">    Index - root or leaf of the index</span>
00850 <span class="comment"></span>
00851 <span class="comment">    Number - ordinal of child key to return</span>
00852 <span class="comment"></span>
00853 <span class="comment">Return Value:</span>
00854 <span class="comment"></span>
00855 <span class="comment">    Cell of requested entry.</span>
00856 <span class="comment"></span>
00857 <span class="comment">--*/</span>
00858 {
00859     ULONG           i;
00860     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     LeafCell;
00861     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   Leaf;
00862     <a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a> FastIndex;
00863 
00864     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == <a class="code" href="../../d9/d0/cmdata_8h.html#a18">CM_KEY_INDEX_ROOT</a>) {
00865         <span class="comment">//</span>
00866         <span class="comment">// step through root, till we find the right leaf</span>
00867         <span class="comment">//</span>
00868         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Count; i++) {
00869             LeafCell = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[i];
00870             Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, LeafCell);
00871             <span class="keywordflow">if</span> (Number &lt; Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a>) {
00872                 <span class="keywordflow">if</span> (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a20">CM_KEY_FAST_LEAF</a>) {
00873                     FastIndex = (<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a>)Leaf;
00874                     <span class="keywordflow">return</span> (FastIndex-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[Number].<a class="code" href="../../d2/d4/struct__CM__INDEX.html#o0">Cell</a>);
00875                 } <span class="keywordflow">else</span> {
00876                     <span class="keywordflow">return</span> (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[Number]);
00877                 }
00878             } <span class="keywordflow">else</span> {
00879                 Number = Number - Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a>;
00880             }
00881         }
00882         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00883     }
00884     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Number &lt; Index-&gt;<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>);
00885     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == <a class="code" href="../../d9/d0/cmdata_8h.html#a20">CM_KEY_FAST_LEAF</a>) {
00886         FastIndex = (<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a>)<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00887         <span class="keywordflow">return</span>(FastIndex-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[Number].<a class="code" href="../../d2/d4/struct__CM__INDEX.html#o0">Cell</a>);
00888     } <span class="keywordflow">else</span> {
00889         <span class="keywordflow">return</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[Number]);
00890     }
00891 }
00892 
00893 
00894 BOOLEAN
<a name="l00895"></a><a class="code" href="../../d1/d2/cmp_8h.html#a305">00895</a> <a class="code" href="../../d1/d2/cmp_8h.html#a305">CmpAddSubKey</a>(
00896     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
00897     HCELL_INDEX     Parent,
00898     HCELL_INDEX     Child
00899     )
00900 <span class="comment">/*++</span>
00901 <span class="comment"></span>
00902 <span class="comment">Routine Description:</span>
00903 <span class="comment"></span>
00904 <span class="comment">    Add a new child subkey to the subkey index for a cell.  The</span>
00905 <span class="comment">    child MUST NOT already be present (bugcheck if so.)</span>
00906 <span class="comment"></span>
00907 <span class="comment">    NOTE:   We expect Parent to already be marked dirty.</span>
00908 <span class="comment">            We will mark stuff in Index dirty</span>
00909 <span class="comment"></span>
00910 <span class="comment">Arguments:</span>
00911 <span class="comment"></span>
00912 <span class="comment">    Hive - pointer to hive control structure for hive of interest</span>
00913 <span class="comment"></span>
00914 <span class="comment">    Parent - cell of key that will be parent of new key</span>
00915 <span class="comment"></span>
00916 <span class="comment">    Child - new key to put in Paren't sub key list</span>
00917 <span class="comment"></span>
00918 <span class="comment">Return Value:</span>
00919 <span class="comment"></span>
00920 <span class="comment">    TRUE - it worked</span>
00921 <span class="comment"></span>
00922 <span class="comment">    FALSE - resource problem</span>
00923 <span class="comment"></span>
00924 <span class="comment">--*/</span>
00925 {
00926     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>    pcell;
00927     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     WorkCell;
00928     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00929     <a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a> FastIndex;
00930     UNICODE_STRING  <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>;
00931     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     LeafCell;
00932     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a>    RootPointer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00933     ULONG           cleanup = 0;
00934     ULONG           Type;
00935     BOOLEAN         IsCompressed;
00936     ULONG           i;
00937 
00938     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a39">CMS_INDEX</a>) {
00939         KdPrint((<span class="stringliteral">"CmpAddSubKey:\n\t"</span>));
00940         KdPrint((<span class="stringliteral">"Hive=%08lx Parent=%08lx Child=%08lx\n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,Parent,Child));
00941     }
00942 
00943     <span class="comment">//</span>
00944     <span class="comment">// build a name string</span>
00945     <span class="comment">//</span>
00946     pcell = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Child);
00947     <span class="keywordflow">if</span> (pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>) {
00948         IsCompressed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00949         <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Length = <a class="code" href="../../d1/d2/cmp_8h.html#a320">CmpCompressedNameSize</a>(pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>, pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
00950         <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.MaximumLength = <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Length;
00951         <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Buffer = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Length, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00952         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Buffer==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00953             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00954         }
00955         <a class="code" href="../../d1/d2/cmp_8h.html#a318">CmpCopyCompressedName</a>(<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Buffer,
00956                               <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.MaximumLength,
00957                               pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>,
00958                               pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
00959     } <span class="keywordflow">else</span> {
00960         IsCompressed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00961         <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Length = pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>;
00962         <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.MaximumLength = pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>;
00963         <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Buffer = &amp;(pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>[0]);
00964     }
00965 
00966     pcell = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Parent);
00967 
00968     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Child);
00969 
00970     <span class="keywordflow">if</span> (pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[Type] == 0) {
00971 
00972         ULONG Signature;
00973 
00974         <span class="comment">//</span>
00975         <span class="comment">// we must allocate a leaf</span>
00976         <span class="comment">//</span>
00977         WorkCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">CM_KEY_FAST_INDEX</a>), Type);
00978         <span class="keywordflow">if</span> (WorkCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00979             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00980         }
00981         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, WorkCell);
00982         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature = <a class="code" href="../../d9/d0/cmdata_8h.html#a17">UseFastIndex</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>) ? <a class="code" href="../../d9/d0/cmdata_8h.html#a20">CM_KEY_FAST_LEAF</a> : <a class="code" href="../../d9/d0/cmdata_8h.html#a19">CM_KEY_INDEX_LEAF</a>;
00983         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Count = 0;
00984         pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Type] = WorkCell;
00985         cleanup = 1;
00986     } <span class="keywordflow">else</span> {
00987 
00988         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Type]);
00989         <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == <a class="code" href="../../d9/d0/cmdata_8h.html#a20">CM_KEY_FAST_LEAF</a>) &amp;&amp;
00990             (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Count &gt;= (<a class="code" href="../../d9/d0/cmdata_8h.html#a23">CM_MAX_FAST_INDEX</a>))) {
00991 
00992             <span class="comment">//</span>
00993             <span class="comment">// We must change fast index to a slow index to accomodate</span>
00994             <span class="comment">// growth.</span>
00995             <span class="comment">//</span>
00996 
00997             FastIndex = (<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a>)<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00998             <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Count; i++) {
00999                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[i] = FastIndex-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[i].<a class="code" href="../../d2/d4/struct__CM__INDEX.html#o0">Cell</a>;
01000             }
01001             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature = <a class="code" href="../../d9/d0/cmdata_8h.html#a19">CM_KEY_INDEX_LEAF</a>;
01002 
01003         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == <a class="code" href="../../d9/d0/cmdata_8h.html#a19">CM_KEY_INDEX_LEAF</a>) &amp;&amp;
01004                    (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Count &gt;= (<a class="code" href="../../d9/d0/cmdata_8h.html#a21">CM_MAX_INDEX</a> - 1) )) {
01005             <span class="comment">//</span>
01006             <span class="comment">// We must change flat entry to a root/leaf tree</span>
01007             <span class="comment">//</span>
01008             WorkCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(
01009                          <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01010                          <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">CM_KEY_INDEX</a>) + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>), <span class="comment">// allow for 2</span>
01011                          Type
01012                          );
01013             <span class="keywordflow">if</span> (WorkCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01014                 <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01015             }
01016 
01017             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, WorkCell);
01018             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature = <a class="code" href="../../d9/d0/cmdata_8h.html#a18">CM_KEY_INDEX_ROOT</a>;
01019             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Count = 1;
01020             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[0] = pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Type];
01021             pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Type] = WorkCell;
01022             cleanup = 2;
01023 
01024         }
01025     }
01026     LeafCell = pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Type];
01027 
01028     <span class="comment">//</span>
01029     <span class="comment">// LeafCell is target for add, or perhaps root</span>
01030     <span class="comment">// Index is pointer to fast leaf, slow Leaf or Root, whichever applies</span>
01031     <span class="comment">//</span>
01032     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == <a class="code" href="../../d9/d0/cmdata_8h.html#a18">CM_KEY_INDEX_ROOT</a>) {
01033         LeafCell = <a class="code" href="../../d7/d1/cmindex_8c.html#a8">CmpSelectLeaf</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, pcell, &amp;<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>, Type, &amp;RootPointer);
01034         <span class="keywordflow">if</span> (LeafCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01035             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01036         }
01037     }
01038 
01039     <span class="comment">//</span>
01040     <span class="comment">// Add new cell to Leaf, update pointers</span>
01041     <span class="comment">//</span>
01042     LeafCell = <a class="code" href="../../d7/d1/cmindex_8c.html#a7">CmpAddToLeaf</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, LeafCell, Child, &amp;<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>);
01043 
01044     <span class="keywordflow">if</span> (LeafCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01045         <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01046     }
01047 
01048     pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[Type] += 1;
01049 
01050     <span class="keywordflow">if</span> (RootPointer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01051         *RootPointer = LeafCell;
01052     } <span class="keywordflow">else</span> {
01053         pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Type] = LeafCell;
01054     }
01055 
01056     <span class="keywordflow">if</span> (IsCompressed) {
01057         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Buffer, <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Length);
01058     }
01059 
01060     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01061 
01062 
01063 
01064 <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>:
01065     <span class="keywordflow">if</span> (IsCompressed) {
01066         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Buffer, <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Length);
01067     }
01068 
01069     <span class="keywordflow">switch</span> (cleanup) {
01070     <span class="keywordflow">case</span> 1:
01071         <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Type]);
01072         pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Type] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01073         <span class="keywordflow">break</span>;
01074 
01075     <span class="keywordflow">case</span> 2:
01076         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Type]);
01077         pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Type] = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[0];
01078         <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Type]);
01079         <span class="keywordflow">break</span>;
01080     }
01081 
01082     <span class="keywordflow">return</span>  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01083 }
01084 
01085 
01086 <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>
<a name="l01087"></a><a class="code" href="../../d7/d1/cmindex_8c.html#a7">01087</a> <a class="code" href="../../d7/d1/cmindex_8c.html#a7">CmpAddToLeaf</a>(
01088     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
01089     HCELL_INDEX     LeafCell,
01090     HCELL_INDEX     NewKey,
01091     PUNICODE_STRING NewName
01092     )
01093 <span class="comment">/*++</span>
01094 <span class="comment"></span>
01095 <span class="comment">Routine Description:</span>
01096 <span class="comment"></span>
01097 <span class="comment">    Insert a new subkey into a Leaf index. Supports both fast and slow</span>
01098 <span class="comment">    leaf indexes and will determine which sort of index the given leaf is.</span>
01099 <span class="comment"></span>
01100 <span class="comment">    NOTE:   We expect Root to already be marked dirty by caller if non NULL.</span>
01101 <span class="comment">            We expect Leaf to always be marked dirty by caller.</span>
01102 <span class="comment"></span>
01103 <span class="comment">Arguments:</span>
01104 <span class="comment"></span>
01105 <span class="comment">    Hive - pointer to hive control structure for hive of interest</span>
01106 <span class="comment"></span>
01107 <span class="comment">    LeafCell - cell of index leaf node we are to add entry too</span>
01108 <span class="comment"></span>
01109 <span class="comment">    NewKey - cell of KEY_NODE we are to add</span>
01110 <span class="comment"></span>
01111 <span class="comment">    NewName - pointer to unicode string with name to we are to add</span>
01112 <span class="comment"></span>
01113 <span class="comment">Return Value:</span>
01114 <span class="comment"></span>
01115 <span class="comment">    HCELL_NIL - some resource problem</span>
01116 <span class="comment"></span>
01117 <span class="comment">    Else - cell of Leaf index when are done, caller is expected to</span>
01118 <span class="comment">            set this into Root index or Key body.</span>
01119 <span class="comment"></span>
01120 <span class="comment">--*/</span>
01121 {
01122     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   Leaf;
01123     <a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a> FastLeaf;
01124     ULONG           <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
01125     ULONG           OldSize;
01126     ULONG           freecount;
01127     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     NewCell;
01128     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     Child;
01129     ULONG           Select;
01130     LONG            Result;
01131     ULONG           EntrySize;
01132     ULONG           i;
01133 
01134     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a39">CMS_INDEX</a>) {
01135         KdPrint((<span class="stringliteral">"CmpAddToLeaf:\n\t"</span>));
01136         KdPrint((<span class="stringliteral">"Hive=%08lx LeafCell=%08lx NewKey=%08lx\n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,LeafCell,NewKey));
01137     }
01138 
01139     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, LeafCell)) {
01140         <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01141     }
01142 
01143     <span class="comment">//</span>
01144     <span class="comment">// compute number free slots left in the leaf</span>
01145     <span class="comment">//</span>
01146     Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, LeafCell);
01147     <span class="keywordflow">if</span> (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a19">CM_KEY_INDEX_LEAF</a>) {
01148         FastLeaf = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01149         EntrySize = <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>);
01150     } <span class="keywordflow">else</span> {
01151         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a20">CM_KEY_FAST_LEAF</a>);
01152         FastLeaf = (<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a>)Leaf;
01153         EntrySize = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__CM__INDEX.html">CM_INDEX</a>);
01154     }
01155     OldSize = <a class="code" href="../../d8/d0/hivecell_8c.html#a15">HvGetCellSize</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Leaf);
01156     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = OldSize - ((EntrySize * Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a>) +
01157               FIELD_OFFSET(<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">CM_KEY_INDEX</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>));
01158     freecount = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> / EntrySize;
01159 
01160     <span class="comment">//</span>
01161     <span class="comment">// grow the leaf if it isn't big enough</span>
01162     <span class="comment">//</span>
01163     NewCell = LeafCell;
01164     <span class="keywordflow">if</span> (freecount &lt; 1) {
01165         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = OldSize + OldSize / 2;
01166         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &lt; (OldSize + EntrySize)) {
01167             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = OldSize + EntrySize;
01168         }
01169         NewCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a20">HvReallocateCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, LeafCell, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
01170         <span class="keywordflow">if</span> (NewCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01171             <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01172         }
01173         Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, NewCell);
01174         <span class="keywordflow">if</span> (FastLeaf != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01175             FastLeaf = (<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a>)Leaf;
01176         }
01177     }
01178 
01179     <span class="comment">//</span>
01180     <span class="comment">// Find where to put the new entry</span>
01181     <span class="comment">//</span>
01182     Select = <a class="code" href="../../d7/d1/cmindex_8c.html#a3">CmpFindSubKeyInLeaf</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Leaf, (ULONG)-1, <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>, &amp;Child);
01183     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Child == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>);
01184 
01185     <span class="comment">//</span>
01186     <span class="comment">// Select is the index in List of the entry nearest where the</span>
01187     <span class="comment">// new entry should go.</span>
01188     <span class="comment">// Decide wether the new entry goes before or after Offset entry,</span>
01189     <span class="comment">// and then ripple copy and set.</span>
01190     <span class="comment">// If Select == Count, then the leaf is empty, so simply set our entry</span>
01191     <span class="comment">//</span>
01192     <span class="keywordflow">if</span> (Select != Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a>) {
01193 
01194         Result = <a class="code" href="../../d7/d1/cmindex_8c.html#a4">CmpCompareInIndex</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01195                                    <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>,
01196                                    Select,
01197                                    Leaf,
01198                                    &amp;Child);
01199         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Result != 0);
01200 
01201         <span class="comment">//</span>
01202         <span class="comment">// Result &lt; 0 - NewName/NewKey less than selected key, insert before</span>
01203         <span class="comment">//        &gt; 0 - NewName/NewKey greater than selected key, insert after</span>
01204         <span class="comment">//</span>
01205         <span class="keywordflow">if</span> (Result &gt; 0) {
01206             Select++;
01207         }
01208 
01209         <span class="keywordflow">if</span> (Select != Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a>) {
01210 
01211             <span class="comment">//</span>
01212             <span class="comment">// ripple copy to make space and insert</span>
01213             <span class="comment">//</span>
01214 
01215             <span class="keywordflow">if</span> (FastLeaf != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01216                 RtlMoveMemory((PVOID)&amp;(FastLeaf-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[Select+1]),
01217                               (PVOID)&amp;(FastLeaf-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[Select]),
01218                               <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__CM__INDEX.html">CM_INDEX</a>)*(FastLeaf-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o1">Count</a> - Select));
01219             } <span class="keywordflow">else</span> {
01220                 RtlMoveMemory((PVOID)&amp;(Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[Select+1]),
01221                               (PVOID)&amp;(Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[Select]),
01222                               <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>)*(Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> - Select));
01223             }
01224         }
01225     }
01226     <span class="keywordflow">if</span> (FastLeaf != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01227         FastLeaf-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[Select].<a class="code" href="../../d2/d4/struct__CM__INDEX.html#o0">Cell</a> = NewKey;
01228         FastLeaf-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[Select].<a class="code" href="../../d2/d4/struct__CM__INDEX.html#o1">NameHint</a>[0] = 0;
01229         FastLeaf-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[Select].<a class="code" href="../../d2/d4/struct__CM__INDEX.html#o1">NameHint</a>[1] = 0;
01230         FastLeaf-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[Select].<a class="code" href="../../d2/d4/struct__CM__INDEX.html#o1">NameHint</a>[2] = 0;
01231         FastLeaf-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[Select].<a class="code" href="../../d2/d4/struct__CM__INDEX.html#o1">NameHint</a>[3] = 0;
01232         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>-&gt;Length/<span class="keyword">sizeof</span>(WCHAR) &lt; 4) {
01233             i = <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>-&gt;Length/<span class="keyword">sizeof</span>(WCHAR);
01234         } <span class="keywordflow">else</span> {
01235             i = 4;
01236         }
01237         <span class="keywordflow">do</span> {
01238             <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>-&gt;Buffer[i-1] &gt; (UCHAR)-1) {
01239                 <span class="comment">//</span>
01240                 <span class="comment">// Can't compress this name. Leave NameHint[0]==0</span>
01241                 <span class="comment">// to force the name to be looked up in the key.</span>
01242                 <span class="comment">//</span>
01243                 <span class="keywordflow">break</span>;
01244             }
01245             FastLeaf-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[Select].<a class="code" href="../../d2/d4/struct__CM__INDEX.html#o1">NameHint</a>[i-1] = (UCHAR)<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>-&gt;Buffer[i-1];
01246             i--;
01247         } <span class="keywordflow">while</span> ( i&gt;0 );
01248     } <span class="keywordflow">else</span> {
01249         Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[Select] = NewKey;
01250     }
01251     Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> += 1;
01252     <span class="keywordflow">return</span> NewCell;
01253 }
01254 
01255 
01256 <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>
<a name="l01257"></a><a class="code" href="../../d7/d1/cmindex_8c.html#a8">01257</a> <a class="code" href="../../d7/d1/cmindex_8c.html#a8">CmpSelectLeaf</a>(
01258     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
01259     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>    ParentKey,
01260     PUNICODE_STRING NewName,
01261     HSTORAGE_TYPE   Type,
01262     PHCELL_INDEX    *RootPointer
01263     )
01264 <span class="comment">/*++</span>
01265 <span class="comment"></span>
01266 <span class="comment">Routine Description:</span>
01267 <span class="comment"></span>
01268 <span class="comment">    This routine is only called if the subkey index for a cell is NOT</span>
01269 <span class="comment">    simply a single Leaf index block.</span>
01270 <span class="comment"></span>
01271 <span class="comment">    It selects the Leaf index block to which a new entry is to be</span>
01272 <span class="comment">    added.  It may create this block by splitting an existing Leaf</span>
01273 <span class="comment">    block.</span>
01274 <span class="comment"></span>
01275 <span class="comment">Arguments:</span>
01276 <span class="comment"></span>
01277 <span class="comment">    Hive - pointer to hive control structure for hive of interest</span>
01278 <span class="comment"></span>
01279 <span class="comment">    ParentKey - mapped pointer to parent key</span>
01280 <span class="comment"></span>
01281 <span class="comment">    NewName - pointer to unicode string naming entry to add</span>
01282 <span class="comment"></span>
01283 <span class="comment">    Type - Stable or Volatile, describes Child's storage</span>
01284 <span class="comment"></span>
01285 <span class="comment">    RootPointer - pointer to variable to receive address of HCELL_INDEX</span>
01286 <span class="comment">                that points to Leaf block returned as function argument.</span>
01287 <span class="comment">                Used for updates.</span>
01288 <span class="comment"></span>
01289 <span class="comment">Return Value:</span>
01290 <span class="comment"></span>
01291 <span class="comment">    HCELL_NIL - resource problem</span>
01292 <span class="comment"></span>
01293 <span class="comment">    Else, cell index of Leaf index block to add entry to</span>
01294 <span class="comment"></span>
01295 <span class="comment">--*/</span>
01296 {
01297     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     LeafCell;
01298     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     WorkCell;
01299     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01300     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   Leaf;
01301     ULONG           RootSelect;
01302     LONG            Result;
01303 
01304     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a39">CMS_INDEX</a>) {
01305         KdPrint((<span class="stringliteral">"CmpSelectLeaf:\n\t"</span>));
01306         KdPrint((<span class="stringliteral">"Hive=%08lx ParentKey=%08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ParentKey));
01307     }
01308 
01309 
01310     <span class="comment">//</span>
01311     <span class="comment">// Force root to always be dirty, since we'll either grow it or edit it,</span>
01312     <span class="comment">// and it needs to be marked dirty for BOTH cases.  (Edit may not</span>
01313     <span class="comment">// occur until after we leave</span>
01314     <span class="comment">//</span>
01315     <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ParentKey-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Type])) {
01316         <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01317     }
01318 
01319     <span class="comment">//</span>
01320     <span class="comment">// must find the proper leaf</span>
01321     <span class="comment">//</span>
01322     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ParentKey-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Type]);
01323     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == <a class="code" href="../../d9/d0/cmdata_8h.html#a18">CM_KEY_INDEX_ROOT</a>);
01324 
01325     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01326 
01327         RootSelect = <a class="code" href="../../d7/d1/cmindex_8c.html#a2">CmpFindSubKeyInRoot</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>, <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>, &amp;LeafCell);
01328 
01329         <span class="keywordflow">if</span> (LeafCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01330 
01331             <span class="comment">//</span>
01332             <span class="comment">// Leaf of interest is somewhere near RootSelect</span>
01333             <span class="comment">//</span>
01334             <span class="comment">// . Always use lowest order leaf we can get away with</span>
01335             <span class="comment">// . Never split a leaf if there's one with space we can use</span>
01336             <span class="comment">// . When we split a leaf, we have to repeat search</span>
01337             <span class="comment">//</span>
01338             <span class="comment">// If (NewKey is below lowest key in selected)</span>
01339             <span class="comment">//    If there's a Leaf below selected with space</span>
01340             <span class="comment">//       use the leaf below</span>
01341             <span class="comment">//    else</span>
01342             <span class="comment">//       use the leaf (split it if not enough space)</span>
01343             <span class="comment">// Else</span>
01344             <span class="comment">//    must be above highest key in selected, less than</span>
01345             <span class="comment">//      lowest key in Leaf to right of selected</span>
01346             <span class="comment">//       if space in selected</span>
01347             <span class="comment">//          use selected</span>
01348             <span class="comment">//       else if space in leaf above selected</span>
01349             <span class="comment">//          use leaf above</span>
01350             <span class="comment">//       else</span>
01351             <span class="comment">//          split selected</span>
01352             <span class="comment">//</span>
01353             LeafCell = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[RootSelect];
01354             Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, LeafCell);
01355             WorkCell = Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[0];
01356             Result = <a class="code" href="../../d7/d1/cmindex_8c.html#a5">CmpDoCompareKeyName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>, WorkCell);
01357             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Result != 0);
01358 
01359             <span class="keywordflow">if</span> (Result &lt; 0) {
01360 
01361                 <span class="comment">//</span>
01362                 <span class="comment">// new is off the left end of Selected</span>
01363                 <span class="comment">//</span>
01364                 <span class="keywordflow">if</span> (RootSelect &gt; 0) {
01365 
01366                     <span class="comment">//</span>
01367                     <span class="comment">// there's a Leaf to the left, try to use it</span>
01368                     <span class="comment">//</span>
01369                     LeafCell = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[RootSelect-1];
01370                     Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, LeafCell);
01371 
01372                     <span class="keywordflow">if</span> (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> &lt; (<a class="code" href="../../d9/d0/cmdata_8h.html#a21">CM_MAX_INDEX</a> - 1)) {
01373                         RootSelect--;
01374                         *RootPointer = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[RootSelect]);
01375                         <span class="keywordflow">break</span>;
01376                     }
01377 
01378                 } <span class="keywordflow">else</span> {
01379                     <span class="comment">//</span>
01380                     <span class="comment">// new key is off the left end of the leftmost leaf.</span>
01381                     <span class="comment">// Use the leftmost leaf, if there's enough room</span>
01382                     <span class="comment">//</span>
01383                     LeafCell = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[0];
01384                     Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, LeafCell);
01385                     <span class="keywordflow">if</span> (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> &lt; (<a class="code" href="../../d9/d0/cmdata_8h.html#a21">CM_MAX_INDEX</a> - 1)) {
01386                         *RootPointer = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[0]);
01387                         <span class="keywordflow">break</span>;
01388                     }
01389                 }
01390 
01391                 <span class="comment">//</span>
01392                 <span class="comment">// else fall to split case</span>
01393                 <span class="comment">//</span>
01394 
01395             } <span class="keywordflow">else</span> {
01396 
01397                 <span class="comment">//</span>
01398                 <span class="comment">// since new key is not in a Leaf, and is not off</span>
01399                 <span class="comment">// the left end of the ResultSelect Leaf, it must</span>
01400                 <span class="comment">// be off the right end.</span>
01401                 <span class="comment">//</span>
01402                 LeafCell = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[RootSelect];
01403                 Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, LeafCell);
01404 
01405                 <span class="keywordflow">if</span> (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> &lt; (<a class="code" href="../../d9/d0/cmdata_8h.html#a21">CM_MAX_INDEX</a> - 1)) {
01406                     *RootPointer = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[RootSelect]);
01407                     <span class="keywordflow">break</span>;
01408                 }
01409 
01410                 <span class="comment">//</span>
01411                 <span class="comment">// No space, see if there's a leaf to the rigth</span>
01412                 <span class="comment">// and if it has space</span>
01413                 <span class="comment">//</span>
01414                 <span class="keywordflow">if</span> (RootSelect &lt; (ULONG)(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Count - 1)) {
01415 
01416                     LeafCell = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[RootSelect+1];
01417                     Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, LeafCell);
01418 
01419                     <span class="keywordflow">if</span> (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> &lt; (<a class="code" href="../../d9/d0/cmdata_8h.html#a21">CM_MAX_INDEX</a> - 1)) {
01420                         *RootPointer = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[RootSelect+1]);
01421                         <span class="keywordflow">break</span>;
01422                     }
01423                 }
01424 
01425                 <span class="comment">//</span>
01426                 <span class="comment">// fall to split case</span>
01427                 <span class="comment">//</span>
01428             }
01429 
01430         } <span class="keywordflow">else</span> {   <span class="comment">// LeafCell != HCELL_NIL</span>
01431 
01432             <span class="comment">//</span>
01433             <span class="comment">// Since newkey cannot already be in tree, it must be</span>
01434             <span class="comment">// greater than the bottom of Leaf and less than the top,</span>
01435             <span class="comment">// therefore it must go in Leaf.  If no space, split it.</span>
01436             <span class="comment">//</span>
01437             Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, LeafCell);
01438             <span class="keywordflow">if</span> (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> &lt; (<a class="code" href="../../d9/d0/cmdata_8h.html#a21">CM_MAX_INDEX</a> - 1)) {
01439 
01440                 *RootPointer = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[RootSelect]);
01441                 <span class="keywordflow">break</span>;
01442             }
01443 
01444             <span class="comment">//</span>
01445             <span class="comment">// fall to split case</span>
01446             <span class="comment">//</span>
01447         }
01448 
01449         <span class="comment">//</span>
01450         <span class="comment">// either no neigbor, or no space in neighbor, so split</span>
01451         <span class="comment">//</span>
01452         WorkCell = <a class="code" href="../../d7/d1/cmindex_8c.html#a9">CmpSplitLeaf</a>(
01453                         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01454                         ParentKey-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Type],       <span class="comment">// root cell</span>
01455                         RootSelect,
01456                         Type
01457                         );
01458         <span class="keywordflow">if</span> (WorkCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01459             <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01460         }
01461 
01462         ParentKey-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Type] = WorkCell;
01463         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, WorkCell);
01464         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == <a class="code" href="../../d9/d0/cmdata_8h.html#a18">CM_KEY_INDEX_ROOT</a>);
01465 
01466     } <span class="comment">// while(true)</span>
01467     <span class="keywordflow">return</span> LeafCell;
01468 }
01469 
01470 
01471 <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>
<a name="l01472"></a><a class="code" href="../../d7/d1/cmindex_8c.html#a9">01472</a> <a class="code" href="../../d7/d1/cmindex_8c.html#a9">CmpSplitLeaf</a>(
01473     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
01474     HCELL_INDEX     RootCell,
01475     ULONG           RootSelect,
01476     HSTORAGE_TYPE   Type
01477     )
01478 <span class="comment">/*++</span>
01479 <span class="comment"></span>
01480 <span class="comment">Routine Description:</span>
01481 <span class="comment"></span>
01482 <span class="comment">    Split the Leaf index block specified by RootSelect, causing both</span>
01483 <span class="comment">    of the split out Leaf blocks to appear in the Root index block</span>
01484 <span class="comment">    specified by RootCell.</span>
01485 <span class="comment"></span>
01486 <span class="comment">    Caller is expected to have marked old root cell dirty.</span>
01487 <span class="comment"></span>
01488 <span class="comment">Arguments:</span>
01489 <span class="comment"></span>
01490 <span class="comment">    Hive - pointer to hive control structure for hive of interest</span>
01491 <span class="comment"></span>
01492 <span class="comment">    RootCell - cell of the Root index block of index being grown</span>
01493 <span class="comment"></span>
01494 <span class="comment">    RootSelect - indicates which child of Root to split</span>
01495 <span class="comment"></span>
01496 <span class="comment">    Type - Stable or Volatile</span>
01497 <span class="comment"></span>
01498 <span class="comment">Return Value:</span>
01499 <span class="comment"></span>
01500 <span class="comment">    HCELL_NIL - some resource problem</span>
01501 <span class="comment"></span>
01502 <span class="comment">    Else - cell of new (e.g. reallocated) Root index block</span>
01503 <span class="comment"></span>
01504 <span class="comment">--*/</span>
01505 {
01506     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   Root;
01507     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     LeafCell;
01508     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   Leaf;
01509     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     NewLeafCell;
01510     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   NewLeaf;
01511     ULONG           <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
01512     ULONG           freecount;
01513     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>          OldCount;
01514     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>          KeepCount;
01515     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>          NewCount;
01516 
01517     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a39">CMS_INDEX</a>) {
01518         KdPrint((<span class="stringliteral">"CmpSplitLeaf:\n\t"</span>));
01519         KdPrint((<span class="stringliteral">"Hive=%08lx RootCell=%08lx RootSelect\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, RootCell, RootSelect));
01520     }
01521 
01522     <span class="comment">//</span>
01523     <span class="comment">// allocate new Leaf index block</span>
01524     <span class="comment">//</span>
01525     Root = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, RootCell);
01526     LeafCell = Root-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[RootSelect];
01527     Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, LeafCell);
01528     OldCount = Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a>;
01529 
01530     KeepCount = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(OldCount / 2);     <span class="comment">// # of entries to keep in org. Leaf</span>
01531     NewCount = (OldCount - KeepCount);      <span class="comment">// # of entries to move</span>
01532 
01533     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = (<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>) * NewCount) +
01534             FIELD_OFFSET(<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">CM_KEY_INDEX</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>) + 1;   <span class="comment">// +1 to assure room for add</span>
01535 
01536     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, LeafCell)) {
01537         <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01538     }
01539 
01540     NewLeafCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>, Type);
01541     <span class="keywordflow">if</span> (NewLeafCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01542         <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01543     }
01544     NewLeaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, NewLeafCell);
01545     NewLeaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> = <a class="code" href="../../d9/d0/cmdata_8h.html#a19">CM_KEY_INDEX_LEAF</a>;
01546 
01547 
01548     <span class="comment">//</span>
01549     <span class="comment">// compute number of free slots left in the root</span>
01550     <span class="comment">//</span>
01551     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d8/d0/hivecell_8c.html#a15">HvGetCellSize</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Root);
01552     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - ((<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>) * Root-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a>) +
01553               FIELD_OFFSET(<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">CM_KEY_INDEX</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>));
01554     freecount = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> / <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>);
01555 
01556 
01557     <span class="comment">//</span>
01558     <span class="comment">// grow the root if it isn't big enough</span>
01559     <span class="comment">//</span>
01560     <span class="keywordflow">if</span> (freecount &lt; 1) {
01561         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d8/d0/hivecell_8c.html#a15">HvGetCellSize</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Root) + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>);
01562         RootCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a20">HvReallocateCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, RootCell, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
01563         <span class="keywordflow">if</span> (RootCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01564             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, NewLeafCell);
01565             <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01566         }
01567         Root = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, RootCell);
01568     }
01569 
01570 
01571     <span class="comment">//</span>
01572     <span class="comment">// copy data from one Leaf to the other</span>
01573     <span class="comment">//</span>
01574     RtlMoveMemory(
01575         (PVOID)&amp;(NewLeaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[0]),
01576         (PVOID)&amp;(Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[KeepCount]),
01577         <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>) * NewCount
01578         );
01579 
01580     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeepCount != 0);
01581     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(NewCount  != 0);
01582 
01583     Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> = KeepCount;
01584     NewLeaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> = NewCount;
01585 
01586 
01587     <span class="comment">//</span>
01588     <span class="comment">// make an open slot in the root</span>
01589     <span class="comment">//</span>
01590     <span class="keywordflow">if</span> (RootSelect &lt; (ULONG)(Root-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a>-1)) {
01591         RtlMoveMemory(
01592             (PVOID)&amp;(Root-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[RootSelect+2]),
01593             (PVOID)&amp;(Root-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[RootSelect+1]),
01594             (Root-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> - (RootSelect + 1)) * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>)
01595             );
01596     }
01597 
01598     <span class="comment">//</span>
01599     <span class="comment">// update the root</span>
01600     <span class="comment">//</span>
01601     Root-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> += 1;
01602     Root-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[RootSelect+1] = NewLeafCell;
01603     <span class="keywordflow">return</span> RootCell;
01604 }
01605 
01606 
01607 BOOLEAN
<a name="l01608"></a><a class="code" href="../../d1/d2/cmp_8h.html#a306">01608</a> <a class="code" href="../../d1/d2/cmp_8h.html#a306">CmpMarkIndexDirty</a>(
01609     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
01610     HCELL_INDEX     ParentKey,
01611     HCELL_INDEX     TargetKey
01612     )
01613 <span class="comment">/*++</span>
01614 <span class="comment"></span>
01615 <span class="comment">Routine Description:</span>
01616 <span class="comment"></span>
01617 <span class="comment">    Mark as dirty relevent cells of a subkey index.  The Leaf that</span>
01618 <span class="comment">    points to TargetKey, and the Root index block, if applicable,</span>
01619 <span class="comment">    will be marked dirty.  This call assumes we are setting up</span>
01620 <span class="comment">    for a subkey delete.</span>
01621 <span class="comment"></span>
01622 <span class="comment">Arguments:</span>
01623 <span class="comment"></span>
01624 <span class="comment">    Hive - pointer to hive control structure for hive of interest</span>
01625 <span class="comment"></span>
01626 <span class="comment">    ParentKey - key from whose subkey list delete is to be performed</span>
01627 <span class="comment"></span>
01628 <span class="comment">    TargetKey - key being deleted</span>
01629 <span class="comment"></span>
01630 <span class="comment">Return Value:</span>
01631 <span class="comment"></span>
01632 <span class="comment">    TRUE - it worked, FALSE - it didn't, some resource problem</span>
01633 <span class="comment"></span>
01634 <span class="comment">--*/</span>
01635 {
01636     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>    pcell;
01637     ULONG           i;
01638     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     IndexCell;
01639     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01640     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     Child = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01641     UNICODE_STRING  SearchName;
01642     BOOLEAN         IsCompressed;
01643 
01644     pcell = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, TargetKey);
01645     <span class="keywordflow">if</span> (pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>) {
01646         IsCompressed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01647         SearchName.Length = <a class="code" href="../../d1/d2/cmp_8h.html#a320">CmpCompressedNameSize</a>(pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>, pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
01648         SearchName.MaximumLength = SearchName.Length;
01649         SearchName.Buffer = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(SearchName.Length, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01650         <span class="keywordflow">if</span> (SearchName.Buffer==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01651             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01652         }
01653         <a class="code" href="../../d1/d2/cmp_8h.html#a318">CmpCopyCompressedName</a>(SearchName.Buffer,
01654                               SearchName.MaximumLength,
01655                               pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>,
01656                               pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
01657     } <span class="keywordflow">else</span> {
01658         IsCompressed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01659         SearchName.Length = pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>;
01660         SearchName.MaximumLength = pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>;
01661         SearchName.Buffer = &amp;(pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>[0]);
01662     }
01663 
01664     pcell = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ParentKey);
01665 
01666     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o20">StorageTypeCount</a>; i++) {
01667         <span class="keywordflow">if</span> (pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[i] != 0) {
01668             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d0/hivecell_8c.html#a21">HvIsCellAllocated</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[i]));
01669             IndexCell = pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[i];
01670             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, IndexCell);
01671 
01672             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == <a class="code" href="../../d9/d0/cmdata_8h.html#a18">CM_KEY_INDEX_ROOT</a>) {
01673 
01674                 <span class="comment">//</span>
01675                 <span class="comment">// target even in index?</span>
01676                 <span class="comment">//</span>
01677                 <a class="code" href="../../d7/d1/cmindex_8c.html#a2">CmpFindSubKeyInRoot</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>, &amp;SearchName, &amp;Child);
01678                 <span class="keywordflow">if</span> (Child == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01679                     <span class="keywordflow">continue</span>;
01680                 }
01681 
01682                 <span class="comment">//</span>
01683                 <span class="comment">// mark root dirty</span>
01684                 <span class="comment">//</span>
01685                 <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, IndexCell)) {
01686                     <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01687                 }
01688 
01689                 IndexCell = Child;
01690                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Child);
01691             }
01692             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == <a class="code" href="../../d9/d0/cmdata_8h.html#a19">CM_KEY_INDEX_LEAF</a>) ||
01693                    (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == <a class="code" href="../../d9/d0/cmdata_8h.html#a20">CM_KEY_FAST_LEAF</a>));
01694 
01695             <a class="code" href="../../d7/d1/cmindex_8c.html#a3">CmpFindSubKeyInLeaf</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>, pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o15">WorkVar</a>, &amp;SearchName, &amp;Child);
01696             <span class="keywordflow">if</span> (Child != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01697                 <span class="keywordflow">if</span> (IsCompressed) {
01698                     (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(SearchName.Buffer, SearchName.Length);
01699                 }
01700                 <span class="keywordflow">return</span>(<a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, IndexCell));
01701             }
01702         }
01703     }
01704 
01705 <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>:
01706     <span class="keywordflow">if</span> (IsCompressed) {
01707         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(SearchName.Buffer, SearchName.Length);
01708     }
01709     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01710 }
01711 
01712 
01713 BOOLEAN
<a name="l01714"></a><a class="code" href="../../d1/d2/cmp_8h.html#a307">01714</a> <a class="code" href="../../d1/d2/cmp_8h.html#a307">CmpRemoveSubKey</a>(
01715     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
01716     HCELL_INDEX     ParentKey,
01717     HCELL_INDEX     TargetKey
01718     )
01719 <span class="comment">/*++</span>
01720 <span class="comment"></span>
01721 <span class="comment">Routine Description:</span>
01722 <span class="comment"></span>
01723 <span class="comment">    Remove the subkey TargetKey refers to from ParentKey's list.</span>
01724 <span class="comment"></span>
01725 <span class="comment">    NOTE:   Assumes that caller has marked relevent cells dirty,</span>
01726 <span class="comment">            see CmpMarkIndexDirty.</span>
01727 <span class="comment"></span>
01728 <span class="comment">Arguments:</span>
01729 <span class="comment"></span>
01730 <span class="comment">    Hive - pointer to hive control structure for hive of interest</span>
01731 <span class="comment"></span>
01732 <span class="comment">    ParentKey - key from whose subkey list delete is to be performed</span>
01733 <span class="comment"></span>
01734 <span class="comment">    TargetKey - key being deleted</span>
01735 <span class="comment"></span>
01736 <span class="comment">Return Value:</span>
01737 <span class="comment"></span>
01738 <span class="comment">    TRUE - it worked, FALSE - it didn't, some resource problem</span>
01739 <span class="comment"></span>
01740 <span class="comment">--*/</span>
01741 {
01742     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>    pcell;
01743     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     LeafCell;
01744     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   Leaf;
01745     <a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a> FastIndex;
01746     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     RootCell = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01747     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   Root = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01748     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     Child;
01749     ULONG           Type;
01750     ULONG           RootSelect;
01751     ULONG           LeafSelect;
01752     UNICODE_STRING  SearchName;
01753     BOOLEAN         IsCompressed;
01754     WCHAR           CompressedBuffer[50];
01755 
01756     pcell = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, TargetKey);
01757     <span class="keywordflow">if</span> (pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>) {
01758         IsCompressed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01759         SearchName.Length = <a class="code" href="../../d1/d2/cmp_8h.html#a320">CmpCompressedNameSize</a>(pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>, pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
01760         SearchName.MaximumLength = SearchName.Length;
01761         <span class="keywordflow">if</span> (SearchName.MaximumLength &gt; <span class="keyword">sizeof</span>(CompressedBuffer)) {
01762             SearchName.Buffer = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(SearchName.Length, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01763             <span class="keywordflow">if</span> (SearchName.Buffer==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01764                 <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01765             }
01766         } <span class="keywordflow">else</span> {
01767             SearchName.Buffer = CompressedBuffer;
01768         }
01769         <a class="code" href="../../d1/d2/cmp_8h.html#a318">CmpCopyCompressedName</a>(SearchName.Buffer,
01770                               SearchName.MaximumLength,
01771                               pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>,
01772                               pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
01773     } <span class="keywordflow">else</span> {
01774         IsCompressed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01775         SearchName.Length = pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>;
01776         SearchName.MaximumLength = pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>;
01777         SearchName.Buffer = &amp;(pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>[0]);
01778     }
01779 
01780     pcell = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ParentKey);
01781     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(TargetKey);
01782 
01783     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[Type] != 0);
01784     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d0/hivecell_8c.html#a21">HvIsCellAllocated</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Type]));
01785 
01786     LeafCell = pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Type];
01787     Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, LeafCell);
01788 
01789     <span class="keywordflow">if</span> (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a18">CM_KEY_INDEX_ROOT</a>) {
01790         RootSelect = <a class="code" href="../../d7/d1/cmindex_8c.html#a2">CmpFindSubKeyInRoot</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Leaf, &amp;SearchName, &amp;Child);
01791 
01792         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Child != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01793 
01794         Root = Leaf;
01795         RootCell = LeafCell;
01796         LeafCell = Child;
01797         Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, LeafCell);
01798 
01799     }
01800 
01801     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a19">CM_KEY_INDEX_LEAF</a>) ||
01802            (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a20">CM_KEY_FAST_LEAF</a>));
01803 
01804     LeafSelect = <a class="code" href="../../d7/d1/cmindex_8c.html#a3">CmpFindSubKeyInLeaf</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Leaf, pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o15">WorkVar</a>, &amp;SearchName, &amp;Child);
01805 
01806     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Child != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>);
01807 
01808     <span class="comment">//</span>
01809     <span class="comment">// Leaf points to Index Leaf block</span>
01810     <span class="comment">// Child is Index Leaf block cell</span>
01811     <span class="comment">// LeafSelect is Index for List[]</span>
01812     <span class="comment">//</span>
01813     pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[Type] -= 1;
01814 
01815     Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> -= 1;
01816     <span class="keywordflow">if</span> (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> == 0) {
01817 
01818         <span class="comment">//</span>
01819         <span class="comment">// Empty Leaf, drop it.</span>
01820         <span class="comment">//</span>
01821         <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, LeafCell);
01822 
01823         <span class="keywordflow">if</span> (Root != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01824 
01825             Root-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> -= 1;
01826             <span class="keywordflow">if</span> (Root-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> == 0) {
01827 
01828                 <span class="comment">//</span>
01829                 <span class="comment">// Root is empty, free it too.</span>
01830                 <span class="comment">//</span>
01831                 <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, RootCell);
01832                 pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Type] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01833 
01834             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (RootSelect &lt; (ULONG)(Root-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a>)) {
01835 
01836                 <span class="comment">//</span>
01837                 <span class="comment">// Middle entry, squeeze root</span>
01838                 <span class="comment">//</span>
01839                 RtlMoveMemory(
01840                     (PVOID)&amp;(Root-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[RootSelect]),
01841                     (PVOID)&amp;(Root-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[RootSelect+1]),
01842                     (Root-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> - RootSelect) * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>)
01843                     );
01844             }
01845             <span class="comment">//</span>
01846             <span class="comment">// Else RootSelect == last entry, so decrementing count</span>
01847             <span class="comment">// was all we needed to do</span>
01848             <span class="comment">//</span>
01849 
01850         } <span class="keywordflow">else</span> {
01851 
01852             pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Type] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01853 
01854         }
01855 
01856     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (LeafSelect &lt; (ULONG)(Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a>)) {
01857 
01858         <span class="keywordflow">if</span> (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a19">CM_KEY_INDEX_LEAF</a>) {
01859             RtlMoveMemory((PVOID)&amp;(Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[LeafSelect]),
01860                           (PVOID)&amp;(Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[LeafSelect+1]),
01861                           (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> - LeafSelect) * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>));
01862         } <span class="keywordflow">else</span> {
01863             FastIndex = (<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a>)Leaf;
01864             RtlMoveMemory((PVOID)&amp;(FastIndex-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[LeafSelect]),
01865                           (PVOID)&amp;(FastIndex-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[LeafSelect+1]),
01866                           (FastIndex-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o1">Count</a> - LeafSelect) * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__CM__INDEX.html">CM_INDEX</a>));
01867         }
01868     }
01869     <span class="comment">//</span>
01870     <span class="comment">// Else LeafSelect == last entry, so decrementing count was enough</span>
01871     <span class="comment">//</span>
01872 
01873     <span class="keywordflow">if</span> ((IsCompressed) &amp;&amp;
01874         (SearchName.MaximumLength &gt; <span class="keyword">sizeof</span>(CompressedBuffer))) {
01875         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(SearchName.Buffer, SearchName.Length);
01876     }
01877     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01878 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:27 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
