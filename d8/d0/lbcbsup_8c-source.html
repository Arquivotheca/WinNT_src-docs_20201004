<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: lbcbsup.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>lbcbsup.c</h1><a href="../../d7/d1/lbcbsup_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    LbcbSup.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module provides support for manipulating log buffer control blocks.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Brian Andrew    [BrianAn]   20-June-1991</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/lfsprocs_8h.html">lfsprocs.h</a>"</span>
00022 
00023 <span class="comment">//</span>
00024 <span class="comment">//  The debug trace level</span>
00025 <span class="comment">//</span>
00026 
<a name="l00027"></a><a class="code" href="../../d7/d1/lbcbsup_8c.html#a0">00027</a> <span class="preprocessor">#define Dbg                              (DEBUG_TRACE_LBCB_SUP)</span>
00028 <span class="preprocessor"></span>
00029 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, LfsFlushLbcb)</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, LfsFlushToLsnPriv)</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, LfsGetLbcb)</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00034 <span class="preprocessor"></span>
00035 
00036 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00037"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a53">00037</a> <a class="code" href="../../d0/d4/lfsprocs_8h.html#a53">LfsFlushLbcb</a> (
00038     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00039     IN <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> Lbcb
00040     )
00041 
00042 <span class="comment">/*++</span>
00043 <span class="comment"></span>
00044 <span class="comment">Routine Description:</span>
00045 <span class="comment"></span>
00046 <span class="comment">    This routine is called to make sure the data within an Lbcb makes it out</span>
00047 <span class="comment">    to disk.  The Lbcb must either already be in the workque or it must be</span>
00048 <span class="comment">    a restart Lbcb.</span>
00049 <span class="comment"></span>
00050 <span class="comment">Arguments:</span>
00051 <span class="comment"></span>
00052 <span class="comment">    Lfcb - This is the file control block for the log file.</span>
00053 <span class="comment"></span>
00054 <span class="comment">    Lbcb - This is the Lbcb to flush.</span>
00055 <span class="comment"></span>
00056 <span class="comment">Return Value:</span>
00057 <span class="comment"></span>
00058 <span class="comment">    None.</span>
00059 <span class="comment"></span>
00060 <span class="comment">--*/</span>
00061 
00062 {
00063     <a class="code" href="../../d6/d3/lfs_8h.html#a10">LSN</a> LastLsn;
00064     <a class="code" href="../../d6/d3/lfs_8h.html#a11">PLSN</a> FlushedLsn;
00065 
00066     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00067 
00068     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsFlushLbcb:  Entered\n"</span>, 0 );
00069     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Lfcb      -&gt; %08lx\n"</span>, Lfcb );
00070     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Lbcb      -&gt; %08lx\n"</span>, Lbcb );
00071 
00072     LastLsn = Lbcb-&gt;LastEndLsn;
00073 
00074     <span class="comment">//</span>
00075     <span class="comment">//  If this is a restart area we use the restart counter in the</span>
00076     <span class="comment">//  Lfcb.  Otherwise we can use the LastFlushedLsn value in the</span>
00077     <span class="comment">//  Lfcb.  This way we can determine that the Lbcb that interests</span>
00078     <span class="comment">//  us has made it out to disk.</span>
00079     <span class="comment">//</span>
00080 
00081     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d4/lfsprocs_8h.html#a20">LfsLbcbIsRestart</a>( Lbcb )) {
00082 
00083         FlushedLsn = &amp;Lfcb-&gt;LastFlushedRestartLsn;
00084 
00085     } <span class="keywordflow">else</span> {
00086 
00087         FlushedLsn = &amp;Lfcb-&gt;LastFlushedLsn;
00088     }
00089 
00090     <span class="comment">//</span>
00091     <span class="comment">//  We loop here until the desired Lsn has made it to disk.</span>
00092     <span class="comment">//  If we are able to do the I/O, we will perform it.</span>
00093     <span class="comment">//</span>
00094 
00095     <span class="keywordflow">do</span> {
00096 
00097         <span class="comment">//</span>
00098         <span class="comment">//</span>
00099         <span class="comment">//  If we can do the Io, call down to flush the Lfcb.</span>
00100         <span class="comment">//</span>
00101 
00102         <span class="keywordflow">if</span> (Lfcb-&gt;LfsIoState == <a class="code" href="../../d1/d4/lfsstruc_8h.html#a40a38">LfsNoIoInProgress</a>) {
00103 
00104             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a51">LfsFlushLfcb</a>( Lfcb, Lbcb );
00105 
00106             <span class="keywordflow">break</span>;
00107         }
00108 
00109         <span class="comment">//</span>
00110         <span class="comment">//  Otherwise we release the Lfcb and immediately wait on the event.</span>
00111         <span class="comment">//</span>
00112 
00113         Lfcb-&gt;Waiters += 1;
00114 
00115         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a29">LfsReleaseLfcb</a>( Lfcb );
00116 
00117         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;Lfcb-&gt;Sync-&gt;Event,
00118                                <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
00119                                <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00120                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00121                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00122 
00123         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a28">LfsAcquireLfcb</a>( Lfcb );
00124         Lfcb-&gt;Waiters -= 1;
00125 
00126     } <span class="keywordflow">while</span> ( LastLsn.QuadPart &gt; FlushedLsn-&gt;QuadPart );
00127 
00128     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsFlushLbcb:  Exit\n"</span>, 0 );
00129     <span class="keywordflow">return</span>;
00130 }
00131 
00132 
00133 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00134"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a54">00134</a> <a class="code" href="../../d0/d4/lfsprocs_8h.html#a54">LfsFlushToLsnPriv</a> (
00135     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00136     IN LSN Lsn
00137     )
00138 
00139 <span class="comment">/*++</span>
00140 <span class="comment"></span>
00141 <span class="comment">Routine Description:</span>
00142 <span class="comment"></span>
00143 <span class="comment">    This routine is the worker routine which performs the work of flushing</span>
00144 <span class="comment">    a particular Lsn to disk.  This routine is always called with the</span>
00145 <span class="comment">    Lfcb acquired.  This routines makes no guarantee about whether the Lfcb</span>
00146 <span class="comment">    is acquired on exit.</span>
00147 <span class="comment"></span>
00148 <span class="comment">Arguments:</span>
00149 <span class="comment"></span>
00150 <span class="comment">    Lfcb - This is the file control block for the log file.</span>
00151 <span class="comment"></span>
00152 <span class="comment">    Lsn - This is the Lsn to flush to disk.</span>
00153 <span class="comment"></span>
00154 <span class="comment">Return Value:</span>
00155 <span class="comment"></span>
00156 <span class="comment">    None.</span>
00157 <span class="comment"></span>
00158 <span class="comment">--*/</span>
00159 
00160 {
00161     BOOLEAN UseLastRecordLbcb = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00162     <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> LastRecordLbcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00163 
00164     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00165 
00166     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsFlushToLsnPriv:  Entered\n"</span>, 0 );
00167     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Lfcb          -&gt; %08lx\n"</span>, Lfcb );
00168     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Lsn (Low)     -&gt; %08lx\n"</span>, Lsn.LowPart );
00169     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Lsn (High)    -&gt; %08lx\n"</span>, Lsn.HighPart );
00170 
00171     <span class="comment">//</span>
00172     <span class="comment">//  We check if the Lsn is in the valid range.  Raising an</span>
00173     <span class="comment">//  exception if not.</span>
00174     <span class="comment">//</span>
00175 
00176     <span class="keywordflow">if</span> (Lsn.QuadPart &gt; Lfcb-&gt;RestartArea-&gt;CurrentLsn.QuadPart) {
00177 
00178         UseLastRecordLbcb = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00179     }
00180 
00181     <span class="comment">//</span>
00182     <span class="comment">//  If the Lsn has already been flushed we are done.</span>
00183     <span class="comment">//  Otherwise we need to look through the workqueues and the</span>
00184     <span class="comment">//  active queue.</span>
00185     <span class="comment">//</span>
00186 
00187     <span class="keywordflow">if</span> (Lsn.QuadPart &gt; Lfcb-&gt;LastFlushedLsn.QuadPart) {
00188 
00189         PLIST_ENTRY ThisEntry;
00190         <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> ThisLbcb;
00191 
00192         <span class="comment">//</span>
00193         <span class="comment">//  Check the workqueue first.  We are looking for the last</span>
00194         <span class="comment">//  buffer block of a log page block which contains this</span>
00195         <span class="comment">//  Lsn.</span>
00196         <span class="comment">//</span>
00197 
00198         ThisEntry = Lfcb-&gt;LbcbWorkque.Flink;
00199 
00200         <span class="comment">//</span>
00201         <span class="comment">//  We keep looping.</span>
00202         <span class="comment">//</span>
00203 
00204         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00205 
00206             ThisLbcb = CONTAINING_RECORD( ThisEntry,
00207                                           <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
00208                                           WorkqueLinks );
00209 
00210             <span class="comment">//</span>
00211             <span class="comment">//  We pass over any restart areas.  We also skip any</span>
00212             <span class="comment">//  Lbcb's which do not contain the end of a log record.</span>
00213             <span class="comment">//</span>
00214 
00215             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d4/lfsprocs_8h.html#a20">LfsLbcbIsRestart</a>( ThisLbcb )
00216                 &amp;&amp; <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o12">Flags</a>, <a class="code" href="../../d9/d3/lfsdisk_8h.html#a7">LOG_PAGE_LOG_RECORD_END</a> )) {
00217 
00218                 LastRecordLbcb = ThisLbcb;
00219 
00220                 <span class="comment">//</span>
00221                 <span class="comment">//  If the last complete Lsn in this Lbcb is greater or equal</span>
00222                 <span class="comment">//  to the desired Lsn, we exit the loop.</span>
00223                 <span class="comment">//</span>
00224 
00225                 <span class="keywordflow">if</span> (ThisLbcb-&gt;LastEndLsn.QuadPart &gt;= Lsn.QuadPart) {
00226 
00227                     <span class="keywordflow">break</span>;
00228                 }
00229             }
00230 
00231             <span class="comment">//</span>
00232             <span class="comment">//  Otherwise move to the next Lbcb.</span>
00233             <span class="comment">//</span>
00234 
00235             ThisEntry = ThisEntry-&gt;Flink;
00236 
00237             <span class="comment">//</span>
00238             <span class="comment">//  If we have reached the end of the list then break out.  We</span>
00239             <span class="comment">//  were given an Lsn which is larger than any flushed Lsn so</span>
00240             <span class="comment">//  we will just flush to the end of the log file.</span>
00241             <span class="comment">//</span>
00242 
00243             <span class="keywordflow">if</span> (ThisEntry == &amp;Lfcb-&gt;LbcbWorkque) {
00244 
00245                 <span class="keywordflow">if</span> (UseLastRecordLbcb) {
00246 
00247                     ThisLbcb = LastRecordLbcb;
00248                 }
00249 
00250                 <span class="keywordflow">break</span>;
00251             }
00252         }
00253 
00254         <span class="keywordflow">if</span> (ThisLbcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00255 
00256             <span class="comment">//</span>
00257             <span class="comment">//  If we are not supporting a packed log file and this Lbcb is from</span>
00258             <span class="comment">//  the active queue, we need to check that losing the tail of the</span>
00259             <span class="comment">//  will not swallow up any of our reserved space.</span>
00260             <span class="comment">//</span>
00261 
00262             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a8">LFCB_PACK_LOG</a> )
00263                 &amp;&amp; <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o13">LbcbFlags</a>, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a1">LBCB_ON_ACTIVE_QUEUE</a> )) {
00264 
00265                 LONGLONG CurrentAvail;
00266                 LONGLONG UnusedBytes;
00267 
00268                 <span class="comment">//</span>
00269                 <span class="comment">//  Find the unused bytes.</span>
00270                 <span class="comment">//</span>
00271 
00272                 UnusedBytes = 0;
00273 
00274                 <a class="code" href="../../d7/d5/lfs_2verfysup_8c.html#a0">LfsCurrentAvailSpace</a>( Lfcb,
00275                                       &amp;CurrentAvail,
00276                                       (PULONG)&amp;UnusedBytes );
00277 
00278                 CurrentAvail = CurrentAvail - Lfcb-&gt;TotalUndoCommitment;
00279 
00280                 <span class="keywordflow">if</span> (UnusedBytes &gt; CurrentAvail) {
00281 
00282                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Have to preserve these bytes for possible aborts\n"</span>, 0 );
00283 
00284                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_LOG_FILE_FULL );
00285                 }
00286 
00287                 <span class="comment">//</span>
00288                 <span class="comment">//  We want to make sure we don't write any more data into this</span>
00289                 <span class="comment">//  page.  Remove this from the active queue.</span>
00290                 <span class="comment">//</span>
00291 
00292                 RemoveEntryList( &amp;ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o3">ActiveLinks</a> );
00293                 <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o13">LbcbFlags</a>, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a1">LBCB_ON_ACTIVE_QUEUE</a> );
00294             }
00295 
00296             <span class="comment">//</span>
00297             <span class="comment">//  We now have the Lbcb we want to flush to disk.</span>
00298             <span class="comment">//</span>
00299 
00300             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a53">LfsFlushLbcb</a>( Lfcb, ThisLbcb );
00301         }
00302     }
00303 
00304     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsFlushToLsnPriv:  Exit\n"</span>, 0 );
00305 
00306     <span class="keywordflow">return</span>;
00307 }
00308 
00309 
00310 <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a>
<a name="l00311"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a55">00311</a> <a class="code" href="../../d0/d4/lfsprocs_8h.html#a55">LfsGetLbcb</a> (
00312     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb
00313     )
00314 
00315 <span class="comment">/*++</span>
00316 <span class="comment"></span>
00317 <span class="comment">Routine Description:</span>
00318 <span class="comment"></span>
00319 <span class="comment">    This routine is called to add a Lbcb to the active queue.</span>
00320 <span class="comment"></span>
00321 <span class="comment">Arguments:</span>
00322 <span class="comment"></span>
00323 <span class="comment">    Lfcb - This is the file control block for the log file.</span>
00324 <span class="comment"></span>
00325 <span class="comment">Return Value:</span>
00326 <span class="comment"></span>
00327 <span class="comment">    PLBCB - Pointer to the Lbcb allocated.</span>
00328 <span class="comment"></span>
00329 <span class="comment">--*/</span>
00330 
00331 {
00332     <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> Lbcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00333     PVOID PageHeader;
00334     <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> PageHeaderBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00335 
00336     BOOLEAN WrappedOrUsaError;
00337 
00338     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00339 
00340     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsGetLbcb:  Entered\n"</span>, 0 );
00341     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Lfcb      -&gt; %08lx\n"</span>, Lfcb );
00342 
00343     <span class="comment">//</span>
00344     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00345     <span class="comment">//</span>
00346 
00347     <span class="keywordflow">try</span> {
00348 
00349         <span class="comment">//</span>
00350         <span class="comment">//  Pin the desired record page.</span>
00351         <span class="comment">//</span>
00352 
00353         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a5">LfsPreparePinWriteData</a>( Lfcb,
00354                                 Lfcb-&gt;NextLogPage,
00355                                 (ULONG)Lfcb-&gt;LogPageSize,
00356                                 &amp;PageHeader,
00357                                 &amp;PageHeaderBcb );
00358 
00359         <span class="comment">//</span>
00360         <span class="comment">//  Put our signature into the page so we won't fail if we</span>
00361         <span class="comment">//  see a previous 'BAAD' signature.</span>
00362         <span class="comment">//</span>
00363 
00364         *((PULONG) PageHeader) = <a class="code" href="../../d9/d3/lfsdisk_8h.html#a14">LFS_SIGNATURE_RECORD_PAGE_ULONG</a>;
00365 
00366         <span class="comment">//</span>
00367         <span class="comment">//  Now allocate an Lbcb.</span>
00368         <span class="comment">//</span>
00369 
00370         <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a3">LfsAllocateLbcb</a>( Lfcb, &amp;Lbcb );
00371 
00372         <span class="comment">//</span>
00373         <span class="comment">//  If we are at the beginning of the file we test that the</span>
00374         <span class="comment">//  sequence number won't wrap to 0.</span>
00375         <span class="comment">//</span>
00376 
00377         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a7">LFCB_NO_LAST_LSN</a> | <a class="code" href="../../d1/d4/lfsstruc_8h.html#a9">LFCB_REUSE_TAIL</a> )
00378             &amp;&amp; ( Lfcb-&gt;NextLogPage == Lfcb-&gt;FirstLogPage )) {
00379 
00380             Lfcb-&gt;SeqNumber = Lfcb-&gt;SeqNumber + 1;
00381 
00382             <span class="comment">//</span>
00383             <span class="comment">//  If the sequence number is going from 0 to 1, then</span>
00384             <span class="comment">//  this is the first time the log file has wrapped.  We want</span>
00385             <span class="comment">//  to remember this because it means that we can now do</span>
00386             <span class="comment">//  large spiral writes.</span>
00387             <span class="comment">//</span>
00388 
00389             <span class="keywordflow">if</span> (Int64ShllMod32( Lfcb-&gt;SeqNumber, Lfcb-&gt;FileDataBits ) == 0) {
00390 
00391                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Log sequence number about to wrap:  Lfcb -&gt; %08lx\n"</span>, Lfcb );
00392                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>( FILE_SYSTEM );
00393             }
00394 
00395             <span class="comment">//</span>
00396             <span class="comment">//  If this number is greater or equal to  the wrap sequence number in</span>
00397             <span class="comment">//  the Lfcb, set the wrap flag in the Lbcb.</span>
00398             <span class="comment">//</span>
00399 
00400             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a5">LFCB_LOG_WRAPPED</a> )
00401                 &amp;&amp; ( Lfcb-&gt;SeqNumber &gt;= Lfcb-&gt;SeqNumberForWrap )) {
00402 
00403                 <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o13">LbcbFlags</a>, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a0">LBCB_LOG_WRAPPED</a> );
00404                 <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Lfcb-&gt;Flags, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a5">LFCB_LOG_WRAPPED</a> );
00405             }
00406         }
00407 
00408         <span class="comment">//</span>
00409         <span class="comment">//  Now initialize the rest of the Lbcb fields.</span>
00410         <span class="comment">//</span>
00411 
00412         Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o4">FileOffset</a> = Lfcb-&gt;NextLogPage;
00413         Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o6">SeqNumber</a> = Lfcb-&gt;SeqNumber;
00414         Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o7">BufferOffset</a> = Lfcb-&gt;LogPageDataOffset;
00415 
00416         <span class="comment">//</span>
00417         <span class="comment">//  Store the next page in the Lfcb.</span>
00418         <span class="comment">//</span>
00419 
00420         <a class="code" href="../../d6/d5/logpgsup_8c.html#a2">LfsNextLogPageOffset</a>( Lfcb,
00421                               Lfcb-&gt;NextLogPage,
00422                               &amp;Lfcb-&gt;NextLogPage,
00423                               &amp;WrappedOrUsaError );
00424 
00425         Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o5">Length</a> = Lfcb-&gt;LogPageSize;
00426         Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o8">PageHeader</a> = PageHeader;
00427         Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o9">LogPageBcb</a> = PageHeaderBcb;
00428 
00429         Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o14">ResourceThread</a> = <a class="code" href="../../d5/d8/ex_8h.html#a67">ExGetCurrentResourceThread</a>();
00430         Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o14">ResourceThread</a> = (<a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>) ((ULONG) Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o14">ResourceThread</a> | 3);
00431 
00432         <span class="comment">//</span>
00433         <span class="comment">//  If we are reusing a previous page then set a flag in</span>
00434         <span class="comment">//  the Lbcb to indicate that we should flush a copy</span>
00435         <span class="comment">//  first.</span>
00436         <span class="comment">//</span>
00437 
00438         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a9">LFCB_REUSE_TAIL</a> )) {
00439 
00440             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o13">LbcbFlags</a>, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a3">LBCB_FLUSH_COPY</a> );
00441             <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( Lfcb-&gt;Flags, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a9">LFCB_REUSE_TAIL</a> );
00442 
00443             (ULONG)Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o7">BufferOffset</a> = Lfcb-&gt;ReusePageOffset;
00444 
00445             Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o12">Flags</a> = ((<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html">PLFS_RECORD_PAGE_HEADER</a>) PageHeader)-&gt;Flags;
00446             Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o10">LastLsn</a> = ((<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html">PLFS_RECORD_PAGE_HEADER</a>) PageHeader)-&gt;Copy.LastLsn;
00447             Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o11">LastEndLsn</a> = ((<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html">PLFS_RECORD_PAGE_HEADER</a>) PageHeader)-&gt;Header.Packed.LastEndLsn;
00448         }
00449 
00450         <span class="comment">//</span>
00451         <span class="comment">//  Put the Lbcb on the active queue</span>
00452         <span class="comment">//</span>
00453 
00454         InsertTailList( &amp;Lfcb-&gt;LbcbActive, &amp;Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o3">ActiveLinks</a> );
00455 
00456         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o13">LbcbFlags</a>, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a1">LBCB_ON_ACTIVE_QUEUE</a> );
00457 
00458         <span class="comment">//</span>
00459         <span class="comment">//  Now that we have succeeded, set the owner thread to Thread + 1 so the resource</span>
00460         <span class="comment">//  package will know not to peek in this thread.  It may be deallocated before</span>
00461         <span class="comment">//  we release the Bcb during flush.</span>
00462         <span class="comment">//</span>
00463 
00464         <a class="code" href="../../d4/d2/cache_8h.html#a93">CcSetBcbOwnerPointer</a>( Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o9">LogPageBcb</a>, (PVOID) Lbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o14">ResourceThread</a> );
00465 
00466     } finally {
00467 
00468         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( <a class="code" href="../../d7/d1/lbcbsup_8c.html#a3">LfsGetLbcb</a> );
00469 
00470         <span class="comment">//</span>
00471         <span class="comment">//  If an error occurred, we need to clean up any blocks which</span>
00472         <span class="comment">//  have not been added to the active queue.</span>
00473         <span class="comment">//</span>
00474 
00475         <span class="keywordflow">if</span> (AbnormalTermination()) {
00476 
00477             <span class="keywordflow">if</span> (Lbcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00478 
00479                 <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a4">LfsDeallocateLbcb</a>( Lfcb, Lbcb );
00480                 Lbcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00481             }
00482 
00483             <span class="comment">//</span>
00484             <span class="comment">//  Unpin the system page if pinned.</span>
00485             <span class="comment">//</span>
00486 
00487             <span class="keywordflow">if</span> (PageHeaderBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00488 
00489                 <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( PageHeaderBcb );
00490             }
00491         }
00492 
00493         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsGetLbcb:  Exit\n"</span>, 0 );
00494     }
00495 
00496     <span class="keywordflow">return</span> Lbcb;
00497 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:36 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
