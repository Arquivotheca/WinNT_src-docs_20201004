<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: rtlassig.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>rtlassig.c</h1><a href="../../d7/d1/rtlassig_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    rtlassig.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This Module implements many security rtl routines defined in ntseapi.h</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Jim Kelly       (JimK)     23-Mar-1990</span>
00016 <span class="comment">    Robert Reichel  (RobertRe)  1-Mar-1991</span>
00017 <span class="comment"></span>
00018 <span class="comment">Environment:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Pure Runtime Library Routine</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 
00027 <span class="preprocessor">#include "<a class="code" href="../../d5/d9/ntrtlp_8h.html">ntrtlp.h</a>"</span>
00028 <span class="preprocessor">#include "seopaque.h"</span>
00029 <span class="preprocessor">#include "sertlp.h"</span>
00030 
00031 <span class="preprocessor">#if defined(ALLOC_PRAGMA) &amp;&amp; defined(NTOS_KERNEL_RUNTIME)</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlSelfRelativeToAbsoluteSD)</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlMakeSelfRelativeSD)</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlpQuerySecurityDescriptor)</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlAbsoluteToSelfRelativeSD)</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlSelfRelativeToAbsoluteSD2)</span>
00037 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00038 <span class="preprocessor"></span>
00039 
00041 <span class="comment">//                                                                           //</span>
00042 <span class="comment">//    Exported Procedures                                                    //</span>
00043 <span class="comment">//                                                                           //</span>
00045 <span class="comment"></span>
00046 
00047 
00048 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00049"></a><a class="code" href="../../d7/d1/rtlassig_8c.html#a2">00049</a> <a class="code" href="../../d7/d1/rtlassig_8c.html#a2">RtlSelfRelativeToAbsoluteSD</a>(
00050     IN OUT PSECURITY_DESCRIPTOR SelfRelativeSecurityDescriptor,
00051     OUT PSECURITY_DESCRIPTOR AbsoluteSecurityDescriptor,
00052     IN OUT PULONG AbsoluteSecurityDescriptorSize,
00053     IN OUT PACL Dacl,
00054     IN OUT PULONG DaclSize,
00055     IN OUT PACL Sacl,
00056     IN OUT PULONG SaclSize,
00057     IN OUT PSID Owner,
00058     IN OUT PULONG OwnerSize,
00059     IN OUT PSID PrimaryGroup,
00060     IN OUT PULONG PrimaryGroupSize
00061     )
00062 
00063 <span class="comment">/*++</span>
00064 <span class="comment"></span>
00065 <span class="comment">Routine Description:</span>
00066 <span class="comment"></span>
00067 <span class="comment">    Converts a security descriptor from self-relative format to absolute</span>
00068 <span class="comment">    format</span>
00069 <span class="comment"></span>
00070 <span class="comment">Arguments:</span>
00071 <span class="comment"></span>
00072 <span class="comment">    SecurityDescriptor - Supplies a pointer to a security descriptor in</span>
00073 <span class="comment">        Self-Relative format</span>
00074 <span class="comment"></span>
00075 <span class="comment">    AbsoluteSecurityDescriptor - A pointer to a buffer in which will be</span>
00076 <span class="comment">        placed the main body of the Absolute format security descriptor.</span>
00077 <span class="comment"></span>
00078 <span class="comment">    Dacl - Supplies a pointer to a buffer that will contain the Dacl of the</span>
00079 <span class="comment">        output descriptor.  This pointer will be referenced by, not copied</span>
00080 <span class="comment">        into, the output descriptor.</span>
00081 <span class="comment"></span>
00082 <span class="comment">    DaclSize - Supplies the size of the buffer pointed to by Dacl.  In case</span>
00083 <span class="comment">        of error, it will return the minimum size necessary to contain the</span>
00084 <span class="comment">        Dacl.</span>
00085 <span class="comment"></span>
00086 <span class="comment">    Sacl - Supplies a pointer to a buffer that will contain the Sacl of the</span>
00087 <span class="comment">        output descriptor.  This pointer will be referenced by, not copied</span>
00088 <span class="comment">        into, the output descriptor.</span>
00089 <span class="comment"></span>
00090 <span class="comment">    SaclSize - Supplies the size of the buffer pointed to by Sacl.  In case</span>
00091 <span class="comment">        of error, it will return the minimum size necessary to contain the</span>
00092 <span class="comment">        Sacl.</span>
00093 <span class="comment"></span>
00094 <span class="comment">    Owner - Supplies a pointer to a buffer that will contain the Owner of</span>
00095 <span class="comment">        the output descriptor.  This pointer will be referenced by, not</span>
00096 <span class="comment">        copied into, the output descriptor.</span>
00097 <span class="comment"></span>
00098 <span class="comment">    OwnerSize - Supplies the size of the buffer pointed to by Owner.  In</span>
00099 <span class="comment">        case of error, it will return the minimum size necessary to contain</span>
00100 <span class="comment">        the Owner.</span>
00101 <span class="comment"></span>
00102 <span class="comment">    PrimaryGroup - Supplies a pointer to a buffer that will contain the</span>
00103 <span class="comment">        PrimaryGroup of the output descriptor.  This pointer will be</span>
00104 <span class="comment">        referenced by, not copied into, the output descriptor.</span>
00105 <span class="comment"></span>
00106 <span class="comment">    PrimaryGroupSize - Supplies the size of the buffer pointed to by</span>
00107 <span class="comment">        PrimaryGroup.  In case of error, it will return the minimum size</span>
00108 <span class="comment">        necessary to contain the PrimaryGroup.</span>
00109 <span class="comment"></span>
00110 <span class="comment"></span>
00111 <span class="comment">Return Value:</span>
00112 <span class="comment"></span>
00113 <span class="comment">    STATUS_SUCCESS - Success</span>
00114 <span class="comment"></span>
00115 <span class="comment">    STATUS_BUFFER_TOO_SMALL - One of the buffers passed was too small.</span>
00116 <span class="comment"></span>
00117 <span class="comment">    STATUS_INVALID_OWNER - There was not a valid owner in the passed</span>
00118 <span class="comment">        security descriptor.</span>
00119 <span class="comment"></span>
00120 <span class="comment">--*/</span>
00121 
00122 {
00123     ULONG NewDaclSize;
00124     ULONG NewSaclSize;
00125     ULONG NewBodySize;
00126     ULONG NewOwnerSize;
00127     ULONG NewGroupSize;
00128 
00129     PSID NewOwner;
00130     PSID NewGroup;
00131     PACL NewDacl;
00132     PACL NewSacl;
00133 
00134     <span class="comment">//</span>
00135     <span class="comment">// typecast security descriptors so we don't have to cast all over the place.</span>
00136     <span class="comment">//</span>
00137 
00138     PISECURITY_DESCRIPTOR OutSD =
00139         AbsoluteSecurityDescriptor;
00140 
00141     PISECURITY_DESCRIPTOR InSD =
00142             (PISECURITY_DESCRIPTOR)SelfRelativeSecurityDescriptor;
00143 
00144 
00145     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00146 
00147     <span class="keywordflow">if</span> ( !RtlpAreControlBitsSet( InSD, SE_SELF_RELATIVE) ) {
00148         <span class="keywordflow">return</span>( STATUS_BAD_DESCRIPTOR_FORMAT );
00149     }
00150 
00151     NewBodySize = <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR);
00152 
00153     <a class="code" href="../../d7/d1/rtlassig_8c.html#a5">RtlpQuerySecurityDescriptor</a>(
00154         InSD,
00155         &amp;NewOwner,
00156         &amp;NewOwnerSize,
00157         &amp;NewGroup,
00158         &amp;NewGroupSize,
00159         &amp;NewDacl,
00160         &amp;NewDaclSize,
00161         &amp;NewSacl,
00162         &amp;NewSaclSize
00163         );
00164 
00165     <span class="keywordflow">if</span> ( (NewBodySize  &gt; *AbsoluteSecurityDescriptorSize) ||
00166          (NewOwnerSize &gt; *OwnerSize )                     ||
00167          (NewDaclSize  &gt; *DaclSize )                      ||
00168          (NewSaclSize  &gt; *SaclSize )                      ||
00169          (NewGroupSize &gt; *PrimaryGroupSize ) ) {
00170 
00171          *AbsoluteSecurityDescriptorSize = <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR);
00172          *PrimaryGroupSize               = NewGroupSize;
00173          *OwnerSize                      = NewOwnerSize;
00174          *SaclSize                       = NewSaclSize;
00175          *DaclSize                       = NewDaclSize;
00176 
00177          <span class="keywordflow">return</span>( STATUS_BUFFER_TOO_SMALL );
00178     }
00179 
00180 
00181     RtlMoveMemory( OutSD,
00182                    InSD,
00183                    <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR_RELATIVE) );
00184 
00185     OutSD-&gt;Owner = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00186     OutSD-&gt;Group = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00187     OutSD-&gt;Sacl  = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00188     OutSD-&gt;Dacl  = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00189 
00190     RtlpClearControlBits( OutSD, SE_SELF_RELATIVE );
00191 
00192     <span class="keywordflow">if</span> (NewOwner != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00193         RtlMoveMemory( <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>, NewOwner, <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( NewOwner ));
00194         OutSD-&gt;Owner = <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>;
00195     }
00196 
00197     <span class="keywordflow">if</span> (NewGroup != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00198         RtlMoveMemory( PrimaryGroup, NewGroup, <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( NewGroup ));
00199         OutSD-&gt;Group = PrimaryGroup;
00200     }
00201 
00202     <span class="keywordflow">if</span> (NewSacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00203         RtlMoveMemory( Sacl, NewSacl, NewSacl-&gt;AclSize );
00204         OutSD-&gt;Sacl  = Sacl;
00205     }
00206 
00207     <span class="keywordflow">if</span> (NewDacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00208         RtlMoveMemory( <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>, NewDacl, NewDacl-&gt;AclSize );
00209         OutSD-&gt;Dacl  = <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>;
00210     }
00211 
00212     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00213 }
00214 
00215 
00216 
00217 
00218 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00219"></a><a class="code" href="../../d7/d1/rtlassig_8c.html#a3">00219</a> <a class="code" href="../../d7/d1/rtlassig_8c.html#a3">RtlMakeSelfRelativeSD</a>(
00220     IN PSECURITY_DESCRIPTOR SecurityDescriptor,
00221     IN OUT PSECURITY_DESCRIPTOR SelfRelativeSecurityDescriptor,
00222     IN OUT PULONG BufferLength
00223     )
00224 
00225 <span class="comment">/*++</span>
00226 <span class="comment"></span>
00227 <span class="comment">Routine Description:</span>
00228 <span class="comment"></span>
00229 <span class="comment">    Makes a copy of a security descriptor.  The produced copy will be in self-relative</span>
00230 <span class="comment">    form.</span>
00231 <span class="comment"></span>
00232 <span class="comment">    The security descriptor to be copied may be in either absolute or self-relative</span>
00233 <span class="comment">    form.</span>
00234 <span class="comment"></span>
00235 <span class="comment">Arguments:</span>
00236 <span class="comment"></span>
00237 <span class="comment">    SecurityDescriptor - Pointer to a security descriptor.  This descriptor will not</span>
00238 <span class="comment">        be modified.</span>
00239 <span class="comment"></span>
00240 <span class="comment">    SelfRelativeSecurityDescriptor - Pointer to a buffer that will contain</span>
00241 <span class="comment">        the returned self-relative security descriptor.</span>
00242 <span class="comment"></span>
00243 <span class="comment">    BufferLength - Supplies the length of the buffer.  If the supplied</span>
00244 <span class="comment">        buffer is not large enough to hold the self-relative security</span>
00245 <span class="comment">        descriptor, an error will be returned, and this field will return</span>
00246 <span class="comment">        the minimum size required.</span>
00247 <span class="comment"></span>
00248 <span class="comment"></span>
00249 <span class="comment">Return Value:</span>
00250 <span class="comment"></span>
00251 <span class="comment">    STATUS_BUFFER_TOO_SMALL - The supplied buffer was too small to contain</span>
00252 <span class="comment">        the resultant security descriptor.</span>
00253 <span class="comment"></span>
00254 <span class="comment"></span>
00255 <span class="comment">--*/</span>
00256 
00257 {
00258     ULONG NewDaclSize;
00259     ULONG NewSaclSize;
00260     ULONG NewOwnerSize;
00261     ULONG NewGroupSize;
00262 
00263     ULONG AllocationSize;
00264 
00265     PSID NewOwner;
00266     PSID NewGroup;
00267     PACL NewDacl;
00268     PACL NewSacl;
00269 
00270     PCHAR Field;
00271     PCHAR Base;
00272 
00273 
00274     <span class="comment">//</span>
00275     <span class="comment">// Convert security descriptors to new data type so we don't</span>
00276     <span class="comment">// have to cast all over the place.</span>
00277     <span class="comment">//</span>
00278 
00279     PISECURITY_DESCRIPTOR_RELATIVE IResultantDescriptor =
00280             (PISECURITY_DESCRIPTOR_RELATIVE)SelfRelativeSecurityDescriptor;
00281 
00282     PISECURITY_DESCRIPTOR IPassedSecurityDescriptor =
00283             (PISECURITY_DESCRIPTOR)SecurityDescriptor;
00284 
00285 
00286     <a class="code" href="../../d7/d1/rtlassig_8c.html#a5">RtlpQuerySecurityDescriptor</a>(
00287         IPassedSecurityDescriptor,
00288         &amp;NewOwner,
00289         &amp;NewOwnerSize,
00290         &amp;NewGroup,
00291         &amp;NewGroupSize,
00292         &amp;NewDacl,
00293         &amp;NewDaclSize,
00294         &amp;NewSacl,
00295         &amp;NewSaclSize
00296         );
00297 
00298     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00299 
00300     AllocationSize = <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR_RELATIVE) +
00301                      NewOwnerSize +
00302                      NewGroupSize +
00303                      NewDaclSize  +
00304                      NewSaclSize  ;
00305 
00306     <span class="keywordflow">if</span> (AllocationSize &gt; *BufferLength) {
00307         *BufferLength = AllocationSize;
00308         <span class="keywordflow">return</span>( STATUS_BUFFER_TOO_SMALL );
00309     }
00310 
00311     RtlZeroMemory( IResultantDescriptor, AllocationSize );
00312 
00313     RtlCopyMemory( IResultantDescriptor,
00314                    IPassedSecurityDescriptor,
00315                    FIELD_OFFSET( SECURITY_DESCRIPTOR_RELATIVE, <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> ));
00316 
00317 
00318     Base = (PCHAR)(IResultantDescriptor);
00319     Field =  Base + (ULONG)<span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR_RELATIVE);
00320 
00321     <span class="keywordflow">if</span> (NewSaclSize &gt; 0) {
00322         RtlCopyMemory( Field, NewSacl, NewSaclSize );
00323         IResultantDescriptor-&gt;Sacl = RtlPointerToOffset(Base,Field);
00324         Field += NewSaclSize;
00325     } <span class="keywordflow">else</span> {
00326         IResultantDescriptor-&gt;Sacl = 0;
00327     }
00328 
00329 
00330     <span class="keywordflow">if</span> (NewDaclSize &gt; 0) {
00331         RtlCopyMemory( Field, NewDacl, NewDaclSize );
00332         IResultantDescriptor-&gt;Dacl = RtlPointerToOffset(Base,Field);
00333         Field += NewDaclSize;
00334     } <span class="keywordflow">else</span> {
00335         IResultantDescriptor-&gt;Dacl = 0;
00336     }
00337 
00338 
00339 
00340     <span class="keywordflow">if</span> (NewOwnerSize &gt; 0) {
00341         RtlCopyMemory( Field, NewOwner, NewOwnerSize );
00342         IResultantDescriptor-&gt;Owner = RtlPointerToOffset(Base,Field);
00343         Field += NewOwnerSize;
00344     }
00345 
00346 
00347     <span class="keywordflow">if</span> (NewGroupSize &gt; 0) {
00348         RtlCopyMemory( Field, NewGroup, NewGroupSize );
00349         IResultantDescriptor-&gt;Group = RtlPointerToOffset(Base,Field);
00350     }
00351 
00352     RtlpSetControlBits( IResultantDescriptor, SE_SELF_RELATIVE );
00353 
00354     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00355 
00356 }
00357 
00358 
00359 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00360"></a><a class="code" href="../../d7/d1/rtlassig_8c.html#a4">00360</a> <a class="code" href="../../d7/d1/rtlassig_8c.html#a4">RtlAbsoluteToSelfRelativeSD</a>(
00361     IN PSECURITY_DESCRIPTOR AbsoluteSecurityDescriptor,
00362     IN OUT PSECURITY_DESCRIPTOR SelfRelativeSecurityDescriptor,
00363     IN OUT PULONG BufferLength
00364     )
00365 
00366 <span class="comment">/*++</span>
00367 <span class="comment"></span>
00368 <span class="comment">Routine Description:</span>
00369 <span class="comment"></span>
00370 <span class="comment">    Converts a security descriptor in absolute form to one in self-relative</span>
00371 <span class="comment">    form.</span>
00372 <span class="comment"></span>
00373 <span class="comment">Arguments:</span>
00374 <span class="comment"></span>
00375 <span class="comment">    AbsoluteSecurityDescriptor - Pointer to an absolute format security</span>
00376 <span class="comment">        descriptor.  This descriptor will not be modified.</span>
00377 <span class="comment"></span>
00378 <span class="comment">    SelfRelativeSecurityDescriptor - Pointer to a buffer that will contain</span>
00379 <span class="comment">        the returned self-relative security descriptor.</span>
00380 <span class="comment"></span>
00381 <span class="comment">    BufferLength - Supplies the length of the buffer.  If the supplied</span>
00382 <span class="comment">        buffer is not large enough to hold the self-relative security</span>
00383 <span class="comment">        descriptor, an error will be returned, and this field will return</span>
00384 <span class="comment">        the minimum size required.</span>
00385 <span class="comment"></span>
00386 <span class="comment"></span>
00387 <span class="comment">Return Value:</span>
00388 <span class="comment"></span>
00389 <span class="comment">    STATUS_BUFFER_TOO_SMALL - The supplied buffer was too small to contain</span>
00390 <span class="comment">        the resultant security descriptor.</span>
00391 <span class="comment"></span>
00392 <span class="comment">    STATUS_BAD_DESCRIPTOR_FORMAT - The supplied security descriptor was not</span>
00393 <span class="comment">        in absolute form.</span>
00394 <span class="comment"></span>
00395 <span class="comment">--*/</span>
00396 
00397 {
00398     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> NtStatus;
00399 
00400     PISECURITY_DESCRIPTOR IAbsoluteSecurityDescriptor =
00401             (PISECURITY_DESCRIPTOR)AbsoluteSecurityDescriptor;
00402 
00403 
00404     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00405 
00406     <span class="comment">//</span>
00407     <span class="comment">// Make sure the passed SD is absolute format, and then call</span>
00408     <span class="comment">// RtlMakeSelfRelativeSD() to do all the work.</span>
00409     <span class="comment">//</span>
00410 
00411     <span class="keywordflow">if</span> ( RtlpAreControlBitsSet( IAbsoluteSecurityDescriptor, SE_SELF_RELATIVE) ) {
00412         <span class="keywordflow">return</span>( STATUS_BAD_DESCRIPTOR_FORMAT );
00413     }
00414 
00415     NtStatus = <a class="code" href="../../d7/d1/rtlassig_8c.html#a3">RtlMakeSelfRelativeSD</a>(
00416                    AbsoluteSecurityDescriptor,
00417                    SelfRelativeSecurityDescriptor,
00418                    BufferLength
00419                    );
00420 
00421     <span class="keywordflow">return</span>( NtStatus );
00422 
00423 }
00424 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00425"></a><a class="code" href="../../d7/d1/rtlassig_8c.html#a5">00425</a> <a class="code" href="../../d7/d1/rtlassig_8c.html#a5">RtlpQuerySecurityDescriptor</a>(
00426     IN PISECURITY_DESCRIPTOR SecurityDescriptor,
00427     OUT PSID *Owner,
00428     OUT PULONG OwnerSize,
00429     OUT PSID *PrimaryGroup,
00430     OUT PULONG PrimaryGroupSize,
00431     OUT PACL *Dacl,
00432     OUT PULONG DaclSize,
00433     OUT PACL *Sacl,
00434     OUT PULONG SaclSize
00435     )
00436 <span class="comment">/*++</span>
00437 <span class="comment"></span>
00438 <span class="comment">Routine Description:</span>
00439 <span class="comment"></span>
00440 <span class="comment">    Returns the pieces of a security descriptor structure.</span>
00441 <span class="comment"></span>
00442 <span class="comment">Arguments:</span>
00443 <span class="comment"></span>
00444 <span class="comment"></span>
00445 <span class="comment">    SecurityDescriptor - Provides the security descriptor of interest.</span>
00446 <span class="comment"></span>
00447 <span class="comment">    Owner - Returns a pointer to the owner information contained in the</span>
00448 <span class="comment">        security descriptor.</span>
00449 <span class="comment"></span>
00450 <span class="comment">    OwnerSize - Returns the size of the owner information.</span>
00451 <span class="comment"></span>
00452 <span class="comment">    PrimaryGroup -  Returns a pointer to the primary group information.</span>
00453 <span class="comment"></span>
00454 <span class="comment">    PrimaryGroupSize - Returns the size of the primary group information.</span>
00455 <span class="comment"></span>
00456 <span class="comment">    Dacl - Returns a pointer to the Dacl.</span>
00457 <span class="comment"></span>
00458 <span class="comment">    DaclSize - Returns the size of the Dacl.</span>
00459 <span class="comment"></span>
00460 <span class="comment">    Sacl - Returns a pointer to the Sacl.</span>
00461 <span class="comment"></span>
00462 <span class="comment">    SaclSize - Returns the size of the Sacl.</span>
00463 <span class="comment"></span>
00464 <span class="comment">Return Value:</span>
00465 <span class="comment"></span>
00466 <span class="comment">    None.</span>
00467 <span class="comment"></span>
00468 <span class="comment">--*/</span>
00469 {
00470 
00471     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00472 
00473     *<a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> = RtlpOwnerAddrSecurityDescriptor( SecurityDescriptor );
00474 
00475     <span class="keywordflow">if</span> (*<a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00476         *OwnerSize = LongAlignSize(<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(*<a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>));
00477     } <span class="keywordflow">else</span> {
00478         *OwnerSize = 0;
00479     }
00480 
00481     *<a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> = RtlpDaclAddrSecurityDescriptor ( SecurityDescriptor );
00482 
00483     <span class="keywordflow">if</span> (*<a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> !=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00484         *DaclSize = LongAlignSize((*Dacl)-&gt;AclSize);
00485     } <span class="keywordflow">else</span> {
00486         *DaclSize = 0;
00487     }
00488 
00489     *PrimaryGroup = RtlpGroupAddrSecurityDescriptor( SecurityDescriptor );
00490 
00491     <span class="keywordflow">if</span> (*PrimaryGroup != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00492         *PrimaryGroupSize = LongAlignSize(<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(*PrimaryGroup));
00493     } <span class="keywordflow">else</span> {
00494          *PrimaryGroupSize = 0;
00495     }
00496 
00497     *Sacl = RtlpSaclAddrSecurityDescriptor( SecurityDescriptor );
00498 
00499     <span class="keywordflow">if</span> (*Sacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00500         *SaclSize = LongAlignSize((*Sacl)-&gt;AclSize);
00501     } <span class="keywordflow">else</span> {
00502         *SaclSize = 0;
00503     }
00504 
00505 }
00506 
00507 
00508 
00509 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00510"></a><a class="code" href="../../d7/d1/rtlassig_8c.html#a6">00510</a> <a class="code" href="../../d7/d1/rtlassig_8c.html#a6">RtlSelfRelativeToAbsoluteSD2</a>(
00511     IN OUT PSECURITY_DESCRIPTOR pSelfRelativeSecurityDescriptor,
00512     IN OUT PULONG               pBufferSize
00513     )
00514 
00515 <span class="comment">/*++</span>
00516 <span class="comment"></span>
00517 <span class="comment">Routine Description:</span>
00518 <span class="comment"></span>
00519 <span class="comment">    Converts a security descriptor from self-relative format to absolute</span>
00520 <span class="comment">    format using the memory allocated for the SelfRelativeSecurityDescriptor</span>
00521 <span class="comment"></span>
00522 <span class="comment">Arguments:</span>
00523 <span class="comment"></span>
00524 <span class="comment">    pSecurityDescriptor - Supplies a pointer to a security descriptor in</span>
00525 <span class="comment">        Self-Relative format. If success, we return a absolute security</span>
00526 <span class="comment">        descriptor where this pointer pointings.</span>
00527 <span class="comment"></span>
00528 <span class="comment">    pBufferSize - Supplies a pointer to the size of the</span>
00529 <span class="comment">        buffer.</span>
00530 <span class="comment"></span>
00531 <span class="comment">Return Value:</span>
00532 <span class="comment"></span>
00533 <span class="comment">    STATUS_SUCCESS - Success</span>
00534 <span class="comment"></span>
00535 <span class="comment">    STATUS_BAD_DESCRIPTOR_FORMAT - The passed descriptor is not a self-relative</span>
00536 <span class="comment">       security descriptor.</span>
00537 <span class="comment"></span>
00538 <span class="comment">    STATUS_BUFFER_TOO_SMALL - The passed buffer is too small.</span>
00539 <span class="comment"></span>
00540 <span class="comment">    STATUS_INVALID_OWNER - There was not a valid owner in the passed</span>
00541 <span class="comment">        security descriptor.</span>
00542 <span class="comment"></span>
00543 <span class="comment">Notes: Despite some attempts to make this code as portable as possible and the </span>
00544 <span class="comment">       utilization of C_ASSERT or ASSERT to detect the respect of these assumptions, </span>
00545 <span class="comment">       this code is still making several assumptions about the format of the absolute </span>
00546 <span class="comment">       and self-relative descriptors and their relationships: in terms of packing, </span>
00547 <span class="comment">       fields definitions and locations in their respective structures. </span>
00548 <span class="comment">       In particular, this code assumes that the only differences are due to differences </span>
00549 <span class="comment">       in the types of the structure members and in the behaviour of the security descriptor</span>
00550 <span class="comment">       query API.</span>
00551 <span class="comment">       At this time, the only structure members that get read/updated are Owner, Group,</span>
00552 <span class="comment">       Dacl and Sacl. If more members are added or displaced in the definitions of these</span>
00553 <span class="comment">       structures, this code may have to be modified.</span>
00554 <span class="comment"></span>
00555 <span class="comment">--*/</span>
00556 
00557 {
00558     ULONG_PTR   ptr;
00559     PSID        owner;
00560     PSID        group;
00561     PACL        dacl;
00562     PACL        sacl;
00563     ULONG       daclSize;
00564     ULONG       saclSize;
00565     ULONG       newBodySize;
00566     ULONG       ownerSize;
00567     ULONG       groupSize;
00568     ULONG       newBufferSize;
00569     LONG        deltaSize;
00570 
00571 <span class="comment">//</span>
00572 <span class="comment">// Typecast security descriptors so we don't have to cast all over the place.</span>
00573 <span class="comment">//</span>
00574 
00575     PISECURITY_DESCRIPTOR          psd  = (PISECURITY_DESCRIPTOR)         pSelfRelativeSecurityDescriptor;
00576     PISECURITY_DESCRIPTOR_RELATIVE psdr = (PISECURITY_DESCRIPTOR_RELATIVE)pSelfRelativeSecurityDescriptor;
00577 
00578 <span class="comment">//</span>
00579 <span class="comment">// This code uses several assumptions about the absolute and self-relative formats of </span>
00580 <span class="comment">// security descriptors and the way they are packing in memory. </span>
00581 <span class="comment">// See Routine Description Notes.</span>
00582 <span class="comment">//</span>
00583 
00584     <a class="code" href="../../d1/d9/worker_8c.html#a21">C_ASSERT</a>( <span class="keyword">sizeof</span>( SECURITY_DESCRIPTOR ) &gt;= <span class="keyword">sizeof</span>( SECURITY_DESCRIPTOR_RELATIVE ) ); 
00585     <a class="code" href="../../d1/d9/worker_8c.html#a21">C_ASSERT</a>( <span class="keyword">sizeof</span>( psd-&gt;Control ) == <span class="keyword">sizeof</span>( psdr-&gt;Control ) );
00586     <a class="code" href="../../d1/d9/worker_8c.html#a21">C_ASSERT</a>( FIELD_OFFSET( SECURITY_DESCRIPTOR, Control ) == FIELD_OFFSET( SECURITY_DESCRIPTOR_RELATIVE, Control ) );
00587     
00588     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00589 
00590 <span class="comment">//</span>
00591 <span class="comment">// Parameters check point</span>
00592 <span class="comment">//</span>
00593 
00594     <span class="keywordflow">if</span> ( psd == (PISECURITY_DESCRIPTOR)0 ) {
00595         <span class="keywordflow">return</span>( STATUS_INVALID_PARAMETER_1 );        
00596     }
00597     <span class="keywordflow">if</span> ( pBufferSize == (PULONG)0 )   {
00598         <span class="keywordflow">return</span>( STATUS_INVALID_PARAMETER_2 );       
00599     }
00600 
00601     <span class="comment">//</span>
00602     <span class="comment">// If the passed security descriptor is not self-relative, we return</span>
00603     <span class="comment">// an format error.</span>
00604     <span class="comment">//</span>
00605 
00606     <span class="keywordflow">if</span> ( !RtlpAreControlBitsSet( psd, SE_SELF_RELATIVE) ) {
00607         <span class="keywordflow">return</span>( STATUS_BAD_DESCRIPTOR_FORMAT );
00608     }
00609 
00610 <span class="comment">//</span>
00611 <span class="comment">// Update local variables by querying the self-relative descriptor.</span>
00612 <span class="comment">//</span>
00613 <span class="comment">// Note that the returned size values are long-aligned.</span>
00614 <span class="comment">//</span>
00615 
00616     <a class="code" href="../../d7/d1/rtlassig_8c.html#a5">RtlpQuerySecurityDescriptor</a>(
00617         psd,
00618         &amp;owner,
00619         &amp;ownerSize,
00620         &amp;group,
00621         &amp;groupSize,
00622         &amp;dacl,
00623         &amp;daclSize,
00624         &amp;sacl,
00625         &amp;saclSize
00626         );
00627 
00628 <span class="comment">//</span>
00629 <span class="comment">// Identical formats check:</span>
00630 <span class="comment">//</span>
00631 
00632     <span class="comment">//</span>
00633     <span class="comment">// Determine the delta in size between the two formats of security descriptors</span>
00634     <span class="comment">//</span>
00635 
00636     deltaSize = <span class="keyword">sizeof</span>( SECURITY_DESCRIPTOR ) - <span class="keyword">sizeof</span>( SECURITY_DESCRIPTOR_RELATIVE ); 
00637 
00638     <span class="comment">//</span>
00639     <span class="comment">// If identical format: </span>
00640     <span class="comment">//      - clear the SELF_RELATIVE flag</span>
00641     <span class="comment">//      - update absolute descriptor members</span>
00642     <span class="comment">//      - return SUCCESS.</span>
00643     <span class="comment">//</span>
00644 
00645     <span class="keywordflow">if</span> ( deltaSize == 0 )   {
00646        
00647         RtlpClearControlBits( psd, SE_SELF_RELATIVE );
00648 
00649         <span class="comment">//</span>
00650         <span class="comment">// Only the following fields are updated.</span>
00651         <span class="comment">//</span>
00652 
00653         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <span class="keyword">sizeof</span>( psd-&gt;Owner ) == <span class="keyword">sizeof</span>( psdr-&gt;Owner ) );
00654         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <span class="keyword">sizeof</span>( psd-&gt;Group ) == <span class="keyword">sizeof</span>( psdr-&gt;Group ) );
00655         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <span class="keyword">sizeof</span>( psd-&gt;Sacl  ) == <span class="keyword">sizeof</span>( psdr-&gt;Sacl  ) );
00656         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <span class="keyword">sizeof</span>( psd-&gt;Dacl  ) == <span class="keyword">sizeof</span>( psdr-&gt;Dacl  ) );
00657 
00658         psd-&gt;Owner = owner;
00659         psd-&gt;Group = group;
00660         psd-&gt;Sacl  = sacl;
00661         psd-&gt;Dacl  = dacl;
00662     
00663         <span class="keywordflow">return</span>( STATUS_SUCCESS );
00664 
00665     }
00666 
00667 <span class="comment">//</span>
00668 <span class="comment">// Determine the required size for the absolute format:</span>
00669 <span class="comment">//</span>
00670 
00671 <span class="preprocessor">#define ULONG_PTR_SDEND( _Adr ) ( (ULONG_PTR)(_Adr) + (ULONG_PTR)(_Adr##Size) )</span>
00672 <span class="preprocessor"></span>
00673     ptr = owner &gt; group ? <a class="code" href="../../d7/d1/rtlassig_8c.html#a0">ULONG_PTR_SDEND</a>( owner ) : <a class="code" href="../../d7/d1/rtlassig_8c.html#a0">ULONG_PTR_SDEND</a>( group );
00674     ptr = ptr &gt; (ULONG_PTR)dacl ? ptr : <a class="code" href="../../d7/d1/rtlassig_8c.html#a0">ULONG_PTR_SDEND</a>( dacl );
00675     ptr = ptr &gt; (ULONG_PTR)sacl ? ptr : <a class="code" href="../../d7/d1/rtlassig_8c.html#a0">ULONG_PTR_SDEND</a>( sacl );
00676    
00677     newBufferSize = <span class="keyword">sizeof</span>( SECURITY_DESCRIPTOR );
00678     <span class="keywordflow">if</span> ( ptr )   {
00679 
00680 <span class="preprocessor">#define ULONG_ROUND_UP( x, y )   ((ULONG)(x) + ((y)-1) &amp; ~((y)-1))</span>
00681 <span class="preprocessor"></span>
00682         newBufferSize += <a class="code" href="../../d7/d1/rtlassig_8c.html#a1">ULONG_ROUND_UP</a>( (ULONG_PTR)ptr - (ULONG_PTR)(psdr + 1), <span class="keyword">sizeof</span>(PVOID) );
00683     }
00684 
00685     <span class="comment">//</span>
00686     <span class="comment">// If the specified buffer size is not big enough, let the caller know abour </span>
00687     <span class="comment">// the minimum size and return STATUS_BUFFER_TOO_SMALL.</span>
00688     <span class="comment">//</span>
00689 
00690     <span class="keywordflow">if</span> ( newBufferSize &gt; *pBufferSize )  {
00691         *pBufferSize = newBufferSize;
00692         <span class="keywordflow">return</span>( STATUS_BUFFER_TOO_SMALL );
00693     }
00694 
00695 <span class="comment">//</span>
00696 <span class="comment">// Update absolute security descriptor:</span>
00697 <span class="comment">//</span>
00698 
00699     <span class="comment">//</span>
00700     <span class="comment">// Move the members of self-relative security descriptor in their </span>
00701     <span class="comment">// absolute format locations.</span>
00702     <span class="comment">//</span>
00703 
00704     <span class="keywordflow">if</span> ( ptr )   {
00705        RtlMoveMemory( (PVOID)(psd + 1), (PVOID)(psdr + 1), newBufferSize - <span class="keyword">sizeof</span>( SECURITY_DESCRIPTOR) );      
00706     }
00707 
00708     <span class="comment">//</span>
00709     <span class="comment">// Clear the self-relative flag</span>
00710     <span class="comment">//</span>
00711 
00712     RtlpClearControlBits( psd, SE_SELF_RELATIVE );
00713 
00714     <span class="comment">//</span>
00715     <span class="comment">// Only the following fields are updated.</span>
00716     <span class="comment">//</span>
00717 
00718     psd-&gt;Owner = (PSID)( owner ? (ULONG_PTR)owner + deltaSize : 0 );
00719     psd-&gt;Group = (PSID)( group ? (ULONG_PTR)group + deltaSize : 0 );
00720     psd-&gt;Sacl  = (PACL)( sacl  ? (ULONG_PTR)sacl  + deltaSize : 0 );
00721     psd-&gt;Dacl  = (PACL)( dacl  ? (ULONG_PTR)dacl  + deltaSize : 0 );
00722     
00723     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00724 
00725 } <span class="comment">// RtlSelfRelativeToAbsoluteSD2()</span>
00726 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:40 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
