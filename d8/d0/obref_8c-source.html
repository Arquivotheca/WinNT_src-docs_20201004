<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: obref.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>obref.c</h1><a href="../../d7/d1/obref_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    obref.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    Object open API</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Steve Wood (stevewo) 31-Mar-1989</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d5/d1/obp_8h.html">obp.h</a>"</span>
00022 
00023 <span class="comment">//</span>
00024 <span class="comment">//  A local variable to tell us if the worker queue is active</span>
00025 <span class="comment">//</span>
00026 
<a name="l00027"></a><a class="code" href="../../d7/d1/obref_8c.html#a0">00027</a> BOOLEAN <a class="code" href="../../d7/d1/obref_8c.html#a0">ObpRemoveQueueActive</a>;
00028 
00029 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObGetObjectPointerCount)</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObOpenObjectByName)</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObOpenObjectByPointer)</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObReferenceObjectByName)</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObpRemoveObjectRoutine)</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObpDeleteNameCheck)</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00037 <span class="preprocessor"></span>
00038 
00039 <span class="preprocessor">#ifndef LpcpAcquireLpcpLock</span>
00040 <span class="preprocessor"></span>
00041 <span class="comment">//</span>
00042 <span class="comment">//  ********************  WARNING  ************************</span>
00043 <span class="comment">//</span>
00044 <span class="comment">//  The following include is neccessary in order to hold the LPC lock</span>
00045 <span class="comment">//  while setting the  port flag to PORT_DELETED.</span>
00046 <span class="comment">//  A cleanest solution could be a callback on DereferenceObject.</span>
00047 <span class="comment">//  In that case we'll define the callback for the LPC to do all these things.</span>
00048 <span class="comment">//</span>
00049 
00050 <span class="preprocessor">#include "..\lpc\lpcp.h"</span>
00051 
00052 <span class="preprocessor">#endif //#ifndef LpcpAcquireLpcpLock</span>
00053 <span class="preprocessor"></span>
00054 
00055 
00056 
00057 ULONG
<a name="l00058"></a><a class="code" href="../../d7/d1/obref_8c.html#a1">00058</a> <a class="code" href="../../d7/d1/obref_8c.html#a1">ObGetObjectPointerCount</a> (
00059     IN PVOID Object
00060     )
00061 
00062 <span class="comment">/*++</span>
00063 <span class="comment"></span>
00064 <span class="comment">Routine Description:</span>
00065 <span class="comment"></span>
00066 <span class="comment">    This routine returns the current pointer count for a specified object.</span>
00067 <span class="comment"></span>
00068 <span class="comment">Arguments:</span>
00069 <span class="comment"></span>
00070 <span class="comment">    Object - Pointer to the object whose pointer count is to be returned.</span>
00071 <span class="comment"></span>
00072 <span class="comment">Return Value:</span>
00073 <span class="comment"></span>
00074 <span class="comment">    The current pointer count for the specified object is returned.</span>
00075 <span class="comment"></span>
00076 <span class="comment">Note:</span>
00077 <span class="comment"></span>
00078 <span class="comment">    This function cannot be made a macro, since fields in the thread object</span>
00079 <span class="comment">    move from release to release, so this must remain a full function.</span>
00080 <span class="comment"></span>
00081 <span class="comment">--*/</span>
00082 
00083 {
00084     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00085 
00086     <span class="comment">//</span>
00087     <span class="comment">//  Simply return the current pointer count for the object.</span>
00088     <span class="comment">//</span>
00089 
00090     <span class="keywordflow">return</span> <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object )-&gt;PointerCount;
00091 }
00092 
00093 
00094 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00095"></a><a class="code" href="../../d7/d1/obref_8c.html#a2">00095</a> <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a> (
00096     IN POBJECT_ATTRIBUTES ObjectAttributes,
00097     IN <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType OPTIONAL,
00098     IN KPROCESSOR_MODE AccessMode,
00099     IN OUT <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState OPTIONAL,
00100     IN ACCESS_MASK DesiredAccess OPTIONAL,
00101     IN OUT PVOID ParseContext OPTIONAL,
00102     OUT PHANDLE Handle
00103     )
00104 
00105 <span class="comment">/*++</span>
00106 <span class="comment"></span>
00107 <span class="comment">Routine Description:</span>
00108 <span class="comment"></span>
00109 <span class="comment"></span>
00110 <span class="comment">    This function opens an object with full access validation and auditing.</span>
00111 <span class="comment">    Soon after entering we capture the SubjectContext for the caller. This</span>
00112 <span class="comment">    context must remain captured until auditing is complete, and passed to</span>
00113 <span class="comment">    any routine that may have to do access checking or auditing.</span>
00114 <span class="comment"></span>
00115 <span class="comment">Arguments:</span>
00116 <span class="comment"></span>
00117 <span class="comment">    ObjectAttributes - Supplies a pointer to the object attributes.</span>
00118 <span class="comment"></span>
00119 <span class="comment">    ObjectType - Supplies an optional pointer to the object type descriptor.</span>
00120 <span class="comment"></span>
00121 <span class="comment">    AccessMode - Supplies the processor mode of the access.</span>
00122 <span class="comment"></span>
00123 <span class="comment">    AccessState - Supplies an optional pointer to the current access status</span>
00124 <span class="comment">        describing already granted access types, the privileges used to get</span>
00125 <span class="comment">        them, and any access types yet to be granted.</span>
00126 <span class="comment"></span>
00127 <span class="comment">    DesiredAcess - Supplies the desired access to the object.</span>
00128 <span class="comment"></span>
00129 <span class="comment">    ParseContext - Supplies an optional pointer to parse context.</span>
00130 <span class="comment"></span>
00131 <span class="comment">    Handle - Supplies a pointer to a variable that receives the handle value.</span>
00132 <span class="comment"></span>
00133 <span class="comment">Return Value:</span>
00134 <span class="comment"></span>
00135 <span class="comment">    If the object is successfully opened, then a handle for the object is</span>
00136 <span class="comment">    created and a success status is returned. Otherwise, an error status is</span>
00137 <span class="comment">    returned.</span>
00138 <span class="comment"></span>
00139 <span class="comment">--*/</span>
00140 
00141 {
00142     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00143     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> HandleStatus;
00144     PVOID ExistingObject;
00145     HANDLE NewHandle;
00146     BOOLEAN DirectoryLocked;
00147     <a class="code" href="../../d4/d0/ob_8h.html#a21">OB_OPEN_REASON</a> OpenReason;
00148     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00149     <a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html">OBJECT_CREATE_INFORMATION</a> ObjectCreateInfo;
00150     UNICODE_STRING CapturedObjectName;
00151     <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">ACCESS_STATE</a> LocalAccessState;
00152     <a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html">AUX_ACCESS_DATA</a> AuxData;
00153     PGENERIC_MAPPING GenericMapping;
00154 
00155     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00156 
00157     <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>(<span class="stringliteral">"ObOpenObjectByName"</span>);
00158 
00159     <span class="comment">//</span>
00160     <span class="comment">//  If the object attributes are not specified, then return an error.</span>
00161     <span class="comment">//</span>
00162 
00163     *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00164 
00165     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>)) {
00166 
00167         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00168 
00169     } <span class="keywordflow">else</span> {
00170 
00171         <span class="comment">//</span>
00172         <span class="comment">//  Capture the object creation information.</span>
00173         <span class="comment">//</span>
00174 
00175         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/obp_8h.html#a58">ObpCaptureObjectCreateInformation</a>( ObjectType,
00176                                                     AccessMode,
00177                                                     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00178                                                     &amp;CapturedObjectName,
00179                                                     &amp;ObjectCreateInfo,
00180                                                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00181 
00182         <span class="comment">//</span>
00183         <span class="comment">//  If the object creation information is successfully captured,</span>
00184         <span class="comment">//  then generate the access state.</span>
00185         <span class="comment">//</span>
00186 
00187         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00188 
00189             <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(AccessState)) {
00190 
00191                 <span class="comment">//</span>
00192                 <span class="comment">//  If an object type descriptor is specified, then use</span>
00193                 <span class="comment">//  associated generic mapping. Otherwise, use no generic</span>
00194                 <span class="comment">//  mapping.</span>
00195                 <span class="comment">//</span>
00196 
00197                 GenericMapping = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00198 
00199                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ObjectType)) {
00200 
00201                     GenericMapping = &amp;ObjectType-&gt;TypeInfo.GenericMapping;
00202                 }
00203 
00204                 AccessState = &amp;LocalAccessState;
00205 
00206                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/seastate_8c.html#a2">SeCreateAccessState</a>( &amp;LocalAccessState,
00207                                               &amp;AuxData,
00208                                               DesiredAccess,
00209                                               GenericMapping );
00210 
00211                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00212 
00213                     <span class="keywordflow">goto</span> FreeCreateInfo;
00214                 }
00215             }
00216 
00217             <span class="comment">//</span>
00218             <span class="comment">//  If there is a security descriptor specified in the object</span>
00219             <span class="comment">//  attributes, then capture it in the access state.</span>
00220             <span class="comment">//</span>
00221 
00222             <span class="keywordflow">if</span> (ObjectCreateInfo.<a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html#o7">SecurityDescriptor</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00223 
00224                 AccessState-&gt;SecurityDescriptor = ObjectCreateInfo.<a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html#o7">SecurityDescriptor</a>;
00225             }
00226 
00227             <span class="comment">//</span>
00228             <span class="comment">//  Validate the access state.</span>
00229             <span class="comment">//</span>
00230 
00231             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/obse_8c.html#a14">ObpValidateAccessMask</a>(AccessState);
00232 
00233             <span class="comment">//</span>
00234             <span class="comment">//  If the access state is valid, then lookup the object by</span>
00235             <span class="comment">//  name.</span>
00236             <span class="comment">//</span>
00237 
00238             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00239 
00240                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/obp_8h.html#a71">ObpLookupObjectName</a>( ObjectCreateInfo.<a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html#o1">RootDirectory</a>,
00241                                               &amp;CapturedObjectName,
00242                                               ObjectCreateInfo.<a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html#o0">Attributes</a>,
00243                                               ObjectType,
00244                                               AccessMode,
00245                                               ParseContext,
00246                                               ObjectCreateInfo.<a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html#o8">SecurityQos</a>,
00247                                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00248                                               AccessState,
00249                                               &amp;DirectoryLocked,
00250                                               &amp;ExistingObject );
00251 
00252                 <span class="comment">//</span>
00253                 <span class="comment">//  If the object was successfully looked up, then attempt</span>
00254                 <span class="comment">//  to create or open a handle.</span>
00255                 <span class="comment">//</span>
00256 
00257                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00258 
00259                     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(ExistingObject);
00260 
00261                     <span class="comment">//</span>
00262                     <span class="comment">//  If the object is being created, then the operation</span>
00263                     <span class="comment">//  must be a open-if operation. Otherwise, a handle to</span>
00264                     <span class="comment">//  an object is being opened.</span>
00265                     <span class="comment">//</span>
00266 
00267                     <span class="keywordflow">if</span> (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a1">OB_FLAG_NEW_OBJECT</a>) {
00268 
00269                         OpenReason = <a class="code" href="../../d4/d0/ob_8h.html#a100a58">ObCreateHandle</a>;
00270 
00271                         <span class="keywordflow">if</span> (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o8">ObjectCreateInfo</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00272 
00273                             <a class="code" href="../../d5/d1/obp_8h.html#a29">ObpFreeObjectCreateInformation</a>(ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o8">ObjectCreateInfo</a>);
00274                             ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o8">ObjectCreateInfo</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00275                         }
00276 
00277                     } <span class="keywordflow">else</span> {
00278 
00279                         OpenReason = <a class="code" href="../../d4/d0/ob_8h.html#a100a59">ObOpenHandle</a>;
00280                     }
00281 
00282                     <span class="comment">//</span>
00283                     <span class="comment">//  If any of the object attributes are invalid, then</span>
00284                     <span class="comment">//  return an error status.</span>
00285                     <span class="comment">//</span>
00286 
00287                     <span class="keywordflow">if</span> (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o3">InvalidAttributes</a> &amp; ObjectCreateInfo.<a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html#o0">Attributes</a>) {
00288 
00289                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00290 
00291                         <span class="keywordflow">if</span> (DirectoryLocked) {
00292 
00293                             <a class="code" href="../../d5/d1/obp_8h.html#a11">ObpLeaveRootDirectoryMutex</a>();
00294                         }
00295 
00296                     } <span class="keywordflow">else</span> {
00297 
00298                         <span class="comment">//</span>
00299                         <span class="comment">//  The status returned by the object lookup routine</span>
00300                         <span class="comment">//  must be returned if the creation of a handle is</span>
00301                         <span class="comment">//  successful. Otherwise, the handle creation status</span>
00302                         <span class="comment">//  is returned.</span>
00303                         <span class="comment">//</span>
00304 
00305                         HandleStatus = <a class="code" href="../../d5/d1/obp_8h.html#a79">ObpCreateHandle</a>( OpenReason,
00306                                                         ExistingObject,
00307                                                         ObjectType,
00308                                                         AccessState,
00309                                                         0,
00310                                                         ObjectCreateInfo.<a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html#o0">Attributes</a>,
00311                                                         DirectoryLocked,
00312                                                         AccessMode,
00313                                                         (PVOID *)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00314                                                         &amp;NewHandle );
00315 
00316                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(HandleStatus)) {
00317 
00318                             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(ExistingObject);
00319 
00320                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = HandleStatus;
00321 
00322                         } <span class="keywordflow">else</span> {
00323 
00324                             *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = NewHandle;
00325                         }
00326                     }
00327 
00328                 } <span class="keywordflow">else</span> {
00329 
00330                     <span class="keywordflow">if</span> (DirectoryLocked) {
00331 
00332                         <a class="code" href="../../d5/d1/obp_8h.html#a11">ObpLeaveRootDirectoryMutex</a>();
00333                     }
00334                 }
00335             }
00336 
00337             <span class="comment">//</span>
00338             <span class="comment">//  If the access state was generated, then delete the access</span>
00339             <span class="comment">//  state.</span>
00340             <span class="comment">//</span>
00341 
00342             <span class="keywordflow">if</span> (AccessState == &amp;LocalAccessState) {
00343 
00344                 <a class="code" href="../../d2/d5/seastate_8c.html#a3">SeDeleteAccessState</a>(AccessState);
00345             }
00346 
00347             <span class="comment">//</span>
00348             <span class="comment">//  Free the create information.</span>
00349             <span class="comment">//</span>
00350 
00351         FreeCreateInfo:
00352 
00353             <a class="code" href="../../d5/d1/obp_8h.html#a30">ObpReleaseObjectCreateInformation</a>(&amp;ObjectCreateInfo);
00354 
00355             <span class="keywordflow">if</span> (CapturedObjectName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00356 
00357                 <a class="code" href="../../d5/d1/obp_8h.html#a61">ObpFreeObjectNameBuffer</a>(&amp;CapturedObjectName);
00358             }
00359         }
00360     }
00361 
00362     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00363 }
00364 
00365 
00366 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00367"></a><a class="code" href="../../d7/d1/obref_8c.html#a3">00367</a> <a class="code" href="../../d7/d1/obref_8c.html#a3">ObOpenObjectByPointer</a> (
00368     IN PVOID Object,
00369     IN ULONG HandleAttributes,
00370     IN <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> PassedAccessState OPTIONAL,
00371     IN ACCESS_MASK DesiredAccess,
00372     IN <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType,
00373     IN KPROCESSOR_MODE AccessMode,
00374     OUT PHANDLE Handle
00375     )
00376 
00377 <span class="comment">/*++</span>
00378 <span class="comment"></span>
00379 <span class="comment">Routine Description:</span>
00380 <span class="comment"></span>
00381 <span class="comment">    This routine opens an object referenced by a pointer.</span>
00382 <span class="comment"></span>
00383 <span class="comment">Arguments:</span>
00384 <span class="comment"></span>
00385 <span class="comment">    Object - A pointer to the object being opened.</span>
00386 <span class="comment"></span>
00387 <span class="comment">    HandleAttributes - The desired attributes for the handle, such</span>
00388 <span class="comment">        as OBJ_INHERIT, OBJ_PERMANENT, OBJ_EXCLUSIVE, OBJ_CASE_INSENSITIVE,</span>
00389 <span class="comment">        OBJ_OPENIF, and OBJ_OPENLINK</span>
00390 <span class="comment"></span>
00391 <span class="comment">    PassedAccessState - Supplies an optional pointer to the current access</span>
00392 <span class="comment">        status describing already granted access types, the privileges used</span>
00393 <span class="comment">        to get them, and any access types yet to be granted.</span>
00394 <span class="comment"></span>
00395 <span class="comment">    DesiredAcess - Supplies the desired access to the object.</span>
00396 <span class="comment"></span>
00397 <span class="comment">    ObjectType - Supplies the type of the object being opened</span>
00398 <span class="comment"></span>
00399 <span class="comment">    AccessMode - Supplies the processor mode of the access.</span>
00400 <span class="comment"></span>
00401 <span class="comment">    Handle - Supplies a pointer to a variable that receives the handle value.</span>
00402 <span class="comment"></span>
00403 <span class="comment">Return Value:</span>
00404 <span class="comment"></span>
00405 <span class="comment">    An appropriate NTSTATUS value</span>
00406 <span class="comment"></span>
00407 <span class="comment">--*/</span>
00408 
00409 {
00410     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00411     HANDLE NewHandle;
00412     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00413     <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">ACCESS_STATE</a> LocalAccessState;
00414     <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00415     <a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html">AUX_ACCESS_DATA</a> AuxData;
00416 
00417     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00418 
00419     <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>( <span class="stringliteral">"ObOpenObjectByPointer"</span> );
00420 
00421     <span class="comment">//</span>
00422     <span class="comment">//  First increment the pointer count for the object.  This routine</span>
00423     <span class="comment">//  also checks the object types</span>
00424     <span class="comment">//</span>
00425 
00426     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a6">ObReferenceObjectByPointer</a>( Object,
00427                                          0,
00428                                          ObjectType,
00429                                          AccessMode );
00430 
00431     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00432 
00433         <span class="comment">//</span>
00434         <span class="comment">//  Get the object header for the input object body</span>
00435         <span class="comment">//</span>
00436 
00437         ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
00438 
00439         <span class="comment">//</span>
00440         <span class="comment">//  If the caller did not pass in an access state then</span>
00441         <span class="comment">//  we will create a new one based on the desired access</span>
00442         <span class="comment">//  and the object types generic mapping</span>
00443         <span class="comment">//</span>
00444 
00445         <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( PassedAccessState )) {
00446 
00447             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/seastate_8c.html#a2">SeCreateAccessState</a>( &amp;LocalAccessState,
00448                                           &amp;AuxData,
00449                                           DesiredAccess,
00450                                           &amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> );
00451 
00452             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00453 
00454                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Object );
00455 
00456                 <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00457             }
00458 
00459             AccessState = &amp;LocalAccessState;
00460 
00461         <span class="comment">//</span>
00462         <span class="comment">//  Otherwise the caller did specify an access state so</span>
00463         <span class="comment">//  we use the one passed in.</span>
00464         <span class="comment">//</span>
00465 
00466         } <span class="keywordflow">else</span> {
00467 
00468             AccessState = PassedAccessState;
00469         }
00470 
00471         <span class="comment">//</span>
00472         <span class="comment">//  Make sure the caller is asking for handle attributes that are</span>
00473         <span class="comment">//  valid for the given object type</span>
00474         <span class="comment">//</span>
00475 
00476         <span class="keywordflow">if</span> (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o3">InvalidAttributes</a> &amp; HandleAttributes) {
00477 
00478             <span class="keywordflow">if</span> (AccessState == &amp;LocalAccessState) {
00479 
00480                 <a class="code" href="../../d2/d5/seastate_8c.html#a3">SeDeleteAccessState</a>( AccessState );
00481             }
00482 
00483             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Object );
00484 
00485             <span class="keywordflow">return</span>( STATUS_INVALID_PARAMETER );
00486         }
00487 
00488         <span class="comment">//</span>
00489         <span class="comment">//  We've referenced the object and have an access state to give</span>
00490         <span class="comment">//  the new handle so now create a new handle for the object.</span>
00491         <span class="comment">//</span>
00492 
00493         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/obp_8h.html#a79">ObpCreateHandle</a>( <a class="code" href="../../d4/d0/ob_8h.html#a100a59">ObOpenHandle</a>,
00494                                   Object,
00495                                   ObjectType,
00496                                   AccessState,
00497                                   0,
00498                                   HandleAttributes,
00499                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00500                                   AccessMode,
00501                                   (PVOID *)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00502                                   &amp;NewHandle );
00503 
00504         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00505 
00506             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Object );
00507         }
00508     }
00509 
00510     <span class="comment">//</span>
00511     <span class="comment">//  If we successfully opened by object and created a new handle</span>
00512     <span class="comment">//  then set the output variable correctly</span>
00513     <span class="comment">//</span>
00514 
00515     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00516 
00517         *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = NewHandle;
00518 
00519     } <span class="keywordflow">else</span> {
00520 
00521         *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00522     }
00523 
00524     <span class="comment">//</span>
00525     <span class="comment">//  Check if we used our own access state and now need to cleanup</span>
00526     <span class="comment">//</span>
00527 
00528     <span class="keywordflow">if</span> (AccessState == &amp;LocalAccessState) {
00529 
00530         <a class="code" href="../../d2/d5/seastate_8c.html#a3">SeDeleteAccessState</a>( AccessState );
00531     }
00532 
00533     <span class="comment">//</span>
00534     <span class="comment">//  And return to our caller</span>
00535     <span class="comment">//</span>
00536 
00537     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00538 }
00539 
00540 
00541 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00542"></a><a class="code" href="../../d7/d1/obref_8c.html#a4">00542</a> <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> (
00543     IN HANDLE Handle,
00544     IN ACCESS_MASK DesiredAccess,
00545     IN <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType OPTIONAL,
00546     IN KPROCESSOR_MODE AccessMode,
00547     OUT PVOID *Object,
00548     OUT <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">POBJECT_HANDLE_INFORMATION</a> HandleInformation OPTIONAL
00549     )
00550 
00551 <span class="comment">/*++</span>
00552 <span class="comment"></span>
00553 <span class="comment">Routine Description:</span>
00554 <span class="comment"></span>
00555 <span class="comment">    Given a handle to an object this routine returns a pointer</span>
00556 <span class="comment">    to the body of the object with proper ref counts</span>
00557 <span class="comment"></span>
00558 <span class="comment">Arguments:</span>
00559 <span class="comment"></span>
00560 <span class="comment">    Handle - Supplies a handle to the object being referenced.  It can</span>
00561 <span class="comment">        also be the result of NtCurrentProcess or NtCurrentThread</span>
00562 <span class="comment"></span>
00563 <span class="comment">    DesiredAccess - Supplies the access being requested by the caller</span>
00564 <span class="comment"></span>
00565 <span class="comment">    ObjectType - Optionally supplies the type of the object we</span>
00566 <span class="comment">        are expecting</span>
00567 <span class="comment"></span>
00568 <span class="comment">    AccessMode - Supplies the processor mode of the access</span>
00569 <span class="comment"></span>
00570 <span class="comment">    Object - Receives a pointer to the object body if the operation</span>
00571 <span class="comment">        is successful</span>
00572 <span class="comment"></span>
00573 <span class="comment">    HandleInformation - Optionally receives information regarding the</span>
00574 <span class="comment">        input handle.</span>
00575 <span class="comment"></span>
00576 <span class="comment">Return Value:</span>
00577 <span class="comment"></span>
00578 <span class="comment">    An appropriate NTSTATUS value</span>
00579 <span class="comment"></span>
00580 <span class="comment">--*/</span>
00581 
00582 {
00583     ACCESS_MASK GrantedAccess;
00584     <a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> HandleTable;
00585     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00586     <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> ObjectTableEntry;
00587     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00588     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00589     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00590     BOOLEAN AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00591 
00592     <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>(<span class="stringliteral">"ObReferenceObjectByHandle"</span>);
00593 
00594     <span class="comment">//</span>
00595     <span class="comment">//  Protect ourselves from being interrupted while we hold a handle table</span>
00596     <span class="comment">//  entry lock</span>
00597     <span class="comment">//</span>
00598 
00599     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00600 
00601     <span class="keywordflow">try</span> {
00602 
00603         <span class="comment">//</span>
00604         <span class="comment">//  If the handle is equal to the current process handle and the object</span>
00605         <span class="comment">//  type is NULL or type process, then attempt to translate a handle to</span>
00606         <span class="comment">//  the current process. Otherwise, check if the handle is the current</span>
00607         <span class="comment">//  thread handle.</span>
00608         <span class="comment">//</span>
00609 
00610         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> == NtCurrentProcess()) {
00611 
00612             <span class="keywordflow">if</span> ((ObjectType == <a class="code" href="../../d9/d8/ntos_8h.html#a2">PsProcessType</a>) || (ObjectType == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00613 
00614                 Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00615                 GrantedAccess = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o54">GrantedAccess</a>;
00616 
00617                 <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d5/se_8h.html#a8">SeComputeDeniedAccesses</a>(GrantedAccess, DesiredAccess) == 0) ||
00618                     (AccessMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>)) {
00619 
00620                     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(Process);
00621 
00622                     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(HandleInformation)) {
00623 
00624                         HandleInformation-&gt;GrantedAccess = GrantedAccess;
00625                         HandleInformation-&gt;HandleAttributes = 0;
00626                     }
00627 
00628                     <a class="code" href="../../d5/d1/obp_8h.html#a3">ObpIncrPointerCount</a>(ObjectHeader);
00629                     *Object = Process;
00630 
00631                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( *Object != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00632 
00633                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00634                     leave;
00635 
00636                 } <span class="keywordflow">else</span> {
00637 
00638                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
00639                 }
00640 
00641             } <span class="keywordflow">else</span> {
00642 
00643                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_TYPE_MISMATCH;
00644             }
00645 
00646         <span class="comment">//</span>
00647         <span class="comment">//  If the handle is equal to the current thread handle and the object</span>
00648         <span class="comment">//  type is NULL or type thread, then attempt to translate a handle to</span>
00649         <span class="comment">//  the current thread. Otherwise, the we'll try and translate the</span>
00650         <span class="comment">//  handle</span>
00651         <span class="comment">//</span>
00652 
00653         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> == NtCurrentThread()) {
00654 
00655             <span class="keywordflow">if</span> ((ObjectType == <a class="code" href="../../d9/d8/ntos_8h.html#a3">PsThreadType</a>) || (ObjectType == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00656 
00657                 Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00658                 GrantedAccess = Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o27">GrantedAccess</a>;
00659 
00660                 <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d5/se_8h.html#a8">SeComputeDeniedAccesses</a>(GrantedAccess, DesiredAccess) == 0) ||
00661                     (AccessMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>)) {
00662 
00663                     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(Thread);
00664 
00665                     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(HandleInformation)) {
00666 
00667                         HandleInformation-&gt;GrantedAccess = GrantedAccess;
00668                         HandleInformation-&gt;HandleAttributes = 0;
00669                     }
00670 
00671                     <a class="code" href="../../d5/d1/obp_8h.html#a3">ObpIncrPointerCount</a>(ObjectHeader);
00672                     *Object = Thread;
00673 
00674                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( *Object != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00675 
00676                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00677                     leave;
00678 
00679                 } <span class="keywordflow">else</span> {
00680 
00681                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
00682                 }
00683 
00684             } <span class="keywordflow">else</span> {
00685 
00686                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_TYPE_MISMATCH;
00687             }
00688 
00689         <span class="comment">//</span>
00690         <span class="comment">//  Otherwise the handle is not a built in value.  It must be an index</span>
00691         <span class="comment">//  into a handle table.</span>
00692         <span class="comment">//</span>
00693 
00694         } <span class="keywordflow">else</span> {
00695 
00696 <span class="preprocessor">    #if DBG</span>
00697 <span class="preprocessor"></span>            <span class="comment">//</span>
00698             <span class="comment">//  On checked builds, check that if the Kernel handle bit is set,</span>
00699             <span class="comment">//  then we're coming from Kernel mode. We should probably fail the</span>
00700             <span class="comment">//  call if bit set &amp;&amp; !Kmode</span>
00701             <span class="comment">//</span>
00702             <span class="comment">//  We know we're NOT a builtin handle at this point</span>
00703             <span class="comment">//</span>
00704 
00705             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> &lt; 0) ? (AccessMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) : <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00706 <span class="preprocessor">    #endif</span>
00707 <span class="preprocessor"></span>
00708             <span class="comment">//</span>
00709             <span class="comment">//  First get a pointer to either the processes handle table or the</span>
00710             <span class="comment">//  global kernel handle table.  If it is the kernel handle then we</span>
00711             <span class="comment">//  need to clear the handle bit and attach to the system process</span>
00712             <span class="comment">//</span>
00713 
00714             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ioverifier_8c.html#a14">IsKernelHandle</a>( <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>, AccessMode )) {
00715 
00716                 <span class="comment">//</span>
00717                 <span class="comment">//  Make the handle look like a regular handle</span>
00718                 <span class="comment">//</span>
00719 
00720                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = <a class="code" href="../../d5/d1/obp_8h.html#a27">DecodeKernelHandle</a>( <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> );
00721 
00722                 <span class="comment">//</span>
00723                 <span class="comment">//  The global kernel handle table</span>
00724                 <span class="comment">//</span>
00725 
00726                 HandleTable = <a class="code" href="../../d5/d1/obp_8h.html#a54">ObpKernelHandleTable</a>;
00727 
00728             } <span class="keywordflow">else</span> {
00729 
00730                 HandleTable = <a class="code" href="../../d5/d1/obp_8h.html#a12">ObpGetObjectTable</a>();
00731             }
00732 
00733             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(HandleTable != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00734 
00735             <span class="comment">//</span>
00736             <span class="comment">//  Translate the specified handle to an object table index.</span>
00737             <span class="comment">//</span>
00738 
00739             ObjectTableEntry = <a class="code" href="../../d5/d8/ex_8h.html#a299">ExMapHandleToPointer</a>( HandleTable, <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> );
00740 
00741             <span class="comment">//</span>
00742             <span class="comment">//  Make sure the object table entry really does exist</span>
00743             <span class="comment">//</span>
00744 
00745             <span class="keywordflow">if</span> (ObjectTableEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00746 
00747                 ObjectHeader = (<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a>)(((ULONG_PTR)(ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a>)) &amp; ~<a class="code" href="../../d5/d1/obp_8h.html#a17">OBJ_HANDLE_ATTRIBUTES</a>);
00748 
00749                 <span class="keywordflow">if</span> ((ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a> == ObjectType) || (ObjectType == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00750 
00751 <span class="preprocessor">    #if i386 &amp;&amp; !FPO</span>
00752 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_KERNEL_STACK_TRACE_DB) {
00753 
00754                         <span class="keywordflow">if</span> ((AccessMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) || ARGUMENT_PRESENT(HandleInformation)) {
00755 
00756                             GrantedAccess = ObpTranslateGrantedAccessIndex( ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o3">GrantedAccessIndex</a> );
00757                         }
00758 
00759                     } <span class="keywordflow">else</span> {
00760 
00761                         GrantedAccess = ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a>;
00762                     }
00763 <span class="preprocessor">    #else</span>
00764 <span class="preprocessor"></span>                    GrantedAccess = ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a>;
00765 
00766 <span class="preprocessor">    #endif // i386 &amp;&amp; !FPO</span>
00767 <span class="preprocessor"></span>
00768                     <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d5/se_8h.html#a8">SeComputeDeniedAccesses</a>(GrantedAccess, DesiredAccess) == 0) ||
00769                         (AccessMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>)) {
00770 
00771                         <span class="comment">//</span>
00772                         <span class="comment">//  Access to the object is allowed. Return the handle</span>
00773                         <span class="comment">//  information is requested, increment the object</span>
00774                         <span class="comment">//  pointer count, unlock the handle table and return</span>
00775                         <span class="comment">//  a success status.</span>
00776                         <span class="comment">//</span>
00777                         <span class="comment">//  Note that this is the only successful return path</span>
00778                         <span class="comment">//  out of this routine if the user did not specify</span>
00779                         <span class="comment">//  the current process or current thread in the input</span>
00780                         <span class="comment">//  handle.</span>
00781                         <span class="comment">//</span>
00782 
00783                         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(HandleInformation)) {
00784 
00785                             HandleInformation-&gt;GrantedAccess = GrantedAccess;
00786                             HandleInformation-&gt;HandleAttributes = ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o1">ObAttributes</a> &amp; <a class="code" href="../../d5/d1/obp_8h.html#a17">OBJ_HANDLE_ATTRIBUTES</a>;
00787                         }
00788 
00789                         <a class="code" href="../../d5/d1/obp_8h.html#a3">ObpIncrPointerCount</a>(ObjectHeader);
00790                         *Object = &amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o11">Body</a>;
00791 
00792                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( *Object != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00793 
00794                         <a class="code" href="../../d5/d8/ex_8h.html#a288">ExUnlockHandleTableEntry</a>( HandleTable, ObjectTableEntry );
00795 
00796                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00797                         leave;
00798 
00799                     } <span class="keywordflow">else</span> {
00800 
00801                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
00802                     }
00803 
00804                 } <span class="keywordflow">else</span> {
00805 
00806                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_TYPE_MISMATCH;
00807                 }
00808 
00809                 <a class="code" href="../../d5/d8/ex_8h.html#a288">ExUnlockHandleTableEntry</a>( HandleTable, ObjectTableEntry );
00810 
00811             } <span class="keywordflow">else</span> {
00812 
00813                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_HANDLE;
00814             }
00815         }
00816 
00817         <span class="comment">//</span>
00818         <span class="comment">//  If we are attached to the system process then return</span>
00819         <span class="comment">//  back to our caller</span>
00820         <span class="comment">//</span>
00821 
00822         <span class="keywordflow">if</span> (AttachedToProcess) {
00823 
00824             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00825         }
00826 
00827         <span class="comment">//</span>
00828         <span class="comment">//  No handle translation is possible. Set the object address to NULL</span>
00829         <span class="comment">//  and return an error status.</span>
00830         <span class="comment">//</span>
00831 
00832         *Object = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00833 
00834     } finally {
00835 
00836         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00837     }
00838 
00839     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00840 }
00841 
00842 
00843 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00844"></a><a class="code" href="../../d7/d1/obref_8c.html#a5">00844</a> <a class="code" href="../../d7/d1/obref_8c.html#a5">ObReferenceObjectByName</a> (
00845     IN PUNICODE_STRING ObjectName,
00846     IN ULONG Attributes,
00847     IN <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState OPTIONAL,
00848     IN ACCESS_MASK DesiredAccess OPTIONAL,
00849     IN <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType,
00850     IN KPROCESSOR_MODE AccessMode,
00851     IN OUT PVOID ParseContext OPTIONAL,
00852     OUT PVOID *Object
00853     )
00854 
00855 <span class="comment">/*++</span>
00856 <span class="comment"></span>
00857 <span class="comment">Routine Description:</span>
00858 <span class="comment"></span>
00859 <span class="comment">    Given a name of an object this routine returns a pointer</span>
00860 <span class="comment">    to the body of the object with proper ref counts</span>
00861 <span class="comment"></span>
00862 <span class="comment">Arguments:</span>
00863 <span class="comment"></span>
00864 <span class="comment">    ObjectName - Supplies the name of the object being referenced</span>
00865 <span class="comment"></span>
00866 <span class="comment">    Attributes - Supplies the desired handle attributes</span>
00867 <span class="comment"></span>
00868 <span class="comment">    AccessState - Supplies an optional pointer to the current access</span>
00869 <span class="comment">        status describing already granted access types, the privileges used</span>
00870 <span class="comment">        to get them, and any access types yet to be granted.</span>
00871 <span class="comment"></span>
00872 <span class="comment">    DesiredAccess - Optionally supplies the desired access to the</span>
00873 <span class="comment">        for the object</span>
00874 <span class="comment"></span>
00875 <span class="comment">    ObjectType - Specifies the object type according to the caller</span>
00876 <span class="comment"></span>
00877 <span class="comment">    AccessMode - Supplies the processor mode of the access</span>
00878 <span class="comment"></span>
00879 <span class="comment">    ParseContext - Optionally supplies a context to pass down to the</span>
00880 <span class="comment">        parse routine</span>
00881 <span class="comment"></span>
00882 <span class="comment">    Object - Receives a pointer to the referenced object body</span>
00883 <span class="comment"></span>
00884 <span class="comment">Return Value:</span>
00885 <span class="comment"></span>
00886 <span class="comment">    An appropriate NTSTATUS value</span>
00887 <span class="comment"></span>
00888 <span class="comment">--*/</span>
00889 
00890 {
00891     UNICODE_STRING CapturedObjectName;
00892     BOOLEAN DirectoryLocked;
00893     PVOID ExistingObject;
00894     <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">ACCESS_STATE</a> LocalAccessState;
00895     <a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html">AUX_ACCESS_DATA</a> AuxData;
00896     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00897 
00898     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00899 
00900     <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>(<span class="stringliteral">"ObReferenceObjectByName"</span>);
00901 
00902     <span class="comment">//</span>
00903     <span class="comment">//  If the object name descriptor is not specified, or the object name</span>
00904     <span class="comment">//  length is zero (tested after capture), then the object name is</span>
00905     <span class="comment">//  invalid.</span>
00906     <span class="comment">//</span>
00907 
00908     <span class="keywordflow">if</span> (ObjectName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00909 
00910         <span class="keywordflow">return</span> STATUS_OBJECT_NAME_INVALID;
00911     }
00912 
00913     <span class="comment">//</span>
00914     <span class="comment">//  Capture the object name.</span>
00915     <span class="comment">//</span>
00916 
00917     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/obp_8h.html#a59">ObpCaptureObjectName</a>( AccessMode,
00918                                    ObjectName,
00919                                    &amp;CapturedObjectName,
00920                                    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00921 
00922     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00923 
00924         <span class="comment">//</span>
00925         <span class="comment">//  No buffer has been allocated for a zero length name so no free</span>
00926         <span class="comment">//  needed</span>
00927         <span class="comment">//</span>
00928 
00929         <span class="keywordflow">if</span> (CapturedObjectName.Length == 0) {
00930 
00931            <span class="keywordflow">return</span> STATUS_OBJECT_NAME_INVALID;
00932         }
00933 
00934         <span class="comment">//</span>
00935         <span class="comment">//  If the access state is not specified, then create the access</span>
00936         <span class="comment">//  state.</span>
00937         <span class="comment">//</span>
00938 
00939         <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(AccessState)) {
00940 
00941             AccessState = &amp;LocalAccessState;
00942 
00943             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/seastate_8c.html#a2">SeCreateAccessState</a>( &amp;LocalAccessState,
00944                                           &amp;AuxData,
00945                                           DesiredAccess,
00946                                           &amp;ObjectType-&gt;TypeInfo.<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o1">GenericMapping</a> );
00947 
00948             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00949 
00950                 <span class="keywordflow">goto</span> FreeBuffer;
00951             }
00952         }
00953 
00954         <span class="comment">//</span>
00955         <span class="comment">//  Lookup object by name.</span>
00956         <span class="comment">//</span>
00957 
00958         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/obp_8h.html#a71">ObpLookupObjectName</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00959                                       &amp;CapturedObjectName,
00960                                       Attributes,
00961                                       ObjectType,
00962                                       AccessMode,
00963                                       ParseContext,
00964                                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00965                                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00966                                       AccessState,
00967                                       &amp;DirectoryLocked,
00968                                       &amp;ExistingObject );
00969 
00970         <span class="comment">//</span>
00971         <span class="comment">//  If the directory is returned locked, then unlock it.</span>
00972         <span class="comment">//</span>
00973 
00974         <span class="keywordflow">if</span> (DirectoryLocked) {
00975 
00976             <a class="code" href="../../d5/d1/obp_8h.html#a11">ObpLeaveRootDirectoryMutex</a>();
00977         }
00978 
00979         <span class="comment">//</span>
00980         <span class="comment">//  If the lookup was successful, then return the existing</span>
00981         <span class="comment">//  object if access is allowed. Otherwise, return NULL.</span>
00982         <span class="comment">//</span>
00983 
00984         *Object = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00985 
00986         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00987 
00988             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d1/obse_8c.html#a4">ObpCheckObjectReference</a>( ExistingObject,
00989                                          AccessState,
00990                                          <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00991                                          AccessMode,
00992                                          &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00993 
00994                 *Object = ExistingObject;
00995             }
00996         }
00997 
00998         <span class="comment">//</span>
00999         <span class="comment">//  If the access state was generated, then delete the access</span>
01000         <span class="comment">//  state.</span>
01001         <span class="comment">//</span>
01002 
01003         <span class="keywordflow">if</span> (AccessState == &amp;LocalAccessState) {
01004 
01005             <a class="code" href="../../d2/d5/seastate_8c.html#a3">SeDeleteAccessState</a>(AccessState);
01006         }
01007 
01008         <span class="comment">//</span>
01009         <span class="comment">//  Free the object name buffer.</span>
01010         <span class="comment">//</span>
01011 
01012 FreeBuffer:
01013 
01014         <a class="code" href="../../d5/d1/obp_8h.html#a61">ObpFreeObjectNameBuffer</a>(&amp;CapturedObjectName);
01015     }
01016 
01017     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01018 }
01019 
01020 
01021 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01022"></a><a class="code" href="../../d7/d1/obref_8c.html#a6">01022</a> <a class="code" href="../../d7/d1/obref_8c.html#a6">ObReferenceObjectByPointer</a> (
01023     IN PVOID Object,
01024     IN ACCESS_MASK DesiredAccess,
01025     IN <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType,
01026     IN KPROCESSOR_MODE AccessMode
01027     )
01028 
01029 <span class="comment">/*++</span>
01030 <span class="comment"></span>
01031 <span class="comment">Routine Description:</span>
01032 <span class="comment"></span>
01033 <span class="comment">    This routine adds another reference count to an object denoted by</span>
01034 <span class="comment">    a pointer to the object body</span>
01035 <span class="comment"></span>
01036 <span class="comment">Arguments:</span>
01037 <span class="comment"></span>
01038 <span class="comment">    Object - Supplies a pointer to the object being referenced</span>
01039 <span class="comment"></span>
01040 <span class="comment">    DesiredAccess - Specifies the desired access for the reference</span>
01041 <span class="comment"></span>
01042 <span class="comment">    ObjectType - Specifies the object type according to the caller</span>
01043 <span class="comment"></span>
01044 <span class="comment">    AccessMode - Supplies the processor mode of the access</span>
01045 <span class="comment"></span>
01046 <span class="comment">Return Value:</span>
01047 <span class="comment"></span>
01048 <span class="comment">    STATUS_SUCCESS if successful and STATUS_OBJECT_TYPE_MISMATCH otherwise</span>
01049 <span class="comment"></span>
01050 <span class="comment">--*/</span>
01051 
01052 {
01053     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01054 
01055     <span class="comment">//</span>
01056     <span class="comment">//  Translate the pointer to the object body to a pointer to the</span>
01057     <span class="comment">//  object header</span>
01058     <span class="comment">//</span>
01059 
01060     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
01061 
01062     <span class="comment">//</span>
01063     <span class="comment">//  If the specified object type does not match and either the caller is</span>
01064     <span class="comment">//  not kernel mode or it is not a symbolic link object then it is an</span>
01065     <span class="comment">//  error</span>
01066     <span class="comment">//</span>
01067 
01068     <span class="keywordflow">if</span> ((ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a> != ObjectType) &amp;&amp; (AccessMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> ||
01069                                                ObjectType == <a class="code" href="../../d5/d1/obp_8h.html#a43">ObpSymbolicLinkObjectType</a>)) {
01070 
01071         <span class="keywordflow">return</span>( STATUS_OBJECT_TYPE_MISMATCH );
01072     }
01073 
01074     <span class="comment">//</span>
01075     <span class="comment">//  Otherwise increment the pointer count and return success to</span>
01076     <span class="comment">//  our caller</span>
01077     <span class="comment">//</span>
01078 
01079     <a class="code" href="../../d5/d1/obp_8h.html#a3">ObpIncrPointerCount</a>( ObjectHeader );
01080 
01081     <span class="keywordflow">return</span>( STATUS_SUCCESS );
01082 }
01083 
01084 
01085 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01086 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l01087"></a><a class="code" href="../../d7/d1/obref_8c.html#a7">01087</a> <a class="code" href="../../d7/d1/obref_8c.html#a7">ObfReferenceObject</a> (
01088     IN PVOID Object
01089     )
01090 
01091 <span class="comment">/*++</span>
01092 <span class="comment"></span>
01093 <span class="comment">Routine Description:</span>
01094 <span class="comment"></span>
01095 <span class="comment">    This function increments the reference count for an object.</span>
01096 <span class="comment"></span>
01097 <span class="comment">    N.B. This function should be used to increment the reference count</span>
01098 <span class="comment">        when the accessing mode is kernel or the objct type is known.</span>
01099 <span class="comment"></span>
01100 <span class="comment">Arguments:</span>
01101 <span class="comment"></span>
01102 <span class="comment">    Object - Supplies a pointer to the object whose reference count is</span>
01103 <span class="comment">        incremented.</span>
01104 <span class="comment"></span>
01105 <span class="comment">Return Value:</span>
01106 <span class="comment"></span>
01107 <span class="comment">    None.</span>
01108 <span class="comment"></span>
01109 <span class="comment">--*/</span>
01110 
01111 {
01112     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01113 
01114     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
01115 
01116     <a class="code" href="../../d5/d1/obp_8h.html#a3">ObpIncrPointerCount</a>( ObjectHeader );
01117 
01118     <span class="keywordflow">return</span>;
01119 }
01120 
01121 
01122 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01123 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l01124"></a><a class="code" href="../../d7/d1/obref_8c.html#a8">01124</a> <a class="code" href="../../d7/d1/obref_8c.html#a8">ObfDereferenceObject</a> (
01125     IN PVOID Object
01126     )
01127 
01128 <span class="comment">/*++</span>
01129 <span class="comment"></span>
01130 <span class="comment">Routine Description:</span>
01131 <span class="comment"></span>
01132 <span class="comment">    This routine decrments the refernce count of the specified object and</span>
01133 <span class="comment">    does whatever cleanup there is if the count goes to zero.</span>
01134 <span class="comment"></span>
01135 <span class="comment">Arguments:</span>
01136 <span class="comment"></span>
01137 <span class="comment">    Object - Supplies a pointer to the body of the object being dereferenced</span>
01138 <span class="comment"></span>
01139 <span class="comment">Return Value:</span>
01140 <span class="comment"></span>
01141 <span class="comment">    None.</span>
01142 <span class="comment"></span>
01143 <span class="comment">--*/</span>
01144 
01145 {
01146     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01147     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
01148     KIRQL OldIrql;
01149     BOOLEAN StartWorkerThread;
01150 
01151     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> Port = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01152 
01153 <span class="preprocessor">#if DBG</span>
01154 <span class="preprocessor"></span>
01155     <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">POBJECT_HEADER_NAME_INFO</a> NameInfo;
01156 
01157 <span class="preprocessor">#endif</span>
01158 <span class="preprocessor"></span>
01159     <span class="comment">//</span>
01160     <span class="comment">//  Translate a pointer to the object body to a pointer to the object</span>
01161     <span class="comment">//  header.</span>
01162     <span class="comment">//</span>
01163 
01164     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
01165 
01166 <span class="preprocessor">#if DBG</span>
01167 <span class="preprocessor"></span>
01168     NameInfo = <a class="code" href="../../d4/d0/ob_8h.html#a12">OBJECT_HEADER_TO_NAME_INFO</a>( ObjectHeader );
01169 
01170     <span class="keywordflow">if</span> (NameInfo) {
01171 
01172        InterlockedDecrement(&amp;NameInfo-&gt;DbgDereferenceCount) ;
01173     }
01174 
01175 <span class="preprocessor">#endif</span>
01176 <span class="preprocessor"></span>
01177 
01178     <span class="comment">//</span>
01179     <span class="comment">//  Decrement the point count and if the result is now then</span>
01180     <span class="comment">//  there is extra work to do</span>
01181     <span class="comment">//</span>
01182 
01183     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
01184 
01185     <span class="keywordflow">if</span> ( (ObjectType == <a class="code" href="../../d9/d8/ntos_8h.html#a5">LpcPortObjectType</a>) ||
01186          (ObjectType == <a class="code" href="../../d9/d8/ntos_8h.html#a6">LpcWaitablePortObjectType</a>) ) {
01187 
01188         Port = Object;
01189         <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
01190     }
01191 
01192     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/obp_8h.html#a5">ObpDecrPointerCountWithResult</a>( ObjectHeader )) {
01193 
01194         <span class="comment">//</span>
01195         <span class="comment">//  Find out the level we're at and the object type</span>
01196         <span class="comment">//</span>
01197 
01198         OldIrql = KeGetCurrentIrql();
01199 
01200         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o1">HandleCount</a> == 0);
01201 
01202 
01203         <span class="keywordflow">if</span> (Port != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01204 
01205             Port-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> |= <a class="code" href="../../d2/d6/lpc_8h.html#a11">PORT_DELETED</a>;
01206             Port = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01207 
01208             <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
01209         }
01210 
01211 
01212         <span class="comment">//</span>
01213         <span class="comment">//  If we're at the passive level then go ahead and delete the</span>
01214         <span class="comment">//  object now.  Or if we're at APC level and object say's we're</span>
01215         <span class="comment">//  allocated out of paged pool then also go ahead and delete</span>
01216         <span class="comment">//  the object right now.</span>
01217         <span class="comment">//</span>
01218 
01219         <span class="keywordflow">if</span> ((OldIrql == <a class="code" href="../../d1/d3/ppcdef_8h.html#a21">PASSIVE_LEVEL</a>) ||
01220             ((OldIrql == <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) &amp;&amp;
01221              ((ObjectType != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o9">PoolType</a> != <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>)))) {
01222 
01223 
01224                 <a class="code" href="../../d7/d1/obref_8c.html#a10">ObpRemoveObjectRoutine</a>( Object );
01225 
01226                 <span class="keywordflow">return</span>;    
01227 
01228         } <span class="keywordflow">else</span> {
01229 
01230             <span class="comment">//</span>
01231             <span class="comment">//  Objects can't be deleted from an IRQL above APC_LEVEL.</span>
01232             <span class="comment">//  Nonpaged objects can't be deleted from APC_LEVEL.</span>
01233             <span class="comment">//  So queue the delete operation.</span>
01234             <span class="comment">//</span>
01235 
01236             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o9">PoolType</a> == <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>));
01237 
01238             <span class="comment">//</span>
01239             <span class="comment">//  Lock the work queue, enqueue the new work item, and if the</span>
01240             <span class="comment">//  work queue is not active then make it active, indicate that</span>
01241             <span class="comment">//  we need to start the worker thread, and unlock the work</span>
01242             <span class="comment">//  queue.</span>
01243             <span class="comment">//</span>
01244 
01245             ExAcquireSpinLock( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a33">ObpLock</a>, &amp;OldIrql );
01246 
01247             PushEntryList((PSINGLE_LIST_ENTRY)&amp;<a class="code" href="../../d5/d1/obp_8h.html#a36">ObpRemoveObjectQueue</a>, (PSINGLE_LIST_ENTRY)&amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o2">SEntry</a> );
01248 
01249             <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d1/obref_8c.html#a0">ObpRemoveQueueActive</a>) {
01250 
01251                 <a class="code" href="../../d7/d1/obref_8c.html#a0">ObpRemoveQueueActive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01252                 StartWorkerThread = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01253 
01254             } <span class="keywordflow">else</span> {
01255 
01256                 StartWorkerThread = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01257             }
01258 
01259 <span class="preprocessor">#if 0</span>
01260 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (StartWorkerThread) {
01261 
01262                 KdPrint(( <span class="stringliteral">"OB: %08x Starting ObpProcessRemoveObjectQueue thread.\n"</span>, Object ));
01263 
01264             } <span class="keywordflow">else</span> {
01265 
01266                 KdPrint(( <span class="stringliteral">"OB: %08x Queued to ObpProcessRemoveObjectQueue thread.\n"</span>, Object ));
01267             }
01268 
01269 <span class="preprocessor">#endif  // 1</span>
01270 <span class="preprocessor"></span>
01271             ExReleaseSpinLock( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a33">ObpLock</a>, OldIrql );
01272 
01273             <span class="comment">//</span>
01274             <span class="comment">//  If we have to start the worker thread then go ahead</span>
01275             <span class="comment">//  and enqueue the work item</span>
01276             <span class="comment">//</span>
01277 
01278             <span class="keywordflow">if</span> (StartWorkerThread) {
01279 
01280                 <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a35">ObpRemoveObjectWorkItem</a>,
01281                                       <a class="code" href="../../d5/d1/obp_8h.html#a74">ObpProcessRemoveObjectQueue</a>,
01282                                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01283 
01284                 <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a35">ObpRemoveObjectWorkItem</a>, <a class="code" href="../../d5/d8/ex_8h.html#a332a205">CriticalWorkQueue</a> );
01285             }
01286         }
01287     }
01288 
01289     <span class="keywordflow">if</span> ( Port != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01290 
01291         <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
01292     }
01293 
01294     <span class="keywordflow">return</span>;
01295 }
01296 
01297 
01298 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01299"></a><a class="code" href="../../d7/d1/obref_8c.html#a9">01299</a> <a class="code" href="../../d7/d1/obref_8c.html#a9">ObpProcessRemoveObjectQueue</a> (
01300     PVOID Parameter
01301     )
01302 
01303 <span class="comment">/*++</span>
01304 <span class="comment"></span>
01305 <span class="comment">Routine Description:</span>
01306 <span class="comment"></span>
01307 <span class="comment">    This is the work routine for the remove object work queue.  Its</span>
01308 <span class="comment">    job is to remove and process items from the remove object queue.</span>
01309 <span class="comment"></span>
01310 <span class="comment">Arguments:</span>
01311 <span class="comment"></span>
01312 <span class="comment">    Parameter - Ignored</span>
01313 <span class="comment"></span>
01314 <span class="comment">Return Value:</span>
01315 <span class="comment"></span>
01316 <span class="comment">    None.</span>
01317 <span class="comment"></span>
01318 <span class="comment">--*/</span>
01319 
01320 {
01321     PSINGLE_LIST_ENTRY Entry;
01322     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01323     KIRQL OldIrql;
01324 
01325     <span class="comment">//</span>
01326     <span class="comment">//  Lock the work queue this will keep the preceding routine</span>
01327     <span class="comment">//  from monkeying with the queue</span>
01328     <span class="comment">//</span>
01329 
01330     ExAcquireSpinLock( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a33">ObpLock</a>, &amp;OldIrql );
01331 
01332     <span class="comment">//</span>
01333     <span class="comment">//  While there are items in our private remove object work queue</span>
01334     <span class="comment">//  then we remove each item, get back up to the object header,</span>
01335     <span class="comment">//  and delete the object.  The latter part done outside of the</span>
01336     <span class="comment">//  work queue lock</span>
01337     <span class="comment">//</span>
01338 
01339     Entry = PopEntryList( (PSINGLE_LIST_ENTRY)&amp;<a class="code" href="../../d5/d1/obp_8h.html#a36">ObpRemoveObjectQueue</a> );
01340 
01341     <span class="keywordflow">while</span> ( Entry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01342 
01343         ExReleaseSpinLock( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a33">ObpLock</a>, OldIrql );
01344 
01345         ObjectHeader = CONTAINING_RECORD( Entry,
01346                                           <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">OBJECT_HEADER</a>,
01347                                           SEntry );
01348 
01349         <a class="code" href="../../d7/d1/obref_8c.html#a10">ObpRemoveObjectRoutine</a>( &amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o11">Body</a> );
01350 
01351         ExAcquireSpinLock( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a33">ObpLock</a>, &amp;OldIrql );
01352 
01353         Entry = PopEntryList((PSINGLE_LIST_ENTRY)&amp;<a class="code" href="../../d5/d1/obp_8h.html#a36">ObpRemoveObjectQueue</a> );
01354     }
01355 
01356     <span class="comment">//</span>
01357     <span class="comment">//  Indicate that we are now going inactive and then unlock</span>
01358     <span class="comment">//  the work queue</span>
01359     <span class="comment">//</span>
01360 
01361     <a class="code" href="../../d7/d1/obref_8c.html#a0">ObpRemoveQueueActive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01362 
01363     ExReleaseSpinLock( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a33">ObpLock</a>, OldIrql );
01364 
01365     <span class="keywordflow">return</span>;
01366 }
01367 
01368 
01369 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01370"></a><a class="code" href="../../d7/d1/obref_8c.html#a10">01370</a> <a class="code" href="../../d7/d1/obref_8c.html#a10">ObpRemoveObjectRoutine</a> (
01371     PVOID Object
01372     )
01373 
01374 <span class="comment">/*++</span>
01375 <span class="comment"></span>
01376 <span class="comment">Routine Description:</span>
01377 <span class="comment"></span>
01378 <span class="comment">    This routine is used to delete an object whose reference count has</span>
01379 <span class="comment">    gone to zero.</span>
01380 <span class="comment"></span>
01381 <span class="comment">Arguments:</span>
01382 <span class="comment"></span>
01383 <span class="comment">    Object - Supplies a pointer to the body of the object being deleted</span>
01384 <span class="comment"></span>
01385 <span class="comment">Return Value:</span>
01386 <span class="comment"></span>
01387 <span class="comment">    None.</span>
01388 <span class="comment"></span>
01389 <span class="comment">--*/</span>
01390 
01391 {
01392     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01393     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01394     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
01395     <a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html">POBJECT_HEADER_CREATOR_INFO</a> CreatorInfo;
01396     <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">POBJECT_HEADER_NAME_INFO</a> NameInfo;
01397 
01398     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01399 
01400     <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>( <span class="stringliteral">"ObpRemoveObjectRoutine"</span> );
01401 
01402     <span class="comment">//</span>
01403     <span class="comment">//  Retrieve an object header from the object body, and also get</span>
01404     <span class="comment">//  the object type, creator and name info if available</span>
01405     <span class="comment">//</span>
01406 
01407     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
01408     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
01409     CreatorInfo = <a class="code" href="../../d4/d0/ob_8h.html#a13">OBJECT_HEADER_TO_CREATOR_INFO</a>( ObjectHeader );
01410     NameInfo = <a class="code" href="../../d4/d0/ob_8h.html#a12">OBJECT_HEADER_TO_NAME_INFO</a>( ObjectHeader );
01411 
01412     <span class="comment">//</span>
01413     <span class="comment">//  Get exclusive access to the object type object</span>
01414     <span class="comment">//</span>
01415 
01416     <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
01417 
01418     <span class="comment">//</span>
01419     <span class="comment">//  If there is a creator info record and we are on the list</span>
01420     <span class="comment">//  for the object type then remove this object from the list</span>
01421     <span class="comment">//</span>
01422 
01423     <span class="keywordflow">if</span> (CreatorInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; !IsListEmpty( &amp;CreatorInfo-&gt;<a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html#o0">TypeList</a> )) {
01424 
01425         RemoveEntryList( &amp;CreatorInfo-&gt;<a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html#o0">TypeList</a> );
01426     }
01427 
01428     <span class="comment">//</span>
01429     <span class="comment">//  If there is a name info record and the name buffer is not null</span>
01430     <span class="comment">//  then free the buffer and zero out the name record</span>
01431     <span class="comment">//</span>
01432 
01433     <span class="keywordflow">if</span> (NameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01434 
01435         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Buffer );
01436 
01437         NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01438         NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Length = 0;
01439         NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.MaximumLength = 0;
01440     }
01441 
01442     <span class="comment">//</span>
01443     <span class="comment">//  We are done with the object type object so we can now release it</span>
01444     <span class="comment">//</span>
01445 
01446     <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
01447 
01448     <span class="comment">//</span>
01449     <span class="comment">//  Security descriptor deletion must precede the</span>
01450     <span class="comment">//  call to the object's DeleteProcedure.  Check if we have</span>
01451     <span class="comment">//  a security descriptor and if so then call the routine</span>
01452     <span class="comment">//  to delete the security descritpor.</span>
01453     <span class="comment">//</span>
01454 
01455     <span class="keywordflow">if</span> (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o10">SecurityDescriptor</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01456 
01457         KIRQL SaveIrql;
01458 
01459         <a class="code" href="../../d5/d1/obp_8h.html#a0">ObpBeginTypeSpecificCallOut</a>( SaveIrql );
01460 
01461         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o17">SecurityProcedure</a>)( Object,
01462                                                            <a class="code" href="../../d0/d5/se_8h.html#a200a110">DeleteSecurityDescriptor</a>,
01463                                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01464                                                            &amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o10">SecurityDescriptor</a>,
01465                                                            0,
01466                                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01467 
01468         <a class="code" href="../../d5/d1/obp_8h.html#a1">ObpEndTypeSpecificCallOut</a>( SaveIrql, <span class="stringliteral">"Security"</span>, ObjectType, Object );
01469     }
01470 
01471     <span class="comment">//</span>
01472     <span class="comment">//  Now if there is a delete callback for the object type invoke</span>
01473     <span class="comment">//  the routine</span>
01474     <span class="comment">//</span>
01475 
01476     <span class="keywordflow">if</span> (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o15">DeleteProcedure</a>) {
01477 
01478         KIRQL SaveIrql;
01479 
01480         <a class="code" href="../../d5/d1/obp_8h.html#a0">ObpBeginTypeSpecificCallOut</a>( SaveIrql );
01481 
01482         (*(ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o15">DeleteProcedure</a>))( Object );
01483 
01484         <a class="code" href="../../d5/d1/obp_8h.html#a1">ObpEndTypeSpecificCallOut</a>( SaveIrql, <span class="stringliteral">"Delete"</span>, ObjectType, Object );
01485     }
01486 
01487     <span class="comment">//</span>
01488     <span class="comment">//  Finally return the object back to pool including releasing any quota</span>
01489     <span class="comment">//  charges</span>
01490     <span class="comment">//</span>
01491 
01492     <a class="code" href="../../d5/d1/obp_8h.html#a63">ObpFreeObject</a>( Object );
01493 }
01494 
01495 
01496 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01497"></a><a class="code" href="../../d7/d1/obref_8c.html#a11">01497</a> <a class="code" href="../../d7/d1/obref_8c.html#a11">ObpDeleteNameCheck</a> (
01498     IN PVOID Object,
01499     IN BOOLEAN TypeMutexHeld
01500     )
01501 
01502 <span class="comment">/*++</span>
01503 <span class="comment"></span>
01504 <span class="comment">Routine Description:</span>
01505 <span class="comment"></span>
01506 <span class="comment">    This routine removes the name of an object from its parent directory</span>
01507 <span class="comment"></span>
01508 <span class="comment">Arguments:</span>
01509 <span class="comment"></span>
01510 <span class="comment">    Object - Supplies a pointer to the object body whose name is being checked</span>
01511 <span class="comment"></span>
01512 <span class="comment">    TypeMutexHeld - Indicates if the lock on object type is being held by the</span>
01513 <span class="comment">        caller</span>
01514 <span class="comment"></span>
01515 <span class="comment">Return Value:</span>
01516 <span class="comment"></span>
01517 <span class="comment">    None.</span>
01518 <span class="comment"></span>
01519 <span class="comment">--*/</span>
01520 
01521 {
01522     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01523     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
01524     <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">POBJECT_HEADER_NAME_INFO</a> NameInfo;
01525     PVOID DirObject;
01526 
01527     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01528 
01529     <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>( <span class="stringliteral">"ObpDeleteNameCheck"</span> );
01530 
01531     <span class="comment">//</span>
01532     <span class="comment">//  Translate the object body to an object header also get</span>
01533     <span class="comment">//  the object type and name info if present</span>
01534     <span class="comment">//</span>
01535 
01536     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
01537     NameInfo = <a class="code" href="../../d4/d0/ob_8h.html#a12">OBJECT_HEADER_TO_NAME_INFO</a>( ObjectHeader );
01538     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
01539 
01540     <span class="comment">//</span>
01541     <span class="comment">//  If the lock is not held then get the lock now</span>
01542     <span class="comment">//</span>
01543 
01544     <span class="keywordflow">if</span> (!TypeMutexHeld) {
01545 
01546         <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
01547     }
01548 
01549     <span class="comment">//</span>
01550     <span class="comment">//  Make sure that the object has a zero handle count, has a non</span>
01551     <span class="comment">//  empty name buffer, and is not a permanent object</span>
01552     <span class="comment">//</span>
01553 
01554     <span class="keywordflow">if</span> ((ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o1">HandleCount</a> == 0) &amp;&amp;
01555         (NameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01556         (NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Length != 0) &amp;&amp;
01557         (!(ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a5">OB_FLAG_PERMANENT_OBJECT</a>))) {
01558 
01559         <span class="comment">//</span>
01560         <span class="comment">//  Give up the lock on the object type and instead</span>
01561         <span class="comment">//  get the lock on the object directories</span>
01562         <span class="comment">//</span>
01563 
01564         <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
01565         <a class="code" href="../../d5/d1/obp_8h.html#a10">ObpEnterRootDirectoryMutex</a>();
01566         DirObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01567 
01568         <span class="comment">//</span>
01569         <span class="comment">//  Check that the object we is still in the directory otherwise</span>
01570         <span class="comment">//  then is nothing for us to remove</span>
01571         <span class="comment">//</span>
01572 
01573         <span class="keywordflow">if</span> (Object == <a class="code" href="../../d5/d1/obp_8h.html#a68">ObpLookupDirectoryEntry</a>( NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a>,
01574                                                &amp;NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>,
01575                                                0 )) {
01576 
01577             <span class="comment">//</span>
01578             <span class="comment">//  Now reacquire the lock on the object type and</span>
01579             <span class="comment">//  check check the handle count again.  If it is still</span>
01580             <span class="comment">//  zero then we can do the actual delete name operation</span>
01581             <span class="comment">//</span>
01582 
01583             <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
01584 
01585             <span class="keywordflow">if</span> (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o1">HandleCount</a> == 0) {
01586 
01587                 KIRQL SaveIrql;
01588 
01589                 <span class="comment">//</span>
01590                 <span class="comment">//  Delete the directory entry </span>
01591                 <span class="comment">//</span>
01592                 
01593                 <a class="code" href="../../d5/d1/obp_8h.html#a70">ObpDeleteDirectoryEntry</a>( NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a> );
01594                 
01595                 <span class="comment">//</span>
01596                 <span class="comment">//  If security is not required invoke the </span>
01597                 <span class="comment">//  security callback to delete the security descriptor</span>
01598                 <span class="comment">//</span>
01599                 
01600                 <span class="keywordflow">if</span> ( !ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o6">SecurityRequired</a> ) {
01601                     
01602                     <a class="code" href="../../d5/d1/obp_8h.html#a0">ObpBeginTypeSpecificCallOut</a>( SaveIrql );
01603 
01604                     (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o17">SecurityProcedure</a>)( Object,
01605                                                               <a class="code" href="../../d0/d5/se_8h.html#a200a110">DeleteSecurityDescriptor</a>,
01606                                                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01607                                                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01608                                                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01609                                                               &amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o10">SecurityDescriptor</a>,
01610                                                               ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o9">PoolType</a>,
01611                                                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01612 
01613                     <a class="code" href="../../d5/d1/obp_8h.html#a1">ObpEndTypeSpecificCallOut</a>( SaveIrql, <span class="stringliteral">"Security"</span>, ObjectType, Object );
01614                 }
01615                 
01616                 <span class="comment">//</span>
01617                 <span class="comment">//  If this is a symbolic link object then we also need to</span>
01618                 <span class="comment">//  delete the symbolic link</span>
01619                 <span class="comment">//</span>
01620 
01621                 <span class="keywordflow">if</span> (ObjectType == <a class="code" href="../../d5/d1/obp_8h.html#a43">ObpSymbolicLinkObjectType</a>) {
01622 
01623                     <a class="code" href="../../d5/d1/obp_8h.html#a67">ObpDeleteSymbolicLinkName</a>( (<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html">POBJECT_SYMBOLIC_LINK</a>)Object );
01624                 }
01625 
01626                 <span class="comment">//</span>
01627                 <span class="comment">//  Free the name buffer and zero out the name data fields</span>
01628                 <span class="comment">//</span>
01629 
01630                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Buffer );
01631 
01632                 NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01633                 NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Length = 0;
01634                 NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.MaximumLength = 0;
01635 
01636                 DirObject = NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a>;
01637                 NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01638             }
01639 
01640             <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
01641         }
01642 
01643         <a class="code" href="../../d5/d1/obp_8h.html#a11">ObpLeaveRootDirectoryMutex</a>();
01644 
01645         <span class="comment">//</span>
01646         <span class="comment">//  If there is a directory object for the name then decrement</span>
01647         <span class="comment">//  its reference count for it and for the object</span>
01648         <span class="comment">//</span>
01649 
01650         <span class="keywordflow">if</span> (DirObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01651 
01652             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( DirObject );
01653             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Object );
01654         }
01655 
01656     } <span class="keywordflow">else</span> {
01657 
01658         <span class="comment">//</span>
01659         <span class="comment">//  Otherwise don't do any work but simply release the object type</span>
01660         <span class="comment">//  lock and return to our caller</span>
01661         <span class="comment">//</span>
01662 
01663         <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
01664     }
01665 
01666     <span class="keywordflow">return</span>;
01667 }
01668 
01669 
01670 <span class="comment">//</span>
01671 <span class="comment">// Thunks to support standard call callers</span>
01672 <span class="comment">//</span>
01673 
01674 <span class="preprocessor">#ifdef ObDereferenceObject</span>
01675 <span class="preprocessor"></span><span class="preprocessor">#undef ObDereferenceObject</span>
01676 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01677 <span class="preprocessor"></span>
01678 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01679"></a><a class="code" href="../../d7/d1/obref_8c.html#a12">01679</a> <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (
01680     IN PVOID Object
01681     )
01682 
01683 <span class="comment">/*++</span>
01684 <span class="comment"></span>
01685 <span class="comment">Routine Description:</span>
01686 <span class="comment"></span>
01687 <span class="comment">    This is really just a thunk for the Obf version of the dereference</span>
01688 <span class="comment">    routine</span>
01689 <span class="comment"></span>
01690 <span class="comment">Arguments:</span>
01691 <span class="comment"></span>
01692 <span class="comment">    Object - Supplies a pointer to the body of the object being dereferenced</span>
01693 <span class="comment"></span>
01694 <span class="comment">Return Value:</span>
01695 <span class="comment"></span>
01696 <span class="comment">    None.</span>
01697 <span class="comment"></span>
01698 <span class="comment">--*/</span>
01699 
01700 {
01701     <a class="code" href="../../d7/d1/obref_8c.html#a8">ObfDereferenceObject</a> (Object) ;
01702 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:05 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
