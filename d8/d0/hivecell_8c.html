<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: hivecell.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>hivecell.c File Reference</h1><code>#include "<a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>"</code><br>

<p>
<a href="../../d9/d9/hivecell_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d0/hivecell_8c.html#a0">CmpFindFirstSetRight</a>&nbsp;&nbsp;&nbsp;<a class="el" href="../../d5/d9/kernldat_8c.html#a39">KiFindFirstSetRight</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d0/hivecell_8c.html#a1">CmpFindFirstSetLeft</a>&nbsp;&nbsp;&nbsp;<a class="el" href="../../d0/d0/ki_8h.html#a45">KiFindFirstSetLeft</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d0/hivecell_8c.html#a2">HvpComputeIndex</a>(<a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>, <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d0/hivecell_8c.html#a3">ONE_K</a>&nbsp;&nbsp;&nbsp;1024</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d0/hivecell_8c.html#a4">HvpAdjustCellSize</a>(<a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d0/hivecell_8c.html#a7">HvpDoAllocateCell</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, ULONG NewSize, <a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a> Type)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d0/hivecell_8c.html#a8">HvpAllocateInBin</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d7/d4/struct__HBIN.html">PHBIN</a> <a class="el" href="../../d9/d0/hivechek_8c.html#a6">Bin</a>, ULONG <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>, ULONG Type)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d0/hivecell_8c.html#a9">HvpMakeBinPresent</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>, IN <a class="el" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> Map)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d0/hivecell_8c.html#a10">HvpIsFreeNeighbor</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d7/d4/struct__HBIN.html">PHBIN</a> <a class="el" href="../../d9/d0/hivechek_8c.html#a6">Bin</a>, <a class="el" href="../../d8/d4/struct__HCELL.html">PHCELL</a> FreeCell, <a class="el" href="../../d8/d4/struct__HCELL.html">PHCELL</a> *FreeNeighbor, <a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a> Type)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d0/hivecell_8c.html#a11">HvpDelistBinFreeCells</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d7/d4/struct__HBIN.html">PHBIN</a> <a class="el" href="../../d9/d0/hivechek_8c.html#a6">Bin</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a> Type, <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d9/struct__CELL__DATA.html">_CELL_DATA</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d0/hivecell_8c.html#a12">HvpGetCellPaged</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d9/struct__CELL__DATA.html">_CELL_DATA</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d0/hivecell_8c.html#a13">HvpGetCellFlat</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d0/hivecell_8c.html#a15">HvGetCellSize</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN PVOID Address)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, ULONG NewSize, <a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a> Type)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d0/hivecell_8c.html#a18">HvpEnlistFreeCell</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>, ULONG <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a> Type, BOOLEAN CoalesceForward, <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d0/hivecell_8c.html#a19">HvpDelistFreeCell</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d8/d4/struct__HCELL.html">PHCELL</a> Pcell, <a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a> Type, <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d0/hivecell_8c.html#a20">HvReallocateCell</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>, ULONG NewSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d0/hivecell_8c.html#a21">HvIsCellAllocated</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>CCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d0/hivecell_8c.html#a5">KiFindFirstSetRight</a> [256]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>CCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d0/hivecell_8c.html#a6">KiFindFirstSetLeft</a> [256]</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a1" doxytag="hivecell.c::CmpFindFirstSetLeft" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmpFindFirstSetLeft&nbsp;&nbsp;&nbsp;<a class="el" href="../../d0/d0/ki_8h.html#a45">KiFindFirstSetLeft</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00076">76</a> of file <a class="el" href="../../d9/d9/hivecell_8c-source.html">hivecell.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="hivecell.c::CmpFindFirstSetRight" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmpFindFirstSetRight&nbsp;&nbsp;&nbsp;<a class="el" href="../../d5/d9/kernldat_8c.html#a39">KiFindFirstSetRight</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00074">74</a> of file <a class="el" href="../../d9/d9/hivecell_8c-source.html">hivecell.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="hivecell.c::HvpAdjustCellSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HvpAdjustCellSize          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                                                   \
        ULONG   onek = <a class="code" href="../../d8/d0/hivecell_8c.html#a3">ONE_K</a>;                                           \
        ULONG   Limit = 0;                                              \
                                                                        \
        <span class="keywordflow">while</span>( <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &gt; onek ) {                                          \
            onek&lt;&lt;=1;                                                   \
            Limit++;                                                    \
        }                                                               \
                                                                        \
        <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = Limit?onek:<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;                                         \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00109">109</a> of file <a class="el" href="../../d9/d9/hivecell_8c-source.html">hivecell.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="hivecell.c::HvpComputeIndex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HvpComputeIndex          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                                                   \
        <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &gt;&gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a46">HHIVE_FREE_DISPLAY_SHIFT</a>) - 1;                 \
        <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt;= <a class="code" href="../../d0/d1/hivedata_8h.html#a43">HHIVE_LINEAR_INDEX</a> ) {                             \
                                                                        \
            <span class="comment">/*                                                          \</span>
<span class="comment">            ** Too big for the linear lists, compute the exponential    \</span>
<span class="comment">            ** list.                                                    \</span>
<span class="comment">            */</span>                                                          \
                                                                        \
            <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt; 255) {                                          \
                <span class="comment">/*                                                      \</span>
<span class="comment">                ** Too big for all the lists, use the last index.       \</span>
<span class="comment">                */</span>                                                      \
                <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a45">HHIVE_FREE_DISPLAY_SIZE</a>-1;                      \
            } <span class="keywordflow">else</span> {                                                    \
                <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d8/d0/hivecell_8c.html#a1">CmpFindFirstSetLeft</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] +                    \
                        <a class="code" href="../../d0/d1/hivedata_8h.html#a47">HHIVE_FREE_DISPLAY_BIAS</a>;                        \
            }                                                           \
        }                                                               \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00079">79</a> of file <a class="el" href="../../d9/d9/hivecell_8c-source.html">hivecell.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="hivecell.c::ONE_K" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ONE_K&nbsp;&nbsp;&nbsp;1024          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00096">96</a> of file <a class="el" href="../../d9/d9/hivecell_8c-source.html">hivecell.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a16" doxytag="hivecell.c::HvAllocateCell" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> HvAllocateCell           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NewSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00386">386</a> of file <a class="el" href="../../d9/d9/hivecell_8c-source.html">hivecell.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00895">CmpAddSubKey()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00697">CmpAssignSecurityDescriptor()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01009">CmpCopyCell()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00686">CmpCopyKeyPartial()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01252">CmpCreateLinkNode()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01328">CmpCreateRootNode()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00226">CmpDoCreateChild()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00397">CmpSetSecurityDescriptorInfo()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01383">CmpSetValueKeyExisting()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01619">CmpSetValueKeyNew()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01472">CmpSplitLeaf()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01338">CmpSyncKeyValues()</a>, <a class="el" href="../../d0/d4/edithive_8c-source.html#l00625">EhCreateChild()</a>, and <a class="el" href="../../d0/d4/edithive_8c-source.html#l00988">EhpAttachSecurity()</a>.
<p>
<pre class="fragment"><div>00398                    :
00399 
00400     Allocates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> space and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cell index <span class="keywordflow">for</span> a <span class="keyword">new</span> cell.
00401 
00402 Arguments:
00403 
00404     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00405             hive of interest
00406 
00407     NewSize - size in bytes of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cell to allocate
00408 
00409     Type - indicates whether <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a> or <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a> storage <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> desired.
00410 
00411 Return Value:
00412 
00413     New <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <span class="keywordflow">if</span> success, <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a> <span class="keywordflow">if</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
00414 
00415 --*/
00416 {
00417     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> NewCell;
00418 
00419     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_HIVE) {
00420         KdPrint((<span class="stringliteral">"HvAllocateCell:\n"</span>));
00421         KdPrint((<span class="stringliteral">"\tHive=%08lx NewSize=%08lx\n"</span>,Hive,NewSize));
00422     }
00423     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> == HHIVE_SIGNATURE);
00424     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == FALSE);
00425     <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
00426 
00427     <span class="comment">//</span>
00428     <span class="comment">// Make room for overhead fields and round up to HCELL_PAD boundary</span>
00429     <span class="comment">//</span>
00430     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
00431         NewSize += FIELD_OFFSET(<a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>, u.OldCell.u.UserData);
00432     } <span class="keywordflow">else</span> {
00433         NewSize += FIELD_OFFSET(<a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>, u.NewCell.u.UserData);
00434     }
00435     NewSize = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(NewSize, <a class="code" href="../../d0/d1/hivedata_8h.html#a20">HCELL_PAD</a>(Hive));
00436 
00437     <span class="comment">// </span>
00438     <span class="comment">// Adjust the size (an easy fix for granularity)</span>
00439     <span class="comment">//</span>
00440     <a class="code" href="../../d8/d0/hivecell_8c.html#a4">HvpAdjustCellSize</a>(NewSize);
00441     <span class="comment">//</span>
00442     <span class="comment">// reject impossible/unreasonable values</span>
00443     <span class="comment">//</span>
00444     <span class="keywordflow">if</span> (NewSize &gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a0">HSANE_CELL_MAX</a>) {
00445         <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00446     }
00447 
00448     <span class="comment">//</span>
00449     <span class="comment">// Do the actual storage allocation</span>
00450     <span class="comment">//</span>
00451     NewCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a7">HvpDoAllocateCell</a>(Hive, NewSize, Type);
00452 
00453 <span class="preprocessor">#if DBG</span>
00454 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (NewCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00455         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d0/hivecell_8c.html#a21">HvIsCellAllocated</a>(Hive, NewCell));
00456     }
00457 <span class="preprocessor">#endif</span>
00458 <span class="preprocessor"></span>
00459 
    <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_HIVE) {
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="hivecell.c::HvFreeCell" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID HvFreeCell           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">688</a> of file <a class="el" href="../../d9/d9/hivecell_8c-source.html">hivecell.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00346">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00136">Bin</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00423">_HMAP_ENTRY::BinAddress</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00258">CMS_HIVE</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00046">DHvCheckBin</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00193">_HBIN::FileOffset</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00151">HCELL_FREE_FILL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00111">HCELL_TYPE_MASK</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00412">HMAP_BASE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00135">HvGetCellType</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00947">HvpEnlistFreeCell()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00285">HvpGetCellMap()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00292">HvpGetHCell</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00832">HvpIsFreeNeighbor()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00617">_HHIVE::ReadOnly</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00194">_HBIN::Size</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00164">_HCELL::Size</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d8/d4/struct__HCELL.html#o4">_HCELL::u</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00161">USE_OLD_CELL</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00378">VALIDATE_CELL_MAP</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00092">CmDeleteValueKey()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00895">CmpAddSubKey()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00697">CmpAssignSecurityDescriptor()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00686">CmpCopyKeyPartial()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00895">CmpCopyValue()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01252">CmpCreateLinkNode()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00226">CmpDoCreateChild()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01297">CmpFreeKeyBody()</a>, <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00140">CmpFreeKeyByCell()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01064">CmpFreeKeyValues()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01464">CmpFreeSecurityDescriptor()</a>, <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00053">CmpFreeValue()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01150">CmpMergeKeyValues()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01714">CmpRemoveSubKey()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00397">CmpSetSecurityDescriptorInfo()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01383">CmpSetValueKeyExisting()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01619">CmpSetValueKeyNew()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01472">CmpSplitLeaf()</a>, and <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01338">CmpSyncKeyValues()</a>.
<p>
<pre class="fragment"><div>00699                    :
00700 
00701 
00702     Frees <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> storage <span class="keywordflow">for</span> a cell.
00703 
00704     NOTE:   CALLER <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> expected to mark relevent data dirty, so as to
00705             allow <span class="keyword">this</span> call to always succeed.
00706 
00707 Arguments:
00708 
00709     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00710             hive of interest
00711 
00712     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> of <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> to free.
00713 
00714 Return Value:
00715 
00716     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - failed, presumably <span class="keywordflow">for</span> want of log space.
00717 
00718     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
00719 
00720 --*/
00721 {
00722     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00723     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>          tmp;
00724     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     newfreecell;
00725     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>          freebase;
00726     ULONG           savesize;
00727     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>          neighbor;
00728     ULONG           Type;
00729     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a>     Me;
00730 
00731 
00732     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_HIVE) {
00733         KdPrint((<span class="stringliteral">"HvFreeCell:\n"</span>));
00734         KdPrint((<span class="stringliteral">"\tHive=%08lx Cell=%08lx\n"</span>,Hive,Cell));
00735     }
00736     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == FALSE);
00737     <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
00738 
00739     <span class="comment">//</span>
00740     <span class="comment">// Get sizes and addresses</span>
00741     <span class="comment">//</span>
00742     Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, Cell);
00743     <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,Hive,Cell);
00744     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Cell);
00745 
00746     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)((Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a>) &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
00747     <a class="code" href="../../d6/d0/hive_8h.html#a1">DHvCheckBin</a>(Hive,Bin);
00748 
00749     freebase = <a class="code" href="../../d6/d0/hive_8h.html#a13">HvpGetHCell</a>(Hive, Cell);
00750 
00751     <span class="comment">//</span>
00752     <span class="comment">// go do actual frees, cannot fail from this point on</span>
00753     <span class="comment">//</span>
00754     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(freebase-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> &lt; 0);
00755     freebase-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> *= -1;
00756 
00757     savesize = freebase-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>;
00758 
00759     <span class="comment">//</span>
00760     <span class="comment">// Look for free neighbors and coalesce them.  We will never travel</span>
00761     <span class="comment">// around this loop more than twice.</span>
00762     <span class="comment">//</span>
00763     <span class="keywordflow">while</span> (
00764         <a class="code" href="../../d8/d0/hivecell_8c.html#a10">HvpIsFreeNeighbor</a>(
00765             Hive,
00766             Bin,
00767             freebase,
00768             &amp;neighbor,
00769             Type
00770             ) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00771         )
00772     {
00773 
00774         <span class="keywordflow">if</span> (neighbor &gt; freebase) {
00775 
00776             <span class="comment">//</span>
00777             <span class="comment">// Neighboring free cell is immediately above us in memory.</span>
00778             <span class="comment">//</span>
00779             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
00780                 tmp = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)neighbor + neighbor-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>);
00781                 <span class="keywordflow">if</span> ( ((ULONG)((ULONG_PTR)tmp - (ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>)) &lt; <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) {
00782                         tmp-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.Last = (ULONG)((ULONG_PTR)freebase - (ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>);
00783                 }
00784             }
00785             freebase-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> += neighbor-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>;
00786 
00787         } <span class="keywordflow">else</span> {
00788 
00789             <span class="comment">//</span>
00790             <span class="comment">// Neighboring free cell is immediately below us in memory.</span>
00791             <span class="comment">//</span>
00792 
00793             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
00794                 tmp = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)freebase + freebase-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>);
00795                 <span class="keywordflow">if</span> ( ((ULONG)((ULONG_PTR)tmp - (ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>)) &lt; <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a> ) {
00796                     tmp-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.Last = (ULONG)((ULONG_PTR)neighbor - (ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>);
00797                 }
00798             }
00799             neighbor-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> += freebase-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>;
00800             freebase = neighbor;
00801         }
00802     }
00803 
00804     <span class="comment">//</span>
00805     <span class="comment">// freebase now points to the biggest free cell we could make, none</span>
00806     <span class="comment">// of which is on the free list.  So put it on the list.</span>
00807     <span class="comment">//</span>
00808     newfreecell = (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>) +
00809                ((ULONG)((ULONG_PTR)freebase - (ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>)) +
00810                (Type*<a class="code" href="../../d0/d1/hivedata_8h.html#a7">HCELL_TYPE_MASK</a>);
00811 
00812     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d6/d0/hive_8h.html#a13">HvpGetHCell</a>(Hive, newfreecell) == freebase);
00813 
00814 <span class="preprocessor">#if DBG</span>
00815 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
00816         RtlFillMemory(
00817             &amp;(freebase-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.u.UserData),
00818             (freebase-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> - FIELD_OFFSET(<a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>, u.OldCell.u.UserData)),
00819             HCELL_FREE_FILL
00820             );
00821     } <span class="keywordflow">else</span> {
00822         RtlFillMemory(
00823             &amp;(freebase-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.NewCell.u.UserData),
00824             (freebase-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> - FIELD_OFFSET(<a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>, u.NewCell.u.UserData)),
00825             HCELL_FREE_FILL
00826             );
00827     }
00828 <span class="preprocessor">#endif</span>
</span>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="hivecell.c::HvGetCellSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LONG HvGetCellSize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Address</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00335">335</a> of file <a class="el" href="../../d9/d9/hivecell_8c-source.html">hivecell.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01087">CmpAddToLeaf()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00323">CmpCheckKey()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00588">CmpCheckValueList()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01009">CmpCopyCell()</a>, <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00403">CmpGetValueDataFromCache()</a>, <a class="el" href="../../d5/d2/cmtree_8c-source.html#l00200">CmpGetValueKeyFromCache()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01383">CmpSetValueKeyExisting()</a>, and <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01472">CmpSplitLeaf()</a>.
<p>
<pre class="fragment"><div>00346                    :
00347 
00348     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>, based on its MEMORY
00349     ADDRESS.  Must always call <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a> first to get that
00350     address.
00351 
00352     NOTE:   This should be a macro <span class="keywordflow">if</span> speed <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> issue.
00353 
00354     NOTE:   If you pass in some random pointer, you will get some
00355             random answer.  Only pass in valid <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> addresses.
00356 
00357 Arguments:
00358 
00359     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given cell
00360 
00361     Address - address in memory of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cell, returned by <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>()
00362 
00363 Return Value:
00364 
00365     Allocated size in bytes of the cell.
00366 
00367     If Negative, Cell is free, or Address is bogus.
00368 
00369 --*/
00370 {
00371     LONG    size;
00372 
00373     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_MAP) {
00374         KdPrint((<span class="stringliteral">"HvGetCellSize:\n"</span>));
00375         KdPrint((<span class="stringliteral">"\tAddress=%08lx\n"</span>, Address));
00376     }
00377 
00378     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
00379         size = ( (CONTAINING_RECORD(Address, <a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>, u.OldCell.u.UserData))-&gt;Size ) * -1;
00380         size -= FIELD_OFFSET(<a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>, u.OldCell.u.UserData);
00381     } <span class="keywordflow">else</span> {
        size = ( (CONTAINING_RECORD(Address, <a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>, u.NewCell.u.UserData))-&gt;Size ) * -1;
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="hivecell.c::HvIsCellAllocated" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN HvIsCellAllocated           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/hivecell_8c-source.html#l01453">1453</a> of file <a class="el" href="../../d9/d9/hivecell_8c-source.html">hivecell.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00136">Bin</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00423">_HMAP_ENTRY::BinAddress</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00616">_HHIVE::Flat</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00188">HBIN_NIL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00143">HCELL_PAD</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00111">HCELL_TYPE_MASK</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00566">HHIVE_SIGNATURE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00412">HMAP_BASE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00135">HvGetCellType</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00285">HvpGetCellMap()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00292">HvpGetHCell</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00593">_HHIVE::Signature</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00194">_HBIN::Size</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00164">_HCELL::Size</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d8/d4/struct__HCELL.html#o4">_HCELL::u</a>, and <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00161">USE_OLD_CELL</a>.
<p>
Referenced by <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00323">CmpCheckKey()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00588">CmpCheckValueList()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00186">CmpFindSubKeyByName()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01608">CmpMarkIndexDirty()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01714">CmpRemoveSubKey()</a>, and <a class="el" href="../../d3/d9/cmchek2_8c-source.html#l00034">CmpValidateHiveSecurityDescriptors()</a>.
<p>
<pre class="fragment"><div>01464                    :
01465 
01466     Report whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested cell <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allocated or not.
01467 
01468 Arguments:
01469 
01470     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - containing <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>.
01471 
01472     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - cel of interest
01473 
01474 Return Value:
01475 
01476     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> allocated, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> not.
01477 
01478 --*/
01479 {
01480     ULONG   Type;
01481     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>  Address;
01482     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>  Below;
01483     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> Me;
01484     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>   <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
01485     ULONG   <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01486     LONG    <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
01487 
01488 
01489     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> == HHIVE_SIGNATURE);
01490 
01491     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o13">Flat</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01492         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01493     }
01494 
01495     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Cell);
01496 
01497     <span class="keywordflow">if</span> ( ((<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> &amp; ~<a class="code" href="../../d0/d1/hivedata_8h.html#a7">HCELL_TYPE_MASK</a>) &gt; <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Length) || <span class="comment">// off end</span>
01498          (<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> % <a class="code" href="../../d0/d1/hivedata_8h.html#a20">HCELL_PAD</a>(Hive) != 0)                    <span class="comment">// wrong alignment</span>
01499        )
01500     {
01501         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01502     }
01503 
01504     Address = <a class="code" href="../../d6/d0/hive_8h.html#a13">HvpGetHCell</a>(Hive, Cell);
01505     Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, Cell);
01506     <span class="keywordflow">if</span> (Me == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01507         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01508     }
01509     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)((ULONG_PTR)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a>) &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
01510     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = (ULONG)((ULONG_PTR)Address - (ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>);
01511     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = Address-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> * -1;
01512 
01513     <span class="keywordflow">if</span> ( (Address-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> &gt; 0) ||                     <span class="comment">// not allocated</span>
01514          ((<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> + (ULONG)<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>) &gt; <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) ||    <span class="comment">// runs off bin, or too big</span>
01515          (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &lt; <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>))                    <span class="comment">// pts into bin header</span>
01516        )
01517     {
01518         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01519     }
01520 
01521     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
01522         <span class="keywordflow">if</span> (Address-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.Last != <a class="code" href="../../d0/d1/hivedata_8h.html#a25">HBIN_NIL</a>) {
01523 
01524             <span class="keywordflow">if</span> (Address-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.Last &gt; <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) {            <span class="comment">// bogus back pointer</span>
01525                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01526             }
01527 
01528             Below = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + Address-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.Last);
01529             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = (Below-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> &lt; 0) ?
01530                         Below-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> * -1 :
01531                         Below-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>;
01532 
01533             <span class="keywordflow">if</span> ( ((ULONG_PTR)Below + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>) != (ULONG_PTR)Address ) {    <span class="comment">// no pt back</span>
01534                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01535             }
01536         }
    }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="hivecell.c::HvpAllocateInBin" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG HvpAllocateInBin           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d4/struct__HBIN.html">PHBIN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Bin</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Size</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="hivecell.c::HvpDelistBinFreeCells" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID HvpDelistBinFreeCells           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d4/struct__HBIN.html">PHBIN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Bin</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/hivecell_8c-source.html#l01539">1539</a> of file <a class="el" href="../../d9/d9/hivecell_8c-source.html">hivecell.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>01552                    :
01553 
01554     If we are here, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive needs recovery.
01555 
01556     Walks through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entire bin and removes its free cells from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list.
01557     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bin <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> marked as free, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> just delist <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> freebins list.
01558 
01559 Arguments:
01560 
01561     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01562             hive of interest
01563 
01564     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a> of interest
01565 
01566     Type - <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a> vs. <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>
01567 
01568 Return Value:
01569 
01570     NONE.
01571 
01572 --*/
01573 {
01574     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>  p;
01575     ULONG   size;
01576     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
01577     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> Map;
01578     <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a> FreeBin;
01579     PLIST_ENTRY Entry;
01580 
01581     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>+(Type*<a class="code" href="../../d0/d1/hivedata_8h.html#a7">HCELL_TYPE_MASK</a>);
01582     Map = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, Cell);
01583     <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Map,Hive,Cell);
01584 
01585     <span class="comment">//</span>
01586     <span class="comment">// When loading, bins are always in separate chunks (each bin in it's owns chunk)</span>
01587     <span class="comment">//</span>
01588     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> == ((ULONG_PTR)Bin | HMAP_NEWALLOC) );
01589     
01590     <span class="keywordflow">if</span>( Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a36">HMAP_DISCARDABLE</a> ) {
01591         <span class="comment">//</span>
01592         <span class="comment">// The bin has been added to the freebins list</span>
01593         <span class="comment">// we have to take it out. No free cell from this bin is on the </span>
01594         <span class="comment">// freecells list, so we don't have to delist them.</span>
01595         <span class="comment">//</span>
01596 
01597         Entry = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].FreeBins.Flink;
01598         <span class="keywordflow">while</span> (Entry != &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].FreeBins) {
01599             FreeBin = CONTAINING_RECORD(Entry,
01600                                         <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">FREE_HBIN</a>,
01601                                         ListEntry);
01602 
01603             
01604             <span class="keywordflow">if</span>( FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a> == <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> ){
01605                 <span class="comment">//</span>
01606                 <span class="comment">// that's the bin we're looking for</span>
01607                 <span class="comment">//</span>
01608                 
01609                 <span class="comment">// sanity checks</span>
01610                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a> == <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a> );
01611                 <a class="code" href="../../d6/d0/hive_8h.html#a3">ASSERT_LISTENTRY</a>(&amp;FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o0">ListEntry</a>);
01612                 
01613                 RemoveEntryList(&amp;FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o0">ListEntry</a>);
01614                 (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(FreeBin, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">FREE_HBIN</a>));
01615                 <span class="keywordflow">return</span>;
01616             }
01617 
01618             <span class="comment">// advance to the new bin</span>
01619             Entry = Entry-&gt;Flink;
01620         }
01621 
01622         <span class="comment">// we shouldn't get here</span>
01623         <a class="code" href="../../d1/d2/cmp_8h.html#a64">CM_BUGCHECK</a>(REGISTRY_ERROR,14,(ULONG)Cell,(ULONG_PTR)Map,0);
01624         <span class="keywordflow">return</span>;
01625     }
01626 
01627     <span class="comment">//</span>
01628     <span class="comment">// Scan all the cells in the bin, total free and allocated, check</span>
01629     <span class="comment">// for impossible pointers.</span>
01630     <span class="comment">//</span>
01631     p = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>));
01632 
01633     <span class="keywordflow">while</span> (p &lt; (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>)) {
01634 
01635         <span class="comment">//</span>
01636         <span class="comment">// if free cell, remove it from the list of the hive</span>
01637         <span class="comment">//</span>
01638         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> &gt;= 0) {
01639 
01640             size = (ULONG)p-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>;
01641 
01642             <span class="comment">//</span>
01643             <span class="comment">// Enlist this free cell, but do not coalesce with the next free cell</span>
01644             <span class="comment">// as we haven't gotten that far yet.</span>
01645             <span class="comment">//</span>
01646             <a class="code" href="../../d8/d0/hivecell_8c.html#a19">HvpDelistFreeCell</a>(Hive, p, Type, TailDisplay);
01647 
01648         } <span class="keywordflow">else</span> {
01649 
01650             size = (ULONG)(p-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> * -1);
01651 
01652         }
01653 
01654         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(size &gt;= 0);
        p = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)p + size);
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="hivecell.c::HvpDelistFreeCell" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID HvpDelistFreeCell           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d8/d4/struct__HCELL.html">PHCELL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Pcell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/hivecell_8c-source.html#l01203">1203</a> of file <a class="el" href="../../d9/d9/hivecell_8c-source.html">hivecell.c</a>.
<p>
<pre class="fragment"><div>01216                    :
01217 
01218     Removes a free cell from its list, and clears <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Summary
01219     bit <span class="keywordflow">for</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <span class="keywordflow">if</span> need be.
01220 
01221 Arguments:
01222 
01223     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01224             hive of interest
01225 
01226     Pcell - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a> structure of interest
01227 
01228     Type - <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a> vs. <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>
01229 
01230 Return Value:
01231 
01232     NONE.
01233 
01234 --*/
01235 {
01236     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>;
01237     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Prev = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01238     ULONG       <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01239 
01240     <a class="code" href="../../d8/d0/hivecell_8c.html#a2">HvpComputeIndex</a>(Index, Pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>);
01241     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].FreeDisplay[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]);
01242 
01243     <span class="comment">//</span>
01244     <span class="comment">// Find previous cell on list</span>
01245     <span class="comment">//</span>
01246     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(*List != HCELL_NIL);
01247     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d0/hive_8h.html#a13">HvpGetHCell</a>(Hive,*List) != Pcell) {
01248         Prev = *<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>;
01249         <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> = (<a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,*List);
01250         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(*List != HCELL_NIL);
01251     }
01252 
01253     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(TailDisplay)) {
01254         <span class="comment">//</span>
01255         <span class="comment">// This should only happen once, at boot time; Then, we want to sort the list ascedending</span>
01256         <span class="comment">//</span>
01257         <span class="keywordflow">if</span>( *<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> == TailDisplay[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] ) {
01258             <span class="comment">//</span>
01259             <span class="comment">// this cell is also the last cell on list; so it should be reset</span>
01260             <span class="comment">//</span>
01261 
01262 <span class="preprocessor">#if DBG</span>
01263 <span class="preprocessor"></span>            <span class="comment">//</span>
01264             <span class="comment">// consistency checks</span>
01265             <span class="comment">//</span>
01266             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
01267                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.u.Next == HCELL_NIL);
01268             } <span class="keywordflow">else</span> {
01269                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.NewCell.u.Next == HCELL_NIL);
01270             }
01271 <span class="preprocessor">#endif</span>
01272 <span class="preprocessor"></span>
01273             TailDisplay[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = Prev;
01274         }
01275     }
01276 
01277     <span class="comment">//</span>
01278     <span class="comment">// Remove Pcell from list.</span>
01279     <span class="comment">//</span>
01280     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
01281         *<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> = Pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.u.Next;
01282     } <span class="keywordflow">else</span> {
01283         *<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> = Pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.NewCell.u.Next;
01284     }
01285 
01286     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].FreeDisplay[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01287         <span class="comment">//</span>
01288         <span class="comment">// consistency check</span>
01289         <span class="comment">//</span>
01290         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Prev == HCELL_NIL);
01291 
        <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].FreeSummary &amp;= ~(1 &lt;&lt; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>);
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="hivecell.c::HvpDoAllocateCell" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> HvpDoAllocateCell           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NewSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00463">463</a> of file <a class="el" href="../../d9/d9/hivecell_8c-source.html">hivecell.c</a>.
<p>
<pre class="fragment"><div>00475                    :
00476 
00477     Allocates space in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive.  Does not affect cell map in any way.
00478 
00479 Arguments:
00480 
00481     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00482             hive of interest
00483 
00484     NewSize - size in bytes of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cell to allocate
00485 
00486     Type - indicates whether <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a> or <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a> storage <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> desired.
00487 
00488 Return Value:
00489 
00490     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> of <span class="keyword">new</span> cell, <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a> <span class="keywordflow">if</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>
00491 
00492 --*/
00493 {
00494     ULONG       <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00495     ULONG       Summary;
00496     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> cell;
00497     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>      pcell;
00498     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> tcell;
00499     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>      ptcell;
00500     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>       <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00501     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> Me;
00502     ULONG       offset;
00503     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>      next;
00504     ULONG       MinFreeSize;
00505 
00506 
00507     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_HIVE) {
00508         KdPrint((<span class="stringliteral">"HvDoAllocateCell:\n"</span>));
00509         KdPrint((<span class="stringliteral">"\tHive=%08lx NewSize=%08lx Type=%08lx\n"</span>,Hive,NewSize,Type));
00510     }
00511     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == FALSE);
00512 
00513 
00514     <span class="comment">//</span>
00515     <span class="comment">// Compute Index into Display</span>
00516     <span class="comment">//</span>
00517     <a class="code" href="../../d8/d0/hivecell_8c.html#a2">HvpComputeIndex</a>(Index, NewSize);
00518 
00519     <span class="comment">//</span>
00520     <span class="comment">// Compute Summary vector of Display entries that are non null</span>
00521     <span class="comment">//</span>
00522     Summary = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].FreeSummary;
00523     Summary = Summary &amp; ~((1 &lt;&lt; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>) - 1);
00524 
00525     <span class="comment">//</span>
00526     <span class="comment">// We now have a summary of lists that are non-null and may</span>
00527     <span class="comment">// contain entries large enough to satisfy the request.</span>
00528     <span class="comment">// Iterate through the list and pull the first cell that is</span>
00529     <span class="comment">// big enough.  If no cells are big enough, advance to the</span>
00530     <span class="comment">// next non-null list.</span>
00531     <span class="comment">//</span>
00532 
00533     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(HHIVE_FREE_DISPLAY_SIZE == 24);
00534     <span class="keywordflow">while</span> (Summary != 0) {
00535         <span class="keywordflow">if</span> (Summary &amp; 0xff) {
00536             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d8/d0/hivecell_8c.html#a0">CmpFindFirstSetRight</a>[Summary &amp; 0xff];
00537         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Summary &amp; 0xff00) {
00538             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d8/d0/hivecell_8c.html#a0">CmpFindFirstSetRight</a>[(Summary &amp; 0xff00) &gt;&gt; 8] + 8;
00539         } <span class="keywordflow">else</span>  {
00540             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Summary &amp; 0xff0000);
00541             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d8/d0/hivecell_8c.html#a0">CmpFindFirstSetRight</a>[(Summary &amp; 0xff0000) &gt;&gt; 16] + 16;
00542         }
00543 
00544         <span class="comment">//</span>
00545         <span class="comment">// Walk through the list until we find a cell large enough</span>
00546         <span class="comment">// to satisfy the allocation.  If we find one, pull it from</span>
00547         <span class="comment">// the list and use it.  If we don't find one, clear this</span>
00548         <span class="comment">// list's bit in the Summary and try the next larger list.</span>
00549         <span class="comment">//</span>
00550 
00551         <span class="comment">//</span>
00552         <span class="comment">// look for a large enough cell in the list</span>
00553         <span class="comment">//</span>
00554         cell = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].FreeDisplay[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00555         <span class="keywordflow">while</span> (cell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00556 
00557             pcell = <a class="code" href="../../d6/d0/hive_8h.html#a13">HvpGetHCell</a>(Hive, cell);
00558 
00559             <span class="keywordflow">if</span> (NewSize &lt;= (ULONG)pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>) {
00560 
00561                 <span class="comment">//</span>
00562                 <span class="comment">// Found a big enough cell.</span>
00563                 <span class="comment">//</span>
00564                 <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, cell)) {
00565                     <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00566                 }
00567 
00568                 <a class="code" href="../../d8/d0/hivecell_8c.html#a19">HvpDelistFreeCell</a>(Hive, pcell, Type, NULL);
00569 
00570                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> &gt; 0);
00571                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(NewSize &lt;= (ULONG)pcell-&gt;Size);
00572                 <span class="keywordflow">goto</span> UseIt;
00573             }
00574 <span class="comment">//            DbgPrint("cell %08lx (%lx) too small (%d &lt; %d), trying next at",cell,pcell,pcell-&gt;Size,NewSize);</span>
00575             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
00576                 cell = pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.u.Next;
00577             } <span class="keywordflow">else</span> {
00578                 cell = pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.NewCell.u.Next;
00579             }
00580 <span class="comment">//          DbgPrint(" %08lx\n",cell);</span>
00581         }
00582 
00583         <span class="comment">//</span>
00584         <span class="comment">// No suitable cell was found on that list.</span>
00585         <span class="comment">// Clear the bit in the summary and try the</span>
00586         <span class="comment">// next biggest list.</span>
00587         <span class="comment">//</span>
00588 <span class="comment">//        DbgPrint("No suitable cell, Index %d, Summary %08lx -&gt; ",Index, Summary);</span>
00589         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Summary &amp; (1 &lt;&lt; Index));
00590         Summary = Summary &amp; ~(1 &lt;&lt; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>);
00591 <span class="comment">//        DbgPrint("%08lx\n",Summary);</span>
00592     }
00593 
00594     <span class="keywordflow">if</span> (Summary == 0) {
00595         <span class="comment">//</span>
00596         <span class="comment">// No suitable cells were found on any free list.</span>
00597         <span class="comment">//</span>
00598         <span class="comment">// Either there is no large enough cell, or we</span>
00599         <span class="comment">// have no free cells left at all.  In either case, allocate a</span>
00600         <span class="comment">// new bin, with a new free cell certain to be large enough in</span>
00601         <span class="comment">// it, and use that cell.</span>
00602         <span class="comment">//</span>
00603 
00604         <span class="comment">//</span>
00605         <span class="comment">// Attempt to create a new bin</span>
00606         <span class="comment">//</span>
00607         <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = <a class="code" href="../../d7/d0/hivebin_8c.html#a1">HvpAddBin</a>(Hive, NewSize, Type)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00608 
00609             <span class="comment">//</span>
00610             <span class="comment">// It worked.  Use single large cell in Bin.</span>
00611             <span class="comment">//</span>
00612             <a class="code" href="../../d6/d0/hive_8h.html#a1">DHvCheckBin</a>(Hive,Bin);
00613             cell = (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>) + <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>) + (Type*<a class="code" href="../../d0/d1/hivedata_8h.html#a7">HCELL_TYPE_MASK</a>);
00614             pcell = <a class="code" href="../../d6/d0/hive_8h.html#a13">HvpGetHCell</a>(Hive, cell);
00615         } <span class="keywordflow">else</span> {
00616             <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00617         }
00618     }
00619 
00620 UseIt:
00621 
00622     <span class="comment">//</span>
00623     <span class="comment">// cell refers to a free cell we have pulled from its list</span>
00624     <span class="comment">// if it is too big, give the residue back</span>
00625     <span class="comment">// ("too big" means there is at least one HCELL of extra space)</span>
00626     <span class="comment">// always mark it allocated</span>
00627     <span class="comment">// return it as our function value</span>
00628     <span class="comment">//</span>
00629 
00630     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> &gt; 0);
00631     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
00632         MinFreeSize = FIELD_OFFSET(<a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>, u.OldCell.u.Next) + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>);
00633     } <span class="keywordflow">else</span> {
00634         MinFreeSize = FIELD_OFFSET(<a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>, u.NewCell.u.Next) + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>);
00635     }
00636     <span class="keywordflow">if</span> ((NewSize + MinFreeSize) &lt; (ULONG)pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>) {
00637 
00638         <span class="comment">//</span>
00639         <span class="comment">// Crack the cell, use part we need, put rest on</span>
00640         <span class="comment">// free list.</span>
00641         <span class="comment">//</span>
00642         Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, cell);
00643         <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,Hive,cell);
00644         <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)((Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a>) &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
00645         offset = (ULONG)((ULONG_PTR)pcell - (ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>);
00646 
00647         ptcell = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)pcell + NewSize);
00648         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
00649             ptcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.Last = offset;
00650         }
00651         ptcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> = pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> - NewSize;
00652 
00653         <span class="keywordflow">if</span> ((offset + pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>) &lt; <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) {
00654             next = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)pcell + pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>);
00655             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
00656                 next-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.Last = offset + NewSize;
00657             }
00658         }
00659 
00660         pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> = NewSize;
00661         tcell = (<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>)((ULONG)cell + NewSize);
00662 
00663         <a class="code" href="../../d8/d0/hivecell_8c.html#a18">HvpEnlistFreeCell</a>(Hive, tcell, ptcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>, Type, TRUE,NULL);
00664     }
00665 
00666     <span class="comment">//</span>
00667     <span class="comment">// return the cell we found.</span>
00668     <span class="comment">//</span>
00669 <span class="preprocessor">#if DBG</span>
00670 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
00671         RtlFillMemory(
00672             &amp;(pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.u.UserData),
00673             (pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> - FIELD_OFFSET(<a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>, u.OldCell.u.UserData)),
00674             HCELL_ALLOCATE_FILL
00675             );
00676     } <span class="keywordflow">else</span> {
00677         RtlFillMemory(
00678             &amp;(pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.NewCell.u.UserData),
00679             (pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> - FIELD_OFFSET(<a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>, u.NewCell.u.UserData)),
00680             HCELL_ALLOCATE_FILL
00681             );
00682     }
<span class="preprocessor">#endif</span>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="hivecell.c::HvpEnlistFreeCell" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID HvpEnlistFreeCell           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Size</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>CoalesceForward</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00947">947</a> of file <a class="el" href="../../d9/d9/hivecell_8c-source.html">hivecell.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, and <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00649">HvpEnlistFreeCells()</a>.
<p>
<pre class="fragment"><div>00962                    :
00963 
00964     Puts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly freed cell on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate list.
00965 
00966 Arguments:
00967 
00968     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00969             hive of interest
00970 
00971     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - supplies index of cell to enlist
00972 
00973     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - size of cell
00974 
00975     Type - indicates whether <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a> or <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a> storage <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> desired.
00976 
00977     CoalesceForward - indicates whether we can coalesce forward or not.
00978         For <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">case</span> where we have not finished scanning <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive and
00979         enlisting free cells, we <span class="keywordflow">do</span> not want to coalesce forward.
00980 
00981 Return Value:
00982 
00983     NONE.
00984 
00985 --*/
00986 {
00987     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> Last;
00988     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> First;
00989     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> Map;
00990     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a> pcell;
00991     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a> pcellLast;
00992     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a> FirstCell;
00993     ULONG   <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00994     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>   <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00995     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> FreeCell;
00996     <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a> FreeBin;
00997     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>   FirstBin;
00998     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>   LastBin;
00999 
01000     <a class="code" href="../../d8/d0/hivecell_8c.html#a2">HvpComputeIndex</a>(Index, Size);
01001 
01002     
01003     First = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].FreeDisplay[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]);
01004     pcell = <a class="code" href="../../d6/d0/hive_8h.html#a13">HvpGetHCell</a>(Hive, Cell);
01005     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> &gt; 0);
01006     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Size == (ULONG)pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>);
01007 
01008     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(TailDisplay)) {
01009         <span class="comment">//</span>
01010         <span class="comment">// This should only happen once, at boot time; Then, we want to sort the list ascedending</span>
01011         <span class="comment">//</span>
01012         Last = &amp;TailDisplay[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01013         <span class="keywordflow">if</span>( *Last != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a> ) {
01014         <span class="comment">//</span>
01015         <span class="comment">// there is a last cell; insert current cell right after it.</span>
01016         <span class="comment">// and set the next cell pointer for the current cell to NIL</span>
01017         <span class="comment">//</span>
01018             pcellLast = <a class="code" href="../../d6/d0/hive_8h.html#a13">HvpGetHCell</a>(Hive,*Last);
01019             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pcellLast-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> &gt; 0);
01020 
01021             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
01022                 pcellLast-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.u.Next = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
01023                 pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.u.Next = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01024             } <span class="keywordflow">else</span> {
01025                 pcellLast-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.NewCell.u.Next = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
01026                 pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.NewCell.u.Next = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01027             }
01028         } <span class="keywordflow">else</span> {
01029         <span class="comment">//</span>
01030         <span class="comment">// No Last cell; Insert it at the begining and set the last cell pointing to it as well</span>
01031         <span class="comment">// Sanity check: First cell should be also NIL</span>
01032         <span class="comment">//</span>
01033             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( *First == HCELL_NIL );
01034 
01035             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
01036                 pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.u.Next = *First;
01037             } <span class="keywordflow">else</span> {
01038                 pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.NewCell.u.Next = *First;
01039             }
01040             *First = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
01041         }
01042         <span class="comment">//</span>
01043         <span class="comment">// The current cell becomes the last cell</span>
01044         <span class="comment">//</span>
01045         *Last = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
01046     } <span class="keywordflow">else</span> {
01047     <span class="comment">//</span>
01048     <span class="comment">// Normal case, insert the cell at the begining of the list (speed reasons).</span>
01049     <span class="comment">//</span>
01050         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
01051             pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.u.Next = *First;
01052         } <span class="keywordflow">else</span> {
01053             pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.NewCell.u.Next = *First;
01054         }
01055         *First = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
01056     }
01057 
01058 
01059     <span class="comment">//</span>
01060     <span class="comment">// Check to see if this is the first cell in the bin and if the entire</span>
01061     <span class="comment">// bin consists just of this cell.</span>
01062     <span class="comment">//</span>
01063     Map = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, Cell);
01064     <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Map,Hive,Cell);
01065     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; ~<a class="code" href="../../d0/d1/hivedata_8h.html#a35">HMAP_NEWALLOC</a>);
01066     <span class="keywordflow">if</span> ((pcell == (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)(<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + 1)) &amp;&amp;
01067         (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> == <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>-<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>))) {
01068 
01069         <span class="comment">//</span>
01070         <span class="comment">// We have a bin that is entirely free.  But we cannot do anything with it</span>
01071         <span class="comment">// unless the memalloc that contains the bin is entirely free.  Walk the</span>
01072         <span class="comment">// bins backwards until we find the first one in the alloc, then walk forwards</span>
01073         <span class="comment">// until we find the last one.  If any of the other bins in the memalloc</span>
01074         <span class="comment">// are not free, bail out.</span>
01075         <span class="comment">//</span>
01076         FirstBin = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
01077         <span class="keywordflow">while</span> (FirstBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a> == 0) {
01078             Map=<a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive,(FirstBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> - HBLOCK_SIZE) +
01079                                    (Type * HCELL_TYPE_MASK));
01080             <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Map,Hive,(FirstBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> - HBLOCK_SIZE) +(Type * HCELL_TYPE_MASK));
01081             FirstBin = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
01082             FirstCell = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)(FirstBin+1);
01083             <span class="keywordflow">if</span> ((ULONG)(FirstCell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>) != FirstBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>-<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>)) {
01084                 <span class="comment">//</span>
01085                 <span class="comment">// The first cell in the bin is either allocated, or not the only</span>
01086                 <span class="comment">// cell in the HBIN.  We cannot free any HBINs.</span>
01087                 <span class="comment">//</span>
01088                 <span class="keywordflow">goto</span> Done;
01089             }
01090         }
01091 
01092         <span class="comment">//</span>
01093         <span class="comment">// We can never discard the first bin of a hive as that always gets marked dirty</span>
01094         <span class="comment">// and written out.</span>
01095         <span class="comment">//</span>
01096         <span class="keywordflow">if</span> (FirstBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> == 0) {
01097             <span class="keywordflow">goto</span> Done;
01098         }
01099 
01100         LastBin = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
01101         <span class="keywordflow">while</span> (LastBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>+LastBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a> &lt; FirstBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>+FirstBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a>) {
01102             <span class="keywordflow">if</span> (!CoalesceForward) {
01103                 <span class="comment">//</span>
01104                 <span class="comment">// We are at the end of what's been built up. Just return and this</span>
01105                 <span class="comment">// will get freed up when the next HBIN is added.</span>
01106                 <span class="comment">//</span>
01107                 <span class="keywordflow">goto</span> Done;
01108             }
01109             Map = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, (LastBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>+LastBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) +
01110                                       (Type * HCELL_TYPE_MASK));
01111             <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Map,Hive,(LastBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>+LastBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) + (Type * HCELL_TYPE_MASK));
01112 
01113             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> != 0);
01114 
01115             LastBin = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
01116             FirstCell = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)(LastBin + 1);
01117             <span class="keywordflow">if</span> ((ULONG)(FirstCell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>) != LastBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>-<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>)) {
01118                 <span class="comment">//</span>
01119                 <span class="comment">// The first cell in the bin is either allocated, or not the only</span>
01120                 <span class="comment">// cell in the HBIN.  We cannot free any HBINs.</span>
01121                 <span class="comment">//</span>
01122                 <span class="keywordflow">goto</span> Done;
01123             }
01124         }
01125 
01126         <span class="comment">//</span>
01127         <span class="comment">// All the bins in this alloc are freed.  Coalesce all the bins into</span>
01128         <span class="comment">// one alloc-sized bin, then either discard the bin or mark it as</span>
01129         <span class="comment">// discardable.</span>
01130         <span class="comment">//</span>
01131         <span class="keywordflow">if</span> (FirstBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a> != FirstBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a>) {
01132             <span class="comment">//</span>
01133             <span class="comment">// Mark the first HBLOCK of the first HBIN dirty, since</span>
01134             <span class="comment">// we will need to update the on disk field for the bin size</span>
01135             <span class="comment">//</span>
01136             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/hivesync_8c.html#a9">HvMarkDirty</a>(Hive,
01137                              FirstBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> + (Type * HCELL_TYPE_MASK),
01138                              <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>) + <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>))) {
01139                 <span class="keywordflow">goto</span> Done;
01140             }
01141 
01142         }
01143 
01144 
01145         FreeBin = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">FREE_HBIN</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01146         <span class="keywordflow">if</span> (FreeBin == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01147             <span class="keywordflow">goto</span> Done;
01148         }
01149 
01150         <span class="comment">//</span>
01151         <span class="comment">// Walk through the bins and delist each free cell</span>
01152         <span class="comment">//</span>
01153         <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = FirstBin;
01154         <span class="keywordflow">do</span> {
01155             FirstCell = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)(<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>+1);
01156             <a class="code" href="../../d8/d0/hivecell_8c.html#a19">HvpDelistFreeCell</a>(Hive, FirstCell, Type, TailDisplay);
01157             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>==LastBin) {
01158                 <span class="keywordflow">break</span>;
01159             }
01160             Map = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>+<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>)+
01161                                       (Type * HCELL_TYPE_MASK));
01162             <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Map,Hive,(<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>+<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>)+(Type * HCELL_TYPE_MASK));
01163             <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
01164 
01165         } <span class="keywordflow">while</span> ( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01166 
01167         <span class="comment">//</span>
01168         <span class="comment">// Coalesce them all into one bin.</span>
01169         <span class="comment">//</span>
01170         FirstBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a> = FirstBin-&gt;MemAlloc;
01171 
01172         FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a> = FirstBin-&gt;Size;
01173         FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o2">FileOffset</a> = FirstBin-&gt;FileOffset;
01174         FirstCell = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)(FirstBin+1);
01175         FirstCell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> = FirstBin-&gt;Size - <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>);
01176         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
01177             FirstCell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.Last = (ULONG)<a class="code" href="../../d0/d1/hivedata_8h.html#a25">HBIN_NIL</a>;
01178         }
01179 
01180         InsertHeadList(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].FreeBins, &amp;FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o0">ListEntry</a>);
01181         <a class="code" href="../../d6/d0/hive_8h.html#a3">ASSERT_LISTENTRY</a>(&amp;FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o0">ListEntry</a>);
01182         <a class="code" href="../../d6/d0/hive_8h.html#a3">ASSERT_LISTENTRY</a>(FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o0">ListEntry</a>.Flink);
01183 
01184         FreeCell = FirstBin-&gt;FileOffset+(Type*<a class="code" href="../../d0/d1/hivedata_8h.html#a7">HCELL_TYPE_MASK</a>);
01185         FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o3">Flags</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a48">FREE_HBIN_DISCARDABLE</a>;
01186         <span class="keywordflow">while</span> (FreeCell-FirstBin-&gt;FileOffset &lt; FirstBin-&gt;Size) {
01187             Map = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, FreeCell);
01188             <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Map,Hive,FreeCell);
01189             <span class="keywordflow">if</span> (Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a35">HMAP_NEWALLOC</a>) {
01190                 Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> = (ULONG_PTR)FirstBin | <a class="code" href="../../d0/d1/hivedata_8h.html#a36">HMAP_DISCARDABLE</a> | <a class="code" href="../../d0/d1/hivedata_8h.html#a35">HMAP_NEWALLOC</a>;
01191             } <span class="keywordflow">else</span> {
01192                 Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> = (ULONG_PTR)FirstBin | <a class="code" href="../../d0/d1/hivedata_8h.html#a36">HMAP_DISCARDABLE</a>;
01193             }
01194             Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a> = (ULONG_PTR)FreeBin;
01195             FreeCell += <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
01196         }
01197     }
01198 

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="hivecell.c::HvpGetCellFlat" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> struct <a class="el" href="../../d4/d9/struct__CELL__DATA.html">_CELL_DATA</a>* HvpGetCellFlat           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00221">221</a> of file <a class="el" href="../../d9/d9/hivecell_8c-source.html">hivecell.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00158">HvInitializeHive()</a>.
<p>
<pre class="fragment"><div>00232                    :
00233 
00234     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory address <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>.  Will never
00235     <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>, but may assert.  Use <a class="code" href="../../d6/d0/hive_8h.html#a49">HvIsCellAllocated</a> to check
00236     validity of <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>.
00237 
00238     This routine should never be called directly, always call <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
00239     via <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>() macro.
00240 
00241     This routine provides GetCell support for read only hives with
00242     single allocation flat images.  Such hives do not have cell
00243     maps ("page tables"), instead, we compute addresses by
00244     arithmetic against the base image address.
00245 
00246     Such hives cannot have volatile cells.
00247 
00248 Arguments:
00249 
00250     Hive - supplies a pointer to the hive control structure for the
00251             hive of interest
00252 
00253     Cell - supplies HCELL_INDEX of cell to return address for
00254 
00255 Return Value:
00256 
00257     Address of Cell in memory.  Assert or BugCheck if error.
00258 
00259 --*/
00260 {
00261     PUCHAR          base;
00262     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>          pcell;
00263 
00264     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_MAP) {
00265         KdPrint((<span class="stringliteral">"HvGetCellFlat:\n"</span>));
00266         KdPrint((<span class="stringliteral">"\tHive=%08lx Cell=%08lx\n"</span>,Hive,Cell));
00267     }
00268     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> == HHIVE_SIGNATURE);
00269     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Cell != HCELL_NIL);
00270     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o13">Flat</a> == TRUE);
00271     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Cell) == Stable);
00272     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Cell &gt;= <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>));
00273     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Cell &lt; Hive-&gt;BaseBlock-&gt;Length);
00274     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((Cell &amp; 0x7)==0);
00275 
00276     <span class="comment">//</span>
00277     <span class="comment">// Address is base of Hive image + Cell</span>
00278     <span class="comment">//</span>
00279     base = (PUCHAR)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>) + <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00280     pcell = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)(base + <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00281     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
        <span class="keywordflow">return</span> (<span class="keyword">struct </span><a class="code" href="../../d4/d9/struct__CELL__DATA.html">_CELL_DATA</a> *)&amp;(pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.u.UserData);
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="hivecell.c::HvpGetCellMap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> HvpGetCellMap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00285">285</a> of file <a class="el" href="../../d9/d9/hivecell_8c-source.html">hivecell.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/hivechek_8c-source.html#l00054">HvCheckHive()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d3/d0/hivefree_8c-source.html#l00034">HvFreeHive()</a>, <a class="el" href="../../d3/d0/hivefree_8c-source.html#l00160">HvFreeHivePartial()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00200">HvIsBinDirty()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l01453">HvIsCellAllocated()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00117">HvMarkCellDirty()</a>, <a class="el" href="../../d8/d9/hivebin_8c-source.html#l00046">HvpAddBin()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00047">HvpBuildMapAndCopy()</a>, <a class="el" href="../../d8/d9/hivebin_8c-source.html#l00434">HvpCoalesceDiscardedBins()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01885">HvpDiscardBins()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00775">HvpDoWriteHive()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00437">HvpEnlistBinInMap()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01233">HvpFindNextDirtyBlock()</a>, <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00847">HvpRecoverData()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01946">HvpTruncateBins()</a>, and <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01584">HvRefreshHive()</a>.
<p>
<pre class="fragment"><div>00296                    :
00297 
00298     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">HMAP_ENTRY</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cell.
00299 
00300 Arguments:
00301 
00302     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00303             hive of interest
00304 
00305     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - supplies <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> of cell to <span class="keywordflow">return</span> map entry address <span class="keywordflow">for</span>
00306 
00307 Return Value:
00308 
00309     Address of MAP_ENTRY in memory.  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> no such cell or other error.
00310 
00311 --*/
00312 {
00313     ULONG           Type;
00314     ULONG           Table;
00315     ULONG           Block;
00316     <a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">PHMAP_TABLE</a>     ptab;
00317 
00318     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_MAP) {
00319         KdPrint((<span class="stringliteral">"HvpGetCellMapPaged:\n"</span>));
00320         KdPrint((<span class="stringliteral">"\tHive=%08lx Cell=%08lx\n"</span>,Hive,Cell));
00321     }
00322     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> == HHIVE_SIGNATURE);
00323     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o13">Flat</a> == FALSE);
00324     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((Cell &amp; (<a class="code" href="../../d0/d1/hivedata_8h.html#a20">HCELL_PAD</a>(Hive)-1))==0);
00325 
00326     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Cell);
00327     Table = (<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a9">HCELL_TABLE_MASK</a>) &gt;&gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a10">HCELL_TABLE_SHIFT</a>;
00328     Block = (<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a11">HCELL_BLOCK_MASK</a>) &gt;&gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a12">HCELL_BLOCK_SHIFT</a>;
00329 
00330     <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - (Type * <a class="code" href="../../d0/d1/hivedata_8h.html#a7">HCELL_TYPE_MASK</a>)) &gt;= <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Length) {
00331         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
    }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="hivecell.c::HvpGetCellPaged" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> struct <a class="el" href="../../d4/d9/struct__CELL__DATA.html">_CELL_DATA</a>* HvpGetCellPaged           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00146">146</a> of file <a class="el" href="../../d9/d9/hivecell_8c-source.html">hivecell.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00345">ASSERT_CM_LOCK_OWNED</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00423">_HMAP_ENTRY::BinAddress</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00417">_HMAP_ENTRY::BlockAddress</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00255">CMS_MAP</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00616">_HHIVE::Flat</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00117">HCELL_BLOCK_MASK</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00118">HCELL_BLOCK_SHIFT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00120">HCELL_OFFSET_MASK</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00143">HCELL_PAD</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00114">HCELL_TABLE_MASK</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00115">HCELL_TABLE_SHIFT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00111">HCELL_TYPE_MASK</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00566">HHIVE_SIGNATURE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00412">HMAP_BASE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00414">HMAP_DISCARDABLE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00135">HvGetCellType</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00593">_HHIVE::Signature</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d8/d4/struct__HCELL.html#o4">_HCELL::u</a>, and <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00161">USE_OLD_CELL</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00158">HvInitializeHive()</a>.
<p>
<pre class="fragment"><div>00157                    :
00158 
00159     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory address <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>.  Will never
00160     <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>, but may assert.  Use <a class="code" href="../../d6/d0/hive_8h.html#a49">HvIsCellAllocated</a> to check
00161     validity of <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>.
00162 
00163     This routine should never be called directly, always call <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
00164     via <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>() macro.
00165 
00166     This routine provides GetCell support for hives with full maps.
00167     It is the normal version of the routine.
00168 
00169 Arguments:
00170 
00171     Hive - supplies a pointer to the hive control structure for the
00172             hive of interest
00173 
00174     Cell - supplies HCELL_INDEX of cell to return address for
00175 
00176 Return Value:
00177 
00178     Address of Cell in memory.  Assert or BugCheck if error.
00179 
00180 --*/
00181 {
00182     ULONG           Type;
00183     ULONG           Table;
00184     ULONG           Block;
00185     ULONG           <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00186     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>          pcell;
00187     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a>     Map;
00188 
00189     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_MAP) {
00190         KdPrint((<span class="stringliteral">"HvGetCellPaged:\n"</span>));
00191         KdPrint((<span class="stringliteral">"\tHive=%08lx Cell=%08lx\n"</span>,Hive,Cell));
00192     }
00193     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> == HHIVE_SIGNATURE);
00194     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Cell != HCELL_NIL);
00195     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o13">Flat</a> == FALSE);
00196     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((Cell &amp; (<a class="code" href="../../d0/d1/hivedata_8h.html#a20">HCELL_PAD</a>(Hive)-1))==0);
00197     <a class="code" href="../../d1/d2/cmp_8h.html#a61">ASSERT_CM_LOCK_OWNED</a>();
00198 <span class="preprocessor">    #if DBG</span>
00199 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Cell) == <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>) {
00200             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Cell &gt;= <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>));
00201         } <span class="keywordflow">else</span> {
00202             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Cell &gt;= (HCELL_TYPE_MASK + <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>)));
00203         }
00204 <span class="preprocessor">    #endif</span>
00205 <span class="preprocessor"></span>
00206     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Cell);
00207     Table = (<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a9">HCELL_TABLE_MASK</a>) &gt;&gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a10">HCELL_TABLE_SHIFT</a>;
00208     Block = (<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a11">HCELL_BLOCK_MASK</a>) &gt;&gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a12">HCELL_BLOCK_SHIFT</a>;
00209     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = (<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a13">HCELL_OFFSET_MASK</a>);
00210 
00211     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((Cell - (Type * HCELL_TYPE_MASK)) &lt; <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Length);
00212 
00213     Map = &amp;((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Map)-&gt;Directory[Table]-&gt;Table[Block]);
00214     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; HMAP_BASE) != 0);
00215     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; HMAP_DISCARDABLE) == 0);
00216     pcell = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((ULONG_PTR)(Map-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a>) + <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>);
00217     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
        <span class="keywordflow">return</span> (<span class="keyword">struct </span><a class="code" href="../../d4/d9/struct__CELL__DATA.html">_CELL_DATA</a> *)&amp;(pcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o4">u</a>.OldCell.u.UserData);
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="hivecell.c::HvpIsFreeNeighbor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN HvpIsFreeNeighbor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d4/struct__HBIN.html">PHBIN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Bin</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d8/d4/struct__HCELL.html">PHCELL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FreeCell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d8/d4/struct__HCELL.html">PHCELL</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>FreeNeighbor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00832">832</a> of file <a class="el" href="../../d9/d9/hivecell_8c-source.html">hivecell.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>.
<p>
<pre class="fragment"><div>00846                    :
00847 
00848     Reports on whether FreeCell has at least one free neighbor and
00849     <span class="keywordflow">if</span> so where.  Free neighbor will be cut <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> free list.
00850 
00851 Arguments:
00852 
00853     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - hive we're working on
00854 
00855     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> - pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> storage bin
00856 
00857     FreeCell - supplies a pointer to a cell that has been freed, or
00858                 <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> result of a coalesce.
00859 
00860     FreeNeighbor - supplies a pointer to a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address
00861                     of a free neigbhor of FreeCell, <span class="keywordflow">if</span> such exists
00862 
00863     Type - storage <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cell
00864 
00865 Return Value:
00866 
00867     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> a free neighbor was found, <span class="keywordflow">else</span> <span class="keyword">false</span>.
00868 
00869 
00870 --*/
00871 {
00872     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>  ptcell;
00873 
00874     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_HIVE) {
00875         KdPrint((<span class="stringliteral">"HvpIsFreeNeighbor:\n\tBin=%08lx"</span>,Bin));
00876         KdPrint((<span class="stringliteral">"FreeCell=%08lx\n"</span>, FreeCell));
00877     }
00878     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == FALSE);
00879 
00880     <span class="comment">//</span>
00881     <span class="comment">// Neighbor above us?</span>
00882     <span class="comment">//</span>
00883     *FreeNeighbor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00884     ptcell = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)FreeCell + FreeCell-&gt;Size);
00885     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ((ULONG)((ULONG_PTR)ptcell - (ULONG_PTR)Bin)) &lt;= <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>);
00886     <span class="keywordflow">if</span> (((ULONG)((ULONG_PTR)ptcell - (ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>)) &lt; <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) {
00887         <span class="keywordflow">if</span> (ptcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> &gt; 0) {
00888             *FreeNeighbor = ptcell;
00889             <span class="keywordflow">goto</span> FoundNeighbor;
00890         }
00891     }
00892 
00893     <span class="comment">//</span>
00894     <span class="comment">// Neighbor below us?</span>
00895     <span class="comment">//</span>
00896     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
00897         <span class="keywordflow">if</span> (FreeCell-&gt;u.OldCell.Last != <a class="code" href="../../d0/d1/hivedata_8h.html#a25">HBIN_NIL</a>) {
00898             ptcell = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + FreeCell-&gt;u.OldCell.Last);
00899             <span class="keywordflow">if</span> (ptcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> &gt; 0) {
00900                 *FreeNeighbor = ptcell;
00901                 <span class="keywordflow">goto</span> FoundNeighbor;
00902             }
00903         }
00904     } <span class="keywordflow">else</span> {
00905         ptcell = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)(<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>+1);
00906         <span class="keywordflow">while</span> (ptcell &lt; FreeCell) {
00907 
00908             <span class="comment">//</span>
00909             <span class="comment">// scan through the cells from the start of the bin looking for neighbor.</span>
00910             <span class="comment">//</span>
00911             <span class="keywordflow">if</span> (ptcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> &gt; 0) {
00912 
00913                 <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)ptcell + ptcell-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>) == FreeCell) {
00914                     *FreeNeighbor = ptcell;
00915                     <span class="comment">//</span>
00916                     <span class="comment">// Try and mark it dirty, since we will be changing</span>
00917                     <span class="comment">// the size field.  If this fails, ignore</span>
00918                     <span class="comment">// the free neighbor, we will not fail the free</span>
00919                     <span class="comment">// just because we couldn't mark the cell dirty</span>
00920                     <span class="comment">// so it could be coalesced.</span>
00921                     <span class="comment">//</span>
00922                     <span class="comment">// Note we only bother doing this for new hives,</span>
00923                     <span class="comment">// for old format hives we always mark the whole</span>
00924                     <span class="comment">// bin dirty.</span>
00925                     <span class="comment">//</span>
00926                     <span class="keywordflow">if</span> ((Type == <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>) ||
00927                         (<a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, (ULONG)((ULONG_PTR)ptcell-(ULONG_PTR)Bin) + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>))) {
00928                         <span class="keywordflow">goto</span> FoundNeighbor;
00929                     } <span class="keywordflow">else</span> {
00930                         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00931                     }
00932 
00933                 } <span class="keywordflow">else</span> {
00934                     ptcell = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)ptcell + ptcell-&gt;Size);
00935                 }
00936             } <span class="keywordflow">else</span> {
00937                 ptcell = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)ptcell - ptcell-&gt;Size);
00938             }
00939         }
00940     }
00941 
00942     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00943 
FoundNeighbor:
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="hivecell.c::HvpMakeBinPresent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN HvpMakeBinPresent           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Map</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="hivecell.c::HvReallocateCell" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> HvReallocateCell           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NewSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/hivecell_8c-source.html#l01295">1295</a> of file <a class="el" href="../../d9/d9/hivecell_8c-source.html">hivecell.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00092">CmDeleteValueKey()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01087">CmpAddToLeaf()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01150">CmpMergeKeyValues()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00397">CmpSetSecurityDescriptorInfo()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l01619">CmpSetValueKeyNew()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01472">CmpSplitLeaf()</a>, and <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00097">CmRestoreKey()</a>.
<p>
<pre class="fragment"><div>01307                    :
01308 
01309     Grows or shrinks a cell.
01310 
01311     NOTE:
01312 
01313         MUST NOT FAIL <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cell <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> smaller.  Can be
01314         a noop, but must work.
01315 
01316     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>:
01317 
01318         If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cell <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> grown, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will get a NEW and DIFFERENT <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>!!!
01319 
01320 Arguments:
01321 
01322     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01323             hive of interest
01324 
01325     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - supplies index of cell to grow or shrink
01326 
01327     NewSize - desired size of cell  (<span class="keyword">this</span> is an absolute size, not an
01328             increment or decrement.)
01329 
01330 Return Value:
01331 
01332     New HCELL_INDEX <span class="keywordflow">for</span> cell, or HCELL_NIL <span class="keywordflow">if</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
01333 
01334     If <span class="keywordflow">return</span> is HCELL_NIL, either old cell did not exist, or it did exist
01335     and we could not make a <span class="keyword">new</span> one.  In either <span class="keywordflow">case</span>, nothing has changed.
01336 
01337     If <span class="keywordflow">return</span> is NOT HCELL_NIL, then it is the HCELL_INDEX <span class="keywordflow">for</span> the Cell,
01338     which very probably <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a100">moved</a>.
01339 
01340 --*/
01341 {
01342     PUCHAR      oldaddress;
01343     LONG        oldsize;
01344     ULONG       oldalloc;
01345     HCELL_INDEX NewCell;            <span class="comment">// return value</span>
01346     PUCHAR      newaddress;
01347     ULONG       Type;
01348 
01349     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_HIVE) {
01350         KdPrint((<span class="stringliteral">"HvReallocateCell:\n"</span>));
01351         KdPrint((<span class="stringliteral">"\tHive=%08lx  Cell=%08lx  NewSize=%08lx\n"</span>,Hive,Cell,NewSize));
01352     }
01353     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> == HHIVE_SIGNATURE);
01354     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == FALSE);
01355     <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
01356 
01357     <span class="comment">//</span>
01358     <span class="comment">// Make room for overhead fields and round up to HCELL_PAD boundary</span>
01359     <span class="comment">//</span>
01360     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
01361         NewSize += FIELD_OFFSET(<a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>, u.OldCell.u.UserData);
01362     } <span class="keywordflow">else</span> {
01363         NewSize += FIELD_OFFSET(<a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>, u.NewCell.u.UserData);
01364     }
01365     NewSize = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(NewSize, <a class="code" href="../../d0/d1/hivedata_8h.html#a20">HCELL_PAD</a>(Hive));
01366 
01367     <span class="comment">// </span>
01368     <span class="comment">// Adjust the size (an easy fix for granularity)</span>
01369     <span class="comment">//</span>
01370     <a class="code" href="../../d8/d0/hivecell_8c.html#a4">HvpAdjustCellSize</a>(NewSize);
01371 
01372     <span class="comment">//</span>
01373     <span class="comment">// reject impossible/unreasonable values</span>
01374     <span class="comment">//</span>
01375     <span class="keywordflow">if</span> (NewSize &gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a0">HSANE_CELL_MAX</a>) {
01376         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_HIVE) {
01377             KdPrint((<span class="stringliteral">"\tNewSize=%08lx\n"</span>, NewSize));
01378         }
01379         <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01380     }
01381 
01382     <span class="comment">//</span>
01383     <span class="comment">// Get sizes and addresses</span>
01384     <span class="comment">//</span>
01385     oldaddress = (PUCHAR)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Cell);
01386     oldsize = <a class="code" href="../../d8/d0/hivecell_8c.html#a15">HvGetCellSize</a>(Hive, oldaddress);
01387     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(oldsize &gt; 0);
01388     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a23">USE_OLD_CELL</a>(Hive)) {
01389         oldalloc = (ULONG)(oldsize + FIELD_OFFSET(<a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>, u.OldCell.u.UserData));
01390     } <span class="keywordflow">else</span> {
01391         oldalloc = (ULONG)(oldsize + FIELD_OFFSET(<a class="code" href="../../d8/d4/struct__HCELL.html">HCELL</a>, u.NewCell.u.UserData));
01392     }
01393     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Cell);
01394 
01395     <a class="code" href="../../d6/d0/hive_8h.html#a0">DHvCheckHive</a>(Hive);
01396 
01397     <span class="keywordflow">if</span> (NewSize == oldalloc) {
01398 
01399         <span class="comment">//</span>
01400         <span class="comment">// This is a noop, return the same cell</span>
01401         <span class="comment">//</span>
01402         NewCell = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
01403 
01404     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NewSize &lt; oldalloc) {
01405 
01406         <span class="comment">//</span>
01407         <span class="comment">// This is a shrink.</span>
01408         <span class="comment">//</span>
01409         <span class="comment">// PERFNOTE - IMPLEMENT THIS.  Do nothing for now.</span>
01410         <span class="comment">//</span>
01411         NewCell = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
01412 
01413     } <span class="keywordflow">else</span> {
01414 
01415         <span class="comment">//</span>
01416         <span class="comment">// This is a grow.</span>
01417         <span class="comment">//</span>
01418 
01419         <span class="comment">//</span>
01420         <span class="comment">// PERFNOTE - Someday we want to detect that there is a free neighbor</span>
01421         <span class="comment">//          above us and grow into that neighbor if possible.</span>
01422         <span class="comment">//          For now, always do the allocate, copy, free gig.</span>
01423         <span class="comment">//</span>
01424 
01425         <span class="comment">//</span>
01426         <span class="comment">// Allocate a new block of memory to hold the cell</span>
01427         <span class="comment">//</span>
01428 
01429         <span class="keywordflow">if</span> ((NewCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a7">HvpDoAllocateCell</a>(Hive, NewSize, Type)) == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01430             <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01431         }
01432         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d0/hivecell_8c.html#a21">HvIsCellAllocated</a>(Hive, NewCell));
01433         newaddress = (PUCHAR)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, NewCell);
01434 
01435         <span class="comment">//</span>
01436         <span class="comment">// oldaddress points to the old data block for the cell,</span>
01437         <span class="comment">// newaddress points to the new data block, copy the data</span>
01438         <span class="comment">//</span>
01439         RtlMoveMemory(newaddress, oldaddress, oldsize);
01440 
01441         <span class="comment">//</span>
01442         <span class="comment">// Free the old block of memory</span>
01443         <span class="comment">//</span>
01444         <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, Cell);
    }
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a6" doxytag="hivecell.c::KiFindFirstSetLeft" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> CCHAR <a class="el" href="../../d0/d0/ki_8h.html#a45">KiFindFirstSetLeft</a>[256]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00077">77</a> of file <a class="el" href="../../d9/d9/hivecell_8c-source.html">hivecell.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01690">KiFindFirstSetLeftBit()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="hivecell.c::KiFindFirstSetRight" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> CCHAR <a class="el" href="../../d5/d9/kernldat_8c.html#a39">KiFindFirstSetRight</a>[256]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00075">75</a> of file <a class="el" href="../../d9/d9/hivecell_8c-source.html">hivecell.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/mtrr_8c-source.html#l01669">KiFindFirstSetRightBit()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:05 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
