<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cursor.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cursor.c</h1><a href="../../d7/d1/ntuser_2kernel_2cursor_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: cursor.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains code for dealing with cursors.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 03-Dec-1990 DavidPe   Created.</span>
00010 <span class="comment">* 01-Feb-1991 MikeKe    Added Revalidation code (None)</span>
00011 <span class="comment">* 12-Feb-1991 JimA      Added access checks</span>
00012 <span class="comment">* 21-Jan-1992 IanJa     ANSI/Unicode neutralized (null op)</span>
00013 <span class="comment">* 02-Aug-1992 DarrinM   Added animated cursor code</span>
00014 <span class="comment">\***************************************************************************/</span>
00015 
00016 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00017 <span class="preprocessor">#pragma hdrstop</span>
00018 <span class="preprocessor"></span>
00019 <span class="comment">/***************************************************************************\</span>
00020 <span class="comment">* zzzSetCursor (API)</span>
00021 <span class="comment">*</span>
00022 <span class="comment">* This API sets the cursor image for the current thread.</span>
00023 <span class="comment">*</span>
00024 <span class="comment">* History:</span>
00025 <span class="comment">* 12-03-90 DavidPe      Created.</span>
00026 <span class="comment">\***************************************************************************/</span>
00027 
<a name="l00028"></a><a class="code" href="../../d4/d1/userk_8h.html#a1785">00028</a> <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> <a class="code" href="../../d4/d1/userk_8h.html#a1785">zzzSetCursor</a>(
00029     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcur)
00030 {
00031     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a>      pq;
00032     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcurPrev;
00033     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>  ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00034 
00035     pq = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>;
00036 
00037     pcurPrev = pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o19">spcurCurrent</a>;
00038 
00039     <span class="keywordflow">if</span> (pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o19">spcurCurrent</a> != pcur) {
00040 
00041         <span class="comment">/*</span>
00042 <span class="comment">         * Lock() returns pobjOld - if it is still valid.  Don't want to</span>
00043 <span class="comment">         * return a pcurPrev that is an invalid pointer.</span>
00044 <span class="comment">         */</span>
00045         pcurPrev = <a class="code" href="../../d4/d1/userk_8h.html#a599">LockQCursor</a>(pq, pcur);
00046 
00047         <span class="comment">/*</span>
00048 <span class="comment">         * If no thread 'owns' the cursor, we must be in initialization</span>
00049 <span class="comment">         * so go ahead and assign it to ourself.</span>
00050 <span class="comment">         */</span>
00051         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a31">gpqCursor</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00052             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a31">gpqCursor</a> = pq;
00053 
00054         <span class="comment">/*</span>
00055 <span class="comment">         * If we're changing the local-cursor for the thread currently</span>
00056 <span class="comment">         * representing the global-cursor, update the cursor image now.</span>
00057 <span class="comment">         */</span>
00058         <span class="keywordflow">if</span> (pq == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a31">gpqCursor</a>) {
00059             <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpcur;
00060             <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pcurPrev, &amp;tlpcur);
00061             <a class="code" href="../../d7/d1/ntuser_2kernel_2cursor_8c.html#a11">zzzUpdateCursorImage</a>();
00062             pcurPrev = <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpcur);
00063         }
00064     }
00065 
00066     <span class="keywordflow">return</span> pcurPrev;
00067 }
00068 
00069 <span class="comment">/***************************************************************************\</span>
00070 <span class="comment">* zzzSetCursorPos (API)</span>
00071 <span class="comment">*</span>
00072 <span class="comment">* This API sets the cursor position.</span>
00073 <span class="comment">*</span>
00074 <span class="comment">* History:</span>
00075 <span class="comment">* 03-Dec-1990 DavidPe  Created.</span>
00076 <span class="comment">* 12-Feb-1991 JimA     Added access check</span>
00077 <span class="comment">* 16-May-1991 mikeke   Changed to return BOOL</span>
00078 <span class="comment">\***************************************************************************/</span>
00079 
<a name="l00080"></a><a class="code" href="../../d4/d1/userk_8h.html#a1786">00080</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1786">zzzSetCursorPos</a>(
00081     <span class="keywordtype">int</span> x,
00082     <span class="keywordtype">int</span> y)
00083 {
00084     <span class="comment">/*</span>
00085 <span class="comment">     * Blow it off if the caller doesn't have the proper access rights</span>
00086 <span class="comment">     */</span>
00087     <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d5/w32_2ntuser_2kernel_2security_8c.html#a9">CheckWinstaWriteAttributesAccess</a>()) {
00088         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00089     }
00090 
00091     <a class="code" href="../../d4/d1/userk_8h.html#a1179">zzzInternalSetCursorPos</a>(x, y);
00092 
00093     <span class="comment">/*</span>
00094 <span class="comment">     * Save the absolute coordinates in the global array</span>
00095 <span class="comment">     * for GetMouseMovePointsEx.</span>
00096 <span class="comment">     */</span>
00097     <a class="code" href="../../d4/d1/userk_8h.html#a152">SAVEPOINT</a>(x, y,
00098               <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXVIRTUALSCREEN) - 1,
00099               <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYVIRTUALSCREEN) - 1,
00100               <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>(), 0);
00101 
00102     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00103 }
00104 
00105 <span class="comment">/***************************************************************************\</span>
00106 <span class="comment">* zzzInternalSetCursorPos</span>
00107 <span class="comment">*</span>
00108 <span class="comment">* This function is used whenever the server needs to set the cursor</span>
00109 <span class="comment">* position, regardless of the caller's access rights.</span>
00110 <span class="comment">*</span>
00111 <span class="comment">* History:</span>
00112 <span class="comment">* 12-Feb-1991 JimA      Created.</span>
00113 <span class="comment">\***************************************************************************/</span>
<a name="l00114"></a><a class="code" href="../../d4/d1/userk_8h.html#a1179">00114</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1179">zzzInternalSetCursorPos</a>(
00115     <span class="keywordtype">int</span>      x,
00116     <span class="keywordtype">int</span>      y
00117     )
00118 {
00119 
00120     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a79">gptCursorAsync</a>.x = x;
00121     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a79">gptCursorAsync</a>.y = y;
00122 
00123     <a class="code" href="../../d4/d1/userk_8h.html#a1182">BoundCursor</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a79">gptCursorAsync</a>);
00124     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a79">gptCursorAsync</a>;
00125     GreMovePointer(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor.x, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor.y);
00126 
00127     <span class="comment">/*</span>
00128 <span class="comment">     * Cursor has changed position, so generate a mouse event so the</span>
00129 <span class="comment">     * window underneath the new location knows it's there and sets the</span>
00130 <span class="comment">     * shape accordingly.</span>
00131 <span class="comment">     */</span>
00132     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a32">zzzSetFMouseMoved</a>();
00133 }
00134 
00135 <span class="comment">/***************************************************************************\</span>
00136 <span class="comment">* IncCursorLevel</span>
00137 <span class="comment">* DecCursorLevel</span>
00138 <span class="comment">*</span>
00139 <span class="comment">* Keeps track of this thread show/hide cursor level as well as the queue</span>
00140 <span class="comment">* it is associated with. Thread levels are done so that when</span>
00141 <span class="comment">* AttachThreadInput() is called we can do exact level calculations in the</span>
00142 <span class="comment">* new queue.</span>
00143 <span class="comment">*</span>
00144 <span class="comment">* 15-Jan-1993 ScottLu   Created.</span>
00145 <span class="comment">\***************************************************************************/</span>
00146 
<a name="l00147"></a><a class="code" href="../../d7/d1/ntuser_2kernel_2cursor_8c.html#a3">00147</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d7/d1/ntuser_2kernel_2cursor_8c.html#a3">IncCursorLevel</a>(
00148     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti)
00149 {
00150     pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o37">iCursorLevel</a>++;
00151     pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o20">iCursorLevel</a>++;
00152 }
00153 
<a name="l00154"></a><a class="code" href="../../d7/d1/ntuser_2kernel_2cursor_8c.html#a4">00154</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d7/d1/ntuser_2kernel_2cursor_8c.html#a4">DecCursorLevel</a>(
00155     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti)
00156 {
00157     pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o37">iCursorLevel</a>--;
00158     pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o20">iCursorLevel</a>--;
00159 }
00160 
00161 <span class="comment">/***************************************************************************\</span>
00162 <span class="comment">* zzzShowCursor (API)</span>
00163 <span class="comment">*</span>
00164 <span class="comment">* This API allows the application to hide or show the cursor image.</span>
00165 <span class="comment">*</span>
00166 <span class="comment">* History:</span>
00167 <span class="comment">* 03-Dec-1990 JimA      Implemented for fake cursor stuff</span>
00168 <span class="comment">\***************************************************************************/</span>
00169 
<a name="l00170"></a><a class="code" href="../../d4/d1/userk_8h.html#a1787">00170</a> <span class="keywordtype">int</span> <a class="code" href="../../d4/d1/userk_8h.html#a1787">zzzShowCursor</a>(
00171     BOOL fShow)
00172 {
00173     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00174     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a>          pq;
00175     <span class="keywordtype">int</span>         iCursorLevel;
00176 
00177     pq = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>;
00178     <span class="comment">/*</span>
00179 <span class="comment">     * To preserve pq</span>
00180 <span class="comment">     */</span>
00181     <a class="code" href="../../d4/d1/userk_8h.html#a614">DeferWinEventNotify</a>();
00182 
00183     <span class="keywordflow">if</span> (fShow) {
00184 
00185         <a class="code" href="../../d7/d1/ntuser_2kernel_2cursor_8c.html#a3">IncCursorLevel</a>(pti);
00186 
00187         <span class="keywordflow">if</span> ((pq == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a31">gpqCursor</a>) &amp;&amp; (pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o20">iCursorLevel</a> == 0))
00188             <a class="code" href="../../d7/d1/ntuser_2kernel_2cursor_8c.html#a11">zzzUpdateCursorImage</a>();
00189 
00190     } <span class="keywordflow">else</span> {
00191 
00192         <a class="code" href="../../d7/d1/ntuser_2kernel_2cursor_8c.html#a4">DecCursorLevel</a>(pti);
00193 
00194         <span class="keywordflow">if</span> ((pq == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a31">gpqCursor</a>) &amp;&amp; (pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o20">iCursorLevel</a> == -1))
00195             <a class="code" href="../../d7/d1/ntuser_2kernel_2cursor_8c.html#a11">zzzUpdateCursorImage</a>();
00196     }
00197 
00198     iCursorLevel = pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o20">iCursorLevel</a>;
00199     <a class="code" href="../../d4/d1/userk_8h.html#a617">zzzEndDeferWinEventNotify</a>();
00200 
00201     <span class="keywordflow">return</span> iCursorLevel;
00202 }
00203 
00204 <span class="comment">/***************************************************************************\</span>
00205 <span class="comment">* zzzClipCursor (API)</span>
00206 <span class="comment">*</span>
00207 <span class="comment">* This API sets the cursor clipping rectangle which restricts where the</span>
00208 <span class="comment">* cursor can go.  If prcClip is NULL, the clipping rectangle will be the</span>
00209 <span class="comment">* screen.</span>
00210 <span class="comment">*</span>
00211 <span class="comment">* History:</span>
00212 <span class="comment">* 03-Dec-1990 DavidPe   Created.</span>
00213 <span class="comment">* 16-May-1991 MikeKe    Changed to return BOOL</span>
00214 <span class="comment">\***************************************************************************/</span>
00215 
<a name="l00216"></a><a class="code" href="../../d4/d1/userk_8h.html#a1788">00216</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1788">zzzClipCursor</a>(
00217     LPCRECT prcClip)
00218 {
00219     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00220 
00221     <span class="comment">/*</span>
00222 <span class="comment">     * Don't let this happen if it doesn't have access.</span>
00223 <span class="comment">     */</span>
00224     <span class="keywordflow">if</span> (Process != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a> &amp;&amp; !<a class="code" href="../../d7/d5/w32_2ntuser_2kernel_2security_8c.html#a9">CheckWinstaWriteAttributesAccess</a>()) {
00225         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00226     }
00227 
00228     <span class="comment">/*</span>
00229 <span class="comment">     * The comment from NT 3.51:</span>
00230 <span class="comment">     *     Non-foreground threads can only set the clipping rectangle</span>
00231 <span class="comment">     *     if it was empty, or if they are restoring it to the whole screen.</span>
00232 <span class="comment">     *</span>
00233 <span class="comment">     * But the code from NT 3.51 says "IsRectEmpty" instead of</span>
00234 <span class="comment">     * "!IsRectEmpty", as would follow from the comment. We leave</span>
00235 <span class="comment">     * the code as it was, as following the comment appears to</span>
00236 <span class="comment">     * break apps.</span>
00237 <span class="comment">     *</span>
00238 <span class="comment">     * CONSIDER: Removing this test altogether after NT4.0 ships.</span>
00239 <span class="comment">     */</span>
00240     <span class="keywordflow">if</span> (    <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;pq != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> &amp;&amp;
00241             prcClip != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00242             <a class="code" href="../../d3/d6/rect_8c.html#a4">IsRectEmpty</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a75">grcCursorClip</a>)) {
00243         RIPERR0(ERROR_ACCESS_DENIED, RIP_WARNING, <span class="stringliteral">"Access denied in _ClipCursor"</span>);
00244         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00245     }
00246 
00247     <span class="keywordflow">if</span> (prcClip == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00248 
00249         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a75">grcCursorClip</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o14">rcScreen</a>;
00250 
00251     } <span class="keywordflow">else</span> {
00252 
00253         <span class="comment">/*</span>
00254 <span class="comment">         * Never let our cursor leave the screen. Can't use IntersectRect()</span>
00255 <span class="comment">         * because it doesn't allow rects with 0 width or height.</span>
00256 <span class="comment">         */</span>
00257         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a75">grcCursorClip</a>.left   = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o14">rcScreen</a>.left  , prcClip-&gt;left);
00258         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a75">grcCursorClip</a>.right  = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o14">rcScreen</a>.right , prcClip-&gt;right);
00259         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a75">grcCursorClip</a>.top    = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o14">rcScreen</a>.top   , prcClip-&gt;top);
00260         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a75">grcCursorClip</a>.bottom = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o14">rcScreen</a>.bottom, prcClip-&gt;bottom);
00261 
00262         <span class="comment">/*</span>
00263 <span class="comment">         * Check for invalid clip rect.</span>
00264 <span class="comment">         */</span>
00265         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a75">grcCursorClip</a>.left &gt; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a75">grcCursorClip</a>.right ||
00266             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a75">grcCursorClip</a>.top &gt; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a75">grcCursorClip</a>.bottom) {
00267 
00268             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a75">grcCursorClip</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o14">rcScreen</a>;
00269         }
00270     }
00271 
00272     <span class="comment">/*</span>
00273 <span class="comment">     * Update the cursor position if it's currently outside the</span>
00274 <span class="comment">     * cursor clip-rect.</span>
00275 <span class="comment">     */</span>
00276     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/rect_8c.html#a5">PtInRect</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a75">grcCursorClip</a>, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor)) {
00277         <a class="code" href="../../d4/d1/userk_8h.html#a1179">zzzInternalSetCursorPos</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor.x, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor.y);
00278     }
00279 
00280     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00281 }
00282 
00283 <span class="comment">/***************************************************************************\</span>
00284 <span class="comment">* BoundCursor</span>
00285 <span class="comment">*</span>
00286 <span class="comment">* This rountine 'clips' gptCursorAsync to be within rcCursorClip.  This</span>
00287 <span class="comment">* routine treats rcCursorClip as non-inclusive so the bottom and right sides</span>
00288 <span class="comment">* get bound to rcCursorClip.bottom/right - 1.</span>
00289 <span class="comment">*</span>
00290 <span class="comment">* Is called in OR out of the USER critical section!! IANJA</span>
00291 <span class="comment">*</span>
00292 <span class="comment">* History:</span>
00293 <span class="comment">* 03-Dec-1990 DavidPe   Created.</span>
00294 <span class="comment">\***************************************************************************/</span>
00295 <span class="preprocessor">#ifdef LOCK_MOUSE_CODE</span>
00296 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(MOUSE, BoundCursor)</span>
00297 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00298 <span class="preprocessor"></span>
<a name="l00299"></a><a class="code" href="../../d4/d1/userk_8h.html#a1182">00299</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1182">BoundCursor</a>(
00300     LPPOINT lppt)
00301 {
00302     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a657">TEST_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a646">PUDF_VDMBOUNDSACTIVE</a>) &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a15">gspwndFullScreen</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00303 
00304         <span class="keywordflow">if</span> (lppt-&gt;x &lt; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a85">grcVDMCursorBounds</a>.left) {
00305             lppt-&gt;x = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a85">grcVDMCursorBounds</a>.left;
00306         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lppt-&gt;x &gt;= <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a85">grcVDMCursorBounds</a>.right) {
00307             lppt-&gt;x = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a85">grcVDMCursorBounds</a>.right - 1;
00308         }
00309 
00310         <span class="keywordflow">if</span> (lppt-&gt;y &lt; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a85">grcVDMCursorBounds</a>.top) {
00311             lppt-&gt;y = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a85">grcVDMCursorBounds</a>.top;
00312         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lppt-&gt;y &gt;= <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a85">grcVDMCursorBounds</a>.bottom) {
00313             lppt-&gt;y = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a85">grcVDMCursorBounds</a>.bottom - 1;
00314         }
00315 
00316     } <span class="keywordflow">else</span> {
00317 
00318         <span class="keywordflow">if</span> (lppt-&gt;x &lt; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a75">grcCursorClip</a>.left) {
00319             lppt-&gt;x = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a75">grcCursorClip</a>.left;
00320         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lppt-&gt;x &gt;= <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a75">grcCursorClip</a>.right) {
00321             lppt-&gt;x = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a75">grcCursorClip</a>.right - 1;
00322         }
00323 
00324         <span class="keywordflow">if</span> (lppt-&gt;y &lt; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a75">grcCursorClip</a>.top) {
00325             lppt-&gt;y = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a75">grcCursorClip</a>.top;
00326         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lppt-&gt;y &gt;= <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a75">grcCursorClip</a>.bottom) {
00327             lppt-&gt;y = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a75">grcCursorClip</a>.bottom - 1;
00328         }
00329     }
00330 
00331     <span class="comment">/*</span>
00332 <span class="comment">     * If we have more than one monitor, then we need to clip the</span>
00333 <span class="comment">     * cursor to a point on the desktop.</span>
00334 <span class="comment">     */</span>
00335     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o18">fDesktopIsRect</a>) {
00336         <a class="code" href="../../d4/d1/userk_8h.html#a2078">ClipPointToDesktop</a>(lppt);
00337     }
00338 }
00339 
00340 <span class="comment">/***************************************************************************\</span>
00341 <span class="comment">* SetVDMCursorBounds</span>
00342 <span class="comment">*</span>
00343 <span class="comment">* This routine is needed so when a vdm is running, the mouse is not bounded</span>
00344 <span class="comment">* by the screen. This is so the vdm can correctly virtualize the DOS mouse</span>
00345 <span class="comment">* device driver. It can't deal with user always bounding to the screen,</span>
00346 <span class="comment">* so it sets wide open bounds.</span>
00347 <span class="comment">*</span>
00348 <span class="comment">* 20-May-1993 ScottLu       Created.</span>
00349 <span class="comment">\***************************************************************************/</span>
00350 
<a name="l00351"></a><a class="code" href="../../d6/d3/queue_8c.html#a23">00351</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d3/queue_8c.html#a23">SetVDMCursorBounds</a>(
00352     LPRECT lprc)
00353 {
00354     <span class="keywordflow">if</span> (lprc != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00355 
00356         <span class="comment">/*</span>
00357 <span class="comment">         * Set grcVDMCursorBounds before TEST_PUDF(PUDF_VDMBOUNDSACTIVE), because</span>
00358 <span class="comment">         * MoveEvent() calls BoundCursor() from outside the USER CritSect!</span>
00359 <span class="comment">         */</span>
00360         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a85">grcVDMCursorBounds</a> = *lprc;
00361         <a class="code" href="../../d4/d1/userk_8h.html#a659">SET_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a646">PUDF_VDMBOUNDSACTIVE</a>);
00362 
00363     } <span class="keywordflow">else</span> {
00364 
00365         <span class="comment">/*</span>
00366 <span class="comment">         * Turn vdm bounds off.</span>
00367 <span class="comment">         */</span>
00368         <a class="code" href="../../d4/d1/userk_8h.html#a660">CLEAR_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a646">PUDF_VDMBOUNDSACTIVE</a>);
00369     }
00370 }
00371 
00372 <span class="comment">/***************************************************************************\</span>
00373 <span class="comment">* zzzAnimateCursor</span>
00374 <span class="comment">*</span>
00375 <span class="comment">* When an animated cursor is loaded and the wait cursor is up this routine</span>
00376 <span class="comment">* gets called to maintain the cursor animation.</span>
00377 <span class="comment">*</span>
00378 <span class="comment">* Should only be called by the cursor animation timer.</span>
00379 <span class="comment">*</span>
00380 <span class="comment">* History:</span>
00381 <span class="comment">* 02-Oct-1991 DarrinM      Created.</span>
00382 <span class="comment">* 03-Aug-1994 SanfordS     Calibrated.</span>
00383 <span class="comment">\***************************************************************************/</span>
00384 
00385 <span class="preprocessor">#if defined (_M_IX86) &amp;&amp; (_MSC_VER &lt;= 1100)</span>
00386 <span class="preprocessor"></span><span class="preprocessor">#pragma optimize("s", off)</span>
00387 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00388 <span class="preprocessor"></span>
<a name="l00389"></a><a class="code" href="../../d7/d1/ntuser_2kernel_2cursor_8c.html#a9">00389</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d7/d1/ntuser_2kernel_2cursor_8c.html#a9">zzzAnimateCursor</a>(
00390     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwndDummy,
00391     UINT  message,
00392     UINT_PTR nID,
00393     LPARAM lParam)
00394 {
00395     <span class="keywordtype">int</span>   iicur;
00396     <a class="code" href="../../d1/d8/structtagACON.html">PACON</a> <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>;
00397     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>    tlpacon;
00398     <span class="keywordtype">int</span>   LostTime;
00399     <span class="keywordtype">int</span>   tTime;
00400 
00401     <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a> = (<a class="code" href="../../d1/d8/structtagACON.html">PACON</a>)<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a83">gpcurLogCurrent</a>;
00402 
00403     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || !(<a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;CURSORF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a537">CURSORF_ACON</a>)) {
00404         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a86">gdwLastAniTick</a> = 0;
00405         <span class="keywordflow">return</span>;
00406     }
00407 
00408     <span class="comment">/*</span>
00409 <span class="comment">     * Find out actual time loss since last update.</span>
00410 <span class="comment">     */</span>
00411     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a86">gdwLastAniTick</a>) {
00412 
00413         LostTime = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>() - <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a86">gdwLastAniTick</a> -
00414                 (<a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;ajifRate[<a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;iicur] * 100 / 6);
00415 
00416         <span class="keywordflow">if</span> (LostTime &lt; 0)
00417             LostTime = 0;
00418 
00419     } <span class="keywordflow">else</span> {
00420 
00421         LostTime = 0;
00422     }
00423 
00424     <span class="comment">/*</span>
00425 <span class="comment">     * Increment the animation index.</span>
00426 <span class="comment">     */</span>
00427     iicur = <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;iicur + 1;
00428     <span class="keywordflow">if</span> (iicur &gt;= <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;cicur)
00429         iicur = 0;
00430 
00431     <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;iicur = iicur;
00432 
00433     <span class="comment">/*</span>
00434 <span class="comment">     * This forces the new cursor to be drawn.</span>
00435 <span class="comment">     */</span>
00436     <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(<a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>, &amp;tlpacon);
00437     <a class="code" href="../../d7/d1/ntuser_2kernel_2cursor_8c.html#a11">zzzUpdateCursorImage</a>();
00438 
00439     tTime = <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;ajifRate[iicur] * 100 / 6;
00440 
00441     <span class="keywordflow">while</span> (tTime &lt; LostTime) {
00442 
00443         <span class="comment">/*</span>
00444 <span class="comment">         * Animation is outrunning our ability to render it - skip frames</span>
00445 <span class="comment">         * to catch up.</span>
00446 <span class="comment">         */</span>
00447         LostTime -= tTime;
00448 
00449         <span class="comment">/*</span>
00450 <span class="comment">         * Increment the animation index.</span>
00451 <span class="comment">         */</span>
00452         iicur = <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;iicur + 1;
00453         <span class="keywordflow">if</span> (iicur &gt;= <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;cicur)
00454             iicur = 0;
00455 
00456         <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;iicur = iicur;
00457 
00458         tTime = <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;ajifRate[iicur] * 100 / 6;
00459     }
00460     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpacon);
00461 
00462     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a86">gdwLastAniTick</a> = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>() - LostTime;
00463     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a87">gidCursorTimer</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1044">InternalSetTimer</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a87">gidCursorTimer</a>, tTime - LostTime, <a class="code" href="../../d7/d1/ntuser_2kernel_2cursor_8c.html#a9">zzzAnimateCursor</a>, TMRF_RIT | TMRF_ONESHOT);
00464 
00465     <span class="keywordflow">return</span>;
00466 
00467 
00468     DBG_UNREFERENCED_PARAMETER(pwndDummy);
00469     DBG_UNREFERENCED_PARAMETER(message);
00470     DBG_UNREFERENCED_PARAMETER(nID);
00471     DBG_UNREFERENCED_PARAMETER(lParam);
00472 }
00473 
00474 <span class="comment">/**************************************************************************\</span>
00475 <span class="comment">* FCursorShadowed</span>
00476 <span class="comment">*</span>
00477 <span class="comment">\**************************************************************************/</span>
00478 
<a name="l00479"></a><a class="code" href="../../d7/d1/ntuser_2kernel_2cursor_8c.html#a10">00479</a> __inline <a class="code" href="../../d7/d1/ntuser_2kernel_2cursor_8c.html#a10">FCursorShadowed</a>(PCURSINFO pci)
00480 {
00481     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d1/userk_8h.html#a666">TestALPHA</a>(CURSORSHADOW) &amp;&amp; (pci-&gt;CURSORF_flags &amp; CURSORF_SYSTEM));
00482 }
00483 
00484 <span class="preprocessor">#if defined (_M_IX86) &amp;&amp; (_MSC_VER &lt;= 1100)</span>
00485 <span class="preprocessor"></span><span class="preprocessor">#pragma optimize("", on)</span>
00486 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00487 <span class="preprocessor"></span>
00488 <span class="comment">/**************************************************************************\</span>
00489 <span class="comment">* zzzUpdateCursorImage</span>
00490 <span class="comment">*</span>
00491 <span class="comment">* History:</span>
00492 <span class="comment">* 14-Jan-1992 DavidPe   Created.</span>
00493 <span class="comment">* 09-Aug-1992 DarrinM   Added animated cursor code.</span>
00494 <span class="comment">\**************************************************************************/</span>
00495 
<a name="l00496"></a><a class="code" href="../../d4/d1/userk_8h.html#a1489">00496</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d7/d1/ntuser_2kernel_2cursor_8c.html#a11">zzzUpdateCursorImage</a>()
00497 {
00498     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcurLogNew;
00499     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcurPhysNew;
00500     <a class="code" href="../../d1/d8/structtagACON.html">PACON</a>   <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>;
00501     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcurPhysOld;
00502 
00503     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a31">gpqCursor</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00504         <span class="keywordflow">return</span>;
00505 
00506     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a31">gpqCursor</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o20">iCursorLevel</a> &lt; 0) || (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a31">gpqCursor</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o19">spcurCurrent</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00507 
00508         pcurLogNew = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00509 
00510     } <span class="keywordflow">else</span> {
00511 
00512         <span class="comment">/*</span>
00513 <span class="comment">         * Assume we're using the current cursor.</span>
00514 <span class="comment">         */</span>
00515         pcurLogNew = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a31">gpqCursor</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o19">spcurCurrent</a>;
00516 
00517         <span class="comment">/*</span>
00518 <span class="comment">         * Check to see if we should use the "app starting" cursor.</span>
00519 <span class="comment">         */</span>
00520         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a74">gtimeStartCursorHide</a> != 0) {
00521 
00522             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a31">gpqCursor</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o19">spcurCurrent</a> == <a class="code" href="../../d4/d1/userk_8h.html#a321">SYSCUR</a>(ARROW) ||
00523                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a31">gpqCursor</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o19">spcurCurrent</a> == <a class="code" href="../../d4/d1/userk_8h.html#a321">SYSCUR</a>(APPSTARTING)) {
00524 
00525                 pcurLogNew = <a class="code" href="../../d4/d1/userk_8h.html#a321">SYSCUR</a>(APPSTARTING);
00526             }
00527         }
00528     }
00529 
00530     <span class="comment">/*</span>
00531 <span class="comment">     * If the logical cursor is changing then start/stop the cursor</span>
00532 <span class="comment">     * animation timer as appropriate.</span>
00533 <span class="comment">     */</span>
00534     <span class="keywordflow">if</span> (pcurLogNew != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a83">gpcurLogCurrent</a>) {
00535 
00536         <span class="comment">/*</span>
00537 <span class="comment">         * If the old cursor was animating, shut off the animation timer.</span>
00538 <span class="comment">         */</span>
00539         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a114">gtmridAniCursor</a> != 0) {
00540             <span class="comment">/*</span>
00541 <span class="comment">             * Disable animation.</span>
00542 <span class="comment">             */</span>
00543             <a class="code" href="../../d4/d1/userk_8h.html#a499">KILLRITTIMER</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a114">gtmridAniCursor</a>);
00544             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a114">gtmridAniCursor</a> = 0;
00545         }
00546 
00547         <span class="comment">/*</span>
00548 <span class="comment">         * If the new cursor is animated, start the animation timer.</span>
00549 <span class="comment">         */</span>
00550         <span class="keywordflow">if</span> ((pcurLogNew != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (pcurLogNew-&gt;CURSORF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a537">CURSORF_ACON</a>)) {
00551 
00552             <span class="comment">/*</span>
00553 <span class="comment">             * Start the animation over from the beginning.</span>
00554 <span class="comment">             */</span>
00555             <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a> = (<a class="code" href="../../d1/d8/structtagACON.html">PACON</a>)pcurLogNew;
00556             <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;iicur = 0;
00557 
00558             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a86">gdwLastAniTick</a> = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>();
00559 
00560             <span class="comment">/*</span>
00561 <span class="comment">             * Use the rate table to keep the timer on track.</span>
00562 <span class="comment">             * 1 Jiffy = 1/60 sec = 100/6 ms</span>
00563 <span class="comment">             */</span>
00564             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a114">gtmridAniCursor</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1044">InternalSetTimer</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a114">gtmridAniCursor</a>,
00565                     <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;ajifRate[0] * 100 / 6, <a class="code" href="../../d7/d1/ntuser_2kernel_2cursor_8c.html#a9">zzzAnimateCursor</a>, TMRF_RIT | TMRF_ONESHOT);
00566         }
00567     }
00568 
00569     <span class="comment">/*</span>
00570 <span class="comment">     * If this is an animated cursor, find and use the current frame</span>
00571 <span class="comment">     * of the animation.  NOTE: this is done AFTER the AppStarting</span>
00572 <span class="comment">     * business so the AppStarting cursor itself can be animated.</span>
00573 <span class="comment">     */</span>
00574     <span class="keywordflow">if</span> (pcurLogNew != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pcurLogNew-&gt;CURSORF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a537">CURSORF_ACON</a>) {
00575 
00576         pcurPhysNew = ((<a class="code" href="../../d1/d8/structtagACON.html">PACON</a>)pcurLogNew)-&gt;aspcur[((<a class="code" href="../../d1/d8/structtagACON.html">PACON</a>)pcurLogNew)-&gt;
00577                 aicur[((<a class="code" href="../../d1/d8/structtagACON.html">PACON</a>)pcurLogNew)-&gt;iicur]];
00578     } <span class="keywordflow">else</span> {
00579 
00580         pcurPhysNew = pcurLogNew;
00581     }
00582 
00583     <span class="comment">/*</span>
00584 <span class="comment">     * Remember the new logical cursor.</span>
00585 <span class="comment">     */</span>
00586     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a83">gpcurLogCurrent</a> = pcurLogNew;
00587 
00588     <span class="comment">/*</span>
00589 <span class="comment">     * If the physical cursor is changing then update screen.</span>
00590 <span class="comment">     */</span>
00591     <span class="keywordflow">if</span> (pcurPhysNew != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a84">gpcurPhysCurrent</a>) {
00592 
00593         pcurPhysOld = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a84">gpcurPhysCurrent</a>;
00594 
00595         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a84">gpcurPhysCurrent</a> = pcurPhysNew;
00596 
00597         <span class="keywordflow">if</span> (pcurPhysNew == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00598 
00599             <a class="code" href="../../d4/d1/userk_8h.html#a1790">SetPointer</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00600 
00601         } <span class="keywordflow">else</span> {
00602             ULONG fl = 0;
00603 
00604             <span class="keywordflow">if</span> (pcurLogNew-&gt;CURSORF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a537">CURSORF_ACON</a>) {
00605                 fl |= SPS_ANIMATEUPDATE;
00606             }
00607             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d1/ntuser_2kernel_2cursor_8c.html#a10">FCursorShadowed</a>(<a class="code" href="../../d4/d1/userk_8h.html#a600">GETPCI</a>(pcurLogNew))) {
00608                 fl |= SPS_ALPHA;
00609             }
00610             GreSetPointer(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, <a class="code" href="../../d4/d1/userk_8h.html#a600">GETPCI</a>(pcurPhysNew), fl);
00611         }
00612 
00613         <span class="comment">/*</span>
00614 <span class="comment">         * Notify anyone who cares about the change</span>
00615 <span class="comment">         * This can happen on the RIT, so we need to pass on the real</span>
00616 <span class="comment">         * thread/process ID.  Hence we use hwndCursor.</span>
00617 <span class="comment">         * This comment is from WIn'95 so it may not be true - IanJa.</span>
00618 <span class="comment">         */</span>
00619         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
00620             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   event;
00621             <span class="comment">/*</span>
00622 <span class="comment">             * These are the events we send:</span>
00623 <span class="comment">             *      hcurPhys now NULL       -&gt;  EVENT_OBJECT_HIDE</span>
00624 <span class="comment">             *      hcurPhys was NULL       -&gt;  EVENT_OBJECT_SHOW</span>
00625 <span class="comment">             *      hcurPhys changing       -&gt;  EVENT_OBJECT_NAMECHANGE</span>
00626 <span class="comment">             * Since we only go through this code if hcurPhys is actually</span>
00627 <span class="comment">             * changing, these checks are simple.</span>
00628 <span class="comment">             */</span>
00629             <span class="keywordflow">if</span> (!pcurPhysNew) {
00630                 event = EVENT_OBJECT_HIDE;
00631             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pcurPhysOld) {
00632                 event = EVENT_OBJECT_SHOW;
00633             } <span class="keywordflow">else</span> {
00634                 event = EVENT_OBJECT_NAMECHANGE;
00635             }
00636             <a class="code" href="../../d4/d1/userk_8h.html#a619">zzzWindowEvent</a>(event, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, OBJID_CURSOR, INDEXID_CONTAINER, <a class="code" href="../../d4/d1/userk_8h.html#a610">WEF_USEPWNDTHREAD</a>);
00637         }
00638     }
00639 }
00640 
00641 <span class="preprocessor">#if DBG</span>
00642 <span class="preprocessor"></span>
00643 <span class="comment">/***************************************************************************\</span>
00644 <span class="comment">* DbgLockQCursor</span>
00645 <span class="comment">*</span>
00646 <span class="comment">* Special routine to lock cursors into a queue.  Besides a pointer</span>
00647 <span class="comment">* to the cursor, the handle is also saved.</span>
00648 <span class="comment">* Returns the pointer to the previous current cursor for that queue.</span>
00649 <span class="comment">*</span>
00650 <span class="comment">* History:</span>
00651 <span class="comment">* 26-Jan-1993 JimA      Created.</span>
00652 <span class="comment">\***************************************************************************/</span>
00653 
00654 <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> DbgLockQCursor(
00655     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a>      pq,
00656     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcur)
00657 {
00658     <span class="comment">/*</span>
00659 <span class="comment">     * See if the queue is marked for destuction.  If so, we should not</span>
00660 <span class="comment">     * be trying to lock a cursor.</span>
00661 <span class="comment">     */</span>
00662     UserAssertMsg0(!(pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp; QF_INDESTROY),
00663                   <span class="stringliteral">"LockQCursor: Attempting to lock cursor to freed queue"</span>);
00664 
00665     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o19">spcurCurrent</a>, pcur);
00666 }
00667 
00668 <span class="preprocessor">#endif // DBG</span>
00669 <span class="preprocessor"></span>
00670 <span class="comment">/***************************************************************************\</span>
00671 <span class="comment">* SetPointer</span>
00672 <span class="comment">*</span>
00673 <span class="comment">* 29-Mar-1998   vadimg      created</span>
00674 <span class="comment">\***************************************************************************/</span>
00675 
<a name="l00676"></a><a class="code" href="../../d4/d1/userk_8h.html#a1790">00676</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1790">SetPointer</a>(BOOL fSet)
00677 {
00678     <span class="keywordflow">if</span> (fSet) {
00679         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a31">gpqCursor</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a31">gpqCursor</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o20">iCursorLevel</a> &gt;= 0 &amp;&amp;
00680                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a31">gpqCursor</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o19">spcurCurrent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00681                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(MOUSEPRESENT)) {
00682 
00683             PCURSINFO pci = <a class="code" href="../../d4/d1/userk_8h.html#a600">GETPCI</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a31">gpqCursor</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o19">spcurCurrent</a>);
00684             ULONG fl = <a class="code" href="../../d7/d1/ntuser_2kernel_2cursor_8c.html#a10">FCursorShadowed</a>(pci) ? SPS_ALPHA : 0;
00685 
00686             GreSetPointer(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, pci, fl);
00687         }
00688     } <span class="keywordflow">else</span> {
00689         GreSetPointer(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
00690     }
00691 }
00692 
00693 <span class="comment">/***************************************************************************\</span>
00694 <span class="comment">* HideCursorNoCapture</span>
00695 <span class="comment">*</span>
00696 <span class="comment">* Set the cursor to NULL if the mouse is not captured</span>
00697 <span class="comment">*</span>
00698 <span class="comment">* 20-May-1998   MCostea      created</span>
00699 <span class="comment">\***************************************************************************/</span>
00700 
<a name="l00701"></a><a class="code" href="../../d4/d1/userk_8h.html#a1791">00701</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/d1/ntuser_2kernel_2cursor_8c.html#a13">zzzHideCursorNoCapture</a>()
00702 {
00703     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>();
00704 
00705     <span class="keywordflow">if</span> (!ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a> &amp;&amp; (<a class="code" href="../../d6/d3/queue_8c.html#a35">GetAppCompatFlags2</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>) &amp; GACF2_EDITNOMOUSEHIDE) == 0) {
00706         <a class="code" href="../../d4/d1/userk_8h.html#a1785">zzzSetCursor</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00707     }
00708 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:38 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
