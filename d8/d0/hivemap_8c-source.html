<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: hivemap.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>hivemap.c</h1><a href="../../d7/d1/hivemap_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    hivemap.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements HvpBuildMap - used to build the initial map for a hive</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Bryan M. Willman (bryanwi) 28-Mar-92</span>
00016 <span class="comment"></span>
00017 <span class="comment">Environment:</span>
00018 <span class="comment"></span>
00019 <span class="comment"></span>
00020 <span class="comment">Revision History:</span>
00021 <span class="comment">    Dragos C. Sambotin (dragoss) 25-Jan-99</span>
00022 <span class="comment">        Implementation of bin-size chunk loading of hives.</span>
00023 <span class="comment">--*/</span>
00024 
00025 <span class="preprocessor">#include    "<a class="code" href="../../d1/d2/cmp_8h.html">cmp.h</a>"</span>
00026 
00027 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvpBuildMap)</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvpFreeMap)</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvpAllocateMap)</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvpBuildMapAndCopy)</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvpEnlistFreeCells)</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvpInitMap)</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvpCleanMap)</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,HvpEnlistBinInMap)</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00037 <span class="preprocessor"></span>
00038 <span class="keyword">extern</span> <span class="keyword">struct </span>{
<a name="l00039"></a><a class="code" href="../../d7/d1/hivemap_8c.html#a0">00039</a>     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>      <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
<a name="l00040"></a><a class="code" href="../../d7/d1/hivemap_8c.html#a1">00040</a>     ULONG       <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
<a name="l00041"></a><a class="code" href="../../d7/d1/hivemap_8c.html#a2">00041</a>     ULONG       <a class="code" href="../../d7/d0/cmdat2_8c.html#a32">Space</a>;
<a name="l00042"></a><a class="code" href="../../d7/d1/hivemap_8c.html#a3">00042</a>     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d7/d0/cmdat2_8c.html#a33">MapPoint</a>;
<a name="l00043"></a><a class="code" href="../../d7/d1/hivemap_8c.html#a4">00043</a>     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>       <a class="code" href="../../d7/d0/cmdat2_8c.html#a34">BinPoint</a>;
00044 } <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>;
00045 
00046 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00047"></a><a class="code" href="../../d7/d1/hivemap_8c.html#a6">00047</a> <a class="code" href="../../d7/d1/hivemap_8c.html#a6">HvpBuildMapAndCopy</a>(
00048     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>  Hive,
00049     PVOID   Image,
00050     PHCELL_INDEX TailDisplay OPTIONAL
00051     )
00052 <span class="comment">/*++</span>
00053 <span class="comment"></span>
00054 <span class="comment">Routine Description:</span>
00055 <span class="comment"></span>
00056 <span class="comment">    Creates the map for the Stable storage of the hive, and inits</span>
00057 <span class="comment">    the map for the volatile storage.</span>
00058 <span class="comment"></span>
00059 <span class="comment">    Following fields in hive must already be filled in:</span>
00060 <span class="comment"></span>
00061 <span class="comment">         Allocate, Free</span>
00062 <span class="comment"></span>
00063 <span class="comment">    Will initialize Storage structure of HHIVE.</span>
00064 <span class="comment"></span>
00065 <span class="comment">    The difference between this routine and HvpBuildMapAndCopy is that</span>
00066 <span class="comment">    this routine will create a "sparse" map.  As it copies the SourceImage</span>
00067 <span class="comment">    to the newly allocated memory for the destination, it will avoid</span>
00068 <span class="comment">    allocating space for HBINs that contain nothing but free space.  The</span>
00069 <span class="comment">    HBLOCKs in these HBINs will be marked as discarded, and HvGetCell</span>
00070 <span class="comment">    will allocate memory for them if necessary.</span>
00071 <span class="comment"></span>
00072 <span class="comment">Arguments:</span>
00073 <span class="comment"></span>
00074 <span class="comment">    Hive - Pointer to hive control structure to build map for.</span>
00075 <span class="comment"></span>
00076 <span class="comment">    Image - pointer to flat memory image of original hive.</span>
00077 <span class="comment"></span>
00078 <span class="comment">Return Value:</span>
00079 <span class="comment"></span>
00080 <span class="comment">    TRUE - it worked</span>
00081 <span class="comment">    FALSE - either hive is corrupt or no memory for map</span>
00082 <span class="comment"></span>
00083 <span class="comment">--*/</span>
00084 {
00085     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>    BaseBlock;
00086     ULONG           Length;
00087     ULONG           MapSlots;
00088     ULONG           Tables;
00089     <a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">PHMAP_TABLE</a>     <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00090     <a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a> d = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00091     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00092     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           NewBins;
00093     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           CurrentBin;
00094     ULONG           <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00095     ULONG_PTR        Address;
00096     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a>     Me;
00097     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00098     PULONG          Vector;
00099     ULONG           <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00100 
00101 
00102     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a29">CMS_HIVE</a>) {
00103         KdPrint((<span class="stringliteral">"HvpBuildMap:\n"</span>));
00104         KdPrint((<span class="stringliteral">"\tHive=%08lx"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>));
00105     }
00106 
00107 
00108     <span class="comment">//</span>
00109     <span class="comment">// Compute size of data region to be mapped</span>
00110     <span class="comment">//</span>
00111     BaseBlock = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>;
00112     Length = BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a>;
00113     <span class="keywordflow">if</span> ((Length % <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) != 0 ) {
00114         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REGISTRY_CORRUPT;
00115         <span class="keywordflow">goto</span> ErrorExit1;
00116     }
00117     MapSlots = Length / <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00118     <span class="keywordflow">if</span>( MapSlots &gt; 0 ) {
00119         Tables = (MapSlots-1) / <a class="code" href="../../d0/d1/hivedata_8h.html#a17">HTABLE_SLOTS</a>;
00120     } <span class="keywordflow">else</span> {
00121         Tables = 0;
00122     }
00123 
00124     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length = Length;
00125 
00126     <span class="comment">//</span>
00127     <span class="comment">// allocate dirty vector if one is not already present (from HvpRecoverData)</span>
00128     <span class="comment">//</span>
00129 
00130     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00131         Vector = (PULONG)((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(Length/<a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>/8,<span class="keyword">sizeof</span>(ULONG)), <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
00132         <span class="keywordflow">if</span> (Vector == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00133             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00134             <span class="keywordflow">goto</span> ErrorExit1;
00135         }
00136         RtlZeroMemory(Vector, Length / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a> / 8);
00137         <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a26">RtlInitializeBitMap</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>, Vector, Length / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>);
00138         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o11">DirtyAlloc</a> = (Length/<a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>/8);
00139     }
00140 
00141     <span class="comment">//</span>
00142     <span class="comment">// allocate and build structure for map</span>
00143     <span class="comment">//</span>
00144     <span class="keywordflow">if</span> (Tables == 0) {
00145 
00146         <span class="comment">//</span>
00147         <span class="comment">// Just 1 table, no need for directory</span>
00148         <span class="comment">//</span>
00149         <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">HMAP_TABLE</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00150         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00151             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00152             <span class="keywordflow">goto</span> ErrorExit1;
00153         }
00154         RtlZeroMemory(<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">HMAP_TABLE</a>));
00155         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Map =
00156             (<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a>)&amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].SmallDir);
00157         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].SmallDir = <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>;
00158 
00159     } <span class="keywordflow">else</span> {
00160 
00161         <span class="comment">//</span>
00162         <span class="comment">// Need directory and multiple tables</span>
00163         <span class="comment">//</span>
00164         d = (<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">HMAP_DIRECTORY</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00165         <span class="keywordflow">if</span> (d == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00166             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00167             <span class="keywordflow">goto</span> ErrorExit1;
00168         }
00169         RtlZeroMemory(d, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">HMAP_DIRECTORY</a>));
00170 
00171         <span class="comment">//</span>
00172         <span class="comment">// Allocate tables and fill in dir</span>
00173         <span class="comment">//</span>
00174         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d1/hivemap_8c.html#a13">HvpAllocateMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, d, 0, Tables) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00175             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00176             <span class="keywordflow">goto</span> ErrorExit2;
00177         }
00178         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Map = d;
00179         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].SmallDir = 0;
00180     }
00181 
00182     <span class="comment">//</span>
00183     <span class="comment">// Now we have to allocate the memory for the HBINs and fill in</span>
00184     <span class="comment">// the map appropriately.  We are careful never to allocate less</span>
00185     <span class="comment">// than a page to avoid fragmenting pool.  As long as the page</span>
00186     <span class="comment">// size is a multiple of HBLOCK_SIZE (a fairly good assumption as</span>
00187     <span class="comment">// long as HBLOCK_SIZE is 4k) this strategy will prevent pool</span>
00188     <span class="comment">// fragmentation.</span>
00189     <span class="comment">//</span>
00190     <span class="comment">// If we come across an HBIN that is entirely composed of a freed</span>
00191     <span class="comment">// HCELL, then we do not allocate memory, but mark its HBLOCKs in</span>
00192     <span class="comment">// the map as not present.  HvAllocateCell will allocate memory for</span>
00193     <span class="comment">// the bin when it is needed.</span>
00194     <span class="comment">//</span>
00195     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = 0;
00196     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 0;
00197     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)Image;
00198 
00199     <span class="keywordflow">while</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> &lt; (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)((PUCHAR)(Image) + Length)) {
00200 
00201         <span class="keywordflow">if</span> ( (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a> &gt; (Length-<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>))               ||
00202              (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o0">Signature</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a24">HBIN_SIGNATURE</a>)         ||
00203              (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> != (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>+<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>))
00204            )
00205         {
00206             <span class="comment">//</span>
00207             <span class="comment">// Bin is bogus</span>
00208             <span class="comment">//</span>
00209             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REGISTRY_CORRUPT;
00210             <span class="keywordflow">goto</span> ErrorExit2;
00211         }
00212 
00213         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> += <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>;
00214         <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) &amp;&amp;
00215             (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> + Length - <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) {
00216 
00217             <span class="comment">//</span>
00218             <span class="comment">// We haven't accumulated enough bins to fill up a page</span>
00219             <span class="comment">// yet, and there are still bins left, so group this one</span>
00220             <span class="comment">// in with the next one.</span>
00221             <span class="comment">//</span>
00222             <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)((ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>);
00223 
00224             <span class="keywordflow">continue</span>;
00225 
00226         }
00227 
00228         <span class="comment">//</span>
00229         <span class="comment">// We now have a series of HBINs to group together in one</span>
00230         <span class="comment">// chunk of memory.</span>
00231         <span class="comment">//</span>
00232         NewBins = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00233         <span class="keywordflow">if</span> (NewBins==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00234             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00235             <span class="keywordflow">goto</span> ErrorExit2;        <span class="comment">//fixfix</span>
00236         }
00237         RtlCopyMemory(NewBins,
00238                       (PUCHAR)Image+<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>,
00239                       <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
00240         NewBins-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a> = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00241 
00242         <span class="comment">//</span>
00243         <span class="comment">// create map entries for each block/page in bin</span>
00244         <span class="comment">//</span>
00245         Address = (ULONG_PTR)NewBins;
00246         <span class="keywordflow">do</span> {
00247             CurrentBin = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)Address;
00248             <span class="keywordflow">do</span> {
00249                 Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>);
00250                 <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>);
00251                 Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a> = Address;
00252                 Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> = (ULONG_PTR)CurrentBin;
00253 
00254                 <span class="keywordflow">if</span> (CurrentBin == NewBins) {
00255                     Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> |= <a class="code" href="../../d0/d1/hivedata_8h.html#a35">HMAP_NEWALLOC</a>;
00256                 } <span class="keywordflow">else</span> {
00257                     CurrentBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a> = 0;
00258                 }
00259                 Address += <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00260                 <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> += <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00261             } <span class="keywordflow">while</span> ( Address &lt; ((ULONG_PTR)CurrentBin + CurrentBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a> ));
00262 
00263             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00264 
00265                 <span class="comment">//</span>
00266                 <span class="comment">// add free cells in the bin to the appropriate free lists</span>
00267                 <span class="comment">//</span>
00268                 <span class="keywordflow">if</span> ( ! <a class="code" href="../../d7/d1/hivemap_8c.html#a10">HvpEnlistFreeCells</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00269                                           CurrentBin,
00270                                           CurrentBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>,
00271                                           TailDisplay
00272                                           )) {
00273                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REGISTRY_CORRUPT;
00274                     <span class="keywordflow">goto</span> ErrorExit2;
00275                 }
00276 
00277             }
00278 
00279         } <span class="keywordflow">while</span> ( Address &lt; (ULONG_PTR)NewBins + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> );
00280 
00281         <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)((ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>);
00282         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 0;
00283     }
00284 
00285     <span class="keywordflow">return</span> STATUS_SUCCESS;
00286 
00287 
00288 ErrorExit2:
00289     <span class="keywordflow">if</span> (d != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00290 
00291         <span class="comment">//</span>
00292         <span class="comment">// directory was built and allocated, so clean it up</span>
00293         <span class="comment">//</span>
00294 
00295         <a class="code" href="../../d7/d1/hivemap_8c.html#a12">HvpFreeMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, d, 0, Tables);
00296         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(d, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">HMAP_DIRECTORY</a>));
00297     }
00298 
00299 ErrorExit1:
00300     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00301 }
00302 
00303 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00304"></a><a class="code" href="../../d7/d1/hivemap_8c.html#a7">00304</a> <a class="code" href="../../d7/d1/hivemap_8c.html#a7">HvpInitMap</a>(
00305     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>  Hive
00306     )
00307 <span class="comment">/*++</span>
00308 <span class="comment"></span>
00309 <span class="comment">Routine Description:</span>
00310 <span class="comment"></span>
00311 <span class="comment">    Initialize the map for the Stable Volatile storage of the hive.</span>
00312 <span class="comment"></span>
00313 <span class="comment">    Following fields in hive must already be filled in:</span>
00314 <span class="comment"></span>
00315 <span class="comment">         Allocate, Free</span>
00316 <span class="comment"></span>
00317 <span class="comment">    Will initialize Storage structure of HHIVE.</span>
00318 <span class="comment"></span>
00319 <span class="comment">Arguments:</span>
00320 <span class="comment"></span>
00321 <span class="comment">    Hive - Pointer to hive control structure to build map for.</span>
00322 <span class="comment"></span>
00323 <span class="comment">Return Value:</span>
00324 <span class="comment"></span>
00325 <span class="comment">    STATUS_SUCCESS - it worked</span>
00326 <span class="comment">    STATUS_xxx - the errorneous status</span>
00327 <span class="comment"></span>
00328 <span class="comment">--*/</span>
00329 {
00330     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>    BaseBlock;
00331     ULONG           Length;
00332     ULONG           MapSlots;
00333     ULONG           Tables;
00334     <a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">PHMAP_TABLE</a>     <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00335     <a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a> d = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00336     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00337     PULONG          Vector;
00338 
00339     
00340     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a29">CMS_HIVE</a>) {
00341         KdPrint((<span class="stringliteral">"HvpInitMap:\n"</span>));
00342         KdPrint((<span class="stringliteral">"\tHive=%08lx"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>));
00343     }
00344 
00345     <span class="comment">//</span>
00346     <span class="comment">// Compute size of data region to be mapped</span>
00347     <span class="comment">//</span>
00348     BaseBlock = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>;
00349     Length = BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a>;
00350     <span class="keywordflow">if</span> ((Length % <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) != 0) {
00351         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REGISTRY_CORRUPT;
00352         <span class="keywordflow">goto</span> ErrorExit1;
00353     }
00354     MapSlots = Length / <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00355     <span class="keywordflow">if</span>( MapSlots &gt; 0 ) {
00356         Tables = (MapSlots-1) / <a class="code" href="../../d0/d1/hivedata_8h.html#a17">HTABLE_SLOTS</a>;
00357     } <span class="keywordflow">else</span> {
00358         Tables = 0;
00359     }
00360 
00361     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length = Length;
00362 
00363     <span class="comment">//</span>
00364     <span class="comment">// allocate dirty vector if one is not already present (from HvpRecoverData)</span>
00365     <span class="comment">//</span>
00366 
00367     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00368         Vector = (PULONG)((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(Length/<a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>/8,<span class="keyword">sizeof</span>(ULONG)), <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
00369         <span class="keywordflow">if</span> (Vector == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00370             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00371             <span class="keywordflow">goto</span> ErrorExit1;
00372         }
00373         RtlZeroMemory(Vector, Length / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a> / 8);
00374         <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a26">RtlInitializeBitMap</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>, Vector, Length / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>);
00375         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o11">DirtyAlloc</a> = (Length/<a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>/8);
00376     }
00377 
00378     <span class="comment">//</span>
00379     <span class="comment">// allocate and build structure for map</span>
00380     <span class="comment">//</span>
00381     <span class="keywordflow">if</span> (Tables == 0) {
00382 
00383         <span class="comment">//</span>
00384         <span class="comment">// Just 1 table, no need for directory</span>
00385         <span class="comment">//</span>
00386         <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">HMAP_TABLE</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00387         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00388             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00389             <span class="keywordflow">goto</span> ErrorExit1;
00390         }
00391         RtlZeroMemory(<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">HMAP_TABLE</a>));
00392         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Map =
00393             (<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a>)&amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].SmallDir);
00394         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].SmallDir = <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>;
00395 
00396     } <span class="keywordflow">else</span> {
00397 
00398         <span class="comment">//</span>
00399         <span class="comment">// Need directory and multiple tables</span>
00400         <span class="comment">//</span>
00401         d = (<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">HMAP_DIRECTORY</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00402         <span class="keywordflow">if</span> (d == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00403             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00404             <span class="keywordflow">goto</span> ErrorExit1;
00405         }
00406         RtlZeroMemory(d, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">HMAP_DIRECTORY</a>));
00407 
00408         <span class="comment">//</span>
00409         <span class="comment">// Allocate tables and fill in dir</span>
00410         <span class="comment">//</span>
00411         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d1/hivemap_8c.html#a13">HvpAllocateMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, d, 0, Tables) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00412             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00413             <span class="keywordflow">goto</span> ErrorExit2;
00414         }
00415         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Map = d;
00416         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].SmallDir = 0;
00417     }
00418 
00419     <span class="keywordflow">return</span> STATUS_SUCCESS;
00420 
00421 ErrorExit2:
00422     <span class="keywordflow">if</span> (d != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00423 
00424         <span class="comment">//</span>
00425         <span class="comment">// directory was built and allocated, so clean it up</span>
00426         <span class="comment">//</span>
00427 
00428         <a class="code" href="../../d7/d1/hivemap_8c.html#a12">HvpFreeMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, d, 0, Tables);
00429         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(d, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">HMAP_DIRECTORY</a>));
00430     }
00431 
00432 ErrorExit1:
00433     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00434 }
00435 
00436 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00437"></a><a class="code" href="../../d7/d1/hivemap_8c.html#a8">00437</a> <a class="code" href="../../d7/d1/hivemap_8c.html#a8">HvpEnlistBinInMap</a>(
00438     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>  Hive,
00439     ULONG   Length,
00440     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>   Bin,
00441     ULONG   Offset,
00442     PHCELL_INDEX TailDisplay OPTIONAL
00443     )
00444 <span class="comment">/*++</span>
00445 <span class="comment"></span>
00446 <span class="comment">Routine Description:</span>
00447 <span class="comment"></span>
00448 <span class="comment">    Creates map entries and enlist free cells for the specified bin </span>
00449 <span class="comment"></span>
00450 <span class="comment">Arguments:</span>
00451 <span class="comment"></span>
00452 <span class="comment">    Hive - Pointer to hive control structure containing the target map</span>
00453 <span class="comment"></span>
00454 <span class="comment">    Length - the Length of the hive image</span>
00455 <span class="comment"></span>
00456 <span class="comment">    Bin - the bin to be enlisted</span>
00457 <span class="comment"></span>
00458 <span class="comment">    Offset - the offset within the hive file</span>
00459 <span class="comment"></span>
00460 <span class="comment">    TailDisplay - array containing the tail ends of the free cell lists - optional</span>
00461 <span class="comment"></span>
00462 <span class="comment">Return Value:</span>
00463 <span class="comment"></span>
00464 <span class="comment">    STATUS_SUCCESS - it worked</span>
00465 <span class="comment">    STATUS_REGISTRY_CORRUPT - the bin is inconsistent</span>
00466 <span class="comment"></span>
00467 <span class="comment">--*/</span>
00468 {
00469     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00470     ULONG           BinOffset;
00471     ULONG_PTR       Address;
00472     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a>     Me;
00473 
00474     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a29">CMS_HIVE</a>) {
00475         KdPrint((<span class="stringliteral">"HvpEnlistBinInMap:\n"</span>));
00476         KdPrint((<span class="stringliteral">"\tHive=%08lx\t Offset=%08lx"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>));
00477     }
00478 
00479     <span class="comment">//</span>
00480     <span class="comment">// memory was allocated for this bin</span>
00481     <span class="comment">//</span>
00482     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>;
00483     
00484     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a25">CML_BIN</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a40">CMS_BIN_MAP</a>) {
00485         KdPrint((<span class="stringliteral">"HvpEnlistBinInMap: BinAddress = 0x%08lx\t Size = 0x%lx\n"</span>, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>));
00486     }
00487 
00488     <span class="comment">//</span>
00489     <span class="comment">// create map entries for each block/page in bin</span>
00490     <span class="comment">//</span>
00491     BinOffset = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00492     <span class="keywordflow">for</span> (Address = (ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00493          Address &lt; ((ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>);
00494          Address += <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>
00495         )
00496     {
00497         Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>);
00498         <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>);
00499         Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a> = Address;
00500         Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> = (ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00501         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> == BinOffset) {
00502             Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> |= <a class="code" href="../../d0/d1/hivedata_8h.html#a35">HMAP_NEWALLOC</a>;
00503         }
00504         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> += <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00505     }
00506 
00507     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00508 
00509         <span class="comment">//</span>
00510         <span class="comment">// add free cells in the bin to the appropriate free lists</span>
00511         <span class="comment">//</span>
00512         <span class="keywordflow">if</span> ( ! <a class="code" href="../../d7/d1/hivemap_8c.html#a10">HvpEnlistFreeCells</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>, BinOffset,TailDisplay)) {
00513             <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Hive = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00514             <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Status = 0xA002;
00515             <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Space = Length;
00516             <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.MapPoint = BinOffset;
00517             <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.BinPoint = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00518             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REGISTRY_CORRUPT;
00519             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00520         }
00521 
00522     }
00523 
00524     <span class="comment">//</span>
00525     <span class="comment">// logical consistency check</span>
00526     <span class="comment">//</span>
00527     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> == (BinOffset + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>));
00528 
00529     <span class="keywordflow">return</span> STATUS_SUCCESS;
00530 
00531 <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>:
00532     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00533 }
00534 
00535 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00536"></a><a class="code" href="../../d7/d1/hivemap_8c.html#a9">00536</a> <a class="code" href="../../d7/d1/hivemap_8c.html#a9">HvpBuildMap</a>(
00537     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>  Hive,
00538     PVOID   Image,
00539     PHCELL_INDEX TailDisplay OPTIONAL
00540     )
00541 <span class="comment">/*++</span>
00542 <span class="comment"></span>
00543 <span class="comment">Routine Description:</span>
00544 <span class="comment"></span>
00545 <span class="comment">    Creates the map for the Stable storage of the hive, and inits</span>
00546 <span class="comment">    the map for the volatile storage.</span>
00547 <span class="comment"></span>
00548 <span class="comment">    Following fields in hive must already be filled in:</span>
00549 <span class="comment"></span>
00550 <span class="comment">         Allocate, Free</span>
00551 <span class="comment"></span>
00552 <span class="comment">    Will initialize Storage structure of HHIVE.</span>
00553 <span class="comment"></span>
00554 <span class="comment">Arguments:</span>
00555 <span class="comment"></span>
00556 <span class="comment">    Hive - Pointer to hive control structure to build map for.</span>
00557 <span class="comment"></span>
00558 <span class="comment">    Image - pointer to in memory image of the hive</span>
00559 <span class="comment"></span>
00560 <span class="comment">Return Value:</span>
00561 <span class="comment"></span>
00562 <span class="comment">    TRUE - it worked</span>
00563 <span class="comment">    FALSE - either hive is corrupt or no memory for map</span>
00564 <span class="comment"></span>
00565 <span class="comment">--*/</span>
00566 {
00567     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00568     ULONG           <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00569     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00570     ULONG           Length;
00571 
00572 
00573     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a29">CMS_HIVE</a>) {
00574         KdPrint((<span class="stringliteral">"HvpBuildMap:\n"</span>));
00575         KdPrint((<span class="stringliteral">"\tHive=%08lx"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>));
00576     }
00577 
00578     <span class="comment">//</span>
00579     <span class="comment">// Init the map</span>
00580     <span class="comment">//</span>
00581     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/hivemap_8c.html#a7">HvpInitMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
00582 
00583     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00584         <span class="comment">//</span>
00585         <span class="comment">// just return failure; HvpInitMap took care of cleanup</span>
00586         <span class="comment">//</span>
00587         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00588     }
00589 
00590     <span class="comment">//</span>
00591     <span class="comment">// Fill in the map</span>
00592     <span class="comment">//</span>
00593     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = 0;
00594     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)Image;
00595     Length = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length;
00596 
00597     <span class="keywordflow">while</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> &lt; (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)((PUCHAR)(Image) + Length)) {
00598 
00599         <span class="comment">//</span>
00600         <span class="comment">// Check the validity of the bin header</span>
00601         <span class="comment">//</span>
00602         <span class="keywordflow">if</span> ( (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a> &gt; Length)                       ||
00603              (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a> &lt; <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>)                  ||
00604              (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o0">Signature</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a24">HBIN_SIGNATURE</a>)         ||
00605              (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> != <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>)) {
00606             <span class="comment">//</span>
00607             <span class="comment">// Bin is bogus</span>
00608             <span class="comment">//</span>
00609             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REGISTRY_CORRUPT;
00610             <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Hive = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00611             <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Status = 0xA001;
00612             <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Space = Length;
00613             <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.MapPoint = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00614             <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.BinPoint = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00615             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00616         }
00617 
00618         <span class="comment">//</span>
00619         <span class="comment">// enlist this bin</span>
00620         <span class="comment">//</span>
00621         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/hivemap_8c.html#a8">HvpEnlistBinInMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Length, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>, <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>, TailDisplay);
00622 
00623         <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00624             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00625         }
00626 
00627         <span class="comment">//</span>
00628         <span class="comment">// the next bin</span>
00629         <span class="comment">//</span>
00630         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> += <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>;
00631 
00632         <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)((ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>);
00633     }
00634 
00635     <span class="keywordflow">return</span> STATUS_SUCCESS;
00636 
00637 
00638 <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>:
00639     <span class="comment">//</span>
00640     <span class="comment">// Clean up the directory table</span>
00641     <span class="comment">//</span>
00642     <a class="code" href="../../d7/d1/hivemap_8c.html#a11">HvpCleanMap</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> );
00643 
00644     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00645 }
00646 
00647 
00648 BOOLEAN
<a name="l00649"></a><a class="code" href="../../d7/d1/hivemap_8c.html#a10">00649</a> <a class="code" href="../../d7/d1/hivemap_8c.html#a10">HvpEnlistFreeCells</a>(
00650     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>  Hive,
00651     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>   Bin,
00652     ULONG   BinOffset,
00653     PHCELL_INDEX TailDisplay OPTIONAL
00654     )
00655 <span class="comment">/*++</span>
00656 <span class="comment"></span>
00657 <span class="comment">Routine Description:</span>
00658 <span class="comment"></span>
00659 <span class="comment">    Scan through the cells in the bin, locating the free ones.</span>
00660 <span class="comment">    Enlist them in the hive's free list set.</span>
00661 <span class="comment"></span>
00662 <span class="comment">    N.B.    Bin MUST already be mapped when this is called.</span>
00663 <span class="comment"></span>
00664 <span class="comment">Arguments:</span>
00665 <span class="comment"></span>
00666 <span class="comment">    Hive - pointer to hive control structure map is being built for</span>
00667 <span class="comment"></span>
00668 <span class="comment">    Bin - pointer to bin to enlist cells from</span>
00669 <span class="comment"></span>
00670 <span class="comment">    BinOffset - offset of Bin in image</span>
00671 <span class="comment"></span>
00672 <span class="comment">Return Value:</span>
00673 <span class="comment"></span>
00674 <span class="comment">    FALSE - registry is corrupt</span>
00675 <span class="comment"></span>
00676 <span class="comment">    TRUE - it worked</span>
00677 <span class="comment"></span>
00678 <span class="comment">--*/</span>
00679 {
00680     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>  p;
00681     ULONG   celloffset;
00682     ULONG   size;
00683     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> cellindex;
00684 
00685     <span class="comment">// PERFNOTE -- Keep this in mind as a possible optimization for NT6.</span>
00686     <span class="comment">// Since now the hive is loaded in chunks of bins, we can drop the </span>
00687     <span class="comment">// bins that are entirely free!!!!!!</span>
00688     <span class="comment">//</span>
00689 
00690     <span class="comment">//</span>
00691     <span class="comment">// Scan all the cells in the bin, total free and allocated, check</span>
00692     <span class="comment">// for impossible pointers.</span>
00693     <span class="comment">//</span>
00694     celloffset = <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>);
00695     p = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>));
00696 
00697     <span class="keywordflow">while</span> (p &lt; (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>)) {
00698 
00699         <span class="comment">//</span>
00700         <span class="comment">// if free cell, check it out, add it to free list for hive</span>
00701         <span class="comment">//</span>
00702         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> &gt;= 0) {
00703 
00704             size = (ULONG)p-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>;
00705 
00706             <span class="keywordflow">if</span> ( (size &gt; <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>)               ||
00707                  ( (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)(size + (PUCHAR)p) &gt;
00708                    (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) ) ||
00709                  ((size % <a class="code" href="../../d0/d1/hivedata_8h.html#a20">HCELL_PAD</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>)) != 0) ||
00710                  (size == 0) )
00711             {
00712                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00713             }
00714 
00715 
00716             <span class="comment">//</span>
00717             <span class="comment">// cell is free, and is not obviously corrupt, add to free list</span>
00718             <span class="comment">//</span>
00719             celloffset = (ULONG)((PUCHAR)p - (PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>);
00720             cellindex = BinOffset + celloffset;
00721 
00722             <span class="comment">//</span>
00723             <span class="comment">// Enlist this free cell, but do not coalesce with the next free cell</span>
00724             <span class="comment">// as we haven't gotten that far yet.</span>
00725             <span class="comment">//</span>
00726             <a class="code" href="../../d8/d0/hivecell_8c.html#a18">HvpEnlistFreeCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, cellindex, size, <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,TailDisplay);
00727 
00728         } <span class="keywordflow">else</span> {
00729 
00730             size = (ULONG)(p-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> * -1);
00731 
00732             <span class="keywordflow">if</span> ( (size &gt; <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>)               ||
00733                  ( (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)(size + (PUCHAR)p) &gt;
00734                    (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) ) ||
00735                  ((size % <a class="code" href="../../d0/d1/hivedata_8h.html#a20">HCELL_PAD</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>)) != 0) ||
00736                  (size == 0) )
00737             {
00738                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00739             }
00740 
00741         }
00742 
00743         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(size &gt;= 0);
00744         p = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)p + size);
00745     }
00746 
00747     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00748 }
00749 
00750 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00751"></a><a class="code" href="../../d7/d1/hivemap_8c.html#a11">00751</a> <a class="code" href="../../d7/d1/hivemap_8c.html#a11">HvpCleanMap</a>(
00752     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>  Hive
00753     )
00754 <span class="comment">/*++</span>
00755 <span class="comment"></span>
00756 <span class="comment">Routine Description:</span>
00757 <span class="comment"></span>
00758 <span class="comment">    Cleans all the map allocations for the stable storage</span>
00759 <span class="comment"></span>
00760 <span class="comment">  Arguments:</span>
00761 <span class="comment"></span>
00762 <span class="comment">    Hive - Pointer to hive control structure to build map for.</span>
00763 <span class="comment"></span>
00764 <span class="comment">Return Value:</span>
00765 <span class="comment"></span>
00766 <span class="comment">    None</span>
00767 <span class="comment">--*/</span>
00768 {
00769     ULONG           Length;
00770     ULONG           MapSlots;
00771     ULONG           Tables;
00772     <a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a> d = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00773 
00774     <span class="comment">//</span>
00775     <span class="comment">// Compute MapSlots and Tables based on the Length</span>
00776     <span class="comment">//</span>
00777     Length = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length;
00778     MapSlots = Length / <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00779     <span class="keywordflow">if</span>( MapSlots &gt; 0 ) {
00780         Tables = (MapSlots-1) / <a class="code" href="../../d0/d1/hivedata_8h.html#a17">HTABLE_SLOTS</a>;
00781     } <span class="keywordflow">else</span> {
00782         Tables = 0;
00783     }
00784 
00785     <span class="keywordflow">if</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].SmallDir == 0 ) {
00786         <span class="comment">//</span>
00787         <span class="comment">// directory was built and allocated, so clean it up</span>
00788         <span class="comment">//</span>
00789 
00790         d = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Map;
00791         <span class="keywordflow">if</span>( d != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00792             <a class="code" href="../../d7/d1/hivemap_8c.html#a12">HvpFreeMap</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, d, 0, Tables);
00793             (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(d, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">HMAP_DIRECTORY</a>));
00794         }
00795     } <span class="keywordflow">else</span> {
00796         <span class="comment">//</span>
00797         <span class="comment">// no directory, just a smalldir</span>
00798         <span class="comment">//</span>
00799         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].SmallDir, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">HMAP_TABLE</a>));
00800     }
00801     
00802     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].SmallDir = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00803     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Map = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00804 }
00805 
00806 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00807"></a><a class="code" href="../../d7/d1/hivemap_8c.html#a12">00807</a> <a class="code" href="../../d7/d1/hivemap_8c.html#a12">HvpFreeMap</a>(
00808     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
00809     <a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a> Dir,
00810     ULONG           Start,
00811     ULONG           End
00812     )
00813 <span class="comment">/*++</span>
00814 <span class="comment"></span>
00815 <span class="comment">Routine Description:</span>
00816 <span class="comment"></span>
00817 <span class="comment">    Sweeps through the directory Dir points to and frees Tables.</span>
00818 <span class="comment">    Will free Start-th through End-th entries, INCLUSIVE.</span>
00819 <span class="comment"></span>
00820 <span class="comment">Arguments:</span>
00821 <span class="comment"></span>
00822 <span class="comment">    Hive - supplies pointer to hive control block of interest</span>
00823 <span class="comment"></span>
00824 <span class="comment">    Dir - supplies address of an HMAP_DIRECTORY structure</span>
00825 <span class="comment"></span>
00826 <span class="comment">    Start - index of first map table pointer to clean up</span>
00827 <span class="comment"></span>
00828 <span class="comment">    End - index of last map table pointer to clean up</span>
00829 <span class="comment"></span>
00830 <span class="comment">Return Value:</span>
00831 <span class="comment"></span>
00832 <span class="comment">    NONE.</span>
00833 <span class="comment"></span>
00834 <span class="comment">--*/</span>
00835 {
00836     ULONG   i;
00837 
00838     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> &gt;= <a class="code" href="../../d0/d1/hivedata_8h.html#a18">HDIRECTORY_SLOTS</a>) {
00839         <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a18">HDIRECTORY_SLOTS</a> - 1;
00840     }
00841 
00842     <span class="keywordflow">for</span> (i = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>; i &lt;= <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>; i++) {
00843         <span class="keywordflow">if</span> (Dir-&gt;<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html#o0">Directory</a>[i] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00844             (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(Dir-&gt;<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html#o0">Directory</a>[i], <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">HMAP_TABLE</a>));
00845             Dir-&gt;<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html#o0">Directory</a>[i] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00846         }
00847     }
00848     <span class="keywordflow">return</span>;
00849 }
00850 
00851 
00852 BOOLEAN
<a name="l00853"></a><a class="code" href="../../d7/d1/hivemap_8c.html#a13">00853</a> <a class="code" href="../../d7/d1/hivemap_8c.html#a13">HvpAllocateMap</a>(
00854     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
00855     <a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a> Dir,
00856     ULONG           Start,
00857     ULONG           End
00858     )
00859 <span class="comment">/*++</span>
00860 <span class="comment"></span>
00861 <span class="comment">Routine Description:</span>
00862 <span class="comment"></span>
00863 <span class="comment">    Sweeps through the directory Dir points to and allocates Tables.</span>
00864 <span class="comment">    Will allocate Start-th through End-th entries, INCLUSIVE.</span>
00865 <span class="comment"></span>
00866 <span class="comment">    Does NOT clean up when out of memory, call HvpFreeMap to do that.</span>
00867 <span class="comment">Arguments:</span>
00868 <span class="comment"></span>
00869 <span class="comment">    Hive - supplies pointer to hive control block of interest</span>
00870 <span class="comment"></span>
00871 <span class="comment">    Dir - supplies address of an HMAP_DIRECTORY structure</span>
00872 <span class="comment"></span>
00873 <span class="comment">    Start - index of first map table pointer to allocate for</span>
00874 <span class="comment"></span>
00875 <span class="comment">    End - index of last map table pointer to allocate for</span>
00876 <span class="comment"></span>
00877 <span class="comment">Return Value:</span>
00878 <span class="comment"></span>
00879 <span class="comment">    TRUE - it worked</span>
00880 <span class="comment"></span>
00881 <span class="comment">    FALSE - insufficient memory</span>
00882 <span class="comment"></span>
00883 <span class="comment">--*/</span>
00884 {
00885     ULONG   i;
00886     PVOID   <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>;
00887 
00888     <span class="keywordflow">for</span> (i = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>; i &lt;= <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>; i++) {
00889         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Dir-&gt;<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html#o0">Directory</a>[i] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00890         <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> = (PVOID)((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">HMAP_TABLE</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>));
00891         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00892             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00893         }
00894         RtlZeroMemory(<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">HMAP_TABLE</a>));
00895         Dir-&gt;<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html#o0">Directory</a>[i] = (<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">PHMAP_TABLE</a>)<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>;
00896     }
00897     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00898 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:17 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
