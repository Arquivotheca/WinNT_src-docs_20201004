<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: extsect.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>extsect.c File Reference</h1><code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">mi.h</a>"</code><br>

<p>
<a href="../../d9/d9/extsect_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d0/extsect_8c.html#a0">NtExtendSection</a> (IN HANDLE SectionHandle, IN OUT PLARGE_INTEGER NewSectionSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d0/extsect_8c.html#a1">MmExtendSection</a> (IN PVOID SectionToExtend, IN OUT PLARGE_INTEGER NewSectionSize, IN ULONG IgnoreFileSizeChecking)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d0/extsect_8c.html#a2">MiGetProtoPteAddressExtended</a> (IN <a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad, IN ULONG_PTR Vpn)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d0/extsect_8c.html#a3">MiLocateSubsection</a> (IN <a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad, IN ULONG_PTR Vpn)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a2" doxytag="extsect.c::MiGetProtoPteAddressExtended" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FASTCALL MiGetProtoPteAddressExtended           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vad</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>Vpn</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/extsect_8c-source.html#l00685">685</a> of file <a class="el" href="../../d9/d9/extsect_8c-source.html">extsect.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02124">_SUBSECTION::NextSubsection</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02123">_SUBSECTION::PtesInSubsection</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02121">_SUBSECTION::SubsectionBase</a>, and <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html#o10">_CONTROL_AREA::u</a>.
<p>
<pre class="fragment"><div>00692                    :
00693 
00694     This function calculates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> prototype PTE
00695     <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding <span class="keyword">virtual</span> address.
00696 
00697 Arguments:
00698 
00699 
00700     Vad - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address desciptor which
00701           encompasses <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address.
00702 
00703     Vpn - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> page number to locate a prototype PTE
00704                      <span class="keywordflow">for</span>.
00705 
00706 Return Value:
00707 
00708     The corresponding prototype PTE address.
00709 
00710 --*/
00711 
00712 {
00713     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
00714     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
00715     ULONG PteOffset;
00716 
00717     ControlArea = Vad-&gt;ControlArea;
00718 
00719     <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession == 0) {
00720         Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)(ControlArea + 1);
00721     }
00722     <span class="keywordflow">else</span> {
00723         Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)((<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">PLARGE_CONTROL_AREA</a>)ControlArea + 1);
00724     }
00725 
00726     <span class="comment">//</span>
00727     <span class="comment">// Locate the subsection which contains the First Prototype PTE</span>
00728     <span class="comment">// for this VAD.</span>
00729     <span class="comment">//</span>
00730 
00731     <span class="keywordflow">while</span> ((Vad-&gt;FirstPrototypePte &lt; Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>) ||
00732            (Vad-&gt;FirstPrototypePte &gt;=
00733                &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>])) {
00734 
00735         <span class="comment">//</span>
00736         <span class="comment">// Get the next subsection.</span>
00737         <span class="comment">//</span>
00738 
00739         Subsection = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
00740         <span class="keywordflow">if</span> (Subsection == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00741             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00742         }
00743     }
00744 
00745     <span class="comment">//</span>
00746     <span class="comment">// How many PTEs beyond this subsection must we go?</span>
00747     <span class="comment">//</span>
00748 
00749     PteOffset = (ULONG) (((Vpn - Vad-&gt;StartingVpn) +
00750                  (ULONG)(Vad-&gt;FirstPrototypePte - Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>)) -
00751                  Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>);
00752 
00753 <span class="comment">// DbgPrint("map extended subsection offset = %lx\n",PteOffset);</span>
00754 
00755     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteOffset &lt; 0xF0000000);
00756 
00757     PteOffset += Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>;
00758 
00759     <span class="comment">//</span>
00760     <span class="comment">// Locate the subsection which contains the prototype PTEs.</span>
00761     <span class="comment">//</span>
00762 
00763     <span class="keywordflow">while</span> (PteOffset &gt;= Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>) {
00764         PteOffset -= Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>;
00765         Subsection = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
00766         <span class="keywordflow">if</span> (Subsection == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00767             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00768         }
00769     }
00770 
00771     <span class="comment">//</span>
00772     <span class="comment">// The PTEs are in this subsection.</span>
00773     <span class="comment">//</span>
00774 
00775     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteOffset &lt; Subsection-&gt;PtesInSubsection);
00776 
00777     <span class="keywordflow">return</span> &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[PteOffset];
00778 
00779 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="extsect.c::MiLocateSubsection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> FASTCALL MiLocateSubsection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vad</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>Vpn</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/extsect_8c-source.html#l00783">783</a> of file <a class="el" href="../../d9/d9/extsect_8c-source.html">extsect.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02124">_SUBSECTION::NextSubsection</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02123">_SUBSECTION::PtesInSubsection</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02121">_SUBSECTION::SubsectionBase</a>, and <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html#o10">_CONTROL_AREA::u</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/deleteva_8c-source.html#l00026">MiDeleteVirtualAddresses()</a>, and <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00297">MmFlushVirtualMemory()</a>.
<p>
<pre class="fragment"><div>00790                    :
00791 
00792     This function calculates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subsection
00793     <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding <span class="keyword">virtual</span> address.
00794 
00795     This function <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> works <span class="keywordflow">for</span> mapped files NOT mapped images.
00796 
00797 Arguments:
00798 
00799 
00800     Vad - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address desciptor which
00801           encompasses <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address.
00802 
00803     Vpn - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> page number to locate a prototype PTE
00804                      <span class="keywordflow">for</span>.
00805 
00806 Return Value:
00807 
00808     The corresponding prototype subsection.
00809 
00810 --*/
00811 
00812 {
00813     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
00814     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
00815     ULONG PteOffset;
00816 
00817     ControlArea = Vad-&gt;ControlArea;
00818 
00819     <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession == 0) {
00820         Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)(ControlArea + 1);
00821     }
00822     <span class="keywordflow">else</span> {
00823         Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)((<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">PLARGE_CONTROL_AREA</a>)ControlArea + 1);
00824     }
00825 
00826     Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)(ControlArea + 1);
00827 
00828 <span class="preprocessor">#if 0</span>
00829 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00830 
00831         <span class="comment">//</span>
00832         <span class="comment">// There is only one subsection, don't look any further.</span>
00833         <span class="comment">//</span>
00834 
00835         <span class="keywordflow">return</span> Subsection;
00836     }
00837 <span class="preprocessor">#endif //0</span>
00838 <span class="preprocessor"></span>
00839     <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Image) {
00840 
00841         <span class="comment">//</span>
00842         <span class="comment">// There is only one subsection, don't look any further.</span>
00843         <span class="comment">//</span>
00844 
00845         <span class="keywordflow">return</span> Subsection;
00846     }
00847 
00848     <span class="comment">//</span>
00849     <span class="comment">// Locate the subsection which contains the First Prototype PTE</span>
00850     <span class="comment">// for this VAD.</span>
00851     <span class="comment">//</span>
00852 
00853     <span class="keywordflow">while</span> ((Vad-&gt;FirstPrototypePte &lt; Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>) ||
00854            (Vad-&gt;FirstPrototypePte &gt;=
00855                &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>])) {
00856 
00857         <span class="comment">//</span>
00858         <span class="comment">// Get the next subsection.</span>
00859         <span class="comment">//</span>
00860 
00861         Subsection = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
00862         <span class="keywordflow">if</span> (Subsection == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00863             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00864         }
00865     }
00866 
00867     <span class="comment">//</span>
00868     <span class="comment">// How many PTEs beyond this subsection must we go?</span>
00869     <span class="comment">//</span>
00870 
00871     PteOffset = (ULONG)((Vpn - Vad-&gt;StartingVpn) +
00872          (ULONG)(Vad-&gt;FirstPrototypePte - Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>));
00873 
00874     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteOffset &lt; 0xF0000000);
00875 
00876     <span class="comment">//</span>
00877     <span class="comment">// Locate the subsection which contains the prototype PTEs.</span>
00878     <span class="comment">//</span>
00879 
00880     <span class="keywordflow">while</span> (PteOffset &gt;= Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>) {
00881         PteOffset -= Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>;
00882         Subsection = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
00883         <span class="keywordflow">if</span> (Subsection == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00884             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00885         }
00886     }
00887 
00888     <span class="comment">//</span>
00889     <span class="comment">// The PTEs are in this subsection.</span>
00890     <span class="comment">//</span>
00891 
00892     <span class="keywordflow">return</span> Subsection;
00893 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="extsect.c::MmExtendSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmExtendSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionToExtend</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>NewSectionSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>IgnoreFileSizeChecking</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/extsect_8c-source.html#l00201">201</a> of file <a class="el" href="../../d9/d9/extsect_8c-source.html">extsect.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01996">_MMEXTEND_INFO::CommittedSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02114">_SUBSECTION::ControlArea</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02001">_SEGMENT::ControlArea</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02059">_CONTROL_AREA::DereferenceList</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00263">EX_REAL_POOL_USAGE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02012">_SEGMENT::ExtendInfo</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02070">_CONTROL_AREA::FilePointer</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l02691">FsRtlGetFileSize()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l02864">FsRtlSetFileSize()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02161">Mi4KStartForSubsection</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02190">Mi4KStartFromSubsection</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02412">MI_GET_PROTECTION_FROM_SOFT_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02127">MI_MAXIMUM_SECTION_SIZE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02486">MI_WRITE_INVALID_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01591">MiGetSubsectionAddressForPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00107">MM4K_MASK</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00106">MM4K_SHIFT</a>, <a class="el" href="../../d8/d8/alpha_2mialpha_8h.html#a213">MMPTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04833">MmSectionBasedMutex</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04839">MmSectionExtendResource</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04840">MmSectionExtendSetResource</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02124">_SUBSECTION::NextSubsection</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02075">_CONTROL_AREA::NonPagedPoolUsage</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02120">_SUBSECTION::NumberOfFullSectors</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02074">_CONTROL_AREA::PagedPoolUsage</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00036">PSECTION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02123">_SUBSECTION::PtesInSubsection</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00117">ROUND_TO_PAGES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02058">_CONTROL_AREA::Segment</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02010">_SEGMENT::SegmentPteTemplate</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02005">_SEGMENT::SizeOfSegment</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d8/mi_8h.html#a465">SUBSECTION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02121">_SUBSECTION::SubsectionBase</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02003">_SEGMENT::TotalNumberOfPtes</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d1/d7/struct__SUBSECTION.html#o3">_SUBSECTION::u</a>, <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html#o10">_CONTROL_AREA::u</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l02122">_SUBSECTION::UnusedPtes</a>.
<p>
Referenced by <a class="el" href="../../d6/d7/fssup_8c-source.html#l00387">CcInitializeCacheMap()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l01821">CcSetFileSizes()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l00390">MmCreateSection()</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>, and <a class="el" href="../../d9/d9/extsect_8c-source.html#l00085">NtExtendSection()</a>.
<p>
<pre class="fragment"><div>00209                    :
00210 
00211     This function extends <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified section.  If
00212     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> greater than or equal to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00213     specified section size, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not updated.
00214 
00215 Arguments:
00216 
00217     Section - Supplies a pointer to a referenced section object.
00218 
00219     NewSectionSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> size <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section object.
00220 
00221     IgnoreFileSizeChecking -  Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> size
00222                               checking should be ignored (i.e., it
00223                               is being called from a file system which
00224                               has already done the checks).  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00225                               <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> checks still need to be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a>.
00226 
00227 Return Value:
00228 
00229     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status
00230 
00231     TBS
00232 
00233 
00234 --*/
00235 
00236 {
00237     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00238     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
00239     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> ExtendedPtes;
00240     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00241     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
00242     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a> Section;
00243     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> LastSubsection;
00244     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> ExtendedSubsection;
00245     ULONG RequiredPtes;
00246     ULONG NumberOfPtes;
00247     ULONG PtesUsed;
00248     ULONG AllocationSize;
00249     UINT64 EndOfFile;
00250     UINT64 NumberOfPtesForEntireFile;
00251     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00252     LARGE_INTEGER NumberOf4KsForEntireFile;
00253     LARGE_INTEGER Starting4K;
00254     LARGE_INTEGER Last4KChunk;
00255 
00256     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00257 
00258     Section = (<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)SectionToExtend;
00259 
00260     <span class="comment">//</span>
00261     <span class="comment">// Make sure the section is really extendable - physical and</span>
00262     <span class="comment">// image sections are not.</span>
00263     <span class="comment">//</span>
00264 
00265     ControlArea = Section-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o0">ControlArea</a>;
00266 
00267     <span class="keywordflow">if</span> ((ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.PhysicalMemory || ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Image) ||
00268          (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00269         <span class="keywordflow">return</span> STATUS_SECTION_NOT_EXTENDED;
00270     }
00271 
00272     <span class="comment">//</span>
00273     <span class="comment">// Acquire the section extension mutex, this blocks other threads from</span>
00274     <span class="comment">// updating the size at the same time.</span>
00275     <span class="comment">//</span>
00276 
00277     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a> ();
00278     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a> (&amp;MmSectionExtendResource, TRUE);
00279 
00280     <span class="comment">//</span>
00281     <span class="comment">// Each subsection is limited to 16TB - 64K because the NumberOfFullSectors</span>
00282     <span class="comment">// and various other fields in the subsection are ULONGs.  For NT64, the</span>
00283     <span class="comment">// allocation could be split into multiple subsections as needed to</span>
00284     <span class="comment">// conform to this limit - this is not worth doing for NT32 unless</span>
00285     <span class="comment">// sparse prototype PTE allocations are supported.</span>
00286     <span class="comment">//</span>
00287 
00288     <span class="comment">// This must be a multiple of the size of prototype pte allocation so any</span>
00289     <span class="comment">// given prototype pte allocation will have the same subsection for all</span>
00290     <span class="comment">// PTEs.</span>
00291     <span class="comment">//</span>
00292     <span class="comment">// The total section size is limited to 16PB - 4K because of the</span>
00293     <span class="comment">// StartingSector4132 field in each subsection.</span>
00294     <span class="comment">//</span>
00295 
00296     NumberOfPtesForEntireFile = (NewSectionSize-&gt;QuadPart + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00297 
00298     NumberOfPtes = (ULONG)NumberOfPtesForEntireFile;
00299 
00300     <span class="keywordflow">if</span> (NewSectionSize-&gt;QuadPart &gt; <a class="code" href="../../d4/d8/mi_8h.html#a218">MI_MAXIMUM_SECTION_SIZE</a>) {
00301         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SECTION_TOO_BIG;
00302         <span class="keywordflow">goto</span> ReleaseAndReturn;
00303     }
00304 
00305     <span class="keywordflow">if</span> (NumberOfPtesForEntireFile &gt; (UINT64)((MAXULONG_PTR / <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>)) - <span class="keyword">sizeof</span> (<a class="code" href="../../d1/d1/struct__SEGMENT.html">SEGMENT</a>))) {
00306         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SECTION_TOO_BIG;
00307         <span class="keywordflow">goto</span> ReleaseAndReturn;
00308     }
00309 
00310     <span class="keywordflow">if</span> (NumberOfPtesForEntireFile &gt; (UINT64)NewSectionSize-&gt;QuadPart) {
00311         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SECTION_TOO_BIG;
00312         <span class="keywordflow">goto</span> ReleaseAndReturn;
00313     }
00314 
00315     <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.WasPurged == 0) {
00316 
00317         <span class="keywordflow">if</span> ((UINT64)NewSectionSize-&gt;QuadPart &lt;= (UINT64)Section-&gt;SizeOfSection.QuadPart) {
00318             *NewSectionSize = Section-&gt;SizeOfSection;
00319             <span class="keywordflow">goto</span> ReleaseAndReturnSuccess;
00320         }
00321     }
00322 
00323     <span class="comment">//</span>
00324     <span class="comment">// If a file handle was specified, set the allocation size of the file.</span>
00325     <span class="comment">//</span>
00326 
00327     <span class="keywordflow">if</span> (IgnoreFileSizeChecking == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00328 
00329         <span class="comment">//</span>
00330         <span class="comment">// Release the resource so we don't deadlock with the file</span>
00331         <span class="comment">// system trying to extend this section at the same time.</span>
00332         <span class="comment">//</span>
00333 
00334         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;MmSectionExtendResource);
00335 
00336         <span class="comment">//</span>
00337         <span class="comment">// Get a different resource to single thread query/set operations.</span>
00338         <span class="comment">//</span>
00339 
00340         <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a> (&amp;MmSectionExtendSetResource, TRUE);
00341 
00342         <span class="comment">//</span>
00343         <span class="comment">// Query the file size to see if this file really needs extending.</span>
00344         <span class="comment">//</span>
00345         <span class="comment">// If the specified size is less than the current size, return</span>
00346         <span class="comment">// the current size.</span>
00347         <span class="comment">//</span>
00348 
00349         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d8/fsrtl_8h.html#a109">FsRtlGetFileSize</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>,
00350                                    (PLARGE_INTEGER)&amp;EndOfFile);
00351 
00352         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (Status)) {
00353             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;MmSectionExtendSetResource);
00354             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a> ();
00355             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00356         }
00357 
00358         <span class="keywordflow">if</span> ((UINT64)NewSectionSize-&gt;QuadPart &gt; EndOfFile) {
00359 
00360             <span class="comment">//</span>
00361             <span class="comment">// Don't allow section extension unless the section was originally</span>
00362             <span class="comment">// created with write access.  The check couldn't be done at create</span>
00363             <span class="comment">// time without breaking existing binaries, so the caller gets the</span>
00364             <span class="comment">// error at this point instead.</span>
00365             <span class="comment">//</span>
00366 
00367             <span class="keywordflow">if</span> (((Section-&gt;InitialPageProtection &amp; PAGE_READWRITE) |
00368                 (Section-&gt;InitialPageProtection &amp; PAGE_EXECUTE_READWRITE)) == 0) {
00369 <span class="preprocessor">#if DBG</span>
00370 <span class="preprocessor"></span>                    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Section extension failed %x\n"</span>, Section);
00371 <span class="preprocessor">#endif</span>
00372 <span class="preprocessor"></span>                    <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;MmSectionExtendSetResource);
00373                     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a> ();
00374                     <span class="keywordflow">return</span> STATUS_SECTION_NOT_EXTENDED;
00375             }
00376 
00377             <span class="comment">//</span>
00378             <span class="comment">// Current file is smaller, attempt to set a new end of file.</span>
00379             <span class="comment">//</span>
00380 
00381             EndOfFile = *(PUINT64)NewSectionSize;
00382 
00383             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d8/fsrtl_8h.html#a110">FsRtlSetFileSize</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>,
00384                                        (PLARGE_INTEGER)&amp;EndOfFile);
00385 
00386             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (Status)) {
00387                 <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;MmSectionExtendSetResource);
00388                 <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a> ();
00389                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00390             }
00391         }
00392 
00393         <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o11">ExtendInfo</a>) {
00394             ExAcquireFastMutex (&amp;MmSectionBasedMutex);
00395             <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o11">ExtendInfo</a>) {
00396                 ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o11">ExtendInfo</a>-&gt;<a class="code" href="../../d0/d2/struct__MMEXTEND__INFO.html#o0">CommittedSize</a> = EndOfFile;
00397             }
00398             ExReleaseFastMutex (&amp;MmSectionBasedMutex);
00399         }
00400 
00401         <span class="comment">//</span>
00402         <span class="comment">// Release the query/set resource and reacquire the extend section</span>
00403         <span class="comment">// resource.</span>
00404         <span class="comment">//</span>
00405 
00406         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;MmSectionExtendSetResource);
00407         <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a> (&amp;MmSectionExtendResource, TRUE);
00408     }
00409 
00410     <span class="comment">//</span>
00411     <span class="comment">// Find the last subsection.</span>
00412     <span class="comment">//</span>
00413 
00414     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession == 0);
00415 
00416     LastSubsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)(ControlArea + 1);
00417 
00418     <span class="keywordflow">while</span> (LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00419         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o7">UnusedPtes</a> == 0);
00420         LastSubsection = LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
00421     }
00422 
00423 <span class="preprocessor">#if DBG</span>
00424 <span class="preprocessor"></span>    MiSubsectionConsistent(LastSubsection);
00425 <span class="preprocessor">#endif</span>
00426 <span class="preprocessor"></span>
00427     <span class="comment">//</span>
00428     <span class="comment">// Does the structure need extending?</span>
00429     <span class="comment">//</span>
00430 
00431     <span class="keywordflow">if</span> (NumberOfPtes &lt;= Section-&gt;Segment-&gt;TotalNumberOfPtes) {
00432 
00433         <span class="comment">//</span>
00434         <span class="comment">// The segment is already large enough, just update</span>
00435         <span class="comment">// the section size and return.</span>
00436         <span class="comment">//</span>
00437 
00438         Section-&gt;SizeOfSection = *NewSectionSize;
00439         <span class="keywordflow">if</span> (Section-&gt;Segment-&gt;SizeOfSegment &lt; (UINT64)NewSectionSize-&gt;QuadPart) {
00440             <span class="comment">//</span>
00441             <span class="comment">// Only update if it is really bigger.</span>
00442             <span class="comment">//</span>
00443 
00444             Section-&gt;Segment-&gt;SizeOfSegment = *(PUINT64)NewSectionSize;
00445 
00446             <a class="code" href="../../d4/d8/mi_8h.html#a220">Mi4KStartFromSubsection</a>(&amp;Starting4K, LastSubsection);
00447 
00448             Last4KChunk.QuadPart = (NewSectionSize-&gt;QuadPart &gt;&gt; <a class="code" href="../../d4/d8/mi_8h.html#a25">MM4K_SHIFT</a>) - Starting4K.QuadPart;
00449 
00450             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Last4KChunk.HighPart == 0);
00451 
00452             LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o5">NumberOfFullSectors</a> = Last4KChunk.LowPart;
00453             LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.SectorEndOffset =
00454                                         NewSectionSize-&gt;LowPart &amp; <a class="code" href="../../d4/d8/mi_8h.html#a26">MM4K_MASK</a>;
00455 <span class="preprocessor">#if DBG</span>
00456 <span class="preprocessor"></span>            MiSubsectionConsistent(LastSubsection);
00457 <span class="preprocessor">#endif</span>
00458 <span class="preprocessor"></span>        }
00459         <span class="keywordflow">goto</span> ReleaseAndReturnSuccess;
00460     }
00461 
00462     <span class="comment">//</span>
00463     <span class="comment">// Add new structures to the section - locate the last subsection</span>
00464     <span class="comment">// and add there.</span>
00465     <span class="comment">//</span>
00466 
00467     RequiredPtes = NumberOfPtes - Section-&gt;Segment-&gt;TotalNumberOfPtes;
00468     PtesUsed = 0;
00469 
00470     <span class="keywordflow">if</span> (RequiredPtes &lt; LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o7">UnusedPtes</a>) {
00471 
00472         <span class="comment">//</span>
00473         <span class="comment">// There are ample PTEs to extend the section already allocated.</span>
00474         <span class="comment">//</span>
00475 
00476         PtesUsed = RequiredPtes;
00477         RequiredPtes = 0;
00478 
00479     } <span class="keywordflow">else</span> {
00480         PtesUsed = LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o7">UnusedPtes</a>;
00481         RequiredPtes -= PtesUsed;
00482     }
00483 
00484     LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> += PtesUsed;
00485     LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o7">UnusedPtes</a> -= PtesUsed;
00486     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o4">SizeOfSegment</a> += (ULONG_PTR)PtesUsed * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00487     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o2">TotalNumberOfPtes</a> += PtesUsed;
00488 
00489     <span class="keywordflow">if</span> (RequiredPtes == 0) {
00490 
00491         <span class="comment">//</span>
00492         <span class="comment">// There is no extension necessary, update the high VBN.</span>
00493         <span class="comment">//</span>
00494 
00495         <a class="code" href="../../d4/d8/mi_8h.html#a220">Mi4KStartFromSubsection</a>(&amp;Starting4K, LastSubsection);
00496 
00497         Last4KChunk.QuadPart = (NewSectionSize-&gt;QuadPart &gt;&gt; <a class="code" href="../../d4/d8/mi_8h.html#a25">MM4K_SHIFT</a>) - Starting4K.QuadPart;
00498 
00499         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Last4KChunk.HighPart == 0);
00500 
00501         LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o5">NumberOfFullSectors</a> = Last4KChunk.LowPart;
00502 
00503         LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.SectorEndOffset =
00504                                     NewSectionSize-&gt;LowPart &amp; <a class="code" href="../../d4/d8/mi_8h.html#a26">MM4K_MASK</a>;
00505 <span class="preprocessor">#if DBG</span>
00506 <span class="preprocessor"></span>        MiSubsectionConsistent(LastSubsection);
00507 <span class="preprocessor">#endif</span>
00508 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
00509 
00510         <span class="comment">//</span>
00511         <span class="comment">// An extension is required.  Allocate paged pool</span>
00512         <span class="comment">// and populate it with prototype PTEs.</span>
00513         <span class="comment">//</span>
00514 
00515         AllocationSize = (ULONG) <a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a> (RequiredPtes * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
00516 
00517         ExtendedPtes = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (PagedPool,
00518                                                       AllocationSize,
00519                                                       'ppmM');
00520 
00521         <span class="keywordflow">if</span> (ExtendedPtes == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00522 
00523             <span class="comment">//</span>
00524             <span class="comment">// The required pool could not be allocated.  Reset</span>
00525             <span class="comment">// the subsection and control area fields to their</span>
00526             <span class="comment">// original values.</span>
00527             <span class="comment">//</span>
00528 
00529             LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> -= PtesUsed;
00530             LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o7">UnusedPtes</a> += PtesUsed;
00531             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o2">TotalNumberOfPtes</a> -= PtesUsed;
00532             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o4">SizeOfSegment</a> -= ((ULONG_PTR)PtesUsed * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00533             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00534             <span class="keywordflow">goto</span> ReleaseAndReturn;
00535         }
00536 
00537         <span class="comment">//</span>
00538         <span class="comment">// Allocate an extended subsection descriptor.</span>
00539         <span class="comment">//</span>
00540 
00541         ExtendedSubsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
00542                                                      <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d7/struct__SUBSECTION.html">SUBSECTION</a>),
00543                                                      'bSmM'
00544                                                      );
00545         <span class="keywordflow">if</span> (ExtendedSubsection == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00546 
00547             <span class="comment">//</span>
00548             <span class="comment">// The required pool could not be allocated.  Reset</span>
00549             <span class="comment">// the subsection and control area fields to their</span>
00550             <span class="comment">// original values.</span>
00551             <span class="comment">//</span>
00552 
00553             LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> -= PtesUsed;
00554             LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o7">UnusedPtes</a> += PtesUsed;
00555             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o2">TotalNumberOfPtes</a> -= PtesUsed;
00556             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o4">SizeOfSegment</a> -= ((ULONG_PTR)PtesUsed * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00557             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ExtendedPtes);
00558             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00559             <span class="keywordflow">goto</span> ReleaseAndReturn;
00560         }
00561 
00562         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o16">NonPagedPoolUsage</a> += <a class="code" href="../../d4/d2/pool_8h.html#a23">EX_REAL_POOL_USAGE</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d7/struct__SUBSECTION.html">SUBSECTION</a>));
00563         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o15">PagedPoolUsage</a> += AllocationSize;
00564     
00565         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o1">DereferenceList</a>.Flink == NULL);
00566 
00567         NumberOf4KsForEntireFile.QuadPart =
00568             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o4">SizeOfSegment</a> &gt;&gt; <a class="code" href="../../d4/d8/mi_8h.html#a25">MM4K_SHIFT</a>;
00569 
00570         <a class="code" href="../../d4/d8/mi_8h.html#a220">Mi4KStartFromSubsection</a>(&amp;Starting4K, LastSubsection);
00571 
00572         Last4KChunk.QuadPart = NumberOf4KsForEntireFile.QuadPart -
00573                                    Starting4K.QuadPart;
00574 
00575         <span class="keywordflow">if</span> (LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.SectorEndOffset) {
00576             Last4KChunk.QuadPart += 1;
00577         }
00578 
00579         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Last4KChunk.HighPart == 0);
00580 
00581         LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o5">NumberOfFullSectors</a> = Last4KChunk.LowPart;
00582         LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.SectorEndOffset = 0;
00583 
00584         <span class="comment">//</span>
00585         <span class="comment">// If the number of sectors doesn't completely fill the PTEs (this can</span>
00586         <span class="comment">// only happen when the page size is not MM4K), then fill it now.</span>
00587         <span class="comment">//</span>
00588 
00589         <span class="keywordflow">if</span> (LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o5">NumberOfFullSectors</a> &amp; ((1 &lt;&lt; (<a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a> - <a class="code" href="../../d4/d8/mi_8h.html#a25">MM4K_SHIFT</a>)) - 1)) {
00590             LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o5">NumberOfFullSectors</a> += 1;
00591         }
00592 
00593 <span class="preprocessor">#if DBG</span>
00594 <span class="preprocessor"></span>        MiSubsectionConsistent(LastSubsection);
00595 <span class="preprocessor">#endif</span>
00596 <span class="preprocessor"></span>
00597         ExtendedSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.LongFlags = 0;
00598         ExtendedSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00599         ExtendedSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o7">UnusedPtes</a> = (AllocationSize / <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>)) -
00600                                                     RequiredPtes;
00601 
00602         ExtendedSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a> = ControlArea;
00603         ExtendedSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> = RequiredPtes;
00604 
00605         Starting4K.QuadPart += LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o5">NumberOfFullSectors</a>;
00606 
00607         <a class="code" href="../../d4/d8/mi_8h.html#a219">Mi4KStartForSubsection</a>(&amp;Starting4K, ExtendedSubsection);
00608 
00609         Last4KChunk.QuadPart =
00610             (NewSectionSize-&gt;QuadPart &gt;&gt; <a class="code" href="../../d4/d8/mi_8h.html#a25">MM4K_SHIFT</a>) - Starting4K.QuadPart;
00611 
00612         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Last4KChunk.HighPart == 0);
00613 
00614         ExtendedSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o5">NumberOfFullSectors</a> = Last4KChunk.LowPart;
00615         ExtendedSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.SectorEndOffset =
00616                                     NewSectionSize-&gt;LowPart &amp; <a class="code" href="../../d4/d8/mi_8h.html#a26">MM4K_MASK</a>;
00617 
00618 <span class="preprocessor">#if DBG</span>
00619 <span class="preprocessor"></span>        MiSubsectionConsistent(ExtendedSubsection);
00620 <span class="preprocessor">#endif</span>
00621 <span class="preprocessor"></span>
00622         ExtendedSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a> = ExtendedPtes;
00623 
00624         PointerPte = ExtendedPtes;
00625         LastPte = ExtendedPtes + (AllocationSize / <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
00626 
00627         <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00628             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a149">MiGetSubsectionAddressForPte</a>(ExtendedSubsection);
00629         }
00630 <span class="preprocessor">#if DBG</span>
00631 <span class="preprocessor"></span>        <span class="keywordflow">else</span> {
00632             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM: Extend with no control area file pointer %x %x\n"</span>,
00633                 ExtendedSubsection, ControlArea);
00634             DbgBreakPoint();
00635         }
00636 <span class="preprocessor">#endif</span>
00637 <span class="preprocessor"></span>
00638         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o9">SegmentPteTemplate</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection;
00639         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype = 1;
00640         ExtendedSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.Protection =
00641             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a184">MI_GET_PROTECTION_FROM_SOFT_PTE</a>(&amp;TempPte);
00642 
00643         <span class="keywordflow">while</span> (PointerPte &lt; LastPte) {
00644             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, TempPte);
00645             PointerPte += 1;
00646         }
00647 
00648         <span class="comment">//</span>
00649         <span class="comment">// Link this into the list.</span>
00650         <span class="comment">//</span>
00651 
00652         LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a> = ExtendedSubsection;
00653         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o2">TotalNumberOfPtes</a> += RequiredPtes;
00654 
00655 <span class="preprocessor">#if defined(_ALPHA_) &amp;&amp; !defined(NT_UP)</span>
00656 <span class="preprocessor"></span>        <span class="comment">//</span>
00657         <span class="comment">// A memory barrier is required here to synchronize with</span>
00658         <span class="comment">// NtMapViewOfSection, which validates the specified offset against</span>
00659         <span class="comment">// the section object without holding lock synchronization.</span>
00660         <span class="comment">// This memory barrier forces the subsection chaining to be correct</span>
00661         <span class="comment">// before increasing the size in the section object.</span>
00662         <span class="comment">//</span>
00663         __MB();
00664 <span class="preprocessor">#endif</span>
00665 <span class="preprocessor"></span>
00666     }
00667 
00668     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o4">SizeOfSegment</a> = *(PUINT64)NewSectionSize;
00669     Section-&gt;SizeOfSection = *NewSectionSize;
00670 
00671 ReleaseAndReturnSuccess:
00672 
00673     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00674 
00675 ReleaseAndReturn:
00676 
00677     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;MmSectionExtendResource);
00678     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a> ();
00679 
00680     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00681 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="extsect.c::NtExtendSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtExtendSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>NewSectionSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/extsect_8c-source.html#l00085">85</a> of file <a class="el" href="../../d9/d9/extsect_8c-source.html">extsect.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d9/d9/extsect_8c-source.html#l00201">MmExtendSection()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00381">MmSectionObjectType</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00036">PSECTION</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>00092                    :
00093 
00094     This function extends <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified section.  If
00095     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> greater than or equal to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00096     specified section size, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not updated.
00097 
00098 Arguments:
00099 
00100     SectionHandle - Supplies an open handle to a section object.
00101 
00102     NewSectionSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> size <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section object.
00103 
00104 Return Value:
00105 
00106     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status
00107 
00108     TBS
00109 
00110 
00111 --*/
00112 
00113 {
00114     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00115     PVOID Section;
00116     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00117     LARGE_INTEGER CapturedNewSectionSize;
00118 
00119     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00120 
00121     <span class="comment">//</span>
00122     <span class="comment">// Check to make sure the new section size is accessible.</span>
00123     <span class="comment">//</span>
00124 
00125     PreviousMode = KeGetPreviousMode();
00126 
00127     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00128 
00129         <span class="keywordflow">try</span> {
00130 
00131             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a> (NewSectionSize,
00132                            <span class="keyword">sizeof</span>(LARGE_INTEGER),
00133                            <span class="keyword">sizeof</span>(ULONG ));
00134 
00135             CapturedNewSectionSize = *NewSectionSize;
00136 
00137         } except (EXCEPTION_EXECUTE_HANDLER) {
00138 
00139             <span class="comment">//</span>
00140             <span class="comment">// If an exception occurs during the probe or capture</span>
00141             <span class="comment">// of the initial values, then handle the exception and</span>
00142             <span class="comment">// return the exception code as the status value.</span>
00143             <span class="comment">//</span>
00144 
00145             <span class="keywordflow">return</span> GetExceptionCode();
00146         }
00147 
00148     } <span class="keywordflow">else</span> {
00149 
00150         CapturedNewSectionSize = *NewSectionSize;
00151     }
00152 
00153     <span class="comment">//</span>
00154     <span class="comment">// Reference the section object.</span>
00155     <span class="comment">//</span>
00156 
00157     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> ( SectionHandle,
00158                                          SECTION_EXTEND_SIZE,
00159                                          MmSectionObjectType,
00160                                          PreviousMode,
00161                                          (PVOID *)&amp;Section,
00162                                          NULL );
00163 
00164     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00165         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00166     }
00167 
00168     <span class="comment">//</span>
00169     <span class="comment">// Make sure this section is backed by a file.</span>
00170     <span class="comment">//</span>
00171 
00172     <span class="keywordflow">if</span> (((<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)Section)-&gt;Segment-&gt;ControlArea-&gt;FilePointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00173         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (Section);
00174         <span class="keywordflow">return</span> STATUS_SECTION_NOT_EXTENDED;
00175     }
00176 
00177     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d0/extsect_8c.html#a1">MmExtendSection</a> (Section, &amp;CapturedNewSectionSize, FALSE);
00178 
00179     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (Section);
00180 
00181     <span class="comment">//</span>
00182     <span class="comment">// Update the NewSectionSize field.</span>
00183     <span class="comment">//</span>
00184 
00185     <span class="keywordflow">try</span> {
00186 
00187         <span class="comment">//</span>
00188         <span class="comment">// Return the captured section size.</span>
00189         <span class="comment">//</span>
00190 
00191         *NewSectionSize = CapturedNewSectionSize;
00192 
00193     } except (EXCEPTION_EXECUTE_HANDLER) {
00194         NOTHING;
00195     }
00196 
00197     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00198 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:36 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
