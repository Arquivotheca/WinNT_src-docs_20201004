<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: power.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>power.c</h1><a href="../../d7/d2/power_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: power.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains the code to implement power management.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 02-Dec-1996 JerrySh   Created.</span>
00010 <span class="comment">\***************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span>
00015 <span class="preprocessor">#include &lt;ntcsrmsg.h&gt;</span>
00016 <span class="preprocessor">#include "<a class="code" href="../../d2/d0/csrmsg_8h.html">csrmsg.h</a>"</span>
00017 <span class="preprocessor">#include "ntddvdeo.h"</span>
00018 
00019 <span class="preprocessor">#pragma alloc_text(INIT, InitializePowerRequestList)</span>
00020 <span class="preprocessor"></span>
<a name="l00021"></a><a class="code" href="../../d7/d2/power_8c.html#a0">00021</a> <span class="keyword">extern</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d7/d2/power_8c.html#a0">gbUserInitialized</a>;
<a name="l00022"></a><a class="code" href="../../d7/d2/power_8c.html#a1">00022</a> <span class="keyword">extern</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d6/desktop_8c.html#a3">fGdiEnabled</a>;
00023 
<a name="l00024"></a><a class="code" href="../../d7/d2/power_8c.html#a2">00024</a> LIST_ENTRY <a class="code" href="../../d7/d2/power_8c.html#a2">gPowerRequestList</a>;
<a name="l00025"></a><a class="code" href="../../d7/d2/power_8c.html#a3">00025</a> <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a> <a class="code" href="../../d7/d2/power_8c.html#a3">gpPowerRequestMutex</a>;
<a name="l00026"></a><a class="code" href="../../d7/d2/power_8c.html#a4">00026</a> <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> <a class="code" href="../../d7/d2/power_8c.html#a4">gpEventPowerRequest</a>;
<a name="l00027"></a><a class="code" href="../../d7/d2/power_8c.html#a5">00027</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    <a class="code" href="../../d7/d2/power_8c.html#a5">gbHibernate</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00028 
<a name="l00029"></a><a class="code" href="../../d5/d3/structtagPOWERREQUEST.html">00029</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d5/d3/structtagPOWERREQUEST.html">tagPOWERREQUEST</a> {
<a name="l00030"></a><a class="code" href="../../d5/d3/structtagPOWERREQUEST.html#o0">00030</a>     LIST_ENTRY        <a class="code" href="../../d5/d3/structtagPOWERREQUEST.html#o0">PowerRequestLink</a>;
<a name="l00031"></a><a class="code" href="../../d5/d3/structtagPOWERREQUEST.html#o1">00031</a>     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>            <a class="code" href="../../d5/d3/structtagPOWERREQUEST.html#o1">Event</a>;
<a name="l00032"></a><a class="code" href="../../d5/d3/structtagPOWERREQUEST.html#o2">00032</a>     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>          <a class="code" href="../../d5/d3/structtagPOWERREQUEST.html#o2">Status</a>;
<a name="l00033"></a><a class="code" href="../../d5/d3/structtagPOWERREQUEST.html#o3">00033</a>     <a class="code" href="../../d5/d8/struct__WIN32__POWEREVENT__PARAMETERS.html">PKWIN32_POWEREVENT_PARAMETERS</a> <a class="code" href="../../d5/d3/structtagPOWERREQUEST.html#o3">Parms</a>;
00034 } <a class="code" href="../../d5/d3/structtagPOWERREQUEST.html">POWERREQUEST</a>, *<a class="code" href="../../d5/d3/structtagPOWERREQUEST.html">PPOWERREQUEST</a>;
00035 
<a name="l00036"></a><a class="code" href="../../d7/d2/power_8c.html#a8">00036</a> <a class="code" href="../../d7/d2/power_8c.html#a7">PPOWERREQUEST</a> <a class="code" href="../../d7/d2/power_8c.html#a8">gpPowerRequestCurrent</a>;
00037 
<a name="l00038"></a><a class="code" href="../../d7/d2/power_8c.html#a9">00038</a> __inline <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d7/d2/power_8c.html#a9">EnterPowerCrit</a>() {
00039     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00040     <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>(<a class="code" href="../../d7/d2/power_8c.html#a3">gpPowerRequestMutex</a>);
00041 }
00042 
<a name="l00043"></a><a class="code" href="../../d7/d2/power_8c.html#a10">00043</a> __inline <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d7/d2/power_8c.html#a10">LeavePowerCrit</a>() {
00044     <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>(<a class="code" href="../../d7/d2/power_8c.html#a3">gpPowerRequestMutex</a>);
00045     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00046 }
00047 
00048 <span class="comment">/***************************************************************************\</span>
00049 <span class="comment">* CancelPowerRequest</span>
00050 <span class="comment">*</span>
00051 <span class="comment">* The power request can't be satisfied because the worker thread is gone.</span>
00052 <span class="comment">*</span>
00053 <span class="comment">* History:</span>
00054 <span class="comment">* 20-Oct-1998 JerrySh   Created.</span>
00055 <span class="comment">\***************************************************************************/</span>
00056 
00057 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00058"></a><a class="code" href="../../d7/d2/power_8c.html#a11">00058</a> <a class="code" href="../../d7/d2/power_8c.html#a11">CancelPowerRequest</a>(
00059     PPOWERREQUEST pPowerRequest)
00060 {
00061     UserAssert(pPowerRequest != <a class="code" href="../../d7/d2/power_8c.html#a8">gpPowerRequestCurrent</a>);
00062     pPowerRequest-&gt;<a class="code" href="../../d5/d3/structtagPOWERREQUEST.html#o2">Status</a> = STATUS_UNSUCCESSFUL;
00063     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(&amp;pPowerRequest-&gt;<a class="code" href="../../d5/d3/structtagPOWERREQUEST.html#o1">Event</a>, <a class="code" href="../../d7/d8/exboosts_8h.html#a0">EVENT_INCREMENT</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00064 }
00065 
00066 <span class="comment">/***************************************************************************\</span>
00067 <span class="comment">* QueuePowerRequest</span>
00068 <span class="comment">*</span>
00069 <span class="comment">* Insert a power request into the list and wakeup CSRSS to process it.</span>
00070 <span class="comment">*</span>
00071 <span class="comment">* History:</span>
00072 <span class="comment">* 20-Oct-1998 JerrySh   Created.</span>
00073 <span class="comment">\***************************************************************************/</span>
00074 
00075 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00076"></a><a class="code" href="../../d7/d2/power_8c.html#a12">00076</a> <a class="code" href="../../d7/d2/power_8c.html#a12">QueuePowerRequest</a>(
00077     <a class="code" href="../../d5/d8/struct__WIN32__POWEREVENT__PARAMETERS.html">PKWIN32_POWEREVENT_PARAMETERS</a> Parms)
00078 {
00079     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00080     <a class="code" href="../../d7/d2/power_8c.html#a7">PPOWERREQUEST</a> pPowerRequest;
00081     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlPool;
00082 
00083     UserAssert(<a class="code" href="../../d7/d2/power_8c.html#a4">gpEventPowerRequest</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00084     UserAssert(<a class="code" href="../../d7/d2/power_8c.html#a3">gpPowerRequestMutex</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00085 
00086     <span class="comment">/*</span>
00087 <span class="comment">     * Allocate and initialize the power request.</span>
00088 <span class="comment">     */</span>
00089     pPowerRequest = UserAllocPoolNonPaged(<span class="keyword">sizeof</span>(<a class="code" href="../../d5/d3/structtagPOWERREQUEST.html">POWERREQUEST</a>), TAG_POWER);
00090     <span class="keywordflow">if</span> (pPowerRequest == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00091         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00092     }
00093     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;pPowerRequest-&gt;<a class="code" href="../../d5/d3/structtagPOWERREQUEST.html#o1">Event</a>, SynchronizationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00094     pPowerRequest-&gt;<a class="code" href="../../d5/d3/structtagPOWERREQUEST.html#o3">Parms</a> = Parms;
00095 
00096     <span class="comment">/*</span>
00097 <span class="comment">     * Insert the power request into the list.</span>
00098 <span class="comment">     */</span>
00099     <a class="code" href="../../d7/d2/power_8c.html#a9">EnterPowerCrit</a>();
00100     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a324">gbNoMorePowerCallouts</a>) {
00101         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
00102     } <span class="keywordflow">else</span> {
00103         InsertHeadList(&amp;<a class="code" href="../../d7/d2/power_8c.html#a2">gPowerRequestList</a>, &amp;pPowerRequest-&gt;<a class="code" href="../../d5/d3/structtagPOWERREQUEST.html#o0">PowerRequestLink</a>);
00104     }
00105     <a class="code" href="../../d7/d2/power_8c.html#a10">LeavePowerCrit</a>();
00106 
00107     <span class="comment">/*</span>
00108 <span class="comment">     * If this is a system thread or a non-GUI thread, tell CSRSS to do the</span>
00109 <span class="comment">     * work and wait for it to finish. Otherwise, we'll do the work ourselves.</span>
00110 <span class="comment">     */</span>
00111     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00112         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a18">IS_SYSTEM_THREAD</a>(<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()) ||
00113                 W32GetCurrentThread() == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00114             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(<a class="code" href="../../d7/d2/power_8c.html#a4">gpEventPowerRequest</a>, <a class="code" href="../../d7/d8/exboosts_8h.html#a0">EVENT_INCREMENT</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00115         } <span class="keywordflow">else</span> {
00116             <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00117             <a class="code" href="../../d4/d1/userk_8h.html#a137">ThreadLockPool</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), pPowerRequest, &amp;tlPool);
00118             <a class="code" href="../../d4/d1/userk_8h.html#a1969">xxxUserPowerCalloutWorker</a>();
00119             <a class="code" href="../../d4/d1/userk_8h.html#a138">ThreadUnlockPool</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), &amp;tlPool);
00120             <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00121         }
00122         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;pPowerRequest-&gt;<a class="code" href="../../d5/d3/structtagPOWERREQUEST.html#o1">Event</a>,
00123                                        <a class="code" href="../../d4/d9/ke_8h.html#a407a211">WrUserRequest</a>,
00124                                        <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00125                                        <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00126                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00127 
00128         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00129             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = pPowerRequest-&gt;<a class="code" href="../../d5/d3/structtagPOWERREQUEST.html#o2">Status</a>;
00130         }
00131     }
00132 
00133     <span class="comment">/*</span>
00134 <span class="comment">     * Free the power request.</span>
00135 <span class="comment">     */</span>
00136     UserAssert(pPowerRequest != <a class="code" href="../../d7/d2/power_8c.html#a8">gpPowerRequestCurrent</a>);
00137     UserFreePool(pPowerRequest);
00138 
00139     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00140 }
00141 
00142 <span class="comment">/***************************************************************************\</span>
00143 <span class="comment">* UnqueuePowerRequest</span>
00144 <span class="comment">*</span>
00145 <span class="comment">* Remove a power request from the list.</span>
00146 <span class="comment">*</span>
00147 <span class="comment">* History:</span>
00148 <span class="comment">* 20-Oct-1998 JerrySh   Created.</span>
00149 <span class="comment">\***************************************************************************/</span>
00150 
00151 <a class="code" href="../../d7/d2/power_8c.html#a7">PPOWERREQUEST</a>
<a name="l00152"></a><a class="code" href="../../d7/d2/power_8c.html#a13">00152</a> <a class="code" href="../../d7/d2/power_8c.html#a13">UnqueuePowerRequest</a>(VOID)
00153 {
00154     PLIST_ENTRY pEntry;
00155     <a class="code" href="../../d7/d2/power_8c.html#a7">PPOWERREQUEST</a> pPowerRequest = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00156 
00157     <span class="comment">/*</span>
00158 <span class="comment">     * Remove a power request from the list.</span>
00159 <span class="comment">     */</span>
00160     <a class="code" href="../../d7/d2/power_8c.html#a9">EnterPowerCrit</a>();
00161     <span class="keywordflow">if</span> (!IsListEmpty(&amp;<a class="code" href="../../d7/d2/power_8c.html#a2">gPowerRequestList</a>)) {
00162         pEntry = RemoveTailList(&amp;<a class="code" href="../../d7/d2/power_8c.html#a2">gPowerRequestList</a>);
00163         pPowerRequest = CONTAINING_RECORD(pEntry, <a class="code" href="../../d5/d3/structtagPOWERREQUEST.html">POWERREQUEST</a>, PowerRequestLink);
00164     }
00165     <a class="code" href="../../d7/d2/power_8c.html#a10">LeavePowerCrit</a>();
00166 
00167     <span class="keywordflow">return</span> pPowerRequest;
00168 }
00169 
00170 <span class="comment">/***************************************************************************\</span>
00171 <span class="comment">* InitializePowerRequestList</span>
00172 <span class="comment">*</span>
00173 <span class="comment">* Initialize global power request list state.</span>
00174 <span class="comment">*</span>
00175 <span class="comment">* History:</span>
00176 <span class="comment">* 20-Oct-1998 JerrySh   Created.</span>
00177 <span class="comment">\***************************************************************************/</span>
00178 
00179 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00180"></a><a class="code" href="../../d4/d1/userk_8h.html#a1966">00180</a> <a class="code" href="../../d4/d1/userk_8h.html#a1966">InitializePowerRequestList</a>(
00181     HANDLE hPowerRequestEvent)
00182 {
00183     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00184 
00185     InitializeListHead(&amp;<a class="code" href="../../d7/d2/power_8c.html#a2">gPowerRequestList</a>);
00186 
00187     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(hPowerRequestEvent,
00188                                        EVENT_ALL_ACCESS,
00189                                        *<a class="code" href="../../d7/d7/ntapi_8c.html#a3">ExEventObjectType</a>,
00190                                        <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00191                                        &amp;<a class="code" href="../../d7/d2/power_8c.html#a4">gpEventPowerRequest</a>,
00192                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00193     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00194         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00195     }
00196 
00197     <a class="code" href="../../d7/d2/power_8c.html#a3">gpPowerRequestMutex</a> = UserAllocPoolNonPaged(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a>), TAG_POWER);
00198     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d2/power_8c.html#a3">gpPowerRequestMutex</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00199         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00200     }
00201     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(<a class="code" href="../../d7/d2/power_8c.html#a3">gpPowerRequestMutex</a>);
00202 
00203     <span class="keywordflow">return</span> STATUS_SUCCESS;
00204 }
00205 
00206 <span class="comment">/***************************************************************************\</span>
00207 <span class="comment">* CleanupPowerRequestList</span>
00208 <span class="comment">*</span>
00209 <span class="comment">* Cancel any pending power requests.</span>
00210 <span class="comment">*</span>
00211 <span class="comment">* History:</span>
00212 <span class="comment">* 20-Oct-1998 JerrySh   Created.</span>
00213 <span class="comment">\***************************************************************************/</span>
00214 
00215 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00216"></a><a class="code" href="../../d4/d1/userk_8h.html#a1967">00216</a> <a class="code" href="../../d4/d1/userk_8h.html#a1967">CleanupPowerRequestList</a>(VOID)
00217 {
00218     <a class="code" href="../../d7/d2/power_8c.html#a7">PPOWERREQUEST</a> pPowerRequest;
00219 
00220     <span class="comment">/*</span>
00221 <span class="comment">     * Make sure no new power requests come in.</span>
00222 <span class="comment">     */</span>
00223     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a324">gbNoMorePowerCallouts</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00224 
00225     <span class="comment">/*</span>
00226 <span class="comment">     * If we never allocated anything, there's nothing to clean up.</span>
00227 <span class="comment">     */</span>
00228     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d2/power_8c.html#a3">gpPowerRequestMutex</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00229         <span class="keywordflow">return</span>;
00230     }
00231 
00232     <span class="comment">/*</span>
00233 <span class="comment">     * Mark any pending power requests as cacelled.</span>
00234 <span class="comment">     */</span>
00235     <span class="keywordflow">while</span> ((pPowerRequest = <a class="code" href="../../d7/d2/power_8c.html#a13">UnqueuePowerRequest</a>()) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00236         <a class="code" href="../../d7/d2/power_8c.html#a11">CancelPowerRequest</a>(pPowerRequest);
00237     }
00238 }
00239 
00240 <span class="comment">/***************************************************************************\</span>
00241 <span class="comment">* DeletePowerRequestList</span>
00242 <span class="comment">*</span>
00243 <span class="comment">* Clean up any global power request state.</span>
00244 <span class="comment">*</span>
00245 <span class="comment">* History:</span>
00246 <span class="comment">* 20-Oct-1998 JerrySh   Created.</span>
00247 <span class="comment">\***************************************************************************/</span>
00248 
00249 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00250"></a><a class="code" href="../../d4/d1/userk_8h.html#a1968">00250</a> <a class="code" href="../../d4/d1/userk_8h.html#a1968">DeletePowerRequestList</a>(VOID)
00251 {
00252     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d2/power_8c.html#a3">gpPowerRequestMutex</a>) {
00253 
00254         <span class="comment">/*</span>
00255 <span class="comment">         * Make sure there are no pending power requests.</span>
00256 <span class="comment">         */</span>
00257         UserAssert(IsListEmpty(&amp;<a class="code" href="../../d7/d2/power_8c.html#a2">gPowerRequestList</a>));
00258 
00259         <span class="comment">/*</span>
00260 <span class="comment">         * Free the power request structures.</span>
00261 <span class="comment">         */</span>
00262         UserFreePool(<a class="code" href="../../d7/d2/power_8c.html#a3">gpPowerRequestMutex</a>);
00263         <a class="code" href="../../d7/d2/power_8c.html#a3">gpPowerRequestMutex</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00264     }
00265 }
00266 
00267 <span class="comment">/***************************************************************************\</span>
00268 <span class="comment">* UserPowerEventCalloutWorker</span>
00269 <span class="comment">*</span>
00270 <span class="comment">* History:</span>
00271 <span class="comment">* 02-Dec-1996 JerrySh   Created.</span>
00272 <span class="comment">\***************************************************************************/</span>
00273 
<a name="l00274"></a><a class="code" href="../../d7/d2/power_8c.html#a17">00274</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d7/d2/power_8c.html#a17">xxxUserPowerEventCalloutWorker</a>(
00275     <a class="code" href="../../d5/d8/struct__WIN32__POWEREVENT__PARAMETERS.html">PKWIN32_POWEREVENT_PARAMETERS</a> Parms)
00276 {
00277     <a class="code" href="../../d3/d1/structBROADCASTSYSTEMMSGPARAMS.html">BROADCASTSYSTEMMSGPARAMS</a> bsmParams;
00278     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00279     <a class="code" href="../../d1/d9/ps_8h.html#a81">PSPOWEREVENTTYPE</a> EventNumber = Parms-&gt;<a class="code" href="../../d5/d8/struct__WIN32__POWEREVENT__PARAMETERS.html#o0">EventNumber</a>;
00280     ULONG_PTR Code = Parms-&gt;<a class="code" href="../../d5/d8/struct__WIN32__POWEREVENT__PARAMETERS.html#o1">Code</a>;
00281     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bCurrentPowerOn;
00282 
00283     <span class="comment">/*</span>
00284 <span class="comment">     * Make sure CSRSS is still running.</span>
00285 <span class="comment">     */</span>
00286     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a324">gbNoMorePowerCallouts</a>) {
00287         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00288     }
00289 
00290     <span class="keywordflow">switch</span> (EventNumber) {
00291     <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/ps_8h.html#a158a98">PsW32FullWake</a>:
00292         <span class="comment">/*</span>
00293 <span class="comment">         * Let all the applications know that they can resume operation.</span>
00294 <span class="comment">         */</span>
00295         bsmParams.<a class="code" href="../../d3/d1/structBROADCASTSYSTEMMSGPARAMS.html#o0">dwRecipients</a> = BSM_ALLDESKTOPS;
00296         bsmParams.<a class="code" href="../../d3/d1/structBROADCASTSYSTEMMSGPARAMS.html#o1">dwFlags</a> = BSF_QUEUENOTIFYMESSAGE;
00297         <a class="code" href="../../d4/d1/userk_8h.html#a1577">xxxSendMessageBSM</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00298                           WM_POWERBROADCAST,
00299                           PBT_APMRESUMESUSPEND,
00300                           0,
00301                           &amp;bsmParams);
00302         <span class="keywordflow">break</span>;
00303 
00304     <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/ps_8h.html#a158a99">PsW32EventCode</a>:
00305         <span class="comment">/*</span>
00306 <span class="comment">         * Post a message to winlogon, and let them put up a message box</span>
00307 <span class="comment">         * or play a sound.</span>
00308 <span class="comment">         */</span>
00309 
00310         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a>) {
00311             <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a>, WM_LOGONNOTIFY, LOGON_PLAYPOWERSOUND, (ULONG)Code);
00312             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00313         } <span class="keywordflow">else</span> {
00314             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
00315         }
00316 
00317         <span class="keywordflow">break</span>;
00318 
00319     <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/ps_8h.html#a158a100">PsW32PowerPolicyChanged</a>:
00320         <span class="comment">/*</span>
00321 <span class="comment">         * Set video timeout value.</span>
00322 <span class="comment">         */</span>
00323         <a class="code" href="../../d4/d1/userk_8h.html#a1493">xxxSystemParametersInfo</a>(SPI_SETLOWPOWERTIMEOUT, (ULONG)Code, 0, 0);
00324         <a class="code" href="../../d4/d1/userk_8h.html#a1493">xxxSystemParametersInfo</a>(SPI_SETPOWEROFFTIMEOUT, (ULONG)Code, 0, 0);
00325         <span class="keywordflow">break</span>;
00326 
00327     <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/ps_8h.html#a158a101">PsW32SystemPowerState</a>:
00328         <span class="comment">/*</span>
00329 <span class="comment">         * Let all the applications know that the power status has changed.</span>
00330 <span class="comment">         */</span>
00331         bsmParams.<a class="code" href="../../d3/d1/structBROADCASTSYSTEMMSGPARAMS.html#o0">dwRecipients</a> = BSM_ALLDESKTOPS;
00332         bsmParams.<a class="code" href="../../d3/d1/structBROADCASTSYSTEMMSGPARAMS.html#o1">dwFlags</a> = BSF_POSTMESSAGE;
00333         <a class="code" href="../../d4/d1/userk_8h.html#a1577">xxxSendMessageBSM</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00334                           WM_POWERBROADCAST,
00335                           PBT_APMPOWERSTATUSCHANGE,
00336                           0,
00337                           &amp;bsmParams);
00338         <span class="keywordflow">break</span>;
00339 
00340     <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/ps_8h.html#a158a102">PsW32SystemTime</a>:
00341         <span class="comment">/*</span>
00342 <span class="comment">         * Let all the applications know that the system time has changed.</span>
00343 <span class="comment">         */</span>
00344         bsmParams.<a class="code" href="../../d3/d1/structBROADCASTSYSTEMMSGPARAMS.html#o0">dwRecipients</a> = BSM_ALLDESKTOPS;
00345         bsmParams.<a class="code" href="../../d3/d1/structBROADCASTSYSTEMMSGPARAMS.html#o1">dwFlags</a> = BSF_POSTMESSAGE;
00346         <a class="code" href="../../d4/d1/userk_8h.html#a1577">xxxSendMessageBSM</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00347                           WM_TIMECHANGE,
00348                           0,
00349                           0,
00350                           &amp;bsmParams);
00351         <span class="keywordflow">break</span>;
00352 
00353     <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/ps_8h.html#a158a103">PsW32DisplayState</a>:
00354         <span class="comment">/*</span>
00355 <span class="comment">         * Set video timeout active status.</span>
00356 <span class="comment">         */</span>
00357         <a class="code" href="../../d4/d1/userk_8h.html#a1493">xxxSystemParametersInfo</a>(SPI_SETLOWPOWERACTIVE, !Code, 0, 0);
00358         <a class="code" href="../../d4/d1/userk_8h.html#a1493">xxxSystemParametersInfo</a>(SPI_SETPOWEROFFACTIVE, !Code, 0, 0);
00359         <span class="keywordflow">break</span>;
00360 
00361     <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/ps_8h.html#a158a106">PsW32GdiOff</a>:
00362         <span class="comment">/*</span>
00363 <span class="comment">         * At this point we will disable the display device</span>
00364 <span class="comment">         */</span>
00365 
00366         DrvSetMonitorPowerState(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>, PowerDeviceD3);
00367 
00368         bCurrentPowerOn = DrvQueryMDEVPowerState(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>);
00369         <span class="keywordflow">if</span> (bCurrentPowerOn) {
00370             DrvDisableMDEV(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00371         }
00372         DrvSetMDEVPowerState(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00373 
00374         <span class="keywordflow">break</span>;
00375 
00376     <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/ps_8h.html#a158a107">PsW32GdiOn</a>:
00377         <span class="comment">/*</span>
00378 <span class="comment">         * Call video driver to turn the display back on.</span>
00379 <span class="comment">         */</span>
00380         bCurrentPowerOn = DrvQueryMDEVPowerState(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>);
00381         <span class="keywordflow">if</span> (!bCurrentPowerOn) {
00382             DrvEnableMDEV(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00383         }
00384         DrvSetMDEVPowerState(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00385         DrvSetMonitorPowerState(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>, PowerDeviceD0);
00386 
00387         <span class="comment">/*</span>
00388 <span class="comment">         * Repaint the whole screen</span>
00389 <span class="comment">         */</span>
00390         <a class="code" href="../../d9/d6/desktop_8c.html#a26">xxxUserResetDisplayDevice</a>();
00391 
00392         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d2/power_8c.html#a5">gbHibernate</a>)
00393         {
00394             HANDLE pdo;
00395 
00396             PVOID PhysDisp = DrvWakeupHandler(&amp;pdo);
00397 
00398             <span class="keywordflow">if</span> (PhysDisp)
00399             {
00400                 UNICODE_STRING   strDeviceName;
00401                 DEVMODEW         NewMode;
00402                 ULONG            bPrune;
00403 
00404                 <span class="keywordflow">if</span> (DrvDisplaySwitchHandler(PhysDisp, &amp;strDeviceName, &amp;NewMode, &amp;bPrune))
00405                 {
00406                     <span class="comment">/*</span>
00407 <span class="comment">                     * CSRSS is not the only process to diliver power callout</span>
00408 <span class="comment">                     */</span>
00409                     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>()) {
00410                         <a class="code" href="../../d4/d1/userk_8h.html#a1758">xxxUserChangeDisplaySettings</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>,
00411                                  ((bPrune) ? 0 : CDS_RAWMODE) | CDS_TRYCLOSEST | CDS_RESET, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>);
00412                     }
00413                     <span class="keywordflow">else</span>
00414                     {
00415                         DESKRESTOREDATA drdRestore;
00416 
00417                         drdRestore.pdeskRestore = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00418                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d4/d1/userk_8h.html#a1829">xxxSetCsrssThreadDesktop</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>, &amp;drdRestore)) )
00419                         {
00420                             <a class="code" href="../../d4/d1/userk_8h.html#a1758">xxxUserChangeDisplaySettings</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00421                                      ((bPrune) ? 0 : CDS_RAWMODE) | CDS_TRYCLOSEST | CDS_RESET, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>);
00422                             <a class="code" href="../../d4/d1/userk_8h.html#a1830">xxxRestoreCsrssThreadDesktop</a>(&amp;drdRestore);
00423                         }
00424                     }
00425                 }
00426 
00427                 <span class="comment">//</span>
00428                 <span class="comment">// If there is a requirement to reenumerate sub-devices</span>
00429                 <span class="comment">//</span>
00430                 <span class="keywordflow">if</span> (pdo)
00431                 {
00432                     <a class="code" href="../../d8/d0/pnpioapi_8c.html#a79">IoInvalidateDeviceRelations</a>((<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>)pdo, <a class="code" href="../../d0/d5/io_8h.html#a602a412">BusRelations</a>);
00433                 }
00434             }
00435         }
00436         <a class="code" href="../../d7/d2/power_8c.html#a5">gbHibernate</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00437 
00438         <span class="keywordflow">break</span>;
00439 
00440     <span class="keywordflow">default</span>:
00441         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_IMPLEMENTED;
00442         <span class="keywordflow">break</span>;
00443     }
00444 
00445     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00446 }
00447 
00448 <span class="comment">/***************************************************************************\</span>
00449 <span class="comment">* UserPowerEventCallout</span>
00450 <span class="comment">*</span>
00451 <span class="comment">* History:</span>
00452 <span class="comment">* 02-Dec-1996 JerrySh   Created.</span>
00453 <span class="comment">\***************************************************************************/</span>
00454 
<a name="l00455"></a><a class="code" href="../../d7/d2/power_8c.html#a18">00455</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d7/d2/power_8c.html#a18">UserPowerEventCallout</a>(
00456     <a class="code" href="../../d5/d8/struct__WIN32__POWEREVENT__PARAMETERS.html">PKWIN32_POWEREVENT_PARAMETERS</a> Parms)
00457 {
00458 
00459     <span class="comment">/*</span>
00460 <span class="comment">     * Make sure CSRSS is running.</span>
00461 <span class="comment">     */</span>
00462     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a323">gbVideoInitialized</a> || <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a324">gbNoMorePowerCallouts</a>) {
00463         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00464     }
00465 
00466     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00467 
00468     <span class="comment">/*</span>
00469 <span class="comment">     * Process the power request.</span>
00470 <span class="comment">     */</span>
00471     <span class="keywordflow">return</span> <a class="code" href="../../d7/d2/power_8c.html#a12">QueuePowerRequest</a>(Parms);
00472 }
00473 
00474 <span class="comment">/***************************************************************************\</span>
00475 <span class="comment">* UserPowerStateCalloutWorker</span>
00476 <span class="comment">*</span>
00477 <span class="comment">* History:</span>
00478 <span class="comment">* 02-Dec-1996 JerrySh   Created.</span>
00479 <span class="comment">\***************************************************************************/</span>
00480 
<a name="l00481"></a><a class="code" href="../../d7/d2/power_8c.html#a19">00481</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d7/d2/power_8c.html#a19">xxxUserPowerStateCalloutWorker</a>(VOID)
00482 {
00483     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fContinue;
00484     <a class="code" href="../../d3/d1/structBROADCASTSYSTEMMSGPARAMS.html">BROADCASTSYSTEMMSGPARAMS</a> bsmParams;
00485     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00486     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
00487 
00488     <span class="comment">/*</span>
00489 <span class="comment">     * Make sure CSRSS is still running.</span>
00490 <span class="comment">     */</span>
00491     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a324">gbNoMorePowerCallouts</a>) {
00492         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00493     }
00494 
00495     <span class="comment">/*</span>
00496 <span class="comment">     * Store the event so this thread can be promoted later.</span>
00497 <span class="comment">     */</span>
00498     <a class="code" href="../../d7/d2/power_8c.html#a9">EnterPowerCrit</a>();
00499     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o5">pEvent</a> = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;pEventQueueServer;
00500     <a class="code" href="../../d7/d2/power_8c.html#a10">LeavePowerCrit</a>();
00501 
00502     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o1">fCritical</a>) {
00503         <span class="comment">/*</span>
00504 <span class="comment">         * Ask the applications if we can suspend operation.</span>
00505 <span class="comment">         */</span>
00506         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o3">fQueryAllowed</a>) {
00507             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o6">bsmParams</a>.<a class="code" href="../../d3/d1/structBROADCASTSYSTEMMSGPARAMS.html#o0">dwRecipients</a> = BSM_ALLDESKTOPS;
00508             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o6">bsmParams</a>.<a class="code" href="../../d3/d1/structBROADCASTSYSTEMMSGPARAMS.html#o1">dwFlags</a> = BSF_NOHANG | BSF_FORCEIFHUNG;
00509             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o4">fUIAllowed</a>) {
00510                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o6">bsmParams</a>.<a class="code" href="../../d3/d1/structBROADCASTSYSTEMMSGPARAMS.html#o1">dwFlags</a> |= BSF_ALLOWSFW;
00511             }
00512             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o2">fOverrideApps</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00513                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o6">bsmParams</a>.<a class="code" href="../../d3/d1/structBROADCASTSYSTEMMSGPARAMS.html#o1">dwFlags</a> |= (BSF_QUERY | BSF_NOTIMEOUTIFNOTHUNG);
00514             }
00515             fContinue = <a class="code" href="../../d4/d1/userk_8h.html#a1577">xxxSendMessageBSM</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00516                                           WM_POWERBROADCAST,
00517                                           PBT_APMQUERYSUSPEND,
00518                                           <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o4">fUIAllowed</a>,
00519                                           &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o6">bsmParams</a>);
00520 
00521             <span class="comment">/*</span>
00522 <span class="comment">             * If an app says to abort and we're not in override apps or</span>
00523 <span class="comment">             * critical mode, send out the suspend failed message and bail.</span>
00524 <span class="comment">             */</span>
00525             <span class="keywordflow">if</span> (!(fContinue || <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o2">fOverrideApps</a> || <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o1">fCritical</a>)) {
00526                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o6">bsmParams</a>.<a class="code" href="../../d3/d1/structBROADCASTSYSTEMMSGPARAMS.html#o0">dwRecipients</a> = BSM_ALLDESKTOPS;
00527                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o6">bsmParams</a>.<a class="code" href="../../d3/d1/structBROADCASTSYSTEMMSGPARAMS.html#o1">dwFlags</a> = BSF_QUEUENOTIFYMESSAGE;
00528                 <a class="code" href="../../d4/d1/userk_8h.html#a1577">xxxSendMessageBSM</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00529                                   WM_POWERBROADCAST,
00530                                   PBT_APMQUERYSUSPENDFAILED,
00531                                   0,
00532                                   &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o6">bsmParams</a>);
00533                 <a class="code" href="../../d7/d2/power_8c.html#a9">EnterPowerCrit</a>();
00534                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o5">pEvent</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00535                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o0">fInProgress</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00536                 <a class="code" href="../../d7/d2/power_8c.html#a10">LeavePowerCrit</a>();
00537                 <span class="keywordflow">return</span> STATUS_CANCELLED;
00538             }
00539         }
00540 
00541         <span class="comment">/*</span>
00542 <span class="comment">         * Let all the applications know they should suspend operation.</span>
00543 <span class="comment">         */</span>
00544         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o1">fCritical</a>) {
00545             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o6">bsmParams</a>.<a class="code" href="../../d3/d1/structBROADCASTSYSTEMMSGPARAMS.html#o0">dwRecipients</a> = BSM_ALLDESKTOPS;
00546             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o6">bsmParams</a>.<a class="code" href="../../d3/d1/structBROADCASTSYSTEMMSGPARAMS.html#o1">dwFlags</a> = BSF_NOHANG | BSF_FORCEIFHUNG;
00547             <a class="code" href="../../d4/d1/userk_8h.html#a1577">xxxSendMessageBSM</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00548                               WM_POWERBROADCAST,
00549                               PBT_APMSUSPEND,
00550                               0,
00551                               &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o6">bsmParams</a>);
00552         }
00553     }
00554 
00555     <span class="comment">/*</span>
00556 <span class="comment">     * Clear the event so the thread won't wake up prematurely.</span>
00557 <span class="comment">     */</span>
00558     <a class="code" href="../../d7/d2/power_8c.html#a9">EnterPowerCrit</a>();
00559     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o5">pEvent</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00560     <a class="code" href="../../d7/d2/power_8c.html#a10">LeavePowerCrit</a>();
00561 
00562     <span class="comment">/*</span>
00563 <span class="comment">     * Look for a Winlogon window to notify.</span>
00564 <span class="comment">     */</span>
00565     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00566         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o7">psParams</a>.FullScreenMode = !<a class="code" href="../../d9/d6/desktop_8c.html#a3">fGdiEnabled</a>;
00567         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a>, &amp;tlpwnd);
00568         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a>,
00569                                           WM_LOGONNOTIFY,
00570                                           LOGON_POWERSTATE,
00571                                           (LPARAM)&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o7">psParams</a>);
00572         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
00573     }
00574 
00575     <span class="comment">/*</span>
00576 <span class="comment">     * The power state broadcast is over.</span>
00577 <span class="comment">     */</span>
00578     <a class="code" href="../../d7/d2/power_8c.html#a9">EnterPowerCrit</a>();
00579     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o0">fInProgress</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00580     <a class="code" href="../../d7/d2/power_8c.html#a10">LeavePowerCrit</a>();
00581 
00582     <span class="comment">/*</span>
00583 <span class="comment">     * Tickle the input time so we don't fire up a screen saver right away.</span>
00584 <span class="comment">     */</span>
00585     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o0">timeLastInputMessage</a> = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>();
00586 
00587     <span class="comment">/*</span>
00588 <span class="comment">     * Let all the applications know that we're waking up.</span>
00589 <span class="comment">     */</span>
00590     bsmParams.<a class="code" href="../../d3/d1/structBROADCASTSYSTEMMSGPARAMS.html#o0">dwRecipients</a> = BSM_ALLDESKTOPS;
00591     bsmParams.<a class="code" href="../../d3/d1/structBROADCASTSYSTEMMSGPARAMS.html#o1">dwFlags</a> = BSF_QUEUENOTIFYMESSAGE;
00592     <a class="code" href="../../d4/d1/userk_8h.html#a1577">xxxSendMessageBSM</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00593                       WM_POWERBROADCAST,
00594                       PBT_APMRESUMEAUTOMATIC,
00595                       0,
00596                       &amp;bsmParams);
00597 
00598     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00599 }
00600 
00601 <span class="comment">/***************************************************************************\</span>
00602 <span class="comment">* UserPowerStateCallout</span>
00603 <span class="comment">*</span>
00604 <span class="comment">* History:</span>
00605 <span class="comment">* 02-Dec-1996 JerrySh   Created.</span>
00606 <span class="comment">\***************************************************************************/</span>
00607 
<a name="l00608"></a><a class="code" href="../../d7/d2/power_8c.html#a20">00608</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d7/d2/power_8c.html#a20">UserPowerStateCallout</a>(
00609     <a class="code" href="../../d6/d8/struct__WIN32__POWERSTATE__PARAMETERS.html">PKWIN32_POWERSTATE_PARAMETERS</a> Parms)
00610 {
00611     BOOLEAN Promotion = Parms-&gt;<a class="code" href="../../d6/d8/struct__WIN32__POWERSTATE__PARAMETERS.html#o0">Promotion</a>;
00612     POWER_ACTION SystemAction = Parms-&gt;<a class="code" href="../../d6/d8/struct__WIN32__POWERSTATE__PARAMETERS.html#o1">SystemAction</a>;
00613     SYSTEM_POWER_STATE MinSystemState = Parms-&gt;<a class="code" href="../../d6/d8/struct__WIN32__POWERSTATE__PARAMETERS.html#o2">MinSystemState</a>;
00614     ULONG Flags = Parms-&gt;<a class="code" href="../../d6/d8/struct__WIN32__POWERSTATE__PARAMETERS.html#o3">Flags</a>;
00615 
00616     <span class="comment">/*</span>
00617 <span class="comment">     * Make sure CSRSS is running.</span>
00618 <span class="comment">     */</span>
00619     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a323">gbVideoInitialized</a> || <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a324">gbNoMorePowerCallouts</a> || !<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a>) {
00620         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00621     }
00622 
00623     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00624 
00625     <a class="code" href="../../d7/d2/power_8c.html#a9">EnterPowerCrit</a>();
00626 
00627     <span class="comment">/*</span>
00628 <span class="comment">     * Make sure we're not trying to promote a non-existent request</span>
00629 <span class="comment">     * or start a new one when we're already doing it.</span>
00630 <span class="comment">     */</span>
00631     <span class="keywordflow">if</span> ((Promotion &amp;&amp; !<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o0">fInProgress</a>) ||
00632         (!Promotion &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o0">fInProgress</a>)) {
00633         <a class="code" href="../../d7/d2/power_8c.html#a10">LeavePowerCrit</a>();
00634         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00635     }
00636 
00637     <span class="comment">/*</span>
00638 <span class="comment">     * Save our state.</span>
00639 <span class="comment">     */</span>
00640     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o0">fInProgress</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00641     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o2">fOverrideApps</a> = (Flags &amp; POWER_ACTION_OVERRIDE_APPS) != 0;
00642     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o1">fCritical</a> = (Flags &amp; POWER_ACTION_CRITICAL) != 0;
00643     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o3">fQueryAllowed</a> = (Flags &amp; POWER_ACTION_QUERY_ALLOWED) != 0;
00644     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o4">fUIAllowed</a> = (Flags &amp; POWER_ACTION_UI_ALLOWED) != 0;
00645     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o7">psParams</a>.SystemAction = SystemAction;
00646     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o7">psParams</a>.MinSystemState = MinSystemState;
00647     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o7">psParams</a>.Flags = Flags;
00648     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o2">fOverrideApps</a>) {
00649         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o6">bsmParams</a>.<a class="code" href="../../d3/d1/structBROADCASTSYSTEMMSGPARAMS.html#o1">dwFlags</a> = BSF_NOHANG | BSF_FORCEIFHUNG;
00650     }
00651     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o1">fCritical</a>) {
00652         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o6">bsmParams</a>.<a class="code" href="../../d3/d1/structBROADCASTSYSTEMMSGPARAMS.html#o1">dwFlags</a> = BSF_NOHANG | BSF_QUERY;
00653     }
00654     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o5">pEvent</a>) {
00655         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o5">pEvent</a>, <a class="code" href="../../d7/d8/exboosts_8h.html#a0">EVENT_INCREMENT</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00656     }
00657 
00658     <a class="code" href="../../d7/d2/power_8c.html#a10">LeavePowerCrit</a>();
00659 
00660     <span class="comment">/*</span>
00661 <span class="comment">     * If this is a promotion, we're done.</span>
00662 <span class="comment">     */</span>
00663     <span class="keywordflow">if</span> (Promotion) {
00664         <span class="keywordflow">return</span> STATUS_SUCCESS;
00665     }
00666 
00667     <span class="comment">/*</span>
00668 <span class="comment">     * Process the power request.</span>
00669 <span class="comment">     */</span>
00670     <span class="keywordflow">return</span> <a class="code" href="../../d7/d2/power_8c.html#a12">QueuePowerRequest</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00671 }
00672 
00673 <span class="comment">/***************************************************************************\</span>
00674 <span class="comment">* UserPowerCalloutWorker</span>
00675 <span class="comment">*</span>
00676 <span class="comment">* Pull any pending power requests off the list and call the appropriate</span>
00677 <span class="comment">* power callout function.</span>
00678 <span class="comment">*</span>
00679 <span class="comment">* History:</span>
00680 <span class="comment">* 02-Dec-1996 JerrySh   Created.</span>
00681 <span class="comment">\***************************************************************************/</span>
00682 
00683 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00684"></a><a class="code" href="../../d4/d1/userk_8h.html#a1969">00684</a> <a class="code" href="../../d4/d1/userk_8h.html#a1969">xxxUserPowerCalloutWorker</a>(VOID)
00685 {
00686     <a class="code" href="../../d7/d2/power_8c.html#a7">PPOWERREQUEST</a> pPowerRequest;
00687     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlPool;
00688 
00689     <span class="keywordflow">while</span> ((pPowerRequest = <a class="code" href="../../d7/d2/power_8c.html#a13">UnqueuePowerRequest</a>()) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00690         <span class="comment">/*</span>
00691 <span class="comment">         * Make sure the event gets signalled even if the thread dies in a</span>
00692 <span class="comment">         * callback or the waiting thread might get stuck.</span>
00693 <span class="comment">         */</span>
00694         <a class="code" href="../../d4/d1/userk_8h.html#a140">ThreadLockPoolCleanup</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), pPowerRequest, &amp;tlPool, <a class="code" href="../../d7/d2/power_8c.html#a11">CancelPowerRequest</a>);
00695 
00696         <span class="comment">/*</span>
00697 <span class="comment">         * Call the appropriate power worker function.</span>
00698 <span class="comment">         */</span>
00699         <a class="code" href="../../d7/d2/power_8c.html#a8">gpPowerRequestCurrent</a> = pPowerRequest;
00700         <span class="keywordflow">if</span> (pPowerRequest-&gt;Parms) {
00701             pPowerRequest-&gt;<a class="code" href="../../d5/d3/structtagPOWERREQUEST.html#o2">Status</a> = <a class="code" href="../../d7/d2/power_8c.html#a17">xxxUserPowerEventCalloutWorker</a>(pPowerRequest-&gt;Parms);
00702         } <span class="keywordflow">else</span> {
00703             pPowerRequest-&gt;Status = <a class="code" href="../../d7/d2/power_8c.html#a19">xxxUserPowerStateCalloutWorker</a>();
00704         }
00705         <a class="code" href="../../d7/d2/power_8c.html#a8">gpPowerRequestCurrent</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00706 
00707         <span class="comment">/*</span>
00708 <span class="comment">         * Tell the waiting thread to proceed.</span>
00709 <span class="comment">         */</span>
00710         <a class="code" href="../../d4/d1/userk_8h.html#a141">ThreadUnlockPoolCleanup</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), &amp;tlPool);
00711         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(&amp;pPowerRequest-&gt;Event, <a class="code" href="../../d7/d8/exboosts_8h.html#a0">EVENT_INCREMENT</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00712     }
00713 }
00714 
00715 
00716 
00717 <span class="comment">/***************************************************************************\</span>
00718 <span class="comment">* VideoPortCalloutThread</span>
00719 <span class="comment">*</span>
00720 <span class="comment">* Call the appropriate power callout function and return.</span>
00721 <span class="comment">*</span>
00722 <span class="comment">* History:</span>
00723 <span class="comment">* 02-Dec-1996 JerrySh   Created.</span>
00724 <span class="comment">\***************************************************************************/</span>
00725 
00726 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00727"></a><a class="code" href="../../d7/d2/power_8c.html#a22">00727</a> <a class="code" href="../../d7/d2/power_8c.html#a22">VideoPortCalloutThread</a>(
00728     PVIDEO_WIN32K_CALLBACKS_PARAMS Params
00729     )
00730 {
00731 
00732     <span class="comment">/*</span>
00733 <span class="comment">     * Convert this thread to GUI if it's not already converted</span>
00734 <span class="comment">     */</span>
00735     UserAssert(W32GetCurrentThread() == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00736 
00737     Params-&gt;Status = <a class="code" href="../../d4/d1/userk_8h.html#a964">InitSystemThread</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00738 
00739     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Params-&gt;Status)) {
00740         <span class="keywordflow">return</span>;
00741     }
00742 
00743     <span class="comment">// DbgPrint("video --- Before CritSect\n");</span>
00744     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00745     <span class="comment">// DbgPrint("video --- After CritSect\n");</span>
00746 
00747 
00748     <span class="keywordflow">switch</span> (Params-&gt;CalloutType) {
00749 
00750     <span class="keywordflow">case</span> VideoWakeupCallout:
00751         <a class="code" href="../../d7/d2/power_8c.html#a5">gbHibernate</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00752         <span class="keywordflow">break</span>;
00753 
00754     <span class="keywordflow">case</span> VideoDisplaySwitchCallout:
00755         {
00756             UNICODE_STRING   strDeviceName;
00757             DEVMODEW         NewMode;
00758             ULONG            bPrune;
00759 
00760             <span class="keywordflow">if</span> (Params-&gt;PhysDisp != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00761             {
00762                 <span class="keywordflow">if</span> (DrvDisplaySwitchHandler(Params-&gt;PhysDisp, &amp;strDeviceName, &amp;NewMode, &amp;bPrune))
00763                 {
00764                     DESKRESTOREDATA drdRestore;
00765 
00766                     drdRestore.pdeskRestore = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00767 
00768                     <span class="comment">/*</span>
00769 <span class="comment">                     * CSRSS is not the only process to diliver power callout</span>
00770 <span class="comment">                     */</span>
00771 
00772                     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>() ||
00773                         <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d4/d1/userk_8h.html#a1829">xxxSetCsrssThreadDesktop</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>, &amp;drdRestore)) )
00774                     {
00775                         <span class="keywordflow">if</span> (!DrvQueryMDEVPowerState(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>)) {
00776 
00777                             DrvEnableMDEV(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00778                             DrvSetMDEVPowerState(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00779                         }
00780 
00781                         <a class="code" href="../../d4/d1/userk_8h.html#a1758">xxxUserChangeDisplaySettings</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>,
00782                                  ((bPrune) ? 0 : CDS_RAWMODE) | CDS_TRYCLOSEST | CDS_RESET, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>);
00783 
00784                         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>())
00785                         {
00786                             <a class="code" href="../../d4/d1/userk_8h.html#a1830">xxxRestoreCsrssThreadDesktop</a>(&amp;drdRestore);
00787                         }
00788                     }
00789                 }
00790             }
00791         }
00792 
00793         <span class="comment">//</span>
00794         <span class="comment">// If there is a requirement to reenumerate sub-devices</span>
00795         <span class="comment">//</span>
00796         <span class="keywordflow">if</span> (Params-&gt;Param)
00797         {
00798             <a class="code" href="../../d8/d0/pnpioapi_8c.html#a79">IoInvalidateDeviceRelations</a>((<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>)Params-&gt;Param, <a class="code" href="../../d0/d5/io_8h.html#a602a412">BusRelations</a>);
00799         }
00800 
00801         Params-&gt;Status = STATUS_SUCCESS;
00802         <span class="keywordflow">break</span>;
00803 
00804     <span class="keywordflow">case</span> VideoFindAdapterCallout:
00805 
00806         <span class="keywordflow">if</span> (Params-&gt;Param) {
00807 
00808             DrvEnableMDEV(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00809             <a class="code" href="../../d9/d6/desktop_8c.html#a26">xxxUserResetDisplayDevice</a>();
00810 
00811         } <span class="keywordflow">else</span> {
00812 
00813             DrvDisableMDEV(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00814         }
00815 
00816         Params-&gt;Status = STATUS_SUCCESS;
00817         <span class="keywordflow">break</span>;
00818 
00819     <span class="keywordflow">default</span>:
00820 
00821         UserAssert(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00822 
00823         Params-&gt;Status = STATUS_UNSUCCESSFUL;
00824 
00825     }
00826 
00827 
00828     <span class="comment">// DbgPrint("video --- Before Leave CritSect\n");</span>
00829     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00830     <span class="comment">// DbgPrint("video --- After Leave CritSect\n");</span>
00831 
00832 
00833     <span class="keywordflow">return</span>;
00834 }
00835 
00836 
00837 <span class="comment">/***************************************************************************\</span>
00838 <span class="comment">* VideoPortCallout</span>
00839 <span class="comment">*</span>
00840 <span class="comment">* History:</span>
00841 <span class="comment">* 26-Jul-1998 AndreVa   Created.</span>
00842 <span class="comment">\***************************************************************************/</span>
00843 
00844 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00845"></a><a class="code" href="../../d7/d2/power_8c.html#a23">00845</a> <a class="code" href="../../d7/d2/power_8c.html#a23">VideoPortCallout</a>(
00846     IN PVOID Params
00847     )
00848 {
00849 
00850     <span class="comment">/*</span>
00851 <span class="comment">     * To make sure this is a system thread, we create a new thread.</span>
00852 <span class="comment">     */</span>
00853 
00854     HANDLE   hThread;
00855     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00856 
00857     <span class="comment">// DbgPrint("Callout --- Enter !!!\n");</span>
00858 
00859     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a963">CreateSystemThread</a>(<a class="code" href="../../d7/d2/power_8c.html#a22">VideoPortCalloutThread</a>, Params, &amp;hThread);
00860     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00861         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>(hThread, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00862         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00863             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ((PVIDEO_WIN32K_CALLBACKS_PARAMS)(Params))-&gt;Status;
00864         }
00865         ZwClose(hThread);
00866     }
00867 
00868     <span class="comment">// DbgPrint("Callout --- Leave !!!\n");</span>
00869 
00870     ((PVIDEO_WIN32K_CALLBACKS_PARAMS)(Params))-&gt;Status = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00871 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:24 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
