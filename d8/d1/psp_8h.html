<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: psp.h File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>psp.h File Reference</h1><code>#include "<a class="el" href="../../d0/d8/ntos_8h-source.html">ntos.h</a>"</code><br>
<code>#include "ntrtl.h"</code><br>
<code>#include "nturtl.h"</code><br>
<code>#include "zwapi.h"</code><br>
<code>#include "<a class="el" href="../../d1/d9/ki_8h-source.html">ki.h</a>"</code><br>
<code>#include "wdbgexts.h"</code><br>
<code>#include "ntdbg.h"</code><br>
<code>#include &lt;string.h&gt;</code><br>

<p>
<a href="../../d9/d0/psp_8h-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d0/struct__TERMINATION__PORT.html">_TERMINATION_PORT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/struct__GETSETCONTEXT.html">_GETSETCONTEXT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/struct__SYSTEM__DLL.html">_SYSTEM_DLL</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/struct__JOB__WORKING__SET__CHANGE__HEAD.html">_JOB_WORKING_SET_CHANGE_HEAD</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/struct__JOB__WORKING__SET__CHANGE__RECORD.html">_JOB_WORKING_SET_CHANGE_RECORD</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a0">NOEXTAPI</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a1">PSP_PROCESS_PAGED_CHARGE</a>&nbsp;&nbsp;&nbsp;(PAGE_SIZE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a2">PSP_PROCESS_NONPAGED_CHARGE</a>&nbsp;&nbsp;&nbsp;(sizeof(<a class="el" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a3">PSP_THREAD_PAGED_CHARGE</a>&nbsp;&nbsp;&nbsp;(0)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a4">PSP_THREAD_NONPAGED_CHARGE</a>&nbsp;&nbsp;&nbsp;(sizeof(<a class="el" href="../../d5/d6/struct__ETHREAD.html">ETHREAD</a>))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a5">PSP_MAX_CREATE_PROCESS_NOTIFY</a>&nbsp;&nbsp;&nbsp;8</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a6">PSP_MAX_CREATE_THREAD_NOTIFY</a>&nbsp;&nbsp;&nbsp;8</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a7">PSP_MAX_LOAD_IMAGE_NOTIFY</a>&nbsp;&nbsp;&nbsp;8</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a8">PSP_NUMBER_OF_SCHEDULING_CLASSES</a>&nbsp;&nbsp;&nbsp;10</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a9">PSP_DEFAULT_SCHEDULING_CLASSES</a>&nbsp;&nbsp;&nbsp;5</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d3/d0/struct__TERMINATION__PORT.html">_TERMINATION_PORT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a10">TERMINATION_PORT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d3/d0/struct__TERMINATION__PORT.html">_TERMINATION_PORT</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a11">PTERMINATION_PORT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d1/d2/struct__GETSETCONTEXT.html">_GETSETCONTEXT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a12">GETSETCONTEXT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d1/d2/struct__GETSETCONTEXT.html">_GETSETCONTEXT</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a13">PGETSETCONTEXT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d8/struct__SYSTEM__DLL.html">_SYSTEM_DLL</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a14">SYSTEM_DLL</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d8/struct__SYSTEM__DLL.html">_SYSTEM_DLL</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a15">PSYSTEM_DLL</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d7/d4/struct__JOB__WORKING__SET__CHANGE__HEAD.html">_JOB_WORKING_SET_CHANGE_HEAD</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a16">JOB_WORKING_SET_CHANGE_HEAD</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d7/d4/struct__JOB__WORKING__SET__CHANGE__HEAD.html">_JOB_WORKING_SET_CHANGE_HEAD</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a17">PJOB_WORKING_SET_CHANGE_HEAD</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d4/struct__JOB__WORKING__SET__CHANGE__RECORD.html">_JOB_WORKING_SET_CHANGE_RECORD</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a18">JOB_WORKING_SET_CHANGE_RECORD</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d4/struct__JOB__WORKING__SET__CHANGE__RECORD.html">_JOB_WORKING_SET_CHANGE_RECORD</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a19">PJOB_WORKING_SET_CHANGE_RECORD</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a49">PspProcessDump</a> (IN PVOID Object, IN <a class="el" href="../../d0/d5/struct__OBJECT__DUMP__CONTROL.html">POB_DUMP_CONTROL</a> Control OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a50">PspProcessDelete</a> (IN PVOID Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a51">PspThreadDump</a> (IN PVOID Object, IN <a class="el" href="../../d0/d5/struct__OBJECT__DUMP__CONTROL.html">POB_DUMP_CONTROL</a> Control OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a52">PspInheritQuota</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> NewProcess, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ParentProcess)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a53">PspDereferenceQuota</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a54">PspThreadDelete</a> (IN PVOID Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a55">PspInitPhase0</a> (IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a56">PspInitPhase1</a> (IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a57">PspInitializeSystemDll</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a58">PspLookupSystemDllEntryPoint</a> (IN PSZ EntryPointName, OUT PVOID *EntryPointAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a59">PspLookupKernelUserEntryPoints</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a60">PspNameToOrdinal</a> (IN PSZ EntryPointName, IN ULONG DllBase, IN ULONG NumberOfNames, IN PULONG NameTableBase, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a22">PUSHORT</a> OrdinalTableBase)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a61">PspMapSystemDll</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, OUT PVOID *DllBase OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a62">PspCreateProcess</a> (OUT PHANDLE ProcessHandle, IN ACCESS_MASK DesiredAccess, IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a> OPTIONAL, IN HANDLE ParentProcess OPTIONAL, IN BOOLEAN InheritObjectTable, IN HANDLE SectionHandle OPTIONAL, IN HANDLE <a class="el" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a> OPTIONAL, IN HANDLE ExceptionPort OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a63">PspCreateThread</a> (OUT PHANDLE <a class="el" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>, IN ACCESS_MASK DesiredAccess, IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a> OPTIONAL, IN HANDLE ProcessHandle, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessPointer, OUT PCLIENT_ID ClientId OPTIONAL, IN PCONTEXT <a class="el" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a> OPTIONAL, IN PINITIAL_TEB <a class="el" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a> OPTIONAL, IN BOOLEAN CreateSuspended, IN <a class="el" href="../../d4/d9/ke_8h.html#a66">PKSTART_ROUTINE</a> StartRoutine OPTIONAL, IN PVOID StartContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a64">PspUserThreadStartup</a> (IN <a class="el" href="../../d4/d9/ke_8h.html#a66">PKSTART_ROUTINE</a> StartRoutine, IN PVOID StartContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a65">PspSystemThreadStartup</a> (IN <a class="el" href="../../d4/d9/ke_8h.html#a66">PKSTART_ROUTINE</a> StartRoutine, IN PVOID StartContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a66">PspReaper</a> (IN PVOID StartContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a67">PspNullSpecialApc</a> (IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc, IN OUT <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *NormalRoutine, IN OUT PVOID *NormalContext, IN OUT PVOID *SystemArgument1, IN OUT PVOID *SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>DECLSPEC_NORETURN VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a68">PspExitThread</a> (IN NTSTATUS ExitStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a69">PspTerminateThreadByPointer</a> (IN <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread, IN NTSTATUS ExitStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a70">PspExitSpecialApc</a> (IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc, IN OUT <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *NormalRoutine, IN OUT PVOID *NormalContext, IN OUT PVOID *SystemArgument1, IN OUT PVOID *SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a71">PspExitProcess</a> (IN BOOLEAN TrimAddressSpace, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a72">PspSetContext</a> (OUT PKTRAP_FRAME TrapFrame, OUT PKNONVOLATILE_CONTEXT_POINTERS NonVolatileContext, IN PCONTEXT Context, <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> Mode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a73">PspGetContext</a> (IN PKTRAP_FRAME TrapFrame, IN PKNONVOLATILE_CONTEXT_POINTERS NonVolatileContext, IN OUT PCONTEXT Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a74">PspGetSetContextSpecialApc</a> (IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc, IN OUT <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *NormalRoutine, IN OUT PVOID *NormalContext, IN OUT PVOID *SystemArgument1, IN OUT PVOID *SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a75">PspExitNormalApc</a> (IN PVOID NormalContext, IN PVOID SystemArgument1, IN PVOID SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a76">PspInitializeProcessSecurity</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Parent OPTIONAL, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Child)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a77">PspDeleteProcessSecurity</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a78">PspInitializeThreadSecurity</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a79">PspDeleteThreadSecurity</a> (IN <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a80">PspAssignPrimaryToken</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN HANDLE <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a> OPTIONAL, IN PACCESS_TOKEN TokenPointer OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a81">PspSetPrimaryToken</a> (IN HANDLE ProcessHandle, IN HANDLE TokenHandle OPTIONAL, IN PACCESS_TOKEN TokenPointer OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a82">PspQueryLdtInformation</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, OUT PVOID LdtInformation, IN ULONG LdtInformationLength, OUT PULONG ReturnLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a83">PspSetLdtInformation</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN PVOID LdtInformation, IN ULONG LdtInformationLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a84">PspSetLdtSize</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN PVOID LdtSize, IN ULONG LdtSizeLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a85">PspDeleteLdt</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a86">PspSetProcessIoHandlers</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN PVOID IoHandlerInformation, IN ULONG IoHandlerLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a87">PspDeleteVdmObjects</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a88">PspQueryDescriptorThread</a> (<a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread, PVOID ThreadInformation, ULONG ThreadInformationLength, PULONG ReturnLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a89">PspJobDelete</a> (IN PVOID Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a90">PspJobClose</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN PVOID Object, IN ACCESS_MASK GrantedAccess, IN ULONG ProcessHandleCount, IN ULONG SystemHandleCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a91">PspAddProcessToJob</a> (<a class="el" href="../../d0/d3/struct__EJOB.html">PEJOB</a> Job, <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a92">PspRemoveProcessFromJob</a> (<a class="el" href="../../d0/d3/struct__EJOB.html">PEJOB</a> Job, <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a93">PspExitProcessFromJob</a> (<a class="el" href="../../d0/d3/struct__EJOB.html">PEJOB</a> Job, <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a94">PspTerminateProcess</a> (<a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, NTSTATUS <a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>, <a class="el" href="../../d1/d9/ps_8h.html#a73">PSLOCKPROCESSMODE</a> LockMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a95">PspApplyJobLimitsToProcessSet</a> (<a class="el" href="../../d0/d3/struct__EJOB.html">PEJOB</a> Job)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a96">PspApplyJobLimitsToProcess</a> (<a class="el" href="../../d0/d3/struct__EJOB.html">PEJOB</a> Job, <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a97">PspTerminateAllProcessesInJob</a> (<a class="el" href="../../d0/d3/struct__EJOB.html">PEJOB</a> Job, NTSTATUS <a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>, <a class="el" href="../../d1/d9/ps_8h.html#a73">PSLOCKPROCESSMODE</a> LockMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a98">PspFoldProcessAccountingIntoJob</a> (<a class="el" href="../../d0/d3/struct__EJOB.html">PEJOB</a> Job, <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a99">PspCaptureTokenFilter</a> (<a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode, PJOBOBJECT_SECURITY_LIMIT_INFORMATION SecurityLimitInfo, <a class="el" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html">PPS_JOB_TOKEN_FILTER</a> *TokenFilter)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d7/d4/struct__JOB__WORKING__SET__CHANGE__HEAD.html">JOB_WORKING_SET_CHANGE_HEAD</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a20">PspWorkingSetChangeHead</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a21">PspCreateProcessNotifyRoutineCount</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d9/ps_8h.html#a67">PCREATE_PROCESS_NOTIFY_ROUTINE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a22">PspCreateProcessNotifyRoutine</a> [PSP_MAX_CREATE_PROCESS_NOTIFY]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a23">PspCreateThreadNotifyRoutineCount</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d9/ps_8h.html#a68">PCREATE_THREAD_NOTIFY_ROUTINE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a24">PspCreateThreadNotifyRoutine</a> [PSP_MAX_CREATE_THREAD_NOTIFY]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a25">PspLoadImageNotifyRoutineCount</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d9/ps_8h.html#a71">PLOAD_IMAGE_NOTIFY_ROUTINE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a26">PspLoadImageNotifyRoutine</a> [PSP_MAX_LOAD_IMAGE_NOTIFY]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a27">PspCidTable</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HANDLE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a28">PspInitialSystemProcessHandle</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PACCESS_TOKEN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a29">PspBootAccessToken</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>KSPIN_LOCK&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a30">PspEventPairLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d8/struct__SYSTEM__DLL.html">SYSTEM_DLL</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a31">PspSystemDll</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a32">PspActiveProcessMutex</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a33">PspProcessLockMutex</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a34">PspDefaultPagedLimit</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a35">PspDefaultNonPagedLimit</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a36">PspDefaultPagefileLimit</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html">EPROCESS_QUOTA_BLOCK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a37">PspDefaultQuotaBlock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a38">PspDoingGiveBacks</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d9/ps_8h.html#a74">PKWIN32_PROCESS_CALLOUT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a39">PspW32ProcessCallout</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d9/ps_8h.html#a80">PKWIN32_THREAD_CALLOUT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a40">PspW32ThreadCallout</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d9/ps_8h.html#a78">PKWIN32_JOB_CALLOUT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a41">PspW32JobCallout</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a42">PspW32ProcessSize</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a43">PspW32ThreadSize</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>SCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a44">PspForegroundQuantum</a> [3]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>SCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a45">PspJobSchedulingClasses</a> [PSP_NUMBER_OF_SCHEDULING_CLASSES]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a46">PspUseJobSchedulingClasses</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a47">PspJobListLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/psp_8h.html#a48">PspJobList</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="psp.h::NOEXTAPI" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define NOEXTAPI          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00032">32</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="psp.h::PSP_DEFAULT_SCHEDULING_CLASSES" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PSP_DEFAULT_SCHEDULING_CLASSES&nbsp;&nbsp;&nbsp;5          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00543">543</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/psjob_8c-source.html#l00048">NtCreateJobObject()</a>, and <a class="el" href="../../d2/d0/psjob_8c-source.html#l01323">NtSetInformationJobObject()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="psp.h::PSP_MAX_CREATE_PROCESS_NOTIFY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PSP_MAX_CREATE_PROCESS_NOTIFY&nbsp;&nbsp;&nbsp;8          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00189">189</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00262">PspCreateThread()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01232">PspExitProcess()</a>, and <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01691">PsSetCreateProcessNotifyRoutine()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="psp.h::PSP_MAX_CREATE_THREAD_NOTIFY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PSP_MAX_CREATE_THREAD_NOTIFY&nbsp;&nbsp;&nbsp;8          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00206">206</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00262">PspCreateThread()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00690">PspExitThread()</a>, and <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01755">PsSetCreateThreadNotifyRoutine()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="psp.h::PSP_MAX_LOAD_IMAGE_NOTIFY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PSP_MAX_LOAD_IMAGE_NOTIFY&nbsp;&nbsp;&nbsp;8          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00212">212</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l02396">PsCallImageNotifyRoutines()</a>, and <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l02344">PsSetLoadImageNotifyRoutine()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="psp.h::PSP_NUMBER_OF_SCHEDULING_CLASSES" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PSP_NUMBER_OF_SCHEDULING_CLASSES&nbsp;&nbsp;&nbsp;10          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00542">542</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/psjob_8c-source.html#l01323">NtSetInformationJobObject()</a>, and <a class="el" href="../../d2/d0/psjob_8c-source.html#l02262">PspApplyJobLimitsToProcess()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="psp.h::PSP_PROCESS_NONPAGED_CHARGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PSP_PROCESS_NONPAGED_CHARGE&nbsp;&nbsp;&nbsp;(sizeof(<a class="el" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>))          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00056">56</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/psinit_8c-source.html#l00181">PspInitPhase0()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="psp.h::PSP_PROCESS_PAGED_CHARGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PSP_PROCESS_PAGED_CHARGE&nbsp;&nbsp;&nbsp;(PAGE_SIZE)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00055">55</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/psinit_8c-source.html#l00181">PspInitPhase0()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="psp.h::PSP_THREAD_NONPAGED_CHARGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PSP_THREAD_NONPAGED_CHARGE&nbsp;&nbsp;&nbsp;(sizeof(<a class="el" href="../../d5/d6/struct__ETHREAD.html">ETHREAD</a>))          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00069">69</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/psinit_8c-source.html#l00181">PspInitPhase0()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="psp.h::PSP_THREAD_PAGED_CHARGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PSP_THREAD_PAGED_CHARGE&nbsp;&nbsp;&nbsp;(0)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00068">68</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/psinit_8c-source.html#l00181">PspInitPhase0()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a12" doxytag="psp.h::GETSETCONTEXT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d1/d2/struct__GETSETCONTEXT.html">_GETSETCONTEXT</a>  <a class="el" href="../../d1/d2/struct__GETSETCONTEXT.html">GETSETCONTEXT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d9/psctx_8c-source.html#l00151">NtGetContextThread()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="psp.h::JOB_WORKING_SET_CHANGE_HEAD" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d7/d4/struct__JOB__WORKING__SET__CHANGE__HEAD.html">_JOB_WORKING_SET_CHANGE_HEAD</a>  <a class="el" href="../../d7/d4/struct__JOB__WORKING__SET__CHANGE__HEAD.html">JOB_WORKING_SET_CHANGE_HEAD</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="psp.h::JOB_WORKING_SET_CHANGE_RECORD" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d4/struct__JOB__WORKING__SET__CHANGE__RECORD.html">_JOB_WORKING_SET_CHANGE_RECORD</a>  <a class="el" href="../../d8/d4/struct__JOB__WORKING__SET__CHANGE__RECORD.html">JOB_WORKING_SET_CHANGE_RECORD</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d2/d0/psjob_8c-source.html#l01323">NtSetInformationJobObject()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="psp.h::PGETSETCONTEXT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d1/d2/struct__GETSETCONTEXT.html">_GETSETCONTEXT</a> * <a class="el" href="../../d1/d2/struct__GETSETCONTEXT.html">PGETSETCONTEXT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d4/d9/psctx386_8c-source.html#l00131">PspGetSetContextSpecialApc()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="psp.h::PJOB_WORKING_SET_CHANGE_HEAD" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d7/d4/struct__JOB__WORKING__SET__CHANGE__HEAD.html">_JOB_WORKING_SET_CHANGE_HEAD</a> * <a class="el" href="../../d7/d4/struct__JOB__WORKING__SET__CHANGE__HEAD.html">PJOB_WORKING_SET_CHANGE_HEAD</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="psp.h::PJOB_WORKING_SET_CHANGE_RECORD" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d4/struct__JOB__WORKING__SET__CHANGE__RECORD.html">_JOB_WORKING_SET_CHANGE_RECORD</a> * <a class="el" href="../../d8/d4/struct__JOB__WORKING__SET__CHANGE__RECORD.html">PJOB_WORKING_SET_CHANGE_RECORD</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d2/d0/psjob_8c-source.html#l01323">NtSetInformationJobObject()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="psp.h::PSYSTEM_DLL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d8/struct__SYSTEM__DLL.html">_SYSTEM_DLL</a>  <a class="el" href="../../d0/d8/struct__SYSTEM__DLL.html">PSYSTEM_DLL</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="psp.h::PTERMINATION_PORT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d3/d0/struct__TERMINATION__PORT.html">_TERMINATION_PORT</a> * <a class="el" href="../../d3/d0/struct__TERMINATION__PORT.html">PTERMINATION_PORT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00690">PspExitThread()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="psp.h::SYSTEM_DLL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d8/struct__SYSTEM__DLL.html">_SYSTEM_DLL</a>  <a class="el" href="../../d0/d8/struct__SYSTEM__DLL.html">SYSTEM_DLL</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="psp.h::TERMINATION_PORT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d3/d0/struct__TERMINATION__PORT.html">_TERMINATION_PORT</a>  <a class="el" href="../../d3/d0/struct__TERMINATION__PORT.html">TERMINATION_PORT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00690">PspExitThread()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a91" doxytag="psp.h::PspAddProcessToJob" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PspAddProcessToJob           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d3/struct__EJOB.html">PEJOB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Job</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d0/psjob_8c-source.html#l00439">439</a> of file <a class="el" href="../../d2/d0/psjob_8c-source.html">psjob.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00503">_EJOB::ActiveProcesses</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00515">_EJOB::ActiveProcessLimit</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00539">_EJOB::CompletionKey</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00538">_EJOB::CompletionPort</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00488">_EJOB::Event</a>, <a class="el" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d3/complete_8c-source.html#l00671">IoSetIoCompletion()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00285">_EPROCESS::Job</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00287">_EPROCESS::JobLinks</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00491">_EJOB::JobLock</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00286">_EPROCESS::JobStatus</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00253">KeReadStateEvent()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00512">_EJOB::LimitFlags</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00092">_JOB_WORKING_SET_CHANGE_HEAD::Lock</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00514">_EJOB::MaximumWorkingSetSize</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00513">_EJOB::MinimumWorkingSetSize</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l02450">MmAdjustWorkingSetSize()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l02386">MmAssignProcessToJob()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l00543">MmEnforceWorkingSetLimit()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00490">_EJOB::ProcessListHead</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00315">PS_JOB_STATUS_ACCOUNTING_FOLDED</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00319">PS_JOB_STATUS_LAST_REPORT_MEMORY</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00316">PS_JOB_STATUS_NEW_PROCESS_REPORTED</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00314">PS_JOB_STATUS_NOT_REALLY_ACTIVE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00148">PS_SET_BITS</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00154">PS_SET_CLEAR_BITS</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l02262">PspApplyJobLimitsToProcess()</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00102">PspWorkingSetChangeHead</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00502">_EJOB::TotalProcesses</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00174">_EPROCESS::UniqueProcessId</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00196">_EPROCESS::Vm</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/psjob_8c-source.html#l00266">NtAssignProcessToJobObject()</a>, and <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>.
<p>
<pre class="fragment"><div>00443 {
00444 
00445     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00446     SIZE_T MinWs,MaxWs;
00447 
00448     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00449 
00450 
00451     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00452     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o3">JobLock</a>, TRUE);
00453 
00454     InsertTailList(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o2">ProcessListHead</a>,&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o75">JobLinks</a>);
00455 
00456     <span class="comment">//</span>
00457     <span class="comment">// Update relevant ADD accounting info.</span>
00458     <span class="comment">//</span>
00459 
00460     Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o9">TotalProcesses</a>++;
00461     Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o10">ActiveProcesses</a>++;
00462 
00463 
00464 
00465     <span class="comment">//</span>
00466     <span class="comment">// Test for active process count exceeding limit</span>
00467     <span class="comment">//</span>
00468 
00469     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00470     <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp; JOB_OBJECT_LIMIT_ACTIVE_PROCESS &amp;&amp;
00471          Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o10">ActiveProcesses</a> &gt; Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o17">ActiveProcessLimit</a> ) {
00472 
00473         <a class="code" href="../../d1/d9/ps_8h.html#a8">PS_SET_CLEAR_BITS</a> (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a>,
00474                            PS_JOB_STATUS_NOT_REALLY_ACTIVE | PS_JOB_STATUS_ACCOUNTING_FOLDED,
00475                            PS_JOB_STATUS_LAST_REPORT_MEMORY);
00476 
00477         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o10">ActiveProcesses</a>--;
00478 
00479         <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a> ) {
00480             <a class="code" href="../../d5/d4/complete_8c.html#a6">IoSetIoCompletion</a>(
00481                 Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a>,
00482                 Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o26">CompletionKey</a>,
00483                 NULL,
00484                 STATUS_SUCCESS,
00485                 JOB_OBJECT_MSG_ACTIVE_PROCESS_LIMIT,
00486                 TRUE
00487                 );
00488             }
00489 
00490         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_QUOTA_EXCEEDED;
00491         }
00492 
00493     <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp; JOB_OBJECT_LIMIT_JOB_TIME &amp;&amp; <a class="code" href="../../d2/d8/eventobj_8c.html#a6">KeReadStateEvent</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o0">Event</a>) ) {
00494         <a class="code" href="../../d1/d9/ps_8h.html#a6">PS_SET_BITS</a> (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a>, PS_JOB_STATUS_NOT_REALLY_ACTIVE | PS_JOB_STATUS_ACCOUNTING_FOLDED);
00495 
00496         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o10">ActiveProcesses</a>--;
00497 
00498         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_QUOTA_EXCEEDED;
00499         }
00500 
00501     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS ) {
00502 
00503         <a class="code" href="../../d8/d1/psp_8h.html#a96">PspApplyJobLimitsToProcess</a>(Job,Process);
00504 
00505         <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a>
00506              &amp;&amp; Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a>
00507              &amp;&amp; !(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a9">PS_JOB_STATUS_NOT_REALLY_ACTIVE</a>)
00508              &amp;&amp; !(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a11">PS_JOB_STATUS_NEW_PROCESS_REPORTED</a>)) {
00509 
00510             <a class="code" href="../../d1/d9/ps_8h.html#a8">PS_SET_CLEAR_BITS</a> (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a>,
00511                                PS_JOB_STATUS_NEW_PROCESS_REPORTED,
00512                                PS_JOB_STATUS_LAST_REPORT_MEMORY);
00513 
00514             <a class="code" href="../../d5/d4/complete_8c.html#a6">IoSetIoCompletion</a>(
00515                 Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a>,
00516                 Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o26">CompletionKey</a>,
00517                 (PVOID)Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a>,
00518                 STATUS_SUCCESS,
00519                 JOB_OBJECT_MSG_NEW_PROCESS,
00520                 FALSE
00521                 );
00522             }
00523 
00524         }
00525 
00526     <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp; JOB_OBJECT_LIMIT_WORKINGSET ) {
00527         MinWs = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o15">MinimumWorkingSetSize</a>;
00528         MaxWs = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o16">MaximumWorkingSetSize</a>;
00529         }
00530     <span class="keywordflow">else</span> {
00531         MinWs = 0;
00532         MaxWs = 0;
00533         }
00534 
00535     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o3">JobLock</a>);
00536 
00537     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00538 
00539     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS ) {
00540 
00541         <span class="keywordflow">if</span> ( MinWs != 0 &amp;&amp; MaxWs != 0 ) {
00542 
00543             <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00544             <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>(&amp;<a class="code" href="../../d8/d1/psp_8h.html#a20">PspWorkingSetChangeHead</a>.<a class="code" href="../../d7/d4/struct__JOB__WORKING__SET__CHANGE__HEAD.html#o1">Lock</a>);
00545 
00546             <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>);
00547             <a class="code" href="../../d4/d0/wslist_8c.html#a31">MmAdjustWorkingSetSize</a>(MinWs,MaxWs,FALSE);
00548 
00549             <span class="comment">//</span>
00550             <span class="comment">// call MM to Enable hard workingset</span>
00551             <span class="comment">//</span>
00552 
00553             <a class="code" href="../../d4/d0/wslist_8c.html#a22">MmEnforceWorkingSetLimit</a>(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>, TRUE);
00554 
00555             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00556 
00557             <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>(&amp;<a class="code" href="../../d8/d1/psp_8h.html#a20">PspWorkingSetChangeHead</a>.<a class="code" href="../../d7/d4/struct__JOB__WORKING__SET__CHANGE__HEAD.html#o1">Lock</a>);
00558             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00559 
00560             }
00561         <span class="keywordflow">else</span> {
00562             <a class="code" href="../../d4/d0/wslist_8c.html#a22">MmEnforceWorkingSetLimit</a>(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>, FALSE);
00563             }
00564 
00565         <span class="keywordflow">if</span> ( !<a class="code" href="../../d4/d0/wslist_8c.html#a30">MmAssignProcessToJob</a>(Process) ) {
00566             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_QUOTA_EXCEEDED;
00567             }
00568 
00569         }
00570 
00571     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00572 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a96" doxytag="psp.h::PspApplyJobLimitsToProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspApplyJobLimitsToProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d3/struct__EJOB.html">PEJOB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Job</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d0/psjob_8c-source.html#l02262">2262</a> of file <a class="el" href="../../d2/d0/psjob_8c-source.html">psjob.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00516">_EJOB::Affinity</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00766">_KPROCESS::Affinity</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00304">_EPROCESS::CommitChargeLimit</a>, <a class="el" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01302">KeSetAffinityThread()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00907">KeSetDisableQuantumProcess()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00512">_EJOB::LimitFlags</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00043">MEMORY_PRIORITY_FOREGROUND</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00563">_EJOB::MemoryLimitsLock</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00069">_MMSUPPORT::MemoryPriority</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l00543">MmEnforceWorkingSetLimit()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00517">_EJOB::PriorityClass</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00276">_EPROCESS::PriorityClass</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00557">_EJOB::ProcessMemoryLimit</a>, <a class="el" href="../../d1/d9/ps_8h.html#a155a89">PsLockPollOnTimeout</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01966">PsLockProcess()</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00542">PSP_NUMBER_OF_SCHEDULING_CLASSES</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00864">PspJobSchedulingClasses</a>, <a class="el" href="../../d1/d9/ps_8h.html#a159a108">PsProcessPriorityBackground</a>, <a class="el" href="../../d1/d9/ps_8h.html#a159a109">PsProcessPriorityForeground</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00862">PspUseJobSchedulingClasses</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l03916">PsSetProcessPriorityByClass()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l02250">PsUnlockProcess()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00543">_EJOB::SchedulingClass</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00347">_ETHREAD::Tcb</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00307">_EPROCESS::ThreadListHead</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00769">_KPROCESS::ThreadQuantum</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00196">_EPROCESS::Vm</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/psjob_8c-source.html#l00439">PspAddProcessToJob()</a>, and <a class="el" href="../../d2/d0/psjob_8c-source.html#l02210">PspApplyJobLimitsToProcessSet()</a>.
<p>
<pre class="fragment"><div>02266 {
02267 
02268     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02269     PLIST_ENTRY Next;
02270     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
02271 
02272     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02273 
02274     <span class="comment">//</span>
02275     <span class="comment">// The job object is held exclusive by the caller</span>
02276     <span class="comment">//</span>
02277 
02278     <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp; JOB_OBJECT_LIMIT_PRIORITY_CLASS ) {
02279         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o68">PriorityClass</a> = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o19">PriorityClass</a>;
02280 
02281         <a class="code" href="../../d9/d1/psquery_8c.html#a24">PsSetProcessPriorityByClass</a>(
02282                 Process,
02283                 Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o12">MemoryPriority</a> == MEMORY_PRIORITY_FOREGROUND ?
02284                     PsProcessPriorityForeground : PsProcessPriorityBackground
02285                 );
02286         }
02287 
02288     <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp; JOB_OBJECT_LIMIT_AFFINITY ) {
02289 
02290         <span class="comment">//</span>
02291         <span class="comment">// the following allows this api to properly if</span>
02292         <span class="comment">// called while the exiting process is blocked holding the</span>
02293         <span class="comment">// createdeletelock. This can happen during debugger/server</span>
02294         <span class="comment">// lpc transactions that occur in pspexitthread</span>
02295         <span class="comment">//</span>
02296 
02297         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/ps_2create_8c.html#a22">PsLockProcess</a>(Process,KeGetPreviousMode(),PsLockPollOnTimeout);
02298 
02299         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS ) {
02300             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o10">Affinity</a> = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o18">Affinity</a>;
02301 
02302             Next = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o87">ThreadListHead</a>.Flink;
02303 
02304             <span class="keywordflow">while</span> ( Next != &amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o87">ThreadListHead</a>) {
02305 
02306                 Thread = (<a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>)(CONTAINING_RECORD(Next,<a class="code" href="../../d5/d6/struct__ETHREAD.html">ETHREAD</a>,ThreadListEntry));
02307                 <a class="code" href="../../d9/d1/thredobj_8c.html#a18">KeSetAffinityThread</a>(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>,Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o18">Affinity</a>);
02308                 Next = Next-&gt;Flink;
02309                 }
02310 
02311             <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
02312             }
02313         }
02314 
02315     <span class="keywordflow">if</span> ( !(Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp; JOB_OBJECT_LIMIT_WORKINGSET) ) {
02316         <span class="comment">//</span>
02317         <span class="comment">// call MM to disable hard workingset</span>
02318         <span class="comment">//</span>
02319 
02320         <a class="code" href="../../d4/d0/wslist_8c.html#a22">MmEnforceWorkingSetLimit</a>(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>, FALSE);
02321         }
02322 
02323     <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o41">MemoryLimitsLock</a>);
02324     <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp; JOB_OBJECT_LIMIT_PROCESS_MEMORY  ) {
02325         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o85">CommitChargeLimit</a> = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o36">ProcessMemoryLimit</a>;
02326         }
02327     <span class="keywordflow">else</span> {
02328         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o85">CommitChargeLimit</a> = 0;
02329         }
02330     <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o41">MemoryLimitsLock</a>);
02331 
02332     <span class="comment">//</span>
02333     <span class="comment">// If the process is NOT IDLE Priority Class, and long fixed quantums</span>
02334     <span class="comment">// are in use, use the scheduling class stored in the job object for this process</span>
02335     <span class="comment">//</span>
02336     <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o68">PriorityClass</a> != PROCESS_PRIORITY_CLASS_IDLE ) {
02337 
02338         <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d1/psinit_8c.html#a37">PspUseJobSchedulingClasses</a> ) {
02339             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o13">ThreadQuantum</a> = <a class="code" href="../../d0/d1/psinit_8c.html#a38">PspJobSchedulingClasses</a>[Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o28">SchedulingClass</a>];
02340             }
02341         <span class="comment">//</span>
02342         <span class="comment">// if the scheduling class is PSP_NUMBER_OF_SCHEDULING_CLASSES-1, then</span>
02343         <span class="comment">// give this process non-preemptive scheduling</span>
02344         <span class="comment">//</span>
02345         <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o28">SchedulingClass</a> == <a class="code" href="../../d8/d1/psp_8h.html#a8">PSP_NUMBER_OF_SCHEDULING_CLASSES</a>-1 ) {
02346             <a class="code" href="../../d3/d5/procobj_8c.html#a12">KeSetDisableQuantumProcess</a>(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>,TRUE);
02347             }
02348         <span class="keywordflow">else</span> {
02349             <a class="code" href="../../d3/d5/procobj_8c.html#a12">KeSetDisableQuantumProcess</a>(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>,FALSE);
02350             }
02351 
02352         }
02353 
02354 
02355 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a95" doxytag="psp.h::PspApplyJobLimitsToProcessSet" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspApplyJobLimitsToProcessSet           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d3/struct__EJOB.html">PEJOB</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Job</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d0/psjob_8c-source.html#l02210">2210</a> of file <a class="el" href="../../d2/d0/psjob_8c-source.html">psjob.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00286">_EPROCESS::JobStatus</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00512">_EJOB::LimitFlags</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00091">_JOB_WORKING_SET_CHANGE_HEAD::Links</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00058">ObGetObjectPointerCount()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00490">_EJOB::ProcessListHead</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00314">PS_JOB_STATUS_NOT_REALLY_ACTIVE</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l02262">PspApplyJobLimitsToProcess()</a>, and <a class="el" href="../../d9/d0/psp_8h-source.html#l00102">PspWorkingSetChangeHead</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/psjob_8c-source.html#l01323">NtSetInformationJobObject()</a>.
<p>
<pre class="fragment"><div>02213 {
02214 
02215     PLIST_ENTRY Next;
02216     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
02217     <a class="code" href="../../d8/d4/struct__JOB__WORKING__SET__CHANGE__RECORD.html">PJOB_WORKING_SET_CHANGE_RECORD</a> WsChangeRecord;
02218 
02219     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02220 
02221     <span class="comment">//</span>
02222     <span class="comment">// The job object is held exclusive by the caller</span>
02223     <span class="comment">//</span>
02224 
02225     Next = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o2">ProcessListHead</a>.Flink;
02226 
02227     <span class="keywordflow">while</span> ( Next != &amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o2">ProcessListHead</a>) {
02228 
02229         Process = (<a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>)(CONTAINING_RECORD(Next,<a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>,JobLinks));
02230         <span class="keywordflow">if</span> ( !(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a9">PS_JOB_STATUS_NOT_REALLY_ACTIVE</a>) ) {
02231             <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp; JOB_OBJECT_LIMIT_WORKINGSET ) {
02232                 WsChangeRecord = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
02233                                         PagedPool,
02234                                         <span class="keyword">sizeof</span>( *WsChangeRecord ),
02235                                         'rCsP'
02236                                         );
02237                 <span class="keywordflow">if</span> ( WsChangeRecord ) {
02238                     WsChangeRecord-&gt;<a class="code" href="../../d8/d4/struct__JOB__WORKING__SET__CHANGE__RECORD.html#o1">Process</a> = Process;
02239                     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(Process);
02240                     <span class="comment">//</span>
02241                     <span class="comment">// Avoid double delete since process could be in delete routine during the above ref</span>
02242                     <span class="comment">//</span>
02243                     <span class="keywordflow">if</span> ( <a class="code" href="../../d7/d1/obref_8c.html#a1">ObGetObjectPointerCount</a>(Process) &gt; 1 ) {
02244                         InsertTailList(&amp;<a class="code" href="../../d8/d1/psp_8h.html#a20">PspWorkingSetChangeHead</a>.<a class="code" href="../../d7/d4/struct__JOB__WORKING__SET__CHANGE__HEAD.html#o0">Links</a>,&amp;WsChangeRecord-&gt;<a class="code" href="../../d8/d4/struct__JOB__WORKING__SET__CHANGE__RECORD.html#o0">Links</a>);
02245                         }
02246                     <span class="keywordflow">else</span> {
02247                         <span class="comment">//</span>
02248                         <span class="comment">// process is possibly in delete routine waiting to come</span>
02249                         <span class="comment">// out of job. DON'T Dereference !</span>
02250                         <span class="comment">//</span>
02251                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(WsChangeRecord);
02252                         }
02253                     }
02254                 }
02255             <a class="code" href="../../d8/d1/psp_8h.html#a96">PspApplyJobLimitsToProcess</a>(Job,Process);
02256             }
02257         Next = Next-&gt;Flink;
02258         }
02259 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a80" doxytag="psp.h::PspAssignPrimaryToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PspAssignPrimaryToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PACCESS_TOKEN TokenPointer&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01256">1256</a> of file <a class="el" href="../../d7/d4/ps_2security_8c-source.html">ps/security.c</a>.
<p>
References <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00661">PsFreeProcessSecurityFields</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00654">PsLockProcessSecurityFields</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l00346">SeExchangePrimaryToken()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01213">SeTokenObjectType</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/psquery_8c-source.html#l00366">PspSetPrimaryToken()</a>.
<p>
<pre class="fragment"><div>01264                    :
01265 
01266     This function performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security portions of primary token assignment.
01267     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> expected that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> proper access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process and thread objects,
01268     as well as necessary privilege, has already been established.
01269 
01270     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> primary token can <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> be replaced <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process has no threads, or
01271     has one thread.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> because <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread objects point to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary
01272     token and must have those pointers updated when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01273     changed.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> expected to be necessary at logon time, when
01274     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in its infancy and either has zero threads or maybe one
01275     inactive thread.
01276 
01277     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> assignment <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> successful, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> old token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> dereferenced and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01278     <span class="keyword">new</span> one <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> referenced.
01279 
01280 
01281 
01282 Arguments:
01283 
01284     Process - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process whose primary token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being
01285         replaced.
01286 
01287     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - The handle value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token to be assigned as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary
01288         token.
01289 
01290 
01291 Return Value:
01292 
01293     STATUS_SUCCESS - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary token has been successfully
01294         replaced.
01295 
01296     STATUS_BAD_TOKEN_TYPE - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> TokenPrimary.
01297 
01298     STATUS_TOKEN_IN_USE - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already in use by
01299         another process.
01300 
01301     Other status may be returned when attempting to reference <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token
01302     object.
01303 
01304 --*/
01305 
01306 {
01307     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
01308         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01309 
01310     PACCESS_TOKEN
01311         NewToken,
01312         OldToken;
01313 
01314     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>
01315         PreviousMode;
01316 
01317 
01318     <span class="keywordflow">if</span> ( TokenPointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )
01319     {
01320         PreviousMode = KeGetPreviousMode();
01321 
01322         <span class="comment">//</span>
01323         <span class="comment">// Reference the specified token, and make sure it can be assigned</span>
01324         <span class="comment">// as a primary token.</span>
01325         <span class="comment">//</span>
01326 
01327         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> (
01328                     Token,
01329                     TOKEN_ASSIGN_PRIMARY,
01330                     <a class="code" href="../../d0/d5/se_8h.html#a17">SeTokenObjectType</a>(),
01331                     PreviousMode,
01332                     (PVOID *)&amp;NewToken,
01333                     NULL
01334                     );
01335 
01336         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
01337             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01338         }
01339     }
01340     <span class="keywordflow">else</span>
01341     {
01342         NewToken = TokenPointer ;
01343     }
01344 
01345 
01346     <span class="comment">//</span>
01347     <span class="comment">//  Lock the process security fields.</span>
01348     <span class="comment">//</span>
01349 
01350     <a class="code" href="../../d1/d9/ps_8h.html#a21">PsLockProcessSecurityFields</a>();
01351 
01352 
01353 
01354 
01355 
01356     <span class="comment">//</span>
01357     <span class="comment">// This routine makes sure the NewToken is suitable for assignment</span>
01358     <span class="comment">// as a primary token.</span>
01359     <span class="comment">//</span>
01360 
01361     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d3/token_8c.html#a9">SeExchangePrimaryToken</a>( Process, NewToken, &amp;OldToken );
01362 
01363 
01364     <span class="comment">//</span>
01365     <span class="comment">//  Release the process security fields</span>
01366     <span class="comment">//</span>
01367 
01368     <a class="code" href="../../d1/d9/ps_8h.html#a22">PsFreeProcessSecurityFields</a>();
01369 
01370     <span class="comment">//</span>
01371     <span class="comment">// Free the old token (we don't need it).</span>
01372     <span class="comment">// This can't be done while the security fields are locked.</span>
01373     <span class="comment">//</span>
01374 
01375     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
01376 
01377         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( OldToken );
01378     }
01379 
01380     <span class="comment">//</span>
01381     <span class="comment">// Undo the handle reference</span>
01382     <span class="comment">//</span>
01383 
01384     <span class="keywordflow">if</span> ( TokenPointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )
01385     {
01386         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( NewToken );
01387     }
01388 
01389 
01390     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01391 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a99" doxytag="psp.h::PspCaptureTokenFilter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PspCaptureTokenFilter           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PJOBOBJECT_SECURITY_LIMIT_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityLimitInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html">PPS_JOB_TOKEN_FILTER</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>TokenFilter</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d0/psjob_8c-source.html#l02680">2680</a> of file <a class="el" href="../../d2/d0/psjob_8c-source.html">psjob.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d1/rtnotify_8c-source.html#l00075">Filter</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d1/d9/ps_8h.html#a43">PS_JOB_TOKEN_FILTER</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l01608">SeCaptureLuidAndAttributesArray()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l01850">SeCaptureSidAndAttributesArray()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/psjob_8c-source.html#l01323">NtSetInformationJobObject()</a>.
<p>
<pre class="fragment"><div>02685 {
02686     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
02687     <a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html">PPS_JOB_TOKEN_FILTER</a> <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a> ;
02688 
02689     <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( NonPagedPool,
02690                                     <span class="keyword">sizeof</span>( <a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html">PS_JOB_TOKEN_FILTER</a> ),
02691                                     'fTsP' );
02692 
02693     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a> )
02694     {
02695         *TokenFilter = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
02696 
02697         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES ;
02698     }
02699 
02700     RtlZeroMemory( Filter, <span class="keyword">sizeof</span>( <a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html">PS_JOB_TOKEN_FILTER</a> ) );
02701 
02702     <span class="keywordflow">try</span> {
02703 
02704         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS ;
02705 
02706         <span class="comment">//</span>
02707         <span class="comment">//  Capture Sids to remove</span>
02708         <span class="comment">//</span>
02709 
02710         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( SecurityLimitInfo-&gt;SidsToDisable)) {
02711 
02712             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( SecurityLimitInfo-&gt;SidsToDisable,
02713                           <span class="keyword">sizeof</span>(TOKEN_GROUPS),
02714                           <span class="keyword">sizeof</span>(ULONG) );
02715 
02716             <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedGroupCount = SecurityLimitInfo-&gt;SidsToDisable-&gt;GroupCount;
02717 
02718             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a14">SeCaptureSidAndAttributesArray</a>(
02719                         SecurityLimitInfo-&gt;SidsToDisable-&gt;Groups,
02720                         <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedGroupCount,
02721                         PreviousMode,
02722                         NULL, 0,
02723                         NonPagedPool,
02724                         TRUE,
02725                         &amp;<a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedGroups,
02726                         &amp;<a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedGroupsLength
02727                         );
02728 
02729         }
02730 
02731         <span class="comment">//</span>
02732         <span class="comment">//  Capture PrivilegesToDelete</span>
02733         <span class="comment">//</span>
02734 
02735         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) &amp;&amp;
02736             ARGUMENT_PRESENT(SecurityLimitInfo-&gt;PrivilegesToDelete)) {
02737 
02738             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( SecurityLimitInfo-&gt;PrivilegesToDelete,
02739                           <span class="keyword">sizeof</span>(TOKEN_PRIVILEGES),
02740                           <span class="keyword">sizeof</span>(ULONG) );
02741 
02742             <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedPrivilegeCount = SecurityLimitInfo-&gt;PrivilegesToDelete-&gt;PrivilegeCount;
02743 
02744             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a12">SeCaptureLuidAndAttributesArray</a>(
02745                          SecurityLimitInfo-&gt;PrivilegesToDelete-&gt;Privileges,
02746                          <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedPrivilegeCount,
02747                          PreviousMode,
02748                          NULL, 0,
02749                          NonPagedPool,
02750                          TRUE,
02751                          &amp;<a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedPrivileges,
02752                          &amp;<a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedPrivilegesLength
02753                          );
02754 
02755         }
02756 
02757         <span class="comment">//</span>
02758         <span class="comment">//  Capture Restricted Sids</span>
02759         <span class="comment">//</span>
02760 
02761         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) &amp;&amp;
02762             ARGUMENT_PRESENT(SecurityLimitInfo-&gt;RestrictedSids)) {
02763 
02764             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( SecurityLimitInfo-&gt;RestrictedSids,
02765                           <span class="keyword">sizeof</span>(TOKEN_GROUPS),
02766                           <span class="keyword">sizeof</span>(ULONG) );
02767 
02768             <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedSidCount = SecurityLimitInfo-&gt;RestrictedSids-&gt;GroupCount;
02769 
02770             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a14">SeCaptureSidAndAttributesArray</a>(
02771                         SecurityLimitInfo-&gt;RestrictedSids-&gt;Groups,
02772                         <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedSidCount,
02773                         PreviousMode,
02774                         NULL, 0,
02775                         NonPagedPool,
02776                         TRUE,
02777                         &amp;<a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedSids,
02778                         &amp;<a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedSidsLength
02779                         );
02780 
02781         }
02782 
02783 
02784 
02785     } except(EXCEPTION_EXECUTE_HANDLER) {
02786 
02787         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
02788     }  <span class="comment">// end_try</span>
02789 
02790     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) )
02791     {
02792         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedSids )
02793         {
02794             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedSids );
02795         }
02796 
02797         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedPrivileges )
02798         {
02799             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedPrivileges );
02800         }
02801 
02802         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedGroups )
02803         {
02804             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedGroups );
02805         }
02806 
02807         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Filter );
02808 
02809         <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
02810 
02811     }
02812 
02813     *TokenFilter = <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a> ;
02814 
02815     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
02816 
02817 
02818 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a62" doxytag="psp.h::PspCreateProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PspCreateProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE ParentProcess&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>InheritObjectTable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE SectionHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE <a class="el" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE ExceptionPort&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">969</a> of file <a class="el" href="../../d3/d7/ps_2create_8c-source.html">ps/create.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00100">_SECURITY_SUBJECT_CONTEXT::ClientToken</a>, <a class="el" href="../../d9/d6/udbgk_8c-source.html#l00026">DebugPort</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00255">_EPROCESS::DefaultHardErrorProcessing</a>, <a class="el" href="../../d1/d9/ps_8h.html#a37">EPROCESS</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00367">ExInitializeFastMutex</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00168">_OBJECT_TYPE_INITIALIZER::GenericMapping</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00463">_INITIAL_PEB::InheritedAddressSpace</a>, <a class="el" href="../../d1/d9/ps_8h.html#a41">INITIAL_PEB</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00285">_EPROCESS::Job</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02766">KeActiveProcessors</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00063">KeInitializeProcess()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00153">KeQuerySystemTime()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00512">_EJOB::LimitFlags</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00091">LpcPortObjectType</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l04631">MmCreatePeb()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00190">MmCreateProcessAddressSpace()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00911">MmInitializeProcessAddressSpace()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00381">MmSectionObjectType</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00442">MmWorkingSetList</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00467">_INITIAL_PEB::Mutant</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00055">ObCreateObject()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01258">ObGetObjectSecurity()</a>, <a class="el" href="../../d8/d9/obdevmap_8c-source.html#l00343">ObInheritDeviceMap()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00815">ObInitProcess()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00953">ObInitProcess2()</a>, <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l01022">ObKillProcess()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01418">ObReleaseObjectSecurity()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00246">_EPROCESS::Peb</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00102">_SECURITY_SUBJECT_CONTEXT::PrimaryToken</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00276">_EPROCESS::PriorityClass</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00103">_SECURITY_SUBJECT_CONTEXT::ProcessAuditId</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00575">PsActiveProcessHead</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00810">PsDereferencePrimaryToken</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00579">PsInitialSystemProcess</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00056">PsMaximumWorkingSet</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00097">PsMinimumWorkingSet</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l03058">PspActiveProcessMutex</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l00439">PspAddProcessToJob()</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01206">PspDeleteProcessSecurity()</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00113">PspForegroundQuantum</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00466">PspInheritQuota()</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01117">PspInitializeProcessSecurity()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00086">PspInitialSystemProcessHandle</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00679">PspMapSystemDll()</a>, <a class="el" href="../../d1/d9/ps_8h.html#a159a108">PsProcessPriorityBackground</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00088">PsProcessType</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00028">PsReferencePrimaryToken()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l03916">PsSetProcessPriorityByClass()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l03323">SeAccessCheck()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02466">SeAuditProcessCreation()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00247">_EPROCESS::SectionBaseAddress</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00240">_EPROCESS::SectionHandle</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01709">SeDetailedAuditing</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00265">_EPROCESS::SessionId</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00174">_EPROCESS::UniqueProcessId</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00843">NtCreateProcess()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00915">PsCreateSystemProcess()</a>, and <a class="el" href="../../d1/d0/psinit_8c-source.html#l00181">PspInitPhase0()</a>.
<p>
<pre class="fragment"><div>00982                    :
00983 
00984     This routine creates and initializes a process object.  It implements <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00985     foundation <span class="keywordflow">for</span> <a class="code" href="../../d2/d8/ps_2create_8c.html#a14">NtCreateProcess</a> and <span class="keywordflow">for</span> system initialization process
00986     creation.
00987 
00988 Arguments:
00989 
00990     ProcessHandle - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> process.
00991 
00992     DesiredAccess - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access modes to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> process.
00993 
00994     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object attributes of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> process.
00995 
00996     ParentProcess - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process' parent process.  If <span class="keyword">this</span>
00997                     parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process has no parent
00998                     and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> created <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system address space.
00999 
01000     SectionHandle - Supplies a handle to a section object to be used to create
01001                     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process' address space.  If <span class="keyword">this</span> parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not
01002                     specified, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address space <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> simply a clone of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01003                     parent process' address space.
01004 
01005     <a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a> - Supplies a handle to a port object that will be used as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01006                 process' debug port.
01007 
01008     ExceptionPort - Supplies a handle to a port object that will be used as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01009                     process' exception port.
01010 
01011 Return Value:
01012 
01013     TBD
01014 
01015 --*/
01016 
01017 {
01018     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
01019     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
01020     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Parent;
01021     KAFFINITY Affinity;
01022     KPRIORITY BasePriority;
01023     PVOID SectionToMap;
01024     PVOID ExceptionPortObject;
01025     PVOID DebugPortObject;
01026     ULONG WorkingSetMinimum, WorkingSetMaximum;
01027     HANDLE LocalProcessHandle;
01028     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
01029     HANDLE NewSection;
01030     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> DuplicateStatus;
01031     <a class="code" href="../../d2/d2/struct__INITIAL__PEB.html">INITIAL_PEB</a> InitialPeb;
01032     BOOLEAN CreatePeb;
01033     ULONG_PTR DirectoryTableBase[2];
01034     BOOLEAN AccessCheck;
01035     BOOLEAN MemoryAllocated;
01036     PSECURITY_DESCRIPTOR SecurityDescriptor;
01037     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> SubjectContext;
01038     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> accesst;
01039     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> savedst;
01040     BOOLEAN BreakAwayRequested;
01041     PUNICODE_STRING AuditName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
01042 
01043     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01044 
01045     BreakAwayRequested = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01046     CreatePeb = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01047     DirectoryTableBase[0] = 0;
01048     DirectoryTableBase[1] = 0;
01049     PreviousMode = KeGetPreviousMode();
01050 
01051     <span class="comment">//</span>
01052     <span class="comment">// Parent</span>
01053     <span class="comment">//</span>
01054 
01055     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ParentProcess) ) {
01056         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01057                 ParentProcess,
01058                 PROCESS_CREATE_PROCESS,
01059                 PsProcessType,
01060                 PreviousMode,
01061                 (PVOID *)&amp;Parent,
01062                 NULL
01063                 );
01064         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01065             <span class="keywordflow">return</span> st;
01066         }
01067 
01068         <span class="comment">//</span>
01069         <span class="comment">// Until CSR understands priority class, don't</span>
01070         <span class="comment">// inherit base priority. This just makes things</span>
01071         <span class="comment">// worse !</span>
01072         <span class="comment">//</span>
01073 
01074         BasePriority = (KPRIORITY) NORMAL_BASE_PRIORITY;
01075 
01076         <span class="comment">//</span>
01077         <span class="comment">//BasePriority = Parent-&gt;Pcb.BasePriority;</span>
01078         <span class="comment">//</span>
01079 
01080         Affinity = Parent-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o10">Affinity</a>;
01081 
01082         WorkingSetMinimum = <a class="code" href="../../d5/d0/wsmanage_8c.html#a5">PsMinimumWorkingSet</a>;              <span class="comment">// FIXFIX</span>
01083         WorkingSetMaximum = <a class="code" href="../../d2/d8/ps_2create_8c.html#a7">PsMaximumWorkingSet</a>;
01084 
01085 
01086     } <span class="keywordflow">else</span> {
01087 
01088         Parent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01089         Affinity = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a>;
01090         BasePriority = (KPRIORITY) NORMAL_BASE_PRIORITY;
01091 
01092         WorkingSetMinimum = <a class="code" href="../../d5/d0/wsmanage_8c.html#a5">PsMinimumWorkingSet</a>;              <span class="comment">// FIXFIX</span>
01093         WorkingSetMaximum = <a class="code" href="../../d2/d8/ps_2create_8c.html#a7">PsMaximumWorkingSet</a>;
01094     }
01095 
01096     <span class="comment">//</span>
01097     <span class="comment">// Section</span>
01098     <span class="comment">//</span>
01099 
01100     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(SectionHandle) ) {
01101 
01102         <span class="comment">//</span>
01103         <span class="comment">// Use Object manager tag bits to indicate that breakaway is</span>
01104         <span class="comment">// desired</span>
01105         <span class="comment">//</span>
01106 
01107         <span class="keywordflow">if</span> ( (UINT_PTR)SectionHandle &amp; 1 ) {
01108             BreakAwayRequested = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01109             }
01110 
01111         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01112                 SectionHandle,
01113                 SECTION_MAP_EXECUTE,
01114                 MmSectionObjectType,
01115                 PreviousMode,
01116                 (PVOID *)&amp;SectionToMap,
01117                 NULL
01118                 );
01119         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01120             <span class="keywordflow">if</span> (Parent) {
01121                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Parent);
01122             }
01123             <span class="keywordflow">return</span> st;
01124         }
01125     } <span class="keywordflow">else</span> {
01126         SectionToMap = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01127     }
01128 
01129     <span class="comment">//</span>
01130     <span class="comment">// DebugPort</span>
01131     <span class="comment">//</span>
01132 
01133     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(DebugPort) ) {
01134         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> (
01135                 DebugPort,
01136                 0,
01137                 LpcPortObjectType,
01138                 KeGetPreviousMode(),
01139                 (PVOID *)&amp;DebugPortObject,
01140                 NULL
01141                 );
01142         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01143             <span class="keywordflow">if</span> (Parent) {
01144                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Parent);
01145             }
01146             <span class="keywordflow">if</span> (SectionToMap) {
01147                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(SectionToMap);
01148             }
01149             <span class="keywordflow">return</span> st;
01150         }
01151     } <span class="keywordflow">else</span> {
01152         DebugPortObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01153     }
01154 
01155     <span class="comment">//</span>
01156     <span class="comment">// ExceptionPort</span>
01157     <span class="comment">//</span>
01158 
01159     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ExceptionPort) ) {
01160         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> (
01161                 ExceptionPort,
01162                 0,
01163                 LpcPortObjectType,
01164                 KeGetPreviousMode(),
01165                 (PVOID *)&amp;ExceptionPortObject,
01166                 NULL
01167                 );
01168         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01169             <span class="keywordflow">if</span> (Parent) {
01170                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Parent);
01171             }
01172             <span class="keywordflow">if</span> (SectionToMap) {
01173                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(SectionToMap);
01174             }
01175             <span class="keywordflow">if</span> (DebugPortObject) {
01176                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(DebugPortObject);
01177             }
01178 
01179             <span class="keywordflow">return</span> st;
01180         }
01181     } <span class="keywordflow">else</span> {
01182         ExceptionPortObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01183     }
01184 
01185     st = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>(
01186            KeGetPreviousMode(),
01187            PsProcessType,
01188            ObjectAttributes,
01189            KeGetPreviousMode(),
01190            NULL,
01191            (ULONG) <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>),
01192            0,
01193            0,
01194            (PVOID *)&amp;Process
01195            );
01196     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( st ) ) {
01197         <span class="keywordflow">if</span> (Parent) {
01198             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Parent);
01199         }
01200         <span class="keywordflow">if</span> (SectionToMap) {
01201             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(SectionToMap);
01202         }
01203         <span class="keywordflow">if</span> (DebugPortObject) {
01204             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(DebugPortObject);
01205         }
01206         <span class="keywordflow">if</span> (ExceptionPortObject) {
01207             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(ExceptionPortObject);
01208         }
01209         <span class="keywordflow">return</span> st;
01210     }
01211 
01212     <span class="comment">//</span>
01213     <span class="comment">// The process object is created set to NULL. Errors</span>
01214     <span class="comment">// That occur after this step cause the process delete</span>
01215     <span class="comment">// routine to be entered.</span>
01216     <span class="comment">//</span>
01217     <span class="comment">// Teardown actions that occur in the process delete routine</span>
01218     <span class="comment">// do not need to be performed inline.</span>
01219     <span class="comment">//</span>
01220 
01221     RtlZeroMemory(Process,<span class="keyword">sizeof</span>(EPROCESS));
01222 
01223     InitializeListHead(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o87">ThreadListHead</a>);
01224     Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o45">CreateProcessReported</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01225     Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o18">DebugPort</a> = DebugPortObject;
01226     Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o19">ExceptionPort</a> = ExceptionPortObject;
01227 
01228 
01229     <a class="code" href="../../d0/d2/psquota_8c.html#a4">PspInheritQuota</a>(Process,Parent);
01230     <a class="code" href="../../d7/d0/obdevmap_8c.html#a2">ObInheritDeviceMap</a>(Process,Parent);
01231 
01232     <span class="keywordflow">if</span> ( Parent ) {
01233         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o55">DefaultHardErrorProcessing</a> = Parent-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o55">DefaultHardErrorProcessing</a>;
01234         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o53">InheritedFromUniqueProcessId</a> = Parent-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a>;
01235         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o60">SessionId</a> = Parent-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o60">SessionId</a>;
01236 
01237     } <span class="keywordflow">else</span> {
01238         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o55">DefaultHardErrorProcessing</a> = 1;
01239         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o53">InheritedFromUniqueProcessId</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01240     }
01241 
01242     Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o1">ExitStatus</a> = STATUS_PENDING;
01243     Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o3">LockCount</a> = 1;
01244     Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o6">LockOwner</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01245     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o2">LockEvent</a>, SynchronizationEvent, FALSE);
01246 
01247     <span class="comment">//</span>
01248     <span class="comment">//  Initialize the security fields of the process</span>
01249     <span class="comment">//  The parent may be null exactly once (during system init).</span>
01250     <span class="comment">//  Thereafter, a parent is always required so that we have a</span>
01251     <span class="comment">//  security context to duplicate for the new process.</span>
01252     <span class="comment">//</span>
01253 
01254     st = <a class="code" href="../../d6/d5/ps_2security_8c.html#a10">PspInitializeProcessSecurity</a>( Parent, Process );
01255 
01256     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
01257 
01258 
01259         <span class="keywordflow">if</span> ( Parent ) {
01260             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Parent);
01261         }
01262 
01263         <span class="keywordflow">if</span> (SectionToMap) {
01264             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(SectionToMap);
01265         }
01266 
01267         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
01268         <span class="keywordflow">return</span> st;
01269     }
01270 
01271     <span class="comment">//</span>
01272     <span class="comment">// Clone parent's object table.</span>
01273     <span class="comment">// If no parent (booting) then use the current object table created in</span>
01274     <span class="comment">// ObInitSystem.</span>
01275     <span class="comment">//</span>
01276 
01277     <span class="keywordflow">if</span> (Parent) {
01278 
01279 
01280         <span class="comment">//</span>
01281         <span class="comment">// Calculate address space</span>
01282         <span class="comment">//</span>
01283         <span class="comment">//      If Parent == PspInitialSystem</span>
01284         <span class="comment">//</span>
01285 
01286         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d5/procsup_8c.html#a29">MmCreateProcessAddressSpace</a>(WorkingSetMinimum,
01287                                          Process,
01288                                          &amp;DirectoryTableBase[0])) {
01289 
01290             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Parent);
01291             <span class="keywordflow">if</span> (SectionToMap) {
01292                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(SectionToMap);
01293             }
01294 
01295             <a class="code" href="../../d6/d5/ps_2security_8c.html#a11">PspDeleteProcessSecurity</a>( Process );
01296 
01297             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
01298             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01299         }
01300 
01301     } <span class="keywordflow">else</span> {
01302 
01303         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o20">ObjectTable</a> = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ObjectTable;
01304 
01305         DirectoryTableBase[0] = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Pcb.DirectoryTableBase[0];
01306         DirectoryTableBase[1] = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Pcb.DirectoryTableBase[1];
01307 
01308         <span class="comment">//</span>
01309         <span class="comment">// Initialize the Working Set Mutex and address creation mutex</span>
01310         <span class="comment">// for this "hand built" process.</span>
01311         <span class="comment">// Normally, the call the MmInitializeAddressSpace initializes the</span>
01312         <span class="comment">// working set mutex, however, in this case, we have already initialized</span>
01313         <span class="comment">// the address space and we are now creating a second process using</span>
01314         <span class="comment">// the address space of the idle thread.</span>
01315         <span class="comment">//</span>
01316 
01317         <span class="comment">//KeInitializeMutant(&amp;Process-&gt;WorkingSetLock, FALSE);</span>
01318         <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o22">WorkingSetLock</a>);
01319 
01320         <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o28">AddressCreationLock</a>);
01321 
01322         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o29">HyperSpaceLock</a>);
01323 
01324         <span class="comment">//</span>
01325         <span class="comment">// Initialize virtual address descriptor root.</span>
01326         <span class="comment">//</span>
01327 
01328         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o38">VadRoot</a> == NULL);
01329         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm.WorkingSetSize;
01330         <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o0">LastTrimTime</a>);
01331         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a> = <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>;
01332     }
01333 
01334     Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o6">MaximumWorkingSetSize</a> = WorkingSetMaximum;
01335 
01336     <a class="code" href="../../d3/d5/procobj_8c.html#a3">KeInitializeProcess</a>(
01337         &amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>,
01338         BasePriority,
01339         Affinity,
01340         &amp;DirectoryTableBase[0],
01341         (BOOLEAN)(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o55">DefaultHardErrorProcessing</a> &amp; PROCESS_HARDERROR_ALIGNMENT_BIT)
01342         );
01343     Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o13">ThreadQuantum</a> = <a class="code" href="../../d0/d1/psinit_8c.html#a21">PspForegroundQuantum</a>[0];
01344     Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o68">PriorityClass</a> = PROCESS_PRIORITY_CLASS_NORMAL;
01345 
01346     <span class="keywordflow">if</span> (Parent) {
01347 
01348         <span class="comment">//</span>
01349         <span class="comment">// this used to happen in basesrv\srvtask.c</span>
01350         <span class="comment">//</span>
01351         <span class="keywordflow">if</span> ( Parent-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o68">PriorityClass</a> == PROCESS_PRIORITY_CLASS_IDLE ||
01352              Parent-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o68">PriorityClass</a> == PROCESS_PRIORITY_CLASS_BELOW_NORMAL ) {
01353              Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o68">PriorityClass</a> = Parent-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o68">PriorityClass</a>;
01354              }
01355         <span class="comment">//</span>
01356         <span class="comment">// if address space creation worked, then when going through</span>
01357         <span class="comment">// delete, we will attach. Of course, attaching means that the kprocess</span>
01358         <span class="comment">// must be initialized, so we delay the object stuff till here.</span>
01359 
01360         <span class="comment">//</span>
01361         st = <a class="code" href="../../d0/d1/obinit_8c.html#a20">ObInitProcess</a>(InheritObjectTable ? Parent : (<a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>)NULL,Process);
01362 
01363         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
01364 
01365             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Parent);
01366             <span class="keywordflow">if</span> (SectionToMap) {
01367                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(SectionToMap);
01368             }
01369 
01370             <a class="code" href="../../d6/d5/ps_2security_8c.html#a11">PspDeleteProcessSecurity</a>( Process );
01371             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
01372             <span class="keywordflow">return</span> st;
01373         }
01374     }
01375 
01376     st = STATUS_SUCCESS;
01377     savedst = STATUS_SUCCESS;
01378 
01379     <span class="comment">//</span>
01380     <span class="comment">// Initialize the process address space</span>
01381     <span class="comment">// The address space has four possibilities</span>
01382     <span class="comment">//</span>
01383     <span class="comment">//      1 - Boot Process. Address space is initialized during</span>
01384     <span class="comment">//          MmInit. Parent is not specified.</span>
01385     <span class="comment">//</span>
01386     <span class="comment">//      2 - System Process. Address space is a virgin address</span>
01387     <span class="comment">//          space that only maps system space. Process is same</span>
01388     <span class="comment">//          as PspInitialSystemProcess.</span>
01389     <span class="comment">//</span>
01390     <span class="comment">//      3 - User Process (Cloned Address Space). Address space</span>
01391     <span class="comment">//          is cloned from the specified process.</span>
01392     <span class="comment">//</span>
01393     <span class="comment">//      4 - User Process (New Image Address Space). Address space</span>
01394     <span class="comment">//          is initialized so that it maps the specified section.</span>
01395     <span class="comment">//</span>
01396 
01397     <span class="keywordflow">if</span> ( SectionToMap ) {
01398         <span class="comment">//</span>
01399         <span class="comment">// User Process (New Image Address Space). Don't specify Process to</span>
01400         <span class="comment">// clone, just SectionToMap.</span>
01401         <span class="comment">//</span>
01402 
01403         st = <a class="code" href="../../d4/d5/procsup_8c.html#a30">MmInitializeProcessAddressSpace</a>(
01404                 Process,
01405                 NULL,
01406                 SectionToMap,
01407                 &amp;AuditName
01408                 );
01409 
01410         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(SectionToMap);
01411         <a class="code" href="../../d0/d1/obinit_8c.html#a21">ObInitProcess2</a>(Process);
01412 
01413         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01414 
01415             <span class="comment">//</span>
01416             <span class="comment">// In order to support relocating executables, the proper status</span>
01417             <span class="comment">// (STATUS_IMAGE_NOT_AT_BASE) must be returned, so save it here.</span>
01418             <span class="comment">//</span>
01419 
01420             savedst = st;
01421 
01422             st = <a class="code" href="../../d8/d1/psp_8h.html#a61">PspMapSystemDll</a>(Process,NULL);
01423         }
01424 
01425         CreatePeb = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01426 
01427         <span class="keywordflow">goto</span> insert_process;
01428     }
01429 
01430     <span class="keywordflow">if</span> ( Parent ) {
01431 
01432         <span class="keywordflow">if</span> ( Parent != <a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a> ) {
01433 
01434             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o48">SectionBaseAddress</a> = Parent-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o48">SectionBaseAddress</a>;
01435 
01436             <span class="comment">//</span>
01437             <span class="comment">// User Process ( Cloned Address Space ).  Don't specify section to</span>
01438             <span class="comment">// map, just Process to clone.</span>
01439             <span class="comment">//</span>
01440 
01441             st = <a class="code" href="../../d4/d5/procsup_8c.html#a30">MmInitializeProcessAddressSpace</a>(
01442                     Process,
01443                     Parent,
01444                     NULL,
01445                     NULL
01446                     );
01447 
01448             CreatePeb = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01449 
01450         } <span class="keywordflow">else</span> {
01451 
01452             <span class="comment">//</span>
01453             <span class="comment">// System Process.  Don't specify Process to clone or section to map</span>
01454             <span class="comment">//</span>
01455 
01456             st = <a class="code" href="../../d4/d5/procsup_8c.html#a30">MmInitializeProcessAddressSpace</a>(
01457                     Process,
01458                     NULL,
01459                     NULL,
01460                     NULL
01461                     );
01462         }
01463     }
01464 
01465 insert_process:
01466 
01467     <span class="comment">//</span>
01468     <span class="comment">// If MmInitializeProcessAddressSpace was NOT successful, then</span>
01469     <span class="comment">// dereference and exit.</span>
01470     <span class="comment">//</span>
01471 
01472     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01473 
01474         <span class="keywordflow">if</span> (Parent) {
01475             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Parent);
01476         }
01477 
01478         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>);
01479         <a class="code" href="../../d0/d1/obinit_8c.html#a23">ObKillProcess</a>(FALSE, Process);
01480         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
01481 
01482         <a class="code" href="../../d6/d5/ps_2security_8c.html#a11">PspDeleteProcessSecurity</a>( Process );
01483         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
01484         <span class="keywordflow">return</span> st;
01485     }
01486 
01487     <span class="comment">//</span>
01488     <span class="comment">// Reference count of process is not biased here. Each thread in the</span>
01489     <span class="comment">// process bias the reference count when they are created.</span>
01490     <span class="comment">//</span>
01491 
01492     st = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>(
01493             Process,
01494             NULL,
01495             DesiredAccess,
01496             0,
01497             (PVOID *)NULL,
01498             &amp;LocalProcessHandle
01499             );
01500 
01501 
01502     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01503         <span class="keywordflow">if</span> (Parent) {
01504             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Parent);
01505         }
01506         <span class="keywordflow">return</span> st;
01507     }
01508 
01509     <span class="comment">//</span>
01510     <span class="comment">// See if the parent has a job. If so reference the job</span>
01511     <span class="comment">// and add the process in.</span>
01512     <span class="comment">//</span>
01513 
01514     <span class="keywordflow">if</span> ( Parent &amp;&amp; Parent-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a> &amp;&amp; !(Parent-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp; JOB_OBJECT_LIMIT_SILENT_BREAKAWAY_OK) ) {
01515 
01516         <span class="keywordflow">if</span> ( BreakAwayRequested ) {
01517             <span class="keywordflow">if</span> ( !(Parent-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp; JOB_OBJECT_LIMIT_BREAKAWAY_OK) ) {
01518                 st = STATUS_ACCESS_DENIED;
01519                 <span class="keywordflow">if</span> (Parent) {
01520                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Parent);
01521                     }
01522                 ZwClose(LocalProcessHandle);
01523                 <span class="keywordflow">return</span> st;
01524                 }
01525             }
01526         <span class="keywordflow">else</span> {
01527             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(Parent-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>);
01528             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a> = Parent-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>;
01529             st = <a class="code" href="../../d8/d1/psp_8h.html#a91">PspAddProcessToJob</a>(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>,Process);
01530             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01531                 <span class="keywordflow">if</span> (Parent) {
01532                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Parent);
01533                     }
01534                 ZwClose(LocalProcessHandle);
01535                 <span class="keywordflow">return</span> st;
01536                 }
01537             }
01538         }
01539 
01540     <a class="code" href="../../d9/d1/psquery_8c.html#a24">PsSetProcessPriorityByClass</a>(Process,PsProcessPriorityBackground);
01541 
01542     ExAcquireFastMutex(&amp;PspActiveProcessMutex);
01543     InsertTailList(&amp;PsActiveProcessHead,&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o8">ActiveProcessLinks</a>);
01544     ExReleaseFastMutex(&amp;PspActiveProcessMutex);
01545 
01546     <span class="keywordflow">if</span> (Parent &amp;&amp; CreatePeb ) {
01547 
01548         <span class="comment">//</span>
01549         <span class="comment">// For processes created w/ a section,</span>
01550         <span class="comment">// a new "virgin" PEB is created. Otherwise,</span>
01551         <span class="comment">// for forked processes, uses inherited PEB</span>
01552         <span class="comment">// with an updated mutant.</span>
01553 
01554         RtlZeroMemory(&amp;InitialPeb, FIELD_OFFSET(<a class="code" href="../../d2/d2/struct__INITIAL__PEB.html">INITIAL_PEB</a>, Mutant));
01555         InitialPeb.<a class="code" href="../../d2/d2/struct__INITIAL__PEB.html#o4">Mutant</a> = (HANDLE)(-1);
01556         <span class="keywordflow">if</span> ( SectionToMap ) {
01557 
01558             <span class="keywordflow">try</span> {
01559                 Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o47">Peb</a> = <a class="code" href="../../d4/d5/procsup_8c.html#a41">MmCreatePeb</a>(Process,&amp;InitialPeb);
01560             } except(EXCEPTION_EXECUTE_HANDLER) {
01561                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Parent);
01562                 ZwClose(LocalProcessHandle);
01563                 <span class="keywordflow">return</span> GetExceptionCode();
01564             }
01565 
01566         } <span class="keywordflow">else</span> {
01567 
01568             InitialPeb.<a class="code" href="../../d2/d2/struct__INITIAL__PEB.html#o0">InheritedAddressSpace</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01569 
01570             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o47">Peb</a> = Parent-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o47">Peb</a>;
01571 
01572             ZwWriteVirtualMemory(
01573                 LocalProcessHandle,
01574                 Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o47">Peb</a>,
01575                 &amp;InitialPeb,
01576                 <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d2/struct__INITIAL__PEB.html">INITIAL_PEB</a>),
01577                 NULL
01578                 );
01579         }
01580 
01581         <span class="comment">//</span>
01582         <span class="comment">// The new process should have a handle to its</span>
01583         <span class="comment">// section. The section is either from the specified</span>
01584         <span class="comment">// section, or the section of its parent.</span>
01585         <span class="comment">//</span>
01586 
01587         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(SectionHandle) ) {
01588             DuplicateStatus = ZwDuplicateObject(
01589                                 NtCurrentProcess(),
01590                                 SectionHandle,
01591                                 LocalProcessHandle,
01592                                 &amp;NewSection,
01593                                 0L,
01594                                 0L,
01595                                 DUPLICATE_SAME_ACCESS
01596                                 );
01597         } <span class="keywordflow">else</span> {
01598 
01599             DuplicateStatus = ZwDuplicateObject(
01600                                 ParentProcess,
01601                                 Parent-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o46">SectionHandle</a>,
01602                                 LocalProcessHandle,
01603                                 &amp;NewSection,
01604                                 0L,
01605                                 0L,
01606                                 DUPLICATE_SAME_ACCESS
01607                                 );
01608         }
01609 
01610         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(DuplicateStatus) ) {
01611             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o46">SectionHandle</a> = NewSection;
01612         }
01613 
01614         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Parent);
01615     }
01616 
01617     <span class="keywordflow">if</span> ( Parent &amp;&amp; ParentProcess != <a class="code" href="../../d6/d3/modwrite_8c.html#a13">PspInitialSystemProcessHandle</a> ) {
01618 
01619         st = <a class="code" href="../../d9/d1/obse_8c.html#a8">ObGetObjectSecurity</a>(
01620                 Process,
01621                 &amp;SecurityDescriptor,
01622                 &amp;MemoryAllocated
01623                 );
01624         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01625             ZwClose(LocalProcessHandle);
01626             <span class="keywordflow">return</span> st;
01627             }
01628 
01629         <span class="comment">//</span>
01630         <span class="comment">// Compute the subject security context</span>
01631         <span class="comment">//</span>
01632 
01633         SubjectContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o3">ProcessAuditId</a> = Process;
01634         SubjectContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o2">PrimaryToken</a> = <a class="code" href="../../d6/d5/ps_2security_8c.html#a0">PsReferencePrimaryToken</a>(Process);
01635         SubjectContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o0">ClientToken</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01636         AccessCheck = <a class="code" href="../../d0/d4/accessck_8c.html#a18">SeAccessCheck</a>(
01637                         SecurityDescriptor,
01638                         &amp;SubjectContext,
01639                         FALSE,
01640                         MAXIMUM_ALLOWED,
01641                         0,
01642                         NULL,
01643                         &amp;<a class="code" href="../../d9/d8/ntos_8h.html#a2">PsProcessType</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>,
01644                         PreviousMode,
01645                         &amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o54">GrantedAccess</a>,
01646                         &amp;accesst
01647                         );
01648         <a class="code" href="../../d1/d9/ps_8h.html#a24">PsDereferencePrimaryToken</a>(SubjectContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o2">PrimaryToken</a>);
01649         <a class="code" href="../../d9/d1/obse_8c.html#a9">ObReleaseObjectSecurity</a>(
01650             SecurityDescriptor,
01651             MemoryAllocated
01652             );
01653 
01654         <span class="keywordflow">if</span> ( !AccessCheck ) {
01655             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o54">GrantedAccess</a> = 0;
01656             }
01657 
01658         <span class="comment">//</span>
01659         <span class="comment">// It does not make any sense to create a process that can not</span>
01660         <span class="comment">// do anything to itself</span>
01661         <span class="comment">//</span>
01662 
01663         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o54">GrantedAccess</a> |= (PROCESS_VM_OPERATION | PROCESS_VM_READ | PROCESS_VM_WRITE | PROCESS_QUERY_INFORMATION | PROCESS_TERMINATE | PROCESS_CREATE_THREAD | PROCESS_DUP_HANDLE | PROCESS_CREATE_PROCESS | PROCESS_SET_INFORMATION);
01664 
01665     } <span class="keywordflow">else</span> {
01666         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o54">GrantedAccess</a> = PROCESS_ALL_ACCESS;
01667     }
01668 
01669     <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d5/se_8h.html#a106">SeDetailedAuditing</a> ) {
01670 
01671         <a class="code" href="../../d7/d6/sepaudit_8c.html#a19">SeAuditProcessCreation</a>( Process, Parent, AuditName );
01672     } 
01673 
01674     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o4">CreateTime</a>);
01675 
01676     <span class="keywordflow">try</span> {
01677         *ProcessHandle = LocalProcessHandle;
01678     } except(EXCEPTION_EXECUTE_HANDLER) {
01679         <span class="keywordflow">return</span> st;
01680     }
01681 
01682     <span class="keywordflow">if</span> (savedst != STATUS_SUCCESS) {
01683         st = savedst;
01684     }
01685 
01686     <span class="keywordflow">return</span> st;
01687 
01688 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a63" doxytag="psp.h::PspCreateThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PspCreateThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ThreadHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessPointer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PCLIENT_ID ClientId&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT <a class="el" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PINITIAL_TEB <a class="el" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>CreateSuspended</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/ke_8h.html#a66">PKSTART_ROUTINE</a> StartRoutine&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>StartContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00262">262</a> of file <a class="el" href="../../d3/d7/ps_2create_8c-source.html">ps/create.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00100">_SECURITY_SUBJECT_CONTEXT::ClientToken</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00539">_EJOB::CompletionKey</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00538">_EJOB::CompletionPort</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d1/d9/ps_8h.html#a39">ETHREAD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01315">ExChangeHandle()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01144">ExCreateHandle()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02973">ExSetHandleTableOwner</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00168">_OBJECT_TYPE_INITIALIZER::GenericMapping</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02690">_HANDLE_TABLE_ENTRY::GrantedAccess</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00134">InitialTeb</a>, <a class="el" href="../../d6/d3/complete_8c-source.html#l00671">IoSetIoCompletion()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00285">_EPROCESS::Job</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00286">_EPROCESS::JobStatus</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l00631">KeEnableApcQueuingThread()</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00039">KeInitializeSemaphore()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l00043">KeInitializeThread()</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00153">KeQuerySystemTime()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01025">KeReadyThread()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01079">KeResumeThread()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01912">KeSuspendThread()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00563">_EJOB::MemoryLimitsLock</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l02450">MmCreateKernelStack()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l04314">MmCreateTeb()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l02723">MmDeleteKernelStack()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l04843">MmDeleteTeb()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00387">MmReadClusterSize</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00055">ObCreateObject()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01258">ObGetObjectSecurity()</a>, <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02672">_HANDLE_TABLE_ENTRY::Object</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00201">_EPROCESS::ObjectTable</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01418">ObReleaseObjectSecurity()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02208">PERFINFO_PROCESS_CREATE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02215">PERFINFO_THREAD_CREATE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00367">PKSTART_ROUTINE</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00102">_SECURITY_SUBJECT_CONTEXT::PrimaryToken</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00103">_SECURITY_SUBJECT_CONTEXT::ProcessAuditId</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00316">PS_JOB_STATUS_NEW_PROCESS_REPORTED</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00314">PS_JOB_STATUS_NOT_REALLY_ACTIVE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00148">PS_SET_BITS</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00343">PS_SET_THREAD_CREATE_TIME</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00810">PsDereferencePrimaryToken</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00579">PsInitialSystemProcess</a>, <a class="el" href="../../d1/d9/ps_8h.html#a155a89">PsLockPollOnTimeout</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01966">PsLockProcess()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00029">PSP_INVALID_ID</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00189">PSP_MAX_CREATE_PROCESS_NOTIFY</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00206">PSP_MAX_CREATE_THREAD_NOTIFY</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00037">PspCidTable</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00192">PspCreateProcessNotifyRoutine</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00191">PspCreateProcessNotifyRoutineCount</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00209">PspCreateThreadNotifyRoutine</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00208">PspCreateThreadNotifyRoutineCount</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01395">PspInitializeThreadSecurity()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00249">PspMarkProcessIdValid()</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00088">PsProcessType</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01920">PspSystemThreadStartup()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01800">PspUserThreadStartup()</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00028">PsReferencePrimaryToken()</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00089">PsThreadType</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l02250">PsUnlockProcess()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l03323">SeAccessCheck()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00137">ThreadContext</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00138">ThreadHandle</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00307">_EPROCESS::ThreadListHead</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00174">_EPROCESS::UniqueProcessId</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00067">NtCreateThread()</a>, and <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00175">PsCreateSystemThread()</a>.
<p>
<pre class="fragment"><div>00278                    :
00279 
00280     This routine creates and initializes a thread object. It implements <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00281     foundation <span class="keywordflow">for</span> <a class="code" href="../../d2/d8/ps_2create_8c.html#a10">NtCreateThread</a> and <span class="keywordflow">for</span> <a class="code" href="../../d1/d9/ps_8h.html#a118">PsCreateSystemThread</a>.
00282 
00283 Arguments:
00284 
00285     <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a> - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> thread.
00286 
00287     DesiredAccess - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access modes to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> thread.
00288 
00289     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object attributes of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> thread.
00290 
00291     ProcessHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being
00292                     created within.
00293 
00294     ClientId - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CLIENT_ID of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> thread.
00295 
00296     <a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a> - Supplies a pointer to a context frame that represents <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00297                 initial user-mode context <span class="keywordflow">for</span> a user-mode thread. The absence
00298                 of <span class="keyword">this</span> parameter indicates that a system thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being
00299                 created.
00300 
00301     <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> contents of certain fields <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> threads
00302                  TEB. This parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> examined <span class="keywordflow">if</span> both a trap and
00303                  exception frame were specified.
00304 
00305     CreateSuspended - Supplies a value that controls whether or not a user-mode
00306                       thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> created in a suspended state.
00307 
00308     StartRoutine - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system thread start routine.
00309 
00310     StartContext - Supplies context <span class="keywordflow">for</span> a system thread start routine.
00311 
00312 Return Value:
00313 
00314     TBD
00315 
00316 --*/
00317 
00318 {
00319 
00320     <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">HANDLE_TABLE_ENTRY</a> CidEntry;
00321     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00322     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00323     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00324     PVOID KernelStack;
00325     PTEB Teb;
00326     INITIAL_TEB ITeb;
00327     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00328     HANDLE LocalThreadHandle;
00329     BOOLEAN AccessCheck;
00330     BOOLEAN MemoryAllocated;
00331     PSECURITY_DESCRIPTOR SecurityDescriptor;
00332     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> SubjectContext;
00333     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> accesst;
00334     LARGE_INTEGER NullTime;
00335     LARGE_INTEGER CreateTime;
00336     BOOLEAN NeedToFixProcessId = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00337 
00338     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00339 
00340     NullTime.LowPart = 0;
00341     NullTime.HighPart = 0;
00342 
00343     <span class="keywordflow">if</span> ( StartRoutine ) {
00344         PreviousMode = <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>;
00345     } <span class="keywordflow">else</span> {
00346         PreviousMode = KeGetPreviousMode();
00347     }
00348 
00349     Teb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00350 
00351     Thread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00352     Process = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00353     KernelStack = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00354 
00355     <span class="keywordflow">if</span> ( ProcessHandle ) {
00356         <span class="comment">//</span>
00357         <span class="comment">// Process object reference count is biased by one for each thread.</span>
00358         <span class="comment">// This accounts for the pointer given to the kernel that remains</span>
00359         <span class="comment">// in effect until the thread terminates (and becomes signaled)</span>
00360         <span class="comment">//</span>
00361 
00362         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00363                     ProcessHandle,
00364                     PROCESS_CREATE_THREAD,
00365                     PsProcessType,
00366                     PreviousMode,
00367                     (PVOID *)&amp;Process,
00368                     NULL
00369                     );
00370         }
00371     <span class="keywordflow">else</span> {
00372         <span class="keywordflow">if</span> ( StartRoutine ) {
00373             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(ProcessPointer);
00374             Process = ProcessPointer;
00375             st = STATUS_SUCCESS;
00376             }
00377         <span class="keywordflow">else</span> {
00378             st = STATUS_INVALID_HANDLE;
00379             }
00380         }
00381     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00382         <span class="keywordflow">return</span> st;
00383     }
00384 
00385     <span class="comment">//</span>
00386     <span class="comment">// If the previous mode is user and the target process is the system</span>
00387     <span class="comment">// process, then the operation cannot be performed.</span>
00388     <span class="comment">//</span>
00389 
00390     <span class="keywordflow">if</span> ((PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) &amp;&amp; (Process == <a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>)) {
00391         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00392         <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
00393     }
00394 
00395     st = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>(
00396              PreviousMode,
00397              PsThreadType,
00398              ObjectAttributes,
00399              PreviousMode,
00400              NULL,
00401              (ULONG) <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d6/struct__ETHREAD.html">ETHREAD</a>),
00402              0,
00403              0,
00404              (PVOID *)&amp;Thread
00405              );
00406     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( st ) ) {
00407         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00408         <span class="keywordflow">return</span> st;
00409     }
00410 
00411     RtlZeroMemory(Thread,<span class="keyword">sizeof</span>(ETHREAD));
00412     CidEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a> = Thread;
00413     CidEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a> = 0;
00414     Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueThread = <a class="code" href="../../d5/d8/ex_8h.html#a296">ExCreateHandle</a>(PspCidTable,&amp;CidEntry);
00415 
00416     <span class="keywordflow">if</span> ( !Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueThread ) {
00417         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00418         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
00419         <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
00420     }
00421 
00422     <span class="comment">//</span>
00423     <span class="comment">// Initialize Mm</span>
00424     <span class="comment">//</span>
00425 
00426     Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o21">ReadClusterSize</a> = <a class="code" href="../../d2/d1/mm_8h.html#a134">MmReadClusterSize</a>;
00427 
00428     <span class="comment">//</span>
00429     <span class="comment">// Initialize LPC</span>
00430     <span class="comment">//</span>
00431 
00432     <a class="code" href="../../d1/d6/semphobj_8c.html#a1">KeInitializeSemaphore</a>(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o13">LpcReplySemaphore</a>,0L,1L);
00433     InitializeListHead( &amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> );
00434 
00435     <span class="comment">//</span>
00436     <span class="comment">// Initialize Io</span>
00437     <span class="comment">//</span>
00438 
00439     InitializeListHead(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o18">IrpList</a>);
00440 
00441     <span class="comment">//</span>
00442     <span class="comment">// Initialize Registry</span>
00443     <span class="comment">//</span>
00444 
00445     InitializeListHead(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o8">PostBlockList</a>);
00446 
00447 
00448     <span class="comment">//</span>
00449     <span class="comment">// Initialize Security</span>
00450     <span class="comment">//</span>
00451 
00452     <a class="code" href="../../d6/d5/ps_2security_8c.html#a13">PspInitializeThreadSecurity</a>( Process, Thread );
00453 
00454     <span class="comment">//</span>
00455 
00456     InitializeListHead(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o9">TerminationPortList</a>);
00457 
00458     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o10">ActiveTimerListLock</a>);
00459     InitializeListHead(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o11">ActiveTimerListHead</a>);
00460 
00461     <span class="comment">//</span>
00462     <span class="comment">// Allocate Kernel Stack</span>
00463     <span class="comment">//</span>
00464 
00465     KernelStack = <a class="code" href="../../d4/d5/procsup_8c.html#a33">MmCreateKernelStack</a>(FALSE);
00466     <span class="keywordflow">if</span> ( !KernelStack ) {
00467         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00468         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
00469 
00470         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00471     }
00472 
00473     st = <a class="code" href="../../d2/d8/ps_2create_8c.html#a22">PsLockProcess</a>(Process,KernelMode,PsLockPollOnTimeout);
00474     <span class="keywordflow">if</span> ( st != STATUS_SUCCESS ) {
00475         <a class="code" href="../../d4/d5/procsup_8c.html#a34">MmDeleteKernelStack</a>(KernelStack, FALSE);
00476         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00477         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
00478 
00479         <span class="keywordflow">return</span> STATUS_PROCESS_IS_TERMINATING;
00480         }
00481 
00482 
00483     <span class="comment">//</span>
00484     <span class="comment">// If the process does not have its part of the client id, then</span>
00485     <span class="comment">// assign one</span>
00486     <span class="comment">//</span>
00487 
00488     <span class="keywordflow">if</span> ( !Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a> ) {
00489         CidEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a> = (PVOID)<a class="code" href="../../d1/d9/ps_8h.html#a0">PSP_INVALID_ID</a>;
00490         CidEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a> = 0;
00491         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a> = <a class="code" href="../../d5/d8/ex_8h.html#a296">ExCreateHandle</a>(PspCidTable,&amp;CidEntry);
00492         <a class="code" href="../../d5/d8/ex_8h.html#a77">ExSetHandleTableOwner</a>( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o20">ObjectTable</a>, Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a> );
00493         <span class="keywordflow">if</span> (!Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a>) {
00494             <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
00495 
00496             <a class="code" href="../../d4/d5/procsup_8c.html#a34">MmDeleteKernelStack</a>(KernelStack, FALSE);
00497             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00498             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
00499 
00500             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00501         }
00502 
00503         NeedToFixProcessId = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00504 
00505         <a class="code" href="../../d2/d1/mm_8h.html#a87">PERFINFO_PROCESS_CREATE</a>(Process);
00506     }
00507     Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueProcess = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a>;
00508 
00509     Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o28">ThreadsProcess</a> = Process;
00510 
00511     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ThreadContext)) {
00512 
00513         <span class="comment">//</span>
00514         <span class="comment">// FIX. Handle exception on bad context</span>
00515         <span class="comment">//</span>
00516 
00517         <span class="comment">//</span>
00518         <span class="comment">// User-mode thread</span>
00519         <span class="comment">//</span>
00520 
00521         <span class="keywordflow">try</span> {
00522 
00523             ITeb = *<a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>;
00524 
00525             Teb = <a class="code" href="../../d4/d5/procsup_8c.html#a40">MmCreateTeb</a> ( Process, &amp;ITeb, &amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a> );
00526 
00527             <span class="comment">//</span>
00528             <span class="comment">// Initialize kernel thread object for user mode thread.</span>
00529             <span class="comment">//</span>
00530 
00531             Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o29">StartAddress</a> = (PVOID)CONTEXT_TO_PROGRAM_COUNTER(ThreadContext);
00532 <span class="preprocessor">#if defined(_IA64_)</span>
00533 <span class="preprocessor"></span>            Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o30">Win32StartAddress</a> = (PVOID)<a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>-&gt;IntT0;
00534 <span class="preprocessor">#endif // _IA64_</span>
00535 <span class="preprocessor"></span>
00536 <span class="preprocessor">#if defined(_X86_)</span>
00537 <span class="preprocessor"></span>            Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o30">Win32StartAddress</a> = (PVOID)<a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>-&gt;Eax;
00538 <span class="preprocessor">#endif // _X86_</span>
00539 <span class="preprocessor"></span>
00540 <span class="preprocessor">#if defined(_MIPS_)</span>
00541 <span class="preprocessor"></span>            Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o30">Win32StartAddress</a> = (PVOID)<a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>-&gt;XIntA0;
00542 <span class="preprocessor">#endif // _MIPS_</span>
00543 <span class="preprocessor"></span>
00544 <span class="preprocessor">#if defined(_ALPHA_)</span>
00545 <span class="preprocessor"></span>            Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o30">Win32StartAddress</a> = (PVOID)<a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>-&gt;IntA0;
00546 <span class="preprocessor">#endif // _ALPHA_</span>
00547 <span class="preprocessor"></span>
00548 <span class="preprocessor">#if defined(_PPC_)</span>
00549 <span class="preprocessor"></span>            Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o30">Win32StartAddress</a> = (PVOID)<a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>-&gt;Gpr3;
00550 <span class="preprocessor">#endif // _PPC_</span>
00551 <span class="preprocessor"></span>
00552             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)
00553             <a class="code" href="../../d9/d1/thredobj_8c.html#a1">KeInitializeThread</a>(
00554                 &amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>,
00555                 KernelStack,
00556                 PspUserThreadStartup,
00557                 (PKSTART_ROUTINE)NULL,
00558                 (PVOID)CONTEXT_TO_PROGRAM_COUNTER(ThreadContext),
00559                 ThreadContext,
00560                 Teb,
00561                 &amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>
00562                 );
00563 
00564         } except(EXCEPTION_EXECUTE_HANDLER) {
00565 
00566 
00567             <span class="keywordflow">if</span> ( Teb ) {
00568                 <a class="code" href="../../d4/d5/procsup_8c.html#a42">MmDeleteTeb</a>(Process, Teb);
00569             }
00570 
00571             <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
00572 
00573              <a class="code" href="../../d4/d5/procsup_8c.html#a34">MmDeleteKernelStack</a>(KernelStack, FALSE);
00574              Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o2">InitialStack</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00575              <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
00576 
00577              <span class="keywordflow">return</span> GetExceptionCode();
00578         }
00579 
00580     } <span class="keywordflow">else</span> {
00581 
00582         <span class="comment">//</span>
00583         <span class="comment">// Initialize kernel thread object for kernel mode thread.</span>
00584         <span class="comment">//</span>
00585 
00586         Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o29">StartAddress</a> = (PVOID)StartRoutine;
00587         <a class="code" href="../../d9/d1/thredobj_8c.html#a1">KeInitializeThread</a>(
00588             &amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>,
00589             KernelStack,
00590             PspSystemThreadStartup,
00591             StartRoutine,
00592             StartContext,
00593             NULL,
00594             NULL,
00595             &amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>
00596             );
00597 
00598     }
00599 
00600     InsertTailList(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o87">ThreadListHead</a>,&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o37">ThreadListEntry</a>);
00601 
00602     <span class="keywordflow">if</span> ( NeedToFixProcessId ) {
00603 
00604         <span class="comment">//</span>
00605         <span class="comment">// Now that the thread is really there and will rundown through exit,</span>
00606         <span class="comment">// open up the process id</span>
00607         <span class="comment">//</span>
00608 
00609         <a class="code" href="../../d5/d8/ex_8h.html#a298">ExChangeHandle</a>(PspCidTable, Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueProcess, PspMarkProcessIdValid, (ULONG_PTR)Process);
00610 
00611         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/psp_8h.html#a21">PspCreateProcessNotifyRoutineCount</a> != 0) {
00612             ULONG i;
00613 
00614             <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d8/d1/psp_8h.html#a5">PSP_MAX_CREATE_PROCESS_NOTIFY</a>; i++) {
00615                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/psp_8h.html#a22">PspCreateProcessNotifyRoutine</a>[i] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00616                     (*<a class="code" href="../../d8/d1/psp_8h.html#a22">PspCreateProcessNotifyRoutine</a>[i])( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o53">InheritedFromUniqueProcessId</a>,
00617                                                          Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a>,
00618                                                          <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00619                                                        );
00620                     }
00621                 }
00622             }
00623 
00624 
00625         }
00626 
00627     <span class="comment">//</span>
00628     <span class="comment">// If the process has a job with a completion port,</span>
00629     <span class="comment">// AND if the process is really considered to be in the Job, AND</span>
00630     <span class="comment">// the process has not reported, report in</span>
00631     <span class="comment">//</span>
00632     <span class="comment">// This should really be done in add process to job, but can't</span>
00633     <span class="comment">// in this path because the process's ID isn't assigned until this point</span>
00634     <span class="comment">// in time</span>
00635     <span class="comment">//</span>
00636 
00637     <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>
00638          &amp;&amp; Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a>
00639          &amp;&amp; !(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a9">PS_JOB_STATUS_NOT_REALLY_ACTIVE</a>)
00640          &amp;&amp; !(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a11">PS_JOB_STATUS_NEW_PROCESS_REPORTED</a>)) {
00641 
00642         <a class="code" href="../../d1/d9/ps_8h.html#a6">PS_SET_BITS</a> (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a>, PS_JOB_STATUS_NEW_PROCESS_REPORTED);
00643 
00644         ExAcquireFastMutex(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o41">MemoryLimitsLock</a>);
00645         <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00646             <a class="code" href="../../d5/d4/complete_8c.html#a6">IoSetIoCompletion</a>(
00647                 Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a>,
00648                 Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o26">CompletionKey</a>,
00649                 (PVOID)Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a>,
00650                 STATUS_SUCCESS,
00651                 JOB_OBJECT_MSG_NEW_PROCESS,
00652                 FALSE
00653                 );
00654         }
00655         ExReleaseFastMutex(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o41">MemoryLimitsLock</a>);
00656         }
00657 
00658     <a class="code" href="../../d2/d1/mm_8h.html#a94">PERFINFO_THREAD_CREATE</a>(Thread, InitialTeb);
00659 
00660     <span class="comment">//</span>
00661     <span class="comment">// Notify registered callout routines of thread creation.</span>
00662     <span class="comment">//</span>
00663 
00664     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/psp_8h.html#a23">PspCreateThreadNotifyRoutineCount</a> != 0) {
00665         ULONG i;
00666 
00667         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d8/d1/psp_8h.html#a6">PSP_MAX_CREATE_THREAD_NOTIFY</a>; i++) {
00668             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/psp_8h.html#a24">PspCreateThreadNotifyRoutine</a>[i] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00669                 (*<a class="code" href="../../d8/d1/psp_8h.html#a24">PspCreateThreadNotifyRoutine</a>[i])( Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueProcess,
00670                                                     Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueThread,
00671                                                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00672                                                    );
00673             }
00674         }
00675     }
00676 
00677     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d9/d1/thredobj_8c.html#a7">KeEnableApcQueuingThread</a>(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>);
00678 
00679     <span class="keywordflow">if</span> (CreateSuspended) {
00680         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d9/d1/thredobj_8c.html#a25">KeSuspendThread</a>(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>);
00681     }
00682 
00683 
00684     <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
00685 
00686     <span class="comment">//</span>
00687     <span class="comment">// Failures that occur after this point cause the thread to</span>
00688     <span class="comment">// go through PspExitThread</span>
00689     <span class="comment">//</span>
00690 
00691     <span class="comment">//</span>
00692     <span class="comment">// Reference count of thread is biased once for itself, and</span>
00693     <span class="comment">// once to account for its Cid Handle</span>
00694     <span class="comment">//</span>
00695     <span class="comment">// Note:</span>
00696     <span class="comment">//      if this fails we should do punt so we only have one</span>
00697     <span class="comment">//      cleanup path that really goes through PspExitThread ?</span>
00698     <span class="comment">//      Remember to free spin locks, cid...</span>
00699     <span class="comment">//</span>
00700 
00701     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(Thread);
00702     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(Thread);
00703     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(Thread);
00704 
00705     st = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>(
00706             Thread,
00707             NULL,
00708             DesiredAccess,
00709             0,
00710             (PVOID *)NULL,
00711             &amp;LocalThreadHandle
00712             );
00713 
00714     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00715 
00716         <span class="comment">//</span>
00717         <span class="comment">// The insert failed. Terminate the thread.</span>
00718         <span class="comment">//</span>
00719 
00720         <span class="comment">//</span>
00721         <span class="comment">// This trick us used so that Dbgk doesn't report</span>
00722         <span class="comment">// events for dead threads</span>
00723         <span class="comment">//</span>
00724 
00725         Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o24">DeadThread</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00726         Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o26">HasTerminated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00727 
00728         <span class="keywordflow">if</span> (CreateSuspended) {
00729             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d9/d1/thredobj_8c.html#a15">KeResumeThread</a>(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>);
00730         }
00731 
00732     } <span class="keywordflow">else</span> {
00733 
00734         <span class="keywordflow">try</span> {
00735 
00736             *<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a> = LocalThreadHandle;
00737             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ClientId)) {
00738                 *ClientId = Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>;
00739             }
00740         } except(EXCEPTION_EXECUTE_HANDLER) {
00741 
00742             <span class="keywordflow">if</span> ( GetExceptionCode() == STATUS_QUOTA_EXCEEDED ) {
00743 
00744                 <span class="comment">//</span>
00745                 <span class="comment">// This trick us used so that Dbgk doesn't report</span>
00746                 <span class="comment">// events for dead threads</span>
00747                 <span class="comment">//</span>
00748 
00749                 Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o24">DeadThread</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00750                 Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o26">HasTerminated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00751 
00752                 <span class="keywordflow">if</span> (CreateSuspended) {
00753                     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d9/d1/thredobj_8c.html#a15">KeResumeThread</a>(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>);
00754                 }
00755                 <a class="code" href="../../d9/d1/thredobj_8c.html#a14">KeReadyThread</a>(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>);
00756                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
00757                 ZwClose(LocalThreadHandle);
00758                 <span class="keywordflow">return</span> GetExceptionCode();
00759             }
00760         }
00761     }
00762 
00763     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;CreateTime);
00764     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((CreateTime.HighPart &amp; 0xf0000000) == 0);
00765     <a class="code" href="../../d1/d9/ps_8h.html#a16">PS_SET_THREAD_CREATE_TIME</a>(Thread, CreateTime);
00766 
00767     <span class="keywordflow">if</span> ( !Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o24">DeadThread</a> ) {
00768         st = <a class="code" href="../../d9/d1/obse_8c.html#a8">ObGetObjectSecurity</a>(
00769                 Thread,
00770                 &amp;SecurityDescriptor,
00771                 &amp;MemoryAllocated
00772                 );
00773         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00774             <span class="comment">//</span>
00775             <span class="comment">// This trick us used so that Dbgk doesn't report</span>
00776             <span class="comment">// events for dead threads</span>
00777             <span class="comment">//</span>
00778 
00779             Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o24">DeadThread</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00780             Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o26">HasTerminated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00781 
00782             <span class="keywordflow">if</span> (CreateSuspended) {
00783                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d9/d1/thredobj_8c.html#a15">KeResumeThread</a>(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>);
00784             }
00785             <a class="code" href="../../d9/d1/thredobj_8c.html#a14">KeReadyThread</a>(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>);
00786             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
00787             ZwClose(LocalThreadHandle);
00788             <span class="keywordflow">return</span> st;
00789             }
00790 
00791         <span class="comment">//</span>
00792         <span class="comment">// Compute the subject security context</span>
00793         <span class="comment">//</span>
00794 
00795         SubjectContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o3">ProcessAuditId</a> = Process;
00796         SubjectContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o2">PrimaryToken</a> = <a class="code" href="../../d6/d5/ps_2security_8c.html#a0">PsReferencePrimaryToken</a>(Process);
00797         SubjectContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o0">ClientToken</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00798 
00799         AccessCheck = <a class="code" href="../../d0/d4/accessck_8c.html#a18">SeAccessCheck</a>(
00800                         SecurityDescriptor,
00801                         &amp;SubjectContext,
00802                         FALSE,
00803                         MAXIMUM_ALLOWED,
00804                         0,
00805                         NULL,
00806                         &amp;<a class="code" href="../../d9/d8/ntos_8h.html#a3">PsThreadType</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>,
00807                         PreviousMode,
00808                         &amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o27">GrantedAccess</a>,
00809                         &amp;accesst
00810                         );
00811         <a class="code" href="../../d1/d9/ps_8h.html#a24">PsDereferencePrimaryToken</a>(SubjectContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o2">PrimaryToken</a>);
00812         <a class="code" href="../../d9/d1/obse_8c.html#a9">ObReleaseObjectSecurity</a>(
00813             SecurityDescriptor,
00814             MemoryAllocated
00815             );
00816 
00817         <span class="keywordflow">if</span> ( !AccessCheck ) {
00818             Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o27">GrantedAccess</a> = 0;
00819             }
00820 
00821         <span class="keywordflow">if</span> ( (Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o27">GrantedAccess</a> &amp; THREAD_SET_THREAD_TOKEN) == 0 )
00822         {
00823             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"SE: Warning, new thread does not have SET_THREAD_TOKEN for itself\n"</span> );
00824             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"SE: Check that thread %x.%x isn't in some weird state\n"</span>,
00825                         <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid.UniqueProcess,
00826                         <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid.UniqueThread );
00827 
00828         }
00829 
00830         Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o27">GrantedAccess</a> |= (THREAD_TERMINATE | THREAD_SET_INFORMATION | THREAD_QUERY_INFORMATION);
00831 
00832         }
00833     <span class="keywordflow">else</span> {
00834         Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o27">GrantedAccess</a> = THREAD_ALL_ACCESS;
00835         }
00836     <a class="code" href="../../d9/d1/thredobj_8c.html#a14">KeReadyThread</a>(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>);
00837     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
00838 
00839     <span class="keywordflow">return</span> st;
00840 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a85" doxytag="psp.h::PspDeleteLdt" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspDeleteLdt           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Process</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/alpha_2psldt_8c-source.html#l00140">140</a> of file <a class="el" href="../../d3/d0/alpha_2psldt_8c-source.html">alpha/psldt.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01363">PspProcessDelete()</a>.
<p>
<pre class="fragment"><div>00145                    :
00146     
00147     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a stub <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Ldt <span class="keyword">delete</span> routine
00148 
00149 Arguments:
00150 
00151     Process -- Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process
00152 
00153 Return Value:
00154 
00155     None
00156 --*/
00157 {
00158 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a77" doxytag="psp.h::PspDeleteProcessSecurity" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspDeleteProcessSecurity           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Process</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01206">1206</a> of file <a class="el" href="../../d7/d4/ps_2security_8c-source.html">ps/security.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d2/token_8c-source.html#l00302">SeDeassignPrimaryToken()</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>, and <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01363">PspProcessDelete()</a>.
<p>
<pre class="fragment"><div>01212                    :
01213 
01214     This function cleans up a process's security fields as part of process
01215     deletion.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed no other references to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process can occur
01216     during or after a call to <span class="keyword">this</span> routine.  This enables us to reference
01217     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process security fields without acquiring <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock protecting those
01218     fields.
01219 
01220     NOTE: It may be desirable to add auditing capability to <span class="keyword">this</span> routine
01221           at some point.
01222 
01223 
01224 Arguments:
01225 
01226     Process - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process being deleted.
01227 
01228 
01229 Return Value:
01230 
01231     None.
01232 
01233 --*/
01234 
01235 {
01236 
01237 
01238 
01239 
01240     <span class="comment">//</span>
01241     <span class="comment">// If we are deleting a process that didn't successfully complete</span>
01242     <span class="comment">// process initialization, then there may be no token associated</span>
01243     <span class="comment">// with it yet.</span>
01244     <span class="comment">//</span>
01245 
01246     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Process-&gt;Token)) {
01247         <a class="code" href="../../d4/d3/token_8c.html#a8">SeDeassignPrimaryToken</a>( Process );
01248         Process-&gt;Token = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01249     }
01250 
01251     <span class="keywordflow">return</span>;
01252 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a79" doxytag="psp.h::PspDeleteThreadSecurity" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspDeleteThreadSecurity           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Thread</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01436">1436</a> of file <a class="el" href="../../d7/d4/ps_2security_8c-source.html">ps/security.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01438">PspThreadDelete()</a>.
<p>
<pre class="fragment"><div>01442                    :
01443 
01444     This function cleans up a thread's security fields as part of thread
01445     deletion.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed no other references to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread can occur
01446     during or after a call to <span class="keyword">this</span> routine, so no locking <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> necessary
01447     to access <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread security fields.
01448 
01449 
01450 Arguments:
01451 
01452     Thread - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread being deleted.
01453 
01454 
01455 Return Value:
01456 
01457     None.
01458 
01459 --*/
01460 
01461 {
01462 
01463     <span class="comment">//</span>
01464     <span class="comment">// clean-up client information, if there is any.</span>
01465     <span class="comment">//</span>
01466 
01467     <span class="keywordflow">if</span> ( Thread-&gt;ActiveImpersonationInfo ) {
01468         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Thread-&gt;ImpersonationInfo-&gt;Token );
01469     }
01470 
01471     <span class="keywordflow">if</span> ( Thread-&gt;ImpersonationInfo ) {
01472         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Thread-&gt;ImpersonationInfo );
01473         Thread-&gt;ActiveImpersonationInfo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01474         Thread-&gt;ImpersonationInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01475     }
01476 
01477     <span class="keywordflow">return</span>;
01478 
01479 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a87" doxytag="psp.h::PspDeleteVdmObjects" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspDeleteVdmObjects           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Process</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/alpha_2psvdm_8c-source.html#l00058">58</a> of file <a class="el" href="../../d3/d1/alpha_2psvdm_8c-source.html">alpha/psvdm.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01363">PspProcessDelete()</a>.
<p>
<pre class="fragment"><div>00063                    :
00064 
00065     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a stub <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Vdm Objects <span class="keyword">delete</span> routine
00066 
00067 Arguments:
00068 
00069     Process -- Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process
00070 
00071 Return Value:
00072 
00073     None
00074 --*/
00075 {
00076     UNREFERENCED_PARAMETER(Process);
00077 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a53" doxytag="psp.h::PspDereferenceQuota" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspDereferenceQuota           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Process</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/psquota_8c-source.html#l00494">494</a> of file <a class="el" href="../../d1/d1/psquota_8c-source.html">psquota.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00133">MiReturnPageFileQuota()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00356">PsReturnPoolQuota()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00107">_EPROCESS_QUOTA_BLOCK::QuotaLock</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00108">_EPROCESS_QUOTA_BLOCK::ReferenceCount</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01363">PspProcessDelete()</a>.
<p>
<pre class="fragment"><div>00497 {
00498     <a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html">PEPROCESS_QUOTA_BLOCK</a> QuotaBlock;
00499     KIRQL OldIrql;
00500 
00501     QuotaBlock = Process-&gt;QuotaBlock;
00502 
00503     <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>(Process,NonPagedPool,Process-&gt;QuotaPoolUsage[NonPagedPool]);
00504     <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>(Process,PagedPool,Process-&gt;QuotaPoolUsage[PagedPool]);
00505     <a class="code" href="../../d0/d2/psquota_8c.html#a5">MiReturnPageFileQuota</a>(Process-&gt;PagefileUsage,Process);
00506 
00507     ExAcquireSpinLock(&amp;QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>,&amp;OldIrql);
00508 
00509     QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o1">ReferenceCount</a>--;
00510     <span class="keywordflow">if</span> ( QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o1">ReferenceCount</a> == 0 ) {
00511         ExReleaseSpinLock(&amp;QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>,OldIrql);
00512         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(QuotaBlock);
00513         }
00514     <span class="keywordflow">else</span> {
00515         ExReleaseSpinLock(&amp;QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>,OldIrql);
00516         }
00517 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a75" doxytag="psp.h::PspExitNormalApc" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspExitNormalApc           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00631">631</a> of file <a class="el" href="../../d9/d9/psdelete_8c-source.html">psdelete.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00639">IS_SYSTEM_THREAD</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00070">KeBugCheck()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l00688">KeForceResumeThread()</a>, <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00039">KeInitializeApc()</a>, <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00217">KeInsertQueueApc()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00244">_KAPC::NormalContext</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d9/ke_8h.html#a403a181">OriginalApcEnvironment</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00603">PsExitSpecialApc()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00631">PspExitNormalApc()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00690">PspExitThread()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00347">_ETHREAD::Tcb</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00631">PspExitNormalApc()</a>, and <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00160">PspTerminateThreadByPointer()</a>.
<p>
<pre class="fragment"><div>00637 {
00638     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00639     <a class="code" href="../../d1/d5/struct__KAPC.html">PKAPC</a> ExitApc;
00640     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> ExitStatus;
00641 
00642     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00643 
00644     Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00645 
00646     <span class="keywordflow">if</span> ( SystemArgument2 ) {
00647         <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(0x12345678);
00648     }
00649 
00650     ExitApc = (<a class="code" href="../../d1/d5/struct__KAPC.html">PKAPC</a>) SystemArgument1;
00651 
00652     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d9/ps_8h.html#a18">IS_SYSTEM_THREAD</a>(Thread) ) {
00653         ExitStatus = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)((LONG_PTR)ExitApc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o8">NormalContext</a>);
00654         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ExitApc);
00655         <a class="code" href="../../d8/d1/psp_8h.html#a68">PspExitThread</a>(ExitStatus);
00656     } <span class="keywordflow">else</span> {
00657 
00658         <a class="code" href="../../d5/d7/apcobj_8c.html#a1">KeInitializeApc</a>(
00659             ExitApc,
00660             &amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>,
00661             OriginalApcEnvironment,
00662             PsExitSpecialApc,
00663             NULL,
00664             PspExitNormalApc,
00665             UserMode,
00666             NormalContext
00667             );
00668 
00669         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d7/apcobj_8c.html#a3">KeInsertQueueApc</a>(ExitApc,ExitApc,(PVOID) 1, 2) ) {
00670             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ExitApc);
00671         }
00672 
00673         <a class="code" href="../../d9/d1/thredobj_8c.html#a8">KeForceResumeThread</a>(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>);
00674     }
00675 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a71" doxytag="psp.h::PspExitProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspExitProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>TrimAddressSpace</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01232">1232</a> of file <a class="el" href="../../d9/d9/psdelete_8c-source.html">psdelete.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d3/complete_8c-source.html#l00671">IoSetIoCompletion()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02774">KeMaximumIncrement</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00656">KeSetProcess()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l01695">MmCleanProcessAddressSpace()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l01022">ObKillProcess()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d1/po_8h-source.html#l00104">PoRundownProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00317">PS_JOB_STATUS_EXIT_PROCESS_REPORTED</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00319">PS_JOB_STATUS_LAST_REPORT_MEMORY</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00314">PS_JOB_STATUS_NOT_REALLY_ACTIVE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00154">PS_SET_CLEAR_BITS</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00189">PSP_MAX_CREATE_PROCESS_NOTIFY</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l03058">PspActiveProcessMutex</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00192">PspCreateProcessNotifyRoutine</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00191">PspCreateProcessNotifyRoutineCount</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00690">PspExitThread()</a>, and <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01363">PspProcessDelete()</a>.
<p>
<pre class="fragment"><div>01236 {
01237 
01238     ULONG ActualTime;
01239 
01240     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01241 
01242     <span class="keywordflow">if</span> (!Process-&gt;ExitProcessCalled &amp;&amp; <a class="code" href="../../d8/d1/psp_8h.html#a21">PspCreateProcessNotifyRoutineCount</a> != 0) {
01243         ULONG i;
01244 
01245         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d8/d1/psp_8h.html#a5">PSP_MAX_CREATE_PROCESS_NOTIFY</a>; i++) {
01246             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/psp_8h.html#a22">PspCreateProcessNotifyRoutine</a>[i] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01247                 (*<a class="code" href="../../d8/d1/psp_8h.html#a22">PspCreateProcessNotifyRoutine</a>[i])( Process-&gt;InheritedFromUniqueProcessId,
01248                                                      Process-&gt;UniqueProcessId,
01249                                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01250                                                    );
01251             }
01252         }
01253     }
01254 
01255     Process-&gt;ExitProcessCalled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01256 
01257     <a class="code" href="../../d1/d2/po_8h.html#a7">PoRundownProcess</a>(Process);
01258 
01259     <span class="comment">//</span>
01260     <span class="comment">// If the process is on the active list, remove it now. Must be done before ObKill</span>
01261     <span class="comment">// due to code in ex\sysinfo that references the process through the handle table</span>
01262     <span class="comment">//</span>
01263 
01264     <span class="keywordflow">if</span> ( Process-&gt;ActiveProcessLinks.Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
01265          Process-&gt;ActiveProcessLinks.Blink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01266 
01267         ExAcquireFastMutex(&amp;PspActiveProcessMutex);
01268         RemoveEntryList(&amp;Process-&gt;ActiveProcessLinks);
01269         Process-&gt;ActiveProcessLinks.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01270         Process-&gt;ActiveProcessLinks.Blink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01271         ExReleaseFastMutex(&amp;PspActiveProcessMutex);
01272 
01273     }
01274 
01275     <span class="keywordflow">if</span> (Process-&gt;SecurityPort) {
01276 
01277         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process-&gt;SecurityPort);
01278 
01279         Process-&gt;SecurityPort = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
01280     }
01281 
01282 
01283     <span class="keywordflow">if</span> ( TrimAddressSpace ) {
01284 
01285 
01286         <span class="comment">//</span>
01287         <span class="comment">// If the current process has previously set the timer resolution,</span>
01288         <span class="comment">// then reset it.</span>
01289         <span class="comment">//</span>
01290 
01291         <span class="keywordflow">if</span> (Process-&gt;SetTimerResolution != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01292             ZwSetTimerResolution(KeMaximumIncrement, FALSE, &amp;ActualTime);
01293         }
01294 
01295         <span class="keywordflow">if</span> ( Process-&gt;Job
01296              &amp;&amp; Process-&gt;Job-&gt;CompletionPort
01297              &amp;&amp; !(Process-&gt;JobStatus &amp; <a class="code" href="../../d1/d9/ps_8h.html#a9">PS_JOB_STATUS_NOT_REALLY_ACTIVE</a>)
01298              &amp;&amp; !(Process-&gt;JobStatus &amp; <a class="code" href="../../d1/d9/ps_8h.html#a12">PS_JOB_STATUS_EXIT_PROCESS_REPORTED</a>)) {
01299 
01300             ULONG_PTR ExitMessageId;
01301 
01302             <span class="keywordflow">switch</span> (Process-&gt;ExitStatus) {
01303                 <span class="keywordflow">case</span> STATUS_GUARD_PAGE_VIOLATION      :
01304                 <span class="keywordflow">case</span> STATUS_DATATYPE_MISALIGNMENT     :
01305                 <span class="keywordflow">case</span> STATUS_BREAKPOINT                :
01306                 <span class="keywordflow">case</span> STATUS_SINGLE_STEP               :
01307                 <span class="keywordflow">case</span> STATUS_ACCESS_VIOLATION          :
01308                 <span class="keywordflow">case</span> STATUS_IN_PAGE_ERROR             :
01309                 <span class="keywordflow">case</span> STATUS_ILLEGAL_INSTRUCTION       :
01310                 <span class="keywordflow">case</span> STATUS_NONCONTINUABLE_EXCEPTION  :
01311                 <span class="keywordflow">case</span> STATUS_INVALID_DISPOSITION       :
01312                 <span class="keywordflow">case</span> STATUS_ARRAY_BOUNDS_EXCEEDED     :
01313                 <span class="keywordflow">case</span> STATUS_FLOAT_DENORMAL_OPERAND    :
01314                 <span class="keywordflow">case</span> STATUS_FLOAT_DIVIDE_BY_ZERO      :
01315                 <span class="keywordflow">case</span> STATUS_FLOAT_INEXACT_RESULT      :
01316                 <span class="keywordflow">case</span> STATUS_FLOAT_INVALID_OPERATION   :
01317                 <span class="keywordflow">case</span> STATUS_FLOAT_OVERFLOW            :
01318                 <span class="keywordflow">case</span> STATUS_FLOAT_STACK_CHECK         :
01319                 <span class="keywordflow">case</span> STATUS_FLOAT_UNDERFLOW           :
01320                 <span class="keywordflow">case</span> STATUS_INTEGER_DIVIDE_BY_ZERO    :
01321                 <span class="keywordflow">case</span> STATUS_INTEGER_OVERFLOW          :
01322                 <span class="keywordflow">case</span> STATUS_PRIVILEGED_INSTRUCTION    :
01323                 <span class="keywordflow">case</span> STATUS_STACK_OVERFLOW            :
01324                 <span class="keywordflow">case</span> STATUS_CONTROL_C_EXIT            :
01325                 <span class="keywordflow">case</span> STATUS_FLOAT_MULTIPLE_FAULTS     :
01326                 <span class="keywordflow">case</span> STATUS_FLOAT_MULTIPLE_TRAPS      :
01327                 <span class="keywordflow">case</span> STATUS_REG_NAT_CONSUMPTION       :
01328                     ExitMessageId = JOB_OBJECT_MSG_ABNORMAL_EXIT_PROCESS;
01329                     <span class="keywordflow">break</span>;
01330                 <span class="keywordflow">default</span>:
01331                     ExitMessageId = JOB_OBJECT_MSG_EXIT_PROCESS;
01332                     <span class="keywordflow">break</span>;
01333                 }
01334 
01335             <a class="code" href="../../d1/d9/ps_8h.html#a8">PS_SET_CLEAR_BITS</a> (&amp;Process-&gt;JobStatus,
01336                                PS_JOB_STATUS_EXIT_PROCESS_REPORTED,
01337                                PS_JOB_STATUS_LAST_REPORT_MEMORY);
01338 
01339             ExAcquireFastMutex(&amp;Process-&gt;Job-&gt;MemoryLimitsLock);
01340 
01341             <span class="keywordflow">if</span> (Process-&gt;Job-&gt;CompletionPort != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01342                 <a class="code" href="../../d5/d4/complete_8c.html#a6">IoSetIoCompletion</a>(
01343                     Process-&gt;Job-&gt;CompletionPort,
01344                     Process-&gt;Job-&gt;CompletionKey,
01345                     (PVOID)Process-&gt;UniqueProcessId,
01346                     STATUS_SUCCESS,
01347                     ExitMessageId,
01348                     FALSE
01349                     );
01350             }
01351             ExReleaseFastMutex(&amp;Process-&gt;Job-&gt;MemoryLimitsLock);
01352             }
01353 
01354     } <span class="keywordflow">else</span> {
01355         <a class="code" href="../../d3/d5/procobj_8c.html#a10">KeSetProcess</a>(&amp;Process-&gt;Pcb,0,FALSE);
01356         <a class="code" href="../../d0/d1/obinit_8c.html#a23">ObKillProcess</a>(FALSE, Process);
01357         <a class="code" href="../../d4/d5/procsup_8c.html#a32">MmCleanProcessAddressSpace</a>();
01358     }
01359 
01360 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a93" doxytag="psp.h::PspExitProcessFromJob" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspExitProcessFromJob           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d3/struct__EJOB.html">PEJOB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Job</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d0/psjob_8c-source.html#l00608">608</a> of file <a class="el" href="../../d2/d0/psjob_8c-source.html">psjob.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00503">_EJOB::ActiveProcesses</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00491">_EJOB::JobLock</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00286">_EPROCESS::JobStatus</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00314">PS_JOB_STATUS_NOT_REALLY_ACTIVE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00148">PS_SET_BITS</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l02632">PspFoldProcessAccountingIntoJob()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00690">PspExitThread()</a>.
<p>
<pre class="fragment"><div>00612 {
00613 
00614     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00615 
00616     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00617     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o3">JobLock</a>, TRUE);
00618 
00619     <span class="comment">//</span>
00620     <span class="comment">// Update REMOVE accounting info</span>
00621     <span class="comment">//</span>
00622 
00623 
00624     <span class="keywordflow">if</span> ( !(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a9">PS_JOB_STATUS_NOT_REALLY_ACTIVE</a>) ) {
00625         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o10">ActiveProcesses</a>--;
00626         <a class="code" href="../../d1/d9/ps_8h.html#a6">PS_SET_BITS</a> (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a>, PS_JOB_STATUS_NOT_REALLY_ACTIVE);
00627         }
00628 
00629     <a class="code" href="../../d8/d1/psp_8h.html#a98">PspFoldProcessAccountingIntoJob</a>(Job,Process);
00630 
00631     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o3">JobLock</a>);
00632     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00633 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a70" doxytag="psp.h::PspExitSpecialApc" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspExitSpecialApc           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Apc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a68" doxytag="psp.h::PspExitThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> DECLSPEC_NORETURN VOID PspExitThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN NTSTATUS&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ExitStatus</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00690">690</a> of file <a class="el" href="../../d9/d9/psdelete_8c-source.html">psdelete.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l00575">_KTHREAD::ApcState</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00658">_KTHREAD::ApcStateIndex</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00388">_ETHREAD::Cid</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01028">CmNotifyRunDown()</a>, <a class="el" href="../../d8/d2/dbgkproc_8c-source.html#l00528">DbgkExitProcess()</a>, <a class="el" href="../../d8/d2/dbgkproc_8c-source.html#l00471">DbgkExitThread()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00431">_ETHREAD::DeadThread</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00640">_KTHREAD::EnableStackSwap</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01315">ExChangeHandle()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00374">_ETHREAD::ExitStatus</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00167">_EPROCESS::ExitStatus</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00370">_ETHREAD::ExitTime</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00171">_EPROCESS::ExitTime</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00346">ExTimerRundown()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02242">IoCancelThreadIo()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00639">IS_SYSTEM_THREAD</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00285">_EPROCESS::Job</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00070">KeBugCheck()</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l00574">KeDisableApcQueuingThread()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00138">KeFlushQueueApc()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l00688">KeForceResumeThread()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01302">KeIsAttachedProcess</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00153">KeQuerySystemTime()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00596">_KTHREAD::KernelApcDisable</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01218">KeRundownThread()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01838">KeSetPriorityThread()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00656">KeSetProcess()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01996">KeTerminateThread()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00250">_EPROCESS::LastThreadExitStatus</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00595">_KTHREAD::LegoData</a>, <a class="el" href="../../d4/d5/lpcclose_8c-source.html#l00281">LpcExitThread()</a>, <a class="el" href="../../d7/d6/lpcsend_8c-source.html#l01181">LpcRequestPort()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l01695">MmCleanProcessAddressSpace()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l04843">MmDeleteTeb()</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00748">NtSetEvent()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l01022">ObKillProcess()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d2/ppcdef_8h-source.html#l00079">PASSIVE_LEVEL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00246">_EPROCESS::Peb</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00073">_TERMINATION_PORT::Port</a>, <a class="el" href="../../d2/d1/po_8h-source.html#l00101">PoRundownThread</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00574">_KTHREAD::Priority</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00244">_KAPC_STATE::Process</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00341">PS_GET_THREAD_CREATE_TIME</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d9/ps_8h.html#a155a92">PsLockIAmExiting</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01966">PsLockProcess()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00029">PSP_INVALID_ID</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00206">PSP_MAX_CREATE_THREAD_NOTIFY</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00037">PspCidTable</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00209">PspCreateThreadNotifyRoutine</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00208">PspCreateThreadNotifyRoutineCount</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01232">PspExitProcess()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l00608">PspExitProcessFromJob()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00042">PspLegoNotifyRoutine</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00679">PspMarkCidInvalid()</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00534">PspW32ProcessCallout</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00535">PspW32ThreadCallout</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l02250">PsUnlockProcess()</a>, <a class="el" href="../../d1/d9/ps_8h.html#a157a97">PsW32ThreadCalloutExit</a>, <a class="el" href="../../d8/d1/psp_8h.html#a11">PTERMINATION_PORT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00242">_KAPC::RundownRoutine</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00347">_ETHREAD::Tcb</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00562">_KTHREAD::Teb</a>, <a class="el" href="../../d8/d1/psp_8h.html#a10">TERMINATION_PORT</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00383">_ETHREAD::TerminationPortList</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00638">THREAD_TO_PROCESS</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00453">_ETHREAD::ThreadListEntry</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00307">_EPROCESS::ThreadListHead</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00174">_EPROCESS::UniqueProcessId</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00284">_EPROCESS::Win32Process</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00636">_KTHREAD::Win32Thread</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00140">_WOW64_PROCESS::Wow64</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00295">_EPROCESS::Wow64Process</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00227">NtTerminateProcess()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00603">PsExitSpecialApc()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00631">PspExitNormalApc()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01920">PspSystemThreadStartup()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00160">PspTerminateThreadByPointer()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01800">PspUserThreadStartup()</a>, and <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00546">PsTerminateSystemThread()</a>.
<p>
<pre class="fragment"><div>00696                    :
00697 
00698     This function causes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> currently executing thread to terminate.  This
00699     function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> called from within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process structure.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called
00700     either from mainline <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a> code to <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread, or from
00701     <a class="code" href="../../d8/d0/psdelete_8c.html#a9">PsExitSpecialApc</a> (as a piggyback to user-mode PspExitNormalApc).
00702 
00703 Arguments:
00704 
00705     ExitStatus - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a> status associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread.
00706 
00707 Return Value:
00708 
00709     None.
00710 
00711 --*/
00712 
00713 
00714 {
00715 
00716     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00717     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00718     <a class="code" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc;
00719     PLIST_ENTRY FirstEntry;
00720     PLIST_ENTRY NextEntry;
00721     <a class="code" href="../../d3/d0/struct__TERMINATION__PORT.html">PTERMINATION_PORT</a> TerminationPort;
00722     LPC_CLIENT_DIED_MSG CdMsg;
00723     BOOLEAN LastThread;
00724 
00725     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00726 
00727     Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00728     Process = <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>(Thread);
00729 
00730     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/ke_8h.html#a25">KeIsAttachedProcess</a>() ) {
00731         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(
00732             INVALID_PROCESS_ATTACH_ATTEMPT,
00733             (ULONG_PTR)Process,
00734             (ULONG_PTR)Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>,
00735             (ULONG)Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o58">ApcStateIndex</a>,
00736             (ULONG_PTR)Thread
00737             );
00738         }
00739 
00740     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(PASSIVE_LEVEL);
00741 
00742     <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o13">Priority</a> &lt; LOW_REALTIME_PRIORITY) {
00743         <a class="code" href="../../d9/d1/thredobj_8c.html#a24">KeSetPriorityThread</a> (&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>, LOW_REALTIME_PRIORITY);
00744     }
00745 
00746     <span class="comment">//</span>
00747     <span class="comment">// Clear any execution state associated with the thread</span>
00748     <span class="comment">//</span>
00749 
00750     <a class="code" href="../../d1/d2/po_8h.html#a6">PoRundownThread</a>(Thread);
00751 
00752     <span class="comment">//</span>
00753     <span class="comment">// Account for a miss where we try to freeze a thread and bump the</span>
00754     <span class="comment">// freeze count, but in the freeze APC we bail from the APC due to the</span>
00755     <span class="comment">// pending exit APC. This results in an active thread running with a biased</span>
00756     <span class="comment">// freeze count and no pending APC. When this sort of thread tries to grab the</span>
00757     <span class="comment">// process lock, it ends of spinning since it things a freeze is pending and</span>
00758     <span class="comment">// an APC should occur.</span>
00759     <span class="comment">//</span>
00760     <span class="comment">// Wait mode of UserMode allows the kernel stack to page out if necessary</span>
00761     <span class="comment">//</span>
00762 
00763     <a class="code" href="../../d2/d8/ps_2create_8c.html#a22">PsLockProcess</a>(Process,UserMode,PsLockIAmExiting);
00764     <a class="code" href="../../d9/d1/thredobj_8c.html#a8">KeForceResumeThread</a> (&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>);
00765 
00766     <span class="comment">//</span>
00767     <span class="comment">// Notify registered callout routines of thread deletion.</span>
00768     <span class="comment">//</span>
00769 
00770     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/psp_8h.html#a23">PspCreateThreadNotifyRoutineCount</a> != 0) {
00771         ULONG i;
00772 
00773         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d8/d1/psp_8h.html#a6">PSP_MAX_CREATE_THREAD_NOTIFY</a>; i++) {
00774             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/psp_8h.html#a24">PspCreateThreadNotifyRoutine</a>[i] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00775                 (*<a class="code" href="../../d8/d1/psp_8h.html#a24">PspCreateThreadNotifyRoutine</a>[i])(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a>,
00776                                                    Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueThread,
00777                                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00778                                                    );
00779             }
00780         }
00781     }
00782 
00783     LastThread = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00784 
00785     <span class="keywordflow">if</span> ( (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o87">ThreadListHead</a>.Flink == Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o87">ThreadListHead</a>.Blink)
00786          &amp;&amp; (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o87">ThreadListHead</a>.Flink == &amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o37">ThreadListEntry</a>) ) {
00787         LastThread = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00788         <span class="keywordflow">if</span> ( ExitStatus == STATUS_THREAD_IS_TERMINATING ) {
00789             <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o1">ExitStatus</a> == STATUS_PENDING ) {
00790                 Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o1">ExitStatus</a> = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o50">LastThreadExitStatus</a>;
00791             }
00792         } <span class="keywordflow">else</span> {
00793             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o1">ExitStatus</a> = ExitStatus;
00794         }
00795 
00796         <a class="code" href="../../d4/d3/dbgk_8h.html#a2">DbgkExitProcess</a>(ExitStatus);
00797 
00798     } <span class="keywordflow">else</span> {
00799         <span class="keywordflow">if</span> ( ExitStatus != STATUS_THREAD_IS_TERMINATING ) {
00800             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o50">LastThreadExitStatus</a> = ExitStatus;
00801         }
00802 
00803         <a class="code" href="../../d4/d3/dbgk_8h.html#a1">DbgkExitThread</a>(ExitStatus);
00804     }
00805 
00806     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00807     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o30">KernelApcDisable</a> == 0);
00808 
00809     Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o30">KernelApcDisable</a> = 0;
00810 
00811     <span class="comment">//</span>
00812     <span class="comment">// Process the TerminationPortList</span>
00813     <span class="comment">//</span>
00814     <span class="keywordflow">if</span> ( !IsListEmpty(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o9">TerminationPortList</a>) ) {
00815 
00816         CdMsg.PortMsg.u1.s1.DataLength = <span class="keyword">sizeof</span>(LARGE_INTEGER);
00817         CdMsg.PortMsg.u1.s1.TotalLength = <span class="keyword">sizeof</span>(LPC_CLIENT_DIED_MSG);
00818         CdMsg.PortMsg.u2.s2.Type = LPC_CLIENT_DIED;
00819         CdMsg.PortMsg.u2.s2.DataInfoOffset = 0;
00820 
00821         <span class="keywordflow">while</span> ( !IsListEmpty(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o9">TerminationPortList</a>) ) {
00822 
00823             NextEntry = RemoveHeadList(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o9">TerminationPortList</a>);
00824             TerminationPort = CONTAINING_RECORD(NextEntry,<a class="code" href="../../d3/d0/struct__TERMINATION__PORT.html">TERMINATION_PORT</a>,Links);
00825             CdMsg.CreateTime.QuadPart = <a class="code" href="../../d1/d9/ps_8h.html#a15">PS_GET_THREAD_CREATE_TIME</a>(Thread);
00826             <a class="code" href="../../d6/d7/lpcsend_8c.html#a2">LpcRequestPort</a>(TerminationPort-&gt;<a class="code" href="../../d3/d0/struct__TERMINATION__PORT.html#o1">Port</a>, (PPORT_MESSAGE)&amp;CdMsg);
00827             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(TerminationPort-&gt;<a class="code" href="../../d3/d0/struct__TERMINATION__PORT.html#o1">Port</a>);
00828             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(TerminationPort);
00829         }
00830     } <span class="keywordflow">else</span> {
00831 
00832         <span class="comment">//</span>
00833         <span class="comment">// If there are no ports to send notifications to,</span>
00834         <span class="comment">// but there is an exception port, then we have to</span>
00835         <span class="comment">// send a client died message through the exception</span>
00836         <span class="comment">// port. This will allow a server a chance to get notification</span>
00837         <span class="comment">// if an app/thread dies before it even starts</span>
00838         <span class="comment">//</span>
00839         <span class="comment">//</span>
00840         <span class="comment">// We only send the exception if the thread creation really worked.</span>
00841         <span class="comment">// DeadThread is set when an NtCreateThread returns an error, but</span>
00842         <span class="comment">// the thread will actually execute this path. If DeadThread is not</span>
00843         <span class="comment">// set than the thread creation succeeded. The other place DeadThread</span>
00844         <span class="comment">// is set is when we were terminated without having any chance to move.</span>
00845         <span class="comment">// in this case, DeadThread is set and the exit status is set to</span>
00846         <span class="comment">// STATUS_THREAD_IS_TERMINATING</span>
00847         <span class="comment">//</span>
00848 
00849         <span class="keywordflow">if</span> ( (ExitStatus == STATUS_THREAD_IS_TERMINATING &amp;&amp; Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o24">DeadThread</a>) ||
00850              !Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o24">DeadThread</a> ) {
00851 
00852             CdMsg.PortMsg.u1.s1.DataLength = <span class="keyword">sizeof</span>(LARGE_INTEGER);
00853             CdMsg.PortMsg.u1.s1.TotalLength = <span class="keyword">sizeof</span>(LPC_CLIENT_DIED_MSG);
00854             CdMsg.PortMsg.u2.s2.Type = LPC_CLIENT_DIED;
00855             CdMsg.PortMsg.u2.s2.DataInfoOffset = 0;
00856             <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ExceptionPort ) {
00857                 CdMsg.CreateTime.QuadPart = <a class="code" href="../../d1/d9/ps_8h.html#a15">PS_GET_THREAD_CREATE_TIME</a>(Thread);
00858                 <a class="code" href="../../d6/d7/lpcsend_8c.html#a2">LpcRequestPort</a>(<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ExceptionPort, (PPORT_MESSAGE)&amp;CdMsg);
00859                 }
00860             }
00861     }
00862 
00863     <span class="comment">//</span>
00864     <span class="comment">// rundown the Win32 structures</span>
00865     <span class="comment">//</span>
00866 
00867     <span class="keywordflow">if</span> ( Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o47">Win32Thread</a> ) {
00868         (<a class="code" href="../../d8/d1/psp_8h.html#a40">PspW32ThreadCallout</a>)(Thread,<a class="code" href="../../d1/d9/ps_8h.html#a157a97">PsW32ThreadCalloutExit</a>);
00869         }
00870 
00871     <span class="keywordflow">if</span> ( LastThread &amp;&amp; Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o72">Win32Process</a> ) {
00872         (<a class="code" href="../../d8/d1/psp_8h.html#a39">PspW32ProcessCallout</a>)(Process,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00873         }
00874 
00875     <span class="comment">//</span>
00876     <span class="comment">// User/Gdi has been given a chance to clean up. Now make sure they didn't</span>
00877     <span class="comment">// leave the kernel stack locked which would happen if data was still live on</span>
00878     <span class="comment">// this stack, but was being used by another thread</span>
00879     <span class="comment">//</span>
00880 
00881     <span class="keywordflow">if</span> ( !Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o51">EnableStackSwap</a> ) {
00882         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(KERNEL_STACK_LOCKED_AT_EXIT,0,0,0,0);
00883         }
00884 
00885     <span class="comment">//</span>
00886     <span class="comment">// Delete the thread's TEB.  If the address of the TEB is in user</span>
00887     <span class="comment">// space, then this is a real user mode TEB.  If the address is in</span>
00888     <span class="comment">// system space, then this is a special system thread TEB allocated</span>
00889     <span class="comment">// from paged or nonpaged pool.</span>
00890     <span class="comment">//</span>
00891 
00892 
00893     <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o4">Teb</a>) {
00894         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d9/ps_8h.html#a18">IS_SYSTEM_THREAD</a>(Thread) ) {
00895             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o4">Teb</a> );
00896         } <span class="keywordflow">else</span> {
00897 
00898             <span class="comment">//</span>
00899             <span class="comment">// The thread is a user-mode thread. Look to see if the thread</span>
00900             <span class="comment">// owns the loader lock (and any other key peb-based critical</span>
00901             <span class="comment">// sections. If so, do our best to release the locks.</span>
00902             <span class="comment">//</span>
00903             <span class="comment">// Since the LoaderLock used to be a mutant, releasing the lock</span>
00904             <span class="comment">// like this is very similar to mutant abandonment and the loader</span>
00905             <span class="comment">// never did anything with abandoned status anyway</span>
00906             <span class="comment">//</span>
00907 
00908             <span class="keywordflow">try</span> {
00909                 PTEB Teb;
00910                 PPEB Peb;
00911                 PRTL_CRITICAL_SECTION Cs;
00912                 <span class="keywordtype">int</span> DecrementCount;
00913 
00914                 Teb = Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o4">Teb</a>;
00915                 Peb = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o47">Peb</a>;
00916 
00917                 Cs = Peb-&gt;LoaderLock;
00918                 <span class="keywordflow">if</span> ( Cs ) {
00919                     <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(Cs,<span class="keyword">sizeof</span>(*Cs),4);
00920                     <span class="keywordflow">if</span> ( Cs-&gt;OwningThread == Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueThread ) {
00921 
00922                         <span class="comment">//</span>
00923                         <span class="comment">// x86 uses a 1 based recursion count</span>
00924                         <span class="comment">//</span>
00925 
00926 <span class="preprocessor">#if defined(_X86_)</span>
00927 <span class="preprocessor"></span>                        DecrementCount = Cs-&gt;RecursionCount;
00928 <span class="preprocessor">#else</span>
00929 <span class="preprocessor"></span>                        DecrementCount = Cs-&gt;RecursionCount + 1;
00930 <span class="preprocessor">#endif</span>
00931 <span class="preprocessor"></span>                        Cs-&gt;RecursionCount = 0;
00932                         Cs-&gt;OwningThread = 0;
00933 
00934                         <span class="comment">//</span>
00935                         <span class="comment">// undo lock count increments for recursion cases</span>
00936                         <span class="comment">//</span>
00937 
00938                         <span class="keywordflow">while</span>(DecrementCount &gt; 1){
00939                             InterlockedDecrement(&amp;Cs-&gt;LockCount);
00940                             DecrementCount--;
00941                             }
00942 
00943                         <span class="comment">//</span>
00944                         <span class="comment">// undo final lock count</span>
00945                         <span class="comment">//</span>
00946 
00947                         <span class="keywordflow">if</span> ( InterlockedDecrement(&amp;Cs-&gt;LockCount) &gt;= 0 ){
00948                             <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>(Cs-&gt;LockSemaphore,NULL);
00949                             }
00950                         }
00951 
00952                     <span class="comment">//</span>
00953                     <span class="comment">// if the thread exited while waiting on the loader</span>
00954                     <span class="comment">// lock clean it up. There is still a potential race</span>
00955                     <span class="comment">// here since we can not safely know what happens to</span>
00956                     <span class="comment">// a thread after it interlocked increments the lock count</span>
00957                     <span class="comment">// but before it sets the waiting on loader lock flag. On the</span>
00958                     <span class="comment">// release side, it it safe since we mark ownership of the lock</span>
00959                     <span class="comment">// before clearing the flag. This triggers the first part of this</span>
00960                     <span class="comment">// test. The only thing out of whack is the recursion count, but this</span>
00961                     <span class="comment">// is also safe since in this state, recursion count is 0.</span>
00962                     <span class="comment">//</span>
00963 
00964                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( Teb-&gt;WaitingOnLoaderLock ) {
00965 
00966                         <span class="comment">//</span>
00967                         <span class="comment">// This code isn't right. We need to bump down our lock count</span>
00968                         <span class="comment">// increment.</span>
00969                         <span class="comment">//</span>
00970                         <span class="comment">// A few cases to consider:</span>
00971                         <span class="comment">//</span>
00972                         <span class="comment">// Another thread releases the lock signals the event.</span>
00973                         <span class="comment">// We take the wait and then die before setting our ID.</span>
00974                         <span class="comment">// I doubt very much that this can happen because right</span>
00975                         <span class="comment">// after we come out of the wait, we set the owner Id</span>
00976                         <span class="comment">// (meaning that we would go through the other part of the if).</span>
00977                         <span class="comment">// Bottom line is that we should just decrement our lock count</span>
00978                         <span class="comment">// and get out of the way. There is no need to set the event.</span>
00979                         <span class="comment">// In the RAS stress failure, I saw us setting the event</span>
00980                         <span class="comment">// just because the lock count was &gt;= 0. The lock was already held</span>
00981                         <span class="comment">// by another thread so setting the event let yet another thread</span>
00982                         <span class="comment">// also own the lock. Last one to release would get a</span>
00983                         <span class="comment">// not owner critical section failure</span>
00984                         <span class="comment">//</span>
00985                         <span class="comment">//</span>
00986                         <span class="comment">// if ( InterlockedDecrement(&amp;Cs-&gt;LockCount) &gt;= 0 ){</span>
00987                         <span class="comment">//     NtSetEvent(Cs-&gt;LockSemaphore,NULL);</span>
00988                         <span class="comment">//     }</span>
00989                         <span class="comment">//</span>
00990 
00991                         InterlockedDecrement(&amp;Cs-&gt;LockCount);
00992                         }
00993                     }
00994 <span class="preprocessor">#if defined(_WIN64)</span>
00995 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o78">Wow64Process</a>) {
00996                         <span class="comment">// Do the same thing for the 32-bit PEB-&gt;Ldr</span>
00997                         PRTL_CRITICAL_SECTION32 Cs32;
00998                         PPEB32 Peb32;
00999 
01000                         Peb32 = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o78">Wow64Process</a>-&gt;<a class="code" href="../../d8/d9/struct__WOW64__PROCESS.html#o0">Wow64</a>;
01001                         Cs32 = (PRTL_CRITICAL_SECTION32)ULongToPtr(Peb32-&gt;LoaderLock);
01002                         <span class="keywordflow">if</span> (Cs32) {
01003                             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(Cs32,<span class="keyword">sizeof</span>(*Cs32),4);
01004                             <span class="keywordflow">if</span> ( Cs32-&gt;OwningThread == PtrToUlong(Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueThread) ) {
01005                                 <span class="comment">//</span>
01006                                 <span class="comment">// x86 uses a 1 based recursion count, so the</span>
01007                                 <span class="comment">// IA64 kernel needs to do the same, since</span>
01008                                 <span class="comment">// the critsect is really implemented by IA32</span>
01009                                 <span class="comment">// usermode.</span>
01010                                 <span class="comment">//</span>
01011                                 DecrementCount = Cs32-&gt;RecursionCount;
01012                                 Cs32-&gt;RecursionCount = 0;
01013                                 Cs32-&gt;OwningThread = 0;
01014 
01015                                 <span class="comment">//</span>
01016                                 <span class="comment">// undo lock count increments for recursion cases</span>
01017                                 <span class="comment">//</span>
01018                                 <span class="keywordflow">while</span>(DecrementCount &gt; 1) {
01019                                     InterlockedDecrement(&amp;Cs32-&gt;LockCount);
01020                                     DecrementCount--;
01021                                 }
01022 
01023                                 <span class="comment">//</span>
01024                                 <span class="comment">// undo final lock count</span>
01025                                 <span class="comment">//</span>
01026                                 <span class="keywordflow">if</span> ( InterlockedDecrement(&amp;Cs32-&gt;LockCount) &gt;= 0 ){
01027                                     <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>(LongToHandle(Cs32-&gt;LockSemaphore),NULL);
01028                                 }
01029                             } <span class="keywordflow">else</span> {
01030                                 PTEB32 Teb32 = WOW64_GET_TEB32(Teb);
01031 
01032                                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(Teb32,<span class="keyword">sizeof</span>(*Teb32),4);
01033                                 <span class="keywordflow">if</span> ( Teb32-&gt;WaitingOnLoaderLock ) {
01034                                     InterlockedDecrement(&amp;Cs32-&gt;LockCount);
01035                                 }
01036                             }
01037                         }
01038                     }
01039 <span class="preprocessor">#endif</span>
01040 <span class="preprocessor"></span>                }
01041             except (EXCEPTION_EXECUTE_HANDLER) {
01042                 ;
01043                 }
01044 
01045 <span class="preprocessor">#if defined(_WIN64)</span>
01046 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o78">Wow64Process</a>) {
01047                 <span class="comment">//</span>
01048                 <span class="comment">// Free the 32 bit Teb</span>
01049                 <span class="comment">//</span>
01050                 <span class="keywordflow">try</span> {
01051                     PVOID BaseAddress;
01052                     SIZE_T RegionSize;
01053 
01054                     <span class="comment">// Get the TEB32 pointer</span>
01055                     BaseAddress = *(PVOID *)WOW64_TEB32_POINTER_ADDRESS(((PTEB)Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o4">Teb</a>));
01056 
01057                     <span class="comment">// Free it.  ZwFreeVirtualMemory will probe the address</span>
01058                     <span class="comment">// for us, ensuring that it is in usermode memory.</span>
01059                     RegionSize = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01060                     ZwFreeVirtualMemory( NtCurrentProcess(),
01061                                          &amp;BaseAddress,
01062                                          &amp;RegionSize,
01063                                          MEM_RELEASE
01064                                        );
01065 
01066                     }
01067                 except (EXCEPTION_EXECUTE_HANDLER) {
01068                     ;
01069                     }
01070             }
01071 <span class="preprocessor">#endif</span>
01072 <span class="preprocessor"></span>
01073             <a class="code" href="../../d4/d5/procsup_8c.html#a42">MmDeleteTeb</a>(Process, Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o4">Teb</a>);
01074             Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o4">Teb</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01075         }
01076     }
01077 
01078     <span class="comment">//</span>
01079     <span class="comment">// Rundown The Lists:</span>
01080     <span class="comment">//</span>
01081     <span class="comment">//      - Cancel Io By Thread</span>
01082     <span class="comment">//      - Cancel Timers</span>
01083     <span class="comment">//      - Cancel Registry Notify Requests pending against this thread</span>
01084     <span class="comment">//      - Perform kernel thread rundown</span>
01085     <span class="comment">//</span>
01086 
01087     <a class="code" href="../../d4/d6/iosubs_8c.html#a31">IoCancelThreadIo</a>(Thread);
01088     <a class="code" href="../../d2/d2/timer_8c.html#a10">ExTimerRundown</a>();
01089     <a class="code" href="../../d7/d9/cm_8h.html#a32">CmNotifyRunDown</a>(Thread);
01090     <a class="code" href="../../d9/d1/thredobj_8c.html#a17">KeRundownThread</a>();
01091 
01092     <span class="comment">//</span>
01093     <span class="comment">// delete the Client Id and decrement the reference count for it.</span>
01094     <span class="comment">//</span>
01095 
01096     <span class="keywordflow">if</span> (!(<a class="code" href="../../d5/d8/ex_8h.html#a298">ExChangeHandle</a>(PspCidTable, Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueThread, PspMarkCidInvalid, PSP_INVALID_ID))) {
01097         <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(CID_HANDLE_DELETION);
01098     }
01099     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
01100 
01101     <span class="comment">//</span>
01102     <span class="comment">// Let LPC component deal with message stack in Thread-&gt;LpcReplyMessage</span>
01103     <span class="comment">// but do it after the client ID becomes invalid.</span>
01104     <span class="comment">//</span>
01105 
01106     <a class="code" href="../../d3/d6/lpcclose_8c.html#a2">LpcExitThread</a>(Thread);
01107 
01108     <span class="comment">//</span>
01109     <span class="comment">// If this is the last thread in the process, then clean the address space</span>
01110     <span class="comment">//</span>
01111 
01112     <span class="keywordflow">if</span> ( LastThread ) {
01113         <span class="keywordflow">if</span> (!(<a class="code" href="../../d5/d8/ex_8h.html#a298">ExChangeHandle</a>(PspCidTable,Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a>, PspMarkCidInvalid, PSP_INVALID_ID))) {
01114             <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(CID_HANDLE_DELETION);
01115         }
01116         <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o5">ExitTime</a>);
01117         <a class="code" href="../../d8/d1/psp_8h.html#a71">PspExitProcess</a>(TRUE,Process);
01118     }
01119 
01120 
01121     Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o6">ExitStatus</a> = ExitStatus;
01122     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o4">ExitTime</a>);
01123 
01124 
01125     RemoveEntryList(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o37">ThreadListEntry</a>);
01126     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01127 
01128     Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o37">ThreadListEntry</a>.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01129     Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o37">ThreadListEntry</a>.Blink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01130 
01131     <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
01132     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o30">KernelApcDisable</a> == 0);
01133 
01134     <span class="keywordflow">if</span> ( LastThread ) {
01135 
01136         <span class="comment">//</span>
01137         <span class="comment">// can not hold the process lock while running down the object table</span>
01138         <span class="comment">// since this can lead to a delete routine, which will need the job</span>
01139         <span class="comment">// lock, BUT our lock ordering is always joblock -&gt; processlock</span>
01140         <span class="comment">//</span>
01141 
01142         <a class="code" href="../../d0/d1/obinit_8c.html#a23">ObKillProcess</a>(TRUE, Process);
01143 
01144         <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>) {
01145 
01146             <span class="comment">//</span>
01147             <span class="comment">// Now we can fold the process accounting into the job. Don't need to wait for</span>
01148             <span class="comment">// the delete routine.</span>
01149             <span class="comment">//</span>
01150 
01151             <a class="code" href="../../d8/d1/psp_8h.html#a93">PspExitProcessFromJob</a>(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>,Process);
01152 
01153             }
01154 
01155         <a class="code" href="../../d3/d5/procobj_8c.html#a10">KeSetProcess</a>(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>,0,FALSE);
01156 
01157         }
01158 
01159     <span class="comment">//</span>
01160     <span class="comment">// Rundown pending APCs</span>
01161     <span class="comment">//</span>
01162 
01163     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d9/d1/thredobj_8c.html#a6">KeDisableApcQueuingThread</a>(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>);
01164 
01165     <span class="comment">//</span>
01166     <span class="comment">// flush user-mode APC queue</span>
01167     <span class="comment">//</span>
01168 
01169     FirstEntry = <a class="code" href="../../d5/d7/apcobj_8c.html#a2">KeFlushQueueApc</a>(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>,UserMode);
01170 
01171     <span class="keywordflow">if</span> ( FirstEntry ) {
01172 
01173         NextEntry = FirstEntry;
01174         <span class="keywordflow">do</span> {
01175             Apc = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d1/d5/struct__KAPC.html">KAPC</a>, ApcListEntry);
01176             NextEntry = NextEntry-&gt;Flink;
01177 
01178             <span class="comment">//</span>
01179             <span class="comment">// If the APC has a rundown routine then call it. Otherwise</span>
01180             <span class="comment">// deallocate the APC</span>
01181             <span class="comment">//</span>
01182 
01183             <span class="keywordflow">if</span> ( Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o6">RundownRoutine</a> ) {
01184                 (Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o6">RundownRoutine</a>)(Apc);
01185             } <span class="keywordflow">else</span> {
01186                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Apc);
01187             }
01188 
01189         } <span class="keywordflow">while</span> (NextEntry != FirstEntry);
01190     }
01191 
01192     <span class="keywordflow">if</span> ( LastThread ) {
01193         <a class="code" href="../../d4/d5/procsup_8c.html#a32">MmCleanProcessAddressSpace</a>();
01194     }
01195 
01196     <span class="keywordflow">if</span> ( Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o29">LegoData</a> &amp;&amp; <a class="code" href="../../d8/d0/psdelete_8c.html#a0">PspLegoNotifyRoutine</a> ) {
01197         (<a class="code" href="../../d8/d0/psdelete_8c.html#a0">PspLegoNotifyRoutine</a>)(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>);
01198         }
01199 
01200     <span class="comment">//</span>
01201     <span class="comment">// flush kernel-mode APC queue</span>
01202     <span class="comment">// There should never be any kernel mode APCs found this far</span>
01203     <span class="comment">// into thread termination. Since we go to PASSIVE_LEVEL upon</span>
01204     <span class="comment">// entering exit.</span>
01205     <span class="comment">//</span>
01206 
01207     FirstEntry = <a class="code" href="../../d5/d7/apcobj_8c.html#a2">KeFlushQueueApc</a>(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>,KernelMode);
01208 
01209     <span class="keywordflow">if</span> ( FirstEntry ) {
01210         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(
01211             KERNEL_APC_PENDING_DURING_EXIT,
01212             (ULONG_PTR)FirstEntry,
01213             (ULONG_PTR)Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o30">KernelApcDisable</a>,
01214             (ULONG_PTR)KeGetCurrentIrql(),
01215             0
01216             );
01217     }
01218 
01219     <span class="comment">//</span>
01220     <span class="comment">// Terminate the thread.</span>
01221     <span class="comment">//</span>
01222     <span class="comment">// N.B. There is no return from this call.</span>
01223     <span class="comment">//</span>
01224     <span class="comment">// N.B. The kernel inserts the current thread in the reaper list and</span>
01225     <span class="comment">//      activates a thread, if necessary, to reap the terminating thread.</span>
01226     <span class="comment">//</span>
01227 
01228     <a class="code" href="../../d9/d1/thredobj_8c.html#a26">KeTerminateThread</a>(0L);
01229 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a98" doxytag="psp.h::PspFoldProcessAccountingIntoJob" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspFoldProcessAccountingIntoJob           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d3/struct__EJOB.html">PEJOB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Job</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d0/psjob_8c-source.html#l02632">2632</a> of file <a class="el" href="../../d2/d0/psjob_8c-source.html">psjob.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00503">_EJOB::ActiveProcesses</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00305">_EPROCESS::CommitChargePeak</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00539">_EJOB::CompletionKey</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00538">_EJOB::CompletionPort</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d3/complete_8c-source.html#l00671">IoSetIoCompletion()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00286">_EPROCESS::JobStatus</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02774">KeMaximumIncrement</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00755">_KPROCESS::KernelTime</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00299">_EPROCESS::OtherOperationCount</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00547">_EJOB::OtherOperationCount</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00302">_EPROCESS::OtherTransferCount</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00550">_EJOB::OtherTransferCount</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00059">_MMSUPPORT::PageFaultCount</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00559">_EJOB::PeakProcessMemoryUsed</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00315">PS_JOB_STATUS_ACCOUNTING_FOLDED</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00319">PS_JOB_STATUS_LAST_REPORT_MEMORY</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00154">PS_SET_CLEAR_BITS</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00297">_EPROCESS::ReadOperationCount</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00545">_EJOB::ReadOperationCount</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00300">_EPROCESS::ReadTransferCount</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00548">_EJOB::ReadTransferCount</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00500">_EJOB::ThisPeriodTotalKernelTime</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00499">_EJOB::ThisPeriodTotalUserTime</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00498">_EJOB::TotalKernelTime</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00501">_EJOB::TotalPageFaultCount</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00497">_EJOB::TotalUserTime</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00756">_KPROCESS::UserTime</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00196">_EPROCESS::Vm</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00298">_EPROCESS::WriteOperationCount</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00546">_EJOB::WriteOperationCount</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00301">_EPROCESS::WriteTransferCount</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00549">_EJOB::WriteTransferCount</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/psjob_8c-source.html#l01323">NtSetInformationJobObject()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l02396">PsEnforceExecutionTimeLimits()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l00608">PspExitProcessFromJob()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l00579">PspRemoveProcessFromJob()</a>, and <a class="el" href="../../d2/d0/psjob_8c-source.html#l02570">PspTerminateAllProcessesInJob()</a>.
<p>
<pre class="fragment"><div>02636 {
02637     LARGE_INTEGER UserTime, KernelTime;
02638 
02639     <span class="keywordflow">if</span> ( !(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a10">PS_JOB_STATUS_ACCOUNTING_FOLDED</a>) ) {
02640         UserTime.QuadPart = UInt32x32To64(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o5">UserTime</a>,KeMaximumIncrement);
02641         KernelTime.QuadPart = UInt32x32To64(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o4">KernelTime</a>,KeMaximumIncrement);
02642 
02643         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o4">TotalUserTime</a>.QuadPart += UserTime.QuadPart;
02644         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o5">TotalKernelTime</a>.QuadPart += KernelTime.QuadPart;
02645         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o6">ThisPeriodTotalUserTime</a>.QuadPart += UserTime.QuadPart;
02646         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o7">ThisPeriodTotalKernelTime</a>.QuadPart += KernelTime.QuadPart;
02647 
02648         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o29">ReadOperationCount</a> += Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o79">ReadOperationCount</a>.QuadPart;
02649         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o30">WriteOperationCount</a> += Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o80">WriteOperationCount</a>.QuadPart;
02650         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o31">OtherOperationCount</a> += Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o81">OtherOperationCount</a>.QuadPart;
02651         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o32">ReadTransferCount</a> += Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o82">ReadTransferCount</a>.QuadPart;
02652         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o33">WriteTransferCount</a> += Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o83">WriteTransferCount</a>.QuadPart;
02653         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o34">OtherTransferCount</a> += Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o84">OtherTransferCount</a>.QuadPart;
02654 
02655         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o8">TotalPageFaultCount</a> += Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a>;
02656 
02657 
02658         <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o86">CommitChargePeak</a> &gt; Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o38">PeakProcessMemoryUsed</a> ) {
02659             Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o38">PeakProcessMemoryUsed</a> = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o86">CommitChargePeak</a>;
02660             }
02661 
02662         <a class="code" href="../../d1/d9/ps_8h.html#a8">PS_SET_CLEAR_BITS</a> (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a>,
02663                            PS_JOB_STATUS_ACCOUNTING_FOLDED,
02664                            PS_JOB_STATUS_LAST_REPORT_MEMORY);
02665 
02666         <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a> &amp;&amp; Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o10">ActiveProcesses</a> == 0) {
02667             <a class="code" href="../../d5/d4/complete_8c.html#a6">IoSetIoCompletion</a>(
02668                 Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a>,
02669                 Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o26">CompletionKey</a>,
02670                 NULL,
02671                 STATUS_SUCCESS,
02672                 JOB_OBJECT_MSG_ACTIVE_PROCESS_ZERO,
02673                 FALSE
02674                 );
02675             }
02676         }
02677 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a73" doxytag="psp.h::PspGetContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspGetContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKNONVOLATILE_CONTEXT_POINTERS&nbsp;</td>
          <td class="mdname" nowrap> <em>NonVolatileContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/psctxalp_8c-source.html#l00029">29</a> of file <a class="el" href="../../d5/d9/psctxalp_8c-source.html">psctxalp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00240">CONTEXT_CONTROL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00241">CONTEXT_FLOATING_POINT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00242">CONTEXT_INTEGER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, and <a class="el" href="../../d3/d8/ppc_2exceptn_8c-source.html#l00078">KiBreakPoints</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/psctxppc_8c-source.html#l00386">PspGetSetContextApc()</a>, <a class="el" href="../../d4/d9/psctx386_8c-source.html#l00131">PspGetSetContextSpecialApc()</a>, and <a class="el" href="../../d5/d9/psctxalp_8c-source.html#l00349">PspGetSetContextSpecialApcMain()</a>.
<p>
<pre class="fragment"><div>00037                    :
00038 
00039     This function selectively moves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> contents of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified trap frame
00040     and nonvolatile context to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified context record.
00041 
00042 Arguments:
00043 
00044     TrapFrame - Supplies a pointer to a trap frame.
00045 
00046     ContextPointers - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of context pointers record.
00047 
00048     ContextRecord - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a context record.
00049 
00050 Return Value:
00051 
00052     None.
00053 
00054 --*/
00055 
00056 {
00057 
00058     <span class="comment">//</span>
00059     <span class="comment">// Get control information if specified.</span>
00060     <span class="comment">//</span>
00061 
00062     <span class="keywordflow">if</span> ((ContextRecord-&gt;ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) {
00063 
00064         <span class="comment">//</span>
00065         <span class="comment">// Get integer registers gp, ra, sp, FIR, and PSR from trap frame.</span>
00066         <span class="comment">//</span>
00067 
00068         ContextRecord-&gt;IntGp = TrapFrame-&gt;IntGp;
00069         ContextRecord-&gt;IntSp = TrapFrame-&gt;IntSp;
00070         ContextRecord-&gt;IntRa = TrapFrame-&gt;IntRa;
00071         ContextRecord-&gt;Fir = TrapFrame-&gt;Fir;
00072         ContextRecord-&gt;Psr = TrapFrame-&gt;Psr;
00073     }
00074 
00075     <span class="comment">//</span>
00076     <span class="comment">// Get integer register contents if specified.</span>
00077     <span class="comment">//</span>
00078 
00079     <span class="keywordflow">if</span> ((ContextRecord-&gt;ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) {
00080 
00081         <span class="comment">//</span>
00082         <span class="comment">// Get volatile integer registers v0 and t0 - t7 from trap frame.</span>
00083         <span class="comment">//</span>
00084 
00085         ContextRecord-&gt;IntV0 = TrapFrame-&gt;IntV0;
00086         ContextRecord-&gt;IntT0 = TrapFrame-&gt;IntT0;
00087         ContextRecord-&gt;IntT1 = TrapFrame-&gt;IntT1;
00088         ContextRecord-&gt;IntT2 = TrapFrame-&gt;IntT2;
00089         ContextRecord-&gt;IntT3 = TrapFrame-&gt;IntT3;
00090         ContextRecord-&gt;IntT4 = TrapFrame-&gt;IntT4;
00091         ContextRecord-&gt;IntT5 = TrapFrame-&gt;IntT5;
00092         ContextRecord-&gt;IntT6 = TrapFrame-&gt;IntT6;
00093         ContextRecord-&gt;IntT7 = TrapFrame-&gt;IntT7;
00094 
00095         <span class="comment">//</span>
00096         <span class="comment">// Get nonvolatile integer registers s0 - s5 through context pointers.</span>
00097         <span class="comment">//</span>
00098 
00099         ContextRecord-&gt;IntS0 = *ContextPointers-&gt;IntS0;
00100         ContextRecord-&gt;IntS1 = *ContextPointers-&gt;IntS1;
00101         ContextRecord-&gt;IntS2 = *ContextPointers-&gt;IntS2;
00102         ContextRecord-&gt;IntS3 = *ContextPointers-&gt;IntS3;
00103         ContextRecord-&gt;IntS4 = *ContextPointers-&gt;IntS4;
00104         ContextRecord-&gt;IntS5 = *ContextPointers-&gt;IntS5;
00105 
00106         <span class="comment">//</span>
00107         <span class="comment">// Get volatile integer registers fp/s6, a0 - a5, and t8 - t12 from</span>
00108         <span class="comment">// trap frame.</span>
00109         <span class="comment">//</span>
00110 
00111         ContextRecord-&gt;IntFp = TrapFrame-&gt;IntFp;
00112 
00113         ContextRecord-&gt;IntA0 = TrapFrame-&gt;IntA0;
00114         ContextRecord-&gt;IntA1 = TrapFrame-&gt;IntA1;
00115         ContextRecord-&gt;IntA2 = TrapFrame-&gt;IntA2;
00116         ContextRecord-&gt;IntA3 = TrapFrame-&gt;IntA3;
00117         ContextRecord-&gt;IntA4 = TrapFrame-&gt;IntA4;
00118         ContextRecord-&gt;IntA5 = TrapFrame-&gt;IntA5;
00119 
00120         ContextRecord-&gt;IntT8 = TrapFrame-&gt;IntT8;
00121         ContextRecord-&gt;IntT9 = TrapFrame-&gt;IntT9;
00122         ContextRecord-&gt;IntT10 = TrapFrame-&gt;IntT10;
00123         ContextRecord-&gt;IntT11 = TrapFrame-&gt;IntT11;
00124         ContextRecord-&gt;IntT12 = TrapFrame-&gt;IntT12;
00125 
00126         <span class="comment">//</span>
00127         <span class="comment">// Get volatile integer register AT from trap frame.</span>
00128         <span class="comment">// Get integer register zero.</span>
00129         <span class="comment">//</span>
00130 
00131         ContextRecord-&gt;IntAt = TrapFrame-&gt;IntAt;
00132         ContextRecord-&gt;IntZero = 0;
00133     }
00134 
00135     <span class="comment">//</span>
00136     <span class="comment">// Get floating register contents if specified.</span>
00137     <span class="comment">//</span>
00138 
00139     <span class="keywordflow">if</span> ((ContextRecord-&gt;ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a154">CONTEXT_FLOATING_POINT</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a154">CONTEXT_FLOATING_POINT</a>) {
00140 
00141         <span class="comment">//</span>
00142         <span class="comment">// Get volatile floating registers f0 - f1 from trap frame.</span>
00143         <span class="comment">//</span>
00144 
00145         ContextRecord-&gt;FltF0 = TrapFrame-&gt;FltF0;
00146         ContextRecord-&gt;FltF1 = TrapFrame-&gt;FltF1;
00147 
00148         <span class="comment">//</span>
00149         <span class="comment">// Get volatile floating registers f10 - f30 from trap frame.</span>
00150         <span class="comment">// This assumes that f10 - f30 are contiguous in the trap frame.</span>
00151         <span class="comment">//</span>
00152 
00153         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((&amp;ContextRecord-&gt;FltF30 - &amp;ContextRecord-&gt;FltF10) == 20);
00154         RtlMoveMemory(&amp;ContextRecord-&gt;FltF10, &amp;TrapFrame-&gt;FltF10,
00155                       <span class="keyword">sizeof</span>(ULONGLONG) * 21);
00156 
00157         ContextRecord-&gt;FltF31 = 0;
00158 
00159         <span class="comment">//</span>
00160         <span class="comment">// Get nonvolatile floating registers f2 - f9 through context pointers.</span>
00161         <span class="comment">//</span>
00162 
00163         ContextRecord-&gt;FltF2 = *ContextPointers-&gt;FltF2;
00164         ContextRecord-&gt;FltF3 = *ContextPointers-&gt;FltF3;
00165         ContextRecord-&gt;FltF4 = *ContextPointers-&gt;FltF4;
00166         ContextRecord-&gt;FltF5 = *ContextPointers-&gt;FltF5;
00167         ContextRecord-&gt;FltF6 = *ContextPointers-&gt;FltF6;
00168         ContextRecord-&gt;FltF7 = *ContextPointers-&gt;FltF7;
00169         ContextRecord-&gt;FltF8 = *ContextPointers-&gt;FltF8;
00170         ContextRecord-&gt;FltF9 = *ContextPointers-&gt;FltF9;
00171 
00172         <span class="comment">//</span>
00173         <span class="comment">// Get floating point control register from trap frame.</span>
00174         <span class="comment">// Get the current software FPCR value from the TEB.</span>
00175         <span class="comment">//</span>
00176 
00177         ContextRecord-&gt;Fpcr = TrapFrame-&gt;Fpcr;
00178         <span class="keywordflow">try</span> {
00179             ContextRecord-&gt;SoftFpcr =
00180                 (ULONGLONG)(NtCurrentTeb()-&gt;FpSoftwareStatusRegister);
00181 
00182         } except (EXCEPTION_EXECUTE_HANDLER) {
00183             ContextRecord-&gt;SoftFpcr = 0;
00184         }
00185     }
00186 
00187     <span class="keywordflow">return</span>;
00188 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a74" doxytag="psp.h::PspGetSetContextSpecialApc" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspGetSetContextSpecialApc           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Apc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d9/psctx_8c-source.html#l00151">NtGetContextThread()</a>, and <a class="el" href="../../d3/d9/psctx_8c-source.html#l00352">NtSetContextThread()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a52" doxytag="psp.h::PspInheritQuota" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspInheritQuota           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NewProcess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ParentProcess</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/psquota_8c-source.html#l00466">466</a> of file <a class="el" href="../../d1/d1/psquota_8c-source.html">psquota.c</a>.
<p>
References <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00046">PspDefaultQuotaBlock</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00107">_EPROCESS_QUOTA_BLOCK::QuotaLock</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00108">_EPROCESS_QUOTA_BLOCK::ReferenceCount</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>.
<p>
<pre class="fragment"><div>00470 {
00471     <a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html">PEPROCESS_QUOTA_BLOCK</a> QuotaBlock;
00472     KIRQL OldIrql;
00473 
00474     <span class="keywordflow">if</span> ( ParentProcess ) {
00475         QuotaBlock = ParentProcess-&gt;QuotaBlock;
00476         }
00477     <span class="keywordflow">else</span> {
00478         QuotaBlock = &amp;<a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>;
00479         }
00480 
00481     ExAcquireSpinLock(&amp;QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>,&amp;OldIrql);
00482     QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o1">ReferenceCount</a>++;
00483     NewProcess-&gt;QuotaBlock = QuotaBlock;
00484     ExReleaseSpinLock(&amp;QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>,OldIrql);
00485 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a76" doxytag="psp.h::PspInitializeProcessSecurity" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PspInitializeProcessSecurity           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Parent&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Child</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01117">1117</a> of file <a class="el" href="../../d7/d4/ps_2security_8c-source.html">ps/security.c</a>.
<p>
References <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00106">PspBootAccessToken</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l00241">SeAssignPrimaryToken()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l01327">SeSubProcessToken()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>.
<p>
<pre class="fragment"><div>01124                    :
01125 
01126     This function initializes a <span class="keyword">new</span> process's security fields, including
01127     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> assignment of a <span class="keyword">new</span> primary token.
01128 
01129     The child process <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed to not yet have been inserted into
01130     an object table.
01131 
01132     NOTE: IT IS EXPECTED THAT THIS SERVICE WILL BE CALLED WITH <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01133           PARENT PROCESS POINTER EXACTLY ONCE - FOR THE INITIAL SYSTEM
01134           PROCESS.
01135 
01136 
01137 Arguments:
01138 
01139     Parent - An optional pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process being used as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent
01140         of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> process.  If <span class="keyword">this</span> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01141         assumed to be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial system process, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> boot token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01142         assigned rather than a duplicate of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent process's primary
01143         token.
01144 
01145     Child - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process being initialized.  This
01146         process does not yet require security field contention protection.
01147         In particular, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security fields may be accessed without first
01148         acquiring <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process security fields lock.
01149 
01150 
01151 
01152 Return Value:
01153 
01154 
01155 --*/
01156 
01157 {
01158     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
01159         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01160 
01161 
01162     <span class="comment">//</span>
01163     <span class="comment">// Assign the primary token</span>
01164     <span class="comment">//</span>
01165 
01166     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Parent)) {
01167 
01168         <span class="comment">//</span>
01169         <span class="comment">// create the primary token</span>
01170         <span class="comment">// This is a duplicate of the parent's token.</span>
01171         <span class="comment">//</span>
01172 
01173         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d3/token_8c.html#a13">SeSubProcessToken</a>(
01174                      Parent,
01175                      &amp;Child-&gt;Token
01176                      );
01177 
01178         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01179             Child-&gt;Token = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;       <span class="comment">// Needed to ensure proper deletion</span>
01180         }
01181 
01182     } <span class="keywordflow">else</span> {
01183 
01184         <span class="comment">//</span>
01185         <span class="comment">//  Reference and assign the boot token</span>
01186         <span class="comment">//</span>
01187         <span class="comment">//  The use of a single boot access token assumes there is</span>
01188         <span class="comment">//  exactly one parentless process in the system - the initial</span>
01189         <span class="comment">//  process.  If this ever changes, this code will need to change</span>
01190         <span class="comment">//  to match the new condition (so that a token doesn't end up</span>
01191         <span class="comment">//  being shared by multiple processes.</span>
01192         <span class="comment">//</span>
01193 
01194         Child-&gt;Token = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01195         <a class="code" href="../../d4/d3/token_8c.html#a7">SeAssignPrimaryToken</a>( Child, PspBootAccessToken );
01196         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01197 
01198 
01199     }
01200 
01201     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01202 
01203 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a57" doxytag="psp.h::PspInitializeSystemDll" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PspInitializeSystemDll           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/psinit_8c-source.html#l00745">745</a> of file <a class="el" href="../../d1/d0/psinit_8c-source.html">psinit.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d5/4_2kdinit_8c-source.html#l00038">KdUpdateDataBlock()</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d7/d8/kernlini_8c-source.html#l02008">KeSetup80387OrEmulate()</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00087">_SYSTEM_DLL::LoaderInitRoutine</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d9/d9/kulokup2_8c-source.html#l00025">PspLookupKernelUserEntryPoints()</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00827">PspLookupSystemDllEntryPoint()</a>, and <a class="el" href="../../d1/d0/psinit_8c-source.html#l00124">PspSystemDll</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/psinit_8c-source.html#l00487">PspInitPhase1()</a>.
<p>
<pre class="fragment"><div>00751                    :
00752 
00753     This function initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system DLL and locates
00754     various <a class="code" href="../../d7/d1/genuedef_8c.html#a4">entrypoints</a> within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL.
00755 
00756 Arguments:
00757 
00758     None.
00759 
00760 Return Value:
00761 
00762     TBD
00763 
00764 --*/
00765 
00766 {
00767     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00768     PSZ dll_entrypoint;
00769     PVOID R3EmulatorTable;
00770 
00771     <span class="comment">//</span>
00772     <span class="comment">// Locate the important system dll entrypoints</span>
00773     <span class="comment">//</span>
00774 
00775     dll_entrypoint = <span class="stringliteral">"LdrInitializeThunk"</span>;
00776 
00777     st = <a class="code" href="../../d8/d1/psp_8h.html#a58">PspLookupSystemDllEntryPoint</a>(
00778             dll_entrypoint,
00779             (PVOID *)&amp;<a class="code" href="../../d0/d1/psinit_8c.html#a30">PspSystemDll</a>.<a class="code" href="../../d0/d8/struct__SYSTEM__DLL.html#o2">LoaderInitRoutine</a>
00780             );
00781 
00782     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00783 <span class="preprocessor">#if DBG</span>
00784 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"PS: Unable to locate LdrInitializeThunk in system dll\n"</span>);
00785 <span class="preprocessor">#endif</span>
00786 <span class="preprocessor"></span>        <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(PROCESS1_INITIALIZATION_FAILED,st,6,0,0);
00787         <span class="keywordflow">return</span> st;
00788     }
00789 
00790 <span class="preprocessor">#if i386</span>
00791 <span class="preprocessor"></span>    <span class="comment">//</span>
00792     <span class="comment">// Find 80387 emulator.</span>
00793     <span class="comment">//</span>
00794 
00795     st = <a class="code" href="../../d8/d1/psp_8h.html#a58">PspLookupSystemDllEntryPoint</a>(
00796             <span class="stringliteral">"NPXEMULATORTABLE"</span>,
00797             &amp;R3EmulatorTable
00798             );
00799 
00800     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00801 <span class="preprocessor">#if DBG</span>
00802 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"PS: Unable to locate NPXNPHandler in system dll\n"</span>);
00803 <span class="preprocessor">#endif</span>
00804 <span class="preprocessor"></span>        <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(PROCESS1_INITIALIZATION_FAILED,st,7,0,0);
00805         <span class="keywordflow">return</span> st;
00806     }
00807     <span class="comment">//</span>
00808     <span class="comment">// Pass emulator into kernel, and let it decide whether it should</span>
00809     <span class="comment">// use the emulator or set up to use the 80387 hardware.</span>
00810     <span class="comment">//</span>
00811 
00812     <a class="code" href="../../d6/d9/kernlini_8c.html#a40">KeSetup80387OrEmulate</a>(R3EmulatorTable);
00813 <span class="preprocessor">#endif //i386</span>
00814 <span class="preprocessor"></span>
00815     st = <a class="code" href="../../d8/d1/psp_8h.html#a59">PspLookupKernelUserEntryPoints</a>();
00816 
00817     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00818         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(PROCESS1_INITIALIZATION_FAILED,st,8,0,0);
00819         }
00820 
00821     <a class="code" href="../../d5/d6/4_2kdinit_8c.html#a2">KdUpdateDataBlock</a>();
00822 
00823     <span class="keywordflow">return</span> st;
00824 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a78" doxytag="psp.h::PspInitializeThreadSecurity" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspInitializeThreadSecurity           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01395">1395</a> of file <a class="el" href="../../d7/d4/ps_2security_8c-source.html">ps/security.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00262">PspCreateThread()</a>.
<p>
<pre class="fragment"><div>01402                    :
01403 
01404     This function initializes a <span class="keyword">new</span> thread's security fields.
01405 
01406 
01407 Arguments:
01408 
01409     Process - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread belongs to.
01410 
01411     Thread - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread object being initialized.
01412 
01413 
01414 Return Value:
01415 
01416     None.
01417 
01418 --*/
01419 
01420 {
01421 
01422 
01423     <span class="comment">//</span>
01424     <span class="comment">// Initially not impersonating anyone.</span>
01425     <span class="comment">//</span>
01426 
01427     Thread-&gt;ImpersonationInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01428     Thread-&gt;ActiveImpersonationInfo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01429 
01430     <span class="keywordflow">return</span>;
01431 
01432 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a55" doxytag="psp.h::PspInitPhase0" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN PspInitPhase0           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LoaderBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/psinit_8c-source.html#l00181">181</a> of file <a class="el" href="../../d1/d0/psinit_8c-source.html">psinit.c</a>.
<p>
References <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00457">ExCreateHandleTable()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00367">ExInitializeFastMutex</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01961">ExInitializeWorkItem</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00501">ExRemoveHandleTable()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00273">_EPROCESS::ImageFileName</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00755">_KPROCESS::KernelTime</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00091">_JOB_WORKING_SET_CHANGE_HEAD::Links</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00092">_JOB_WORKING_SET_CHANGE_HEAD::Lock</a>, <a class="el" href="../../d2/d1/mm_8h.html#a140">MM_SYSTEMSIZE</a>, <a class="el" href="../../d2/d1/mm_8h.html#a343a167">MmLargeSystem</a>, <a class="el" href="../../d2/d1/mm_8h.html#a343a166">MmMediumSystem</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l03073">MmQuerySystemSize()</a>, <a class="el" href="../../d2/d1/mm_8h.html#a343a165">MmSmallSystem</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d1/obtype_8c-source.html#l00069">ObCreateObjectType()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d8/d1/init_8h.html#a23">Phase1Initialization()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00575">PsActiveProcessHead</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00878">PsChangeQuantumTable()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00175">PsCreateSystemThread()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00588">PsIdleProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00579">PsInitialSystemProcess</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00090">PsJobType</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00056">PsMaximumWorkingSet</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00097">PsMinimumWorkingSet</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00126">PSP_1MB</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00056">PSP_PROCESS_NONPAGED_CHARGE</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00055">PSP_PROCESS_PAGED_CHARGE</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00069">PSP_THREAD_NONPAGED_CHARGE</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00068">PSP_THREAD_PAGED_CHARGE</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l03058">PspActiveProcessMutex</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00106">PspBootAccessToken</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00037">PspCidTable</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00098">PspDefaultNonPagedLimit</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00097">PspDefaultPagedLimit</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00099">PspDefaultPagefileLimit</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00116">PspDoingGiveBacks</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00086">PspInitialSystemProcessHandle</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l00709">PspJobClose()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l00636">PspJobDelete()</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00119">PspJobList</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00118">PspJobListLock</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00074">PspJobMapping</a>, <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00084">PspLdtInitialize()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01363">PspProcessDelete()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00064">PspProcessLockMutex</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00050">PspProcessMapping</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00057">PspReaper()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00578">PsProcessSecurityLock</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00088">PsProcessType</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01438">PspThreadDelete()</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00063">PspThreadMapping</a>, <a class="el" href="../../d4/d1/i386_2psvdm_8c-source.html#l00987">PspVdmInitialize()</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00102">PspWorkingSetChangeHead</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00574">PsRawPrioritySeparation</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00590">PsReaperListHead</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00591">PsReaperWorkItem</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00089">PsThreadType</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00138">ThreadHandle</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/psinit_8c-source.html#l00138">PsInitSystem()</a>.
<p>
<pre class="fragment"><div>00187                    :
00188 
00189     This routine performs phase 0 process structure initialization.
00190     During <span class="keyword">this</span> phase, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial system process, phase 1 initialization
00191     thread, and reaper threads are created. All object types and other
00192     process structures are created and initialized.
00193 
00194 Arguments:
00195 
00196     None.
00197 
00198 Return Value:
00199 
00200     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - Initialization was successful.
00201 
00202     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - Initialization Failed.
00203 
00204 --*/
00205 
00206 {
00207 
00208     UNICODE_STRING NameString;
00209     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00210     <a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html">OBJECT_TYPE_INITIALIZER</a> ObjectTypeInitializer;
00211     HANDLE <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>;
00212     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00213     <a class="code" href="../../d2/d1/mm_8h.html#a140">MM_SYSTEMSIZE</a> SystemSize;
00214 
00215     SystemSize = <a class="code" href="../../d5/d1/mminit_8c.html#a57">MmQuerySystemSize</a>();
00216     <a class="code" href="../../d8/d0/cmdat3_8c.html#a43">PspDefaultPagefileLimit</a> = (ULONG)-1;
00217 
00218 <span class="preprocessor">#ifdef _WIN64</span>
00219 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>(TEB) &gt; 8192 || <span class="keyword">sizeof</span>(PEB) &gt; 4096 ) {
00220 <span class="preprocessor">#else</span>
00221 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>(TEB) &gt; 4096 || <span class="keyword">sizeof</span>(PEB) &gt; 4096 ) {
00222 <span class="preprocessor">#endif</span>
00223 <span class="preprocessor"></span>        <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(PROCESS_INITIALIZATION_FAILED,99,<span class="keyword">sizeof</span>(TEB),<span class="keyword">sizeof</span>(PEB),99);
00224         }
00225 
00226     <span class="keywordflow">switch</span> ( SystemSize ) {
00227 
00228         <span class="keywordflow">case</span> <a class="code" href="../../d2/d1/mm_8h.html#a343a166">MmMediumSystem</a> :
00229             <a class="code" href="../../d5/d0/wsmanage_8c.html#a5">PsMinimumWorkingSet</a> += 10;
00230             <a class="code" href="../../d2/d8/ps_2create_8c.html#a7">PsMaximumWorkingSet</a> += 100;
00231             <span class="keywordflow">break</span>;
00232 
00233         <span class="keywordflow">case</span> <a class="code" href="../../d2/d1/mm_8h.html#a343a167">MmLargeSystem</a> :
00234             <a class="code" href="../../d5/d0/wsmanage_8c.html#a5">PsMinimumWorkingSet</a> += 30;
00235             <a class="code" href="../../d2/d8/ps_2create_8c.html#a7">PsMaximumWorkingSet</a> += 300;
00236             <span class="keywordflow">break</span>;
00237 
00238         <span class="keywordflow">case</span> <a class="code" href="../../d2/d1/mm_8h.html#a343a165">MmSmallSystem</a> :
00239         <span class="keywordflow">default</span>:
00240             <span class="keywordflow">break</span>;
00241         }
00242 
00243     <a class="code" href="../../d0/d1/psinit_8c.html#a48">PsChangeQuantumTable</a>(FALSE,PsRawPrioritySeparation);
00244 
00245     <span class="comment">//</span>
00246     <span class="comment">// Quotas grow as needed automatically</span>
00247     <span class="comment">//</span>
00248 
00249     <span class="keywordflow">if</span> ( !<a class="code" href="../../d8/d0/cmdat3_8c.html#a41">PspDefaultPagedLimit</a> ) {
00250         <a class="code" href="../../d8/d0/cmdat3_8c.html#a41">PspDefaultPagedLimit</a> = 0;
00251         }
00252     <span class="keywordflow">if</span> ( !<a class="code" href="../../d8/d0/cmdat3_8c.html#a42">PspDefaultNonPagedLimit</a> ) {
00253         <a class="code" href="../../d8/d0/cmdat3_8c.html#a42">PspDefaultNonPagedLimit</a> = 0;
00254         }
00255 
00256     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d0/cmdat3_8c.html#a42">PspDefaultNonPagedLimit</a> == 0 &amp;&amp; <a class="code" href="../../d8/d0/cmdat3_8c.html#a41">PspDefaultPagedLimit</a> == 0) {
00257         <a class="code" href="../../d0/d1/psinit_8c.html#a23">PspDoingGiveBacks</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00258         }
00259     <span class="keywordflow">else</span> {
00260         <a class="code" href="../../d0/d1/psinit_8c.html#a23">PspDoingGiveBacks</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00261         }
00262 
00263 
00264     <a class="code" href="../../d8/d0/cmdat3_8c.html#a41">PspDefaultPagedLimit</a> *= <a class="code" href="../../d0/d1/psinit_8c.html#a1">PSP_1MB</a>;
00265     <a class="code" href="../../d8/d0/cmdat3_8c.html#a42">PspDefaultNonPagedLimit</a> *= <a class="code" href="../../d0/d1/psinit_8c.html#a1">PSP_1MB</a>;
00266 
00267     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a43">PspDefaultPagefileLimit</a> != -1) {
00268         <a class="code" href="../../d8/d0/cmdat3_8c.html#a43">PspDefaultPagefileLimit</a> *= <a class="code" href="../../d0/d1/psinit_8c.html#a1">PSP_1MB</a>;
00269         }
00270 
00271     <span class="comment">//</span>
00272     <span class="comment">// Initialize the process security fields lock and the process lock.</span>
00273     <span class="comment">//</span>
00274 
00275     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>( &amp;PspProcessLockMutex );
00276     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>( &amp;PsProcessSecurityLock );
00277 
00278     <a class="code" href="../../d1/d9/ps_8h.html#a62">PsIdleProcess</a> = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00279     <a class="code" href="../../d1/d9/ps_8h.html#a62">PsIdleProcess</a>-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o4">KernelTime</a> = 0;
00280     <a class="code" href="../../d1/d9/ps_8h.html#a62">PsIdleProcess</a>-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o4">KernelTime</a> = 0;
00281 
00282     <span class="comment">//</span>
00283     <span class="comment">// Initialize the common fields of the Object Type Prototype record</span>
00284     <span class="comment">//</span>
00285 
00286     RtlZeroMemory( &amp;ObjectTypeInitializer, <span class="keyword">sizeof</span>( ObjectTypeInitializer ) );
00287     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o0">Length</a> = <span class="keyword">sizeof</span>( ObjectTypeInitializer );
00288     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o3">InvalidAttributes</a> = OBJ_OPENLINK;
00289     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o6">SecurityRequired</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00290     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o9">PoolType</a> = <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>;
00291     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o3">InvalidAttributes</a> = OBJ_PERMANENT |
00292                                               OBJ_EXCLUSIVE |
00293                                               OBJ_OPENIF;
00294 
00295 
00296     <span class="comment">//</span>
00297     <span class="comment">// Create Object types for Thread and Process Objects.</span>
00298     <span class="comment">//</span>
00299 
00300     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;NameString, L<span class="stringliteral">"Process"</span>);
00301     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o10">DefaultPagedPoolCharge</a> = <a class="code" href="../../d8/d1/psp_8h.html#a1">PSP_PROCESS_PAGED_CHARGE</a>;
00302     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o11">DefaultNonPagedPoolCharge</a> = <a class="code" href="../../d8/d1/psp_8h.html#a2">PSP_PROCESS_NONPAGED_CHARGE</a>;
00303     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o15">DeleteProcedure</a> = <a class="code" href="../../d8/d0/psdelete_8c.html#a14">PspProcessDelete</a>;
00304     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o5">ValidAccessMask</a> = PROCESS_ALL_ACCESS;
00305     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> = <a class="code" href="../../d0/d1/psinit_8c.html#a6">PspProcessMapping</a>;
00306 
00307     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>(&amp;NameString,
00308                                      &amp;ObjectTypeInitializer,
00309                                      (PSECURITY_DESCRIPTOR) NULL,
00310                                      &amp;PsProcessType
00311                                      )) ){
00312         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00313     }
00314 
00315     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;NameString, L<span class="stringliteral">"Thread"</span>);
00316     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o10">DefaultPagedPoolCharge</a> = <a class="code" href="../../d8/d1/psp_8h.html#a3">PSP_THREAD_PAGED_CHARGE</a>;
00317     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o11">DefaultNonPagedPoolCharge</a> = <a class="code" href="../../d8/d1/psp_8h.html#a4">PSP_THREAD_NONPAGED_CHARGE</a>;
00318     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o15">DeleteProcedure</a> = <a class="code" href="../../d8/d0/psdelete_8c.html#a15">PspThreadDelete</a>;
00319     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o5">ValidAccessMask</a> = THREAD_ALL_ACCESS;
00320     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> = <a class="code" href="../../d0/d1/psinit_8c.html#a7">PspThreadMapping</a>;
00321 
00322     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>(&amp;NameString,
00323                                      &amp;ObjectTypeInitializer,
00324                                      (PSECURITY_DESCRIPTOR) NULL,
00325                                      &amp;PsThreadType
00326                                      )) ){
00327         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00328     }
00329 
00330 
00331     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;NameString, L<span class="stringliteral">"Job"</span>);
00332     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o10">DefaultPagedPoolCharge</a> = 0;
00333     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o11">DefaultNonPagedPoolCharge</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d3/struct__EJOB.html">EJOB</a>);
00334     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o15">DeleteProcedure</a> = <a class="code" href="../../d1/d1/psjob_8c.html#a9">PspJobDelete</a>;
00335     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o14">CloseProcedure</a> = <a class="code" href="../../d1/d1/psjob_8c.html#a10">PspJobClose</a>;
00336     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o5">ValidAccessMask</a> = JOB_OBJECT_ALL_ACCESS;
00337     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> = <a class="code" href="../../d0/d1/psinit_8c.html#a8">PspJobMapping</a>;
00338     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o3">InvalidAttributes</a> = 0;
00339 
00340     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>(&amp;NameString,
00341                                      &amp;ObjectTypeInitializer,
00342                                      (PSECURITY_DESCRIPTOR) NULL,
00343                                      &amp;PsJobType
00344                                      )) ){
00345         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00346     }
00347 
00348 
00349 
00350 
00351 
00352 
00353     <span class="comment">//</span>
00354     <span class="comment">// Initialize active process list head and mutex</span>
00355     <span class="comment">//</span>
00356 
00357     InitializeListHead(&amp;PsActiveProcessHead);
00358     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(&amp;PspActiveProcessMutex);
00359 
00360     <span class="comment">//</span>
00361     <span class="comment">// Initialize job list head and mutex</span>
00362     <span class="comment">//</span>
00363 
00364     InitializeListHead(&amp;PspJobList);
00365     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(&amp;PspJobListLock);
00366     InitializeListHead(&amp;<a class="code" href="../../d8/d1/psp_8h.html#a20">PspWorkingSetChangeHead</a>.<a class="code" href="../../d7/d4/struct__JOB__WORKING__SET__CHANGE__HEAD.html#o0">Links</a>);
00367     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(&amp;<a class="code" href="../../d8/d1/psp_8h.html#a20">PspWorkingSetChangeHead</a>.<a class="code" href="../../d7/d4/struct__JOB__WORKING__SET__CHANGE__HEAD.html#o1">Lock</a>);
00368 
00369     <span class="comment">//</span>
00370     <span class="comment">// Initialize CID handle table.</span>
00371     <span class="comment">//</span>
00372     <span class="comment">// N.B. The CID handle table is removed from the handle table list so</span>
00373     <span class="comment">//      it will not be enumerated for object handle queries.</span>
00374     <span class="comment">//</span>
00375 
00376     <a class="code" href="../../d6/d8/sysinfo_8c.html#a1">PspCidTable</a> = <a class="code" href="../../d5/d8/ex_8h.html#a290">ExCreateHandleTable</a>(NULL);
00377     <span class="keywordflow">if</span> ( ! <a class="code" href="../../d6/d8/sysinfo_8c.html#a1">PspCidTable</a> ) {
00378         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00379     }
00380     <a class="code" href="../../d5/d8/ex_8h.html#a291">ExRemoveHandleTable</a>(PspCidTable);
00381 
00382 <span class="preprocessor">#if defined(i386)</span>
00383 <span class="preprocessor"></span>
00384     <span class="comment">//</span>
00385     <span class="comment">// Ldt Initialization</span>
00386     <span class="comment">//</span>
00387 
00388     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d3/d1/i386_2psldt_8c.html#a9">PspLdtInitialize</a>()) ) {
00389         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00390     }
00391 
00392     <span class="comment">//</span>
00393     <span class="comment">// Vdm support Initialization</span>
00394     <span class="comment">//</span>
00395 
00396     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d3/d2/i386_2psvdm_8c.html#a11">PspVdmInitialize</a>()) ) {
00397         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00398     }
00399 
00400 <span class="preprocessor">#endif</span>
00401 <span class="preprocessor"></span>
00402     <span class="comment">//</span>
00403     <span class="comment">// Initialize Reaper Data Structures</span>
00404     <span class="comment">//</span>
00405 
00406     InitializeListHead(&amp;PsReaperListHead);
00407     <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>(&amp;PsReaperWorkItem, PspReaper, NULL);
00408 
00409     <span class="comment">//</span>
00410     <span class="comment">// Get a pointer to the system access token.</span>
00411     <span class="comment">// This token is used by the boot process, so we can take the pointer</span>
00412     <span class="comment">// from there.</span>
00413     <span class="comment">//</span>
00414 
00415     <a class="code" href="../../d0/d1/psinit_8c.html#a14">PspBootAccessToken</a> = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Token;
00416 
00417     InitializeObjectAttributes( &amp;ObjectAttributes,
00418                                 NULL,
00419                                 0,
00420                                 NULL,
00421                                 NULL
00422                               ); <span class="comment">// FIXFIX</span>
00423 
00424     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d1/psp_8h.html#a62">PspCreateProcess</a>(
00425                     &amp;PspInitialSystemProcessHandle,
00426                     PROCESS_ALL_ACCESS,
00427                     &amp;ObjectAttributes,
00428                     0L,
00429                     FALSE,
00430                     0L,
00431                     0L,
00432                     0L
00433                     )) ) {
00434         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00435     }
00436 
00437     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00438                                         PspInitialSystemProcessHandle,
00439                                         0L,
00440                                         PsProcessType,
00441                                         KernelMode,
00442                                         (PVOID *)&amp;PsInitialSystemProcess,
00443                                         NULL
00444                                         )) ) {
00445 
00446         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00447     }
00448 
00449     strcpy(&amp;<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ImageFileName[0],<span class="stringliteral">"Idle"</span>);
00450     strcpy(&amp;<a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o65">ImageFileName</a>[0],<span class="stringliteral">"System"</span>);
00451 
00452     <span class="comment">//</span>
00453     <span class="comment">// Phase 1 System initialization</span>
00454     <span class="comment">//</span>
00455 
00456     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d2/d8/ps_2create_8c.html#a11">PsCreateSystemThread</a>(
00457                     &amp;ThreadHandle,
00458                     THREAD_ALL_ACCESS,
00459                     &amp;ObjectAttributes,
00460                     0L,
00461                     NULL,
00462                     Phase1Initialization,
00463                     (PVOID)LoaderBlock
00464                     )) ) {
00465         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00466     }
00467 
00468 
00469     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00470                         ThreadHandle,
00471                         0L,
00472                         PsThreadType,
00473                         KernelMode,
00474                         (PVOID *)&amp;Thread,
00475                         NULL
00476                         )) ) {
00477 
00478         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00479     }
00480 
00481     ZwClose( ThreadHandle );
00482 
00483     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00484 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a56" doxytag="psp.h::PspInitPhase1" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN PspInitPhase1           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LoaderBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/psinit_8c-source.html#l00487">487</a> of file <a class="el" href="../../d1/d0/psinit_8c-source.html">psinit.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00745">PspInitializeSystemDll()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/psinit_8c-source.html#l00138">PsInitSystem()</a>.
<p>
<pre class="fragment"><div>00493                    :
00494 
00495     This routine performs phase 1 process structure initialization.
00496     During <span class="keyword">this</span> phase, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system DLL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> located and relevant entry
00497     points are extracted.
00498 
00499 Arguments:
00500 
00501     None.
00502 
00503 Return Value:
00504 
00505     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - Initialization was successful.
00506 
00507     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - Initialization Failed.
00508 
00509 --*/
00510 
00511 {
00512 
00513     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00514 
00515     st = <a class="code" href="../../d8/d1/psp_8h.html#a57">PspInitializeSystemDll</a>();
00516 
00517     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00518         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00519     }
00520 
00521     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00522 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a90" doxytag="psp.h::PspJobClose" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspJobClose           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>GrantedAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHandleCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemHandleCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d0/psjob_8c-source.html#l00709">709</a> of file <a class="el" href="../../d2/d0/psjob_8c-source.html">psjob.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00538">_EJOB::CompletionPort</a>, <a class="el" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00491">_EJOB::JobLock</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00563">_EJOB::MemoryLimitsLock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/psinit_8c-source.html#l00181">PspInitPhase0()</a>.
<p>
<pre class="fragment"><div>00718                    :
00719 
00720     Called by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object manager when a handle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> closed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
00721 
00722 Arguments:
00723 
00724     Process - Process doing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> close
00725     Object - Job object being closed
00726     GrantedAccess - Access ranted <span class="keywordflow">for</span> <span class="keyword">this</span> handle
00727     ProcessHandleCount - Unused and unmaintained by OB
00728     SystemHandleCount - Current handle count <span class="keywordflow">for</span> <span class="keyword">this</span> object
00729 
00730 Return Value:
00731 
00732     None.
00733 
00734 --*/
00735 {
00736     <a class="code" href="../../d0/d3/struct__EJOB.html">PEJOB</a> Job = Object;
00737     PVOID Port;
00738 
00739     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
00740     <span class="comment">//</span>
00741     <span class="comment">// If this isn't the last handle then do nothing.</span>
00742     <span class="comment">//</span>
00743     <span class="keywordflow">if</span> (SystemHandleCount &gt; 1) {
00744         <span class="keywordflow">return</span>;
00745     }
00746 
00747     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00748     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o3">JobLock</a>, TRUE);
00749     <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o41">MemoryLimitsLock</a>);
00750 
00751     <span class="comment">//</span>
00752     <span class="comment">// Release the completion port</span>
00753     <span class="comment">//</span>
00754     Port = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a>;
00755     Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00756     
00757 
00758     <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o41">MemoryLimitsLock</a>);
00759     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o3">JobLock</a>);
00760     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00761 
00762     <span class="keywordflow">if</span> (Port != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00763         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Port);
00764     }
00765 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a89" doxytag="psp.h::PspJobDelete" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspJobDelete           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Object</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d0/psjob_8c-source.html#l00636">636</a> of file <a class="el" href="../../d2/d0/psjob_8c-source.html">psjob.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l01068">_WIN32_JOBCALLOUT_PARAMETERS::CalloutType</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00476">_PS_JOB_TOKEN_FILTER::CapturedGroups</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00480">_PS_JOB_TOKEN_FILTER::CapturedPrivileges</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00472">_PS_JOB_TOKEN_FILTER::CapturedSids</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00538">_EJOB::CompletionPort</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l01069">_WIN32_JOBCALLOUT_PARAMETERS::Data</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02478">ExDeleteResource</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00531">_EJOB::Filter</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l01067">_WIN32_JOBCALLOUT_PARAMETERS::Job</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00489">_EJOB::JobLinks</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00491">_EJOB::JobLock</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00512">_EJOB::LimitFlags</a>, <a class="el" href="../../d2/d1/mm_8h.html#a197">MmDispatchWin32Callout()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00118">PspJobListLock</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00536">PspW32JobCallout</a>, <a class="el" href="../../d1/d9/ps_8h.html#a156a95">PsW32JobCalloutTerminate</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00541">_EJOB::SessionId</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00530">_EJOB::Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/psinit_8c-source.html#l00181">PspInitPhase0()</a>.
<p>
<pre class="fragment"><div>00639 {
00640     <a class="code" href="../../d0/d3/struct__EJOB.html">PEJOB</a> Job;
00641     <a class="code" href="../../d4/d8/struct__WIN32__JOBCALLOUT__PARAMETERS.html">WIN32_JOBCALLOUT_PARAMETERS</a> Parms;
00642 
00643     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00644 
00645     Job = (<a class="code" href="../../d0/d3/struct__EJOB.html">PEJOB</a>) Object;
00646 
00647     <span class="comment">//</span>
00648     <span class="comment">// call ntuser to delete its job structure</span>
00649     <span class="comment">//</span>
00650 
00651     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00652     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o3">JobLock</a>, TRUE);
00653 
00654 
00655     Parms.<a class="code" href="../../d4/d8/struct__WIN32__JOBCALLOUT__PARAMETERS.html#o0">Job</a> = Job;
00656     Parms.<a class="code" href="../../d4/d8/struct__WIN32__JOBCALLOUT__PARAMETERS.html#o1">CalloutType</a> = <a class="code" href="../../d1/d9/ps_8h.html#a156a95">PsW32JobCalloutTerminate</a>;
00657     Parms.<a class="code" href="../../d4/d8/struct__WIN32__JOBCALLOUT__PARAMETERS.html#o2">Data</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00658     <a class="code" href="../../d2/d1/mm_8h.html#a197">MmDispatchWin32Callout</a>( PspW32JobCallout,NULL, (PVOID)&amp;Parms, &amp;(Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o27">SessionId</a>));
00659 
00660     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o3">JobLock</a>);
00661     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00662 
00663     Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> = 0;
00664 
00665     <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a> ) {
00666         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a>);
00667         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00668         }
00669 
00670 
00671     <span class="comment">//</span>
00672     <span class="comment">// Remove Job on Job List</span>
00673     <span class="comment">//</span>
00674 
00675     ExAcquireFastMutex(&amp;PspJobListLock);
00676     RemoveEntryList(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o1">JobLinks</a>);
00677     ExReleaseFastMutex(&amp;PspJobListLock);
00678 
00679     <span class="comment">//</span>
00680     <span class="comment">// Free Security clutter:</span>
00681     <span class="comment">//</span>
00682 
00683     <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o22">Token</a> ) {
00684         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o22">Token</a> );
00685         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o22">Token</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
00686         }
00687 
00688     <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a> ) {
00689         <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o1">CapturedSids</a> ) {
00690             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o1">CapturedSids</a> );
00691             }
00692 
00693         <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o7">CapturedPrivileges</a> ) {
00694             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o7">CapturedPrivileges</a> );
00695             }
00696 
00697         <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o4">CapturedGroups</a> ) {
00698             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o4">CapturedGroups</a> );
00699             }
00700 
00701         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a> );
00702 
00703         }
00704 
00705     <a class="code" href="../../d5/d8/ex_8h.html#a73">ExDeleteResource</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o3">JobLock</a>);
00706 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a59" doxytag="psp.h::PspLookupKernelUserEntryPoints" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PspLookupKernelUserEntryPoints           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/kulokup2_8c-source.html#l00025">25</a> of file <a class="el" href="../../d9/d9/kulokup2_8c-source.html">kulokup2.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02811">KeRaiseUserExceptionDispatcher</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02808">KeUserApcDispatcher</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02809">KeUserCallbackDispatcher</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02810">KeUserExceptionDispatcher</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00827">PspLookupSystemDllEntryPoint()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/psinit_8c-source.html#l00745">PspInitializeSystemDll()</a>.
<p>
<pre class="fragment"><div>00029                    :
00030 
00031     The function locates user mode code that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel dispatches
00032     to, and stores <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> addresses of that code in global kernel variables.
00033 
00034     Which procedures are of interest <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> machine dependent.
00035 
00036 Arguments:
00037 
00038     None.
00039 
00040 Return Value:
00041 
00042     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00043 
00044 --*/
00045 
00046 {
00047     <span class="comment">//</span>
00048     <span class="comment">// NOTE WELL - This is a dummy stub to make the system build.</span>
00049     <span class="comment">//             Replace it with proper code</span>
00050     <span class="comment">//</span>
00051 
00052     <span class="keywordflow">return</span> STATUS_SUCCESS;
00053 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a58" doxytag="psp.h::PspLookupSystemDllEntryPoint" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PspLookupSystemDllEntryPoint           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSZ&nbsp;</td>
          <td class="mdname" nowrap> <em>EntryPointName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>EntryPointAddress</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/psinit_8c-source.html#l00827">827</a> of file <a class="el" href="../../d1/d0/psinit_8c-source.html">psinit.c</a>.
<p>
References <a class="el" href="../../d9/d0/psp_8h-source.html#l00086">_SYSTEM_DLL::DllBase</a>, <a class="el" href="../../d0/d1/psinit_8c.html#a40">LookupEntryPoint()</a>, and <a class="el" href="../../d1/d0/psinit_8c-source.html#l00124">PspSystemDll</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/psinit_8c-source.html#l00745">PspInitializeSystemDll()</a>, and <a class="el" href="../../d0/d0/kulookup_8c-source.html#l00026">PspLookupKernelUserEntryPoints()</a>.
<p>
<pre class="fragment"><div>00832 {
00833     <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/psinit_8c.html#a40">LookupEntryPoint</a> (
00834                 <a class="code" href="../../d0/d1/psinit_8c.html#a30">PspSystemDll</a>.<a class="code" href="../../d0/d8/struct__SYSTEM__DLL.html#o1">DllBase</a>,
00835                 NameOfEntryPoint,
00836                 AddressOfEntryPoint
00837             );
00838 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a61" doxytag="psp.h::PspMapSystemDll" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PspMapSystemDll           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *DllBase&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d0/psinit_8c-source.html#l00679">679</a> of file <a class="el" href="../../d1/d0/psinit_8c-source.html">psinit.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00753">MmMapViewOfSection()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00124">PspSystemDll</a>, and <a class="el" href="../../d9/d0/psp_8h-source.html#l00085">_SYSTEM_DLL::Section</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/psinit_8c-source.html#l00525">PsLocateSystemDll()</a>, and <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>.
<p>
<pre class="fragment"><div>00686                    :
00687 
00688     This function maps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system DLL into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified process.
00689 
00690 Arguments:
00691 
00692     Process - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process to map <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL into.
00693 
00694 Return Value:
00695 
00696     TBD
00697 
00698 --*/
00699 
00700 {
00701     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00702     PVOID ViewBase;
00703     LARGE_INTEGER SectionOffset;
00704     SIZE_T ViewSize;
00705 
00706     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00707 
00708     ViewBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00709     SectionOffset.LowPart = 0;
00710     SectionOffset.HighPart = 0;
00711     ViewSize = 0;
00712 
00713     <span class="comment">//</span>
00714     <span class="comment">// Map the system dll into the user part of the address space</span>
00715     <span class="comment">//</span>
00716 
00717     st = <a class="code" href="../../d3/d5/mapview_8c.html#a21">MmMapViewOfSection</a>(
00718             <a class="code" href="../../d0/d1/psinit_8c.html#a30">PspSystemDll</a>.<a class="code" href="../../d0/d8/struct__SYSTEM__DLL.html#o0">Section</a>,
00719             Process,
00720             &amp;ViewBase,
00721             0L,
00722             0L,
00723             &amp;SectionOffset,
00724             &amp;ViewSize,
00725             ViewShare,
00726             0L,
00727             PAGE_READWRITE
00728             );
00729 
00730     <span class="keywordflow">if</span> ( st != STATUS_SUCCESS ) {
00731 <span class="preprocessor">#if DBG</span>
00732 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"PS: Unable to map system dll at based address.\n"</span>);
00733 <span class="preprocessor">#endif</span>
00734 <span class="preprocessor"></span>        st = STATUS_CONFLICTING_ADDRESSES;
00735     }
00736 
00737     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(DllBase) ) {
00738         *DllBase = ViewBase;
00739     }
00740 
00741     <span class="keywordflow">return</span> st;
00742 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a60" doxytag="psp.h::PspNameToOrdinal" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> PspNameToOrdinal           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSZ&nbsp;</td>
          <td class="mdname" nowrap> <em>EntryPointName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DllBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfNames</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NameTableBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a22">PUSHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OrdinalTableBase</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a67" doxytag="psp.h::PspNullSpecialApc" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspNullSpecialApc           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Apc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a50" doxytag="psp.h::PspProcessDelete" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspProcessDelete           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Object</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01363">1363</a> of file <a class="el" href="../../d9/d9/psdelete_8c-source.html">psdelete.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l00705">_KPROCESS::DirectoryTableBase</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01227">ExDestroyHandle()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00285">_EPROCESS::Job</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00070">KeBugCheck()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00324">KeStackAttachProcess()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01335">KeTerminateProcess</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00512">KeUnstackDetachProcess()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l01398">MmDeleteProcessAddressSpace()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d9/obdevmap_8c-source.html#l00416">ObDereferenceDeviceMap()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02209">PERFINFO_PROCESS_DELETE</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00037">PspCidTable</a>, <a class="el" href="../../d3/d0/alpha_2psldt_8c-source.html#l00140">PspDeleteLdt()</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01206">PspDeleteProcessSecurity()</a>, <a class="el" href="../../d3/d1/alpha_2psvdm_8c-source.html#l00058">PspDeleteVdmObjects()</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00494">PspDereferenceQuota()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01232">PspExitProcess()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l00579">PspRemoveProcessFromJob()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02653">SeAuditProcessExit()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01709">SeDetailedAuditing</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00207">_EPROCESS::Token</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/psinit_8c-source.html#l00181">PspInitPhase0()</a>.
<p>
<pre class="fragment"><div>01366 {
01367     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
01368     ULONG AddressSpace;
01369     <a class="code" href="../../d3/d5/struct__KAPC__STATE.html">KAPC_STATE</a> ApcState;
01370 
01371     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01372 
01373     Process = (<a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>)Object;
01374 
01375     <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d5/se_8h.html#a106">SeDetailedAuditing</a> &amp;&amp; Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o21">Token</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01376         <a class="code" href="../../d7/d6/sepaudit_8c.html#a21">SeAuditProcessExit</a>(
01377             Process
01378             );
01379     }
01380 
01381     <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a> ) {
01382         <a class="code" href="../../d8/d1/psp_8h.html#a92">PspRemoveProcessFromJob</a>(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>,Process);
01383         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>);
01384         }
01385 
01386     <a class="code" href="../../d4/d9/ke_8h.html#a26">KeTerminateProcess</a>((<a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a>)Process);
01387     AddressSpace = (ULONG)
01388         ((PHARDWARE_PTE)(&amp;(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o2">DirectoryTableBase</a>[0])))-&gt;PageFrameNumber;
01389 
01390 
01391     <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o18">DebugPort</a>) {
01392         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o18">DebugPort</a>);
01393     }
01394     <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o19">ExceptionPort</a>) {
01395         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o19">ExceptionPort</a>);
01396     }
01397     <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a> ) {
01398         <span class="keywordflow">if</span> ( !(<a class="code" href="../../d5/d8/ex_8h.html#a297">ExDestroyHandle</a>(PspCidTable,Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a>,NULL))) {
01399             <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(CID_HANDLE_DELETION);
01400         }
01401     }
01402 
01403     <a class="code" href="../../d8/d1/psp_8h.html#a85">PspDeleteLdt</a>( Process );
01404     <a class="code" href="../../d8/d1/psp_8h.html#a87">PspDeleteVdmObjects</a>( Process );
01405 
01406     <span class="keywordflow">if</span> ( AddressSpace ) {
01407 
01408         <span class="comment">//</span>
01409         <span class="comment">// Clean address space of the process</span>
01410         <span class="comment">//</span>
01411 
01412         <a class="code" href="../../d3/d5/procobj_8c.html#a6">KeStackAttachProcess</a>(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>, &amp;ApcState);
01413 
01414         <a class="code" href="../../d8/d1/psp_8h.html#a71">PspExitProcess</a>(FALSE,Process);
01415 
01416         <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
01417     }
01418 
01419     <a class="code" href="../../d6/d5/ps_2security_8c.html#a11">PspDeleteProcessSecurity</a>( Process );
01420 
01421     <span class="keywordflow">if</span> (AddressSpace) {
01422         <a class="code" href="../../d4/d5/procsup_8c.html#a31">MmDeleteProcessAddressSpace</a>(Process);
01423     }
01424 
01425 <span class="preprocessor">#if DEVL</span>
01426 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o51">WorkingSetWatch</a> ) {
01427         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o51">WorkingSetWatch</a>);
01428     }
01429 <span class="preprocessor">#endif // DEVL</span>
01430 <span class="preprocessor"></span>
01431     <a class="code" href="../../d2/d1/mm_8h.html#a88">PERFINFO_PROCESS_DELETE</a>(Process);
01432 
01433     <a class="code" href="../../d7/d0/obdevmap_8c.html#a3">ObDereferenceDeviceMap</a>(Process);
01434     <a class="code" href="../../d0/d2/psquota_8c.html#a6">PspDereferenceQuota</a>(Process);
01435 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a49" doxytag="psp.h::PspProcessDump" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspProcessDump           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d5/struct__OBJECT__DUMP__CONTROL.html">POB_DUMP_CONTROL</a> Control&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a88" doxytag="psp.h::PspQueryDescriptorThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PspQueryDescriptorThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ThreadInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ThreadInformationLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/alpha_2psldt_8c-source.html#l00112">112</a> of file <a class="el" href="../../d3/d0/alpha_2psldt_8c-source.html">alpha/psldt.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/psquery_8c-source.html#l02706">NtQueryInformationThread()</a>.
<p>
<pre class="fragment"><div>00120                    :
00121 
00122     This function returns STATUS_NOT_IMPLEMENTED
00123 
00124 Arguments:
00125 
00126     Thread -- Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread.
00127     ThreadInformation -- Supplies information on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> descriptor.
00128     ThreadInformationLength -- Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information.
00129     ReturnLength -- Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes returned.
00130 
00131 Return Value:
00132     
00133     STATUS_NOT_IMPLEMENTED
00134 --*/
00135 {
00136     <span class="keywordflow">return</span> STATUS_NOT_IMPLEMENTED;
00137 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a82" doxytag="psp.h::PspQueryLdtInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PspQueryLdtInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>LdtInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>LdtInformationLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/alpha_2psldt_8c-source.html#l00025">25</a> of file <a class="el" href="../../d3/d0/alpha_2psldt_8c-source.html">alpha/psldt.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/psquery_8c-source.html#l00531">NtQueryInformationProcess()</a>.
<p>
<pre class="fragment"><div>00033                    :
00034 
00035     This routine returns STATUS_NOT_IMPLEMENTED
00036 
00037 Arguments:
00038 
00039     Process -- Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process to <span class="keywordflow">return</span> LDT info <span class="keywordflow">for</span>
00040     LdtInformation -- Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer 
00041     ReturnLength -- Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes put into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer
00042     
00043 Return Value:
00044 
00045     STATUS_NOT_IMPLEMENTED
00046 --*/
00047 {
00048     <span class="keywordflow">return</span> STATUS_NOT_IMPLEMENTED;
00049 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a66" doxytag="psp.h::PspReaper" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspReaper           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>StartContext</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00057">57</a> of file <a class="el" href="../../d9/d9/psdelete_8c-source.html">psdelete.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00556">_KTHREAD::InitialStack</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00128">KiLockContextSwap</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00131">KiUnlockContextSwap</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00641">_KTHREAD::LargeStack</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l02723">MmDeleteKernelStack()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00589">PsReaperActive</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00590">PsReaperListHead</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00667">_KTHREAD::StackBase</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00347">_ETHREAD::Tcb</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00638">THREAD_TO_PROCESS</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/psinit_8c-source.html#l00181">PspInitPhase0()</a>.
<p>
<pre class="fragment"><div>00063                    :
00064 
00065     This routine implements <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread reaper. The reaper <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> responsible
00066     <span class="keywordflow">for</span> processing terminated threads. This includes:
00067 
00068         - deallocating their kernel stacks
00069 
00070         - releasing their process' CreateDelete lock
00071 
00072         - dereferencing their process
00073 
00074         - dereferencing themselves
00075 
00076 Arguments:
00077 
00078     Context - NOT USED
00079 
00080 Return Value:
00081 
00082     None.
00083 
00084 --*/
00085 
00086 {
00087 
00088     PLIST_ENTRY NextEntry;
00089     KIRQL OldIrql, OldIrql2;
00090     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00091     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00092 
00093 
00094     <span class="comment">//</span>
00095     <span class="comment">// Lock the dispatcher data and continually remove entries from the</span>
00096     <span class="comment">// reaper list until no more entries exist.</span>
00097     <span class="comment">//</span>
00098     <span class="comment">// N.B. The dispatcher database lock is used to synchronize access to</span>
00099     <span class="comment">//      the reaper list. This is done to avoid a race condition with</span>
00100     <span class="comment">//      the thread termination code.</span>
00101     <span class="comment">//</span>
00102 
00103     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00104     NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a64">PsReaperListHead</a>.Flink;
00105     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a64">PsReaperListHead</a>) {
00106 
00107         <span class="comment">//</span>
00108         <span class="comment">// Remove the next thread from the reaper list, get the address of</span>
00109         <span class="comment">// the executive thread object, acquire the context swap lock, and</span>
00110         <span class="comment">// then release the both the context swap dispatcher database locks.</span>
00111         <span class="comment">//</span>
00112         <span class="comment">// N.B. The context swap lock is acquired and immediately released.</span>
00113         <span class="comment">//    This is necessary to ensure that the respective thread has</span>
00114         <span class="comment">//    completely passed through the context switch code before it</span>
00115         <span class="comment">//    is terminated.</span>
00116         <span class="comment">//</span>
00117 
00118         RemoveEntryList(NextEntry);
00119         Thread = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d5/d6/struct__ETHREAD.html">ETHREAD</a>, TerminationPortList);
00120 
00121         <a class="code" href="../../d0/d0/ki_8h.html#a11">KiLockContextSwap</a>(&amp;OldIrql2);
00122         <a class="code" href="../../d0/d0/ki_8h.html#a12">KiUnlockContextSwap</a>(OldIrql2);
00123 
00124         <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00125 
00126         <span class="comment">//</span>
00127         <span class="comment">// Get the address of the executive process object, release the</span>
00128         <span class="comment">// process' CreateDelete lock and then dereference the process</span>
00129         <span class="comment">// object.</span>
00130         <span class="comment">//</span>
00131 
00132         Process = <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>(Thread);
00133         <span class="comment">//</span>
00134         <span class="comment">// Delete the kernel stack and dereference the thread.</span>
00135         <span class="comment">//</span>
00136 
00137         <a class="code" href="../../d4/d5/procsup_8c.html#a34">MmDeleteKernelStack</a>(Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o61">StackBase</a>,(BOOLEAN)Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o52">LargeStack</a>);
00138         Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o2">InitialStack</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00139         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
00140 
00141         <span class="comment">//</span>
00142         <span class="comment">// Lock the dispatcher database and get the address of the next</span>
00143         <span class="comment">// entry in the list.</span>
00144         <span class="comment">//</span>
00145 
00146         <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00147         NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a64">PsReaperListHead</a>.Flink;
00148     }
00149 
00150     <span class="comment">//</span>
00151     <span class="comment">// Set the reaper not active and unlock the dispatcher database.</span>
00152     <span class="comment">//</span>
00153 
00154     <a class="code" href="../../d1/d9/ps_8h.html#a63">PsReaperActive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00155     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00156     <span class="keywordflow">return</span>;
00157 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a92" doxytag="psp.h::PspRemoveProcessFromJob" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspRemoveProcessFromJob           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d3/struct__EJOB.html">PEJOB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Job</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d0/psjob_8c-source.html#l00579">579</a> of file <a class="el" href="../../d2/d0/psjob_8c-source.html">psjob.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00503">_EJOB::ActiveProcesses</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00287">_EPROCESS::JobLinks</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00491">_EJOB::JobLock</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00286">_EPROCESS::JobStatus</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00314">PS_JOB_STATUS_NOT_REALLY_ACTIVE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00148">PS_SET_BITS</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l02632">PspFoldProcessAccountingIntoJob()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01363">PspProcessDelete()</a>.
<p>
<pre class="fragment"><div>00583 {
00584     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00585 
00586     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00587     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o3">JobLock</a>, TRUE);
00588 
00589     RemoveEntryList(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o75">JobLinks</a>);
00590 
00591     <span class="comment">//</span>
00592     <span class="comment">// Update REMOVE accounting info</span>
00593     <span class="comment">//</span>
00594 
00595 
00596     <span class="keywordflow">if</span> ( !(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a9">PS_JOB_STATUS_NOT_REALLY_ACTIVE</a>) ) {
00597         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o10">ActiveProcesses</a>--;
00598         <a class="code" href="../../d1/d9/ps_8h.html#a6">PS_SET_BITS</a> (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a>, PS_JOB_STATUS_NOT_REALLY_ACTIVE);
00599         }
00600 
00601     <a class="code" href="../../d8/d1/psp_8h.html#a98">PspFoldProcessAccountingIntoJob</a>(Job,Process);
00602 
00603     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o3">JobLock</a>);
00604     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00605 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a72" doxytag="psp.h::PspSetContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspSetContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PKNONVOLATILE_CONTEXT_POINTERS&nbsp;</td>
          <td class="mdname" nowrap> <em>NonVolatileContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Mode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d9/psctx386_8c-source.html#l00088">88</a> of file <a class="el" href="../../d4/d9/psctx386_8c-source.html">psctx386.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d8/ppc_2exceptn_8c-source.html#l00230">KeContextToKframes()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/psctxppc_8c-source.html#l00386">PspGetSetContextApc()</a>, <a class="el" href="../../d4/d9/psctx386_8c-source.html#l00131">PspGetSetContextSpecialApc()</a>, and <a class="el" href="../../d5/d9/psctxalp_8c-source.html#l00349">PspGetSetContextSpecialApcMain()</a>.
<p>
<pre class="fragment"><div>00097                    :
00098 
00099     This function moves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> contents of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified context record
00100     into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified trap frame, and modifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread's non <span class="keyword">volatile</span>
00101     context by storing through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread's nonvolatile context pointers.
00102 
00103     N.B. - NonVolatileContext <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> IGNORED on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> 386.
00104 
00105 Arguments:
00106 
00107     TrapFrame - Returns selected pieces of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context record.
00108 
00109     Context - Supplies a context record to be copied in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap and
00110               nonvolatile context.
00111 
00112     Mode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mode to be used when sanitizing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> psr, epsr and fsr
00113 
00114 Return Value:
00115 
00116     None.
00117 
00118 --*/
00119 
00120 {
00121     UNREFERENCED_PARAMETER( NonVolatileContext );
00122     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(((TrapFrame-&gt;SegCs &amp; MODE_MASK) != KernelMode) ||
00123            (TrapFrame-&gt;EFlags &amp; EFLAGS_V86_MASK));
00124 
00125     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00126 
00127     <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a10">KeContextToKframes</a>(TrapFrame, NULL, Context, Context-&gt;ContextFlags, Mode);
00128 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a83" doxytag="psp.h::PspSetLdtInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PspSetLdtInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>LdtInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>LdtInformationLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/alpha_2psldt_8c-source.html#l00081">81</a> of file <a class="el" href="../../d3/d0/alpha_2psldt_8c-source.html">alpha/psldt.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/psquery_8c-source.html#l01510">NtSetInformationProcess()</a>.
<p>
<pre class="fragment"><div>00089                    :
00090 
00091     This function returns STATUS_NOT_IMPLEMENTED
00092 
00093 Arguments:
00094 
00095     Process -- Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process whose Ldt <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be modified
00096     LdtInformation -- Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Ldt
00097         modifications
00098     LdtInformationLength -- Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LdtInformation 
00099         structure.
00100 Return Value:
00101 
00102     
00103 Return Value:
00104 
00105     STATUS_NOT_IMPLEMENTED
00106 --*/
00107 {
00108     <span class="keywordflow">return</span> STATUS_NOT_IMPLEMENTED;
00109 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a84" doxytag="psp.h::PspSetLdtSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PspSetLdtSize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>LdtSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>LdtSizeLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/alpha_2psldt_8c-source.html#l00053">53</a> of file <a class="el" href="../../d3/d0/alpha_2psldt_8c-source.html">alpha/psldt.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/psquery_8c-source.html#l01510">NtSetInformationProcess()</a>.
<p>
<pre class="fragment"><div>00061                    :
00062 
00063     This function returns STATUS_NOT_IMPLEMENTED
00064 
00065 Arguments:
00066 
00067     Process -- Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process whose Ldt <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be sized
00068     LdtSize -- Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size information
00069 
00070     
00071 Return Value:
00072 
00073     STATUS_NOT_IMPLEMENTED
00074 --*/
00075 {
00076     <span class="keywordflow">return</span> STATUS_NOT_IMPLEMENTED;
00077 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a81" doxytag="psp.h::PspSetPrimaryToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PspSetPrimaryToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE TokenHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PACCESS_TOKEN TokenPointer&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/psquery_8c-source.html#l00366">366</a> of file <a class="el" href="../../d0/d1/psquery_8c-source.html">psquery.c</a>.
<p>
References <a class="el" href="../../d1/d4/se_8h-source.html#l00100">_SECURITY_SUBJECT_CONTEXT::ClientToken</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00168">_OBJECT_TYPE_INITIALIZER::GenericMapping</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01258">ObGetObjectSecurity()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01418">ObReleaseObjectSecurity()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00102">_SECURITY_SUBJECT_CONTEXT::PrimaryToken</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00103">_SECURITY_SUBJECT_CONTEXT::ProcessAuditId</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00810">PsDereferencePrimaryToken</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01256">PspAssignPrimaryToken()</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00088">PsProcessType</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00028">PsReferencePrimaryToken()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l03323">SeAccessCheck()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01671">SeAssignPrimaryTokenPrivilege</a>, <a class="el" href="../../d9/d3/privileg_8c-source.html#l00504">SeCheckPrivilegedObject()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l02960">SeIsChildTokenByPointer()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01213">SeTokenObjectType</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/psjob_8c-source.html#l00266">NtAssignProcessToJobObject()</a>, and <a class="el" href="../../d0/d1/psquery_8c-source.html#l01510">NtSetInformationProcess()</a>.
<p>
<pre class="fragment"><div>00377 {
00378     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st ;
00379     BOOLEAN HasPrivilege ;
00380     BOOLEAN IsChildToken ;
00381     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process ;
00382     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode ;
00383 
00384     <span class="comment">//</span>
00385     <span class="comment">// Check to see if the supplied token is a child of the caller's</span>
00386     <span class="comment">// token. If so, we don't need to do the privilege check.</span>
00387     <span class="comment">//</span>
00388 
00389     PreviousMode = KeGetPreviousMode();
00390 
00391     <span class="keywordflow">if</span> ( TokenHandle )
00392     {
00393         <span class="comment">//</span>
00394         <span class="comment">// Reference the specified token, and make sure it can be assigned</span>
00395         <span class="comment">// as a primary token.</span>
00396         <span class="comment">//</span>
00397 
00398        st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> (
00399                 TokenHandle,
00400                 TOKEN_ASSIGN_PRIMARY,
00401                 <a class="code" href="../../d0/d5/se_8h.html#a17">SeTokenObjectType</a>(),
00402                 PreviousMode,
00403                 (PVOID *)&amp;TokenPointer,
00404                 NULL
00405                 );
00406 
00407         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
00408             <span class="keywordflow">return</span>( st );
00409         }
00410     }
00411 
00412     st = <a class="code" href="../../d4/d3/token_8c.html#a20">SeIsChildTokenByPointer</a>(
00413             TokenPointer,
00414             &amp;IsChildToken
00415             );
00416 
00417     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
00418 
00419         <span class="keywordflow">if</span> ( TokenHandle ) {
00420             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( TokenPointer );
00421         }
00422         <span class="keywordflow">return</span>( st );
00423     }
00424 
00425     <span class="keywordflow">if</span> (!IsChildToken ) {
00426 
00427 
00428         <span class="comment">//</span>
00429         <span class="comment">// SeCheckPrivilegedObject will perform auditing as appropriate</span>
00430         <span class="comment">//</span>
00431 
00432         HasPrivilege = <a class="code" href="../../d8/d4/privileg_8c.html#a4">SeCheckPrivilegedObject</a>(
00433                            SeAssignPrimaryTokenPrivilege,
00434                            ProcessHandle,
00435                            PROCESS_SET_INFORMATION,
00436                            PreviousMode
00437                            );
00438 
00439         <span class="keywordflow">if</span> ( !HasPrivilege ) {
00440 
00441             <span class="keywordflow">if</span> ( TokenHandle ) {
00442                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( TokenPointer );
00443             }
00444 
00445             <span class="keywordflow">return</span>( STATUS_PRIVILEGE_NOT_HELD );
00446         }
00447 
00448     }
00449 
00450     st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00451             ProcessHandle,
00452             PROCESS_SET_INFORMATION,
00453             PsProcessType,
00454             PreviousMode,
00455             (PVOID *)&amp;Process,
00456             NULL
00457             );
00458 
00459     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00460 
00461         <span class="comment">//</span>
00462         <span class="comment">// Check for proper access to the token, and assign the primary</span>
00463         <span class="comment">// token for the process.</span>
00464         <span class="comment">//</span>
00465 
00466         st = <a class="code" href="../../d6/d5/ps_2security_8c.html#a12">PspAssignPrimaryToken</a>( Process, NULL, TokenPointer );
00467 
00468         <span class="comment">//</span>
00469         <span class="comment">// Recompute the process's access to itself for use</span>
00470         <span class="comment">// with the CurrentProcess() pseudo handle.</span>
00471         <span class="comment">//</span>
00472 
00473         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00474 
00475             <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> accesst;
00476             BOOLEAN AccessCheck;
00477             BOOLEAN MemoryAllocated;
00478             PSECURITY_DESCRIPTOR SecurityDescriptor;
00479             <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> SubjectContext;
00480 
00481             st = <a class="code" href="../../d9/d1/obse_8c.html#a8">ObGetObjectSecurity</a>(
00482                     Process,
00483                     &amp;SecurityDescriptor,
00484                     &amp;MemoryAllocated
00485                     );
00486 
00487             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00488 
00489                 <span class="comment">//</span>
00490                 <span class="comment">// Compute the subject security context</span>
00491                 <span class="comment">//</span>
00492 
00493                 SubjectContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o3">ProcessAuditId</a> = Process;
00494                 SubjectContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o2">PrimaryToken</a> = <a class="code" href="../../d6/d5/ps_2security_8c.html#a0">PsReferencePrimaryToken</a>(Process);
00495                 SubjectContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o0">ClientToken</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00496                 AccessCheck = <a class="code" href="../../d0/d4/accessck_8c.html#a18">SeAccessCheck</a>(
00497                                 SecurityDescriptor,
00498                                 &amp;SubjectContext,
00499                                 FALSE,
00500                                 MAXIMUM_ALLOWED,
00501                                 0,
00502                                 NULL,
00503                                 &amp;<a class="code" href="../../d9/d8/ntos_8h.html#a2">PsProcessType</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>,
00504                                 PreviousMode,
00505                                 &amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o54">GrantedAccess</a>,
00506                                 &amp;accesst
00507                                 );
00508                 <a class="code" href="../../d1/d9/ps_8h.html#a24">PsDereferencePrimaryToken</a>(SubjectContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o2">PrimaryToken</a>);
00509                 <a class="code" href="../../d9/d1/obse_8c.html#a9">ObReleaseObjectSecurity</a>(
00510                     SecurityDescriptor,
00511                     MemoryAllocated
00512                     );
00513                 <span class="keywordflow">if</span> ( !AccessCheck ) {
00514                     Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o54">GrantedAccess</a> = 0;
00515                     }
00516             }
00517         }
00518 
00519         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00520     }
00521 
00522     <span class="keywordflow">if</span> ( TokenHandle) {
00523         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( TokenPointer );
00524     }
00525 
00526     <span class="keywordflow">return</span> st;
00527 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a86" doxytag="psp.h::PspSetProcessIoHandlers" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PspSetProcessIoHandlers           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>IoHandlerInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>IoHandlerLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/alpha_2psvdm_8c-source.html#l00025">25</a> of file <a class="el" href="../../d3/d1/alpha_2psvdm_8c-source.html">alpha/psvdm.c</a>.
<p>
<pre class="fragment"><div>00032                    :
00033 
00034     This routine returns STATUS_NOT_IMPLEMENTED
00035 
00036 Arguments:
00037 
00038     Process -- Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process <span class="keywordflow">for</span> which Io port handlers
00039         are to be installed
00040     IoHandlerInformation -- Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00041         io port handlers
00042     IoHandlerLength -- Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IoHandlerInformation
00043         structure.
00044 
00045 Return Value:
00046 
00047     Returns STATUS_NOT_IMPLEMENTED
00048 
00049 --*/
00050 {
00051     UNREFERENCED_PARAMETER(Process);
00052     UNREFERENCED_PARAMETER(IoHandlerInformation);
00053     UNREFERENCED_PARAMETER(IoHandlerLength);
00054     <span class="keywordflow">return</span> STATUS_NOT_IMPLEMENTED;
00055 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a65" doxytag="psp.h::PspSystemThreadStartup" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspSystemThreadStartup           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d9/ke_8h.html#a66">PKSTART_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>StartRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>StartContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01920">1920</a> of file <a class="el" href="../../d3/d7/ps_2create_8c-source.html">ps/create.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00431">_ETHREAD::DeadThread</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00434">_ETHREAD::HasTerminated</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00070">KeBugCheck()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00025">KMODE_EXCEPTION_NOT_HANDLED</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l04948">MmAllowWorkingSetExpansion()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00690">PspExitThread()</a>, and <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01895">PspUnhandledExceptionInSystemThread()</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00262">PspCreateThread()</a>.
<p>
<pre class="fragment"><div>01927                    :
01928 
01929     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel to start a system thread.
01930 
01931 Arguments:
01932 
01933     StartRoutine - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system threads entry point.
01934 
01935     StartContext - Supplies a context value <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system thread.
01936 
01937 Return Value:
01938 
01939     None.
01940 
01941 --*/
01942 
01943 {
01944 
01945         <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
01946 
01947         <a class="code" href="../../d4/d5/procsup_8c.html#a43">MmAllowWorkingSetExpansion</a>();
01948 
01949         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(0);
01950 
01951         Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01952 
01953         <span class="keywordflow">try</span> {
01954             <span class="keywordflow">if</span> ( !Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o24">DeadThread</a> &amp;&amp; !Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o26">HasTerminated</a> ) {
01955                 (StartRoutine)(StartContext);
01956                 }
01957             }
01958         except (<a class="code" href="../../d2/d8/ps_2create_8c.html#a20">PspUnhandledExceptionInSystemThread</a>(GetExceptionInformation())) {
01959             <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(KMODE_EXCEPTION_NOT_HANDLED);
01960             }
01961         <a class="code" href="../../d8/d1/psp_8h.html#a68">PspExitThread</a>(STATUS_SUCCESS);
01962 
01963 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a97" doxytag="psp.h::PspTerminateAllProcessesInJob" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN PspTerminateAllProcessesInJob           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d3/struct__EJOB.html">PEJOB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Job</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>NTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>Status</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d1/d9/ps_8h.html#a73">PSLOCKPROCESSMODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LockMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d0/psjob_8c-source.html#l02570">2570</a> of file <a class="el" href="../../d2/d0/psjob_8c-source.html">psjob.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00503">_EJOB::ActiveProcesses</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00286">_EPROCESS::JobStatus</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00058">ObGetObjectPointerCount()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00490">_EJOB::ProcessListHead</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00314">PS_JOB_STATUS_NOT_REALLY_ACTIVE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00148">PS_SET_BITS</a>, <a class="el" href="../../d1/d9/ps_8h.html#a155a89">PsLockPollOnTimeout</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l02632">PspFoldProcessAccountingIntoJob()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00384">PspTerminateProcess()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00504">_EJOB::TotalTerminatedProcesses</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/psjob_8c-source.html#l02358">NtTerminateJobObject()</a>, and <a class="el" href="../../d2/d0/psjob_8c-source.html#l02396">PsEnforceExecutionTimeLimits()</a>.
<p>
<pre class="fragment"><div>02575 {
02576     PLIST_ENTRY NextProcess;
02577     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
02578     BOOLEAN TerminatedAProcess;
02579 
02580     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02581 
02582     TerminatedAProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02583     NextProcess = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o2">ProcessListHead</a>.Flink;
02584 
02585     <span class="keywordflow">while</span> ( NextProcess != &amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o2">ProcessListHead</a>) {
02586 
02587         Process = (<a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>)(CONTAINING_RECORD(NextProcess,<a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>,JobLinks));
02588 
02589         <span class="comment">//</span>
02590         <span class="comment">// Reference the process. Assert that it is not in its</span>
02591         <span class="comment">// delete routine. If all is OK, then nuke and dereferece</span>
02592         <span class="comment">// the process</span>
02593         <span class="comment">//</span>
02594 
02595         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(Process);
02596 
02597         <span class="comment">//</span>
02598         <span class="comment">// Avoid double delete since process could be in delete routine during the above ref</span>
02599         <span class="comment">//</span>
02600         <span class="keywordflow">if</span> ( <a class="code" href="../../d7/d1/obref_8c.html#a1">ObGetObjectPointerCount</a>(Process) &gt; 1 ) {
02601             <span class="keywordflow">if</span> ( !(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a9">PS_JOB_STATUS_NOT_REALLY_ACTIVE</a>) ) {
02602 
02603                 <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d1/psp_8h.html#a94">PspTerminateProcess</a>(Process,Status,LockMode) == STATUS_SUCCESS ) {
02604 
02605                     <span class="comment">//</span>
02606                     <span class="comment">// If the lockmode isn't poll, it means we ran out of</span>
02607                     <span class="comment">// job time, so increment the terminated process count</span>
02608                     <span class="comment">// for each nuked process</span>
02609                     <span class="comment">//</span>
02610                     <span class="keywordflow">if</span> ( LockMode != <a class="code" href="../../d1/d9/ps_8h.html#a155a89">PsLockPollOnTimeout</a> ) {
02611                         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o11">TotalTerminatedProcesses</a>++;
02612                         }
02613                     <a class="code" href="../../d1/d9/ps_8h.html#a6">PS_SET_BITS</a> (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a>, PS_JOB_STATUS_NOT_REALLY_ACTIVE);
02614                     Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o10">ActiveProcesses</a>--;
02615 
02616                     <a class="code" href="../../d8/d1/psp_8h.html#a98">PspFoldProcessAccountingIntoJob</a>(Job,Process);
02617 
02618                     TerminatedAProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02619                     }
02620                 }
02621 
02622             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
02623             }
02624 
02625         NextProcess = NextProcess-&gt;Flink;
02626         }
02627     <span class="keywordflow">return</span> TerminatedAProcess;
02628 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a94" doxytag="psp.h::PspTerminateProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PspTerminateProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>NTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>Status</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d1/d9/ps_8h.html#a73">PSLOCKPROCESSMODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LockMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00384">384</a> of file <a class="el" href="../../d9/d9/psdelete_8c-source.html">psdelete.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00434">_ETHREAD::HasTerminated</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00639">IS_SYSTEM_THREAD</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l00688">KeForceResumeThread()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01966">PsLockProcess()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00160">PspTerminateThreadByPointer()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l02250">PsUnlockProcess()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00347">_ETHREAD::Tcb</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00307">_EPROCESS::ThreadListHead</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/psjob_8c-source.html#l00266">NtAssignProcessToJobObject()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l02396">PsEnforceExecutionTimeLimits()</a>, and <a class="el" href="../../d2/d0/psjob_8c-source.html#l02570">PspTerminateAllProcessesInJob()</a>.
<p>
<pre class="fragment"><div>00392                    :
00393 
00394     This function causes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified process and all of
00395     its threads to terminate.
00396 
00397 Arguments:
00398 
00399     ProcessHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process to terminate.
00400 
00401     ExitStatus - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a> status associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process.
00402 
00403 Return Value:
00404 
00405     TBD
00406 
00407 --*/
00408 
00409 {
00410 
00411     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00412     PLIST_ENTRY Next;
00413     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00414 
00415     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00416 
00417     <span class="keywordflow">if</span> ( Process == <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() ) {
00418         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00419         }
00420 
00421     <span class="comment">//</span>
00422     <span class="comment">// the following allows NtTerminateProcess to fail properly if</span>
00423     <span class="comment">// called while the exiting process is blocked holding the</span>
00424     <span class="comment">// createdeletelock. This can happen during debugger/server</span>
00425     <span class="comment">// lpc transactions that occur in pspexitthread</span>
00426     <span class="comment">//</span>
00427 
00428     st = <a class="code" href="../../d2/d8/ps_2create_8c.html#a22">PsLockProcess</a>(Process,KernelMode,LockMode);
00429 
00430     <span class="keywordflow">if</span> ( st != STATUS_SUCCESS ) {
00431         <span class="keywordflow">return</span> st;
00432         }
00433 
00434     Next = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o87">ThreadListHead</a>.Flink;
00435 
00436     <span class="keywordflow">while</span> ( Next != &amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o87">ThreadListHead</a>) {
00437 
00438         Thread = (<a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>)(CONTAINING_RECORD(Next,<a class="code" href="../../d5/d6/struct__ETHREAD.html">ETHREAD</a>,ThreadListEntry));
00439 
00440         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d9/ps_8h.html#a18">IS_SYSTEM_THREAD</a>(Thread) ) {
00441             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00442             <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
00443             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00444             }
00445 
00446         <span class="keywordflow">if</span> ( !Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o26">HasTerminated</a> ) {
00447             Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o26">HasTerminated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00448             <a class="code" href="../../d8/d1/psp_8h.html#a69">PspTerminateThreadByPointer</a>(Thread, Status);
00449             <a class="code" href="../../d9/d1/thredobj_8c.html#a8">KeForceResumeThread</a>(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>);
00450             }
00451         Next = Next-&gt;Flink;
00452         }
00453 
00454     <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
00455 
00456     <span class="keywordflow">return</span> STATUS_SUCCESS;
00457 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a69" doxytag="psp.h::PspTerminateThreadByPointer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PspTerminateThreadByPointer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN NTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>ExitStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00160">160</a> of file <a class="el" href="../../d9/d9/psdelete_8c-source.html">psdelete.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00039">KeInitializeApc()</a>, <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00217">KeInsertQueueApc()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d4/d9/ke_8h.html#a403a181">OriginalApcEnvironment</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00603">PsExitSpecialApc()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00631">PspExitNormalApc()</a>, and <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00690">PspExitThread()</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00227">NtTerminateProcess()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00461">NtTerminateThread()</a>, and <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00384">PspTerminateProcess()</a>.
<p>
<pre class="fragment"><div>00167                    :
00168 
00169     This function causes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified thread to terminate.
00170 
00171 Arguments:
00172 
00173     <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a> - Supplies a referenced pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread to terminate.
00174 
00175     ExitStatus - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a> status associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread.
00176 
00177 Return Value:
00178 
00179     TBD
00180 
00181 --*/
00182 
00183 {
00184 
00185     <a class="code" href="../../d1/d5/struct__KAPC.html">PKAPC</a> ExitApc;
00186 
00187     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00188 
00189     <span class="keywordflow">if</span> ( Thread == <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>() ) {
00190         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
00191         <a class="code" href="../../d8/d1/psp_8h.html#a68">PspExitThread</a>(ExitStatus);
00192 
00193         <span class="comment">//</span>
00194         <span class="comment">// Never Returns</span>
00195         <span class="comment">//</span>
00196 
00197     } <span class="keywordflow">else</span> {
00198         ExitApc = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(NonPagedPool,(ULONG)<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d5/struct__KAPC.html">KAPC</a>));
00199 
00200         <span class="keywordflow">if</span> ( !ExitApc ) {
00201             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00202         }
00203 
00204         <a class="code" href="../../d5/d7/apcobj_8c.html#a1">KeInitializeApc</a>(
00205             ExitApc,
00206             &amp;Thread-&gt;Tcb,
00207             OriginalApcEnvironment,
00208             PsExitSpecialApc,
00209             NULL,
00210             PspExitNormalApc,
00211             KernelMode,
00212             ULongToPtr(ExitStatus) <span class="comment">// Sundown: ExitStatus is zero-extended.</span>
00213             );
00214 
00215 
00216         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d7/apcobj_8c.html#a3">KeInsertQueueApc</a>(ExitApc,ExitApc,NULL, 2) ) {
00217             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ExitApc);
00218 
00219             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00220         }
00221     }
00222 
00223     <span class="keywordflow">return</span> STATUS_SUCCESS;
00224 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a54" doxytag="psp.h::PspThreadDelete" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspThreadDelete           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Object</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01438">1438</a> of file <a class="el" href="../../d9/d9/psdelete_8c-source.html">psdelete.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00388">_ETHREAD::Cid</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01227">ExDestroyHandle()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00556">_KTHREAD::InitialStack</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00070">KeBugCheck()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00641">_KTHREAD::LargeStack</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l02723">MmDeleteKernelStack()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02216">PERFINFO_THREAD_DELETE</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00037">PspCidTable</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01436">PspDeleteThreadSecurity()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00347">_ETHREAD::Tcb</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00638">THREAD_TO_PROCESS</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00636">_KTHREAD::Win32Thread</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/psinit_8c-source.html#l00181">PspInitPhase0()</a>.
<p>
<pre class="fragment"><div>01441 {
01442     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
01443     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
01444 
01445     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01446 
01447     Thread = (<a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>) Object;
01448 
01449     <a class="code" href="../../d2/d1/mm_8h.html#a95">PERFINFO_THREAD_DELETE</a>(Thread);
01450 
01451     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o47">Win32Thread</a> == NULL);
01452 
01453     <span class="keywordflow">if</span> ( Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o2">InitialStack</a> ) {
01454         <a class="code" href="../../d4/d5/procsup_8c.html#a34">MmDeleteKernelStack</a>(Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o2">InitialStack</a>,(BOOLEAN)Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o52">LargeStack</a>);
01455         }
01456 
01457     <span class="keywordflow">if</span> ( Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueThread ) {
01458         <span class="keywordflow">if</span> (!(<a class="code" href="../../d5/d8/ex_8h.html#a297">ExDestroyHandle</a>(PspCidTable,Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueThread,NULL))) {
01459             <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(CID_HANDLE_DELETION);
01460             }
01461         }
01462 
01463     <a class="code" href="../../d6/d5/ps_2security_8c.html#a14">PspDeleteThreadSecurity</a>( Thread );
01464 
01465     Process = <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>(Thread);
01466     <span class="keywordflow">if</span> (Process) {
01467         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
01468         }
01469 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a51" doxytag="psp.h::PspThreadDump" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspThreadDump           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d5/struct__OBJECT__DUMP__CONTROL.html">POB_DUMP_CONTROL</a> Control&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a64" doxytag="psp.h::PspUserThreadStartup" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspUserThreadStartup           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d9/ke_8h.html#a66">PKSTART_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>StartRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>StartContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01800">1800</a> of file <a class="el" href="../../d3/d7/ps_2create_8c-source.html">ps/create.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l00575">_KTHREAD::ApcState</a>, <a class="el" href="../../d8/d2/dbgkproc_8c-source.html#l00211">DbgkCreateThread()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00431">_ETHREAD::DeadThread</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00086">_SYSTEM_DLL::DllBase</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00434">_ETHREAD::HasTerminated</a>, <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00039">KeInitializeApc()</a>, <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00217">KeInsertQueueApc()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00087">_SYSTEM_DLL::LoaderInitRoutine</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l04948">MmAllowWorkingSetExpansion()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d9/ke_8h.html#a403a181">OriginalApcEnvironment</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00585">PsDefaultThreadLocaleId</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00690">PspExitThread()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00580">PspNullSpecialApc()</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00124">PspSystemDll</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00347">_ETHREAD::Tcb</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00247">_KAPC_STATE::UserApcPending</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00756">_KPROCESS::UserTime</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00262">PspCreateThread()</a>.
<p>
<pre class="fragment"><div>01807                    :
01808 
01809     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel to start a user-mode thread.
01810 
01811 Arguments:
01812 
01813     StartRoutine - Ignored.
01814 
01815     StartContext - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial pc value <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread.
01816 
01817 Return Value:
01818 
01819     None.
01820 
01821 --*/
01822 
01823 {
01824     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
01825     <a class="code" href="../../d1/d5/struct__KAPC.html">PKAPC</a> StartApc;
01826     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
01827 
01828     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01829 
01830     UNREFERENCED_PARAMETER(StartRoutine);
01831 
01832     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
01833 
01834     <span class="comment">//</span>
01835     <span class="comment">// All threads start with an APC at LdrInitializeThunk</span>
01836     <span class="comment">//</span>
01837 
01838     <a class="code" href="../../d4/d5/procsup_8c.html#a43">MmAllowWorkingSetExpansion</a>();
01839 
01840     Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01841 
01842     <span class="keywordflow">if</span> ( !Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o24">DeadThread</a> &amp;&amp; !Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o26">HasTerminated</a> ) {
01843 
01844         StartApc = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(NonPagedPoolMustSucceed,(ULONG)<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d5/struct__KAPC.html">KAPC</a>));
01845 
01846         ((PTEB)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Tcb.Teb)-&gt;CurrentLocale = <a class="code" href="../../d1/d9/ps_8h.html#a59">PsDefaultThreadLocaleId</a>;
01847 
01848         <a class="code" href="../../d5/d7/apcobj_8c.html#a1">KeInitializeApc</a>(
01849             StartApc,
01850             &amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>,
01851             OriginalApcEnvironment,
01852             PspNullSpecialApc,
01853             NULL,
01854             <a class="code" href="../../d0/d1/psinit_8c.html#a30">PspSystemDll</a>.<a class="code" href="../../d0/d8/struct__SYSTEM__DLL.html#o2">LoaderInitRoutine</a>,
01855             UserMode,
01856             NULL
01857             );
01858 
01859         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d7/apcobj_8c.html#a3">KeInsertQueueApc</a>(StartApc,(PVOID) <a class="code" href="../../d0/d1/psinit_8c.html#a30">PspSystemDll</a>.<a class="code" href="../../d0/d8/struct__SYSTEM__DLL.html#o1">DllBase</a>,NULL,0) ) {
01860             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(StartApc);
01861         } <span class="keywordflow">else</span> {
01862             Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o4">UserApcPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01863         }
01864     } <span class="keywordflow">else</span> {
01865 
01866         <span class="keywordflow">if</span> ( !Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o24">DeadThread</a> ) {
01867 
01868             <span class="comment">//</span>
01869             <span class="comment">// If DeadThread is not set, then it means the thread was terminated before</span>
01870             <span class="comment">// it started, but creation was ok. Need to let debuggers see these threads</span>
01871             <span class="comment">// for an instant because if they are the last to exit, the exitprocess</span>
01872             <span class="comment">// message gets nuked</span>
01873             <span class="comment">//</span>
01874 
01875             <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(0);
01876             <a class="code" href="../../d4/d3/dbgk_8h.html#a0">DbgkCreateThread</a>(StartContext);
01877 
01878             }
01879         <a class="code" href="../../d8/d1/psp_8h.html#a68">PspExitThread</a>(STATUS_THREAD_IS_TERMINATING);
01880     }
01881 
01882     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(0);
01883 
01884     <a class="code" href="../../d4/d3/dbgk_8h.html#a0">DbgkCreateThread</a>(StartContext);
01885 
01886     <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o5">UserTime</a> == 0 ) {
01887         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o5">UserTime</a> = 1;
01888     }
01889 
01890 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a32" doxytag="psp.h::PspActiveProcessMutex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="el" href="../../d8/d1/psp_8h.html#a32">PspActiveProcessMutex</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00524">524</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="psp.h::PspBootAccessToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PACCESS_TOKEN <a class="el" href="../../d8/d1/psp_8h.html#a29">PspBootAccessToken</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00521">521</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01117">PspInitializeProcessSecurity()</a>, and <a class="el" href="../../d1/d0/psinit_8c-source.html#l00181">PspInitPhase0()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="psp.h::PspCidTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> <a class="el" href="../../d8/d1/psp_8h.html#a27">PspCidTable</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00519">519</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="psp.h::PspCreateProcessNotifyRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d9/ps_8h.html#a67">PCREATE_PROCESS_NOTIFY_ROUTINE</a> <a class="el" href="../../d8/d1/psp_8h.html#a22">PspCreateProcessNotifyRoutine</a>[PSP_MAX_CREATE_PROCESS_NOTIFY]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00192">192</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00262">PspCreateThread()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01232">PspExitProcess()</a>, and <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01691">PsSetCreateProcessNotifyRoutine()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="psp.h::PspCreateProcessNotifyRoutineCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d8/d1/psp_8h.html#a21">PspCreateProcessNotifyRoutineCount</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00191">191</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00262">PspCreateThread()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01232">PspExitProcess()</a>, and <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01691">PsSetCreateProcessNotifyRoutine()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="psp.h::PspCreateThreadNotifyRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d9/ps_8h.html#a68">PCREATE_THREAD_NOTIFY_ROUTINE</a> <a class="el" href="../../d8/d1/psp_8h.html#a24">PspCreateThreadNotifyRoutine</a>[PSP_MAX_CREATE_THREAD_NOTIFY]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00209">209</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00262">PspCreateThread()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00690">PspExitThread()</a>, and <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01755">PsSetCreateThreadNotifyRoutine()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="psp.h::PspCreateThreadNotifyRoutineCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d8/d1/psp_8h.html#a23">PspCreateThreadNotifyRoutineCount</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00208">208</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00262">PspCreateThread()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00690">PspExitThread()</a>, and <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01755">PsSetCreateThreadNotifyRoutine()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="psp.h::PspDefaultNonPagedLimit" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d8/d1/psp_8h.html#a35">PspDefaultNonPagedLimit</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00528">528</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="psp.h::PspDefaultPagedLimit" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d8/d1/psp_8h.html#a34">PspDefaultPagedLimit</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00527">527</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="psp.h::PspDefaultPagefileLimit" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d8/d1/psp_8h.html#a36">PspDefaultPagefileLimit</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00529">529</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="psp.h::PspDefaultQuotaBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html">EPROCESS_QUOTA_BLOCK</a> <a class="el" href="../../d8/d1/psp_8h.html#a37">PspDefaultQuotaBlock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00531">531</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="psp.h::PspDoingGiveBacks" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d8/d1/psp_8h.html#a38">PspDoingGiveBacks</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00532">532</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/psinit_8c-source.html#l00181">PspInitPhase0()</a>, and <a class="el" href="../../d1/d1/psquota_8c-source.html#l00356">PsReturnPoolQuota()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="psp.h::PspEventPairLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> KSPIN_LOCK <a class="el" href="../../d8/d1/psp_8h.html#a30">PspEventPairLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00522">522</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a44" doxytag="psp.h::PspForegroundQuantum" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> SCHAR <a class="el" href="../../d8/d1/psp_8h.html#a44">PspForegroundQuantum</a>[3]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00539">539</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/psinit_8c-source.html#l00878">PsChangeQuantumTable()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>, and <a class="el" href="../../d0/d1/psquery_8c-source.html#l03916">PsSetProcessPriorityByClass()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="psp.h::PspInitialSystemProcessHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HANDLE <a class="el" href="../../d8/d1/psp_8h.html#a28">PspInitialSystemProcessHandle</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00520">520</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a48" doxytag="psp.h::PspJobList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d8/d1/psp_8h.html#a48">PspJobList</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00549">549</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/psjob_8c-source.html#l00048">NtCreateJobObject()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l02396">PsEnforceExecutionTimeLimits()</a>, and <a class="el" href="../../d1/d0/psinit_8c-source.html#l00181">PspInitPhase0()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a47" doxytag="psp.h::PspJobListLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="el" href="../../d8/d1/psp_8h.html#a47">PspJobListLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00548">548</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/psjob_8c-source.html#l00048">NtCreateJobObject()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l02396">PsEnforceExecutionTimeLimits()</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00181">PspInitPhase0()</a>, and <a class="el" href="../../d2/d0/psjob_8c-source.html#l00636">PspJobDelete()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a45" doxytag="psp.h::PspJobSchedulingClasses" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> SCHAR <a class="el" href="../../d8/d1/psp_8h.html#a45">PspJobSchedulingClasses</a>[PSP_NUMBER_OF_SCHEDULING_CLASSES]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00545">545</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/psinit_8c-source.html#l00878">PsChangeQuantumTable()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l02262">PspApplyJobLimitsToProcess()</a>, and <a class="el" href="../../d0/d1/psquery_8c-source.html#l03916">PsSetProcessPriorityByClass()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="psp.h::PspLoadImageNotifyRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d9/ps_8h.html#a71">PLOAD_IMAGE_NOTIFY_ROUTINE</a> <a class="el" href="../../d8/d1/psp_8h.html#a26">PspLoadImageNotifyRoutine</a>[PSP_MAX_LOAD_IMAGE_NOTIFY]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00214">214</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l02396">PsCallImageNotifyRoutines()</a>, and <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l02344">PsSetLoadImageNotifyRoutine()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="psp.h::PspLoadImageNotifyRoutineCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d8/d1/psp_8h.html#a25">PspLoadImageNotifyRoutineCount</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00213">213</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l02344">PsSetLoadImageNotifyRoutine()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="psp.h::PspProcessLockMutex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="el" href="../../d8/d1/psp_8h.html#a33">PspProcessLockMutex</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00525">525</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01966">PsLockProcess()</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00181">PspInitPhase0()</a>, and <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l02250">PsUnlockProcess()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="psp.h::PspSystemDll" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d8/struct__SYSTEM__DLL.html">SYSTEM_DLL</a> <a class="el" href="../../d8/d1/psp_8h.html#a31">PspSystemDll</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00523">523</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/psinit_8c-source.html#l00525">PsLocateSystemDll()</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00745">PspInitializeSystemDll()</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00827">PspLookupSystemDllEntryPoint()</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00679">PspMapSystemDll()</a>, and <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01800">PspUserThreadStartup()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a46" doxytag="psp.h::PspUseJobSchedulingClasses" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d8/d1/psp_8h.html#a46">PspUseJobSchedulingClasses</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00546">546</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/psinit_8c-source.html#l00878">PsChangeQuantumTable()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l02262">PspApplyJobLimitsToProcess()</a>, and <a class="el" href="../../d0/d1/psquery_8c-source.html#l03916">PsSetProcessPriorityByClass()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a41" doxytag="psp.h::PspW32JobCallout" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d9/ps_8h.html#a78">PKWIN32_JOB_CALLOUT</a> <a class="el" href="../../d9/d1/psquery_8c.html#a9">PspW32JobCallout</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00536">536</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/psjob_8c-source.html#l00266">NtAssignProcessToJobObject()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l01323">NtSetInformationJobObject()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l03855">PsEstablishWin32Callouts()</a>, and <a class="el" href="../../d2/d0/psjob_8c-source.html#l00636">PspJobDelete()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="psp.h::PspW32ProcessCallout" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d9/ps_8h.html#a74">PKWIN32_PROCESS_CALLOUT</a> <a class="el" href="../../d9/d1/psquery_8c.html#a7">PspW32ProcessCallout</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00534">534</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/psquery_8c-source.html#l03964">PsConvertToGuiThread()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l03855">PsEstablishWin32Callouts()</a>, and <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00690">PspExitThread()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a42" doxytag="psp.h::PspW32ProcessSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d8/d1/psp_8h.html#a42">PspW32ProcessSize</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00537">537</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="psp.h::PspW32ThreadCallout" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d9/ps_8h.html#a80">PKWIN32_THREAD_CALLOUT</a> <a class="el" href="../../d9/d1/psquery_8c.html#a8">PspW32ThreadCallout</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00535">535</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/psquery_8c-source.html#l03964">PsConvertToGuiThread()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l03855">PsEstablishWin32Callouts()</a>, and <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00690">PspExitThread()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a43" doxytag="psp.h::PspW32ThreadSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d8/d1/psp_8h.html#a43">PspW32ThreadSize</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00538">538</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="psp.h::PspWorkingSetChangeHead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d7/d4/struct__JOB__WORKING__SET__CHANGE__HEAD.html">JOB_WORKING_SET_CHANGE_HEAD</a> <a class="el" href="../../d8/d1/psp_8h.html#a20">PspWorkingSetChangeHead</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/psp_8h-source.html#l00102">102</a> of file <a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/psjob_8c-source.html#l01323">NtSetInformationJobObject()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l00439">PspAddProcessToJob()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l02210">PspApplyJobLimitsToProcessSet()</a>, and <a class="el" href="../../d1/d0/psinit_8c-source.html#l00181">PspInitPhase0()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:24 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
