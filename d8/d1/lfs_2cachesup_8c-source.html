<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cachesup.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cachesup.c</h1><a href="../../d7/d2/lfs_2cachesup_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    CacheSup.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module provides an interface with the cache manager.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Brian Andrew    [BrianAn]   20-June-1991</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/lfsprocs_8h.html">lfsprocs.h</a>"</span>
00022 
00023 <span class="comment">//</span>
00024 <span class="comment">//  The debug trace level</span>
00025 <span class="comment">//</span>
00026 
<a name="l00027"></a><a class="code" href="../../d7/d2/lfs_2cachesup_8c.html#a0">00027</a> <span class="preprocessor">#define Dbg                             (DEBUG_TRACE_CACHE_SUP)</span>
00028 <span class="preprocessor"></span>
00029 <span class="comment">//</span>
00030 <span class="comment">//  Following is used to generate a sequence number when the cache manager</span>
00031 <span class="comment">//  gives us a page of zeroes.  Otherwise all of the sequence numbers will</span>
00032 <span class="comment">//  be 1.</span>
00033 <span class="comment">//</span>
00034 
<a name="l00035"></a><a class="code" href="../../d7/d2/lfs_2cachesup_8c.html#a1">00035</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d7/d2/lfs_2cachesup_8c.html#a1">LfsUsaSeqNumber</a>;
00036 
00037 BOOLEAN
00038 <a class="code" href="../../d7/d2/lfs_2cachesup_8c.html#a2">LfsIsRestartPageHeaderValid</a> (
00039     IN LONGLONG FileOffset,
00040     IN <a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html">PLFS_RESTART_PAGE_HEADER</a> PageHeader,
00041     OUT PBOOLEAN LogPacked
00042     );
00043 
00044 BOOLEAN
00045 <a class="code" href="../../d7/d2/lfs_2cachesup_8c.html#a3">LfsIsRestartAreaValid</a> (
00046     IN <a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html">PLFS_RESTART_PAGE_HEADER</a> PageHeader,
00047     IN BOOLEAN LogPacked
00048     );
00049 
00050 BOOLEAN
00051 <a class="code" href="../../d7/d2/lfs_2cachesup_8c.html#a4">LfsIsClientAreaValid</a> (
00052     IN <a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html">PLFS_RESTART_PAGE_HEADER</a> PageHeader,
00053     IN BOOLEAN LogPacked,
00054     IN BOOLEAN UsaError
00055     );
00056 
00057 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00058 <a class="code" href="../../d7/d2/lfs_2cachesup_8c.html#a5">LfsFindFirstIo</a> (
00059     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00060     IN <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> TargetLbcb,
00061     IN <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> FirstLbcb,
00062     OUT <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> *NextLbcb,
00063     OUT PLONGLONG FileOffset,
00064     OUT PBOOLEAN ContainsLastEntry,
00065     OUT PBOOLEAN LfsRestart,
00066     OUT PBOOLEAN UseTailCopy,
00067     OUT PULONG IoBlocks
00068     );
00069 
00070 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00071 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, LfsCopyReadLogRecord)</span>
00072 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, LfsFindFirstIo)</span>
00073 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, LfsFlushLfcb)</span>
00074 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, LfsIsClientAreaValid)</span>
00075 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, LfsIsRestartAreaValid)</span>
00076 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, LfsIsRestartPageHeaderValid)</span>
00077 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, LfsPinOrMapData)</span>
00078 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, LfsPinOrMapLogRecordHeader)</span>
00079 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, LfsReadRestart)</span>
00080 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00081 <span class="preprocessor"></span>
00082 
00083 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00084"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a48">00084</a> <a class="code" href="../../d0/d4/lfsprocs_8h.html#a48">LfsPinOrMapData</a> (
00085     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00086     IN LONGLONG FileOffset,
00087     IN ULONG Length,
00088     IN BOOLEAN PinData,
00089     IN BOOLEAN AllowErrors,
00090     IN BOOLEAN IgnoreUsaErrors,
00091     OUT PBOOLEAN UsaError,
00092     OUT PVOID *Buffer,
00093     OUT <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> *Bcb
00094     )
00095 
00096 <span class="comment">/*++</span>
00097 <span class="comment"></span>
00098 <span class="comment">Routine Description:</span>
00099 <span class="comment"></span>
00100 <span class="comment">    This routine will pin or map a portion of the log file.</span>
00101 <span class="comment"></span>
00102 <span class="comment">Arguments:</span>
00103 <span class="comment"></span>
00104 <span class="comment">    Lfcb - This is the file control block for the log file.</span>
00105 <span class="comment"></span>
00106 <span class="comment">    FileOffset - This is the offset of the log page to pin.</span>
00107 <span class="comment"></span>
00108 <span class="comment">    Length - This is the length of the data to access.</span>
00109 <span class="comment"></span>
00110 <span class="comment">    PinData - Boolean indicating if we are to pin or map this data.</span>
00111 <span class="comment"></span>
00112 <span class="comment">    AllowErrors - This boolean indicates whether we should raise on an</span>
00113 <span class="comment">        I/O error or return on an I/O error.</span>
00114 <span class="comment"></span>
00115 <span class="comment">    IgnoreUsaErrors - Boolean indicating whether we will raise on Usa</span>
00116 <span class="comment">        errors.</span>
00117 <span class="comment"></span>
00118 <span class="comment">    UsaError - Address to store whether the Usa had an error.</span>
00119 <span class="comment"></span>
00120 <span class="comment">    Buffer - This is the address to store the address of the data.</span>
00121 <span class="comment"></span>
00122 <span class="comment">    Bcb - This is the Bcb for this operation.</span>
00123 <span class="comment"></span>
00124 <span class="comment">Return Value:</span>
00125 <span class="comment"></span>
00126 <span class="comment">    NTSTATUS - The result of the I/O.</span>
00127 <span class="comment"></span>
00128 <span class="comment">--*/</span>
00129 
00130 {
00131     <span class="keyword">volatile</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00132     ULONG Signature;
00133     BOOLEAN Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00134 
00135     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00136 
00137     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00138 
00139     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsPinReadLogPage:  Entered\n"</span>, 0 );
00140     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Lfcb              -&gt; %08lx\n"</span>, Lfcb );
00141     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FileOffset (Low)  -&gt; %08lx\n"</span>, FileOffset.HighPart );
00142     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FileOffset (High) -&gt; %08lx\n"</span>, FileOffset.LowPart );
00143     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Length            -&gt; %08lx\n"</span>, Length );
00144     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"PinData           -&gt; %04x\n"</span>, PinData );
00145     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"AllowErrors       -&gt; %08x\n"</span>, AllowErrors );
00146     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"IgnoreUsaErrors   -&gt; %04x\n"</span>, IgnoreUsaErrors );
00147 
00148     <span class="comment">//</span>
00149     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00150     <span class="comment">//</span>
00151 
00152     <span class="keywordflow">try</span> {
00153 
00154         <span class="comment">//</span>
00155         <span class="comment">//  Use a try-except to catch cache manager errors.</span>
00156         <span class="comment">//</span>
00157 
00158         <span class="keywordflow">try</span> {
00159 
00160             <span class="comment">//</span>
00161             <span class="comment">//  We call the cache to perform the work.</span>
00162             <span class="comment">//</span>
00163 
00164             <span class="keywordflow">if</span> (PinData) {
00165 
00166                 Result = <a class="code" href="../../d4/d2/cache_8h.html#a87">CcPinRead</a>( Lfcb-&gt;FileObject,
00167                                     (PLARGE_INTEGER)&amp;FileOffset,
00168                                     Length,
00169                                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00170                                     Bcb,
00171                                     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> );
00172 
00173             } <span class="keywordflow">else</span> {
00174 
00175                 Result = <a class="code" href="../../d4/d2/cache_8h.html#a88">CcMapData</a>( Lfcb-&gt;FileObject,
00176                                     (PLARGE_INTEGER)&amp;FileOffset,
00177                                     Length,
00178                                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00179                                     Bcb,
00180                                     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> );
00181             }
00182 
00183             <span class="comment">//</span>
00184             <span class="comment">//  Capture the signature now while we are within the</span>
00185             <span class="comment">//  exception filter.</span>
00186             <span class="comment">//</span>
00187 
00188             Signature = *((PULONG) *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00189 
00190         } except( <a class="code" href="../../d0/d4/lfsprocs_8h.html#a56">LfsExceptionFilter</a>( GetExceptionInformation() )) {
00191 
00192             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00193             <span class="keywordflow">if</span> (Result) {
00194                 <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( *Bcb );
00195                 *Bcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00196             }
00197         }
00198 
00199         *UsaError = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00200 
00201         <span class="comment">//</span>
00202         <span class="comment">//  If an error occurred, we raise the status.</span>
00203         <span class="comment">//</span>
00204 
00205         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00206 
00207             <span class="keywordflow">if</span> (!AllowErrors) {
00208 
00209                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Read on log page failed -&gt; %08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00210                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00211             }
00212 
00213         <span class="comment">//</span>
00214         <span class="comment">//  Check that the update sequence array for this</span>
00215         <span class="comment">//  page is valid.</span>
00216         <span class="comment">//</span>
00217 
00218         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Signature == <a class="code" href="../../d9/d3/lfsdisk_8h.html#a16">LFS_SIGNATURE_BAD_USA_ULONG</a>) {
00219 
00220             <span class="comment">//</span>
00221             <span class="comment">//  If we don't allow errors, raise an error status.</span>
00222             <span class="comment">//</span>
00223 
00224             <span class="keywordflow">if</span> (!IgnoreUsaErrors) {
00225 
00226                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Usa error on log page\n"</span>, 0 );
00227                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_DISK_CORRUPT_ERROR );
00228             }
00229 
00230             *UsaError = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00231         }
00232 
00233     } finally {
00234 
00235         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( <a class="code" href="../../d7/d2/lfs_2cachesup_8c.html#a6">LfsPinOrMapData</a> );
00236 
00237         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Buffer    -&gt; %08lx\n"</span>, *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> );
00238         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Bcb       -&gt; %08lx\n"</span>, *Bcb );
00239 
00240         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsPinOrMapData:  Exit -&gt; %08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00241     }
00242 
00243     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00244 }
00245 
00246 
00247 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00248"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a49">00248</a> <a class="code" href="../../d0/d4/lfsprocs_8h.html#a49">LfsPinOrMapLogRecordHeader</a> (
00249     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00250     IN LSN Lsn,
00251     IN BOOLEAN PinData,
00252     IN BOOLEAN IgnoreUsaErrors,
00253     OUT PBOOLEAN UsaError,
00254     OUT <a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html">PLFS_RECORD_HEADER</a> *RecordHeader,
00255     OUT <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> *Bcb
00256     )
00257 
00258 <span class="comment">/*++</span>
00259 <span class="comment"></span>
00260 <span class="comment">Routine Description:</span>
00261 <span class="comment"></span>
00262 <span class="comment">    This routine will pin or map a log record for read access.</span>
00263 <span class="comment"></span>
00264 <span class="comment">Arguments:</span>
00265 <span class="comment"></span>
00266 <span class="comment">    Lfcb - This is the file control block for the log file.</span>
00267 <span class="comment"></span>
00268 <span class="comment">    Lsn - This is the Lsn whose header should be pinned.</span>
00269 <span class="comment"></span>
00270 <span class="comment">    PinData - Boolean indicating if we are to pin or map this data.</span>
00271 <span class="comment"></span>
00272 <span class="comment">    IgnoreUsaErrors - Boolean indicating whether we will raise on Usa</span>
00273 <span class="comment">        errors.</span>
00274 <span class="comment"></span>
00275 <span class="comment">    UsaError - Address to store whether the Usa had an error.</span>
00276 <span class="comment"></span>
00277 <span class="comment">    RecordHeader - This is the address to store the address of the pinned data.</span>
00278 <span class="comment"></span>
00279 <span class="comment">    Bcb - This is the Bcb for this pin operation.</span>
00280 <span class="comment"></span>
00281 <span class="comment">Return Value:</span>
00282 <span class="comment"></span>
00283 <span class="comment">    None.</span>
00284 <span class="comment"></span>
00285 <span class="comment">--*/</span>
00286 
00287 {
00288     <a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html">PLFS_RECORD_PAGE_HEADER</a> LogPageHeader;
00289     LONGLONG LogPage;
00290     ULONG PageOffset;
00291 
00292     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00293 
00294     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsPinOrMapLogRecordHeader:  Entered\n"</span>, 0 );
00295     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Lfcb       -&gt; %08lx\n"</span>, Lfcb );
00296     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Lsn (Low)  -&gt; %08lx\n"</span>, Lsn.HighPart );
00297     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Lsn (High) -&gt; %08lx\n"</span>, Lsn.LowPart );
00298     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"PinData           -&gt; %04x\n"</span>, PinData );
00299     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"IgnoreUsaErrors   -&gt; %04x\n"</span>, IgnoreUsaErrors );
00300 
00301     <span class="comment">//</span>
00302     <span class="comment">//  Compute the log page and the offset of the log record header</span>
00303     <span class="comment">//  in the log page.</span>
00304     <span class="comment">//</span>
00305 
00306     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a11">LfsTruncateLsnToLogPage</a>( Lfcb, Lsn, &amp;LogPage );
00307     PageOffset = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a14">LfsLsnToPageOffset</a>( Lfcb, Lsn );
00308 
00309     <span class="comment">//</span>
00310     <span class="comment">//  Call the cache manager to pin the page.</span>
00311     <span class="comment">//</span>
00312 
00313     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a48">LfsPinOrMapData</a>( Lfcb,
00314                      LogPage,
00315                      (ULONG)Lfcb-&gt;LogPageSize,
00316                      PinData,
00317                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00318                      IgnoreUsaErrors,
00319                      UsaError,
00320                      (PVOID *) &amp;LogPageHeader,
00321                      Bcb );
00322 
00323     <span class="comment">//</span>
00324     <span class="comment">//  The actual offset we need is at PageOffset from the start of the page.</span>
00325     <span class="comment">//</span>
00326 
00327     *RecordHeader = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( LogPageHeader, PageOffset, <a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html">PLFS_RECORD_HEADER</a> );
00328 
00329     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Record Header -&gt; %08lx\n"</span>, *RecordHeader );
00330     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Bcb           -&gt; %08lx\n"</span>, *Bcb );
00331 
00332     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsPinOrMapLogRecordHeader:  Exit\n"</span>, 0 );
00333 
00334     <span class="keywordflow">return</span>;
00335 }
00336 
00337 
00338 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00339"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a50">00339</a> <a class="code" href="../../d0/d4/lfsprocs_8h.html#a50">LfsCopyReadLogRecord</a> (
00340     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00341     IN <a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html">PLFS_RECORD_HEADER</a> RecordHeader,
00342     OUT PVOID Buffer
00343     )
00344 
00345 <span class="comment">/*++</span>
00346 <span class="comment"></span>
00347 <span class="comment">Routine Description:</span>
00348 <span class="comment"></span>
00349 <span class="comment">    This routines copies a log record from the file to a buffer.  The log</span>
00350 <span class="comment">    record may span several log pages and may even wrap in the file.</span>
00351 <span class="comment"></span>
00352 <span class="comment">Arguments:</span>
00353 <span class="comment"></span>
00354 <span class="comment">    Lfcb - A pointer to the control block for the log file.</span>
00355 <span class="comment"></span>
00356 <span class="comment">    RecordHeader - Pointer to the log record header for this log record.</span>
00357 <span class="comment"></span>
00358 <span class="comment">    Buffer - Pointer to the buffer to store the log record.</span>
00359 <span class="comment"></span>
00360 <span class="comment">Return Value:</span>
00361 <span class="comment"></span>
00362 <span class="comment">    None.</span>
00363 <span class="comment"></span>
00364 <span class="comment">--*/</span>
00365 
00366 {
00367     <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> Bcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00368     BOOLEAN UsaError;
00369 
00370     <a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html">PLFS_RECORD_PAGE_HEADER</a> PageHeader;
00371 
00372     LONGLONG LogPageFileOffset;
00373     ULONG LogPageOffset;
00374 
00375     ULONG RemainingTransferBytes;
00376 
00377     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00378 
00379     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsCopyReadLogRecord:  Entered\n"</span>, 0 );
00380     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Lfcb           -&gt; %08lx\n"</span>, Lfcb );
00381     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"RecordHeader   -&gt; %08lx\n"</span>, RecordHeader );
00382     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Buffer         -&gt; %08lx\n"</span>, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> );
00383 
00384     <span class="comment">//</span>
00385     <span class="comment">//  We find the file offset of the log page containing the start of</span>
00386     <span class="comment">//  this log record, the offset within the page to start the transfer from,</span>
00387     <span class="comment">//  the number of bytes to transfer on this page and the starting</span>
00388     <span class="comment">//  position in the buffer to begin the transfer to.</span>
00389     <span class="comment">//</span>
00390 
00391     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a11">LfsTruncateLsnToLogPage</a>( Lfcb, RecordHeader-&gt;ThisLsn, &amp;LogPageFileOffset );
00392     LogPageOffset = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a14">LfsLsnToPageOffset</a>( Lfcb, RecordHeader-&gt;ThisLsn ) + Lfcb-&gt;RecordHeaderLength;
00393 
00394     RemainingTransferBytes = RecordHeader-&gt;ClientDataLength;
00395 
00396     <span class="comment">//</span>
00397     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00398     <span class="comment">//</span>
00399 
00400     <span class="keywordflow">try</span> {
00401 
00402         <span class="comment">//</span>
00403         <span class="comment">//  While there are more bytes to transfer, we continue to attempt to</span>
00404         <span class="comment">//  perform the read.</span>
00405         <span class="comment">//</span>
00406 
00407         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00408 
00409             ULONG RemainingPageBytes;
00410 
00411             BOOLEAN Wrapped;
00412 
00413             RemainingPageBytes = (ULONG)Lfcb-&gt;LogPageSize - LogPageOffset;
00414 
00415             <span class="comment">//</span>
00416             <span class="comment">//  We compute the number of bytes to read from this log page and</span>
00417             <span class="comment">//  call the cache package to perform the transfer.</span>
00418             <span class="comment">//</span>
00419 
00420             <span class="keywordflow">if</span> (RemainingTransferBytes &lt;= RemainingPageBytes) {
00421 
00422                 RemainingPageBytes = RemainingTransferBytes;
00423             }
00424 
00425             RemainingTransferBytes -= RemainingPageBytes;
00426 
00427             <span class="comment">//</span>
00428             <span class="comment">//  Unpin any previous buffer.</span>
00429             <span class="comment">//</span>
00430 
00431             <span class="keywordflow">if</span> (Bcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00432 
00433                 <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( Bcb );
00434                 Bcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00435             }
00436 
00437             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a48">LfsPinOrMapData</a>( Lfcb,
00438                              LogPageFileOffset,
00439                              (ULONG)Lfcb-&gt;LogPageSize,
00440                              <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00441                              <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00442                              <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00443                              &amp;UsaError,
00444                              (PVOID *) &amp;PageHeader,
00445                              &amp;Bcb );
00446 
00447             <span class="comment">//</span>
00448             <span class="comment">//  The last Lsn on this page better be greater or equal to the Lsn we</span>
00449             <span class="comment">//  are copying.</span>
00450             <span class="comment">//</span>
00451 
00452             <span class="keywordflow">if</span> ( PageHeader-&gt;Copy.LastLsn.QuadPart &lt; RecordHeader-&gt;ThisLsn.QuadPart ) {
00453 
00454                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_DISK_CORRUPT_ERROR );
00455             }
00456 
00457             RtlCopyMemory( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00458                            <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( PageHeader, LogPageOffset, PVOID ),
00459                            RemainingPageBytes );
00460 
00461             <span class="comment">//</span>
00462             <span class="comment">//  If there are no more bytes to transfer, we exit the loop.</span>
00463             <span class="comment">//</span>
00464 
00465             <span class="keywordflow">if</span> (RemainingTransferBytes == 0) {
00466 
00467                 <span class="comment">//</span>
00468                 <span class="comment">//  Our log record better not span this page.</span>
00469                 <span class="comment">//</span>
00470 
00471                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( PageHeader-&gt;Flags, <a class="code" href="../../d9/d3/lfsdisk_8h.html#a7">LOG_PAGE_LOG_RECORD_END</a> )
00472 
00473                     || (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a8">LFCB_PACK_LOG</a> )
00474                         &amp;&amp; ( RecordHeader-&gt;ThisLsn.QuadPart &gt; PageHeader-&gt;Header.Packed.LastEndLsn.QuadPart ))) {
00475 
00476                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_DISK_CORRUPT_ERROR );
00477                 }
00478 
00479                 <span class="keywordflow">break</span>;
00480             }
00481 
00482             <span class="comment">//</span>
00483             <span class="comment">//  If the page header indicates that the log record ended on this page,</span>
00484             <span class="comment">//  this is a disk corrupt condition.  For a packed page it means</span>
00485             <span class="comment">//  that the last Lsn and the last Ending Lsn are the same.</span>
00486             <span class="comment">//</span>
00487 
00488             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a8">LFCB_PACK_LOG</a> )) {
00489 
00490                 <span class="comment">//</span>
00491                 <span class="comment">//  If there is no spanning log record this is an error.</span>
00492                 <span class="comment">//</span>
00493 
00494                 <span class="keywordflow">if</span> (( PageHeader-&gt;Copy.LastLsn.QuadPart == PageHeader-&gt;Header.Packed.LastEndLsn.QuadPart )
00495 
00496                     || ( RecordHeader-&gt;ThisLsn.QuadPart &gt; PageHeader-&gt;Copy.LastLsn.QuadPart )) {
00497 
00498                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_DISK_CORRUPT_ERROR );
00499                 }
00500 
00501             <span class="comment">//</span>
00502             <span class="comment">//  For an unpacked page it simply means that the page</span>
00503             <span class="comment">//  contains the end of a log record.</span>
00504             <span class="comment">//</span>
00505 
00506             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( PageHeader-&gt;Flags, <a class="code" href="../../d9/d3/lfsdisk_8h.html#a7">LOG_PAGE_LOG_RECORD_END</a> )) {
00507 
00508                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_DISK_CORRUPT_ERROR );
00509             }
00510 
00511             <span class="comment">//</span>
00512             <span class="comment">//  We find the start of the next log page and the offset within</span>
00513             <span class="comment">//  that page to start transferring bytes.</span>
00514             <span class="comment">//</span>
00515 
00516             <a class="code" href="../../d6/d5/logpgsup_8c.html#a2">LfsNextLogPageOffset</a>( Lfcb,
00517                                   LogPageFileOffset,
00518                                   &amp;LogPageFileOffset,
00519                                   &amp;Wrapped );
00520 
00521             LogPageOffset = (ULONG)Lfcb-&gt;LogPageDataOffset;
00522 
00523             <span class="comment">//</span>
00524             <span class="comment">//  We also adjust our pointer in the user's buffer to transfer</span>
00525             <span class="comment">//  the next block to.</span>
00526             <span class="comment">//</span>
00527 
00528             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, RemainingPageBytes, PVOID );
00529         }
00530 
00531     } finally {
00532 
00533         <span class="comment">//</span>
00534         <span class="comment">//  Unpin any previous buffer.</span>
00535         <span class="comment">//</span>
00536 
00537         <span class="keywordflow">if</span> (Bcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00538 
00539             <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( Bcb );
00540             Bcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00541         }
00542 
00543         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsCopyReadLogRecord:  Exit\n"</span>, 0 );
00544     }
00545 
00546     <span class="keywordflow">return</span>;
00547 }
00548 
00549 
00550 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00551"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a51">00551</a> <a class="code" href="../../d0/d4/lfsprocs_8h.html#a51">LfsFlushLfcb</a> (
00552     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00553     IN <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> Lbcb
00554     )
00555 
00556 <span class="comment">/*++</span>
00557 <span class="comment"></span>
00558 <span class="comment">Routine Description:</span>
00559 <span class="comment"></span>
00560 <span class="comment">    This routine is called to flush the current Lbcbs in on the Lfcb</span>
00561 <span class="comment">    work queue.  It will flush up to the I/O which contains the desired</span>
00562 <span class="comment">    Lbcb.</span>
00563 <span class="comment"></span>
00564 <span class="comment">Arguments:</span>
00565 <span class="comment"></span>
00566 <span class="comment">    Lfcb - This is the file control block for the log file.</span>
00567 <span class="comment"></span>
00568 <span class="comment">    Lbcb - This is the block which is needed to be flushed to disk.</span>
00569 <span class="comment"></span>
00570 <span class="comment">Return Value:</span>
00571 <span class="comment"></span>
00572 <span class="comment">    None.</span>
00573 <span class="comment"></span>
00574 <span class="comment">--*/</span>
00575 
00576 {
00577     <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> FirstLbcb;
00578     <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> ThisLbcb;
00579     <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> NextLbcb;
00580 
00581     <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> TargetLbcb;
00582     PULONG Signature;
00583 
00584     LONGLONG FileOffset;
00585     ULONG Length;
00586 
00587     BOOLEAN RaiseCorrupt = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00588     BOOLEAN ValidLastLsn = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00589 
00590     BOOLEAN ContainsLastEntry = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00591     BOOLEAN LfsRestart;
00592     BOOLEAN UseTailCopy;
00593 
00594     ULONG IoBlocks;
00595     ULONG NewLfcbFlags = 0;
00596 
00597     <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> MapPageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00598     PVOID MapPage;
00599 
00600     <a class="code" href="../../d6/d3/lfs_8h.html#a10">LSN</a> LastLsn;
00601 
00602     IO_STATUS_BLOCK Iosb;
00603 
00604     <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> PageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00605 
00606     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00607 
00608     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsFlushLfcb:  Entered\n"</span>, 0 );
00609     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Lfcb          -&gt; %08lx\n"</span>, Lfcb );
00610 
00611     <span class="comment">//</span>
00612     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00613     <span class="comment">//</span>
00614 
00615     <span class="keywordflow">try</span> {
00616 
00617         <span class="comment">//</span>
00618         <span class="comment">//  If there are no elements on the list, we are done.</span>
00619         <span class="comment">//</span>
00620 
00621         <span class="keywordflow">if</span> (IsListEmpty( &amp;Lfcb-&gt;LbcbWorkque )) {
00622 
00623             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( NOTHING );
00624         }
00625 
00626         <span class="comment">//</span>
00627         <span class="comment">//  Mark the Lfcb as Io in progress.</span>
00628         <span class="comment">//</span>
00629 
00630         Lfcb-&gt;LfsIoState = <a class="code" href="../../d1/d4/lfsstruc_8h.html#a40a39">LfsClientThreadIo</a>;
00631 <span class="preprocessor">#ifdef BRIANDBG</span>
00632 <span class="preprocessor"></span>        Lfcb-&gt;LfsIoThread = <a class="code" href="../../d5/d8/ex_8h.html#a67">ExGetCurrentResourceThread</a>();
00633 <span class="preprocessor">#endif</span>
00634 <span class="preprocessor"></span>
00635         <span class="comment">//</span>
00636         <span class="comment">//  Remember the first Lbcb in the list.</span>
00637         <span class="comment">//</span>
00638 
00639         FirstLbcb = CONTAINING_RECORD( Lfcb-&gt;LbcbWorkque.Flink,
00640                                        <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
00641                                        WorkqueLinks );
00642 
00643         <span class="comment">//</span>
00644         <span class="comment">//  We continue looping and performing I/o for as long as possible.</span>
00645         <span class="comment">//</span>
00646 
00647         <span class="keywordflow">while</span> (!ContainsLastEntry) {
00648 
00649             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Lfcb-&gt;PageToDirty == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00650 
00651             <span class="comment">//</span>
00652             <span class="comment">//  Reset the notify event for all of the waiting threads.</span>
00653             <span class="comment">//</span>
00654 
00655             <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>( &amp;Lfcb-&gt;Sync-&gt;Event );
00656 
00657             <span class="comment">//</span>
00658             <span class="comment">//  Find the block of Lbcb's that make up the first I/O, remembering</span>
00659             <span class="comment">//  how many there are.  Also remember if this I/O contains the</span>
00660             <span class="comment">//  last element on the list when we were called.</span>
00661             <span class="comment">//</span>
00662 
00663             <a class="code" href="../../d7/d2/lfs_2cachesup_8c.html#a5">LfsFindFirstIo</a>( Lfcb,
00664                             Lbcb,
00665                             FirstLbcb,
00666                             &amp;NextLbcb,
00667                             &amp;FileOffset,
00668                             &amp;ContainsLastEntry,
00669                             &amp;LfsRestart,
00670                             &amp;UseTailCopy,
00671                             &amp;IoBlocks );
00672 
00673             Length = IoBlocks * (ULONG) Lfcb-&gt;LogPageSize;
00674             <span class="keywordflow">if</span> (UseTailCopy) {
00675 
00676                 TargetLbcb = Lfcb-&gt;ActiveTail;
00677                 Lfcb-&gt;ActiveTail = Lfcb-&gt;PrevTail;
00678                 Lfcb-&gt;PrevTail = TargetLbcb;
00679 
00680                 FileOffset = TargetLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o4">FileOffset</a>;
00681 
00682             } <span class="keywordflow">else</span> {
00683 
00684                 TargetLbcb = FirstLbcb;
00685             }
00686 
00687             <span class="comment">//</span>
00688             <span class="comment">//  Give up the Lfcb unless we are looking at an active page.</span>
00689             <span class="comment">//</span>
00690 
00691             <span class="keywordflow">if</span> (!UseTailCopy) {
00692 
00693                 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a29">LfsReleaseLfcb</a>( Lfcb );
00694             }
00695 
00696             <span class="comment">//</span>
00697             <span class="comment">//  If this I/O involves the Lfs restart area, write it to the</span>
00698             <span class="comment">//  cache pages.</span>
00699             <span class="comment">//</span>
00700 
00701             <span class="keywordflow">if</span> (LfsRestart) {
00702 
00703                 <a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html">PLFS_RESTART_PAGE_HEADER</a> RestartPage;
00704                 BOOLEAN UsaError;
00705                 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00706 
00707                 <span class="comment">//</span>
00708                 <span class="comment">//  If there was some error in initially reading the restart page then</span>
00709                 <span class="comment">//  it is OK to settle for a page of zeroes.</span>
00710                 <span class="comment">//</span>
00711 
00712                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a13">LFCB_READ_FIRST_RESTART</a> | <a class="code" href="../../d1/d4/lfsstruc_8h.html#a14">LFCB_READ_SECOND_RESTART</a> ) &amp;&amp;
00713                     ((FileOffset == 0) ?
00714                      <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a13">LFCB_READ_FIRST_RESTART</a> ) :
00715                      <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a14">LFCB_READ_SECOND_RESTART</a> ))) {
00716 
00717                     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a5">LfsPreparePinWriteData</a>( Lfcb,
00718                                             FileOffset,
00719                                             (ULONG) Lfcb-&gt;SystemPageSize,
00720                                             &amp;RestartPage,
00721                                             &amp;PageBcb );
00722 
00723                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00724 
00725                     <span class="keywordflow">if</span> (FileOffset == 0) {
00726 
00727                         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( NewLfcbFlags, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a13">LFCB_READ_FIRST_RESTART</a> );
00728 
00729                     } <span class="keywordflow">else</span> {
00730 
00731                         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( NewLfcbFlags, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a14">LFCB_READ_SECOND_RESTART</a> );
00732                     }
00733 
00734                 } <span class="keywordflow">else</span> {
00735 
00736                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a48">LfsPinOrMapData</a>( Lfcb,
00737                                               FileOffset,
00738                                               (ULONG)Lfcb-&gt;SystemPageSize,
00739                                               <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00740                                               <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00741                                               <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00742                                               &amp;UsaError,
00743                                               &amp;RestartPage,
00744                                               &amp;PageBcb );
00745                 }
00746 
00747                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00748 
00749                     <span class="comment">//</span>
00750                     <span class="comment">//  Initialize the restart page header.</span>
00751                     <span class="comment">//</span>
00752 
00753                     Signature = (PULONG) &amp;RestartPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o0">MultiSectorHeader</a>.<a class="code" href="../../d2/d1/struct__MULTI__SECTOR__HEADER.html#o0">Signature</a>;
00754 
00755                     *Signature = <a class="code" href="../../d9/d3/lfsdisk_8h.html#a12">LFS_SIGNATURE_RESTART_PAGE_ULONG</a>;
00756                     RestartPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o1">ChkDskLsn</a> = <a class="code" href="../../d7/d3/lfsdata_8c.html#a2">LfsLi0</a>;
00757 
00758                     RestartPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o0">MultiSectorHeader</a>.<a class="code" href="../../d2/d1/struct__MULTI__SECTOR__HEADER.html#o1">UpdateSequenceArrayOffset</a>
00759                                                         = Lfcb-&gt;RestartUsaOffset;
00760 
00761                     RestartPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o0">MultiSectorHeader</a>.<a class="code" href="../../d2/d1/struct__MULTI__SECTOR__HEADER.html#o2">UpdateSequenceArraySize</a>
00762                                                         = Lfcb-&gt;RestartUsaArraySize;
00763 
00764                     RestartPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o2">SystemPageSize</a> = (ULONG)Lfcb-&gt;SystemPageSize;
00765                     RestartPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o3">LogPageSize</a> = (ULONG)Lfcb-&gt;LogPageSize;
00766 
00767                     RestartPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o4">RestartOffset</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) Lfcb-&gt;RestartDataOffset;
00768                     RestartPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o6">MajorVersion</a> = Lfcb-&gt;MajorVersion;
00769                     RestartPage-&gt;<a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html#o5">MinorVersion</a> = Lfcb-&gt;MinorVersion;
00770 
00771                     <span class="comment">//</span>
00772                     <span class="comment">//  If the Lfcb indicates that the file has wrapped, then clear the</span>
00773                     <span class="comment">//  first pass flag in the restart area.</span>
00774                     <span class="comment">//</span>
00775 
00776                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a5">LFCB_LOG_WRAPPED</a> )) {
00777 
00778                         <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( ((<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a>) FirstLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o8">PageHeader</a>)-&gt;Flags, <a class="code" href="../../d9/d3/lfsdisk_8h.html#a23">RESTART_SINGLE_PAGE_IO</a> );
00779                         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Lfcb-&gt;Flags, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a6">LFCB_MULTIPLE_PAGE_IO</a> );
00780                     }
00781 
00782                     <span class="comment">//</span>
00783                     <span class="comment">//  Write the page header into the page and mark the page dirty.</span>
00784                     <span class="comment">//</span>
00785 
00786                     RtlCopyMemory( <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( RestartPage, Lfcb-&gt;RestartDataOffset, PVOID ),
00787                                    FirstLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o8">PageHeader</a>,
00788                                    (ULONG)FirstLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o5">Length</a> );
00789 
00790                     <span class="comment">//</span>
00791                     <span class="comment">//  Make sure the modified bit gets set in the pfn database.  The</span>
00792                     <span class="comment">//  cache manager should do this even for files we told him not to</span>
00793                     <span class="comment">//  lazy write.</span>
00794                     <span class="comment">//</span>
00795 
00796                     <a class="code" href="../../d4/d2/cache_8h.html#a91">CcSetDirtyPinnedData</a>( PageBcb, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00797 
00798                     <span class="comment">//</span>
00799                     <span class="comment">//  We unpin any buffers pinned on this page.</span>
00800                     <span class="comment">//</span>
00801 
00802                     <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( PageBcb );
00803                     PageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00804 
00805                     LastLsn = FirstLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o10">LastLsn</a>;
00806                     ValidLastLsn = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00807 
00808                     <span class="comment">//</span>
00809                     <span class="comment">//  Use a system page size as the length we need to flush.</span>
00810                     <span class="comment">//</span>
00811 
00812                     Length = (ULONG)Lfcb-&gt;SystemPageSize;
00813 
00814                 } <span class="keywordflow">else</span> {
00815 
00816                     RaiseCorrupt = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00817                 }
00818 
00819             <span class="comment">//</span>
00820             <span class="comment">//  Otherwise these are log record pages</span>
00821             <span class="comment">//</span>
00822 
00823             } <span class="keywordflow">else</span> {
00824 
00825                 <a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html">PLFS_RECORD_PAGE_HEADER</a> RecordPageHeader;
00826 
00827                 ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00828 
00829                 <span class="comment">//</span>
00830                 <span class="comment">//  Mark the last Lsn fields for the page headers and each</span>
00831                 <span class="comment">//  page's position in the transfer.  Also unpin all of the</span>
00832                 <span class="comment">//  log pages.</span>
00833                 <span class="comment">//</span>
00834 
00835                 <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 1;
00836 
00837                 ThisLbcb = FirstLbcb;
00838 
00839                 <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00840 
00841                     <span class="comment">//</span>
00842                     <span class="comment">//  If we have to use the tail copy, then pin a page to use.</span>
00843                     <span class="comment">//</span>
00844 
00845                     <span class="keywordflow">if</span> (UseTailCopy) {
00846 
00847                         BOOLEAN UsaError;
00848 
00849                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d4/lfsprocs_8h.html#a48">LfsPinOrMapData</a>( Lfcb,
00850                                                           TargetLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o4">FileOffset</a>,
00851                                                           (ULONG)Lfcb-&gt;LogPageSize,
00852                                                           <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00853                                                           <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00854                                                           <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00855                                                           &amp;UsaError,
00856                                                           &amp;RecordPageHeader,
00857                                                           &amp;PageBcb ))) {
00858 
00859                             RaiseCorrupt = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00860                             <span class="keywordflow">break</span>;
00861                         }
00862 
00863                     } <span class="keywordflow">else</span> {
00864 
00865                         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a> SeqNumber;
00866 
00867                         RecordPageHeader = (<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html">PLFS_RECORD_PAGE_HEADER</a>) ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o8">PageHeader</a>;
00868 
00869                         <span class="comment">//</span>
00870                         <span class="comment">//  If the sequence number is zero then this is probably a</span>
00871                         <span class="comment">//  page of zeroes produced by the cache manager.  In order</span>
00872                         <span class="comment">//  to insure that we don't have the same sequence number</span>
00873                         <span class="comment">//  on each page we will seed the sequence number.</span>
00874                         <span class="comment">//</span>
00875 
00876                         SeqNumber = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( RecordPageHeader,
00877                                              Lfcb-&gt;LogRecordUsaOffset,
00878                                              <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a> );
00879 
00880                         <span class="keywordflow">if</span> (*SeqNumber == 0) {
00881 
00882                             *SeqNumber = <a class="code" href="../../d7/d2/lfs_2cachesup_8c.html#a1">LfsUsaSeqNumber</a>;
00883                             <a class="code" href="../../d7/d2/lfs_2cachesup_8c.html#a1">LfsUsaSeqNumber</a> += 1;
00884                         }
00885                     }
00886 
00887                     <span class="comment">//</span>
00888                     <span class="comment">//  Make sure the modified bit gets set in the pfn database.  The</span>
00889                     <span class="comment">//  cache manager should do this even for files we told him not to</span>
00890                     <span class="comment">//  lazy write.</span>
00891                     <span class="comment">//</span>
00892 
00893                     <span class="keywordflow">if</span> (UseTailCopy) {
00894 
00895                         <span class="comment">//</span>
00896                         <span class="comment">//  Store the file offset of the real page in the header.</span>
00897                         <span class="comment">//  Also set the flag indicating the page is a tail copy.</span>
00898                         <span class="comment">//</span>
00899 
00900                         RtlCopyMemory( RecordPageHeader,
00901                                        ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o8">PageHeader</a>,
00902                                        (ULONG)Lfcb-&gt;LogPageSize );
00903 
00904                         RecordPageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o3">Copy</a>.FileOffset = ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o4">FileOffset</a>;
00905                     }
00906 
00907                     <span class="comment">//</span>
00908                     <span class="comment">//  We update all of fields as yet not updated.</span>
00909                     <span class="comment">//</span>
00910 
00911                     RecordPageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o6">PagePosition</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00912                     RecordPageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o5">PageCount</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) IoBlocks;
00913 
00914                     <span class="comment">//</span>
00915                     <span class="comment">//  We set up the update sequence array for this structure.</span>
00916                     <span class="comment">//</span>
00917 
00918                     Signature = (PULONG) &amp;RecordPageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o0">MultiSectorHeader</a>.<a class="code" href="../../d2/d1/struct__MULTI__SECTOR__HEADER.html#o0">Signature</a>;
00919                     *Signature = <a class="code" href="../../d9/d3/lfsdisk_8h.html#a14">LFS_SIGNATURE_RECORD_PAGE_ULONG</a>;
00920 
00921                     RecordPageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o0">MultiSectorHeader</a>.<a class="code" href="../../d2/d1/struct__MULTI__SECTOR__HEADER.html#o1">UpdateSequenceArrayOffset</a>
00922                                                         = Lfcb-&gt;LogRecordUsaOffset;
00923 
00924                     RecordPageHeader-&gt;<a class="code" href="../../d9/d0/struct__LFS__RECORD__PAGE__HEADER.html#o0">MultiSectorHeader</a>.<a class="code" href="../../d2/d1/struct__MULTI__SECTOR__HEADER.html#o2">UpdateSequenceArraySize</a>
00925                                                         = Lfcb-&gt;LogRecordUsaArraySize;
00926 
00927                     <span class="comment">//</span>
00928                     <span class="comment">//  Make sure the modified bit gets set in the pfn database.  The</span>
00929                     <span class="comment">//  cache manager should do this even for files we told him not to</span>
00930                     <span class="comment">//  lazy write.</span>
00931                     <span class="comment">//</span>
00932 
00933                     <span class="keywordflow">if</span> (UseTailCopy) {
00934 
00935                         <a class="code" href="../../d4/d2/cache_8h.html#a91">CcSetDirtyPinnedData</a>( PageBcb, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00936 
00937                         <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( PageBcb );
00938                         PageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00939 
00940                     } <span class="keywordflow">else</span> {
00941 
00942                         <a class="code" href="../../d4/d2/cache_8h.html#a91">CcSetDirtyPinnedData</a>( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o9">LogPageBcb</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00943 
00944                         <span class="comment">//</span>
00945                         <span class="comment">//  We unpin any buffers pinned on this page.</span>
00946                         <span class="comment">//</span>
00947 
00948                         <a class="code" href="../../d4/d2/cache_8h.html#a94">CcUnpinDataForThread</a>( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o9">LogPageBcb</a>, ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o14">ResourceThread</a> );
00949                     }
00950 
00951                     <span class="comment">//</span>
00952                     <span class="comment">//  Remember the last lsn and its length if this is the final</span>
00953                     <span class="comment">//  page of an Lsn.</span>
00954                     <span class="comment">//</span>
00955 
00956                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o12">Flags</a>, <a class="code" href="../../d9/d3/lfsdisk_8h.html#a7">LOG_PAGE_LOG_RECORD_END</a> )) {
00957 
00958                         LastLsn = ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o11">LastEndLsn</a>;
00959                         ValidLastLsn = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00960                     }
00961 
00962                     <span class="comment">//</span>
00963                     <span class="comment">//  Exit the loop if this is the last block.</span>
00964                     <span class="comment">//</span>
00965 
00966                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> == IoBlocks) {
00967 
00968                         <span class="keywordflow">break</span>;
00969                     }
00970 
00971                     <span class="comment">//</span>
00972                     <span class="comment">//  Otherwise move to the next entry.</span>
00973                     <span class="comment">//</span>
00974 
00975                     ThisLbcb = CONTAINING_RECORD( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o2">WorkqueLinks</a>.Flink,
00976                                                   <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
00977                                                   WorkqueLinks );
00978 
00979                     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> += 1;
00980                 }
00981             }
00982 
00983             <span class="comment">//</span>
00984             <span class="comment">//  Remember the range we are flushing and find the second half of a page</span>
00985             <span class="comment">//  if necessary.</span>
00986             <span class="comment">//</span>
00987 
00988             Lfcb-&gt;UserWriteData-&gt;FileOffset = FileOffset;
00989             Lfcb-&gt;UserWriteData-&gt;Length = Length;
00990 
00991             <span class="keywordflow">if</span> (!UseTailCopy &amp;&amp; !LfsRestart) {
00992 
00993                 <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> TailLbcb;
00994                 PLIST_ENTRY Links;
00995                 LONGLONG NextOffset;
00996 
00997                 <span class="comment">//</span>
00998                 <span class="comment">//  We are flushing log records.  If the current request does not end on</span>
00999                 <span class="comment">//  a system page boundary then check if there is another page in</span>
01000                 <span class="comment">//  memory that we are concerned with.</span>
01001                 <span class="comment">//</span>
01002 
01003                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( (ULONG)(FileOffset + Length), (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1) )) {
01004 
01005                     NextOffset = FileOffset + Length;
01006 
01007                     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a28">LfsAcquireLfcb</a>( Lfcb );
01008 
01009                     <span class="comment">//</span>
01010                     <span class="comment">//  Start by looking through the Lbcbs on the active queue.</span>
01011                     <span class="comment">//</span>
01012 
01013                     Links = Lfcb-&gt;LbcbActive.Flink;
01014 
01015                     <span class="keywordflow">while</span> (Links != &amp;Lfcb-&gt;LbcbActive) {
01016 
01017                         TailLbcb = CONTAINING_RECORD( Links,
01018                                                       <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
01019                                                       ActiveLinks );
01020 
01021                         <span class="keywordflow">if</span> (TailLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o4">FileOffset</a> == NextOffset) {
01022 
01023                             Lfcb-&gt;PageToDirty = TailLbcb;
01024                             <span class="keywordflow">break</span>;
01025                         }
01026 
01027                         Links = Links-&gt;Flink;
01028                     }
01029 
01030                     <span class="comment">//</span>
01031                     <span class="comment">//  If we didn't find it then scan to the end of the workque.</span>
01032                     <span class="comment">//</span>
01033 
01034                     <span class="keywordflow">if</span> (Lfcb-&gt;PageToDirty == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01035 
01036                         Links = Lfcb-&gt;LbcbWorkque.Flink;
01037 
01038                         <span class="keywordflow">while</span> (Links != &amp;Lfcb-&gt;LbcbWorkque) {
01039     
01040                             TailLbcb = CONTAINING_RECORD( Links,
01041                                                           <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
01042                                                           WorkqueLinks );
01043     
01044                             <span class="keywordflow">if</span> (TailLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o4">FileOffset</a> == NextOffset) {
01045     
01046                                 Lfcb-&gt;PageToDirty = TailLbcb;
01047                                 <span class="keywordflow">break</span>;
01048                             }
01049     
01050                             Links = Links-&gt;Flink;
01051                         }
01052                     }
01053 
01054                     <span class="comment">//</span>
01055                     <span class="comment">//  If we found an Lbcb then unpin the page temporarily.</span>
01056                     <span class="comment">//  Other users will have to detect this is not pinned.</span>
01057                     <span class="comment">//</span>
01058 
01059                     <span class="keywordflow">if</span> (Lfcb-&gt;PageToDirty != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01060 
01061                         <span class="comment">//</span>
01062                         <span class="comment">//  Go ahead and map this page to keep the virtual address</span>
01063                         <span class="comment">//  valid.</span>
01064                         <span class="comment">//</span>
01065 
01066                         <a class="code" href="../../d4/d2/cache_8h.html#a88">CcMapData</a>( Lfcb-&gt;FileObject, 
01067                                    (PLARGE_INTEGER) &amp;Lfcb-&gt;PageToDirty-&gt;FileOffset,
01068                                    (ULONG) Lfcb-&gt;LogPageSize,
01069                                    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01070                                    &amp;MapPageBcb,
01071                                    &amp;MapPage );
01072 
01073                         <a class="code" href="../../d4/d2/cache_8h.html#a94">CcUnpinDataForThread</a>( Lfcb-&gt;PageToDirty-&gt;LogPageBcb,
01074                                               Lfcb-&gt;PageToDirty-&gt;ResourceThread );
01075 
01076                         Lfcb-&gt;PageToDirty-&gt;LogPageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01077                     }
01078 
01079                     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a29">LfsReleaseLfcb</a>( Lfcb );
01080                 }
01081             }
01082 
01083             <span class="comment">//</span>
01084             <span class="comment">//  We are ready to do the I/O.  Flush the pages to the log file.</span>
01085             <span class="comment">//</span>
01086 
01087             <a class="code" href="../../d4/d2/cache_8h.html#a63">CcFlushCache</a>( Lfcb-&gt;FileObject-&gt;SectionObjectPointer,
01088                           (PLARGE_INTEGER)&amp;FileOffset,
01089                           Length,
01090                           &amp;Iosb );
01091 
01092             <span class="comment">//</span>
01093             <span class="comment">//  Recover the state of any partial page first.</span>
01094             <span class="comment">//</span>
01095 
01096             <span class="keywordflow">if</span> (Lfcb-&gt;PageToDirty != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01097 
01098                 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a5">LfsPreparePinWriteData</a>( Lfcb, 
01099                                         Lfcb-&gt;PageToDirty-&gt;FileOffset,
01100                                         (ULONG) Lfcb-&gt;LogPageSize,
01101                                         &amp;Lfcb-&gt;PageToDirty-&gt;PageHeader,
01102                                         &amp;Lfcb-&gt;PageToDirty-&gt;LogPageBcb );
01103 
01104                 Lfcb-&gt;PageToDirty-&gt;ResourceThread = <a class="code" href="../../d5/d8/ex_8h.html#a67">ExGetCurrentResourceThread</a>();
01105                 Lfcb-&gt;PageToDirty = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01106 
01107                 <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( MapPageBcb );
01108                 MapPageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01109             }
01110 
01111             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Iosb.Status )) {
01112 
01113                 LONG BytesRemaining = (LONG) Length;
01114 
01115                 <span class="comment">//</span>
01116                 <span class="comment">//  If we get an error then try each individual page.</span>
01117                 <span class="comment">//</span>
01118 
01119                 <span class="keywordflow">while</span> (BytesRemaining &gt; 0) {
01120 
01121                     <span class="comment">//</span>
01122                     <span class="comment">//  Remember the range we are flushing and find the second half of a page</span>
01123                     <span class="comment">//  if necessary.</span>
01124                     <span class="comment">//</span>
01125         
01126                     Lfcb-&gt;UserWriteData-&gt;FileOffset = FileOffset;
01127                     Lfcb-&gt;UserWriteData-&gt;Length = Length;
01128         
01129                     <span class="keywordflow">if</span> (!UseTailCopy &amp;&amp; !LfsRestart) {
01130         
01131                         <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> TailLbcb;
01132                         PLIST_ENTRY Links;
01133                         LONGLONG NextOffset;
01134         
01135                         <span class="comment">//</span>
01136                         <span class="comment">//  We are flushing log records.  If the current request does not end on</span>
01137                         <span class="comment">//  a system page boundary then check if there is another page in</span>
01138                         <span class="comment">//  memory that we are concerned with.</span>
01139                         <span class="comment">//</span>
01140         
01141                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( (ULONG)(FileOffset + Length), (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1) )) {
01142         
01143                             NextOffset = FileOffset + Length;
01144         
01145                             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a28">LfsAcquireLfcb</a>( Lfcb );
01146 
01147                             <span class="comment">//</span>
01148                             <span class="comment">//  Start by looking through the Lbcbs on the active queue.</span>
01149                             <span class="comment">//</span>
01150         
01151                             Links = Lfcb-&gt;LbcbActive.Flink;
01152         
01153                             <span class="keywordflow">while</span> (Links != &amp;Lfcb-&gt;LbcbActive) {
01154         
01155                                 TailLbcb = CONTAINING_RECORD( Links,
01156                                                               <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
01157                                                               ActiveLinks );
01158         
01159                                 <span class="keywordflow">if</span> (TailLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o4">FileOffset</a> == NextOffset) {
01160         
01161                                     Lfcb-&gt;PageToDirty = TailLbcb;
01162                                     <span class="keywordflow">break</span>;
01163                                 }
01164         
01165                                 Links = Links-&gt;Flink;
01166                             }
01167         
01168                             <span class="comment">//</span>
01169                             <span class="comment">//  If we didn't find it then scan to the end of the workque.</span>
01170                             <span class="comment">//</span>
01171         
01172                             <span class="keywordflow">if</span> (Lfcb-&gt;PageToDirty == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01173         
01174                                 Links = Lfcb-&gt;LbcbWorkque.Flink;
01175         
01176                                 <span class="keywordflow">while</span> (Links != &amp;Lfcb-&gt;LbcbWorkque) {
01177             
01178                                     TailLbcb = CONTAINING_RECORD( Links,
01179                                                                   <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
01180                                                                   WorkqueLinks );
01181             
01182                                     <span class="keywordflow">if</span> (TailLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o4">FileOffset</a> == NextOffset) {
01183             
01184                                         Lfcb-&gt;PageToDirty = TailLbcb;
01185                                         <span class="keywordflow">break</span>;
01186                                     }
01187             
01188                                     Links = Links-&gt;Flink;
01189                                 }
01190                             }
01191         
01192                             <span class="comment">//</span>
01193                             <span class="comment">//  If we found an Lbcb then unpin the page temporarily.</span>
01194                             <span class="comment">//  Other users will have to detect this is not pinned.</span>
01195                             <span class="comment">//</span>
01196         
01197                             <span class="keywordflow">if</span> (Lfcb-&gt;PageToDirty != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01198         
01199                                 <a class="code" href="../../d4/d2/cache_8h.html#a88">CcMapData</a>( Lfcb-&gt;FileObject, 
01200                                            (PLARGE_INTEGER) &amp;Lfcb-&gt;PageToDirty-&gt;FileOffset,
01201                                            (ULONG) Lfcb-&gt;PageToDirty-&gt;Length,
01202                                            <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01203                                            &amp;MapPageBcb,
01204                                            &amp;MapPage );
01205         
01206                                 <a class="code" href="../../d4/d2/cache_8h.html#a94">CcUnpinDataForThread</a>( Lfcb-&gt;PageToDirty-&gt;LogPageBcb,
01207                                                       Lfcb-&gt;PageToDirty-&gt;ResourceThread );
01208         
01209                                 Lfcb-&gt;PageToDirty-&gt;LogPageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01210                             }
01211                         }
01212                         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a29">LfsReleaseLfcb</a>( Lfcb );
01213                     }
01214         
01215                     <a class="code" href="../../d4/d2/cache_8h.html#a63">CcFlushCache</a>( Lfcb-&gt;FileObject-&gt;SectionObjectPointer,
01216                                   (PLARGE_INTEGER)&amp;FileOffset,
01217                                   (ULONG)Lfcb-&gt;SystemPageSize,
01218                                   &amp;Iosb );
01219 
01220                     <span class="comment">//</span>
01221                     <span class="comment">//  Recover the state of any partial page first.</span>
01222                     <span class="comment">//</span>
01223         
01224                     <span class="keywordflow">if</span> (Lfcb-&gt;PageToDirty != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01225         
01226                         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a5">LfsPreparePinWriteData</a>( Lfcb, 
01227                                                 Lfcb-&gt;PageToDirty-&gt;FileOffset,
01228                                                 (ULONG) Lfcb-&gt;PageToDirty-&gt;Length,
01229                                                 &amp;Lfcb-&gt;PageToDirty-&gt;PageHeader,
01230                                                 &amp;Lfcb-&gt;PageToDirty-&gt;LogPageBcb );
01231         
01232                         Lfcb-&gt;PageToDirty-&gt;ResourceThread = <a class="code" href="../../d5/d8/ex_8h.html#a67">ExGetCurrentResourceThread</a>();
01233                         Lfcb-&gt;PageToDirty = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01234 
01235                         <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( MapPageBcb );
01236                         MapPageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01237                     }
01238         
01239                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Iosb.Status )) {
01240 
01241 <span class="preprocessor">#ifdef NTFS_RESTART</span>
01242 <span class="preprocessor"></span>                        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01243 <span class="preprocessor">#endif</span>
01244 <span class="preprocessor"></span>                        RaiseCorrupt = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01245                     }
01246 
01247                     BytesRemaining -= (LONG)Lfcb-&gt;SystemPageSize;
01248                     FileOffset = FileOffset + Lfcb-&gt;SystemPageSize;
01249                 }
01250             }
01251 
01252             <span class="comment">//</span>
01253             <span class="comment">//  Reacquire the Lfcb, remembering that we have it.</span>
01254             <span class="comment">//</span>
01255 
01256             <span class="keywordflow">if</span> (!UseTailCopy) {
01257 
01258                 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a28">LfsAcquireLfcb</a>( Lfcb );
01259             }
01260 
01261             <span class="comment">//</span>
01262             <span class="comment">//  Update the last flushed Lsn value if this isn't a</span>
01263             <span class="comment">//  restart write.</span>
01264             <span class="comment">//</span>
01265 
01266             <span class="keywordflow">if</span> (!LfsRestart) {
01267 
01268                 <span class="keywordflow">if</span> (ValidLastLsn) {
01269 
01270                     Lfcb-&gt;LastFlushedLsn = LastLsn;
01271                 }
01272 
01273             <span class="comment">//</span>
01274             <span class="comment">//  Remember the Lsn we assigned to this restart area.</span>
01275             <span class="comment">//</span>
01276 
01277             } <span class="keywordflow">else</span> {
01278 
01279                 Lfcb-&gt;LastFlushedRestartLsn = LastLsn;
01280 
01281                 <span class="comment">//</span>
01282                 <span class="comment">//  Clear any neccessary flags on a successful operation.</span>
01283                 <span class="comment">//</span>
01284 
01285                 <span class="keywordflow">if</span> (!RaiseCorrupt) {
01286 
01287                     <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( Lfcb-&gt;Flags, NewLfcbFlags );
01288                     NewLfcbFlags = 0;
01289                 }
01290 
01291                 <span class="comment">//</span>
01292                 <span class="comment">//  If this is the first write of a restart area and we have</span>
01293                 <span class="comment">//  updated the LogOpenCount then update the field in the Lfcb.</span>
01294                 <span class="comment">//</span>
01295 
01296                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Iosb.Status ) &amp;&amp;
01297                     (Lfcb-&gt;CurrentOpenLogCount != ((<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a>) FirstLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o8">PageHeader</a>)-&gt;RestartOpenLogCount)) {
01298 
01299                     Lfcb-&gt;CurrentOpenLogCount = ((<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a>) FirstLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o8">PageHeader</a>)-&gt;RestartOpenLogCount;
01300                 }
01301             }
01302 
01303             <span class="comment">//</span>
01304             <span class="comment">//  Walk through all the Lbcb's we flushed, deallocating the Lbcbs.</span>
01305             <span class="comment">//</span>
01306 
01307             <span class="keywordflow">if</span> (!UseTailCopy) {
01308 
01309                 <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> TempLbcb;
01310 
01311                 ThisLbcb = FirstLbcb;
01312 
01313                 <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01314 
01315                     <span class="comment">//</span>
01316                     <span class="comment">//  Remember the next entry on the list.</span>
01317                     <span class="comment">//</span>
01318 
01319                     TempLbcb = CONTAINING_RECORD( ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o2">WorkqueLinks</a>.Flink,
01320                                                   <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
01321                                                   WorkqueLinks );
01322 
01323                     <span class="comment">//</span>
01324                     <span class="comment">//  Remove it from the LbcbWorkque queue.</span>
01325                     <span class="comment">//</span>
01326 
01327                     RemoveEntryList( &amp;ThisLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o2">WorkqueLinks</a> );
01328 
01329                     <span class="comment">//</span>
01330                     <span class="comment">//  Deallocate the structure.</span>
01331                     <span class="comment">//</span>
01332 
01333                     <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a4">LfsDeallocateLbcb</a>( Lfcb, ThisLbcb );
01334 
01335                     <span class="keywordflow">if</span> (IoBlocks-- == 1) {
01336 
01337                         <span class="keywordflow">break</span>;
01338                     }
01339 
01340                     ThisLbcb = TempLbcb;
01341                 }
01342             }
01343 
01344             <span class="comment">//</span>
01345             <span class="comment">//  If we flushed the Lbcb we were interested in, we are done.</span>
01346             <span class="comment">//  We will signal all waiting threads regardless</span>
01347             <span class="comment">//</span>
01348 
01349             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;Lfcb-&gt;Sync-&gt;Event, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01350 
01351             <span class="comment">//</span>
01352             <span class="comment">//  Remember the starting Lbcb for the next I/O.</span>
01353             <span class="comment">//</span>
01354 
01355             FirstLbcb = NextLbcb;
01356         }
01357 
01358     try_exit:  NOTHING;
01359     } finally {
01360 
01361         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( <a class="code" href="../../d7/d2/lfs_2cachesup_8c.html#a9">LfsFlushLfcb</a> );
01362 
01363         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Lfcb-&gt;PageToDirty == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01364 
01365         <span class="comment">//</span>
01366         <span class="comment">//  Show that there is no Io in progress.</span>
01367         <span class="comment">//</span>
01368 
01369         Lfcb-&gt;LfsIoState = <a class="code" href="../../d1/d4/lfsstruc_8h.html#a40a38">LfsNoIoInProgress</a>;
01370 <span class="preprocessor">#ifdef BRIANDBG</span>
01371 <span class="preprocessor"></span>        Lfcb-&gt;LfsIoThread = 0;
01372 <span class="preprocessor">#endif</span>
01373 <span class="preprocessor"></span>
01374         <span class="comment">//</span>
01375         <span class="comment">//  Make sure we didn't leave any pages pinned.</span>
01376         <span class="comment">//</span>
01377 
01378         <span class="keywordflow">if</span> (PageBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01379 
01380             <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( PageBcb );
01381         }
01382 
01383         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsFlushLfcb:  Exit\n"</span>, 0 );
01384     }
01385 
01386     <span class="comment">//</span>
01387     <span class="comment">//  If the Io failed at some point, we raise a corrupt disk error.</span>
01388     <span class="comment">//  The only exception is if this is the final flush of the log file.</span>
01389     <span class="comment">//  In this case the client may not be able to cleanup after this error.</span>
01390     <span class="comment">//</span>
01391 
01392     <span class="keywordflow">if</span> (RaiseCorrupt &amp;&amp; (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a12">LFCB_FINAL_SHUTDOWN</a> ))) {
01393 
01394         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_DISK_CORRUPT_ERROR );
01395     }
01396 
01397     <span class="keywordflow">return</span>;
01398 }
01399 
01400 
01401 BOOLEAN
<a name="l01402"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a52">01402</a> <a class="code" href="../../d0/d4/lfsprocs_8h.html#a52">LfsReadRestart</a> (
01403     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
01404     IN LONGLONG FileSize,
01405     IN BOOLEAN FirstRestart,
01406     OUT PLONGLONG RestartPageOffset,
01407     OUT <a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html">PLFS_RESTART_PAGE_HEADER</a> *RestartPage,
01408     OUT <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> *RestartPageBcb,
01409     OUT PBOOLEAN ChkdskWasRun,
01410     OUT PBOOLEAN ValidPage,
01411     OUT PBOOLEAN UninitializedFile,
01412     OUT PBOOLEAN LogPacked,
01413     OUT <a class="code" href="../../d6/d3/lfs_8h.html#a11">PLSN</a> LastLsn
01414     )
01415 
01416 <span class="comment">/*++</span>
01417 <span class="comment"></span>
01418 <span class="comment">Routine Description:</span>
01419 <span class="comment"></span>
01420 <span class="comment">    This routine will walk through 512 blocks of the file looking for a</span>
01421 <span class="comment">    valid restart page header.  It will stop the first time we find</span>
01422 <span class="comment">    a valid page header.</span>
01423 <span class="comment"></span>
01424 <span class="comment">Arguments:</span>
01425 <span class="comment"></span>
01426 <span class="comment">    Lfcb - This is the Lfcb for the log file.</span>
01427 <span class="comment"></span>
01428 <span class="comment">    FileSize - Size in bytes for the log file.</span>
01429 <span class="comment"></span>
01430 <span class="comment">    FirstRestart - Indicates if we are looking for the first valid</span>
01431 <span class="comment">        restart area.</span>
01432 <span class="comment"></span>
01433 <span class="comment">    RestartPageOffset - This is the location to store the offset in the</span>
01434 <span class="comment">        file where the log page was found.</span>
01435 <span class="comment"></span>
01436 <span class="comment">    RestartPage - This is the location to store the address of the</span>
01437 <span class="comment">        pinned restart page.</span>
01438 <span class="comment"></span>
01439 <span class="comment">    RestartPageBcb - This is the location to store the Bcb for this</span>
01440 <span class="comment">        cache pin operation.</span>
01441 <span class="comment"></span>
01442 <span class="comment">    ChkdskWasRun - Address to store whether checkdisk was run on this volume.</span>
01443 <span class="comment"></span>
01444 <span class="comment">    ValidPage - Address to store whether there was valid data on this page.</span>
01445 <span class="comment"></span>
01446 <span class="comment">    UninitializedFile - Address to store whether this is an uninitialized</span>
01447 <span class="comment">        log file.  Return value only valid if for the first restart area.</span>
01448 <span class="comment"></span>
01449 <span class="comment">    LogPacked - Address to store whether the log file is packed.</span>
01450 <span class="comment"></span>
01451 <span class="comment">    LastLsn - Address to store the last Lsn for this restart page.  It will be the</span>
01452 <span class="comment">        chkdsk value if checkdisk was run.  Otherwise it is the LastFlushedLsn</span>
01453 <span class="comment">        for this restart page.</span>
01454 <span class="comment"></span>
01455 <span class="comment">Return Value:</span>
01456 <span class="comment"></span>
01457 <span class="comment">    BOOLEAN - TRUE if a restart area was found, FALSE otherwise.</span>
01458 <span class="comment"></span>
01459 <span class="comment">--*/</span>
01460 
01461 {
01462     ULONG FileOffsetIncrement;
01463     LONGLONG FileOffset;
01464 
01465     <a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a> RestartArea;
01466 
01467     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01468 
01469     <a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html">PLFS_RESTART_PAGE_HEADER</a> ThisPage;
01470     <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> ThisPageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01471 
01472     BOOLEAN FoundRestart = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01473 
01474     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01475 
01476     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsReadRestart:  Entered\n"</span>, 0 );
01477     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Lfcb   -&gt; %08lx\n"</span>, Lfcb );
01478 
01479     <span class="comment">//</span>
01480     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
01481     <span class="comment">//</span>
01482 
01483     *UninitializedFile = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01484     *ValidPage = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01485     *ChkdskWasRun = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01486     *LogPacked = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01487 
01488     <span class="keywordflow">try</span> {
01489 
01490         <span class="comment">//</span>
01491         <span class="comment">//  Determine which restart area we are looking for.</span>
01492         <span class="comment">//</span>
01493 
01494         <span class="keywordflow">if</span> (FirstRestart) {
01495 
01496             FileOffset = 0;
01497             FileOffsetIncrement = <a class="code" href="../../d6/d3/lfs_8h.html#a0">SEQUENCE_NUMBER_STRIDE</a>;
01498 
01499         } <span class="keywordflow">else</span> {
01500 
01501             FileOffset = <a class="code" href="../../d6/d3/lfs_8h.html#a0">SEQUENCE_NUMBER_STRIDE</a>;
01502             FileOffsetIncrement = 0;
01503         }
01504 
01505         <span class="comment">//</span>
01506         <span class="comment">//  We loop continuously until we succeed, pin a log record page</span>
01507         <span class="comment">//  or exhaust the number of possible tries.</span>
01508         <span class="comment">//</span>
01509 
01510         <span class="keywordflow">while</span> ( FileOffset &lt; FileSize ) {
01511 
01512             ULONG Signature;
01513             BOOLEAN UsaError;
01514 
01515             <span class="keywordflow">if</span> (ThisPageBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01516 
01517                 <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( ThisPageBcb );
01518                 ThisPageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01519             }
01520 
01521             <span class="comment">//</span>
01522             <span class="comment">//  Attempt to pin a page header at the current offset.</span>
01523             <span class="comment">//</span>
01524 
01525             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a48">LfsPinOrMapData</a>( Lfcb,
01526                                       FileOffset,
01527                                       <a class="code" href="../../d6/d3/lfs_8h.html#a0">SEQUENCE_NUMBER_STRIDE</a>,
01528                                       <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01529                                       <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01530                                       <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01531                                       &amp;UsaError,
01532                                       (PVOID *)&amp;ThisPage,
01533                                       &amp;ThisPageBcb );
01534 
01535             <span class="comment">//</span>
01536             <span class="comment">//</span>
01537             <span class="comment">//  If we succeeded, we look at the 4 byte signature.</span>
01538             <span class="comment">//</span>
01539 
01540             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01541 
01542                 Signature = *((PULONG) &amp;ThisPage-&gt;MultiSectorHeader.Signature);
01543 
01544                 <span class="comment">//</span>
01545                 <span class="comment">//  If the signature is a log record page, we will exit.</span>
01546                 <span class="comment">//</span>
01547 
01548                 <span class="keywordflow">if</span> (Signature == <a class="code" href="../../d9/d3/lfsdisk_8h.html#a14">LFS_SIGNATURE_RECORD_PAGE_ULONG</a>) {
01549 
01550                     *UninitializedFile = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01551                     <span class="keywordflow">break</span>;
01552                 }
01553 
01554                 <span class="comment">//</span>
01555                 <span class="comment">//  Continue analyzing the page if the signature is chkdsk or</span>
01556                 <span class="comment">//  a restart page.</span>
01557                 <span class="comment">//</span>
01558 
01559                 <span class="keywordflow">if</span> (Signature == <a class="code" href="../../d9/d3/lfsdisk_8h.html#a18">LFS_SIGNATURE_MODIFIED_ULONG</a>
01560                     || Signature == <a class="code" href="../../d9/d3/lfsdisk_8h.html#a12">LFS_SIGNATURE_RESTART_PAGE_ULONG</a>) {
01561 
01562                     *UninitializedFile = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01563 
01564                     <span class="comment">//</span>
01565                     <span class="comment">//  Remember where we found this page.</span>
01566                     <span class="comment">//</span>
01567 
01568                     *RestartPageOffset = FileOffset;
01569 
01570                     <span class="comment">//</span>
01571                     <span class="comment">//  Let's check the restart area if this is a valid page.</span>
01572                     <span class="comment">//</span>
01573 
01574                     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d2/lfs_2cachesup_8c.html#a2">LfsIsRestartPageHeaderValid</a>( FileOffset,
01575                                                      ThisPage,
01576                                                      LogPacked )
01577 
01578                         &amp;&amp; <a class="code" href="../../d7/d2/lfs_2cachesup_8c.html#a3">LfsIsRestartAreaValid</a>( ThisPage, *LogPacked )) {
01579 
01580                         <span class="comment">//</span>
01581                         <span class="comment">//  We have a valid restart page header and restart area.</span>
01582                         <span class="comment">//  If chkdsk was run or we have no clients then</span>
01583                         <span class="comment">//  we have no more checking to do.</span>
01584                         <span class="comment">//</span>
01585 
01586                         RestartArea = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( ThisPage,
01587                                                ThisPage-&gt;RestartOffset,
01588                                                <a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a> );
01589 
01590                         <span class="keywordflow">if</span> (Signature == <a class="code" href="../../d9/d3/lfsdisk_8h.html#a12">LFS_SIGNATURE_RESTART_PAGE_ULONG</a>
01591                             &amp;&amp; RestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o3">ClientInUseList</a> != <a class="code" href="../../d9/d3/lfsdisk_8h.html#a21">LFS_NO_CLIENT</a>) {
01592 
01593                             <span class="comment">//</span>
01594                             <span class="comment">//  Pin the entire restart area if we didn't have an earlier</span>
01595                             <span class="comment">//</span>
01596 
01597                             <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( ThisPageBcb );
01598                             ThisPageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01599 
01600                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a48">LfsPinOrMapData</a>( Lfcb,
01601                                                       FileOffset,
01602                                                       ThisPage-&gt;SystemPageSize,
01603                                                       <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01604                                                       <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01605                                                       <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01606                                                       &amp;UsaError,
01607                                                       (PVOID *)&amp;ThisPage,
01608                                                       &amp;ThisPageBcb );
01609 
01610                             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )
01611                                 &amp;&amp; <a class="code" href="../../d7/d2/lfs_2cachesup_8c.html#a4">LfsIsClientAreaValid</a>( ThisPage, *LogPacked, UsaError )) {
01612 
01613                                 *ValidPage = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01614 
01615                                 RestartArea = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( ThisPage,
01616                                                        ThisPage-&gt;RestartOffset,
01617                                                        <a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a> );
01618                             }
01619 
01620                         } <span class="keywordflow">else</span> {
01621 
01622                             *ValidPage = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01623                         }
01624                     }
01625 
01626                     <span class="comment">//</span>
01627                     <span class="comment">//  If chkdsk was run then update the caller's values and return.</span>
01628                     <span class="comment">//</span>
01629 
01630                     <span class="keywordflow">if</span> (Signature == <a class="code" href="../../d9/d3/lfsdisk_8h.html#a18">LFS_SIGNATURE_MODIFIED_ULONG</a>) {
01631 
01632                         *ChkdskWasRun = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01633 
01634                         *LastLsn = ThisPage-&gt;ChkDskLsn;
01635 
01636                         FoundRestart = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01637 
01638                         *RestartPageBcb = ThisPageBcb;
01639                         *RestartPage = ThisPage;
01640 
01641                         ThisPageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01642                         <span class="keywordflow">break</span>;
01643                     }
01644 
01645                     <span class="comment">//</span>
01646                     <span class="comment">//  If we have a valid page then copy the values we need from it.</span>
01647                     <span class="comment">//</span>
01648 
01649                     <span class="keywordflow">if</span> (*ValidPage) {
01650 
01651                         *LastLsn = RestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o0">CurrentLsn</a>;
01652 
01653                         FoundRestart = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01654 
01655                         *RestartPageBcb = ThisPageBcb;
01656                         *RestartPage = ThisPage;
01657 
01658                         ThisPageBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01659                         <span class="keywordflow">break</span>;
01660                     }
01661 
01662                 <span class="comment">//</span>
01663                 <span class="comment">//  Remember if the signature does not indicate uninitialized file.</span>
01664                 <span class="comment">//</span>
01665 
01666                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Signature != <a class="code" href="../../d9/d3/lfsdisk_8h.html#a20">LFS_SIGNATURE_UNINITIALIZED_ULONG</a>) {
01667 
01668                     *UninitializedFile = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01669                 }
01670             }
01671 
01672             <span class="comment">//</span>
01673             <span class="comment">//  Move to the next possible log page.</span>
01674             <span class="comment">//</span>
01675 
01676             FileOffset = FileOffset &lt;&lt; 1;
01677 
01678             (ULONG)FileOffset += FileOffsetIncrement;
01679 
01680             FileOffsetIncrement = 0;
01681         }
01682 
01683     } finally {
01684 
01685         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( <a class="code" href="../../d7/d2/lfs_2cachesup_8c.html#a10">LfsReadRestart</a> );
01686 
01687         <span class="comment">//</span>
01688         <span class="comment">//  Unpin the log pages if pinned.</span>
01689         <span class="comment">//</span>
01690 
01691         <span class="keywordflow">if</span> (ThisPageBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01692 
01693             <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( ThisPageBcb );
01694         }
01695 
01696         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"RestartPageAddress (Low)  -&gt; %08lx\n"</span>, RestartPageAddress-&gt;LowPart );
01697         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"RestartPageAddress (High) -&gt; %08lx\n"</span>, RestartPageAddress-&gt;HighPart );
01698         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"FirstRestartPage          -&gt; %08lx\n"</span>, *FirstRestartPage );
01699         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsReadRestart:  Exit\n"</span>, 0 );
01700     }
01701 
01702     <span class="keywordflow">return</span> FoundRestart;
01703 }
01704 
01705 
01706 <span class="comment">//</span>
01707 <span class="comment">//  Local support routine</span>
01708 <span class="comment">//</span>
01709 
01710 BOOLEAN
<a name="l01711"></a><a class="code" href="../../d7/d2/lfs_2cachesup_8c.html#a2">01711</a> <a class="code" href="../../d7/d2/lfs_2cachesup_8c.html#a2">LfsIsRestartPageHeaderValid</a> (
01712     IN LONGLONG FileOffset,
01713     IN <a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html">PLFS_RESTART_PAGE_HEADER</a> PageHeader,
01714     OUT PBOOLEAN LogPacked
01715     )
01716 
01717 <span class="comment">/*++</span>
01718 <span class="comment"></span>
01719 <span class="comment">Routine Description:</span>
01720 <span class="comment"></span>
01721 <span class="comment">    This routine is called to verify that the candidate for a restart page</span>
01722 <span class="comment">    has no corrupt values in the page header.  It verifies that the restart and</span>
01723 <span class="comment">    system page size have only one bit set and are at least the value of</span>
01724 <span class="comment">    the update sequence array stride.</span>
01725 <span class="comment"></span>
01726 <span class="comment">Arguments:</span>
01727 <span class="comment"></span>
01728 <span class="comment">    FileOffset - This is the offset in the file of the restart area to examine.</span>
01729 <span class="comment">        If this offset is not 0, then it should match the system page size.</span>
01730 <span class="comment"></span>
01731 <span class="comment">    PageHeader - This is the page to examine.</span>
01732 <span class="comment"></span>
01733 <span class="comment">    LogPacked - Address to store whether the log file is packed.</span>
01734 <span class="comment"></span>
01735 <span class="comment">Return Value:</span>
01736 <span class="comment"></span>
01737 <span class="comment">    BOOLEAN - TRUE if there is no corruption in the pool header values.</span>
01738 <span class="comment">              FALSE otherwise.</span>
01739 <span class="comment"></span>
01740 <span class="comment">--*/</span>
01741 
01742 {
01743     ULONG SystemPage;
01744     ULONG LogPageSize;
01745     ULONG Mask;
01746     ULONG BitCount;
01747 
01748     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> EndOfUsa;
01749 
01750     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01751 
01752     *LogPacked = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01753 
01754     <span class="comment">//</span>
01755     <span class="comment">//  Copy the values from the page header into the local variables.</span>
01756     <span class="comment">//</span>
01757 
01758     SystemPage = PageHeader-&gt;SystemPageSize;
01759     LogPageSize = PageHeader-&gt;LogPageSize;
01760 
01761     <span class="comment">//</span>
01762     <span class="comment">//  The system page and log page sizes must be greater or equal to the</span>
01763     <span class="comment">//  update sequence stride.</span>
01764     <span class="comment">//</span>
01765 
01766     <span class="keywordflow">if</span> (SystemPage &lt; <a class="code" href="../../d6/d3/lfs_8h.html#a0">SEQUENCE_NUMBER_STRIDE</a>
01767         || LogPageSize &lt; <a class="code" href="../../d6/d3/lfs_8h.html#a0">SEQUENCE_NUMBER_STRIDE</a>) {
01768 
01769         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01770     }
01771 
01772     <span class="comment">//</span>
01773     <span class="comment">//  Now we check that the Log page and system page are multiples of two.</span>
01774     <span class="comment">//  They should only have a single bit set.</span>
01775     <span class="comment">//</span>
01776 
01777     <span class="keywordflow">for</span> (Mask = 1, BitCount = 0; Mask != 0; Mask = Mask &lt;&lt; 1) {
01778 
01779         <span class="keywordflow">if</span> (Mask &amp; LogPageSize) {
01780 
01781             BitCount += 1;
01782         }
01783     }
01784 
01785     <span class="comment">//</span>
01786     <span class="comment">//  If the bit count isn't 1, return false.</span>
01787     <span class="comment">//</span>
01788 
01789     <span class="keywordflow">if</span> (BitCount != 1) {
01790 
01791         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01792     }
01793 
01794     <span class="comment">//</span>
01795     <span class="comment">//  Now do the system page size.</span>
01796     <span class="comment">//</span>
01797 
01798     <span class="keywordflow">for</span> (Mask = 1, BitCount = 0; Mask != 0; Mask = Mask &lt;&lt; 1) {
01799 
01800         <span class="keywordflow">if</span> (Mask &amp; SystemPage) {
01801 
01802             BitCount += 1;
01803         }
01804     }
01805 
01806     <span class="comment">//</span>
01807     <span class="comment">//  If the bit count isn't 1, return false.</span>
01808     <span class="comment">//</span>
01809 
01810     <span class="keywordflow">if</span> (BitCount != 1) {
01811 
01812         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01813     }
01814 
01815     <span class="comment">//</span>
01816     <span class="comment">//  Check that if the file offset isn't 0, it is the system page size.</span>
01817     <span class="comment">//</span>
01818 
01819     <span class="keywordflow">if</span> (( FileOffset != 0 )
01820         &amp;&amp; ((ULONG)FileOffset != SystemPage)) {
01821 
01822         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01823     }
01824 
01825     <span class="comment">//</span>
01826     <span class="comment">//  We only support major version numbers 0.x and 1.x</span>
01827     <span class="comment">//</span>
01828     <span class="comment">//  Version number beyond 1.0 mean the log file is packed.</span>
01829     <span class="comment">//</span>
01830 
01831     <span class="keywordflow">if</span> (PageHeader-&gt;MajorVersion != 0
01832         &amp;&amp; PageHeader-&gt;MajorVersion != 1) {
01833 
01834         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01835     }
01836 
01837     <span class="comment">//</span>
01838     <span class="comment">//  Check that the restart area offset is within the system page and that</span>
01839     <span class="comment">//  the restart length field will fit within the system page size.</span>
01840     <span class="comment">//</span>
01841 
01842     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a62">QuadAlign</a>( PageHeader-&gt;RestartOffset ) != PageHeader-&gt;RestartOffset
01843         || PageHeader-&gt;RestartOffset &gt; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) PageHeader-&gt;SystemPageSize) {
01844 
01845         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01846     }
01847 
01848     <span class="comment">//</span>
01849     <span class="comment">//  Check that the restart offset will lie beyond the Usa Array for this page.</span>
01850     <span class="comment">//</span>
01851 
01852     EndOfUsa = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (<a class="code" href="../../d9/d3/lfsdisk_8h.html#a3">UpdateSequenceArraySize</a>( PageHeader-&gt;SystemPageSize )
01853                          * <span class="keyword">sizeof</span>( <a class="code" href="../../d6/d3/lfs_8h.html#a2">UPDATE_SEQUENCE_NUMBER</a> ));
01854 
01855     EndOfUsa += PageHeader-&gt;MultiSectorHeader.UpdateSequenceArrayOffset;
01856 
01857     <span class="keywordflow">if</span> (PageHeader-&gt;RestartOffset &lt; EndOfUsa) {
01858 
01859         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01860     }
01861 
01862     <span class="comment">//</span>
01863     <span class="comment">//  Check if the log pages are packed.</span>
01864     <span class="comment">//</span>
01865 
01866     <span class="keywordflow">if</span> (PageHeader-&gt;MajorVersion == 1
01867         &amp;&amp; PageHeader-&gt;MinorVersion &gt; 0) {
01868 
01869         *LogPacked = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01870     }
01871 
01872     <span class="comment">//</span>
01873     <span class="comment">//  Otherwise the page header is valid.</span>
01874     <span class="comment">//</span>
01875 
01876     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01877 }
01878 
01879 
01880 <span class="comment">//</span>
01881 <span class="comment">//  Local support routine</span>
01882 <span class="comment">//</span>
01883 
01884 BOOLEAN
<a name="l01885"></a><a class="code" href="../../d7/d2/lfs_2cachesup_8c.html#a3">01885</a> <a class="code" href="../../d7/d2/lfs_2cachesup_8c.html#a3">LfsIsRestartAreaValid</a> (
01886     IN <a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html">PLFS_RESTART_PAGE_HEADER</a> PageHeader,
01887     IN BOOLEAN LogPacked
01888     )
01889 
01890 <span class="comment">/*++</span>
01891 <span class="comment"></span>
01892 <span class="comment">Routine Description:</span>
01893 <span class="comment"></span>
01894 <span class="comment">    This routine is called to verify that the restart area attached to the</span>
01895 <span class="comment">    log page header is valid.  The restart values must be contained within</span>
01896 <span class="comment">    the first Usa stride of the file.  This is so we can restart successfully</span>
01897 <span class="comment">    after chkdsk.</span>
01898 <span class="comment"></span>
01899 <span class="comment">Arguments:</span>
01900 <span class="comment"></span>
01901 <span class="comment">    PageHeader - This is the page to examine.</span>
01902 <span class="comment"></span>
01903 <span class="comment">    LogPacked - Indicates if the log file is packed.</span>
01904 <span class="comment"></span>
01905 <span class="comment">Return Value:</span>
01906 <span class="comment"></span>
01907 <span class="comment">    BOOLEAN - TRUE if there is no corruption in the restart area values.</span>
01908 <span class="comment">              FALSE otherwise.</span>
01909 <span class="comment"></span>
01910 <span class="comment">--*/</span>
01911 
01912 {
01913     <a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a> RestartArea;
01914     ULONG OffsetInRestart;
01915     ULONG SeqNumberBits;
01916 
01917     LONGLONG FileSize;
01918 
01919     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01920 
01921     <span class="comment">//</span>
01922     <span class="comment">//  The basic part of the restart area must fit into the first stride of</span>
01923     <span class="comment">//  the page.  This will allow chkdsk to work even if there are Usa errors.</span>
01924     <span class="comment">//</span>
01925 
01926     OffsetInRestart = FIELD_OFFSET( <a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html">LFS_RESTART_AREA</a>, FileSize );
01927 
01928     <span class="keywordflow">if</span> ((PageHeader-&gt;RestartOffset + OffsetInRestart) &gt; <a class="code" href="../../d9/d3/lfsdisk_8h.html#a4">FIRST_STRIDE</a>) {
01929 
01930         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01931     }
01932 
01933     RestartArea = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( PageHeader, PageHeader-&gt;RestartOffset, <a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a> );
01934 
01935     <span class="comment">//</span>
01936     <span class="comment">//  Everything in the restart area except the actual client array must also</span>
01937     <span class="comment">//  be in the first stride.  If the structure is packed, then we can use</span>
01938     <span class="comment">//  a field in the restart area for the client offset.</span>
01939     <span class="comment">//</span>
01940 
01941     <span class="keywordflow">if</span> (LogPacked) {
01942 
01943         OffsetInRestart = RestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o7">ClientArrayOffset</a>;
01944 
01945     } <span class="keywordflow">else</span> {
01946 
01947         <span class="comment">//</span>
01948         <span class="comment">//  We shouldn't see any of the older disks now.</span>
01949         <span class="comment">//</span>
01950 
01951         OffsetInRestart = FIELD_OFFSET( <a class="code" href="../../d6/d0/struct__LFS__OLD__RESTART__AREA.html">LFS_OLD_RESTART_AREA</a>, LogClientArray );
01952     }
01953 
01954     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a62">QuadAlign</a>( OffsetInRestart ) != OffsetInRestart
01955         || (PageHeader-&gt;RestartOffset + OffsetInRestart) &gt; <a class="code" href="../../d9/d3/lfsdisk_8h.html#a4">FIRST_STRIDE</a>) {
01956 
01957         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01958     }
01959 
01960     <span class="comment">//</span>
01961     <span class="comment">//  The full size of the restart area must fit in the system page specified by</span>
01962     <span class="comment">//  the page header.  We compute the size of the restart area by calculating</span>
01963     <span class="comment">//  the space needed by all clients.  We also check the given size of the</span>
01964     <span class="comment">//  restart area.</span>
01965     <span class="comment">//</span>
01966 
01967     OffsetInRestart += (RestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o1">LogClients</a> * <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">LFS_CLIENT_RECORD</a> ));
01968 
01969     <span class="keywordflow">if</span> (OffsetInRestart &gt; PageHeader-&gt;SystemPageSize ) {
01970 
01971         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01972     }
01973 
01974     <span class="comment">//</span>
01975     <span class="comment">//  If the log is packed, then check the restart length field and whether</span>
01976     <span class="comment">//  the entire restart area is contained in that length.</span>
01977     <span class="comment">//</span>
01978 
01979     <span class="keywordflow">if</span> (LogPacked
01980         &amp;&amp; ((ULONG) (PageHeader-&gt;RestartOffset + RestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o6">RestartAreaLength</a>) &gt; PageHeader-&gt;SystemPageSize
01981             || OffsetInRestart &gt; RestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o6">RestartAreaLength</a>)) {
01982 
01983         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01984     }
01985 
01986     <span class="comment">//</span>
01987     <span class="comment">//  As a final check make sure that the in use list and the free list are either</span>
01988     <span class="comment">//  empty or point to a valid client.</span>
01989     <span class="comment">//</span>
01990 
01991     <span class="keywordflow">if</span> ((RestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o2">ClientFreeList</a> != <a class="code" href="../../d9/d3/lfsdisk_8h.html#a21">LFS_NO_CLIENT</a>
01992          &amp;&amp; RestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o2">ClientFreeList</a> &gt;= RestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o1">LogClients</a>)
01993 
01994         || (RestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o3">ClientInUseList</a> != <a class="code" href="../../d9/d3/lfsdisk_8h.html#a21">LFS_NO_CLIENT</a>
01995             &amp;&amp; RestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o3">ClientInUseList</a> &gt;= RestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o1">LogClients</a>)) {
01996 
01997         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01998     }
01999 
02000     <span class="comment">//</span>
02001     <span class="comment">//  Make sure the sequence number bits match the log file size.</span>
02002     <span class="comment">//</span>
02003 
02004     FileSize = RestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o8">FileSize</a>;
02005 
02006     <span class="keywordflow">for</span> (SeqNumberBits = 0;
02007          ( FileSize != 0 );
02008          SeqNumberBits += 1,
02009          FileSize = ((ULONGLONG)(FileSize)) &gt;&gt; 1 ) {
02010     }
02011 
02012     SeqNumberBits = (<span class="keyword">sizeof</span>( <a class="code" href="../../d6/d3/lfs_8h.html#a10">LSN</a> ) * 8) + 3 - SeqNumberBits;
02013 
02014     <span class="keywordflow">if</span> (SeqNumberBits != RestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o5">SeqNumberBits</a>) {
02015 
02016         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02017     }
02018 
02019     <span class="comment">//</span>
02020     <span class="comment">//  We will check the fields that apply only to a packed log file.</span>
02021     <span class="comment">//</span>
02022 
02023     <span class="keywordflow">if</span> (LogPacked) {
02024 
02025         <span class="comment">//</span>
02026         <span class="comment">//  The log page data offset and record header length must be</span>
02027         <span class="comment">//  quad-aligned.</span>
02028         <span class="comment">//</span>
02029 
02030         <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d5/cc_8h.html#a62">QuadAlign</a>( RestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o11">LogPageDataOffset</a> ) != RestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o11">LogPageDataOffset</a> ) || 
02031             (<a class="code" href="../../d5/d5/cc_8h.html#a62">QuadAlign</a>( RestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o10">RecordHeaderLength</a> ) != RestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o10">RecordHeaderLength</a> )) {
02032 
02033             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02034         }
02035     }
02036 
02037     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02038 }
02039 
02040 
02041 <span class="comment">//</span>
02042 <span class="comment">//  Local support routine</span>
02043 <span class="comment">//</span>
02044 
02045 BOOLEAN
<a name="l02046"></a><a class="code" href="../../d7/d2/lfs_2cachesup_8c.html#a4">02046</a> <a class="code" href="../../d7/d2/lfs_2cachesup_8c.html#a4">LfsIsClientAreaValid</a> (
02047     IN <a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html">PLFS_RESTART_PAGE_HEADER</a> PageHeader,
02048     IN BOOLEAN LogPacked,
02049     IN BOOLEAN UsaError
02050     )
02051 
02052 <span class="comment">/*++</span>
02053 <span class="comment"></span>
02054 <span class="comment">Routine Description:</span>
02055 <span class="comment"></span>
02056 <span class="comment">    This routine is called to verify that the client array is valid.  We test</span>
02057 <span class="comment">    if the client lists are correctly chained.  If the entire restart area is</span>
02058 <span class="comment">    within the first Usa stride, we will ignore any Usa errors.</span>
02059 <span class="comment"></span>
02060 <span class="comment">Arguments:</span>
02061 <span class="comment"></span>
02062 <span class="comment">    PageHeader - This is the page to examine.</span>
02063 <span class="comment"></span>
02064 <span class="comment">    LogPacked - Indicates if the log file is packed.</span>
02065 <span class="comment"></span>
02066 <span class="comment">    UsaError - There was a Usa error in reading the full page.</span>
02067 <span class="comment"></span>
02068 <span class="comment">Return Value:</span>
02069 <span class="comment"></span>
02070 <span class="comment">    BOOLEAN - TRUE if there is no corruption in client array values.</span>
02071 <span class="comment">              FALSE otherwise.</span>
02072 <span class="comment"></span>
02073 <span class="comment">--*/</span>
02074 
02075 {
02076     <a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a> RestartArea;
02077     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> ThisClientIndex;
02078     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> ClientCount;
02079 
02080     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ClientArray;
02081     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ThisClient;
02082 
02083     ULONG LoopCount;
02084 
02085     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02086 
02087     RestartArea = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( PageHeader, PageHeader-&gt;RestartOffset, <a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a> );
02088 
02089     <span class="comment">//</span>
02090     <span class="comment">//  If there was a Usa error and the restart area isn't contained in the</span>
02091     <span class="comment">//  first Usa stride, then we have an error.</span>
02092     <span class="comment">//</span>
02093 
02094     <span class="keywordflow">if</span> (UsaError
02095         &amp;&amp; (RestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o6">RestartAreaLength</a> + PageHeader-&gt;RestartOffset) &gt; <a class="code" href="../../d9/d3/lfsdisk_8h.html#a4">FIRST_STRIDE</a>) {
02096 
02097         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02098     }
02099 
02100     <span class="comment">//</span>
02101     <span class="comment">//  Find the start of the client array.</span>
02102     <span class="comment">//</span>
02103 
02104     <span class="keywordflow">if</span> (LogPacked) {
02105 
02106         ClientArray = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( RestartArea,
02107                                RestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o7">ClientArrayOffset</a>,
02108                                <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> );
02109 
02110     } <span class="keywordflow">else</span> {
02111 
02112         <span class="comment">//</span>
02113         <span class="comment">//  Handle the case where the offset of the client array is fixed.</span>
02114         <span class="comment">//</span>
02115 
02116         ClientArray = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( RestartArea,
02117                                FIELD_OFFSET( <a class="code" href="../../d6/d0/struct__LFS__OLD__RESTART__AREA.html">LFS_OLD_RESTART_AREA</a>,
02118                                              LogClientArray ),
02119                                <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> );
02120     }
02121 
02122     <span class="comment">//</span>
02123     <span class="comment">//  Start with the free list.  Check that all the clients are valid and</span>
02124     <span class="comment">//  that there isn't a cycle.  Do the in-use list on the second pass.</span>
02125     <span class="comment">//</span>
02126 
02127     ThisClientIndex = RestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o2">ClientFreeList</a>;
02128 
02129     LoopCount = 2;
02130 
02131     <span class="keywordflow">do</span> {
02132 
02133         BOOLEAN FirstClient;
02134 
02135         FirstClient = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02136 
02137         ClientCount = RestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o1">LogClients</a>;
02138 
02139         <span class="keywordflow">while</span> (ThisClientIndex != <a class="code" href="../../d9/d3/lfsdisk_8h.html#a21">LFS_NO_CLIENT</a>) {
02140 
02141             <span class="comment">//</span>
02142             <span class="comment">//  If the client count is zero then we must have hit a loop.</span>
02143             <span class="comment">//  If the client index is greater or equal to the log client</span>
02144             <span class="comment">//  count then the list is corrupt.</span>
02145             <span class="comment">//</span>
02146 
02147             <span class="keywordflow">if</span> (ClientCount == 0
02148                 || ThisClientIndex &gt;= RestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o1">LogClients</a>) {
02149 
02150                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02151             }
02152 
02153             ClientCount -= 1;
02154 
02155             ThisClient = ClientArray + ThisClientIndex;
02156             ThisClientIndex = ThisClient-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o3">NextClient</a>;
02157 
02158             <span class="comment">//</span>
02159             <span class="comment">//  If this is the first client, then the previous value</span>
02160             <span class="comment">//  should indicate no client.</span>
02161             <span class="comment">//</span>
02162 
02163             <span class="keywordflow">if</span> (FirstClient) {
02164 
02165                 FirstClient = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02166 
02167                 <span class="keywordflow">if</span> (ThisClient-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o2">PrevClient</a> != <a class="code" href="../../d9/d3/lfsdisk_8h.html#a21">LFS_NO_CLIENT</a>) {
02168 
02169                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02170                 }
02171             }
02172         }
02173 
02174         ThisClientIndex = RestartArea-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o3">ClientInUseList</a>;
02175 
02176     } <span class="keywordflow">while</span> (--LoopCount);
02177 
02178     <span class="comment">//</span>
02179     <span class="comment">//  The client list is valid.</span>
02180     <span class="comment">//</span>
02181 
02182     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02183 }
02184 
02185 
02186 <span class="comment">//</span>
02187 <span class="comment">//  Local support routine.</span>
02188 <span class="comment">//</span>
02189 
02190 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02191"></a><a class="code" href="../../d7/d2/lfs_2cachesup_8c.html#a5">02191</a> <a class="code" href="../../d7/d2/lfs_2cachesup_8c.html#a5">LfsFindFirstIo</a> (
02192     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
02193     IN <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> TargetLbcb,
02194     IN <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> FirstLbcb,
02195     OUT <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> *NextLbcb,
02196     OUT PLONGLONG FileOffset,
02197     OUT PBOOLEAN ContainsLastEntry,
02198     OUT PBOOLEAN LfsRestart,
02199     OUT PBOOLEAN UseTailCopy,
02200     OUT PULONG IoBlocks
02201     )
02202 
02203 <span class="comment">/*++</span>
02204 <span class="comment"></span>
02205 <span class="comment">Routine Description:</span>
02206 <span class="comment"></span>
02207 <span class="comment">    This routine walks through the linked Lbcb's for a Lfcb and groups</span>
02208 <span class="comment">    as many of them as can be grouped into a single I/O transfer.</span>
02209 <span class="comment">    It updates pointers to indicate the file offset and length of the</span>
02210 <span class="comment">    transfer, whether the I/O includes a particular Lbcb, whether the</span>
02211 <span class="comment">    transfer is a restart area or a log record page and the number of</span>
02212 <span class="comment">    Lbcb's included in the transfer.  We only flush a single log page</span>
02213 <span class="comment">    if we are passing through the file for the first time.</span>
02214 <span class="comment"></span>
02215 <span class="comment">Arguments:</span>
02216 <span class="comment"></span>
02217 <span class="comment">    Lfcb - This is the file control block for the log file.</span>
02218 <span class="comment"></span>
02219 <span class="comment">    TargetLbcb - This is the Lbcb that the caller wants to have included in</span>
02220 <span class="comment">        the transfer.</span>
02221 <span class="comment"></span>
02222 <span class="comment">    FirstLbcb - This is the first Lbcb to look at in the list.</span>
02223 <span class="comment"></span>
02224 <span class="comment">    NextLbcb - This is the Lbcb to look at first on the next call to this</span>
02225 <span class="comment">        routine.</span>
02226 <span class="comment"></span>
02227 <span class="comment">    FileOffset - Supplies the address where we store the offset in the</span>
02228 <span class="comment">        log file of this transfer.</span>
02229 <span class="comment"></span>
02230 <span class="comment">    ContainsLastEntry - Supplies the address where we store whether this</span>
02231 <span class="comment">        I/O includes the 'LastEntry' Lbcb.</span>
02232 <span class="comment"></span>
02233 <span class="comment">    LfsRestart - Supplies the address where we store whether this transfer</span>
02234 <span class="comment">        is a Lfs restart area.</span>
02235 <span class="comment"></span>
02236 <span class="comment">    UseTailCopy - Supplies the address where we store whether we should</span>
02237 <span class="comment">        use of page for a copy of the end of the log file.</span>
02238 <span class="comment"></span>
02239 <span class="comment">    IoBlocks - Supplies the address where we store the number of Lbcb's</span>
02240 <span class="comment">        for this transfer.</span>
02241 <span class="comment"></span>
02242 <span class="comment">Return Value:</span>
02243 <span class="comment"></span>
02244 <span class="comment">    None.</span>
02245 <span class="comment"></span>
02246 <span class="comment">--*/</span>
02247 
02248 {
02249     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02250 
02251     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsFindFirstIo:  Entered\n"</span>, 0 );
02252     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Lfcb          -&gt; %08lx\n"</span>, Lfcb );
02253 
02254     <span class="comment">//</span>
02255     <span class="comment">//  Initialize the file offset, length and io blocks values.</span>
02256     <span class="comment">//  Also assume the last entry is not contained here.</span>
02257     <span class="comment">//  Also assume we have no next Lbcb.</span>
02258     <span class="comment">//</span>
02259 
02260     *FileOffset = FirstLbcb-&gt;FileOffset;
02261     *IoBlocks = 1;
02262 
02263     *LfsRestart = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02264     *UseTailCopy = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02265 
02266     *NextLbcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02267 
02268     <span class="comment">//</span>
02269     <span class="comment">//  Check if we have found the desired Lbcb.  We reject the match</span>
02270     <span class="comment">//  if the Lbcb indicates that we should flush the copy first.</span>
02271     <span class="comment">//</span>
02272 
02273     <span class="keywordflow">if</span> (FirstLbcb == TargetLbcb
02274         &amp;&amp; !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( TargetLbcb-&gt;LbcbFlags, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a3">LBCB_FLUSH_COPY</a> )) {
02275 
02276         *ContainsLastEntry = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02277 
02278     } <span class="keywordflow">else</span> {
02279 
02280         *ContainsLastEntry = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02281     }
02282 
02283     <span class="comment">//</span>
02284     <span class="comment">//  Check if this is a restart block or if we are passing through the log</span>
02285     <span class="comment">//  file for the first time or if this Lbcb is still in the active queue.</span>
02286     <span class="comment">//  If not, then group as many of the Lbcb's as can be part of a single Io.</span>
02287     <span class="comment">//</span>
02288 
02289     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d4/lfsprocs_8h.html#a20">LfsLbcbIsRestart</a>( FirstLbcb )) {
02290 
02291         *LfsRestart = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02292 
02293     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a8">LFCB_PACK_LOG</a> )
02294                &amp;&amp; (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( FirstLbcb-&gt;LbcbFlags, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a3">LBCB_FLUSH_COPY</a> | <a class="code" href="../../d1/d4/lfsstruc_8h.html#a1">LBCB_ON_ACTIVE_QUEUE</a> ))) {
02295 
02296         *UseTailCopy = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02297 
02298         <span class="comment">//</span>
02299         <span class="comment">//  If we haven't found the last entry then we want to resume from</span>
02300         <span class="comment">//  this same Lbcb if we flushed a copy otherwise we will want to</span>
02301         <span class="comment">//  go to the next Lbcb.</span>
02302         <span class="comment">//</span>
02303 
02304         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( FirstLbcb-&gt;LbcbFlags, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a3">LBCB_FLUSH_COPY</a> )) {
02305 
02306             *NextLbcb = FirstLbcb;
02307             <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( FirstLbcb-&gt;LbcbFlags, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a3">LBCB_FLUSH_COPY</a> );
02308         }
02309 
02310     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a6">LFCB_MULTIPLE_PAGE_IO</a> )) {
02311 
02312         <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> EndOfPageLbcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02313         ULONG EndOfPageIoBlocks;
02314 
02315         <span class="comment">//</span>
02316         <span class="comment">//  We loop until there are no more blocks or they aren't</span>
02317         <span class="comment">//  contiguous in the file or we have found an entry on the</span>
02318         <span class="comment">//  active queue or we found an entry where we want to explicitly</span>
02319         <span class="comment">//  flush a copy first.</span>
02320         <span class="comment">//</span>
02321 
02322         <span class="keywordflow">while</span> ((FirstLbcb-&gt;WorkqueLinks.Flink != &amp;Lfcb-&gt;LbcbWorkque) &amp;&amp;
02323                !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( FirstLbcb-&gt;LbcbFlags, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a1">LBCB_ON_ACTIVE_QUEUE</a> )) {
02324 
02325             LONGLONG ExpectedFileOffset;
02326             <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> TempLbcb;
02327 
02328             <span class="comment">//</span>
02329             <span class="comment">//  Get the next Lbcb.</span>
02330             <span class="comment">//</span>
02331 
02332             TempLbcb = CONTAINING_RECORD( FirstLbcb-&gt;WorkqueLinks.Flink,
02333                                           <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
02334                                           WorkqueLinks );
02335 
02336             <span class="comment">//</span>
02337             <span class="comment">//  Break out of the loop if the file offset is not the</span>
02338             <span class="comment">//  expected value or the next entry is on the active queue.</span>
02339             <span class="comment">//</span>
02340 
02341             ExpectedFileOffset = FirstLbcb-&gt;FileOffset + Lfcb-&gt;LogPageSize;
02342 
02343             <span class="comment">//</span>
02344             <span class="comment">//  We want to stop at this point if the next Lbcb is not</span>
02345             <span class="comment">//  the expected offset or we are packing the log file and</span>
02346             <span class="comment">//  the next Lbcb is on the active queue or we want to write</span>
02347             <span class="comment">//  a copy of the data before this page goes out.</span>
02348             <span class="comment">//</span>
02349 
02350             <span class="keywordflow">if</span> ((TempLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o4">FileOffset</a> != ExpectedFileOffset) ||
02351                 (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;Flags, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a8">LFCB_PACK_LOG</a> ) &amp;&amp;
02352                  <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( TempLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o13">LbcbFlags</a>, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a3">LBCB_FLUSH_COPY</a> | <a class="code" href="../../d1/d4/lfsstruc_8h.html#a1">LBCB_ON_ACTIVE_QUEUE</a>))) {
02353 
02354                 <span class="comment">//</span>
02355                 <span class="comment">//  Use the Lbcb at the end of a page if possible.</span>
02356                 <span class="comment">//</span>
02357 
02358                 <span class="keywordflow">if</span> (EndOfPageLbcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02359 
02360                     FirstLbcb = EndOfPageLbcb;
02361                     *IoBlocks = EndOfPageIoBlocks;
02362                 }
02363 
02364                 <span class="keywordflow">break</span>;
02365             }
02366 
02367             <span class="comment">//</span>
02368             <span class="comment">//  We can add this to our I/o.  Increment the Io blocks</span>
02369             <span class="comment">//  and length of the transfer.  Also check if this entry</span>
02370             <span class="comment">//  is the Last Entry specified by the caller.</span>
02371             <span class="comment">//</span>
02372 
02373             *IoBlocks += 1;
02374 
02375             <span class="keywordflow">if</span> (TempLbcb == TargetLbcb ) {
02376 
02377                 *ContainsLastEntry = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02378             }
02379 
02380             <span class="comment">//</span>
02381             <span class="comment">//  Check if this Lbcb is at the end of a system page.</span>
02382             <span class="comment">//</span>
02383 
02384             <span class="keywordflow">if</span> (*ContainsLastEntry &amp;&amp;
02385                 (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> != (ULONG) Lfcb-&gt;SystemPageSize) &amp;&amp;
02386                 !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( ((ULONG) TempLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o4">FileOffset</a> + (ULONG) Lfcb-&gt;LogPageSize),
02387                          <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1 )) {
02388 
02389                 EndOfPageLbcb = TempLbcb;
02390                 EndOfPageIoBlocks = *IoBlocks;
02391             }
02392 
02393             <span class="comment">//</span>
02394             <span class="comment">//  Use this entry as the current entry.</span>
02395             <span class="comment">//</span>
02396 
02397             FirstLbcb = TempLbcb;
02398         }
02399     }
02400 
02401     <span class="comment">//</span>
02402     <span class="comment">//  If the current Lbcb is on the active queue and we aren't using</span>
02403     <span class="comment">//  a tail copy, then remove this from the active queue.  If this</span>
02404     <span class="comment">//  not our target and removing this will cause us to swallow up</span>
02405     <span class="comment">//  part of our reserved quota then back up one Lbcb.</span>
02406     <span class="comment">//</span>
02407 
02408     <span class="keywordflow">if</span> (!(*UseTailCopy) &amp;&amp; <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( FirstLbcb-&gt;LbcbFlags, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a1">LBCB_ON_ACTIVE_QUEUE</a> )) {
02409 
02410         <span class="keywordflow">if</span> (Lfcb-&gt;CurrentAvailable &lt; Lfcb-&gt;TotalUndoCommitment) {
02411 
02412             <span class="comment">//</span>
02413             <span class="comment">//  Move back one file record.</span>
02414             <span class="comment">//</span>
02415 
02416             *IoBlocks -= 1;
02417             *NextLbcb = FirstLbcb;
02418 
02419         <span class="comment">//</span>
02420         <span class="comment">//  Otherwise remove it from the active queue.</span>
02421         <span class="comment">//</span>
02422 
02423         } <span class="keywordflow">else</span> {
02424 
02425             <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( FirstLbcb-&gt;LbcbFlags, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a1">LBCB_ON_ACTIVE_QUEUE</a> );
02426             RemoveEntryList( &amp;FirstLbcb-&gt;ActiveLinks );
02427         }
02428     }
02429 
02430     <span class="comment">//</span>
02431     <span class="comment">//  If we haven't found the Lbcb to restart from we will just use the</span>
02432     <span class="comment">//  next Lbcb after the last one found.</span>
02433     <span class="comment">//</span>
02434 
02435     <span class="keywordflow">if</span> (*NextLbcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02436 
02437         *NextLbcb = CONTAINING_RECORD( FirstLbcb-&gt;WorkqueLinks.Flink,
02438                                        <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a>,
02439                                        WorkqueLinks );
02440     }
02441 
02442     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"File Offset (Low)     -&gt; %08lx\n"</span>, FileOffset-&gt;LowPart );
02443     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"File Offset (High)    -&gt; %08lx\n"</span>, FileOffset-&gt;HighPart );
02444     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Contains Last Entry   -&gt; %08x\n"</span>, *ContainsLastEntry );
02445     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsRestart            -&gt; %08x\n"</span>, *LfsRestart );
02446     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"IoBlocks              -&gt; %08lx\n"</span>, *IoBlocks );
02447     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsFindFirstIo:  Exit\n"</span>, 0 );
02448 
02449     <span class="keywordflow">return</span>;
02450 }
02451 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:19 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
