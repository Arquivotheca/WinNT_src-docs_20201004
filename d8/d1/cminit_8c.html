<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cminit.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cminit.c File Reference</h1><code>#include "<a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>"</code><br>

<p>
<a href="../../d9/d0/cminit_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/cminit_8c.html#a2">CmpOpenFileWithExtremePrejudice</a> (OUT PHANDLE Primary, IN POBJECT_ATTRIBUTES Obja, IN ULONG IoFlags, IN ULONG AttributeFlags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/cminit_8c.html#a3">CmpOpenHiveFiles</a> (PUNICODE_STRING <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a6">BaseName</a>, PWSTR Extension OPTIONAL, PHANDLE Primary, PHANDLE Secondary, PULONG PrimaryDisposition, PULONG SecondaryDisposition, BOOLEAN CreateAllowed, BOOLEAN MarkAsSystemHive, OUT OPTIONAL PULONG ClusterSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/cminit_8c.html#a4">CmpInitializeHive</a> (<a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> *CmHive, ULONG OperationType, ULONG HiveFlags, ULONG FileType, PVOID HiveData OPTIONAL, HANDLE Primary, HANDLE Alternate, HANDLE Log, HANDLE External, PUNICODE_STRING <a class="el" href="../../d8/d1/hivestat_8c.html#a9">FileName</a> OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/cminit_8c.html#a5">CmpDestroyHive</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/cminit_8c.html#a0">CmpMasterHive</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/cminit_8c.html#a1">CmpHiveListHead</a></td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a5" doxytag="cminit.c::CmpDestroyHive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpDestroyHive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/cminit_8c-source.html#l00667">667</a> of file <a class="el" href="../../d9/d0/cminit_8c-source.html">cminit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00140">CmpFreeKeyByCell()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00036">CmpMasterHive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d5/d5/regext_8c-source.html#l00033">HiveList</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00537">_CELL_DATA::_u::KeyNode</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00453">_CM_KEY_NODE::Parent</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02079">CmUnloadKey()</a>.
<p>
<pre class="fragment"><div>00674                    :
00675 
00676     This routine tears down a cmhive.
00677 
00678 Arguments:
00679 
00680     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive to be freed.
00681 
00682     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - Supplies index of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive's root cell.
00683 
00684 Return Value:
00685 
00686     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> successful
00687     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> some <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> occurred
00688 
00689 --*/
00690 
00691 {
00692     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> CellData;
00693     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> LinkCell;
00694     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00695 
00696     <span class="comment">//</span>
00697     <span class="comment">// First find the link cell.</span>
00698     <span class="comment">//</span>
00699     CellData = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Cell);
00700     LinkCell = CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a>;
00701 
00702     <span class="comment">//</span>
00703     <span class="comment">// Now delete the link cell.</span>
00704     <span class="comment">//</span>
00705     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FIELD_OFFSET(<a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive) == 0);
00706     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d3/cmtredel_8c.html#a1">CmpFreeKeyByCell</a>((<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)CmpMasterHive, LinkCell, TRUE);
00707 
00708     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00709         <span class="comment">//</span>
00710         <span class="comment">// Take the hive out of the hive list</span>
00711         <span class="comment">//</span>
00712         RemoveEntryList(&amp;( ((<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)Hive)-&gt;HiveList));
00713         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00714     } <span class="keywordflow">else</span> {
00715         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00716     }
00717 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="cminit.c::CmpInitializeHive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpInitializeHive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>CmHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>OperationType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>HiveFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID HiveData&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Primary</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Alternate</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Log</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>External</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUNICODE_STRING <a class="el" href="../../d8/d1/hivestat_8c.html#a9">FileName</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">471</a> of file <a class="el" href="../../d9/d0/cminit_8c-source.html">cminit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00360">ASSERT_PASSIVE_LEVEL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00108">CmCheckRegistry()</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a178">CMHIVE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00062">CmpAllocate()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00772">CmpFileFlush()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00351">CmpFileRead()</a>, <a class="el" href="../../d9/d2/cmwrapr2_8c-source.html#l00045">CmpFileSetSize()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00516">CmpFileWrite()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00186">CmpFree()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00027">CmpHiveListHead</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00256">CMS_INIT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00272">CMS_INIT_ERROR</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00367">ExInitializeFastMutex</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00650">_CMHIVE::FileHandles</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00047">FileName</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00569">HFILE_TYPE_ALTERNATE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00571">HFILE_TYPE_EXTERNAL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00570">HFILE_TYPE_LOG</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00572">HFILE_TYPE_MAX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00568">HFILE_TYPE_PRIMARY</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00199">HINIT_FILE</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00198">HINIT_MEMORY</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00200">HINIT_MEMORY_INPLACE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00649">_CMHIVE::Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00203">HIVE_VOLATILE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00652">_CMHIVE::HiveList</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00653">_CMHIVE::HiveLock</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00129">HSECTOR_SIZE</a>, <a class="el" href="../../d3/d0/hivefree_8c-source.html#l00034">HvFreeHive()</a>, <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00158">HvInitializeHive()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00651">_CMHIVE::NotifyList</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01439">CmpCreateTemporaryHive()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02422">CmpInitHiveFromFile()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02022">CmpInitializeSystemHive()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00484">CmpLoadHiveVolatile()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l04077">CmpValidateAlternate()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00097">CmRestoreKey()</a>, <a class="el" href="../../d0/d4/edithive_8c-source.html#l00156">EhOpenHive()</a>, and <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00405">MyCmpInitHiveFromFile()</a>.
<p>
<pre class="fragment"><div>00485                    :
00486 
00487     Initialize a hive.
00488 
00489 Arguments:
00490 
00491     CmHive - pointer to a variable to receive a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CmHive structure
00492 
00493     OperationType - specifies whether to create a <span class="keyword">new</span> hive from scratch,
00494             from a memory image, or by reading a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> from disk.
00495             [<a class="code" href="../../d6/d0/hive_8h.html#a4">HINIT_CREATE</a> | <a class="code" href="../../d6/d0/hive_8h.html#a5">HINIT_MEMORY</a> | <a class="code" href="../../d6/d0/hive_8h.html#a6">HINIT_FILE</a> ]
00496 
00497     HiveFlags - <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a> - Entire hive <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be <span class="keyword">volatile</span>, regardless
00498                                    of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> types of cells allocated
00499                 HIVE_NO_LAZY_FLUSH - Data in <span class="keyword">this</span> hive <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> never written
00500                                    to disk except by an <span class="keyword">explicit</span> FlushKey
00501 
00502     FileType - HFILE_TYPE_*, <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a> or <a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a> set
00503             up <span class="keywordflow">for</span> logging or alternate support respectively.
00504 
00505     HiveData - <span class="keywordflow">if</span> present, supplies a pointer to an in memory image of
00506             from which to init <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive.  Only useful when OperationType
00507             <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set to <a class="code" href="../../d6/d0/hive_8h.html#a5">HINIT_MEMORY</a>.
00508 
00509     Primary - <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> handle <span class="keywordflow">for</span> primary hive <a class="code" href="../../d7/d1/genuedef_8c.html#a9">file</a> (e.g. SYSTEM)
00510 
00511     Alternate - File handle for alternate hive file (e.g. SYSTEM.ALT)
00512 
00513     Log - File handle for log hive file (e.g. SOFTWARE.LOG)
00514 
00515     External - File handle for primary hive file  (e.g.  BACKUP.REG)
00516 
00517     FileName - some path like "...\system32\config\system", which will
00518                 be written into the base block as an aid to debugging.
00519                 may be NULL.
00520 
00521 Return Value:
00522 
00523     NTSTATUS
00524 
00525 --*/
00526 {
00527     FILE_FS_SIZE_INFORMATION    FsSizeInformation;
00528     IO_STATUS_BLOCK             IoStatusBlock;
00529     ULONG                       Cluster;
00530     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00531     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>                     cmhive2;
00532     ULONG                       rc;
00533 
00534     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INIT) {
00535         KdPrint((<span class="stringliteral">"CmpInitializeHive:\t\n"</span>));
00536     }
00537 
00538     <span class="comment">//</span>
00539     <span class="comment">// Reject illegal parms</span>
00540     <span class="comment">//</span>
00541     <span class="keywordflow">if</span> ( (Alternate &amp;&amp; Log)  ||
00542          (External &amp;&amp; (Primary || Alternate || Log)) ||
00543          (Alternate &amp;&amp; !Primary) ||
00544          (Log &amp;&amp; !Primary) ||
00545          ((HiveFlags &amp; <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a>) &amp;&amp; (Alternate || Primary || External || Log)) ||
00546          ((OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a5">HINIT_MEMORY</a>) &amp;&amp; (!ARGUMENT_PRESENT(HiveData))) ||
00547          (Log &amp;&amp; (FileType != <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>)) ||
00548          (Alternate &amp;&amp; (FileType != <a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a>))
00549        )
00550     {
00551         <span class="keywordflow">return</span> (STATUS_INVALID_PARAMETER);
00552     }
00553 
00554     <span class="comment">//</span>
00555     <span class="comment">// compute control</span>
00556     <span class="comment">//</span>
00557     <span class="keywordflow">if</span> (Primary) {
00558 
00559         <a class="code" href="../../d1/d2/cmp_8h.html#a63">ASSERT_PASSIVE_LEVEL</a>();
00560         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQueryVolumeInformationFile(
00561                     Primary,
00562                     &amp;IoStatusBlock,
00563                     &amp;FsSizeInformation,
00564                     <span class="keyword">sizeof</span>(FILE_FS_SIZE_INFORMATION),
00565                     FileFsSizeInformation
00566                     );
00567         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00568             <span class="keywordflow">return</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00569         }
00570         <span class="keywordflow">if</span> (FsSizeInformation.BytesPerSector &gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) {
00571             <span class="keywordflow">return</span> (STATUS_REGISTRY_IO_FAILED);
00572         }
00573         Cluster = FsSizeInformation.BytesPerSector / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00574         Cluster = (Cluster &lt; 1) ? 1 : Cluster;
00575     } <span class="keywordflow">else</span> {
00576         Cluster = 1;
00577     }
00578 
00579     cmhive2 = <a class="code" href="../../d7/d3/cmwrapr_8c.html#a11">CmpAllocate</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>), FALSE);
00580     <span class="keywordflow">if</span> (cmhive2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00581         <span class="keywordflow">return</span> (STATUS_INSUFFICIENT_RESOURCES);
00582     }
00583 
00584     <span class="comment">//</span>
00585     <span class="comment">// Allocate the mutex from NonPagedPool so it will not be swapped to the disk</span>
00586     <span class="comment">//</span>
00587     cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a> = (<a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(NonPagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a>), CM_POOL_TAG );
00588     <span class="keywordflow">if</span>( cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00589         <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(cmhive2, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>));
00590         <span class="keywordflow">return</span> (STATUS_INSUFFICIENT_RESOURCES);
00591     }
00592 
00593     <span class="comment">//</span>
00594     <span class="comment">// Initialize the Cm hive control block</span>
00595     <span class="comment">//</span>
00596     <span class="comment">//</span>
00597     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((HFILE_TYPE_EXTERNAL+1) == HFILE_TYPE_MAX);
00598     cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>] = Primary;
00599     cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a>] = Alternate;
00600     cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>] = Log;
00601     cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a41">HFILE_TYPE_EXTERNAL</a>] = External;
00602 
00603     cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o2">NotifyList</a>.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00604     cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o2">NotifyList</a>.Blink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00605 
00606     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a>);
00607 
00608     <span class="comment">//</span>
00609     <span class="comment">// Initialize the Hv hive control block</span>
00610     <span class="comment">//</span>
00611     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/hiveinit_8c.html#a3">HvInitializeHive</a>(
00612                 &amp;(cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>),
00613                 OperationType,
00614                 HiveFlags,
00615                 FileType,
00616                 HiveData,
00617                 CmpAllocate,
00618                 CmpFree,
00619                 CmpFileSetSize,
00620                 CmpFileWrite,
00621                 CmpFileRead,
00622                 CmpFileFlush,
00623                 Cluster,
00624                 FileName
00625                 );
00626     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00627         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INIT_ERROR) {
00628             KdPrint((<span class="stringliteral">"CmpInitializeHive: "</span>));
00629             KdPrint((<span class="stringliteral">"HvInitializeHive failed, Status = %08lx\n"</span>, Status));
00630         }
00631         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a> );
00632         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a>);
00633         <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(cmhive2, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>));
00634         <span class="keywordflow">return</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00635     }
00636     <span class="keywordflow">if</span> ( (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a6">HINIT_FILE</a>) ||
00637          (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a5">HINIT_MEMORY</a>) ||
00638          (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a7">HINIT_MEMORY_INPLACE</a>))
00639     {
00640         rc = <a class="code" href="../../d1/d2/cmp_8h.html#a294">CmCheckRegistry</a>(cmhive2, TRUE);
00641         <span class="keywordflow">if</span> (rc != 0) {
00642             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INIT_ERROR) {
00643                 KdPrint((<span class="stringliteral">"CmpInitializeHive: "</span>));
00644                 KdPrint((<span class="stringliteral">"CmCheckRegistry failed, rc = %08lx\n"</span>,rc));
00645             }
00646             <span class="comment">//</span>
00647             <span class="comment">// in theory we should do this for MEMORY and MEMORY_INPLACE</span>
00648             <span class="comment">// as well, but they're only used at init time.</span>
00649             <span class="comment">//</span>
00650             <span class="keywordflow">if</span> (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a6">HINIT_FILE</a>) {
00651                 <a class="code" href="../../d2/d1/hivefree_8c.html#a0">HvFreeHive</a>((<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)cmhive2);
00652             }
00653             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a> );
00654             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a>);
00655             <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(cmhive2, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>));
00656             <span class="keywordflow">return</span>(STATUS_REGISTRY_CORRUPT);
00657         }
00658     }
00659 
00660     InsertHeadList(&amp;CmpHiveListHead, &amp;(cmhive2-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o3">HiveList</a>));
00661     *CmHive = cmhive2;
00662     <span class="keywordflow">return</span> (STATUS_SUCCESS);
00663 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="cminit.c::CmpOpenFileWithExtremePrejudice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpOpenFileWithExtremePrejudice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Primary</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>Obja</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>IoFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AttributeFlags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/cminit_8c-source.html#l00721">721</a> of file <a class="el" href="../../d9/d0/cminit_8c-source.html">cminit.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00360">ASSERT_PASSIVE_LEVEL</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00418">ZwCreateFile()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00582">ZwOpenFile()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00729">ZwQueryAttributesFile()</a>, and <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00861">ZwSetInformationFile()</a>.
<p>
Referenced by <a class="el" href="../../d9/d0/cminit_8c-source.html#l00046">CmpOpenHiveFiles()</a>.
<p>
<pre class="fragment"><div>00730                    :
00731 
00732     This routine opens a hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> that some foolish person has put a
00733     read-<a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> attribute on. It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to prevent people from hurting
00734     themselves by making <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> critical system hive files read-<a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>.
00735 
00736 Arguments:
00737 
00738     Primary - Returns handle to <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
00739 
00740     Obja - Supplies Object Attributes of <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00741 
00742     IoFlags - Supplies flags to pass to <a class="code" href="../../d6/d9/restrfil_8c.html#a31">ZwCreateFile</a>
00743 
00744 Return Value:
00745 
00746     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00747 
00748 --*/
00749 
00750 {
00751     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00752     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00753     IO_STATUS_BLOCK IoStatusBlock;
00754     FILE_BASIC_INFORMATION FileInfo;
00755 
00756     <span class="comment">//</span>
00757     <span class="comment">// Get the current file attributes</span>
00758     <span class="comment">//</span>
00759     <a class="code" href="../../d1/d2/cmp_8h.html#a63">ASSERT_PASSIVE_LEVEL</a>();
00760     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a37">ZwQueryAttributesFile</a>(Obja, &amp;FileInfo);
00761     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00762         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00763     }
00764 
00765     <span class="comment">//</span>
00766     <span class="comment">// Clear the readonly bit.</span>
00767     <span class="comment">//</span>
00768     FileInfo.FileAttributes &amp;= ~FILE_ATTRIBUTE_READONLY;
00769 
00770     <span class="comment">//</span>
00771     <span class="comment">// Open the file</span>
00772     <span class="comment">//</span>
00773     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a33">ZwOpenFile</a>(&amp;Handle,
00774                         FILE_WRITE_ATTRIBUTES,
00775                         Obja,
00776                         &amp;IoStatusBlock,
00777                         FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE,
00778                         FILE_OPEN_FOR_BACKUP_INTENT);
00779     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00780         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00781     }
00782 
00783     <span class="comment">//</span>
00784     <span class="comment">// Set the new attributes</span>
00785     <span class="comment">//</span>
00786     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a39">ZwSetInformationFile</a>(Handle,
00787                                   &amp;IoStatusBlock,
00788                                   &amp;FileInfo,
00789                                   <span class="keyword">sizeof</span>(FileInfo),
00790                                   FileBasicInformation);
00791     ZwClose(Handle);
00792     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00793         <span class="comment">//</span>
00794         <span class="comment">// Reopen the file with the access that we really need.</span>
00795         <span class="comment">//</span>
00796         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a31">ZwCreateFile</a>(Primary,
00797                               FILE_READ_DATA | FILE_WRITE_DATA,
00798                               Obja,
00799                               &amp;IoStatusBlock,
00800                               NULL,
00801                               AttributeFlags,
00802                               0,
00803                               FILE_OPEN,
00804                               IoFlags,
00805                               NULL,
00806                               0);
00807     }
00808 
00809     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00810 
00811 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="cminit.c::CmpOpenHiveFiles" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpOpenHiveFiles           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PWSTR Extension&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Primary</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Secondary</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PrimaryDisposition</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SecondaryDisposition</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>CreateAllowed</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>MarkAsSystemHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT OPTIONAL PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ClusterSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/cminit_8c-source.html#l00046">46</a> of file <a class="el" href="../../d9/d0/cminit_8c-source.html">cminit.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00360">ASSERT_PASSIVE_LEVEL</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00062">BaseName</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00242">CML_BUGCHECK</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00313">CmpCreateEvent()</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00721">CmpOpenFileWithExtremePrejudice()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00272">CMS_INIT_ERROR</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00129">HSECTOR_SIZE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00663">RtlAppendStringToString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00067">WorkName</a>, and <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00418">ZwCreateFile()</a>.
<p>
<pre class="fragment"><div>00059                    :
00060 
00061     Open/<a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> Primary, Alternate, and Log files <span class="keywordflow">for</span> Hives.
00062 
00063     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> some name like <span class="stringliteral">"\winnt\system32\config\system"</span>.
00064     Extension <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="stringliteral">".alt"</span> or <span class="stringliteral">".log"</span> or <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
00065 
00066     If <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> skip secondary work.
00067 
00068     If <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> .alt or .log, open/create a secondary <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
00069     (e.g. <span class="stringliteral">"\winnt\system32\config\system.alt"</span>)
00070 
00071     If <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> .log, open secondary <span class="keywordflow">for</span> buffered I/O, <span class="keywordflow">else</span>,
00072     open <span class="keywordflow">for</span> non-buffered I/O.  Primary always uses non-buffered I/O.
00073 
00074     If primary <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> newly created, supersede secondary.  If secondary
00075     does not exist, simply create (other code will complain <span class="keywordflow">if</span> Log
00076     is needed but does not exist.)
00077 
00078     WARNING:    If Secondary handle is NULL, you have no log
00079                 or alternate!
00080 
00081 Arguments:
00082 
00083     BaseName - unicode string of base hive file, must have space <span class="keywordflow">for</span>
00084                 extension <span class="keywordflow">if</span> that is used.
00085 
00086     Extension - unicode type extension of secondary file, including
00087                 the leading <span class="stringliteral">"."</span>
00088 
00089     Primary - will get handle to primary file
00090 
00091     Secondary - will get handle to secondary, or NULL
00092 
00093     PrimaryDisposition - STATUS_SUCCESS or STATUS_CREATED, of primary <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00094 
00095     SecondaryDisposition - STATUS_SUCCESS or STATUS_CREATED, of secondary <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00096 
00097     CreateAllowed - <span class="keywordflow">if</span> TRUE will create nonexistent primary, <span class="keywordflow">if</span> FALSE will
00098                     fail <span class="keywordflow">if</span> primary does not exist.  no effect on log
00099 
00100     MarkAsSystemHive - <span class="keywordflow">if</span> TRUE will call into file system to mark <span class="keyword">this</span>
00101                        as a critical system hive.
00102 
00103     ClusterSize - <span class="keywordflow">if</span> not NULL, will compute and <span class="keywordflow">return</span> the appropriate
00104         cluster size <span class="keywordflow">for</span> the primary <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00105 
00106 Return Value:
00107 
00108     status - <span class="keywordflow">if</span> status is success, Primay succeeded, check Secondary
00109              value to see <span class="keywordflow">if</span> it succeeded.
00110 
00111 --*/
00112 {
00113     IO_STATUS_BLOCK     IoStatus;
00114     IO_STATUS_BLOCK     FsctlIoStatus;
00115     FILE_FS_SIZE_INFORMATION FsSizeInformation;
00116     ULONG Cluster;
00117     ULONG               CreateDisposition;
00118     OBJECT_ATTRIBUTES   ObjectAttributes;
00119     NTSTATUS            status;
00120     UNICODE_STRING      ExtName;
00121     UNICODE_STRING      WorkName;
00122     PVOID               WorkBuffer;
00123     USHORT              NameSize;
00124     ULONG               IoFlags;
00125     ULONG               AttributeFlags;
00126     USHORT              CompressionState;
00127     HANDLE              hEvent;
00128     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>             pEvent;
00129 
00130     <span class="comment">//</span>
00131     <span class="comment">// Allocate an event to use for our overlapped I/O</span>
00132     <span class="comment">//</span>
00133     status = <a class="code" href="../../d1/d2/cmp_8h.html#a223">CmpCreateEvent</a>(NotificationEvent, &amp;hEvent, &amp;pEvent);
00134     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00135         <span class="keywordflow">return</span>(status);
00136     }
00137     
00138     <span class="comment">//</span>
00139     <span class="comment">// Allocate a buffer big enough to hold the full name</span>
00140     <span class="comment">//</span>
00141     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>.Length = 0;
00142     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>.MaximumLength = 0;
00143     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>.Buffer = NULL;
00144     WorkBuffer = NULL;
00145 
00146     NameSize = <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>-&gt;Length;
00147     if (ARGUMENT_PRESENT(Extension)) {
00148         NameSize += (wcslen(Extension)+1) * <span class="keyword">sizeof</span>(WCHAR);
00149         WorkBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, NameSize);
00150         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>.Buffer = WorkBuffer;
00151         if (WorkBuffer == NULL) {
00152             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pEvent);
00153             ZwClose(hEvent);
00154             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00155         }
00156         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>.MaximumLength = NameSize;
00157         <a class="code" href="../../d2/d7/string_8c.html#a16">RtlAppendStringToString</a>((PSTRING)&amp;WorkName, (PSTRING)BaseName);
00158     } <span class="keywordflow">else</span> {
00159         WorkName = *BaseName;
00160     }
00161 
00162 
00163     <span class="comment">//</span>
00164     <span class="comment">// Open/Create the primary</span>
00165     <span class="comment">//</span>
00166     InitializeObjectAttributes(
00167         &amp;ObjectAttributes,
00168         &amp;WorkName,
00169         OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE,
00170         NULL,
00171         NULL
00172         );
00173 
00174     <span class="keywordflow">if</span> (CreateAllowed) {
00175         CreateDisposition = FILE_OPEN_IF;
00176     } <span class="keywordflow">else</span> {
00177         CreateDisposition = FILE_OPEN;
00178     }
00179 
00180     <a class="code" href="../../d1/d2/cmp_8h.html#a63">ASSERT_PASSIVE_LEVEL</a>();
00181 
00182     status = <a class="code" href="../../d6/d9/restrfil_8c.html#a31">ZwCreateFile</a>(
00183                 Primary,
00184                 FILE_READ_DATA | FILE_WRITE_DATA,
00185                 &amp;ObjectAttributes,
00186                 &amp;IoStatus,
00187                 NULL,                               <span class="comment">// alloc size = none</span>
00188                 FILE_ATTRIBUTE_NORMAL,
00189                 0,                                  <span class="comment">// share nothing</span>
00190                 CreateDisposition,
00191                 FILE_NO_INTERMEDIATE_BUFFERING | 
00192                 FILE_OPEN_FOR_BACKUP_INTENT |
00193                 FILE_NO_COMPRESSION,
00194                 NULL,                               <span class="comment">// eabuffer</span>
00195                 0                                   <span class="comment">// ealength</span>
00196                 );
00197     <span class="keywordflow">if</span> (status == STATUS_ACCESS_DENIED) {
00198 
00199         <span class="comment">//</span>
00200         <span class="comment">// This means some foolish person has put a read-only attribute</span>
00201         <span class="comment">// on one of the critical system hive files. Remove it so they</span>
00202         <span class="comment">// don't hurt themselves.</span>
00203         <span class="comment">//</span>
00204 
00205         status = <a class="code" href="../../d8/d1/cminit_8c.html#a2">CmpOpenFileWithExtremePrejudice</a>(Primary,
00206                                                  &amp;ObjectAttributes,
00207                                                  FILE_NO_INTERMEDIATE_BUFFERING |
00208                                                  FILE_OPEN_FOR_BACKUP_INTENT |
00209                                                  FILE_NO_COMPRESSION,
00210                                                  FILE_ATTRIBUTE_NORMAL);
00211     }
00212 
00213     <span class="keywordflow">if</span> ((MarkAsSystemHive) &amp;&amp;
00214         (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))) {
00215 
00216         <a class="code" href="../../d1/d2/cmp_8h.html#a63">ASSERT_PASSIVE_LEVEL</a>();
00217         status = ZwFsControlFile(*Primary,
00218                                  hEvent,
00219                                  NULL,
00220                                  NULL,
00221                                  &amp;FsctlIoStatus,
00222                                  FSCTL_MARK_AS_SYSTEM_HIVE,
00223                                  NULL,
00224                                  0,
00225                                  NULL,
00226                                  0);
00227         <span class="keywordflow">if</span> (status == STATUS_PENDING) {
00228             <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(pEvent,
00229                                   Executive,
00230                                   KernelMode,
00231                                   FALSE,
00232                                   NULL);
00233             status = FsctlIoStatus.Status;
00234         }
00235 
00236         <span class="comment">//</span>
00237         <span class="comment">//  STATUS_INVALID_DEVICE_REQUEST is OK.</span>
00238         <span class="comment">//</span>
00239 
00240         <span class="keywordflow">if</span> (status == STATUS_INVALID_DEVICE_REQUEST) {
00241             status = STATUS_SUCCESS;
00242 
00243         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00244             ZwClose(*Primary);
00245         }
00246     }
00247 
00248     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00249         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT_ERROR) {
00250             KdPrint((<span class="stringliteral">"CMINIT: CmpOpenHiveFile: "</span>));
00251             KdPrint((<span class="stringliteral">"\tPrimary Open/Create failed for:\n"</span>));
00252             KdPrint((<span class="stringliteral">"\t%wZ\n"</span>, &amp;WorkName));
00253             KdPrint((<span class="stringliteral">"\tstatus = %08lx\n"</span>, status));
00254         }
00255         <span class="keywordflow">if</span> (WorkBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00256             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(WorkBuffer);
00257         }
00258         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pEvent);
00259         ZwClose(hEvent);
00260         <span class="keywordflow">return</span> status;
00261     }
00262 
00263     <span class="comment">//</span>
00264     <span class="comment">// Make sure the file is uncompressed in order to prevent the filesystem</span>
00265     <span class="comment">// from failing our updates due to disk full conditions.</span>
00266     <span class="comment">//</span>
00267     <span class="comment">// Do not fail to open the file if this fails, we don't want to prevent</span>
00268     <span class="comment">// people from booting just because their disk is full. Although they</span>
00269     <span class="comment">// will not be able to update their registry, they will at lease be</span>
00270     <span class="comment">// able to delete some files.</span>
00271     <span class="comment">//</span>
00272     CompressionState = 0;
00273     <a class="code" href="../../d1/d2/cmp_8h.html#a63">ASSERT_PASSIVE_LEVEL</a>();
00274     status = ZwFsControlFile(*Primary,
00275                              hEvent,
00276                              NULL,
00277                              NULL,
00278                              &amp;FsctlIoStatus,
00279                              FSCTL_SET_COMPRESSION,
00280                              &amp;CompressionState,
00281                              <span class="keyword">sizeof</span>(CompressionState),
00282                              NULL,
00283                              0);
00284     <span class="keywordflow">if</span> (status == STATUS_PENDING) {
00285         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(pEvent,
00286                               Executive,
00287                               KernelMode,
00288                               FALSE,
00289                               NULL);
00290     }
00291 
00292     *PrimaryDisposition = (ULONG) IoStatus.Information;
00293 
00294     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ClusterSize)) {
00295 
00296         <a class="code" href="../../d1/d2/cmp_8h.html#a63">ASSERT_PASSIVE_LEVEL</a>();
00297         status = ZwQueryVolumeInformationFile(*Primary,
00298                                               &amp;IoStatus,
00299                                               &amp;FsSizeInformation,
00300                                               <span class="keyword">sizeof</span>(FILE_FS_SIZE_INFORMATION),
00301                                               FileFsSizeInformation);
00302         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00303             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pEvent);
00304             ZwClose(hEvent);
00305             <span class="keywordflow">return</span>(status);
00306         }
00307         <span class="keywordflow">if</span> (FsSizeInformation.BytesPerSector &gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) {
00308             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT_ERROR) {
00309                 KdPrint((<span class="stringliteral">"CmpOpenHiveFiles: sectorsize %lx &gt; HBLOCK_SIZE\n"</span>));
00310             }
00311             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pEvent);
00312             ZwClose(hEvent);
00313             <span class="keywordflow">return</span>(STATUS_CANNOT_LOAD_REGISTRY_FILE);
00314         }
00315 
00316         Cluster = FsSizeInformation.BytesPerSector / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00317         *ClusterSize = (Cluster &lt; 1) ? 1 : Cluster;
00318 
00319     }
00320 
00321     <span class="keywordflow">if</span> ( ! ARGUMENT_PRESENT(Extension)) {
00322         <span class="keywordflow">if</span> (WorkBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00323             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(WorkBuffer);
00324         }
00325         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pEvent);
00326         ZwClose(hEvent);
00327         <span class="keywordflow">return</span> STATUS_SUCCESS;
00328     }
00329 
00330     <span class="comment">//</span>
00331     <span class="comment">// Open/Create the secondary</span>
00332     <span class="comment">//</span>
00333     CreateDisposition = FILE_OPEN_IF;
00334     <span class="keywordflow">if</span> (*PrimaryDisposition == FILE_CREATED) {
00335         CreateDisposition = FILE_SUPERSEDE;
00336     }
00337 
00338     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;ExtName,Extension);
00339     status = <a class="code" href="../../d2/d7/string_8c.html#a16">RtlAppendStringToString</a>((PSTRING)&amp;WorkName, (PSTRING)&amp;ExtName);
00340 
00341     InitializeObjectAttributes(&amp;ObjectAttributes,
00342                                &amp;WorkName,
00343                                OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE,
00344                                NULL,
00345                                NULL);
00346 
00347     IoFlags = FILE_NO_COMPRESSION;
00348     <span class="keywordflow">if</span> (_wcsnicmp(Extension, L<span class="stringliteral">".log"</span>, 4) != 0) {
00349         IoFlags |= FILE_NO_INTERMEDIATE_BUFFERING;
00350         AttributeFlags = FILE_ATTRIBUTE_NORMAL;
00351     } <span class="keywordflow">else</span> {
00352         AttributeFlags = FILE_ATTRIBUTE_NORMAL | FILE_ATTRIBUTE_HIDDEN;
00353     }
00354 
00355     <a class="code" href="../../d1/d2/cmp_8h.html#a63">ASSERT_PASSIVE_LEVEL</a>();
00356     status = <a class="code" href="../../d6/d9/restrfil_8c.html#a31">ZwCreateFile</a>(
00357                 Secondary,
00358                 FILE_READ_DATA | FILE_WRITE_DATA,
00359                 &amp;ObjectAttributes,
00360                 &amp;IoStatus,
00361                 NULL,                               <span class="comment">// alloc size = none</span>
00362                 AttributeFlags,
00363                 0,                                  <span class="comment">// share nothing</span>
00364                 CreateDisposition,
00365                 IoFlags,
00366                 NULL,                               <span class="comment">// eabuffer</span>
00367                 0                                   <span class="comment">// ealength</span>
00368                 );
00369 
00370     <span class="keywordflow">if</span> (status == STATUS_ACCESS_DENIED) {
00371 
00372         <span class="comment">//</span>
00373         <span class="comment">// This means some foolish person has put a read-only attribute</span>
00374         <span class="comment">// on one of the critical system hive files. Remove it so they</span>
00375         <span class="comment">// don't hurt themselves.</span>
00376         <span class="comment">//</span>
00377 
00378         status = <a class="code" href="../../d8/d1/cminit_8c.html#a2">CmpOpenFileWithExtremePrejudice</a>(Secondary,
00379                                                  &amp;ObjectAttributes,
00380                                                  IoFlags,
00381                                                  AttributeFlags);
00382     }
00383 
00384     <span class="keywordflow">if</span> ((MarkAsSystemHive) &amp;&amp;
00385         (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))) {
00386 
00387         <a class="code" href="../../d1/d2/cmp_8h.html#a63">ASSERT_PASSIVE_LEVEL</a>();
00388         status = ZwFsControlFile(*Secondary,
00389                                  hEvent,
00390                                  NULL,
00391                                  NULL,
00392                                  &amp;FsctlIoStatus,
00393                                  FSCTL_MARK_AS_SYSTEM_HIVE,
00394                                  NULL,
00395                                  0,
00396                                  NULL,
00397                                  0);
00398         <span class="keywordflow">if</span> (status == STATUS_PENDING) {
00399             <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(pEvent,
00400                                   Executive,
00401                                   KernelMode,
00402                                   FALSE,
00403                                   NULL);
00404             status = FsctlIoStatus.Status;
00405         }
00406         <span class="comment">//</span>
00407         <span class="comment">//  STATUS_INVALID_DEVICE_REQUEST is OK.</span>
00408         <span class="comment">//</span>
00409 
00410         <span class="keywordflow">if</span> (status == STATUS_INVALID_DEVICE_REQUEST) {
00411             status = STATUS_SUCCESS;
00412 
00413         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00414 
00415             ZwClose(*Secondary);
00416         }
00417     }
00418 
00419     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00420         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT_ERROR) {
00421             KdPrint((<span class="stringliteral">"CMINIT: CmpOpenHiveFile: "</span>));
00422             KdPrint((<span class="stringliteral">"\tSecondary Open/Create failed for:\n"</span>));
00423             KdPrint((<span class="stringliteral">"\t%wZ\n"</span>, &amp;WorkName));
00424             KdPrint((<span class="stringliteral">"\tstatus = %08lx\n"</span>, status));
00425         }
00426         *Secondary = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00427     }
00428 
00429     *SecondaryDisposition = (ULONG) IoStatus.Information;
00430 
00431     <span class="comment">//</span>
00432     <span class="comment">// Make sure the file is uncompressed in order to prevent the filesystem</span>
00433     <span class="comment">// from failing our updates due to disk full conditions.</span>
00434     <span class="comment">//</span>
00435     <span class="comment">// Do not fail to open the file if this fails, we don't want to prevent</span>
00436     <span class="comment">// people from booting just because their disk is full. Although they</span>
00437     <span class="comment">// will not be able to update their registry, they will at lease be</span>
00438     <span class="comment">// able to delete some files.</span>
00439     <span class="comment">//</span>
00440     CompressionState = 0;
00441 
00442     <a class="code" href="../../d1/d2/cmp_8h.html#a63">ASSERT_PASSIVE_LEVEL</a>();
00443     status = ZwFsControlFile(*Secondary,
00444                              hEvent,
00445                              NULL,
00446                              NULL,
00447                              &amp;FsctlIoStatus,
00448                              FSCTL_SET_COMPRESSION,
00449                              &amp;CompressionState,
00450                              <span class="keyword">sizeof</span>(CompressionState),
00451                              NULL,
00452                              0);
00453     <span class="keywordflow">if</span> (status == STATUS_PENDING) {
00454         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(pEvent,
00455                               Executive,
00456                               KernelMode,
00457                               FALSE,
00458                               NULL);
00459     }
00460 
00461     <span class="keywordflow">if</span> (WorkBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00462         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(WorkBuffer);
00463     }
00464     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pEvent);
00465     ZwClose(hEvent);
00466     <span class="keywordflow">return</span> STATUS_SUCCESS;
00467 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a1" doxytag="cminit.c::CmpHiveListHead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d9/d4/edithive_8c.html#a2">CmpHiveListHead</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/cminit_8c-source.html#l00043">43</a> of file <a class="el" href="../../d9/d0/cminit_8c-source.html">cminit.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="cminit.c::CmpMasterHive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> <a class="el" href="../../d6/d3/cmwraper_8c.html#a7">CmpMasterHive</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/cminit_8c-source.html#l00042">42</a> of file <a class="el" href="../../d9/d0/cminit_8c-source.html">cminit.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:08 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
