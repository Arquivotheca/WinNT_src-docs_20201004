<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ppc/thredini.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>thredini.c File Reference</h1><code>#include "<a class="el" href="../../d1/d9/ki_8h-source.html">ki.h</a>"</code><br>

<p>
<a href="../../d9/d0/ppc_2thredini_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/ppc_2thredini_8c.html#a0">ASSERT_PROCESS</a>(E)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/ppc_2thredini_8c.html#a1">ASSERT_THREAD</a>(E)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/ppc_2thredini_8c.html#a2">KiInitializeContextThread</a> (IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread, IN <a class="el" href="../../d4/d9/ke_8h.html#a67">PKSYSTEM_ROUTINE</a> SystemRoutine, IN <a class="el" href="../../d4/d9/ke_8h.html#a66">PKSTART_ROUTINE</a> StartRoutine OPTIONAL, IN PVOID StartContext OPTIONAL, IN PCONTEXT ContextRecord OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/ppc_2thredini_8c.html#a3">KeSetAutoAlignmentProcess</a> (IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process, IN BOOLEAN Enable)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d1/ppc_2thredini_8c.html#a4">KeSetAutoAlignmentThread</a> (IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread, IN BOOLEAN Enable)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="ppc/thredini.c::ASSERT_PROCESS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ASSERT_PROCESS          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">E&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                    \
    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((E)-&gt;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>.Type == ProcessObject); \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d9/d0/ppc_2thredini_8c-source.html#l00035">35</a> of file <a class="el" href="../../d9/d0/ppc_2thredini_8c-source.html">ppc/thredini.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="ppc/thredini.c::ASSERT_THREAD" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ASSERT_THREAD          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">E&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                    \
    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((E)-&gt;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>.Type == ThreadObject); \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d9/d0/ppc_2thredini_8c-source.html#l00039">39</a> of file <a class="el" href="../../d9/d0/ppc_2thredini_8c-source.html">ppc/thredini.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a3" doxytag="ppc/thredini.c::KeSetAutoAlignmentProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KeSetAutoAlignmentProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Enable</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/ppc_2thredini_8c-source.html#l00223">223</a> of file <a class="el" href="../../d9/d0/ppc_2thredini_8c-source.html">ppc/thredini.c</a>.
<p>
References <a class="el" href="../../d5/d0/alpha_2thredini_8c-source.html#l00048">ASSERT_PROCESS</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, and <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/psquery_8c-source.html#l01510">NtSetInformationProcess()</a>.
<p>
<pre class="fragment"><div>00230                    :
00231 
00232     This function sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data alignment handling mode <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00233     process and returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous data alignment handling mode.
00234 
00235 Arguments:
00236 
00237     Process  - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> process.
00238 
00239     Enable - Supplies a <span class="keywordtype">boolean</span> value that determines <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handling of data
00240         alignment exceptions <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> causes all
00241         data alignment exceptions to be automatically handled by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel.
00242         <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> causes all data alignment exceptions to be actually
00243         raised as exceptions.
00244 
00245 Return Value:
00246 
00247     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> data alignment exceptions were
00248     previously automatically handled by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel. Otherwise, a value
00249     of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00250 
00251 --*/
00252 
00253 {
00254 
00255     KIRQL OldIrql;
00256     BOOLEAN Previous;
00257 
00258     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a0">ASSERT_PROCESS</a>(Process);
00259 
00260     <span class="comment">//</span>
00261     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00262     <span class="comment">//</span>
00263 
00264     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00265 
00266     <span class="comment">//</span>
00267     <span class="comment">// Capture the previous data alignment handling mode and set the</span>
00268     <span class="comment">// specified data alignment mode.</span>
00269     <span class="comment">//</span>
00270 
00271     Previous = Process-&gt;AutoAlignment;
00272     Process-&gt;AutoAlignment = Enable;
00273 
00274     <span class="comment">//</span>
00275     <span class="comment">// Unlock dispatcher database, lower IRQL to its previous value, and</span>
00276     <span class="comment">// return the previous data alignment mode.</span>
00277     <span class="comment">//</span>
00278 
00279     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00280     <span class="keywordflow">return</span> Previous;
00281 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="ppc/thredini.c::KeSetAutoAlignmentThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KeSetAutoAlignmentThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Enable</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/ppc_2thredini_8c-source.html#l00284">284</a> of file <a class="el" href="../../d9/d0/ppc_2thredini_8c-source.html">ppc/thredini.c</a>.
<p>
References <a class="el" href="../../d5/d0/alpha_2thredini_8c-source.html#l00052">ASSERT_THREAD</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, and <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/psquery_8c-source.html#l03103">NtSetInformationThread()</a>.
<p>
<pre class="fragment"><div>00291                    :
00292 
00293     This function sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data alignment handling mode <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00294     thread and returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous data alignment handling mode.
00295 
00296 Arguments:
00297 
00298     Thread  - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> thread.
00299 
00300     Enable - Supplies a <span class="keywordtype">boolean</span> value that determines <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handling of data
00301         alignment exceptions <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> causes all
00302         data alignment exceptions to be automatically handled by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel.
00303         <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> causes all data alignment exceptions to be actually
00304         raised as exceptions.
00305 
00306 Return Value:
00307 
00308     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> data alignment exceptions were
00309     previously automatically handled by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel. Otherwise, a value
00310     of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00311 
00312 --*/
00313 
00314 {
00315 
00316     KIRQL OldIrql;
00317     BOOLEAN Previous;
00318 
00319     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a1">ASSERT_THREAD</a>( Thread );
00320 
00321     <span class="comment">//</span>
00322     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00323     <span class="comment">//</span>
00324 
00325     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00326 
00327     <span class="comment">//</span>
00328     <span class="comment">// Capture the previous data alignment handling mode and set the</span>
00329     <span class="comment">// specified data alignment mode.</span>
00330     <span class="comment">//</span>
00331 
00332     Previous = Thread-&gt;AutoAlignment;
00333     Thread-&gt;AutoAlignment = Enable;
00334 
00335     <span class="comment">//</span>
00336     <span class="comment">// Unlock dispatcher database, lower IRQL to its previous value, and</span>
00337     <span class="comment">// return the previous data alignment mode.</span>
00338     <span class="comment">//</span>
00339 
00340     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00341     <span class="keywordflow">return</span> Previous;
00342 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="ppc/thredini.c::KiInitializeContextThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiInitializeContextThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/ke_8h.html#a67">PKSYSTEM_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/ke_8h.html#a66">PKSTART_ROUTINE</a> StartRoutine&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID StartContext&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT ContextRecord&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/ppc_2thredini_8c-source.html#l00045">45</a> of file <a class="el" href="../../d9/d0/ppc_2thredini_8c-source.html">ppc/thredini.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00240">CONTEXT_CONTROL</a>, <a class="el" href="../../d3/d8/ppc_2exceptn_8c-source.html#l00230">KeContextToKframes()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d0/d0/ki_8h.html#a139">KiThreadStartup()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/thredobj_8c-source.html#l00043">KeInitializeThread()</a>.
<p>
<pre class="fragment"><div>00055                    :
00056 
00057     This function initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> machine dependent context of a thread object.
00058 
00059     Actually, what <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> does <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to lay <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread so that
00060     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> contains a stack frame that will be picked up by SwapContext and
00061     returned thru, resulting in a transfer of <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> to <a class="code" href="../../d0/d0/ki_8h.html#a139">KiThreadStartup</a>.
00062     In otherwords, we lay <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> a stack with a stack frame that looks as <span class="keywordflow">if</span>
00063     SwapContext had been called just before <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first instruction in
00064     <a class="code" href="../../d0/d0/ki_8h.html#a139">KiThreadStartup</a>.
00065 
00066     N.B. This function does not check <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> accessibility of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context record.
00067          It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller of <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> either prepared to
00068          handle access violations or has probed and copied <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context record
00069          as appropriate.
00070 
00071     N.B. Arguments to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> thread are passed in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Swap Frame gprs
00072          16 thru 20 which will be loaded into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread's gprs when
00073          execution begins.
00074 
00075     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>: If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread has a user mode context <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Top of stack MUST
00076              be laid <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> identically to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> top of stack laid <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> when an
00077              interrupt or system call from user mode occurs.
00078 
00079 Arguments:
00080 
00081     Thread - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> thread.
00082 
00083     SystemRoutine - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system function that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be
00084         called when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> first scheduled <span class="keywordflow">for</span> execution.
00085 
00086     StartRoutine - Supplies an optional pointer to a function that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be
00087         called after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system has finished initializing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread. This
00088         parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a system thread and will
00089         execute totally in kernel mode.
00090 
00091     StartContext - Supplies an optional pointer to an arbitrary data structure
00092         which will be passed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> StartRoutine as a parameter. This
00093         parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a system thread and will
00094         execute totally in kernel mode.
00095 
00096     ContextRecord - Supplies an optional pointer a context frame which contains
00097         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial user mode state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread. This parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified
00098         <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a user thread and will execute in user mode. If <span class="keyword">this</span>
00099         parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Teb parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored.
00100 
00101 Return Value:
00102 
00103     None.
00104 
00105 --*/
00106 
00107 {
00108 
00109     PKEXCEPTION_FRAME ExFrame;
00110     ULONG InitialStack;
00111     PKTRAP_FRAME TrFrame;
00112     PKSWAP_FRAME SwFrame;
00113     PSTACK_FRAME_HEADER StkFrame, ResumeFrame;
00114 
00115     <span class="comment">//</span>
00116     <span class="comment">// If the initial stack address is in KSEG0, then the stack is not mapped</span>
00117     <span class="comment">// and the kernel stack PTEs are set to zero. Otherwise, capture the PTEs</span>
00118     <span class="comment">// that map the kernel stack.</span>
00119     <span class="comment">//</span>
00120 
00121     InitialStack = (LONG)Thread-&gt;InitialStack;
00122 
00123     <span class="comment">//</span>
00124     <span class="comment">// If a context frame is specified, then initialize a trap frame and</span>
00125     <span class="comment">// and an exception frame with the specified user mode context.</span>
00126     <span class="comment">//</span>
00127 
00128     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ContextRecord)) {
00129         ExFrame = (PKEXCEPTION_FRAME)(InitialStack - 8 -
00130                   <span class="keyword">sizeof</span>(KEXCEPTION_FRAME));
00131         TrFrame = (PKTRAP_FRAME)((ULONG)ExFrame -  <span class="keyword">sizeof</span>(KTRAP_FRAME));
00132         StkFrame = (PSTACK_FRAME_HEADER)((ULONG)TrFrame - (8 * <span class="keyword">sizeof</span>(ULONG)) -
00133                   <span class="keyword">sizeof</span>(STACK_FRAME_HEADER));
00134 
00135         <span class="comment">//</span>
00136         <span class="comment">// Zero the exception and trap frames and copy information from the</span>
00137         <span class="comment">// specified context frame to the trap and exception frames.</span>
00138         <span class="comment">//</span>
00139 
00140         RtlZeroMemory((PVOID)ExFrame, <span class="keyword">sizeof</span>(KEXCEPTION_FRAME));
00141         RtlZeroMemory((PVOID)TrFrame, <span class="keyword">sizeof</span>(KTRAP_FRAME));
00142         <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a10">KeContextToKframes</a>(TrFrame, ExFrame,
00143                            ContextRecord,
00144                            ContextRecord-&gt;ContextFlags | CONTEXT_CONTROL,
00145                            UserMode);
00146 
00147         <span class="comment">//</span>
00148         <span class="comment">// Set the saved previous processor mode in the trap frame and the</span>
00149         <span class="comment">// previous processor mode in the thread object to user mode.</span>
00150         <span class="comment">//</span>
00151 
00152         TrFrame-&gt;PreviousMode = <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>;
00153         Thread-&gt;PreviousMode = <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>;
00154 
00155     } <span class="keywordflow">else</span> {
00156 
00157         StkFrame = (PSTACK_FRAME_HEADER)((InitialStack -
00158                   <span class="keyword">sizeof</span>(STACK_FRAME_HEADER)) &amp; 0xfffffff0);
00159         ExFrame = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00160         TrFrame = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00161 
00162         <span class="comment">//</span>
00163         <span class="comment">// Set the previous mode in thread object to kernel.</span>
00164         <span class="comment">//</span>
00165 
00166         Thread-&gt;PreviousMode = <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>;
00167     }
00168 
00169     StkFrame-&gt;BackChain = (ULONG)0;
00170 
00171     <span class="comment">//</span>
00172     <span class="comment">// Initialize the Swap Frame that swap context will use to</span>
00173     <span class="comment">// initiate execution of this thread.</span>
00174     <span class="comment">//</span>
00175 
00176     SwFrame = (PKSWAP_FRAME)(((ULONG)StkFrame -
00177               <span class="keyword">sizeof</span>(KSWAP_FRAME)) &amp; 0xfffffff0);
00178 
00179     <span class="comment">//</span>
00180     <span class="comment">// Initialize stack frame and set thread start up parameters.</span>
00181     <span class="comment">//</span>
00182 
00183     <span class="keywordflow">if</span> (ExFrame == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00184         SwFrame-&gt;ExceptionFrame.Gpr20 = (ULONG)ExFrame;
00185     } <span class="keywordflow">else</span> {
00186         SwFrame-&gt;ExceptionFrame.Gpr20 = (ULONG)TrFrame;
00187     }
00188 
00189     SwFrame-&gt;ExceptionFrame.Gpr16 = (ULONG)ContextRecord;
00190     SwFrame-&gt;ExceptionFrame.Gpr17 = (ULONG)StartContext;
00191     SwFrame-&gt;ExceptionFrame.Gpr18 = (ULONG)StartRoutine;
00192 
00193     <span class="comment">//</span>
00194     <span class="comment">// Pass the actual entry point addresses rather than the function</span>
00195     <span class="comment">// descriptor's address.</span>
00196     <span class="comment">//</span>
00197 
00198     SwFrame-&gt;ExceptionFrame.Gpr19 = *(ULONG *)SystemRoutine;
00199 
00200     SwFrame-&gt;SwapReturn = *(ULONG *)<a class="code" href="../../d0/d0/ki_8h.html#a139">KiThreadStartup</a>;
00201     SwFrame-&gt;ConditionRegister = 0;
00202 
00203     <span class="comment">//</span>
00204     <span class="comment">// Buy a stack frame so we have the stack frame that will be</span>
00205     <span class="comment">// current when SwapContext is running when we resume this</span>
00206     <span class="comment">// thread.</span>
00207 
00208 
00209     ResumeFrame = ((PSTACK_FRAME_HEADER)SwFrame) - 1;
00210 
00211     ResumeFrame-&gt;BackChain = (ULONG)StkFrame;
00212 
00213     <span class="comment">//</span>
00214     <span class="comment">// Set the initial kernel stack pointer.</span>
00215     <span class="comment">//</span>
00216 
00217     Thread-&gt;KernelStack = (PVOID)ResumeFrame;
00218     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!((ULONG)ResumeFrame &amp; 0x7));        <span class="comment">// ensure stack is align 8</span>
00219     <span class="keywordflow">return</span>;
00220 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:46 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
