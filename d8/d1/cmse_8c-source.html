<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cmse.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cmse.c</h1><a href="../../d7/d2/cmse_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    cmse.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements security routines for the configuration manager.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    John Vert (jvert) 20-Jan-1992</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Richard Ward (richardw) 14-Apr-1992  Changed ACE_HEADER</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 <span class="preprocessor">#include "<a class="code" href="../../d1/d2/cmp_8h.html">cmp.h</a>"</span>
00023 
00024 
00025 <span class="comment">//</span>
00026 <span class="comment">// Function prototypes private to this module</span>
00027 <span class="comment">//</span>
00028 
00029 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00030 <a class="code" href="../../d7/d2/cmse_8c.html#a1">CmpSetSecurityDescriptorInfo</a>(
00031     IN <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> kcb,
00032     IN PSECURITY_INFORMATION SecurityInformation,
00033     IN PSECURITY_DESCRIPTOR ModificationDescriptor,
00034     IN OUT PSECURITY_DESCRIPTOR *ObjectsSecurityDescriptor,
00035     IN POOL_TYPE PoolType,
00036     IN PGENERIC_MAPPING GenericMapping
00037     );
00038 
00039 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00040 <a class="code" href="../../d7/d2/cmse_8c.html#a2">CmpQuerySecurityDescriptorInfo</a>(
00041     IN <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> kcb,
00042     IN PSECURITY_INFORMATION SecurityInformation,
00043     OUT PSECURITY_DESCRIPTOR SecurityDescriptor,
00044     IN OUT PULONG Length,
00045     IN OUT PSECURITY_DESCRIPTOR *ObjectsSecurityDescriptor
00046     );
00047 
00048 <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>
00049 <a class="code" href="../../d7/d2/cmse_8c.html#a3">CmpGetKeySecurity</a>(
00050     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00051     IN <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Key,
00052     OUT PHCELL_INDEX SecurityCell OPTIONAL
00053     );
00054 
00055 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00056 <a class="code" href="../../d9/d4/edithive_8c.html#a9">CmpGetObjectSecurity</a>(
00057     IN HCELL_INDEX Cell,
00058     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00059     OUT <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> *Security,
00060     OUT PHCELL_INDEX SecurityCell OPTIONAL
00061     );
00062 
00063 BOOLEAN
00064 <a class="code" href="../../d7/d2/cmse_8c.html#a5">CmpFindMatchingDescriptorCell</a>(
00065     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00066     IN <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node,
00067     IN PSECURITY_DESCRIPTOR SecurityDescriptor,
00068     IN ULONG Type,
00069     OUT PHCELL_INDEX MatchingCell
00070     );
00071 
00072 BOOLEAN
00073 <a class="code" href="../../d7/d2/cmse_8c.html#a6">CmpInsertSecurityCellList</a>(
00074     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00075     IN HCELL_INDEX NodeCell,
00076     IN HCELL_INDEX SecurityCell
00077     );
00078 
00079 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00080 <a class="code" href="../../d7/d2/cmse_8c.html#a7">CmpRemoveSecurityCellList</a>(
00081     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00082     IN HCELL_INDEX SecurityCell
00083     );
00084 
00085 ULONG
00086 <a class="code" href="../../d7/d2/cmse_8c.html#a8">CmpSecurityExceptionFilter</a>(
00087     IN PEXCEPTION_POINTERS ExceptionPointers
00088     );
00089 
00090 <span class="comment">//</span>
00091 <span class="comment">// This macro takes a PSECURITY_DESCRIPTOR and returns the size of the</span>
00092 <span class="comment">// hive cell required to contain the entire security descriptor.</span>
00093 <span class="comment">//</span>
00094 
<a name="l00095"></a><a class="code" href="../../d7/d2/cmse_8c.html#a0">00095</a> <span class="preprocessor">#define SECURITY_CELL_LENGTH(pDescriptor) \</span>
00096 <span class="preprocessor">    FIELD_OFFSET(CM_KEY_SECURITY,Descriptor) + \</span>
00097 <span class="preprocessor">    RtlLengthSecurityDescriptor(pDescriptor)</span>
00098 <span class="preprocessor"></span>
00099 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00100 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpSecurityMethod )</span>
00101 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpSetSecurityDescriptorInfo)</span>
00102 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpAssignSecurityDescriptor)</span>
00103 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpQuerySecurityDescriptorInfo)</span>
00104 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpCheckCreateAccess)</span>
00105 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpCheckNotifyAccess)</span>
00106 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpGetObjectSecurity)</span>
00107 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpGetKeySecurity)</span>
00108 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpHiveRootSecurityDescriptor)</span>
00109 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpFreeSecurityDescriptor)</span>
00110 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpFindMatchingDescriptorCell)</span>
00111 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpInsertSecurityCellList)</span>
00112 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpRemoveSecurityCellList)</span>
00113 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpSecurityExceptionFilter)</span>
00114 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00115 <span class="preprocessor"></span>
00116 ULONG
<a name="l00117"></a><a class="code" href="../../d7/d2/cmse_8c.html#a8">00117</a> <a class="code" href="../../d7/d2/cmse_8c.html#a8">CmpSecurityExceptionFilter</a>(
00118     IN PEXCEPTION_POINTERS ExceptionPointers
00119     )
00120 
00121 <span class="comment">/*++</span>
00122 <span class="comment"></span>
00123 <span class="comment">Routine Description:</span>
00124 <span class="comment"></span>
00125 <span class="comment">    Debug code to find registry security exceptions that are being swallowed</span>
00126 <span class="comment"></span>
00127 <span class="comment">Return Value:</span>
00128 <span class="comment"></span>
00129 <span class="comment">    EXCEPTION_EXECUTE_HANDLER</span>
00130 <span class="comment"></span>
00131 <span class="comment">--*/</span>
00132 
00133 {
00134     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CM: Registry security exception %lx, ExceptionPointers = %p\n"</span>,
00135             ExceptionPointers-&gt;ExceptionRecord-&gt;ExceptionCode,
00136             ExceptionPointers);
00137     
00138     <span class="comment">//</span>
00139     <span class="comment">// This is a request from the base test team; no dbg should be hit on the free builds </span>
00140     <span class="comment">// at the client; after RC2 is shipped we should enable this on free builds too.</span>
00141     <span class="comment">//</span>
00142 <span class="preprocessor">#if DBG</span>
00143 <span class="preprocessor"></span>    <span class="keywordflow">try</span> {
00144         DbgBreakPoint();
00145     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00146 
00147         <span class="comment">//</span>
00148         <span class="comment">// no debugger enabled, just keep going</span>
00149         <span class="comment">//</span>
00150 
00151     }
00152 <span class="preprocessor">#endif</span>
00153 <span class="preprocessor"></span>
00154     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>);
00155 }
00156 
00157 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00158"></a><a class="code" href="../../d7/d2/cmse_8c.html#a9">00158</a> <a class="code" href="../../d7/d2/cmse_8c.html#a9">CmpSecurityMethod</a> (
00159     IN PVOID Object,
00160     IN SECURITY_OPERATION_CODE OperationCode,
00161     IN PSECURITY_INFORMATION SecurityInformation,
00162     IN OUT PSECURITY_DESCRIPTOR SecurityDescriptor,
00163     IN OUT PULONG CapturedLength,
00164     IN OUT PSECURITY_DESCRIPTOR *ObjectsSecurityDescriptor,
00165     IN POOL_TYPE PoolType,
00166     IN PGENERIC_MAPPING GenericMapping
00167     )
00168 
00169 <span class="comment">/*++</span>
00170 <span class="comment"></span>
00171 <span class="comment">Routine Description:</span>
00172 <span class="comment"></span>
00173 <span class="comment">    This is the security method for registry objects.  It is responsible for</span>
00174 <span class="comment">    retrieving, setting, and deleting the security descriptor of a registry</span>
00175 <span class="comment">    object.  It is not used to assign the original security descriptor to an</span>
00176 <span class="comment">    object (use SeAssignSecurity for that purpose).</span>
00177 <span class="comment"></span>
00178 <span class="comment"></span>
00179 <span class="comment">    IT IS ASSUMED THAT THE OBJECT MANAGER HAS ALREADY DONE THE ACCESS</span>
00180 <span class="comment">    VALIDATIONS NECESSARY TO ALLOW THE REQUESTED OPERATIONS TO BE PERFORMED.</span>
00181 <span class="comment"></span>
00182 <span class="comment">Arguments:</span>
00183 <span class="comment"></span>
00184 <span class="comment">    Object - Supplies a pointer to the object being used.</span>
00185 <span class="comment"></span>
00186 <span class="comment">    OperationCode - Indicates if the operation is for setting, querying, or</span>
00187 <span class="comment">        deleting the object's security descriptor.</span>
00188 <span class="comment"></span>
00189 <span class="comment">    SecurityInformation - Indicates which security information is being</span>
00190 <span class="comment">        queried or set.  This argument is ignored for the delete operation.</span>
00191 <span class="comment"></span>
00192 <span class="comment">    SecurityDescriptor - The meaning of this parameter depends on the</span>
00193 <span class="comment">        OperationCode:</span>
00194 <span class="comment"></span>
00195 <span class="comment">        QuerySecurityDescriptor - For the query operation this supplies the</span>
00196 <span class="comment">            buffer to copy the descriptor into.  The security descriptor is</span>
00197 <span class="comment">            assumed to have been probed up to the size passed in in Length.</span>
00198 <span class="comment">            Since it still points into user space, it must always be</span>
00199 <span class="comment">            accessed in a try clause in case it should suddenly disappear.</span>
00200 <span class="comment"></span>
00201 <span class="comment">        SetSecurityDescriptor - For a set operation this supplies the</span>
00202 <span class="comment">            security descriptor to copy into the object.  The security</span>
00203 <span class="comment">            descriptor must be captured before this routine is called.</span>
00204 <span class="comment"></span>
00205 <span class="comment">        DeleteSecurityDescriptor - It is ignored when deleting a security</span>
00206 <span class="comment">            descriptor.</span>
00207 <span class="comment"></span>
00208 <span class="comment">        AssignSecurityDescriptor - For assign operations this is the</span>
00209 <span class="comment">            security descriptor that will be assigned to the object.</span>
00210 <span class="comment">            It is assumed to be in kernel space, and is therefore not</span>
00211 <span class="comment">            probed or captured.</span>
00212 <span class="comment"></span>
00213 <span class="comment">    CapturedLength - For the query operation this specifies the length, in</span>
00214 <span class="comment">        bytes, of the security descriptor buffer, and upon return contains</span>
00215 <span class="comment">        the number of bytes needed to store the descriptor.  If the length</span>
00216 <span class="comment">        needed is greater than the length supplied the operation will fail.</span>
00217 <span class="comment">        It is ignored in the set and delete operation.</span>
00218 <span class="comment"></span>
00219 <span class="comment">        This parameter is assumed to be captured and probed as appropriate.</span>
00220 <span class="comment"></span>
00221 <span class="comment">    ObjectsSecurityDescriptor - For the Set operation this supplies the address</span>
00222 <span class="comment">        of a pointer to the object's current security descriptor.  This routine</span>
00223 <span class="comment">        will either modify the security descriptor in place or deallocate/</span>
00224 <span class="comment">        allocate a new security descriptor and use this variable to indicate</span>
00225 <span class="comment">        its new location.  For the query operation it simply supplies</span>
00226 <span class="comment">        the security descriptor being queried.</span>
00227 <span class="comment"></span>
00228 <span class="comment">    PoolType - For the set operation this specifies the pool type to use if</span>
00229 <span class="comment">        a new security descriptor needs to be allocated.  It is ignored</span>
00230 <span class="comment">        in the query and delete operation.</span>
00231 <span class="comment"></span>
00232 <span class="comment">    GenericMapping - Passed only for the set operation, this argument provides</span>
00233 <span class="comment">        the mapping of generic to specific/standard access types for the object</span>
00234 <span class="comment">        being accessed.  This mapping structure is expected to be safe to</span>
00235 <span class="comment">        access (i.e., captured if necessary) prior to be passed to this routine.</span>
00236 <span class="comment"></span>
00237 <span class="comment">Return Value:</span>
00238 <span class="comment"></span>
00239 <span class="comment">    NTSTATUS - STATUS_SUCCESS if the operation is successful and an</span>
00240 <span class="comment">        appropriate error status otherwise.</span>
00241 <span class="comment"></span>
00242 <span class="comment">--*/</span>
00243 
00244 {
00245     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00246     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00247     <a class="code" href="../../d5/d5/struct__CM__KEY__REFERENCE.html">CM_KEY_REFERENCE</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
00248 
00249     <span class="comment">//</span>
00250     <span class="comment">//  Make sure the common parts of our input are proper</span>
00251     <span class="comment">//</span>
00252 
00253     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00254     <a class="code" href="../../d1/d2/cmp_8h.html#a83">ASSERT_KEY_OBJECT</a>(Object);
00255 
00256     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (OperationCode == <a class="code" href="../../d0/d5/se_8h.html#a200a108">SetSecurityDescriptor</a>) ||
00257             (OperationCode == <a class="code" href="../../d0/d5/se_8h.html#a200a109">QuerySecurityDescriptor</a>) ||
00258             (OperationCode == <a class="code" href="../../d0/d5/se_8h.html#a200a111">AssignSecurityDescriptor</a>) ||
00259             (OperationCode == <a class="code" href="../../d0/d5/se_8h.html#a200a110">DeleteSecurityDescriptor</a>) );
00260 
00261     <span class="comment">//</span>
00262     <span class="comment">// Lock hive for shared or exclusive, depending on what we need</span>
00263     <span class="comment">// to do.</span>
00264     <span class="comment">//</span>
00265     <span class="keywordflow">if</span> (OperationCode == <a class="code" href="../../d0/d5/se_8h.html#a200a109">QuerySecurityDescriptor</a>) {
00266         <a class="code" href="../../d6/d3/cmwraper_8c.html#a14">CmpLockRegistry</a>();
00267     } <span class="keywordflow">else</span> {
00268         <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
00269     }
00270 
00271     <span class="keywordflow">if</span> (((<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)Object)-&gt;KeyControlBlock-&gt;Delete) {
00272         <span class="comment">//</span>
00273         <span class="comment">// Key has been deleted, performing security operations on</span>
00274         <span class="comment">// it is Not Allowed.</span>
00275         <span class="comment">//</span>
00276         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00277         <span class="keywordflow">return</span>(STATUS_KEY_DELETED);
00278     }
00279 
00280     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = ((<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)Object)-&gt;KeyControlBlock;
00281 
00282     <span class="keywordflow">try</span> {
00283         <span class="comment">//</span>
00284         <span class="comment">//  This routine simply cases off of the operation code to decide</span>
00285         <span class="comment">//  which support routine to call</span>
00286         <span class="comment">//</span>
00287 
00288         <span class="keywordflow">switch</span> (OperationCode) {
00289 
00290         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/se_8h.html#a200a108">SetSecurityDescriptor</a>:
00291 
00292             <span class="comment">//</span>
00293             <span class="comment">//  check the rest of our input and call the set security</span>
00294             <span class="comment">//  method</span>
00295             <span class="comment">//</span>
00296             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (PoolType == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) || (PoolType == <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>) );
00297 
00298             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d2/cmse_8c.html#a1">CmpSetSecurityDescriptorInfo</a>( <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>,
00299                                                    SecurityInformation,
00300                                                    SecurityDescriptor,
00301                                                    ObjectsSecurityDescriptor,
00302                                                    PoolType,
00303                                                    GenericMapping );
00304 
00305             <span class="comment">//</span>
00306             <span class="comment">// this is the one and only path on which a user could change</span>
00307             <span class="comment">// a security descriptor, therefore, report such changes for</span>
00308             <span class="comment">// notification here.</span>
00309             <span class="comment">//</span>
00310             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00311                 <a class="code" href="../../d6/d3/cmwraper_8c.html#a13">CmpReportNotify</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>,
00312                                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyHive,
00313                                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyCell,
00314                                 REG_NOTIFY_CHANGE_ATTRIBUTES | REG_NOTIFY_CHANGE_SECURITY);
00315     
00316             }
00317 
00318             <span class="keywordflow">break</span>;
00319 
00320         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/se_8h.html#a200a109">QuerySecurityDescriptor</a>:
00321 
00322             <span class="comment">//</span>
00323             <span class="comment">//  check the rest of our input and call the default query security</span>
00324             <span class="comment">//  method</span>
00325             <span class="comment">//</span>
00326             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( CapturedLength != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00327             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d2/cmse_8c.html#a2">CmpQuerySecurityDescriptorInfo</a>( <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>,
00328                                                      SecurityInformation,
00329                                                      SecurityDescriptor,
00330                                                      CapturedLength,
00331                                                      ObjectsSecurityDescriptor );
00332             <span class="keywordflow">break</span>;
00333 
00334         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/se_8h.html#a200a110">DeleteSecurityDescriptor</a>:
00335 
00336             <span class="comment">//</span>
00337             <span class="comment">// Nobody should ever call the delete method.  When the key is</span>
00338             <span class="comment">// freed, the security descriptor associated with it is</span>
00339             <span class="comment">// explicitly freed (CmpFreeSecurityDescriptor)</span>
00340             <span class="comment">//</span>
00341             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00342 
00343             <span class="keywordflow">break</span>;
00344 
00345         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/se_8h.html#a200a111">AssignSecurityDescriptor</a>:
00346 
00347             <span class="comment">//</span>
00348             <span class="comment">// Set the SecurityDescriptor field in the object's header to</span>
00349             <span class="comment">// NULL.  This indicates that our security method needs to be</span>
00350             <span class="comment">// called for any security descriptor operations.</span>
00351             <span class="comment">//</span>
00352 
00353             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/obse_8c.html#a7">ObAssignObjectSecurityDescriptor</a>(Object, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>);
00354 
00355             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ));
00356 
00357             <span class="comment">//</span>
00358             <span class="comment">// Assign the actual descriptor.</span>
00359             <span class="comment">//</span>
00360             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d2/cmse_8c.html#a10">CmpAssignSecurityDescriptor</a>( <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyHive,
00361                                                   <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyCell,
00362                                                   <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyNode,
00363                                                   SecurityDescriptor );
00364             <span class="comment">//</span>
00365             <span class="comment">// Security has been changed, update the cache.</span>
00366             <span class="comment">//</span>
00367             <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
00368             <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;Security = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyNode-&gt;Security;
00369 
00370             <span class="keywordflow">break</span>;
00371 
00372         <span class="keywordflow">default</span>:
00373 
00374             <span class="comment">//</span>
00375             <span class="comment">//  Bugcheck on any other operation code,  We won't get here if</span>
00376             <span class="comment">//  the earlier asserts are still checked.</span>
00377             <span class="comment">//</span>
00378             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( REGISTRY_ERROR,3,1,(ULONG_PTR)<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>,0);
00379 
00380         }
00381     
00382     } except (<a class="code" href="../../d7/d2/cmse_8c.html#a8">CmpSecurityExceptionFilter</a>(GetExceptionInformation())) {
00383         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a34">CMS_SEC</a>) {
00384             KdPrint((<span class="stringliteral">"!!CmpSecurityMethod: code:%08lx\n"</span>, GetExceptionCode()));
00385         }
00386         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00387     }
00388 
00389 
00390     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00391     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00392 
00393 }
00394 
00395 
00396 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00397"></a><a class="code" href="../../d7/d2/cmse_8c.html#a1">00397</a> <a class="code" href="../../d7/d2/cmse_8c.html#a1">CmpSetSecurityDescriptorInfo</a>(
00398     IN <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> Key,
00399     IN PSECURITY_INFORMATION SecurityInformation,
00400     IN PSECURITY_DESCRIPTOR ModificationDescriptor,
00401     IN OUT PSECURITY_DESCRIPTOR *ObjectsSecurityDescriptor,
00402     IN POOL_TYPE PoolType,
00403     IN PGENERIC_MAPPING GenericMapping
00404     )
00405 <span class="comment">/*++</span>
00406 <span class="comment"></span>
00407 <span class="comment">Routine Description:</span>
00408 <span class="comment"></span>
00409 <span class="comment">    This routine will set a node's security descriptor.  The input</span>
00410 <span class="comment">    security descriptor must be previously captured.</span>
00411 <span class="comment"></span>
00412 <span class="comment">Arguments:</span>
00413 <span class="comment"></span>
00414 <span class="comment">    Key - Supplies a pointer to the KEY_CONTROL_BLOCK for the node whose</span>
00415 <span class="comment">        security descriptor will be set.</span>
00416 <span class="comment"></span>
00417 <span class="comment">    SecurityInformation - Indicates which security information is</span>
00418 <span class="comment">        to be applied to the object.  The value(s) to be assigned are</span>
00419 <span class="comment">        passed in the SecurityDescriptor parameter.</span>
00420 <span class="comment"></span>
00421 <span class="comment">    ModificationDescriptor - Supplies the input security descriptor to be</span>
00422 <span class="comment">        applied to the object.  The caller of this routine is expected</span>
00423 <span class="comment">        to probe and capture the passed security descriptor before calling</span>
00424 <span class="comment">        and release it after calling.</span>
00425 <span class="comment"></span>
00426 <span class="comment">    ObjectsSecurityDescriptor - Supplies the address of a pointer to</span>
00427 <span class="comment">        the objects security descriptor that is going to be altered by</span>
00428 <span class="comment">        this procedure</span>
00429 <span class="comment"></span>
00430 <span class="comment">    PoolType - Specifies the type of pool to allocate for the objects</span>
00431 <span class="comment">        security descriptor.</span>
00432 <span class="comment"></span>
00433 <span class="comment">    GenericMapping - This argument provides the mapping of generic to</span>
00434 <span class="comment">        specific/standard access types for the object being accessed.</span>
00435 <span class="comment">        This mapping structure is expected to be safe to access</span>
00436 <span class="comment">        (i.e., captured if necessary) prior to be passed to this routine.</span>
00437 <span class="comment"></span>
00438 <span class="comment">Return Value:</span>
00439 <span class="comment"></span>
00440 <span class="comment">    NTSTATUS - STATUS_SUCCESS if successful and an appropriate error</span>
00441 <span class="comment">        value otherwise</span>
00442 <span class="comment"></span>
00443 <span class="comment">--*/</span>
00444 
00445 {
00446     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00447     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> SecurityCell;
00448     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> MatchSecurityCell;
00449     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> NewCell;
00450     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> OldCell;
00451     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> Security;
00452     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> NewSecurity;
00453     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> FlinkSecurity;
00454     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> BlinkSecurity;
00455     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node;
00456     ULONG DescriptorLength;
00457     PSECURITY_DESCRIPTOR DescriptorCopy;
00458     PSECURITY_DESCRIPTOR OldDescriptorCopy;
00459     ULONG   Type;
00460     LARGE_INTEGER SystemTime;
00461     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00462 
00463     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00464     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a34">CMS_SEC</a>) {
00465         KdPrint((<span class="stringliteral">"CmpSetSecurityDescriptorInfo:\n"</span>));
00466     }
00467 
00468     <span class="comment">//</span>
00469     <span class="comment">// Map in the hive cell for the security descriptor before we make</span>
00470     <span class="comment">// the call to SeSetSecurityDescriptorInfo.  This prevents us from</span>
00471     <span class="comment">// changing its security descriptor and then being unable to bring</span>
00472     <span class="comment">// the hive cell into memory for updating.</span>
00473     <span class="comment">//</span>
00474     Security = <a class="code" href="../../d7/d2/cmse_8c.html#a3">CmpGetKeySecurity</a>(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyHive,
00475                                  <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyNode,
00476                                  &amp;SecurityCell);
00477 
00478     <span class="comment">//</span>
00479     <span class="comment">// SeSetSecurityDescriptorInfo takes a pointer to the original</span>
00480     <span class="comment">// descriptor. This pointer is not freed, but a new pointer will</span>
00481     <span class="comment">// be returned.</span>
00482     <span class="comment">//</span>
00483     DescriptorCopy = &amp;Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o6">Descriptor</a>;
00484     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/semethod_8c.html#a4">SeSetSecurityDescriptorInfo</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00485                                           SecurityInformation,
00486                                           ModificationDescriptor,
00487                                           &amp;DescriptorCopy,
00488                                           PoolType,
00489                                           GenericMapping );
00490 
00491     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00492         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00493     }
00494 
00495     <span class="comment">//</span>
00496     <span class="comment">// Set Security operation succeeded, so we update the security</span>
00497     <span class="comment">// descriptor in the hive.</span>
00498     <span class="comment">//</span>
00499     DescriptorLength = <a class="code" href="../../d8/d6/sertl_8c.html#a56">RtlLengthSecurityDescriptor</a>(DescriptorCopy);
00500     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyCell);
00501     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyHive;
00502     Node = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyNode;
00503 
00504     <span class="keywordflow">if</span> (! (<a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyCell) &amp;&amp;
00505            <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, SecurityCell)))
00506     {
00507         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DescriptorCopy);
00508         <span class="keywordflow">return</span> STATUS_NO_LOG_SPACE;
00509     }
00510 
00511     <span class="comment">//</span>
00512     <span class="comment">// Try to find an existing security descriptor that we can share.</span>
00513     <span class="comment">//</span>
00514     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d2/cmse_8c.html#a5">CmpFindMatchingDescriptorCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Node, DescriptorCopy, Type, &amp;MatchSecurityCell)) {
00515         <span class="comment">//</span>
00516         <span class="comment">// A match was found.</span>
00517         <span class="comment">//</span>
00518         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, MatchSecurityCell)) {
00519             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DescriptorCopy);
00520             <span class="keywordflow">return</span>(STATUS_NO_LOG_SPACE);
00521         }
00522         <span class="keywordflow">if</span> (Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o4">ReferenceCount</a> == 1) {
00523             <span class="comment">//</span>
00524             <span class="comment">// No more references to the old security cell, so we can free it now.</span>
00525             <span class="comment">//</span>
00526             <span class="keywordflow">if</span> (! (<a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a>) &amp;&amp;
00527                    <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o3">Blink</a>))) {
00528                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DescriptorCopy);
00529                 <span class="keywordflow">return</span>(STATUS_NO_LOG_SPACE);
00530             }
00531             <a class="code" href="../../d7/d2/cmse_8c.html#a7">CmpRemoveSecurityCellList</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, SecurityCell);
00532             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, SecurityCell);
00533         } <span class="keywordflow">else</span> {
00534 
00535             <span class="comment">//</span>
00536             <span class="comment">// Just decrement the count on the old security cell</span>
00537             <span class="comment">//</span>
00538             Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o4">ReferenceCount</a> -= 1;
00539         }
00540 
00541         <span class="comment">//</span>
00542         <span class="comment">// Set the node to point at the matching security cell.</span>
00543         <span class="comment">//</span>
00544         Security = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, MatchSecurityCell);
00545         Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o4">ReferenceCount</a> += 1;
00546         Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a> = MatchSecurityCell;
00547     } <span class="keywordflow">else</span> {
00548 
00549         <span class="comment">//</span>
00550         <span class="comment">// No match was found, we need to create a new cell.</span>
00551         <span class="comment">//</span>
00552         <span class="keywordflow">if</span> (Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o4">ReferenceCount</a> &gt; 1) {
00553 
00554             <span class="comment">//</span>
00555             <span class="comment">// We can't change the existing security cell, since it is shared</span>
00556             <span class="comment">// by multiple keys.  Allocate a new cell and decrement the existing</span>
00557             <span class="comment">// one's reference count.</span>
00558             <span class="comment">//</span>
00559             NewCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyHive,
00560                                      <a class="code" href="../../d7/d2/cmse_8c.html#a0">SECURITY_CELL_LENGTH</a>(DescriptorCopy),
00561                                      Type);
00562             <span class="keywordflow">if</span> (NewCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00563                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DescriptorCopy);
00564                 <span class="keywordflow">return</span>(STATUS_INSUFFICIENT_RESOURCES);
00565             }
00566 
00567             <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyHive, Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a>)) {
00568                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DescriptorCopy);
00569                 <span class="keywordflow">return</span> STATUS_NO_LOG_SPACE;
00570             }
00571 
00572             Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o4">ReferenceCount</a> -= 1;
00573 
00574             <span class="comment">//</span>
00575             <span class="comment">// Map in the new cell and insert it into the linked list.</span>
00576             <span class="comment">//</span>
00577             NewSecurity = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyHive, NewCell);
00578             NewSecurity-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o3">Blink</a> = SecurityCell;
00579             NewSecurity-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a> = Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a>;
00580             FlinkSecurity = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyHive, Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a>);
00581             Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a> = FlinkSecurity-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o3">Blink</a> = NewCell;
00582 
00583             <span class="comment">//</span>
00584             <span class="comment">// initialize new cell</span>
00585             <span class="comment">//</span>
00586             NewSecurity-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o0">Signature</a> = <a class="code" href="../../d9/d0/cmdata_8h.html#a39">CM_KEY_SECURITY_SIGNATURE</a>;
00587             NewSecurity-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o4">ReferenceCount</a> = 1;
00588             NewSecurity-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o5">DescriptorLength</a> = DescriptorLength;
00589             Security=NewSecurity;
00590 
00591             <span class="comment">//</span>
00592             <span class="comment">// Update the pointer in the node cell.</span>
00593             <span class="comment">//</span>
00594             Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a> = NewCell;
00595 
00596         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (DescriptorLength != Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o5">DescriptorLength</a>) {
00597 
00598             <span class="comment">//</span>
00599             <span class="comment">// The security descriptor's size has changed, and it is not shared</span>
00600             <span class="comment">// by any other cells, so reallocate the cell.</span>
00601             <span class="comment">//</span>
00602             <span class="keywordflow">if</span> (! (<a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyHive, Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a>) &amp;&amp;
00603                    <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyHive, Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o3">Blink</a>))) {
00604                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DescriptorCopy);
00605                 <span class="keywordflow">return</span>(STATUS_INSUFFICIENT_RESOURCES);
00606             }
00607 
00608             <a class="code" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>((<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyHive));
00609             OldCell = SecurityCell;
00610             SecurityCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a20">HvReallocateCell</a>( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyHive,
00611                                              SecurityCell,
00612                                              <a class="code" href="../../d7/d2/cmse_8c.html#a0">SECURITY_CELL_LENGTH</a>(DescriptorCopy) );
00613             <span class="keywordflow">if</span> (SecurityCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00614                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DescriptorCopy);
00615                 <span class="keywordflow">return</span>(STATUS_INSUFFICIENT_RESOURCES);
00616             }
00617 
00618             <span class="comment">//</span>
00619             <span class="comment">// Update the Node's security data.</span>
00620             <span class="comment">//</span>
00621             Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a> = SecurityCell;
00622 
00623             <span class="comment">//</span>
00624             <span class="comment">// Update Security to point to where the new security object is</span>
00625             <span class="comment">//</span>
00626             Security = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyHive, SecurityCell);
00627             <a class="code" href="../../d1/d2/cmp_8h.html#a85">ASSERT_SECURITY</a>(Security);
00628 
00629             <span class="comment">//</span>
00630             <span class="comment">// Update other list references to the node</span>
00631             <span class="comment">//</span>
00632             <span class="keywordflow">if</span> (Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a> == OldCell) {
00633                 Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a> = SecurityCell; <span class="comment">// point to new self</span>
00634             } <span class="keywordflow">else</span> {
00635                 FlinkSecurity = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(
00636                                                         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyHive,
00637                                                         Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a>
00638                                                         );
00639                 FlinkSecurity-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o3">Blink</a> = SecurityCell;
00640             }
00641 
00642             <span class="keywordflow">if</span> (Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o3">Blink</a> == OldCell) {
00643                 Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o3">Blink</a> = SecurityCell; <span class="comment">// point to new self</span>
00644             } <span class="keywordflow">else</span> {
00645                 BlinkSecurity = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(
00646                                                         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyHive,
00647                                                         Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o3">Blink</a>
00648                                                         );
00649                 BlinkSecurity-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a> = SecurityCell;
00650             }
00651 
00652             <span class="comment">//</span>
00653             <span class="comment">// Finally, update the length field in the cell</span>
00654             <span class="comment">//</span>
00655             Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o5">DescriptorLength</a> = DescriptorLength;
00656             <a class="code" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>((<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyHive));
00657 
00658         } <span class="keywordflow">else</span> {
00659 
00660             <span class="comment">//</span>
00661             <span class="comment">// Size hasn't changed, and it's not shared by any other cells, so</span>
00662             <span class="comment">// we can just write the new bits over the old bits.</span>
00663             <span class="comment">//</span>
00664             NOTHING;
00665         }
00666 
00667         RtlMoveMemory( &amp;(Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o6">Descriptor</a>),
00668                        DescriptorCopy,
00669                        DescriptorLength );
00670     }
00671 
00672 
00673     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a34">CMS_SEC</a>) {
00674         KdPrint((<span class="stringliteral">"\tObject's SD has been changed\n"</span>));
00675         <a class="code" href="../../d1/d2/cmp_8h.html#a66">CmpDumpSecurityDescriptor</a>(DescriptorCopy, <span class="stringliteral">"NEW DESCRIPTOR\n"</span>);
00676     }
00677 
00678     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DescriptorCopy);
00679 
00680     <span class="comment">//</span>
00681     <span class="comment">// Update the LastWriteTime of the key.</span>
00682     <span class="comment">//</span>
00683     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;SystemTime);
00684     Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o2">LastWriteTime</a> = SystemTime;
00685 
00686     <span class="comment">//</span>
00687     <span class="comment">// Security has changed, update the cache.</span>
00688     <span class="comment">//</span>
00689     <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
00690     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;Security = Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a>;
00691 
00692     <span class="keywordflow">return</span>(STATUS_SUCCESS);
00693 }
00694 
00695 
00696 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00697"></a><a class="code" href="../../d7/d2/cmse_8c.html#a10">00697</a> <a class="code" href="../../d7/d2/cmse_8c.html#a10">CmpAssignSecurityDescriptor</a>(
00698     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00699     IN HCELL_INDEX Cell,
00700     IN <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node,
00701     IN PSECURITY_DESCRIPTOR SecurityDescriptor
00702     )
00703 
00704 <span class="comment">/*++</span>
00705 <span class="comment"></span>
00706 <span class="comment">Routine Description:</span>
00707 <span class="comment"></span>
00708 <span class="comment">    This routine assigns the given security descriptor to the specified</span>
00709 <span class="comment">    node in the configuration tree.</span>
00710 <span class="comment"></span>
00711 <span class="comment">Arguments:</span>
00712 <span class="comment"></span>
00713 <span class="comment">    Hive - Supplies a pointer to the Hive for the node whose security</span>
00714 <span class="comment">           descriptor will be assigned.</span>
00715 <span class="comment"></span>
00716 <span class="comment">    Cell - Supplies the HCELL_INDEX of the node whose security descriptor</span>
00717 <span class="comment">           will be assigned.</span>
00718 <span class="comment"></span>
00719 <span class="comment">    Node - Supplies a pointer to the node whose security descriptor will</span>
00720 <span class="comment">           be assigned.</span>
00721 <span class="comment"></span>
00722 <span class="comment">    SecurityDescriptor - Supplies a pointer to the security descriptor to</span>
00723 <span class="comment">           be assigned to the node.</span>
00724 <span class="comment"></span>
00725 <span class="comment">    PoolType - Supplies the type of pool the SecurityDescriptor was a</span>
00726 <span class="comment">           allocated from.</span>
00727 <span class="comment"></span>
00728 <span class="comment">Return Value:</span>
00729 <span class="comment"></span>
00730 <span class="comment">    NTSTATUS - STATUS_SUCCESS if successful and an appropriate error value</span>
00731 <span class="comment">        otherwise</span>
00732 <span class="comment"></span>
00733 <span class="comment">--*/</span>
00734 
00735 {
00736     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> SecurityCell;
00737     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> Security;
00738     ULONG DescriptorLength;
00739     ULONG Type;
00740 
00741     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00742     <span class="comment">//</span>
00743     <span class="comment">// Map the node that we need to assign the security descriptor to.</span>
00744     <span class="comment">//</span>
00745     <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>)) {
00746         <span class="keywordflow">return</span> STATUS_NO_LOG_SPACE;
00747     }
00748     <a class="code" href="../../d1/d2/cmp_8h.html#a84">ASSERT_NODE</a>(Node);
00749 
00750     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a34">CMS_SEC</a>) {
00751 <span class="preprocessor">#if DBG</span>
00752 <span class="preprocessor"></span>        UNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
00753 
00754         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.MaximumLength = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length = Node-&gt;NameLength;
00755         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Buffer = Node-&gt;Name;
00756         KdPrint((<span class="stringliteral">"CmpAssignSecurityDescriptor: '%wZ' (H %lx C %lx)\n"</span>,&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> ));
00757         KdPrint((<span class="stringliteral">"\tSecurityCell = %lx\n"</span>,Node-&gt;Security));
00758 <span class="preprocessor">#endif</span>
00759 <span class="preprocessor"></span>    }
00760 
00761     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Node-&gt;Security==<a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>);
00762 
00763     <span class="comment">//</span>
00764     <span class="comment">// This is a CreateKey, so the registry node has just been created and</span>
00765     <span class="comment">// the security descriptor we have been passed needs to be associated</span>
00766     <span class="comment">// with the new registry node and inserted into the hive.</span>
00767     <span class="comment">//</span>
00768     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a34">CMS_SEC</a>) {
00769         <a class="code" href="../../d1/d2/cmp_8h.html#a66">CmpDumpSecurityDescriptor</a>(SecurityDescriptor, <span class="stringliteral">"ASSIGN DESCRIPTOR\n"</span>);
00770     }
00771 
00772     <span class="comment">//</span>
00773     <span class="comment">// Try to find an existing security descriptor that matches this one.</span>
00774     <span class="comment">// If successful, then we don't need to allocate a new cell, we can</span>
00775     <span class="comment">// just point to the existing one and increment its reference count.</span>
00776     <span class="comment">//</span>
00777     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00778     <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d2/cmse_8c.html#a5">CmpFindMatchingDescriptorCell</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00779                                         Node,
00780                                         SecurityDescriptor,
00781                                         Type,
00782                                         &amp;SecurityCell )) {
00783         <span class="comment">//</span>
00784         <span class="comment">// No matching descriptor found, allocate and initialize a new one.</span>
00785         <span class="comment">//</span>
00786         SecurityCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00787                                       <a class="code" href="../../d7/d2/cmse_8c.html#a0">SECURITY_CELL_LENGTH</a>(SecurityDescriptor),
00788                                       Type);
00789         <span class="keywordflow">if</span> (SecurityCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00790             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00791         }
00792 
00793         <span class="comment">//</span>
00794         <span class="comment">// Map the security cell</span>
00795         <span class="comment">//</span>
00796         Security = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, SecurityCell);
00797 
00798         <span class="comment">//</span>
00799         <span class="comment">// Initialize the security cell</span>
00800         <span class="comment">//</span>
00801         DescriptorLength = <a class="code" href="../../d8/d6/sertl_8c.html#a56">RtlLengthSecurityDescriptor</a>(SecurityDescriptor);
00802 
00803         Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o0">Signature</a> = <a class="code" href="../../d9/d0/cmdata_8h.html#a39">CM_KEY_SECURITY_SIGNATURE</a>;
00804         Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o4">ReferenceCount</a> = 1;
00805         Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o5">DescriptorLength</a> = DescriptorLength;
00806         RtlMoveMemory( &amp;(Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o6">Descriptor</a>),
00807                        SecurityDescriptor,
00808                        DescriptorLength );
00809 
00810         <span class="comment">//</span>
00811         <span class="comment">// Insert the new security descriptor into the list of security</span>
00812         <span class="comment">// cells.</span>
00813         <span class="comment">//</span>
00814         <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d2/cmse_8c.html#a6">CmpInsertSecurityCellList</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>,SecurityCell))
00815         {
00816             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, SecurityCell);
00817             <span class="keywordflow">return</span> STATUS_NO_LOG_SPACE;
00818         }
00819 
00820     } <span class="keywordflow">else</span> {
00821 
00822         <span class="comment">//</span>
00823         <span class="comment">// Found identical descriptor already existing.  Map it in and</span>
00824         <span class="comment">// increment its reference count.</span>
00825         <span class="comment">//</span>
00826         <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, SecurityCell)) {
00827             <span class="keywordflow">return</span> STATUS_NO_LOG_SPACE;
00828         }
00829         Security = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, SecurityCell);
00830         Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o4">ReferenceCount</a> += 1;
00831     }
00832 
00833     <span class="comment">//</span>
00834     <span class="comment">// Initialize the reference in the node cell</span>
00835     <span class="comment">//</span>
00836     Node-&gt;Security = SecurityCell;
00837 
00838     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a34">CMS_SEC</a>) {
00839         KdPrint((<span class="stringliteral">"\tSecurityCell = %lx\n"</span>,Node-&gt;Security));
00840     }
00841 
00842     <span class="keywordflow">return</span>(STATUS_SUCCESS);
00843 }
00844 
00845 
00846 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00847"></a><a class="code" href="../../d7/d2/cmse_8c.html#a2">00847</a> <a class="code" href="../../d7/d2/cmse_8c.html#a2">CmpQuerySecurityDescriptorInfo</a>(
00848     IN <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> kcb,
00849     IN PSECURITY_INFORMATION SecurityInformation,
00850     OUT PSECURITY_DESCRIPTOR SecurityDescriptor,
00851     IN OUT PULONG Length,
00852     IN OUT PSECURITY_DESCRIPTOR *ObjectsSecurityDescriptor
00853     )
00854 
00855 <span class="comment">/*++</span>
00856 <span class="comment"></span>
00857 <span class="comment">Routine Description:</span>
00858 <span class="comment"></span>
00859 <span class="comment">    This routine will extract the desired information from the</span>
00860 <span class="comment">    passed security descriptor and return the information in</span>
00861 <span class="comment">    the passed buffer as a security descriptor in absolute format.</span>
00862 <span class="comment"></span>
00863 <span class="comment">Arguments:</span>
00864 <span class="comment"></span>
00865 <span class="comment">    Key - Supplies a pointer to the CM_KEY_REFERENCE for the node whose</span>
00866 <span class="comment">        security descriptor will be deleted.</span>
00867 <span class="comment"></span>
00868 <span class="comment">    SecurityInformation - Specifies what information is being queried.</span>
00869 <span class="comment"></span>
00870 <span class="comment">    SecurityDescriptor - Supplies the buffer to output the requested</span>
00871 <span class="comment">        information into.</span>
00872 <span class="comment"></span>
00873 <span class="comment">        This buffer has been probed only to the size indicated by</span>
00874 <span class="comment">        the Length parameter.  Since it still points into user space,</span>
00875 <span class="comment">        it must always be accessed in a try clause.</span>
00876 <span class="comment"></span>
00877 <span class="comment">    Length - Supplies the address of a variable containing the length of</span>
00878 <span class="comment">        the security descriptor buffer.  Upon return this variable will</span>
00879 <span class="comment">        contain the length needed to store the requested information.</span>
00880 <span class="comment"></span>
00881 <span class="comment">    ObjectsSecurityDescriptor - Supplies the address of a pointer to</span>
00882 <span class="comment">        the objects security descriptor.  The passed security descriptor</span>
00883 <span class="comment">        must be in self-relative format.</span>
00884 <span class="comment"></span>
00885 <span class="comment"></span>
00886 <span class="comment">Return Value:</span>
00887 <span class="comment"></span>
00888 <span class="comment">    NTSTATUS - STATUS_SUCCESS if successful and an appropriate error value</span>
00889 <span class="comment">        otherwise</span>
00890 <span class="comment"></span>
00891 <span class="comment">--*/</span>
00892 
00893 {
00894     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00895     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> Security;
00896     PSECURITY_DESCRIPTOR CellSecurityDescriptor;
00897 
00898     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00899     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a34">CMS_SEC</a>) {
00900         KdPrint((<span class="stringliteral">"CmpQuerySecurityDescriptorInfo:\n"</span>));
00901     }
00902 
00903     Security =  (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyHive, <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;Security);
00904 
00905     CellSecurityDescriptor = &amp;Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o6">Descriptor</a>;
00906 
00907     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/semethod_8c.html#a6">SeQuerySecurityDescriptorInfo</a>( SecurityInformation,
00908                                             SecurityDescriptor,
00909                                             Length,
00910                                             &amp;CellSecurityDescriptor );
00911 
00912     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00913 }
00914 
00915 
00916 BOOLEAN
<a name="l00917"></a><a class="code" href="../../d7/d2/cmse_8c.html#a11">00917</a> <a class="code" href="../../d7/d2/cmse_8c.html#a11">CmpCheckCreateAccess</a>(
00918     IN PUNICODE_STRING RelativeName,
00919     IN PSECURITY_DESCRIPTOR Descriptor,
00920     IN <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState,
00921     IN KPROCESSOR_MODE PreviousMode,
00922     IN ACCESS_MASK AdditionalAccess,
00923     OUT PNTSTATUS AccessStatus
00924     )
00925 
00926 <span class="comment">/*++</span>
00927 <span class="comment"></span>
00928 <span class="comment">Routine Description:</span>
00929 <span class="comment"></span>
00930 <span class="comment">    This routine checks to see if we are allowed to create a sub-key in the</span>
00931 <span class="comment">    given key, and performs auditing as appropriate.</span>
00932 <span class="comment"></span>
00933 <span class="comment">Arguments:</span>
00934 <span class="comment"></span>
00935 <span class="comment">    RelativeName - Supplies the relative name of the key being created.</span>
00936 <span class="comment"></span>
00937 <span class="comment">    Descriptor - Supplies the security descriptor of the key in which</span>
00938 <span class="comment">        the sub-key is to be created.</span>
00939 <span class="comment"></span>
00940 <span class="comment">    CreateAccess - The access mask corresponding to create access for</span>
00941 <span class="comment">        this directory type.</span>
00942 <span class="comment"></span>
00943 <span class="comment">    AccessState - Checks for traverse access will typically be incidental</span>
00944 <span class="comment">        to some other access attempt.  Information on the current state of</span>
00945 <span class="comment">        that access attempt is required so that the constituent access</span>
00946 <span class="comment">        attempts may be associated with each other in the audit log.</span>
00947 <span class="comment"></span>
00948 <span class="comment">    PreviousMode - The previous processor mode.</span>
00949 <span class="comment"></span>
00950 <span class="comment">    AdditionalAccess - access rights in addition to KEY_CREATE_SUB_KEY</span>
00951 <span class="comment">            that are required.  (e.g. KEY_CREATE_LINK)</span>
00952 <span class="comment"></span>
00953 <span class="comment">    AccessStatus - Pointer to a variable to return the status code of the</span>
00954 <span class="comment">        access attempt.  In the case of failure this status code must be</span>
00955 <span class="comment">        propagated back to the user.</span>
00956 <span class="comment"></span>
00957 <span class="comment">Return Value:</span>
00958 <span class="comment"></span>
00959 <span class="comment">    BOOLEAN - TRUE if access is allowed and FALSE otherwise.  AccessStatus</span>
00960 <span class="comment">    contains the status code to be passed back to the caller.  It is not</span>
00961 <span class="comment">    correct to simply pass back STATUS_ACCESS_DENIED, since this will have</span>
00962 <span class="comment">    to change with the advent of mandatory access control.</span>
00963 <span class="comment"></span>
00964 <span class="comment">--*/</span>
00965 
00966 {
00967     BOOLEAN AccessAllowed;
00968     ACCESS_MASK GrantedAccess = 0;
00969     BOOLEAN AuditPerformed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00970 
00971     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00972     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a34">CMS_SEC</a>) {
00973         KdPrint((<span class="stringliteral">"CmpCheckCreateAccess:\n"</span>));
00974     }
00975 
00976     <a class="code" href="../../d0/d8/subject_8c.html#a1">SeLockSubjectContext</a>( &amp;AccessState-&gt;SubjectSecurityContext );
00977 
00978     AccessAllowed = <a class="code" href="../../d0/d4/accessck_8c.html#a18">SeAccessCheck</a>(
00979                         Descriptor,
00980                         &amp;AccessState-&gt;SubjectSecurityContext,
00981                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,                              <span class="comment">// Token is read locked</span>
00982                         (KEY_CREATE_SUB_KEY | AdditionalAccess),
00983                         0,
00984                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00985                         &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>,
00986                         PreviousMode,
00987                         &amp;GrantedAccess,
00988                         AccessStatus
00989                         );
00990 
00991     <span class="comment">//</span>
00992     <span class="comment">// if the security guys ever get around to implementing this,</span>
00993     <span class="comment">// put this call back in.</span>
00994     <span class="comment">//</span>
00995 <span class="preprocessor">#if 0</span>
00996 <span class="preprocessor"></span>    <span class="comment">//</span>
00997     <span class="comment">// WARNNOTE John Vert (jvert) 22-Jan-92</span>
00998     <span class="comment">//  We don't have a Directory Object handy, and the auditing currently</span>
00999     <span class="comment">//  ignores it anyway.</span>
01000     <span class="comment">//</span>
01001 
01002     <a class="code" href="../../d3/d5/seaudit_8c.html#a26">SeCreateObjectAuditAlarm</a>(
01003         &amp;AccessState-&gt;OperationID,
01004         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                       <span class="comment">// &lt;- see WARNNOTE</span>
01005         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                       <span class="comment">// Need component name</span>
01006         Descriptor,
01007         &amp;AccessState-&gt;SubjectSecurityContext,
01008         KEY_CREATE_SUB_KEY,
01009         AccessState-&gt;PrivilegesUsed,
01010         AccessAllowed,
01011         &amp;AuditPerformed,
01012         PreviousMode
01013         );
01014 <span class="preprocessor">#endif</span>
01015 <span class="preprocessor"></span>
01016     <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( &amp;AccessState-&gt;SubjectSecurityContext );
01017 
01018     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a34">CMS_SEC</a>) {
01019         KdPrint((<span class="stringliteral">"Create access %s\n"</span>,AccessAllowed ? <span class="stringliteral">"granted"</span> : <span class="stringliteral">"denied"</span>));
01020 <span class="preprocessor">#if DBG</span>
01021 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!AccessAllowed) {
01022             <a class="code" href="../../d1/d2/cmp_8h.html#a66">CmpDumpSecurityDescriptor</a>(Descriptor, <span class="stringliteral">"DENYING DESCRIPTOR"</span>);
01023         }
01024 <span class="preprocessor">#endif</span>
01025 <span class="preprocessor"></span>    }
01026 
01027     <span class="keywordflow">return</span>(AccessAllowed);
01028 }
01029 
01030 
01031 BOOLEAN
<a name="l01032"></a><a class="code" href="../../d7/d2/cmse_8c.html#a12">01032</a> <a class="code" href="../../d7/d2/cmse_8c.html#a12">CmpCheckNotifyAccess</a>(
01033     IN <a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">PCM_NOTIFY_BLOCK</a> NotifyBlock,
01034     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
01035     IN <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node
01036     )
01037 <span class="comment">/*++</span>
01038 <span class="comment"></span>
01039 <span class="comment">Routine Description:</span>
01040 <span class="comment"></span>
01041 <span class="comment">    Check whether the subject process/thread/user specified by the</span>
01042 <span class="comment">    security data in the NotifyBlock has required access to the</span>
01043 <span class="comment">    key specified by Hive.Cell.</span>
01044 <span class="comment"></span>
01045 <span class="comment">Arguments:</span>
01046 <span class="comment"></span>
01047 <span class="comment">    NotifyBlock - pointer to structure that describes the notify</span>
01048 <span class="comment">                  operation, including the identity of the subject</span>
01049 <span class="comment">                  that opened the notify.</span>
01050 <span class="comment"></span>
01051 <span class="comment">    Hive - Supplies pointer to hive containing Node.</span>
01052 <span class="comment"></span>
01053 <span class="comment">    Node - Supplies pointer to key of interest.</span>
01054 <span class="comment"></span>
01055 <span class="comment">Return Value:</span>
01056 <span class="comment"></span>
01057 <span class="comment">    TRUE if RequiredAccess is in fact possessed by the subject,</span>
01058 <span class="comment">    else FALSE.</span>
01059 <span class="comment"></span>
01060 <span class="comment">--*/</span>
01061 {
01062     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> Security;
01063     PSECURITY_DESCRIPTOR SecurityDescriptor;
01064     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01065     BOOLEAN AccessAllowed;
01066     ACCESS_MASK GrantedAccess = 0;
01067 
01068     <a class="code" href="../../d1/d2/cmp_8h.html#a61">ASSERT_CM_LOCK_OWNED</a>();
01069     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01070 
01071 
01072     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a34">CMS_SEC</a>) {
01073         KdPrint((<span class="stringliteral">"CmpCheckAccessForNotify:\n"</span>));
01074     }
01075     Security = <a class="code" href="../../d7/d2/cmse_8c.html#a3">CmpGetKeySecurity</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01076                                  Node,
01077                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01078 
01079     <a class="code" href="../../d0/d8/subject_8c.html#a1">SeLockSubjectContext</a>( &amp;NotifyBlock-&gt;SubjectContext );
01080 
01081     SecurityDescriptor = &amp;Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o6">Descriptor</a>;
01082     AccessAllowed = <a class="code" href="../../d0/d4/accessck_8c.html#a18">SeAccessCheck</a>( SecurityDescriptor,
01083                                    &amp;NotifyBlock-&gt;SubjectContext,
01084                                    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01085                                    KEY_NOTIFY,
01086                                    0,
01087                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01088                                    &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>,
01089                                    <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
01090                                    &amp;GrantedAccess,
01091                                    &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01092 
01093     <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( &amp;NotifyBlock-&gt;SubjectContext );
01094 
01095     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a34">CMS_SEC</a>) {
01096         KdPrint((<span class="stringliteral">"Notify access %s\n"</span>,AccessAllowed ? <span class="stringliteral">"granted"</span> : <span class="stringliteral">"denied"</span>));
01097 <span class="preprocessor">#if DBG</span>
01098 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!AccessAllowed) {
01099             <a class="code" href="../../d1/d2/cmp_8h.html#a66">CmpDumpSecurityDescriptor</a>(SecurityDescriptor, <span class="stringliteral">"DENYING DESCRIPTOR"</span>);
01100         }
01101 <span class="preprocessor">#endif</span>
01102 <span class="preprocessor"></span>    }
01103 
01104     <span class="keywordflow">return</span> AccessAllowed;
01105 }
01106 
01107 
01108 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01109"></a><a class="code" href="../../d7/d2/cmse_8c.html#a4">01109</a> <a class="code" href="../../d9/d4/edithive_8c.html#a9">CmpGetObjectSecurity</a>(
01110     IN HCELL_INDEX Cell,
01111     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
01112     OUT <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> *Security,
01113     OUT PHCELL_INDEX SecurityCell OPTIONAL
01114     )
01115 
01116 <span class="comment">/*++</span>
01117 <span class="comment"></span>
01118 <span class="comment">Routine Description:</span>
01119 <span class="comment"></span>
01120 <span class="comment">    This routine maps in the security cell of a registry object.</span>
01121 <span class="comment"></span>
01122 <span class="comment">Arguments:</span>
01123 <span class="comment"></span>
01124 <span class="comment">    Cell - Supplies the cell index of the object.</span>
01125 <span class="comment"></span>
01126 <span class="comment">    Hive - Supplies the hive the object's cell is in.</span>
01127 <span class="comment"></span>
01128 <span class="comment">    Security - Returns a pointer to the security cell of the object.</span>
01129 <span class="comment"></span>
01130 <span class="comment">    SecurityCell - Returns the index of the security cell</span>
01131 <span class="comment"></span>
01132 <span class="comment">Return Value:</span>
01133 <span class="comment"></span>
01134 <span class="comment">    NONE.</span>
01135 <span class="comment"></span>
01136 <span class="comment">--*/</span>
01137 
01138 {
01139     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> CellIndex;
01140     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node;
01141 
01142     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01143     <span class="comment">//</span>
01144     <span class="comment">// Map the node we need to get the security descriptor for</span>
01145     <span class="comment">//</span>
01146     Node = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
01147 
01148     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a34">CMS_SEC</a>) {
01149 <span class="preprocessor">#if DBG</span>
01150 <span class="preprocessor"></span>        UNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
01151 
01152         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.MaximumLength = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length = Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>;
01153         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Buffer = Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>;
01154         KdPrint((<span class="stringliteral">"CmpGetObjectSecurity for: "</span>));
01155         KdPrint((<span class="stringliteral">"%wZ\n"</span>, &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>));
01156 <span class="preprocessor">#endif</span>
01157 <span class="preprocessor"></span>    }
01158 
01159     *Security = <a class="code" href="../../d7/d2/cmse_8c.html#a3">CmpGetKeySecurity</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,Node,SecurityCell);
01160 
01161     <span class="keywordflow">return</span>;
01162 }
01163 
01164 <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>
<a name="l01165"></a><a class="code" href="../../d7/d2/cmse_8c.html#a3">01165</a> <a class="code" href="../../d7/d2/cmse_8c.html#a3">CmpGetKeySecurity</a>(
01166     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
01167     IN <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Key,
01168     OUT PHCELL_INDEX SecurityCell OPTIONAL
01169     )
01170 
01171 <span class="comment">/*++</span>
01172 <span class="comment"></span>
01173 <span class="comment">Routine Description:</span>
01174 <span class="comment"></span>
01175 <span class="comment">    This routine returns the security of a registry key.</span>
01176 <span class="comment"></span>
01177 <span class="comment">Arguments:</span>
01178 <span class="comment"></span>
01179 <span class="comment">    Hive - Supplies the hive the object's cell is in.</span>
01180 <span class="comment"></span>
01181 <span class="comment">    Key - Supplies a pointer to the key node.</span>
01182 <span class="comment"></span>
01183 <span class="comment">    SecurityCell - Returns the index of the security cell</span>
01184 <span class="comment"></span>
01185 <span class="comment">Return Value:</span>
01186 <span class="comment"></span>
01187 <span class="comment">    Returns a pointer to the security cell of the object</span>
01188 <span class="comment"></span>
01189 <span class="comment">--*/</span>
01190 
01191 {
01192     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> CellIndex;
01193     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> Security;
01194 
01195     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01196 
01197     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;Signature == <a class="code" href="../../d9/d0/cmdata_8h.html#a25">CM_KEY_NODE_SIGNATURE</a>);
01198     <a class="code" href="../../d1/d2/cmp_8h.html#a84">ASSERT_NODE</a>(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>);
01199 
01200     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a34">CMS_SEC</a>) {
01201 <span class="preprocessor">#if DBG</span>
01202 <span class="preprocessor"></span>        UNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
01203 
01204         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.MaximumLength = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;NameLength;
01205         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Buffer = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;Name;
01206         KdPrint((<span class="stringliteral">"CmpGetObjectSecurity for: "</span>));
01207         KdPrint((<span class="stringliteral">"%wZ\n"</span>, &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>));
01208 <span class="preprocessor">#endif</span>
01209 <span class="preprocessor"></span>    }
01210 
01211     CellIndex = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;Security;
01212 
01213     <span class="comment">//</span>
01214     <span class="comment">// Map in the security descriptor cell</span>
01215     <span class="comment">//</span>
01216     Security = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, CellIndex);
01217     <a class="code" href="../../d1/d2/cmp_8h.html#a85">ASSERT_SECURITY</a>(Security);
01218 
01219     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(SecurityCell)) {
01220         *SecurityCell = CellIndex;
01221     }
01222 
01223     <span class="keywordflow">return</span>(Security);
01224 }
01225 
01226 PSECURITY_DESCRIPTOR
<a name="l01227"></a><a class="code" href="../../d7/d2/cmse_8c.html#a13">01227</a> <a class="code" href="../../d7/d2/cmse_8c.html#a13">CmpHiveRootSecurityDescriptor</a>(
01228     VOID
01229     )
01230 <span class="comment">/*++</span>
01231 <span class="comment"></span>
01232 <span class="comment">Routine Description:</span>
01233 <span class="comment"></span>
01234 <span class="comment">    This routine allocates and initializes the default security descriptor</span>
01235 <span class="comment">    for a system-created registry key.</span>
01236 <span class="comment"></span>
01237 <span class="comment">    The caller is responsible for freeing the allocated security descriptor</span>
01238 <span class="comment">    when he is done with it.</span>
01239 <span class="comment"></span>
01240 <span class="comment">Arguments:</span>
01241 <span class="comment"></span>
01242 <span class="comment">    None</span>
01243 <span class="comment"></span>
01244 <span class="comment">Return Value:</span>
01245 <span class="comment"></span>
01246 <span class="comment">    Pointer to an initialized security descriptor if successful.</span>
01247 <span class="comment"></span>
01248 <span class="comment">    Bugcheck otherwise.</span>
01249 <span class="comment"></span>
01250 <span class="comment">--*/</span>
01251 
01252 {
01253     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01254     PSECURITY_DESCRIPTOR SecurityDescriptor=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01255     PACL Acl=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01256     PACL AclCopy;
01257     PSID <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01258     PSID RestrictedSid=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01259     PSID SystemSid=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01260     PSID AdminSid=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01261     SID_IDENTIFIER_AUTHORITY WorldAuthority = SECURITY_WORLD_SID_AUTHORITY;
01262     SID_IDENTIFIER_AUTHORITY NtAuthority = SECURITY_NT_AUTHORITY;
01263     ULONG AceLength;
01264     ULONG AclLength;
01265     PACE_HEADER AceHeader;
01266 
01267     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01268 
01269     <span class="comment">//</span>
01270     <span class="comment">// Allocate and initialize the SIDs we will need.</span>
01271     <span class="comment">//</span>
01272     <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>  = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>(1));
01273     RestrictedSid  = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>(1));
01274     SystemSid = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>(1));
01275     AdminSid  = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>(2));
01276     <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>  == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01277         (RestrictedSid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01278         (SystemSid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01279         (AdminSid  == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01280 
01281         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR, 10, 0, 0, 0);
01282     }
01283 
01284     <span class="keywordflow">if</span> ((!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>(<a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>, &amp;WorldAuthority, 1))) ||
01285         (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>(RestrictedSid, &amp;NtAuthority, 1))) ||
01286         (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>(SystemSid, &amp;NtAuthority, 1))) ||
01287         (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>(AdminSid, &amp;NtAuthority, 2)))) {
01288         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR, 10, 1, 0, 0);
01289     }
01290 
01291     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>(<a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>, 0)) = SECURITY_WORLD_RID;
01292 
01293     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>(RestrictedSid, 0)) = SECURITY_RESTRICTED_CODE_RID;
01294 
01295     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>(SystemSid, 0)) = SECURITY_LOCAL_SYSTEM_RID;
01296 
01297     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>(AdminSid, 0)) = SECURITY_BUILTIN_DOMAIN_RID;
01298     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>(AdminSid, 1)) = DOMAIN_ALIAS_RID_ADMINS;
01299 
01300     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>(<a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>));
01301     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>(RestrictedSid));
01302     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>(SystemSid));
01303     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>(AdminSid));
01304 
01305     <span class="comment">//</span>
01306     <span class="comment">// Compute the size of the ACE list</span>
01307     <span class="comment">//</span>
01308 
01309     AceLength = (<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(<a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>)  -
01310                  <span class="keyword">sizeof</span>(ULONG)          +
01311                  <span class="keyword">sizeof</span>(ACCESS_ALLOWED_ACE))
01312               + (<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(RestrictedSid)  -
01313                  <span class="keyword">sizeof</span>(ULONG)          +
01314                  <span class="keyword">sizeof</span>(ACCESS_ALLOWED_ACE))
01315               + (<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(SystemSid) -
01316                  <span class="keyword">sizeof</span>(ULONG)          +
01317                  <span class="keyword">sizeof</span>(ACCESS_ALLOWED_ACE))
01318               + (<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(AdminSid)  -
01319                  <span class="keyword">sizeof</span>(ULONG)          +
01320                  <span class="keyword">sizeof</span>(ACCESS_ALLOWED_ACE));
01321 
01322     <span class="comment">//</span>
01323     <span class="comment">// Allocate and initialize the ACL</span>
01324     <span class="comment">//</span>
01325 
01326     AclLength = AceLength + <span class="keyword">sizeof</span>(ACL);
01327     Acl = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, AclLength);
01328     <span class="keywordflow">if</span> (Acl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01329         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a34">CMS_SEC</a>) {
01330             KdPrint((<span class="stringliteral">"CmpHiveRootSecurityDescriptor: couldn't allocate ACL\n"</span>));
01331         }
01332 
01333         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR, 10, 2, 0, 0);
01334     }
01335 
01336     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>(Acl, AclLength, ACL_REVISION);
01337     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01338         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a34">CMS_SEC</a>) {
01339             KdPrint((<span class="stringliteral">"CmpHiveRootSecurityDescriptor: couldn't initialize ACL\n"</span>));
01340         }
01341         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR, 10, 3, 0, 0);
01342     }
01343 
01344     <span class="comment">//</span>
01345     <span class="comment">// Now add the ACEs to the ACL</span>
01346     <span class="comment">//</span>
01347     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a>(Acl,
01348                                     ACL_REVISION,
01349                                     KEY_ALL_ACCESS,
01350                                     SystemSid);
01351     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01352         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a>(Acl,
01353                                         ACL_REVISION,
01354                                         KEY_ALL_ACCESS,
01355                                         AdminSid);
01356     }
01357     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01358         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a>(Acl,
01359                                         ACL_REVISION,
01360                                         KEY_READ,
01361                                         <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>);
01362     }
01363     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01364         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a>(Acl,
01365                                         ACL_REVISION,
01366                                         KEY_READ,
01367                                         RestrictedSid);
01368     }
01369     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01370         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a34">CMS_SEC</a>) {
01371             KdPrint((<span class="stringliteral">"CmpHiveRootSecurityDescriptor: RtlAddAce failed status %08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01372         }
01373 
01374         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR, 10, 4, 0, 0);
01375     }
01376 
01377     <span class="comment">//</span>
01378     <span class="comment">// Make the ACEs inheritable</span>
01379     <span class="comment">//</span>
01380     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a12">RtlGetAce</a>(Acl,0,&amp;AceHeader);
01381     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01382     AceHeader-&gt;AceFlags |= CONTAINER_INHERIT_ACE;
01383 
01384     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a12">RtlGetAce</a>(Acl,1,&amp;AceHeader);
01385     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01386     AceHeader-&gt;AceFlags |= CONTAINER_INHERIT_ACE;
01387 
01388     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a12">RtlGetAce</a>(Acl,2,&amp;AceHeader);
01389     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01390     AceHeader-&gt;AceFlags |= CONTAINER_INHERIT_ACE;
01391 
01392     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a12">RtlGetAce</a>(Acl,3,&amp;AceHeader);
01393     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01394     AceHeader-&gt;AceFlags |= CONTAINER_INHERIT_ACE;
01395     <span class="comment">//</span>
01396     <span class="comment">// We are finally ready to allocate and initialize the security descriptor</span>
01397     <span class="comment">// Allocate enough space to hold both the security descriptor and the</span>
01398     <span class="comment">// ACL.  This allows us to free the whole thing at once when we are</span>
01399     <span class="comment">// done with it.</span>
01400     <span class="comment">//</span>
01401 
01402     SecurityDescriptor = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
01403                             <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01404                             <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR) + AclLength
01405                             );
01406 
01407     <span class="keywordflow">if</span> (SecurityDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01408         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a34">CMS_SEC</a>) {
01409             KdPrint((<span class="stringliteral">"CmpHiveRootSecurityDescriptor: Couldn't allocate Sec. Desc.\n"</span>));
01410         }
01411         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR, 10, 5, 0, 0);
01412     }
01413 
01414     AclCopy = (PACL)((PISECURITY_DESCRIPTOR)SecurityDescriptor+1);
01415     RtlMoveMemory(AclCopy, Acl, AclLength);
01416 
01417     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>( SecurityDescriptor,
01418                                           SECURITY_DESCRIPTOR_REVISION );
01419     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01420         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a34">CMS_SEC</a>) {
01421             KdPrint((<span class="stringliteral">"CmpHiveRootSecurityDescriptor: CreateSecDesc failed %08lx\n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01422         }
01423         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SecurityDescriptor);
01424         SecurityDescriptor=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01425         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR, 10, 6, 0, 0);
01426     }
01427 
01428     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a>( SecurityDescriptor,
01429                                            <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01430                                            AclCopy,
01431                                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01432     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01433         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a34">CMS_SEC</a>) {
01434             KdPrint((<span class="stringliteral">"CmpHiveRootSecurityDescriptor: SetDacl failed %08lx\n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01435         }
01436         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SecurityDescriptor);
01437         SecurityDescriptor=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01438         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR, 10, 7, 0, 0);
01439     }
01440 
01441     <span class="comment">//</span>
01442     <span class="comment">// free any allocations we made</span>
01443     <span class="comment">//</span>
01444     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01445         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>);
01446     }
01447     <span class="keywordflow">if</span> (RestrictedSid!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01448         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(RestrictedSid);
01449     }
01450     <span class="keywordflow">if</span> (SystemSid!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01451         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SystemSid);
01452     }
01453     <span class="keywordflow">if</span> (AdminSid!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01454         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(AdminSid);
01455     }
01456     <span class="keywordflow">if</span> (Acl!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01457         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Acl);
01458     }
01459 
01460     <span class="keywordflow">return</span>(SecurityDescriptor);
01461 }
01462 
01463 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01464"></a><a class="code" href="../../d7/d2/cmse_8c.html#a14">01464</a> <a class="code" href="../../d6/d3/cmwraper_8c.html#a12">CmpFreeSecurityDescriptor</a>(
01465     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
01466     IN HCELL_INDEX Cell
01467     )
01468 
01469 <span class="comment">/*++</span>
01470 <span class="comment"></span>
01471 <span class="comment">Routine Description:</span>
01472 <span class="comment"></span>
01473 <span class="comment">    Frees the security descriptor associated with a particular node.  This</span>
01474 <span class="comment">    can only happen when the node is actually being deleted from the</span>
01475 <span class="comment">    registry.</span>
01476 <span class="comment"></span>
01477 <span class="comment">    NOTE:   Caller is expected to have already marked relevent cells dirty.</span>
01478 <span class="comment"></span>
01479 <span class="comment">Arguments:</span>
01480 <span class="comment"></span>
01481 <span class="comment">    Hive - Supplies thepointer to hive control structure for hive of interest</span>
01482 <span class="comment"></span>
01483 <span class="comment">    Cell - Supplies index for cell to free storage for (the target)</span>
01484 <span class="comment"></span>
01485 <span class="comment">Return Value:</span>
01486 <span class="comment"></span>
01487 <span class="comment">    None.</span>
01488 <span class="comment"></span>
01489 <span class="comment">--*/</span>
01490 
01491 {
01492     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> Node;
01493     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> Security;
01494     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> SecurityCell;
01495 
01496     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01497     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a34">CMS_SEC</a>) {
01498         KdPrint((<span class="stringliteral">"CmpFreeSecurityDescriptor for cell %ld\n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>));
01499     }
01500 
01501     <span class="comment">//</span>
01502     <span class="comment">// Map in the cell whose security descriptor is being freed</span>
01503     <span class="comment">//</span>
01504     Node = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
01505     <a class="code" href="../../d1/d2/cmp_8h.html#a84">ASSERT_NODE</a>(&amp;(Node-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>));
01506 
01507     <span class="comment">//</span>
01508     <span class="comment">// Map in the cell containing the security descriptor.</span>
01509     <span class="comment">//</span>
01510     SecurityCell = Node-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a>;
01511     Security = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, SecurityCell);
01512     <a class="code" href="../../d1/d2/cmp_8h.html#a85">ASSERT_SECURITY</a>(&amp;(Security-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o2">KeySecurity</a>));
01513 
01514 
01515     <span class="keywordflow">if</span> (Security-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o2">KeySecurity</a>.<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o4">ReferenceCount</a> == 1) {
01516 
01517         <span class="comment">//</span>
01518         <span class="comment">// This is the only cell that references this security descriptor,</span>
01519         <span class="comment">// so it is ok to free it now.</span>
01520         <span class="comment">//</span>
01521         <a class="code" href="../../d7/d2/cmse_8c.html#a7">CmpRemoveSecurityCellList</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, SecurityCell);
01522         <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, SecurityCell);
01523         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a34">CMS_SEC</a>) {
01524             KdPrint((<span class="stringliteral">"CmpFreeSecurityDescriptor: freeing security cell\n"</span>));
01525         }
01526     } <span class="keywordflow">else</span> {
01527 
01528         <span class="comment">//</span>
01529         <span class="comment">// More than one node references this security descriptor, so</span>
01530         <span class="comment">// just decrement the reference count.</span>
01531         <span class="comment">//</span>
01532         Security-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o2">KeySecurity</a>.<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o4">ReferenceCount</a> -= 1;
01533         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a34">CMS_SEC</a>) {
01534             KdPrint((<span class="stringliteral">"CmpFreeSecurityDescriptor: decrementing reference count\n"</span>));
01535         }
01536     }
01537 
01538     <span class="comment">//</span>
01539     <span class="comment">// Zero out the pointer to the security descriptdr in the main cell</span>
01540     <span class="comment">//</span>
01541     Node-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01542 }
01543 
01544 BOOLEAN
<a name="l01545"></a><a class="code" href="../../d7/d2/cmse_8c.html#a5">01545</a> <a class="code" href="../../d7/d2/cmse_8c.html#a5">CmpFindMatchingDescriptorCell</a>(
01546     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
01547     IN <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node,
01548     IN PSECURITY_DESCRIPTOR SecurityDescriptor,
01549     IN ULONG Type,
01550     OUT PHCELL_INDEX MatchingCell
01551     )
01552 
01553 <span class="comment">/*++</span>
01554 <span class="comment"></span>
01555 <span class="comment">Routine Description:</span>
01556 <span class="comment"></span>
01557 <span class="comment">    This routine attempts to find a security descriptor in the hive that</span>
01558 <span class="comment">    is identical to the one passed in.  If it finds one, it returns its</span>
01559 <span class="comment">    cell index.</span>
01560 <span class="comment"></span>
01561 <span class="comment">    Currently, this routine checks the security descriptors of the parent</span>
01562 <span class="comment">    and siblings of the node to find a match.</span>
01563 <span class="comment"></span>
01564 <span class="comment">Arguments:</span>
01565 <span class="comment"></span>
01566 <span class="comment">    Hive - Supplies a pointer to the hive control structure for the node.</span>
01567 <span class="comment"></span>
01568 <span class="comment">    Cell - Supplies the cell index of the node</span>
01569 <span class="comment"></span>
01570 <span class="comment">    SecurityDescriptor - Supplies the cooked security descriptor which</span>
01571 <span class="comment">           should be searched for.</span>
01572 <span class="comment"></span>
01573 <span class="comment">    Type - Indicates whether the Security Descriptor that matches must</span>
01574 <span class="comment">            be in Stable or Volatile store</span>
01575 <span class="comment"></span>
01576 <span class="comment">    MatchingCell - Returns the cell index of a security cell whose</span>
01577 <span class="comment">           security descriptor is identical to SecurityDescriptor.</span>
01578 <span class="comment">           Valid only if TRUE is returned.</span>
01579 <span class="comment"></span>
01580 <span class="comment">Return Value:</span>
01581 <span class="comment"></span>
01582 <span class="comment">    TRUE - Matching security descriptor found.  MatchingCell returns the</span>
01583 <span class="comment">           cell index of the matching security descriptor.</span>
01584 <span class="comment"></span>
01585 <span class="comment">    FALSE - No matching security descriptor found.  MatchingCell is invalid.</span>
01586 <span class="comment"></span>
01587 <span class="comment">--*/</span>
01588 
01589 {
01590     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> ChildCheckNode;
01591     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> SiblingNode;
01592     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> Security;
01593     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> ParentNode;
01594     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> SiblingCell;
01595     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01596     ULONG DescriptorLength;
01597     ULONG index;
01598 
01599     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01600         
01601     DescriptorLength = <a class="code" href="../../d8/d6/sertl_8c.html#a56">RtlLengthSecurityDescriptor</a>(SecurityDescriptor);
01602     
01603         <span class="comment">//</span>
01604     <span class="comment">// Check to see if it's a root node or not.</span>
01605     <span class="comment">//</span>
01606     <span class="keywordflow">if</span> (Node-&gt;Flags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a29">KEY_HIVE_ENTRY</a>) {
01607 
01608         <span class="comment">//</span>
01609         <span class="comment">// Never share security descriptors across hive boundaries.</span>
01610         <span class="comment">// Go directly to the child key check.</span>
01611         <span class="comment">//</span>
01612         ChildCheckNode = Node;
01613         <span class="keywordflow">goto</span> RetryMyChildren;
01614     }
01615 
01616     ParentNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,Node-&gt;Parent);
01617 
01618     Security = <a class="code" href="../../d7/d2/cmse_8c.html#a3">CmpGetKeySecurity</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01619                                  ParentNode,
01620                                  MatchingCell);
01621 
01622     <span class="keywordflow">if</span> ((DescriptorLength==Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o5">DescriptorLength</a>) &amp;&amp;
01623         (Type == <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(*MatchingCell))          &amp;&amp;
01624         (RtlEqualMemory(SecurityDescriptor,
01625                         &amp;(Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o6">Descriptor</a>),
01626                         DescriptorLength))) {
01627         <span class="comment">//</span>
01628         <span class="comment">// We have found a match.</span>
01629         <span class="comment">//</span>
01630         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a34">CMS_SEC</a>) {
01631             KdPrint((<span class="stringliteral">"CmpFindMatchingDescriptor: Cell's descriptor matched parent\n"</span>));
01632         }
01633         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01634     }
01635 
01636     <span class="comment">//</span>
01637     <span class="comment">// Parent didn't match.  Go check all the siblings.</span>
01638     <span class="comment">//</span>
01639     ChildCheckNode = ParentNode;
01640 
01641     <span class="comment">//</span>
01642     <span class="comment">// Below loop gets executed twice. The first time we check the siblings of</span>
01643     <span class="comment">// the target node's parents. The second time, we check the target node's</span>
01644     <span class="comment">// own children.</span>
01645     <span class="comment">//</span>
01646 RetryMyChildren:
01647     index=0;
01648     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01649         SiblingCell = <a class="code" href="../../d1/d2/cmp_8h.html#a304">CmpFindSubKeyByNumber</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,ChildCheckNode,index++);
01650         <span class="keywordflow">if</span> (SiblingCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01651             <span class="comment">//</span>
01652             <span class="comment">// out of siblings</span>
01653             <span class="comment">//</span>
01654             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01655         }
01656         SiblingNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,SiblingCell);
01657 
01658         <span class="keywordflow">if</span> (SiblingNode != Node) {
01659 
01660             <span class="comment">//</span>
01661             <span class="comment">// We have a sibling, so get its security descriptor</span>
01662             <span class="comment">//</span>
01663             Security = <a class="code" href="../../d7/d2/cmse_8c.html#a3">CmpGetKeySecurity</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01664                                          SiblingNode,
01665                                          MatchingCell);
01666 
01667             <span class="comment">//</span>
01668             <span class="comment">// Compare its security descriptor to ours</span>
01669             <span class="comment">//</span>
01670 
01671             <span class="keywordflow">if</span> ((DescriptorLength==Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o5">DescriptorLength</a>) &amp;&amp;
01672                 (Type == <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(*MatchingCell))          &amp;&amp;
01673                 (RtlEqualMemory(SecurityDescriptor,
01674                                 &amp;(Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o6">Descriptor</a>),
01675                                 DescriptorLength))) {
01676                 <span class="comment">//</span>
01677                 <span class="comment">// We have found a match.</span>
01678                 <span class="comment">//</span>
01679                 <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a34">CMS_SEC</a>) {
01680                     KdPrint((<span class="stringliteral">"CmpFindMatchingDescriptor: Cell's descriptor "</span>));
01681                     KdPrint((<span class="stringliteral">"matched sibling %d\n"</span>,index));
01682                 }
01683                 <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01684             }
01685         }
01686     }
01687 
01688     <span class="keywordflow">if</span> (ChildCheckNode == ParentNode) {
01689         <span class="comment">//</span>
01690         <span class="comment">// Do the second iteration.</span>
01691         <span class="comment">//</span>
01692         ChildCheckNode = Node;
01693         <span class="keywordflow">goto</span> RetryMyChildren;
01694     }
01695 
01696     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a34">CMS_SEC</a>) {
01697         KdPrint((<span class="stringliteral">"CmpFindMatchingDescriptor: no matching descriptor found\n"</span>));
01698     }
01699     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01700 }
01701 
01702 
01703 BOOLEAN
<a name="l01704"></a><a class="code" href="../../d7/d2/cmse_8c.html#a6">01704</a> <a class="code" href="../../d7/d2/cmse_8c.html#a6">CmpInsertSecurityCellList</a>(
01705     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
01706     IN HCELL_INDEX NodeCell,
01707     IN HCELL_INDEX SecurityCell
01708     )
01709 <span class="comment">/*++</span>
01710 <span class="comment"></span>
01711 <span class="comment">Routine Description:</span>
01712 <span class="comment"></span>
01713 <span class="comment">    Inserts a newly-created security cell into the per-hive linked list of</span>
01714 <span class="comment">    security cells.</span>
01715 <span class="comment"></span>
01716 <span class="comment">    NOTE:   Assumes that NodeCell and SecurityCell have already been</span>
01717 <span class="comment">            marked dirty.</span>
01718 <span class="comment"></span>
01719 <span class="comment">Arguments:</span>
01720 <span class="comment"></span>
01721 <span class="comment">    Hive - Supplies a pointer to the hive control structure.</span>
01722 <span class="comment"></span>
01723 <span class="comment">    NodeCell - Supplies the cell index of the node that owns the security cell</span>
01724 <span class="comment"></span>
01725 <span class="comment">    SecurityCell - Supplies the cell index of the security cell.</span>
01726 <span class="comment"></span>
01727 <span class="comment">Return Value:</span>
01728 <span class="comment"></span>
01729 <span class="comment">    TRUE - it worked</span>
01730 <span class="comment"></span>
01731 <span class="comment">    FALSE - some failure - generally STATUS_NO_LOG_SPACE</span>
01732 <span class="comment"></span>
01733 <span class="comment">--*/</span>
01734 
01735 {
01736     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> FlinkCell;
01737     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> BlinkCell;
01738     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
01739     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node;
01740     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> ParentNode;
01741 
01742     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01743     <span class="comment">//</span>
01744     <span class="comment">// If the new cell's storage type is Volatile, simply make it the</span>
01745     <span class="comment">//  anchor of it's own list.  (Volatile security entries will disappear</span>
01746     <span class="comment">//  at reboot, restore, etc, so we don't need the list to hunt them</span>
01747     <span class="comment">//  down at those times.)</span>
01748     <span class="comment">//</span>
01749     <span class="comment">// Else, the storage type is Stable.</span>
01750     <span class="comment">//   Map in the node that owns the new security cell.  If it is a root</span>
01751     <span class="comment">//   cell, then we are creating the hive for the first time, so this is</span>
01752     <span class="comment">//   the only security cell in the list.  If it is not a root cell, then</span>
01753     <span class="comment">//   we simply find its parent's security cell and stick the new security</span>
01754     <span class="comment">//   cell into the list immediately after it.</span>
01755     <span class="comment">//</span>
01756     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, SecurityCell);
01757     <a class="code" href="../../d1/d2/cmp_8h.html#a85">ASSERT_SECURITY</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
01758 
01759     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(SecurityCell) == <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>) {
01760 
01761         <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Flink = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Blink = SecurityCell;
01762 
01763     } <span class="keywordflow">else</span> {
01764 
01765         Node = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, NodeCell);
01766         <a class="code" href="../../d1/d2/cmp_8h.html#a84">ASSERT_NODE</a>(Node);
01767 
01768         <span class="keywordflow">if</span> (Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a29">KEY_HIVE_ENTRY</a>) {
01769             <span class="comment">//</span>
01770             <span class="comment">// This must be the hive creation, so this cell becomes the anchor</span>
01771             <span class="comment">// for the list.</span>
01772             <span class="comment">//</span>
01773             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a34">CMS_SEC</a>) {
01774                 KdPrint((<span class="stringliteral">"CmpInsertSecurityCellList: hive creation\n"</span>));
01775             }
01776             <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Flink = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Blink = SecurityCell;
01777 
01778         } <span class="keywordflow">else</span> {
01779             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a34">CMS_SEC</a>) {
01780                 KdPrint((<span class="stringliteral">"CmpInsertSecurityCellList: insert at parent\n"</span>));
01781             }
01782             <span class="comment">//</span>
01783             <span class="comment">// Map in the node's parent's security cell, so we can hook into</span>
01784             <span class="comment">// the list there.</span>
01785             <span class="comment">//</span>
01786             ParentNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a>);
01787             <a class="code" href="../../d1/d2/cmp_8h.html#a84">ASSERT_NODE</a>(ParentNode);
01788             BlinkCell = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(
01789                                             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01790                                             ParentNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a>
01791                                             );
01792             <a class="code" href="../../d1/d2/cmp_8h.html#a85">ASSERT_SECURITY</a>(BlinkCell);
01793 
01794             <span class="comment">//</span>
01795             <span class="comment">// Map in the Flink of the parent's security cell.</span>
01796             <span class="comment">//</span>
01797             FlinkCell = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(
01798                                             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01799                                             BlinkCell-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a>
01800                                             );
01801             <a class="code" href="../../d1/d2/cmp_8h.html#a85">ASSERT_SECURITY</a>(FlinkCell);
01802 
01803             <span class="keywordflow">if</span> (! (<a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ParentNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a>) &amp;&amp;
01804                    <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, BlinkCell-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a>)))
01805             {
01806                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01807             }
01808 
01809             <span class="comment">//</span>
01810             <span class="comment">// Insert the new security cell in between the Flink and Blink cells</span>
01811             <span class="comment">//</span>
01812             <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Flink = BlinkCell-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a>;
01813             <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Blink = FlinkCell-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o3">Blink</a>;
01814             BlinkCell-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a> = SecurityCell;
01815             FlinkCell-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o3">Blink</a> = SecurityCell;
01816         }
01817     }
01818     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01819 }
01820 
01821 
01822 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01823"></a><a class="code" href="../../d7/d2/cmse_8c.html#a7">01823</a> <a class="code" href="../../d7/d2/cmse_8c.html#a7">CmpRemoveSecurityCellList</a>(
01824     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
01825     IN HCELL_INDEX SecurityCell
01826     )
01827 <span class="comment">/*++</span>
01828 <span class="comment"></span>
01829 <span class="comment">Routine Description:</span>
01830 <span class="comment"></span>
01831 <span class="comment">    Removes a security cell from the per-hive linked list of security cells.</span>
01832 <span class="comment">    (This means the cell is going to be deleted!)</span>
01833 <span class="comment"></span>
01834 <span class="comment">    NOTE:   Caller is expected to have already marked relevent cells dirty</span>
01835 <span class="comment"></span>
01836 <span class="comment">Arguments:</span>
01837 <span class="comment"></span>
01838 <span class="comment">    Hive - Supplies a pointer to the hive control structure</span>
01839 <span class="comment"></span>
01840 <span class="comment">    SecurityCell - Supplies the cell index of the security cell to be</span>
01841 <span class="comment">           removed</span>
01842 <span class="comment"></span>
01843 <span class="comment">Return Value:</span>
01844 <span class="comment"></span>
01845 <span class="comment">    None.</span>
01846 <span class="comment"></span>
01847 <span class="comment">--*/</span>
01848 
01849 {
01850     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> FlinkCell;
01851     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> BlinkCell;
01852     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
01853 
01854     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01855     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a34">CMS_SEC</a>) {
01856         KdPrint((<span class="stringliteral">"CmpRemoveSecurityCellList: index %ld\n"</span>,SecurityCell));
01857     }
01858     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, SecurityCell);
01859     FlinkCell = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Flink);
01860     BlinkCell = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Blink);
01861 
01862     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FlinkCell-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o3">Blink</a> == SecurityCell);
01863     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(BlinkCell-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a> == SecurityCell);
01864 
01865     FlinkCell-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o3">Blink</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Blink;
01866     BlinkCell-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Flink;
01867 }
01868 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:28 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
