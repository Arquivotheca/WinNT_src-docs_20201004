<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ldrrsrc.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ldrrsrc.c</h1><a href="../../d1/d3/ldrrsrc_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    ldrrsrc.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    Loader API calls for accessing resource sections.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Steve Wood (stevewo) 16-Sep-1991</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d5/d9/ntrtlp_8h.html">ntrtlp.h</a>"</span>
00022 
00023 <span class="preprocessor">#if defined(ALLOC_PRAGMA) &amp;&amp; defined(NTOS_KERNEL_RUNTIME)</span>
00024 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,LdrAccessResource)</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,LdrpAccessResourceData)</span>
00026 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,LdrFindEntryForAddress)</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,LdrFindResource_U)</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,LdrFindResourceDirectory_U)</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,LdrpCompareResourceNames_U)</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,LdrpSearchResourceSection_U)</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,LdrEnumResources)</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00033 <span class="preprocessor"></span>
00034 <span class="preprocessor">#ifndef NTOS_KERNEL_RUNTIME</span>
00035 <span class="preprocessor"></span>
<a name="l00036"></a><a class="code" href="../../d1/d3/ldrrsrc_8c.html#a3">00036</a> <a class="code" href="../../d8/d6/struct__ALT__RESOURCE__MODULE.html">PALT_RESOURCE_MODULE</a> <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a3">AlternateResourceModules</a>;
<a name="l00037"></a><a class="code" href="../../d1/d3/ldrrsrc_8c.html#a4">00037</a> ULONG <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a4">AlternateResourceModuleCount</a>;
<a name="l00038"></a><a class="code" href="../../d1/d3/ldrrsrc_8c.html#a5">00038</a> ULONG <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a5">AltResMemBlockCount</a>;
<a name="l00039"></a><a class="code" href="../../d1/d3/ldrrsrc_8c.html#a6">00039</a> LANGID <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a6">UILangId</a>, <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a7">InstallLangId</a>;
00040 
<a name="l00041"></a><a class="code" href="../../d1/d3/ldrrsrc_8c.html#a0">00041</a> <span class="preprocessor">#define  MEMBLOCKSIZE 16</span>
<a name="l00042"></a><a class="code" href="../../d1/d3/ldrrsrc_8c.html#a1">00042</a> <span class="preprocessor"></span><span class="preprocessor">#define  RESMODSIZE sizeof(ALT_RESOURCE_MODULE)</span>
00043 <span class="preprocessor"></span>
00044 <span class="preprocessor">#endif</span>
00045 <span class="preprocessor"></span>
00046 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00047"></a><a class="code" href="../../d1/d3/ldrrsrc_8c.html#a8">00047</a> <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a8">LdrAccessResource</a>(
00048     IN PVOID DllHandle,
00049     IN PIMAGE_RESOURCE_DATA_ENTRY ResourceDataEntry,
00050     OUT PVOID *Address OPTIONAL,
00051     OUT PULONG Size OPTIONAL
00052     )
00053 
00054 <span class="comment">/*++</span>
00055 <span class="comment"></span>
00056 <span class="comment">Routine Description:</span>
00057 <span class="comment"></span>
00058 <span class="comment">    This function locates the address of the specified resource in the</span>
00059 <span class="comment">    specified DLL and returns its address.</span>
00060 <span class="comment"></span>
00061 <span class="comment">Arguments:</span>
00062 <span class="comment"></span>
00063 <span class="comment">    DllHandle - Supplies a handle to the image file that the resource is</span>
00064 <span class="comment">        contained in.</span>
00065 <span class="comment"></span>
00066 <span class="comment">    ResourceDataEntry - Supplies a pointer to the resource data entry in</span>
00067 <span class="comment">        the resource data section of the image file specified by the</span>
00068 <span class="comment">        DllHandle parameter.  This pointer should have been one returned</span>
00069 <span class="comment">        by the LdrFindResource function.</span>
00070 <span class="comment"></span>
00071 <span class="comment">    Address - Optional pointer to a variable that will receive the</span>
00072 <span class="comment">        address of the resource specified by the first two parameters.</span>
00073 <span class="comment"></span>
00074 <span class="comment">    Size - Optional pointer to a variable that will receive the size of</span>
00075 <span class="comment">        the resource specified by the first two parameters.</span>
00076 <span class="comment"></span>
00077 <span class="comment">Return Value:</span>
00078 <span class="comment"></span>
00079 <span class="comment">    TBD</span>
00080 <span class="comment"></span>
00081 <span class="comment">--*/</span>
00082 
00083 {
00084     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00085 
00086     <span class="keywordflow">return</span> <a class="code" href="../../d5/d9/ntrtlp_8h.html#a35">LdrpAccessResourceData</a>(
00087       DllHandle,
00088       ResourceDataEntry,
00089       Address,
00090       <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>
00091       );
00092 }
00093 
00094 
00095 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00096"></a><a class="code" href="../../d5/d9/ntrtlp_8h.html#a35">00096</a> <a class="code" href="../../d5/d9/ntrtlp_8h.html#a35">LdrpAccessResourceData</a>(
00097     IN PVOID DllHandle,
00098     IN PIMAGE_RESOURCE_DATA_ENTRY ResourceDataEntry,
00099     OUT PVOID *Address OPTIONAL,
00100     OUT PULONG Size OPTIONAL
00101     )
00102 
00103 <span class="comment">/*++</span>
00104 <span class="comment"></span>
00105 <span class="comment">Routine Description:</span>
00106 <span class="comment"></span>
00107 <span class="comment">    This function returns the data necessary to actually examine the</span>
00108 <span class="comment">    contents of a particular resource.</span>
00109 <span class="comment"></span>
00110 <span class="comment">Arguments:</span>
00111 <span class="comment"></span>
00112 <span class="comment">    DllHandle - Supplies a handle to the image file that the resource is</span>
00113 <span class="comment">        contained in.</span>
00114 <span class="comment"></span>
00115 <span class="comment">    ResourceDataEntry - Supplies a pointer to the resource data entry in</span>
00116 <span class="comment">   the resource data directory of the image file specified by the</span>
00117 <span class="comment">        DllHandle parameter.  This pointer should have been one returned</span>
00118 <span class="comment">        by the LdrFindResource function.</span>
00119 <span class="comment"></span>
00120 <span class="comment">    Address - Optional pointer to a variable that will receive the</span>
00121 <span class="comment">        address of the resource specified by the first two parameters.</span>
00122 <span class="comment"></span>
00123 <span class="comment">    Size - Optional pointer to a variable that will receive the size of</span>
00124 <span class="comment">        the resource specified by the first two parameters.</span>
00125 <span class="comment"></span>
00126 <span class="comment"></span>
00127 <span class="comment">Return Value:</span>
00128 <span class="comment"></span>
00129 <span class="comment">    TBD</span>
00130 <span class="comment"></span>
00131 <span class="comment">--*/</span>
00132 
00133 {
00134     PIMAGE_RESOURCE_DIRECTORY ResourceDirectory;
00135     ULONG ResourceSize;
00136     PIMAGE_NT_HEADERS NtHeaders;
00137     ULONG_PTR VirtualAddressOffset;
00138     PIMAGE_SECTION_HEADER NtSection;
00139 
00140     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00141 
00142 <span class="preprocessor">#ifndef NTOS_KERNEL_RUNTIME</span>
00143 <span class="preprocessor"></span>    ResourceDirectory = (PIMAGE_RESOURCE_DIRECTORY)
00144         <a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(DllHandle,
00145                                      <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00146                                      IMAGE_DIRECTORY_ENTRY_RESOURCE,
00147                                      &amp;ResourceSize
00148                                      );
00149     <span class="keywordflow">if</span> (!ResourceDirectory) {
00150         <span class="keywordflow">return</span>( STATUS_RESOURCE_DATA_NOT_FOUND );
00151     }
00152 
00153     <span class="keywordflow">if</span> ((ULONG_PTR)ResourceDataEntry &lt; (ULONG_PTR) ResourceDirectory ){
00154         DllHandle = <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a21">LdrLoadAlternateResourceModule</a> (DllHandle, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00155     } <span class="keywordflow">else</span>{
00156         NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(
00157                         (PVOID)((ULONG_PTR)DllHandle &amp; ~0x00000001)
00158                         );
00159         <span class="keywordflow">if</span> (NtHeaders) {
00160             <span class="comment">// Find the bounds of the image so we can see if this resource entry is in an alternate</span>
00161             <span class="comment">// resource dll.</span>
00162 
00163             ULONG_PTR ImageStart = (ULONG_PTR)DllHandle &amp; ~0x00000001;
00164             SIZE_T ImageSize = 0;
00165 
00166             <span class="keywordflow">if</span> ((ULONG_PTR)DllHandle &amp; 0x00000001) {
00167                 <span class="comment">// mapped as datafile.  Ask mm for the size</span>
00168                 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00169                 MEMORY_BASIC_INFORMATION MemInfo;
00170 
00171                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/queryvm_8c.html#a4">NtQueryVirtualMemory</a>(
00172                             NtCurrentProcess(),
00173                             (PVOID) ImageStart,
00174                             MemoryBasicInformation,
00175                             (PVOID)&amp;MemInfo,
00176                             <span class="keyword">sizeof</span>(MemInfo),
00177                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00178                             );
00179 
00180                 <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00181                     ImageSize = 0;
00182                 } <span class="keywordflow">else</span> {
00183                     ImageSize = MemInfo.RegionSize;
00184                 }
00185             } <span class="keywordflow">else</span> {
00186                 ImageSize = ((PIMAGE_NT_HEADERS32)NtHeaders)-&gt;OptionalHeader.SizeOfImage;
00187             }
00188 
00189             <span class="keywordflow">if</span> (!(((ULONG_PTR)ResourceDataEntry &gt;= ImageStart) &amp;&amp; ((ULONG_PTR)ResourceDataEntry &lt; (ImageStart + ImageSize)))) {
00190                 <span class="comment">// Doesn't fall within the specified image.  Must be an alternate dll.</span>
00191                 DllHandle = <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a21">LdrLoadAlternateResourceModule</a> (DllHandle, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00192             }
00193         }
00194     }
00195 
00196     <span class="keywordflow">if</span> (!DllHandle){
00197         <span class="keywordflow">return</span> ( STATUS_RESOURCE_DATA_NOT_FOUND );
00198     }
00199 
00200 <span class="preprocessor">#endif</span>
00201 <span class="preprocessor"></span>    <span class="keywordflow">try</span> {
00202         ResourceDirectory = (PIMAGE_RESOURCE_DIRECTORY)
00203             <a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(DllHandle,
00204                                          <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00205                                          IMAGE_DIRECTORY_ENTRY_RESOURCE,
00206                                          &amp;ResourceSize
00207                                          );
00208         <span class="keywordflow">if</span> (!ResourceDirectory) {
00209             <span class="keywordflow">return</span>( STATUS_RESOURCE_DATA_NOT_FOUND );
00210             }
00211 
00212         <span class="keywordflow">if</span> ((ULONG_PTR)DllHandle &amp; 0x00000001) {
00213             ULONG ResourceRVA;
00214             DllHandle = (PVOID)((ULONG_PTR)DllHandle &amp; ~0x00000001);
00215             NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>( DllHandle );
00216             <span class="keywordflow">if</span> (NtHeaders-&gt;OptionalHeader.Magic == IMAGE_NT_OPTIONAL_HDR32_MAGIC) {
00217                 ResourceRVA=((PIMAGE_NT_HEADERS32)NtHeaders)-&gt;OptionalHeader.DataDirectory[ IMAGE_DIRECTORY_ENTRY_RESOURCE ].VirtualAddress;
00218             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NtHeaders-&gt;OptionalHeader.Magic == IMAGE_NT_OPTIONAL_HDR64_MAGIC) {
00219                 ResourceRVA=((PIMAGE_NT_HEADERS64)NtHeaders)-&gt;OptionalHeader.DataDirectory[ IMAGE_DIRECTORY_ENTRY_RESOURCE ].VirtualAddress;
00220             } <span class="keywordflow">else</span> {
00221                 ResourceRVA = 0;
00222             }
00223 
00224             <span class="keywordflow">if</span> (!ResourceRVA) {
00225                 <span class="keywordflow">return</span>( STATUS_RESOURCE_DATA_NOT_FOUND );
00226                 }
00227 
00228             VirtualAddressOffset = (ULONG_PTR)DllHandle + ResourceRVA - (ULONG_PTR)ResourceDirectory;
00229 
00230             <span class="comment">//</span>
00231             <span class="comment">// Now, we must check to see if the resource is not in the</span>
00232             <span class="comment">// same section as the resource table.  If it's in .rsrc1,</span>
00233             <span class="comment">// we've got to adjust the RVA in the ResourceDataEntry</span>
00234             <span class="comment">// to point to the correct place in the non-VA data file.</span>
00235             <span class="comment">//</span>
00236             NtSection= <a class="code" href="../../d8/d9/imagedir_8c.html#a1">RtlSectionTableFromVirtualAddress</a>( NtHeaders, DllHandle, ResourceRVA);
00237 
00238             <span class="keywordflow">if</span> (!NtSection) {
00239                 <span class="keywordflow">return</span>( STATUS_RESOURCE_DATA_NOT_FOUND );
00240                 }
00241 
00242             <span class="keywordflow">if</span> ( ResourceDataEntry-&gt;OffsetToData &gt; NtSection-&gt;Misc.VirtualSize ) {
00243                 ULONG rva;
00244 
00245                 rva = NtSection-&gt;VirtualAddress;
00246                 NtSection= <a class="code" href="../../d8/d9/imagedir_8c.html#a1">RtlSectionTableFromVirtualAddress</a>(NtHeaders,
00247                                                              DllHandle,
00248                                                              ResourceDataEntry-&gt;OffsetToData
00249                                                              );
00250                 VirtualAddressOffset +=
00251                         ((ULONG_PTR)NtSection-&gt;VirtualAddress - rva) -
00252                         ((ULONG_PTR)<a class="code" href="../../d8/d9/imagedir_8c.html#a2">RtlAddressInSectionTable</a> ( NtHeaders, DllHandle, NtSection-&gt;VirtualAddress ) - (ULONG_PTR)ResourceDirectory);
00253                 }
00254             }
00255         <span class="keywordflow">else</span> {
00256             VirtualAddressOffset = 0;
00257             }
00258 
00259         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Address )) {
00260             *Address = (PVOID)( (PCHAR)DllHandle +
00261                                 (ResourceDataEntry-&gt;OffsetToData - VirtualAddressOffset)
00262                               );
00263             }
00264 
00265         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> )) {
00266             *<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = ResourceDataEntry-&gt;Size;
00267             }
00268         }
00269     except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00270         <span class="keywordflow">return</span> GetExceptionCode();
00271         }
00272 
00273     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00274 }
00275 
00276 
00277 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00278"></a><a class="code" href="../../d1/d3/ldrrsrc_8c.html#a10">00278</a> <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a10">LdrFindEntryForAddress</a>(
00279     IN PVOID Address,
00280     OUT PLDR_DATA_TABLE_ENTRY *TableEntry
00281     )
00282 <span class="comment">/*++</span>
00283 <span class="comment"></span>
00284 <span class="comment">Routine Description:</span>
00285 <span class="comment"></span>
00286 <span class="comment">    This function returns the load data table entry that describes the virtual</span>
00287 <span class="comment">    address range that contains the passed virtual address.</span>
00288 <span class="comment"></span>
00289 <span class="comment">Arguments:</span>
00290 <span class="comment"></span>
00291 <span class="comment">    Address - Supplies a 32-bit virtual address.</span>
00292 <span class="comment"></span>
00293 <span class="comment">    TableEntry - Supplies a pointer to the variable that will receive the</span>
00294 <span class="comment">        address of the loader data table entry.</span>
00295 <span class="comment"></span>
00296 <span class="comment"></span>
00297 <span class="comment">Return Value:</span>
00298 <span class="comment"></span>
00299 <span class="comment">    Status</span>
00300 <span class="comment"></span>
00301 <span class="comment">--*/</span>
00302 {
00303     PPEB_LDR_DATA Ldr;
00304     PLIST_ENTRY Head, Next;
00305     PLDR_DATA_TABLE_ENTRY Entry;
00306     PIMAGE_NT_HEADERS NtHeaders;
00307     PVOID ImageBase;
00308     PVOID EndOfImage;
00309 
00310     Ldr = NtCurrentPeb()-&gt;Ldr;
00311     <span class="keywordflow">if</span> (Ldr == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00312         <span class="keywordflow">return</span>( STATUS_NO_MORE_ENTRIES );
00313         }
00314 
00315     Head = &amp;Ldr-&gt;InMemoryOrderModuleList;
00316     Next = Head-&gt;Flink;
00317     <span class="keywordflow">while</span> ( Next != Head ) {
00318         Entry = CONTAINING_RECORD( Next, LDR_DATA_TABLE_ENTRY, InMemoryOrderLinks );
00319 
00320         NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>( Entry-&gt;DllBase );
00321         <span class="keywordflow">if</span> (NtHeaders != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00322             ImageBase = (PVOID)Entry-&gt;DllBase;
00323 
00324             EndOfImage = (PVOID)
00325                 ((ULONG_PTR)ImageBase + NtHeaders-&gt;OptionalHeader.SizeOfImage);
00326 
00327             <span class="keywordflow">if</span> ((ULONG_PTR)Address &gt;= (ULONG_PTR)ImageBase &amp;&amp; (ULONG_PTR)Address &lt; (ULONG_PTR)EndOfImage) {
00328                 *TableEntry = Entry;
00329                 <span class="keywordflow">return</span>( STATUS_SUCCESS );
00330                 }
00331             }
00332 
00333         Next = Next-&gt;Flink;
00334         }
00335 
00336     <span class="keywordflow">return</span>( STATUS_NO_MORE_ENTRIES );
00337 }
00338 
00339 
00340 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00341"></a><a class="code" href="../../d1/d3/ldrrsrc_8c.html#a11">00341</a> <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a11">LdrFindResource_U</a>(
00342     IN PVOID DllHandle,
00343     IN PULONG_PTR ResourceIdPath,
00344     IN ULONG ResourceIdPathLength,
00345     OUT PIMAGE_RESOURCE_DATA_ENTRY *ResourceDataEntry
00346     )
00347 
00348 <span class="comment">/*++</span>
00349 <span class="comment"></span>
00350 <span class="comment">Routine Description:</span>
00351 <span class="comment"></span>
00352 <span class="comment">    This function locates the address of the specified resource in the</span>
00353 <span class="comment">    specified DLL and returns its address.</span>
00354 <span class="comment"></span>
00355 <span class="comment">Arguments:</span>
00356 <span class="comment"></span>
00357 <span class="comment">    DllHandle - Supplies a handle to the image file that the resource is</span>
00358 <span class="comment">        contained in.</span>
00359 <span class="comment"></span>
00360 <span class="comment">    ResourceIdPath - Supplies a pointer to an array of 32-bit resource</span>
00361 <span class="comment">        identifiers.  Each identifier is either an integer or a pointer</span>
00362 <span class="comment">        to a STRING structure that specifies a resource name.  The array</span>
00363 <span class="comment">        is used to traverse the directory structure contained in the</span>
00364 <span class="comment">        resource section in the image file specified by the DllHandle</span>
00365 <span class="comment">        parameter.</span>
00366 <span class="comment"></span>
00367 <span class="comment">    ResourceIdPathLength - Supplies the number of elements in the</span>
00368 <span class="comment">        ResourceIdPath array.</span>
00369 <span class="comment"></span>
00370 <span class="comment">    ResourceDataEntry - Supplies a pointer to a variable that will</span>
00371 <span class="comment">        receive the address of the resource data entry in the resource</span>
00372 <span class="comment">        data section of the image file specified by the DllHandle</span>
00373 <span class="comment">        parameter.</span>
00374 <span class="comment"></span>
00375 <span class="comment">Return Value:</span>
00376 <span class="comment"></span>
00377 <span class="comment">    TBD</span>
00378 <span class="comment"></span>
00379 <span class="comment">--*/</span>
00380 
00381 {
00382     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00383 
00384     <span class="keywordflow">return</span> <a class="code" href="../../d5/d9/ntrtlp_8h.html#a34">LdrpSearchResourceSection_U</a>(
00385       DllHandle,
00386       ResourceIdPath,
00387       ResourceIdPathLength,
00388       <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                <span class="comment">// Look for a leaf node</span>
00389       <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00390       (PVOID *)ResourceDataEntry
00391       );
00392 }
00393 
00394 
00395 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00396"></a><a class="code" href="../../d1/d3/ldrrsrc_8c.html#a12">00396</a> <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a12">LdrFindResourceDirectory_U</a>(
00397     IN PVOID DllHandle,
00398     IN PULONG_PTR ResourceIdPath,
00399     IN ULONG ResourceIdPathLength,
00400     OUT PIMAGE_RESOURCE_DIRECTORY *ResourceDirectory
00401     )
00402 
00403 <span class="comment">/*++</span>
00404 <span class="comment"></span>
00405 <span class="comment">Routine Description:</span>
00406 <span class="comment"></span>
00407 <span class="comment">    This function locates the address of the specified resource directory in</span>
00408 <span class="comment">    specified DLL and returns its address.</span>
00409 <span class="comment"></span>
00410 <span class="comment">Arguments:</span>
00411 <span class="comment"></span>
00412 <span class="comment">    DllHandle - Supplies a handle to the image file that the resource</span>
00413 <span class="comment">        directory is contained in.</span>
00414 <span class="comment"></span>
00415 <span class="comment">    ResourceIdPath - Supplies a pointer to an array of 32-bit resource</span>
00416 <span class="comment">        identifiers.  Each identifier is either an integer or a pointer</span>
00417 <span class="comment">        to a STRING structure that specifies a resource name.  The array</span>
00418 <span class="comment">        is used to traverse the directory structure contained in the</span>
00419 <span class="comment">        resource section in the image file specified by the DllHandle</span>
00420 <span class="comment">        parameter.</span>
00421 <span class="comment"></span>
00422 <span class="comment">    ResourceIdPathLength - Supplies the number of elements in the</span>
00423 <span class="comment">        ResourceIdPath array.</span>
00424 <span class="comment"></span>
00425 <span class="comment">    ResourceDirectory - Supplies a pointer to a variable that will</span>
00426 <span class="comment">        receive the address of the resource directory specified by</span>
00427 <span class="comment">        ResourceIdPath in the resource data section of the image file</span>
00428 <span class="comment">        the DllHandle parameter.</span>
00429 <span class="comment"></span>
00430 <span class="comment">Return Value:</span>
00431 <span class="comment"></span>
00432 <span class="comment">    TBD</span>
00433 <span class="comment"></span>
00434 <span class="comment">--*/</span>
00435 
00436 {
00437     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00438 
00439     <span class="keywordflow">return</span> <a class="code" href="../../d5/d9/ntrtlp_8h.html#a34">LdrpSearchResourceSection_U</a>(
00440       DllHandle,
00441       ResourceIdPath,
00442       ResourceIdPathLength,
00443       <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,                 <span class="comment">// Look for a directory node</span>
00444       <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00445       (PVOID *)ResourceDirectory
00446       );
00447 }
00448 
00449 
00450 LONG
<a name="l00451"></a><a class="code" href="../../d5/d9/ntrtlp_8h.html#a33">00451</a> <a class="code" href="../../d5/d9/ntrtlp_8h.html#a33">LdrpCompareResourceNames_U</a>(
00452     IN ULONG_PTR ResourceName,
00453     IN PIMAGE_RESOURCE_DIRECTORY ResourceDirectory,
00454     IN PIMAGE_RESOURCE_DIRECTORY_ENTRY ResourceDirectoryEntry
00455     )
00456 {
00457     LONG li;
00458     PIMAGE_RESOURCE_DIR_STRING_U ResourceNameString;
00459 
00460     <span class="keywordflow">if</span> (ResourceName &amp; LDR_RESOURCE_ID_NAME_MASK) {
00461         <span class="keywordflow">if</span> (!ResourceDirectoryEntry-&gt;NameIsString) {
00462             <span class="keywordflow">return</span>( -1 );
00463             }
00464 
00465         ResourceNameString = (PIMAGE_RESOURCE_DIR_STRING_U)
00466             ((PCHAR)ResourceDirectory + ResourceDirectoryEntry-&gt;NameOffset);
00467 
00468         li = wcsncmp( (LPWSTR)ResourceName,
00469             ResourceNameString-&gt;NameString,
00470             ResourceNameString-&gt;Length
00471           );
00472 
00473         <span class="keywordflow">if</span> (!li &amp;&amp; wcslen((PWSTR)ResourceName) != ResourceNameString-&gt;Length) {
00474        <span class="keywordflow">return</span>( 1 );
00475        }
00476 
00477    <span class="keywordflow">return</span>(li);
00478         }
00479     <span class="keywordflow">else</span> {
00480         <span class="keywordflow">if</span> (ResourceDirectoryEntry-&gt;NameIsString) {
00481             <span class="keywordflow">return</span>( 1 );
00482             }
00483 
00484         <span class="keywordflow">return</span>( (ULONG)(ResourceName - ResourceDirectoryEntry-&gt;Name) );
00485         }
00486 }
00487 
00488 
<a name="l00489"></a><a class="code" href="../../d1/d3/ldrrsrc_8c.html#a2">00489</a> <span class="preprocessor">#define  USE_FIRSTAVAILABLE_LANGID   (0xFFFFFFFF &amp; ~LDR_RESOURCE_ID_NAME_MASK)</span>
00490 <span class="preprocessor"></span>
00491 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00492"></a><a class="code" href="../../d5/d9/ntrtlp_8h.html#a34">00492</a> <a class="code" href="../../d5/d9/ntrtlp_8h.html#a34">LdrpSearchResourceSection_U</a>(
00493     IN PVOID DllHandle,
00494     IN PULONG_PTR ResourceIdPath,
00495     IN ULONG ResourceIdPathLength,
00496     IN BOOLEAN FindDirectoryEntry,
00497     IN BOOLEAN ExactLangMatchOnly,
00498     OUT PVOID *ResourceDirectoryOrData
00499     )
00500 
00501 <span class="comment">/*++</span>
00502 <span class="comment"></span>
00503 <span class="comment">Routine Description:</span>
00504 <span class="comment"></span>
00505 <span class="comment">    This function locates the address of the specified resource in the</span>
00506 <span class="comment">    specified DLL and returns its address.</span>
00507 <span class="comment"></span>
00508 <span class="comment">Arguments:</span>
00509 <span class="comment"></span>
00510 <span class="comment">    DllHandle - Supplies a handle to the image file that the resource is</span>
00511 <span class="comment">        contained in.</span>
00512 <span class="comment"></span>
00513 <span class="comment">    ResourceIdPath - Supplies a pointer to an array of 32-bit resource</span>
00514 <span class="comment">        identifiers.  Each identifier is either an integer or a pointer</span>
00515 <span class="comment">        to a null terminated string (PSZ) that specifies a resource</span>
00516 <span class="comment">        name.  The array is used to traverse the directory structure</span>
00517 <span class="comment">        contained in the resource section in the image file specified by</span>
00518 <span class="comment">        the DllHandle parameter.</span>
00519 <span class="comment"></span>
00520 <span class="comment">    ResourceIdPathLength - Supplies the number of elements in the</span>
00521 <span class="comment">        ResourceIdPath array.</span>
00522 <span class="comment"></span>
00523 <span class="comment">    FindDirectoryEntry - Supplies a boolean that is TRUE if caller is</span>
00524 <span class="comment">        searching for a resource directory, otherwise the caller is</span>
00525 <span class="comment">        searching for a resource data entry.</span>
00526 <span class="comment"></span>
00527 <span class="comment">    ExactLangMatchOnly - Supplies a boolean that is TRUE if caller is</span>
00528 <span class="comment">        searching for a resource with, and only with, the language id</span>
00529 <span class="comment">        specified in ResourceIdPath, otherwise the caller wants the routine</span>
00530 <span class="comment">        to come up with default when specified langid is not found.</span>
00531 <span class="comment"></span>
00532 <span class="comment">    ResourceDirectoryOrData - Supplies a pointer to a variable that will</span>
00533 <span class="comment">        receive the address of the resource directory or data entry in</span>
00534 <span class="comment">        the resource data section of the image file specified by the</span>
00535 <span class="comment">        DllHandle parameter.</span>
00536 <span class="comment"></span>
00537 <span class="comment">Return Value:</span>
00538 <span class="comment"></span>
00539 <span class="comment">    TBD</span>
00540 <span class="comment"></span>
00541 <span class="comment">--*/</span>
00542 
00543 {
00544     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00545     PIMAGE_RESOURCE_DIRECTORY LanguageResourceDirectory, ResourceDirectory, TopResourceDirectory;
00546     PIMAGE_RESOURCE_DIRECTORY_ENTRY ResourceDirEntLow;
00547     PIMAGE_RESOURCE_DIRECTORY_ENTRY ResourceDirEntMiddle;
00548     PIMAGE_RESOURCE_DIRECTORY_ENTRY ResourceDirEntHigh;
00549     PIMAGE_RESOURCE_DATA_ENTRY ResourceEntry;
00550     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>, half;
00551     LONG <a class="code" href="../../d7/d4/conexts_8c.html#a29">dir</a>;
00552     ULONG size;
00553     ULONG_PTR ResourceIdRetry;
00554     ULONG RetryCount;
00555     LANGID NewLangId;
00556     PULONG_PTR IdPath = ResourceIdPath;
00557     ULONG IdPathLength = ResourceIdPathLength;
00558     BOOLEAN fIsNeutral = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00559     LANGID GivenLanguage;
00560 <span class="preprocessor">#ifndef NTOS_KERNEL_RUNTIME</span>
00561 <span class="preprocessor"></span>    LCID DefaultThreadLocale, DefaultSystemLocale;
00562     PVOID AltResourceDllHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00563     ULONG_PTR UIResourceIdPath[3];
00564 <span class="preprocessor">#endif</span>
00565 <span class="preprocessor"></span>
00566     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00567 
00568     <span class="keywordflow">try</span> {
00569         TopResourceDirectory = (PIMAGE_RESOURCE_DIRECTORY)
00570             <a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(DllHandle,
00571                                          <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00572                                          IMAGE_DIRECTORY_ENTRY_RESOURCE,
00573                                          &amp;size
00574                                          );
00575         <span class="keywordflow">if</span> (!TopResourceDirectory) {
00576             <span class="keywordflow">return</span>( STATUS_RESOURCE_DATA_NOT_FOUND );
00577             }
00578 
00579         ResourceDirectory = TopResourceDirectory;
00580         ResourceIdRetry = <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a2">USE_FIRSTAVAILABLE_LANGID</a>;
00581         RetryCount = 0;
00582         ResourceEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00583         LanguageResourceDirectory = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00584         <span class="keywordflow">while</span> (ResourceDirectory != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; ResourceIdPathLength--) {
00585             <span class="comment">//</span>
00586             <span class="comment">// If search path includes a language id, then attempt to</span>
00587             <span class="comment">// match the following language ids in this order:</span>
00588             <span class="comment">//</span>
00589             <span class="comment">//   (0)  use given language id</span>
00590             <span class="comment">//   (1)  use primary language of given language id</span>
00591             <span class="comment">//   (2)  use id 0  (neutral resource)</span>
00592             <span class="comment">//   (3)  use default UI language id</span>
00593             <span class="comment">//</span>
00594             <span class="comment">// If the PRIMARY language id is ZERO, then ALSO attempt to</span>
00595             <span class="comment">// match the following language ids in this order:</span>
00596             <span class="comment">//</span>
00597             <span class="comment">//   (4)  use lang id of TEB if different from user locale</span>
00598             <span class="comment">//   (5)  use UI lang from exe resource</span>
00599             <span class="comment">//   (6)  use primary UI lang from exe resource</span>
00600             <span class="comment">//   (7)  use Install Language</span>
00601             <span class="comment">//   (8)  use lang id from user's locale id</span>
00602             <span class="comment">//   (9)  use primary language of user's locale id</span>
00603             <span class="comment">//   (10) use lang id from system default locale id</span>
00604             <span class="comment">//   (11) use primary language of system default locale id</span>
00605             <span class="comment">//   (12) use US English lang id</span>
00606             <span class="comment">//   (13) use any lang id that matches requested info</span>
00607             <span class="comment">//</span>
00608             <span class="keywordflow">if</span> (ResourceIdPathLength == 0 &amp;&amp; IdPathLength == 3) {
00609                 LanguageResourceDirectory = ResourceDirectory;
00610                 }
00611 
00612             <span class="keywordflow">if</span> (LanguageResourceDirectory != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00613                 GivenLanguage = (LANGID)IdPath[ 2 ];
00614                 fIsNeutral = (PRIMARYLANGID( GivenLanguage ) == LANG_NEUTRAL);
00615 TryNextLangId:
00616                 <span class="keywordflow">switch</span>( RetryCount++ ) {
00617 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
00618 <span class="preprocessor"></span>                    <span class="keywordflow">case</span> 0:     <span class="comment">// Use given language id</span>
00619                         NewLangId = GivenLanguage;
00620                         <span class="keywordflow">break</span>;
00621 
00622                     <span class="keywordflow">case</span> 1:     <span class="comment">// Use primary language of given language id</span>
00623                         NewLangId = PRIMARYLANGID( GivenLanguage );
00624                         <span class="keywordflow">break</span>;
00625 
00626                     <span class="keywordflow">case</span> 2:     <span class="comment">// Use id 0  (neutral resource)</span>
00627                         NewLangId = 0;
00628                         <span class="keywordflow">break</span>;
00629 
00630                     <span class="keywordflow">case</span> 3:     <span class="comment">// Use user's default UI language</span>
00631                         NewLangId = (LANGID)ResourceIdRetry;
00632                         <span class="keywordflow">break</span>;
00633 
00634                     <span class="keywordflow">case</span> 4:     <span class="comment">// Use native UI language</span>
00635                         <span class="keywordflow">if</span> ( !fIsNeutral ) {
00636                             <span class="comment">// Stop looking - Not in the neutral case</span>
00637                             <span class="keywordflow">goto</span> ReturnFailure;
00638                             <span class="keywordflow">break</span>;
00639                         }
00640                         NewLangId = <a class="code" href="../../d1/d9/ps_8h.html#a61">PsInstallUILanguageId</a>;
00641                         <span class="keywordflow">break</span>;
00642 
00643                     <span class="keywordflow">case</span> 5:     <span class="comment">// Use default system locale</span>
00644                         NewLangId = LANGIDFROMLCID(<a class="code" href="../../d1/d9/ps_8h.html#a58">PsDefaultSystemLocaleId</a>);
00645                         <span class="keywordflow">break</span>;
00646 
00647                     <span class="keywordflow">case</span> 6:
00648                         <span class="comment">// Use US English language</span>
00649                         NewLangId = MAKELANGID( LANG_ENGLISH, SUBLANG_ENGLISH_US );
00650                         <span class="keywordflow">break</span>;
00651 
00652                     <span class="keywordflow">case</span> 7:     <span class="comment">// Take any lang id that matches</span>
00653                         NewLangId = <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a2">USE_FIRSTAVAILABLE_LANGID</a>;
00654                         <span class="keywordflow">break</span>;
00655 
00656 <span class="preprocessor">#else</span>
00657 <span class="preprocessor"></span>                    <span class="keywordflow">case</span> 0:     <span class="comment">// Use given language id</span>
00658                         NewLangId = GivenLanguage;
00659                         <span class="keywordflow">break</span>;
00660 
00661                     <span class="keywordflow">case</span> 1:     <span class="comment">// Use primary language of given language id</span>
00662                         <span class="keywordflow">if</span> ( ExactLangMatchOnly) {
00663                             <span class="comment">//</span>
00664                             <span class="comment">//  Did not find an exact language match.</span>
00665                             <span class="comment">//  Stop looking.</span>
00666                             <span class="comment">//</span>
00667                             <span class="keywordflow">goto</span> ReturnFailure;
00668                         }
00669                         NewLangId = PRIMARYLANGID( GivenLanguage );
00670                         <span class="keywordflow">break</span>;
00671 
00672                     <span class="keywordflow">case</span> 2:     <span class="comment">// Use id 0  (neutral resource)</span>
00673                         NewLangId = 0;
00674                         <span class="keywordflow">break</span>;
00675 
00676                     <span class="keywordflow">case</span> 3:     <span class="comment">// Use user's default UI language</span>
00677 
00678                         <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a6">UILangId</a>){
00679                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a47">NtQueryDefaultUILanguage</a>( &amp;<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a6">UILangId</a> );
00680                             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00681                                 <span class="comment">//</span>
00682                                 <span class="comment">// Failed reading key.  Skip this lookup.</span>
00683                                 <span class="comment">//</span>
00684                                 NewLangId = (LANGID)ResourceIdRetry;
00685                                 <span class="keywordflow">break</span>;
00686                             }
00687                         }
00688                         NewLangId = <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a6">UILangId</a>;
00689                         <span class="comment">//</span>
00690                         <span class="comment">// Arabic/Hebrew MUI files may contain resources with LANG ID different than 401/40d.</span>
00691                         <span class="comment">// e.g. Comdlg32.dll has two sets of Arabic/Hebrew resources one mirrored (401/40d)</span>
00692                         <span class="comment">// and one flipped (801/80d).</span>
00693                         <span class="comment">//</span>
00694                         <span class="keywordflow">if</span>( !fIsNeutral &amp;&amp;
00695                             ((PRIMARYLANGID (GivenLanguage) == LANG_ARABIC) || (PRIMARYLANGID (GivenLanguage) == LANG_HEBREW)) &amp;&amp;
00696                             (PRIMARYLANGID (GivenLanguage) == PRIMARYLANGID (NewLangId))
00697                           ) {
00698                             NewLangId = GivenLanguage;
00699                         }
00700 
00701                         <span class="keywordflow">if</span> (fIsNeutral || GivenLanguage == NewLangId){
00702                             <span class="comment">//</span>
00703                             <span class="comment">//  Load alternate resource dll.</span>
00704                             <span class="comment">//</span>
00705                             AltResourceDllHandle=<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a21">LdrLoadAlternateResourceModule</a>(
00706                                                     DllHandle,
00707                                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00708 
00709                             <span class="keywordflow">if</span> (!AltResourceDllHandle){
00710                                 <span class="comment">//</span>
00711                                 <span class="comment">//  Alternate resource dll not available.</span>
00712                                 <span class="comment">//  Skip this lookup.</span>
00713                                 <span class="comment">//</span>
00714                                 NewLangId = (LANGID)ResourceIdRetry;
00715                                 <span class="keywordflow">break</span>;
00716 
00717                             }
00718 
00719                             <span class="comment">//</span>
00720                             <span class="comment">//  Map to alternate resource dll and search</span>
00721                             <span class="comment">//  it instead.</span>
00722                             <span class="comment">//</span>
00723 
00724                             UIResourceIdPath[0]=IdPath[0];
00725                             UIResourceIdPath[1]=IdPath[1];
00726                             UIResourceIdPath[2]=NewLangId;
00727 
00728                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a34">LdrpSearchResourceSection_U</a>(
00729                                         AltResourceDllHandle,
00730                                         UIResourceIdPath,
00731                                         3,
00732                                         FindDirectoryEntry,
00733                                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00734                                         (PVOID *)ResourceDirectoryOrData
00735                                         );
00736 
00737                             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)){
00738                                 <span class="comment">//</span>
00739                                 <span class="comment">// We sucessfully found alternate resource,</span>
00740                                 <span class="comment">// return it.</span>
00741                                 <span class="comment">//</span>
00742                                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00743                             }
00744 
00745 
00746                         }
00747                         <span class="comment">//</span>
00748                         <span class="comment">//  Caller does not want alternate resource, or</span>
00749                         <span class="comment">//  alternate resource not found.</span>
00750                         <span class="comment">//</span>
00751                         NewLangId = (LANGID)ResourceIdRetry;
00752                         <span class="keywordflow">break</span>;
00753 
00754 
00755                     <span class="keywordflow">case</span> 4:     <span class="comment">// Use langid of ThreadLocale if different from user locale</span>
00756                         <span class="keywordflow">if</span> ( !fIsNeutral ) {
00757                             <span class="comment">// Stop looking - Not in the neutral case</span>
00758                             <span class="keywordflow">goto</span> ReturnFailure;
00759                             <span class="keywordflow">break</span>;
00760                         }
00761 
00762                         <span class="comment">//</span>
00763                         <span class="comment">// Try the thread locale language-id if it is different from</span>
00764                         <span class="comment">// user locale.</span>
00765                         <span class="comment">//</span>
00766                         <span class="keywordflow">if</span> (NtCurrentTeb()){
00767                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a44">NtQueryDefaultLocale</a>(
00768                                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00769                                         &amp;DefaultThreadLocale
00770                                         );
00771                             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) &amp;&amp;
00772                                 DefaultThreadLocale !=
00773                                 NtCurrentTeb()-&gt;CurrentLocale) {
00774                                 <span class="comment">//</span>
00775                                 <span class="comment">// Thread locale is different from</span>
00776                                 <span class="comment">// default locale.</span>
00777                                 <span class="comment">//</span>
00778                                 NewLangId = LANGIDFROMLCID(NtCurrentTeb()-&gt;CurrentLocale);
00779                                 <span class="keywordflow">break</span>;
00780                             }
00781                         }
00782 
00783                         NewLangId = (LANGID)ResourceIdRetry;
00784                         <span class="keywordflow">break</span>;
00785 
00786 
00787                     <span class="keywordflow">case</span> 5:   <span class="comment">// UI language from the executable resource</span>
00788 
00789                         <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a6">UILangId</a>){
00790                             NewLangId = (LANGID)ResourceIdRetry;
00791                         } <span class="keywordflow">else</span> {
00792                             NewLangId = <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a6">UILangId</a>;
00793                         }
00794                         <span class="keywordflow">break</span>;
00795 
00796                     <span class="keywordflow">case</span> 6:   <span class="comment">// Parimary lang of UI language from the executable resource</span>
00797 
00798                         <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a6">UILangId</a>){
00799                             NewLangId = (LANGID)ResourceIdRetry;
00800                         } <span class="keywordflow">else</span> {
00801                             NewLangId = PRIMARYLANGID( (LANGID) <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a6">UILangId</a> );
00802                         }
00803                         <span class="keywordflow">break</span>;
00804 
00805                     <span class="keywordflow">case</span> 7:   <span class="comment">// Use install -native- language</span>
00806                         <span class="comment">//</span>
00807                         <span class="comment">// Thread locale is the same as the user locale, then let's</span>
00808                         <span class="comment">// try loading the native (install) ui language resources.</span>
00809                         <span class="comment">//</span>
00810                         <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a7">InstallLangId</a>){
00811                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a46">NtQueryInstallUILanguage</a>(&amp;<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a7">InstallLangId</a>);
00812                             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00813                                 <span class="comment">//</span>
00814                                 <span class="comment">// Failed reading key.  Skip this lookup.</span>
00815                                 <span class="comment">//</span>
00816                                 NewLangId = (LANGID)ResourceIdRetry;
00817                                 <span class="keywordflow">break</span>;
00818 
00819                             }
00820                         }
00821 
00822                         NewLangId = <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a7">InstallLangId</a>;
00823                         <span class="keywordflow">break</span>;
00824 
00825                     <span class="keywordflow">case</span> 8:     <span class="comment">// Use lang id from locale in TEB</span>
00826                         <span class="keywordflow">if</span> (SUBLANGID( GivenLanguage ) == SUBLANG_SYS_DEFAULT) {
00827                             <span class="comment">// Skip over all USER locale options</span>
00828                             DefaultThreadLocale = 0;
00829                             RetryCount += 2;
00830                             <span class="keywordflow">break</span>;
00831                         }
00832 
00833                         <span class="keywordflow">if</span> (NtCurrentTeb() != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00834                             NewLangId = LANGIDFROMLCID(NtCurrentTeb()-&gt;CurrentLocale);
00835                         }
00836                         <span class="keywordflow">break</span>;
00837 
00838                     <span class="keywordflow">case</span> 9:     <span class="comment">// Use User's default locale</span>
00839                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a44">NtQueryDefaultLocale</a>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, &amp;DefaultThreadLocale );
00840                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00841                             NewLangId = LANGIDFROMLCID(DefaultThreadLocale);
00842                             <span class="keywordflow">break</span>;
00843                             }
00844 
00845                         RetryCount++;
00846                         <span class="keywordflow">break</span>;
00847 
00848                     <span class="keywordflow">case</span> 10:     <span class="comment">// Use primary language of User's default locale</span>
00849                         NewLangId = PRIMARYLANGID( (LANGID)ResourceIdRetry );
00850                         <span class="keywordflow">break</span>;
00851 
00852                     <span class="keywordflow">case</span> 11:     <span class="comment">// Use System default locale</span>
00853                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a44">NtQueryDefaultLocale</a>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;DefaultSystemLocale );
00854                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00855                             RetryCount++;
00856                             <span class="keywordflow">break</span>;
00857                         }
00858                         <span class="keywordflow">if</span> (DefaultSystemLocale != DefaultThreadLocale) {
00859                             NewLangId = LANGIDFROMLCID(DefaultSystemLocale);
00860                             <span class="keywordflow">break</span>;
00861                         }
00862 
00863                         RetryCount += 2;
00864                         <span class="comment">// fall through</span>
00865 
00866                     <span class="keywordflow">case</span> 13:     <span class="comment">// Use US English language</span>
00867                         NewLangId = MAKELANGID( LANG_ENGLISH, SUBLANG_ENGLISH_US );
00868                         <span class="keywordflow">break</span>;
00869 
00870                     <span class="keywordflow">case</span> 12:     <span class="comment">// Use primary language of System default locale</span>
00871                         NewLangId = PRIMARYLANGID( (LANGID)ResourceIdRetry );
00872                         <span class="keywordflow">break</span>;
00873 
00874                     <span class="keywordflow">case</span> 14:     <span class="comment">// Take any lang id that matches</span>
00875                         NewLangId = <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a2">USE_FIRSTAVAILABLE_LANGID</a>;
00876                         <span class="keywordflow">break</span>;
00877 <span class="preprocessor">#endif</span>
00878 <span class="preprocessor"></span>                    <span class="keywordflow">default</span>:    <span class="comment">// No lang ids to match</span>
00879                         <span class="keywordflow">goto</span> ReturnFailure;
00880                         <span class="keywordflow">break</span>;
00881                 }
00882 
00883                 <span class="comment">//</span>
00884                 <span class="comment">// If looking for a specific language id and same as the</span>
00885                 <span class="comment">// one we just looked up, then skip it.</span>
00886                 <span class="comment">//</span>
00887                 <span class="keywordflow">if</span> (NewLangId != <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a2">USE_FIRSTAVAILABLE_LANGID</a> &amp;&amp;
00888                     NewLangId == ResourceIdRetry
00889                    ) {
00890                     <span class="keywordflow">goto</span> TryNextLangId;
00891                     }
00892 
00893                 <span class="comment">//</span>
00894                 <span class="comment">// Try this new language Id</span>
00895                 <span class="comment">//</span>
00896                 ResourceIdRetry = (ULONG_PTR)NewLangId;
00897                 ResourceIdPath = &amp;ResourceIdRetry;
00898                 ResourceDirectory = LanguageResourceDirectory;
00899                 }
00900 
00901             <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = ResourceDirectory-&gt;NumberOfNamedEntries;
00902             ResourceDirEntLow = (PIMAGE_RESOURCE_DIRECTORY_ENTRY)(ResourceDirectory+1);
00903             <span class="keywordflow">if</span> (!(*ResourceIdPath &amp; LDR_RESOURCE_ID_NAME_MASK)) {
00904                 ResourceDirEntLow += <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
00905                 <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = ResourceDirectory-&gt;NumberOfIdEntries;
00906                 }
00907 
00908             <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>) {
00909                 ResourceDirectory = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00910                 <span class="keywordflow">goto</span> NotFound;
00911                 }
00912 
00913             <span class="keywordflow">if</span> (LanguageResourceDirectory != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00914                 *ResourceIdPath == <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a2">USE_FIRSTAVAILABLE_LANGID</a>
00915                ) {
00916                 ResourceDirectory = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00917                 ResourceIdRetry = ResourceDirEntLow-&gt;Name;
00918                 ResourceEntry = (PIMAGE_RESOURCE_DATA_ENTRY)
00919                     ((PCHAR)TopResourceDirectory +
00920                             ResourceDirEntLow-&gt;OffsetToData
00921                     );
00922 
00923                 <span class="keywordflow">break</span>;
00924                 }
00925 
00926             ResourceDirectory = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00927             ResourceDirEntHigh = ResourceDirEntLow + <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> - 1;
00928             <span class="keywordflow">while</span> (ResourceDirEntLow &lt;= ResourceDirEntHigh) {
00929                 <span class="keywordflow">if</span> ((half = (<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> &gt;&gt; 1)) != 0) {
00930                     ResourceDirEntMiddle = ResourceDirEntLow;
00931                     <span class="keywordflow">if</span> (*(PUCHAR)&amp;<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> &amp; 1) {
00932                         ResourceDirEntMiddle += half;
00933                         }
00934                     <span class="keywordflow">else</span> {
00935                         ResourceDirEntMiddle += half - 1;
00936                         }
00937                     <a class="code" href="../../d7/d4/conexts_8c.html#a29">dir</a> = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a33">LdrpCompareResourceNames_U</a>( *ResourceIdPath,
00938                                                       TopResourceDirectory,
00939                                                       ResourceDirEntMiddle
00940                                                     );
00941                     <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d4/conexts_8c.html#a29">dir</a>) {
00942                         <span class="keywordflow">if</span> (ResourceDirEntMiddle-&gt;DataIsDirectory) {
00943                             ResourceDirectory = (PIMAGE_RESOURCE_DIRECTORY)
00944                     ((PCHAR)TopResourceDirectory +
00945                                     ResourceDirEntMiddle-&gt;OffsetToDirectory
00946                                 );
00947                             }
00948                         <span class="keywordflow">else</span> {
00949                             ResourceDirectory = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00950                             ResourceEntry = (PIMAGE_RESOURCE_DATA_ENTRY)
00951                                 ((PCHAR)TopResourceDirectory +
00952                   ResourceDirEntMiddle-&gt;OffsetToData
00953                                 );
00954                             }
00955 
00956                         <span class="keywordflow">break</span>;
00957                         }
00958                     <span class="keywordflow">else</span> {
00959                         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/conexts_8c.html#a29">dir</a> &lt; 0) {
00960                             ResourceDirEntHigh = ResourceDirEntMiddle - 1;
00961                             <span class="keywordflow">if</span> (*(PUCHAR)&amp;<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> &amp; 1) {
00962                                 <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = half;
00963                                 }
00964                             <span class="keywordflow">else</span> {
00965                                 <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = half - 1;
00966                                 }
00967                             }
00968                         <span class="keywordflow">else</span> {
00969                             ResourceDirEntLow = ResourceDirEntMiddle + 1;
00970                             <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = half;
00971                             }
00972                         }
00973                     }
00974                 <span class="keywordflow">else</span> {
00975                     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> != 0) {
00976                         <a class="code" href="../../d7/d4/conexts_8c.html#a29">dir</a> = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a33">LdrpCompareResourceNames_U</a>( *ResourceIdPath,
00977                           TopResourceDirectory,
00978                                                           ResourceDirEntLow
00979                                                         );
00980                         <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d4/conexts_8c.html#a29">dir</a>) {
00981                             <span class="keywordflow">if</span> (ResourceDirEntLow-&gt;DataIsDirectory) {
00982                                 ResourceDirectory = (PIMAGE_RESOURCE_DIRECTORY)
00983                                     ((PCHAR)TopResourceDirectory +
00984                                         ResourceDirEntLow-&gt;OffsetToDirectory
00985                                     );
00986                                 }
00987                             <span class="keywordflow">else</span> {
00988                                 ResourceEntry = (PIMAGE_RESOURCE_DATA_ENTRY)
00989                                     ((PCHAR)TopResourceDirectory +
00990                       ResourceDirEntLow-&gt;OffsetToData
00991                                     );
00992                                 }
00993                             }
00994                         }
00995 
00996                     <span class="keywordflow">break</span>;
00997                     }
00998                 }
00999 
01000             ResourceIdPath++;
01001             }
01002 
01003         <span class="keywordflow">if</span> (ResourceEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; !FindDirectoryEntry) {
01004             *ResourceDirectoryOrData = (PVOID)ResourceEntry;
01005             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01006             }
01007         <span class="keywordflow">else</span>
01008         <span class="keywordflow">if</span> (ResourceDirectory != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; FindDirectoryEntry) {
01009             *ResourceDirectoryOrData = (PVOID)ResourceDirectory;
01010             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01011             }
01012         <span class="keywordflow">else</span> {
01013 NotFound:
01014             <span class="keywordflow">switch</span>( IdPathLength - ResourceIdPathLength) {
01015                 <span class="keywordflow">case</span> 3:     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_RESOURCE_LANG_NOT_FOUND; <span class="keywordflow">break</span>;
01016                 <span class="keywordflow">case</span> 2:     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_RESOURCE_NAME_NOT_FOUND; <span class="keywordflow">break</span>;
01017                 <span class="keywordflow">case</span> 1:     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_RESOURCE_TYPE_NOT_FOUND; <span class="keywordflow">break</span>;
01018                 <span class="keywordflow">default</span>:    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER; <span class="keywordflow">break</span>;
01019                 }
01020             }
01021 
01022         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_RESOURCE_LANG_NOT_FOUND &amp;&amp;
01023             LanguageResourceDirectory != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01024            ) {
01025             ResourceEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01026             <span class="keywordflow">goto</span> TryNextLangId;
01027 ReturnFailure: ;
01028             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_RESOURCE_LANG_NOT_FOUND;
01029             }
01030         }
01031     except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01032         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01033         }
01034 
01035     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01036 }
01037 
01038 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01039"></a><a class="code" href="../../d1/d3/ldrrsrc_8c.html#a15">01039</a> <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a15">LdrEnumResources</a>(
01040     IN PVOID DllHandle,
01041     IN PULONG_PTR ResourceIdPath,
01042     IN ULONG ResourceIdPathLength,
01043     IN OUT PULONG NumberOfResources,
01044     OUT PLDR_ENUM_RESOURCE_ENTRY Resources OPTIONAL
01045     )
01046 {
01047     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01048     PIMAGE_RESOURCE_DIRECTORY TopResourceDirectory;
01049     PIMAGE_RESOURCE_DIRECTORY TypeResourceDirectory;
01050     PIMAGE_RESOURCE_DIRECTORY NameResourceDirectory;
01051     PIMAGE_RESOURCE_DIRECTORY LangResourceDirectory;
01052     PIMAGE_RESOURCE_DIRECTORY_ENTRY TypeResourceDirectoryEntry;
01053     PIMAGE_RESOURCE_DIRECTORY_ENTRY NameResourceDirectoryEntry;
01054     PIMAGE_RESOURCE_DIRECTORY_ENTRY LangResourceDirectoryEntry;
01055     ULONG TypeDirectoryIndex, NumberOfTypeDirectoryEntries;
01056     ULONG NameDirectoryIndex, NumberOfNameDirectoryEntries;
01057     ULONG LangDirectoryIndex, NumberOfLangDirectoryEntries;
01058     BOOLEAN ScanTypeDirectory;
01059     BOOLEAN ScanNameDirectory;
01060     BOOLEAN ReturnThisResource;
01061     PIMAGE_RESOURCE_DIR_STRING_U ResourceNameString;
01062     ULONG_PTR TypeResourceNameOrId;
01063     ULONG_PTR NameResourceNameOrId;
01064     ULONG_PTR LangResourceNameOrId;
01065     PLDR_ENUM_RESOURCE_ENTRY ResourceInfo;
01066     PIMAGE_RESOURCE_DATA_ENTRY ResourceDataEntry;
01067     ULONG ResourceIndex, MaxResourceIndex;
01068     ULONG <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
01069 
01070     ResourceIndex = 0;
01071     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( Resources )) {
01072         MaxResourceIndex = 0;
01073         }
01074     <span class="keywordflow">else</span> {
01075         MaxResourceIndex = *NumberOfResources;
01076         }
01077     *NumberOfResources = 0;
01078 
01079     TopResourceDirectory = (PIMAGE_RESOURCE_DIRECTORY)
01080         <a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>( DllHandle,
01081                                       <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01082                                       IMAGE_DIRECTORY_ENTRY_RESOURCE,
01083                                       &amp;<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>
01084                                     );
01085     <span class="keywordflow">if</span> (!TopResourceDirectory) {
01086         <span class="keywordflow">return</span> STATUS_RESOURCE_DATA_NOT_FOUND;
01087         }
01088 
01089     TypeResourceDirectory = TopResourceDirectory;
01090     TypeResourceDirectoryEntry = (PIMAGE_RESOURCE_DIRECTORY_ENTRY)(TypeResourceDirectory+1);
01091     NumberOfTypeDirectoryEntries = TypeResourceDirectory-&gt;NumberOfNamedEntries +
01092                                    TypeResourceDirectory-&gt;NumberOfIdEntries;
01093     TypeDirectoryIndex = 0;
01094     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01095     <span class="keywordflow">for</span> (TypeDirectoryIndex=0;
01096          TypeDirectoryIndex&lt;NumberOfTypeDirectoryEntries;
01097          TypeDirectoryIndex++, TypeResourceDirectoryEntry++
01098         ) {
01099         <span class="keywordflow">if</span> (ResourceIdPathLength &gt; 0) {
01100             ScanTypeDirectory = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a33">LdrpCompareResourceNames_U</a>( ResourceIdPath[ 0 ],
01101                                                             TopResourceDirectory,
01102                                                             TypeResourceDirectoryEntry
01103                                                           ) == 0;
01104             }
01105         <span class="keywordflow">else</span> {
01106             ScanTypeDirectory = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01107             }
01108         <span class="keywordflow">if</span> (ScanTypeDirectory) {
01109             <span class="keywordflow">if</span> (!TypeResourceDirectoryEntry-&gt;DataIsDirectory) {
01110                 <span class="keywordflow">return</span> STATUS_INVALID_IMAGE_FORMAT;
01111                 }
01112             <span class="keywordflow">if</span> (TypeResourceDirectoryEntry-&gt;NameIsString) {
01113                 ResourceNameString = (PIMAGE_RESOURCE_DIR_STRING_U)
01114                     ((PCHAR)TopResourceDirectory + TypeResourceDirectoryEntry-&gt;NameOffset);
01115 
01116                 TypeResourceNameOrId = (ULONG_PTR)ResourceNameString;
01117                 }
01118             <span class="keywordflow">else</span> {
01119                 TypeResourceNameOrId = (ULONG_PTR)TypeResourceDirectoryEntry-&gt;Id;
01120                 }
01121 
01122             NameResourceDirectory = (PIMAGE_RESOURCE_DIRECTORY)
01123                 ((PCHAR)TopResourceDirectory + TypeResourceDirectoryEntry-&gt;OffsetToDirectory);
01124             NameResourceDirectoryEntry = (PIMAGE_RESOURCE_DIRECTORY_ENTRY)(NameResourceDirectory+1);
01125             NumberOfNameDirectoryEntries = NameResourceDirectory-&gt;NumberOfNamedEntries +
01126                                            NameResourceDirectory-&gt;NumberOfIdEntries;
01127             NameDirectoryIndex = 0;
01128             <span class="keywordflow">for</span> (NameDirectoryIndex=0;
01129                  NameDirectoryIndex&lt;NumberOfNameDirectoryEntries;
01130                  NameDirectoryIndex++, NameResourceDirectoryEntry++
01131                 ) {
01132                 <span class="keywordflow">if</span> (ResourceIdPathLength &gt; 1) {
01133                     ScanNameDirectory = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a33">LdrpCompareResourceNames_U</a>( ResourceIdPath[ 1 ],
01134                                                                     TopResourceDirectory,
01135                                                                     NameResourceDirectoryEntry
01136                                                                   ) == 0;
01137                     }
01138                 <span class="keywordflow">else</span> {
01139                     ScanNameDirectory = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01140                     }
01141                 <span class="keywordflow">if</span> (ScanNameDirectory) {
01142                     <span class="keywordflow">if</span> (!NameResourceDirectoryEntry-&gt;DataIsDirectory) {
01143                         <span class="keywordflow">return</span> STATUS_INVALID_IMAGE_FORMAT;
01144                         }
01145 
01146                     <span class="keywordflow">if</span> (NameResourceDirectoryEntry-&gt;NameIsString) {
01147                         ResourceNameString = (PIMAGE_RESOURCE_DIR_STRING_U)
01148                             ((PCHAR)TopResourceDirectory + NameResourceDirectoryEntry-&gt;NameOffset);
01149 
01150                         NameResourceNameOrId = (ULONG_PTR)ResourceNameString;
01151                         }
01152                     <span class="keywordflow">else</span> {
01153                         NameResourceNameOrId = (ULONG_PTR)NameResourceDirectoryEntry-&gt;Id;
01154                         }
01155 
01156                     LangResourceDirectory = (PIMAGE_RESOURCE_DIRECTORY)
01157                         ((PCHAR)TopResourceDirectory + NameResourceDirectoryEntry-&gt;OffsetToDirectory);
01158 
01159                     LangResourceDirectoryEntry = (PIMAGE_RESOURCE_DIRECTORY_ENTRY)(LangResourceDirectory+1);
01160                     NumberOfLangDirectoryEntries = LangResourceDirectory-&gt;NumberOfNamedEntries +
01161                                                    LangResourceDirectory-&gt;NumberOfIdEntries;
01162                     LangDirectoryIndex = 0;
01163                     <span class="keywordflow">for</span> (LangDirectoryIndex=0;
01164                          LangDirectoryIndex&lt;NumberOfLangDirectoryEntries;
01165                          LangDirectoryIndex++, LangResourceDirectoryEntry++
01166                         ) {
01167                         <span class="keywordflow">if</span> (ResourceIdPathLength &gt; 2) {
01168                             ReturnThisResource = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a33">LdrpCompareResourceNames_U</a>( ResourceIdPath[ 2 ],
01169                                                                              TopResourceDirectory,
01170                                                                              LangResourceDirectoryEntry
01171                                                                            ) == 0;
01172                             }
01173                         <span class="keywordflow">else</span> {
01174                             ReturnThisResource = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01175                             }
01176                         <span class="keywordflow">if</span> (ReturnThisResource) {
01177                             <span class="keywordflow">if</span> (LangResourceDirectoryEntry-&gt;DataIsDirectory) {
01178                                 <span class="keywordflow">return</span> STATUS_INVALID_IMAGE_FORMAT;
01179                                 }
01180 
01181                             <span class="keywordflow">if</span> (LangResourceDirectoryEntry-&gt;NameIsString) {
01182                                 ResourceNameString = (PIMAGE_RESOURCE_DIR_STRING_U)
01183                                     ((PCHAR)TopResourceDirectory + LangResourceDirectoryEntry-&gt;NameOffset);
01184 
01185                                 LangResourceNameOrId = (ULONG_PTR)ResourceNameString;
01186                                 }
01187                             <span class="keywordflow">else</span> {
01188                                 LangResourceNameOrId = (ULONG_PTR)LangResourceDirectoryEntry-&gt;Id;
01189                                 }
01190 
01191                             ResourceDataEntry = (PIMAGE_RESOURCE_DATA_ENTRY)
01192                                     ((PCHAR)TopResourceDirectory + LangResourceDirectoryEntry-&gt;OffsetToData);
01193 
01194                             ResourceInfo = &amp;Resources[ ResourceIndex++ ];
01195                             <span class="keywordflow">if</span> (ResourceIndex &lt;= MaxResourceIndex) {
01196                                 ResourceInfo-&gt;Path[ 0 ].NameOrId = TypeResourceNameOrId;
01197                                 ResourceInfo-&gt;Path[ 1 ].NameOrId = NameResourceNameOrId;
01198                                 ResourceInfo-&gt;Path[ 2 ].NameOrId = LangResourceNameOrId;
01199                                 ResourceInfo-&gt;Data = (PVOID)((ULONG_PTR)DllHandle + ResourceDataEntry-&gt;OffsetToData);
01200                                 ResourceInfo-&gt;Size = ResourceDataEntry-&gt;Size;
01201                                 ResourceInfo-&gt;Reserved = 0;
01202                                 }
01203                             <span class="keywordflow">else</span> {
01204                                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INFO_LENGTH_MISMATCH;
01205                                 }
01206                             }
01207                         }
01208                     }
01209                 }
01210             }
01211         }
01212 
01213     *NumberOfResources = ResourceIndex;
01214     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01215 }
01216 
01217 <span class="preprocessor">#ifndef NTOS_KERNEL_RUNTIME</span>
01218 <span class="preprocessor"></span>
01219 BOOLEAN
<a name="l01220"></a><a class="code" href="../../d1/d3/ldrrsrc_8c.html#a16">01220</a> <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a16">LdrAlternateResourcesEnabled</a>(
01221     VOID
01222     )
01223 
01224 <span class="comment">/*++</span>
01225 <span class="comment"></span>
01226 <span class="comment">Routine Description:</span>
01227 <span class="comment"></span>
01228 <span class="comment">    This function determines if the althernate resources are enabled.</span>
01229 <span class="comment"></span>
01230 <span class="comment">Arguments:</span>
01231 <span class="comment"></span>
01232 <span class="comment">    None.</span>
01233 <span class="comment"></span>
01234 <span class="comment">Return Value:</span>
01235 <span class="comment"></span>
01236 <span class="comment">    True - Alternate Resource enabled.</span>
01237 <span class="comment">    False - Alternate Resource not enabled.</span>
01238 <span class="comment"></span>
01239 <span class="comment">--*/</span>
01240 
01241 {
01242     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01243 
01244     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a6">UILangId</a>){
01245         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a47">NtQueryDefaultUILanguage</a>( &amp;<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a6">UILangId</a> );
01246 
01247         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01248             <span class="comment">//</span>
01249             <span class="comment">//  Failed to get UI LangID.  AltResource not enabled.</span>
01250             <span class="comment">//</span>
01251             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01252             }
01253         }
01254 
01255     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a7">InstallLangId</a>){
01256         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a46">NtQueryInstallUILanguage</a>( &amp;<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a7">InstallLangId</a>);
01257 
01258         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01259             <span class="comment">//</span>
01260             <span class="comment">//  Failed to get Intall LangID.  AltResource not enabled.</span>
01261             <span class="comment">//</span>
01262             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01263             }
01264         }
01265 
01266     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a6">UILangId</a> == <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a7">InstallLangId</a>) {
01267         <span class="comment">//</span>
01268         <span class="comment">//  UI Lang matches Installed Lang. AltResource not enabled.</span>
01269         <span class="comment">//</span>
01270         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01271         }
01272 
01273     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01274 }
01275 
01276 PVOID
<a name="l01277"></a><a class="code" href="../../d1/d3/ldrrsrc_8c.html#a17">01277</a> <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a17">LdrGetAlternateResourceModuleHandle</a>(
01278     IN PVOID Module
01279     )
01280 <span class="comment">/*++</span>
01281 <span class="comment"></span>
01282 <span class="comment">Routine Description:</span>
01283 <span class="comment"></span>
01284 <span class="comment">    This function gets the alternate resource module from the table</span>
01285 <span class="comment">    containing the handle.</span>
01286 <span class="comment"></span>
01287 <span class="comment">Arguments:</span>
01288 <span class="comment"></span>
01289 <span class="comment">    Module - Module of which alternate resource module needs to loaded.</span>
01290 <span class="comment"></span>
01291 <span class="comment">Return Value:</span>
01292 <span class="comment"></span>
01293 <span class="comment">   Handle of the alternate resource module.</span>
01294 <span class="comment"></span>
01295 <span class="comment">--*/</span>
01296 
01297 {
01298     ULONG ModuleIndex;
01299 
01300     <span class="keywordflow">for</span> (ModuleIndex = 0;
01301          ModuleIndex &lt; <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a4">AlternateResourceModuleCount</a>;
01302          ModuleIndex++ ){
01303         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a3">AlternateResourceModules</a>[ModuleIndex].<a class="code" href="../../d8/d6/struct__ALT__RESOURCE__MODULE.html#o0">ModuleBase</a> ==
01304             Module){
01305             <span class="keywordflow">return</span> <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a3">AlternateResourceModules</a>[ModuleIndex].<a class="code" href="../../d8/d6/struct__ALT__RESOURCE__MODULE.html#o1">AlternateModule</a>;
01306         }
01307     }
01308     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01309 }
01310 
01311 BOOLEAN
<a name="l01312"></a><a class="code" href="../../d1/d3/ldrrsrc_8c.html#a18">01312</a> <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a18">LdrpGetFileVersion</a>(
01313     IN  PVOID      ImageBase,
01314     IN  LANGID     LangId,
01315     OUT PULONGLONG Version
01316     )
01317 
01318 <span class="comment">/*++</span>
01319 <span class="comment"></span>
01320 <span class="comment">Routine Description:</span>
01321 <span class="comment"></span>
01322 <span class="comment">    Get the version stamp out of the VS_FIXEDFILEINFO resource in a PE</span>
01323 <span class="comment">    image.</span>
01324 <span class="comment"></span>
01325 <span class="comment">Arguments:</span>
01326 <span class="comment"></span>
01327 <span class="comment">    ImageBase - supplies the address in memory where the file is mapped in.</span>
01328 <span class="comment"></span>
01329 <span class="comment">    Version - receives 64bit version number, or 0 if the file is not</span>
01330 <span class="comment">        a PE image or has no version data.</span>
01331 <span class="comment"></span>
01332 <span class="comment">Return Value:</span>
01333 <span class="comment"></span>
01334 <span class="comment">    None.</span>
01335 <span class="comment"></span>
01336 <span class="comment">--*/</span>
01337 
01338 {
01339     PIMAGE_RESOURCE_DATA_ENTRY DataEntry;
01340     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01341     ULONG_PTR IdPath[3];
01342     ULONG ResourceSize;
01343 
01344 
01345 <span class="keyword">typedef</span> <span class="keyword">struct </span>tagVS_FIXEDFILEINFO
01346 {
01347     LONG   dwSignature;            <span class="comment">/* e.g. 0xfeef04bd */</span>
01348     LONG   dwStrucVersion;         <span class="comment">/* e.g. 0x00000042 = "0.42" */</span>
01349     LONG   dwFileVersionMS;        <span class="comment">/* e.g. 0x00030075 = "3.75" */</span>
01350     LONG   dwFileVersionLS;        <span class="comment">/* e.g. 0x00000031 = "0.31" */</span>
01351     LONG   dwProductVersionMS;     <span class="comment">/* e.g. 0x00030010 = "3.10" */</span>
01352     LONG   dwProductVersionLS;     <span class="comment">/* e.g. 0x00000031 = "0.31" */</span>
01353     LONG   dwFileFlagsMask;        <span class="comment">/* = 0x3F for version "0.42" */</span>
01354     LONG   dwFileFlags;            <span class="comment">/* e.g. VFF_DEBUG | VFF_PRERELEASE */</span>
01355     LONG   dwFileOS;               <span class="comment">/* e.g. VOS_DOS_WINDOWS16 */</span>
01356     LONG   dwFileType;             <span class="comment">/* e.g. VFT_DRIVER */</span>
01357     LONG   dwFileSubtype;          <span class="comment">/* e.g. VFT2_DRV_KEYBOARD */</span>
01358     LONG   dwFileDateMS;           <span class="comment">/* e.g. 0 */</span>
01359     LONG   dwFileDateLS;           <span class="comment">/* e.g. 0 */</span>
01360 } VS_FIXEDFILEINFO;
01361 
01362     <span class="keyword">struct </span>{
01363         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> TotalSize;
01364         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> DataSize;
01365         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Type;
01366         WCHAR <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>[16];              <span class="comment">// L"VS_VERSION_INFO" + unicode nul</span>
01367         VS_FIXEDFILEINFO FixedFileInfo;
01368     } *<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>;
01369 
01370     *<a class="code" href="../../d2/d5/editreg_8c.html#a50">Version</a> = 0;
01371 
01372 
01373     IdPath[0] = 16;
01374     IdPath[1] = 1;
01375     IdPath[2] = LangId;
01376 
01377     <span class="keywordflow">try</span> {
01378         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a34">LdrpSearchResourceSection_U</a>(
01379                     ImageBase,
01380                     IdPath,
01381                     3,
01382                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01383                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01384                     &amp;DataEntry);
01385     } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01386         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
01387     }
01388 
01389     <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01390         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01391     }
01392 
01393     <span class="keywordflow">try</span> {
01394         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a35">LdrpAccessResourceData</a>(
01395                     ImageBase,
01396                     DataEntry,
01397                     &amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>,
01398                     &amp;ResourceSize);
01399     } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01400         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
01401     }
01402 
01403     <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01404         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01405     }
01406 
01407     <span class="keywordflow">try</span> {
01408         <span class="keywordflow">if</span>((ResourceSize &gt;= <span class="keyword">sizeof</span>(*Resource))
01409             &amp;&amp; !_wcsicmp(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;Name,<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"VS_VERSION_INFO"</span>)) {
01410 
01411             *<a class="code" href="../../d2/d5/editreg_8c.html#a50">Version</a> = ((ULONGLONG)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;FixedFileInfo.dwFileVersionMS &lt;&lt; 32
01412 )
01413                      | (ULONGLONG)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;FixedFileInfo.dwFileVersionLS;
01414 
01415         } <span class="keywordflow">else</span> {
01416             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>((<span class="stringliteral">"LDR: Warning: invalid version resource\n"</span>));
01417             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01418         }
01419     } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01420         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>((<span class="stringliteral">"LDR: Exception encountered processing bogus version resource\n"</span>));
01421         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01422     }
01423     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01424 }
01425 
01426 BOOLEAN
<a name="l01427"></a><a class="code" href="../../d5/d9/ntrtlp_8h.html#a50">01427</a> <a class="code" href="../../d5/d9/ntrtlp_8h.html#a50">LdrpVerifyAlternateResourceModule</a>(
01428     IN PVOID Module,
01429     IN PVOID AlternateModule
01430     )
01431 
01432 <span class="comment">/*++</span>
01433 <span class="comment"></span>
01434 <span class="comment">Routine Description:</span>
01435 <span class="comment"></span>
01436 <span class="comment">    This function verifies if the alternate resource module has the same</span>
01437 <span class="comment">    version of the base module.</span>
01438 <span class="comment"></span>
01439 <span class="comment">Arguments:</span>
01440 <span class="comment"></span>
01441 <span class="comment">    Module - The handle of the base module.</span>
01442 <span class="comment">    AlternateModule - The handle of the alternate resource module</span>
01443 <span class="comment"></span>
01444 <span class="comment">Return Value:</span>
01445 <span class="comment"></span>
01446 <span class="comment">    TBD.</span>
01447 <span class="comment"></span>
01448 <span class="comment">--*/</span>
01449 
01450 {
01451     ULONGLONG ModuleVersion;
01452     ULONGLONG AltModuleVersion;
01453     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01454 
01455     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a6">UILangId</a>){
01456         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a47">NtQueryDefaultUILanguage</a>( &amp;<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a6">UILangId</a>);
01457         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01458             <span class="comment">//</span>
01459             <span class="comment">//  Failed to get UI LangID.  AltResource not enabled.</span>
01460             <span class="comment">//</span>
01461             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01462             }
01463         }
01464 
01465     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a18">LdrpGetFileVersion</a>(AlternateModule, <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a6">UILangId</a>, &amp;AltModuleVersion)){
01466         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01467         }
01468 
01469     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a7">InstallLangId</a>){
01470         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a46">NtQueryInstallUILanguage</a> (&amp;<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a7">InstallLangId</a>);
01471         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01472             <span class="comment">//</span>
01473             <span class="comment">//  Failed to get Install LangID.  AltResource not enabled.</span>
01474             <span class="comment">//</span>
01475             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01476             }
01477         }
01478 
01479     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a18">LdrpGetFileVersion</a>(Module, <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a7">InstallLangId</a>, &amp;ModuleVersion)){
01480         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01481         }
01482 
01483     <span class="keywordflow">if</span> (ModuleVersion == AltModuleVersion){
01484         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01485         }
01486     <span class="keywordflow">else</span>{
01487         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01488         }
01489 }
01490 
01491 BOOLEAN
<a name="l01492"></a><a class="code" href="../../d5/d9/ntrtlp_8h.html#a51">01492</a> <a class="code" href="../../d5/d9/ntrtlp_8h.html#a51">LdrpSetAlternateResourceModuleHandle</a>(
01493     IN PVOID Module,
01494     IN PVOID AlternateModule
01495     )
01496 
01497 <span class="comment">/*++</span>
01498 <span class="comment"></span>
01499 <span class="comment">Routine Description:</span>
01500 <span class="comment"></span>
01501 <span class="comment">    This function records the handle of the base module and alternate</span>
01502 <span class="comment">    resource module in an array.</span>
01503 <span class="comment"></span>
01504 <span class="comment">Arguments:</span>
01505 <span class="comment"></span>
01506 <span class="comment">    Module - The handle of the base module.</span>
01507 <span class="comment">    AlternateModule - The handle of the alternate resource module</span>
01508 <span class="comment"></span>
01509 <span class="comment">Return Value:</span>
01510 <span class="comment"></span>
01511 <span class="comment">    TBD.</span>
01512 <span class="comment"></span>
01513 <span class="comment">--*/</span>
01514 
01515 {
01516     <a class="code" href="../../d8/d6/struct__ALT__RESOURCE__MODULE.html">PALT_RESOURCE_MODULE</a> NewModules;
01517 
01518     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a3">AlternateResourceModules</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>){
01519         <span class="comment">//</span>
01520         <span class="comment">//  Allocate memory of initial size MEMBLOCKSIZE.</span>
01521         <span class="comment">//</span>
01522         NewModules = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(
01523                         RtlProcessHeap(),
01524                         HEAP_ZERO_MEMORY,
01525                         <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a1">RESMODSIZE</a> * <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a0">MEMBLOCKSIZE</a>);
01526         <span class="keywordflow">if</span> (!NewModules){
01527             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01528             }
01529         <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a3">AlternateResourceModules</a> = NewModules;
01530         <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a5">AltResMemBlockCount</a> = <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a0">MEMBLOCKSIZE</a>;
01531         }
01532     <span class="keywordflow">else</span>
01533     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a4">AlternateResourceModuleCount</a> &gt;= <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a5">AltResMemBlockCount</a> ){
01534         <span class="comment">//</span>
01535         <span class="comment">//  ReAllocate another chunk of memory.</span>
01536         <span class="comment">//</span>
01537         NewModules = <a class="code" href="../../d5/d9/heapdll_8c.html#a24">RtlReAllocateHeap</a>(
01538                         RtlProcessHeap(),
01539                         0,
01540                         <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a3">AlternateResourceModules</a>,
01541                         (<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a5">AltResMemBlockCount</a> + <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a0">MEMBLOCKSIZE</a>) * <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a1">RESMODSIZE</a>
01542                         );
01543 
01544         <span class="keywordflow">if</span> (!NewModules){
01545             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01546             }
01547         <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a3">AlternateResourceModules</a> = NewModules;
01548         <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a5">AltResMemBlockCount</a> += <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a0">MEMBLOCKSIZE</a>;
01549         }
01550 
01551     <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a3">AlternateResourceModules</a>[<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a4">AlternateResourceModuleCount</a>].<a class="code" href="../../d8/d6/struct__ALT__RESOURCE__MODULE.html#o0">ModuleBase</a> = Module;
01552     <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a3">AlternateResourceModules</a>[<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a4">AlternateResourceModuleCount</a>].<a class="code" href="../../d8/d6/struct__ALT__RESOURCE__MODULE.html#o1">AlternateModule</a> = AlternateModule;
01553 
01554 
01555 
01556     <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a4">AlternateResourceModuleCount</a>++;
01557 
01558     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01559 
01560 }
01561 
01562 PVOID
<a name="l01563"></a><a class="code" href="../../d1/d3/ldrrsrc_8c.html#a21">01563</a> <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a21">LdrLoadAlternateResourceModule</a>(
01564     IN PVOID Module,
01565     IN LPCWSTR PathToAlternateModule OPTIONAL
01566     )
01567 
01568 <span class="comment">/*++</span>
01569 <span class="comment"></span>
01570 <span class="comment">Routine Description:</span>
01571 <span class="comment"></span>
01572 <span class="comment">    This function does the acutally loading into memory of the alternate</span>
01573 <span class="comment">    resource module, or loads from the table if it was loaded before.</span>
01574 <span class="comment"></span>
01575 <span class="comment">Arguments:</span>
01576 <span class="comment"></span>
01577 <span class="comment">    Module - The handle of the base module.</span>
01578 <span class="comment">    PathToAlternateModule - Optional path from which module is being loaded.</span>
01579 <span class="comment"></span>
01580 <span class="comment">Return Value:</span>
01581 <span class="comment"></span>
01582 <span class="comment">    Handle to the alternate resource module.</span>
01583 <span class="comment"></span>
01584 <span class="comment">--*/</span>
01585 
01586 {
01587     PVOID AlternateModule, DllBase;
01588     PLDR_DATA_TABLE_ENTRY Entry;
01589     HANDLE FileHandle, MappingHandle;
01590     PIMAGE_NT_HEADERS NtHeaders;
01591     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01592     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
01593     UNICODE_STRING AltDllName;
01594     PVOID FreeBuffer;
01595     LPWSTR BaseDllName, p;
01596     WCHAR DllPathName[DOS_MAX_PATH_LENGTH];
01597     ULONG DllPathNameLength, BaseDllNameLength, CopyCount;
01598     ULONG Digit;
01599     <span class="keywordtype">int</span> i, RetryCount;
01600     WCHAR AltModulePath[DOS_MAX_PATH_LENGTH];
01601     WCHAR AltModulePathMUI[DOS_MAX_PATH_LENGTH];
01602     WCHAR AltModulePathFallback[DOS_MAX_PATH_LENGTH];
01603     IO_STATUS_BLOCK IoStatusBlock;
01604     RTL_RELATIVE_NAME <a class="code" href="../../d2/d2/rtload_8c.html#a7">RelativeName</a>;
01605     SIZE_T ViewSize;
01606     LARGE_INTEGER SectionOffset;
01607     WCHAR LangIdDir[6];
01608     UNICODE_STRING AltModulePathList[3];
01609     UNICODE_STRING <a class="code" href="../../d8/d1/init_8h.html#a3">NtSystemRoot</a>;
01610 
01611 
01612     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a16">LdrAlternateResourcesEnabled</a>()) {
01613         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01614         }
01615 
01616     RtlEnterCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;<a class="code" href="../../d8/d2/ldrinit_8c.html#a12">LoaderLock</a>);
01617 
01618     AlternateModule = <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a17">LdrGetAlternateResourceModuleHandle</a>(Module);
01619     <span class="keywordflow">if</span> (AlternateModule == <a class="code" href="../../d5/d9/ntrtlp_8h.html#a15">NO_ALTERNATE_RESOURCE_MODULE</a>){
01620         <span class="comment">//</span>
01621         <span class="comment">//  We tried to load this module before but failed. Don't try</span>
01622         <span class="comment">//  again in the future.</span>
01623         <span class="comment">//</span>
01624         RtlLeaveCriticalSection(
01625             (PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;<a class="code" href="../../d8/d2/ldrinit_8c.html#a12">LoaderLock</a>);
01626         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01627         }
01628     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (AlternateModule &gt; 0){
01629         <span class="comment">//</span>
01630         <span class="comment">//  We found the previously loaded match</span>
01631         <span class="comment">//</span>
01632         RtlLeaveCriticalSection(
01633             (PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;<a class="code" href="../../d8/d2/ldrinit_8c.html#a12">LoaderLock</a>);
01634         <span class="keywordflow">return</span> AlternateModule;
01635         }
01636 
01637     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PathToAlternateModule)){
01638         <span class="comment">//</span>
01639         <span class="comment">//  Caller suplied path.</span>
01640         <span class="comment">//</span>
01641 
01642         CopyCount = wcslen(PathToAlternateModule);
01643 
01644         <span class="keywordflow">for</span> (p = (LPWSTR) PathToAlternateModule + CopyCount;
01645              p &gt; PathToAlternateModule;
01646              p--){
01647             <span class="keywordflow">if</span> (*(p-1) == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>){
01648                 <span class="keywordflow">break</span>;
01649                 }
01650             }
01651 
01652         <span class="keywordflow">if</span> (p == PathToAlternateModule){
01653             <span class="keywordflow">goto</span> error_exit;
01654             }
01655 
01656         DllPathNameLength = (ULONG)(p - PathToAlternateModule) * <span class="keyword">sizeof</span>(WCHAR);
01657 
01658         RtlCopyMemory(
01659             DllPathName,
01660             PathToAlternateModule,
01661             DllPathNameLength
01662             );
01663 
01664         BaseDllName = p ;
01665         BaseDllNameLength = CopyCount * <span class="keyword">sizeof</span>(WCHAR) - DllPathNameLength;
01666 
01667         }
01668     <span class="keywordflow">else</span>{
01669         <span class="comment">//</span>
01670         <span class="comment">//  Try to get full dll path from Ldr data table.</span>
01671         <span class="comment">//</span>
01672         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a10">LdrFindEntryForAddress</a>(Module, &amp;Entry);
01673         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )){
01674             <span class="keywordflow">goto</span> error_exit;
01675             }
01676 
01677         DllPathNameLength = Entry-&gt;FullDllName.Length -
01678                             Entry-&gt;BaseDllName.Length;
01679 
01680         RtlCopyMemory(
01681             DllPathName,
01682             Entry-&gt;FullDllName.Buffer,
01683             DllPathNameLength);
01684 
01685         BaseDllName = Entry-&gt;BaseDllName.Buffer;
01686         BaseDllNameLength = Entry-&gt;BaseDllName.Length;
01687         }
01688 
01689     DllPathName[DllPathNameLength / <span class="keyword">sizeof</span>(WCHAR)] = UNICODE_NULL;
01690 
01691     <span class="comment">//</span>
01692     <span class="comment">//  Generate the langid directory like "0804\"</span>
01693     <span class="comment">//</span>
01694     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a6">UILangId</a>){
01695         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a47">NtQueryDefaultUILanguage</a>( &amp;<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a6">UILangId</a> );
01696         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01697             <span class="keywordflow">goto</span> error_exit;
01698             }
01699         }
01700 
01701     CopyCount = 0;
01702     <span class="keywordflow">for</span> (i = 12; i &gt;= 0; i -= 4){
01703         Digit = ((<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a6">UILangId</a> &gt;&gt; i) &amp; 0xF);
01704         <span class="keywordflow">if</span> (Digit &gt;= 10){
01705             LangIdDir[CopyCount++] = (WCHAR) (Digit - 10 + <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'A'</span>);
01706             }
01707         <span class="keywordflow">else</span>{
01708             LangIdDir[CopyCount++] = (WCHAR) (Digit + <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'0'</span>);
01709             }
01710         }
01711 
01712     LangIdDir[CopyCount++] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>;
01713     LangIdDir[CopyCount++] = UNICODE_NULL;
01714 
01715     <span class="comment">//</span>
01716     <span class="comment">//  Generate the first path c:\winnt\system32\mui\0804\ntdll.dll.mui</span>
01717     <span class="comment">//</span>
01718     AltModulePathList[1].Buffer = AltModulePath;
01719     AltModulePathList[1].Length = 0;
01720     AltModulePathList[1].MaximumLength = <span class="keyword">sizeof</span>(AltModulePath);
01721 
01722     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;AltModulePathList[1], DllPathName);
01723     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;AltModulePathList[1], <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"mui\\"</span>);
01724     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;AltModulePathList[1], LangIdDir);
01725     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;AltModulePathList[1], BaseDllName);
01726 
01727     <span class="comment">//</span>
01728     <span class="comment">//  Generate the first path c:\winnt\system32\mui\0804\ntdll.dll</span>
01729     <span class="comment">//</span>
01730     AltModulePathList[0].Buffer = AltModulePathMUI;
01731     AltModulePathList[0].Length = 0;
01732     AltModulePathList[0].MaximumLength = <span class="keyword">sizeof</span>(AltModulePathMUI);
01733 
01734     <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>(&amp;AltModulePathList[0], &amp;AltModulePathList[1]);
01735     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;AltModulePathList[0], <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">".mui"</span>);
01736 
01737     <span class="comment">//</span>
01738     <span class="comment">//  Generate path c:\winnt\mui\fallback\0804\foo.exe.mui</span>
01739     <span class="comment">//</span>
01740     AltModulePathList[2].Buffer = AltModulePathFallback;
01741     AltModulePathList[2].Length = 0;
01742     AltModulePathList[2].MaximumLength = <span class="keyword">sizeof</span>(AltModulePathFallback);
01743 
01744     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d1/init_8h.html#a3">NtSystemRoot</a>, USER_SHARED_DATA-&gt;NtSystemRoot);
01745     <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(&amp;AltModulePathList[2], &amp;<a class="code" href="../../d8/d1/init_8h.html#a3">NtSystemRoot</a>);
01746     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;AltModulePathList[2], <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\mui\\fallback\\"</span>);
01747     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;AltModulePathList[2], LangIdDir);
01748     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;AltModulePathList[2], BaseDllName);
01749     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;AltModulePathList[2], <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">".mui"</span>);
01750 
01751     <span class="comment">//</span>
01752     <span class="comment">//  Try name with .mui extesion first.</span>
01753     <span class="comment">//</span>
01754     RetryCount = 0;
01755     <span class="keywordflow">while</span> (RetryCount &lt; <span class="keyword">sizeof</span>(AltModulePathList)/<span class="keyword">sizeof</span>(UNICODE_STRING)){
01756         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d1/curdir_8c.html#a29">RtlDosPathNameToNtPathName_U</a>(
01757                     AltModulePathList[RetryCount].<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
01758                     &amp;AltDllName,
01759                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01760                     &amp;<a class="code" href="../../d2/d2/rtload_8c.html#a7">RelativeName</a>
01761                     )){
01762             <span class="keywordflow">goto</span> error_exit;
01763             }
01764 
01765         FreeBuffer = AltDllName.Buffer;
01766         <span class="keywordflow">if</span> ( <a class="code" href="../../d2/d2/rtload_8c.html#a7">RelativeName</a>.RelativeName.Length ) {
01767             AltDllName = *(PUNICODE_STRING)&amp;<a class="code" href="../../d2/d2/rtload_8c.html#a7">RelativeName</a>.RelativeName;
01768             }
01769         <span class="keywordflow">else</span> {
01770             <a class="code" href="../../d2/d2/rtload_8c.html#a7">RelativeName</a>.ContainingDirectory = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01771             }
01772 
01773         InitializeObjectAttributes(
01774             &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01775             &amp;AltDllName,
01776             OBJ_CASE_INSENSITIVE,
01777             <a class="code" href="../../d2/d2/rtload_8c.html#a7">RelativeName</a>.ContainingDirectory,
01778             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01779             );
01780 
01781 
01782         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d8/io_2create_8c.html#a0">NtCreateFile</a>(
01783                 &amp;FileHandle,
01784                 (ACCESS_MASK) GENERIC_READ | SYNCHRONIZE | FILE_READ_ATTRIBUTES,
01785                 &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01786                 &amp;IoStatusBlock,
01787                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01788                 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01789                 FILE_SHARE_READ | FILE_SHARE_DELETE,
01790                 FILE_OPEN,
01791                 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01792                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01793                 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>
01794                 );
01795 
01796         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, FreeBuffer);
01797 
01798         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )){
01799             <span class="keywordflow">break</span>;
01800             }
01801         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_OBJECT_NAME_NOT_FOUND &amp;&amp; RetryCount == 0) {
01802             <span class="comment">//</span>
01803             <span class="comment">//  Error other than the file name with .mui not found.</span>
01804             <span class="comment">//  Most likely directory is missing.  Skip file name w/o .mui</span>
01805             <span class="comment">//  and goto fallback directory.</span>
01806             <span class="comment">//</span>
01807             RetryCount++;
01808             }
01809 
01810         RetryCount++;
01811         }
01812 
01813     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/creasect_8c.html#a19">NtCreateSection</a>(
01814                 &amp;MappingHandle,
01815                 STANDARD_RIGHTS_REQUIRED | SECTION_QUERY | SECTION_MAP_READ,
01816                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01817                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01818                 PAGE_WRITECOPY,
01819                 SEC_COMMIT,
01820                 FileHandle
01821                 );
01822 
01823     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )){
01824         <span class="keywordflow">goto</span> error_exit;
01825         }
01826 
01827     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( FileHandle );
01828 
01829     SectionOffset.LowPart = 0;
01830     SectionOffset.HighPart = 0;
01831     ViewSize = 0;
01832     DllBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01833 
01834     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a20">NtMapViewOfSection</a>(
01835                 MappingHandle,
01836                 NtCurrentProcess(),
01837                 &amp;DllBase,
01838                 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01839                 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01840                 &amp;SectionOffset,
01841                 &amp;ViewSize,
01842                 ViewShare,
01843                 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01844                 PAGE_WRITECOPY
01845                 );
01846 
01847     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( MappingHandle );
01848 
01849     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )){
01850         <span class="keywordflow">goto</span> error_exit;
01851         }
01852 
01853     NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>( DllBase );
01854     <span class="keywordflow">if</span> (!NtHeaders) {
01855         <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(), (PVOID) DllBase);
01856         <span class="keywordflow">goto</span> error_exit;
01857         }
01858 
01859     AlternateModule = (HANDLE)((ULONG_PTR)DllBase | 0x00000001);
01860 
01861     <span class="comment">//</span>
01862     <span class="comment">//  Disable version check now to make testing with an earlier</span>
01863     <span class="comment">//  localized version easier.</span>
01864     <span class="comment">//</span>
01865 <span class="comment">//    if(!LdrpVerifyAlternateResourceModule(Module, AlternateModule)){</span>
01866 <span class="comment">//       NtUnmapViewOfSection(NtCurrentProcess(), (PVOID) DllBase);</span>
01867 <span class="comment">//       goto error_exit;</span>
01868 <span class="comment">//       }</span>
01869 
01870 
01871     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a51">LdrpSetAlternateResourceModuleHandle</a>(Module, AlternateModule);
01872     RtlLeaveCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;<a class="code" href="../../d8/d2/ldrinit_8c.html#a12">LoaderLock</a>);
01873     <span class="keywordflow">return</span> AlternateModule;
01874 
01875 error_exit:
01876     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a51">LdrpSetAlternateResourceModuleHandle</a>(Module, <a class="code" href="../../d5/d9/ntrtlp_8h.html#a15">NO_ALTERNATE_RESOURCE_MODULE</a>);
01877     RtlLeaveCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;<a class="code" href="../../d8/d2/ldrinit_8c.html#a12">LoaderLock</a>);
01878     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01879 }
01880 
01881 BOOLEAN
<a name="l01882"></a><a class="code" href="../../d1/d3/ldrrsrc_8c.html#a22">01882</a> <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a22">LdrUnloadAlternateResourceModule</a>(
01883     IN PVOID Module
01884     )
01885 
01886 <span class="comment">/*++</span>
01887 <span class="comment"></span>
01888 <span class="comment">Routine Description:</span>
01889 <span class="comment"></span>
01890 <span class="comment">    This function unmaps an alternate resource module from the process'</span>
01891 <span class="comment">    address space and updates alternate resource module table.</span>
01892 <span class="comment"></span>
01893 <span class="comment">Arguments:</span>
01894 <span class="comment"></span>
01895 <span class="comment">    Module - handle of the base module.</span>
01896 <span class="comment"></span>
01897 <span class="comment">Return Value:</span>
01898 <span class="comment"></span>
01899 <span class="comment">    TBD.</span>
01900 <span class="comment"></span>
01901 <span class="comment">--*/</span>
01902 
01903 {
01904     ULONG ModuleIndex;
01905     <a class="code" href="../../d8/d6/struct__ALT__RESOURCE__MODULE.html">PALT_RESOURCE_MODULE</a> AltModule;
01906 
01907     RtlEnterCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;<a class="code" href="../../d8/d2/ldrinit_8c.html#a12">LoaderLock</a>);
01908     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a4">AlternateResourceModuleCount</a> == 0){
01909         RtlLeaveCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;<a class="code" href="../../d8/d2/ldrinit_8c.html#a12">LoaderLock</a>);
01910         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01911         }
01912 
01913     <span class="keywordflow">for</span> (ModuleIndex = <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a4">AlternateResourceModuleCount</a>;
01914          ModuleIndex &gt; 0;
01915          ModuleIndex--){
01916         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a3">AlternateResourceModules</a>[ModuleIndex-1].<a class="code" href="../../d8/d6/struct__ALT__RESOURCE__MODULE.html#o0">ModuleBase</a> == Module){
01917             <span class="keywordflow">break</span>;
01918         }
01919     }
01920 
01921     <span class="keywordflow">if</span> (ModuleIndex == 0){
01922         RtlLeaveCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;<a class="code" href="../../d8/d2/ldrinit_8c.html#a12">LoaderLock</a>);
01923         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01924         }
01925     <span class="comment">//</span>
01926     <span class="comment">//  Adjust to the actual index</span>
01927     <span class="comment">//</span>
01928     ModuleIndex --;
01929 
01930     AltModule = &amp;<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a3">AlternateResourceModules</a>[ModuleIndex];
01931     <span class="keywordflow">if</span> (AltModule-&gt;<a class="code" href="../../d8/d6/struct__ALT__RESOURCE__MODULE.html#o1">AlternateModule</a> != <a class="code" href="../../d5/d9/ntrtlp_8h.html#a15">NO_ALTERNATE_RESOURCE_MODULE</a>) {
01932         <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(
01933             NtCurrentProcess(),
01934             (PVOID)((ULONG_PTR)AltModule-&gt;<a class="code" href="../../d8/d6/struct__ALT__RESOURCE__MODULE.html#o1">AlternateModule</a> &amp; ~0x00000001)
01935             );
01936     }
01937 
01938     __try {
01939         <span class="keywordflow">if</span> (ModuleIndex != <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a4">AlternateResourceModuleCount</a> - 1){
01940             <span class="comment">//</span>
01941             <span class="comment">//  Consolidate the array.  Skip this if unloaded item</span>
01942             <span class="comment">//  is the last element.</span>
01943             <span class="comment">//</span>
01944             RtlMoveMemory(
01945                 AltModule,
01946                 AltModule + 1,
01947                 (<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a4">AlternateResourceModuleCount</a> - ModuleIndex - 1) * <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a1">RESMODSIZE</a>
01948                 );
01949             }
01950         }
01951     __except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01952         RtlLeaveCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;<a class="code" href="../../d8/d2/ldrinit_8c.html#a12">LoaderLock</a>);
01953         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01954         }
01955 
01956     <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a4">AlternateResourceModuleCount</a> --;
01957 
01958     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a4">AlternateResourceModuleCount</a> == 0){
01959         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(
01960             RtlProcessHeap(),
01961             0,
01962             <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a3">AlternateResourceModules</a>
01963             );
01964         <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a3">AlternateResourceModules</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01965         <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a5">AltResMemBlockCount</a> = 0;
01966         }
01967     <span class="keywordflow">else</span>
01968     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a4">AlternateResourceModuleCount</a> &lt; <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a5">AltResMemBlockCount</a> - <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a0">MEMBLOCKSIZE</a>){
01969         AltModule = <a class="code" href="../../d5/d9/heapdll_8c.html#a24">RtlReAllocateHeap</a>(
01970                         RtlProcessHeap(),
01971                         0,
01972                         <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a3">AlternateResourceModules</a>,
01973                         (<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a5">AltResMemBlockCount</a> - <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a0">MEMBLOCKSIZE</a>) * <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a1">RESMODSIZE</a>);
01974 
01975         <span class="keywordflow">if</span> (!AltModule){
01976             RtlLeaveCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;<a class="code" href="../../d8/d2/ldrinit_8c.html#a12">LoaderLock</a>);
01977             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01978             }
01979 
01980         <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a3">AlternateResourceModules</a> = AltModule;
01981         <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a5">AltResMemBlockCount</a> -= <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a0">MEMBLOCKSIZE</a>;
01982         }
01983     RtlLeaveCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;<a class="code" href="../../d8/d2/ldrinit_8c.html#a12">LoaderLock</a>);
01984     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01985 }
01986 
01987 
01988 BOOLEAN
<a name="l01989"></a><a class="code" href="../../d1/d3/ldrrsrc_8c.html#a23">01989</a> <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a23">LdrFlushAlternateResourceModules</a>(
01990     VOID
01991     )
01992 
01993 <span class="comment">/*++</span>
01994 <span class="comment"></span>
01995 <span class="comment">Routine Description:</span>
01996 <span class="comment"></span>
01997 <span class="comment">    This function unmaps all the alternate resouce modules for the</span>
01998 <span class="comment">    process address space. This function would be used mainly by</span>
01999 <span class="comment">    CSRSS, and any sub-systems that are permanent during logon and</span>
02000 <span class="comment">    logoff.</span>
02001 <span class="comment"></span>
02002 <span class="comment"></span>
02003 <span class="comment">Arguments:</span>
02004 <span class="comment"></span>
02005 <span class="comment">    None</span>
02006 <span class="comment"></span>
02007 <span class="comment">Return Value:</span>
02008 <span class="comment"></span>
02009 <span class="comment">    TRUE  : Successful</span>
02010 <span class="comment">    FALSE : Failed</span>
02011 <span class="comment"></span>
02012 <span class="comment">--*/</span>
02013 
02014 {
02015     ULONG ModuleIndex;
02016     <a class="code" href="../../d8/d6/struct__ALT__RESOURCE__MODULE.html">PALT_RESOURCE_MODULE</a> AltModule;
02017 
02018     <span class="comment">//</span>
02019     <span class="comment">// Grab the loader lock</span>
02020     <span class="comment">//</span>
02021     RtlEnterCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;<a class="code" href="../../d8/d2/ldrinit_8c.html#a12">LoaderLock</a>);
02022 
02023     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a4">AlternateResourceModuleCount</a> &gt; 0) {
02024         <span class="comment">//</span>
02025         <span class="comment">// Let's unmap the alternate resource modules from the process</span>
02026         <span class="comment">// address space</span>
02027         <span class="comment">//</span>
02028         <span class="keywordflow">for</span> (ModuleIndex=0;
02029              ModuleIndex&lt;<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a4">AlternateResourceModuleCount</a>;
02030              ModuleIndex++) {
02031 
02032             AltModule = &amp;<a class="code" href="../../d1/d3/ldrrsrc_8c.html#a3">AlternateResourceModules</a>[ModuleIndex];
02033 
02034             <span class="keywordflow">if</span> (AltModule-&gt;<a class="code" href="../../d8/d6/struct__ALT__RESOURCE__MODULE.html#o1">AlternateModule</a> != <a class="code" href="../../d5/d9/ntrtlp_8h.html#a15">NO_ALTERNATE_RESOURCE_MODULE</a>) {
02035                 <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(),
02036                                      (PVOID)((ULONG_PTR)AltModule-&gt;<a class="code" href="../../d8/d6/struct__ALT__RESOURCE__MODULE.html#o1">AlternateModule</a> &amp; ~0x00000001));
02037                 }
02038             }
02039 
02040         <span class="comment">//</span>
02041         <span class="comment">// Cleanup alternate resource modules memory</span>
02042         <span class="comment">//</span>
02043         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a3">AlternateResourceModules</a>);
02044         <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a3">AlternateResourceModules</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02045         <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a4">AlternateResourceModuleCount</a> = 0;
02046         <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a5">AltResMemBlockCount</a> = 0;
02047 
02048         }
02049 
02050     <span class="comment">//</span>
02051     <span class="comment">// Re-Initialize the UI language for the current process,</span>
02052     <span class="comment">// and leave the LoaderLock</span>
02053     <span class="comment">//</span>
02054     <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a6">UILangId</a> = 0;
02055     RtlLeaveCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;<a class="code" href="../../d8/d2/ldrinit_8c.html#a12">LoaderLock</a>);
02056 
02057     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02058 }
02059 
02060 <span class="preprocessor">#endif</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:37 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
