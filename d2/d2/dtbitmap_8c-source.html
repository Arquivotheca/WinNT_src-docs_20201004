<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: dtbitmap.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>dtbitmap.c</h1><a href="../../d1/d3/dtbitmap_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: dtbitmap.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Desktop Wallpaper Routines.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 29-Jul-1991 MikeKe    From win31</span>
00010 <span class="comment">\***************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span>
00015 <span class="comment">/*</span>
00016 <span class="comment"> * Local Constants.</span>
00017 <span class="comment"> */</span>
<a name="l00018"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a0">00018</a> <span class="preprocessor">#define MAXPAL         256</span>
<a name="l00019"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a1">00019</a> <span class="preprocessor"></span><span class="preprocessor">#define MAXSTATIC       20</span>
<a name="l00020"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a2">00020</a> <span class="preprocessor"></span><span class="preprocessor">#define TILE_XMINSIZE    2</span>
<a name="l00021"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a3">00021</a> <span class="preprocessor"></span><span class="preprocessor">#define TILE_YMINSIZE    4</span>
00022 <span class="preprocessor"></span>
00023 <span class="keywordtype">void</span> <a class="code" href="../../d1/d3/dtbitmap_8c.html#a18">xxxInvalidateDesktopOnPaletteChange</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd);
00024 
00025 __inline <span class="keywordtype">void</span>
<a name="l00026"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a19">00026</a> <a class="code" href="../../d6/d0/usercli_8h.html#a31">SetBestStretchMode</a>(HDC hdc, UINT bpp, BOOL fHT)
00027 {
00028     GreSetStretchBltMode(
00029             hdc,
00030             ((fHT) ?
00031                 HALFTONE :
00032                 ((bpp == 1) ? BLACKONWHITE : COLORONCOLOR)));
00033 }
00034 
00035 <span class="comment">/*</span>
00036 <span class="comment"> * The version strings are stored in a contiguous-buffer.  Each string</span>
00037 <span class="comment"> * is of equal-size (MAXVERSIONSTRING).</span>
00038 <span class="comment"> */</span>
<a name="l00039"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a4">00039</a> <span class="preprocessor">#define MAXTXTBUFFER       80</span>
<a name="l00040"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a5">00040</a> <span class="preprocessor"></span><span class="preprocessor">#define MAXVERSIONBUFFER  300   // Max size of buffer (contains all 3 strings).</span>
<a name="l00041"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a6">00041</a> <span class="preprocessor"></span><span class="preprocessor">#define MAXVERSIONSTRING  100   // Size of each string buffer.</span>
<a name="l00042"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a7">00042</a> <span class="preprocessor"></span><span class="preprocessor">#define OFFSET_BLDSTRING    0   // Offset into verbuffer of build-string.</span>
<a name="l00043"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a8">00043</a> <span class="preprocessor"></span><span class="preprocessor">#define OFFSET_TYPSTRING  100   // Offset into verbuffer of type string.</span>
<a name="l00044"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a9">00044</a> <span class="preprocessor"></span><span class="preprocessor">#define OFFSET_CSDSTRING  200   // Offset into verbuffer of CSD string.</span>
00045 <span class="preprocessor"></span>
<a name="l00046"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a13">00046</a> WCHAR          <a class="code" href="../../d1/d3/dtbitmap_8c.html#a13">wszT</a>[<a class="code" href="../../d1/d3/dtbitmap_8c.html#a4">MAXTXTBUFFER</a>];
<a name="l00047"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a14">00047</a> WCHAR          <a class="code" href="../../d1/d3/dtbitmap_8c.html#a14">SafeModeStr</a>[64];
<a name="l00048"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a15">00048</a> <span class="keywordtype">int</span>            <a class="code" href="../../d1/d3/dtbitmap_8c.html#a15">SafeModeStrLen</a>;
00049 <span class="comment">/*</span>
00050 <span class="comment"> * Bug 280256 - joejo</span>
00051 <span class="comment"> * Draw new desktop build information global strings</span>
00052 <span class="comment"> */</span>
<a name="l00053"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a16">00053</a> WCHAR          <a class="code" href="../../d1/d3/dtbitmap_8c.html#a16">wszProductName</a>[<a class="code" href="../../d1/d3/dtbitmap_8c.html#a4">MAXTXTBUFFER</a>];
<a name="l00054"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a17">00054</a> WCHAR          <a class="code" href="../../d1/d3/dtbitmap_8c.html#a17">wszProductBuild</a>[<a class="code" href="../../d1/d3/dtbitmap_8c.html#a4">MAXTXTBUFFER</a>];
00055 
00056 
00057 <span class="comment">/***************************************************************************\</span>
00058 <span class="comment">* GetVersionInfo</span>
00059 <span class="comment">*</span>
00060 <span class="comment">* Outputs a string on the desktop indicating debug-version.</span>
00061 <span class="comment">*</span>
00062 <span class="comment">* History:</span>
00063 <span class="comment">\***************************************************************************/</span>
00064 
00065 
00066 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00067"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a20">00067</a> <a class="code" href="../../d1/d3/dtbitmap_8c.html#a20">GetVersionInfo</a>(
00068     BOOL Verbose
00069     )
00070 {
00071     WCHAR          NameBuffer[<a class="code" href="../../d1/d3/dtbitmap_8c.html#a5">MAXVERSIONBUFFER</a>];
00072     WCHAR          Title1[128];
00073     WCHAR          Title2[128];
00074     WCHAR          wszPID[<a class="code" href="../../d1/d3/dtbitmap_8c.html#a6">MAXVERSIONSTRING</a>];
00075     WCHAR          wszPro[<a class="code" href="../../d1/d3/dtbitmap_8c.html#a6">MAXVERSIONSTRING</a>];
00076     WCHAR          wszSrv[<a class="code" href="../../d1/d3/dtbitmap_8c.html#a6">MAXVERSIONSTRING</a>];
00077     WCHAR          wszPBuild[<a class="code" href="../../d1/d3/dtbitmap_8c.html#a6">MAXVERSIONSTRING</a>];
00078     WCHAR          wszEvaluation[<a class="code" href="../../d1/d3/dtbitmap_8c.html#a6">MAXVERSIONSTRING</a>];
00079     UNICODE_STRING UserBuildString;
00080     UNICODE_STRING UserTypeString;
00081     UNICODE_STRING UserCSDString;
00082     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>       <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00083 
00084 
00085     RTL_QUERY_REGISTRY_TABLE BaseServerRegistryConfigurationTable[] = {
00086 
00087         {<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00088          RTL_QUERY_REGISTRY_DIRECT,
00089          <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"CurrentBuildNumber"</span>,
00090          &amp;UserBuildString,
00091          REG_NONE,
00092          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00093          0},
00094 
00095         {<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00096          RTL_QUERY_REGISTRY_DIRECT,
00097          <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"CurrentType"</span>,
00098          &amp;UserTypeString,
00099          REG_NONE,
00100          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00101          0},
00102 
00103         {<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00104          RTL_QUERY_REGISTRY_DIRECT,
00105          <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"CSDVersion"</span>,
00106          &amp;UserCSDString,
00107          REG_NONE,
00108          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00109          0},
00110 
00111         {<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00112          0,
00113          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00114          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00115          REG_NONE,
00116          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00117          0}
00118     };
00119 
00120     UserBuildString.Buffer          = &amp;NameBuffer[<a class="code" href="../../d1/d3/dtbitmap_8c.html#a7">OFFSET_BLDSTRING</a>];
00121     UserBuildString.Length          = 0;
00122     UserBuildString.MaximumLength   = <a class="code" href="../../d1/d3/dtbitmap_8c.html#a6">MAXVERSIONSTRING</a> * <span class="keyword">sizeof</span>(WCHAR);
00123 
00124     UserTypeString.Buffer           = &amp;NameBuffer[<a class="code" href="../../d1/d3/dtbitmap_8c.html#a8">OFFSET_TYPSTRING</a>];
00125     UserTypeString.Length           = 0;
00126     UserTypeString.MaximumLength    = <a class="code" href="../../d1/d3/dtbitmap_8c.html#a6">MAXVERSIONSTRING</a> * <span class="keyword">sizeof</span>(WCHAR);
00127 
00128     UserCSDString.Buffer            = &amp;NameBuffer[<a class="code" href="../../d1/d3/dtbitmap_8c.html#a9">OFFSET_CSDSTRING</a>];
00129     UserCSDString.Length            = 0;
00130     UserCSDString.MaximumLength     = <a class="code" href="../../d1/d3/dtbitmap_8c.html#a6">MAXVERSIONSTRING</a> * <span class="keyword">sizeof</span>(WCHAR);
00131 
00132     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a19">RtlQueryRegistryValues</a>(RTL_REGISTRY_WINDOWS_NT,
00133                                     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>,
00134                                     BaseServerRegistryConfigurationTable,
00135                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00136                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00137 
00138     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00139         RIPMSG1(RIP_WARNING, <span class="stringliteral">"GetVersionInfo failed with status %x"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00140         <span class="keywordflow">return</span>;
00141     }
00142 
00143     <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>( <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>, STR_DTBS_PRODUCTID, wszPID, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(wszPID) );
00144     <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>( <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>, STR_DTBS_PRODUCTPRO, wszPro, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(wszPro) );
00145     <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>( <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>, STR_DTBS_PRODUCTSRV, wszSrv, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(wszSrv) );
00146     <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>( <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>, STR_DTBS_PRODUCTBUILD, wszPBuild, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(wszPBuild) );
00147 
00148     <span class="comment">/*</span>
00149 <span class="comment">     * Write out Debugging Version message.</span>
00150 <span class="comment">     */</span>
00151 
00152     <span class="comment">/*</span>
00153 <span class="comment">     * Bug 280256 - joejo</span>
00154 <span class="comment">     * Create new desktop build information strings</span>
00155 <span class="comment">     */</span>
00156     swprintf(
00157         <a class="code" href="../../d1/d3/dtbitmap_8c.html#a16">wszProductName</a>,
00158         wszPID,
00159         ((USER_SHARED_DATA-&gt;NtProductType == NtProductWinNt) ? wszPro : wszSrv)
00160         );
00161 
00162     
00163     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a8">gfUnsignedDrivers</a>) {
00164         <span class="comment">/* This takes precedence */</span>
00165         <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>( <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>, STR_TESTINGONLY, wszEvaluation, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(wszEvaluation) );
00166     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (USER_SHARED_DATA-&gt;SystemExpirationDate.QuadPart) {
00167         <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>, STR_DTBS_EVALUATION, wszEvaluation,
00168                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(wszEvaluation));
00169     } <span class="keywordflow">else</span> {
00170         wszEvaluation[0] = <span class="charliteral">'\0'</span>;
00171     }
00172 
00173     swprintf(
00174         <a class="code" href="../../d1/d3/dtbitmap_8c.html#a17">wszProductBuild</a>,
00175         wszPBuild,
00176         wszEvaluation,
00177         UserBuildString.Buffer
00178         );
00179 
00180     <span class="keywordflow">if</span> (Verbose) {
00181 
00182         <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>( <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>, STR_SAFEMODE_TITLE1, Title1, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(Title1) );
00183         <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>( <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>, STR_SAFEMODE_TITLE2, Title2, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(Title2) );
00184 
00185         swprintf(
00186             <a class="code" href="../../d1/d3/dtbitmap_8c.html#a13">wszT</a>,
00187             UserCSDString.Length == 0 ? Title1 : Title2,
00188             UserBuildString.Buffer,
00189             UserCSDString.Buffer,
00190             USER_SHARED_DATA-&gt;NtSystemRoot
00191             );
00192 
00193     } <span class="keywordflow">else</span> {
00194         PWSTR s = wcsrchr( UserTypeString.Buffer, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">' '</span> );
00195         <span class="keywordflow">if</span> (s) {
00196             s += 1;
00197         } <span class="keywordflow">else</span> {
00198             s = UserTypeString.Buffer;
00199         }
00200 
00201         <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>( <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>, STR_SAFEMODE_TITLE3, Title1, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(Title1) );
00202         <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>( <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>, STR_SAFEMODE_TITLE4, Title2, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(Title2) );
00203 
00204         swprintf(
00205             <a class="code" href="../../d1/d3/dtbitmap_8c.html#a13">wszT</a>,
00206             UserCSDString.Length == 0 ? Title1 : Title2,
00207             UserBuildString.Buffer,
00208             UserCSDString.Buffer,
00209             s
00210             );
00211     }
00212 }
00213 
00214 <span class="comment">/***************************************************************************\</span>
00215 <span class="comment">* GetDefaultWallpaperName</span>
00216 <span class="comment">*</span>
00217 <span class="comment">* Get initial bitmap name</span>
00218 <span class="comment">*</span>
00219 <span class="comment">* History:</span>
00220 <span class="comment">* 21-Feb-1995 JimA      Created.</span>
00221 <span class="comment">* 06-Mar-1996 ChrisWil  Moved to kernel to facilite ChangeDisplaySettings.</span>
00222 <span class="comment">\***************************************************************************/</span>
<a name="l00223"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a21">00223</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d1/d3/dtbitmap_8c.html#a21">GetDefaultWallpaperName</a>(
00224         LPWSTR  lpszWallpaper
00225         )
00226 {
00227     <span class="comment">/*</span>
00228 <span class="comment">     * Set the initial global wallpaper bitmap name for (Default)</span>
00229 <span class="comment">     * The global name is an at most 8 character name with no</span>
00230 <span class="comment">     * extension.  It is "winnt" for workstation or "lanmannt"</span>
00231 <span class="comment">     * for server or server upgrade.  It is followed by 256 it</span>
00232 <span class="comment">     * is for 256 color devices.</span>
00233 <span class="comment">     */</span>
00234     <span class="keywordflow">if</span> (USER_SHARED_DATA-&gt;NtProductType == NtProductWinNt) {
00235         <a class="code" href="../../d1/d5/w32_2ntuser_2rtl_2random_8c.html#a3">wcsncpycch</a>(lpszWallpaper, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"winnt"</span>, 8);
00236     } <span class="keywordflow">else</span> {
00237         <a class="code" href="../../d1/d5/w32_2ntuser_2rtl_2random_8c.html#a3">wcsncpycch</a>(lpszWallpaper, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"lanmannt"</span>, 8);
00238     }
00239 
00240     lpszWallpaper[8] = (WCHAR)0;
00241 
00242     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;BitsPixel * <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;Planes &gt; 4) {
00243         <span class="keywordtype">int</span> iStart = wcslen(lpszWallpaper);
00244         iStart = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(iStart, 5);
00245 
00246         lpszWallpaper[iStart] = (WCHAR)0;
00247         wcscat(lpszWallpaper, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"256"</span>);
00248     }
00249 
00250     <span class="keywordflow">return</span>;
00251 }
00252 
00253 <span class="comment">/***************************************************************************\</span>
00254 <span class="comment">* GetDeskWallpaperName</span>
00255 <span class="comment">*</span>
00256 <span class="comment">* History:</span>
00257 <span class="comment">* 19-Dec-1994 JimA          Created.</span>
00258 <span class="comment">* 29-Sep-1995 ChrisWil      ReWrote to return filename.</span>
00259 <span class="comment">\***************************************************************************/</span>
00260 
<a name="l00261"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a10">00261</a> <span class="preprocessor">#define GDWPN_KEYSIZE   40</span>
<a name="l00262"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a11">00262</a> <span class="preprocessor"></span><span class="preprocessor">#define GDWPN_BITSIZE  256</span>
00263 <span class="preprocessor"></span>
<a name="l00264"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a22">00264</a> LPWSTR <a class="code" href="../../d1/d3/dtbitmap_8c.html#a22">GetDeskWallpaperName</a>(PUNICODE_STRING pProfileUserName,
00265         LPWSTR       lpszFile
00266         )
00267 {
00268     WCHAR  wszKey[<a class="code" href="../../d1/d3/dtbitmap_8c.html#a10">GDWPN_KEYSIZE</a>];
00269     WCHAR  wszNone[<a class="code" href="../../d1/d3/dtbitmap_8c.html#a10">GDWPN_KEYSIZE</a>];
00270     LPWSTR lpszBitmap = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00271 
00272     <span class="comment">/*</span>
00273 <span class="comment">     * Load the none-string.  This will be used for comparisons later.</span>
00274 <span class="comment">     */</span>
00275     <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>, STR_NONE, wszNone, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(wszNone));
00276 
00277     <span class="keywordflow">if</span> ((lpszFile == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)                 ||
00278         (lpszFile == SETWALLPAPER_DEFAULT) ||
00279         (lpszFile == SETWALLPAPER_METRICS)) {
00280 
00281         <span class="comment">/*</span>
00282 <span class="comment">         * Allocate a buffer for the wallpaper.  We will assume</span>
00283 <span class="comment">         * a default-size in this case.</span>
00284 <span class="comment">         */</span>
00285         lpszBitmap = UserAllocPool(<a class="code" href="../../d1/d3/dtbitmap_8c.html#a11">GDWPN_BITSIZE</a> * <span class="keyword">sizeof</span>(WCHAR), TAG_SYSTEM);
00286         <span class="keywordflow">if</span> (lpszBitmap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00287             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00288 
00289         <span class="comment">/*</span>
00290 <span class="comment">         * Get the "Wallpaper" string from WIN.INI's [Desktop] section.  The</span>
00291 <span class="comment">         * section name is not localized, so hard code it.  If the string</span>
00292 <span class="comment">         * returned is Empty, then set it up for a none-wallpaper.</span>
00293 <span class="comment">         */</span>
00294         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a2011">FastGetProfileStringFromIDW</a>(pProfileUserName,
00295                                             <a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>,
00296                                             STR_DTBITMAP,
00297                                             wszNone,
00298                                             lpszBitmap,
00299                                             <a class="code" href="../../d1/d3/dtbitmap_8c.html#a11">GDWPN_BITSIZE</a>
00300                                             )) {
00301             wcscpy(lpszBitmap, wszNone);
00302         }
00303 
00304     } <span class="keywordflow">else</span> {
00305 
00306         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uLen;
00307 
00308         uLen = wcslen(lpszFile) + 1;
00309         uLen = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(uLen, <a class="code" href="../../d1/d3/dtbitmap_8c.html#a11">GDWPN_BITSIZE</a>);
00310 
00311         <span class="comment">/*</span>
00312 <span class="comment">         * Allocate enough space to store the name passed in.  Returning</span>
00313 <span class="comment">         * NULL will allow the wallpaper to redraw.  As well, if we're</span>
00314 <span class="comment">         * out of memory, then no need to load a wallpaper anyway.</span>
00315 <span class="comment">         */</span>
00316         lpszBitmap = UserAllocPool(uLen * <span class="keyword">sizeof</span>(WCHAR), TAG_SYSTEM);
00317         <span class="keywordflow">if</span> (lpszBitmap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00318             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00319 
00320         wcscpy(lpszBitmap, lpszFile);
00321     }
00322 
00323     <span class="comment">/*</span>
00324 <span class="comment">     * No bitmap if NULL passed in or if (NONE) in win.ini entry.  We</span>
00325 <span class="comment">     * return NULL to force the redraw of the wallpaper in the kernel.</span>
00326 <span class="comment">     */</span>
00327     <span class="keywordflow">if</span> ((*lpszBitmap == (WCHAR)0) || (_wcsicmp(lpszBitmap, wszNone) == 0)) {
00328         UserFreePool(lpszBitmap);
00329         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00330     }
00331 
00332     <span class="comment">/*</span>
00333 <span class="comment">     * If bitmap name set to (DEFAULT) then set it to the system bitmap.</span>
00334 <span class="comment">     */</span>
00335     <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>, STR_DEFAULT, wszKey, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(wszKey));
00336 
00337     <span class="keywordflow">if</span> (_wcsicmp(lpszBitmap, wszKey) == 0) {
00338         <a class="code" href="../../d1/d3/dtbitmap_8c.html#a21">GetDefaultWallpaperName</a>(lpszBitmap);
00339     }
00340 
00341 
00342     <span class="keywordflow">return</span> lpszBitmap;
00343 }
00344 
00345 <span class="comment">/***************************************************************************\</span>
00346 <span class="comment">* TestVGAColors</span>
00347 <span class="comment">*</span>
00348 <span class="comment">* Tests whether the log-palette is just a standard 20 palette.</span>
00349 <span class="comment">*</span>
00350 <span class="comment">* History:</span>
00351 <span class="comment">* 29-Sep-1995 ChrisWil  Created.</span>
00352 <span class="comment">\***************************************************************************/</span>
00353 
<a name="l00354"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a23">00354</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d1/d3/dtbitmap_8c.html#a23">TestVGAColors</a>(
00355     LPLOGPALETTE ppal)
00356 {
00357     <span class="keywordtype">int</span>      i;
00358     <span class="keywordtype">int</span>      <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
00359     <span class="keywordtype">int</span>      size;
00360     COLORREF clr;
00361 
00362     <span class="keyword">static</span> CONST <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> StupidColors[] = {
00363          0x00000000,        <span class="comment">//   0 Sys Black</span>
00364          0x00000080,        <span class="comment">//   1 Sys Dk Red</span>
00365          0x00008000,        <span class="comment">//   2 Sys Dk Green</span>
00366          0x00008080,        <span class="comment">//   3 Sys Dk Yellow</span>
00367          0x00800000,        <span class="comment">//   4 Sys Dk Blue</span>
00368          0x00800080,        <span class="comment">//   5 Sys Dk Violet</span>
00369          0x00808000,        <span class="comment">//   6 Sys Dk Cyan</span>
00370          0x00c0c0c0,        <span class="comment">//   7 Sys Lt Grey</span>
00371          0x00808080,        <span class="comment">// 248 Sys Lt Gray</span>
00372          0x000000ff,        <span class="comment">// 249 Sys Red</span>
00373          0x0000ff00,        <span class="comment">// 250 Sys Green</span>
00374          0x0000ffff,        <span class="comment">// 251 Sys Yellow</span>
00375          0x00ff0000,        <span class="comment">// 252 Sys Blue</span>
00376          0x00ff00ff,        <span class="comment">// 253 Sys Violet</span>
00377          0x00ffff00,        <span class="comment">// 254 Sys Cyan</span>
00378          0x00ffffff,        <span class="comment">// 255 Sys White</span>
00379 
00380          0x000000BF,        <span class="comment">//   1 Sys Dk Red again</span>
00381          0x0000BF00,        <span class="comment">//   2 Sys Dk Green again</span>
00382          0x0000BFBF,        <span class="comment">//   3 Sys Dk Yellow again</span>
00383          0x00BF0000,        <span class="comment">//   4 Sys Dk Blue again</span>
00384          0x00BF00BF,        <span class="comment">//   5 Sys Dk Violet again</span>
00385          0x00BFBF00,        <span class="comment">//   6 Sys Dk Cyan  again</span>
00386 
00387          0x000000C0,        <span class="comment">//   1 Sys Dk Red again</span>
00388          0x0000C000,        <span class="comment">//   2 Sys Dk Green again</span>
00389          0x0000C0C0,        <span class="comment">//   3 Sys Dk Yellow again</span>
00390          0x00C00000,        <span class="comment">//   4 Sys Dk Blue again</span>
00391          0x00C000C0,        <span class="comment">//   5 Sys Dk Violet again</span>
00392          0x00C0C000,        <span class="comment">//   6 Sys Dk Cyan  again</span>
00393     };
00394 
00395     size = (<span class="keyword">sizeof</span>(StupidColors) / <span class="keyword">sizeof</span>(StupidColors[0]));
00396 
00397     <span class="keywordflow">for</span> (i = 0; i &lt; (<span class="keywordtype">int</span>)ppal-&gt;palNumEntries; i++) {
00398 
00399         clr = ((LPDWORD)ppal-&gt;palPalEntry)[i];
00400 
00401         <span class="keywordflow">for</span> (<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = 0; <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> &lt; size; <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>++) {
00402 
00403             <span class="keywordflow">if</span> (StupidColors[<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>] == clr)
00404                 <span class="keywordflow">break</span>;
00405         }
00406 
00407         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> == size)
00408             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00409     }
00410 
00411     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00412 }
00413 
00414 <span class="comment">/***************************************************************************\</span>
00415 <span class="comment">* DoHTColorAdjustment</span>
00416 <span class="comment">*</span>
00417 <span class="comment">* The default HT-Gamma adjustment was 2.0 on 3.5 (internal to gdi).  For</span>
00418 <span class="comment">* 3.51 this value was decreased to 1.0 to accomdate printing.  For our</span>
00419 <span class="comment">* desktop-wallpaper we are going to darken it slightly to that the image</span>
00420 <span class="comment">* doesn't appear to light.  For the Shell-Release we will provid a UI to</span>
00421 <span class="comment">* allow users to change this for themselves.</span>
00422 <span class="comment">*</span>
00423 <span class="comment">*</span>
00424 <span class="comment">* History:</span>
00425 <span class="comment">* 11-May-1995 ChrisWil  Created.</span>
00426 <span class="comment">\***************************************************************************/</span>
00427 
<a name="l00428"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a12">00428</a> <span class="preprocessor">#define FIXED_GAMMA (WORD)13000</span>
00429 <span class="preprocessor"></span>
<a name="l00430"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a24">00430</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d1/d3/dtbitmap_8c.html#a24">DoHTColorAdjust</a>(
00431     HDC hdc)
00432 {
00433     COLORADJUSTMENT ca;
00434 
00435 
00436     <span class="keywordflow">if</span> (GreGetColorAdjustment(hdc, &amp;ca)) {
00437 
00438         ca.caRedGamma   =
00439         ca.caGreenGamma =
00440         ca.caBlueGamma  = <a class="code" href="../../d1/d3/dtbitmap_8c.html#a12">FIXED_GAMMA</a>;
00441 
00442         GreSetColorAdjustment(hdc, &amp;ca);
00443     }
00444 
00445     <span class="keywordflow">return</span>;
00446 }
00447 
00448 <span class="comment">/***************************************************************************\</span>
00449 <span class="comment">* ConvertToDDB</span>
00450 <span class="comment">*</span>
00451 <span class="comment">* Converts a DIBSection to a DDB.  We do this to speed up drawings so that</span>
00452 <span class="comment">* bitmap-colors don't have to go through a palette-translation match.  This</span>
00453 <span class="comment">* will also stretch/expand the image if the syle is set.</span>
00454 <span class="comment">*</span>
00455 <span class="comment">* If the new image requires a halftone-palette, the we will create one and</span>
00456 <span class="comment">* set it as the new wallpaper-palette.</span>
00457 <span class="comment">*</span>
00458 <span class="comment">* History:</span>
00459 <span class="comment">* 26-Oct-1995 ChrisWil  Ported.</span>
00460 <span class="comment">* 30-Oct-1995 ChrisWil  Added halftoning.  Rewote the stretch/expand stuff.</span>
00461 <span class="comment">\***************************************************************************/</span>
00462 
<a name="l00463"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a25">00463</a> HBITMAP <a class="code" href="../../d1/d3/dtbitmap_8c.html#a25">ConvertToDDB</a>(
00464     HDC      hdc,
00465     HBITMAP  hbmOld,
00466     HPALETTE hpal)
00467 {
00468     BITMAP  bm;
00469     HBITMAP hbmNew;
00470 
00471     <span class="comment">/*</span>
00472 <span class="comment">     * This object must be a REALDIB type bitmap.</span>
00473 <span class="comment">     */</span>
00474     GreExtGetObjectW(hbmOld, <span class="keyword">sizeof</span>(bm), &amp;bm);
00475 
00476     <span class="comment">/*</span>
00477 <span class="comment">     * Create the new wallpaper-surface.</span>
00478 <span class="comment">     */</span>
00479     <span class="keywordflow">if</span> (hbmNew = GreCreateCompatibleBitmap(hdc, bm.bmWidth, bm.bmHeight)) {
00480 
00481         HPALETTE hpalDst;
00482         HPALETTE hpalSrc;
00483         HBITMAP  hbmDst;
00484         HBITMAP  hbmSrc;
00485         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>     bpp;
00486         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>     fHalftone = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00487 
00488         <span class="comment">/*</span>
00489 <span class="comment">         * Select in the surfaces.</span>
00490 <span class="comment">         */</span>
00491         hbmDst = GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a193">ghdcMem2</a>, hbmNew);
00492         hbmSrc = GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>, hbmOld);
00493 
00494         <span class="comment">/*</span>
00495 <span class="comment">         * Determine image bits/pixel.</span>
00496 <span class="comment">         */</span>
00497         bpp = (bm.bmPlanes * bm.bmBitsPixel);
00498 
00499         <span class="comment">/*</span>
00500 <span class="comment">         * Use the palette if given.  If the image is of a greater</span>
00501 <span class="comment">         * resolution than the device, then we're going to go through</span>
00502 <span class="comment">         * a halftone-palette to get better colors.</span>
00503 <span class="comment">         */</span>
00504         <span class="keywordflow">if</span> (hpal) {
00505 
00506             hpalDst = <a class="code" href="../../d4/d1/userk_8h.html#a1103">_SelectPalette</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a193">ghdcMem2</a>, hpal, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00507             hpalSrc = <a class="code" href="../../d4/d1/userk_8h.html#a1103">_SelectPalette</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>, hpal, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00508 
00509             <a class="code" href="../../d4/d1/userk_8h.html#a1104">xxxRealizePalette</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a193">ghdcMem2</a>);
00510 
00511             <span class="comment">/*</span>
00512 <span class="comment">             * Set the halftoning for the destination.  This is done</span>
00513 <span class="comment">             * for images of greater resolution than the device.</span>
00514 <span class="comment">             */</span>
00515             <span class="keywordflow">if</span> (bpp &gt; <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;BitCount) {
00516                 fHalftone = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00517                 <a class="code" href="../../d1/d3/dtbitmap_8c.html#a24">DoHTColorAdjust</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a193">ghdcMem2</a>);
00518             }
00519         }
00520 
00521         <span class="comment">/*</span>
00522 <span class="comment">         * Set the stretchbltmode.  This is more necessary when doing</span>
00523 <span class="comment">         * halftoning.  Since otherwise, the colors won't translate</span>
00524 <span class="comment">         * correctly.</span>
00525 <span class="comment">         */</span>
00526         <a class="code" href="../../d6/d0/usercli_8h.html#a31">SetBestStretchMode</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a193">ghdcMem2</a>, bpp, fHalftone);
00527 
00528         <span class="comment">/*</span>
00529 <span class="comment">         * Set the new surface bits.  Use StretchBlt() so the SBMode</span>
00530 <span class="comment">         * will be used in color-translation.</span>
00531 <span class="comment">         */</span>
00532         GreStretchBlt(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a193">ghdcMem2</a>,
00533                       0,
00534                       0,
00535                       bm.bmWidth,
00536                       bm.bmHeight,
00537                       <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>,
00538                       0,
00539                       0,
00540                       bm.bmWidth,
00541                       bm.bmHeight,
00542                       SRCCOPY,
00543                       0);
00544 
00545         <span class="comment">/*</span>
00546 <span class="comment">         * Restore palettes.</span>
00547 <span class="comment">         */</span>
00548         <span class="keywordflow">if</span> (hpal) {
00549             <a class="code" href="../../d4/d1/userk_8h.html#a1103">_SelectPalette</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a193">ghdcMem2</a>, hpalDst, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00550             <a class="code" href="../../d4/d1/userk_8h.html#a1103">_SelectPalette</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>, hpalSrc, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00551         }
00552 
00553         <span class="comment">/*</span>
00554 <span class="comment">         * Restore the surfaces.</span>
00555 <span class="comment">         */</span>
00556         GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a193">ghdcMem2</a>, hbmDst);
00557         GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>, hbmSrc);
00558         GreDeleteObject(hbmOld);
00559 
00560         GreSetBitmapOwner(hbmNew, OBJECT_OWNER_PUBLIC);
00561 
00562     } <span class="keywordflow">else</span> {
00563         hbmNew = hbmOld;
00564     }
00565 
00566     <span class="keywordflow">return</span> hbmNew;
00567 }
00568 
00569 <span class="comment">/***************************************************************************\</span>
00570 <span class="comment">* CreatePaletteFromBitmap</span>
00571 <span class="comment">*</span>
00572 <span class="comment">* Take in a REAL dib handle and create a palette from it.  This will not</span>
00573 <span class="comment">* work for bitmaps created by any other means than CreateDIBSection or</span>
00574 <span class="comment">* CreateDIBitmap(CBM_CREATEDIB).  This is due to the fact that these are</span>
00575 <span class="comment">* the only two formats who have palettes stored with their object.</span>
00576 <span class="comment">*</span>
00577 <span class="comment">* History:</span>
00578 <span class="comment">* 29-Sep-1995 ChrisWil  Created.</span>
00579 <span class="comment">\***************************************************************************/</span>
00580 
<a name="l00581"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a26">00581</a> HPALETTE <a class="code" href="../../d1/d3/dtbitmap_8c.html#a26">CreatePaletteFromBitmap</a>(
00582     HBITMAP hbm)
00583 {
00584     HPALETTE     hpal;
00585     LPLOGPALETTE ppal;
00586     HBITMAP      hbmT;
00587     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>        size;
00588     <span class="keywordtype">int</span>          i;
00589 
00590     <span class="comment">/*</span>
00591 <span class="comment">     * Make room for temp logical palette of max size.</span>
00592 <span class="comment">     */</span>
00593     size = <span class="keyword">sizeof</span>(LOGPALETTE) + (<a class="code" href="../../d1/d3/dtbitmap_8c.html#a0">MAXPAL</a> * <span class="keyword">sizeof</span>(PALETTEENTRY));
00594 
00595     ppal = (LPLOGPALETTE)UserAllocPool(size, TAG_SYSTEM);
00596     <span class="keywordflow">if</span> (!ppal)
00597         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00598 
00599     <span class="comment">/*</span>
00600 <span class="comment">     * Retrieve the palette from the DIB(Section).  The method of calling</span>
00601 <span class="comment">     * GreGetDIBColorTable() can only be done on sections or REAL-Dibs.</span>
00602 <span class="comment">     */</span>
00603     hbmT = GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>, hbm);
00604     ppal-&gt;palVersion    = 0x300;
00605     ppal-&gt;palNumEntries = (WORD)GreGetDIBColorTable(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>,
00606                                               0,
00607                                               <a class="code" href="../../d1/d3/dtbitmap_8c.html#a0">MAXPAL</a>,
00608                                               (LPRGBQUAD)ppal-&gt;palPalEntry);
00609     GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>, hbmT);
00610 
00611     <span class="comment">/*</span>
00612 <span class="comment">     * Create a halftone-palette if their are no entries.  Otherwise,</span>
00613 <span class="comment">     * swap the RGB values to be palentry-compatible and create us a</span>
00614 <span class="comment">     * palette.</span>
00615 <span class="comment">     */</span>
00616     <span class="keywordflow">if</span> (ppal-&gt;palNumEntries == 0) {
00617         hpal = GreCreateHalftonePalette(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o3">hdcScreen</a>);
00618     } <span class="keywordflow">else</span> {
00619 
00620         <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> tmpR;
00621 
00622         <span class="comment">/*</span>
00623 <span class="comment">         * Swap red/blue because a RGBQUAD and PALETTEENTRY dont get along.</span>
00624 <span class="comment">         */</span>
00625         <span class="keywordflow">for</span> (i=0; i &lt; (<span class="keywordtype">int</span>)ppal-&gt;palNumEntries; i++) {
00626             tmpR                         = ppal-&gt;palPalEntry[i].peRed;
00627             ppal-&gt;palPalEntry[i].peRed   = ppal-&gt;palPalEntry[i].peBlue;
00628             ppal-&gt;palPalEntry[i].peBlue  = tmpR;
00629             ppal-&gt;palPalEntry[i].peFlags = 0;
00630         }
00631 
00632         <span class="comment">/*</span>
00633 <span class="comment">         * If the Bitmap only has VGA colors in it we dont want to</span>
00634 <span class="comment">         * use a palette.  It just causes unessesary palette flashes.</span>
00635 <span class="comment">         */</span>
00636         hpal = <a class="code" href="../../d1/d3/dtbitmap_8c.html#a23">TestVGAColors</a>(ppal) ? <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> : GreCreatePalette(ppal);
00637     }
00638 
00639     UserFreePool(ppal);
00640 
00641     <span class="comment">/*</span>
00642 <span class="comment">     * Make this palette public.</span>
00643 <span class="comment">     */</span>
00644     <span class="keywordflow">if</span> (hpal)
00645         GreSetPaletteOwner(hpal, OBJECT_OWNER_PUBLIC);
00646 
00647     <span class="keywordflow">return</span> hpal;
00648 }
00649 
00650 <span class="comment">/***************************************************************************\</span>
00651 <span class="comment">* TileWallpaper</span>
00652 <span class="comment">*</span>
00653 <span class="comment">* History:</span>
00654 <span class="comment">* 29-Jul-1991 MikeKe    From win31</span>
00655 <span class="comment">\***************************************************************************/</span>
00656 
00657 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00658"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a27">00658</a> <a class="code" href="../../d1/d3/dtbitmap_8c.html#a27">TileWallpaper</a>(HDC hdc, LPCRECT lprc, BOOL fOffset)
00659 {
00660     <span class="keywordtype">int</span>     xO;
00661     <span class="keywordtype">int</span>     yO;
00662     <span class="keywordtype">int</span>     x;
00663     <span class="keywordtype">int</span>     y;
00664     BITMAP  bm;
00665     HBITMAP hbmT = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00666     POINT   ptOffset;
00667 
00668     <span class="keywordflow">if</span> (fOffset) {
00669         ptOffset.x = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a3">gsrcWallpaper</a>.<a class="code" href="../../d6/d6/structtagSIZERECT.html#o0">x</a>;
00670         ptOffset.y = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a3">gsrcWallpaper</a>.<a class="code" href="../../d6/d6/structtagSIZERECT.html#o1">y</a>;
00671     } <span class="keywordflow">else</span> {
00672         ptOffset.x = 0;
00673         ptOffset.y = 0;
00674     }
00675 
00676     <span class="comment">/*</span>
00677 <span class="comment">     * We need to get the dimensions of the bitmap here rather than rely on</span>
00678 <span class="comment">     * the dimensions in srcWallpaper because this function may</span>
00679 <span class="comment">     * be called as part of ExpandBitmap, before srcWallpaper is</span>
00680 <span class="comment">     * set.</span>
00681 <span class="comment">     */</span>
00682     <span class="keywordflow">if</span> (GreExtGetObjectW(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a1">ghbmWallpaper</a>, <span class="keyword">sizeof</span>(BITMAP), (PBITMAP)&amp;bm)) {
00683         xO = lprc-&gt;left - (lprc-&gt;left % bm.bmWidth) + (ptOffset.x % bm.bmWidth);
00684         <span class="keywordflow">if</span> (xO &gt; lprc-&gt;left) {
00685             xO -= bm.bmWidth;
00686         }
00687 
00688         yO = lprc-&gt;top - (lprc-&gt;top % bm.bmHeight) + (ptOffset.y % bm.bmHeight);
00689         <span class="keywordflow">if</span> (yO &gt; lprc-&gt;top) {
00690             yO -= bm.bmHeight;
00691         }
00692 
00693         <span class="comment">/*</span>
00694 <span class="comment">         *  Tile the bitmap to the surface.</span>
00695 <span class="comment">         */</span>
00696         <span class="keywordflow">if</span> (hbmT = GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a1">ghbmWallpaper</a>)) {
00697             <span class="keywordflow">for</span> (y = yO; y &lt; lprc-&gt;bottom; y += bm.bmHeight) {
00698                 <span class="keywordflow">for</span> (x = xO; x &lt; lprc-&gt;right; x += bm.bmWidth) {
00699                     GreBitBlt(hdc,
00700                               x,
00701                               y,
00702                               bm.bmWidth,
00703                               bm.bmHeight,
00704                               <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>,
00705                               0,
00706                               0,
00707                               SRCCOPY,
00708                               0);
00709                 }
00710             }
00711 
00712             GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>, hbmT);
00713         }
00714     }
00715 
00716     <span class="keywordflow">return</span> (hbmT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00717 }
00718 
00719 <span class="comment">/***************************************************************************\</span>
00720 <span class="comment">* GetWallpaperCenterRect</span>
00721 <span class="comment">*</span>
00722 <span class="comment">* Returns the rect of centered wallpaper on a particular monitor.</span>
00723 <span class="comment">*</span>
00724 <span class="comment">* History:</span>
00725 <span class="comment">* 26-Sep-1996 adams     Created.</span>
00726 <span class="comment">\***************************************************************************/</span>
00727 
00728 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00729"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a28">00729</a> <a class="code" href="../../d1/d3/dtbitmap_8c.html#a28">GetWallpaperCenterRect</a>(LPRECT lprc, LPPOINT lppt, LPCRECT lprcMonitor)
00730 {
00731     RECT rc;
00732 
00733 
00734     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a3">gsrcWallpaper</a>.<a class="code" href="../../d6/d6/structtagSIZERECT.html#o0">x</a> != 0 || <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a3">gsrcWallpaper</a>.<a class="code" href="../../d6/d6/structtagSIZERECT.html#o1">y</a> != 0) {
00735         rc.left = lprcMonitor-&gt;left + <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a3">gsrcWallpaper</a>.<a class="code" href="../../d6/d6/structtagSIZERECT.html#o0">x</a>;
00736         rc.top = lprcMonitor-&gt;top + <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a3">gsrcWallpaper</a>.<a class="code" href="../../d6/d6/structtagSIZERECT.html#o1">y</a>;
00737     } <span class="keywordflow">else</span> {
00738         rc.left = (lprcMonitor-&gt;left + lprcMonitor-&gt;right - <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a3">gsrcWallpaper</a>.<a class="code" href="../../d6/d6/structtagSIZERECT.html#o2">cx</a>) / 2;
00739         rc.top = (lprcMonitor-&gt;top + lprcMonitor-&gt;bottom - <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a3">gsrcWallpaper</a>.<a class="code" href="../../d6/d6/structtagSIZERECT.html#o3">cy</a>) / 2;
00740     }
00741 
00742     rc.right  = rc.left + <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a3">gsrcWallpaper</a>.<a class="code" href="../../d6/d6/structtagSIZERECT.html#o2">cx</a>;
00743     rc.bottom = rc.top + <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a3">gsrcWallpaper</a>.<a class="code" href="../../d6/d6/structtagSIZERECT.html#o3">cy</a>;
00744 
00745     lppt-&gt;x = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(0, lprcMonitor-&gt;left - rc.left);
00746     lppt-&gt;y = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(0, lprcMonitor-&gt;top - rc.top);
00747 
00748     <span class="keywordflow">return</span> <a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(lprc, &amp;rc, lprcMonitor);
00749 }
00750 
00751 
00752 
00753 <span class="comment">/***************************************************************************\</span>
00754 <span class="comment">* CenterWallpaper</span>
00755 <span class="comment">*</span>
00756 <span class="comment">*</span>
00757 <span class="comment">* History:</span>
00758 <span class="comment">* 29-Jul-1991 MikeKe    From win31</span>
00759 <span class="comment">\***************************************************************************/</span>
00760 
00761 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00762"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a29">00762</a> <a class="code" href="../../d1/d3/dtbitmap_8c.html#a29">CenterWallpaper</a>(HDC hdc, LPCRECT lprcMonitor)
00763 {
00764     RECT    rc;
00765     HBITMAP hbmT;
00766     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    f = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00767     HRGN    hrgn;
00768     POINT   pt;
00769 
00770     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d3/dtbitmap_8c.html#a28">GetWallpaperCenterRect</a>(&amp;rc, &amp;pt, lprcMonitor)) {
00771         <span class="comment">/*</span>
00772 <span class="comment">         * This used to call TileWallpaper, but this really</span>
00773 <span class="comment">         * slowed up the system for small dimension bitmaps.</span>
00774 <span class="comment">         * We really only need to blt it once for centered</span>
00775 <span class="comment">         * bitmaps.</span>
00776 <span class="comment">         */</span>
00777         <span class="keywordflow">if</span> (hbmT = GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a1">ghbmWallpaper</a>)) {
00778 
00779             GreBitBlt(hdc,
00780                       rc.left,
00781                       rc.top,
00782                       rc.right - rc.left,
00783                       rc.bottom - rc.top,
00784                       <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>,
00785                       pt.x,
00786                       pt.y,
00787                       SRCCOPY,
00788                       0);
00789 
00790             GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>, hbmT);
00791         } <span class="keywordflow">else</span> {
00792             f = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00793         }
00794     }
00795 
00796     <span class="comment">/*</span>
00797 <span class="comment">     * Fill the bacground (excluding the bitmap) with the desktop</span>
00798 <span class="comment">     * brush.  Save the DC with the cliprect.</span>
00799 <span class="comment">     */</span>
00800     <span class="keywordflow">if</span> (hrgn = <a class="code" href="../../d4/d1/userk_8h.html#a1162">CreateEmptyRgn</a>()) {
00801         <span class="keywordflow">if</span> (GreGetRandomRgn(hdc, hrgn, 1) != -1) {
00802             GreExcludeClipRect(hdc, rc.left, rc.top, rc.right, rc.bottom);
00803             <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a3">FillRect</a>(hdc, lprcMonitor, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a22">SYSHBR</a>(<a class="code" href="../../d0/d3/structtagDESKTOP.html">DESKTOP</a>));
00804             GreExtSelectClipRgn(hdc, hrgn, RGN_COPY);
00805         } <span class="keywordflow">else</span> {
00806             f = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00807         }
00808 
00809         GreDeleteObject(hrgn);
00810     } <span class="keywordflow">else</span> {
00811         f = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00812     }
00813 
00814     <span class="keywordflow">return</span> f;
00815 }
00816 
00817 <span class="comment">/***************************************************************************\</span>
00818 <span class="comment">* xxxDrawWallpaper</span>
00819 <span class="comment">*</span>
00820 <span class="comment">* Performs the drawing of the wallpaper.  This can be either tiled or</span>
00821 <span class="comment">* centered.  This routine provides the common things like palette-handling.</span>
00822 <span class="comment">* If the (fPaint) is false, then we only to palette realization and no</span>
00823 <span class="comment">* drawing.</span>
00824 <span class="comment">*</span>
00825 <span class="comment">* History:</span>
00826 <span class="comment">* 01-Oct-1995 ChrisWil  Ported.</span>
00827 <span class="comment">\***************************************************************************/</span>
00828 
<a name="l00829"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a30">00829</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d1/d3/dtbitmap_8c.html#a30">xxxDrawWallpaper</a>(
00830     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwnd,
00831     HDC         hdc,
00832     <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>    pMonitorPaint,
00833     LPCRECT     lprc)
00834 {
00835     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        f;
00836     HPALETTE    hpalT;
00837     <span class="keywordtype">int</span>         i;
00838 
00839     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00840     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pMonitorPaint);
00841     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a1">ghbmWallpaper</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00842     UserAssert(lprc);
00843 
00844     <span class="comment">/*</span>
00845 <span class="comment">     * Select in the palette if one exists.  As a wallpaper, we should only</span>
00846 <span class="comment">     * be able to do background-realizations.</span>
00847 <span class="comment">     */</span>
00848     <span class="keywordflow">if</span> (    <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a2">ghpalWallpaper</a> &amp;&amp;
00849             pMonitorPaint-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o2">dwMONFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a526">MONF_PALETTEDISPLAY</a>) {
00850 
00851         hpalT = <a class="code" href="../../d4/d1/userk_8h.html#a1103">_SelectPalette</a>(hdc, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a2">ghpalWallpaper</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00852         i = <a class="code" href="../../d4/d1/userk_8h.html#a1104">xxxRealizePalette</a>(hdc);
00853     } <span class="keywordflow">else</span> {
00854         hpalT = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00855     }
00856 
00857     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a4">gwWPStyle</a> &amp; DTF_TILE) {
00858         f = <a class="code" href="../../d1/d3/dtbitmap_8c.html#a27">TileWallpaper</a>(hdc, lprc, pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00859     } <span class="keywordflow">else</span> {
00860         f = <a class="code" href="../../d1/d3/dtbitmap_8c.html#a29">CenterWallpaper</a>(hdc, &amp;pMonitorPaint-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>);
00861     }
00862 
00863     <span class="keywordflow">if</span> (hpalT) {
00864         <a class="code" href="../../d4/d1/userk_8h.html#a1103">_SelectPalette</a>(hdc, hpalT, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00865     }
00866 
00867     <span class="keywordflow">return</span> f;
00868 }
00869 
00870 <span class="comment">/***************************************************************************\</span>
00871 <span class="comment">* xxxExpandBitmap</span>
00872 <span class="comment">*</span>
00873 <span class="comment">* Expand this bitmap to fit the screen.  This is used for tiled images</span>
00874 <span class="comment">* only.</span>
00875 <span class="comment">*</span>
00876 <span class="comment">* History:</span>
00877 <span class="comment">* 29-Sep-1995 ChrisWil  Ported from Chicago.</span>
00878 <span class="comment">\***************************************************************************/</span>
00879 
<a name="l00880"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a31">00880</a> HBITMAP <a class="code" href="../../d1/d3/dtbitmap_8c.html#a31">xxxExpandBitmap</a>(
00881     HBITMAP hbm)
00882 {
00883     <span class="keywordtype">int</span>         nx;
00884     <span class="keywordtype">int</span>         ny;
00885     BITMAP      bm;
00886     HBITMAP     hbmNew;
00887     HBITMAP     hbmD;
00888     LPRECT      lprc;
00889     RECT        rc;
00890     <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>    pMonitor;
00891     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlpMonitor;
00892 
00893 
00894     <span class="comment">/*</span>
00895 <span class="comment">     * Get the dimensions of the screen and bitmap we'll</span>
00896 <span class="comment">     * be dealing with.  We'll adjust the xScreen/yScreen</span>
00897 <span class="comment">     * to reflect the new surface size.  The default adjustment</span>
00898 <span class="comment">     * is to stretch the image to fit the screen.</span>
00899 <span class="comment">     */</span>
00900     GreExtGetObjectW(hbm, <span class="keyword">sizeof</span>(bm), (PBITMAP)&amp;bm);
00901 
00902     pMonitor = <a class="code" href="../../d6/d0/usercli_8h.html#a793">GetPrimaryMonitor</a>();
00903     lprc = &amp;pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>;
00904     nx = (lprc-&gt;right / <a class="code" href="../../d1/d3/dtbitmap_8c.html#a2">TILE_XMINSIZE</a>) / bm.bmWidth;
00905     ny = (lprc-&gt;bottom / <a class="code" href="../../d1/d3/dtbitmap_8c.html#a3">TILE_YMINSIZE</a>) / bm.bmHeight;
00906 
00907     <span class="keywordflow">if</span> (nx == 0)
00908         nx++;
00909 
00910     <span class="keywordflow">if</span> (ny == 0)
00911         ny++;
00912 
00913     <span class="keywordflow">if</span> ((nx + ny) &lt;= 2)
00914         <span class="keywordflow">return</span> hbm;
00915 
00916 
00917     <span class="comment">/*</span>
00918 <span class="comment">     * Create the surface for the new-bitmap.</span>
00919 <span class="comment">     */</span>
00920     rc.left = rc.top = 0;
00921     rc.right = nx * bm.bmWidth;
00922     rc.bottom = ny * bm.bmHeight;
00923     hbmD = GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>, hbm);
00924     hbmNew = GreCreateCompatibleBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>, rc.right, rc.bottom);
00925     GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a192">ghdcMem</a>, hbmD);
00926 
00927     <span class="keywordflow">if</span> (hbmNew == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00928         <span class="keywordflow">return</span> hbm;
00929 
00930     <span class="keywordflow">if</span> (hbmD = GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a193">ghdcMem2</a>, hbmNew)) {
00931         <span class="comment">/*</span>
00932 <span class="comment">         * Expand the bitmap to the new surface.</span>
00933 <span class="comment">         */</span>
00934         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pMonitor, &amp;tlpMonitor);
00935         <a class="code" href="../../d1/d3/dtbitmap_8c.html#a30">xxxDrawWallpaper</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a193">ghdcMem2</a>, pMonitor, &amp;rc);
00936         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpMonitor);
00937         GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a193">ghdcMem2</a>, hbmD);
00938     }
00939 
00940     GreDeleteObject(hbm);
00941 
00942     GreSetBitmapOwner(hbmNew, OBJECT_OWNER_PUBLIC);
00943 
00944     <span class="keywordflow">return</span> hbmNew;
00945 }
00946 
00947 <span class="comment">/***************************************************************************\</span>
00948 <span class="comment">* xxxLoadDesktopWallpaper</span>
00949 <span class="comment">*</span>
00950 <span class="comment">* Load the dib (section) from the client-side.  We make this callback to</span>
00951 <span class="comment">* utilize code in USER32 for loading/creating a dib or section.  Since,</span>
00952 <span class="comment">* the wallpaper-code can be called from any-process, we can't use DIBSECTIONS</span>
00953 <span class="comment">* for a wallpaper.  Luckily we can use Real-DIBs for this.  That way we</span>
00954 <span class="comment">* can extract out a palette from the bitmap.  We couldn't do this if the</span>
00955 <span class="comment">* bitmap was created "compatible".</span>
00956 <span class="comment">*</span>
00957 <span class="comment">* History:</span>
00958 <span class="comment">* 29-Sep-1995 ChrisWil  Created.</span>
00959 <span class="comment">\***************************************************************************/</span>
00960 
<a name="l00961"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a32">00961</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d1/d3/dtbitmap_8c.html#a32">xxxLoadDesktopWallpaper</a>(
00962     LPWSTR lpszFile)
00963 {
00964     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>           LR_flags;
00965     <span class="keywordtype">int</span>            dxDesired;
00966     <span class="keywordtype">int</span>            dyDesired;
00967     BITMAP         bm;
00968     UNICODE_STRING strName;
00969 
00970 
00971     <span class="comment">/*</span>
00972 <span class="comment">     * If the bitmap is somewhat large (big bpp), then we'll deal</span>
00973 <span class="comment">     * with it as a real-dib.  We'll also do this for 8bpp since it</span>
00974 <span class="comment">     * can utilize a palette.  Chicago uses DIBSECTIONS since it can</span>
00975 <span class="comment">     * count on the one-process handling the drawing.  Since, NT can</span>
00976 <span class="comment">     * have different processes doing the drawing, we can't use sections.</span>
00977 <span class="comment">     */</span>
00978     LR_flags = LR_LOADFROMFILE;
00979 
00980     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o19">fAnyPalette</a> || <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;BitCount &gt;= 8) {
00981         LR_flags |= LR_CREATEREALDIB;
00982     }
00983 
00984 
00985     <span class="comment">/*</span>
00986 <span class="comment">     * If we're stretching, then we will ask the loaddib code to do</span>
00987 <span class="comment">     * it.</span>
00988 <span class="comment">     */</span>
00989     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a4">gwWPStyle</a> &amp; DTF_STRETCH) {
00990         <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>    pMonitor;
00991         <span class="keywordtype">int</span>         dxMonitor, dyMonitor;
00992 
00993         dxDesired = INT_MAX;
00994         dyDesired = INT_MAX;
00995         <span class="keywordflow">for</span> (   pMonitor = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o13">pMonitorFirst</a>;
00996                 pMonitor;
00997                 pMonitor = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o1">pMonitorNext</a>) {
00998 
00999             <span class="keywordflow">if</span> (!(pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o2">dwMONFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a525">MONF_VISIBLE</a>))
01000                 <span class="keywordflow">continue</span>;
01001 
01002             dxMonitor = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.right - pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.left;
01003             dxDesired = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(dxDesired, dxMonitor);
01004             dyMonitor = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.bottom - pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.top;
01005             dyDesired = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(dyDesired, dyMonitor);
01006         }
01007     } <span class="keywordflow">else</span> {
01008         dxDesired = dyDesired = 0;
01009     }
01010 
01011     <span class="comment">/*</span>
01012 <span class="comment">     * Make a callback to the client to perform the loading.</span>
01013 <span class="comment">     * Saves us some code.</span>
01014 <span class="comment">     */</span>
01015     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strName, lpszFile);
01016 
01017     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a1">ghbmWallpaper</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1007">xxxClientLoadImage</a>(
01018             &amp;strName,
01019             0,
01020             IMAGE_BITMAP,
01021             dxDesired,
01022             dyDesired,
01023             LR_flags,
01024             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01025 
01026     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a1">ghbmWallpaper</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01027         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01028 
01029     <span class="comment">/*</span>
01030 <span class="comment">     * If it's a palette-display, then we will derive the global</span>
01031 <span class="comment">     * wallpaper palette from the bitmap.</span>
01032 <span class="comment">     */</span>
01033     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o19">fAnyPalette</a>) {
01034         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a2">ghpalWallpaper</a> = <a class="code" href="../../d1/d3/dtbitmap_8c.html#a26">CreatePaletteFromBitmap</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a1">ghbmWallpaper</a>);
01035     }
01036 
01037     <span class="comment">/*</span>
01038 <span class="comment">     * If the DIB is a higher bitdepth than the display, convert it to</span>
01039 <span class="comment">     * a DDB, otherwise keep it as DIB.  This way it takes the least</span>
01040 <span class="comment">     * amount of memory and provides a identity-translation blt.</span>
01041 <span class="comment">     *</span>
01042 <span class="comment">     */</span>
01043     GreExtGetObjectW(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a1">ghbmWallpaper</a>, <span class="keyword">sizeof</span>(bm), &amp;bm);
01044 
01045     <span class="keywordflow">if</span> (    <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o11">cMonitors</a> == 1 &amp;&amp;
01046             <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;BitCount &lt;= bm.bmPlanes * bm.bmBitsPixel) {
01047 
01048         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a1">ghbmWallpaper</a> = <a class="code" href="../../d1/d3/dtbitmap_8c.html#a25">ConvertToDDB</a>(
01049                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o3">hdcScreen</a>,
01050                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a1">ghbmWallpaper</a>,
01051                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a2">ghpalWallpaper</a>);
01052     }
01053 
01054     <span class="comment">/*</span>
01055 <span class="comment">     * Expand bitmap if we are going to tile it.  Mark the bitmap</span>
01056 <span class="comment">     * as public, so any process can party with it.  This must</span>
01057 <span class="comment">     * preceed the expand, since it performs a xxxDrawWallpaper</span>
01058 <span class="comment">     * call that can leave the section.</span>
01059 <span class="comment">     */</span>
01060     GreSetBitmapOwner(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a1">ghbmWallpaper</a>, OBJECT_OWNER_PUBLIC);
01061 
01062     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a4">gwWPStyle</a> &amp; DTF_TILE) {
01063         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a1">ghbmWallpaper</a> = <a class="code" href="../../d1/d3/dtbitmap_8c.html#a31">xxxExpandBitmap</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a1">ghbmWallpaper</a>);
01064     }
01065 
01066     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01067 }
01068 
01069 <span class="comment">/***************************************************************************\</span>
01070 <span class="comment">* xxxSetDeskWallpaper</span>
01071 <span class="comment">*</span>
01072 <span class="comment">* Sets the desktop-wallpaper.  This deletes the old handles in the process.</span>
01073 <span class="comment">*</span>
01074 <span class="comment">* History:</span>
01075 <span class="comment">* 29-Jul-1991 MikeKe    From win31.</span>
01076 <span class="comment">* 01-Oct-1995 ChrisWil  Rewrote for LoadImage().</span>
01077 <span class="comment">\***************************************************************************/</span>
01078 
<a name="l01079"></a><a class="code" href="../../d4/d1/userk_8h.html#a1186">01079</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1186">xxxSetDeskWallpaper</a>(PUNICODE_STRING pProfileUserName,
01080     LPWSTR lpszFile)
01081 {
01082     BITMAP       bm;
01083     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>         WallpaperStyle2;
01084     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>         pwndShell;
01085     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>           tl;
01086     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>  ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01087     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>     pdesk;
01088     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>         fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01089     HBITMAP      hbmOld;
01090 
01091     <a class="code" href="../../d0/d4/structtagPROFINTINFO.html">PROFINTINFO</a>  apsi[] = {
01092         {<a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>, (LPWSTR)STR_TILEWALL , 0, &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a4">gwWPStyle</a>    },
01093         {<a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>, (LPWSTR)STR_DTSTYLE  , 0, &amp;WallpaperStyle2   },
01094         {<a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>, (LPWSTR)STR_DTORIGINX, 0, &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a3">gsrcWallpaper</a>.<a class="code" href="../../d6/d6/structtagSIZERECT.html#o0">x</a> },
01095         {<a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>, (LPWSTR)STR_DTORIGINY, 0, &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a3">gsrcWallpaper</a>.<a class="code" href="../../d6/d6/structtagSIZERECT.html#o1">y</a> },
01096         {0,            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                  0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>               }
01097     };
01098 
01099     pdesk = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>;
01100     hbmOld = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a1">ghbmWallpaper</a>;
01101 
01102     <span class="comment">/*</span>
01103 <span class="comment">     * Get the shell-window.  This could be NULL on system</span>
01104 <span class="comment">     * initialization.  We will use this to do palette realization.</span>
01105 <span class="comment">     */</span>
01106     pwndShell = (pdesk ? pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o5">spwndShell</a> : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01107 
01108     <span class="keywordflow">if</span> ((lpszFile == SETWALLPAPER_METRICS) &amp;&amp; !(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a4">gwWPStyle</a> &amp; DTF_STRETCH)) {
01109 
01110         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a3">gsrcWallpaper</a>.<a class="code" href="../../d6/d6/structtagSIZERECT.html#o0">x</a> = 0;
01111         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a3">gsrcWallpaper</a>.<a class="code" href="../../d6/d6/structtagSIZERECT.html#o1">y</a> = 0;
01112 
01113         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a1">ghbmWallpaper</a>)
01114             <span class="keywordflow">goto</span> CreateNewWallpaper;
01115 
01116         <span class="keywordflow">goto</span> Metric_Change;
01117     }
01118 
01119 CreateNewWallpaper:
01120 
01121     <span class="comment">/*</span>
01122 <span class="comment">     * Delete the old wallpaper and palette if the exist.</span>
01123 <span class="comment">     */</span>
01124     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a2">ghpalWallpaper</a>) {
01125         GreDeleteObject(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a2">ghpalWallpaper</a>);
01126         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a2">ghpalWallpaper</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01127     }
01128 
01129     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a1">ghbmWallpaper</a>) {
01130         GreDeleteObject(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a1">ghbmWallpaper</a>);
01131         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a1">ghbmWallpaper</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01132     }
01133 
01134     <span class="comment">/*</span>
01135 <span class="comment">     * Kill any SPBs no matter what.</span>
01136 <span class="comment">     * Works if we're switching from/to palettized wallpaper.</span>
01137 <span class="comment">     * Fixes a lot of problems because palette doesn't change, shell</span>
01138 <span class="comment">     * paints funny on desktop, etc.</span>
01139 <span class="comment">     */</span>
01140     <a class="code" href="../../d1/d4/spb_8c.html#a12">FreeAllSpbs</a>();
01141 
01142     <span class="comment">/*</span>
01143 <span class="comment">     * If this is a metric-change (and stretched), then we need to</span>
01144 <span class="comment">     * reload it.  However, since we are called from the winlogon process</span>
01145 <span class="comment">     * during a desktop-switch, we would be mapped to the wrong Luid</span>
01146 <span class="comment">     * when we attempt to grab the name from GetDeskWallpaperName.  This</span>
01147 <span class="comment">     * would use the Luid from the DEFAULT user rather than the current</span>
01148 <span class="comment">     * logged on user.  In order to avoid this, we cache the wallpaer</span>
01149 <span class="comment">     * name so that on METRIC-CHANGES we use the current-user's wallpaper.</span>
01150 <span class="comment">     *</span>
01151 <span class="comment">     * NOTE: we assume that prior to any METRIC change, we have already</span>
01152 <span class="comment">     * setup the ghbmWallpaper and lpszCached.  This is usually done</span>
01153 <span class="comment">     * either on logon or during user desktop-changes through conrol-Panel.</span>
01154 <span class="comment">     */</span>
01155     <span class="keywordflow">if</span> (lpszFile == SETWALLPAPER_METRICS) {
01156 
01157         UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a6">gpszWall</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01158 
01159         <span class="keywordflow">goto</span> LoadWallpaper;
01160     }
01161 
01162     <span class="comment">/*</span>
01163 <span class="comment">     * Free the cached handle.</span>
01164 <span class="comment">     */</span>
01165     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a6">gpszWall</a>) {
01166         UserFreePool(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a6">gpszWall</a>);
01167         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a6">gpszWall</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01168     }
01169 
01170     <span class="comment">/*</span>
01171 <span class="comment">     * Load the wallpaper-name.  If this returns FALSE, then</span>
01172 <span class="comment">     * the user specified (None).  We will return true to force</span>
01173 <span class="comment">     * the repainting of the desktop.</span>
01174 <span class="comment">     */</span>
01175     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a6">gpszWall</a> = <a class="code" href="../../d1/d3/dtbitmap_8c.html#a22">GetDeskWallpaperName</a>(pProfileUserName,lpszFile);
01176     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a6">gpszWall</a>) {
01177         fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01178         <span class="keywordflow">goto</span> SDW_Exit;
01179     }
01180 
01181     <span class="comment">/*</span>
01182 <span class="comment">     * Retrieve the default settings from the registry.</span>
01183 <span class="comment">     *</span>
01184 <span class="comment">     * If tile is indicated, then normalize style to not include</span>
01185 <span class="comment">     * FIT/STRETCH which are center-only styles.  Likewise, if</span>
01186 <span class="comment">     * we are centered, then normalize out the TILE bit.</span>
01187 <span class="comment">     */</span>
01188     <a class="code" href="../../d4/d1/userk_8h.html#a2014">FastGetProfileIntsW</a>(pProfileUserName, apsi);
01189 
01190     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a4">gwWPStyle</a> &amp;= DTF_TILE;
01191     <span class="keywordflow">if</span> (!(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a4">gwWPStyle</a> &amp; DTF_TILE)) {
01192         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a4">gwWPStyle</a> = WallpaperStyle2 &amp; DTF_STRETCH;
01193     }
01194 
01195     <span class="comment">/*</span>
01196 <span class="comment">     * Load the wallpaper.  This makes a callback to the client to</span>
01197 <span class="comment">     * perform the bitmap-creation.</span>
01198 <span class="comment">     */</span>
01199 
01200 LoadWallpaper:
01201 
01202     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d3/dtbitmap_8c.html#a32">xxxLoadDesktopWallpaper</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a6">gpszWall</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01203         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a4">gwWPStyle</a> = 0;
01204         <span class="keywordflow">goto</span> SDW_Exit;
01205     }
01206 
01207     <span class="comment">/*</span>
01208 <span class="comment">     * If we have a palette, then we need to do the correct realization and</span>
01209 <span class="comment">     * notification.</span>
01210 <span class="comment">     */</span>
01211     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a2">ghpalWallpaper</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01212         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndSend;
01213 
01214         <span class="keywordflow">if</span> (pwndShell) {
01215             pwndSend = pwndShell;
01216         } <span class="keywordflow">else</span> {
01217             pwndSend = (pdesk ? pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a> : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01218         }
01219 
01220         <span class="comment">/*</span>
01221 <span class="comment">         * Update the desktop with the new bitmap.  This cleans</span>
01222 <span class="comment">         * out the system-palette so colors can be realized.</span>
01223 <span class="comment">         */</span>
01224         GreRealizeDefaultPalette(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o3">hdcScreen</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01225 
01226         <span class="comment">/*</span>
01227 <span class="comment">         * Don't broadcast if system initialization is occuring.  Otherwise</span>
01228 <span class="comment">         * this gives the shell first-crack at realizing its colors</span>
01229 <span class="comment">         * correctly.</span>
01230 <span class="comment">         */</span>
01231         <span class="keywordflow">if</span> (pwndSend) {
01232             HWND hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndSend);
01233 
01234             <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwndSend, &amp;tl);
01235             <a class="code" href="../../d4/d1/userk_8h.html#a1581">xxxSendNotifyMessage</a>(pwndSend, WM_PALETTECHANGED, (WPARAM)hwnd, 0);
01236             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tl);
01237         }
01238     }
01239 
01240 Metric_Change:
01241     <span class="keywordflow">if</span> (fRet = GreExtGetObjectW(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a1">ghbmWallpaper</a>, <span class="keyword">sizeof</span>(bm), (PBITMAP)&amp;bm)) {
01242         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a3">gsrcWallpaper</a>.<a class="code" href="../../d6/d6/structtagSIZERECT.html#o2">cx</a> = bm.bmWidth;
01243         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a3">gsrcWallpaper</a>.<a class="code" href="../../d6/d6/structtagSIZERECT.html#o3">cy</a> = bm.bmHeight;
01244     }
01245     <span class="comment">// fall-through</span>
01246 
01247 SDW_Exit:
01248 
01249     <span class="comment">/*</span>
01250 <span class="comment">     * Notify the shell-window that the wallpaper changed.</span>
01251 <span class="comment">     */</span>
01252     <span class="keywordflow">if</span> ((pwndShell != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01253         ((hbmOld &amp;&amp; !<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a1">ghbmWallpaper</a>) || (!hbmOld &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a1">ghbmWallpaper</a>))) {
01254 
01255         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwndShell, &amp;tl);
01256         <a class="code" href="../../d4/d1/userk_8h.html#a1581">xxxSendNotifyMessage</a>(pwndShell,
01257                              WM_SHELLNOTIFY,
01258                              SHELLNOTIFY_WALLPAPERCHANGED,
01259                              (LPARAM)<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a1">ghbmWallpaper</a>);
01260         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tl);
01261     }
01262 
01263     <span class="keywordflow">return</span> fRet;
01264 }
01265 
01266 
01267 <span class="comment">/***************************************************************************\</span>
01268 <span class="comment">* DesktopBuildPaint</span>
01269 <span class="comment">*</span>
01270 <span class="comment">* Draw the build information onto the desktop</span>
01271 <span class="comment">*</span>
01272 <span class="comment">* History:</span>
01273 <span class="comment">* 2/4/99    joejo - Bug 280256</span>
01274 <span class="comment">\***************************************************************************/</span>
<a name="l01275"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a34">01275</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d3/dtbitmap_8c.html#a34">DesktopBuildPaint</a>(
01276     HDC         hdc,
01277     <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>    pMonitor)
01278 {
01279     SIZE        size;
01280     <span class="keywordtype">int</span>         imode;
01281     <span class="keywordtype">int</span>         x;
01282     <span class="keywordtype">int</span>         y;
01283     COLORREF    oldColor;
01284     RECT        rcText1 = {0,0,0,0};
01285 
01286     HFONT       oldFont = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01287 
01288     PWCHAR pwszT = <a class="code" href="../../d1/d3/dtbitmap_8c.html#a16">wszProductName</a>;
01289 
01290     <span class="comment">/*</span>
01291 <span class="comment">     * Set up DC</span>
01292 <span class="comment">     */</span>
01293     imode = GreSetBkMode(hdc, TRANSPARENT);
01294 
01295     <span class="keywordflow">if</span> (GreGetBrushColor(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a22">SYSHBR</a>(BACKGROUND)) != 0x00ffffff) {
01296         oldColor = GreSetTextColor( hdc, RGB(255,255,255) );
01297     } <span class="keywordflow">else</span> {
01298         oldColor = GreSetTextColor( hdc, RGB(0,0,0) );
01299     }
01300 
01301 
01302     <span class="comment">/*</span>
01303 <span class="comment">     * Print Windows 2000 name</span>
01304 <span class="comment">     */</span>
01305     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a> &amp;&amp; <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;hCaptionFont) {
01306         oldFont = GreSelectFont(hdc, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;hCaptionFont);
01307     }
01308 
01309     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a7">gDrawVersionAlways</a>) {
01310         pwszT = (wcslen(<a class="code" href="../../d1/d3/dtbitmap_8c.html#a16">wszProductName</a>) &gt; wcslen(USER_SHARED_DATA-&gt;NtSystemRoot))?<a class="code" href="../../d1/d3/dtbitmap_8c.html#a16">wszProductName</a>:USER_SHARED_DATA-&gt;NtSystemRoot;
01311     }
01312 
01313     GreGetTextExtentW(
01314         hdc,
01315         pwszT,
01316         wcslen(pwszT),
01317         &amp;size,
01318         GGTE_WIN3_EXTENT);
01319 
01320     x = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.right - size.cx - 5;
01321     y = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.bottom -
01322             ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a7">gDrawVersionAlways</a>? 3: 2) * size.cy) - 5;
01323 
01324     rcText1.top = y;
01325     rcText1.bottom = rcText1.top + size.cy;
01326     rcText1.left = x;
01327     rcText1.right = rcText1.left + size.cx;
01328 
01329     <a class="code" href="../../d4/d1/userk_8h.html#a1135">GreSetTextAlign</a>(hdc, TA_RIGHT | TA_BOTTOM);
01330 
01331     GreExtTextOutW(
01332         hdc,
01333         rcText1.right,
01334         rcText1.bottom,
01335         0,
01336         &amp;rcText1,
01337         <a class="code" href="../../d1/d3/dtbitmap_8c.html#a16">wszProductName</a>,
01338         wcslen(<a class="code" href="../../d1/d3/dtbitmap_8c.html#a16">wszProductName</a>),
01339         (LPINT)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01340         );
01341 
01342 
01343     <span class="comment">/*</span>
01344 <span class="comment">     * Print Build Number</span>
01345 <span class="comment">     */</span>
01346     <span class="keywordflow">if</span> (oldFont != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a137">ghMenuFont</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01347         GreSelectFont(hdc, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a137">ghMenuFont</a>);
01348     }
01349 
01350     rcText1.top = rcText1.bottom + 1;
01351     rcText1.bottom = rcText1.top + size.cy;
01352 
01353     GreExtTextOutW(
01354         hdc,
01355         rcText1.right,
01356         rcText1.bottom,
01357         0,
01358         &amp;rcText1,
01359         <a class="code" href="../../d1/d3/dtbitmap_8c.html#a17">wszProductBuild</a>,
01360         wcslen(<a class="code" href="../../d1/d3/dtbitmap_8c.html#a17">wszProductBuild</a>),
01361         (LPINT)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01362         );
01363 
01364     <span class="comment">/*</span>
01365 <span class="comment">     * If we are in CHK mode, draw the System Dir Path</span>
01366 <span class="comment">     */</span>
01367     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a7">gDrawVersionAlways</a>) {
01368         rcText1.top = rcText1.bottom + 1;
01369         rcText1.bottom = rcText1.top + size.cy;
01370 
01371         GreExtTextOutW(
01372             hdc,
01373             rcText1.right,
01374             rcText1.bottom,
01375             0,
01376             &amp;rcText1,
01377             USER_SHARED_DATA-&gt;NtSystemRoot,
01378             wcslen(USER_SHARED_DATA-&gt;NtSystemRoot),
01379             (LPINT)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01380             );
01381     }
01382 
01383     <span class="keywordflow">if</span> (oldFont) {
01384         GreSelectFont(hdc, oldFont);
01385     }
01386 
01387     GreSetBkMode(hdc, imode);
01388     GreSetTextColor(hdc, oldColor);
01389 }
01390 
01391 <span class="comment">/***************************************************************************\</span>
01392 <span class="comment">* xxxDesktopPaintCallback</span>
01393 <span class="comment">*</span>
01394 <span class="comment">* Draw the wallpaper or fill with the background brush. In debug,</span>
01395 <span class="comment">* also draw the build number on the top of each monitor.</span>
01396 <span class="comment">*</span>
01397 <span class="comment">* History:</span>
01398 <span class="comment">* 20-Sep-1996 adams     Created.</span>
01399 <span class="comment">\***************************************************************************/</span>
01400 
01401 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l01402"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a35">01402</a> <a class="code" href="../../d1/d3/dtbitmap_8c.html#a35">xxxDesktopPaintCallback</a>(
01403     <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>        pMonitor,
01404     HDC             hdc,
01405     LPRECT          lprcMonitorClip,
01406     LPARAM          dwData)
01407 {
01408     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>            f;
01409     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>            pwnd;
01410 
01411     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pMonitor);
01412 
01413     pwnd = (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)dwData;
01414 
01415 
01416     <span class="keywordflow">if</span> (**((PULONG *)&amp;<a class="code" href="../../d8/d1/init_8h.html#a18">InitSafeBootMode</a>)) {
01417         <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a3">FillRect</a>(hdc, lprcMonitorClip, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1135">ghbrBlack</a> );
01418         f = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01419     } <span class="keywordflow">else</span> {
01420         <span class="comment">/*</span>
01421 <span class="comment">         * if this is the disconnected desktop, skip the bitmap paint</span>
01422 <span class="comment">         */</span>
01423         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a331">gbDesktopLocked</a>) {
01424 
01425             <span class="comment">/*</span>
01426 <span class="comment">             * Paint the desktop with a color or the wallpaper.</span>
01427 <span class="comment">             */</span>
01428             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a1">ghbmWallpaper</a>) {
01429                 f = <a class="code" href="../../d1/d3/dtbitmap_8c.html#a30">xxxDrawWallpaper</a>(
01430                         pwnd,
01431                         hdc,
01432                         pMonitor,
01433                         lprcMonitorClip);
01434             } <span class="keywordflow">else</span> {
01435                 <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a3">FillRect</a>(hdc, lprcMonitorClip, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a22">SYSHBR</a>(<a class="code" href="../../d0/d3/structtagDESKTOP.html">DESKTOP</a>));
01436                 f = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01437             }
01438         }
01439     }
01440 
01441     <span class="keywordflow">if</span> (**((PULONG *)&amp;<a class="code" href="../../d8/d1/init_8h.html#a18">InitSafeBootMode</a>)
01442             || <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a7">gDrawVersionAlways</a>
01443             || <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a358">gdwCanPaintDesktop</a>) {
01444         <span class="keyword">static</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fInit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01445         SIZE        size;
01446         <span class="keywordtype">int</span>         imode;
01447         COLORREF    oldColor;
01448         HFONT       oldFont = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01449 
01450 
01451         <span class="comment">/*</span>
01452 <span class="comment">         * Grab the stuff from the registry</span>
01453 <span class="comment">         */</span>
01454         <span class="keywordflow">if</span> (fInit) {
01455             <span class="keywordflow">if</span> (**((PULONG *)&amp;<a class="code" href="../../d8/d1/init_8h.html#a18">InitSafeBootMode</a>)) {
01456                 <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>( <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>, STR_SAFEMODE, <a class="code" href="../../d1/d3/dtbitmap_8c.html#a14">SafeModeStr</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(<a class="code" href="../../d1/d3/dtbitmap_8c.html#a14">SafeModeStr</a>) );
01457                 <a class="code" href="../../d1/d3/dtbitmap_8c.html#a15">SafeModeStrLen</a> = wcslen(<a class="code" href="../../d1/d3/dtbitmap_8c.html#a14">SafeModeStr</a>);
01458             }
01459             <a class="code" href="../../d1/d3/dtbitmap_8c.html#a20">GetVersionInfo</a>(**((PULONG *)&amp;<a class="code" href="../../d8/d1/init_8h.html#a18">InitSafeBootMode</a>) == 0);
01460             fInit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01461         }
01462 
01463         <span class="keywordflow">if</span> (**((PULONG *)&amp;<a class="code" href="../../d8/d1/init_8h.html#a18">InitSafeBootMode</a>)) {
01464             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;hCaptionFont != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01465                 oldFont = GreSelectFont(hdc, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;hCaptionFont);
01466             }
01467     
01468             GreGetTextExtentW(hdc, <a class="code" href="../../d1/d3/dtbitmap_8c.html#a13">wszT</a>, wcslen(<a class="code" href="../../d1/d3/dtbitmap_8c.html#a13">wszT</a>), &amp;size, GGTE_WIN3_EXTENT);
01469             imode = GreSetBkMode(hdc, TRANSPARENT);
01470 
01471             oldColor = GreSetTextColor( hdc, RGB(255,255,255) );
01472 
01473             GreExtTextOutW(
01474                 hdc,
01475                 (pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.left + pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.right - size.cx) / 2,
01476                 pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.top,
01477                 0,
01478                 (LPRECT)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01479                 <a class="code" href="../../d1/d3/dtbitmap_8c.html#a13">wszT</a>,
01480                 wcslen(<a class="code" href="../../d1/d3/dtbitmap_8c.html#a13">wszT</a>),
01481                 (LPINT)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01482                 );
01483 
01484             GreGetTextExtentW(hdc, <a class="code" href="../../d1/d3/dtbitmap_8c.html#a14">SafeModeStr</a>, <a class="code" href="../../d1/d3/dtbitmap_8c.html#a15">SafeModeStrLen</a>, &amp;size, GGTE_WIN3_EXTENT);
01485 
01486             GreExtTextOutW(
01487                 hdc,
01488                 pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.left,
01489                 pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.top,
01490                 0,
01491                 (LPRECT)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01492                 <a class="code" href="../../d1/d3/dtbitmap_8c.html#a14">SafeModeStr</a>,
01493                 <a class="code" href="../../d1/d3/dtbitmap_8c.html#a15">SafeModeStrLen</a>,
01494                 (LPINT)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01495                 );
01496 
01497             GreExtTextOutW(
01498                 hdc,
01499                 pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.right - size.cx,
01500                 pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.top,
01501                 0,
01502                 (LPRECT)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01503                 <a class="code" href="../../d1/d3/dtbitmap_8c.html#a14">SafeModeStr</a>,
01504                 <a class="code" href="../../d1/d3/dtbitmap_8c.html#a15">SafeModeStrLen</a>,
01505                 (LPINT)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01506                 );
01507 
01508             GreExtTextOutW(
01509                 hdc,
01510                 pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.right - size.cx,
01511                 pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.bottom - <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;tmSysFont.tmHeight,
01512                 0,
01513                 (LPRECT)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01514                 <a class="code" href="../../d1/d3/dtbitmap_8c.html#a14">SafeModeStr</a>,
01515                 <a class="code" href="../../d1/d3/dtbitmap_8c.html#a15">SafeModeStrLen</a>,
01516                 (LPINT)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01517                 );
01518 
01519             GreExtTextOutW(
01520                 hdc,
01521                 pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.left,
01522                 pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.bottom - <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;tmSysFont.tmHeight,
01523                 0,
01524                 (LPRECT)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01525                 <a class="code" href="../../d1/d3/dtbitmap_8c.html#a14">SafeModeStr</a>,
01526                 <a class="code" href="../../d1/d3/dtbitmap_8c.html#a15">SafeModeStrLen</a>,
01527                 (LPINT)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01528                 );
01529 
01530             GreSetBkMode(hdc, imode);
01531             GreSetTextColor(hdc, oldColor);
01532     
01533             <span class="keywordflow">if</span> (oldFont) {
01534                 GreSelectFont(hdc, oldFont);
01535             }
01536         } <span class="keywordflow">else</span> {
01537             <a class="code" href="../../d1/d3/dtbitmap_8c.html#a34">DesktopBuildPaint</a>(hdc, pMonitor);
01538         }
01539     }
01540 
01541     <span class="keywordflow">return</span> f;
01542 }
01543 
01544 
01545 
01546 <span class="comment">/***************************************************************************\</span>
01547 <span class="comment">* xxxInvalidateDesktopOnPaletteChange</span>
01548 <span class="comment">*</span>
01549 <span class="comment">* Invalidates the shell window and uncovered areas of the desktop</span>
01550 <span class="comment">* when the palette changes.</span>
01551 <span class="comment">*</span>
01552 <span class="comment">* History:</span>
01553 <span class="comment">* 28-Apr-1997 adams     Created.</span>
01554 <span class="comment">\***************************************************************************/</span>
01555 
01556 <span class="keywordtype">void</span>
<a name="l01557"></a><a class="code" href="../../d1/d3/dtbitmap_8c.html#a18">01557</a> <a class="code" href="../../d1/d3/dtbitmap_8c.html#a18">xxxInvalidateDesktopOnPaletteChange</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
01558 {
01559     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>    pdesk;
01560     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndShell;
01561     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlpwndShell;
01562     RECT        rc;
01563     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fRedrawDesktop;
01564 
01565     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
01566 
01567     <span class="comment">/*</span>
01568 <span class="comment">     * Invalidate the shell window.</span>
01569 <span class="comment">     */</span>
01570     pdesk = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;rpdesk;
01571     pwndShell = (pdesk) ? pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o5">spwndShell</a> : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01572     <span class="keywordflow">if</span> (!pwndShell) {
01573         fRedrawDesktop = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01574         rc = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;rcScreen;
01575     } <span class="keywordflow">else</span> {
01576         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwndShell, &amp;tlpwndShell);
01577         <a class="code" href="../../d4/d1/userk_8h.html#a1679">xxxRedrawWindow</a>(
01578                 pwndShell,
01579                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01580                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01581                 RDW_INVALIDATE | RDW_ERASE | RDW_ALLCHILDREN);
01582 
01583         <span class="comment">/*</span>
01584 <span class="comment">         * The shell window may not cover all of the desktop.</span>
01585 <span class="comment">         * Invalidate the part of the desktop wallpaper it</span>
01586 <span class="comment">         * doesn't sit over.</span>
01587 <span class="comment">         */</span>
01588         fRedrawDesktop = <a class="code" href="../../d3/d6/rect_8c.html#a11">SubtractRect</a>(&amp;rc, &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>, &amp;pwndShell-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>);
01589         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndShell);
01590     }
01591 
01592     <span class="comment">/*</span>
01593 <span class="comment">     * Invalidate the desktop window.</span>
01594 <span class="comment">     */</span>
01595     <span class="keywordflow">if</span> (fRedrawDesktop) {
01596         <a class="code" href="../../d4/d1/userk_8h.html#a1679">xxxRedrawWindow</a>(
01597                 pwnd,
01598                 &amp;rc,
01599                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01600                 RDW_INVALIDATE | RDW_ERASE | RDW_ALLCHILDREN);
01601     }
01602 }
01603 
01604 <span class="comment">/***************************************************************************\</span>
01605 <span class="comment">* xxxInternalPaintDesktop</span>
01606 <span class="comment">*</span>
01607 <span class="comment">* If fPaint is TRUE, enumerate the monitors to paint the desktop.</span>
01608 <span class="comment">* Otherwise, it selects the bitmap palette into the DC to select</span>
01609 <span class="comment">* its colors into the hardware palette.</span>
01610 <span class="comment">*</span>
01611 <span class="comment">* History:</span>
01612 <span class="comment">* 29-Jul-1991 MikeKe    From win31</span>
01613 <span class="comment">\***************************************************************************/</span>
01614 
<a name="l01615"></a><a class="code" href="../../d4/d1/userk_8h.html#a1444">01615</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1444">xxxInternalPaintDesktop</a>(
01616     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>    pwnd,
01617     HDC     hdc,
01618     BOOL    fPaint)
01619 {
01620     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRet;
01621 
01622     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
01623 
01624     <span class="keywordflow">if</span> (fPaint) {
01625         RECT rcOrg, rcT;
01626         POINT pt;
01627 
01628         <span class="comment">/*</span>
01629 <span class="comment">         * For compatiblity purposes the DC origin of desktop windows</span>
01630 <span class="comment">         * is set to the primary monitor, i.e. (0,0). Since we may get</span>
01631 <span class="comment">         * either desktop or non-desktop DCs here, temporarily reset</span>
01632 <span class="comment">         * the hdc origin to (0,0).</span>
01633 <span class="comment">         */</span>
01634         GreGetDCOrgEx(hdc, &amp;pt, &amp;rcOrg);
01635         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rcT, &amp;rcOrg);
01636         <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(&amp;rcT, -rcT.left, -rcT.top);
01637         GreSetDCOrg(hdc, rcT.left, rcT.top, (PRECTL)&amp;rcT);
01638 
01639         fRet = <a class="code" href="../../d4/d1/userk_8h.html#a2076">xxxEnumDisplayMonitors</a>(
01640                 hdc,
01641                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01642                 (MONITORENUMPROC) <a class="code" href="../../d1/d3/dtbitmap_8c.html#a35">xxxDesktopPaintCallback</a>,
01643                 (LPARAM)pwnd,
01644                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01645 
01646         <span class="comment">/*</span>
01647 <span class="comment">         * Reset the DC origin back.</span>
01648 <span class="comment">         */</span>
01649         GreSetDCOrg(hdc, rcOrg.left, rcOrg.top, (PRECTL)&amp;rcOrg);
01650 
01651     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (    <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a2">ghpalWallpaper</a> &amp;&amp;
01652             <a class="code" href="../../d6/d0/usercli_8h.html#a793">GetPrimaryMonitor</a>()-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o2">dwMONFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a526">MONF_PALETTEDISPLAY</a>) {
01653         <span class="comment">/*</span>
01654 <span class="comment">         * Select in the palette if one exists.</span>
01655 <span class="comment">         */</span>
01656         HPALETTE    hpalT;
01657         <span class="keywordtype">int</span>         i;
01658 
01659         hpalT = <a class="code" href="../../d4/d1/userk_8h.html#a1103">_SelectPalette</a>(hdc, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a2">ghpalWallpaper</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01660         i = <a class="code" href="../../d4/d1/userk_8h.html#a1104">xxxRealizePalette</a>(hdc);
01661         <a class="code" href="../../d4/d1/userk_8h.html#a1103">_SelectPalette</a>(hdc, hpalT, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01662 
01663         <span class="keywordflow">if</span> (i &gt; 0) {
01664             <a class="code" href="../../d1/d3/dtbitmap_8c.html#a18">xxxInvalidateDesktopOnPaletteChange</a>(pwnd);
01665         }
01666         fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01667     }
01668 
01669     <span class="keywordflow">return</span> fRet;
01670 }
01671 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:47 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
