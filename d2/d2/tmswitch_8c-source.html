<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: tmswitch.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>tmswitch.c</h1><a href="../../d1/d3/tmswitch_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: tmswitch.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* History:</span>
00007 <span class="comment">* 29-May-1991 DavidPe   Created.</span>
00008 <span class="comment">\***************************************************************************/</span>
00009 
00010 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00011 <span class="preprocessor">#pragma hdrstop</span>
00012 <span class="preprocessor"></span>
00013 <span class="comment">/*</span>
00014 <span class="comment"> * COOLSWITCHTRACE is used to trace problems</span>
00015 <span class="comment"> * in the CoolSwitch window</span>
00016 <span class="comment"> */</span>
00017 <span class="preprocessor">#undef COOLSWITCHTRACE</span>
00018 <span class="preprocessor"></span>
00019 
<a name="l00020"></a><a class="code" href="../../d1/d3/tmswitch_8c.html#a0">00020</a> <span class="preprocessor">#define DGF_NODRAW      1</span>
00021 <span class="preprocessor"></span>
<a name="l00022"></a><a class="code" href="../../d1/d3/tmswitch_8c.html#a1">00022</a> <span class="preprocessor">#define ALT_F6          2</span>
<a name="l00023"></a><a class="code" href="../../d1/d3/tmswitch_8c.html#a2">00023</a> <span class="preprocessor"></span><span class="preprocessor">#define ALT_ESCAPE      1</span>
00024 <span class="preprocessor"></span>
<a name="l00025"></a><a class="code" href="../../d1/d3/tmswitch_8c.html#a3">00025</a> <span class="preprocessor">#define FDIR_FORWARD    0</span>
<a name="l00026"></a><a class="code" href="../../d1/d3/tmswitch_8c.html#a4">00026</a> <span class="preprocessor"></span><span class="preprocessor">#define FDIR_BACKWARD   1</span>
00027 <span class="preprocessor"></span>
00028 
00029 <span class="comment">/*</span>
00030 <span class="comment"> *  Win95 hard codes the size of the icon matrix, the size of</span>
00031 <span class="comment"> *  the icons, the highlight border and the icon spacing</span>
00032 <span class="comment"> */</span>
<a name="l00033"></a><a class="code" href="../../d1/d3/tmswitch_8c.html#a5">00033</a> <span class="preprocessor">#define CXICONSLOT      43</span>
<a name="l00034"></a><a class="code" href="../../d1/d3/tmswitch_8c.html#a6">00034</a> <span class="preprocessor"></span><span class="preprocessor">#define CYICONSLOT      43</span>
<a name="l00035"></a><a class="code" href="../../d1/d3/tmswitch_8c.html#a7">00035</a> <span class="preprocessor"></span><span class="preprocessor">#define CXICONSIZE      32</span>
<a name="l00036"></a><a class="code" href="../../d1/d3/tmswitch_8c.html#a8">00036</a> <span class="preprocessor"></span><span class="preprocessor">#define CYICONSIZE      32</span>
<a name="l00037"></a><a class="code" href="../../d1/d3/tmswitch_8c.html#a9">00037</a> <span class="preprocessor"></span><span class="preprocessor">#define MAXTASKNAMELEN  50</span>
00038 <span class="preprocessor"></span>
00039 
00040 
00041 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d1/d3/tmswitch_8c.html#a10">xxxPaintIconsInSwitchWindow</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>, <a class="code" href="../../d8/d7/structtagSwitchWndInfo.html">PSWINFO</a>, HDC, INT, INT, INT, BOOL, BOOL, PICON);
00042 
00043 <span class="comment">/***************************************************************************\</span>
00044 <span class="comment">* Getpswi</span>
00045 <span class="comment">*</span>
00046 <span class="comment">* 04-29-96 GerardoB  Created</span>
00047 <span class="comment">\***************************************************************************/</span>
<a name="l00048"></a><a class="code" href="../../d1/d3/tmswitch_8c.html#a11">00048</a> __inline <a class="code" href="../../d8/d7/structtagSwitchWndInfo.html">PSWINFO</a> <a class="code" href="../../d1/d3/tmswitch_8c.html#a11">Getpswi</a> (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00049 {
00050     UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwnd) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a221">FNID_SWITCH</a>);
00051     <span class="keywordflow">return</span> ((<a class="code" href="../../d7/d7/structtagSWITCHWND.html">PSWITCHWND</a>)pwnd)-&gt;pswi;
00052 }
00053 <span class="comment">/***************************************************************************\</span>
00054 <span class="comment">* Setpswi</span>
00055 <span class="comment">*</span>
00056 <span class="comment">* 04-29-96 GerardoB  Created</span>
00057 <span class="comment">\***************************************************************************/</span>
<a name="l00058"></a><a class="code" href="../../d1/d3/tmswitch_8c.html#a12">00058</a> __inline <span class="keywordtype">void</span> <a class="code" href="../../d1/d3/tmswitch_8c.html#a12">Setpswi</a> (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, <a class="code" href="../../d8/d7/structtagSwitchWndInfo.html">PSWINFO</a> pswi)
00059 {
00060     UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwnd) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a221">FNID_SWITCH</a>);
00061     ((<a class="code" href="../../d7/d7/structtagSWITCHWND.html">PSWITCHWND</a>)pwnd)-&gt;pswi = pswi;
00062 }
00063 <span class="comment">/***************************************************************************\</span>
00064 <span class="comment">* DSW_GetTopLevelCreatorWindow</span>
00065 <span class="comment">*</span>
00066 <span class="comment">*</span>
00067 <span class="comment">\***************************************************************************/</span>
00068 
<a name="l00069"></a><a class="code" href="../../d4/d1/userk_8h.html#a1530">00069</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d4/d1/userk_8h.html#a1530">DSW_GetTopLevelCreatorWindow</a>(
00070     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00071 {
00072     UserAssert(pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00073 
00074     <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00075         <span class="keywordflow">while</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>)
00076             pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>;
00077     }
00078 
00079     <span class="keywordflow">return</span> pwnd;
00080 }
00081 
00082 <span class="comment">/***************************************************************************\</span>
00083 <span class="comment">* GetNextQueueWindow</span>
00084 <span class="comment">*</span>
00085 <span class="comment">* This routine is used to implement the Alt+Esc feature.  This feature lets</span>
00086 <span class="comment">* the user switch between windows for different applications (a.k.a. "Tasks")</span>
00087 <span class="comment">* currently running.  We keep track of the most recently active window in</span>
00088 <span class="comment">* each task.  This routine starts with the window passed and searches for the</span>
00089 <span class="comment">* next window, in the "top-level" window list, that is from a different task</span>
00090 <span class="comment">* than the one passed.  We then return the most recenly active window from</span>
00091 <span class="comment">* that task (or the window we found if the most recently active has been</span>
00092 <span class="comment">* destroyed or is currently disabled or hidden).  This routine returns NULL</span>
00093 <span class="comment">* if no other enabled, visible window for another task can be found.</span>
00094 <span class="comment">*</span>
00095 <span class="comment">* History:</span>
00096 <span class="comment">* 30-May-1991 DavidPe   Ported from Win 3.1 sources.</span>
00097 <span class="comment">\***************************************************************************/</span>
00098 
<a name="l00099"></a><a class="code" href="../../d4/d1/userk_8h.html#a1893">00099</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d4/d1/userk_8h.html#a1893">_GetNextQueueWindow</a>(
00100     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00101     BOOL fPrev, <span class="comment">/* 1 backward 0 forward */</span>
00102     BOOL fAltEsc)
00103 {
00104     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndAltTab;
00105     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndNext;
00106     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndT;
00107     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndDesktop;
00108     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        bBeenHereAlready = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00109     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiAltTab;
00110 
00111     <span class="comment">/*</span>
00112 <span class="comment">     * HACK: We have a problem with direct-draw full apps where an alttab</span>
00113 <span class="comment">     *       window is created on a queue owned other than the RIT.  This</span>
00114 <span class="comment">     *       shows up by alt-tabbing away from ROIDS.EXE during fullscreen.</span>
00115 <span class="comment">     *</span>
00116 <span class="comment">     *       What is happening is on a ALT-TAB, from xxxSysCommand(), the</span>
00117 <span class="comment">     *       thread is not a rit.  xxxSysCommand() calls xxxOldNextWindow</span>
00118 <span class="comment">     *       which finds that the current-thread doesn't have a switch</span>
00119 <span class="comment">     *       window, and then creates one on the current-thread-queue.</span>
00120 <span class="comment">     *</span>
00121 <span class="comment">     *       The hack here is to make sure the calling thread is the RIT</span>
00122 <span class="comment">     *       before allowing any cool-switch creation.</span>
00123 <span class="comment">     *</span>
00124 <span class="comment">     *       21-Mar-1996 : Chriswil</span>
00125 <span class="comment">     */</span>
00126 <span class="preprocessor">#if 0</span>
00127 <span class="preprocessor"></span>    ptiAltTab = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00128 <span class="preprocessor">#else</span>
00129 <span class="preprocessor"></span>    ptiAltTab = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>;
00130 <span class="preprocessor">#endif</span>
00131 <span class="preprocessor"></span>
00132     <span class="comment">/*</span>
00133 <span class="comment">     * If the window we receive is Null then use the last topmost window</span>
00134 <span class="comment">     */</span>
00135     <span class="keywordflow">if</span> (!pwnd) {
00136         pwnd = <a class="code" href="../../d2/d8/swp_8c.html#a35">GetLastTopMostWindow</a>();
00137         <span class="keywordflow">if</span> (!pwnd) {
00138             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00139         }
00140     }
00141 
00142     pwndAltTab = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a>;
00143 
00144     pwnd = pwndNext = <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a11">GetTopLevelWindow</a>(pwnd);
00145     <span class="keywordflow">if</span> (!pwndNext)
00146         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00147 
00148     <span class="comment">/*</span>
00149 <span class="comment">     * Get the window's desktop</span>
00150 <span class="comment">     */</span>
00151     <span class="keywordflow">if</span> ((pwndDesktop = pwndNext-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00152         pwndDesktop = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>;
00153         pwnd = pwndNext = pwndDesktop-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
00154     }
00155 
00156     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00157 
00158         <span class="keywordflow">if</span> (pwndNext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00159             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00160 
00161         <span class="comment">/*</span>
00162 <span class="comment">         *  Get the next window</span>
00163 <span class="comment">         */</span>
00164         pwndNext = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a13">_GetWindow</a>(pwndNext, fPrev ? GW_HWNDPREV : GW_HWNDNEXT);
00165 
00166         <span class="keywordflow">if</span> (!pwndNext) {
00167 
00168             pwndNext = fPrev ? <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a13">_GetWindow</a>(pwndDesktop-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>, GW_HWNDLAST)
00169                              : pwndDesktop-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
00170             <span class="comment">/*</span>
00171 <span class="comment">             * To avoid searching the child chain forever, bale out if we get</span>
00172 <span class="comment">             * to the end (beginning) of the chain twice.</span>
00173 <span class="comment">             * This happens if pwnd is a partially destroyed window that has</span>
00174 <span class="comment">             * been unlinked from its siblings but not yet unlinked from the</span>
00175 <span class="comment">             * parent. (Happens while sending WM_NCDESTROY in xxxFreeWindow)</span>
00176 <span class="comment">             */</span>
00177             <span class="keywordflow">if</span> (bBeenHereAlready) {
00178                 RIPMSG1(RIP_WARNING, <span class="stringliteral">"pwnd %#p is no longer a sibling"</span>, pwnd);
00179                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00180             }
00181 
00182             bBeenHereAlready = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00183         }
00184 
00185         <span class="comment">/*</span>
00186 <span class="comment">         *  If we have gone all the way around with no success, return NULL.</span>
00187 <span class="comment">         */</span>
00188         <span class="keywordflow">if</span> (!pwndNext || (pwndNext == pwnd))
00189             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00190 
00191         <span class="comment">/*</span>
00192 <span class="comment">         *  Ignore the following windows:</span>
00193 <span class="comment">         *      Switch window</span>
00194 <span class="comment">         *      Tool Windows</span>
00195 <span class="comment">         *      NoActivate Windows</span>
00196 <span class="comment">         *      Hidden windows</span>
00197 <span class="comment">         *      Disabled windows</span>
00198 <span class="comment">         *      Topmost windows if via Alt+Esc</span>
00199 <span class="comment">         *      Bottommost windows if via Alt+Esc</span>
00200 <span class="comment">         *</span>
00201 <span class="comment">         *  If we're doing Alt-Esc processing, we have to skip topmost windows.</span>
00202 <span class="comment">         *</span>
00203 <span class="comment">         *  Because topmost windows don't really go to the back when we</span>
00204 <span class="comment">         *  send them there, alt-esc would never enumerate non-topmost windows.</span>
00205 <span class="comment">         *  So, although we're allowed to start enumeration at a topmost window,</span>
00206 <span class="comment">         *  we only allow enumeration of non-topmost windows, so the user can</span>
00207 <span class="comment">         *  enumerate his presumably more important applications.</span>
00208 <span class="comment">         */</span>
00209         <span class="keywordflow">if</span> ((pwndNext != pwndAltTab) &amp;&amp;
00210 <span class="comment">// BradG - Win95 is missing the check for Tool Windows</span>
00211             (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndNext, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a619">WEFTOOLWINDOW</a>)) &amp;&amp;
00212             (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndNext, <a class="code" href="../../d1/d0/inc_2user_8h.html#a624">WEFNOACTIVATE</a>)) &amp;&amp;
00213             (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndNext, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)) &amp;&amp;
00214             ((pwndNext-&gt;spwndLastActive == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndNext-&gt;spwndLastActive, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a651">WFDISABLED</a>)) &amp;&amp;
00215             (!fAltEsc || (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndNext, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>) &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndNext, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a589">WFBOTTOMMOST</a>))))) {
00216             <span class="comment">/*</span>
00217 <span class="comment">             * If this window is owned, don't return it unless it is the most</span>
00218 <span class="comment">             * recently active window in its owner/ownee group.</span>
00219 <span class="comment">             */</span>
00220             <span class="comment">/*</span>
00221 <span class="comment">             *  Hard loop to find top level owner</span>
00222 <span class="comment">             */</span>
00223             <span class="keywordflow">for</span> (pwndT = pwndNext; pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>; pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>)
00224                 ;
00225 
00226             <span class="comment">/*</span>
00227 <span class="comment">             *  Don't return it unless it is the most recently active</span>
00228 <span class="comment">             *  window in its owner/ownee group.</span>
00229 <span class="comment">             */</span>
00230             <span class="keywordflow">if</span> (pwndNext == pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o12">spwndLastActive</a>)
00231                 <span class="keywordflow">return</span> pwndNext;
00232         }
00233     }
00234 }
00235 
00236 <span class="comment">/***************************************************************************\</span>
00237 <span class="comment">*</span>
00238 <span class="comment">* SwitchToThisWindow()</span>
00239 <span class="comment">*</span>
00240 <span class="comment">* This function was added specifically for Win386.  It is called to tell</span>
00241 <span class="comment">* USER that a particular window has been switched to via Alt+Tab or</span>
00242 <span class="comment">* Alt+Esc in the Win386 environment.  They call this function to maintain</span>
00243 <span class="comment">* Z-ordering and consistent operation of these two functions.  This function</span>
00244 <span class="comment">* must be exported, but need not be documented.</span>
00245 <span class="comment">*</span>
00246 <span class="comment">* The parameter fTab is TRUE if this window is to be switched to via an</span>
00247 <span class="comment">* Alt/Ctl+Tab key sequence otherwise it must be FALSE.</span>
00248 <span class="comment">*</span>
00249 <span class="comment">* History:</span>
00250 <span class="comment">* 04-Feb-1991 DarrinM   Created.</span>
00251 <span class="comment">\***************************************************************************/</span>
00252 
<a name="l00253"></a><a class="code" href="../../d4/d1/userk_8h.html#a1657">00253</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1657">xxxSwitchToThisWindow</a>(
00254     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00255     BOOL fAltTab)
00256 {
00257     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00258 
00259     <span class="comment">/*</span>
00260 <span class="comment">     *  If we need to, push old window to the bottom.</span>
00261 <span class="comment">     */</span>
00262     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> &amp;&amp; !fAltTab) {
00263 
00264         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fPush;
00265         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndActive;
00266         <a class="code" href="../../d5/d1/struct__TL.html">TL</a>   tlpwndActive;
00267 
00268         <span class="comment">/*</span>
00269 <span class="comment">         *  if ALT-ESC, and the window brought forward is the next one in the</span>
00270 <span class="comment">         *  list, we must be rotating the zorder forward, so push the current</span>
00271 <span class="comment">         *  window to the back</span>
00272 <span class="comment">         */</span>
00273         pwndActive = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>;
00274         fPush = pwndActive &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a1893">_GetNextQueueWindow</a>(pwndActive, <a class="code" href="../../d1/d3/tmswitch_8c.html#a3">FDIR_FORWARD</a>, !fAltTab);
00275         <span class="keywordflow">if</span> (fPush &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndActive, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>) &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndActive, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a589">WFBOTTOMMOST</a>)) {
00276             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndActive, &amp;tlpwndActive);
00277             <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(pwndActive, <a class="code" href="../../d4/d1/userk_8h.html#a453">PWND_BOTTOM</a>, 0, 0, 0, 0,
00278                 SWP_NOMOVE | SWP_NOSIZE | SWP_NOACTIVATE | SWP_ASYNCWINDOWPOS);
00279             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndActive);
00280         }
00281     }
00282 
00283     <span class="comment">/*</span>
00284 <span class="comment">     *  Switch this new window to the foreground</span>
00285 <span class="comment">     *  This window can go away during the SetForeground call if it isn't</span>
00286 <span class="comment">     *  on the thread calling SwitchToThisWindow()!</span>
00287 <span class="comment">     */</span>
00288     <a class="code" href="../../d4/d1/userk_8h.html#a1665">xxxSetForegroundWindow</a>(pwnd, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00289 
00290     <span class="comment">/*</span>
00291 <span class="comment">     * Restore minimized windows if the Alt+Tab case</span>
00292 <span class="comment">     */</span>
00293     <span class="keywordflow">if</span> (fAltTab &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd,<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>)) {
00294 
00295         <span class="comment">/*</span>
00296 <span class="comment">         * We need to package up a special 'posted' queue message here.  This</span>
00297 <span class="comment">         * ensures that this message gets processed after the asynchronous</span>
00298 <span class="comment">         * activation event occurs (via SetForegroundWindow).</span>
00299 <span class="comment">         */</span>
00300         <a class="code" href="../../d4/d1/userk_8h.html#a1217">PostEventMessage</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq,
00301                          <a class="code" href="../../d4/d1/userk_8h.html#a340">QEVENT_POSTMESSAGE</a>, pwnd, WM_SYSCOMMAND,
00302                          SC_RESTORE, 0 );
00303     }
00304 }
00305 
00306 <span class="comment">/***************************************************************************\</span>
00307 <span class="comment">* NextPrevTaskIndex</span>
00308 <span class="comment">*</span>
00309 <span class="comment">* History:</span>
00310 <span class="comment">* 01-Jun-1995 BradG     Ported from Win95</span>
00311 <span class="comment">\***************************************************************************/</span>
00312 
<a name="l00313"></a><a class="code" href="../../d1/d3/tmswitch_8c.html#a16">00313</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> <a class="code" href="../../d1/d3/tmswitch_8c.html#a16">NextPrevTaskIndex</a>(
00314     <a class="code" href="../../d8/d7/structtagSwitchWndInfo.html">PSWINFO</a> pswInfo,
00315     INT     iIndex,
00316     INT     iCount,
00317     BOOL    fNext)
00318 {
00319     UserAssert(iCount &lt;= pswInfo-&gt;iTotalTasks);
00320 
00321     <span class="keywordflow">if</span> (fNext) {
00322         iIndex += iCount;
00323         <span class="keywordflow">if</span>(iIndex &gt;= pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o3">iTotalTasks</a>)
00324             iIndex -= pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o3">iTotalTasks</a>;
00325     } <span class="keywordflow">else</span> {
00326         iIndex -= iCount;
00327         <span class="keywordflow">if</span>(iIndex &lt; 0)
00328             iIndex += pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o3">iTotalTasks</a>;
00329     }
00330 
00331     UserAssert((iIndex &gt;= 0) &amp;&amp; (iIndex &lt; pswInfo-&gt;iTotalTasks));
00332     <span class="keywordflow">return</span> iIndex;
00333 }
00334 
00335 <span class="comment">/***************************************************************************\</span>
00336 <span class="comment">* NextPrevPhwnd</span>
00337 <span class="comment">*</span>
00338 <span class="comment">* Given a pointer to one entry in the window list, this can return</span>
00339 <span class="comment">* the pointer to the next/prev entry in a circular list fashion.</span>
00340 <span class="comment">*</span>
00341 <span class="comment">* History:</span>
00342 <span class="comment">* 01-Jun-1995 BradG     Ported from Win95</span>
00343 <span class="comment">\***************************************************************************/</span>
00344 
<a name="l00345"></a><a class="code" href="../../d1/d3/tmswitch_8c.html#a17">00345</a> <a class="code" href="../../d4/d1/userk_8h.html#a944">PHWND</a> <a class="code" href="../../d1/d3/tmswitch_8c.html#a17">NextPrevPhwnd</a>(
00346     <a class="code" href="../../d8/d7/structtagSwitchWndInfo.html">PSWINFO</a> pswInfo,
00347     PHWND   phwnd,
00348     BOOL    fNext)
00349 {
00350     <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a>  pbwl;
00351     <a class="code" href="../../d4/d1/userk_8h.html#a944">PHWND</a> phwndStart;
00352     <a class="code" href="../../d4/d1/userk_8h.html#a944">PHWND</a> phwndLast;
00353 
00354     pbwl = pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o0">pbwl</a>;
00355     phwndStart = &amp;(pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o4">rghwnd</a>[0]);
00356     phwndLast = pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o1">phwndLast</a>;
00357 
00358     UserAssert(*phwndLast == (HWND)1);   <span class="comment">// Last entry must have a 1.</span>
00359     UserAssert(phwndStart &lt; phwndLast);  <span class="comment">// There must be atleast one entry.</span>
00360     UserAssert(phwnd != phwndLast);      <span class="comment">// Can't be passing in an invalid entry.</span>
00361 
00362     <span class="keywordflow">if</span> (fNext) {
00363         phwnd++;
00364         <span class="keywordflow">if</span>(phwnd == phwndLast)
00365             phwnd = phwndStart;
00366     } <span class="keywordflow">else</span> {
00367         <span class="keywordflow">if</span> (phwnd == phwndStart) {
00368             phwnd = phwndLast - 1;  <span class="comment">// we have atleast one valid entry.</span>
00369         } <span class="keywordflow">else</span> {
00370             phwnd--;
00371         }
00372     }
00373 
00374     <span class="keywordflow">return</span> phwnd;
00375 }
00376 
00377 <span class="comment">/***************************************************************************\</span>
00378 <span class="comment">* _IsTaskWindow</span>
00379 <span class="comment">*</span>
00380 <span class="comment">* History:</span>
00381 <span class="comment">* 01-Jun-95 BradG       Ported from Win95</span>
00382 <span class="comment">\***************************************************************************/</span>
00383 
<a name="l00384"></a><a class="code" href="../../d1/d3/tmswitch_8c.html#a18">00384</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d1/d3/tmswitch_8c.html#a18">_IsTaskWindow</a>(
00385     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00386     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndActive)
00387 {
00388     <span class="comment">/*</span>
00389 <span class="comment">     *  Following windows do not qualify to be shown in task list:</span>
00390 <span class="comment">     *  Switch  Window, Hidden windows (unless they are the active</span>
00391 <span class="comment">     *  window), Disabled windows, Kanji Conv windows.</span>
00392 <span class="comment">     *</span>
00393 <span class="comment">     *  Also, check for a combobox popup list which has the top-most</span>
00394 <span class="comment">     *  style (it's spwndLastActive will be NULL).</span>
00395 <span class="comment">     */</span>
00396     UserAssert(pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00397     <span class="keywordflow">return</span>( (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a629">WEFAPPWINDOW</a>)
00398                 || (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a619">WEFTOOLWINDOW</a>) &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d1/d0/inc_2user_8h.html#a624">WEFNOACTIVATE</a>))) &amp;&amp;
00399             (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>) || (pwnd == pwndActive)) &amp;&amp;
00400             (!(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o12">spwndLastActive</a> &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o12">spwndLastActive</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a651">WFDISABLED</a>))));
00401 }
00402 
00403 <span class="comment">/***************************************************************************\</span>
00404 <span class="comment">* RemoveNonTaskWindows()</span>
00405 <span class="comment">*</span>
00406 <span class="comment">* Given a list of Windows, this walks down the list and removes the</span>
00407 <span class="comment">* windows that do not qualify to be shown in the Task-Switch screen.</span>
00408 <span class="comment">* This also shrinks the list when it removes some entries.</span>
00409 <span class="comment">* Returns the total number of "tasks" (windows) qualified and remained</span>
00410 <span class="comment">* in the list. The last entry will have a 1 as usual.</span>
00411 <span class="comment">* It also returns a pointer to this last entry via params. It also</span>
00412 <span class="comment">* returns the index of the Currently active task via params.</span>
00413 <span class="comment">*</span>
00414 <span class="comment">* History:</span>
00415 <span class="comment">* 01-Jun-1995 BradG     Ported from Win95</span>
00416 <span class="comment">\***************************************************************************/</span>
00417 
<a name="l00418"></a><a class="code" href="../../d1/d3/tmswitch_8c.html#a19">00418</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> <a class="code" href="../../d1/d3/tmswitch_8c.html#a19">_RemoveNonTaskWindows</a>(
00419     <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a>  pbwl,
00420     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwndActive,
00421     LPINT lpiActiveTask,
00422     PHWND *pphwndLast)
00423 {
00424     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>   iTaskCount = 0;
00425     <a class="code" href="../../d4/d1/userk_8h.html#a944">PHWND</a> phwnd;
00426     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwnd;
00427     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwndUse;
00428     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwndOwnee;
00429     <a class="code" href="../../d4/d1/userk_8h.html#a944">PHWND</a> phwndHole;
00430 
00431     *lpiActiveTask = -1;
00432 
00433     <span class="comment">/*</span>
00434 <span class="comment">     * Walk down the window list and do the following:</span>
00435 <span class="comment">     *   1. Remove all entries that do not qualify to be shown in the task list.</span>
00436 <span class="comment">     *   2. Count the total number of windows that qualify.</span>
00437 <span class="comment">     *   3. Get the pointer to the entry that contains current active window.</span>
00438 <span class="comment">     *   4. Get the pointer to the last dummy entry (that has 1 in it)</span>
00439 <span class="comment">     */</span>
00440     <span class="keywordflow">for</span> (phwndHole = phwnd = pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o4">rghwnd</a>; *phwnd != (HWND)1; phwnd++) {
00441         pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>( *phwnd );
00442 <span class="comment">// BradG - Win95 Assert</span>
00443 <span class="comment">//         Maybe we just want to remove this window if it is gone.</span>
00444 <span class="comment">//        UserAssert(pwnd != NULL);</span>
00445         <span class="keywordflow">if</span> (!pwnd)
00446             <span class="keywordflow">continue</span>;
00447 
00448         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d3/tmswitch_8c.html#a18">_IsTaskWindow</a>(pwnd, pwndActive)) {
00449             pwndUse = pwnd;
00450 
00451 <span class="comment">// BradG - Why is Win95 doing this?</span>
00452 <span class="comment">//         We aren't making any callbacks.</span>
00453 <span class="comment">//            Assert(IsWindow32(hwndUse));</span>
00454 
00455             <span class="comment">/*</span>
00456 <span class="comment">             *  First let's find the task-list owner of this window</span>
00457 <span class="comment">             */</span>
00458             <span class="keywordflow">while</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndUse, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a629">WEFAPPWINDOW</a>) &amp;&amp; pwndUse-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>) {
00459                 pwndOwnee = pwndUse;
00460                 pwndUse = pwndUse-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>;
00461                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndUse, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a619">WEFTOOLWINDOW</a>)) {
00462                     <span class="comment">/*</span>
00463 <span class="comment">                     * If this is the owner of a top level property sheet,</span>
00464 <span class="comment">                     *  show the property sheet.</span>
00465 <span class="comment">                     */</span>
00466                     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndOwnee, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a627">WEFCONTROLPARENT</a>) &amp;&amp; (pwndUse-&gt;spwndOwner == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00467                         pwndUse = pwnd;
00468                     } <span class="keywordflow">else</span> {
00469                         pwndUse = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00470                     }
00471                     <span class="keywordflow">break</span>;
00472                 }
00473             }
00474 
00475             <span class="keywordflow">if</span> (!pwndUse || !pwndUse-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o12">spwndLastActive</a>)
00476                 <span class="keywordflow">continue</span>;
00477 
00478             <span class="comment">/*</span>
00479 <span class="comment">             *  walk up from the last active window 'til we find a valid task</span>
00480 <span class="comment">             *  list window or until we run out of windows in the ownership</span>
00481 <span class="comment">             *  chain</span>
00482 <span class="comment">             */</span>
00483             <span class="keywordflow">for</span> (pwndUse = pwndUse-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o12">spwndLastActive</a>; pwndUse; pwndUse = pwndUse-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>)
00484                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d3/tmswitch_8c.html#a18">_IsTaskWindow</a>(pwndUse, pwndActive))
00485                     <span class="keywordflow">break</span>;
00486 
00487             <span class="comment">/*</span>
00488 <span class="comment">             *  if we ran out of windows in the ownership chain then use the</span>
00489 <span class="comment">             *  owned window itself -- or if we didn't run out of the ownership</span>
00490 <span class="comment">             *  chain, then only include this window if it's the window in the</span>
00491 <span class="comment">             *  ownership chain that we just found (VB will love us for it !)</span>
00492 <span class="comment">             *  -- jeffbog -- 4/20/95 -- Win95C B#2821</span>
00493 <span class="comment">             */</span>
00494             <span class="keywordflow">if</span> (!pwndUse || (pwndUse == pwnd)) {
00495 
00496                 <span class="comment">/*</span>
00497 <span class="comment">                 *  Do we have any holes above this? If so, move this handle to</span>
00498 <span class="comment">                 *  that hole.</span>
00499 <span class="comment">                 */</span>
00500                 <span class="keywordflow">if</span> (phwndHole &lt; phwnd) {
00501 
00502                     <span class="comment">/*</span>
00503 <span class="comment">                     * Yes! There is a hole. Let us move the valid</span>
00504 <span class="comment">                     * handle there.</span>
00505 <span class="comment">                     */</span>
00506                     *phwndHole = *phwnd;
00507                 }
00508 
00509                 <span class="keywordflow">if</span> (pwndActive == pwnd)
00510                     *lpiActiveTask = iTaskCount;
00511                 iTaskCount++;
00512                 phwndHole++;  <span class="comment">// Move to the next entry.</span>
00513             }
00514 
00515             <span class="comment">/*</span>
00516 <span class="comment">             *  Else, leave it as a hole for later filling.</span>
00517 <span class="comment">             */</span>
00518         }
00519     }
00520 
00521     *phwndHole = (HWND)1;
00522     *pphwndLast = phwndHole;
00523 
00524     <span class="keywordflow">return</span> iTaskCount;
00525 }
00526 
00527 <span class="comment">/***************************************************************************\</span>
00528 <span class="comment">* DrawSwitchWndHilite()</span>
00529 <span class="comment">*</span>
00530 <span class="comment">* This draws or erases the Hilite we draw around the icon to show which</span>
00531 <span class="comment">* task we are going to switch to.</span>
00532 <span class="comment">* This also updates the name on the Task title window.</span>
00533 <span class="comment">*</span>
00534 <span class="comment">* History:</span>
00535 <span class="comment">* 01-Jun-1995 BradG     Ported from Win95</span>
00536 <span class="comment">\***************************************************************************/</span>
00537 
<a name="l00538"></a><a class="code" href="../../d1/d3/tmswitch_8c.html#a20">00538</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d1/d3/tmswitch_8c.html#a20">DrawSwitchWndHilite</a>(
00539     <a class="code" href="../../d8/d7/structtagSwitchWndInfo.html">PSWINFO</a> pswInfo,
00540     HDC     hdcSwitch,
00541     <span class="keywordtype">int</span>     iCol,
00542     <span class="keywordtype">int</span>     iRow,
00543     BOOL    fShow)
00544 {
00545     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fGetAndReleaseIt;
00546     RECT        rcTemp;
00547     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiAltTab;
00548     <span class="comment">/*</span>
00549 <span class="comment">     * HACK: We have a problem with direct-draw full apps where an alttab</span>
00550 <span class="comment">     *       window is created on a queue owned other than the RIT.  This</span>
00551 <span class="comment">     *       shows up by alt-tabbing away from ROIDS.EXE during fullscreen.</span>
00552 <span class="comment">     *</span>
00553 <span class="comment">     *       What is happening is on a ALT-TAB, from xxxSysCommand(), the</span>
00554 <span class="comment">     *       thread is not a rit.  xxxSysCommand() calls xxxOldNextWindow</span>
00555 <span class="comment">     *       which finds that the current-thread doesn't have a switch</span>
00556 <span class="comment">     *       window, and then creates one on the current-thread-queue.</span>
00557 <span class="comment">     *</span>
00558 <span class="comment">     *       The hack here is to make sure the calling thread is the RIT</span>
00559 <span class="comment">     *       before allowing any cool-switch creation.</span>
00560 <span class="comment">     *</span>
00561 <span class="comment">     *       21-Mar-1996 : Chriswil</span>
00562 <span class="comment">     */</span>
00563 <span class="preprocessor">#if 0</span>
00564 <span class="preprocessor"></span>    ptiAltTab = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00565 <span class="preprocessor">#else</span>
00566 <span class="preprocessor"></span>    ptiAltTab = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>;
00567 <span class="preprocessor">#endif</span>
00568 <span class="preprocessor"></span>
00569     <span class="comment">/*</span>
00570 <span class="comment">     *  Draw or erase the hilite depending on "fShow".</span>
00571 <span class="comment">     */</span>
00572     <span class="keywordflow">if</span> (fGetAndReleaseIt = (hdcSwitch == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))
00573         hdcSwitch = <a class="code" href="../../d4/d1/userk_8h.html#a1695">_GetDCEx</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, DCX_USESTYLE);
00574 
00575     rcTemp.left   = pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o14">ptFirstRowStart</a>.x + iCol * <a class="code" href="../../d1/d3/tmswitch_8c.html#a5">CXICONSLOT</a>;
00576     rcTemp.top    = pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o14">ptFirstRowStart</a>.y + iRow * <a class="code" href="../../d1/d3/tmswitch_8c.html#a6">CYICONSLOT</a>;
00577     rcTemp.right  = rcTemp.left + <a class="code" href="../../d1/d3/tmswitch_8c.html#a5">CXICONSLOT</a>;
00578     rcTemp.bottom = rcTemp.top + <a class="code" href="../../d1/d3/tmswitch_8c.html#a6">CYICONSLOT</a>;
00579 
00580     <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a17">DrawFrame</a>(hdcSwitch,
00581               &amp;rcTemp,
00582               2,
00583               <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a166">DF_PATCOPY</a> | ((fShow ? COLOR_HIGHLIGHT : COLOR_3DFACE) &lt;&lt; 3));
00584 
00585 
00586     <span class="comment">/*</span>
00587 <span class="comment">     *  Update the Task title window.</span>
00588 <span class="comment">     */</span>
00589     <span class="keywordflow">if</span> (fShow) {
00590         WCHAR    szText[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a768">CCHTITLEMAX</a>];
00591         <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>      cch;
00592         COLORREF clrOldText, clrOldBk;
00593         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>     pwnd;
00594         RECT     rcRect;
00595         HFONT    hOldFont;
00596         <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>      iLeft;
00597         ULONG_PTR dwResult = 0;
00598 
00599         clrOldText = GreSetTextColor(hdcSwitch, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(BTNTEXT));
00600         clrOldBk   = GreSetBkColor(hdcSwitch, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(3DFACE));
00601         hOldFont = GreSelectFont(hdcSwitch, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;hCaptionFont);
00602 
00603 
00604         <span class="comment">/*</span>
00605 <span class="comment">         * Validate this window handle; This could be some app that terminated</span>
00606 <span class="comment">         * in the background and the following line will GP fault in that case;</span>
00607 <span class="comment">         * BOGUS: We should handle it some other better way.</span>
00608 <span class="comment">         */</span>
00609         pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>( *(pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o2">phwndCurrent</a>) );
00610         <span class="keywordflow">if</span> (pwnd) {
00611             <span class="comment">/*</span>
00612 <span class="comment">             *  Get the windows title (up to MAXTASKNAMELEN's worth)</span>
00613 <span class="comment">             */</span>
00614 <span class="comment">// BradG - We can do better than MAXTASKNAMELEN characters!</span>
00615             <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o17">strName</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o0">Length</a>) {
00616                 cch = <a class="code" href="../../d1/d5/w32_2ntuser_2rtl_2random_8c.html#a2">TextCopy</a>(&amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o17">strName</a>, szText, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a768">CCHTITLEMAX</a>);
00617             } <span class="keywordflow">else</span> {
00618                 *szText = TEXT(<span class="charliteral">'\0'</span>);
00619                 cch = 0;
00620             }
00621 
00622             <span class="comment">/*</span>
00623 <span class="comment">             *  Draw the text</span>
00624 <span class="comment">             */</span>
00625             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rcRect, &amp;pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o15">rcTaskName</a>);
00626             iLeft = rcRect.left;
00627             <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a3">FillRect</a>(hdcSwitch, &amp;rcRect, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a22">SYSHBR</a>(3DFACE));
00628             <span class="comment">/*</span>
00629 <span class="comment">             * If an lpk is installed let it draw the text.</span>
00630 <span class="comment">             */</span>
00631             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a458">GETPWNDPPI</a>(pwnd)-&gt;dwLpkEntryPoints) {
00632                 <a class="code" href="../../d5/d1/struct__TL.html">TL</a>    tlpwnd;
00633                 <a class="code" href="../../d6/d5/struct__LPKDRAWSWITCHWND.html">LPKDRAWSWITCHWND</a> LpkDrawSwitchWnd;
00634 
00635                 <a class="code" href="../../d5/d6/chartran_8c.html#a7">RtlInitLargeUnicodeString</a>(&amp;LpkDrawSwitchWnd.<a class="code" href="../../d6/d5/struct__LPKDRAWSWITCHWND.html#o1">strName</a>, szText, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1);
00636                 LpkDrawSwitchWnd.<a class="code" href="../../d6/d5/struct__LPKDRAWSWITCHWND.html#o0">rcRect</a> = rcRect;
00637 
00638                 <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwnd, &amp;tlpwnd);
00639                 <a class="code" href="../../d4/d1/userk_8h.html#a1580">xxxSendMessageTimeout</a>(pwnd, WM_LPKDRAWSWITCHWND, (WPARAM)hdcSwitch,
00640                         (LPARAM)&amp;LpkDrawSwitchWnd, SMTO_ABORTIFHUNG, 100, &amp;dwResult);
00641                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
00642             }
00643             <span class="comment">/*</span>
00644 <span class="comment">             * If the text wasn't draw by the lpk, draw it as best we can.</span>
00645 <span class="comment">             */</span>
00646             <span class="keywordflow">if</span> (dwResult == 0) {
00647                 DRAWTEXTPARAMS  dtp;
00648 
00649                 dtp.cbSize = <span class="keyword">sizeof</span>(dtp);
00650                 dtp.iLeftMargin = 0;
00651                 dtp.iRightMargin = 0;
00652                 DrawTextEx(hdcSwitch, szText, cch, &amp;rcRect, DT_NOPREFIX | DT_END_ELLIPSIS | DT_SINGLELINE, &amp;dtp );
00653             }
00654         }
00655 
00656         GreSelectFont(hdcSwitch, hOldFont);
00657         GreSetBkColor(hdcSwitch, clrOldBk);
00658         GreSetTextColor(hdcSwitch, clrOldText);
00659     }
00660 
00661     <span class="keywordflow">if</span> (fGetAndReleaseIt)
00662         <a class="code" href="../../d4/d1/userk_8h.html#a1697">_ReleaseDC</a>(hdcSwitch);
00663 }
00664 
00665 <span class="comment">/***************************************************************************\</span>
00666 <span class="comment">* DrawIconCallBack</span>
00667 <span class="comment">*</span>
00668 <span class="comment">* This function is called by a Windows app returning his icon.</span>
00669 <span class="comment">*</span>
00670 <span class="comment">* History:</span>
00671 <span class="comment">* 17-Jun-1993 mikesch       Created.</span>
00672 <span class="comment">\***************************************************************************/</span>
00673 
<a name="l00674"></a><a class="code" href="../../d1/d3/tmswitch_8c.html#a21">00674</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> CALLBACK <a class="code" href="../../d1/d3/tmswitch_8c.html#a21">DrawIconCallBack</a>(
00675     HWND    hwnd,
00676     UINT    uMsg,
00677     ULONG_PTR dwData,
00678     LRESULT lResult)
00679 {
00680     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndAltTab;
00681 
00682     <span class="comment">/*</span>
00683 <span class="comment">     *  dwData is the pointer to the switch window handle.</span>
00684 <span class="comment">     *  If this Alt+Tab instance is still active, we need to derive this</span>
00685 <span class="comment">     *  window's index in the bwl array, otherwise, we are receiving an icon</span>
00686 <span class="comment">     *  for an old Alt+Tab window.</span>
00687 <span class="comment">     */</span>
00688     pwndAltTab = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>((HWND)dwData);
00689     <span class="keywordflow">if</span> (pwndAltTab &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndAltTab, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)) {
00690 
00691         <a class="code" href="../../d8/d7/structtagSwitchWndInfo.html">PSWINFO</a> pswCurrent;
00692         <a class="code" href="../../d1/d0/inc_2user_8h.html#a529">PICON</a>   pIcon;
00693         <a class="code" href="../../d4/d1/userk_8h.html#a944">PHWND</a>   phwnd;
00694         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>    pwnd;
00695         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>    pwndT;
00696         <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>     iStartTaskIndex;
00697         <a class="code" href="../../d5/d1/struct__TL.html">TL</a>      tlpwndAltTab;
00698 
00699         <span class="comment">/*</span>
00700 <span class="comment">         *  Derive this window's index in the BWL array</span>
00701 <span class="comment">         */</span>
00702         <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00703             <span class="keywordflow">return</span>;
00704 
00705         <span class="comment">/*</span>
00706 <span class="comment">         *  Get the switch window info</span>
00707 <span class="comment">         */</span>
00708         pswCurrent = <a class="code" href="../../d1/d3/tmswitch_8c.html#a11">Getpswi</a>(pwndAltTab);
00709         <span class="keywordflow">if</span> (!pswCurrent)
00710             <span class="keywordflow">return</span>;
00711 
00712         <span class="keywordflow">for</span> (iStartTaskIndex = 0, phwnd=&amp;(pswCurrent-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o0">pbwl</a>-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o4">rghwnd</a>[0]); *phwnd != (HWND)1; phwnd++, iStartTaskIndex++) {
00713             <span class="comment">/*</span>
00714 <span class="comment">             *  Because we list the active window in the Switch Window, the</span>
00715 <span class="comment">             *  hwnd here might not be the same, so we also need to walk back</span>
00716 <span class="comment">             *  to the top-level window to see if this is the right entry</span>
00717 <span class="comment">             *  in the list.</span>
00718 <span class="comment">             */</span>
00719             <span class="keywordflow">for</span>(pwndT = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(*phwnd); pwndT; pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>) {
00720                 <span class="keywordflow">if</span> (pwnd == pwndT)
00721                     <span class="keywordflow">goto</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a65">DrawIcon</a>;
00722             }
00723         }
00724         <span class="keywordflow">return</span>;
00725 
00726         <span class="comment">/*</span>
00727 <span class="comment">         *  Convert the App's HICON into a PICON, or if the App did not return</span>
00728 <span class="comment">         *  an icon, use the Windows default icon.</span>
00729 <span class="comment">         */</span>
00730 <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a65">DrawIcon</a>:
00731         pIcon = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00732         <span class="keywordflow">if</span> (lResult)
00733             pIcon = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a8">HMValidateHandleNoRip</a>((HCURSOR)lResult, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a239">TYPE_CURSOR</a>);
00734 
00735         <span class="keywordflow">if</span> (!pIcon)
00736             pIcon = <a class="code" href="../../d4/d1/userk_8h.html#a320">SYSICO</a>(WINLOGO);
00737 
00738         <span class="comment">/*</span>
00739 <span class="comment">         *  Paint this icon in the Alt+Tab window.</span>
00740 <span class="comment">         */</span>
00741         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwndAltTab, &amp;tlpwndAltTab);
00742         <a class="code" href="../../d1/d3/tmswitch_8c.html#a10">xxxPaintIconsInSwitchWindow</a>(pwndAltTab,
00743                                     pswCurrent,
00744                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00745                                     iStartTaskIndex,
00746                                     0,
00747                                     1,
00748                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00749                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00750                                     pIcon);
00751         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndAltTab);
00752     }
00753 
00754     UNREFERENCED_PARAMETER(uMsg);
00755 }
00756 
00757 <span class="comment">/***************************************************************************\</span>
00758 <span class="comment">* TSW_CalcRowAndCol</span>
00759 <span class="comment">*</span>
00760 <span class="comment">* History:</span>
00761 <span class="comment">* 01-Jun-1995 BradG     Ported from Win95</span>
00762 <span class="comment">\***************************************************************************/</span>
00763 
<a name="l00764"></a><a class="code" href="../../d1/d3/tmswitch_8c.html#a22">00764</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d1/d3/tmswitch_8c.html#a22">TSW_CalcRowAndCol</a>(
00765     <a class="code" href="../../d8/d7/structtagSwitchWndInfo.html">PSWINFO</a> pswInfo,
00766     INT     iTaskIndex,
00767     LPINT   lpiRow,
00768     LPINT   lpiCol)
00769 {
00770     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> iDiff;
00771     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> iRow;
00772 
00773     <span class="comment">/*</span>
00774 <span class="comment">     *  Calculate how far is the given task from the first task shown</span>
00775 <span class="comment">     *  on the switch window.</span>
00776 <span class="comment">     */</span>
00777     <span class="keywordflow">if</span> ((iDiff = (iTaskIndex - pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o6">iFirstTaskIndex</a>)) &lt; 0)
00778         iDiff += pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o3">iTotalTasks</a>;
00779 
00780     <span class="comment">/*</span>
00781 <span class="comment">     *  Calculate the Row and if this lies outside the switch window, return FALSE</span>
00782 <span class="comment">     */</span>
00783     <span class="keywordflow">if</span> ((iRow = iDiff / pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o7">iNoOfColumns</a>) &gt;= pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o8">iNoOfRows</a>)
00784         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00785 
00786     <span class="comment">/*</span>
00787 <span class="comment">     *  Return the Row and column where this task lies.</span>
00788 <span class="comment">     */</span>
00789     *lpiRow = iRow;
00790     *lpiCol = iDiff - (iRow * pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o7">iNoOfColumns</a>);
00791 
00792     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;  <span class="comment">// This task lies within the switch window.</span>
00793 }
00794 
00795 <span class="comment">/***************************************************************************\</span>
00796 <span class="comment">* xxxPaintIconsInSwitchWindow()</span>
00797 <span class="comment">*</span>
00798 <span class="comment">* This can simply paint the icons in the switch window or Scroll the</span>
00799 <span class="comment">* whole window UP/DOWN and then paint the remaining area;</span>
00800 <span class="comment">*   * If fScroll is TRUE, then the second, third and fourth params are ignored.</span>
00801 <span class="comment">*   * If hIcon is passed in, then we're being called by DrawIconCallBack and</span>
00802 <span class="comment">*       iStartRow parameter is ignored in this case.</span>
00803 <span class="comment">*</span>
00804 <span class="comment">* History:</span>
00805 <span class="comment">* 02-Jun-1995 BradG     Ported from Win95</span>
00806 <span class="comment">\***************************************************************************/</span>
00807 
<a name="l00808"></a><a class="code" href="../../d1/d3/tmswitch_8c.html#a10">00808</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d1/d3/tmswitch_8c.html#a10">xxxPaintIconsInSwitchWindow</a>(
00809     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>    pwndAltTab,
00810     <a class="code" href="../../d8/d7/structtagSwitchWndInfo.html">PSWINFO</a> pswInfo,
00811     HDC     hdc,
00812     INT     iStartTaskIndex,
00813     INT     iStartRow,
00814     INT     iNoOfIcons,
00815     BOOL    fScroll,
00816     BOOL    fUp,
00817     PICON   pIcon)
00818 {
00819     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>   cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>, xStart;
00820     <a class="code" href="../../d4/d1/userk_8h.html#a944">PHWND</a> phwnd;
00821     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  fGetAndReleaseIt;
00822     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>   iColumnIndex = 0;
00823     RECT  rcScroll;
00824     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwnd;
00825     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>    tlpwnd;
00826     HICON hIcon;
00827     RECT  rcIcon;
00828 
00829     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwndAltTab);
00830 
00831     <span class="comment">/*</span>
00832 <span class="comment">     *  If we were not supplied a DC, get ghwndSwitch's and set a flag</span>
00833 <span class="comment">     *  so we remember to release it.</span>
00834 <span class="comment">     */</span>
00835     <span class="keywordflow">if</span> (fGetAndReleaseIt = (hdc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))
00836         hdc = <a class="code" href="../../d4/d1/userk_8h.html#a1695">_GetDCEx</a>(pwndAltTab, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, DCX_USESTYLE);
00837 
00838     cx = pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o14">ptFirstRowStart</a>.x;
00839     <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> = pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o14">ptFirstRowStart</a>.y;
00840 
00841     <span class="keywordflow">if</span> (fScroll) {
00842 
00843         rcScroll.left   = cx;
00844         rcScroll.top    = <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
00845         rcScroll.right  = cx + <a class="code" href="../../d1/d3/tmswitch_8c.html#a5">CXICONSLOT</a> * pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o7">iNoOfColumns</a>;
00846         rcScroll.bottom = <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> + <a class="code" href="../../d1/d3/tmswitch_8c.html#a6">CYICONSLOT</a> * pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o8">iNoOfRows</a>;
00847 
00848         <a class="code" href="../../d4/d1/userk_8h.html#a1762">_ScrollDC</a>(hdc,
00849                   0,
00850                   (fUp ? -<a class="code" href="../../d1/d3/tmswitch_8c.html#a6">CYICONSLOT</a> : <a class="code" href="../../d1/d3/tmswitch_8c.html#a6">CYICONSLOT</a>),
00851                   &amp;rcScroll,
00852                   &amp;rcScroll,
00853                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00854                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00855 
00856         iStartRow = (fUp ? pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o8">iNoOfRows</a> - 1 : 0);
00857         iNoOfIcons = pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o7">iNoOfColumns</a>;
00858         iStartTaskIndex = (fUp ? <a class="code" href="../../d1/d3/tmswitch_8c.html#a16">NextPrevTaskIndex</a>(pswInfo, pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o6">iFirstTaskIndex</a>,
00859                   (pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o8">iNoOfRows</a> - 1) * pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o7">iNoOfColumns</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) :
00860                    pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o6">iFirstTaskIndex</a>);
00861     }
00862 
00863     <span class="keywordflow">if</span> (pIcon) {
00864         <span class="comment">/*</span>
00865 <span class="comment">         *  If pIcon is given, this is to paint just one icon during callback.</span>
00866 <span class="comment">         */</span>
00867 <span class="comment">// BradG - Win95 Assert</span>
00868         UserAssert(iNoOfIcons == 1);
00869 
00870         <span class="comment">/*</span>
00871 <span class="comment">         *  Due to earlier scrolling, the row number would have changed. So,</span>
00872 <span class="comment">         *  recalc the row and column from the iStartTaskIndex given.</span>
00873 <span class="comment">         */</span>
00874         <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d3/tmswitch_8c.html#a22">TSW_CalcRowAndCol</a>(pswInfo, iStartTaskIndex, &amp;iStartRow, &amp;iColumnIndex))
00875             <span class="keywordflow">goto</span> Cleanup;
00876     }
00877 
00878     xStart = cx += (<a class="code" href="../../d1/d3/tmswitch_8c.html#a5">CXICONSLOT</a> - <a class="code" href="../../d1/d3/tmswitch_8c.html#a7">CXICONSIZE</a>) / 2;
00879     cx += iColumnIndex * <a class="code" href="../../d1/d3/tmswitch_8c.html#a5">CXICONSLOT</a>;
00880     <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> += ((<a class="code" href="../../d1/d3/tmswitch_8c.html#a6">CYICONSLOT</a> - <a class="code" href="../../d1/d3/tmswitch_8c.html#a8">CYICONSIZE</a>) / 2) + iStartRow * <a class="code" href="../../d1/d3/tmswitch_8c.html#a6">CYICONSLOT</a>;
00881     phwnd = &amp;(pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o0">pbwl</a>-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o4">rghwnd</a>[iStartTaskIndex]);
00882 
00883     <span class="comment">/*</span>
00884 <span class="comment">     *  Draw all the icons one by one.</span>
00885 <span class="comment">     */</span>
00886     <span class="keywordflow">while</span> (iNoOfIcons--) {
00887         <span class="comment">/*</span>
00888 <span class="comment">         *  If the Alt+Key is no longer down, abort painting icons.</span>
00889 <span class="comment">         */</span>
00890         <span class="keywordflow">if</span> ((pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o16">fJournaling</a> &amp;&amp; <a class="code" href="../../d7/d9/keyboard_8c.html#a1">_GetKeyState</a>(VK_MENU) &gt;= 0) ||
00891                 (!pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o16">fJournaling</a> &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a1714">_GetAsyncKeyState</a>(VK_MENU) &gt;= 0))
00892             <span class="keywordflow">goto</span> Cleanup;
00893 
00894         <span class="comment">/*</span>
00895 <span class="comment">         *  Check if this window is still alive. (Some task could have</span>
00896 <span class="comment">         *  terminated in the background)</span>
00897 <span class="comment">         */</span>
00898         <span class="keywordflow">if</span> (pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(*phwnd)) {
00899             <span class="comment">/*</span>
00900 <span class="comment">             *  Find the window's top-level owner</span>
00901 <span class="comment">             */</span>
00902             pwnd = <a class="code" href="../../d4/d1/userk_8h.html#a1530">DSW_GetTopLevelCreatorWindow</a>(pwnd);
00903 
00904             <span class="comment">/*</span>
00905 <span class="comment">             *  If we don't have an icon, find one</span>
00906 <span class="comment">             */</span>
00907             <span class="keywordflow">if</span> (!pIcon) {
00908                 <span class="comment">/*</span>
00909 <span class="comment">                 *  Try window icon</span>
00910 <span class="comment">                 */</span>
00911                 hIcon = (HICON)<a class="code" href="../../d7/d8/rtl_2winprop_8c.html#a2">_GetProp</a>(pwnd, <a class="code" href="../../d6/d1/userrtl_8h.html#a0">MAKEINTATOM</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o29">atomIconProp</a>), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a498">PROPF_INTERNAL</a>);
00912                 <span class="keywordflow">if</span> (hIcon) {
00913                     pIcon = (<a class="code" href="../../d1/d0/inc_2user_8h.html#a529">PICON</a>)<a class="code" href="../../d6/d9/rtl_2wow_8c.html#a8">HMValidateHandleNoRip</a>(hIcon, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a239">TYPE_CURSOR</a>);
00914                 }
00915 
00916                 <span class="comment">/*</span>
00917 <span class="comment">                 * If we don't have an icon yet, try the class icon</span>
00918 <span class="comment">                 */</span>
00919                 <span class="keywordflow">if</span> (!pIcon) {
00920                     pIcon = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;spicn;
00921                 }
00922 
00923                 <span class="comment">/*</span>
00924 <span class="comment">                 * If we don't have an icon yet, use WM_QUERYDRAGICON to ask</span>
00925 <span class="comment">                 * 3,x apps for their icon.</span>
00926 <span class="comment">                 */</span>
00927                 <span class="keywordflow">if</span> (!pIcon &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>)) {
00928                     <span class="comment">/*</span>
00929 <span class="comment">                     *  The callback routine will paint the icon for</span>
00930 <span class="comment">                     *  us, so just leave pIcon set to NULL</span>
00931 <span class="comment">                     */</span>
00932                     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwnd, &amp;tlpwnd);
00933                     <a class="code" href="../../d4/d1/userk_8h.html#a1583">xxxSendMessageCallback</a>(pwnd, WM_QUERYDRAGICON, 0, 0,
00934                             (SENDASYNCPROC)<a class="code" href="../../d1/d3/tmswitch_8c.html#a21">DrawIconCallBack</a>,
00935                             HandleToUlong(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pwndAltTab)), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00936                     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
00937                 } <span class="keywordflow">else</span> {
00938                     <span class="comment">/*</span>
00939 <span class="comment">                     *  If we can't find an icon, so use the Windows icon</span>
00940 <span class="comment">                     */</span>
00941                     <span class="keywordflow">if</span> (!pIcon) {
00942                         pIcon = <a class="code" href="../../d4/d1/userk_8h.html#a320">SYSICO</a>(WINLOGO);
00943                     }
00944                 }
00945             }
00946         }
00947 
00948         <span class="keywordflow">if</span> (pIcon) {
00949             <a class="code" href="../../d0/d9/wmicon_8c.html#a4">_DrawIconEx</a>(hdc, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>, pIcon, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXICON), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYICON),
00950                 0, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a22">SYSHBR</a>(3DFACE), DI_NORMAL);
00951         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fScroll) {
00952             <span class="comment">/*</span>
00953 <span class="comment">             *  NOT IN WIN95</span>
00954 <span class="comment">             *</span>
00955 <span class="comment">             *  No icon was available, do while we are waiting for the</span>
00956 <span class="comment">             *  application to paint it's icon, we need to "erase" the</span>
00957 <span class="comment">             *  background in case we have scrolled the window.</span>
00958 <span class="comment">             */</span>
00959             rcIcon.left = cx;
00960             rcIcon.top = <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
00961             rcIcon.right = cx + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXICON);
00962             rcIcon.bottom = <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYICON);
00963             <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a3">FillRect</a>(hdc, &amp;rcIcon, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a22">SYSHBR</a>(3DFACE));
00964         }
00965 
00966         <span class="comment">/*</span>
00967 <span class="comment">         *  Check if we are done.</span>
00968 <span class="comment">         */</span>
00969         <span class="keywordflow">if</span> (iNoOfIcons &lt;= 0)
00970             <span class="keywordflow">break</span>;
00971 
00972         <span class="comment">/*</span>
00973 <span class="comment">         *  Reset hIcon for the next run through the loop</span>
00974 <span class="comment">         */</span>
00975         pIcon = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00976 
00977         <span class="comment">/*</span>
00978 <span class="comment">         *  Move all pointers to the next task/icon.</span>
00979 <span class="comment">         */</span>
00980         phwnd = <a class="code" href="../../d1/d3/tmswitch_8c.html#a17">NextPrevPhwnd</a>(pswInfo, phwnd, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>); <span class="comment">// Get next.</span>
00981 
00982         <span class="comment">/*</span>
00983 <span class="comment">         *  Is it going to be in the same row; then adjust cx and cy.</span>
00984 <span class="comment">         */</span>
00985         <span class="keywordflow">if</span> (++iColumnIndex &gt;= pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o7">iNoOfColumns</a>) {
00986             iColumnIndex = 0;
00987             cx = xStart;        <span class="comment">// Move to first column</span>
00988             <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> += <a class="code" href="../../d1/d3/tmswitch_8c.html#a6">CYICONSLOT</a>;   <span class="comment">// Move to next row.</span>
00989             iStartRow++;
00990         } <span class="keywordflow">else</span> {
00991             <span class="comment">/*</span>
00992 <span class="comment">             *  else, adjust cx;</span>
00993 <span class="comment">             */</span>
00994             cx += <a class="code" href="../../d1/d3/tmswitch_8c.html#a5">CXICONSLOT</a>;
00995         }
00996 
00997         iStartTaskIndex = <a class="code" href="../../d1/d3/tmswitch_8c.html#a16">NextPrevTaskIndex</a>(pswInfo, iStartTaskIndex, 1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00998     }
00999 
01000 Cleanup:
01001     <span class="keywordflow">if</span> (fGetAndReleaseIt)
01002         <a class="code" href="../../d4/d1/userk_8h.html#a1697">_ReleaseDC</a>(hdc);
01003 }
01004 
01005 <span class="comment">/***************************************************************************\</span>
01006 <span class="comment">* PaintSwitchWindow</span>
01007 <span class="comment">*</span>
01008 <span class="comment">* History:</span>
01009 <span class="comment">* 02-Jun-1995 BradG     Ported from Win95</span>
01010 <span class="comment">\***************************************************************************/</span>
01011 
<a name="l01012"></a><a class="code" href="../../d1/d3/tmswitch_8c.html#a23">01012</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d1/d3/tmswitch_8c.html#a23">xxxPaintSwitchWindow</a>(
01013     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndSwitch)
01014 {
01015     LPRECT  lprcRect;
01016     RECT    rcRgn;
01017     HDC     hdcSwitch;
01018     <a class="code" href="../../d8/d7/structtagSwitchWndInfo.html">PSWINFO</a> pswCurrent;
01019     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwndSwitch);
01020 
01021     <span class="comment">/*</span>
01022 <span class="comment">     *  If our window isn't visible, return</span>
01023 <span class="comment">     */</span>
01024     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndSwitch, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>))
01025         <span class="keywordflow">return</span>;
01026 
01027     <span class="comment">/*</span>
01028 <span class="comment">     *  Get the switch window information</span>
01029 <span class="comment">     */</span>
01030     pswCurrent = <a class="code" href="../../d1/d3/tmswitch_8c.html#a11">Getpswi</a>(pwndSwitch);
01031     <span class="keywordflow">if</span> (!pswCurrent)
01032         <span class="keywordflow">return</span>;
01033 
01034     <span class="comment">/*</span>
01035 <span class="comment">     * Get the Switch windows DC so we can paint with it</span>
01036 <span class="comment">     */</span>
01037     hdcSwitch = <a class="code" href="../../d4/d1/userk_8h.html#a1695">_GetDCEx</a>(pwndSwitch, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, DCX_USESTYLE );
01038 
01039     <span class="comment">/*</span>
01040 <span class="comment">     *  Paint the background of the Switch Screen.</span>
01041 <span class="comment">     */</span>
01042     <span class="keywordflow">if</span> ((pswCurrent-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o16">fJournaling</a> &amp;&amp; <a class="code" href="../../d7/d9/keyboard_8c.html#a1">_GetKeyState</a>(VK_MENU) &gt;= 0) ||
01043             (!pswCurrent-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o16">fJournaling</a> &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a1714">_GetAsyncKeyState</a>(VK_MENU) &gt;= 0))
01044         <span class="keywordflow">goto</span> PSWExit;
01045 
01046     lprcRect = &amp;(pswCurrent-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o15">rcTaskName</a>);
01047     <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a19">_GetClientRect</a>(pwndSwitch, lprcRect);
01048     <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a3">FillRect</a>(hdcSwitch, lprcRect, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a22">SYSHBR</a>(3DFACE));
01049 
01050     <span class="comment">/*</span>
01051 <span class="comment">     * Store this "caption" area back into the current switch</span>
01052 <span class="comment">     * window data structure.</span>
01053 <span class="comment">     */</span>
01054     <a class="code" href="../../d3/d6/rect_8c.html#a7">InflateRect</a>(lprcRect, -(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a132">gcxCaptionFontChar</a> &lt;&lt; 1), -(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a133">gcyCaptionFontChar</a>));
01055     lprcRect-&gt;top = lprcRect-&gt;bottom - <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a133">gcyCaptionFontChar</a>;
01056 
01057     <span class="comment">/*</span>
01058 <span class="comment">     *  Draw the sunken edge for showing the task names.</span>
01059 <span class="comment">     */</span>
01060     <span class="keywordflow">if</span> ((pswCurrent-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o16">fJournaling</a> &amp;&amp; <a class="code" href="../../d7/d9/keyboard_8c.html#a1">_GetKeyState</a>(VK_MENU) &gt;= 0) ||
01061             (!pswCurrent-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o16">fJournaling</a> &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a1714">_GetAsyncKeyState</a>(VK_MENU) &gt;= 0))
01062         <span class="keywordflow">goto</span> PSWExit;
01063     <a class="code" href="../../d3/d6/rect_8c.html#a2">CopyInflateRect</a>(&amp;rcRgn, lprcRect, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a132">gcxCaptionFontChar</a> &gt;&gt; 1, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a133">gcyCaptionFontChar</a> &gt;&gt; 1);
01064     <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a15">DrawEdge</a>(hdcSwitch, &amp;rcRgn, EDGE_SUNKEN, BF_RECT);
01065 
01066     <span class="comment">/*</span>
01067 <span class="comment">     *  Paint the icons</span>
01068 <span class="comment">     */</span>
01069     <span class="keywordflow">if</span> ((pswCurrent-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o16">fJournaling</a> &amp;&amp; <a class="code" href="../../d7/d9/keyboard_8c.html#a1">_GetKeyState</a>(VK_MENU) &gt;= 0) ||
01070             (!pswCurrent-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o16">fJournaling</a> &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a1714">_GetAsyncKeyState</a>(VK_MENU) &gt;= 0))
01071         <span class="keywordflow">goto</span> PSWExit;
01072 
01073     <a class="code" href="../../d1/d3/tmswitch_8c.html#a10">xxxPaintIconsInSwitchWindow</a>(pwndSwitch,
01074                                 pswCurrent,
01075                                 hdcSwitch,
01076                                 pswCurrent-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o6">iFirstTaskIndex</a>,
01077                                 0,
01078                                 pswCurrent-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o4">iTasksShown</a>,
01079                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01080                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01081                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01082 
01083     <span class="comment">/*</span>
01084 <span class="comment">     *  So, just draw the hilite.</span>
01085 <span class="comment">     */</span>
01086     <span class="keywordflow">if</span> ((pswCurrent-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o16">fJournaling</a> &amp;&amp; <a class="code" href="../../d7/d9/keyboard_8c.html#a1">_GetKeyState</a>(VK_MENU) &gt;= 0) ||
01087             (!pswCurrent-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o16">fJournaling</a> &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a1714">_GetAsyncKeyState</a>(VK_MENU) &gt;= 0))
01088         <span class="keywordflow">goto</span> PSWExit;
01089 
01090     <a class="code" href="../../d1/d3/tmswitch_8c.html#a20">DrawSwitchWndHilite</a>(pswCurrent,
01091                         hdcSwitch,
01092                         pswCurrent-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o10">iCurCol</a>,
01093                         pswCurrent-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o11">iCurRow</a>,
01094                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01095 
01096     <span class="comment">/*</span>
01097 <span class="comment">     *  Release the switch windows DC</span>
01098 <span class="comment">     */</span>
01099 PSWExit:
01100     <a class="code" href="../../d4/d1/userk_8h.html#a1697">_ReleaseDC</a>(hdcSwitch);
01101 }
01102 
01103 <span class="comment">/***************************************************************************\</span>
01104 <span class="comment">* InitSwitchWndInfo()</span>
01105 <span class="comment">*</span>
01106 <span class="comment">* This function allocs and Initializes all the data structures</span>
01107 <span class="comment">* required the build and show the tasks in the system.</span>
01108 <span class="comment">* If there is insufficient mem, then this find the next window to switch</span>
01109 <span class="comment">* to and returns it. In this case, we will behave as if the end user hit</span>
01110 <span class="comment">* ALT+ESC. The SWitchScreen will not comeup in this case.</span>
01111 <span class="comment">* If there is only one task in the whole system, then this function</span>
01112 <span class="comment">* fails and returns a NULL. (No ALT+TAB processing is required).</span>
01113 <span class="comment">* Otherwise, it allocs one SwitchWndInfo struc, fills it up and returns</span>
01114 <span class="comment">* the window we gonna switch to.</span>
01115 <span class="comment">*</span>
01116 <span class="comment">* History:</span>
01117 <span class="comment">* 02-Jun-95 BradG       Ported from Win95</span>
01118 <span class="comment">\***************************************************************************/</span>
01119 
<a name="l01120"></a><a class="code" href="../../d1/d3/tmswitch_8c.html#a24">01120</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d1/d3/tmswitch_8c.html#a24">InitSwitchWndInfo</a>(
01121     <a class="code" href="../../d8/d7/structtagSwitchWndInfo.html">PSWINFO</a> *   lppswInfo,
01122     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndCurActive,
01123     BOOL        fPrev)
01124 {
01125     <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a>            pbwl;
01126     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>             iTotalTasks;
01127     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>             iCols, iRows, iIconsInLastRow;
01128     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>             iDiff;
01129     <a class="code" href="../../d4/d1/userk_8h.html#a944">PHWND</a>           phwndLast;
01130     <a class="code" href="../../d8/d7/structtagSwitchWndInfo.html">PSWINFO</a>         pswInfo;
01131     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>             iIconIndex;
01132     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>             iCurRow, iCurCol;
01133     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>             cxSwitch, cySwitch;
01134     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>             iFirstRowIcons;
01135     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>             iActiveTask;
01136     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>            pwnd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01137     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01138     <a class="code" href="../../d1/d3/structtagDESKTOPINFO.html">PDESKTOPINFO</a>    pdeskinfo = <a class="code" href="../../d4/d1/userk_8h.html#a256">GETDESKINFO</a>(ptiCurrent);
01139     <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>        pMonitor = <a class="code" href="../../d6/d0/usercli_8h.html#a793">GetPrimaryMonitor</a>();
01140 
01141     <span class="comment">/*</span>
01142 <span class="comment">     *  Initialize the list</span>
01143 <span class="comment">     */</span>
01144     *lppswInfo = (<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html">PSWINFO</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01145 
01146     <span class="comment">/*</span>
01147 <span class="comment">     *  Build the Window list of all the top level windows.</span>
01148 <span class="comment">     */</span>
01149 <span class="preprocessor">#if 0</span>
01150 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!(pbwl = <a class="code" href="../../d4/d1/userk_8h.html#a1157">BuildHwndList</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d1/userk_8h.html#a410">BWL_ENUMLIST</a> | BWL_ALLDESKTOPS, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)))
01151         <span class="keywordflow">goto</span> ReturnNextWnd;
01152 <span class="preprocessor">#else</span>
01153 <span class="preprocessor"></span><span class="comment">// BradG - HACK, enumerate on current desktop!</span>
01154 <span class="comment">//   For the long run, we will need to enumerate all desktops</span>
01155 <span class="comment">//   This will be tricky because we need to check the security of</span>
01156 <span class="comment">//   each desktop, thus needing the user's security "token".</span>
01157     <span class="keywordflow">if</span> (!(pbwl = <a class="code" href="../../d4/d1/userk_8h.html#a1157">BuildHwndList</a>(pdeskinfo-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>, <a class="code" href="../../d4/d1/userk_8h.html#a410">BWL_ENUMLIST</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))) {
01158 <span class="preprocessor">#ifdef COOLSWITCHTRACE</span>
01159 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CoolSwitch: BuildHwndList failed (contact bradg).\n"</span>);
01160         UserAssert(pbwl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01161 <span class="preprocessor">#endif</span>
01162 <span class="preprocessor"></span>        <span class="keywordflow">goto</span> ReturnNextWnd;
01163     }
01164 <span class="preprocessor">#endif</span>
01165 <span class="preprocessor"></span>
01166     <span class="comment">/*</span>
01167 <span class="comment">     *  Walk down the list and remove all non-task windows from the list.</span>
01168 <span class="comment">     *  Replace those hwnds with 0.</span>
01169 <span class="comment">     */</span>
01170     <span class="keywordflow">if</span> ((iTotalTasks = <a class="code" href="../../d1/d3/tmswitch_8c.html#a19">_RemoveNonTaskWindows</a>(pbwl, pwndCurActive, &amp;iActiveTask, &amp;phwndLast)) &lt; 2) {
01171         <span class="keywordflow">if</span> (iTotalTasks == 1) {
01172             <span class="comment">/*</span>
01173 <span class="comment">             *  If we have only one window and it's in full screen mode, we will</span>
01174 <span class="comment">             *  return the shell window so the can switch back to GDI mode.</span>
01175 <span class="comment">             */</span>
01176             pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o4">rghwnd</a>[0]);
01177             <span class="keywordflow">if</span> (pwnd &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a744">GetFullScreen</a>(pwnd) == FULLSCREEN &amp;&amp; pwndCurActive == pwnd)
01178                 pwnd = pdeskinfo-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o5">spwndShell</a>;
01179 
01180         } <span class="keywordflow">else</span> {
01181             pwnd = pdeskinfo-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o5">spwndShell</a>;
01182         }
01183 <span class="preprocessor">#ifdef COOLSWITCHTRACE</span>
01184 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CoolSwitch: Not enough windows to switch.\n"</span>);
01185 <span class="preprocessor">#endif</span>
01186 <span class="preprocessor"></span>        <span class="keywordflow">goto</span> FreeAndReturnNextWnd;  <span class="comment">// If there isn't even two tasks, no switch wnd processing.</span>
01187     }
01188 
01189     <span class="comment">/*</span>
01190 <span class="comment">     *  Allocate the Switch Info structure.  If we don't have enough</span>
01191 <span class="comment">     *  memory, act as if we are doing Alt+Esc.</span>
01192 <span class="comment">     */</span>
01193     <span class="keywordflow">if</span> (!(pswInfo = (<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html">PSWINFO</a>)UserAllocPoolWithQuota(<span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html">SWITCHWNDINFO</a>), TAG_ALTTAB))) {
01194 <span class="preprocessor">#ifdef COOLSWITCHTRACE</span>
01195 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CoolSwitch: UserAllocPool failed on 0x%X bytes (contact bradg).\n"</span>, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/userk_8h.html#a945">SWITCHWNDINFO</a>));
01196         UserAssert(pswInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01197 <span class="preprocessor">#endif</span>
01198 <span class="preprocessor"></span>        <span class="keywordflow">goto</span> FreeAndReturnNextWnd;  <span class="comment">// Unable to alloc SwitchWndInfo struct.</span>
01199     }
01200 
01201     pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o0">pbwl</a>        = pbwl;
01202     pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o1">phwndLast</a>   = phwndLast;
01203     pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o4">iTasksShown</a> = pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o3">iTotalTasks</a> = iTotalTasks;
01204 
01205     <span class="comment">/*</span>
01206 <span class="comment">     *  Get the next/prev window that must become active.</span>
01207 <span class="comment">     */</span>
01208     iIconIndex = <a class="code" href="../../d1/d3/tmswitch_8c.html#a16">NextPrevTaskIndex</a>(pswInfo, iActiveTask, 1, !fPrev);
01209     pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o2">phwndCurrent</a> = &amp;(pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o4">rghwnd</a>[iIconIndex]);
01210 
01211     iCols = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a127">gnFastAltTabColumns</a>, iTotalTasks);
01212     iRows = iTotalTasks / iCols;  <span class="comment">// Truncation might occur.</span>
01213 
01214     iIconsInLastRow = iTotalTasks - iRows * iCols;
01215     iRows += (iIconsInLastRow ? 1 : 0);  <span class="comment">// Take care of earlier truncation.</span>
01216 
01217     <span class="comment">/*</span>
01218 <span class="comment">     *  Restrict the number of rows to just MAXROWSALLOWED (3)</span>
01219 <span class="comment">     */</span>
01220     <span class="keywordflow">if</span> (iRows &gt; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a126">gnFastAltTabRows</a>) {
01221         iRows = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a126">gnFastAltTabRows</a>;
01222         pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o5">fScroll</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;    <span class="comment">// We need to scroll.</span>
01223         iIconsInLastRow = iCols;
01224         pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o4">iTasksShown</a> = iCols * iRows;
01225     } <span class="keywordflow">else</span> {
01226         pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o5">fScroll</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01227     }
01228 
01229     pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o7">iNoOfColumns</a> = iCols;
01230     pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o8">iNoOfRows</a>    = iRows;
01231 
01232     <span class="keywordflow">if</span> (iIconsInLastRow == 0)
01233        iIconsInLastRow = pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o7">iNoOfColumns</a>; <span class="comment">// Last Row is full.</span>
01234     pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o9">iIconsInLastRow</a> = iIconsInLastRow;
01235 
01236     <span class="comment">/*</span>
01237 <span class="comment">     *  Find out Row and Col where the next/prev icon will lie.</span>
01238 <span class="comment">     */</span>
01239     <span class="keywordflow">if</span> (iIconIndex &gt;= (iRows * iCols)) {
01240         <span class="comment">/*</span>
01241 <span class="comment">         *  Next Icon lies outside. Bring it to the center.</span>
01242 <span class="comment">         */</span>
01243         iCurRow = (iRows &gt;&gt; 2) + 1;
01244         iCurCol = (iCols &gt;&gt; 2) + 1;
01245         iDiff = (iIconIndex - ((iCurRow * iCols) + iCurCol));
01246     } <span class="keywordflow">else</span> {
01247         iDiff = 0;
01248         iCurRow = iIconIndex / iCols;
01249         iCurCol = iIconIndex - (iCurRow * iCols);
01250     }
01251 
01252     pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o6">iFirstTaskIndex</a> = iDiff;
01253     pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o11">iCurRow</a>         = iCurRow;
01254     pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o10">iCurCol</a>         = iCurCol;
01255 
01256     <span class="comment">/*</span>
01257 <span class="comment">     *  Calculate the Switch Window Dimensions.</span>
01258 <span class="comment">     */</span>
01259     cxSwitch = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(
01260             pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.right - pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.left,
01261             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a127">gnFastAltTabColumns</a> * <a class="code" href="../../d1/d3/tmswitch_8c.html#a5">CXICONSLOT</a> +
01262                 <a class="code" href="../../d1/d3/tmswitch_8c.html#a7">CXICONSIZE</a> / 2 +
01263                 6 * <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;gclBorder * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXBORDER) +
01264                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a132">gcxCaptionFontChar</a>);
01265 
01266     cySwitch = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(
01267             pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.bottom - pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.top,
01268             iRows * <a class="code" href="../../d1/d3/tmswitch_8c.html#a6">CYICONSLOT</a> +
01269                 <a class="code" href="../../d1/d3/tmswitch_8c.html#a8">CYICONSIZE</a> +
01270                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a133">gcyCaptionFontChar</a> * 2 +
01271                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a133">gcyCaptionFontChar</a> / 2);
01272 
01273     <span class="comment">/*</span>
01274 <span class="comment">     *  Find the number of icons in first row</span>
01275 <span class="comment">     */</span>
01276     <span class="keywordflow">if</span> (iRows == 1) {
01277         iFirstRowIcons = iIconsInLastRow;
01278     } <span class="keywordflow">else</span> {
01279         iFirstRowIcons = iCols;
01280     }
01281 
01282     <span class="comment">/*</span>
01283 <span class="comment">     *  Center the icons based on the number of icons in first row.</span>
01284 <span class="comment">     */</span>
01285     pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o14">ptFirstRowStart</a>.x = (cxSwitch - 4*<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;gclBorder*<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXBORDER) - iFirstRowIcons * <a class="code" href="../../d1/d3/tmswitch_8c.html#a5">CXICONSLOT</a>) &gt;&gt; 1;
01286     pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o14">ptFirstRowStart</a>.y = (<a class="code" href="../../d1/d3/tmswitch_8c.html#a8">CYICONSIZE</a> &gt;&gt; 1);
01287 
01288     pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o12">cxSwitch</a> = cxSwitch;
01289     pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o13">cySwitch</a> = cySwitch;
01290 
01291     *lppswInfo = pswInfo;
01292 
01293     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(*(pswInfo-&gt;phwndCurrent));  <span class="comment">// Success!</span>
01294 
01295 
01296     <span class="comment">/*</span>
01297 <span class="comment">     *  When there is insufficient mem to create the reqd structures, we simply</span>
01298 <span class="comment">     *  return the next window. We make the phwndInfo as NULL. So, we won't</span>
01299 <span class="comment">     *  attempt to draw the switch window.</span>
01300 <span class="comment">     */</span>
01301 
01302 FreeAndReturnNextWnd:
01303     <a class="code" href="../../d4/d1/userk_8h.html#a1158">FreeHwndList</a>(pbwl);
01304 ReturnNextWnd:
01305     <span class="keywordflow">if</span> (pwnd)
01306         <span class="keywordflow">return</span>(pwnd);
01307 
01308     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d1/userk_8h.html#a1893">_GetNextQueueWindow</a>(pwndCurActive, <a class="code" href="../../d7/d9/keyboard_8c.html#a1">_GetKeyState</a>(VK_SHIFT) &lt; 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>));
01309 }
01310 
01311 <span class="comment">/***************************************************************************\</span>
01312 <span class="comment">* xxxMoveSwitchWndHilite()</span>
01313 <span class="comment">*</span>
01314 <span class="comment">* This moves the Hilite to the next/prev icon.</span>
01315 <span class="comment">* Checks if this move results in a scrolling. If it does, then</span>
01316 <span class="comment">* make sure scroll occurs.</span>
01317 <span class="comment">* Else, erase hilite from the current icon;</span>
01318 <span class="comment">* Then draw hilite on the new Icon.</span>
01319 <span class="comment">* fPrev indicates whether you want the prev task or next.</span>
01320 <span class="comment">*</span>
01321 <span class="comment">* History:</span>
01322 <span class="comment">* 02-Jun-1995 BradG     Ported from Win95</span>
01323 <span class="comment">\***************************************************************************/</span>
01324 
<a name="l01325"></a><a class="code" href="../../d1/d3/tmswitch_8c.html#a25">01325</a> HWND <a class="code" href="../../d1/d3/tmswitch_8c.html#a25">xxxMoveSwitchWndHilite</a>(
01326     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>    pwndSwitch,
01327     <a class="code" href="../../d8/d7/structtagSwitchWndInfo.html">PSWINFO</a> pswInfo,
01328     BOOL    fPrev)
01329 {
01330     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>  iCurCol, iCurRow;
01331     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>  iMaxColumns;
01332     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fLastRow;
01333     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fNeedToScroll = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01334     HDC  hdc;
01335 
01336     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwndSwitch);
01337     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
01338 
01339     iCurCol = pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o10">iCurCol</a>;
01340     iCurRow = pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o11">iCurRow</a>;
01341 
01342     <span class="comment">/*</span>
01343 <span class="comment">     *  Find out the new postion (row and column) of hilite.</span>
01344 <span class="comment">     */</span>
01345     <span class="keywordflow">if</span> (fPrev) {
01346         <span class="keywordflow">if</span> (iCurCol &gt; 0) {
01347             <span class="comment">/*</span>
01348 <span class="comment">             *  Move cursor to prev column on the same row.</span>
01349 <span class="comment">             */</span>
01350             iCurCol--;
01351         } <span class="keywordflow">else</span> {
01352             <span class="comment">/*</span>
01353 <span class="comment">             *  Try to move to the previous row.</span>
01354 <span class="comment">             */</span>
01355             <span class="keywordflow">if</span> (iCurRow &gt; 0) {
01356                 <span class="comment">/*</span>
01357 <span class="comment">                 *  Move to the last column on the previous row.</span>
01358 <span class="comment">                 */</span>
01359                 iCurRow--;
01360                 iCurCol = pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o7">iNoOfColumns</a> - 1;
01361             } <span class="keywordflow">else</span> {
01362                 <span class="comment">/*</span>
01363 <span class="comment">                 *  We are already at (0,0); See if we need to scroll.</span>
01364 <span class="comment">                 */</span>
01365                 <span class="keywordflow">if</span> (pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o5">fScroll</a>) {
01366                     <span class="comment">/*</span>
01367 <span class="comment">                     * Time to scroll; Scroll by one Row;</span>
01368 <span class="comment">                     * Repaint the whole window.</span>
01369 <span class="comment">                     */</span>
01370                     fNeedToScroll = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01371                     pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o6">iFirstTaskIndex</a> = <a class="code" href="../../d1/d3/tmswitch_8c.html#a16">NextPrevTaskIndex</a>(pswInfo, pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o6">iFirstTaskIndex</a>,
01372                       pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o7">iNoOfColumns</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01373                     iCurCol = pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o7">iNoOfColumns</a> - 1;
01374                 } <span class="keywordflow">else</span> {
01375                     <span class="comment">/*</span>
01376 <span class="comment">                     *  Move the hilite to the last icon shown.</span>
01377 <span class="comment">                     */</span>
01378                     iCurRow = pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o8">iNoOfRows</a> - 1;
01379                     iCurCol = pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o9">iIconsInLastRow</a> - 1;
01380                 }
01381             }
01382         }
01383 
01384     } <span class="keywordflow">else</span> {
01385         <span class="comment">/*</span>
01386 <span class="comment">         *  !fPrev</span>
01387 <span class="comment">         *  Get the number of columns in the current row.</span>
01388 <span class="comment">         */</span>
01389         <span class="keywordflow">if</span> (fLastRow = (iCurRow == (pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o8">iNoOfRows</a> - 1))) <span class="comment">// Are we at the last row?</span>
01390             iMaxColumns = pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o9">iIconsInLastRow</a>;
01391         <span class="keywordflow">else</span>
01392             iMaxColumns = pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o7">iNoOfColumns</a>;
01393 
01394         <span class="comment">/*</span>
01395 <span class="comment">         *  Are we at the last column yet?</span>
01396 <span class="comment">         */</span>
01397         <span class="keywordflow">if</span> (iCurCol &lt; (iMaxColumns - 1)) {
01398             <span class="comment">/*</span>
01399 <span class="comment">             *  No! Move to the right.</span>
01400 <span class="comment">             */</span>
01401             iCurCol++;
01402         } <span class="keywordflow">else</span> {
01403             <span class="comment">/*</span>
01404 <span class="comment">             *  We are at the last column.</span>
01405 <span class="comment">             *  If we are not at last row, then move to next row.</span>
01406 <span class="comment">             */</span>
01407             <span class="keywordflow">if</span> (!fLastRow) {
01408                 iCurCol = 0;
01409                 iCurRow++;
01410             } <span class="keywordflow">else</span> {
01411                 <span class="comment">/*</span>
01412 <span class="comment">                 *  We are at the last row, last col;</span>
01413 <span class="comment">                 *  See if we need to scroll.</span>
01414 <span class="comment">                 */</span>
01415                 <span class="keywordflow">if</span> (pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o5">fScroll</a>) {
01416                     fNeedToScroll = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01417                     pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o6">iFirstTaskIndex</a> = <a class="code" href="../../d1/d3/tmswitch_8c.html#a16">NextPrevTaskIndex</a>(pswInfo, pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o6">iFirstTaskIndex</a>,
01418                           pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o7">iNoOfColumns</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01419                     iCurCol = 0;
01420                 } <span class="keywordflow">else</span> {
01421                     <span class="comment">/*</span>
01422 <span class="comment">                     *  Move to the top left corner (0, 0).</span>
01423 <span class="comment">                     */</span>
01424                     iCurRow = iCurCol = 0;
01425                 }
01426             }
01427         }
01428     }
01429 
01430     <span class="comment">/*</span>
01431 <span class="comment">     *  Move the phwnd to the next/prev</span>
01432 <span class="comment">     */</span>
01433     pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o2">phwndCurrent</a> = <a class="code" href="../../d1/d3/tmswitch_8c.html#a17">NextPrevPhwnd</a>(pswInfo, pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o2">phwndCurrent</a>, !fPrev);
01434 
01435     <span class="comment">/*</span>
01436 <span class="comment">     *  Remove Hilite from the current location.</span>
01437 <span class="comment">     */</span>
01438     hdc = <a class="code" href="../../d4/d1/userk_8h.html#a1695">_GetDCEx</a>(pwndSwitch, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, DCX_USESTYLE);
01439     <a class="code" href="../../d1/d3/tmswitch_8c.html#a20">DrawSwitchWndHilite</a>(pswInfo, hdc, pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o10">iCurCol</a>, pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o11">iCurRow</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01440 
01441     <span class="comment">/*</span>
01442 <span class="comment">     *  Repaint if needed.</span>
01443 <span class="comment">     */</span>
01444     <span class="keywordflow">if</span> (fNeedToScroll)
01445         <a class="code" href="../../d1/d3/tmswitch_8c.html#a10">xxxPaintIconsInSwitchWindow</a>(pwndSwitch, pswInfo, hdc, pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o6">iFirstTaskIndex</a>, 0, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, !fPrev, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01446 
01447     <span class="comment">/*</span>
01448 <span class="comment">     *  Draw Hilite at the new location.</span>
01449 <span class="comment">     */</span>
01450     <a class="code" href="../../d1/d3/tmswitch_8c.html#a20">DrawSwitchWndHilite</a>(pswInfo, hdc, iCurCol, iCurRow, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01451 
01452     <a class="code" href="../../d4/d1/userk_8h.html#a1697">_ReleaseDC</a>(hdc);
01453 
01454     pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o11">iCurRow</a> = iCurRow;
01455     pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o10">iCurCol</a> = iCurCol;
01456 
01457     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
01458         <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a8">xxxWindowEvent</a>(EVENT_OBJECT_FOCUS, pwndSwitch, OBJID_CLIENT,
01459             iCurRow * pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o7">iNoOfColumns</a> + iCurCol + 1, <a class="code" href="../../d4/d1/userk_8h.html#a610">WEF_USEPWNDTHREAD</a>);
01460     }
01461 
01462     <span class="keywordflow">return</span> (*(pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o2">phwndCurrent</a>));
01463 }
01464 
01465 <span class="comment">/***************************************************************************\</span>
01466 <span class="comment">* xxxShowSwitchWindow()</span>
01467 <span class="comment">*</span>
01468 <span class="comment">* Show the switch Window.</span>
01469 <span class="comment">* Returns: TRUE if succeeded.   FALSE, if the window was not shown because</span>
01470 <span class="comment">* of the pre-mature release of ALT key. The selection has been made already.</span>
01471 <span class="comment">*</span>
01472 <span class="comment">* History:</span>
01473 <span class="comment">* 07-Jun-1995 BradG     Ported from Win95</span>
01474 <span class="comment">\***************************************************************************/</span>
01475 
<a name="l01476"></a><a class="code" href="../../d1/d3/tmswitch_8c.html#a26">01476</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d1/d3/tmswitch_8c.html#a26">xxxShowSwitchWindow</a>(
01477         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndAltTab)
01478 {
01479     <a class="code" href="../../d8/d7/structtagSwitchWndInfo.html">PSWINFO</a> pswInfo;
01480     <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a> pMonitorSwitch = <a class="code" href="../../d6/d0/usercli_8h.html#a793">GetPrimaryMonitor</a>();
01481     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwndAltTab);
01482     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
01483 
01484     <span class="comment">/*</span>
01485 <span class="comment">     *  Get the switch window information</span>
01486 <span class="comment">     */</span>
01487     pswInfo = <a class="code" href="../../d1/d3/tmswitch_8c.html#a11">Getpswi</a>(pwndAltTab);
01488     UserAssert(pswInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01489 
01490     <span class="comment">/*</span>
01491 <span class="comment">     *  If the key is not down, don't bother to display Switch Window.</span>
01492 <span class="comment">     */</span>
01493     <span class="keywordflow">if</span> ((pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o16">fJournaling</a> &amp;&amp; <a class="code" href="../../d7/d9/keyboard_8c.html#a1">_GetKeyState</a>(VK_MENU) &gt;= 0) ||
01494             (!pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o16">fJournaling</a> &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a1714">_GetAsyncKeyState</a>(VK_MENU) &gt;= 0)) {
01495 <span class="preprocessor">#ifdef COOLSWITCHTRACE</span>
01496 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CoolSwitch: Not displaying window because VM_MENU is up (contact bradg).\n"</span>);
01497 <span class="preprocessor">#endif</span>
01498 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01499     }
01500 
01501     <span class="comment">/*</span>
01502 <span class="comment">     *  Bring and position the window on top.</span>
01503 <span class="comment">     */</span>
01504     <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(pwndAltTab, <a class="code" href="../../d4/d1/userk_8h.html#a455">PWND_TOPMOST</a>, 0,0,0,0,
01505         SWP_NOACTIVATE | SWP_NOSIZE | SWP_NOMOVE | SWP_NOREDRAW );
01506 
01507     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndAltTab, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)) {
01508         <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(
01509             pwndAltTab,
01510             <a class="code" href="../../d4/d1/userk_8h.html#a455">PWND_TOPMOST</a>,
01511             (pMonitorSwitch-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.left + pMonitorSwitch-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.right - pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o12">cxSwitch</a>) / 2,
01512             (pMonitorSwitch-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.top + pMonitorSwitch-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.bottom - pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o13">cySwitch</a>) / 2,
01513             pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o12">cxSwitch</a>,
01514             pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o13">cySwitch</a>,
01515             SWP_SHOWWINDOW | SWP_NOACTIVATE);
01516     }
01517 <span class="preprocessor">#ifdef COOLSWITCHTRACE</span>
01518 <span class="preprocessor"></span>    UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndAltTab, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>));
01519 <span class="preprocessor">#endif</span>
01520 <span class="preprocessor"></span>    <a class="code" href="../../d4/d1/userk_8h.html#a1673">xxxUpdateWindow</a>(pwndAltTab);
01521 
01522     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
01523         <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a8">xxxWindowEvent</a>(EVENT_SYSTEM_SWITCHSTART, pwndAltTab, OBJID_CLIENT,
01524                 0, <a class="code" href="../../d4/d1/userk_8h.html#a610">WEF_USEPWNDTHREAD</a>);
01525         <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a8">xxxWindowEvent</a>(EVENT_OBJECT_FOCUS, pwndAltTab, OBJID_CLIENT,
01526                 pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o11">iCurRow</a> * pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o7">iNoOfColumns</a> + pswInfo-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o10">iCurCol</a> + 1,
01527                 <a class="code" href="../../d4/d1/userk_8h.html#a610">WEF_USEPWNDTHREAD</a>);
01528     }
01529 
01530     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01531 }
01532 
01533 <span class="comment">/***************************************************************************\</span>
01534 <span class="comment">* SwitchWndCleanup()</span>
01535 <span class="comment">*</span>
01536 <span class="comment">* Clean up all the mem allocated etc.,</span>
01537 <span class="comment">*</span>
01538 <span class="comment">* History:</span>
01539 <span class="comment">* 07-Jun-1995 BradG     Ported from Win95</span>
01540 <span class="comment">\***************************************************************************/</span>
01541 
<a name="l01542"></a><a class="code" href="../../d1/d3/tmswitch_8c.html#a27">01542</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d1/d3/tmswitch_8c.html#a27">SwitchWndCleanup</a>(
01543     <a class="code" href="../../d8/d7/structtagSwitchWndInfo.html">PSWINFO</a> *ppswInfo)
01544 {
01545     UserAssert(ppswInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01546     UserAssert(*ppswInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01547 
01548     <span class="comment">/*</span>
01549 <span class="comment">     *  First of all free the Window list.</span>
01550 <span class="comment">     */</span>
01551     <span class="keywordflow">if</span> ((*ppswInfo)-&gt;pbwl)
01552         <a class="code" href="../../d4/d1/userk_8h.html#a1158">FreeHwndList</a>((*ppswInfo)-&gt;pbwl);
01553     UserFreePool(*ppswInfo);
01554     *ppswInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01555 }
01556 
01557 
01558 <span class="comment">/***************************************************************************\</span>
01559 <span class="comment">*</span>
01560 <span class="comment">*  xxxSwitchWndProc()</span>
01561 <span class="comment">*</span>
01562 <span class="comment">\***************************************************************************/</span>
01563 
<a name="l01564"></a><a class="code" href="../../d4/d1/userk_8h.html#a1482">01564</a> LRESULT <a class="code" href="../../d4/d1/userk_8h.html#a1482">xxxSwitchWndProc</a>(
01565     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwnd,
01566     UINT  message,
01567     WPARAM wParam,
01568     LPARAM lParam)
01569 {
01570     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlpwndActivate;
01571     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01572 
01573     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
01574     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
01575 
01576     <a class="code" href="../../d6/d0/usercli_8h.html#a28">VALIDATECLASSANDSIZE</a>(pwnd, message, wParam, lParam, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a221">FNID_SWITCH</a>, WM_CREATE);
01577 
01578     <span class="keywordflow">switch</span> (message) {
01579     <span class="keywordflow">case</span> WM_CREATE:
01580         <span class="comment">/*</span>
01581 <span class="comment">         * When the queue was created, the cursor was set to the wait cursor.</span>
01582 <span class="comment">         * We want to use the normal one.</span>
01583 <span class="comment">         */</span>
01584         <a class="code" href="../../d4/d1/userk_8h.html#a1785">zzzSetCursor</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;spcur);
01585         <span class="keywordflow">break</span>;
01586 
01587     <span class="keywordflow">case</span> WM_CLOSE:
01588         <span class="comment">/*</span>
01589 <span class="comment">         *  Hide this window without activating anyone else.</span>
01590 <span class="comment">         */</span>
01591         <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(pwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, 0, 0, 0, SWP_HIDEWINDOW |
01592                 SWP_NOACTIVATE | SWP_NOMOVE | SWP_NOSIZE | SWP_NOZORDER);
01593 
01594         <span class="comment">/*</span>
01595 <span class="comment">         * Get us out of Alt+Tab mode.  Since the alttab information</span>
01596 <span class="comment">         * is stored in the gptiRit-&gt;pq, we will reference that insteatd</span>
01597 <span class="comment">         * of the current-thread.</span>
01598 <span class="comment">         */</span>
01599         <a class="code" href="../../d1/d3/tmswitch_8c.html#a29">xxxCancelCoolSwitch</a>();
01600         <span class="keywordflow">break</span>;
01601 
01602     <span class="keywordflow">case</span> WM_ERASEBKGND:
01603     <span class="keywordflow">case</span> WM_FULLSCREEN:
01604         <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pwnd, &amp;tlpwndActivate);
01605         <a class="code" href="../../d1/d3/tmswitch_8c.html#a23">xxxPaintSwitchWindow</a>(pwnd);
01606         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndActivate);
01607         <span class="keywordflow">return</span> 0;
01608 
01609     <span class="keywordflow">case</span> WM_DESTROY:
01610         {
01611             <span class="comment">/*</span>
01612 <span class="comment">             *  Get the switch window info for this window</span>
01613 <span class="comment">             */</span>
01614             <a class="code" href="../../d8/d7/structtagSwitchWndInfo.html">PSWINFO</a> pswCurrent = <a class="code" href="../../d1/d3/tmswitch_8c.html#a11">Getpswi</a>(pwnd);
01615 
01616 
01617             <span class="keywordflow">if</span> (pswCurrent)
01618                 <a class="code" href="../../d1/d3/tmswitch_8c.html#a27">SwitchWndCleanup</a>(&amp;pswCurrent);
01619         }
01620         <span class="keywordflow">break</span>;
01621     }
01622 
01623     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1632">xxxDefWindowProc</a>(pwnd, message, wParam, lParam);
01624 }
01625 
01626 <span class="comment">/***************************************************************************\</span>
01627 <span class="comment">* xxxCancelCoolSwitch</span>
01628 <span class="comment">*</span>
01629 <span class="comment">* This functions destroys the cool switch window and removed the INALTTAB</span>
01630 <span class="comment">* mode flag from the specified queue.</span>
01631 <span class="comment">*</span>
01632 <span class="comment">* History:</span>
01633 <span class="comment">* 18-Sep-1995 BradG     Created</span>
01634 <span class="comment">\***************************************************************************/</span>
<a name="l01635"></a><a class="code" href="../../d4/d1/userk_8h.html#a1513">01635</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d1/d3/tmswitch_8c.html#a29">xxxCancelCoolSwitch</a>(
01636     <span class="keywordtype">void</span>)
01637 {
01638     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
01639     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
01640 
01641     <span class="comment">/*</span>
01642 <span class="comment">     *  Destroy the Cool Switch window</span>
01643 <span class="comment">     */</span>
01644     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01645 
01646         <span class="comment">/*</span>
01647 <span class="comment">         * Make sure that the thread calling this is the same</span>
01648 <span class="comment">         * thread which created the alttab window.  Otherwise,</span>
01649 <span class="comment">         * we could end up with this window floating around until</span>
01650 <span class="comment">         * the calling process dies.  Remember, we can't destroy</span>
01651 <span class="comment">         * windows across different threads.</span>
01652 <span class="comment">         */</span>
01653         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.pti != <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>())
01654             <span class="keywordflow">return</span>;
01655 
01656         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
01657             <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a8">xxxWindowEvent</a>(EVENT_SYSTEM_SWITCHEND, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a>, OBJID_CLIENT,
01658                 0, <a class="code" href="../../d4/d1/userk_8h.html#a610">WEF_USEPWNDTHREAD</a>);
01659         }
01660         <a class="code" href="../../d4/d1/userk_8h.html#a1575">xxxDestroyWindow</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a>);
01661 
01662         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01663     }
01664 }
01665 
01666 <span class="comment">/***************************************************************************\</span>
01667 <span class="comment">* xxxNextWindow</span>
01668 <span class="comment">*</span>
01669 <span class="comment">* This function does the processing for the alt-tab/esc/F6 UI.</span>
01670 <span class="comment">*</span>
01671 <span class="comment">* History:</span>
01672 <span class="comment">* 30-May-1991 DavidPe       Created.</span>
01673 <span class="comment">\***************************************************************************/</span>
01674 
<a name="l01675"></a><a class="code" href="../../d4/d1/userk_8h.html#a1511">01675</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1511">xxxNextWindow</a>(
01676     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a>    pq,
01677     DWORD wParam)
01678 {
01679     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndActivateNext;
01680     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndCurrentActivate, pwndCurrentTopFocus;
01681     <span class="keywordtype">int</span>         fDir;
01682     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlpwndActivateNext;
01683     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlpwndCurrentActivate;
01684     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlpwndT;
01685     <a class="code" href="../../d8/d7/structtagSwitchWndInfo.html">PSWINFO</a>     pswCurrent;
01686     ULONG_PTR    dwResult;
01687     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fNonRit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01688     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01689     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiAltTab;
01690 
01691     UserAssert(!<a class="code" href="../../d4/d1/userk_8h.html#a615">IsWinEventNotifyDeferred</a>());
01692 
01693     <span class="comment">/*</span>
01694 <span class="comment">     * HACK: We have a problem with direct-draw full apps where an alttab</span>
01695 <span class="comment">     *       window is created on a queue owned other than the RIT.  This</span>
01696 <span class="comment">     *       shows up by alt-tabbing away from ROIDS.EXE during fullscreen.</span>
01697 <span class="comment">     *</span>
01698 <span class="comment">     *       What is happening is on a ALT-TAB, from xxxSysCommand(), the</span>
01699 <span class="comment">     *       thread is not a rit.  xxxSysCommand() calls xxxOldNextWindow</span>
01700 <span class="comment">     *       which finds that the current-thread doesn't have a switch</span>
01701 <span class="comment">     *       window, and then creates one on the current-thread-queue.</span>
01702 <span class="comment">     *</span>
01703 <span class="comment">     *       The hack here is to make sure the calling thread is the RIT</span>
01704 <span class="comment">     *       before allowing any cool-switch creation.</span>
01705 <span class="comment">     *</span>
01706 <span class="comment">     *       21-Mar-1996 : Chriswil</span>
01707 <span class="comment">     */</span>
01708 <span class="preprocessor">#if 0</span>
01709 <span class="preprocessor"></span>    ptiAltTab = ptiCurrent;
01710 <span class="preprocessor">#else</span>
01711 <span class="preprocessor"></span>    ptiAltTab = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>;
01712 <span class="preprocessor">#endif</span>
01713 <span class="preprocessor"></span>
01714     <span class="keywordflow">if</span> (pq == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01715         <span class="keywordflow">return</span>;
01716 
01717     fDir = (<a class="code" href="../../d4/d1/userk_8h.html#a1714">_GetAsyncKeyState</a>(VK_SHIFT) &lt; 0) ? <a class="code" href="../../d1/d3/tmswitch_8c.html#a4">FDIR_BACKWARD</a> : <a class="code" href="../../d1/d3/tmswitch_8c.html#a3">FDIR_FORWARD</a>;
01718 
01719     <span class="comment">/*</span>
01720 <span class="comment">     *  NOTE: As of NT 4.0 the slow Alt+Tab functionality now officially acts</span>
01721 <span class="comment">     *  like Alt+Esc with the exception that Alt+Tab will activate the window</span>
01722 <span class="comment">     *  where Alt+Esc will not.</span>
01723 <span class="comment">     */</span>
01724     <span class="keywordflow">switch</span> (wParam) {
01725 
01726     <span class="keywordflow">case</span> VK_TAB:
01727 
01728         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01729 
01730             <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndSwitch;
01731             <a class="code" href="../../d5/d1/struct__TL.html">TL</a>   tlpSwitchInfo;
01732 
01733             <span class="comment">/*</span>
01734 <span class="comment">             *  We are entering Alt+Tab for the first time, we need to</span>
01735 <span class="comment">             *  initialize the Switch Window structure and if needed</span>
01736 <span class="comment">             *  create and display the Alt+Tab window.  We have two special</span>
01737 <span class="comment">             *  cases: (1) The user does not want to use the Switch window,</span>
01738 <span class="comment">             *  (2) The initialize switch window fails thus we will act</span>
01739 <span class="comment">             *  just like slow Alt+Tab</span>
01740 <span class="comment">             */</span>
01741 
01742             <span class="comment">/*</span>
01743 <span class="comment">             * Since Alt+Shift is the default hotkey for keyboard layout switching,</span>
01744 <span class="comment">             * Alt+Shift+Tab may cause a KL switching while AltTab window is up.</span>
01745 <span class="comment">             * To prevent it, we'd better reset the global toggle key state here,</span>
01746 <span class="comment">             * so that xxxScanSysQueue will not confuse when it handles keyup messages.</span>
01747 <span class="comment">             */</span>
01748             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a66">gLangToggleKeyState</a> = <a class="code" href="../../d4/d1/userk_8h.html#a284">KLT_NONE</a>;
01749 
01750             <span class="comment">/*</span>
01751 <span class="comment">             * Mouse buttons sometimes get stuck down due to hardware glitches,</span>
01752 <span class="comment">             * usually due to input concentrator switchboxes or faulty serial</span>
01753 <span class="comment">             * mouse COM ports, so clear the global button state here just in case,</span>
01754 <span class="comment">             * otherwise we may not be able to change focus with the mouse.</span>
01755 <span class="comment">             * Also do this in zzzCancelJournalling (Ctr-Esc, Ctrl-Alt-Del, etc.)</span>
01756 <span class="comment">             */</span>
01757 <span class="preprocessor">#if DBG</span>
01758 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a92">gwMouseOwnerButton</a>)
01759                 RIPMSG1(RIP_WARNING,
01760                         <span class="stringliteral">"gwMouseOwnerButton=%x, being forcibly cleared\n"</span>,
01761                         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a92">gwMouseOwnerButton</a>);
01762 <span class="preprocessor">#endif</span>
01763 <span class="preprocessor"></span>            <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a92">gwMouseOwnerButton</a> = 0;
01764 
01765             <span class="comment">/*</span>
01766 <span class="comment">             *  Determine the current active window.</span>
01767 <span class="comment">             */</span>
01768             <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a88">gspwndActivate</a>, pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>);
01769             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a88">gspwndActivate</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01770                 <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a88">gspwndActivate</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>);
01771             }
01772 
01773             <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a88">gspwndActivate</a>) {
01774                 <span class="keywordflow">return</span>;
01775             }
01776 
01777             <span class="comment">/*</span>
01778 <span class="comment">             *  Make a local copy of gspwndActivate and lock it because xxxFreeWindow will</span>
01779 <span class="comment">             *  unlock if it is the window being freed.</span>
01780 <span class="comment">             */</span>
01781             pwndCurrentActivate = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a88">gspwndActivate</a>;
01782             <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwndCurrentActivate, &amp;tlpwndCurrentActivate);
01783 
01784             <span class="comment">/*</span>
01785 <span class="comment">             *   Cancel the active window's mode</span>
01786 <span class="comment">             */</span>
01787             <a class="code" href="../../d4/d1/userk_8h.html#a1580">xxxSendMessageTimeout</a>(pwndCurrentActivate, WM_CANCELMODE, 0, 0, SMTO_ABORTIFHUNG, 100, &amp;dwResult);
01788 
01789             <span class="comment">/*</span>
01790 <span class="comment">             *  Initialize the Switch Window data structure, if we</span>
01791 <span class="comment">             *  succeed create and display the window, otherwise act</span>
01792 <span class="comment">             *  like slow Alt+Tab.</span>
01793 <span class="comment">             */</span>
01794             pwndActivateNext = <a class="code" href="../../d1/d3/tmswitch_8c.html#a24">InitSwitchWndInfo</a>(&amp;pswCurrent, pwndCurrentActivate, fDir);
01795             
01796             <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pwndActivateNext, &amp;tlpwndActivateNext);
01797 
01798             <span class="keywordflow">if</span> (pswCurrent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01799                 <span class="comment">/*</span>
01800 <span class="comment">                 *  Couldn't initialize our switch window data structure, so we</span>
01801 <span class="comment">                 *  will act like Alt+Esc.</span>
01802 <span class="comment">                 */</span>
01803                 <span class="keywordflow">goto</span> DoSlowAltTab;
01804             }
01805 
01806             <span class="keywordflow">if</span> (pwndActivateNext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01807                 <a class="code" href="../../d1/d3/tmswitch_8c.html#a27">SwitchWndCleanup</a>(&amp;pswCurrent);
01808                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndActivateNext);
01809                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndCurrentActivate);
01810                 <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a88">gspwndActivate</a>);
01811                 <span class="keywordflow">return</span>;
01812             }
01813 
01814             <a class="code" href="../../d4/d1/userk_8h.html#a137">ThreadLockPool</a>(ptiCurrent, pswCurrent, &amp;tlpSwitchInfo);
01815             
01816             <span class="comment">/*</span>
01817 <span class="comment">             * Since we are in the RIT, test the physical state of the keyboard</span>
01818 <span class="comment">             */</span>
01819             pswCurrent-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o16">fJournaling</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01820 
01821             <span class="comment">/*</span>
01822 <span class="comment">             *  Create the Alt+Tab window</span>
01823 <span class="comment">             */</span>
01824             pwndSwitch =
01825                   <a class="code" href="../../d4/d1/userk_8h.html#a1574">xxxCreateWindowEx</a>( WS_EX_TOOLWINDOW | WS_EX_WINDOWEDGE | WS_EX_DLGMODALFRAME,
01826                       (<a class="code" href="../../d1/d9/struct__LARGE__STRING.html">PLARGE_STRING</a>)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a41">SWITCHWNDCLASS</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01827                       WS_POPUP | WS_BORDER | WS_DISABLED,
01828                       0, 0, 10, 10, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>);
01829 
01830             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01831                 UserAssert(0);
01832 
01833                 <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a>, WM_CLOSE, 0, 0);
01834             }
01835 
01836             <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a>, pwndSwitch);
01837 
01838             <a class="code" href="../../d4/d1/userk_8h.html#a138">ThreadUnlockPool</a>(ptiCurrent, &amp;tlpSwitchInfo);
01839             
01840             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01841                 <span class="comment">/*</span>
01842 <span class="comment">                 *  Could not create the cool switch window, do the Alt+Esc thing</span>
01843 <span class="comment">                 */</span>
01844 <span class="preprocessor">#ifdef COOLSWITCHTRACE</span>
01845 <span class="preprocessor"></span>                <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CoolSwitch: Could not create window (contact bradg).\n"</span>);
01846                 UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01847 <span class="preprocessor">#endif</span>
01848 <span class="preprocessor"></span>                <a class="code" href="../../d1/d3/tmswitch_8c.html#a27">SwitchWndCleanup</a>(&amp;pswCurrent);
01849                 <span class="keywordflow">goto</span> DoSlowAltTab;
01850             }
01851 
01852             <span class="comment">/*</span>
01853 <span class="comment">             *  Save the pointer to the switch window info structure</span>
01854 <span class="comment">             */</span>
01855             <a class="code" href="../../d1/d3/tmswitch_8c.html#a12">Setpswi</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a>, pswCurrent);
01856             <span class="comment">/*</span>
01857 <span class="comment">             *  Set gspwndActivate so the RIT knows what window we would like</span>
01858 <span class="comment">             *  it to activate.</span>
01859 <span class="comment">             */</span>
01860             <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a88">gspwndActivate</a>, pwndActivateNext);
01861 
01862             <span class="comment">/*</span>
01863 <span class="comment">             * Make sure that our rit queue has the correct pdesk</span>
01864 <span class="comment">             */</span>
01865             <span class="keywordflow">if</span> (ptiCurrent-&gt;TIF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a797">TIF_SYSTEMTHREAD</a>) {
01866                 <a class="code" href="../../d4/d1/userk_8h.html#a1801">xxxSetThreadDesktop</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>); <span class="comment">// DeferWinEventNotify() ?? IANJA ??</span>
01867             }
01868 
01869             <span class="comment">/*</span>
01870 <span class="comment">             * If we're currently full screen tell console to switch to</span>
01871 <span class="comment">             * the desktop to GDI mode; we can't do this on the RIT because</span>
01872 <span class="comment">             * it can be slow.</span>
01873 <span class="comment">             */</span>
01874             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a15">gspwndFullScreen</a> != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>) {
01875                 <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>, &amp;tlpwndT);
01876                 <a class="code" href="../../d4/d1/userk_8h.html#a1581">xxxSendNotifyMessage</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>, WM_FULLSCREEN, GDIFULLSCREEN, (LPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>));
01877                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
01878             }
01879 
01880             <span class="comment">/*</span>
01881 <span class="comment">             *  Show the Alt+Tab window.  If it returns FALSE this means</span>
01882 <span class="comment">             *  the ALT key has been released, so there is no need to</span>
01883 <span class="comment">             *  paint the icons.</span>
01884 <span class="comment">             */</span>
01885             <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a>, &amp;tlpwndT);
01886             <a class="code" href="../../d1/d3/tmswitch_8c.html#a26">xxxShowSwitchWindow</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a>);
01887             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
01888 
01889             <span class="comment">/*</span>
01890 <span class="comment">             *  Exit now because the Switch window will have been</span>
01891 <span class="comment">             *  already updated.</span>
01892 <span class="comment">             */</span>
01893             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndActivateNext);
01894             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndCurrentActivate);
01895 
01896         } <span class="keywordflow">else</span> {
01897 
01898             <span class="comment">/*</span>
01899 <span class="comment">             *  We come here to do the actual switching and/or updating of</span>
01900 <span class="comment">             *  the switch window when in Alt+Tab mode.</span>
01901 <span class="comment">             */</span>
01902             <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>    pwndSwitch;
01903             <a class="code" href="../../d5/d1/struct__TL.html">TL</a>      tlpwndSwitch;
01904             <a class="code" href="../../d8/d7/structtagSwitchWndInfo.html">PSWINFO</a> pswCurrent;
01905             HWND    hwndActivateNext;
01906             HWND    hwndStop;
01907 
01908             <span class="keywordflow">if</span> (!(pwndSwitch = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a>)) {
01909 
01910                 <span class="keywordflow">goto</span> DoAltEsc;
01911 
01912             } <span class="keywordflow">else</span> {
01913                 <span class="comment">/*</span>
01914 <span class="comment">                 *  Move the hilight rect to the next/prev task.  It is possible</span>
01915 <span class="comment">                 *  that some tasks were destoryed, so we need to skip those.</span>
01916 <span class="comment">                 */</span>
01917                 pswCurrent = <a class="code" href="../../d1/d3/tmswitch_8c.html#a11">Getpswi</a>(pwndSwitch);
01918                 <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwndSwitch, &amp;tlpwndSwitch);
01919                 hwndStop = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01920                 <span class="keywordflow">do</span> {
01921                     hwndActivateNext = <a class="code" href="../../d1/d3/tmswitch_8c.html#a25">xxxMoveSwitchWndHilite</a>(pwndSwitch, pswCurrent, fDir);
01922                     <span class="keywordflow">if</span> (!hwndStop) {
01923                         hwndStop = hwndActivateNext;
01924                     } <span class="keywordflow">else</span> {
01925                         <span class="keywordflow">if</span> (hwndStop == hwndActivateNext) {
01926                             pwndActivateNext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01927                             <span class="keywordflow">break</span>;
01928                         }
01929                     }
01930                     pwndActivateNext = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(hwndActivateNext);
01931                 } <span class="keywordflow">while</span> (!pwndActivateNext);
01932                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndSwitch);
01933                 <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a88">gspwndActivate</a>, pwndActivateNext);
01934                 <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a88">gspwndActivate</a>) {
01935                     <span class="comment">/*</span>
01936 <span class="comment">                     *  No Window to activate, bail out of Alt+Tab mode</span>
01937 <span class="comment">                     */</span>
01938                     <a class="code" href="../../d1/d3/tmswitch_8c.html#a29">xxxCancelCoolSwitch</a>();
01939                 }
01940             }
01941         }
01942         <span class="keywordflow">break</span>;
01943 
01944 DoAltEsc:
01945     <span class="keywordflow">case</span> VK_ESCAPE:
01946         <span class="comment">/*</span>
01947 <span class="comment">         *  NOTE: The RIT doesn't use gspwndActivate to activate the window when</span>
01948 <span class="comment">         *        processing Alt+Esc, we just use it here as a convenient</span>
01949 <span class="comment">         *        variable.  The actual activation takes place below.</span>
01950 <span class="comment">         */</span>
01951         pwndCurrentActivate = pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>;
01952         <span class="keywordflow">if</span> (pwndCurrentActivate == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01953             pwndCurrentActivate = pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o5">ptiKeyboard</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
01954         }
01955         <span class="keywordflow">if</span> (!pwndCurrentActivate)
01956             <span class="keywordflow">return</span>;
01957         <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwndCurrentActivate, &amp;tlpwndCurrentActivate);
01958 
01959         <span class="comment">/*</span>
01960 <span class="comment">         *   Cancel the active window's mode</span>
01961 <span class="comment">         */</span>
01962         <a class="code" href="../../d4/d1/userk_8h.html#a1580">xxxSendMessageTimeout</a>(pwndCurrentActivate, WM_CANCELMODE, 0, 0, SMTO_ABORTIFHUNG, 100, &amp;dwResult);
01963 
01964         <span class="comment">/*</span>
01965 <span class="comment">         * Determine the next window to activate</span>
01966 <span class="comment">         */</span>
01967         pwndActivateNext = <a class="code" href="../../d4/d1/userk_8h.html#a1893">_GetNextQueueWindow</a>(pwndCurrentActivate, fDir, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01968         <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pwndActivateNext, &amp;tlpwndActivateNext);
01969 
01970         <span class="comment">/*</span>
01971 <span class="comment">         * If we're going forward through the windows, move the currently</span>
01972 <span class="comment">         * active window to the bottom so we'll do the right thing when</span>
01973 <span class="comment">         * we go backwards.</span>
01974 <span class="comment">         */</span>
01975         <span class="keywordflow">if</span> (pwndActivateNext != pwndCurrentActivate) {
01976 DoSlowAltTab:
01977             <span class="keywordflow">if</span> (pwndActivateNext) {
01978 
01979                 <span class="comment">/*</span>
01980 <span class="comment">                 * We're about to activate another window while the ALT key is down,</span>
01981 <span class="comment">                 *  so let the current focus window know that it doesn't need the</span>
01982 <span class="comment">                 *  menu underlines anymore</span>
01983 <span class="comment">                 */</span>
01984                 pwndCurrentTopFocus = <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a11">GetTopLevelWindow</a>(pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>);
01985                 <span class="keywordflow">if</span> ((pwndCurrentTopFocus != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (pwndCurrentTopFocus-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01986                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a785">ClearMF</a>(pwndCurrentTopFocus-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a144">MFUNDERLINE</a>);
01987                 }
01988 
01989                 <span class="keywordflow">if</span> (fDir == <a class="code" href="../../d1/d3/tmswitch_8c.html#a3">FDIR_FORWARD</a>) {
01990                     <span class="comment">/*</span>
01991 <span class="comment">                     * For Alt+ESC only move the window to the bottom if it's</span>
01992 <span class="comment">                     * not a top most window</span>
01993 <span class="comment">                     */</span>
01994                     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndCurrentActivate, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>)) {
01995                         <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(pwndCurrentActivate, <a class="code" href="../../d4/d1/userk_8h.html#a453">PWND_BOTTOM</a>, 0, 0, 0, 0,
01996                                 SWP_NOMOVE | SWP_NOSIZE | SWP_NOACTIVATE |
01997                                 SWP_DEFERDRAWING | SWP_NOSENDCHANGING |
01998                                 SWP_ASYNCWINDOWPOS);
01999                     }
02000                 }
02001 
02002                 <span class="comment">/*</span>
02003 <span class="comment">                 * The ALT key is down, so this window needs menu underlines</span>
02004 <span class="comment">                 */</span>
02005                 <span class="keywordflow">if</span> (pwndActivateNext-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02006                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a784">SetMF</a>(pwndActivateNext-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a144">MFUNDERLINE</a>);
02007                 }
02008 
02009 
02010                 <span class="comment">/*</span>
02011 <span class="comment">                 * This little ugly hack will cause xxxSetForegroundWindow2()</span>
02012 <span class="comment">                 * to send out an activation messages to a queue that is</span>
02013 <span class="comment">                 * already the active queue allowing us to change the active</span>
02014 <span class="comment">                 * window on that queue.</span>
02015 <span class="comment">                 */</span>
02016                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndActivateNext)-&gt;pq)
02017                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02018 
02019                 <span class="comment">/*</span>
02020 <span class="comment">                 * Make the selected window thread the owner of the last input;</span>
02021 <span class="comment">                 *  since he's next, he owns the ALT-ESC.</span>
02022 <span class="comment">                 */</span>
02023                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o2">ptiLastWoken</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndActivateNext);
02024 
02025                 <a class="code" href="../../d4/d1/userk_8h.html#a1225">xxxSetForegroundWindow2</a>(pwndActivateNext, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02026                         (wParam == VK_TAB) ? <a class="code" href="../../d4/d1/userk_8h.html#a507">SFW_SWITCH</a> | <a class="code" href="../../d4/d1/userk_8h.html#a510">SFW_ACTIVATERESTORE</a> : <a class="code" href="../../d4/d1/userk_8h.html#a507">SFW_SWITCH</a>);
02027 
02028                 <span class="comment">/*</span>
02029 <span class="comment">                 * Win3.1 calls SetWindowPos() with activate, which z-orders</span>
02030 <span class="comment">                 * first regardless, then activates. Our code relies on</span>
02031 <span class="comment">                 * xxxActivateThisWindow() to z-order, and it'll only do</span>
02032 <span class="comment">                 * it if the window does not have the child bit set (regardless</span>
02033 <span class="comment">                 * that the window is a child of the desktop).</span>
02034 <span class="comment">                 *</span>
02035 <span class="comment">                 * To be compatible, we'll just force z-order here if the</span>
02036 <span class="comment">                 * window has the child bit set. This z-order is asynchronous,</span>
02037 <span class="comment">                 * so this'll z-order after the activate event is processed.</span>
02038 <span class="comment">                 * That'll allow it to come on top because it'll be foreground</span>
02039 <span class="comment">                 * then. (Grammatik has a top level window with the child</span>
02040 <span class="comment">                 * bit set that wants to be come the active window).</span>
02041 <span class="comment">                 */</span>
02042                 <span class="keywordflow">if</span> (wParam == VK_TAB &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndActivateNext, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a654">WFCHILD</a>)) {
02043                     <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(pwndActivateNext, (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)HWND_TOP, 0, 0, 0, 0,
02044                             SWP_NOSIZE | SWP_NOMOVE | SWP_ASYNCWINDOWPOS);
02045                 }
02046             }
02047         }
02048         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndActivateNext);
02049         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndCurrentActivate);
02050         <span class="keywordflow">break</span>;
02051 
02052     <span class="keywordflow">case</span> VK_F6:
02053         <span class="keywordflow">if</span> ((pwndCurrentActivate = pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02054             pwndCurrentActivate = pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o5">ptiKeyboard</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
02055 
02056         pwndActivateNext = pwndCurrentActivate;
02057 
02058         <span class="comment">/*</span>
02059 <span class="comment">         * HACK! console sessions are all one thread but we want them</span>
02060 <span class="comment">         * to act like different threads so if its a console thread (csrss.exe)</span>
02061 <span class="comment">         * then ALT-F6 does nothing just like in Win 3.1</span>
02062 <span class="comment">         * Note: we never get called with wParam == VK_F6 anyway. Win NT 3.51</span>
02063 <span class="comment">         * doesn't seem to either, but Windows '95 does.  BUG?? (IanJa)</span>
02064 <span class="comment">         */</span>
02065         <span class="keywordflow">if</span> (!(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndActivateNext)-&gt;TIF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a798">TIF_CSRSSTHREAD</a>)) {
02066             <span class="comment">/*</span>
02067 <span class="comment">             * on a alt-f6, we want to keep the switch within the thread.</span>
02068 <span class="comment">             * We may want to rethink this because this will look strange</span>
02069 <span class="comment">             * when you alt-f6 on a multi-threaded app we will not rotate</span>
02070 <span class="comment">             * through the windows on the different threads.  This works</span>
02071 <span class="comment">             * fine on Win 3.x because it is single threaded.</span>
02072 <span class="comment">             */</span>
02073             <span class="keywordflow">do</span> {
02074                 pwndActivateNext = <a class="code" href="../../d4/d1/userk_8h.html#a1231">NextTopWindow</a>(pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o5">ptiKeyboard</a>, pwndActivateNext, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02075                         fDir ? <a class="code" href="../../d4/d1/userk_8h.html#a515">NTW_PREVIOUS</a> : 0);
02076             } <span class="keywordflow">while</span>( (pwndActivateNext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
02077                     (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndActivateNext) != pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o5">ptiKeyboard</a>));
02078 
02079             <span class="keywordflow">if</span> (pwndActivateNext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02080 
02081                 <span class="keywordflow">if</span> (pwndActivateNext != pwndCurrentActivate) {
02082                     <span class="comment">/*</span>
02083 <span class="comment">                     * We're about to activate another window while the ALT key is down,</span>
02084 <span class="comment">                     *  so let the current focus window know that it doesn't need the</span>
02085 <span class="comment">                     *  menu underlines anymore</span>
02086 <span class="comment">                     */</span>
02087                     pwndCurrentTopFocus = <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a11">GetTopLevelWindow</a>(pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>);
02088                     <span class="keywordflow">if</span> ((pwndCurrentTopFocus != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (pwndCurrentTopFocus-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02089                         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a785">ClearMF</a>(pwndCurrentTopFocus-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a144">MFUNDERLINE</a>);
02090                     }
02091                     <span class="comment">/*</span>
02092 <span class="comment">                     * The ALT key is down, so this window needs menu underlines</span>
02093 <span class="comment">                     */</span>
02094                     <span class="keywordflow">if</span> (pwndActivateNext-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02095                         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a784">SetMF</a>(pwndActivateNext-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a144">MFUNDERLINE</a>);
02096                     }
02097                 }
02098 
02099 
02100                 <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwndActivateNext, &amp;tlpwndActivateNext);
02101                 <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(pwndActivateNext, <a class="code" href="../../d4/d1/userk_8h.html#a453">PWND_BOTTOM</a>, 0, 0, 0, 0,
02102                         SWP_DEFERDRAWING | SWP_NOSENDCHANGING | SWP_NOCHANGE |
02103                         SWP_ASYNCWINDOWPOS);
02104                 <a class="code" href="../../d4/d1/userk_8h.html#a1225">xxxSetForegroundWindow2</a>(pwndActivateNext, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d1/userk_8h.html#a507">SFW_SWITCH</a>);
02105                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndActivateNext);
02106             }
02107         }
02108         <span class="keywordflow">break</span>;
02109     }
02110 }
02111 
02112 <span class="comment">/***************************************************************************\</span>
02113 <span class="comment">* xxxOldNextWindow</span>
02114 <span class="comment">*</span>
02115 <span class="comment">* This function does the processing for the alt-tab/esc/F6 UI.</span>
02116 <span class="comment">*</span>
02117 <span class="comment">* History:</span>
02118 <span class="comment">* 03-17-92  DavidPe     Ported from Win 3.1 sources</span>
02119 <span class="comment">\***************************************************************************/</span>
02120 
<a name="l02121"></a><a class="code" href="../../d4/d1/userk_8h.html#a1512">02121</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1512">xxxOldNextWindow</a>(
02122     UINT flags)
02123 {
02124     MSG         <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
02125     HWND        hwndSel;
02126     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndNewSel;
02127     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndSel;
02128     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fType = 0;
02129     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fDrawIcon;
02130     WORD        vk;
02131     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlpwndT;
02132     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlpwndSel;
02133     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlpwndSwitch;
02134     <a class="code" href="../../d8/d7/structtagSwitchWndInfo.html">PSWINFO</a>     pswCurrent;
02135     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndSwitch;
02136     HWND        hwndStop;
02137     HWND        hwndNewSel;
02138     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
02139     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiAltTab;
02140     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
02141 
02142     <span class="comment">/*</span>
02143 <span class="comment">     * HACK: We have a problem with direct-draw full apps where an alttab</span>
02144 <span class="comment">     *       window is created on a queue owned other than the RIT.  This</span>
02145 <span class="comment">     *       shows up by alt-tabbing away from ROIDS.EXE during fullscreen.</span>
02146 <span class="comment">     *</span>
02147 <span class="comment">     *       What is happening is on a ALT-TAB, from xxxSysCommand(), the</span>
02148 <span class="comment">     *       thread is not a rit.  xxxSysCommand() calls xxxOldNextWindow</span>
02149 <span class="comment">     *       which finds that the current-thread doesn't have a switch</span>
02150 <span class="comment">     *       window, and then creates one on the current-thread-queue.</span>
02151 <span class="comment">     *</span>
02152 <span class="comment">     *       The hack here is to make sure the calling thread is the RIT</span>
02153 <span class="comment">     *       before allowing any cool-switch creation.</span>
02154 <span class="comment">     *</span>
02155 <span class="comment">     *       21-Mar-1996 : Chriswil</span>
02156 <span class="comment">     */</span>
02157 <span class="preprocessor">#if 0</span>
02158 <span class="preprocessor"></span>    ptiAltTab = ptiCurrent;
02159 <span class="preprocessor">#else</span>
02160 <span class="preprocessor"></span>    ptiAltTab = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>;
02161 <span class="preprocessor">#endif</span>
02162 <span class="preprocessor"></span>
02163     <span class="comment">/*</span>
02164 <span class="comment">     * Don't allow entering this routine when we're already in the AltTab</span>
02165 <span class="comment">     * mode. The AltTab window may have been created via xxxNextWindow.</span>
02166 <span class="comment">     */</span>
02167     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02168         <span class="keywordflow">return</span>;
02169 
02170     <span class="keywordflow">if</span> ((pwndSel = ptiCurrent-&gt;pq-&gt;spwndActive) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02171         <span class="keywordflow">return</span>;
02172 
02173     <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pwndSel, &amp;tlpwndSel);
02174     <a class="code" href="../../d4/d1/userk_8h.html#a1516">xxxCapture</a>(ptiCurrent, pwndSel, <a class="code" href="../../d4/d1/userk_8h.html#a466">SCREEN_CAPTURE</a>);
02175 
02176     vk = (WORD)flags;
02177     <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.wParam = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)flags;
02178 
02179     pwndNewSel = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02180 
02181     <span class="keywordflow">if</span> (vk == VK_TAB) {
02182 
02183         <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpSwitchInfo;
02184 
02185         <span class="comment">/*</span>
02186 <span class="comment">         *  Initialize the Switch window data structures</span>
02187 <span class="comment">         */</span>
02188         pwndNewSel = <a class="code" href="../../d1/d3/tmswitch_8c.html#a24">InitSwitchWndInfo</a>(&amp;pswCurrent,
02189                                        pwndSel,
02190                                        <a class="code" href="../../d7/d9/keyboard_8c.html#a1">_GetKeyState</a>(VK_SHIFT) &lt; 0);
02191 
02192         <span class="keywordflow">if</span> (pswCurrent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02193             <span class="comment">/*</span>
02194 <span class="comment">             *  We were unable to initialize the data structure used by</span>
02195 <span class="comment">             *  the Switch window, so we will act like Alt+Esc.</span>
02196 <span class="comment">             */</span>
02197         } <span class="keywordflow">else</span> {
02198 
02199             <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndSwitch;
02200 
02201             <span class="comment">/*</span>
02202 <span class="comment">             * We are doing a journal playback do use _GetKeyState to</span>
02203 <span class="comment">             * test the keyboard</span>
02204 <span class="comment">             */</span>
02205             pswCurrent-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o16">fJournaling</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02206 
02207             <a class="code" href="../../d4/d1/userk_8h.html#a137">ThreadLockPool</a>(ptiCurrent, pswCurrent, &amp;tlpSwitchInfo);
02208             
02209             <span class="comment">/*</span>
02210 <span class="comment">             *  Attempt to create the Switch Window</span>
02211 <span class="comment">             */</span>
02212 
02213             pwndSwitch =
02214                  <a class="code" href="../../d4/d1/userk_8h.html#a1574">xxxCreateWindowEx</a>(WS_EX_TOOLWINDOW | WS_EX_WINDOWEDGE | WS_EX_DLGMODALFRAME,
02215                                    (<a class="code" href="../../d1/d9/struct__LARGE__STRING.html">PLARGE_STRING</a>)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a41">SWITCHWNDCLASS</a>,
02216                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02217                                    WS_POPUP | WS_BORDER | WS_DISABLED,
02218                                    0,
02219                                    0,
02220                                    10,
02221                                    10,
02222                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02223                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02224                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02225                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02226                                    <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>);
02227 
02228             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02229                 UserAssert(0);
02230 
02231                 <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a>, WM_CLOSE, 0, 0);
02232             }
02233 
02234             <a class="code" href="../../d4/d1/userk_8h.html#a138">ThreadUnlockPool</a>(ptiCurrent, &amp;tlpSwitchInfo);
02235 
02236             <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a>, pwndSwitch);
02237 
02238 
02239             <span class="keywordflow">if</span> (!(pwndSwitch = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a>)) {
02240 
02241                 <a class="code" href="../../d1/d3/tmswitch_8c.html#a27">SwitchWndCleanup</a>(&amp;pswCurrent);
02242 
02243             } <span class="keywordflow">else</span> {
02244                 <span class="comment">/*</span>
02245 <span class="comment">                 *  Lock the switch window</span>
02246 <span class="comment">                 */</span>
02247                 <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwndSwitch, &amp;tlpwndSwitch);
02248 
02249                 <span class="comment">/*</span>
02250 <span class="comment">                 *  Save the switch window info</span>
02251 <span class="comment">                 */</span>
02252                 <a class="code" href="../../d1/d3/tmswitch_8c.html#a12">Setpswi</a>(pwndSwitch, pswCurrent);
02253 
02254 <span class="comment">// Don't we need to switch from full screen mode if needed?</span>
02255 <span class="preprocessor">#if 0</span>
02256 <span class="preprocessor"></span>                <span class="comment">/*</span>
02257 <span class="comment">                 * If we're currently full screen tell console to switch to</span>
02258 <span class="comment">                 * the desktop to GDI mode; we can't do this on the RIT because</span>
02259 <span class="comment">                 * it can be slow.</span>
02260 <span class="comment">                 */</span>
02261                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a15">gspwndFullScreen</a> != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>) {
02262                     <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(pti, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>, &amp;tlpwndT);
02263                     <a class="code" href="../../d4/d1/userk_8h.html#a1581">xxxSendNotifyMessage</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>, WM_FULLSCREEN, GDIFULLSCREEN, (LONG)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>));
02264                     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
02265                 }
02266 <span class="preprocessor">#endif</span>
02267 <span class="preprocessor"></span>
02268                 <span class="comment">/*</span>
02269 <span class="comment">                 *  Show the switch window, this also will paint the window</span>
02270 <span class="comment">                 */</span>
02271                 <a class="code" href="../../d1/d3/tmswitch_8c.html#a26">xxxShowSwitchWindow</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a>);
02272                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndSwitch);
02273             }
02274         }
02275 
02276     }
02277 
02278     <span class="keywordflow">if</span> (!pwndNewSel)
02279         <span class="keywordflow">goto</span> StartTab;
02280 
02281     pwndSel = pwndNewSel;
02282 
02283     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02284 
02285         hwndSel = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pwndSel);
02286         <span class="comment">/*</span>
02287 <span class="comment">         * Wait for a message without getting it out of the queue.</span>
02288 <span class="comment">         */</span>
02289         <span class="keywordflow">while</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a576">xxxPeekMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, 0, PM_NOREMOVE | PM_NOYIELD))
02290             <a class="code" href="../../d4/d1/userk_8h.html#a1634">xxxWaitMessage</a>();
02291 
02292         <span class="keywordflow">if</span> ((pwndSel = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(hwndSel)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02293             pwndSel = ptiCurrent-&gt;pq-&gt;spwndActive;
02294 
02295         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1818">_CallMsgFilter</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, MSGF_NEXTWINDOW)) {
02296             <span class="comment">/*</span>
02297 <span class="comment">             * Swallow the message if the hook processed it</span>
02298 <span class="comment">             */</span>
02299             <a class="code" href="../../d4/d1/userk_8h.html#a576">xxxPeekMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message, PM_REMOVE);
02300             <span class="keywordflow">continue</span>;
02301         }
02302 
02303         <span class="comment">/*</span>
02304 <span class="comment">         * If we are doing Alt+Tab and some other key comes in (other than</span>
02305 <span class="comment">         * tab, escape or shift), then bomb out of this loop and leave that</span>
02306 <span class="comment">         * key in the queue.</span>
02307 <span class="comment">         */</span>
02308         <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message == WM_SYSKEYDOWN) &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02309 
02310             vk = (WORD)<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.wParam;
02311 
02312             <span class="keywordflow">if</span> ((vk != VK_TAB) &amp;&amp; (vk != VK_ESCAPE) &amp;&amp; (vk != VK_SHIFT)) {
02313                 pwndSel = ptiCurrent-&gt;pq-&gt;spwndActive;
02314                 fType = 0;
02315                 <span class="keywordflow">goto</span> Exit;
02316             }
02317         }
02318 
02319         <span class="keywordflow">switch</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message) {
02320 
02321         <span class="keywordflow">case</span> WM_CANCELJOURNAL:
02322             <span class="comment">/*</span>
02323 <span class="comment">             *  If journalling was canceled we need to exit our loop and</span>
02324 <span class="comment">             *  remove the Alt+Tab window.  We don't want to remove this</span>
02325 <span class="comment">             *  meesage because we want the app to know that journalling</span>
02326 <span class="comment">             *  was canceled.</span>
02327 <span class="comment">             */</span>
02328 
02329             <span class="comment">/* &gt; &gt; &gt;  F A L L   T H R O U G H  &lt; &lt; &lt; */</span>
02330 
02331         <span class="keywordflow">case</span> WM_LBUTTONDOWN:
02332         <span class="keywordflow">case</span> WM_LBUTTONUP:
02333         <span class="keywordflow">case</span> WM_RBUTTONDOWN:
02334         <span class="keywordflow">case</span> WM_RBUTTONUP:
02335         <span class="keywordflow">case</span> WM_MBUTTONDOWN:
02336         <span class="keywordflow">case</span> WM_MBUTTONUP:
02337         <span class="keywordflow">case</span> WM_XBUTTONDOWN:
02338         <span class="keywordflow">case</span> WM_XBUTTONUP:
02339             <span class="comment">/*</span>
02340 <span class="comment">             * If mouse message, cancel and get out of loop.</span>
02341 <span class="comment">             */</span>
02342             pwndSel = ptiCurrent-&gt;pq-&gt;spwndActive;
02343             fType = 0;
02344             <span class="keywordflow">goto</span> Exit;
02345 
02346         <span class="keywordflow">case</span> WM_KEYUP:
02347         <span class="keywordflow">case</span> WM_KEYDOWN:
02348         <span class="keywordflow">case</span> WM_SYSCHAR:
02349         <span class="keywordflow">case</span> WM_SYSKEYUP:
02350         <span class="keywordflow">case</span> WM_MOUSEMOVE:
02351             <span class="comment">/*</span>
02352 <span class="comment">             * Swallow the message</span>
02353 <span class="comment">             */</span>
02354             hwndSel = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pwndSel);
02355             <a class="code" href="../../d4/d1/userk_8h.html#a576">xxxPeekMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message, PM_REMOVE);
02356 
02357             <span class="keywordflow">if</span> ((pwndSel = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(hwndSel)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02358                 pwndSel = ptiCurrent-&gt;pq-&gt;spwndActive;
02359 
02360             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message == WM_KEYUP || <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message == WM_SYSKEYUP) {
02361 
02362                 vk = (WORD)<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.wParam;
02363 
02364                 <span class="comment">/*</span>
02365 <span class="comment">                 * If alt-tab up, then exit.</span>
02366 <span class="comment">                 */</span>
02367                 <span class="keywordflow">if</span> (vk == VK_MENU) {
02368                     <span class="comment">/*</span>
02369 <span class="comment">                     * If doing Alt+Esc, wait for up of ESC to get out.</span>
02370 <span class="comment">                     */</span>
02371                     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02372                         <span class="keywordflow">break</span>;
02373 
02374                     fType = 0;
02375                     <span class="keywordflow">goto</span> Exit;
02376 
02377                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vk == VK_ESCAPE || vk == VK_F6) {
02378                     <span class="comment">/*</span>
02379 <span class="comment">                     * Get out on up transition of ESC or F6 keys.</span>
02380 <span class="comment">                     */</span>
02381                     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02382 
02383                         pwndSel = ptiCurrent-&gt;pq-&gt;spwndActive;
02384                         fType = 0;
02385 
02386                     } <span class="keywordflow">else</span> {
02387 
02388                         fType = ((vk == VK_ESCAPE) ? <a class="code" href="../../d1/d3/tmswitch_8c.html#a2">ALT_ESCAPE</a> : <a class="code" href="../../d1/d3/tmswitch_8c.html#a1">ALT_F6</a>);
02389                     }
02390 
02391                     <span class="keywordflow">goto</span> Exit;
02392                 }
02393 
02394             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message == WM_KEYDOWN) {
02395                 <span class="comment">/*</span>
02396 <span class="comment">                 *  Exit out loop is a stray key stroke comes through.  In</span>
02397 <span class="comment">                 *  particular look for VK_CONTROL.</span>
02398 <span class="comment">                 */</span>
02399                 pwndSel = ptiCurrent-&gt;pq-&gt;spwndActive;
02400                 fType = 0;
02401                 <span class="keywordflow">goto</span> Exit;
02402             }
02403             <span class="keywordflow">break</span>;
02404 
02405         <span class="keywordflow">case</span> WM_SYSKEYDOWN:
02406             vk = (WORD)<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.wParam;
02407 
02408             <span class="keywordflow">switch</span> (vk) {
02409 
02410             <span class="keywordflow">case</span> VK_SHIFT:
02411             <span class="keywordflow">case</span> VK_TAB:
02412             <span class="keywordflow">case</span> VK_ESCAPE:
02413             <span class="keywordflow">case</span> VK_F6:
02414 
02415                 hwndSel = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pwndSel);
02416                 <a class="code" href="../../d4/d1/userk_8h.html#a576">xxxPeekMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message, PM_REMOVE);
02417 
02418                 <span class="keywordflow">if</span> ((pwndSel = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(hwndSel)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02419                     pwndSel = ptiCurrent-&gt;pq-&gt;spwndActive;
02420 
02421                 <span class="keywordflow">if</span> (!(vk == VK_TAB))
02422                     <span class="keywordflow">break</span>;
02423 StartTab:
02424                 <span class="keywordflow">if</span> (vk == VK_ESCAPE) {
02425                     pwndNewSel = <a class="code" href="../../d4/d1/userk_8h.html#a1893">_GetNextQueueWindow</a>(
02426                             pwndSel,
02427                             <a class="code" href="../../d7/d9/keyboard_8c.html#a1">_GetKeyState</a>(VK_SHIFT) &lt; 0,
02428                             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02429 
02430                     <span class="keywordflow">if</span> (pwndNewSel == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02431                         <span class="keywordflow">break</span>;
02432 
02433                     fType = <a class="code" href="../../d1/d3/tmswitch_8c.html#a2">ALT_ESCAPE</a>;
02434                     pwndSel = pwndNewSel;
02435 
02436                     <span class="comment">/*</span>
02437 <span class="comment">                     * Wait until ESC goes up to activate new window.</span>
02438 <span class="comment">                     */</span>
02439                     <span class="keywordflow">break</span>;
02440                 }
02441                 <span class="keywordflow">if</span> (vk == VK_F6) {
02442 
02443                     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndFirst;
02444                     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndSaveSel = pwndSel;
02445 
02446                     <span class="comment">/*</span>
02447 <span class="comment">                     * Save the first returned window to act as a limit</span>
02448 <span class="comment">                     * to the search because NextTopWindow will return NULL</span>
02449 <span class="comment">                     * only if pwndSel is the only window that meets its</span>
02450 <span class="comment">                     * selection criteria.</span>
02451 <span class="comment">                     *</span>
02452 <span class="comment">                     * This prevents a hang that can occur in winword or</span>
02453 <span class="comment">                     * excel when then Alt-F4-F6 key combination is hit</span>
02454 <span class="comment">                     * and unsaved changes exist.</span>
02455 <span class="comment">                     */</span>
02456                     pwndFirst = pwndNewSel = (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)<a class="code" href="../../d4/d1/userk_8h.html#a1231">NextTopWindow</a>(ptiCurrent, pwndSel, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02457                             <a class="code" href="../../d7/d9/keyboard_8c.html#a1">_GetKeyState</a>(VK_SHIFT) &lt; 0 ? <a class="code" href="../../d4/d1/userk_8h.html#a515">NTW_PREVIOUS</a> : 0);
02458 
02459                     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02460 
02461                         <span class="comment">/*</span>
02462 <span class="comment">                         * If pwndNewSel is NULL, pwndSel is the only candidate.</span>
02463 <span class="comment">                         */</span>
02464                         <span class="keywordflow">if</span> (pwndNewSel == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02465                             <span class="keywordflow">break</span>;
02466 
02467                         pwndSel = pwndNewSel;
02468 
02469                         <span class="comment">/*</span>
02470 <span class="comment">                         * If the window is on the same thread, wait until</span>
02471 <span class="comment">                         * F6 goes up to activate new window.</span>
02472 <span class="comment">                         */</span>
02473                         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndSel) == ptiCurrent)
02474                             <span class="keywordflow">break</span>;
02475 
02476                         pwndNewSel = (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)<a class="code" href="../../d4/d1/userk_8h.html#a1231">NextTopWindow</a>(ptiCurrent, pwndSel, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02477                                 <a class="code" href="../../d7/d9/keyboard_8c.html#a1">_GetKeyState</a>(VK_SHIFT) &lt; 0 ? <a class="code" href="../../d4/d1/userk_8h.html#a515">NTW_PREVIOUS</a> : 0);
02478 
02479                         <span class="comment">/*</span>
02480 <span class="comment">                         * If we've looped around, use the original window.</span>
02481 <span class="comment">                         * Wait until F6 goes up to activate new window.</span>
02482 <span class="comment">                         */</span>
02483                         <span class="keywordflow">if</span> (pwndNewSel == pwndFirst) {
02484                             pwndSel = pwndSaveSel;
02485                             <span class="keywordflow">break</span>;
02486                         }
02487                     }
02488                     <span class="keywordflow">break</span>;
02489                 }
02490 
02491                 <span class="comment">/*</span>
02492 <span class="comment">                 * Here for the Alt+Tab case</span>
02493 <span class="comment">                 */</span>
02494                 <span class="keywordflow">if</span> ((pwndSwitch = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02495                     pswCurrent = <a class="code" href="../../d1/d3/tmswitch_8c.html#a11">Getpswi</a>(pwndSwitch);
02496                     <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pwndSwitch, &amp;tlpwndSwitch);
02497                     hwndStop = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02498                     <span class="keywordflow">do</span> {
02499 
02500                         hwndNewSel = <a class="code" href="../../d1/d3/tmswitch_8c.html#a25">xxxMoveSwitchWndHilite</a>(
02501                                 pwndSwitch,
02502                                 pswCurrent,
02503                                 <a class="code" href="../../d7/d9/keyboard_8c.html#a1">_GetKeyState</a>(VK_SHIFT) &lt; 0);
02504 
02505                         <span class="keywordflow">if</span> (!hwndStop) {
02506                             hwndStop = hwndNewSel;
02507                         } <span class="keywordflow">else</span> {
02508                             <span class="keywordflow">if</span> (hwndStop == hwndNewSel) {
02509                                 pwndNewSel = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02510                                 <span class="keywordflow">break</span>;
02511                             }
02512                         }
02513                         pwndNewSel = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(hwndNewSel);
02514                     } <span class="keywordflow">while</span> (!pwndNewSel);
02515                     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndSwitch);
02516                     pwndSel = pwndNewSel;
02517 
02518                 } <span class="keywordflow">else</span> {
02519 
02520                     pwndNewSel = <a class="code" href="../../d4/d1/userk_8h.html#a1893">_GetNextQueueWindow</a>(
02521                             pwndSel,
02522                             <a class="code" href="../../d7/d9/keyboard_8c.html#a1">_GetKeyState</a>(VK_SHIFT) &lt; 0,
02523                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02524 
02525                     <span class="keywordflow">if</span> (pwndNewSel &amp;&amp; pwndNewSel != pwndSel) {
02526 
02527                         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndSel, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>)) {
02528                             <span class="comment">/*</span>
02529 <span class="comment">                             *  Force the old window to the bottom</span>
02530 <span class="comment">                             */</span>
02531                             <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pwndSel, &amp;tlpwndT);
02532                             <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(pwndSel,
02533                                             <a class="code" href="../../d4/d1/userk_8h.html#a453">PWND_BOTTOM</a>,
02534                                             0,
02535                                             0,
02536                                             0,
02537                                             0,
02538                                             SWP_NOMOVE             |
02539                                                 SWP_NOSIZE         |
02540                                                 SWP_NOACTIVATE     |
02541                                                 SWP_DEFERDRAWING   |
02542                                                 SWP_NOSENDCHANGING |
02543                                                 SWP_ASYNCWINDOWPOS);
02544                             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
02545                         }
02546 
02547                         pwndSel = pwndNewSel; <span class="comment">// Will be revalidated at top of loop</span>
02548                     }
02549                 }
02550                 <span class="keywordflow">break</span>;
02551 
02552             <span class="keywordflow">default</span>:
02553                 <span class="keywordflow">goto</span> Exit;
02554             }
02555             <span class="keywordflow">break</span>;
02556 
02557         <span class="keywordflow">default</span>:
02558             hwndSel = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pwndSel);
02559             <a class="code" href="../../d4/d1/userk_8h.html#a576">xxxPeekMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message, PM_REMOVE);
02560             <a class="code" href="../../d4/d1/userk_8h.html#a1646">xxxTranslateMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, 0);
02561             <a class="code" href="../../d4/d1/userk_8h.html#a1640">xxxDispatchMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>);
02562 
02563             <span class="keywordflow">if</span> ((pwndSel = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(hwndSel)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02564                 pwndSel = ptiCurrent-&gt;pq-&gt;spwndActive;
02565 
02566             <span class="keywordflow">break</span>;
02567         }
02568     }
02569 
02570 Exit:
02571     <a class="code" href="../../d4/d1/userk_8h.html#a1713">xxxReleaseCapture</a>();
02572 
02573     fDrawIcon = (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02574 
02575     <span class="comment">/*</span>
02576 <span class="comment">     * If this is an Alt-Escape we also have to send the current window</span>
02577 <span class="comment">     * to the bottom.</span>
02578 <span class="comment">     */</span>
02579     <span class="keywordflow">if</span> (fType == <a class="code" href="../../d1/d3/tmswitch_8c.html#a2">ALT_ESCAPE</a>) {
02580 
02581         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndActive;
02582 
02583         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>) {
02584 
02585             pwndActive = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>;
02586 
02587             <span class="keywordflow">if</span> (pwndActive &amp;&amp; (pwndActive != pwndSel)) {
02588                 <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pwndActive, &amp;tlpwndT);
02589                 <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(pwndActive,
02590                                 <a class="code" href="../../d4/d1/userk_8h.html#a453">PWND_BOTTOM</a>,
02591                                 0,
02592                                 0,
02593                                 0,
02594                                 0,
02595                                 SWP_NOMOVE             |
02596                                     SWP_NOSIZE         |
02597                                     SWP_NOACTIVATE     |
02598                                     SWP_DEFERDRAWING   |
02599                                     SWP_NOSENDCHANGING |
02600                                     SWP_ASYNCWINDOWPOS);
02601                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
02602             }
02603         }
02604     }
02605 
02606     <span class="keywordflow">if</span> (pwndSel) {
02607         <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pwndSel, &amp;tlpwndT);
02608         <a class="code" href="../../d4/d1/userk_8h.html#a1665">xxxSetForegroundWindow</a>(pwndSel, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02609 
02610         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndSel, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>)) {
02611 
02612             <span class="keywordflow">if</span> ((fType == 0) &amp;&amp; fDrawIcon)
02613                 <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pwndSel, WM_SYSCOMMAND, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)SC_RESTORE, 0);
02614 
02615         }
02616         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
02617     }
02618 
02619     <span class="comment">/*</span>
02620 <span class="comment">     * destroy the alt-tab window</span>
02621 <span class="comment">     */</span>
02622     <a class="code" href="../../d1/d3/tmswitch_8c.html#a29">xxxCancelCoolSwitch</a>();
02623 
02624     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndSel);
02625 }
02626 
02627 <span class="comment">/*****************************************************************************\</span>
02628 <span class="comment">*</span>
02629 <span class="comment">* GetAltTabInfo()   -   Active Accessibility API for OLEACC</span>
02630 <span class="comment">*</span>
02631 <span class="comment">* This succeeds if we are currently in alt-tab mode.</span>
02632 <span class="comment">*</span>
02633 <span class="comment">\*****************************************************************************/</span>
02634 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI
<a name="l02635"></a><a class="code" href="../../d4/d1/userk_8h.html#a1964">02635</a> <a class="code" href="../../d4/d1/userk_8h.html#a1964">_GetAltTabInfo</a>(
02636     <span class="keywordtype">int</span> iItem,
02637     PALTTABINFO pati,
02638     LPWSTR ccxpwszItemText,
02639     UINT cchItemText OPTIONAL,
02640     BOOL bAnsi)
02641 {
02642     <a class="code" href="../../d8/d7/structtagSwitchWndInfo.html">PSWINFO</a> pswCurrent;
02643 
02644     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a> || ((pswCurrent = <a class="code" href="../../d1/d3/tmswitch_8c.html#a11">Getpswi</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a11">gspwndAltTab</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02645         RIPERR0(ERROR_NOT_FOUND, RIP_WARNING, <span class="stringliteral">"no Alt-Tab window"</span>);
02646         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02647     }
02648 
02649     <span class="comment">/*</span>
02650 <span class="comment">     * Fill in general information</span>
02651 <span class="comment">     */</span>
02652     pati-&gt;cItems = pswCurrent-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o3">iTotalTasks</a>;
02653     pati-&gt;cColumns = pswCurrent-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o7">iNoOfColumns</a>;
02654     pati-&gt;cRows = pswCurrent-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o8">iNoOfRows</a>;
02655 
02656     pati-&gt;iColFocus = pswCurrent-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o10">iCurCol</a>;
02657     pati-&gt;iRowFocus = pswCurrent-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o11">iCurRow</a>;
02658 
02659     pati-&gt;cxItem = <a class="code" href="../../d1/d3/tmswitch_8c.html#a5">CXICONSLOT</a>;
02660     pati-&gt;cyItem = <a class="code" href="../../d1/d3/tmswitch_8c.html#a6">CYICONSLOT</a>;
02661     pati-&gt;ptStart = pswCurrent-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o14">ptFirstRowStart</a>;
02662 
02663     <span class="comment">/*</span>
02664 <span class="comment">     * Fill in specific information if asked.</span>
02665 <span class="comment">     */</span>
02666     <span class="keywordflow">if</span> (cchItemText &amp;&amp; (iItem &gt;= 0)) {
02667         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>    pwndCur;
02668 
02669         pwndCur = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02670 
02671         <span class="keywordflow">try</span> {
02672             <span class="keywordflow">if</span> ((iItem &lt; pswCurrent-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o3">iTotalTasks</a>) &amp;&amp;
02673                     (pwndCur = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(pswCurrent-&gt;<a class="code" href="../../d8/d7/structtagSwitchWndInfo.html#o0">pbwl</a>-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o4">rghwnd</a>[iItem]))) {
02674                 <span class="keywordflow">if</span> (bAnsi) {
02675                     LPSTR ccxpszItemText = (LPSTR)ccxpwszItemText;
02676                     ULONG cch;
02677                     <a class="code" href="../../d9/d6/nlsxlat_8c.html#a37">RtlUnicodeToMultiByteN</a>(ccxpszItemText, cchItemText - 1,
02678                             &amp;cch, pwndCur-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o17">strName</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o3">Buffer</a>, pwndCur-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o17">strName</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o0">Length</a>);
02679                     ccxpszItemText[cch] = <span class="charliteral">'\0'</span>;
02680                 } <span class="keywordflow">else</span> {
02681                     <a class="code" href="../../d1/d5/w32_2ntuser_2rtl_2random_8c.html#a2">TextCopy</a>(&amp;pwndCur-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o17">strName</a>, ccxpwszItemText, cchItemText);
02682                 }
02683             } <span class="keywordflow">else</span> {
02684                 <span class="comment">// no such item</span>
02685                 <a class="code" href="../../d1/d0/inc_2user_8h.html#a1133">NullTerminateString</a>(ccxpwszItemText, bAnsi);
02686             }
02687         } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
02688             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02689         }
02690     }
02691 
02692     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02693 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:00 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
