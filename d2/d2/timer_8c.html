<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: timer.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>timer.c File Reference</h1><code>#include "<a class="el" href="../../d5/d9/exp_8h-source.html">exp.h</a>"</code><br>

<p>
<a href="../../d3/d1/timer_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d7/struct__ETIMER.html">_ETIMER</a></td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d1/d7/struct__ETIMER.html">_ETIMER</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/timer_8c.html#a0">ETIMER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d1/d7/struct__ETIMER.html">_ETIMER</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/timer_8c.html#a1">PETIMER</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/timer_8c.html#a6">ExpTimerApcRoutine</a> (IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *NormalRoutine, IN PVOID *NormalContext, IN PVOID *SystemArgument1, IN PVOID *SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/timer_8c.html#a7">ExpTimerDpcRoutine</a> (IN <a class="el" href="../../d1/d6/struct__KDPC.html">PKDPC</a> Dpc, IN PVOID DeferredContext, IN PVOID SystemArgument1, IN PVOID SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/timer_8c.html#a8">ExpDeleteTimer</a> (IN PVOID Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/timer_8c.html#a9">ExpTimerInitialization</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/timer_8c.html#a10">ExTimerRundown</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/timer_8c.html#a11">NtCreateTimer</a> (OUT PHANDLE <a class="el" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a>, IN ACCESS_MASK DesiredAccess, IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a> OPTIONAL, IN TIMER_TYPE TimerType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/timer_8c.html#a12">NtOpenTimer</a> (OUT PHANDLE <a class="el" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a>, IN ACCESS_MASK DesiredAccess, IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/timer_8c.html#a13">NtCancelTimer</a> (IN HANDLE <a class="el" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a>, OUT PBOOLEAN CurrentState OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/timer_8c.html#a14">NtQueryTimer</a> (IN HANDLE <a class="el" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a>, IN TIMER_INFORMATION_CLASS TimerInformationClass, OUT PVOID TimerInformation, IN ULONG TimerInformationLength, OUT PULONG ReturnLength OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/timer_8c.html#a15">NtSetTimer</a> (IN HANDLE <a class="el" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a>, IN PLARGE_INTEGER DueTime, IN PTIMER_APC_ROUTINE TimerApcRoutine OPTIONAL, IN PVOID TimerContext OPTIONAL, IN BOOLEAN WakeTimer, IN LONG Period OPTIONAL, OUT PBOOLEAN PreviousState OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/timer_8c.html#a16">ExGetNextWakeTime</a> (OUT PULONGLONG DueTime, OUT PTIME_FIELDS <a class="el" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>, OUT PVOID *TimerObject)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>KSPIN_LOCK&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/timer_8c.html#a2">ExpWakeTimerListLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/timer_8c.html#a3">ExpWakeTimerList</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/timer_8c.html#a4">ExTimerObjectType</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>GENERIC_MAPPING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/timer_8c.html#a5">ExpTimerMapping</a></td></tr>

</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a0" doxytag="timer.c::ETIMER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d1/d7/struct__ETIMER.html">_ETIMER</a>  <a class="el" href="../../d1/d7/struct__ETIMER.html">ETIMER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="timer.c::PETIMER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d1/d7/struct__ETIMER.html">_ETIMER</a> * <a class="el" href="../../d1/d7/struct__ETIMER.html">PETIMER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d1/timer_8c-source.html#l01212">ExGetNextWakeTime()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00232">ExpDeleteTimer()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00081">ExpTimerApcRoutine()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00166">ExpTimerDpcRoutine()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00346">ExTimerRundown()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00679">NtCancelTimer()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00444">NtCreateTimer()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00822">NtQueryTimer()</a>, and <a class="el" href="../../d3/d1/timer_8c-source.html#l00960">NtSetTimer()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a16" doxytag="timer.c::ExGetNextWakeTime" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ExGetNextWakeTime           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PULONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DueTime</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PTIME_FIELDS&nbsp;</td>
          <td class="mdname" nowrap> <em>TimeFields</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>TimerObject</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/timer_8c-source.html#l01212">1212</a> of file <a class="el" href="../../d3/d1/timer_8c-source.html">timer.c</a>.
<p>
References <a class="el" href="../../d3/d1/timer_8c-source.html#l00049">ExpWakeTimerList</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00048">ExpWakeTimerListLock</a>, <a class="el" href="../../d5/d8/ex_8h.html#a317">ExSystemTimeToLocalTime()</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00122">KeQueryInterruptTime()</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00153">KeQuerySystemTime()</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00410">KeQueryTimerDueTime()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00033">_ETIMER::KeTimer</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d2/timer_8c.html#a1">PETIMER</a>, <a class="el" href="../../d2/d1/time_8c-source.html#l00508">RtlTimeToTimeFields()</a>, <a class="el" href="../../d7/d5/ttime_8c-source.html#l00046">TimeFields</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00040">_ETIMER::WakeTimer</a>, and <a class="el" href="../../d3/d1/timer_8c-source.html#l00041">_ETIMER::WakeTimerListEntry</a>.
<p>
<pre class="fragment"><div>01217 {
01218     PLIST_ENTRY     Link;
01219     <a class="code" href="../../d1/d7/struct__ETIMER.html">PETIMER</a>         ExTimer;
01220     <a class="code" href="../../d1/d7/struct__ETIMER.html">PETIMER</a>         BestTimer;
01221     KIRQL           OldIrql;
01222     ULONGLONG       TimerDueTime;
01223     ULONGLONG       BestDueTime;
01224     ULONGLONG       InterruptTime;
01225     LARGE_INTEGER   SystemTime;
01226     LARGE_INTEGER   CmosTime;
01227 
01228     ExAcquireSpinLock(&amp;ExpWakeTimerListLock, &amp;OldIrql);
01229     BestDueTime = 0;
01230     BestTimer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01231     Link = <a class="code" href="../../d2/d2/timer_8c.html#a3">ExpWakeTimerList</a>.Flink;
01232     <span class="keywordflow">while</span> (Link != &amp;<a class="code" href="../../d2/d2/timer_8c.html#a3">ExpWakeTimerList</a>) {
01233         ExTimer = CONTAINING_RECORD(Link, <a class="code" href="../../d1/d7/struct__ETIMER.html">ETIMER</a>, WakeTimerListEntry);
01234         Link = Link-&gt;Flink;
01235 
01236         <span class="keywordflow">if</span> (ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o7">WakeTimer</a>) {
01237 
01238             TimerDueTime = <a class="code" href="../../d3/d2/timerobj_8c.html#a8">KeQueryTimerDueTime</a>(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o0">KeTimer</a>);
01239             TimerDueTime = 0 - TimerDueTime;
01240 
01241             <span class="comment">//</span>
01242             <span class="comment">// Is this timers due time closer?</span>
01243             <span class="comment">//</span>
01244 
01245             <span class="keywordflow">if</span> (TimerDueTime &gt; BestDueTime) {
01246                 BestDueTime = TimerDueTime;
01247                 BestTimer = ExTimer;
01248             }
01249 
01250         } <span class="keywordflow">else</span> {
01251 
01252             <span class="comment">//</span>
01253             <span class="comment">// Timer is not an active wake timer, remove it</span>
01254             <span class="comment">//</span>
01255 
01256             RemoveEntryList(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o8">WakeTimerListEntry</a>);
01257             ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o8">WakeTimerListEntry</a>.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01258         }
01259     }
01260 
01261     ExReleaseSpinLock(&amp;ExpWakeTimerListLock, OldIrql);
01262 
01263     <span class="keywordflow">if</span> (BestDueTime) {
01264         <span class="comment">//</span>
01265         <span class="comment">// Convert time to timefields</span>
01266         <span class="comment">//</span>
01267 
01268         <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a> (&amp;SystemTime);
01269         InterruptTime = <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a2">KeQueryInterruptTime</a> ();
01270         BestDueTime = 0 - BestDueTime;
01271 
01272         SystemTime.QuadPart += BestDueTime - InterruptTime;
01273 
01274         <span class="comment">//</span>
01275         <span class="comment">// Many system alarms are only good to 1 second resolution.</span>
01276         <span class="comment">// Add one sceond to the target time so that the timer is really</span>
01277         <span class="comment">// elasped if this is the wake event.</span>
01278         <span class="comment">//</span>
01279 
01280         SystemTime.QuadPart += 10000000;
01281 
01282         <a class="code" href="../../d5/d8/ex_8h.html#a317">ExSystemTimeToLocalTime</a>(&amp;SystemTime,&amp;CmosTime);
01283         <a class="code" href="../../d1/d2/time_8c.html#a26">RtlTimeToTimeFields</a>(&amp;CmosTime, TimeFields);
01284     }
01285 
01286     *DueTime = BestDueTime;
01287     *TimerObject = BestTimer;
01288 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="timer.c::ExpDeleteTimer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ExpDeleteTimer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Object</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/timer_8c-source.html#l00232">232</a> of file <a class="el" href="../../d3/d1/timer_8c-source.html">timer.c</a>.
<p>
References <a class="el" href="../../d3/d1/timer_8c-source.html#l00048">ExpWakeTimerListLock</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00157">KeCancelTimer()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00033">_ETIMER::KeTimer</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d2/timer_8c.html#a1">PETIMER</a>, and <a class="el" href="../../d3/d1/timer_8c-source.html#l00041">_ETIMER::WakeTimerListEntry</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/timer_8c-source.html#l00281">ExpTimerInitialization()</a>.
<p>
<pre class="fragment"><div>00238                    :
00239 
00240     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">delete</span> routine <span class="keywordflow">for</span> timer objects. Its function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00241     to cancel <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer and free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> spin lock associated with a timer.
00242 
00243 Arguments:
00244 
00245     Object - Supplies a pointer to an executive timer object.
00246 
00247 Return Value:
00248 
00249     None.
00250 
00251 --*/
00252 
00253 {
00254     <a class="code" href="../../d1/d7/struct__ETIMER.html">PETIMER</a>     ExTimer;
00255     KIRQL       OldIrql;
00256 
00257     ExTimer = (<a class="code" href="../../d1/d7/struct__ETIMER.html">PETIMER</a>) Object;
00258 
00259     <span class="comment">//</span>
00260     <span class="comment">// Remove from wake list</span>
00261     <span class="comment">//</span>
00262 
00263     <span class="keywordflow">if</span> (ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o8">WakeTimerListEntry</a>.Flink) {
00264         ExAcquireSpinLock(&amp;ExpWakeTimerListLock, &amp;OldIrql);
00265         <span class="keywordflow">if</span> (ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o8">WakeTimerListEntry</a>.Flink) {
00266             RemoveEntryList(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o8">WakeTimerListEntry</a>);
00267             ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o8">WakeTimerListEntry</a>.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00268         }
00269         ExReleaseSpinLock(&amp;ExpWakeTimerListLock, OldIrql);
00270     }
00271 
00272     <span class="comment">//</span>
00273     <span class="comment">// Cancel the timer and free the spin lock associated with the timer.</span>
00274     <span class="comment">//</span>
00275 
00276     <a class="code" href="../../d3/d2/timerobj_8c.html#a4">KeCancelTimer</a>(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o0">KeTimer</a>);
00277     <span class="keywordflow">return</span>;
00278 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="timer.c::ExpTimerApcRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ExpTimerApcRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Apc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/timer_8c-source.html#l00081">81</a> of file <a class="el" href="../../d3/d1/timer_8c-source.html">timer.c</a>.
<p>
References <a class="el" href="../../d3/d1/timer_8c-source.html#l00036">_ETIMER::ActiveTimerListEntry</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00385">_ETHREAD::ActiveTimerListLock</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00039">_ETIMER::ApcAssociated</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00037">_ETIMER::Lock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00038">_ETIMER::Period</a>, <a class="el" href="../../d2/d2/timer_8c.html#a1">PETIMER</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00196">PKNORMAL_ROUTINE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00347">_ETHREAD::Tcb</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00239">_KAPC::Thread</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00034">_ETIMER::TimerApc</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/timer_8c-source.html#l00960">NtSetTimer()</a>.
<p>
<pre class="fragment"><div>00091                    :
00092 
00093     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> special APC routine that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to remove
00094     a timer from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread's active timer list.
00095 
00096 Arguments:
00097 
00098     Apc - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC object used to invoke <span class="keyword">this</span> routine.
00099 
00100     NormalRoutine - Supplies a pointer to a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> normal routine
00101         function that was specified when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC was initialized.
00102 
00103     NormalContext - Supplies a pointer to a pointer to an arbitrary data
00104         structure that was specified when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC was initialized.
00105 
00106     SystemArgument1, SystemArgument2 - Supplies a set of two pointers to
00107         two arguments that contain untyped data.
00108 
00109 Return Value:
00110 
00111     None.
00112 
00113 --*/
00114 
00115 {
00116 
00117     BOOLEAN Dereference;
00118     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> ExThread;
00119     <a class="code" href="../../d1/d7/struct__ETIMER.html">PETIMER</a> ExTimer;
00120     KIRQL OldIrql1;
00121 
00122     <span class="comment">//</span>
00123     <span class="comment">// Get address of executive timer object and the current thread object.</span>
00124     <span class="comment">//</span>
00125 
00126     ExThread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00127     ExTimer = CONTAINING_RECORD(Apc, <a class="code" href="../../d1/d7/struct__ETIMER.html">ETIMER</a>, TimerApc);
00128 
00129     <span class="comment">//</span>
00130     <span class="comment">// If the timer is still in the current thread's active timer list, then</span>
00131     <span class="comment">// remove it if it is not a periodic timer and set APC associated FALSE.</span>
00132     <span class="comment">// It is possible for the timer not to be in the current thread's active</span>
00133     <span class="comment">// timer list since the APC could have been delivered, and then another</span>
00134     <span class="comment">// thread could have set the timer again with another APC. This would</span>
00135     <span class="comment">// have caused the timer to be removed from the current thread's active</span>
00136     <span class="comment">// timer list.</span>
00137     <span class="comment">//</span>
00138     <span class="comment">// N. B. The spin locks for the timer and the active timer list must be</span>
00139     <span class="comment">//  acquired in the order: 1) timer lock, 2) thread list lock.</span>
00140     <span class="comment">//</span>
00141 
00142     Dereference = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00143     ExAcquireSpinLock(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o4">Lock</a>, &amp;OldIrql1);
00144     ExAcquireSpinLockAtDpcLevel(&amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o10">ActiveTimerListLock</a>);
00145     <span class="keywordflow">if</span> ((ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o6">ApcAssociated</a>) &amp;&amp; (&amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a> == ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o1">TimerApc</a>.<a class="code" href="../../d1/d5/struct__KAPC.html#o3">Thread</a>)) {
00146         <span class="keywordflow">if</span> (ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o5">Period</a> == 0) {
00147             RemoveEntryList(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o3">ActiveTimerListEntry</a>);
00148             ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o6">ApcAssociated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00149             Dereference = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00150         }
00151 
00152     } <span class="keywordflow">else</span> {
00153         *NormalRoutine = (<a class="code" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00154     }
00155 
00156     ExReleaseSpinLockFromDpcLevel(&amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o10">ActiveTimerListLock</a>);
00157     ExReleaseSpinLock(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o4">Lock</a>, OldIrql1);
00158     <span class="keywordflow">if</span> (Dereference) {
00159         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)ExTimer);
00160     }
00161 
00162     <span class="keywordflow">return</span>;
00163 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="timer.c::ExpTimerDpcRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ExpTimerDpcRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d6/struct__KDPC.html">PKDPC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Dpc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>DeferredContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/timer_8c-source.html#l00166">166</a> of file <a class="el" href="../../d3/d1/timer_8c-source.html">timer.c</a>.
<p>
References <a class="el" href="../../d3/d1/timer_8c-source.html#l00039">_ETIMER::ApcAssociated</a>, <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00217">KeInsertQueueApc()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00033">_ETIMER::KeTimer</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00037">_ETIMER::Lock</a>, <a class="el" href="../../d2/d2/timer_8c.html#a1">PETIMER</a>, <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00162">TIMER_APC_INCREMENT</a>, and <a class="el" href="../../d3/d1/timer_8c-source.html#l00034">_ETIMER::TimerApc</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/timer_8c-source.html#l00444">NtCreateTimer()</a>.
<p>
<pre class="fragment"><div>00175                    :
00176 
00177     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DPC routine that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when a timer expires that
00178     has an associated APC routine. Its function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to insert <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> associated
00179     APC into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target thread's APC queue.
00180 
00181 Arguments:
00182 
00183     Dpc - Supplies a pointer to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> DPC.
00184 
00185     DeferredContext - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> executive timer that contains
00186         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DPC that caused <span class="keyword">this</span> routine to be executed.
00187 
00188     SystemArgument1, SystemArgument2 - Supplies values that are not used by
00189         <span class="keyword">this</span> routine.
00190 
00191 Return Value:
00192 
00193     None.
00194 
00195 --*/
00196 
00197 {
00198 
00199     <a class="code" href="../../d1/d7/struct__ETIMER.html">PETIMER</a> ExTimer;
00200     <a class="code" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> KeTimer;
00201     KIRQL OldIrql;
00202 
00203     <span class="comment">//</span>
00204     <span class="comment">// Get address of executive and kernel timer objects.</span>
00205     <span class="comment">//</span>
00206 
00207     ExTimer = (<a class="code" href="../../d1/d7/struct__ETIMER.html">PETIMER</a>)DeferredContext;
00208     KeTimer = &amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o0">KeTimer</a>;
00209 
00210     <span class="comment">//</span>
00211     <span class="comment">// If there is still an APC associated with the timer, then insert the APC</span>
00212     <span class="comment">// in target thread's APC queue. It is possible that the timer does not</span>
00213     <span class="comment">// have an associated APC. This can happen when the timer is set to expire</span>
00214     <span class="comment">// by a thread running on another processor just after the DPC has been</span>
00215     <span class="comment">// removed from the DPC queue, but before it has acquired the timer related</span>
00216     <span class="comment">// spin lock.</span>
00217     <span class="comment">//</span>
00218 
00219     ExAcquireSpinLock(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o4">Lock</a>, &amp;OldIrql);
00220     <span class="keywordflow">if</span> (ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o6">ApcAssociated</a>) {
00221         <a class="code" href="../../d5/d7/apcobj_8c.html#a3">KeInsertQueueApc</a>(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o1">TimerApc</a>,
00222                          SystemArgument1,
00223                          SystemArgument2,
00224                          TIMER_APC_INCREMENT);
00225     }
00226 
00227     ExReleaseSpinLock(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o4">Lock</a>, OldIrql);
00228     <span class="keywordflow">return</span>;
00229 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="timer.c::ExpTimerInitialization" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN ExpTimerInitialization           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/timer_8c-source.html#l00281">281</a> of file <a class="el" href="../../d3/d1/timer_8c-source.html">timer.c</a>.
<p>
References <a class="el" href="../../d3/d1/timer_8c-source.html#l00232">ExpDeleteTimer()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00062">ExpTimerMapping</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00049">ExpWakeTimerList</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00048">ExpWakeTimerListLock</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00055">ExTimerObjectType</a>, <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d1/obtype_8c-source.html#l00069">ObCreateObjectType()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>00286                    :
00287 
00288     This function creates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> descriptor at system
00289     initialization and stores <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> descriptor
00290     in local <span class="keyword">static</span> storage.
00291 
00292 Arguments:
00293 
00294     None.
00295 
00296 Return Value:
00297 
00298     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> descriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00299     successfully initialized. Otherwise a value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00300 
00301 --*/
00302 
00303 {
00304 
00305     <a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html">OBJECT_TYPE_INITIALIZER</a> ObjectTypeInitializer;
00306     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00307     UNICODE_STRING TypeName;
00308 
00309     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;ExpWakeTimerListLock);
00310     InitializeListHead (&amp;ExpWakeTimerList);
00311 
00312     <span class="comment">//</span>
00313     <span class="comment">// Initialize string descriptor.</span>
00314     <span class="comment">//</span>
00315 
00316     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;TypeName, L<span class="stringliteral">"Timer"</span>);
00317 
00318     <span class="comment">//</span>
00319     <span class="comment">// Create timer object type descriptor.</span>
00320     <span class="comment">//</span>
00321 
00322     RtlZeroMemory(&amp;ObjectTypeInitializer, <span class="keyword">sizeof</span>(ObjectTypeInitializer));
00323     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o0">Length</a> = <span class="keyword">sizeof</span>(ObjectTypeInitializer);
00324     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o3">InvalidAttributes</a> = OBJ_OPENLINK;
00325     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> = <a class="code" href="../../d2/d2/timer_8c.html#a5">ExpTimerMapping</a>;
00326     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o9">PoolType</a> = <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>;
00327     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o11">DefaultNonPagedPoolCharge</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d7/struct__ETIMER.html">ETIMER</a>);
00328     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o5">ValidAccessMask</a> = TIMER_ALL_ACCESS;
00329     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o15">DeleteProcedure</a> = <a class="code" href="../../d2/d2/timer_8c.html#a8">ExpDeleteTimer</a>;
00330     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>(&amp;TypeName,
00331                                 &amp;ObjectTypeInitializer,
00332                                 (PSECURITY_DESCRIPTOR)NULL,
00333                                 &amp;ExTimerObjectType);
00334 
00335 
00336 
00337     <span class="comment">//</span>
00338     <span class="comment">// If the time object type descriptor was successfully created, then</span>
00339     <span class="comment">// return a value of TRUE. Otherwise return a value of FALSE.</span>
00340     <span class="comment">//</span>
00341 
00342     <span class="keywordflow">return</span> (BOOLEAN)(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
00343 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="timer.c::ExTimerRundown" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ExTimerRundown           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/timer_8c-source.html#l00346">346</a> of file <a class="el" href="../../d3/d1/timer_8c-source.html">timer.c</a>.
<p>
References <a class="el" href="../../d3/d1/timer_8c-source.html#l00036">_ETIMER::ActiveTimerListEntry</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00386">_ETHREAD::ActiveTimerListHead</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00385">_ETHREAD::ActiveTimerListLock</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00039">_ETIMER::ApcAssociated</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00157">KeCancelTimer()</a>, <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00291">KeRemoveQueueApc()</a>, <a class="el" href="../../d5/d0/dpcobj_8c-source.html#l00272">KeRemoveQueueDpc()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00033">_ETIMER::KeTimer</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00037">_ETIMER::Lock</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d2/d2/timer_8c.html#a1">PETIMER</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00347">_ETHREAD::Tcb</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00239">_KAPC::Thread</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00034">_ETIMER::TimerApc</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00035">_ETIMER::TimerDpc</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/tex_8c-source.html#l02376">oops()</a>, and <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00690">PspExitThread()</a>.
<p>
<pre class="fragment"><div>00351                    :
00352 
00353     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when a thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> about to be terminated to
00354     process <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> active timer list. It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed that APC's have been
00355     disabled <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subject thread, thus <span class="keyword">this</span> code cannot be interrupted
00356     to execute an APC <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread.
00357 
00358 Arguments:
00359 
00360     None.
00361 
00362 Return Value:
00363 
00364     None.
00365 
00366 --*/
00367 
00368 {
00369 
00370     BOOLEAN Dereference;
00371     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> ExThread;
00372     <a class="code" href="../../d1/d7/struct__ETIMER.html">PETIMER</a> ExTimer;
00373     PLIST_ENTRY NextEntry;
00374     KIRQL OldIrql1;
00375 
00376     <span class="comment">//</span>
00377     <span class="comment">// Process each entry in the active timer list.</span>
00378     <span class="comment">//</span>
00379 
00380     ExThread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00381     ExAcquireSpinLock(&amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o10">ActiveTimerListLock</a>, &amp;OldIrql1);
00382     NextEntry = ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o11">ActiveTimerListHead</a>.Flink;
00383     <span class="keywordflow">while</span> (NextEntry != &amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o11">ActiveTimerListHead</a>) {
00384         ExTimer = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d1/d7/struct__ETIMER.html">ETIMER</a>, ActiveTimerListEntry);
00385 
00386         <span class="comment">//</span>
00387         <span class="comment">// Increment the reference count on the object so that it cannot be</span>
00388         <span class="comment">// deleted, and then drop the active timer list lock.</span>
00389         <span class="comment">//</span>
00390         <span class="comment">// N. B. The object reference cannot fail and will acquire no mutexes.</span>
00391         <span class="comment">//</span>
00392 
00393         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(ExTimer);
00394         ExReleaseSpinLock(&amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o10">ActiveTimerListLock</a>, OldIrql1);
00395 
00396         <span class="comment">//</span>
00397         <span class="comment">// Acquire the timer spin lock and reacquire the active time list spin</span>
00398         <span class="comment">// lock. If the timer is still in the current thread's active timer</span>
00399         <span class="comment">// list, then cancel the timer, remove the timer's DPC from the DPC</span>
00400         <span class="comment">// queue, remove the timer's APC from the APC queue, remove the timer</span>
00401         <span class="comment">// from the thread's active timer list, and set the associate APC</span>
00402         <span class="comment">// flag FALSE.</span>
00403         <span class="comment">//</span>
00404         <span class="comment">// N. B. The spin locks for the timer and the active timer list must be</span>
00405         <span class="comment">//  acquired in the order: 1) timer lock, 2) thread list lock.</span>
00406         <span class="comment">//</span>
00407 
00408         ExAcquireSpinLock(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o4">Lock</a>, &amp;OldIrql1);
00409         ExAcquireSpinLockAtDpcLevel(&amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o10">ActiveTimerListLock</a>);
00410         <span class="keywordflow">if</span> ((ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o6">ApcAssociated</a>) &amp;&amp; (&amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a> == ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o1">TimerApc</a>.<a class="code" href="../../d1/d5/struct__KAPC.html#o3">Thread</a>)) {
00411             RemoveEntryList(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o3">ActiveTimerListEntry</a>);
00412             ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o6">ApcAssociated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00413             <a class="code" href="../../d3/d2/timerobj_8c.html#a4">KeCancelTimer</a>(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o0">KeTimer</a>);
00414             <a class="code" href="../../d4/d1/dpcobj_8c.html#a3">KeRemoveQueueDpc</a>(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o2">TimerDpc</a>);
00415             <a class="code" href="../../d5/d7/apcobj_8c.html#a4">KeRemoveQueueApc</a>(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o1">TimerApc</a>);
00416             Dereference = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00417 
00418         } <span class="keywordflow">else</span> {
00419             Dereference = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00420         }
00421 
00422         ExReleaseSpinLockFromDpcLevel(&amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o10">ActiveTimerListLock</a>);
00423         ExReleaseSpinLock(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o4">Lock</a>, OldIrql1);
00424         <span class="keywordflow">if</span> (Dereference) {
00425             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)ExTimer);
00426         }
00427 
00428         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)ExTimer);
00429 
00430         <span class="comment">//</span>
00431         <span class="comment">// Raise IRQL to DISPATCH_LEVEL and reacquire active timer list</span>
00432         <span class="comment">// spin lock.</span>
00433         <span class="comment">//</span>
00434 
00435         ExAcquireSpinLock(&amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o10">ActiveTimerListLock</a>, &amp;OldIrql1);
00436         NextEntry = ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o11">ActiveTimerListHead</a>.Flink;
00437     }
00438 
00439     ExReleaseSpinLock(&amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o10">ActiveTimerListLock</a>, OldIrql1);
00440     <span class="keywordflow">return</span>;
00441 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="timer.c::NtCancelTimer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtCancelTimer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>TimerHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN CurrentState&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/timer_8c-source.html#l00679">679</a> of file <a class="el" href="../../d3/d1/timer_8c-source.html">timer.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00385">_ETHREAD::ActiveTimerListLock</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00048">ExpWakeTimerListLock</a>, <a class="el" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00055">ExTimerObjectType</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00157">KeCancelTimer()</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00211">KeReadStateTimer()</a>, <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00291">KeRemoveQueueApc()</a>, <a class="el" href="../../d5/d0/dpcobj_8c-source.html#l00272">KeRemoveQueueDpc()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d2/d2/timer_8c.html#a1">PETIMER</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01447">ProbeForWriteBoolean</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00252">TimerHandle</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l04429">RtlpResetTimer()</a>.
<p>
<pre class="fragment"><div>00686                    :
00687 
00688     This function cancels a timer object.
00689 
00690 Arguments:
00691 
00692     <a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a> - Supplies a handle to an timer object.
00693 
00694     CurrentState - Supplies an optional pointer to a variable that will
00695         receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer object.
00696 
00697 Return Value:
00698 
00699     TBS
00700 
00701 --*/
00702 
00703 {
00704 
00705     BOOLEAN Dereference;
00706     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> ExThread;
00707     <a class="code" href="../../d1/d7/struct__ETIMER.html">PETIMER</a> ExTimer;
00708     KIRQL OldIrql1;
00709     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00710     BOOLEAN State;
00711     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00712 
00713     <span class="comment">//</span>
00714     <span class="comment">// Establish an exception handler, probe the current state address if</span>
00715     <span class="comment">// specified, reference the timer object, and cancel the timer object.</span>
00716     <span class="comment">// If the probe fails, then return the exception code as the service</span>
00717     <span class="comment">// status. Otherwise return the status value returned by the reference</span>
00718     <span class="comment">// object by handle routine.</span>
00719     <span class="comment">//</span>
00720 
00721     <span class="keywordflow">try</span> {
00722 
00723         <span class="comment">//</span>
00724         <span class="comment">// Get previous processor mode and probe current state address if</span>
00725         <span class="comment">// necessary.</span>
00726         <span class="comment">//</span>
00727 
00728         PreviousMode = KeGetPreviousMode();
00729         <span class="keywordflow">if</span> ((PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) &amp;&amp; (ARGUMENT_PRESENT(CurrentState))) {
00730             <a class="code" href="../../d5/d8/ex_8h.html#a28">ProbeForWriteBoolean</a>(CurrentState);
00731         }
00732 
00733         <span class="comment">//</span>
00734         <span class="comment">// Reference timer object by handle.</span>
00735         <span class="comment">//</span>
00736 
00737         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(TimerHandle,
00738                                            TIMER_MODIFY_STATE,
00739                                            ExTimerObjectType,
00740                                            PreviousMode,
00741                                            (PVOID *)&amp;ExTimer,
00742                                            NULL);
00743 
00744         <span class="comment">//</span>
00745         <span class="comment">// If the reference was successful, then cancel the timer object,</span>
00746         <span class="comment">// dereference the timer object, and write the current state value</span>
00747         <span class="comment">// if specified. If the write attempt fails, then do not report an</span>
00748         <span class="comment">// error. When the caller attempts to access the current state value,</span>
00749         <span class="comment">// an access violation will occur.</span>
00750         <span class="comment">//</span>
00751 
00752         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00753             ExAcquireSpinLock(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o4">Lock</a>, &amp;OldIrql1);
00754             <span class="keywordflow">if</span> (ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o6">ApcAssociated</a>) {
00755                 ExThread = CONTAINING_RECORD(ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o1">TimerApc</a>.<a class="code" href="../../d1/d5/struct__KAPC.html#o3">Thread</a>, <a class="code" href="../../d5/d6/struct__ETHREAD.html">ETHREAD</a>, Tcb);
00756                 ExAcquireSpinLockAtDpcLevel(&amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o10">ActiveTimerListLock</a>);
00757                 RemoveEntryList(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o3">ActiveTimerListEntry</a>);
00758                 ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o6">ApcAssociated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00759                 ExReleaseSpinLockFromDpcLevel(&amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o10">ActiveTimerListLock</a>);
00760                 <a class="code" href="../../d3/d2/timerobj_8c.html#a4">KeCancelTimer</a>(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o0">KeTimer</a>);
00761                 <a class="code" href="../../d4/d1/dpcobj_8c.html#a3">KeRemoveQueueDpc</a>(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o2">TimerDpc</a>);
00762                 <a class="code" href="../../d5/d7/apcobj_8c.html#a4">KeRemoveQueueApc</a>(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o1">TimerApc</a>);
00763                 Dereference = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00764 
00765             } <span class="keywordflow">else</span> {
00766                 <a class="code" href="../../d3/d2/timerobj_8c.html#a4">KeCancelTimer</a>(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o0">KeTimer</a>);
00767                 Dereference = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00768             }
00769 
00770             <span class="keywordflow">if</span> (ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o8">WakeTimerListEntry</a>.Flink) {
00771                 ExAcquireSpinLockAtDpcLevel(&amp;ExpWakeTimerListLock);
00772 
00773                 <span class="comment">//</span>
00774                 <span class="comment">// Check again as ExGetNextWakeTime might have removed it.</span>
00775                 <span class="comment">//</span>
00776                 <span class="keywordflow">if</span> (ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o8">WakeTimerListEntry</a>.Flink) {
00777                     RemoveEntryList(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o8">WakeTimerListEntry</a>);
00778                     ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o8">WakeTimerListEntry</a>.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00779                 }
00780                 ExReleaseSpinLockFromDpcLevel(&amp;ExpWakeTimerListLock);
00781             }
00782 
00783             ExReleaseSpinLock(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o4">Lock</a>, OldIrql1);
00784             <span class="keywordflow">if</span> (Dereference) {
00785                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)ExTimer);
00786             }
00787 
00788             <span class="comment">//</span>
00789             <span class="comment">// Read current state of timer, dereference timer object, and set</span>
00790             <span class="comment">// current state.</span>
00791             <span class="comment">//</span>
00792 
00793             State = <a class="code" href="../../d3/d2/timerobj_8c.html#a5">KeReadStateTimer</a>(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o0">KeTimer</a>);
00794             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(ExTimer);
00795             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(CurrentState)) {
00796                 <span class="keywordflow">try</span> {
00797                     *CurrentState = State;
00798 
00799                 } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00800                 }
00801             }
00802         }
00803 
00804     <span class="comment">//</span>
00805     <span class="comment">// If an exception occurs during the probe of the current state address,</span>
00806     <span class="comment">// then always handle the exception and return the exception code as the</span>
00807     <span class="comment">// status value.</span>
00808     <span class="comment">//</span>
00809 
00810     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00811         <span class="keywordflow">return</span> GetExceptionCode();
00812     }
00813 
00814     <span class="comment">//</span>
00815     <span class="comment">// Return service status.</span>
00816     <span class="comment">//</span>
00817 
00818     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00819 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="timer.c::NtCreateTimer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtCreateTimer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>TimerHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN TIMER_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>TimerType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/timer_8c-source.html#l00444">444</a> of file <a class="el" href="../../d3/d1/timer_8c-source.html">timer.c</a>.
<p>
References <a class="el" href="../../d3/d1/timer_8c-source.html#l00166">ExpTimerDpcRoutine()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00055">ExTimerObjectType</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d5/d0/dpcobj_8c-source.html#l00039">KeInitializeDpc()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00075">KeInitializeTimerEx()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00055">ObCreateObject()</a>, <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d2/d2/timer_8c.html#a1">PETIMER</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01564">ProbeForWriteHandle</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00252">TimerHandle</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l05256">RtlpInitializeTimerThreadPool()</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l02824">RtlpWaitThread()</a>.
<p>
<pre class="fragment"><div>00453                    :
00454 
00455     This function creates an timer object and opens a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object with
00456     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified desired access.
00457 
00458 Arguments:
00459 
00460     <a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a> - Supplies a pointer to a variable that will receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00461         timer object handle.
00462 
00463     DesiredAccess - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired types of access <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer object.
00464 
00465     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a> - Supplies a pointer to an object attributes structure.
00466 
00467     TimerType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer (autoclearing or notification).
00468 
00469 Return Value:
00470 
00471     TBS
00472 
00473 --*/
00474 
00475 {
00476 
00477     <a class="code" href="../../d1/d7/struct__ETIMER.html">PETIMER</a> ExTimer;
00478     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00479     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00480     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00481 
00482     <span class="comment">//</span>
00483     <span class="comment">// Establish an exception handler, probe the output handle address, and</span>
00484     <span class="comment">// attempt to create a timer object. If the probe fails, then return the</span>
00485     <span class="comment">// exception code as the service status. Otherwise return the status value</span>
00486     <span class="comment">// returned by the object insertion routine.</span>
00487     <span class="comment">//</span>
00488 
00489     <span class="keywordflow">try</span> {
00490 
00491         <span class="comment">//</span>
00492         <span class="comment">// Get previous processor mode and probe output handle address if</span>
00493         <span class="comment">// necessary.</span>
00494         <span class="comment">//</span>
00495 
00496         PreviousMode = KeGetPreviousMode();
00497         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00498             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>(TimerHandle);
00499         }
00500 
00501         <span class="comment">//</span>
00502         <span class="comment">// Check argument validity.</span>
00503         <span class="comment">//</span>
00504 
00505         <span class="keywordflow">if</span> ((TimerType != NotificationTimer) &amp;&amp;
00506             (TimerType != SynchronizationTimer)) {
00507             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_4;
00508         }
00509 
00510         <span class="comment">//</span>
00511         <span class="comment">// Allocate timer object.</span>
00512         <span class="comment">//</span>
00513 
00514         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>(PreviousMode,
00515                                 ExTimerObjectType,
00516                                 ObjectAttributes,
00517                                 PreviousMode,
00518                                 NULL,
00519                                 <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d7/struct__ETIMER.html">ETIMER</a>),
00520                                 0,
00521                                 0,
00522                                 (PVOID *)&amp;ExTimer);
00523 
00524         <span class="comment">//</span>
00525         <span class="comment">// If the timer object was successfully allocated, then initialize the</span>
00526         <span class="comment">// timer object and attempt to insert the time object in the current</span>
00527         <span class="comment">// process' handle table.</span>
00528         <span class="comment">//</span>
00529 
00530         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00531             <a class="code" href="../../d4/d1/dpcobj_8c.html#a1">KeInitializeDpc</a>(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o2">TimerDpc</a>,
00532                             ExpTimerDpcRoutine,
00533                             (PVOID)ExTimer);
00534 
00535             <a class="code" href="../../d3/d2/timerobj_8c.html#a2">KeInitializeTimerEx</a>(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o0">KeTimer</a>, TimerType);
00536             <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o4">Lock</a>);
00537             ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o6">ApcAssociated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00538             ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o7">WakeTimer</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00539             ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o8">WakeTimerListEntry</a>.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00540             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>((PVOID)ExTimer,
00541                                     NULL,
00542                                     DesiredAccess,
00543                                     0,
00544                                     (PVOID *)NULL,
00545                                     &amp;Handle);
00546 
00547             <span class="comment">//</span>
00548             <span class="comment">// If the timer object was successfully inserted in the current</span>
00549             <span class="comment">// process' handle table, then attempt to write the timer object</span>
00550             <span class="comment">// handle value. If the write attempt fails, then do not report</span>
00551             <span class="comment">// an error. When the caller attempts to access the handle value,</span>
00552             <span class="comment">// an access violation will occur.</span>
00553             <span class="comment">//</span>
00554 
00555             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00556                 <span class="keywordflow">try</span> {
00557                     *<a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00558                  } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00559                  }
00560             }
00561         }
00562 
00563     <span class="comment">//</span>
00564     <span class="comment">// If an exception occurs during the probe of the output handle address,</span>
00565     <span class="comment">// then always handle the exception and return the exception code as the</span>
00566     <span class="comment">// status value.</span>
00567     <span class="comment">//</span>
00568 
00569     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00570         <span class="keywordflow">return</span> GetExceptionCode();
00571     }
00572 
00573     <span class="comment">//</span>
00574     <span class="comment">// Return service status.</span>
00575     <span class="comment">//</span>
00576 
00577     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00578 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="timer.c::NtOpenTimer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtOpenTimer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>TimerHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectAttributes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/timer_8c-source.html#l00581">581</a> of file <a class="el" href="../../d3/d1/timer_8c-source.html">timer.c</a>.
<p>
References <a class="el" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00055">ExTimerObjectType</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00095">ObOpenObjectByName()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01564">ProbeForWriteHandle</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00252">TimerHandle</a>.
<p>
<pre class="fragment"><div>00589                    :
00590 
00591     This function opens a handle to an timer object with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00592     desired access.
00593 
00594 Arguments:
00595 
00596     <a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a> - Supplies a pointer to a variable that will receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00597         timer object handle.
00598 
00599     DesiredAccess - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired types of access <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer object.
00600 
00601     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a> - Supplies a pointer to an object attributes structure.
00602 
00603 Return Value:
00604 
00605     TBS
00606 
00607 --*/
00608 
00609 {
00610 
00611     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00612     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00613     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00614 
00615     <span class="comment">//</span>
00616     <span class="comment">// Establish an exception handler, probe the output handle address, and</span>
00617     <span class="comment">// attempt to open a timer object. If the probe fails, then return the</span>
00618     <span class="comment">// exception code as the service status. Otherwise return the status value</span>
00619     <span class="comment">// returned by the open object routine.</span>
00620     <span class="comment">//</span>
00621 
00622     <span class="keywordflow">try</span> {
00623 
00624         <span class="comment">//</span>
00625         <span class="comment">// Get previous processor mode and probe output handle address if</span>
00626         <span class="comment">// necessary.</span>
00627         <span class="comment">//</span>
00628 
00629         PreviousMode = KeGetPreviousMode();
00630         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00631             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>(TimerHandle);
00632         }
00633 
00634         <span class="comment">//</span>
00635         <span class="comment">// Open handle to the timer object with the specified desired access.</span>
00636         <span class="comment">//</span>
00637 
00638         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>(ObjectAttributes,
00639                                     ExTimerObjectType,
00640                                     PreviousMode,
00641                                     NULL,
00642                                     DesiredAccess,
00643                                     NULL,
00644                                     &amp;Handle);
00645 
00646         <span class="comment">//</span>
00647         <span class="comment">// If the open was successful, then attempt to write the timer object</span>
00648         <span class="comment">// handle value. If the write attempt fails, then do not report an</span>
00649         <span class="comment">// error. When the caller attempts to access the handle value, an</span>
00650         <span class="comment">// access violation will occur.</span>
00651         <span class="comment">//</span>
00652 
00653         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00654             <span class="keywordflow">try</span> {
00655                 *<a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00656 
00657             } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00658             }
00659         }
00660 
00661     <span class="comment">//</span>
00662     <span class="comment">// If an exception occurs during the probe of the output handle address,</span>
00663     <span class="comment">// then always handle the exception and return the exception code as the</span>
00664     <span class="comment">// status value.</span>
00665     <span class="comment">//</span>
00666 
00667     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00668         <span class="keywordflow">return</span> GetExceptionCode();
00669     }
00670 
00671     <span class="comment">//</span>
00672     <span class="comment">// Return service status.</span>
00673     <span class="comment">//</span>
00674 
00675     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00676 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="timer.c::NtQueryTimer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtQueryTimer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>TimerHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN TIMER_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>TimerInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>TimerInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>TimerInformationLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG ReturnLength&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/timer_8c-source.html#l00822">822</a> of file <a class="el" href="../../d3/d1/timer_8c-source.html">timer.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l00523">_KTIMER::DueTime</a>, <a class="el" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00055">ExTimerObjectType</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00211">KeReadStateTimer()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d2/d2/timer_8c.html#a1">PETIMER</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01649">ProbeForWriteUlong</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00252">TimerHandle</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l04378">RtlpGetTimeRemaining()</a>.
<p>
<pre class="fragment"><div>00832                    :
00833 
00834     This function queries <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state of an timer object and returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00835     requested information in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified record structure.
00836 
00837 Arguments:
00838 
00839     <a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a> - Supplies a handle to an timer object.
00840 
00841     TimerInformationClass - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">class </span>of information being requested.
00842 
00843     TimerInformation - Supplies a pointer to a record that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00844         requested information.
00845 
00846     TimerInformationLength - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> record that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to
00847         receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested information.
00848 
00849     ReturnLength - Supplies an optional pointer to a variable that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to
00850         receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual length of information that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00851 
00852 Return Value:
00853 
00854     TBS
00855 
00856 --*/
00857 
00858 {
00859 
00860     <a class="code" href="../../d1/d7/struct__ETIMER.html">PETIMER</a> ExTimer;
00861     <a class="code" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> KeTimer;
00862     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00863     BOOLEAN State;
00864     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00865     LARGE_INTEGER TimeToGo;
00866 
00867     <span class="comment">//</span>
00868     <span class="comment">// Establish an exception handler, probe the output arguments, reference</span>
00869     <span class="comment">// the timer object, and return the specified information. If the probe</span>
00870     <span class="comment">// fails, then return the exception code as the service status. Otherwise</span>
00871     <span class="comment">// return the status value returned by the reference object by handle</span>
00872     <span class="comment">// routine.</span>
00873     <span class="comment">//</span>
00874 
00875     <span class="keywordflow">try</span> {
00876 
00877         <span class="comment">//</span>
00878         <span class="comment">// Get previous processor mode and probe output arguments if necessary.</span>
00879         <span class="comment">//</span>
00880 
00881         PreviousMode = KeGetPreviousMode();
00882         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00883             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(TimerInformation,
00884                           <span class="keyword">sizeof</span>(TIMER_BASIC_INFORMATION),
00885                           <span class="keyword">sizeof</span>(ULONG));
00886 
00887             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength)) {
00888                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(ReturnLength);
00889             }
00890         }
00891 
00892         <span class="comment">//</span>
00893         <span class="comment">// Check argument validity.</span>
00894         <span class="comment">//</span>
00895 
00896         <span class="keywordflow">if</span> (TimerInformationClass != TimerBasicInformation) {
00897             <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
00898         }
00899 
00900         <span class="keywordflow">if</span> (TimerInformationLength != <span class="keyword">sizeof</span>(TIMER_BASIC_INFORMATION)) {
00901             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00902         }
00903 
00904         <span class="comment">//</span>
00905         <span class="comment">// Reference timer object by handle.</span>
00906         <span class="comment">//</span>
00907 
00908         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(TimerHandle,
00909                                            TIMER_QUERY_STATE,
00910                                            ExTimerObjectType,
00911                                            PreviousMode,
00912                                            (PVOID *)&amp;ExTimer,
00913                                            NULL);
00914 
00915         <span class="comment">//</span>
00916         <span class="comment">// If the reference was successful, then read the current state,</span>
00917         <span class="comment">// compute the time remaining, dereference the timer object, fill in</span>
00918         <span class="comment">// the information structure, and return the length of the information</span>
00919         <span class="comment">// structure if specified. If the write of the time information or the</span>
00920         <span class="comment">// return length fails, then do not report an error. When the caller</span>
00921         <span class="comment">// accesses the information structure or the length, an violation will</span>
00922         <span class="comment">// occur.</span>
00923         <span class="comment">//</span>
00924 
00925         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00926             KeTimer = &amp;ExTimer-&gt;KeTimer;
00927             State = <a class="code" href="../../d3/d2/timerobj_8c.html#a5">KeReadStateTimer</a>(KeTimer);
00928             KiQueryInterruptTime(&amp;TimeToGo);
00929             TimeToGo.QuadPart = KeTimer-&gt;DueTime.QuadPart - TimeToGo.QuadPart;
00930             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(ExTimer);
00931             <span class="keywordflow">try</span> {
00932                 ((PTIMER_BASIC_INFORMATION)TimerInformation)-&gt;TimerState = State;
00933                 ((PTIMER_BASIC_INFORMATION)TimerInformation)-&gt;RemainingTime = TimeToGo;
00934                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength)) {
00935                     *ReturnLength = <span class="keyword">sizeof</span>(TIMER_BASIC_INFORMATION);
00936                 }
00937 
00938             } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00939             }
00940         }
00941 
00942     <span class="comment">//</span>
00943     <span class="comment">// If an exception occurs during the probe of the current state address,</span>
00944     <span class="comment">// then always handle the exception and return the exception code as the</span>
00945     <span class="comment">// status value.</span>
00946     <span class="comment">//</span>
00947 
00948     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00949         <span class="keywordflow">return</span> GetExceptionCode();
00950     }
00951 
00952     <span class="comment">//</span>
00953     <span class="comment">// Return service status.</span>
00954     <span class="comment">//</span>
00955 
00956     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00957 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="timer.c::NtSetTimer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtSetTimer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>TimerHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>DueTime</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PTIMER_APC_ROUTINE TimerApcRoutine&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID TimerContext&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>WakeTimer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONG Period&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN PreviousState&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/timer_8c-source.html#l00960">960</a> of file <a class="el" href="../../d3/d1/timer_8c-source.html">timer.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00386">_ETHREAD::ActiveTimerListHead</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00385">_ETHREAD::ActiveTimerListLock</a>, <a class="el" href="../../d4/d9/ke_8h.html#a403a183">CurrentApcEnvironment</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00081">ExpTimerApcRoutine()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00049">ExpWakeTimerList</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00048">ExpWakeTimerListLock</a>, <a class="el" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00055">ExTimerObjectType</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00157">KeCancelTimer()</a>, <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00039">KeInitializeApc()</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00211">KeReadStateTimer()</a>, <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00291">KeRemoveQueueApc()</a>, <a class="el" href="../../d5/d0/dpcobj_8c-source.html#l00272">KeRemoveQueueDpc()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00285">KeSetTimerEx()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d2/d2/timer_8c.html#a1">PETIMER</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00196">PKNORMAL_ROUTINE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00214">PKRUNDOWN_ROUTINE</a>, <a class="el" href="../../d2/d1/po_8h-source.html#l00148">PoWakeTimerSupported</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01447">ProbeForWriteBoolean</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00347">_ETHREAD::Tcb</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l00804">TimerApcRoutine()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00252">TimerHandle</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l04429">RtlpResetTimer()</a>.
<p>
<pre class="fragment"><div>00972                    :
00973 
00974     This function sets an timer object to a Not-Signaled state and sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer
00975     to expire at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified time.
00976 
00977 Arguments:
00978 
00979     <a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a> - Supplies a handle to an timer object.
00980 
00981     DueTime - Supplies a pointer to absolute of relative time at which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00982         timer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to expire.
00983 
00984     <a class="code" href="../../d4/d0/tex_8c.html#a29">TimerApcRoutine</a> - Supplies an optional pointer to a function which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to
00985         be executed when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer expires. If <span class="keyword">this</span> parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified,
00986         then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TimerContext parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored.
00987 
00988     TimerContext - Supplies an optional pointer to an arbitrary data structure
00989         that will be passed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d0/tex_8c.html#a29">TimerApcRoutine</a>
00990         parameter. This parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d0/tex_8c.html#a29">TimerApcRoutine</a> parameter
00991         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified.
00992 
00993     WakeTimer - Supplies a <span class="keywordtype">boolean</span> value that specifies whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer
00994         wakes computer operation <span class="keywordflow">if</span> sleeping
00995 
00996     Period - Supplies an optional repetitive period <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer.
00997 
00998     PreviousState - Supplies an optional pointer to a variable that will
00999         receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer object.
01000 
01001 Return Value:
01002 
01003     TBS
01004 
01005 --*/
01006 
01007 {
01008 
01009     BOOLEAN AssociatedApc;
01010     BOOLEAN Dereference;
01011     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> ExThread;
01012     <a class="code" href="../../d1/d7/struct__ETIMER.html">PETIMER</a> ExTimer;
01013     LARGE_INTEGER ExpirationTime;
01014     KIRQL OldIrql1;
01015     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
01016     BOOLEAN State;
01017     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01018 
01019     <span class="comment">//</span>
01020     <span class="comment">// Establish an exception handler, probe the due time and previous state</span>
01021     <span class="comment">// address if specified, reference the timer object, and set the timer</span>
01022     <span class="comment">// object. If the probe fails, then return the exception code as the</span>
01023     <span class="comment">// service status. Otherwise return the status value returned by the</span>
01024     <span class="comment">// reference object by handle routine.</span>
01025     <span class="comment">//</span>
01026 
01027     <span class="keywordflow">try</span> {
01028 
01029         <span class="comment">//</span>
01030         <span class="comment">// Get previous processor mode and probe previous state address</span>
01031         <span class="comment">// if necessary.</span>
01032         <span class="comment">//</span>
01033 
01034         PreviousMode = KeGetPreviousMode();
01035         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
01036             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
01037                 <a class="code" href="../../d5/d8/ex_8h.html#a28">ProbeForWriteBoolean</a>(PreviousState);
01038             }
01039 
01040             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(DueTime, <span class="keyword">sizeof</span>(LARGE_INTEGER), <span class="keyword">sizeof</span>(ULONG));
01041         }
01042 
01043         <span class="comment">//</span>
01044         <span class="comment">// Check argument validity.</span>
01045         <span class="comment">//</span>
01046 
01047         <span class="keywordflow">if</span> (Period &lt; 0) {
01048             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_6;
01049         }
01050 
01051         <span class="comment">//</span>
01052         <span class="comment">// Capture the expiration time.</span>
01053         <span class="comment">//</span>
01054 
01055         ExpirationTime = *DueTime;
01056 
01057         <span class="comment">//</span>
01058         <span class="comment">// Reference timer object by handle.</span>
01059         <span class="comment">//</span>
01060 
01061         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(TimerHandle,
01062                                            TIMER_MODIFY_STATE,
01063                                            ExTimerObjectType,
01064                                            PreviousMode,
01065                                            (PVOID *)&amp;ExTimer,
01066                                            NULL);
01067 
01068         <span class="comment">//</span>
01069         <span class="comment">// If this WakeTimer flag is set, return the appropiate informational</span>
01070         <span class="comment">// success status code.</span>
01071         <span class="comment">//</span>
01072 
01073         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) &amp;&amp; WakeTimer &amp;&amp; !<a class="code" href="../../d1/d2/po_8h.html#a13">PoWakeTimerSupported</a>()) {
01074             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_TIMER_RESUME_IGNORED;
01075         }
01076 
01077         <span class="comment">//</span>
01078         <span class="comment">// If the reference was successful, then cancel the timer object, set</span>
01079         <span class="comment">// the timer object, dereference time object, and write the previous</span>
01080         <span class="comment">// state value if specified. If the write of the previous state value</span>
01081         <span class="comment">// fails, then do not report an error. When the caller attempts to</span>
01082         <span class="comment">// access the previous state value, an access violation will occur.</span>
01083         <span class="comment">//</span>
01084 
01085         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01086             ExAcquireSpinLock(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o4">Lock</a>, &amp;OldIrql1);
01087 
01088             <span class="keywordflow">if</span> (ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o6">ApcAssociated</a>) {
01089                 ExThread = CONTAINING_RECORD(ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o1">TimerApc</a>.<a class="code" href="../../d1/d5/struct__KAPC.html#o3">Thread</a>, <a class="code" href="../../d5/d6/struct__ETHREAD.html">ETHREAD</a>, Tcb);
01090                 ExAcquireSpinLockAtDpcLevel(&amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o10">ActiveTimerListLock</a>);
01091                 RemoveEntryList(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o3">ActiveTimerListEntry</a>);
01092                 ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o6">ApcAssociated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01093                 ExReleaseSpinLockFromDpcLevel(&amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o10">ActiveTimerListLock</a>);
01094                 <a class="code" href="../../d3/d2/timerobj_8c.html#a4">KeCancelTimer</a>(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o0">KeTimer</a>);
01095                 <a class="code" href="../../d4/d1/dpcobj_8c.html#a3">KeRemoveQueueDpc</a>(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o2">TimerDpc</a>);
01096                 <a class="code" href="../../d5/d7/apcobj_8c.html#a4">KeRemoveQueueApc</a>(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o1">TimerApc</a>);
01097                 Dereference = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01098 
01099             } <span class="keywordflow">else</span> {
01100                 <a class="code" href="../../d3/d2/timerobj_8c.html#a4">KeCancelTimer</a>(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o0">KeTimer</a>);
01101                 Dereference = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01102             }
01103 
01104             <span class="comment">//</span>
01105             <span class="comment">// Read the current state of the timer.</span>
01106             <span class="comment">//</span>
01107 
01108             State = <a class="code" href="../../d3/d2/timerobj_8c.html#a5">KeReadStateTimer</a>(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o0">KeTimer</a>);
01109 
01110             <span class="comment">//</span>
01111             <span class="comment">// If this is a wake timer ensure it's on the wake timer list</span>
01112             <span class="comment">//</span>
01113 
01114             ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o7">WakeTimer</a> = WakeTimer;
01115             ExAcquireSpinLockAtDpcLevel(&amp;ExpWakeTimerListLock);
01116             <span class="keywordflow">if</span> (WakeTimer) {
01117                 <span class="keywordflow">if</span> (!ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o8">WakeTimerListEntry</a>.Flink) {
01118                     InsertTailList(&amp;ExpWakeTimerList, &amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o8">WakeTimerListEntry</a>);
01119                 }
01120             } <span class="keywordflow">else</span> {
01121                 <span class="keywordflow">if</span> (ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o8">WakeTimerListEntry</a>.Flink) {
01122                     RemoveEntryList(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o8">WakeTimerListEntry</a>);
01123                     ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o8">WakeTimerListEntry</a>.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01124                 }
01125             }
01126             ExReleaseSpinLockFromDpcLevel(&amp;ExpWakeTimerListLock);
01127 
01128             <span class="comment">//</span>
01129             <span class="comment">// If an APC routine is specified, then initialize the APC, acquire the</span>
01130             <span class="comment">// thread's active time list lock, insert the timer in the thread's</span>
01131             <span class="comment">// active timer list, set the timer with an associated DPC, and set the</span>
01132             <span class="comment">// associated APC flag TRUE. Otherwise set the timer without an associated</span>
01133             <span class="comment">// DPC, and set the associated APC flag FALSE.</span>
01134             <span class="comment">//</span>
01135 
01136             ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o5">Period</a> = Period;
01137             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(TimerApcRoutine)) {
01138                 ExThread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01139                 <a class="code" href="../../d5/d7/apcobj_8c.html#a1">KeInitializeApc</a>(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o1">TimerApc</a>,
01140                                 &amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>,
01141                                 CurrentApcEnvironment,
01142                                 ExpTimerApcRoutine,
01143                                 (PKRUNDOWN_ROUTINE)NULL,
01144                                 (PKNORMAL_ROUTINE)TimerApcRoutine,
01145                                 PreviousMode,
01146                                 TimerContext);
01147 
01148                 ExAcquireSpinLockAtDpcLevel(&amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o10">ActiveTimerListLock</a>);
01149                 InsertTailList(&amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o11">ActiveTimerListHead</a>,
01150                                &amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o3">ActiveTimerListEntry</a>);
01151 
01152                 ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o6">ApcAssociated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01153                 ExReleaseSpinLockFromDpcLevel(&amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o10">ActiveTimerListLock</a>);
01154                 <a class="code" href="../../d3/d2/timerobj_8c.html#a7">KeSetTimerEx</a>(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o0">KeTimer</a>,
01155                              ExpirationTime,
01156                              Period,
01157                              &amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o2">TimerDpc</a>);
01158 
01159                 AssociatedApc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01160 
01161             } <span class="keywordflow">else</span> {
01162                 <a class="code" href="../../d3/d2/timerobj_8c.html#a7">KeSetTimerEx</a>(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o0">KeTimer</a>,
01163                              ExpirationTime,
01164                              Period,
01165                              NULL);
01166 
01167                 AssociatedApc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01168             }
01169 
01170             ExReleaseSpinLock(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o4">Lock</a>, OldIrql1);
01171 
01172             <span class="comment">//</span>
01173             <span class="comment">// Dereference the object as appropriate.</span>
01174             <span class="comment">//</span>
01175 
01176             <span class="keywordflow">if</span> (Dereference) {
01177                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)ExTimer);
01178             }
01179 
01180             <span class="keywordflow">if</span> (AssociatedApc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01181                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)ExTimer);
01182             }
01183 
01184             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
01185                 <span class="keywordflow">try</span> {
01186                     *PreviousState = State;
01187 
01188                 } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
01189                 }
01190             }
01191         }
01192 
01193     <span class="comment">//</span>
01194     <span class="comment">// If an exception occurs during the probe of the current state address,</span>
01195     <span class="comment">// then always handle the exception and return the exception code as the</span>
01196     <span class="comment">// status value.</span>
01197     <span class="comment">//</span>
01198 
01199     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
01200         <span class="keywordflow">return</span> GetExceptionCode();
01201     }
01202 
01203     <span class="comment">//</span>
01204     <span class="comment">// Return service status.</span>
01205     <span class="comment">//</span>
01206 
01207     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01208 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a5" doxytag="timer.c::ExpTimerMapping" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> GENERIC_MAPPING <a class="el" href="../../d2/d2/timer_8c.html#a5">ExpTimerMapping</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><pre class="fragment"><div> {
    STANDARD_RIGHTS_READ |
        TIMER_QUERY_STATE,
    STANDARD_RIGHTS_WRITE |
        TIMER_MODIFY_STATE,
    STANDARD_RIGHTS_EXECUTE |
        SYNCHRONIZE,
    TIMER_ALL_ACCESS
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d1/timer_8c-source.html#l00062">62</a> of file <a class="el" href="../../d3/d1/timer_8c-source.html">timer.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/timer_8c-source.html#l00281">ExpTimerInitialization()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="timer.c::ExpWakeTimerList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d2/d2/timer_8c.html#a3">ExpWakeTimerList</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/timer_8c-source.html#l00049">49</a> of file <a class="el" href="../../d3/d1/timer_8c-source.html">timer.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/timer_8c-source.html#l01212">ExGetNextWakeTime()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00281">ExpTimerInitialization()</a>, and <a class="el" href="../../d3/d1/timer_8c-source.html#l00960">NtSetTimer()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="timer.c::ExpWakeTimerListLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> KSPIN_LOCK <a class="el" href="../../d2/d2/timer_8c.html#a2">ExpWakeTimerListLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/timer_8c-source.html#l00048">48</a> of file <a class="el" href="../../d3/d1/timer_8c-source.html">timer.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/timer_8c-source.html#l01212">ExGetNextWakeTime()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00232">ExpDeleteTimer()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00281">ExpTimerInitialization()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00679">NtCancelTimer()</a>, and <a class="el" href="../../d3/d1/timer_8c-source.html#l00960">NtSetTimer()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="timer.c::ExTimerObjectType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="el" href="../../d2/d2/timer_8c.html#a4">ExTimerObjectType</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/timer_8c-source.html#l00055">55</a> of file <a class="el" href="../../d3/d1/timer_8c-source.html">timer.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/timer_8c-source.html#l00281">ExpTimerInitialization()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00679">NtCancelTimer()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00444">NtCreateTimer()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00581">NtOpenTimer()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00822">NtQueryTimer()</a>, and <a class="el" href="../../d3/d1/timer_8c-source.html#l00960">NtSetTimer()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:46 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
