<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: query.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>query.c</h1><a href="../../d1/d3/dll_2query_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1992  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    query.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the RtlQueryProcessInformation function</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Steve Wood (stevewo) 01-Apr-1994</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include &lt;<a class="code" href="../../d9/d8/ntos_8h.html">ntos.h</a>&gt;</span>
00022 <span class="preprocessor">#include "<a class="code" href="../../d9/d2/ldrp_8h.html">ldrp.h</a>"</span>
00023 <span class="preprocessor">#include &lt;<a class="code" href="../../d8/d6/stktrace_8h.html">stktrace.h</a>&gt;</span>
00024 <span class="preprocessor">#include &lt;<a class="code" href="../../d3/d9/heap_8h.html">heap.h</a>&gt;</span>
00025 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00026 
<a name="l00027"></a><a class="code" href="../../d1/d3/dll_2query_8c.html#a0">00027</a> <span class="preprocessor">#define AdjustPointer( t, p, d ) (p); if ((p) != NULL) (p) = (t)((ULONG_PTR)(p) + (d))</span>
00028 <span class="preprocessor"></span>
00029 NTSYSAPI
00030 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00031 NTAPI
<a name="l00032"></a><a class="code" href="../../d1/d3/dll_2query_8c.html#a1">00032</a> <a class="code" href="../../d1/d3/dll_2query_8c.html#a1">RtlpQueryProcessDebugInformationRemote</a>(
00033     IN OUT PRTL_DEBUG_INFORMATION Buffer
00034     )
00035 {
00036     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00037     ULONG i;
00038     ULONG_PTR Delta;
00039     PRTL_PROCESS_HEAPS Heaps;
00040     PRTL_HEAP_INFORMATION HeapInfo;
00041 
00042     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;EventPairTarget != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00043         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/eventpr_8c.html#a7">NtWaitLowEventPair</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;EventPairTarget );
00044         }
00045     <span class="keywordflow">else</span> {
00046         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00047         }
00048 
00049     <span class="keywordflow">while</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00050         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d3/dll_2query_8c.html#a7">RtlQueryProcessDebugInformation</a>( NtCurrentTeb()-&gt;ClientId.UniqueProcess,
00051                                                   <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;Flags,
00052                                                   <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>
00053                                                 );
00054         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00055             <span class="keywordflow">if</span> (Delta = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;ViewBaseDelta) {
00056                 <span class="comment">//</span>
00057                 <span class="comment">// Need to relocate buffer pointers back to client addresses</span>
00058                 <span class="comment">//</span>
00059                 <a class="code" href="../../d1/d3/dll_2query_8c.html#a0">AdjustPointer</a>( PRTL_PROCESS_MODULES, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;Modules, Delta );
00060                 <a class="code" href="../../d1/d3/dll_2query_8c.html#a0">AdjustPointer</a>( PRTL_PROCESS_BACKTRACES, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;BackTraces, Delta );
00061                 Heaps = <a class="code" href="../../d1/d3/dll_2query_8c.html#a0">AdjustPointer</a>( PRTL_PROCESS_HEAPS, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;Heaps, Delta );
00062                 <span class="keywordflow">if</span> (Heaps != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00063                     <span class="keywordflow">for</span> (i=0; i&lt;Heaps-&gt;NumberOfHeaps; i++) {
00064                         HeapInfo = &amp;Heaps-&gt;Heaps[ i ];
00065                         <a class="code" href="../../d1/d3/dll_2query_8c.html#a0">AdjustPointer</a>( PRTL_HEAP_TAG, HeapInfo-&gt;Tags, Delta );
00066                         <a class="code" href="../../d1/d3/dll_2query_8c.html#a0">AdjustPointer</a>( PRTL_HEAP_ENTRY, HeapInfo-&gt;Entries, Delta );
00067                         }
00068                     }
00069 
00070                 <a class="code" href="../../d1/d3/dll_2query_8c.html#a0">AdjustPointer</a>( PRTL_PROCESS_LOCKS, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;Locks, Delta );
00071                 }
00072             }
00073 
00074         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;EventPairTarget == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00075             <span class="comment">//</span>
00076             <span class="comment">// If no event pair handle, then exit loop and terminate</span>
00077             <span class="comment">//</span>
00078             <span class="keywordflow">break</span>;
00079             }
00080 
00081         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/eventpr_8c.html#a10">NtSetHighWaitLowEventPair</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;EventPairTarget );
00082         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;EventPairTarget == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00083             <span class="keywordflow">break</span>;
00084             }
00085         }
00086 
00087     <span class="comment">//</span>
00088     <span class="comment">// All done with buffer, remove from our address space</span>
00089     <span class="comment">// then terminate ourselves so client wakes up.</span>
00090     <span class="comment">//</span>
00091 
00092     <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>( NtCurrentProcess(), <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> );
00093     <a class="code" href="../../d8/d0/psdelete_8c.html#a6">NtTerminateThread</a>( NtCurrentThread(), <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00094     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00095 }
00096 
00097 
00098 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00099"></a><a class="code" href="../../d1/d3/dll_2query_8c.html#a2">00099</a> <a class="code" href="../../d1/d3/dll_2query_8c.html#a2">RtlpChangeQueryDebugBufferTarget</a>(
00100     IN PRTL_DEBUG_INFORMATION Buffer,
00101     IN HANDLE TargetProcessId,
00102     OUT PHANDLE ReturnedTargetProcessHandle
00103     )
00104 {
00105     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00106     CLIENT_ID OldTargetClientId, NewTargetClientId;
00107     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00108     HANDLE OldTargetProcess, NewTargetProcess, NewHandle;
00109     PHANDLE pOldHandle;
00110     ULONG DuplicateHandleFlags;
00111 
00112     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;EventPairClient != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00113         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;TargetProcessId == TargetProcessId
00114        ) {
00115         <span class="keywordflow">return</span> STATUS_SUCCESS;
00116         }
00117 
00118     InitializeObjectAttributes( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00119                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00120                                 0,
00121                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00122                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00123                               );
00124 
00125     DuplicateHandleFlags = DUPLICATE_CLOSE_SOURCE |
00126                            DUPLICATE_SAME_ACCESS |
00127                            DUPLICATE_SAME_ATTRIBUTES;
00128 
00129     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;EventPairClient != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00130         pOldHandle = &amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;EventPairTarget;
00131         }
00132     <span class="keywordflow">else</span> {
00133         pOldHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00134         }
00135 
00136     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;TargetProcessId != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00137         OldTargetClientId.UniqueProcess = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;TargetProcessId;
00138         OldTargetClientId.UniqueThread = 0;
00139         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/psopen_8c.html#a0">NtOpenProcess</a>( &amp;OldTargetProcess,
00140                                 PROCESS_ALL_ACCESS,
00141                                 &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00142                                 &amp;OldTargetClientId
00143                               );
00144         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00145             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00146             }
00147         }
00148     <span class="keywordflow">else</span> {
00149         OldTargetProcess = NtCurrentProcess();
00150         DuplicateHandleFlags &amp;= ~DUPLICATE_CLOSE_SOURCE;
00151         <span class="keywordflow">if</span> (pOldHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00152             pOldHandle = &amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;EventPairClient;
00153             }
00154         }
00155 
00156     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( TargetProcessId )) {
00157         NewTargetClientId.UniqueProcess = TargetProcessId;
00158         NewTargetClientId.UniqueThread = 0;
00159         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/psopen_8c.html#a0">NtOpenProcess</a>( &amp;NewTargetProcess,
00160                                 PROCESS_ALL_ACCESS,
00161                                 &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00162                                 &amp;NewTargetClientId
00163                               );
00164         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00165             <span class="keywordflow">if</span> (OldTargetProcess != NtCurrentProcess()) {
00166                 <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( OldTargetProcess );
00167                 }
00168             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00169             }
00170         }
00171     <span class="keywordflow">else</span> {
00172         NewTargetProcess = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00173         }
00174 
00175     NewHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00176     <span class="keywordflow">if</span> (pOldHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00177         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>( OldTargetProcess,
00178                                     *pOldHandle,
00179                                     NewTargetProcess,
00180                                     &amp;NewHandle,
00181                                     0,
00182                                     0,
00183                                     DuplicateHandleFlags
00184                                   );
00185         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00186             <span class="keywordflow">if</span> (OldTargetProcess != NtCurrentProcess()) {
00187                 <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( OldTargetProcess );
00188                 }
00189             <span class="keywordflow">if</span> (NewTargetProcess != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00190                 <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( NewTargetProcess );
00191                 }
00192             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00193             }
00194         }
00195 
00196     <span class="keywordflow">if</span> (OldTargetProcess != NtCurrentProcess()) {
00197         <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>( OldTargetProcess, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;ViewBaseTarget );
00198         }
00199     <span class="keywordflow">else</span> {
00200         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;ViewBaseTarget = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;ViewBaseClient;
00201         }
00202 
00203     <span class="keywordflow">if</span> (NewTargetProcess != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00204         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a20">NtMapViewOfSection</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;SectionHandleClient,
00205                                      NewTargetProcess,
00206                                      &amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;ViewBaseTarget,
00207                                      0,
00208                                      0,
00209                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00210                                      &amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;ViewSize,
00211                                      ViewUnmap,
00212                                      0,
00213                                      PAGE_READWRITE
00214                                    );
00215         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_CONFLICTING_ADDRESSES) {
00216             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;ViewBaseTarget = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00217             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a20">NtMapViewOfSection</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;SectionHandleClient,
00218                                          NewTargetProcess,
00219                                          &amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;ViewBaseTarget,
00220                                          0,
00221                                          0,
00222                                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00223                                          &amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;ViewSize,
00224                                          ViewUnmap,
00225                                          0,
00226                                          PAGE_READWRITE
00227                                        );
00228             }
00229 
00230         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00231             <span class="keywordflow">if</span> (NewHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00232                 <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>( NewTargetProcess,
00233                                    &amp;NewHandle,
00234                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00235                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00236                                    0,
00237                                    0,
00238                                    DUPLICATE_CLOSE_SOURCE
00239                                  );
00240                 }
00241 
00242             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00243             }
00244 
00245         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnedTargetProcessHandle )) {
00246             *ReturnedTargetProcessHandle = NewTargetProcess;
00247             }
00248         <span class="keywordflow">else</span> {
00249             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( NewTargetProcess );
00250             }
00251         }
00252 
00253     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;EventPairTarget = NewHandle;
00254     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;ViewBaseDelta = (ULONG_PTR)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;ViewBaseClient - (ULONG_PTR)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;ViewBaseTarget;
00255     <span class="keywordflow">return</span> STATUS_SUCCESS;
00256 }
00257 
00258 
00259 PVOID
<a name="l00260"></a><a class="code" href="../../d1/d3/dll_2query_8c.html#a3">00260</a> <a class="code" href="../../d1/d3/dll_2query_8c.html#a3">RtlpCommitQueryDebugInfo</a>(
00261     IN PRTL_DEBUG_INFORMATION Buffer,
00262     IN ULONG Size
00263     )
00264 {
00265     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00266     PVOID Result;
00267     PVOID CommitBase;
00268     SIZE_T CommitSize;
00269     SIZE_T NeededSize;
00270 
00271     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> + 3) &amp; ~3;
00272     NeededSize = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;OffsetFree + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00273     <span class="keywordflow">if</span> (NeededSize &gt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;CommitSize) {
00274         <span class="keywordflow">if</span> (NeededSize &gt;= <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;ViewSize) {
00275             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00276             }
00277 
00278         CommitBase = (PCHAR)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> + <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;CommitSize;
00279         CommitSize =  NeededSize - <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;CommitSize;
00280         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d6/allocvm_8c.html#a7">NtAllocateVirtualMemory</a>( NtCurrentProcess(),
00281                                           &amp;CommitBase,
00282                                           0,
00283                                           &amp;CommitSize,
00284                                           MEM_COMMIT,
00285                                           PAGE_READWRITE
00286                                         );
00287         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00288             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00289             }
00290 
00291 
00292         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;CommitSize += CommitSize;
00293         }
00294 
00295     Result = (PCHAR)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> + <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;OffsetFree;
00296     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;OffsetFree = NeededSize;
00297     <span class="keywordflow">return</span> Result;
00298 }
00299 
00300 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00301"></a><a class="code" href="../../d1/d3/dll_2query_8c.html#a4">00301</a> <a class="code" href="../../d1/d3/dll_2query_8c.html#a4">RtlpDeCommitQueryDebugInfo</a>(
00302     IN PRTL_DEBUG_INFORMATION Buffer,
00303     IN PVOID p,
00304     IN ULONG Size
00305     )
00306 {
00307     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> + 3) &amp; ~3;
00308     <span class="keywordflow">if</span> (p == (PVOID)(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;OffsetFree - <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>)) {
00309         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;OffsetFree -= <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00310         }
00311 }
00312 
00313 NTSYSAPI
00314 PRTL_DEBUG_INFORMATION
00315 NTAPI
<a name="l00316"></a><a class="code" href="../../d1/d3/dll_2query_8c.html#a5">00316</a> <a class="code" href="../../d1/d3/dll_2query_8c.html#a5">RtlCreateQueryDebugBuffer</a>(
00317     IN ULONG MaximumCommit OPTIONAL,
00318     IN BOOLEAN UseEventPair
00319     )
00320 {
00321     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00322     HANDLE Section;
00323     PRTL_DEBUG_INFORMATION <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00324     LARGE_INTEGER MaximumSize;
00325     ULONG_PTR ViewSize, CommitSize;
00326 
00327     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( (PVOID)(ULONG_PTR)MaximumCommit )) { <span class="comment">// Sundown Note: ULONG zero-extended.</span>
00328         MaximumCommit = 4 * 1024 * 1024;
00329         }
00330     MaximumSize.QuadPart = MaximumCommit;
00331     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/creasect_8c.html#a19">NtCreateSection</a>( &amp;Section,
00332                               SECTION_ALL_ACCESS,
00333                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00334                               &amp;MaximumSize,
00335                               PAGE_READWRITE,
00336                               SEC_RESERVE,
00337                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00338                             );
00339     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00340         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00341         }
00342 
00343     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00344     ViewSize = MaximumCommit;
00345     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a20">NtMapViewOfSection</a>( Section,
00346                                  NtCurrentProcess(),
00347                                  &amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00348                                  0,
00349                                  0,
00350                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00351                                  &amp;ViewSize,
00352                                  ViewUnmap,
00353                                  0,
00354                                  PAGE_READWRITE
00355                                );
00356     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00357         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( Section );
00358         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00359         }
00360 
00361     CommitSize = 1;
00362     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d6/allocvm_8c.html#a7">NtAllocateVirtualMemory</a>( NtCurrentProcess(),
00363                                       &amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00364                                       0,
00365                                       &amp;CommitSize,
00366                                       MEM_COMMIT,
00367                                       PAGE_READWRITE
00368                                     );
00369     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00370         <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>( NtCurrentProcess(), <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> );
00371         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( Section );
00372         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00373         }
00374 
00375     <span class="keywordflow">if</span> (UseEventPair) {
00376         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/eventpr_8c.html#a5">NtCreateEventPair</a>( &amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;EventPairClient,
00377                                     EVENT_PAIR_ALL_ACCESS,
00378                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00379                                   );
00380         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00381             <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>( NtCurrentProcess(), <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> );
00382             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( Section );
00383             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00384             }
00385         }
00386 
00387     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;SectionHandleClient = Section;
00388     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;ViewBaseClient = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00389     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;OffsetFree = 0;
00390     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;CommitSize = CommitSize;
00391     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;ViewSize = ViewSize;
00392     <span class="keywordflow">return</span> <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00393 }
00394 
00395 
00396 NTSYSAPI
00397 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00398 NTAPI
<a name="l00399"></a><a class="code" href="../../d1/d3/dll_2query_8c.html#a6">00399</a> <a class="code" href="../../d1/d3/dll_2query_8c.html#a6">RtlDestroyQueryDebugBuffer</a>(
00400     IN PRTL_DEBUG_INFORMATION Buffer
00401     )
00402 {
00403     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00404     HANDLE ProcessHandle, <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>;
00405     THREAD_BASIC_INFORMATION BasicInformation;
00406     PTEB Teb;
00407     PVOID StackDeallocationBase;
00408     ULONG <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00409     SIZE_T BigSize;
00410 
00411     <a class="code" href="../../d1/d3/dll_2query_8c.html#a2">RtlpChangeQueryDebugBufferTarget</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00412 
00413     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00414     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;TargetThreadHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00415         StackDeallocationBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00416         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/psquery_8c.html#a20">NtQueryInformationThread</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;TargetThreadHandle,
00417                                            ThreadBasicInformation,
00418                                            &amp;BasicInformation,
00419                                            <span class="keyword">sizeof</span>( BasicInformation ),
00420                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00421                                          );
00422         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00423             <span class="keywordflow">if</span> (Teb = BasicInformation.TebBaseAddress) {
00424                 <a class="code" href="../../d9/d5/readwrt_8c.html#a9">NtReadVirtualMemory</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;TargetProcessHandle,
00425                                      &amp;Teb-&gt;DeallocationStack,
00426                                      &amp;StackDeallocationBase,
00427                                      <span class="keyword">sizeof</span>( StackDeallocationBase ),
00428                                      &amp;<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>
00429                                    );
00430                 }
00431             }
00432 
00433         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;EventPairTarget = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00434         <a class="code" href="../../d3/d8/eventpr_8c.html#a11">NtSetLowEventPair</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;EventPairClient );
00435         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;EventPairClient );
00436         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;TargetThreadHandle,
00437                                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00438                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00439                                       );
00440         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00441             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/psquery_8c.html#a20">NtQueryInformationThread</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;TargetThreadHandle,
00442                                                ThreadBasicInformation,
00443                                                &amp;BasicInformation,
00444                                                <span class="keyword">sizeof</span>( BasicInformation ),
00445                                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00446                                              );
00447             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00448                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = BasicInformation.ExitStatus;
00449                 }
00450             }
00451 
00452         BigSize = 0;
00453         <a class="code" href="../../d3/d7/freevm_8c.html#a6">NtFreeVirtualMemory</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;TargetProcessHandle,
00454                              &amp;StackDeallocationBase,
00455                              &amp;BigSize,
00456                              MEM_RELEASE
00457                            );
00458         }
00459 
00460     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;SectionHandleClient );
00461     <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>( NtCurrentProcess(), <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> );
00462     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00463 }
00464 
00465 
00466 NTSYSAPI
00467 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00468 NTAPI
<a name="l00469"></a><a class="code" href="../../d1/d3/dll_2query_8c.html#a7">00469</a> <a class="code" href="../../d1/d3/dll_2query_8c.html#a7">RtlQueryProcessDebugInformation</a>(
00470     IN HANDLE UniqueProcessId,
00471     IN ULONG Flags,
00472     IN OUT PRTL_DEBUG_INFORMATION Buffer
00473     )
00474 {
00475     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00476     HANDLE ProcessHandle, <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>;
00477     THREAD_BASIC_INFORMATION BasicInformation;
00478     PTEB Teb;
00479     PVOID StackDeallocationBase;
00480     ULONG <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00481     SIZE_T BigSize;
00482 
00483     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;Flags = Flags;
00484     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;OffsetFree != 0) {
00485         RtlZeroMemory( (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>+1), <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;OffsetFree - (SIZE_T)<span class="keyword">sizeof</span>(*<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>) );
00486         }
00487     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;OffsetFree = <span class="keyword">sizeof</span>( *Buffer );
00488 
00489     <span class="keywordflow">if</span> (NtCurrentTeb()-&gt;ClientId.UniqueProcess != UniqueProcessId) {
00490         <span class="comment">//</span>
00491         <span class="comment">// Not querying current process, so do it remotely</span>
00492         <span class="comment">//</span>
00493         ProcessHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00494         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d3/dll_2query_8c.html#a2">RtlpChangeQueryDebugBufferTarget</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, UniqueProcessId, &amp;ProcessHandle );
00495         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00496             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00497             }
00498 
00499         <span class="keywordflow">if</span> (ProcessHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00500 waitForDump:
00501             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/eventpr_8c.html#a9">NtSetLowWaitHighEventPair</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;EventPairClient );
00502             }
00503         <span class="keywordflow">else</span> {
00504             <span class="comment">//</span>
00505             <span class="comment">// don't let the debugger see this remote thread !</span>
00506             <span class="comment">// This is a very ugly but effective way to prevent</span>
00507             <span class="comment">// the debugger deadlocking with the target process when calling</span>
00508             <span class="comment">// this function.</span>
00509             <span class="comment">//</span>
00510 
00511             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/rtlexec_8c.html#a13">RtlCreateUserThread</a>( ProcessHandle,
00512                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00513                                           <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00514                                           0,
00515                                           0,
00516                                           0,
00517                                           <a class="code" href="../../d1/d3/dll_2query_8c.html#a1">RtlpQueryProcessDebugInformationRemote</a>,
00518                                           <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;ViewBaseTarget,
00519                                           &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
00520                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00521                                         );
00522             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00523 
00524                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/psquery_8c.html#a21">NtSetInformationThread</a>( <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
00525                                                  ThreadHideFromDebugger,
00526                                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00527                                                  0
00528                                                );
00529 
00530                 <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00531                     <a class="code" href="../../d8/d0/psdelete_8c.html#a6">NtTerminateThread</a>(<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00532                     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>);
00533                     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(ProcessHandle);
00534                     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00535                     }
00536 
00537                 <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>(<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00538 
00539                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;EventPairClient != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00540                     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;TargetThreadHandle = <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>;
00541                     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;TargetProcessHandle = ProcessHandle;
00542                     <span class="keywordflow">goto</span> waitForDump;
00543                     }
00544 
00545                 StackDeallocationBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00546                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/psquery_8c.html#a20">NtQueryInformationThread</a>( <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
00547                                                    ThreadBasicInformation,
00548                                                    &amp;BasicInformation,
00549                                                    <span class="keyword">sizeof</span>( BasicInformation ),
00550                                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00551                                                  );
00552                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00553                     <span class="keywordflow">if</span> (Teb = BasicInformation.TebBaseAddress) {
00554                         <a class="code" href="../../d9/d5/readwrt_8c.html#a9">NtReadVirtualMemory</a>( ProcessHandle,
00555                                              &amp;Teb-&gt;DeallocationStack,
00556                                              &amp;StackDeallocationBase,
00557                                              <span class="keyword">sizeof</span>( StackDeallocationBase ),
00558                                              &amp;<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>
00559                                            );
00560                         }
00561                     }
00562 
00563                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>( <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
00564                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00565                                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00566                                               );
00567 
00568                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00569                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/psquery_8c.html#a20">NtQueryInformationThread</a>( <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
00570                                                        ThreadBasicInformation,
00571                                                        &amp;BasicInformation,
00572                                                        <span class="keyword">sizeof</span>( BasicInformation ),
00573                                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00574                                                      );
00575                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00576                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = BasicInformation.ExitStatus;
00577                         }
00578                     }
00579 
00580                 BigSize = 0;
00581                 <a class="code" href="../../d3/d7/freevm_8c.html#a6">NtFreeVirtualMemory</a>( ProcessHandle, &amp;StackDeallocationBase, &amp;BigSize, MEM_RELEASE );
00582                 <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a> );
00583 
00584                 }
00585 
00586 
00587             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( ProcessHandle );
00588             }
00589         }
00590     <span class="keywordflow">else</span> {
00591         <span class="keywordflow">if</span> (Flags &amp; RTL_QUERY_PROCESS_MODULES) {
00592             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d3/dll_2query_8c.html#a8">RtlQueryProcessModuleInformation</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> );
00593             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00594                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00595                 }
00596             }
00597 
00598         <span class="keywordflow">if</span> (Flags &amp; RTL_QUERY_PROCESS_BACKTRACES) {
00599             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d3/dll_2query_8c.html#a9">RtlQueryProcessBackTraceInformation</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> );
00600             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00601                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00602                 }
00603             }
00604 
00605         <span class="keywordflow">if</span> (Flags &amp; RTL_QUERY_PROCESS_LOCKS) {
00606             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d3/dll_2query_8c.html#a12">RtlQueryProcessLockInformation</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> );
00607             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00608                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00609                 }
00610             }
00611 
00612         <span class="keywordflow">if</span> (Flags &amp; (RTL_QUERY_PROCESS_HEAP_SUMMARY |
00613                      RTL_QUERY_PROCESS_HEAP_TAGS |
00614                      RTL_QUERY_PROCESS_HEAP_ENTRIES
00615                     )
00616            ) {
00617             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d3/dll_2query_8c.html#a11">RtlQueryProcessHeapInformation</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> );
00618             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00619                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00620                 }
00621             }
00622         }
00623 
00624     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00625 }
00626 
00627 
00628 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00629 NTAPI
<a name="l00630"></a><a class="code" href="../../d1/d3/dll_2query_8c.html#a8">00630</a> <a class="code" href="../../d1/d3/dll_2query_8c.html#a8">RtlQueryProcessModuleInformation</a>(
00631     IN OUT PRTL_DEBUG_INFORMATION Buffer
00632     )
00633 {
00634     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00635     ULONG RequiredLength;
00636     PRTL_PROCESS_MODULES Modules;
00637 
00638     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d2/ldrapi_8c.html#a10">LdrQueryProcessModuleInformation</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00639                                                0,
00640                                                &amp;RequiredLength
00641                                              );
00642     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INFO_LENGTH_MISMATCH) {
00643         Modules = <a class="code" href="../../d1/d3/dll_2query_8c.html#a3">RtlpCommitQueryDebugInfo</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, RequiredLength );
00644         <span class="keywordflow">if</span> (Modules != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00645             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d2/ldrapi_8c.html#a10">LdrQueryProcessModuleInformation</a>( Modules,
00646                                                        RequiredLength,
00647                                                        &amp;RequiredLength
00648                                                      );
00649             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00650                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;Modules = Modules;
00651                 <span class="keywordflow">return</span> STATUS_SUCCESS;
00652                 }
00653             }
00654         }
00655 
00656     <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00657 }
00658 
00659 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00660"></a><a class="code" href="../../d1/d3/dll_2query_8c.html#a9">00660</a> <a class="code" href="../../d1/d3/dll_2query_8c.html#a9">RtlQueryProcessBackTraceInformation</a>(
00661     IN OUT PRTL_DEBUG_INFORMATION Buffer
00662     )
00663 {
00664 <span class="preprocessor">#if i386</span>
00665 <span class="preprocessor"></span>    <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00666     OUT PRTL_PROCESS_BACKTRACES BackTraces;
00667     PRTL_PROCESS_BACKTRACE_INFORMATION BackTraceInfo;
00668     <a class="code" href="../../d7/d5/struct__STACK__TRACE__DATABASE.html">PSTACK_TRACE_DATABASE</a> DataBase;
00669     <a class="code" href="../../d9/d5/struct__RTL__STACK__TRACE__ENTRY.html">PRTL_STACK_TRACE_ENTRY</a> p, *pp;
00670     ULONG <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
00671 
00672     DataBase = <a class="code" href="../../d8/d6/stktrace_8h.html#a4">RtlpAcquireStackTraceDataBase</a>();
00673     <span class="keywordflow">if</span> (DataBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00674         <span class="keywordflow">return</span> STATUS_SUCCESS;
00675         }
00676 
00677     BackTraces = <a class="code" href="../../d1/d3/dll_2query_8c.html#a3">RtlpCommitQueryDebugInfo</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, FIELD_OFFSET( RTL_PROCESS_BACKTRACES, BackTraces ) );
00678     <span class="keywordflow">if</span> (BackTraces == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00679         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00680         }
00681 
00682     DataBase-&gt;<a class="code" href="../../d7/d5/struct__STACK__TRACE__DATABASE.html#o7">DumpInProgress</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00683     <a class="code" href="../../d8/d6/stktrace_8h.html#a5">RtlpReleaseStackTraceDataBase</a>();
00684     <span class="keywordflow">try</span> {
00685         BackTraces-&gt;CommittedMemory = (ULONG)DataBase-&gt;<a class="code" href="../../d7/d5/struct__STACK__TRACE__DATABASE.html#o10">CurrentUpperCommitLimit</a> -
00686                                       (ULONG)DataBase-&gt;<a class="code" href="../../d7/d5/struct__STACK__TRACE__DATABASE.html#o8">CommitBase</a>;
00687         BackTraces-&gt;ReservedMemory =  (ULONG)DataBase-&gt;<a class="code" href="../../d7/d5/struct__STACK__TRACE__DATABASE.html#o15">EntryIndexArray</a> -
00688                                       (ULONG)DataBase-&gt;<a class="code" href="../../d7/d5/struct__STACK__TRACE__DATABASE.html#o8">CommitBase</a>;
00689         BackTraces-&gt;NumberOfBackTraceLookups = DataBase-&gt;<a class="code" href="../../d7/d5/struct__STACK__TRACE__DATABASE.html#o13">NumberOfEntriesLookedUp</a>;
00690         BackTraces-&gt;NumberOfBackTraces = DataBase-&gt;<a class="code" href="../../d7/d5/struct__STACK__TRACE__DATABASE.html#o14">NumberOfEntriesAdded</a>;
00691         BackTraceInfo = <a class="code" href="../../d1/d3/dll_2query_8c.html#a3">RtlpCommitQueryDebugInfo</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, (<span class="keyword">sizeof</span>( *BackTraceInfo ) * BackTraces-&gt;NumberOfBackTraces) );
00692         <span class="keywordflow">if</span> (BackTraceInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00693             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00694             }
00695         <span class="keywordflow">else</span> {
00696             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00697             <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = DataBase-&gt;<a class="code" href="../../d7/d5/struct__STACK__TRACE__DATABASE.html#o14">NumberOfEntriesAdded</a>;
00698             pp = DataBase-&gt;<a class="code" href="../../d7/d5/struct__STACK__TRACE__DATABASE.html#o15">EntryIndexArray</a>;
00699             <span class="keywordflow">while</span> (<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>--) {
00700                 p = *--pp;
00701                 BackTraceInfo-&gt;SymbolicBackTrace = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00702                 BackTraceInfo-&gt;TraceCount = p-&gt;<a class="code" href="../../d9/d5/struct__RTL__STACK__TRACE__ENTRY.html#o1">TraceCount</a>;
00703                 BackTraceInfo-&gt;Index = p-&gt;<a class="code" href="../../d9/d5/struct__RTL__STACK__TRACE__ENTRY.html#o2">Index</a>;
00704                 BackTraceInfo-&gt;Depth = p-&gt;<a class="code" href="../../d9/d5/struct__RTL__STACK__TRACE__ENTRY.html#o3">Depth</a>;
00705                 RtlMoveMemory( BackTraceInfo-&gt;BackTrace,
00706                                p-&gt;<a class="code" href="../../d9/d5/struct__RTL__STACK__TRACE__ENTRY.html#o4">BackTrace</a>,
00707                                p-&gt;<a class="code" href="../../d9/d5/struct__RTL__STACK__TRACE__ENTRY.html#o3">Depth</a> * <span class="keyword">sizeof</span>( PVOID )
00708                              );
00709                 BackTraceInfo++;
00710                 }
00711             }
00712         }
00713     finally {
00714         DataBase-&gt;<a class="code" href="../../d7/d5/struct__STACK__TRACE__DATABASE.html#o7">DumpInProgress</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00715         }
00716 
00717     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00718         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;BackTraces = BackTraces;
00719         }
00720 
00721     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00722 <span class="preprocessor">#else</span>
00723 <span class="preprocessor"></span>    <span class="keywordflow">return</span> STATUS_SUCCESS;
00724 <span class="preprocessor">#endif // i386</span>
00725 <span class="preprocessor"></span>}
00726 
00727 
00728 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00729"></a><a class="code" href="../../d1/d3/dll_2query_8c.html#a10">00729</a> <a class="code" href="../../d1/d3/dll_2query_8c.html#a10">RtlpQueryProcessEnumHeapsRoutine</a>(
00730     PVOID HeapHandle,
00731     PVOID Parameter
00732     )
00733 {
00734     PRTL_DEBUG_INFORMATION <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = (PRTL_DEBUG_INFORMATION)Parameter;
00735     PRTL_PROCESS_HEAPS Heaps = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;Heaps;
00736     <a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap = (<a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a>)<a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>;
00737     PRTL_HEAP_INFORMATION HeapInfo;
00738     <a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html">PHEAP_SEGMENT</a> Segment;
00739     UCHAR SegmentIndex;
00740 
00741     HeapInfo = <a class="code" href="../../d1/d3/dll_2query_8c.html#a3">RtlpCommitQueryDebugInfo</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <span class="keyword">sizeof</span>( *HeapInfo ) );
00742     <span class="keywordflow">if</span> (HeapInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00743         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00744         }
00745 
00746     HeapInfo-&gt;BaseAddress = Heap;
00747     HeapInfo-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o2">Flags</a> = Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o2">Flags</a>;
00748     HeapInfo-&gt;EntryOverhead = <span class="keyword">sizeof</span>( <a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">HEAP_ENTRY</a> );
00749     HeapInfo-&gt;CreatorBackTraceIndex = Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o27">AllocatorBackTraceIndex</a>;
00750     SegmentIndex = <a class="code" href="../../d3/d9/heap_8h.html#a7">HEAP_MAXIMUM_SEGMENTS</a>;
00751     <span class="keywordflow">while</span> (SegmentIndex--) {
00752         Segment = Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o22">Segments</a>[ SegmentIndex ];
00753         <span class="keywordflow">if</span> (Segment) {
00754             HeapInfo-&gt;BytesCommitted += (Segment-&gt;<a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html#o6">NumberOfPages</a> -
00755                                          Segment-&gt;<a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html#o9">NumberOfUnCommittedPages</a>
00756                                         ) * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00757 
00758             }
00759         }
00760     HeapInfo-&gt;BytesAllocated = HeapInfo-&gt;BytesCommitted -
00761                                (Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o9">TotalFreeSize</a> &lt;&lt; <a class="code" href="../../d3/d9/heap_8h.html#a4">HEAP_GRANULARITY_SHIFT</a>);
00762     Heaps-&gt;NumberOfHeaps += 1;
00763     <span class="keywordflow">return</span> STATUS_SUCCESS;
00764 }
00765 
00766 NTSYSAPI
00767 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00768 NTAPI
<a name="l00769"></a><a class="code" href="../../d1/d3/dll_2query_8c.html#a11">00769</a> <a class="code" href="../../d1/d3/dll_2query_8c.html#a11">RtlQueryProcessHeapInformation</a>(
00770     IN OUT PRTL_DEBUG_INFORMATION Buffer
00771     )
00772 {
00773     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00774     <a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap;
00775     BOOLEAN LockAcquired;
00776     PRTL_PROCESS_HEAPS Heaps;
00777     PRTL_HEAP_INFORMATION HeapInfo;
00778     ULONG NumberOfHeaps;
00779     PVOID *ProcessHeaps;
00780     UCHAR SegmentIndex;
00781     ULONG i, <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>, TagIndex;
00782     <a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html">PHEAP_SEGMENT</a> Segment;
00783     PRTL_HEAP_TAG Tags;
00784     <a class="code" href="../../d7/d6/struct__HEAP__PSEUDO__TAG__ENTRY.html">PHEAP_PSEUDO_TAG_ENTRY</a> PseudoTags;
00785     PRTL_HEAP_ENTRY Entries;
00786     <a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a> CurrentBlock;
00787     <a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html">PHEAP_ENTRY_EXTRA</a> ExtraStuff;
00788     PRTL_HEAP_ENTRY p;
00789     PLIST_ENTRY Head, Next;
00790     <a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html">PHEAP_VIRTUAL_ALLOC_ENTRY</a> VirtualAllocBlock;
00791     ULONG <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00792     <a class="code" href="../../d5/d7/struct__HEAP__UNCOMMMTTED__RANGE.html">PHEAP_UNCOMMMTTED_RANGE</a> UnCommittedRange;
00793 
00794     Heaps = <a class="code" href="../../d1/d3/dll_2query_8c.html#a3">RtlpCommitQueryDebugInfo</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, FIELD_OFFSET( RTL_PROCESS_HEAPS, Heaps ) );
00795     <span class="keywordflow">if</span> (Heaps == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00796         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00797         }
00798 
00799     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;Heaps = Heaps;
00800     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d9/heapdll_8c.html#a35">RtlEnumProcessHeaps</a>( <a class="code" href="../../d1/d3/dll_2query_8c.html#a10">RtlpQueryProcessEnumHeapsRoutine</a>, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> );
00801     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00802         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;Flags &amp; RTL_QUERY_PROCESS_HEAP_TAGS) {
00803             Heap = <a class="code" href="../../d3/d9/heap_8h.html#a64">RtlpGlobalTagHeap</a>;
00804             <span class="keywordflow">if</span> (Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o16">TagEntries</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00805                 HeapInfo = <a class="code" href="../../d1/d3/dll_2query_8c.html#a3">RtlpCommitQueryDebugInfo</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <span class="keyword">sizeof</span>( *HeapInfo ) );
00806                 <span class="keywordflow">if</span> (HeapInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00807                     <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00808                     }
00809 
00810                 HeapInfo-&gt;BaseAddress = Heap;
00811                 HeapInfo-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o2">Flags</a> = Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o2">Flags</a>;
00812                 HeapInfo-&gt;EntryOverhead = <span class="keyword">sizeof</span>( <a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">HEAP_ENTRY</a> );
00813                 Heaps-&gt;NumberOfHeaps += 1;
00814                 }
00815 
00816             <span class="keywordflow">for</span> (i=0; i&lt;Heaps-&gt;NumberOfHeaps; i++) {
00817                 HeapInfo = &amp;Heaps-&gt;Heaps[ i ];
00818                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;SpecificHeap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
00819                     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;SpecificHeap == HeapInfo-&gt;BaseAddress
00820                    ) {
00821                     Heap = HeapInfo-&gt;BaseAddress;
00822                     HeapInfo-&gt;NumberOfTags = Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o14">NextAvailableTagIndex</a>;
00823                     <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = HeapInfo-&gt;NumberOfTags * <span class="keyword">sizeof</span>( RTL_HEAP_TAG );
00824                     <span class="keywordflow">if</span> (Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o29">PseudoTagEntries</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00825                         HeapInfo-&gt;NumberOfTags += <a class="code" href="../../d3/d9/heap_8h.html#a6">HEAP_MAXIMUM_FREELISTS</a> + 1;
00826                         <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> += (<a class="code" href="../../d3/d9/heap_8h.html#a6">HEAP_MAXIMUM_FREELISTS</a> + 1) * <span class="keyword">sizeof</span>( RTL_HEAP_TAG );
00827                         }
00828                     Tags = <a class="code" href="../../d1/d3/dll_2query_8c.html#a3">RtlpCommitQueryDebugInfo</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> );
00829                     <span class="keywordflow">if</span> (Tags == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00830                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00831                         <span class="keywordflow">break</span>;
00832                         }
00833                     HeapInfo-&gt;Tags = Tags;
00834                     <span class="keywordflow">if</span> ((PseudoTags = Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o29">PseudoTagEntries</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00835                         HeapInfo-&gt;NumberOfPseudoTags = <a class="code" href="../../d3/d9/heap_8h.html#a32">HEAP_NUMBER_OF_PSEUDO_TAG</a>;
00836                         HeapInfo-&gt;PseudoTagGranularity = <a class="code" href="../../d3/d9/heap_8h.html#a3">HEAP_GRANULARITY</a>;
00837                         <span class="keywordflow">for</span> (TagIndex=0; TagIndex&lt;=<a class="code" href="../../d3/d9/heap_8h.html#a6">HEAP_MAXIMUM_FREELISTS</a>; TagIndex++) {
00838                             Tags-&gt;NumberOfAllocations = PseudoTags-&gt;<a class="code" href="../../d7/d6/struct__HEAP__PSEUDO__TAG__ENTRY.html#o0">Allocs</a>;
00839                             Tags-&gt;NumberOfFrees = PseudoTags-&gt;<a class="code" href="../../d7/d6/struct__HEAP__PSEUDO__TAG__ENTRY.html#o1">Frees</a>;
00840                             Tags-&gt;BytesAllocated = PseudoTags-&gt;<a class="code" href="../../d7/d6/struct__HEAP__PSEUDO__TAG__ENTRY.html#o2">Size</a> &lt;&lt; <a class="code" href="../../d3/d9/heap_8h.html#a4">HEAP_GRANULARITY_SHIFT</a>;
00841                             Tags-&gt;TagIndex = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(TagIndex | HEAP_PSEUDO_TAG_FLAG);
00842                             <span class="keywordflow">if</span> (TagIndex == 0) {
00843                                 swprintf( Tags-&gt;TagName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Objects&gt;%4u"</span>,
00844                                           <a class="code" href="../../d3/d9/heap_8h.html#a6">HEAP_MAXIMUM_FREELISTS</a> &lt;&lt; <a class="code" href="../../d3/d9/heap_8h.html#a4">HEAP_GRANULARITY_SHIFT</a>
00845                                         );
00846                                 }
00847                             <span class="keywordflow">else</span>
00848                             <span class="keywordflow">if</span> (TagIndex &lt; <a class="code" href="../../d3/d9/heap_8h.html#a6">HEAP_MAXIMUM_FREELISTS</a>) {
00849                                 swprintf( Tags-&gt;TagName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Objects=%4u"</span>,
00850                                           TagIndex &lt;&lt; <a class="code" href="../../d3/d9/heap_8h.html#a4">HEAP_GRANULARITY_SHIFT</a>
00851                                         );
00852                                 }
00853                             <span class="keywordflow">else</span> {
00854                                 swprintf( Tags-&gt;TagName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"VirtualAlloc"</span>,
00855                                           TagIndex &lt;&lt; <a class="code" href="../../d3/d9/heap_8h.html#a4">HEAP_GRANULARITY_SHIFT</a>
00856                                         );
00857                                 }
00858 
00859                             Tags += 1;
00860                             PseudoTags += 1;
00861                             }
00862                         }
00863 
00864                     RtlMoveMemory( Tags,
00865                                    Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o16">TagEntries</a>,
00866                                    Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o14">NextAvailableTagIndex</a> * <span class="keyword">sizeof</span>( RTL_HEAP_TAG )
00867                                  );
00868                     <span class="keywordflow">for</span> (TagIndex=0; TagIndex&lt;Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o14">NextAvailableTagIndex</a>; TagIndex++) {
00869                         Tags-&gt;BytesAllocated &lt;&lt;= <a class="code" href="../../d3/d9/heap_8h.html#a4">HEAP_GRANULARITY_SHIFT</a>;
00870                         Tags += 1;
00871                         }
00872                     }
00873                 }
00874             }
00875         }
00876     <span class="keywordflow">else</span> {
00877         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;Heaps = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00878         }
00879     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00880         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;Flags &amp; RTL_QUERY_PROCESS_HEAP_ENTRIES) {
00881             <span class="keywordflow">for</span> (i=0; i&lt;Heaps-&gt;NumberOfHeaps; i++) {
00882                 HeapInfo = &amp;Heaps-&gt;Heaps[ i ];
00883                 Heap = HeapInfo-&gt;BaseAddress;
00884                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;SpecificHeap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
00885                     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;SpecificHeap == Heap
00886                    ) {
00887                     <span class="keywordflow">if</span> (!(Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o2">Flags</a> &amp; HEAP_NO_SERIALIZE)) {
00888                         RtlEnterCriticalSection( (PRTL_CRITICAL_SECTION)Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o31">LockVariable</a> );
00889                         LockAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00890                         }
00891                     <span class="keywordflow">else</span> {
00892                         LockAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00893                         }
00894 
00895                     <span class="keywordflow">try</span> {
00896                         <span class="keywordflow">for</span> (SegmentIndex=0; SegmentIndex&lt;<a class="code" href="../../d3/d9/heap_8h.html#a7">HEAP_MAXIMUM_SEGMENTS</a>; SegmentIndex++) {
00897                             Segment = Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o22">Segments</a>[ SegmentIndex ];
00898                             <span class="keywordflow">if</span> (!Segment) {
00899                                 <span class="keywordflow">continue</span>;
00900                                 }
00901 
00902                             Entries = <a class="code" href="../../d1/d3/dll_2query_8c.html#a3">RtlpCommitQueryDebugInfo</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <span class="keyword">sizeof</span>( *Entries ) );
00903                             <span class="keywordflow">if</span> (Entries == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00904                                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00905                                 <span class="keywordflow">break</span>;
00906                                 }
00907                             <span class="keywordflow">else</span>
00908                             <span class="keywordflow">if</span> (HeapInfo-&gt;Entries == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00909                                 HeapInfo-&gt;Entries = Entries;
00910                                 }
00911 
00912                             Entries-&gt;Flags = RTL_HEAP_SEGMENT;
00913                             Entries-&gt;AllocatorBackTraceIndex = Segment-&gt;<a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html#o12">AllocatorBackTraceIndex</a>;
00914                             Entries-&gt;Size = Segment-&gt;<a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html#o6">NumberOfPages</a> * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00915                             Entries-&gt;u.s2.CommittedSize = (Segment-&gt;<a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html#o6">NumberOfPages</a> -
00916                                                            Segment-&gt;<a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html#o9">NumberOfUnCommittedPages</a>
00917                                                           ) * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00918                             Entries-&gt;u.s2.FirstBlock = Segment-&gt;<a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html#o7">FirstEntry</a>;
00919                             HeapInfo-&gt;NumberOfEntries++;
00920 
00921                             UnCommittedRange = Segment-&gt;<a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html#o11">UnCommittedRanges</a>;
00922                             CurrentBlock = Segment-&gt;<a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html#o7">FirstEntry</a>;
00923                             <span class="keywordflow">while</span> (CurrentBlock &lt; Segment-&gt;<a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html#o8">LastValidEntry</a>) {
00924                                 Entries = <a class="code" href="../../d1/d3/dll_2query_8c.html#a3">RtlpCommitQueryDebugInfo</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <span class="keyword">sizeof</span>( *Entries ) );
00925                                 <span class="keywordflow">if</span> (Entries == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00926                                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00927                                     <span class="keywordflow">break</span>;
00928                                     }
00929 
00930                                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = CurrentBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o0">Size</a> &lt;&lt; <a class="code" href="../../d3/d9/heap_8h.html#a4">HEAP_GRANULARITY_SHIFT</a>;
00931                                 Entries-&gt;Size = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00932                                 HeapInfo-&gt;NumberOfEntries++;
00933                                 <span class="keywordflow">if</span> (CurrentBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o3">Flags</a> &amp; <a class="code" href="../../d3/d9/heap_8h.html#a8">HEAP_ENTRY_BUSY</a>) {
00934                                     <span class="keywordflow">if</span> (CurrentBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o3">Flags</a> &amp; <a class="code" href="../../d3/d9/heap_8h.html#a9">HEAP_ENTRY_EXTRA_PRESENT</a>) {
00935                                         ExtraStuff = (<a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html">PHEAP_ENTRY_EXTRA</a>)(CurrentBlock + CurrentBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o0">Size</a> - 1);
00936 <span class="preprocessor">#if i386</span>
00937 <span class="preprocessor"></span>                                        Entries-&gt;<a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html#o0">AllocatorBackTraceIndex</a> = ExtraStuff-&gt;<a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html#o0">AllocatorBackTraceIndex</a>;
00938 <span class="preprocessor">#endif // i386</span>
00939 <span class="preprocessor"></span>                                        Entries-&gt;Flags |= RTL_HEAP_SETTABLE_VALUE;
00940                                         Entries-&gt;u.s1.Settable = ExtraStuff-&gt;<a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html#o2">Settable</a>;
00941                                         Entries-&gt;u.s1.Tag = ExtraStuff-&gt;<a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html#o1">TagIndex</a>;
00942                                         }
00943                                     <span class="keywordflow">else</span> {
00944                                         Entries-&gt;u.s1.Tag = CurrentBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o5">SmallTagIndex</a>;
00945                                         }
00946 
00947                                     Entries-&gt;Flags |= RTL_HEAP_BUSY | (CurrentBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o3">Flags</a> &amp; <a class="code" href="../../d3/d9/heap_8h.html#a16">HEAP_ENTRY_SETTABLE_FLAGS</a>);
00948                                     }
00949                                 <span class="keywordflow">else</span>
00950                                 <span class="keywordflow">if</span> (CurrentBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o3">Flags</a> &amp; <a class="code" href="../../d3/d9/heap_8h.html#a9">HEAP_ENTRY_EXTRA_PRESENT</a>) {
00951                                     <a class="code" href="../../d2/d6/struct__HEAP__FREE__ENTRY__EXTRA.html">PHEAP_FREE_ENTRY_EXTRA</a> FreeExtra;
00952 
00953                                     FreeExtra = (<a class="code" href="../../d2/d6/struct__HEAP__FREE__ENTRY__EXTRA.html">PHEAP_FREE_ENTRY_EXTRA</a>)(CurrentBlock + CurrentBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o0">Size</a>) - 1;
00954                                     Entries-&gt;u.s1.Tag = FreeExtra-&gt;<a class="code" href="../../d2/d6/struct__HEAP__FREE__ENTRY__EXTRA.html#o0">TagIndex</a>;
00955                                     Entries-&gt;AllocatorBackTraceIndex = FreeExtra-&gt;<a class="code" href="../../d2/d6/struct__HEAP__FREE__ENTRY__EXTRA.html#o1">FreeBackTraceIndex</a>;
00956                                     }
00957 
00958                                 <span class="keywordflow">if</span> (CurrentBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o3">Flags</a> &amp; <a class="code" href="../../d3/d9/heap_8h.html#a12">HEAP_ENTRY_LAST_ENTRY</a>) {
00959                                     CurrentBlock += CurrentBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o0">Size</a>;
00960                                     <span class="keywordflow">if</span> (UnCommittedRange == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00961                                         CurrentBlock = Segment-&gt;<a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html#o8">LastValidEntry</a>;
00962                                         }
00963                                     <span class="keywordflow">else</span> {
00964                                         Entries = <a class="code" href="../../d1/d3/dll_2query_8c.html#a3">RtlpCommitQueryDebugInfo</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <span class="keyword">sizeof</span>( *Entries ) );
00965                                         <span class="keywordflow">if</span> (Entries == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00966                                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00967                                             <span class="keywordflow">break</span>;
00968                                             }
00969 
00970                                         Entries-&gt;Flags = RTL_HEAP_UNCOMMITTED_RANGE;
00971                                         Entries-&gt;Size = UnCommittedRange-&gt;<a class="code" href="../../d5/d7/struct__HEAP__UNCOMMMTTED__RANGE.html#o2">Size</a>;
00972                                         HeapInfo-&gt;NumberOfEntries++;
00973 
00974                                         CurrentBlock = (<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)
00975                                             ((PCHAR)UnCommittedRange-&gt;<a class="code" href="../../d5/d7/struct__HEAP__UNCOMMMTTED__RANGE.html#o1">Address</a> + UnCommittedRange-&gt;<a class="code" href="../../d5/d7/struct__HEAP__UNCOMMMTTED__RANGE.html#o2">Size</a>);
00976                                         UnCommittedRange = UnCommittedRange-&gt;<a class="code" href="../../d5/d7/struct__HEAP__UNCOMMMTTED__RANGE.html#o0">Next</a>;
00977                                         }
00978                                     }
00979                                 <span class="keywordflow">else</span> {
00980                                     CurrentBlock += CurrentBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o0">Size</a>;
00981                                     }
00982                                 }
00983                             }
00984 
00985                         Head = &amp;Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o21">VirtualAllocdBlocks</a>;
00986                         Next = Head-&gt;Flink;
00987                         <span class="keywordflow">while</span> (Head != Next) {
00988                             VirtualAllocBlock = CONTAINING_RECORD( Next, <a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html">HEAP_VIRTUAL_ALLOC_ENTRY</a>, Entry );
00989                             CurrentBlock = &amp;VirtualAllocBlock-&gt;<a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html#o4">BusyBlock</a>;
00990                             Entries = <a class="code" href="../../d1/d3/dll_2query_8c.html#a3">RtlpCommitQueryDebugInfo</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <span class="keyword">sizeof</span>( *Entries ) );
00991                             <span class="keywordflow">if</span> (Entries == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00992                                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00993                                 <span class="keywordflow">break</span>;
00994                                 }
00995                             <span class="keywordflow">else</span>
00996                             <span class="keywordflow">if</span> (HeapInfo-&gt;Entries == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00997                                 HeapInfo-&gt;Entries = Entries;
00998                                 }
00999 
01000                             Entries-&gt;Flags = RTL_HEAP_SEGMENT;
01001                             Entries-&gt;Size = VirtualAllocBlock-&gt;<a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html#o3">ReserveSize</a>;
01002                             Entries-&gt;u.s2.CommittedSize = VirtualAllocBlock-&gt;<a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html#o2">CommitSize</a>;
01003                             Entries-&gt;u.s2.FirstBlock = CurrentBlock;
01004                             HeapInfo-&gt;NumberOfEntries++;
01005                             Entries = <a class="code" href="../../d1/d3/dll_2query_8c.html#a3">RtlpCommitQueryDebugInfo</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <span class="keyword">sizeof</span>( *Entries ) );
01006                             <span class="keywordflow">if</span> (Entries == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01007                                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
01008                                 <span class="keywordflow">break</span>;
01009                                 }
01010 
01011                             Entries-&gt;Size = VirtualAllocBlock-&gt;<a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html#o2">CommitSize</a>;
01012                             Entries-&gt;Flags = RTL_HEAP_BUSY | (CurrentBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o3">Flags</a> &amp; <a class="code" href="../../d3/d9/heap_8h.html#a16">HEAP_ENTRY_SETTABLE_FLAGS</a>);
01013 <span class="preprocessor">#if i386</span>
01014 <span class="preprocessor"></span>                            Entries-&gt;AllocatorBackTraceIndex = VirtualAllocBlock-&gt;<a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html#o1">ExtraStuff</a>.<a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html#o0">AllocatorBackTraceIndex</a>;
01015 <span class="preprocessor">#endif // i386</span>
01016 <span class="preprocessor"></span>                            Entries-&gt;Flags |= RTL_HEAP_SETTABLE_VALUE;
01017                             Entries-&gt;u.s1.Settable = VirtualAllocBlock-&gt;<a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html#o1">ExtraStuff</a>.<a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html#o2">Settable</a>;
01018                             Entries-&gt;u.s1.Tag = VirtualAllocBlock-&gt;<a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html#o1">ExtraStuff</a>.<a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html#o1">TagIndex</a>;
01019                             HeapInfo-&gt;NumberOfEntries++;
01020 
01021                             Next = Next-&gt;Flink;
01022                             }
01023                         }
01024                     finally {
01025                         <span class="comment">//</span>
01026                         <span class="comment">// Unlock the heap</span>
01027                         <span class="comment">//</span>
01028 
01029                         <span class="keywordflow">if</span> (LockAcquired) {
01030                             RtlLeaveCriticalSection( (PRTL_CRITICAL_SECTION)Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o31">LockVariable</a> );
01031                             }
01032                         }
01033                     }
01034 
01035                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01036                     <span class="keywordflow">break</span>;
01037                     }
01038                 }
01039             }
01040         }
01041 
01042     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01043 }
01044 
01045 
01046 NTSYSAPI
01047 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
01048 NTAPI
<a name="l01049"></a><a class="code" href="../../d1/d3/dll_2query_8c.html#a12">01049</a> <a class="code" href="../../d1/d3/dll_2query_8c.html#a12">RtlQueryProcessLockInformation</a>(
01050     IN OUT PRTL_DEBUG_INFORMATION Buffer
01051     )
01052 {
01053     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01054     PLIST_ENTRY Head, Next;
01055     PRTL_PROCESS_LOCKS Locks;
01056     PRTL_PROCESS_LOCK_INFORMATION LockInfo;
01057     PRTL_CRITICAL_SECTION CriticalSection;
01058     PRTL_CRITICAL_SECTION_DEBUG DebugInfo;
01059     PRTL_RESOURCE <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>;
01060     PRTL_RESOURCE_DEBUG ResourceDebugInfo;
01061 
01062     Locks = <a class="code" href="../../d1/d3/dll_2query_8c.html#a3">RtlpCommitQueryDebugInfo</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, FIELD_OFFSET( RTL_PROCESS_LOCKS, Locks ) );
01063     <span class="keywordflow">if</span> (Locks == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01064         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01065         }
01066 
01067     RtlEnterCriticalSection( &amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a35">RtlCriticalSectionLock</a> );
01068     Head = &amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a34">RtlCriticalSectionList</a>;
01069     Next = Head-&gt;Flink;
01070     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01071     <span class="keywordflow">while</span> (Next != Head) {
01072         DebugInfo = CONTAINING_RECORD( Next,
01073                                        RTL_CRITICAL_SECTION_DEBUG,
01074                                        ProcessLocksList
01075                                      );
01076         LockInfo = <a class="code" href="../../d1/d3/dll_2query_8c.html#a3">RtlpCommitQueryDebugInfo</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <span class="keyword">sizeof</span>( RTL_PROCESS_LOCK_INFORMATION ) );
01077         <span class="keywordflow">if</span> (LockInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01078             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
01079             <span class="keywordflow">break</span>;
01080             }
01081 
01082         CriticalSection = DebugInfo-&gt;CriticalSection;
01083         <span class="keywordflow">try</span> {
01084             LockInfo-&gt;Address = CriticalSection;
01085             LockInfo-&gt;Type = DebugInfo-&gt;Type;
01086             LockInfo-&gt;CreatorBackTraceIndex = DebugInfo-&gt;CreatorBackTraceIndex;
01087             <span class="keywordflow">if</span> (LockInfo-&gt;Type == RTL_CRITSECT_TYPE) {
01088                 LockInfo-&gt;OwningThread = CriticalSection-&gt;OwningThread;
01089                 LockInfo-&gt;LockCount = CriticalSection-&gt;LockCount;
01090                 LockInfo-&gt;RecursionCount = CriticalSection-&gt;RecursionCount;
01091                 LockInfo-&gt;ContentionCount = DebugInfo-&gt;ContentionCount;
01092                 LockInfo-&gt;EntryCount = DebugInfo-&gt;EntryCount;
01093                 }
01094             <span class="keywordflow">else</span> {
01095                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> = (PRTL_RESOURCE)CriticalSection;
01096                 ResourceDebugInfo = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;DebugInfo;
01097                 LockInfo-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o7">ContentionCount</a> = ResourceDebugInfo-&gt;ContentionCount;
01098                 LockInfo-&gt;OwningThread = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveOwnerThread;
01099                 LockInfo-&gt;LockCount = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive;
01100                 LockInfo-&gt;NumberOfWaitingShared    = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingShared;
01101                 LockInfo-&gt;NumberOfWaitingExclusive = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingExclusive;
01102                 }
01103 
01104             Locks-&gt;NumberOfLocks++;
01105             }
01106         except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01107             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"NTDLL: Lost critical section %08lX\n"</span>, CriticalSection);
01108             <a class="code" href="../../d1/d3/dll_2query_8c.html#a4">RtlpDeCommitQueryDebugInfo</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, LockInfo, <span class="keyword">sizeof</span>( RTL_PROCESS_LOCK_INFORMATION ) );
01109             }
01110 
01111         <span class="keywordflow">if</span> (Next == Next-&gt;Flink) {
01112             <span class="comment">//</span>
01113             <span class="comment">// Bail if list is circular</span>
01114             <span class="comment">//</span>
01115             <span class="keywordflow">break</span>;
01116             }
01117         <span class="keywordflow">else</span> {
01118             Next = Next-&gt;Flink;
01119             }
01120         }
01121 
01122     RtlLeaveCriticalSection( &amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a35">RtlCriticalSectionLock</a> );
01123 
01124     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01125         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;Locks = Locks;
01126         }
01127 
01128     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01129 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:34 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
