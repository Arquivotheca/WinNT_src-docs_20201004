<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ex/pool.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>pool.c File Reference</h1><code>#include "<a class="el" href="../../d5/d9/exp_8h-source.html">exp.h</a>"</code><br>

<p>
<a href="../../d3/d1/ex_2pool_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a0">POOL_QUOTA_ENABLED</a>&nbsp;&nbsp;&nbsp;(<a class="el" href="../../d9/d5/4_2kddata_8c.html#a44">PoolTrackTable</a> == NULL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a1">POOL_SPECIAL_POOL_BIT</a>&nbsp;&nbsp;&nbsp;0x8</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a2">POOL_SPECIAL_POOL_UNDERRUN_BIT</a>&nbsp;&nbsp;&nbsp;0x1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a3">FREE_CHECK_ERESOURCE</a>(Va, NumberOfBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a4">FREE_CHECK_KTIMER</a>(Va, NumberOfBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a5">FREE_CHECK_WORKER</a>(Va, NumberOfBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a6">LOCK_POOL_GRANULAR</a>(PoolDesc, LockHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a7">UNLOCK_POOL_GRANULAR</a>(PoolDesc, LockHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a8">DecodeLink</a>(Link)&nbsp;&nbsp;&nbsp;((PLIST_ENTRY)((ULONG_PTR)(Link) &amp; ~1))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a9">EncodeLink</a>(Link)&nbsp;&nbsp;&nbsp;((PLIST_ENTRY)((ULONG_PTR)(Link) |  1))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a10">PrivateInitializeListHead</a>(ListHead)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a11">PrivateIsListEmpty</a>(ListHead)&nbsp;&nbsp;&nbsp;(DecodeLink((ListHead)-&gt;Flink) == (ListHead))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a12">PrivateRemoveHeadList</a>(ListHead)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a13">PrivateRemoveTailList</a>(ListHead)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a14">PrivateRemoveEntryList</a>(Entry)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a15">PrivateInsertTailList</a>(ListHead, Entry)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a16">PrivateInsertHeadList</a>(ListHead, Entry)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(LINE, LIST, <a class="el" href="../../d6/d4/structtagENTRY.html">ENTRY</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a18">CHECK_POOL_HEADER</a>(LINE, <a class="el" href="../../d6/d4/structtagENTRY.html">ENTRY</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a19">ASSERT_ALLOCATE_IRQL</a>(_PoolType, _NumberOfBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a20">ASSERT_FREE_IRQL</a>(_PoolType, _P)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a21">ASSERT_POOL_NOT_FREE</a>(_Entry)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a22">ASSERT_POOL_TYPE_NOT_ZERO</a>(_Entry)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a23">CHECK_LOOKASIDE_LIST</a>(LINE, LIST, <a class="el" href="../../d6/d4/structtagENTRY.html">ENTRY</a>)&nbsp;&nbsp;&nbsp;{NOTHING;}</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a24">MAX_TRACKER_TABLE</a>&nbsp;&nbsp;&nbsp;1025</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a25">MAX_BIGPAGE_TABLE</a>&nbsp;&nbsp;&nbsp;4096</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a26">ENCODE_POOL_INDEX</a>(POOLHEADER, INDEX)&nbsp;&nbsp;&nbsp;{(POOLHEADER)-&gt;PoolIndex = (UCHAR)((((POOLHEADER)-&gt;PoolIndex &amp; 0x80) | ((UCHAR)(INDEX))));}</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a27">DECODE_POOL_INDEX</a>(POOLHEADER)&nbsp;&nbsp;&nbsp;((ULONG)((POOLHEADER)-&gt;PoolIndex &amp; 0x7f))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a28">MARK_POOL_HEADER_ALLOCATED</a>(POOLHEADER)&nbsp;&nbsp;&nbsp;{(POOLHEADER)-&gt;PoolIndex |= 0x80;}</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a29">MARK_POOL_HEADER_FREED</a>(POOLHEADER)&nbsp;&nbsp;&nbsp;{(POOLHEADER)-&gt;PoolIndex &amp;= 0x7f;}</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a30">IS_POOL_HEADER_MARKED_ALLOCATED</a>(POOLHEADER)&nbsp;&nbsp;&nbsp;((POOLHEADER)-&gt;PoolIndex &amp; 0x80)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a31">ExpLockNonPagedPool</a>(OldIrql)&nbsp;&nbsp;&nbsp;ExAcquireSpinLock(&amp;<a class="el" href="../../d5/d2/poolhack_8c.html#a21">NonPagedPoolLock</a>, &amp;OldIrql)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a32">ExpUnlockNonPagedPool</a>(OldIrql)&nbsp;&nbsp;&nbsp;ExReleaseSpinLock(&amp;<a class="el" href="../../d5/d2/poolhack_8c.html#a21">NonPagedPoolLock</a>, OldIrql)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a33">LOCK_POOL</a>(PoolDesc, LockHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a34">LOCK_IF_PAGED_POOL</a>(_CheckType, _GlobalPool)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a35">UNLOCK_POOL</a>(PoolDesc, LockHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a36">UNLOCK_IF_PAGED_POOL</a>(_CheckType, _GlobalPool)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a37">_NTOSKRNL_VERIFIER_</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a38">CacheOverhead</a>&nbsp;&nbsp;&nbsp;POOL_OVERHEAD</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a62">MmSqueezeBadTags</a> (IN SIZE_T NumberOfBytes, IN ULONG Tag, IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType, IN ULONG SpecialPoolType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a63">ExpInitializePoolDescriptor</a> (IN <a class="el" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">PPOOL_DESCRIPTOR</a> PoolDescriptor, IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType, IN ULONG PoolIndex, IN ULONG Threshold, IN PVOID PoolLock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a64">ExpSnapShotPoolPages</a> (IN PVOID Address, IN ULONG <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>, IN OUT PSYSTEM_POOL_INFORMATION PoolInformation, IN OUT PSYSTEM_POOL_ENTRY *PoolEntryInfo, IN ULONG Length, IN OUT PULONG RequiredLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a65">ExpInsertPoolTracker</a> (IN ULONG <a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>, IN SIZE_T <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>, IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a66">ExpRemovePoolTracker</a> (IN ULONG <a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>, IN ULONG <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>, IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a67">ExpAddTagForBigPages</a> (IN PVOID Va, IN ULONG <a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>, IN ULONG NumberOfPages)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a68">ExpFindAndRemoveTagBigPages</a> (IN PVOID Va)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a69">ExpAllocateStringRoutine</a> (IN SIZE_T NumberOfBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a70">ExOkayToLockRoutine</a> (IN PVOID Lock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>KIRQL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a71">ExLockPool</a> (IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a72">ExUnlockPool</a> (IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType, IN KIRQL LockHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a73">InitializePool</a> (IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType, IN ULONG Threshold)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a74">ExpCheckSingleFilter</a> (ULONG Tag, ULONG <a class="el" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a75">ExAllocatePool</a> (IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType, IN SIZE_T NumberOfBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a76">VeAllocatePoolWithTagPriority</a> (IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType, IN SIZE_T NumberOfBytes, IN ULONG Tag, IN <a class="el" href="../../d5/d8/ex_8h.html#a97">EX_POOL_PRIORITY</a> Priority, IN PVOID CallingAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a77">ExAllocatePoolWithTagPriority</a> (IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType, IN SIZE_T NumberOfBytes, IN ULONG Tag, IN <a class="el" href="../../d5/d8/ex_8h.html#a97">EX_POOL_PRIORITY</a> Priority)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a78">ExAllocatePoolWithTag</a> (IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType, IN SIZE_T NumberOfBytes, IN ULONG Tag)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a79">ExInsertPoolTag</a> (ULONG Tag, PVOID Va, SIZE_T NumberOfBytes, <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a80">ExRemovePoolTag</a> (ULONG Tag, PVOID Va, SIZE_T NumberOfBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a81">ExpAllocatePoolWithQuotaHandler</a> (IN NTSTATUS ExceptionCode, IN PVOID PoolAddress, IN LOGICAL ContinueSearch)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a82">ExAllocatePoolWithQuota</a> (IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType, IN SIZE_T NumberOfBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a83">ExAllocatePoolWithQuotaTag</a> (IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType, IN SIZE_T NumberOfBytes, IN ULONG Tag)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a84">ExFreePool</a> (IN PVOID P)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a85">ExFreePoolWithTag</a> (IN PVOID P, IN ULONG TagToFree)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a86">ExQueryPoolBlockSize</a> (IN PVOID PoolBlock, OUT PBOOLEAN QuotaCharged)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a87">ExQueryPoolUsage</a> (OUT PULONG PagedPoolPages, OUT PULONG NonPagedPoolPages, OUT PULONG PagedPoolAllocs, OUT PULONG PagedPoolFrees, OUT PULONG PagedPoolLookasideHits, OUT PULONG NonPagedPoolAllocs, OUT PULONG NonPagedPoolFrees, OUT PULONG NonPagedPoolLookasideHits)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a88">ExReturnPoolQuota</a> (IN PVOID P)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a89">ExAllocatePoolSanityChecks</a> (IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType, IN SIZE_T NumberOfBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a90">ExFreePoolSanityChecks</a> (IN PVOID P)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a39">ExpPoolBugCheckLine</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">PPOOL_DESCRIPTOR</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a40">ExpSessionPoolDescriptor</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a41">FirstPrint</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html">PPOOL_TRACKER_TABLE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>SIZE_T&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a43">PoolTrackTableSize</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>SIZE_T&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a44">PoolTrackTableMask</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d9/struct__POOL__TRACKER__BIG__PAGES.html">PPOOL_TRACKER_BIG_PAGES</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a45">PoolBigPageTable</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>SIZE_T&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a46">PoolBigPageTableSize</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>SIZE_T&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a47">PoolBigPageTableHash</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a48">PoolHitTag</a> = 0xffffff0f</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PRTL_ALLOCATE_STRING_ROUTINE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a49">RtlAllocateStringRoutine</a> = ExpAllocateStringRoutine</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PRTL_FREE_STRING_ROUTINE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a50">RtlFreeStringRoutine</a> = (PRTL_FREE_STRING_ROUTINE)ExFreePool</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a51">ExpNumberOfPagedPools</a> = NUMBER_OF_PAGED_POOLS</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">POOL_DESCRIPTOR</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a52">NonPagedPoolDescriptor</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">POOL_DESCRIPTOR</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a53">NonPagedPoolDescriptorMS</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">PPOOL_DESCRIPTOR</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a54">PoolVector</a> [NUMBER_OF_POOLS]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">PPOOL_DESCRIPTOR</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a55">ExpPagedPoolDescriptor</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>KSPIN_LOCK&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a56">NonPagedPoolLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>volatile ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a57">ExpPoolIndex</a> = 1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>KSPIN_LOCK&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a58">ExpTaggedPoolLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a59">ExpSmallNPagedPoolLookasideLists</a> [POOL_SMALL_LISTS]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a60">ExpSmallPagedPoolLookasideLists</a> [POOL_SMALL_LISTS]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/ex_2pool_8c.html#a61">KernelVerifier</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a37" doxytag="ex/pool.c::_NTOSKRNL_VERIFIER_" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define _NTOSKRNL_VERIFIER_&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00974">974</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="ex/pool.c::ASSERT_ALLOCATE_IRQL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ASSERT_ALLOCATE_IRQL          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_PoolType,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>_NumberOfBytes&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><span class="keywordflow">if</span> ((_PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>) == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {               \
        <span class="keywordflow">if</span> (KeGetCurrentIrql() &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) {                           \
            <a class="code" href="../../d6/d3/cmwraper_8c.html#a23">KeBugCheckEx</a> (BAD_POOL_CALLER, 8, KeGetCurrentIrql(), _PoolType, _NumberOfBytes);                                                           \
        }                                                               \
    }                                                                   \
    <span class="keywordflow">else</span> {                                                              \
        <span class="keywordflow">if</span> (KeGetCurrentIrql() &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {                      \
            <a class="code" href="../../d6/d3/cmwraper_8c.html#a23">KeBugCheckEx</a> (BAD_POOL_CALLER, 8, KeGetCurrentIrql(), _PoolType, _NumberOfBytes);                                                           \
        }                                                               \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00205">205</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="ex/pool.c::ASSERT_FREE_IRQL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ASSERT_FREE_IRQL          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_PoolType,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>_P&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><span class="keywordflow">if</span> ((_PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>) == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {               \
        <span class="keywordflow">if</span> (KeGetCurrentIrql() &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) {                           \
            <a class="code" href="../../d6/d3/cmwraper_8c.html#a23">KeBugCheckEx</a> (BAD_POOL_CALLER, 9, KeGetCurrentIrql(), _PoolType, (ULONG_PTR)_P);                                                            \
        }                                                               \
    }                                                                   \
    <span class="keywordflow">else</span> {                                                              \
        <span class="keywordflow">if</span> (KeGetCurrentIrql() &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {                      \
            <a class="code" href="../../d6/d3/cmwraper_8c.html#a23">KeBugCheckEx</a> (BAD_POOL_CALLER, 9, KeGetCurrentIrql(), _PoolType, (ULONG_PTR)P);                                                             \
        }                                                               \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00217">217</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">ExFreePoolWithTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="ex/pool.c::ASSERT_POOL_NOT_FREE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ASSERT_POOL_NOT_FREE          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_Entry&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><span class="keywordflow">if</span> ((_Entry-&gt;PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a12">POOL_TYPE_MASK</a>) == 0) {                     \
        <a class="code" href="../../d6/d3/cmwraper_8c.html#a23">KeBugCheckEx</a> (BAD_POOL_CALLER, 6, __LINE__, (ULONG_PTR)_Entry, _Entry-&gt;Ulong1);                                                                 \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00229">229</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">ExFreePoolWithTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="ex/pool.c::ASSERT_POOL_TYPE_NOT_ZERO" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ASSERT_POOL_TYPE_NOT_ZERO          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_Entry&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><span class="keywordflow">if</span> (_Entry-&gt;PoolType == 0) {                                        \
        <a class="code" href="../../d6/d3/cmwraper_8c.html#a23">KeBugCheckEx</a>(BAD_POOL_CALLER, 1, (ULONG_PTR)_Entry, (ULONG_PTR)(*(PULONG)_Entry), 0);                                                           \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00234">234</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">ExFreePoolWithTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="ex/pool.c::CacheOverhead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CacheOverhead&nbsp;&nbsp;&nbsp;POOL_OVERHEAD          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="ex/pool.c::CHECK_LIST" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CHECK_LIST          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">LINE,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LIST,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d6/d4/structtagENTRY.html">ENTRY</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><span class="keywordflow">if</span> ((<a class="code" href="../../d2/d2/ex_2pool_8c.html#a8">DecodeLink</a>(<a class="code" href="../../d2/d2/ex_2pool_8c.html#a8">DecodeLink</a>((LIST)-&gt;Flink)-&gt;Blink) != (<a class="code" href="../../d2/d5/editreg_8c.html#a11">LIST</a>)) ||         \
        (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a8">DecodeLink</a>(<a class="code" href="../../d2/d2/ex_2pool_8c.html#a8">DecodeLink</a>((LIST)-&gt;Blink)-&gt;Flink) != (<a class="code" href="../../d2/d5/editreg_8c.html#a11">LIST</a>))) {         \
            <a class="code" href="../../d2/d2/ex_2pool_8c.html#a39">ExpPoolBugCheckLine</a> = LINE;                                     \
            <a class="code" href="../../d6/d3/cmwraper_8c.html#a23">KeBugCheckEx</a> (BAD_POOL_HEADER,                                  \
                          3,                                                \
                          (ULONG_PTR)LIST,                                  \
                          (ULONG_PTR)<a class="code" href="../../d2/d2/ex_2pool_8c.html#a8">DecodeLink</a>(<a class="code" href="../../d2/d2/ex_2pool_8c.html#a8">DecodeLink</a>((LIST)-&gt;Flink)-&gt;Blink),     \
                          (ULONG_PTR)<a class="code" href="../../d2/d2/ex_2pool_8c.html#a8">DecodeLink</a>(<a class="code" href="../../d2/d2/ex_2pool_8c.html#a8">DecodeLink</a>((LIST)-&gt;Blink)-&gt;Flink));    \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00173">173</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">ExFreePoolWithTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="ex/pool.c::CHECK_LOOKASIDE_LIST" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CHECK_LOOKASIDE_LIST          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">LINE,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LIST,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d6/d4/structtagENTRY.html">ENTRY</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;{NOTHING;}</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00239">239</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">ExFreePoolWithTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="ex/pool.c::CHECK_POOL_HEADER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CHECK_POOL_HEADER          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">LINE,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d6/d4/structtagENTRY.html">ENTRY</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                                 \
    <a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a> PreviousEntry;                                                         \
    <a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a> NextEntry;                                                             \
    <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d4/structtagENTRY.html">ENTRY</a>)-&gt;PreviousSize != 0) {                                                   \
        PreviousEntry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((<a class="code" href="../../d3/d8/struct__POOL__BLOCK.html">PPOOL_BLOCK</a>)(<a class="code" href="../../d6/d4/structtagENTRY.html">ENTRY</a>) - (<a class="code" href="../../d6/d4/structtagENTRY.html">ENTRY</a>)-&gt;PreviousSize);   \
        <span class="keywordflow">if</span> ((PreviousEntry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> != (<a class="code" href="../../d6/d4/structtagENTRY.html">ENTRY</a>)-&gt;PreviousSize) ||                      \
            (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a27">DECODE_POOL_INDEX</a>(PreviousEntry) != <a class="code" href="../../d2/d2/ex_2pool_8c.html#a27">DECODE_POOL_INDEX</a>(<a class="code" href="../../d6/d4/structtagENTRY.html">ENTRY</a>))) {           \
            <a class="code" href="../../d2/d2/ex_2pool_8c.html#a39">ExpPoolBugCheckLine</a> = LINE;                                     \
            <a class="code" href="../../d6/d3/cmwraper_8c.html#a23">KeBugCheckEx</a>(BAD_POOL_HEADER, 5, (ULONG_PTR)PreviousEntry, LINE, (ULONG_PTR)<a class="code" href="../../d6/d4/structtagENTRY.html">ENTRY</a>); \
        }                                                                               \
    }                                                                                   \
    NextEntry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((<a class="code" href="../../d3/d8/struct__POOL__BLOCK.html">PPOOL_BLOCK</a>)(<a class="code" href="../../d6/d4/structtagENTRY.html">ENTRY</a>) + (<a class="code" href="../../d6/d4/structtagENTRY.html">ENTRY</a>)-&gt;BlockSize);              \
    <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d2/pool_8h.html#a17">PAGE_END</a>(NextEntry)) {                                                         \
        <span class="keywordflow">if</span> ((NextEntry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o3">PreviousSize</a> != (<a class="code" href="../../d6/d4/structtagENTRY.html">ENTRY</a>)-&gt;BlockSize) ||                          \
            (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a27">DECODE_POOL_INDEX</a>(NextEntry) != <a class="code" href="../../d2/d2/ex_2pool_8c.html#a27">DECODE_POOL_INDEX</a>(<a class="code" href="../../d6/d4/structtagENTRY.html">ENTRY</a>))) {               \
            <a class="code" href="../../d2/d2/ex_2pool_8c.html#a39">ExpPoolBugCheckLine</a> = LINE;                                     \
            <a class="code" href="../../d6/d3/cmwraper_8c.html#a23">KeBugCheckEx</a>(BAD_POOL_HEADER, 5, (ULONG_PTR)NextEntry, LINE, (ULONG_PTR)<a class="code" href="../../d6/d4/structtagENTRY.html">ENTRY</a>);     \
        }                                                                               \
    }                                                                                   \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00184">184</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">ExFreePoolWithTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="ex/pool.c::DECODE_POOL_INDEX" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DECODE_POOL_INDEX          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">POOLHEADER&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((ULONG)((POOLHEADER)-&gt;PoolIndex &amp; 0x7f))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00418">418</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">ExFreePoolWithTag()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l03480">ExReturnPoolQuota()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="ex/pool.c::DecodeLink" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DecodeLink          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Link&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((PLIST_ENTRY)((ULONG_PTR)(Link) &amp; ~1))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00125">125</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">ExFreePoolWithTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="ex/pool.c::ENCODE_POOL_INDEX" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ENCODE_POOL_INDEX          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">POOLHEADER,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>INDEX&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;{(POOLHEADER)-&gt;PoolIndex = (UCHAR)((((POOLHEADER)-&gt;PoolIndex &amp; 0x80) | ((UCHAR)(INDEX))));}</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00417">417</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">ExFreePoolWithTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="ex/pool.c::EncodeLink" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define EncodeLink          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Link&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((PLIST_ENTRY)((ULONG_PTR)(Link) |  1))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00126">126</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="ex/pool.c::ExpLockNonPagedPool" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ExpLockNonPagedPool          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OldIrql&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExAcquireSpinLock(&amp;<a class="el" href="../../d5/d2/poolhack_8c.html#a21">NonPagedPoolLock</a>, &amp;OldIrql)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00456">456</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02324">ExpAddTagForBigPages()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02000">ExpInsertPoolTracker()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="ex/pool.c::ExpUnlockNonPagedPool" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ExpUnlockNonPagedPool          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OldIrql&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExReleaseSpinLock(&amp;<a class="el" href="../../d5/d2/poolhack_8c.html#a21">NonPagedPoolLock</a>, OldIrql)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00459">459</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02324">ExpAddTagForBigPages()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02000">ExpInsertPoolTracker()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="ex/pool.c::FREE_CHECK_ERESOURCE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FREE_CHECK_ERESOURCE          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Va,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>NumberOfBytes&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00072">72</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">ExFreePoolWithTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="ex/pool.c::FREE_CHECK_KTIMER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FREE_CHECK_KTIMER          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Va,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>NumberOfBytes&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00073">73</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">ExFreePoolWithTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="ex/pool.c::FREE_CHECK_WORKER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FREE_CHECK_WORKER          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Va,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>NumberOfBytes&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00074">74</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">ExFreePoolWithTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="ex/pool.c::IS_POOL_HEADER_MARKED_ALLOCATED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IS_POOL_HEADER_MARKED_ALLOCATED          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">POOLHEADER&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((POOLHEADER)-&gt;PoolIndex &amp; 0x80)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00422">422</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l03892">ExFreePoolSanityChecks()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">ExFreePoolWithTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="ex/pool.c::LOCK_IF_PAGED_POOL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LOCK_IF_PAGED_POOL          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_CheckType,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>_GlobalPool&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><span class="keywordflow">if</span> (_CheckType == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a> &amp;&amp; _GlobalPool == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {                      \
        ExAcquireFastMutex((<a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a>)PoolVector[PagedPool]-&gt;LockAddress);   \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00500">500</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">ExFreePoolWithTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="ex/pool.c::LOCK_POOL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LOCK_POOL          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PoolDesc,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LockHandle&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                      \
    <span class="keywordflow">if</span> ((PoolDesc-&gt;PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>) == <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>) {          \
        <a class="code" href="../../d2/d2/ex_2pool_8c.html#a31">ExpLockNonPagedPool</a>(LockHandle);                                       \
    } <span class="keywordflow">else</span> {                                                                   \
        ExAcquireFastMutex((<a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a>)PoolDesc-&gt;LockAddress);                \
    }                                                                          \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00492">492</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00413">ExAllocatePool()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00970">ExFreePool()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">ExFreePoolWithTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="ex/pool.c::LOCK_POOL_GRANULAR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LOCK_POOL_GRANULAR          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PoolDesc,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LockHandle&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00098">98</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l03480">ExReturnPoolQuota()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="ex/pool.c::MARK_POOL_HEADER_ALLOCATED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MARK_POOL_HEADER_ALLOCATED          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">POOLHEADER&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;{(POOLHEADER)-&gt;PoolIndex |= 0x80;}</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00420">420</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="ex/pool.c::MARK_POOL_HEADER_FREED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MARK_POOL_HEADER_FREED          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">POOLHEADER&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;{(POOLHEADER)-&gt;PoolIndex &amp;= 0x7f;}</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00421">421</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">ExFreePoolWithTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="ex/pool.c::MAX_BIGPAGE_TABLE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MAX_BIGPAGE_TABLE&nbsp;&nbsp;&nbsp;4096          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00345">345</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00677">InitializePool()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="ex/pool.c::MAX_TRACKER_TABLE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MAX_TRACKER_TABLE&nbsp;&nbsp;&nbsp;1025          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00344">344</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="ex/pool.c::POOL_QUOTA_ENABLED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define POOL_QUOTA_ENABLED&nbsp;&nbsp;&nbsp;(<a class="el" href="../../d9/d5/4_2kddata_8c.html#a44">PoolTrackTable</a> == NULL)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00041">41</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02607">ExAllocatePoolWithQuotaTag()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l03480">ExReturnPoolQuota()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="ex/pool.c::POOL_SPECIAL_POOL_BIT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define POOL_SPECIAL_POOL_BIT&nbsp;&nbsp;&nbsp;0x8          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00048">48</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00993">ExAllocatePoolWithTagPriority()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="ex/pool.c::POOL_SPECIAL_POOL_UNDERRUN_BIT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define POOL_SPECIAL_POOL_UNDERRUN_BIT&nbsp;&nbsp;&nbsp;0x1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00049">49</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00993">ExAllocatePoolWithTagPriority()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="ex/pool.c::PrivateInitializeListHead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PrivateInitializeListHead          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ListHead&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                     \
    (ListHead)-&gt;Flink = (ListHead)-&gt;Blink = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a9">EncodeLink</a>(ListHead))
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00128">128</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00609">ExpInitializePoolDescriptor()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="ex/pool.c::PrivateInsertHeadList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PrivateInsertHeadList          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ListHead,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Entry&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{  \
    PLIST_ENTRY _EX_Flink;                       \
    PLIST_ENTRY _EX_ListHead;                    \
    _EX_ListHead = (ListHead);                   \
    _EX_Flink = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a8">DecodeLink</a>(_EX_ListHead-&gt;Flink); \
    (Entry)-&gt;Flink = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a9">EncodeLink</a>(_EX_Flink);      \
    (Entry)-&gt;Blink = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a9">EncodeLink</a>(_EX_ListHead);   \
    _EX_Flink-&gt;Blink = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a9">EncodeLink</a>(Entry);        \
    _EX_ListHead-&gt;Flink = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a9">EncodeLink</a>(Entry);     \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00162">162</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">ExFreePoolWithTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="ex/pool.c::PrivateInsertTailList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PrivateInsertTailList          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ListHead,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Entry&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{  \
    PLIST_ENTRY _EX_Blink;                       \
    PLIST_ENTRY _EX_ListHead;                    \
    _EX_ListHead = (ListHead);                   \
    _EX_Blink = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a8">DecodeLink</a>(_EX_ListHead-&gt;Blink); \
    (Entry)-&gt;Flink = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a9">EncodeLink</a>(_EX_ListHead);   \
    (Entry)-&gt;Blink = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a9">EncodeLink</a>(_EX_Blink);      \
    _EX_Blink-&gt;Flink = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a9">EncodeLink</a>(Entry);        \
    _EX_ListHead-&gt;Blink = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a9">EncodeLink</a>(Entry);     \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00151">151</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">ExFreePoolWithTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="ex/pool.c::PrivateIsListEmpty" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PrivateIsListEmpty          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ListHead&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(DecodeLink((ListHead)-&gt;Flink) == (ListHead))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00131">131</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="ex/pool.c::PrivateRemoveEntryList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PrivateRemoveEntryList          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Entry&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{       \
    PLIST_ENTRY _EX_Blink;                    \
    PLIST_ENTRY _EX_Flink;                    \
    _EX_Flink = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a8">DecodeLink</a>((Entry)-&gt;Flink);   \
    _EX_Blink = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a8">DecodeLink</a>((Entry)-&gt;Blink);   \
    _EX_Blink-&gt;Flink = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a9">EncodeLink</a>(_EX_Flink); \
    _EX_Flink-&gt;Blink = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a9">EncodeLink</a>(_EX_Blink); \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00142">142</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">ExFreePoolWithTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="ex/pool.c::PrivateRemoveHeadList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PrivateRemoveHeadList          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ListHead&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><a class="code" href="../../d2/d2/ex_2pool_8c.html#a8">DecodeLink</a>((ListHead)-&gt;Flink);                          \
    {<a class="code" href="../../d2/d2/ex_2pool_8c.html#a14">PrivateRemoveEntryList</a>(<a class="code" href="../../d2/d2/ex_2pool_8c.html#a8">DecodeLink</a>((ListHead)-&gt;Flink))}
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00134">134</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="ex/pool.c::PrivateRemoveTailList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PrivateRemoveTailList          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ListHead&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><a class="code" href="../../d2/d2/ex_2pool_8c.html#a8">DecodeLink</a>((ListHead)-&gt;Blink);                          \
    {<a class="code" href="../../d2/d2/ex_2pool_8c.html#a14">PrivateRemoveEntryList</a>(<a class="code" href="../../d2/d2/ex_2pool_8c.html#a8">DecodeLink</a>((ListHead)-&gt;Blink))}
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00138">138</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="ex/pool.c::UNLOCK_IF_PAGED_POOL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UNLOCK_IF_PAGED_POOL          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_CheckType,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>_GlobalPool&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><span class="keywordflow">if</span> (_CheckType == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a> &amp;&amp; _GlobalPool == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {                      \
        ExReleaseFastMutex((<a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a>)PoolVector[PagedPool]-&gt;LockAddress);   \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00559">559</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">ExFreePoolWithTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="ex/pool.c::UNLOCK_POOL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UNLOCK_POOL          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PoolDesc,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LockHandle&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                    \
    <span class="keywordflow">if</span> ((PoolDesc-&gt;PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>) == <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>) {          \
        <a class="code" href="../../d2/d2/ex_2pool_8c.html#a32">ExpUnlockNonPagedPool</a>((KIRQL)LockHandle);                              \
    } <span class="keywordflow">else</span> {                                                                   \
        ExReleaseFastMutex((<a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a>)PoolDesc-&gt;LockAddress);                \
    }                                                                          \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00551">551</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00413">ExAllocatePool()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00970">ExFreePool()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">ExFreePoolWithTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="ex/pool.c::UNLOCK_POOL_GRANULAR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UNLOCK_POOL_GRANULAR          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PoolDesc,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LockHandle&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00099">99</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l03480">ExReturnPoolQuota()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a75" doxytag="ex/pool.c::ExAllocatePool" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID ExAllocatePool           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00910">910</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
<pre class="fragment"><div>00917                    :
00918 
00919     This function allocates a block of <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> and
00920     returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated block.  This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to
00921     access both <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page-aligned pools, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list head entries (less than
00922     a page) pools.
00923 
00924     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes specifies a size that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> too large to be
00925     satisfied by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate list, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page-aligned
00926     <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> allocator <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used.  The allocated block will be page-aligned
00927     and a page-sized multiple.
00928 
00929     Otherwise, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> list entry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used.  The allocated
00930     block will be 64-bit aligned, but will not be page aligned.  The
00931     <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> allocator calculates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> smallest number of POOL_BLOCK_SIZE
00932     that can be used to satisfy <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request.  If there are no blocks
00933     available of <span class="keyword">this</span> size, then a block of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next larger block size
00934     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allocated and split.  One piece <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> placed back into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>, and
00935     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> other piece <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to satisfy <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocator
00936     reaches <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> paged-sized block list, and nothing <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> there, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00937     page-aligned <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> allocator <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called.  The page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> split and added
00938     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>...
00939 
00940 Arguments:
00941 
00942     PoolType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> to allocate.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>
00943         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="stringliteral">"MustSucceed"</span> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> types, then <span class="keyword">this</span> call will
00944         always succeed and <span class="keywordflow">return</span> a pointer to allocated <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
00945         Otherwise, <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system cannot allocate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested amount
00946         of memory a <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00947 
00948         Valid <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> types:
00949 
00950         <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>
00951         <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>
00952         <a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>,
00953         <a class="code" href="../../d5/d8/ex_8h.html#a329a177">NonPagedPoolCacheAligned</a>
00954         <a class="code" href="../../d5/d8/ex_8h.html#a329a178">PagedPoolCacheAligned</a>
00955         <a class="code" href="../../d5/d8/ex_8h.html#a329a179">NonPagedPoolCacheAlignedMustS</a>
00956 
00957     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes to allocate.
00958 
00959 Return Value:
00960 
00961     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - The PoolType <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="stringliteral">"MustSucceed"</span> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> types, and
00962         not enough <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> exists to satisfy <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request.
00963 
00964     NON-<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - Returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
00965 
00966 --*/
00967 
00968 {
00969     <span class="keywordflow">return</span> <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (PoolType,
00970                                   NumberOfBytes,
00971                                   'enoN');
00972 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a89" doxytag="ex/pool.c::ExAllocatePoolSanityChecks" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ExAllocatePoolSanityChecks           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l03828">3828</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00050">BASE_POOL_TYPE_MASK</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00052">MUST_SUCCEED_POOL_TYPE_MASK</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, and <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/verifier_8c-source.html#l01812">VeAllocatePoolWithTagPriority()</a>.
<p>
<pre class="fragment"><div>03835                    :
03836 
03837     This function performs sanity checks on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
03838 
03839 Return Value:
03840 
03841     None.
03842 
03843 Environment:
03844 
03845     Only enabled as part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver verification package.
03846 
03847 --*/
03848 
03849 {
03850     <span class="keywordflow">if</span> (NumberOfBytes == 0) {
03851         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
03852                       0x0,
03853                       KeGetCurrentIrql(),
03854                       PoolType,
03855                       NumberOfBytes);
03856     }
03857 
03858     <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>) == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
03859 
03860         <span class="keywordflow">if</span> (KeGetCurrentIrql() &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) {
03861 
03862             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
03863                           0x1,
03864                           KeGetCurrentIrql(),
03865                           PoolType,
03866                           NumberOfBytes);
03867         }
03868     }
03869     <span class="keywordflow">else</span> {
03870         <span class="keywordflow">if</span> (KeGetCurrentIrql() &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
03871 
03872             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
03873                           0x2,
03874                           KeGetCurrentIrql(),
03875                           PoolType,
03876                           NumberOfBytes);
03877         }
03878     }
03879 
03880     <span class="keywordflow">if</span> (PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a6">MUST_SUCCEED_POOL_TYPE_MASK</a>) {
03881         <span class="keywordflow">if</span> (NumberOfBytes &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) {
03882             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
03883                           0x3,
03884                           KeGetCurrentIrql(),
03885                           PoolType,
03886                           NumberOfBytes);
03887         }
03888     }
03889 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a82" doxytag="ex/pool.c::ExAllocatePoolWithQuota" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID ExAllocatePoolWithQuota           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02550">2550</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
<pre class="fragment"><div>02557                    :
02558 
02559     This function allocates a block of <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>,
02560     returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated block, and <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> binary buddy
02561     allocator was used to satisfy <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request, charges <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> quota to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02562     current process.  This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to access both <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02563     page-aligned pools, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> binary buddy.
02564 
02565     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes specifies a size that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> too large to be
02566     satisfied by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate binary buddy <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02567     page-aligned <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> allocator <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used.  The allocated block will be
02568     page-aligned and a page-sized multiple.  No quota <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> charged to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02569     current process <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">case</span>.
02570 
02571     Otherwise, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate binary buddy <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used.  The allocated
02572     block will be 64-bit aligned, but will not be page aligned.  After
02573     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation completes, an attempt will be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to charge <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>
02574     quota (of the appropriate type) to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process object.  If
02575     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> quota charge succeeds, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> block's header <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> adjusted
02576     to point to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process.  The process object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not
02577     dereferenced until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> deallocated and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate
02578     amount of quota <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process.  Otherwise, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02579     deallocated, a <span class="stringliteral">"quota exceeded"</span> condition <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> raised.
02580 
02581 Arguments:
02582 
02583     PoolType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> to allocate.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>
02584         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="stringliteral">"MustSucceed"</span> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> types and sufficient quota
02585         exists, then <span class="keyword">this</span> call will always succeed and <span class="keywordflow">return</span> a pointer
02586         to allocated <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.  Otherwise, <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system cannot allocate
02587         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested amount of memory a STATUS_INSUFFICIENT_RESOURCES
02588         status <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> raised.
02589 
02590     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes to allocate.
02591 
02592 Return Value:
02593 
02594     NON-<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - Returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
02595 
02596     Unspecified - If insufficient quota exists to complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>
02597         allocation, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">return</span> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> unspecified.
02598 
02599 --*/
02600 
02601 {
02602     <span class="keywordflow">return</span> (<a class="code" href="../../d5/d8/ex_8h.html#a5">ExAllocatePoolWithQuotaTag</a> (PoolType, NumberOfBytes, 'enoN'));
02603 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a83" doxytag="ex/pool.c::ExAllocatePoolWithQuotaTag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID ExAllocatePoolWithQuotaTag           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Tag</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02607">2607</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
References <a class="el" href="../../d5/d1/pool_8h-source.html#l00050">BASE_POOL_TYPE_MASK</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00171">_POOL_HEADER::BlockSize</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00651">ExpAllocatePoolWithQuotaHandler()</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00070">KeBugCheck()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01977">MmSpecialPoolEnd</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01976">MmSpecialPoolStart</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00370">NtGlobalFlag</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00071">PAGE_ALIGNED</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00096">POOL_BLOCK_SHIFT</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00116">POOL_OVERHEAD</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00041">POOL_QUOTA_ENABLED</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00143">POOL_QUOTA_FAIL_INSTEAD_OF_RAISE</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00073">POOL_QUOTA_MASK</a>, <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00112">_POOL_HEADER::ProcessBilled</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00246">PsChargePoolQuota()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00579">PsInitialSystemProcess</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>02615                    :
02616 
02617     This function allocates a block of <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>,
02618     returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated block, and <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> binary buddy
02619     allocator was used to satisfy <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request, charges <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> quota to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02620     current process.  This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to access both <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02621     page-aligned pools, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> binary buddy.
02622 
02623     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes specifies a size that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> too large to be
02624     satisfied by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate binary buddy <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02625     page-aligned <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> allocator <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used.  The allocated block will be
02626     page-aligned and a page-sized multiple.  No quota <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> charged to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02627     current process <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">case</span>.
02628 
02629     Otherwise, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate binary buddy <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used.  The allocated
02630     block will be 64-bit aligned, but will not be page aligned.  After
02631     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation completes, an attempt will be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to charge <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>
02632     quota (of the appropriate type) to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process object.  If
02633     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> quota charge succeeds, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> block's header <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> adjusted
02634     to point to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process.  The process object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not
02635     dereferenced until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> deallocated and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate
02636     amount of quota <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process.  Otherwise, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02637     deallocated, a <span class="stringliteral">"quota exceeded"</span> condition <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> raised.
02638 
02639 Arguments:
02640 
02641     PoolType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> to allocate.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>
02642         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="stringliteral">"MustSucceed"</span> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> types and sufficient quota
02643         exists, then <span class="keyword">this</span> call will always succeed and <span class="keywordflow">return</span> a pointer
02644         to allocated <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.  Otherwise, <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system cannot allocate
02645         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested amount of memory a STATUS_INSUFFICIENT_RESOURCES
02646         status <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> raised.
02647 
02648     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes to allocate.
02649 
02650 Return Value:
02651 
02652     NON-<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - Returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
02653 
02654     Unspecified - If insufficient quota exists to complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>
02655         allocation, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">return</span> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> unspecified.
02656 
02657 --*/
02658 
02659 {
02660     PVOID p;
02661     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
02662     <a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a> Entry;
02663     LOGICAL IgnoreQuota;
02664     LOGICAL RaiseOnQuotaFailure;
02665 
02666     IgnoreQuota = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02667     RaiseOnQuotaFailure = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02668 
02669     <span class="keywordflow">if</span> ( PoolType &amp; <a class="code" href="../../d5/d8/ex_8h.html#a2">POOL_QUOTA_FAIL_INSTEAD_OF_RAISE</a> ) {
02670         RaiseOnQuotaFailure = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02671         PoolType &amp;= ~<a class="code" href="../../d5/d8/ex_8h.html#a2">POOL_QUOTA_FAIL_INSTEAD_OF_RAISE</a>;
02672     }
02673 
02674     <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d2/ex_2pool_8c.html#a0">POOL_QUOTA_ENABLED</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)
02675 <span class="preprocessor">#if i386 &amp;&amp; !FPO</span>
02676 <span class="preprocessor"></span>            || (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_KERNEL_STACK_TRACE_DB)
02677 <span class="preprocessor">#endif // i386 &amp;&amp; !FPO</span>
02678 <span class="preprocessor"></span>       ) {
02679         IgnoreQuota = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02680     } <span class="keywordflow">else</span> {
02681         PoolType = (<a class="code" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>)((UCHAR)PoolType + <a class="code" href="../../d4/d2/pool_8h.html#a11">POOL_QUOTA_MASK</a>);
02682     }
02683 
02684     p = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(PoolType, NumberOfBytes, Tag);
02685 
02686     <span class="comment">//</span>
02687     <span class="comment">// Note - NULL is page aligned.</span>
02688     <span class="comment">//</span>
02689 
02690     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d2/poolhack_8c.html#a5">PAGE_ALIGNED</a>(p) &amp;&amp; !IgnoreQuota) {
02691 
02692         <span class="keywordflow">if</span> ((p &gt;= <a class="code" href="../../d2/d1/mm_8h.html#a160">MmSpecialPoolStart</a>) &amp;&amp; (p &lt; <a class="code" href="../../d2/d1/mm_8h.html#a161">MmSpecialPoolEnd</a>)) {
02693             <span class="keywordflow">return</span> p;
02694         }
02695 
02696 <span class="preprocessor">#if POOL_CACHE_SUPPORTED</span>
02697 <span class="preprocessor"></span>
02698         <span class="comment">//</span>
02699         <span class="comment">// Align entry on pool allocation boundary.</span>
02700         <span class="comment">//</span>
02701 
02702         <span class="keywordflow">if</span> (((ULONG)p &amp; POOL_CACHE_CHECK) == 0) {
02703             Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((ULONG)p - PoolCacheSize);
02704         } <span class="keywordflow">else</span> {
02705             Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((PCH)p - <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>);
02706         }
02707 
02708 <span class="preprocessor">#else</span>
02709 <span class="preprocessor"></span>        Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((PCH)p - <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>);
02710 <span class="preprocessor">#endif //POOL_CACHE_SUPPORTED</span>
02711 <span class="preprocessor"></span>
02712         Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
02713 
02714         <span class="comment">//</span>
02715         <span class="comment">// Catch exception and back out allocation if necessary</span>
02716         <span class="comment">//</span>
02717 
02718         <span class="keywordflow">try</span> {
02719 
02720             Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o2">ProcessBilled</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02721 
02722             <span class="keywordflow">if</span> (Process != <a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>) {
02723 
02724                 <a class="code" href="../../d0/d2/psquota_8c.html#a2">PsChargePoolQuota</a>(Process,
02725                                  PoolType &amp; BASE_POOL_TYPE_MASK,
02726                                  (ULONG)(Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; POOL_BLOCK_SHIFT));
02727 
02728                 <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(Process);
02729                 Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o2">ProcessBilled</a> = Process;
02730             }
02731 
02732         } except ( <a class="code" href="../../d5/d2/poolhack_8c.html#a33">ExpAllocatePoolWithQuotaHandler</a>(GetExceptionCode(),p,RaiseOnQuotaFailure)) {
02733             <span class="keywordflow">if</span> ( RaiseOnQuotaFailure ) {
02734                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(GetExceptionCode());
02735             }
02736             <span class="keywordflow">else</span> {
02737                 p = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02738             }
02739         }
02740 
02741     } <span class="keywordflow">else</span> {
02742         <span class="keywordflow">if</span> ( !p &amp;&amp; RaiseOnQuotaFailure ) {
02743             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_INSUFFICIENT_RESOURCES);
02744         }
02745     }
02746 
02747     <span class="keywordflow">return</span> p;
02748 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a78" doxytag="ex/pool.c::ExAllocatePoolWithTag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID ExAllocatePoolWithTag           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Tag</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">1104</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00730">_GENERAL_LOOKASIDE::AllocateHits</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00205">ASSERT_ALLOCATE_IRQL</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00050">BASE_POOL_TYPE_MASK</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00171">_POOL_HEADER::BlockSize</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00141">BYTES_TO_PAGES</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00054">CACHE_ALIGNED_POOL_TYPE_MASK</a>, <a class="el" href="../../d2/d2/ex_2pool_8c.html#a38">CacheOverhead</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00173">CHECK_LIST</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00239">CHECK_LOOKASIDE_LIST</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00184">CHECK_POOL_HEADER</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00418">DECODE_POOL_INDEX</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00417">ENCODE_POOL_INDEX</a>, <a class="el" href="../../d5/d8/ex_8h.html#a242">ExInterlockedPopEntrySList()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02324">ExpAddTagForBigPages()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00853">ExpCheckSingleFilter()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02000">ExpInsertPoolTracker()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00429">ExpNumberOfPagedPools</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00452">ExpPagedPoolDescriptor</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00462">ExpPoolIndex</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00349">ExpSessionPoolDescriptor</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a330a194">HighPoolPriority</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02725">Isx86FeaturePresent</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00069">KeGetCurrentPrcb</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00987">KernelVerifier</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02709">KF_CMPXCHG8B</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00755">_NPAGED_LOOKASIDE_LIST::L</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00724">_GENERAL_LOOKASIDE::ListHead</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00100">_POOL_DESCRIPTOR::ListHeads</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00756">_NPAGED_LOOKASIDE_LIST::Lock</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00367">Lock</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00500">LOCK_IF_PAGED_POOL</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00492">LOCK_POOL</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00098">LOCK_POOL_GRANULAR</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00125">_POOL_DESCRIPTOR::LockAddress</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00420">MARK_POOL_HEADER_ALLOCATED</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00807">MiAllocatePoolPages()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00505">MiSessionPoolAllocated()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l03408">MmAllocateSpecialPool()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01975">MmSpecialPoolTag</a>, <a class="el" href="../../d1/d6/allocpag_8c.html#a38">MmSqueezeBadTags()</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00052">MUST_SUCCEED_POOL_TYPE_MASK</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00454">NonPagedPoolLock</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00110">PAGE_END</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02153">PERFINFO_ADDPOOLPAGE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02155">PERFINFO_BIGPOOLALLOC</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02170">PERFINFO_EXALLOCATEPOOLWITHTAG_DECL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02203">PERFINFO_POOLALLOC</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02204">PERFINFO_POOLALLOC_ADDR</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00096">POOL_BLOCK_SHIFT</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00117">POOL_BUDDY_MAX</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00060">POOL_DRIVER_MASK</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00068">POOL_LIST_HEADS</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00116">POOL_OVERHEAD</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00073">POOL_QUOTA_MASK</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00144">POOL_RAISE_IF_ALLOCATION_FAILURE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00115">POOL_SMALL_LISTS</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00214">POOL_SMALLEST_BLOCK</a>, <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00058">POOL_VERIFIER_MASK</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00356">PoolBigPageTable</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00119">_POOL_DESCRIPTOR::PoolIndex</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00181">_POOL_HEADER::PoolTag</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00352">PoolTrackTable</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00106">_POOL_HEADER::PoolType</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00451">PoolVector</a>, <a class="el" href="../../d4/d2/pool_8h.html#a29">PPOOL_BLOCK</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00114">PPOOL_HEADER</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00168">_POOL_HEADER::PreviousSize</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00162">PrivateInsertHeadList</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00151">PrivateInsertTailList</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00131">PrivateIsListEmpty</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00134">PrivateRemoveHeadList</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00117">ROUND_TO_PAGES</a>, <a class="el" href="../../d6/d1/ppc_2getcalr_8c-source.html#l00038">RtlGetCallersAddress()</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00120">_POOL_DESCRIPTOR::RunningAllocs</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00056">SESSION_POOL_MASK</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00727">_GENERAL_LOOKASIDE::TotalAllocates</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00123">_POOL_DESCRIPTOR::TotalBigPages</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00122">_POOL_DESCRIPTOR::TotalPages</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00559">UNLOCK_IF_PAGED_POOL</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00551">UNLOCK_POOL</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00099">UNLOCK_POOL_GRANULAR</a>, and <a class="el" href="../../d9/d5/verifier_8c.html#a58">VeAllocatePoolWithTagPriority()</a>.
<p>
<pre class="fragment"><div>01112                    :
01113 
01114     This function allocates a block of <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> and
01115     returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated block. This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to
01116     access both <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page-aligned pools and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list head entries (less
01117     than a page) pools.
01118 
01119     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes specifies a size that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> too large to be
01120     satisfied by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate list, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page-aligned <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>
01121     allocator <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used. The allocated block will be page-aligned and a
01122     page-sized multiple.
01123 
01124     Otherwise, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> list entry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used. The allocated
01125     block will be 64-bit aligned, but will not be page aligned. The
01126     <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> allocator calculates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> smallest number of POOL_BLOCK_SIZE
01127     that can be used to satisfy <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request. If there are no blocks
01128     available of <span class="keyword">this</span> size, then a block of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next larger block size
01129     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allocated and split. One piece <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> placed back into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>, and
01130     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> other piece <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to satisfy <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocator
01131     reaches <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> paged-sized block list, and nothing <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> there, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01132     page-aligned <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> allocator <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called. The page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> split and added
01133     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
01134 
01135 Arguments:
01136 
01137     PoolType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> to allocate. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>
01138         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="stringliteral">"MustSucceed"</span> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> types, then <span class="keyword">this</span> call will
01139         always succeed and <span class="keywordflow">return</span> a pointer to allocated <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>. Otherwise,
01140         <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system cannot allocate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested amount of memory a
01141         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
01142 
01143         Valid <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> types:
01144 
01145         <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>
01146         <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>
01147         <a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>,
01148         <a class="code" href="../../d5/d8/ex_8h.html#a329a177">NonPagedPoolCacheAligned</a>
01149         <a class="code" href="../../d5/d8/ex_8h.html#a329a178">PagedPoolCacheAligned</a>
01150         <a class="code" href="../../d5/d8/ex_8h.html#a329a179">NonPagedPoolCacheAlignedMustS</a>
01151 
01152     Tag - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's identifying tag.
01153 
01154     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes to allocate.
01155 
01156 Return Value:
01157 
01158     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - The PoolType <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="stringliteral">"MustSucceed"</span> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> types, and
01159         not enough <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> exists to satisfy <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request.
01160 
01161     NON-<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - Returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
01162 
01163 --*/
01164 
01165 {
01166     PVOID Block;
01167     <a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a> Entry;
01168     <a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">PNPAGED_LOOKASIDE_LIST</a> LookasideList;
01169     <a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a> NextEntry;
01170     <a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a> SplitEntry;
01171     KIRQL LockHandle;
01172     <a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">PPOOL_DESCRIPTOR</a> PoolDesc;
01173     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01174     ULONG ListNumber;
01175     ULONG NeededSize;
01176     ULONG PoolIndex;
01177     <a class="code" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> CheckType;
01178     <a class="code" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> RequestType;
01179     PLIST_ENTRY ListHead;
01180     <a class="code" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> NewPoolType;
01181     LOGICAL GlobalSpace;
01182     ULONG IsLargeSessionAllocation;
01183     PKPRCB Prcb;
01184     ULONG NumberOfPages;
01185     PVOID CallingAddress;
01186     PVOID CallersCaller;
01187 
01188 <span class="preprocessor">#if POOL_CACHE_SUPPORTED</span>
01189 <span class="preprocessor"></span>    ULONG <a class="code" href="../../d2/d2/ex_2pool_8c.html#a38">CacheOverhead</a>;
01190 <span class="preprocessor">#else</span>
01191 <span class="preprocessor"></span><span class="preprocessor">#define CacheOverhead POOL_OVERHEAD</span>
01192 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01193 <span class="preprocessor"></span>
01194     <a class="code" href="../../d2/d1/mm_8h.html#a49">PERFINFO_EXALLOCATEPOOLWITHTAG_DECL</a>();
01195 
01196 <span class="preprocessor">#ifdef _NTOSKRNL_VERIFIER_</span>
01197 <span class="preprocessor"></span>
01198     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a61">KernelVerifier</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01199 <span class="preprocessor">#if defined (_X86_)</span>
01200 <span class="preprocessor"></span>        <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a0">RtlGetCallersAddress</a>(&amp;CallingAddress, &amp;CallersCaller);
01201 <span class="preprocessor">#else</span>
01202 <span class="preprocessor"></span>        CallingAddress = (PVOID)_ReturnAddress();
01203 <span class="preprocessor">#endif</span>
01204 <span class="preprocessor"></span>
01205         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(NumberOfBytes != 0);
01206         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a19">ASSERT_ALLOCATE_IRQL</a>(PoolType, NumberOfBytes);
01207 
01208         <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a10">POOL_DRIVER_MASK</a>) == 0) {
01209 
01210             <span class="comment">//</span>
01211             <span class="comment">// Use the Driver Verifier pool framework.  Note this will</span>
01212             <span class="comment">// result in a recursive callback to this routine.</span>
01213             <span class="comment">//</span>
01214 
01215             <span class="keywordflow">return</span> <a class="code" href="../../d9/d5/verifier_8c.html#a58">VeAllocatePoolWithTagPriority</a> (PoolType | POOL_DRIVER_MASK,
01216                                                   NumberOfBytes,
01217                                                   Tag,
01218                                                   HighPoolPriority,
01219                                                   CallingAddress);
01220         }
01221         PoolType &amp;= ~<a class="code" href="../../d4/d2/pool_8h.html#a10">POOL_DRIVER_MASK</a>;
01222     }
01223 
01224 <span class="preprocessor">#else</span>
01225 <span class="preprocessor"></span>
01226     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(NumberOfBytes != 0);
01227     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a19">ASSERT_ALLOCATE_IRQL</a>(PoolType, NumberOfBytes);
01228 
01229 <span class="preprocessor">#endif</span>
01230 <span class="preprocessor"></span>
01231     <span class="comment">//</span>
01232     <span class="comment">// Isolate the base pool type and select a pool from which to allocate</span>
01233     <span class="comment">// the specified block size.</span>
01234     <span class="comment">//</span>
01235 
01236     CheckType = PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>;
01237 
01238     <span class="comment">//</span>
01239     <span class="comment">// Currently only Hydra paged pool allocations come from the per session</span>
01240     <span class="comment">// pools.  Nonpaged Hydra pool allocations still come from global pool.</span>
01241     <span class="comment">//</span>
01242 
01243     <span class="keywordflow">if</span> (PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a>) {
01244         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a40">ExpSessionPoolDescriptor</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01245 
01246             <span class="comment">//</span>
01247             <span class="comment">// Promote this down to support common binaries.</span>
01248             <span class="comment">//</span>
01249 
01250             PoolType &amp;= ~<a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a>;
01251             PoolDesc = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a54">PoolVector</a>[CheckType];
01252             GlobalSpace = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01253         }
01254         <span class="keywordflow">else</span> {
01255             GlobalSpace = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01256             <span class="keywordflow">if</span> (CheckType == <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>) {
01257                 PoolDesc = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a54">PoolVector</a>[CheckType];
01258             }
01259             <span class="keywordflow">else</span> {
01260                 PoolDesc = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a40">ExpSessionPoolDescriptor</a>;
01261             }
01262         }
01263     }
01264     <span class="keywordflow">else</span> {
01265         PoolDesc = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a54">PoolVector</a>[CheckType];
01266         GlobalSpace = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01267     }
01268 
01269     <span class="comment">//</span>
01270     <span class="comment">// Check to determine if the requested block can be allocated from one</span>
01271     <span class="comment">// of the pool lists or must be directly allocated from virtual memory.</span>
01272     <span class="comment">//</span>
01273 
01274     <span class="keywordflow">if</span> (NumberOfBytes &gt; <a class="code" href="../../d5/d2/poolhack_8c.html#a7">POOL_BUDDY_MAX</a>) {
01275 
01276         <span class="comment">//</span>
01277         <span class="comment">// The requested size is greater than the largest block maintained</span>
01278         <span class="comment">// by allocation lists.</span>
01279         <span class="comment">//</span>
01280 
01281         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((NumberOfBytes &lt;= PAGE_SIZE) ||
01282                 (ExpPagedPoolDescriptor == (<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">PPOOL_DESCRIPTOR</a>)0) ||
01283                 ((PoolType &amp; MUST_SUCCEED_POOL_TYPE_MASK) == 0));
01284 
01285         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a33">LOCK_POOL</a>(PoolDesc, LockHandle);
01286 
01287         PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o6">RunningAllocs</a> += 1;
01288 
01289         IsLargeSessionAllocation = (PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a>);
01290 
01291         RequestType = (PoolType &amp; (<a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a> | <a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a> | <a class="code" href="../../d4/d2/pool_8h.html#a9">POOL_VERIFIER_MASK</a>));
01292 
01293 RetryWithMustSucceed:
01294         Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>) <a class="code" href="../../d1/d6/allocpag_8c.html#a54">MiAllocatePoolPages</a> (RequestType,
01295                                                     NumberOfBytes,
01296                                                     IsLargeSessionAllocation);
01297 
01298         <span class="comment">//</span>
01299         <span class="comment">// Large session pool allocations are accounted for directly by</span>
01300         <span class="comment">// the memory manager so no need to call MiSessionPoolAllocated here.</span>
01301         <span class="comment">//</span>
01302 
01303         <span class="keywordflow">if</span> (Entry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01304 
01305             NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a>(NumberOfBytes);
01306             PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o8">TotalBigPages</a> += NumberOfPages;
01307 
01308             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a35">UNLOCK_POOL</a>(PoolDesc, LockHandle);
01309 
01310             <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d2/ex_2pool_8c.html#a45">PoolBigPageTable</a>) &amp;&amp; (IsLargeSessionAllocation == 0)) {
01311 
01312                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a67">ExpAddTagForBigPages</a>((PVOID)Entry,
01313                                          Tag,
01314                                          NumberOfPages) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01315                     Tag = ' GIB';
01316                 }
01317 
01318                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a65">ExpInsertPoolTracker</a> (Tag,
01319                                       (ULONG) <a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a>(NumberOfBytes),
01320                                       PoolType);
01321             }
01322 
01323         } <span class="keywordflow">else</span> {
01324             <span class="keywordflow">if</span> (PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a6">MUST_SUCCEED_POOL_TYPE_MASK</a>) {
01325                 RequestType |= <a class="code" href="../../d4/d2/pool_8h.html#a6">MUST_SUCCEED_POOL_TYPE_MASK</a>;
01326                 <span class="keywordflow">goto</span> RetryWithMustSucceed;
01327             }
01328 
01329             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a35">UNLOCK_POOL</a>(PoolDesc, LockHandle);
01330 
01331             KdPrint((<span class="stringliteral">"EX: ExAllocatePool (%p, 0x%x ) returning NULL\n"</span>,
01332                 NumberOfBytes,
01333                 PoolType));
01334 
01335             <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d5/d8/ex_8h.html#a3">POOL_RAISE_IF_ALLOCATION_FAILURE</a>) != 0) {
01336                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_INSUFFICIENT_RESOURCES);
01337             }
01338         }
01339 
01340         <a class="code" href="../../d2/d1/mm_8h.html#a34">PERFINFO_BIGPOOLALLOC</a>(PoolType, Tag, NumberOfBytes, Entry);
01341 
01342         <span class="keywordflow">return</span> Entry;
01343     }
01344 
01345     <span class="comment">//</span>
01346     <span class="comment">// The requested size is less than or equal to the size of the</span>
01347     <span class="comment">// maximum block maintained by the allocation lists.</span>
01348     <span class="comment">//</span>
01349 
01350     <a class="code" href="../../d2/d1/mm_8h.html#a82">PERFINFO_POOLALLOC</a>(PoolType, Tag, NumberOfBytes);
01351 
01352     <span class="comment">//</span>
01353     <span class="comment">// Check for a special pool tag match by actual tag.</span>
01354     <span class="comment">//</span>
01355 
01356     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a159">MmSpecialPoolTag</a> != 0 &amp;&amp; NumberOfBytes != 0) {
01357 
01358 <span class="preprocessor">#ifndef NO_POOL_CHECKS</span>
01359 <span class="preprocessor"></span>        Entry = <a class="code" href="../../d1/d6/allocpag_8c.html#a38">MmSqueezeBadTags</a> (NumberOfBytes, Tag, CheckType, 2);
01360         <span class="keywordflow">if</span> (Entry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01361             <span class="keywordflow">return</span> (PVOID)Entry;
01362         }
01363 <span class="preprocessor">#endif</span>
01364 <span class="preprocessor"></span>
01365         <span class="comment">//</span>
01366         <span class="comment">// Check for a special pool tag match by tag string and size ranges.</span>
01367         <span class="comment">//</span>
01368 
01369         <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d2/ex_2pool_8c.html#a74">ExpCheckSingleFilter</a>(Tag, MmSpecialPoolTag)) ||
01370             ((<a class="code" href="../../d2/d1/mm_8h.html#a159">MmSpecialPoolTag</a> &gt;= (NumberOfBytes + <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>)) &amp;&amp;
01371              (<a class="code" href="../../d2/d1/mm_8h.html#a159">MmSpecialPoolTag</a> &lt; (NumberOfBytes + <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a> + <a class="code" href="../../d4/d2/pool_8h.html#a20">POOL_SMALLEST_BLOCK</a>)))) {
01372 
01373             Entry = <a class="code" href="../../d1/d6/allocpag_8c.html#a60">MmAllocateSpecialPool</a> (NumberOfBytes,
01374                                            Tag,
01375                                            PoolType &amp; (BASE_POOL_TYPE_MASK | POOL_VERIFIER_MASK),
01376                                            2);
01377             <span class="keywordflow">if</span> (Entry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01378                 <span class="keywordflow">return</span> (PVOID)Entry;
01379             }
01380         }
01381     }
01382 
01383     <span class="comment">//</span>
01384     <span class="comment">// If the request is for cache aligned memory adjust the number of</span>
01385     <span class="comment">// bytes.</span>
01386     <span class="comment">//</span>
01387 
01388 <span class="preprocessor">#if POOL_CACHE_SUPPORTED</span>
01389 <span class="preprocessor"></span>
01390     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a38">CacheOverhead</a> = <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>;
01391     <span class="keywordflow">if</span> (PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a7">CACHE_ALIGNED_POOL_TYPE_MASK</a>) {
01392         NumberOfBytes += PoolCacheOverhead;
01393         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a38">CacheOverhead</a> = PoolCacheSize;
01394     }
01395 
01396 <span class="preprocessor">#endif //POOL_CACHE_SUPPORTED</span>
01397 <span class="preprocessor"></span>
01398     <span class="comment">//</span>
01399     <span class="comment">// Compute the Index of the listhead for blocks of the requested</span>
01400     <span class="comment">// size.</span>
01401     <span class="comment">//</span>
01402 
01403     ListNumber = (ULONG)((NumberOfBytes + <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a> + (<a class="code" href="../../d4/d2/pool_8h.html#a20">POOL_SMALLEST_BLOCK</a> - 1)) &gt;&gt; <a class="code" href="../../d4/d2/pool_8h.html#a14">POOL_BLOCK_SHIFT</a>);
01404 
01405     NeededSize = ListNumber;
01406 
01407     <span class="comment">//</span>
01408     <span class="comment">// If the pool type is paged, then pick a starting pool number and</span>
01409     <span class="comment">// attempt to lock each paged pool in circular succession. Otherwise,</span>
01410     <span class="comment">// lock the nonpaged pool as the same lock is used for both nonpaged</span>
01411     <span class="comment">// and nonpaged must succeed.</span>
01412     <span class="comment">//</span>
01413     <span class="comment">// N.B. The paged pool is selected in a round robin fashion using a</span>
01414     <span class="comment">//      simple counter. Note that the counter is incremented using a</span>
01415     <span class="comment">//      a noninterlocked sequence, but the pool index is never allowed</span>
01416     <span class="comment">//      to get out of range.</span>
01417     <span class="comment">//</span>
01418 
01419     <span class="keywordflow">if</span> (CheckType == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
01420 
01421         <span class="comment">//</span>
01422         <span class="comment">// If the requested pool block is a small block, then attempt to</span>
01423         <span class="comment">// allocate the requested pool from the per processor lookaside</span>
01424         <span class="comment">// list. If the attempt fails, then attempt to allocate from the</span>
01425         <span class="comment">// system lookaside list. If the attempt fails, then select a</span>
01426         <span class="comment">// pool to allocate from and allocate the block normally.</span>
01427         <span class="comment">//</span>
01428         <span class="comment">// Session space allocations do not currently use lookaside lists.</span>
01429         <span class="comment">//</span>
01430 
01431         <span class="keywordflow">if</span> ((GlobalSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp;
01432             (NeededSize &lt;= <a class="code" href="../../d0/d9/ntosdef_8h.html#a2">POOL_SMALL_LISTS</a>) &amp;&amp;
01433             (<a class="code" href="../../d5/d3/i386_8h.html#a16">Isx86FeaturePresent</a>(KF_CMPXCHG8B))) {
01434 
01435             Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
01436             LookasideList = Prcb-&gt;PPPagedLookasideList[NeededSize - 1].P;
01437             LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o3">TotalAllocates</a> += 1;
01438 
01439             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a23">CHECK_LOOKASIDE_LIST</a>(__LINE__, LookasideList, Entry);
01440 
01441             Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)
01442                 <a class="code" href="../../d5/d8/ex_8h.html#a242">ExInterlockedPopEntrySList</a> (&amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o0">ListHead</a>,
01443                                             &amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o1">Lock</a>);
01444 
01445             <span class="keywordflow">if</span> (Entry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01446                 LookasideList = Prcb-&gt;PPPagedLookasideList[NeededSize - 1].<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>;
01447                 LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o3">TotalAllocates</a> += 1;
01448 
01449                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a23">CHECK_LOOKASIDE_LIST</a>(__LINE__, LookasideList, Entry);
01450 
01451                 Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)
01452                     <a class="code" href="../../d5/d8/ex_8h.html#a242">ExInterlockedPopEntrySList</a> (&amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o0">ListHead</a>,
01453                                                 &amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o1">Lock</a>);
01454             }
01455 
01456             <span class="keywordflow">if</span> (Entry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01457 
01458                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a23">CHECK_LOOKASIDE_LIST</a>(__LINE__, LookasideList, Entry);
01459 
01460                 Entry -= 1;
01461                 LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o5">AllocateHits</a> += 1;
01462                 NewPoolType = (PoolType &amp; (<a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a> | <a class="code" href="../../d4/d2/pool_8h.html#a11">POOL_QUOTA_MASK</a> | <a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a> | <a class="code" href="../../d4/d2/pool_8h.html#a9">POOL_VERIFIER_MASK</a>)) + 1;
01463 
01464 <span class="preprocessor">#if _POOL_LOCK_GRANULAR_</span>
01465 <span class="preprocessor"></span>                PoolDesc = &amp;PoolDesc[<a class="code" href="../../d2/d2/ex_2pool_8c.html#a27">DECODE_POOL_INDEX</a>(Entry)];
01466 <span class="preprocessor">#endif</span>
01467 <span class="preprocessor"></span>
01468                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a6">LOCK_POOL_GRANULAR</a>(PoolDesc, LockHandle);
01469 
01470                 Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> = (UCHAR)NewPoolType;
01471                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a28">MARK_POOL_HEADER_ALLOCATED</a>(Entry);
01472 
01473                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a7">UNLOCK_POOL_GRANULAR</a>(PoolDesc, LockHandle);
01474 
01475                 Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o9">PoolTag</a> = Tag;
01476 
01477                 <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01478                     ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a>) == 0)) {
01479 
01480                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a65">ExpInsertPoolTracker</a> (Tag,
01481                                           Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; POOL_BLOCK_SHIFT,
01482                                           PoolType);
01483                 }
01484 
01485                 <span class="comment">//</span>
01486                 <span class="comment">// Zero out any back pointer to our internal structures</span>
01487                 <span class="comment">// to stop someone from corrupting us via an</span>
01488                 <span class="comment">// uninitialized pointer.</span>
01489                 <span class="comment">//</span>
01490 
01491                 ((PULONG)((PCHAR)Entry + <a class="code" href="../../d2/d2/ex_2pool_8c.html#a38">CacheOverhead</a>))[0] = 0;
01492 
01493                 <a class="code" href="../../d2/d1/mm_8h.html#a83">PERFINFO_POOLALLOC_ADDR</a>((PUCHAR)Entry + CacheOverhead);
01494 
01495                 <span class="keywordflow">return</span> (PUCHAR)Entry + <a class="code" href="../../d2/d2/ex_2pool_8c.html#a38">CacheOverhead</a>;
01496             }
01497         }
01498 
01499         <span class="comment">//</span>
01500         <span class="comment">// If there is more than one paged pool, then attempt to find</span>
01501         <span class="comment">// one that can be immediately locked.</span>
01502         <span class="comment">//</span>
01503 
01504         <span class="keywordflow">if</span> (GlobalSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01505 
01506             PVOID <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>;
01507 
01508             PoolIndex = 1;
01509             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a51">ExpNumberOfPagedPools</a> != PoolIndex) {
01510                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a57">ExpPoolIndex</a> += 1;
01511                 PoolIndex = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a57">ExpPoolIndex</a>;
01512                 <span class="keywordflow">if</span> (PoolIndex &gt; <a class="code" href="../../d2/d2/ex_2pool_8c.html#a51">ExpNumberOfPagedPools</a>) {
01513                     PoolIndex = 1;
01514                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a57">ExpPoolIndex</a> = 1;
01515                 }
01516 
01517                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = PoolIndex;
01518                 <span class="keywordflow">do</span> {
01519                     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> = PoolDesc[PoolIndex].<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o3">LockAddress</a>;
01520                     <span class="keywordflow">if</span> (ExTryToAcquireFastMutex((<a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a>)Lock) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01521                         PoolDesc = &amp;PoolDesc[PoolIndex];
01522                         <span class="keywordflow">goto</span> PoolLocked;
01523                     }
01524 
01525                     PoolIndex += 1;
01526                     <span class="keywordflow">if</span> (PoolIndex &gt; <a class="code" href="../../d2/d2/ex_2pool_8c.html#a51">ExpNumberOfPagedPools</a>) {
01527                         PoolIndex = 1;
01528                     }
01529 
01530                 } <span class="keywordflow">while</span> (PoolIndex != <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>);
01531             }
01532             PoolDesc = &amp;PoolDesc[PoolIndex];
01533         }
01534         <span class="keywordflow">else</span> {
01535 
01536             <span class="comment">//</span>
01537             <span class="comment">// Only one paged pool is currently available per session.</span>
01538             <span class="comment">//</span>
01539 
01540             PoolIndex = 0;
01541             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PoolDesc == ExpSessionPoolDescriptor);
01542         }
01543 
01544         <span class="comment">//</span>
01545         <span class="comment">// None of the paged pools could be conditionally locked or there</span>
01546         <span class="comment">// is only one paged pool. The first pool considered is picked as</span>
01547         <span class="comment">// the victim to wait on.</span>
01548         <span class="comment">//</span>
01549 
01550         ExAcquireFastMutex((<a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a>)PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o3">LockAddress</a>);
01551 PoolLocked:
01552 
01553         GlobalSpace = GlobalSpace;
01554 <span class="preprocessor">#if DBG</span>
01555 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (GlobalSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01556             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PoolIndex == PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o5">PoolIndex</a>);
01557         }
01558         <span class="keywordflow">else</span> {
01559             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PoolIndex == 0);
01560             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o5">PoolIndex</a> == 0);
01561         }
01562 <span class="preprocessor">#endif</span>
01563 <span class="preprocessor"></span>
01564     } <span class="keywordflow">else</span> {
01565 
01566         <span class="comment">//</span>
01567         <span class="comment">// If the requested pool block is a small block, then attempt to</span>
01568         <span class="comment">// allocate the requested pool from the per processor lookaside</span>
01569         <span class="comment">// list. If the attempt fails, then attempt to allocate from the</span>
01570         <span class="comment">// system lookaside list. If the attempt fails, then select a</span>
01571         <span class="comment">// pool to allocate from and allocate the block normally.</span>
01572         <span class="comment">//</span>
01573 
01574         <span class="keywordflow">if</span> (GlobalSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; NeededSize &lt;= <a class="code" href="../../d0/d9/ntosdef_8h.html#a2">POOL_SMALL_LISTS</a>) {
01575             Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
01576             LookasideList = Prcb-&gt;PPNPagedLookasideList[NeededSize - 1].P;
01577             LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o3">TotalAllocates</a> += 1;
01578 
01579             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a23">CHECK_LOOKASIDE_LIST</a>(__LINE__, LookasideList, 0);
01580 
01581             Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)
01582                         <a class="code" href="../../d5/d8/ex_8h.html#a242">ExInterlockedPopEntrySList</a> (&amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o0">ListHead</a>,
01583                                                     &amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o1">Lock</a>);
01584 
01585             <span class="keywordflow">if</span> (Entry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01586                 LookasideList = Prcb-&gt;PPNPagedLookasideList[NeededSize - 1].<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>;
01587                 LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o3">TotalAllocates</a> += 1;
01588 
01589                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a23">CHECK_LOOKASIDE_LIST</a>(__LINE__, LookasideList, 0);
01590 
01591                 Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)
01592                         <a class="code" href="../../d5/d8/ex_8h.html#a242">ExInterlockedPopEntrySList</a> (&amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o0">ListHead</a>,
01593                                                     &amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o1">Lock</a>);
01594             }
01595 
01596             <span class="keywordflow">if</span> (Entry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01597 
01598                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a23">CHECK_LOOKASIDE_LIST</a>(__LINE__, LookasideList, Entry);
01599 
01600                 Entry -= 1;
01601                 LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o5">AllocateHits</a> += 1;
01602                 NewPoolType = (PoolType &amp; (<a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a> | <a class="code" href="../../d4/d2/pool_8h.html#a11">POOL_QUOTA_MASK</a> | <a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a> | <a class="code" href="../../d4/d2/pool_8h.html#a9">POOL_VERIFIER_MASK</a>)) + 1;
01603 
01604                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a6">LOCK_POOL_GRANULAR</a>(PoolDesc, LockHandle);
01605 
01606                 Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> = (UCHAR)NewPoolType;
01607                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a28">MARK_POOL_HEADER_ALLOCATED</a>(Entry);
01608 
01609                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a7">UNLOCK_POOL_GRANULAR</a>(PoolDesc, LockHandle);
01610 
01611                 Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o9">PoolTag</a> = Tag;
01612 
01613                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01614 
01615                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a65">ExpInsertPoolTracker</a> (Tag,
01616                                           Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; POOL_BLOCK_SHIFT,
01617                                           PoolType);
01618                 }
01619 
01620                 <span class="comment">//</span>
01621                 <span class="comment">// Zero out any back pointer to our internal structures</span>
01622                 <span class="comment">// to stop someone from corrupting us via an</span>
01623                 <span class="comment">// uninitialized pointer.</span>
01624                 <span class="comment">//</span>
01625 
01626                 ((PULONG)((PCHAR)Entry + <a class="code" href="../../d2/d2/ex_2pool_8c.html#a38">CacheOverhead</a>))[0] = 0;
01627 
01628                 <a class="code" href="../../d2/d1/mm_8h.html#a83">PERFINFO_POOLALLOC_ADDR</a>((PUCHAR)Entry + CacheOverhead);
01629 
01630                 <span class="keywordflow">return</span> (PUCHAR)Entry + <a class="code" href="../../d2/d2/ex_2pool_8c.html#a38">CacheOverhead</a>;
01631             }
01632         }
01633 
01634         PoolIndex = 0;
01635         ExAcquireSpinLock(&amp;NonPagedPoolLock, &amp;LockHandle);
01636 
01637         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PoolIndex == PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o5">PoolIndex</a>);
01638     }
01639 
01640     <span class="comment">//</span>
01641     <span class="comment">// The following code has an outer loop and an inner loop.</span>
01642     <span class="comment">//</span>
01643     <span class="comment">// The outer loop is utilized to repeat a nonpaged must succeed</span>
01644     <span class="comment">// allocation if necessary.</span>
01645     <span class="comment">//</span>
01646     <span class="comment">// The inner loop is used to repeat an allocation attempt if there</span>
01647     <span class="comment">// are no entries in any of the pool lists.</span>
01648     <span class="comment">//</span>
01649 
01650     RequestType = PoolType &amp; (<a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a> | <a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a>);
01651 
01652     PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o6">RunningAllocs</a> += 1;
01653     ListHead = &amp;PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o4">ListHeads</a>[ListNumber];
01654 
01655     <span class="keywordflow">do</span> {
01656 
01657         <span class="comment">//</span>
01658         <span class="comment">// Attempt to allocate the requested block from the current free</span>
01659         <span class="comment">// blocks.</span>
01660         <span class="comment">//</span>
01661 
01662         <span class="keywordflow">do</span> {
01663 
01664             <span class="comment">//</span>
01665             <span class="comment">// If the list is not empty, then allocate a block from the</span>
01666             <span class="comment">// selected list.</span>
01667             <span class="comment">//</span>
01668 
01669             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a11">PrivateIsListEmpty</a>(ListHead) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01670 
01671                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>( __LINE__, ListHead, 0 );
01672                 Block = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a12">PrivateRemoveHeadList</a>(ListHead);
01673                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>( __LINE__, ListHead, 0 );
01674                 Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((PCHAR)Block - <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>);
01675 
01676                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &gt;= NeededSize);
01677 
01678                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d2/d2/ex_2pool_8c.html#a27">DECODE_POOL_INDEX</a>(Entry) == PoolIndex);
01679 
01680                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> == 0);
01681 
01682                 <span class="keywordflow">if</span> (Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> != NeededSize) {
01683 
01684                     <span class="comment">//</span>
01685                     <span class="comment">// The selected block is larger than the allocation</span>
01686                     <span class="comment">// request. Split the block and insert the remaining</span>
01687                     <span class="comment">// fragment in the appropriate list.</span>
01688                     <span class="comment">//</span>
01689                     <span class="comment">// If the entry is at the start of a page, then take</span>
01690                     <span class="comment">// the allocation from the front of the block so as</span>
01691                     <span class="comment">// to minimize fragmentation. Otherwise, take the</span>
01692                     <span class="comment">// allocation from the end of the block which may</span>
01693                     <span class="comment">// also reduce fragmentation if the block is at the</span>
01694                     <span class="comment">// end of a page.</span>
01695                     <span class="comment">//</span>
01696 
01697                     <span class="keywordflow">if</span> (Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o3">PreviousSize</a> == 0) {
01698 
01699                         <span class="comment">//</span>
01700                         <span class="comment">// The entry is at the start of a page.</span>
01701                         <span class="comment">//</span>
01702 
01703                         SplitEntry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((<a class="code" href="../../d3/d8/struct__POOL__BLOCK.html">PPOOL_BLOCK</a>)Entry + NeededSize);
01704                         SplitEntry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> = (UCHAR)(Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> - (UCHAR)NeededSize);
01705                         SplitEntry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o3">PreviousSize</a> = (UCHAR)NeededSize;
01706 
01707                         <span class="comment">//</span>
01708                         <span class="comment">// If the allocated block is not at the end of a</span>
01709                         <span class="comment">// page, then adjust the size of the next block.</span>
01710                         <span class="comment">//</span>
01711 
01712                         NextEntry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((<a class="code" href="../../d3/d8/struct__POOL__BLOCK.html">PPOOL_BLOCK</a>)SplitEntry + SplitEntry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a>);
01713                         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d2/pool_8h.html#a17">PAGE_END</a>(NextEntry) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01714                             NextEntry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o3">PreviousSize</a> = SplitEntry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a>;
01715                         }
01716 
01717                     } <span class="keywordflow">else</span> {
01718 
01719                         <span class="comment">//</span>
01720                         <span class="comment">// The entry is not at the start of a page.</span>
01721                         <span class="comment">//</span>
01722 
01723                         SplitEntry = Entry;
01724                         Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> -= (UCHAR)NeededSize;
01725                         Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((<a class="code" href="../../d3/d8/struct__POOL__BLOCK.html">PPOOL_BLOCK</a>)Entry + Entry-&gt;BlockSize);
01726                         Entry-&gt;PreviousSize = SplitEntry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a>;
01727 
01728                         <span class="comment">//</span>
01729                         <span class="comment">// If the allocated block is not at the end of a</span>
01730                         <span class="comment">// page, then adjust the size of the next block.</span>
01731                         <span class="comment">//</span>
01732 
01733                         NextEntry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((<a class="code" href="../../d3/d8/struct__POOL__BLOCK.html">PPOOL_BLOCK</a>)Entry + NeededSize);
01734                         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d2/pool_8h.html#a17">PAGE_END</a>(NextEntry) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01735                             NextEntry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o3">PreviousSize</a> = (UCHAR)NeededSize;
01736                         }
01737                     }
01738 
01739                     <span class="comment">//</span>
01740                     <span class="comment">// Set the size of the allocated entry, clear the pool</span>
01741                     <span class="comment">// type of the split entry, set the index of the split</span>
01742                     <span class="comment">// entry, and insert the split entry in the appropriate</span>
01743                     <span class="comment">// free list.</span>
01744                     <span class="comment">//</span>
01745 
01746                     Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> = (UCHAR)NeededSize;
01747                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a26">ENCODE_POOL_INDEX</a>(Entry, PoolIndex);
01748                     SplitEntry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> = 0;
01749                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a26">ENCODE_POOL_INDEX</a>(SplitEntry, PoolIndex);
01750                     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = SplitEntry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a>;
01751 
01752                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, &amp;PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o4">ListHeads</a>[Index - 1], 0);
01753                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a15">PrivateInsertTailList</a>(&amp;PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o4">ListHeads</a>[Index - 1], ((PLIST_ENTRY)((PCHAR)SplitEntry + POOL_OVERHEAD)));
01754                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, &amp;PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o4">ListHeads</a>[Index - 1], 0);
01755                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, ((PLIST_ENTRY)((PCHAR)SplitEntry + POOL_OVERHEAD)), 0);
01756                 }
01757 
01758                 Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> = (UCHAR)((PoolType &amp; (<a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a> | <a class="code" href="../../d4/d2/pool_8h.html#a11">POOL_QUOTA_MASK</a> | <a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a> | <a class="code" href="../../d4/d2/pool_8h.html#a9">POOL_VERIFIER_MASK</a>)) + 1);
01759 
01760                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a28">MARK_POOL_HEADER_ALLOCATED</a>(Entry);
01761 
01762                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a18">CHECK_POOL_HEADER</a>(__LINE__, Entry);
01763 
01764                 <span class="comment">//</span>
01765                 <span class="comment">// Notify the memory manager of session pool allocations</span>
01766                 <span class="comment">// so leaked allocations can be caught on session exit.</span>
01767                 <span class="comment">// This call must be made with the relevant pool locked.</span>
01768                 <span class="comment">//</span>
01769 
01770                 <span class="keywordflow">if</span> (PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a>) {
01771                     <a class="code" href="../../d1/d6/allocpag_8c.html#a50">MiSessionPoolAllocated</a>(
01772                         (PVOID)((PCHAR)Entry + CacheOverhead),
01773                         (ULONG)(Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; POOL_BLOCK_SHIFT),
01774                         PoolType);
01775                 }
01776 
01777                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a35">UNLOCK_POOL</a>(PoolDesc, LockHandle);
01778 
01779                 Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o9">PoolTag</a> = Tag;
01780 
01781                 <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01782                     ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a>) == 0)) {
01783 
01784                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a65">ExpInsertPoolTracker</a> (Tag,
01785                                           Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; POOL_BLOCK_SHIFT,
01786                                           PoolType);
01787                 }
01788 
01789                 <span class="comment">//</span>
01790                 <span class="comment">// Zero out any back pointer to our internal structures</span>
01791                 <span class="comment">// to stop someone from corrupting us via an</span>
01792                 <span class="comment">// uninitialized pointer.</span>
01793                 <span class="comment">//</span>
01794 
01795                 ((PULONGLONG)((PCHAR)Entry + <a class="code" href="../../d2/d2/ex_2pool_8c.html#a38">CacheOverhead</a>))[0] = 0;
01796 
01797                 <a class="code" href="../../d2/d1/mm_8h.html#a83">PERFINFO_POOLALLOC_ADDR</a>((PUCHAR)Entry + CacheOverhead);
01798                 <span class="keywordflow">return</span> (PCHAR)Entry + <a class="code" href="../../d2/d2/ex_2pool_8c.html#a38">CacheOverhead</a>;
01799 
01800             }
01801             ListHead += 1;
01802 
01803         } <span class="keywordflow">while</span> (ListHead != &amp;PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o4">ListHeads</a>[<a class="code" href="../../d5/d2/poolhack_8c.html#a2">POOL_LIST_HEADS</a>]);
01804 
01805         <span class="comment">//</span>
01806         <span class="comment">// A block of the desired size does not exist and there are</span>
01807         <span class="comment">// no large blocks that can be split to satisfy the allocation.</span>
01808         <span class="comment">// Attempt to expand the pool by allocating another page to be</span>
01809         <span class="comment">// added to the pool.</span>
01810         <span class="comment">//</span>
01811         <span class="comment">// If the pool type is paged pool, then the paged pool page lock</span>
01812         <span class="comment">// must be held during the allocation of the pool pages.</span>
01813         <span class="comment">//</span>
01814 
01815         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a34">LOCK_IF_PAGED_POOL</a>(CheckType, GlobalSpace);
01816 
01817         Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)<a class="code" href="../../d1/d6/allocpag_8c.html#a54">MiAllocatePoolPages</a> (RequestType,
01818                                                    PAGE_SIZE,
01819                                                    FALSE);
01820 
01821         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a36">UNLOCK_IF_PAGED_POOL</a>(CheckType, GlobalSpace);
01822 
01823         <span class="keywordflow">if</span> (Entry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01824             <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a6">MUST_SUCCEED_POOL_TYPE_MASK</a>) != 0) {
01825 
01826                 <span class="comment">//</span>
01827                 <span class="comment">// Must succeed pool was requested. Reset the type,</span>
01828                 <span class="comment">// the pool descriptor address, and continue the search.</span>
01829                 <span class="comment">//</span>
01830 
01831                 CheckType = <a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>;
01832                 RequestType = RequestType | <a class="code" href="../../d4/d2/pool_8h.html#a6">MUST_SUCCEED_POOL_TYPE_MASK</a>;
01833                 PoolDesc = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a54">PoolVector</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>];
01834                 ListHead = &amp;PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o4">ListHeads</a>[ListNumber];
01835                 <span class="keywordflow">continue</span>;
01836 
01837             } <span class="keywordflow">else</span> {
01838 
01839                 <span class="comment">//</span>
01840                 <span class="comment">// No more pool of the specified type is available.</span>
01841                 <span class="comment">//</span>
01842 
01843                 KdPrint((<span class="stringliteral">"EX: ExAllocatePool (%p, 0x%x ) returning NULL\n"</span>,
01844                     NumberOfBytes,
01845                     PoolType));
01846 
01847                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a35">UNLOCK_POOL</a>(PoolDesc, LockHandle);
01848 
01849                 <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d5/d8/ex_8h.html#a3">POOL_RAISE_IF_ALLOCATION_FAILURE</a>) != 0) {
01850                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_INSUFFICIENT_RESOURCES);
01851                 }
01852 
01853                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01854             }
01855         }
01856 
01857         <span class="comment">//</span>
01858         <span class="comment">// Insert the allocated page in the last allocation list.</span>
01859         <span class="comment">//</span>
01860 
01861         PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o1">TotalPages</a> += 1;
01862         Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> = 0;
01863         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a26">ENCODE_POOL_INDEX</a>(Entry, PoolIndex);
01864 
01865         <a class="code" href="../../d2/d1/mm_8h.html#a32">PERFINFO_ADDPOOLPAGE</a>(CheckType, PoolIndex, Entry, PoolDesc);
01866 
01867         <span class="comment">//</span>
01868         <span class="comment">// N.B. A byte is used to store the block size in units of the</span>
01869         <span class="comment">//      smallest block size. Therefore, if the number of small</span>
01870         <span class="comment">//      blocks in the page is greater than 255, the block size</span>
01871         <span class="comment">//      is set to 255.</span>
01872         <span class="comment">//</span>
01873 
01874         <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> / <a class="code" href="../../d4/d2/pool_8h.html#a20">POOL_SMALLEST_BLOCK</a>) &gt; 255) {
01875             Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> = 255;
01876 
01877         } <span class="keywordflow">else</span> {
01878             Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> = (UCHAR)(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> / <a class="code" href="../../d4/d2/pool_8h.html#a20">POOL_SMALLEST_BLOCK</a>);
01879         }
01880 
01881         Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o3">PreviousSize</a> = 0;
01882         ListHead = &amp;PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o4">ListHeads</a>[<a class="code" href="../../d5/d2/poolhack_8c.html#a2">POOL_LIST_HEADS</a> - 1];
01883 
01884         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, ListHead, 0);
01885         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a16">PrivateInsertHeadList</a>(ListHead, ((PLIST_ENTRY)((PCHAR)Entry + POOL_OVERHEAD)));
01886         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, ListHead, 0);
01887         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, ((PLIST_ENTRY)((PCHAR)Entry + POOL_OVERHEAD)), 0);
01888 
01889     } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01890 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a77" doxytag="ex/pool.c::ExAllocatePoolWithTagPriority" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID ExAllocatePoolWithTagPriority           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Tag</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d8/ex_8h.html#a97">EX_POOL_PRIORITY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Priority</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00993">993</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
References <a class="el" href="../../d5/d1/pool_8h-source.html#l00050">BASE_POOL_TYPE_MASK</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00349">ExpSessionPoolDescriptor</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a330a194">HighPoolPriority</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l03408">MmAllocateSpecialPool()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00589">MmResourcesAvailable()</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00052">MUST_SUCCEED_POOL_TYPE_MASK</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00117">POOL_BUDDY_MAX</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00048">POOL_SPECIAL_POOL_BIT</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00049">POOL_SPECIAL_POOL_UNDERRUN_BIT</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00058">POOL_VERIFIER_MASK</a>, and <a class="el" href="../../d5/d1/pool_8h-source.html#l00056">SESSION_POOL_MASK</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00353">IovAllocateIrp()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00686">IovpProtectedIrpAllocate()</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l01812">VeAllocatePoolWithTagPriority()</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l01115">VerifierAllocatePoolWithTagPriority()</a>, and <a class="el" href="../../d0/d5/verifier_8c-source.html#l01233">ViReservePoolAllocation()</a>.
<p>
<pre class="fragment"><div>01002                    :
01003 
01004     This function allocates a block of <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> and
01005     returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated block.  This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to
01006     access both <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page-aligned pools, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list head entries (less than
01007     a page) pools.
01008 
01009     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes specifies a size that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> too large to be
01010     satisfied by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate list, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page-aligned
01011     <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> allocator <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used.  The allocated block will be page-aligned
01012     and a page-sized multiple.
01013 
01014     Otherwise, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> list entry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used.  The allocated
01015     block will be 64-bit aligned, but will not be page aligned.  The
01016     <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> allocator calculates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> smallest number of POOL_BLOCK_SIZE
01017     that can be used to satisfy <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request.  If there are no blocks
01018     available of <span class="keyword">this</span> size, then a block of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next larger block size
01019     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allocated and split.  One piece <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> placed back into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>, and
01020     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> other piece <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to satisfy <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocator
01021     reaches <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> paged-sized block list, and nothing <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> there, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01022     page-aligned <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> allocator <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called.  The page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> split and added
01023     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>...
01024 
01025 Arguments:
01026 
01027     PoolType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> to allocate.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>
01028         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="stringliteral">"MustSucceed"</span> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> types, then <span class="keyword">this</span> call will
01029         always succeed and <span class="keywordflow">return</span> a pointer to allocated <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
01030         Otherwise, <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system cannot allocate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested amount
01031         of memory a <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
01032 
01033         Valid <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> types:
01034 
01035         <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>
01036         <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>
01037         <a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>,
01038         <a class="code" href="../../d5/d8/ex_8h.html#a329a177">NonPagedPoolCacheAligned</a>
01039         <a class="code" href="../../d5/d8/ex_8h.html#a329a178">PagedPoolCacheAligned</a>
01040         <a class="code" href="../../d5/d8/ex_8h.html#a329a179">NonPagedPoolCacheAlignedMustS</a>
01041 
01042     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes to allocate.
01043 
01044     Tag - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's identifying tag.
01045 
01046     Priority - Supplies an indication as to how important <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> that <span class="keyword">this</span>
01047                request succeed under <a class="code" href="../../d2/d3/fetypes_8h.html#a457a418">low</a> available <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> conditions.  This
01048                can also be used to specify special <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
01049 
01050 Return Value:
01051 
01052     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - The PoolType <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="stringliteral">"MustSucceed"</span> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> types, and
01053         not enough <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> exists to satisfy <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request.
01054 
01055     NON-<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - Returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
01056 
01057 --*/
01058 
01059 {
01060     PVOID Entry;
01061 
01062     <span class="keywordflow">if</span> ((Priority &amp; <a class="code" href="../../d2/d2/ex_2pool_8c.html#a1">POOL_SPECIAL_POOL_BIT</a>) &amp;&amp; (NumberOfBytes &lt;= <a class="code" href="../../d5/d2/poolhack_8c.html#a7">POOL_BUDDY_MAX</a>)) {
01063         Entry = <a class="code" href="../../d1/d6/allocpag_8c.html#a60">MmAllocateSpecialPool</a> (NumberOfBytes,
01064                                        Tag,
01065                                        PoolType &amp; (BASE_POOL_TYPE_MASK | POOL_VERIFIER_MASK),
01066                                        (Priority &amp; POOL_SPECIAL_POOL_UNDERRUN_BIT) ? 1 : 0);
01067 
01068         <span class="keywordflow">if</span> (Entry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01069             <span class="keywordflow">return</span> Entry;
01070         }
01071         Priority &amp;= ~(<a class="code" href="../../d2/d2/ex_2pool_8c.html#a1">POOL_SPECIAL_POOL_BIT</a> | <a class="code" href="../../d2/d2/ex_2pool_8c.html#a2">POOL_SPECIAL_POOL_UNDERRUN_BIT</a>);
01072     }
01073 
01074     <span class="comment">//</span>
01075     <span class="comment">// Pool and other resources can be allocated directly through the Mm</span>
01076     <span class="comment">// without the pool code knowing - so always call the Mm for the</span>
01077     <span class="comment">// up-to-date counters.</span>
01078     <span class="comment">//</span>
01079 
01080     <span class="keywordflow">if</span> ((Priority != <a class="code" href="../../d5/d8/ex_8h.html#a330a194">HighPoolPriority</a>) &amp;&amp; ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a6">MUST_SUCCEED_POOL_TYPE_MASK</a>) == 0)) {
01081 
01082         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a40">ExpSessionPoolDescriptor</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01083             PoolType &amp;= ~<a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a>;
01084         }
01085 
01086         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d6/allocpag_8c.html#a52">MmResourcesAvailable</a> (PoolType, NumberOfBytes, Priority) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01087             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01088         }
01089     }
01090 
01091     <span class="comment">//</span>
01092     <span class="comment">// There is a window between determining whether to proceed and actually</span>
01093     <span class="comment">// doing the allocation.  In this window the pool may deplete.  This is not</span>
01094     <span class="comment">// worth closing at this time.</span>
01095     <span class="comment">//</span>
01096 
01097     <span class="keywordflow">return</span> <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (PoolType,
01098                                   NumberOfBytes,
01099                                   Tag);
01100 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a84" doxytag="ex/pool.c::ExFreePool" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ExFreePool           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>P</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02751">2751</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00291">ExFreePoolWithTag</a>.
<p>
<pre class="fragment"><div>02754 {
02755     <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(P, 0);
02756     <span class="keywordflow">return</span>;
02757 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a90" doxytag="ex/pool.c::ExFreePoolSanityChecks" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ExFreePoolSanityChecks           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>P</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l03892">3892</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00050">BASE_POOL_TYPE_MASK</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00171">_POOL_HEADER::BlockSize</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00166">BYTE_OFFSET</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l02894">ExpCheckForResource()</a>, <a class="el" href="../../d1/d9/worker_8c.html#a27">ExpCheckForWorker()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00422">IS_POOL_HEADER_MARKED_ALLOCATED</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00467">KeCheckForTimer()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00437">MmDeterminePoolType()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01977">MmSpecialPoolEnd</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01976">MmSpecialPoolStart</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00071">PAGE_ALIGNED</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00096">POOL_BLOCK_SHIFT</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00116">POOL_OVERHEAD</a>, <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00075">POOL_TYPE_MASK</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00106">_POOL_HEADER::PoolType</a>, and <a class="el" href="../../d5/d1/pool_8h-source.html#l00173">_POOL_HEADER::Ulong1</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/verifier_8c-source.html#l02143">VerifierFreePoolWithTag()</a>.
<p>
<pre class="fragment"><div>03898                    :
03899 
03900     This function performs sanity checks on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
03901 
03902 Return Value:
03903 
03904     None.
03905 
03906 Environment:
03907 
03908     Only enabled as part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver verification package.
03909 
03910 --*/
03911 
03912 {
03913     <a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a> Entry;
03914     <a class="code" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType;
03915     PVOID StillQueued;
03916 
03917     <span class="keywordflow">if</span> (P &lt;= (PVOID)(MM_HIGHEST_USER_ADDRESS)) {
03918         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
03919                       0x10,
03920                       (ULONG_PTR)P,
03921                       0,
03922                       0);
03923     }
03924 
03925     <span class="keywordflow">if</span> ((P &gt;= <a class="code" href="../../d2/d1/mm_8h.html#a160">MmSpecialPoolStart</a>) &amp;&amp; (P &lt; <a class="code" href="../../d2/d1/mm_8h.html#a161">MmSpecialPoolEnd</a>)) {
03926         StillQueued = <a class="code" href="../../d3/d2/timerobj_8c.html#a9">KeCheckForTimer</a>(P, PAGE_SIZE - BYTE_OFFSET (P));
03927         <span class="keywordflow">if</span> (StillQueued != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03928             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
03929                           0x15,
03930                           (ULONG_PTR)StillQueued,
03931                           (ULONG_PTR)-1,
03932                           (ULONG_PTR)P);
03933         }
03934 
03935         <span class="comment">//</span>
03936         <span class="comment">// Check if an ERESOURCE is currently active in this memory block.</span>
03937         <span class="comment">//</span>
03938 
03939         StillQueued = <a class="code" href="../../d8/d8/ex_2resource_8c.html#a34">ExpCheckForResource</a>(P, PAGE_SIZE - BYTE_OFFSET (P));
03940         <span class="keywordflow">if</span> (StillQueued != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03941             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
03942                           0x17,
03943                           (ULONG_PTR)StillQueued,
03944                           (ULONG_PTR)-1,
03945                           (ULONG_PTR)P);
03946         }
03947 
03948         <a class="code" href="../../d1/d9/worker_8c.html#a27">ExpCheckForWorker</a> (P, PAGE_SIZE - BYTE_OFFSET (P)); <span class="comment">// bugchecks inside</span>
03949         <span class="keywordflow">return</span>;
03950     }
03951 
03952     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d2/poolhack_8c.html#a5">PAGE_ALIGNED</a>(P)) {
03953         PoolType = <a class="code" href="../../d1/d6/allocpag_8c.html#a48">MmDeterminePoolType</a>(P);
03954 
03955         <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>) == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
03956             <span class="keywordflow">if</span> (KeGetCurrentIrql() &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) {
03957                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
03958                               0x11,
03959                               KeGetCurrentIrql(),
03960                               PoolType,
03961                               (ULONG_PTR)P);
03962             }
03963         }
03964         <span class="keywordflow">else</span> {
03965             <span class="keywordflow">if</span> (KeGetCurrentIrql() &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
03966                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
03967                               0x12,
03968                               KeGetCurrentIrql(),
03969                               PoolType,
03970                               (ULONG_PTR)P);
03971             }
03972         }
03973 
03974         <span class="comment">//</span>
03975         <span class="comment">// Just check the first page.</span>
03976         <span class="comment">//</span>
03977 
03978         StillQueued = <a class="code" href="../../d3/d2/timerobj_8c.html#a9">KeCheckForTimer</a>(P, PAGE_SIZE);
03979         <span class="keywordflow">if</span> (StillQueued != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03980             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
03981                           0x15,
03982                           (ULONG_PTR)StillQueued,
03983                           PoolType,
03984                           (ULONG_PTR)P);
03985         }
03986 
03987         <span class="comment">//</span>
03988         <span class="comment">// Check if an ERESOURCE is currently active in this memory block.</span>
03989         <span class="comment">//</span>
03990 
03991         StillQueued = <a class="code" href="../../d8/d8/ex_2resource_8c.html#a34">ExpCheckForResource</a>(P, PAGE_SIZE);
03992 
03993         <span class="keywordflow">if</span> (StillQueued != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03994             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
03995                           0x17,
03996                           (ULONG_PTR)StillQueued,
03997                           PoolType,
03998                           (ULONG_PTR)P);
03999         }
04000     }
04001     <span class="keywordflow">else</span> {
04002 
04003 <span class="preprocessor">#if !defined (_WIN64)</span>
04004 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (((ULONG_PTR)P &amp; 0x17) != 0) {
04005             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
04006                           0x16,
04007                           __LINE__,
04008                           (ULONG_PTR)P,
04009                           0);
04010         }
04011 <span class="preprocessor">#endif</span>
04012 <span class="preprocessor"></span>
04013         Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((PCHAR)P - <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>);
04014 
04015         <span class="keywordflow">if</span> ((Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> &amp; <a class="code" href="../../d4/d2/pool_8h.html#a12">POOL_TYPE_MASK</a>) == 0) {
04016             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
04017                           0x13,
04018                           __LINE__,
04019                           (ULONG_PTR)Entry,
04020                           Entry-&gt;Ulong1);
04021         }
04022 
04023         PoolType = (Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> &amp; <a class="code" href="../../d4/d2/pool_8h.html#a12">POOL_TYPE_MASK</a>) - 1;
04024 
04025         <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>) == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
04026             <span class="keywordflow">if</span> (KeGetCurrentIrql() &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) {
04027                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
04028                               0x11,
04029                               KeGetCurrentIrql(),
04030                               PoolType,
04031                               (ULONG_PTR)P);
04032             }
04033         }
04034         <span class="keywordflow">else</span> {
04035             <span class="keywordflow">if</span> (KeGetCurrentIrql() &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
04036                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
04037                               0x12,
04038                               KeGetCurrentIrql(),
04039                               PoolType,
04040                               (ULONG_PTR)P);
04041             }
04042         }
04043 
04044         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d2/ex_2pool_8c.html#a30">IS_POOL_HEADER_MARKED_ALLOCATED</a>(Entry)) {
04045             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
04046                           0x14,
04047                           __LINE__,
04048                           (ULONG_PTR)Entry,
04049                           0);
04050         }
04051         StillQueued = <a class="code" href="../../d3/d2/timerobj_8c.html#a9">KeCheckForTimer</a>(Entry, (ULONG)(Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; POOL_BLOCK_SHIFT));
04052         <span class="keywordflow">if</span> (StillQueued != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04053             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
04054                           0x15,
04055                           (ULONG_PTR)StillQueued,
04056                           PoolType,
04057                           (ULONG_PTR)P);
04058         }
04059 
04060         <span class="comment">//</span>
04061         <span class="comment">// Check if an ERESOURCE is currently active in this memory block.</span>
04062         <span class="comment">//</span>
04063 
04064         StillQueued = <a class="code" href="../../d8/d8/ex_2resource_8c.html#a34">ExpCheckForResource</a>(Entry, (ULONG)(Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; POOL_BLOCK_SHIFT));
04065 
04066         <span class="keywordflow">if</span> (StillQueued != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04067             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
04068                           0x17,
04069                           (ULONG_PTR)StillQueued,
04070                           PoolType,
04071                           (ULONG_PTR)P);
04072         }
04073     }
04074 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a85" doxytag="ex/pool.c::ExFreePoolWithTag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ExFreePoolWithTag           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>P</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>TagToFree</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">2760</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00217">ASSERT_FREE_IRQL</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00229">ASSERT_POOL_NOT_FREE</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00234">ASSERT_POOL_TYPE_NOT_ZERO</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00050">BASE_POOL_TYPE_MASK</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00171">_POOL_HEADER::BlockSize</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00173">CHECK_LIST</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00239">CHECK_LOOKASIDE_LIST</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00184">CHECK_POOL_HEADER</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00418">DECODE_POOL_INDEX</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00125">DecodeLink</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00725">_GENERAL_LOOKASIDE::Depth</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00417">ENCODE_POOL_INDEX</a>, <a class="el" href="../../d5/d8/ex_8h.html#a243">ExInterlockedPushEntrySList()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02461">ExpFindAndRemoveTagBigPages()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02231">ExpRemovePoolTracker()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00349">ExpSessionPoolDescriptor</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00637">ExQueryDepthSList</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00072">FREE_CHECK_ERESOURCE</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00073">FREE_CHECK_KTIMER</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00074">FREE_CHECK_WORKER</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00736">_GENERAL_LOOKASIDE::FreeHits</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00422">IS_POOL_HEADER_MARKED_ALLOCATED</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02725">Isx86FeaturePresent</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00069">KeGetCurrentPrcb</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02709">KF_CMPXCHG8B</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00755">_NPAGED_LOOKASIDE_LIST::L</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00724">_GENERAL_LOOKASIDE::ListHead</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00100">_POOL_DESCRIPTOR::ListHeads</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00756">_NPAGED_LOOKASIDE_LIST::Lock</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00500">LOCK_IF_PAGED_POOL</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00492">LOCK_POOL</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00421">MARK_POOL_HEADER_FREED</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l01778">MiFreePoolPages()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00547">MiSessionPoolFreed()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00437">MmDeterminePoolType()</a>, <a class="el" href="../../d1/d6/allocpag_8c.html#a41">MmFreeSpecialPool()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01977">MmSpecialPoolEnd</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01976">MmSpecialPoolStart</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00071">PAGE_ALIGNED</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00110">PAGE_END</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a182">PagedPoolSession</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02171">PERFINFO_EXFREEPOOLWITHTAG_DECL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02172">PERFINFO_FREEPOOL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02173">PERFINFO_FREEPOOLPAGE</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00096">POOL_BLOCK_SHIFT</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00116">POOL_OVERHEAD</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00073">POOL_QUOTA_MASK</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00115">POOL_SMALL_LISTS</a>, <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00075">POOL_TYPE_MASK</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00058">POOL_VERIFIER_MASK</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00119">_POOL_DESCRIPTOR::PoolIndex</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00181">_POOL_HEADER::PoolTag</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00352">PoolTrackTable</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00106">_POOL_HEADER::PoolType</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00451">PoolVector</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00168">_POOL_HEADER::PreviousSize</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00162">PrivateInsertHeadList</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00151">PrivateInsertTailList</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00142">PrivateRemoveEntryList</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00112">_POOL_HEADER::ProcessBilled</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00281">PROTECTED_POOL</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00356">PsReturnPoolQuota()</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00121">_POOL_DESCRIPTOR::RunningDeAllocs</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00056">SESSION_POOL_MASK</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00123">_POOL_DESCRIPTOR::TotalBigPages</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00733">_GENERAL_LOOKASIDE::TotalFrees</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00122">_POOL_DESCRIPTOR::TotalPages</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00559">UNLOCK_IF_PAGED_POOL</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00551">UNLOCK_POOL</a>, and <a class="el" href="../../d9/d5/verifier_8c.html#a91">VerifierFreeTrackedPool()</a>.
<p>
<pre class="fragment"><div>02764 {
02765 
02766 <span class="comment">/*++</span>
02767 <span class="comment"></span>
02768 <span class="comment">Routine Description:</span>
02769 <span class="comment"></span>
02770 <span class="comment">    This function deallocates a block of pool. This function is used to</span>
02771 <span class="comment">    deallocate to both the page aligned pools and the buddy (less than</span>
02772 <span class="comment">    a page) pools.</span>
02773 <span class="comment"></span>
02774 <span class="comment">    If the address of the block being deallocated is page-aligned, then</span>
02775 <span class="comment">    the page-aligned pool deallocator is used.</span>
02776 <span class="comment"></span>
02777 <span class="comment">    Otherwise, the binary buddy pool deallocator is used.  Deallocation</span>
02778 <span class="comment">    looks at the allocated block's pool header to determine the pool</span>
02779 <span class="comment">    type and block size being deallocated.  If the pool was allocated</span>
02780 <span class="comment">    using ExAllocatePoolWithQuota, then after the deallocation is</span>
02781 <span class="comment">    complete, the appropriate process's pool quota is adjusted to reflect</span>
02782 <span class="comment">    the deallocation, and the process object is dereferenced.</span>
02783 <span class="comment"></span>
02784 <span class="comment">Arguments:</span>
02785 <span class="comment"></span>
02786 <span class="comment">    P - Supplies the address of the block of pool being deallocated.</span>
02787 <span class="comment"></span>
02788 <span class="comment">Return Value:</span>
02789 <span class="comment"></span>
02790 <span class="comment">    None.</span>
02791 <span class="comment"></span>
02792 <span class="comment">--*/</span>
02793 
02794     <a class="code" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> CheckType;
02795     <a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a> Entry;
02796     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02797     KIRQL LockHandle;
02798     <a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">PNPAGED_LOOKASIDE_LIST</a> LookasideList;
02799     <a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a> NextEntry;
02800     ULONG PoolIndex;
02801     <a class="code" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType;
02802     <a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">PPOOL_DESCRIPTOR</a> PoolDesc;
02803     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessBilled;
02804     LOGICAL Combined;
02805     ULONG BigPages;
02806     ULONG Tag;
02807     LOGICAL GlobalSpace;
02808     PKPRCB Prcb;
02809     <a class="code" href="../../d2/d1/mm_8h.html#a50">PERFINFO_EXFREEPOOLWITHTAG_DECL</a>();
02810 
02811     <a class="code" href="../../d2/d1/mm_8h.html#a51">PERFINFO_FREEPOOL</a>(P);
02812 
02813     <span class="keywordflow">if</span> ((P &gt;= <a class="code" href="../../d2/d1/mm_8h.html#a160">MmSpecialPoolStart</a>) &amp;&amp; (P &lt; <a class="code" href="../../d2/d1/mm_8h.html#a161">MmSpecialPoolEnd</a>)) {
02814         <a class="code" href="../../d1/d6/allocpag_8c.html#a41">MmFreeSpecialPool</a> (P);
02815         <span class="keywordflow">return</span>;
02816     }
02817 
02818     ProcessBilled = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02819 
02820     <span class="comment">//</span>
02821     <span class="comment">// If entry is page aligned, then call free block to the page aligned</span>
02822     <span class="comment">// pool. Otherwise, free the block to the allocation lists.</span>
02823     <span class="comment">//</span>
02824 
02825     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d2/poolhack_8c.html#a5">PAGE_ALIGNED</a>(P)) {
02826 
02827         PoolType = <a class="code" href="../../d1/d6/allocpag_8c.html#a48">MmDeterminePoolType</a>(P);
02828 
02829         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a20">ASSERT_FREE_IRQL</a>(PoolType, P);
02830 
02831         CheckType = PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>;
02832 
02833         <span class="keywordflow">if</span> (PoolType == <a class="code" href="../../d5/d8/ex_8h.html#a329a182">PagedPoolSession</a>) {
02834             PoolDesc = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a40">ExpSessionPoolDescriptor</a>;
02835         }
02836         <span class="keywordflow">else</span> {
02837             PoolDesc = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a54">PoolVector</a>[PoolType];
02838         }
02839 
02840         <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (PoolType != <a class="code" href="../../d5/d8/ex_8h.html#a329a182">PagedPoolSession</a>)) {
02841             Tag = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a68">ExpFindAndRemoveTagBigPages</a>(P);
02842         }
02843 
02844         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a33">LOCK_POOL</a>(PoolDesc, LockHandle);
02845 
02846         PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o7">RunningDeAllocs</a> += 1;
02847 
02848         <span class="comment">//</span>
02849         <span class="comment">// Large session pool allocations are accounted for directly by</span>
02850         <span class="comment">// the memory manager so no need to call MiSessionPoolFreed here.</span>
02851         <span class="comment">//</span>
02852 
02853         BigPages = <a class="code" href="../../d1/d6/allocpag_8c.html#a55">MiFreePoolPages</a>(P);
02854 
02855         <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (PoolType != <a class="code" href="../../d5/d8/ex_8h.html#a329a182">PagedPoolSession</a>)) {
02856             <span class="keywordflow">if</span> (Tag &amp; <a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>) {
02857                 Tag &amp;= ~<a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>;
02858                 TagToFree &amp;= ~<a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>;
02859                 <span class="keywordflow">if</span> (Tag != TagToFree) {
02860                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"EX: Invalid attempt to free protected pool block %x (%c%c%c%c)\n"</span>,
02861                               P,
02862                               Tag,
02863                               Tag &gt;&gt; 8,
02864                               Tag &gt;&gt; 16,
02865                               Tag &gt;&gt; 24
02866                             );
02867                     DbgBreakPoint();
02868                 }
02869             }
02870 
02871             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a66">ExpRemovePoolTracker</a>(Tag,
02872                                  BigPages * PAGE_SIZE,
02873                                  PoolType);
02874         }
02875 
02876         <span class="comment">//</span>
02877         <span class="comment">// Check if an ERESOURCE is currently active in this memory block.</span>
02878         <span class="comment">//</span>
02879 
02880         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a3">FREE_CHECK_ERESOURCE</a> (P, BigPages &lt;&lt; PAGE_SHIFT);
02881 
02882         <span class="comment">//</span>
02883         <span class="comment">// Check if a KTIMER is currently active in this memory block</span>
02884         <span class="comment">//</span>
02885 
02886         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a4">FREE_CHECK_KTIMER</a>(P, BigPages &lt;&lt; PAGE_SHIFT);
02887 
02888         <span class="comment">//</span>
02889         <span class="comment">// Search worker queues for work items still queued</span>
02890         <span class="comment">//</span>
02891         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a5">FREE_CHECK_WORKER</a>(P, BigPages &lt;&lt; PAGE_SHIFT);
02892 
02893         PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o8">TotalBigPages</a> -= BigPages;
02894 
02895         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a35">UNLOCK_POOL</a>(PoolDesc, LockHandle);
02896 
02897         <span class="keywordflow">return</span>;
02898     }
02899 
02900     <span class="comment">//</span>
02901     <span class="comment">// Align the entry address to a pool allocation boundary.</span>
02902     <span class="comment">//</span>
02903 
02904 <span class="preprocessor">#if POOL_CACHE_SUPPORTED</span>
02905 <span class="preprocessor"></span>
02906     <span class="keywordflow">if</span> (((ULONG)P &amp; POOL_CACHE_CHECK) == 0) {
02907         Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((ULONG)P - PoolCacheSize);
02908 
02909     } <span class="keywordflow">else</span> {
02910         Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((PCHAR)P - <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>);
02911     }
02912 
02913 <span class="preprocessor">#else</span>
02914 <span class="preprocessor"></span>
02915     Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((PCHAR)P - <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>);
02916 
02917 <span class="preprocessor">#endif //POOL_CACHE_SUPPORTED</span>
02918 <span class="preprocessor"></span>
02919     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a21">ASSERT_POOL_NOT_FREE</a>(Entry);
02920 
02921     PoolType = (Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> &amp; <a class="code" href="../../d4/d2/pool_8h.html#a12">POOL_TYPE_MASK</a>) - 1;
02922 
02923     CheckType = PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>;
02924 
02925     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a20">ASSERT_FREE_IRQL</a>(PoolType, P);
02926 
02927     <span class="keywordflow">if</span> (Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> &amp; <a class="code" href="../../d4/d2/pool_8h.html#a9">POOL_VERIFIER_MASK</a>) {
02928         <a class="code" href="../../d9/d5/verifier_8c.html#a91">VerifierFreeTrackedPool</a> (P,
02929                                  Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; POOL_BLOCK_SHIFT,
02930                                  CheckType,
02931                                  FALSE);
02932     }
02933 
02934     PoolDesc = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a54">PoolVector</a>[PoolType];
02935     GlobalSpace = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02936 
02937     <span class="keywordflow">if</span> (Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> &amp; <a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a>) {
02938         <span class="keywordflow">if</span> (CheckType == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
02939             PoolDesc = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a40">ExpSessionPoolDescriptor</a>;
02940         }
02941         GlobalSpace = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02942     }
02943     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CheckType == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
02944         PoolDesc = &amp;PoolDesc[<a class="code" href="../../d2/d2/ex_2pool_8c.html#a27">DECODE_POOL_INDEX</a>(Entry)];
02945     }
02946 
02947     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a33">LOCK_POOL</a>(PoolDesc, LockHandle);
02948 
02949     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d2/ex_2pool_8c.html#a30">IS_POOL_HEADER_MARKED_ALLOCATED</a>(Entry)) {
02950         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (BAD_POOL_CALLER, 7, __LINE__, (ULONG_PTR)Entry, (ULONG_PTR)P);
02951     }
02952 
02953     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a29">MARK_POOL_HEADER_FREED</a>(Entry);
02954 
02955     <span class="comment">//</span>
02956     <span class="comment">// If this allocation was in session space, let the memory</span>
02957     <span class="comment">// manager know to delete it so it won't be considered in use on</span>
02958     <span class="comment">// session exit.  Note this call must be made with the</span>
02959     <span class="comment">// relevant pool still locked.</span>
02960     <span class="comment">//</span>
02961 
02962     <span class="keywordflow">if</span> (GlobalSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02963         <a class="code" href="../../d1/d6/allocpag_8c.html#a51">MiSessionPoolFreed</a>(P, Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; POOL_BLOCK_SHIFT, CheckType);
02964     }
02965 
02966     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a35">UNLOCK_POOL</a>(PoolDesc, LockHandle);
02967 
02968     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a22">ASSERT_POOL_TYPE_NOT_ZERO</a>(Entry);
02969 
02970     <span class="comment">//</span>
02971     <span class="comment">// Check if an ERESOURCE is currently active in this memory block.</span>
02972     <span class="comment">//</span>
02973 
02974     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a3">FREE_CHECK_ERESOURCE</a> (Entry, (ULONG)(Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; POOL_BLOCK_SHIFT));
02975 
02976     <span class="comment">//</span>
02977     <span class="comment">// Check if a KTIMER is currently active in this memory block.</span>
02978     <span class="comment">//</span>
02979 
02980     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a4">FREE_CHECK_KTIMER</a>(Entry, (ULONG)(Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; POOL_BLOCK_SHIFT));
02981 
02982     <span class="comment">//</span>
02983     <span class="comment">// Look for work items still queued</span>
02984     <span class="comment">//</span>
02985 
02986     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a5">FREE_CHECK_WORKER</a>(Entry, (ULONG)(Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; POOL_BLOCK_SHIFT));
02987 
02988 
02989 <span class="preprocessor">#if DBG</span>
02990 <span class="preprocessor"></span>
02991     <span class="comment">//</span>
02992     <span class="comment">// Check if the pool index field is defined correctly.</span>
02993     <span class="comment">//</span>
02994 
02995     <span class="keywordflow">if</span> (CheckType == <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>) {
02996         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a27">DECODE_POOL_INDEX</a>(Entry) != 0) {
02997             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(BAD_POOL_CALLER, 2, (ULONG_PTR)Entry, (ULONG_PTR)(*(PULONG)Entry), 0);
02998         }
02999     }
03000     <span class="keywordflow">else</span> {
03001         <span class="keywordflow">if</span> (GlobalSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03002             <span class="comment">//</span>
03003             <span class="comment">// All session space allocations have an index of 0.</span>
03004             <span class="comment">//</span>
03005             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a27">DECODE_POOL_INDEX</a>(Entry) == 0);
03006         }
03007         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a27">DECODE_POOL_INDEX</a>(Entry) == 0) {
03008             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(BAD_POOL_CALLER, 4, (ULONG_PTR)Entry, *(PULONG)Entry, 0);
03009         }
03010     }
03011 
03012 <span class="preprocessor">#endif // DBG</span>
03013 <span class="preprocessor"></span>
03014     <span class="comment">//</span>
03015     <span class="comment">// If pool tagging is enabled, then update the pool tracking database.</span>
03016     <span class="comment">// Otherwise, check to determine if quota was charged when the pool</span>
03017     <span class="comment">// block was allocated.</span>
03018     <span class="comment">//</span>
03019 
03020 <span class="preprocessor">#if defined (_WIN64)</span>
03021 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Entry-&gt;PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a11">POOL_QUOTA_MASK</a>) {
03022         ProcessBilled = Entry-&gt;ProcessBilled;
03023     }
03024 
03025     Tag = Entry-&gt;PoolTag;
03026     <span class="keywordflow">if</span> (Tag &amp; <a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>) {
03027         Tag &amp;= ~<a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>;
03028         TagToFree &amp;= ~<a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>;
03029         <span class="keywordflow">if</span> (Tag != TagToFree) {
03030             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"EX: Invalid attempt to free protected pool block %x (%c%c%c%c)\n"</span>,
03031                       P,
03032                       Tag,
03033                       Tag &gt;&gt; 8,
03034                       Tag &gt;&gt; 16,
03035                       Tag &gt;&gt; 24
03036                     );
03037             DbgBreakPoint();
03038         }
03039     }
03040     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03041         <span class="keywordflow">if</span> (GlobalSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03042             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a66">ExpRemovePoolTracker</a>(Tag,
03043                                  Entry-&gt;BlockSize &lt;&lt; POOL_BLOCK_SHIFT,
03044                                  PoolType);
03045 
03046         }
03047     }
03048     <span class="keywordflow">if</span> (ProcessBilled != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03049         <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>(ProcessBilled,
03050                           PoolType &amp; BASE_POOL_TYPE_MASK,
03051                           (ULONG)Entry-&gt;BlockSize &lt;&lt; POOL_BLOCK_SHIFT);
03052         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(ProcessBilled);
03053     }
03054 <span class="preprocessor">#else</span>
03055 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Entry-&gt;PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a11">POOL_QUOTA_MASK</a>) {
03056         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03057             ProcessBilled = Entry-&gt;ProcessBilled;
03058             Entry-&gt;PoolTag = 'atoQ';
03059         }
03060     }
03061 
03062     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03063         Tag = Entry-&gt;PoolTag;
03064         <span class="keywordflow">if</span> (Tag &amp; <a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>) {
03065             Tag &amp;= ~<a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>;
03066             TagToFree &amp;= ~<a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>;
03067             <span class="keywordflow">if</span> (Tag != TagToFree) {
03068                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"EX: Invalid attempt to free protected pool block %x (%c%c%c%c)\n"</span>,
03069                           P,
03070                           Tag,
03071                           Tag &gt;&gt; 8,
03072                           Tag &gt;&gt; 16,
03073                           Tag &gt;&gt; 24
03074                         );
03075                 DbgBreakPoint();
03076             }
03077         }
03078         <span class="keywordflow">if</span> (GlobalSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03079             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a66">ExpRemovePoolTracker</a>(Tag,
03080                                  Entry-&gt;BlockSize &lt;&lt; POOL_BLOCK_SHIFT ,
03081                                  PoolType);
03082         }
03083     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ProcessBilled != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03084         <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>(ProcessBilled,
03085                           PoolType &amp; BASE_POOL_TYPE_MASK,
03086                           (ULONG)Entry-&gt;BlockSize &lt;&lt; POOL_BLOCK_SHIFT);
03087         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(ProcessBilled);
03088     }
03089 <span class="preprocessor">#endif</span>
03090 <span class="preprocessor"></span>
03091     <span class="comment">//</span>
03092     <span class="comment">// If the pool block is a small block, then attempt to free the block</span>
03093     <span class="comment">// to the single entry lookaside list. If the free attempt fails, then</span>
03094     <span class="comment">// free the block by merging it back into the pool data structures.</span>
03095     <span class="comment">//</span>
03096 
03097     PoolIndex = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a27">DECODE_POOL_INDEX</a>(Entry);
03098 
03099     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = Entry-&gt;BlockSize;
03100 
03101     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt;= <a class="code" href="../../d0/d9/ntosdef_8h.html#a2">POOL_SMALL_LISTS</a> &amp;&amp; GlobalSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03102 
03103         <span class="comment">//</span>
03104         <span class="comment">// Attempt to free the small block to a per processor lookaside</span>
03105         <span class="comment">// list.</span>
03106         <span class="comment">//</span>
03107 
03108         <span class="keywordflow">if</span> (CheckType == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
03109             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d3/i386_8h.html#a16">Isx86FeaturePresent</a>(KF_CMPXCHG8B)) {
03110                 Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
03111                 LookasideList = Prcb-&gt;PPPagedLookasideList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - 1].P;
03112                 LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o6">TotalFrees</a> += 1;
03113 
03114                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a23">CHECK_LOOKASIDE_LIST</a>(__LINE__, LookasideList, P);
03115 
03116                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d8/ex_8h.html#a10">ExQueryDepthSList</a>(&amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o0">ListHead</a>) &lt; LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o1">Depth</a>) {
03117                     LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o8">FreeHits</a> += 1;
03118                     Entry += 1;
03119                     <a class="code" href="../../d5/d8/ex_8h.html#a243">ExInterlockedPushEntrySList</a>(&amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o0">ListHead</a>,
03120                                                 (PSINGLE_LIST_ENTRY)Entry,
03121                                                 &amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o1">Lock</a>);
03122 
03123                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a23">CHECK_LOOKASIDE_LIST</a>(__LINE__, LookasideList, P);
03124 
03125                     <span class="keywordflow">return</span>;
03126 
03127                 } <span class="keywordflow">else</span> {
03128                     LookasideList = Prcb-&gt;PPPagedLookasideList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - 1].<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>;
03129                     LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o6">TotalFrees</a> += 1;
03130 
03131                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a23">CHECK_LOOKASIDE_LIST</a>(__LINE__, LookasideList, P);
03132 
03133                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d8/ex_8h.html#a10">ExQueryDepthSList</a>(&amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o0">ListHead</a>) &lt; LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o1">Depth</a>) {
03134                         LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o8">FreeHits</a> += 1;
03135                         Entry += 1;
03136                         <a class="code" href="../../d5/d8/ex_8h.html#a243">ExInterlockedPushEntrySList</a>(&amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o0">ListHead</a>,
03137                                                     (PSINGLE_LIST_ENTRY)Entry,
03138                                                     &amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o1">Lock</a>);
03139 
03140                         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a23">CHECK_LOOKASIDE_LIST</a>(__LINE__, LookasideList, P);
03141 
03142                         <span class="keywordflow">return</span>;
03143                     }
03144                 }
03145             }
03146 
03147         } <span class="keywordflow">else</span> {
03148 
03149             <span class="comment">//</span>
03150             <span class="comment">// Make sure we don't put a must succeed buffer into the</span>
03151             <span class="comment">// regular nonpaged pool list.</span>
03152             <span class="comment">//</span>
03153 
03154             <span class="keywordflow">if</span> (PoolType != <a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>) {
03155                 Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
03156                 LookasideList = Prcb-&gt;PPNPagedLookasideList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - 1].P;
03157                 LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o6">TotalFrees</a> += 1;
03158 
03159                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a23">CHECK_LOOKASIDE_LIST</a>(__LINE__, LookasideList, P);
03160 
03161                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d8/ex_8h.html#a10">ExQueryDepthSList</a>(&amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o0">ListHead</a>) &lt; LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o1">Depth</a>) {
03162                     LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o8">FreeHits</a> += 1;
03163                     Entry += 1;
03164                     <a class="code" href="../../d5/d8/ex_8h.html#a243">ExInterlockedPushEntrySList</a>(&amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o0">ListHead</a>,
03165                                                 (PSINGLE_LIST_ENTRY)Entry,
03166                                                 &amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o1">Lock</a>);
03167 
03168                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a23">CHECK_LOOKASIDE_LIST</a>(__LINE__, LookasideList, P);
03169 
03170                     <span class="keywordflow">return</span>;
03171 
03172                 } <span class="keywordflow">else</span> {
03173                     LookasideList = Prcb-&gt;PPNPagedLookasideList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - 1].<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>;
03174                     LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o6">TotalFrees</a> += 1;
03175 
03176                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a23">CHECK_LOOKASIDE_LIST</a>(__LINE__, LookasideList, P);
03177 
03178                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d8/ex_8h.html#a10">ExQueryDepthSList</a>(&amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o0">ListHead</a>) &lt; LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o1">Depth</a>) {
03179                         LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o8">FreeHits</a> += 1;
03180                         Entry += 1;
03181                         <a class="code" href="../../d5/d8/ex_8h.html#a243">ExInterlockedPushEntrySList</a>(&amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o0">ListHead</a>,
03182                                                     (PSINGLE_LIST_ENTRY)Entry,
03183                                                     &amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o1">Lock</a>);
03184 
03185                         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a23">CHECK_LOOKASIDE_LIST</a>(__LINE__, LookasideList, P);
03186 
03187                         <span class="keywordflow">return</span>;
03188                     }
03189                 }
03190             }
03191         }
03192     }
03193 
03194     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PoolIndex == PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o5">PoolIndex</a>);
03195 
03196     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a33">LOCK_POOL</a>(PoolDesc, LockHandle);
03197 
03198     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a18">CHECK_POOL_HEADER</a>(__LINE__, Entry);
03199 
03200     PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o7">RunningDeAllocs</a> += 1;
03201 
03202     <span class="comment">//</span>
03203     <span class="comment">// Free the specified pool block.</span>
03204     <span class="comment">//</span>
03205     <span class="comment">// Check to see if the next entry is free.</span>
03206     <span class="comment">//</span>
03207 
03208     Combined = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03209     NextEntry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((<a class="code" href="../../d3/d8/struct__POOL__BLOCK.html">PPOOL_BLOCK</a>)Entry + Entry-&gt;BlockSize);
03210     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d2/pool_8h.html#a17">PAGE_END</a>(NextEntry) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03211 
03212         <span class="keywordflow">if</span> (NextEntry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> == 0) {
03213 
03214             <span class="comment">//</span>
03215             <span class="comment">// This block is free, combine with the released block.</span>
03216             <span class="comment">//</span>
03217 
03218             Combined = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03219 
03220             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, ((PLIST_ENTRY)((PCHAR)NextEntry + POOL_OVERHEAD)), P);
03221             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a14">PrivateRemoveEntryList</a>(((PLIST_ENTRY)((PCHAR)NextEntry + POOL_OVERHEAD)));
03222             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, <a class="code" href="../../d2/d2/ex_2pool_8c.html#a8">DecodeLink</a>(((PLIST_ENTRY)((PCHAR)NextEntry + POOL_OVERHEAD))-&gt;Flink), P);
03223             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, <a class="code" href="../../d2/d2/ex_2pool_8c.html#a8">DecodeLink</a>(((PLIST_ENTRY)((PCHAR)NextEntry + POOL_OVERHEAD))-&gt;Blink), P);
03224 
03225             Entry-&gt;BlockSize += NextEntry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a>;
03226         }
03227     }
03228 
03229     <span class="comment">//</span>
03230     <span class="comment">// Check to see if the previous entry is free.</span>
03231     <span class="comment">//</span>
03232 
03233     <span class="keywordflow">if</span> (Entry-&gt;PreviousSize != 0) {
03234         NextEntry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((<a class="code" href="../../d3/d8/struct__POOL__BLOCK.html">PPOOL_BLOCK</a>)Entry - Entry-&gt;PreviousSize);
03235         <span class="keywordflow">if</span> (NextEntry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> == 0) {
03236 
03237             <span class="comment">//</span>
03238             <span class="comment">// This block is free, combine with the released block.</span>
03239             <span class="comment">//</span>
03240 
03241             Combined = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03242 
03243             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, ((PLIST_ENTRY)((PCHAR)NextEntry + POOL_OVERHEAD)), P);
03244             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a14">PrivateRemoveEntryList</a>(((PLIST_ENTRY)((PCHAR)NextEntry + POOL_OVERHEAD)));
03245             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, <a class="code" href="../../d2/d2/ex_2pool_8c.html#a8">DecodeLink</a>(((PLIST_ENTRY)((PCHAR)NextEntry + POOL_OVERHEAD))-&gt;Flink), P);
03246             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, <a class="code" href="../../d2/d2/ex_2pool_8c.html#a8">DecodeLink</a>(((PLIST_ENTRY)((PCHAR)NextEntry + POOL_OVERHEAD))-&gt;Blink), P);
03247 
03248             NextEntry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> += Entry-&gt;BlockSize;
03249             Entry = NextEntry;
03250         }
03251     }
03252 
03253     <span class="comment">//</span>
03254     <span class="comment">// If the block being freed has been combined into a full page,</span>
03255     <span class="comment">// then return the free page to memory management.</span>
03256     <span class="comment">//</span>
03257 
03258     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d2/poolhack_8c.html#a5">PAGE_ALIGNED</a>(Entry) &amp;&amp;
03259         (<a class="code" href="../../d4/d2/pool_8h.html#a17">PAGE_END</a>((<a class="code" href="../../d3/d8/struct__POOL__BLOCK.html">PPOOL_BLOCK</a>)Entry + Entry-&gt;BlockSize) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
03260 
03261         <span class="comment">//</span>
03262         <span class="comment">// If the pool type is paged pool, then the paged pool page lock</span>
03263         <span class="comment">// must be held during the free of the pool pages.</span>
03264         <span class="comment">//</span>
03265 
03266         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a34">LOCK_IF_PAGED_POOL</a>(CheckType, GlobalSpace);
03267 
03268         <a class="code" href="../../d2/d1/mm_8h.html#a52">PERFINFO_FREEPOOLPAGE</a>(CheckType, PoolIndex, Entry, PoolDesc);
03269 
03270         <a class="code" href="../../d1/d6/allocpag_8c.html#a55">MiFreePoolPages</a>(Entry);
03271 
03272         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a36">UNLOCK_IF_PAGED_POOL</a>(CheckType, GlobalSpace);
03273 
03274         PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o1">TotalPages</a> -= 1;
03275 
03276     } <span class="keywordflow">else</span> {
03277 
03278         <span class="comment">//</span>
03279         <span class="comment">// Insert this element into the list.</span>
03280         <span class="comment">//</span>
03281 
03282         Entry-&gt;PoolType = 0;
03283         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a26">ENCODE_POOL_INDEX</a>(Entry, PoolIndex);
03284         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = Entry-&gt;BlockSize;
03285 
03286         <span class="comment">//</span>
03287         <span class="comment">// If the freed block was combined with any other block, then</span>
03288         <span class="comment">// adjust the size of the next block if necessary.</span>
03289         <span class="comment">//</span>
03290 
03291         <span class="keywordflow">if</span> (Combined != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03292 
03293             <span class="comment">//</span>
03294             <span class="comment">// The size of this entry has changed, if this entry is</span>
03295             <span class="comment">// not the last one in the page, update the pool block</span>
03296             <span class="comment">// after this block to have a new previous allocation size.</span>
03297             <span class="comment">//</span>
03298 
03299             NextEntry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((<a class="code" href="../../d3/d8/struct__POOL__BLOCK.html">PPOOL_BLOCK</a>)Entry + Entry-&gt;BlockSize);
03300             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d2/pool_8h.html#a17">PAGE_END</a>(NextEntry) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03301                 NextEntry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o3">PreviousSize</a> = Entry-&gt;BlockSize;
03302             }
03303 
03304             <span class="comment">//</span>
03305             <span class="comment">// Reduce fragmentation and insert at the tail in hopes</span>
03306             <span class="comment">// neighbors for this will be freed before this is reallocated.</span>
03307             <span class="comment">//</span>
03308 
03309             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, &amp;PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o4">ListHeads</a>[Index - 1], P);
03310             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a15">PrivateInsertTailList</a>(&amp;PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o4">ListHeads</a>[Index - 1], ((PLIST_ENTRY)((PCHAR)Entry + POOL_OVERHEAD)));
03311             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, &amp;PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o4">ListHeads</a>[Index - 1], P);
03312             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, ((PLIST_ENTRY)((PCHAR)Entry + POOL_OVERHEAD)), P);
03313 
03314         } <span class="keywordflow">else</span> {
03315 
03316             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, &amp;PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o4">ListHeads</a>[Index - 1], P);
03317             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a16">PrivateInsertHeadList</a>(&amp;PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o4">ListHeads</a>[Index - 1], ((PLIST_ENTRY)((PCHAR)Entry + POOL_OVERHEAD)));
03318             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, &amp;PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o4">ListHeads</a>[Index - 1], P);
03319             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, ((PLIST_ENTRY)((PCHAR)Entry + POOL_OVERHEAD)), P);
03320         }
03321     }
03322 
03323     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a35">UNLOCK_POOL</a>(PoolDesc, LockHandle);
03324 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a79" doxytag="ex/pool.c::ExInsertPoolTag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ExInsertPoolTag           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Tag</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Va</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01893">1893</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00141">BYTES_TO_PAGES</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02324">ExpAddTagForBigPages()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02000">ExpInsertPoolTracker()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00356">PoolBigPageTable</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00352">PoolTrackTable</a>, and <a class="el" href="../../d5/d1/pool_8h-source.html#l00056">SESSION_POOL_MASK</a>.
<p>
Referenced by <a class="el" href="../../d2/d5/allocpag_8c-source.html#l04569">MiFindContiguousMemory()</a>.
<p>
<pre class="fragment"><div>01902                    :
01903 
01904     This function inserts a <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> tag in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tag table and increments <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01905     number of allocates and updates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> total allocation size.
01906 
01907     This function also inserts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> tag in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> big page tag table.
01908 
01909     N.B. This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> use by memory management ONLY.
01910 
01911 Arguments:
01912 
01913     Tag - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tag used to insert an entry in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tag table.
01914 
01915     Va - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated <span class="keyword">virtual</span> address.
01916 
01917     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation size in bytes.
01918 
01919     PoolType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
01920 
01921 Return Value:
01922 
01923     None.
01924 
01925 Environment:
01926 
01927     No <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> locks held so <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> may be freely allocated here as needed.
01928 
01929 --*/
01930 
01931 {
01932     ULONG NumberOfPages;
01933 
01934     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((PoolType &amp; SESSION_POOL_MASK) == 0);
01935 
01936     <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d2/ex_2pool_8c.html#a45">PoolBigPageTable</a>) &amp;&amp; (NumberOfBytes &gt;= <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) {
01937 
01938         NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a>(NumberOfBytes);
01939 
01940         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a67">ExpAddTagForBigPages</a>((PVOID)Va, Tag, NumberOfPages) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01941             Tag = ' GIB';
01942         }
01943     }
01944 
01945     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01946         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a65">ExpInsertPoolTracker</a> (Tag, NumberOfBytes, NonPagedPool);
01947     }
01948 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a71" doxytag="ex/pool.c::ExLockPool" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> KIRQL ExLockPool           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PoolType</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00506">506</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
<pre class="fragment"><div>00512                    :
00513 
00514     This function locks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> specified by <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
00515 
00516 Arguments:
00517 
00518     PoolType - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> that should be locked.
00519 
00520 Return Value:
00521 
00522     The previous IRQL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function value.
00523 
00524 --*/
00525 
00526 {
00527 
00528     KIRQL OldIrql;
00529 
00530     <span class="comment">//</span>
00531     <span class="comment">// If the pool type is nonpaged, then use a spinlock to lock the</span>
00532     <span class="comment">// pool. Otherwise, use a fast mutex to lock the pool.</span>
00533     <span class="comment">//</span>
00534 
00535     <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>) == <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>) {
00536         ExAcquireSpinLock(<a class="code" href="../../d2/d2/ex_2pool_8c.html#a52">NonPagedPoolDescriptor</a>.<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o3">LockAddress</a>, &amp;OldIrql);
00537 
00538     } <span class="keywordflow">else</span> {
00539         ExAcquireFastMutex((<a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a>)PoolVector[PagedPool]-&gt;LockAddress);
00540         OldIrql = (KIRQL)((<a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a>)(<a class="code" href="../../d2/d2/ex_2pool_8c.html#a54">PoolVector</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>]-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o3">LockAddress</a>))-&gt;OldIrql;
00541     }
00542 
00543     <span class="keywordflow">return</span> OldIrql;
00544 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a70" doxytag="ex/pool.c::ExOkayToLockRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN ExOkayToLockRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Lock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00397">397</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00367">Lock</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00400 {
00401     UNREFERENCED_PARAMETER (Lock);
00402 
00403     <span class="keywordflow">if</span> (KeIsExecutingDpc()) {
00404         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00405     } <span class="keywordflow">else</span> {
00406         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00407     }
00408 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a67" doxytag="ex/pool.c::ExpAddTagForBigPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL ExpAddTagForBigPages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Va</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Key</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfPages</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02324">2324</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02000">ExpInsertPoolTracker()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00456">ExpLockNonPagedPool</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02231">ExpRemovePoolTracker()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00463">ExpTaggedPoolLock</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00459">ExpUnlockNonPagedPool</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00350">FirstPrint</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00287">_POOL_TRACKER_BIG_PAGES::Key</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00807">MiAllocatePoolPages()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l01778">MiFreePoolPages()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00288">_POOL_TRACKER_BIG_PAGES::NumberOfPages</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00356">PoolBigPageTable</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00358">PoolBigPageTableHash</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00357">PoolBigPageTableSize</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00117">ROUND_TO_PAGES</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d1/pool_8h-source.html#l00286">_POOL_TRACKER_BIG_PAGES::Va</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01893">ExInsertPoolTag()</a>.
<p>
<pre class="fragment"><div>02331                    :
02332 
02333     This function inserts a <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> tag in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> big page tag table.
02334 
02335 Arguments:
02336 
02337     Va - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated <span class="keyword">virtual</span> address.
02338 
02339     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key value used to locate a <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a> entry in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02340         tag table.
02341 
02342     NumberOfPages - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of pages that were allocated.
02343 
02344 Return Value:
02345 
02346     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> an entry was allocated, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> not.
02347 
02348 Environment:
02349 
02350     No <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> locks held so <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> table may be freely expanded here as needed.
02351 
02352 --*/
02353 {
02354     ULONG Hash;
02355     ULONG BigPages;
02356     PVOID OldTable;
02357     LOGICAL Inserted;
02358     KIRQL OldIrql;
02359     KIRQL LockHandle;
02360     SIZE_T SizeInBytes;
02361     SIZE_T NewSizeInBytes;
02362     <a class="code" href="../../d1/d9/struct__POOL__TRACKER__BIG__PAGES.html">PPOOL_TRACKER_BIG_PAGES</a> NewTable;
02363     <a class="code" href="../../d1/d9/struct__POOL__TRACKER__BIG__PAGES.html">PPOOL_TRACKER_BIG_PAGES</a> p;
02364 
02365 retry:
02366 
02367     Inserted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02368     Hash = (ULONG)(((ULONG_PTR)Va &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>) &amp; <a class="code" href="../../d2/d2/ex_2pool_8c.html#a47">PoolBigPageTableHash</a>);
02369     ExAcquireSpinLock(&amp;ExpTaggedPoolLock, &amp;OldIrql);
02370     <span class="keywordflow">while</span> ((LONG_PTR)<a class="code" href="../../d2/d2/ex_2pool_8c.html#a45">PoolBigPageTable</a>[Hash].<a class="code" href="../../d1/d9/struct__POOL__TRACKER__BIG__PAGES.html#o0">Va</a> &lt; 0) {
02371         Hash += 1;
02372         <span class="keywordflow">if</span> (Hash &gt;= <a class="code" href="../../d2/d2/ex_2pool_8c.html#a46">PoolBigPageTableSize</a>) {
02373             <span class="keywordflow">if</span> (!Inserted) {
02374 
02375                 <span class="comment">//</span>
02376                 <span class="comment">// Try to expand the tracker table.</span>
02377                 <span class="comment">//</span>
02378 
02379                 SizeInBytes = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a46">PoolBigPageTableSize</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d9/struct__POOL__TRACKER__BIG__PAGES.html">POOL_TRACKER_BIG_PAGES</a>);
02380                 NewSizeInBytes = (SizeInBytes &lt;&lt; 1);
02381 
02382                 <span class="keywordflow">if</span> (NewSizeInBytes &gt; SizeInBytes) {
02383 
02384                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a31">ExpLockNonPagedPool</a>(LockHandle);
02385 
02386                     NewTable = <a class="code" href="../../d1/d6/allocpag_8c.html#a54">MiAllocatePoolPages</a> (NonPagedPool,
02387                                                     NewSizeInBytes,
02388                                                     FALSE);
02389 
02390                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a32">ExpUnlockNonPagedPool</a>(LockHandle);
02391 
02392                     <span class="keywordflow">if</span> (NewTable != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02393     
02394                         OldTable = (PVOID)<a class="code" href="../../d2/d2/ex_2pool_8c.html#a45">PoolBigPageTable</a>;
02395 
02396                         KdPrint((<span class="stringliteral">"POOL:grew big table (%p, %p, %p)\n"</span>,
02397                             OldTable,
02398                             PoolBigPageTableSize,
02399                             NewTable));
02400 
02401                         RtlCopyMemory ((PVOID)NewTable,
02402                                        OldTable,
02403                                        SizeInBytes);
02404 
02405                         RtlZeroMemory ((PVOID)(NewTable + PoolBigPageTableSize),
02406                                        NewSizeInBytes - SizeInBytes);
02407 
02408                         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a45">PoolBigPageTable</a> = NewTable;
02409                         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a46">PoolBigPageTableSize</a> &lt;&lt;= 1;
02410                         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a47">PoolBigPageTableHash</a> = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a46">PoolBigPageTableSize</a> - 1;
02411 
02412                         ExReleaseSpinLock(&amp;ExpTaggedPoolLock, OldIrql);
02413 
02414                         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a31">ExpLockNonPagedPool</a>(LockHandle);
02415 
02416                         BigPages = <a class="code" href="../../d1/d6/allocpag_8c.html#a55">MiFreePoolPages</a> (OldTable);
02417 
02418                         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a32">ExpUnlockNonPagedPool</a>(LockHandle);
02419 
02420                         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a66">ExpRemovePoolTracker</a> ('looP',
02421                                               BigPages * PAGE_SIZE,
02422                                               NonPagedPool);
02423 
02424                         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a65">ExpInsertPoolTracker</a> ('looP',
02425                                               (ULONG) <a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a>(NewSizeInBytes),
02426                                               NonPagedPool);
02427 
02428                         <span class="keywordflow">goto</span> retry;
02429                     }
02430                 }
02431 
02432                 <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d2/ex_2pool_8c.html#a41">FirstPrint</a>) {
02433                     KdPrint((<span class="stringliteral">"POOL:unable to insert big page slot %lx\n"</span>,Key));
02434                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a41">FirstPrint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02435                 }
02436 
02437                 ExReleaseSpinLock(&amp;ExpTaggedPoolLock, OldIrql);
02438                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02439             }
02440 
02441             Hash = 0;
02442             Inserted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02443         }
02444     }
02445 
02446     p = &amp;<a class="code" href="../../d2/d2/ex_2pool_8c.html#a45">PoolBigPageTable</a>[Hash];
02447 
02448     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG_PTR)Va &lt; 0);
02449 
02450     p-&gt;<a class="code" href="../../d1/d9/struct__POOL__TRACKER__BIG__PAGES.html#o0">Va</a> = Va;
02451     p-&gt;<a class="code" href="../../d1/d9/struct__POOL__TRACKER__BIG__PAGES.html#o1">Key</a> = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
02452     p-&gt;<a class="code" href="../../d1/d9/struct__POOL__TRACKER__BIG__PAGES.html#o2">NumberOfPages</a> = NumberOfPages;
02453 
02454     ExReleaseSpinLock(&amp;ExpTaggedPoolLock, OldIrql);
02455 
02456     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02457 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a81" doxytag="ex/pool.c::ExpAllocatePoolWithQuotaHandler" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG ExpAllocatePoolWithQuotaHandler           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN NTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionCode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LOGICAL&nbsp;</td>
          <td class="mdname" nowrap> <em>ContinueSearch</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02502">2502</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00056">EXCEPTION_CONTINUE_SEARCH</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, and <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>.
<p>
<pre class="fragment"><div>02510                    :
02511 
02512     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when an exception occurs in <a class="code" href="../../d6/d3/cmwraper_8c.html#a26">ExFreePool</a>
02513     <span class="keywordflow">while</span> quota <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being charged to a process.
02514 
02515     Its function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to deallocate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> block and <span class="keywordflow">continue</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> search
02516     <span class="keywordflow">for</span> an exception handler.
02517 
02518 Arguments:
02519 
02520     ExceptionCode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception code that caused <span class="keyword">this</span>
02521         function to be entered.
02522 
02523     PoolAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> block that needs to be
02524         deallocated.
02525 
02526     ContinueSearch - Supplies a value that <span class="keywordflow">if</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> causes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception
02527         search to <span class="keywordflow">continue</span>.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used in allocate <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> with quota
02528         calls that <span class="keywordflow">do</span> not contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> quota mask bit set.
02529 
02530 Return Value:
02531 
02532     <a class="code" href="../../d6/d7/halmips_8h.html#a34">EXCEPTION_CONTINUE_SEARCH</a> - The exception should be propagated to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02533         caller of <a class="code" href="../../d5/d5/cc_8h.html#a11">ExAllocatePoolWithQuota</a>.
02534 
02535 --*/
02536 
02537 {
02538     <span class="keywordflow">if</span> ( PoolAddress ) {
02539         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ExceptionCode == STATUS_QUOTA_EXCEEDED);
02540         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PoolAddress);
02541 
02542     } <span class="keywordflow">else</span> {
02543         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ExceptionCode == STATUS_INSUFFICIENT_RESOURCES);
02544     }
02545 
02546     <span class="keywordflow">return</span> ContinueSearch ? <a class="code" href="../../d6/d7/halmips_8h.html#a34">EXCEPTION_CONTINUE_SEARCH</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>;
02547 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a69" doxytag="ex/pool.c::ExpAllocateStringRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID ExpAllocateStringRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SIZE_T&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>NumberOfBytes</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00389">389</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, and <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>.
<p>
<pre class="fragment"><div>00392 {
00393     <span class="keywordflow">return</span> <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(PagedPool,NumberOfBytes,'grtS');
00394 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a74" doxytag="ex/pool.c::ExpCheckSingleFilter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL ExpCheckSingleFilter           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Tag</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Filter</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00853">853</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d1/rtnotify_8c-source.html#l00075">Filter</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00281">PROTECTED_POOL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>.
<p>
<pre class="fragment"><div>00860                    :
00861 
00862     This function checks <span class="keywordflow">if</span> a <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> tag matches a given pattern.  Pool
00863     protection <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tag.
00864 
00865         ? - matches a single character
00866         * - terminates match with <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00867 
00868     N.B.: ability inspired by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> !poolfind debugger <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a>.
00869 
00870 Arguments:
00871 
00872     Tag - a <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> tag
00873 
00874     <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a> - a globish pattern (chars and/or ?,*)
00875 
00876 Return Value:
00877 
00878     TRUE if a match exists, FALSE otherwise.
00879 
00880 --*/
00881 
00882 {
00883     ULONG i;
00884     PUCHAR tc;
00885     PUCHAR fc;
00886 
00887     tc = (PUCHAR) &amp;Tag;
00888     fc = (PUCHAR) &amp;<a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>;
00889 
00890     <span class="keywordflow">for</span> (i = 0; i &lt; 4; i += 1, tc += 1, fc += 1) {
00891 
00892         <span class="keywordflow">if</span> (*fc == <span class="charliteral">'*'</span>) {
00893             <span class="keywordflow">break</span>;
00894         }
00895         <span class="keywordflow">if</span> (*fc == <span class="charliteral">'?'</span>) {
00896             <span class="keywordflow">continue</span>;
00897         }
00898         <span class="keywordflow">if</span> (i == 3 &amp;&amp; ((*tc) &amp; ~(<a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a> &gt;&gt; 24)) == *fc) {
00899             <span class="keywordflow">continue</span>;
00900         }
00901         <span class="keywordflow">if</span> (*tc != *fc) {
00902             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00903         }
00904     }
00905     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00906 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a68" doxytag="ex/pool.c::ExpFindAndRemoveTagBigPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG ExpFindAndRemoveTagBigPages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Va</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02461">2461</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00463">ExpTaggedPoolLock</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00350">FirstPrint</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00287">_POOL_TRACKER_BIG_PAGES::Key</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00356">PoolBigPageTable</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00358">PoolBigPageTableHash</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00357">PoolBigPageTableSize</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d1/pool_8h-source.html#l00286">_POOL_TRACKER_BIG_PAGES::Va</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">ExFreePoolWithTag()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01951">ExRemovePoolTag()</a>.
<p>
<pre class="fragment"><div>02465 {
02466     ULONG Hash;
02467     LOGICAL Inserted;
02468     KIRQL OldIrql;
02469     ULONG ReturnKey;
02470 
02471     Inserted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02472     Hash = (ULONG)(((ULONG_PTR)Va &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>) &amp; <a class="code" href="../../d2/d2/ex_2pool_8c.html#a47">PoolBigPageTableHash</a>);
02473     ExAcquireSpinLock(&amp;ExpTaggedPoolLock, &amp;OldIrql);
02474     <span class="keywordflow">while</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a45">PoolBigPageTable</a>[Hash].<a class="code" href="../../d1/d9/struct__POOL__TRACKER__BIG__PAGES.html#o0">Va</a> != Va) {
02475         Hash += 1;
02476         <span class="keywordflow">if</span> (Hash &gt;= <a class="code" href="../../d2/d2/ex_2pool_8c.html#a46">PoolBigPageTableSize</a>) {
02477             <span class="keywordflow">if</span> (!Inserted) {
02478                 <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d2/ex_2pool_8c.html#a41">FirstPrint</a>) {
02479                     KdPrint((<span class="stringliteral">"POOL:unable to find big page slot %lx\n"</span>,Va));
02480                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a41">FirstPrint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02481                 }
02482 
02483                 ExReleaseSpinLock(&amp;ExpTaggedPoolLock, OldIrql);
02484                 <span class="keywordflow">return</span> ' GIB';
02485             }
02486 
02487             Hash = 0;
02488             Inserted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02489         }
02490     }
02491 
02492     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG_PTR)Va &lt; 0);
02493     (ULONG_PTR)<a class="code" href="../../d2/d2/ex_2pool_8c.html#a45">PoolBigPageTable</a>[Hash].<a class="code" href="../../d1/d9/struct__POOL__TRACKER__BIG__PAGES.html#o0">Va</a> &amp;= MAXLONG_PTR;
02494 
02495     ReturnKey = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a45">PoolBigPageTable</a>[Hash].<a class="code" href="../../d1/d9/struct__POOL__TRACKER__BIG__PAGES.html#o1">Key</a>;
02496     ExReleaseSpinLock(&amp;ExpTaggedPoolLock, OldIrql);
02497     <span class="keywordflow">return</span> ReturnKey;
02498 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a63" doxytag="ex/pool.c::ExpInitializePoolDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ExpInitializePoolDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">PPOOL_DESCRIPTOR</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolIndex</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Threshold</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolLock</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00609">609</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
References <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00349">ExpSessionPoolDescriptor</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00479">MiSessionPoolVector()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a182">PagedPoolSession</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00068">POOL_LIST_HEADS</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00128">PrivateInitializeListHead</a>.
<p>
<pre class="fragment"><div>00619                    :
00620 
00621     This function initializes a <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> descriptor.
00622 
00623     Note that <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called directly by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory manager.
00624 
00625 Arguments:
00626 
00627     PoolDescriptor - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> descriptor.
00628 
00629     PoolType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
00630 
00631     PoolIndex - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> descriptor index.
00632 
00633     Threshold - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> threshold value <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
00634 
00635     PoolLock - Supplies a point to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
00636 
00637 Return Value:
00638 
00639     None.
00640 
00641 --*/
00642 
00643 {
00644 
00645     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00646 
00647     <span class="comment">//</span>
00648     <span class="comment">// Initialize statistics fields, the pool type, the threshold value,</span>
00649     <span class="comment">// and the lock address.</span>
00650     <span class="comment">//</span>
00651 
00652     PoolDescriptor-&gt;PoolType = PoolType;
00653     PoolDescriptor-&gt;PoolIndex = PoolIndex;
00654     PoolDescriptor-&gt;RunningAllocs = 0;
00655     PoolDescriptor-&gt;RunningDeAllocs = 0;
00656     PoolDescriptor-&gt;TotalPages = 0;
00657     PoolDescriptor-&gt;TotalBigPages = 0;
00658     PoolDescriptor-&gt;Threshold = Threshold;
00659     PoolDescriptor-&gt;LockAddress = PoolLock;
00660 
00661     <span class="comment">//</span>
00662     <span class="comment">// Initialize the allocation listheads.</span>
00663     <span class="comment">//</span>
00664 
00665     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d5/d2/poolhack_8c.html#a2">POOL_LIST_HEADS</a>; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00666         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a10">PrivateInitializeListHead</a>(&amp;PoolDescriptor-&gt;ListHeads[Index]);
00667     }
00668 
00669     <span class="keywordflow">if</span> ((PoolType == <a class="code" href="../../d5/d8/ex_8h.html#a329a182">PagedPoolSession</a>) &amp;&amp; (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a40">ExpSessionPoolDescriptor</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00670         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a40">ExpSessionPoolDescriptor</a> = (<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">PPOOL_DESCRIPTOR</a>) <a class="code" href="../../d1/d6/allocpag_8c.html#a49">MiSessionPoolVector</a> ();
00671     }
00672 
00673     <span class="keywordflow">return</span>;
00674 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a65" doxytag="ex/pool.c::ExpInsertPoolTracker" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ExpInsertPoolTracker           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Key</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>Size</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02000">2000</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00050">BASE_POOL_TYPE_MASK</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00456">ExpLockNonPagedPool</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02231">ExpRemovePoolTracker()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00463">ExpTaggedPoolLock</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00459">ExpUnlockNonPagedPool</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00269">_POOL_TRACKER_TABLE::Key</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00807">MiAllocatePoolPages()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l01778">MiFreePoolPages()</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00270">_POOL_TRACKER_TABLE::NonPagedAllocs</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00272">_POOL_TRACKER_TABLE::NonPagedBytes</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00273">_POOL_TRACKER_TABLE::PagedAllocs</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00275">_POOL_TRACKER_TABLE::PagedBytes</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00360">PoolHitTag</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00352">PoolTrackTable</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00354">PoolTrackTableMask</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00353">PoolTrackTableSize</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00281">PROTECTED_POOL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00117">ROUND_TO_PAGES</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00056">SESSION_POOL_MASK</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01893">ExInsertPoolTag()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02324">ExpAddTagForBigPages()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00677">InitializePool()</a>.
<p>
<pre class="fragment"><div>02008                    :
02009 
02010     This function inserts a <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> tag in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tag table and increments <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02011     number of allocates and updates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> total allocation size.
02012 
02013 Arguments:
02014 
02015     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key value used to locate a <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a> entry in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02016           tag table.
02017 
02018     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation size.
02019 
02020     PoolType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
02021 
02022 Return Value:
02023 
02024     None.
02025 
02026 Environment:
02027 
02028     No <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> locks held so <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> may be freely allocated here as needed.
02029 
02030 --*/
02031 
02032 {
02033     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Result;
02034     ULONG Hash;
02035     ULONG OriginalKey;
02036     ULONG OriginalHash;
02037     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02038     KIRQL OldIrql;
02039     KIRQL LockHandle;
02040     ULONG BigPages;
02041     LOGICAL HashedIt;
02042     SIZE_T NewSize;
02043     SIZE_T SizeInBytes;
02044     SIZE_T NewSizeInBytes;
02045     SIZE_T NewSizeMask;
02046     <a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html">PPOOL_TRACKER_TABLE</a> OldTable;
02047     <a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html">PPOOL_TRACKER_TABLE</a> NewTable;
02048 
02049     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((PoolType &amp; SESSION_POOL_MASK) == 0);
02050 
02051     <span class="comment">//</span>
02052     <span class="comment">// Ignore protected pool bit except for returned hash index.</span>
02053     <span class="comment">//</span>
02054 
02055     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> &amp; <a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>) {
02056         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> &amp;= ~<a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>;
02057         Result = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a> &gt;&gt; 16);
02058     } <span class="keywordflow">else</span> {
02059         Result = 0;
02060     }
02061 
02062     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> == <a class="code" href="../../d2/d2/ex_2pool_8c.html#a48">PoolHitTag</a>) {
02063         DbgBreakPoint();
02064     }
02065 
02066 retry:
02067 
02068     <span class="comment">//</span>
02069     <span class="comment">// Compute hash index and search for pool tag.</span>
02070     <span class="comment">//</span>
02071 
02072     ExAcquireSpinLock(&amp;ExpTaggedPoolLock, &amp;OldIrql);
02073 
02074     Hash = ((40543*((((((((PUCHAR)&amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>)[0]&lt;&lt;2)^((PUCHAR)&amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>)[1])&lt;&lt;2)^((PUCHAR)&amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>)[2])&lt;&lt;2)^((PUCHAR)&amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>)[3]))&gt;&gt;2) &amp; (ULONG)<a class="code" href="../../d2/d2/ex_2pool_8c.html#a44">PoolTrackTableMask</a>;
02075     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = Hash;
02076 
02077     <span class="keywordflow">do</span> {
02078         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[Hash].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o0">Key</a> == <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>) {
02079             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[Hash].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o0">Key</a> = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
02080             <span class="keywordflow">goto</span> EntryFound;
02081         }
02082 
02083         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[Hash].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o0">Key</a> == 0 &amp;&amp; Hash != <a class="code" href="../../d2/d2/ex_2pool_8c.html#a43">PoolTrackTableSize</a> - 1) {
02084             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[Hash].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o0">Key</a> = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
02085             <span class="keywordflow">goto</span> EntryFound;
02086         }
02087 
02088         Hash = (Hash + 1) &amp; (ULONG)<a class="code" href="../../d2/d2/ex_2pool_8c.html#a44">PoolTrackTableMask</a>;
02089     } <span class="keywordflow">while</span> (Hash != <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>);
02090 
02091     <span class="comment">//</span>
02092     <span class="comment">// No matching entry and no free entry was found.</span>
02093     <span class="comment">// If the overflow bucket has been used then expansion of the tracker table</span>
02094     <span class="comment">// is not allowed because a subsequent free of a tag can go negative as the</span>
02095     <span class="comment">// original allocation is in overflow and a newer allocation may be</span>
02096     <span class="comment">// distinct.</span>
02097     <span class="comment">//</span>
02098 
02099     NewSize = ((<a class="code" href="../../d2/d2/ex_2pool_8c.html#a43">PoolTrackTableSize</a> - 1) &lt;&lt; 1) + 1;
02100     NewSizeInBytes = NewSize * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html">POOL_TRACKER_TABLE</a>);
02101 
02102     SizeInBytes = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a43">PoolTrackTableSize</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html">POOL_TRACKER_TABLE</a>);
02103 
02104     <span class="keywordflow">if</span> ((NewSizeInBytes &gt; SizeInBytes) &amp;&amp;
02105         (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[<a class="code" href="../../d2/d2/ex_2pool_8c.html#a43">PoolTrackTableSize</a> - 1].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o0">Key</a> == 0)) {
02106 
02107         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a31">ExpLockNonPagedPool</a>(LockHandle);
02108 
02109         NewTable = <a class="code" href="../../d1/d6/allocpag_8c.html#a54">MiAllocatePoolPages</a> (NonPagedPool,
02110                                         NewSizeInBytes,
02111                                         FALSE);
02112 
02113         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a32">ExpUnlockNonPagedPool</a>(LockHandle);
02114 
02115         <span class="keywordflow">if</span> (NewTable != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02116 
02117             OldTable = (PVOID)<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>;
02118 
02119             KdPrint((<span class="stringliteral">"POOL:grew track table (%p, %p, %p)\n"</span>,
02120                 OldTable,
02121                 PoolTrackTableSize,
02122                 NewTable));
02123 
02124             RtlZeroMemory ((PVOID)NewTable, NewSizeInBytes);
02125 
02126             <span class="comment">//</span>
02127             <span class="comment">// Rehash all the entries into the new table.</span>
02128             <span class="comment">//</span>
02129 
02130             NewSizeMask = NewSize - 2;
02131 
02132             <span class="keywordflow">for</span> (OriginalHash = 0; OriginalHash &lt; <a class="code" href="../../d2/d2/ex_2pool_8c.html#a43">PoolTrackTableSize</a>; OriginalHash += 1) {
02133                 OriginalKey = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[OriginalHash].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o0">Key</a>;
02134 
02135                 <span class="keywordflow">if</span> (OriginalKey == 0) {
02136                     <span class="keywordflow">continue</span>;
02137                 }
02138 
02139                 Hash = (ULONG)((40543*((((((((PUCHAR)&amp;OriginalKey)[0]&lt;&lt;2)^((PUCHAR)&amp;OriginalKey)[1])&lt;&lt;2)^((PUCHAR)&amp;OriginalKey)[2])&lt;&lt;2)^((PUCHAR)&amp;OriginalKey)[3]))&gt;&gt;2) &amp; (ULONG)NewSizeMask;
02140                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = Hash;
02141             
02142                 HashedIt = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02143                 <span class="keywordflow">do</span> {
02144                     <span class="keywordflow">if</span> (NewTable[Hash].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o0">Key</a> == 0 &amp;&amp; Hash != NewSize - 1) {
02145                         RtlCopyMemory ((PVOID)&amp;NewTable[Hash],
02146                                        (PVOID)&amp;PoolTrackTable[OriginalHash],
02147                                        <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html">POOL_TRACKER_TABLE</a>));
02148                         HashedIt = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02149                         <span class="keywordflow">break</span>;
02150                     }
02151             
02152                     Hash = (Hash + 1) &amp; (ULONG)NewSizeMask;
02153                 } <span class="keywordflow">while</span> (Hash != <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>);
02154         
02155                 <span class="comment">//</span>
02156                 <span class="comment">// No matching entry and no free entry was found, have to bail.</span>
02157                 <span class="comment">//</span>
02158 
02159                 <span class="keywordflow">if</span> (HashedIt == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02160                     KdPrint((<span class="stringliteral">"POOL:rehash of track table failed (%p, %p, %p %p)\n"</span>,
02161                         OldTable,
02162                         PoolTrackTableSize,
02163                         NewTable,
02164                         OriginalKey));
02165         
02166                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a31">ExpLockNonPagedPool</a>(LockHandle);
02167 
02168                     <a class="code" href="../../d1/d6/allocpag_8c.html#a55">MiFreePoolPages</a> (NewTable);
02169 
02170                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a32">ExpUnlockNonPagedPool</a>(LockHandle);
02171 
02172                     <span class="keywordflow">goto</span> overflow;
02173                 }
02174             }
02175 
02176             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a> = NewTable;
02177             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a43">PoolTrackTableSize</a> = NewSize;
02178             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a44">PoolTrackTableMask</a> = NewSizeMask;
02179 
02180             ExReleaseSpinLock(&amp;ExpTaggedPoolLock, OldIrql);
02181 
02182             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a31">ExpLockNonPagedPool</a>(LockHandle);
02183 
02184             BigPages = <a class="code" href="../../d1/d6/allocpag_8c.html#a55">MiFreePoolPages</a> (OldTable);
02185 
02186             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a32">ExpUnlockNonPagedPool</a>(LockHandle);
02187 
02188             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a66">ExpRemovePoolTracker</a> ('looP',
02189                                   BigPages * PAGE_SIZE,
02190                                   NonPagedPool);
02191 
02192             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a65">ExpInsertPoolTracker</a> ('looP',
02193                                   (ULONG) <a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a>(NewSizeInBytes),
02194                                   NonPagedPool);
02195 
02196             <span class="keywordflow">goto</span> retry;
02197         }
02198     }
02199 
02200 overflow:
02201 
02202     <span class="comment">//</span>
02203     <span class="comment">// Use the very last entry as a bit bucket for overflows.</span>
02204     <span class="comment">//</span>
02205 
02206     Hash = (ULONG)<a class="code" href="../../d2/d2/ex_2pool_8c.html#a43">PoolTrackTableSize</a> - 1;
02207 
02208     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[Hash].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o0">Key</a> = 'lfvO';
02209 
02210     <span class="comment">//</span>
02211     <span class="comment">// Update pool tracker table entry.</span>
02212     <span class="comment">//</span>
02213 
02214 EntryFound:
02215 
02216     <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>) == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
02217         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[Hash].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o4">PagedAllocs</a> += 1;
02218         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[Hash].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o6">PagedBytes</a> += <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
02219 
02220     } <span class="keywordflow">else</span> {
02221         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[Hash].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o1">NonPagedAllocs</a> += 1;
02222         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[Hash].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o3">NonPagedBytes</a> += <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
02223     }
02224     ExReleaseSpinLock(&amp;ExpTaggedPoolLock, OldIrql);
02225 
02226     <span class="keywordflow">return</span>;
02227 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a66" doxytag="ex/pool.c::ExpRemovePoolTracker" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ExpRemovePoolTracker           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Key</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Size</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02231">2231</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
References <a class="el" href="../../d5/d1/pool_8h-source.html#l00050">BASE_POOL_TYPE_MASK</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00463">ExpTaggedPoolLock</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00269">_POOL_TRACKER_TABLE::Key</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00272">_POOL_TRACKER_TABLE::NonPagedBytes</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00271">_POOL_TRACKER_TABLE::NonPagedFrees</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00275">_POOL_TRACKER_TABLE::PagedBytes</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00274">_POOL_TRACKER_TABLE::PagedFrees</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00360">PoolHitTag</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00352">PoolTrackTable</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00354">PoolTrackTableMask</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00353">PoolTrackTableSize</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00281">PROTECTED_POOL</a>, and <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">ExFreePoolWithTag()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02324">ExpAddTagForBigPages()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02000">ExpInsertPoolTracker()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01951">ExRemovePoolTag()</a>.
<p>
<pre class="fragment"><div>02239                    :
02240 
02241     This function increments <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of frees and updates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> total
02242     allocation size.
02243 
02244 Arguments:
02245 
02246     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key value used to locate a <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a> entry in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02247           tag table.
02248 
02249     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation size.
02250 
02251     PoolType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
02252 
02253 Return Value:
02254 
02255     None.
02256 
02257 --*/
02258 
02259 {
02260     ULONG Hash;
02261     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02262     KIRQL OldIrql;
02263 
02264     <span class="comment">//</span>
02265     <span class="comment">// Ignore protected pool bit</span>
02266     <span class="comment">//</span>
02267 
02268     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> &amp;= ~<a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>;
02269     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> == <a class="code" href="../../d2/d2/ex_2pool_8c.html#a48">PoolHitTag</a>) {
02270         DbgBreakPoint();
02271     }
02272 
02273     <span class="comment">//</span>
02274     <span class="comment">// Compute hash index and search for pool tag.</span>
02275     <span class="comment">//</span>
02276 
02277     ExAcquireSpinLock(&amp;ExpTaggedPoolLock, &amp;OldIrql);
02278 
02279     Hash = ((40543*((((((((PUCHAR)&amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>)[0]&lt;&lt;2)^((PUCHAR)&amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>)[1])&lt;&lt;2)^((PUCHAR)&amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>)[2])&lt;&lt;2)^((PUCHAR)&amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>)[3]))&gt;&gt;2) &amp; (ULONG)<a class="code" href="../../d2/d2/ex_2pool_8c.html#a44">PoolTrackTableMask</a>;
02280     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = Hash;
02281 
02282     <span class="keywordflow">do</span> {
02283         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[Hash].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o0">Key</a> == <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>) {
02284             <span class="keywordflow">goto</span> EntryFound;
02285         }
02286 
02287         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[Hash].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o0">Key</a> == 0 &amp;&amp; Hash != <a class="code" href="../../d2/d2/ex_2pool_8c.html#a43">PoolTrackTableSize</a> - 1) {
02288             KdPrint((<span class="stringliteral">"POOL: Unable to find tracker %lx, table corrupted\n"</span>, Key));
02289             ExReleaseSpinLock(&amp;ExpTaggedPoolLock, OldIrql);
02290             <span class="keywordflow">return</span>;
02291         }
02292 
02293         Hash = (Hash + 1) &amp; (ULONG)<a class="code" href="../../d2/d2/ex_2pool_8c.html#a44">PoolTrackTableMask</a>;
02294     } <span class="keywordflow">while</span> (Hash != <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>);
02295 
02296     <span class="comment">//</span>
02297     <span class="comment">// No matching entry and no free entry was found.</span>
02298     <span class="comment">//</span>
02299 
02300     Hash = (ULONG)<a class="code" href="../../d2/d2/ex_2pool_8c.html#a43">PoolTrackTableSize</a> - 1;
02301 
02302     <span class="comment">//</span>
02303     <span class="comment">// Update pool tracker table entry.</span>
02304     <span class="comment">//</span>
02305 
02306 EntryFound:
02307 
02308     <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>) == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
02309         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[Hash].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o6">PagedBytes</a> -= <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
02310         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[Hash].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o5">PagedFrees</a> += 1;
02311 
02312     } <span class="keywordflow">else</span> {
02313         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[Hash].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o3">NonPagedBytes</a> -= <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
02314         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[Hash].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o2">NonPagedFrees</a> += 1;
02315     }
02316 
02317     ExReleaseSpinLock(&amp;ExpTaggedPoolLock, OldIrql);
02318 
02319     <span class="keywordflow">return</span>;
02320 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a64" doxytag="ex/pool.c::ExpSnapShotPoolPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ExpSnapShotPoolPages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Address</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Size</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSYSTEM_POOL_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSYSTEM_POOL_ENTRY *&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolEntryInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>RequiredLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a86" doxytag="ex/pool.c::ExQueryPoolBlockSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG ExQueryPoolBlockSize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>QuotaCharged</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l03328">3328</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
References <a class="el" href="../../d5/d1/pool_8h-source.html#l00171">_POOL_HEADER::BlockSize</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l02927">MmQuerySpecialPoolBlockSize()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01977">MmSpecialPoolEnd</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01976">MmSpecialPoolStart</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00071">PAGE_ALIGNED</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00096">POOL_BLOCK_SHIFT</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00116">POOL_OVERHEAD</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00352">PoolTrackTable</a>, and <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00112">_POOL_HEADER::ProcessBilled</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00828">HMAllocObject()</a>, and <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01069">HMFreeObject()</a>.
<p>
<pre class="fragment"><div>03335                    :
03336 
03337     This function returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> block.
03338 
03339 Arguments:
03340 
03341     PoolBlock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> block of <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
03342 
03343     QuotaCharged - Supplies a BOOLEAN variable to receive whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03344         <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> block had quota charged.
03345 
03346     NOTE: If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> bigger than a page, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned
03347           rather than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> correct number of bytes.
03348 
03349 Return Value:
03350 
03351     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> of <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> block.
03352 
03353 --*/
03354 
03355 {
03356     <a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a> Entry;
03357     ULONG size;
03358 
03359     <span class="keywordflow">if</span> ((PoolBlock &gt;= <a class="code" href="../../d2/d1/mm_8h.html#a160">MmSpecialPoolStart</a>) &amp;&amp; (PoolBlock &lt; <a class="code" href="../../d2/d1/mm_8h.html#a161">MmSpecialPoolEnd</a>)) {
03360         *QuotaCharged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03361         <span class="keywordflow">return</span> (ULONG)<a class="code" href="../../d1/d6/allocpag_8c.html#a57">MmQuerySpecialPoolBlockSize</a> (PoolBlock);
03362     }
03363 
03364     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d2/poolhack_8c.html#a5">PAGE_ALIGNED</a>(PoolBlock)) {
03365         *QuotaCharged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03366         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
03367     }
03368 
03369 <span class="preprocessor">#if POOL_CACHE_SUPPORTED</span>
03370 <span class="preprocessor"></span>
03371     <span class="comment">//</span>
03372     <span class="comment">// Align entry on pool allocation boundary.</span>
03373     <span class="comment">//</span>
03374 
03375     <span class="keywordflow">if</span> (((ULONG)PoolBlock &amp; POOL_CACHE_CHECK) == 0) {
03376         Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((ULONG)PoolBlock - PoolCacheSize);
03377         size = (Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; <a class="code" href="../../d4/d2/pool_8h.html#a14">POOL_BLOCK_SHIFT</a>) - PoolCacheSize;
03378 
03379     } <span class="keywordflow">else</span> {
03380         Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((PCHAR)PoolBlock - <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>);
03381         size = (Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; <a class="code" href="../../d4/d2/pool_8h.html#a14">POOL_BLOCK_SHIFT</a>) - <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>;
03382     }
03383 
03384 <span class="preprocessor">#else</span>
03385 <span class="preprocessor"></span>
03386     Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((PCHAR)PoolBlock - <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>);
03387     size = (ULONG)((Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; <a class="code" href="../../d4/d2/pool_8h.html#a14">POOL_BLOCK_SHIFT</a>) - <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>);
03388 
03389 <span class="preprocessor">#endif //POOL_CACHE_SUPPORTED</span>
03390 <span class="preprocessor"></span>
03391 <span class="preprocessor">#ifdef _WIN64</span>
03392 <span class="preprocessor"></span>    *QuotaCharged = (BOOLEAN) (Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o2">ProcessBilled</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03393 <span class="preprocessor">#else</span>
03394 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( <a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a> ) {
03395         *QuotaCharged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03396     }
03397     <span class="keywordflow">else</span> {
03398         *QuotaCharged = (BOOLEAN) (Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o2">ProcessBilled</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03399     }
03400 <span class="preprocessor">#endif</span>
03401 <span class="preprocessor"></span>    <span class="keywordflow">return</span> size;
03402 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a87" doxytag="ex/pool.c::ExQueryPoolUsage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ExQueryPoolUsage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PagedPoolPages</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NonPagedPoolPages</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PagedPoolAllocs</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PagedPoolFrees</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PagedPoolLookasideHits</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NonPagedPoolAllocs</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NonPagedPoolFrees</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NonPagedPoolLookasideHits</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l03405">3405</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
<pre class="fragment"><div>03416 {
03417     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
03418     <a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">PNPAGED_LOOKASIDE_LIST</a> Lookaside;
03419     PLIST_ENTRY NextEntry;
03420     <a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">PPOOL_DESCRIPTOR</a> <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>;
03421 
03422     <span class="comment">//</span>
03423     <span class="comment">// Sum all the paged pool usage.</span>
03424     <span class="comment">//</span>
03425 
03426     <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a> = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a54">PoolVector</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>];
03427     *PagedPoolPages = 0;
03428     *PagedPoolAllocs = 0;
03429     *PagedPoolFrees = 0;
03430 
03431     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d2/d2/ex_2pool_8c.html#a51">ExpNumberOfPagedPools</a> + 1; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
03432         *PagedPoolPages += <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].TotalPages + <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].TotalBigPages;
03433         *PagedPoolAllocs += <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].RunningAllocs;
03434         *PagedPoolFrees += <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].RunningDeAllocs;
03435     }
03436 
03437     <span class="comment">//</span>
03438     <span class="comment">// Sum all the nonpaged pool usage.</span>
03439     <span class="comment">//</span>
03440 
03441     <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a> = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a54">PoolVector</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>];
03442     *NonPagedPoolPages = <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>-&gt;TotalPages + <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>-&gt;TotalBigPages;
03443     *NonPagedPoolAllocs = <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>-&gt;RunningAllocs;
03444     *NonPagedPoolFrees = <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>-&gt;RunningDeAllocs;
03445 
03446     <span class="comment">//</span>
03447     <span class="comment">// Sum all the nonpaged must succeed usage.</span>
03448     <span class="comment">//</span>
03449 
03450     <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a> = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a54">PoolVector</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>];
03451     *NonPagedPoolPages += <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>-&gt;TotalPages + <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>-&gt;TotalBigPages;
03452     *NonPagedPoolAllocs += <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>-&gt;RunningAllocs;
03453     *NonPagedPoolFrees += <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>-&gt;RunningDeAllocs;
03454 
03455     <span class="comment">//</span>
03456     <span class="comment">// Sum all the lookaside hits for paged and nonpaged pool.</span>
03457     <span class="comment">//</span>
03458 
03459     NextEntry = <a class="code" href="../../d4/d0/exp_8h.html#a17">ExPoolLookasideListHead</a>.Flink;
03460     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d4/d0/exp_8h.html#a17">ExPoolLookasideListHead</a>) {
03461         Lookaside = CONTAINING_RECORD(NextEntry,
03462                                       <a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a>,
03463                                       <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>.ListEntry);
03464 
03465         <span class="keywordflow">if</span> (Lookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o9">Type</a> == <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>) {
03466             *NonPagedPoolLookasideHits += Lookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o5">AllocateHits</a>;
03467 
03468         } <span class="keywordflow">else</span> {
03469             *PagedPoolLookasideHits += Lookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o5">AllocateHits</a>;
03470         }
03471 
03472         NextEntry = NextEntry-&gt;Flink;
03473     }
03474 
03475     <span class="keywordflow">return</span>;
03476 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a80" doxytag="ex/pool.c::ExRemovePoolTag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ExRemovePoolTag           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Tag</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Va</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01951">1951</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
References <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02461">ExpFindAndRemoveTagBigPages()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02231">ExpRemovePoolTracker()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00356">PoolBigPageTable</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00352">PoolTrackTable</a>.
<p>
<pre class="fragment"><div>01959                    :
01960 
01961     This function removes a <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> tag from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tag table and increments <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01962     number of frees and updates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> total allocation size.
01963 
01964     This function also removes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> tag from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> big page tag table.
01965 
01966     N.B. This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> use by memory management ONLY.
01967 
01968 Arguments:
01969 
01970     Tag - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tag used to remove an entry in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tag table.
01971 
01972     Va - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated <span class="keyword">virtual</span> address.
01973 
01974     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation size in bytes.
01975 
01976 Return Value:
01977 
01978     None.
01979 
01980 Environment:
01981 
01982     No <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> locks held so <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> may be freely allocated here as needed.
01983 
01984 --*/
01985 
01986 {
01987     <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d2/ex_2pool_8c.html#a45">PoolBigPageTable</a>) &amp;&amp; (NumberOfBytes &gt;= <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) {
01988         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a68">ExpFindAndRemoveTagBigPages</a> (Va);
01989     }
01990 
01991     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01992         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a66">ExpRemovePoolTracker</a>(Tag,
01993                              (ULONG)NumberOfBytes,
01994                              NonPagedPool);
01995     }
01996 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a88" doxytag="ex/pool.c::ExReturnPoolQuota" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ExReturnPoolQuota           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>P</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l03480">3480</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
References <a class="el" href="../../d5/d1/pool_8h-source.html#l00050">BASE_POOL_TYPE_MASK</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00171">_POOL_HEADER::BlockSize</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00418">DECODE_POOL_INDEX</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00098">LOCK_POOL_GRANULAR</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01977">MmSpecialPoolEnd</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01976">MmSpecialPoolStart</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00096">POOL_BLOCK_SHIFT</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00116">POOL_OVERHEAD</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00041">POOL_QUOTA_ENABLED</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00073">POOL_QUOTA_MASK</a>, <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00075">POOL_TYPE_MASK</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00181">_POOL_HEADER::PoolTag</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00106">_POOL_HEADER::PoolType</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00451">PoolVector</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00112">_POOL_HEADER::ProcessBilled</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00356">PsReturnPoolQuota()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00099">UNLOCK_POOL_GRANULAR</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06641">IopFreeIrp()</a>, and <a class="el" href="../../d6/d3/complete_8c-source.html#l00797">IopFreeMiniPacket()</a>.
<p>
<pre class="fragment"><div>03486                    :
03487 
03488     This function returns quota charged to a subject process when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03489     specified <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> block was allocated.
03490 
03491 Arguments:
03492 
03493     P - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> block of <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> being deallocated.
03494 
03495 Return Value:
03496 
03497     None.
03498 
03499 --*/
03500 
03501 {
03502 
03503     <a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a> Entry;
03504     <a class="code" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType;
03505     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
03506 <span class="preprocessor">#if defined(_ALPHA_) &amp;&amp; !defined(_AXP64_)</span>
03507 <span class="preprocessor"></span>    <a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">PPOOL_DESCRIPTOR</a> PoolDesc;
03508     KIRQL LockHandle;
03509 <span class="preprocessor">#endif</span>
03510 <span class="preprocessor"></span>
03511     <span class="comment">//</span>
03512     <span class="comment">//  Do nothing for special pool. No quota was charged.</span>
03513     <span class="comment">//</span>
03514     
03515     <span class="keywordflow">if</span> ((P &gt;= <a class="code" href="../../d2/d1/mm_8h.html#a160">MmSpecialPoolStart</a>) &amp;&amp; (P &lt; <a class="code" href="../../d2/d1/mm_8h.html#a161">MmSpecialPoolEnd</a>)) {
03516         
03517         <span class="keywordflow">return</span>;
03518     }
03519 
03520     <span class="comment">//</span>
03521     <span class="comment">// Align the entry address to a pool allocation boundary.</span>
03522     <span class="comment">//</span>
03523 
03524 <span class="preprocessor">#if POOL_CACHE_SUPPORTED</span>
03525 <span class="preprocessor"></span>
03526     <span class="keywordflow">if</span> (((ULONG)P &amp; POOL_CACHE_CHECK) == 0) {
03527         Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((ULONG)P - PoolCacheSize);
03528 
03529     } <span class="keywordflow">else</span> {
03530         Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((PCHAR)P - <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>);
03531     }
03532 
03533 <span class="preprocessor">#else</span>
03534 <span class="preprocessor"></span>
03535     Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((PCHAR)P - <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>);
03536 
03537 <span class="preprocessor">#endif //POOL_CACHE_SUPPORTED</span>
03538 <span class="preprocessor"></span>
03539     <span class="comment">//</span>
03540     <span class="comment">// If quota was charged, then return the appropriate quota to the</span>
03541     <span class="comment">// subject process.</span>
03542     <span class="comment">//</span>
03543 
03544     <span class="keywordflow">if</span> ((Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> &amp; <a class="code" href="../../d4/d2/pool_8h.html#a11">POOL_QUOTA_MASK</a>) &amp;&amp; <a class="code" href="../../d2/d2/ex_2pool_8c.html#a0">POOL_QUOTA_ENABLED</a>) {
03545 
03546         PoolType = (Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> &amp; <a class="code" href="../../d4/d2/pool_8h.html#a12">POOL_TYPE_MASK</a>) - 1;
03547 
03548 <span class="preprocessor">#if _POOL_LOCK_GRANULAR_</span>
03549 <span class="preprocessor"></span>        PoolDesc = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a54">PoolVector</a>[PoolType];
03550         <span class="keywordflow">if</span> (PoolType == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
03551             PoolDesc = &amp;PoolDesc[<a class="code" href="../../d2/d2/ex_2pool_8c.html#a27">DECODE_POOL_INDEX</a>(Entry)];
03552         }
03553 <span class="preprocessor">#endif</span>
03554 <span class="preprocessor"></span>
03555         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a6">LOCK_POOL_GRANULAR</a>(PoolDesc, LockHandle);
03556 
03557         Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> &amp;= ~<a class="code" href="../../d4/d2/pool_8h.html#a11">POOL_QUOTA_MASK</a>;
03558 
03559         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a7">UNLOCK_POOL_GRANULAR</a>(PoolDesc, LockHandle);
03560 
03561         Process = Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o2">ProcessBilled</a>;
03562 
03563 <span class="preprocessor">#if !defined (_WIN64)</span>
03564 <span class="preprocessor"></span>        Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o9">PoolTag</a> = 'atoQ';
03565 <span class="preprocessor">#endif</span>
03566 <span class="preprocessor"></span>
03567         <span class="keywordflow">if</span> (Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03568             <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>(Process,
03569                               PoolType &amp; BASE_POOL_TYPE_MASK,
03570                               (ULONG)Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; POOL_BLOCK_SHIFT);
03571 
03572             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
03573         }
03574 
03575     }
03576 
03577     <span class="keywordflow">return</span>;
03578 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a72" doxytag="ex/pool.c::ExUnlockPool" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ExUnlockPool           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN KIRQL&nbsp;</td>
          <td class="mdname" nowrap> <em>LockHandle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00565">565</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
<pre class="fragment"><div>00572                    :
00573 
00574     This function unlocks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> specified by <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
00575 
00576 
00577 Arguments:
00578 
00579     PoolType - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> that should be unlocked.
00580 
00581     LockHandle - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock handle from a previous call to
00582                  <a class="code" href="../../d2/d2/ex_2pool_8c.html#a71">ExLockPool</a>.
00583 
00584 Return Value:
00585 
00586     None.
00587 
00588 --*/
00589 
00590 {
00591 
00592     <span class="comment">//</span>
00593     <span class="comment">// If the pool type is nonpaged, then use a spinlock to unlock the</span>
00594     <span class="comment">// pool. Otherwise, use a fast mutex to unlock the pool.</span>
00595     <span class="comment">//</span>
00596 
00597     <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>) == <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>) {
00598         ExReleaseSpinLock(&amp;NonPagedPoolLock, LockHandle);
00599 
00600     } <span class="keywordflow">else</span> {
00601         ExReleaseFastMutex((<a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a>)PoolVector[PagedPool]-&gt;LockAddress);
00602     }
00603 
00604     <span class="keywordflow">return</span>;
00605 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a73" doxytag="ex/pool.c::InitializePool" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID InitializePool           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Threshold</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
DBG<p>
DBG 
<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00677">677</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
<pre class="fragment"><div>00684                    :
00685 
00686     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> initializes a <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> descriptor <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>
00687     <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.  Once initialized, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> may be used <span class="keywordflow">for</span> allocation and
00688     deallocation.
00689 
00690     This function should be called once <span class="keywordflow">for</span> each base <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> during
00691     system initialization.
00692 
00693     Each <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> descriptor contains an array of list heads <span class="keywordflow">for</span> free
00694     blocks.  Each list head holds blocks which are a multiple of
00695     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> POOL_BLOCK_SIZE.  The first element on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list [0] links
00696     together free entries of size POOL_BLOCK_SIZE, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second element
00697     [1] links together entries of POOL_BLOCK_SIZE * 2, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> third
00698     POOL_BLOCK_SIZE * 3, etc, up to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of blocks which fit
00699     into a page.
00700 
00701 Arguments:
00702 
00703     PoolType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> being initialized (e.g.
00704                nonpaged pool, paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>...).
00705 
00706     Threshold - Supplies the threshold value <span class="keywordflow">for</span> the specified <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
00707 
00708 Return Value:
00709 
00710     None.
00711 
00712 --*/
00713 
00714 {
00715 
00716     <a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">PPOOL_DESCRIPTOR</a> Descriptor;
00717     ULONG Index;
00718     <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a> FastMutex;
00719     SIZE_T Size;
00720 
00721     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((PoolType &amp; MUST_SUCCEED_POOL_TYPE_MASK) == 0);
00722 
00723     <span class="keywordflow">if</span> (PoolType == NonPagedPool) {
00724 
00725         <span class="comment">//</span>
00726         <span class="comment">// Initialize nonpaged pools.</span>
00727         <span class="comment">//</span>
00728 
00729 #<span class="keywordflow">if</span> !DBG
00730         <span class="keywordflow">if</span> (NtGlobalFlag &amp; FLG_POOL_ENABLE_TAGGING) {
00731 #endif  
00732             PoolTrackTableSize = MAX_TRACKER_TABLE;
00733             PoolTrackTableMask = PoolTrackTableSize - 2;
00734             PoolTrackTable = <a class="code" href="../../d1/d6/allocpag_8c.html#a54">MiAllocatePoolPages</a>(NonPagedPool,
00735                                                  PoolTrackTableSize *
00736                                                    <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html">POOL_TRACKER_TABLE</a>),
00737                                                  FALSE);
00738 
00739             RtlZeroMemory(PoolTrackTable, PoolTrackTableSize * <span class="keyword">sizeof</span>(POOL_TRACKER_TABLE));
00740 
00741             PoolBigPageTableSize = MAX_BIGPAGE_TABLE;
00742             PoolBigPageTableHash = PoolBigPageTableSize - 1;
00743             PoolBigPageTable = <a class="code" href="../../d1/d6/allocpag_8c.html#a54">MiAllocatePoolPages</a>(NonPagedPool,
00744                                                    PoolBigPageTableSize *
00745                                                      <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d9/struct__POOL__TRACKER__BIG__PAGES.html">POOL_TRACKER_BIG_PAGES</a>),
00746                                                    FALSE);
00747 
00748             RtlZeroMemory(PoolBigPageTable, PoolBigPageTableSize * <span class="keyword">sizeof</span>(POOL_TRACKER_BIG_PAGES));
00749 #<span class="keywordflow">if</span> !DBG
00750         }
00751 #endif  
00752 
00753         <span class="comment">//</span>
00754         <span class="comment">// Initialize the spinlocks for nonpaged pool.</span>
00755         <span class="comment">//</span>
00756 
00757         KeInitializeSpinLock (&amp;ExpTaggedPoolLock);
00758         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;NonPagedPoolLock);
00759 
00760         <span class="comment">//</span>
00761         <span class="comment">// Initialize the nonpaged pool descriptor.</span>
00762         <span class="comment">//</span>
00763 
00764         PoolVector[NonPagedPool] = &amp;NonPagedPoolDescriptor;
00765         <a class="code" href="../../d4/d2/pool_8h.html#a35">ExpInitializePoolDescriptor</a>(&amp;NonPagedPoolDescriptor,
00766                                     NonPagedPool,
00767                                     0,
00768                                     Threshold,
00769                                     (PVOID)&amp;NonPagedPoolLock);
00770 
00771         <span class="comment">//</span>
00772         <span class="comment">// Initialize the nonpaged must succeed pool descriptor.</span>
00773         <span class="comment">//</span>
00774 
00775         PoolVector[NonPagedPoolMustSucceed] = &amp;NonPagedPoolDescriptorMS;
00776         <a class="code" href="../../d4/d2/pool_8h.html#a35">ExpInitializePoolDescriptor</a>(&amp;NonPagedPoolDescriptorMS,
00777                                     NonPagedPoolMustSucceed,
00778                                     0,
00779                                     0,
00780                                     (PVOID)&amp;NonPagedPoolLock);
00781 
00782     } <span class="keywordflow">else</span> {
00783 
00784         <span class="comment">//</span>
00785         <span class="comment">// Allocate memory for the paged pool descriptors and fast mutexes.</span>
00786         <span class="comment">//</span>
00787 
00788         Size = (ExpNumberOfPagedPools + 1) * (<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a>) + <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">POOL_DESCRIPTOR</a>));
00789         Descriptor = (<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">PPOOL_DESCRIPTOR</a>)ExAllocatePoolWithTag (NonPagedPool,
00790                                                               Size,
00791                                                               'looP');
00792         <span class="keywordflow">if</span> (Descriptor == NULL) {
00793             KeBugCheckEx (MUST_SUCCEED_POOL_EMPTY,
00794                           Size,
00795                           (ULONG_PTR)-1,
00796                           (ULONG_PTR)-1,
00797                           (ULONG_PTR)-1);
00798         }
00799 
00800         <span class="keywordflow">if</span> (PoolTrackTable) {
00801             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a65">ExpInsertPoolTracker</a>('looP',
00802                                   (ULONG) <a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a>(PoolTrackTableSize * <span class="keyword">sizeof</span>(POOL_TRACKER_TABLE)),
00803                                  NonPagedPool);
00804 
00805             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a65">ExpInsertPoolTracker</a>('looP',
00806                                   (ULONG) <a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a>(PoolBigPageTableSize * <span class="keyword">sizeof</span>(POOL_TRACKER_BIG_PAGES)),
00807                                  NonPagedPool);
00808         }
00809 
00810         FastMutex = (<a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a>)(Descriptor + ExpNumberOfPagedPools + 1);
00811         PoolVector[PagedPool] = Descriptor;
00812         ExpPagedPoolDescriptor = Descriptor;
00813         <span class="keywordflow">for</span> (Index = 0; Index &lt; (ExpNumberOfPagedPools + 1); Index += 1) {
00814             <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(FastMutex);
00815             <a class="code" href="../../d4/d2/pool_8h.html#a35">ExpInitializePoolDescriptor</a>(Descriptor,
00816                                         PagedPool,
00817                                         Index,
00818                                         Threshold,
00819                                         (PVOID)FastMutex);
00820 
00821             Descriptor += 1;
00822             FastMutex += 1;
00823         }
00824     }
00825 
00826     <span class="comment">//</span>
00827     <span class="comment">// The maximum cache alignment must be less than the size of the</span>
00828     <span class="comment">// smallest pool block because the lower bits are being cleared</span>
00829     <span class="comment">// in ExFreePool to find the entry's address.</span>
00830     <span class="comment">//</span>
00831 
00832 #<span class="keywordflow">if</span> POOL_CACHE_SUPPORTED
00833 
00834     <span class="comment">//</span>
00835     <span class="comment">// Compute pool cache information.</span>
00836     <span class="comment">//</span>
00837 
00838     PoolCacheSize = HalGetDmaAlignmentRequirement();
00839 
00840     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PoolCacheSize &gt;= POOL_OVERHEAD);
00841 
00842     PoolCacheOverhead = PoolCacheSize + PoolCacheSize - (<span class="keyword">sizeof</span>(<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">POOL_HEADER</a>) + 1);
00843 
00844     PoolBuddyMax =
00845        (POOL_PAGE_SIZE - (POOL_OVERHEAD + (3*POOL_SMALLEST_BLOCK) + 2*PoolCacheSize));
00846 
00847 #endif <span class="comment">//POOL_CACHE_SUPPORTED</span>
00848 
00849 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a62" doxytag="ex/pool.c::MmSqueezeBadTags" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MmSqueezeBadTags           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Tag</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SpecialPoolType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/allocpag_8c-source.html#l03325">3325</a> of file <a class="el" href="../../d2/d5/allocpag_8c-source.html">allocpag.c</a>.
<p>
References <a class="el" href="../../d2/d5/allocpag_8c-source.html#l03188">_MI_BAD_TAGS::Allocations</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l03186">_MI_BAD_TAGS::AllOthers</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l03184">_MI_BAD_TAGS::Enabled</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l03192">MiBadTags</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l03408">MmAllocateSpecialPool()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l03189">_MI_BAD_TAGS::RandomizerEnabled</a>, and <a class="el" href="../../d2/d5/allocpag_8c-source.html#l03185">_MI_BAD_TAGS::TargetChar</a>.
<p>
<pre class="fragment"><div>03334                    :
03335 
03336     This routine squeezes bad tags by forcing them into special <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> in a
03337     systematic fashion.
03338 
03339 Arguments:
03340 
03341     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes to commit.
03342 
03343     Tag - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tag of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested allocation.
03344 
03345     PoolType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested allocation.
03346 
03347     SpecialPoolType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> special <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03348                       requested allocation.
03349 
03350                       - 0 indicates overruns.
03351                       - 1 indicates underruns.
03352                       - 2 indicates use <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> systemwide <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> policy.
03353 
03354 Return Value:
03355 
03356     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> non-<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> pointer <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested allocation was fulfilled from special
03357     <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation was not <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a>.
03358 
03359 Environment:
03360 
03361     Kernel mode, no locks (not even pool locks) held.
03362 
03363 --*/
03364 
03365 {
03366     PUCHAR tc;
03367 
03368     <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d6/allocpag_8c.html#a30">MiBadTags</a>.<a class="code" href="../../d0/d9/struct__MI__BAD__TAGS.html#o0">Enabled</a> % 0x10) == 0) {
03369         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03370     }
03371 
03372     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d6/allocpag_8c.html#a30">MiBadTags</a>.<a class="code" href="../../d0/d9/struct__MI__BAD__TAGS.html#o5">RandomizerEnabled</a> == 0) {
03373         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03374     }
03375 
03376     tc = (PUCHAR)&amp;Tag;
03377     <span class="keywordflow">if</span> (*tc == <a class="code" href="../../d1/d6/allocpag_8c.html#a30">MiBadTags</a>.<a class="code" href="../../d0/d9/struct__MI__BAD__TAGS.html#o1">TargetChar</a>) {
03378         ;
03379     }
03380     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d6/allocpag_8c.html#a30">MiBadTags</a>.<a class="code" href="../../d0/d9/struct__MI__BAD__TAGS.html#o2">AllOthers</a> == 1) {
03381         <span class="keywordflow">if</span> (*tc &gt;= <span class="charliteral">'a'</span> &amp;&amp; *tc &lt;= <span class="charliteral">'z'</span>) {
03382             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03383         }
03384         <span class="keywordflow">if</span> (*tc &gt;= <span class="charliteral">'A'</span> &amp;&amp; *tc &lt;= <span class="charliteral">'Z'</span>) {
03385             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03386         }
03387     }
03388     <span class="keywordflow">else</span> {
03389         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03390     }
03391 
03392     <a class="code" href="../../d1/d6/allocpag_8c.html#a30">MiBadTags</a>.<a class="code" href="../../d0/d9/struct__MI__BAD__TAGS.html#o4">Allocations</a> += 1;
03393 
03394     <span class="keywordflow">return</span> <a class="code" href="../../d1/d6/allocpag_8c.html#a60">MmAllocateSpecialPool</a>(NumberOfBytes, Tag, PoolType, SpecialPoolType);
03395 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a76" doxytag="ex/pool.c::VeAllocatePoolWithTagPriority" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID VeAllocatePoolWithTagPriority           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Tag</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d8/ex_8h.html#a97">EX_POOL_PRIORITY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Priority</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>CallingAddress</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/verifier_8c-source.html#l01812">1812</a> of file <a class="el" href="../../d0/d5/verifier_8c-source.html">verifier.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00050">BASE_POOL_TYPE_MASK</a>, <a class="el" href="../../d5/d8/ex_8h.html#a97">EX_POOL_PRIORITY</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l03828">ExAllocatePoolSanityChecks()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00993">ExAllocatePoolWithTagPriority()</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04111">_MI_VERIFIER_DRIVER_ENTRY::Flags</a>, <a class="el" href="../../d5/d8/ex_8h.html#a330a189">LowPoolPrioritySpecialPoolOverrun</a>, <a class="el" href="../../d5/d8/ex_8h.html#a330a190">LowPoolPrioritySpecialPoolUnderrun</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00334">MI_ROUND_TO_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00084">MmSpecialPoolCatchOverruns</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00097">MmVerifierData</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00052">MUST_SUCCEED_POOL_TYPE_MASK</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00144">POOL_RAISE_IF_ALLOCATION_FAILURE</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00058">POOL_VERIFIER_MASK</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00056">SESSION_POOL_MASK</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04108">VI_VERIFYING_DIRECTLY</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l01566">ViCancelPoolAllocation()</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l01168">ViInjectResourceFailure()</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l03396">ViLocateVerifierEntry()</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l01614">ViPostPoolAllocation()</a>, and <a class="el" href="../../d0/d5/verifier_8c-source.html#l01233">ViReservePoolAllocation()</a>.
<p>
<pre class="fragment"><div>01822                    :
01823 
01824     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called both from ex\<a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.c and directly within <span class="keyword">this</span> module.
01825 
01826         - Performs sanity checks on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
01827         - Can optionally provide allocation failures to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
01828         - Attempts to provide <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation from special <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
01829         - Tracks <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> to ensure callers free everything they allocate.
01830 
01831 --*/
01832 
01833 {
01834     PVOID VirtualAddress;
01835     <a class="code" href="../../d5/d8/ex_8h.html#a97">EX_POOL_PRIORITY</a> AllocationPriority;
01836     SIZE_T ChargedBytes;
01837     <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a> Verifier;
01838     LOGICAL ReservedHash;
01839     ULONG HeaderSize;
01840 
01841     <a class="code" href="../../d5/d8/ex_8h.html#a217">ExAllocatePoolSanityChecks</a> (PoolType, NumberOfBytes);
01842 
01843     InterlockedIncrement ((PLONG)&amp;<a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.AllocationsAttempted);
01844 
01845     <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a6">MUST_SUCCEED_POOL_TYPE_MASK</a>) == 0) {
01846 
01847         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/verifier_8c.html#a93">ViInjectResourceFailure</a> () == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01848 
01849             <span class="comment">//</span>
01850             <span class="comment">// Caller requested an exception - throw it here.</span>
01851             <span class="comment">//</span>
01852 
01853             <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d5/d8/ex_8h.html#a3">POOL_RAISE_IF_ALLOCATION_FAILURE</a>) != 0) {
01854                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INSUFFICIENT_RESOURCES);
01855             }
01856 
01857             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01858         }
01859     }
01860 
01861     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((PoolType &amp; POOL_VERIFIER_MASK) == 0);
01862 
01863     AllocationPriority = Priority;
01864 
01865     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.Level &amp; DRIVER_VERIFIER_SPECIAL_POOLING) {
01866 
01867         <span class="comment">//</span>
01868         <span class="comment">// Try for a special pool overrun allocation unless the caller has</span>
01869         <span class="comment">// explicitly specified otherwise.</span>
01870         <span class="comment">//</span>
01871 
01872         <span class="keywordflow">if</span> ((AllocationPriority &amp; (<a class="code" href="../../d5/d8/ex_8h.html#a330a189">LowPoolPrioritySpecialPoolOverrun</a> | <a class="code" href="../../d5/d8/ex_8h.html#a330a190">LowPoolPrioritySpecialPoolUnderrun</a>)) == 0) {
01873             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a28">MmSpecialPoolCatchOverruns</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01874                 AllocationPriority |= <a class="code" href="../../d5/d8/ex_8h.html#a330a189">LowPoolPrioritySpecialPoolOverrun</a>;
01875             }
01876             <span class="keywordflow">else</span> {
01877                 AllocationPriority |= <a class="code" href="../../d5/d8/ex_8h.html#a330a190">LowPoolPrioritySpecialPoolUnderrun</a>;
01878             }
01879         }
01880     }
01881 
01882     ReservedHash = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01883     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.Level &amp; DRIVER_VERIFIER_TRACK_POOL_ALLOCATIONS) {
01884 
01885         <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a>) &amp;&amp; (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
01886 
01887             <span class="comment">//</span>
01888             <span class="comment">// Session pool is directly tracked by default already.</span>
01889             <span class="comment">//</span>
01890 
01891             NOTHING;
01892         }
01893         <span class="keywordflow">else</span> {
01894             HeaderSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d9/struct__MI__VERIFIER__POOL__HEADER.html">MI_VERIFIER_POOL_HEADER</a>);
01895 
01896             ChargedBytes = <a class="code" href="../../d4/d8/mi_8h.html#a90">MI_ROUND_TO_SIZE</a> (NumberOfBytes, <span class="keyword">sizeof</span>(ULONG)) + HeaderSize;
01897             Verifier = <a class="code" href="../../d9/d5/verifier_8c.html#a105">ViLocateVerifierEntry</a> (CallingAddress);
01898 
01899             <span class="keywordflow">if</span> ((Verifier == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01900                 ((Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o6">Flags</a> &amp; <a class="code" href="../../d4/d8/mi_8h.html#a252">VI_VERIFYING_DIRECTLY</a>) == 0)) {
01901 
01902                 <span class="comment">//</span>
01903                 <span class="comment">// This can happen for many reasons including no framing (which</span>
01904                 <span class="comment">// can cause RtlGetCallersAddress to return the wrong address),</span>
01905                 <span class="comment">// etc.</span>
01906                 <span class="comment">//</span>
01907 
01908                 <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.UnTrackedPool += 1;
01909             }
01910             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ChargedBytes &lt;= NumberOfBytes) {
01911 
01912                 <span class="comment">//</span>
01913                 <span class="comment">// Don't let the verifier header transform a bad caller into a</span>
01914                 <span class="comment">// good caller.  Fail via the fall through so an exception</span>
01915                 <span class="comment">// can be thrown if asked for, etc.</span>
01916                 <span class="comment">//</span>
01917 
01918                 <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.UnTrackedPool += 1;
01919             }
01920             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a6">MUST_SUCCEED_POOL_TYPE_MASK</a>) == 0) ||
01921                      (ChargedBytes &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) {
01922 
01923                 <span class="comment">//</span>
01924                 <span class="comment">// Any pool allocation that is allowed to fail or where the</span>
01925                 <span class="comment">// total number of charged bytes fits in a page (nonpaged-</span>
01926                 <span class="comment">// must-succeed requires this) is suitable for tracking.</span>
01927                 <span class="comment">// Just ensure that the hash list has space for it.</span>
01928                 <span class="comment">//</span>
01929 
01930                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/verifier_8c.html#a96">ViReservePoolAllocation</a> (Verifier) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01931                     ReservedHash = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01932                     NumberOfBytes = ChargedBytes;
01933                     PoolType |= <a class="code" href="../../d4/d2/pool_8h.html#a9">POOL_VERIFIER_MASK</a>;
01934                 }
01935             }
01936             <span class="keywordflow">else</span> {
01937                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((PoolType &amp; BASE_POOL_TYPE_MASK) == NonPagedPool);
01938                 <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.UnTrackedPool += 1;
01939             }
01940         }
01941     }
01942 
01943     VirtualAddress = <a class="code" href="../../d5/d8/ex_8h.html#a222">ExAllocatePoolWithTagPriority</a> (PoolType,
01944                                                     NumberOfBytes,
01945                                                     Tag,
01946                                                     AllocationPriority);
01947 
01948     <span class="keywordflow">if</span> (VirtualAddress == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01949         <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.AllocationsFailed += 1;
01950 
01951         <span class="keywordflow">if</span> (ReservedHash == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01952 
01953             <span class="comment">//</span>
01954             <span class="comment">// Release the hash table entry now as it's not needed.</span>
01955             <span class="comment">//</span>
01956 
01957             <a class="code" href="../../d9/d5/verifier_8c.html#a98">ViCancelPoolAllocation</a> (Verifier);
01958         }
01959 
01960         <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d5/d8/ex_8h.html#a3">POOL_RAISE_IF_ALLOCATION_FAILURE</a>) != 0) {
01961             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INSUFFICIENT_RESOURCES);
01962         }
01963         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01964     }
01965 
01966     VirtualAddress = <a class="code" href="../../d9/d5/verifier_8c.html#a104">ViPostPoolAllocation</a> (VirtualAddress,
01967                                            NumberOfBytes,
01968                                            PoolType,
01969                                            Tag,
01970                                            CallingAddress);
01971 
01972     <span class="keywordflow">return</span> VirtualAddress;
01973 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a51" doxytag="ex/pool.c::ExpNumberOfPagedPools" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d9/d5/4_2kddata_8c.html#a4">ExpNumberOfPagedPools</a> = NUMBER_OF_PAGED_POOLS          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00429">429</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l03405">ExQueryPoolUsage()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00677">InitializePool()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a55" doxytag="ex/pool.c::ExpPagedPoolDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">PPOOL_DESCRIPTOR</a> <a class="el" href="../../d9/d5/4_2kddata_8c.html#a3">ExpPagedPoolDescriptor</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00452">452</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00677">InitializePool()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="ex/pool.c::ExpPoolBugCheckLine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d2/d2/ex_2pool_8c.html#a39">ExpPoolBugCheckLine</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00115">115</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a57" doxytag="ex/pool.c::ExpPoolIndex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> volatile ULONG <a class="el" href="../../d2/d2/ex_2pool_8c.html#a57">ExpPoolIndex</a> = 1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00462">462</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="ex/pool.c::ExpSessionPoolDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">PPOOL_DESCRIPTOR</a> <a class="el" href="../../d2/d2/ex_2pool_8c.html#a40">ExpSessionPoolDescriptor</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00349">349</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00993">ExAllocatePoolWithTagPriority()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">ExFreePoolWithTag()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00609">ExpInitializePoolDescriptor()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a59" doxytag="ex/pool.c::ExpSmallNPagedPoolLookasideLists" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a> <a class="el" href="../../d2/d2/ex_2pool_8c.html#a59">ExpSmallNPagedPoolLookasideLists</a>[POOL_SMALL_LISTS]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00483">483</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a60" doxytag="ex/pool.c::ExpSmallPagedPoolLookasideLists" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a> <a class="el" href="../../d2/d2/ex_2pool_8c.html#a60">ExpSmallPagedPoolLookasideLists</a>[POOL_SMALL_LISTS]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00485">485</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a58" doxytag="ex/pool.c::ExpTaggedPoolLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> KSPIN_LOCK <a class="el" href="../../d6/d8/sysinfo_8c.html#a27">ExpTaggedPoolLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00463">463</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02324">ExpAddTagForBigPages()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02461">ExpFindAndRemoveTagBigPages()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l04104">ExpGetPoolTagInfo()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02000">ExpInsertPoolTracker()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02231">ExpRemovePoolTracker()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00677">InitializePool()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a41" doxytag="ex/pool.c::FirstPrint" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d2/d2/ex_2pool_8c.html#a41">FirstPrint</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00350">350</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02324">ExpAddTagForBigPages()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02461">ExpFindAndRemoveTagBigPages()</a>, and <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00317">KiDumpParameterImages()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a61" doxytag="ex/pool.c::KernelVerifier" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL <a class="el" href="../../d9/d5/verifier_8c.html#a35">KernelVerifier</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00987">987</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l03448">MiApplyDriverVerifier()</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l04712">MiEnableVerifier()</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l03121">MiInitializeDriverVerifierList()</a>, <a class="el" href="../../d2/d1/mm_2i386_2init386_8c-source.html#l00058">MiInitMachineDependent()</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l03625">MiVerifyingDriverUnloading()</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l00927">VerifierAllocatePool()</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l01003">VerifierAllocatePoolWithQuota()</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l01059">VerifierAllocatePoolWithQuotaTag()</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l00965">VerifierAllocatePoolWithTag()</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l01115">VerifierAllocatePoolWithTagPriority()</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l02129">VerifierFreePool()</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l02143">VerifierFreePoolWithTag()</a>, and <a class="el" href="../../d0/d5/verifier_8c-source.html#l02333">ViTrimAllSystemPagableMemory()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a52" doxytag="ex/pool.c::NonPagedPoolDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">POOL_DESCRIPTOR</a> <a class="el" href="../../d5/d6/iosup_8c.html#a16">NonPagedPoolDescriptor</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00440">440</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00506">ExLockPool()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00677">InitializePool()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00807">MiAllocatePoolPages()</a>, and <a class="el" href="../../d2/d5/allocpag_8c-source.html#l04569">MiFindContiguousMemory()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a53" doxytag="ex/pool.c::NonPagedPoolDescriptorMS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">POOL_DESCRIPTOR</a> <a class="el" href="../../d5/d2/poolhack_8c.html#a19">NonPagedPoolDescriptorMS</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00441">441</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00677">InitializePool()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a56" doxytag="ex/pool.c::NonPagedPoolLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> KSPIN_LOCK <a class="el" href="../../d5/d2/poolhack_8c.html#a21">NonPagedPoolLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00454">454</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00565">ExUnlockPool()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00677">InitializePool()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a45" doxytag="ex/pool.c::PoolBigPageTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d9/struct__POOL__TRACKER__BIG__PAGES.html">PPOOL_TRACKER_BIG_PAGES</a> <a class="el" href="../../d2/d2/ex_2pool_8c.html#a45">PoolBigPageTable</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00356">356</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01893">ExInsertPoolTag()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02324">ExpAddTagForBigPages()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02461">ExpFindAndRemoveTagBigPages()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01951">ExRemovePoolTag()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00677">InitializePool()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a47" doxytag="ex/pool.c::PoolBigPageTableHash" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> SIZE_T <a class="el" href="../../d2/d2/ex_2pool_8c.html#a47">PoolBigPageTableHash</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00358">358</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02324">ExpAddTagForBigPages()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02461">ExpFindAndRemoveTagBigPages()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00677">InitializePool()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a46" doxytag="ex/pool.c::PoolBigPageTableSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> SIZE_T <a class="el" href="../../d2/d2/ex_2pool_8c.html#a46">PoolBigPageTableSize</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00357">357</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02324">ExpAddTagForBigPages()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02461">ExpFindAndRemoveTagBigPages()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00677">InitializePool()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a48" doxytag="ex/pool.c::PoolHitTag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d2/d2/ex_2pool_8c.html#a48">PoolHitTag</a> = 0xffffff0f          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00360">360</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02000">ExpInsertPoolTracker()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02231">ExpRemovePoolTracker()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a42" doxytag="ex/pool.c::PoolTrackTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html">PPOOL_TRACKER_TABLE</a> <a class="el" href="../../d9/d5/4_2kddata_8c.html#a44">PoolTrackTable</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00352">352</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">ExFreePoolWithTag()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01893">ExInsertPoolTag()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l04104">ExpGetPoolTagInfo()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02000">ExpInsertPoolTracker()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02231">ExpRemovePoolTracker()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l03328">ExQueryPoolBlockSize()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01951">ExRemovePoolTag()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00677">InitializePool()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a44" doxytag="ex/pool.c::PoolTrackTableMask" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> SIZE_T <a class="el" href="../../d2/d2/ex_2pool_8c.html#a44">PoolTrackTableMask</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00354">354</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02000">ExpInsertPoolTracker()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02231">ExpRemovePoolTracker()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00677">InitializePool()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a43" doxytag="ex/pool.c::PoolTrackTableSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> SIZE_T <a class="el" href="../../d6/d8/sysinfo_8c.html#a26">PoolTrackTableSize</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00353">353</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l04104">ExpGetPoolTagInfo()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02000">ExpInsertPoolTracker()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02231">ExpRemovePoolTracker()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00677">InitializePool()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a54" doxytag="ex/pool.c::PoolVector" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">PPOOL_DESCRIPTOR</a> <a class="el" href="../../d5/d2/poolhack_8c.html#a23">PoolVector</a>[NUMBER_OF_POOLS]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00451">451</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/poolhack_8c-source.html#l01400">CheckPool()</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l01351">DumpPool()</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00413">ExAllocatePool()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00970">ExFreePool()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">ExFreePoolWithTag()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00506">ExLockPool()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l03405">ExQueryPoolUsage()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l03480">ExReturnPoolQuota()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00565">ExUnlockPool()</a>, and <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00677">InitializePool()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a49" doxytag="ex/pool.c::RtlAllocateStringRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PRTL_ALLOCATE_STRING_ROUTINE <a class="el" href="../../d2/d2/ex_2pool_8c.html#a49">RtlAllocateStringRoutine</a> = ExpAllocateStringRoutine          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00410">410</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/psinit_8c-source.html#l00525">PsLocateSystemDll()</a>, <a class="el" href="../../d5/d6/rtl_2regutil_8c-source.html#l00200">RtlpQueryRegistryDirect()</a>, and <a class="el" href="../../d2/d6/guid_8c-source.html#l00051">RtlStringFromGUID()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a50" doxytag="ex/pool.c::RtlFreeStringRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PRTL_FREE_STRING_ROUTINE <a class="el" href="../../d2/d2/ex_2pool_8c.html#a50">RtlFreeStringRoutine</a> = (PRTL_FREE_STRING_ROUTINE)ExFreePool          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00411">411</a> of file <a class="el" href="../../d3/d1/ex_2pool_8c-source.html">ex/pool.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:17 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
