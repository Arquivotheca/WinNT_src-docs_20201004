<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cmparse.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cmparse.c File Reference</h1><code>#include "<a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>"</code><br>

<p>
<a href="../../d3/d1/cmparse_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d4/struct__CM__HASH__ENTRY.html">_CM_HASH_ENTRY</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/cmparse_8c.html#a0">CM_HASH_STACK_SIZE</a>&nbsp;&nbsp;&nbsp;30</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/cmparse_8c.html#a1">CmpStepThroughExit</a>(h, <a class="el" href="../../d7/d1/genuedef_8c.html#a8">c</a>, <a class="el" href="../../d7/d0/exts_8h.html#a0">n</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/cmparse_8c.html#a2">CMP_PARSE_GOTO_NONE</a>&nbsp;&nbsp;&nbsp;0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/cmparse_8c.html#a3">CMP_PARSE_GOTO_CREATE</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/cmparse_8c.html#a4">CMP_PARSE_GOTO_RETURN</a>&nbsp;&nbsp;&nbsp;2</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/cmparse_8c.html#a5">CMP_PARSE_GOTO_RETURN2</a>&nbsp;&nbsp;&nbsp;3</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d1/d4/struct__CM__HASH__ENTRY.html">_CM_HASH_ENTRY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/cmparse_8c.html#a11">CM_HASH_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d1/d4/struct__CM__HASH__ENTRY.html">_CM_HASH_ENTRY</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/cmparse_8c.html#a12">PCM_HASH_ENTRY</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/cmparse_8c.html#a13">CmpComputeHashValue</a> (IN <a class="el" href="../../d1/d4/struct__CM__HASH__ENTRY.html">PCM_HASH_ENTRY</a> HashStack, IN OUT ULONG *TotalSubkeys, IN ULONG BaseConvKey, IN PUNICODE_STRING RemainingName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/cmparse_8c.html#a14">CmpCacheLookup</a> (IN <a class="el" href="../../d1/d4/struct__CM__HASH__ENTRY.html">PCM_HASH_ENTRY</a> HashStack, IN ULONG TotalRemainingSubkeys, OUT ULONG *MatchRemainSubkeyLevel, IN OUT <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> *Kcb, OUT PUNICODE_STRING RemainingName, OUT <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> *<a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, OUT <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> *<a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/cmparse_8c.html#a15">CmpCacheAdd</a> (IN <a class="el" href="../../d1/d4/struct__CM__HASH__ENTRY.html">PCM_HASH_ENTRY</a> LastHashEntry, IN ULONG <a class="el" href="../../d6/d0/cmdat_8c.html#a5">Count</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/cmparse_8c.html#a16">CmpAddInfoAfterParseFailure</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>, <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node, <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> kcb, PUNICODE_STRING NodeName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/cmparse_8c.html#a17">CmpGetSymbolicLink</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node, IN OUT PUNICODE_STRING ObjectName, IN OUT <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> SymbolicKcb, IN PUNICODE_STRING RemainingName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/cmparse_8c.html#a18">CmpDoOpen</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>, IN <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node, IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, IN ULONG Attributes, IN <a class="el" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">PCM_PARSE_CONTEXT</a> Context, IN BOOLEAN CompleteKeyCached, IN OUT <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> *CachedKcb, IN PUNICODE_STRING <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>, OUT PVOID *Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/cmparse_8c.html#a19">CmpCreateLinkNode</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>, IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState, IN UNICODE_STRING <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, IN ULONG Attributes, IN <a class="el" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">PCM_PARSE_CONTEXT</a> Context, IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> ParentKcb, OUT PVOID *Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/cmparse_8c.html#a20">CmpParseKey</a> (IN PVOID ParseObject, IN PVOID ObjectType, IN OUT <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, IN ULONG Attributes, IN OUT PUNICODE_STRING CompleteName, IN OUT PUNICODE_STRING RemainingName, IN OUT PVOID Context OPTIONAL, IN PSECURITY_QUALITY_OF_SERVICE <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a9">SecurityQos</a> OPTIONAL, OUT PVOID *Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/cmparse_8c.html#a21">CmpGetNextName</a> (IN OUT PUNICODE_STRING RemainingName, OUT PUNICODE_STRING NextName, OUT PBOOLEAN Last)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/cmparse_8c.html#a6">CmpCacheOnFlag</a> = CM_CACHE_FAKE_KEY</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/cmparse_8c.html#a7">CmpMasterHive</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/cmparse_8c.html#a8">CmpNoMasterCreates</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/cmparse_8c.html#a9">CmpKeyControlBlockRoot</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UNICODE_STRING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d2/cmparse_8c.html#a10">CmSymbolicLinkValueName</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="cmparse.c::CM_HASH_STACK_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CM_HASH_STACK_SIZE&nbsp;&nbsp;&nbsp;30          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00030">30</a> of file <a class="el" href="../../d3/d1/cmparse_8c-source.html">cmparse.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01737">CmpComputeHashValue()</a>, and <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="cmparse.c::CMP_PARSE_GOTO_CREATE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMP_PARSE_GOTO_CREATE&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00139">139</a> of file <a class="el" href="../../d3/d1/cmparse_8c-source.html">cmparse.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="cmparse.c::CMP_PARSE_GOTO_NONE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMP_PARSE_GOTO_NONE&nbsp;&nbsp;&nbsp;0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00138">138</a> of file <a class="el" href="../../d3/d1/cmparse_8c-source.html">cmparse.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="cmparse.c::CMP_PARSE_GOTO_RETURN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMP_PARSE_GOTO_RETURN&nbsp;&nbsp;&nbsp;2          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00140">140</a> of file <a class="el" href="../../d3/d1/cmparse_8c-source.html">cmparse.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="cmparse.c::CMP_PARSE_GOTO_RETURN2" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMP_PARSE_GOTO_RETURN2&nbsp;&nbsp;&nbsp;3          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00141">141</a> of file <a class="el" href="../../d3/d1/cmparse_8c-source.html">cmparse.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="cmparse.c::CmpStepThroughExit" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmpStepThroughExit          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">h,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d1/genuedef_8c.html#a8">c</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d0/exts_8h.html#a0">n</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><span class="keywordflow">if</span> ((<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>)-&gt;Flags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a28">KEY_HIVE_EXIT</a>) {           \
    (h)=(<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>)-&gt;ChildHiveReference.KeyHive;    \
    (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>)=(<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>)-&gt;ChildHiveReference.KeyCell;    \
    (<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>)=(<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>((h),(c));   \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00131">131</a> of file <a class="el" href="../../d3/d1/cmparse_8c-source.html">cmparse.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a11" doxytag="cmparse.c::CM_HASH_ENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d1/d4/struct__CM__HASH__ENTRY.html">_CM_HASH_ENTRY</a>  <a class="el" href="../../d1/d4/struct__CM__HASH__ENTRY.html">CM_HASH_ENTRY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="cmparse.c::PCM_HASH_ENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d1/d4/struct__CM__HASH__ENTRY.html">_CM_HASH_ENTRY</a> * <a class="el" href="../../d1/d4/struct__CM__HASH__ENTRY.html">PCM_HASH_ENTRY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a16" doxytag="cmparse.c::CmpAddInfoAfterParseFailure" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> CmpAddInfoAfterParseFailure           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Node</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>kcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>NodeName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/cmparse_8c-source.html#l02056">2056</a> of file <a class="el" href="../../d3/d1/cmparse_8c-source.html">cmparse.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00222">CM_CACHE_FAKE_KEY</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00251">CM_KCB_NO_SUBKEY</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00255">CM_KCB_SUBKEY_HINT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00252">CM_KCB_SUBKEY_ONE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00373">CM_KEY_FAST_LEAF</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00245">CM_MAX_CACHE_HINT_SIZE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00244">CM_SUBKEY_HINT_LENGTH</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00220">CmpCacheOnFlag</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00824">CmpCreateKeyControlBlock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01153">CmpDereferenceKeyControlBlock()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00291">ExFreePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d5/d5/regext_8c-source.html#l00458">kcb()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00383">_CM_KEY_FAST_INDEX::List</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00230">LOCK_KCB_TREE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00377">_CM_INDEX::NameHint</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00281">PROTECTED_POOL</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00629">_HHIVE::StorageTypeCount</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00454">_CM_KEY_NODE::SubKeyCounts</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00457">_CM_KEY_NODE::SubKeyLists</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00231">UNLOCK_KCB_TREE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00369">UseFastIndex</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>.
<p>
<pre class="fragment"><div>02065                    :
02066 
02067     This routine builds up further information in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cache when parse
02068     fails.  The additional information can be
02069     1. The key <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> has no subkey (CM_KCB_NO_SUBKEY).
02070     2. The key has a few subkeys, then build <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> index hint in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cache.
02071     3. If lookup failed even we have index hint cached, then create a fake key so
02072        we <span class="keywordflow">do</span> not fail again.   This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> very usful <span class="keywordflow">for</span> lookup <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> under keys like
02073        \registry\machine\software\classes\clsid, which have 1500+ subkeys and lots of
02074        them have <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> smae first four chars.
02075        
02076        NOTE. Currently we are not seeing too many fake keys being created.
02077        We need to monitor <span class="keyword">this</span> periodly and work <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> a way to work around <span class="keywordflow">if</span>
02078        we <span class="keywordflow">do</span> create too many fake keys. 
02079        One solution <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to use hash value <span class="keywordflow">for</span> index hint (We can <span class="keywordflow">do</span> it in the cache only
02080        <span class="keywordflow">if</span> we need to be backward comparible).
02081     
02082 Arguments:
02083 
02084     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> that holds <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key we are creating a KCB <span class="keywordflow">for</span>.
02085 
02086     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - Supplies <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> that contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key we are creating a KCB <span class="keywordflow">for</span>.
02087 
02088     Node - Supplies pointer to key node.
02089 
02090     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> - The <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.
02091 
02092 Return Value:
02093 
02094     The KCB that CmpParse need to dereference at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end.
02095 --*/
02096 {
02097 
02098     ULONG TotalSubKeyCounts;
02099     BOOLEAN CreateFakeKcb = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02100     BOOLEAN HintCached;
02101     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> ParentKcb;
02102     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> i,j,k;
02103 
02104     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/cmdata_8h.html#a17">UseFastIndex</a>(Hive)) {
02105         <span class="comment">//</span>
02106         <span class="comment">// Older version of hive, do not bother to cache hint.</span>
02107         <span class="comment">//</span>
02108         <span class="keywordflow">return</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>);
02109     }
02110 
02111     TotalSubKeyCounts = Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] + Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>];
02112 
02113     <span class="keywordflow">if</span> (TotalSubKeyCounts == 0) {
02114         <a class="code" href="../../d1/d2/cmp_8h.html#a16">LOCK_KCB_TREE</a>();
02115         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ExtFlags |= <a class="code" href="../../d9/d0/cmdata_8h.html#a9">CM_KCB_NO_SUBKEY</a>;
02116         <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
02117     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TotalSubKeyCounts == 1) {
02118         <a class="code" href="../../d1/d2/cmp_8h.html#a16">LOCK_KCB_TREE</a>();
02119         <span class="keywordflow">if</span> (!(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ExtFlags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a10">CM_KCB_SUBKEY_ONE</a>)) {
02120             <span class="comment">//</span>
02121             <span class="comment">// Build the subkey hint to avoid unnecessary lookups in the index leaf</span>
02122             <span class="comment">//</span>
02123             <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02124             <a class="code" href="../../d2/d4/struct__CM__INDEX.html">PCM_INDEX</a>       Hint;
02125 
02126             <span class="keywordflow">if</span> (Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] == 1) {
02127                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Stable]);
02128             } <span class="keywordflow">else</span> {
02129                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Volatile]);
02130             } 
02131 
02132             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == <a class="code" href="../../d9/d0/cmdata_8h.html#a20">CM_KEY_FAST_LEAF</a>) {
02133                 <a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a> FastIndex;
02134                 FastIndex = (<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a>)<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02135                 Hint = &amp;FastIndex-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[0];
02136 
02137                 <span class="keywordflow">for</span> (k=0; k&lt;<a class="code" href="../../d9/d0/cmdata_8h.html#a7">CM_SUBKEY_HINT_LENGTH</a>; k++) {
02138                     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;NameHint[k] = Hint-&gt;<a class="code" href="../../d2/d4/struct__CM__INDEX.html#o1">NameHint</a>[k];
02139                 }
02140 
02141                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ExtFlags |= <a class="code" href="../../d9/d0/cmdata_8h.html#a10">CM_KCB_SUBKEY_ONE</a>;
02142             } 
02143         } <span class="keywordflow">else</span> {
02144             <span class="comment">//</span>
02145             <span class="comment">// The name hint does not prevent from this look up</span>
02146             <span class="comment">// Create the fake Kcb.</span>
02147             <span class="comment">//</span>
02148             CreateFakeKcb = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02149         }
02150         <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
02151     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TotalSubKeyCounts &lt; <a class="code" href="../../d9/d0/cmdata_8h.html#a8">CM_MAX_CACHE_HINT_SIZE</a>) {
02152         <a class="code" href="../../d1/d2/cmp_8h.html#a16">LOCK_KCB_TREE</a>();
02153         <span class="keywordflow">if</span> (!(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ExtFlags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a11">CM_KCB_SUBKEY_HINT</a>)) {
02154             <span class="comment">//</span>
02155             <span class="comment">// Build the index leaf info in the parent KCB</span>
02156             <span class="comment">// How to sync the cache with the registry data is a problem to be resolved.</span>
02157             <span class="comment">//</span>
02158             ULONG <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
02159             <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02160             <a class="code" href="../../d2/d4/struct__CM__INDEX.html">PCM_INDEX</a>       Hint;
02161             <a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a> FastIndex;
02162             UCHAR           *NameHint;
02163 
02164             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <span class="keyword">sizeof</span>(ULONG) * (Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] + Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>] + 1);
02165 
02166             <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;IndexHint = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(PagedPool,
02167                                                    Size,
02168                                                    CM_CACHE_INDEX_TAG | PROTECTED_POOL);
02169 
02170             HintCached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02171             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;IndexHint) {
02172                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;IndexHint-&gt;Count = Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] + Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>]; 
02173 
02174                 NameHint = &amp;(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;IndexHint-&gt;NameHint[0]);
02175 
02176                 <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o20">StorageTypeCount</a>; i++) {
02177                     <span class="keywordflow">if</span>(Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[i]) {
02178                         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[i]);
02179                         <span class="keywordflow">for</span> (j=0; j&lt;Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[i]; j++) {
02180                             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == <a class="code" href="../../d9/d0/cmdata_8h.html#a20">CM_KEY_FAST_LEAF</a>) {
02181                                 FastIndex = (<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a>)<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02182                                 Hint = &amp;FastIndex-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[j];
02183                 
02184                                 <span class="keywordflow">for</span> (k=0; k&lt;<a class="code" href="../../d9/d0/cmdata_8h.html#a7">CM_SUBKEY_HINT_LENGTH</a>; k++) {
02185                                     NameHint[k] = Hint-&gt;<a class="code" href="../../d2/d4/struct__CM__INDEX.html#o1">NameHint</a>[k];
02186                                 }
02187                             } <span class="keywordflow">else</span> {
02188                                 HintCached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02189                                 <span class="keywordflow">break</span>;
02190                             }
02191                             NameHint += <a class="code" href="../../d9/d0/cmdata_8h.html#a7">CM_SUBKEY_HINT_LENGTH</a>;
02192                         }
02193                     }
02194                 }
02195 
02196                 <span class="keywordflow">if</span> (HintCached) {
02197                     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ExtFlags |= <a class="code" href="../../d9/d0/cmdata_8h.html#a11">CM_KCB_SUBKEY_HINT</a>;
02198                 } <span class="keywordflow">else</span> {
02199                     <span class="comment">//</span>
02200                     <span class="comment">// Do not have a FAST_LEAF, free the allocation.</span>
02201                     <span class="comment">//</span>
02202                     <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;IndexHint, CM_CACHE_INDEX_TAG | PROTECTED_POOL);
02203                 }
02204             }
02205         } <span class="keywordflow">else</span> {
02206             <span class="comment">//</span>
02207             <span class="comment">// The name hint does not prevent from this look up</span>
02208             <span class="comment">// Create the fake Kcb.</span>
02209             <span class="comment">//</span>
02210             CreateFakeKcb = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02211         }
02212         <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
02213     } <span class="keywordflow">else</span> {
02214         CreateFakeKcb = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02215     }
02216 
02217     ParentKcb = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
02218 
02219     <span class="keywordflow">if</span> (CreateFakeKcb &amp;&amp; (<a class="code" href="../../d1/d2/cmp_8h.html#a154">CmpCacheOnFlag</a> &amp; <a class="code" href="../../d1/d2/cmp_8h.html#a15">CM_CACHE_FAKE_KEY</a>)) {
02220         <span class="comment">//</span>
02221         <span class="comment">// It has more than a few children but not the one we are interested.</span>
02222         <span class="comment">// Create a kcb for this non-existing key so we do not try to find it</span>
02223         <span class="comment">// again. Use the cell and node from the parent.</span>
02224         <span class="comment">//</span>
02225         <span class="comment">// Before we create a new one. Dereference the current kcb.</span>
02226         <span class="comment">//</span>
02227         <span class="comment">// CmpCacheOnFlag is for us to turn it on/off easily.</span>
02228         <span class="comment">//</span>
02229 
02230         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = <a class="code" href="../../d8/d2/cmsubs_8c.html#a20">CmpCreateKeyControlBlock</a>(Hive,
02231                                        Cell,
02232                                        Node,
02233                                        ParentKcb,
02234                                        TRUE,
02235                                        NodeName);
02236 
02237         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>) {
02238             <a class="code" href="../../d8/d2/cmsubs_8c.html#a22">CmpDereferenceKeyControlBlock</a>(ParentKcb);
02239             ParentKcb = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
02240         }
02241     }
02242 
02243     <span class="keywordflow">return</span> (ParentKcb);
02244 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="cmparse.c::CmpCacheAdd" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpCacheAdd           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d4/struct__CM__HASH__ENTRY.html">PCM_HASH_ENTRY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LastHashEntry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Count</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="cmparse.c::CmpCacheLookup" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpCacheLookup           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d4/struct__CM__HASH__ENTRY.html">PCM_HASH_ENTRY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>HashStack</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>TotalRemainingSubkeys</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT ULONG *&nbsp;</td>
          <td class="mdname" nowrap> <em>MatchRemainSubkeyLevel</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>Kcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>RemainingName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01853">1853</a> of file <a class="el" href="../../d3/d1/cmparse_8c-source.html">cmparse.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00070">ASSERT_KEY_HASH</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00257">CM_KCB_KEY_NON_EXIST</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01982">CmpCacheTable</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00629">CmpCleanUpKcbCacheWithLock()</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00195">CmpCompareCompressedName()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00345">CmpReferenceKeyControlBlock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00807">CmpRemoveFromDelayedClose()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01260">CmpRemoveKeyControlBlock()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00215">_CM_NAME_CONTROL_BLOCK::Compressed</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00277">_CM_KEY_CONTROL_BLOCK::ConvKey</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00475">GET_HASH_ENTRY</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00223">_CM_NAME_CONTROL_BLOCK::Name</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00286">_CM_KEY_CONTROL_BLOCK::NameBlock</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00222">_CM_NAME_CONTROL_BLOCK::NameLength</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00056">_CM_KEY_HASH::NextHash</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00285">_CM_KEY_CONTROL_BLOCK::ParentKcb</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01520">RtlCompareUnicodeString()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00294">_CM_KEY_CONTROL_BLOCK::TotalLevels</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>.
<p>
<pre class="fragment"><div>01864                    :
01865 
01866     This routine Search <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cache to find <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Cache.
01867 
01868 Arguments:
01869 
01870     HashStack - Array that has <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hash value of each level.
01871 
01872     TotalRemainingSubkeys - Total Subkey counts from base.
01873 
01874     MatchRemainSubkeyLevel - Number of Levels in RemaingName 
01875                              that matches. (0 <span class="keywordflow">if</span> not found)
01876 
01877     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> basename.
01878           Will be changed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> basename.
01879 
01880     RemainingName - Returns remaining name
01881 
01882     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cache entry found (<span class="keywordflow">if</span> any)
01883 
01884     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cell of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cache entry found (<span class="keywordflow">if</span> any)
01885 
01886 Return Value:
01887 
01888     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>
01889 
01890 --*/
01891 
01892 {
01893     LONG i;
01894     LONG j;
01895     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
01896     ULONG CurrentLevel;
01897     <a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a> Current;
01898     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> BaseKcb;
01899     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> CurrentKcb;
01900     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> ParentKcb;
01901     BOOLEAN Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01902 
01903     BaseKcb = *Kcb;
01904     CurrentLevel = TotalRemainingSubkeys + BaseKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o16">TotalLevels</a> + 1;
01905 
01906     <span class="keywordflow">for</span>(i = TotalRemainingSubkeys-1; i&gt;=0; i--) {
01907         <span class="comment">//</span>
01908         <span class="comment">// Try to find the longest path in the cache.</span>
01909         <span class="comment">//</span>
01910         <span class="comment">// First, find the kcb that match the hash value.</span>
01911         <span class="comment">//</span>
01912 
01913         CurrentLevel--; 
01914 
01915         Current = <a class="code" href="../../d1/d2/cmp_8h.html#a77">GET_HASH_ENTRY</a>(CmpCacheTable, HashStack[i].ConvKey);
01916 
01917         <span class="keywordflow">while</span> (Current) {
01918             <a class="code" href="../../d9/d0/cmdata_8h.html#a6">ASSERT_KEY_HASH</a>(Current);
01919 
01920             <span class="comment">//</span>
01921             <span class="comment">// Check against both the ConvKey and total levels;</span>
01922             <span class="comment">//</span>
01923             CurrentKcb = (CONTAINING_RECORD(Current, <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">CM_KEY_CONTROL_BLOCK</a>, KeyHash));
01924 
01925             <span class="keywordflow">if</span> (CurrentKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o16">TotalLevels</a> == CurrentLevel) {
01926                 <span class="comment">//</span>
01927                 <span class="comment">// The total subkey levels match.</span>
01928                 <span class="comment">// Iterate through the kcb path and compare each subkey.</span>
01929                 <span class="comment">//</span>
01930                 Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01931                 ParentKcb = CurrentKcb;
01932                 <span class="keywordflow">for</span> (j=i; j&gt;=0; j--) {
01933                     <span class="keywordflow">if</span> (HashStack[j].ConvKey == ParentKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o3">ConvKey</a>) {
01934                         <span class="comment">//</span>
01935                         <span class="comment">// Convkey matches, compare the string</span>
01936                         <span class="comment">//</span>
01937                         LONG Result;
01938                         UNICODE_STRING  TmpNodeName;
01939 
01940                         <span class="keywordflow">if</span> (ParentKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o0">Compressed</a>) {
01941                                Result = <a class="code" href="../../d1/d2/cmp_8h.html#a319">CmpCompareCompressedName</a>(&amp;(HashStack[j].KeyName),
01942                                                                  ParentKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o6">Name</a>, 
01943                                                                  ParentKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o5">NameLength</a>);
01944                         } <span class="keywordflow">else</span> {
01945                                TmpNodeName.Buffer = ParentKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o6">Name</a>;
01946                                TmpNodeName.Length = ParentKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o5">NameLength</a>;
01947                                TmpNodeName.MaximumLength = ParentKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o5">NameLength</a>;
01948 
01949                                Result = <a class="code" href="../../d6/d6/nls_8c.html#a41">RtlCompareUnicodeString</a> (&amp;(HashStack[j].KeyName), 
01950                                                                  &amp;TmpNodeName, 
01951                                                                  TRUE);
01952                         }
01953 
01954                         <span class="keywordflow">if</span> (Result) {
01955                             Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01956                             <span class="keywordflow">break</span>;
01957                         } 
01958                         ParentKcb = ParentKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o9">ParentKcb</a>;
01959                     } <span class="keywordflow">else</span> {
01960                         Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01961                         <span class="keywordflow">break</span>;
01962                     }
01963                 }
01964                 <span class="keywordflow">if</span> (Found) {
01965                     <span class="comment">//</span>
01966                     <span class="comment">// All remaining key matches.  Now compare the BaseKcb.</span>
01967                     <span class="comment">//</span>
01968                     <span class="keywordflow">if</span> (BaseKcb == ParentKcb) {
01969                         <span class="keywordflow">if</span> (CurrentKcb-&gt;ParentKcb-&gt;Delete) {
01970                             <span class="comment">//</span>
01971                             <span class="comment">// The parentkcb is marked deleted.  </span>
01972                             <span class="comment">// So this must be a fake key created when the parent still existed.</span>
01973                             <span class="comment">// Otherwise it cannot be in the cache</span>
01974                             <span class="comment">//</span>
01975                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (CurrentKcb-&gt;ExtFlags &amp; CM_KCB_KEY_NON_EXIST);
01976 
01977                             <span class="comment">//</span>
01978                             <span class="comment">// It is possible that the parent key was deleted but now recreated.</span>
01979                             <span class="comment">// In that case this fake key is not longer valid for the ParentKcb is bad.</span>
01980                             <span class="comment">// We must now remove this fake key out of cache so, if this is a</span>
01981                             <span class="comment">// create operation, we do get hit this kcb in CmpCreateKeyControlBlock. </span>
01982                             <span class="comment">//</span>
01983                             <span class="keywordflow">if</span> (CurrentKcb-&gt;RefCount == 0) {
01984                                 <span class="comment">//</span>
01985                                 <span class="comment">// No one is holding this fake kcb, just delete it.</span>
01986                                 <span class="comment">//</span>
01987                                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a19">CmpRemoveFromDelayedClose</a>(CurrentKcb);
01988                                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a17">CmpCleanUpKcbCacheWithLock</a>(CurrentKcb);
01989                             } <span class="keywordflow">else</span> {
01990                                 <span class="comment">//</span>
01991                                 <span class="comment">// Someone is still holding this fake kcb, </span>
01992                                 <span class="comment">// Mark it as delete and remove it out of cache.</span>
01993                                 <span class="comment">//</span>
01994                                 CurrentKcb-&gt;Delete = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01995                                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a24">CmpRemoveKeyControlBlock</a>(CurrentKcb);
01996                             }
01997                             Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01998                             <span class="keywordflow">break</span>;
01999                         }
02000 
02001                         
02002                         <span class="comment">//</span>
02003                         <span class="comment">// We have a match, update the RemainingName.</span>
02004                         <span class="comment">//</span>
02005 
02006                         <span class="comment">//</span>
02007                         <span class="comment">// Skip the leading OBJ_NAME_PATH_SEPARATOR</span>
02008                         <span class="comment">//</span>
02009                         <span class="keywordflow">while</span> ((RemainingName-&gt;Length &gt; 0) &amp;&amp;
02010                                (RemainingName-&gt;Buffer[0] == OBJ_NAME_PATH_SEPARATOR)) {
02011                             RemainingName-&gt;Buffer++;
02012                             RemainingName-&gt;Length -= <span class="keyword">sizeof</span>(WCHAR);
02013                         }
02014 
02015                         <span class="comment">//</span>
02016                         <span class="comment">// Skip all subkeys plus OBJ_NAME_PATH_SEPARATOR</span>
02017                         <span class="comment">//</span>
02018                         <span class="keywordflow">for</span>(j=0; j&lt;=i; j++) {
02019                             RemainingName-&gt;Buffer += HashStack[j].KeyName.Length/<span class="keyword">sizeof</span>(WCHAR) + 1;
02020                             RemainingName-&gt;Length -= HashStack[j].KeyName.Length + <span class="keyword">sizeof</span>(WCHAR);
02021                         }
02022 
02023                         <span class="comment">//</span>
02024                         <span class="comment">// Update the KCB, Hive and Cell.</span>
02025                         <span class="comment">//</span>
02026                         *Kcb = CurrentKcb;
02027                         *<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = CurrentKcb-&gt;KeyHive;
02028                         *<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = CurrentKcb-&gt;KeyCell;
02029                         <span class="keywordflow">break</span>;
02030                     } <span class="keywordflow">else</span> {
02031                         Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02032                     }
02033                 }
02034             }
02035             Current = Current-&gt;<a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html#o1">NextHash</a>;
02036         }
02037 
02038         <span class="keywordflow">if</span> (Found) {
02039             <span class="keywordflow">break</span>;
02040         }
02041     }
02042     <span class="comment">//</span>
02043     <span class="comment">// Now the kcb will be used in the parse routine.</span>
02044     <span class="comment">// Increase its reference count.</span>
02045     <span class="comment">// Make sure we remember to dereference it at the parse routine.</span>
02046     <span class="comment">//</span>
02047     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d2/cmsubs_8c.html#a13">CmpReferenceKeyControlBlock</a>(*Kcb)) {
02048         status = STATUS_INSUFFICIENT_RESOURCES;
02049     }
02050     *MatchRemainSubkeyLevel = i+1;
02051     <span class="keywordflow">return</span> status;
02052 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="cmparse.c::CmpComputeHashValue" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG CmpComputeHashValue           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d4/struct__CM__HASH__ENTRY.html">PCM_HASH_ENTRY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>HashStack</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT ULONG *&nbsp;</td>
          <td class="mdname" nowrap> <em>TotalSubkeys</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseConvKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>RemainingName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01737">1737</a> of file <a class="el" href="../../d3/d1/cmparse_8c-source.html">cmparse.c</a>.
<p>
References <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00030">CM_HASH_STACK_SIZE</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01178">RtlUpcaseUnicodeChar()</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>.
<p>
<pre class="fragment"><div>01746                    :
01747 
01748     This routine parses <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> complete <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> of a request registry key and calculate
01749     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hash value at each level.
01750 
01751 Arguments:
01752 
01753     HashStack - Array <span class="keywordflow">for</span> filling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hash value of each level.
01754 
01755     TotalSubkeys - a pointer to fill <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> total number of subkeys
01756 
01757     BaseConvKey - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> convkey <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base key.
01758 
01759     RemainingName - supplies pointer to a unicode_string <span class="keywordflow">for</span> RemainingName.
01760 
01761 Return Value:
01762 
01763     Number of Levels in RemainingName
01764 
01765 --*/
01766 
01767 {
01768     ULONG  TotalRemainingSubkeys=0;
01769     ULONG  TotalKeys=0;
01770     ULONG  ConvKey=BaseConvKey;
01771     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>  Cnt;
01772     WCHAR *Cp;
01773     WCHAR *Begin;
01774     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Length;
01775 
01776     <span class="keywordflow">if</span> (RemainingName-&gt;Length) {
01777         Cp = RemainingName-&gt;Buffer;
01778         Cnt = RemainingName-&gt;Length;
01779 
01780         <span class="comment">//Skip the leading OBJ_NAME_PATH_SEPARATOR</span>
01781 
01782         <span class="keywordflow">while</span> (*Cp == OBJ_NAME_PATH_SEPARATOR) {
01783             Cp++;
01784             Cnt -= <span class="keyword">sizeof</span>(WCHAR);
01785         }
01786         Begin = Cp;
01787         Length = 0;
01788 
01789         HashStack[TotalRemainingSubkeys].KeyName.Buffer = Cp;
01790 
01791         <span class="keywordflow">while</span> (Cnt){
01792             <span class="keywordflow">if</span> ( *Cp == OBJ_NAME_PATH_SEPARATOR ) {
01793                 <span class="keywordflow">if</span> (TotalRemainingSubkeys &lt; <a class="code" href="../../d2/d2/cmparse_8c.html#a0">CM_HASH_STACK_SIZE</a>) {
01794                     HashStack[TotalRemainingSubkeys].ConvKey = ConvKey;
01795                     <span class="comment">//</span>
01796                     <span class="comment">// Due to the changes in KCB structure, we now only have the subkey name</span>
01797                     <span class="comment">// in the kcb (not the full path).  Change the name in the stack to store</span>
01798                     <span class="comment">// the parse element (each subkey) only.</span>
01799                     <span class="comment">//</span>
01800                     HashStack[TotalRemainingSubkeys].KeyName.Length = Length;
01801                     Length = 0;
01802                     TotalRemainingSubkeys++;
01803                 }
01804 
01805                 TotalKeys++;
01806 
01807                 <span class="comment">//</span>
01808                 <span class="comment">// Now skip over leading path separators</span>
01809                 <span class="comment">// Just in case someone has a RemainingName '..A\\\\B..'</span>
01810                 <span class="comment">//</span>
01811                 <span class="comment">//</span>
01812                 <span class="comment">// We are stripping all OBJ_NAME_PATH_SEPARATOR (The origainl code keep the first one).</span>
01813                 <span class="comment">// so the KeyName.Buffer is set properly.</span>
01814                 <span class="comment">//</span>
01815                 <span class="keywordflow">while</span>(*Cp == OBJ_NAME_PATH_SEPARATOR){
01816                     Cp++;
01817                     Cnt -= <span class="keyword">sizeof</span>(WCHAR);
01818                 }
01819                 HashStack[TotalRemainingSubkeys].KeyName.Buffer = Cp;
01820 
01821             } <span class="keywordflow">else</span> {
01822                 ConvKey = 37 * ConvKey + (ULONG) <a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(*Cp);
01823                 <span class="comment">//</span>
01824                 <span class="comment">// We are stripping all OBJ_NAME_PATH_SEPARATOR in the above code,</span>
01825                 <span class="comment">// we should only move to the next char in the else case.</span>
01826                 <span class="comment">//</span>
01827                 Cp++;
01828                 Cnt -= <span class="keyword">sizeof</span>(WCHAR);
01829                 Length += <span class="keyword">sizeof</span>(WCHAR);
01830             
01831             }
01832 
01833 
01834         }
01835 
01836         <span class="comment">//</span>
01837         <span class="comment">// Since we have stripped off all trailing path separators in CmpParseKey routine,</span>
01838         <span class="comment">// the last char will not be OBJ_NAME_PATH_SEPARATOR.</span>
01839         <span class="comment">//</span>
01840         <span class="keywordflow">if</span> (TotalRemainingSubkeys &lt; <a class="code" href="../../d2/d2/cmparse_8c.html#a0">CM_HASH_STACK_SIZE</a>) {
01841             HashStack[TotalRemainingSubkeys].ConvKey = ConvKey;
01842             HashStack[TotalRemainingSubkeys].KeyName.Length = Length;
01843             TotalRemainingSubkeys++;
01844         }
01845         TotalKeys++;
01846 
01847         (*TotalSubkeys) = TotalKeys;
01848     }
01849 
01850     <span class="keywordflow">return</span>(TotalRemainingSubkeys);
01851 }
<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="cmparse.c::CmpCreateLinkNode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpCreateLinkNode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessState</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Name</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Attributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">PCM_PARSE_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ParentKcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01252">1252</a> of file <a class="el" href="../../d3/d1/cmparse_8c-source.html">cmparse.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00346">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00460">_CM_KEY_NODE::ChildHiveReference</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00476">_CM_KEY_NODE::ClassLength</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00423">CM_LINK_NODE_SIGNATURE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00895">CmpAddSubKey()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00537">CmpCleanUpSubKeyInfo()</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00074">CmpCopyName()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00226">CmpDoCreateChild()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00963">CmpDoOpen()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00683">CmpHKeyNodeSize</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00036">CmpMasterHive</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00260">CMS_PARSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00332">_CHILD_LIST::Count</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00649">_CMHIVE::Hive</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00386">HvAllocateCell()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d5/d5/regext_8c-source.html#l00458">kcb()</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00153">KeQuerySystemTime()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00440">KEY_COMP_NAME</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00434">KEY_HIVE_ENTRY</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00428">KEY_HIVE_EXIT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00437">KEY_NO_DELETE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00341">_CM_KEY_REFERENCE::KeyCell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00492">_CM_KEY_BODY::KeyControlBlock</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00342">_CM_KEY_REFERENCE::KeyHive</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00537">_CELL_DATA::_u::KeyNode</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00451">_CM_KEY_NODE::LastWriteTime</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00333">_CHILD_LIST::List</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00466">_CM_KEY_NODE::MaxClassLen</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00465">_CM_KEY_NODE::MaxNameLen</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00477">_CM_KEY_NODE::Name</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00475">_CM_KEY_NODE::NameLength</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00453">_CM_KEY_NODE::Parent</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00285">_CM_KEY_CONTROL_BLOCK::ParentKcb</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00449">_CM_KEY_NODE::Signature</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00454">_CM_KEY_NODE::SubKeyCounts</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00457">_CM_KEY_NODE::SubKeyLists</a>, <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00458">_CM_KEY_NODE::ValueList</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>.
<p>
<pre class="fragment"><div>01265                    :
01266 
01267     Perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> creation of a link node.  Allocate all components,
01268     and attach to parent key.  Calls <a class="code" href="../../d1/d2/cmp_8h.html#a209">CmpDoCreate</a> or <a class="code" href="../../d2/d2/cmparse_8c.html#a18">CmpDoOpen</a> to
01269     create or open <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root node of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive as appropriate.
01270 
01271     Note that you can <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> create link nodes in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> master hive.
01272 
01273 Arguments:
01274 
01275     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive
01276 
01277     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - supplies index of node to create child under
01278 
01279     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> - supplies pointer to a UNICODE string which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of
01280             <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> child to be created.
01281 
01282     AccessMode - Access mode of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original caller.
01283 
01284     Attributes - Attributes to be applied to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
01285 
01286     Context - pointer to <a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">CM_PARSE_CONTEXT</a> structure passed through
01287                 <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object manager
01288 
01289     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a> - <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> of object create <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> relative to
01290 
01291     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> - Relative name (to BaseName)
01292 
01293     Object - The address of a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> created key object, <span class="keywordflow">if</span>
01294              any.
01295 
01296 Return Value:
01297 
01298     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
01299 
01300 --*/
01301 {
01302     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01303     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> Parent;
01304     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> Link;
01305     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> CellData;
01306     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> LinkCell;
01307     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> KeyCell;
01308     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ChildCell;
01309     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = ParentKcb;  
01310     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> KeyBody;
01311     LARGE_INTEGER systemtime;
01312 
01313     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_PARSE) {
01314         KdPrint((<span class="stringliteral">"CmpCreateLinkNode:\n"</span>));
01315     }
01316 
01317     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> != &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>) {
01318         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_PARSE) {
01319             KdPrint((<span class="stringliteral">"CmpCreateLinkNode: attempt to create link node in\n"</span>));
01320             KdPrint((<span class="stringliteral">"    non-master hive %08lx\n"</span>, Hive));
01321         }
01322         <span class="keywordflow">return</span>(STATUS_ACCESS_DENIED);
01323     }
01324 
01325     <span class="comment">//</span>
01326     <span class="comment">// Allocate link node</span>
01327     <span class="comment">//</span>
01328     <span class="comment">// Link nodes are always in the master hive, so their storage type is</span>
01329     <span class="comment">// mostly irrelevent.</span>
01330     <span class="comment">//</span>
01331     LinkCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(Hive,  <a class="code" href="../../d1/d2/cmp_8h.html#a98">CmpHKeyNodeSize</a>(Hive, &amp;Name), Stable);
01332     <span class="keywordflow">if</span> (LinkCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01333         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01334     }
01335 
01336     KeyCell = Context-&gt;ChildHive.KeyCell;
01337 
01338     <span class="keywordflow">if</span> (KeyCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01339 
01340         <span class="comment">//</span>
01341         <span class="comment">// This hive already exists, so we just need to open the root node.</span>
01342         <span class="comment">//</span>
01343         ChildCell=KeyCell;
01344 
01345         <span class="comment">//</span>
01346         <span class="comment">// The root cell in the hive does not has the Name buffer </span>
01347         <span class="comment">// space reseverd.  This is why we need to pass in the Name for creating KCB</span>
01348         <span class="comment">// instead of using the name in the keynode.</span>
01349         <span class="comment">//</span>
01350         CellData = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Context-&gt;ChildHive.KeyHive, ChildCell);
01351         CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a> = LinkCell;
01352         CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/cmdata_8h.html#a29">KEY_HIVE_ENTRY</a> | <a class="code" href="../../d9/d0/cmdata_8h.html#a30">KEY_NO_DELETE</a>;
01353         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d2/cmparse_8c.html#a18">CmpDoOpen</a>( Context-&gt;ChildHive.KeyHive,
01354                             KeyCell,
01355                             (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Context-&gt;ChildHive.KeyHive,KeyCell),
01356                             AccessState,
01357                             AccessMode,
01358                             Attributes,
01359                             NULL,
01360                             FALSE,
01361                             &amp;kcb,
01362                             &amp;Name,
01363                             Object );
01364     } <span class="keywordflow">else</span> {
01365 
01366         <span class="comment">//</span>
01367         <span class="comment">// This is a newly created hive, so we must allocate and initialize</span>
01368         <span class="comment">// the root node.</span>
01369         <span class="comment">//</span>
01370 
01371         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d2/cmparse2_8c.html#a2">CmpDoCreateChild</a>( Context-&gt;ChildHive.KeyHive,
01372                                    Cell,
01373                                    NULL,
01374                                    AccessState,
01375                                    &amp;Name,
01376                                    AccessMode,
01377                                    Context,
01378                                    ParentKcb,
01379                                    KEY_HIVE_ENTRY | KEY_NO_DELETE,
01380                                    &amp;ChildCell,
01381                                    Object );
01382 
01383         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01384 
01385             <span class="comment">//</span>
01386             <span class="comment">// Initialize hive root cell pointer.</span>
01387             <span class="comment">//</span>
01388 
01389             Context-&gt;ChildHive.KeyHive-&gt;BaseBlock-&gt;RootCell = ChildCell;
01390         }
01391 
01392     }
01393     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01394 
01395         <span class="comment">//</span>
01396         <span class="comment">// Initialize parent and flags.  Note that we do this whether the</span>
01397         <span class="comment">// root has been created or opened, because we are not guaranteed</span>
01398         <span class="comment">// that the link node is always the same cell in the master hive.</span>
01399         <span class="comment">//</span>
01400         CellData = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Context-&gt;ChildHive.KeyHive, ChildCell);
01401         CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a> = LinkCell;
01402         CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/cmdata_8h.html#a29">KEY_HIVE_ENTRY</a> | <a class="code" href="../../d9/d0/cmdata_8h.html#a30">KEY_NO_DELETE</a>;
01403 
01404         <span class="comment">//</span>
01405         <span class="comment">// Initialize special link node flags and data</span>
01406         <span class="comment">//</span>
01407         Link = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, LinkCell);
01408         Link-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o0">Signature</a> = <a class="code" href="../../d9/d0/cmdata_8h.html#a26">CM_LINK_NODE_SIGNATURE</a>;
01409         Link-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> = <a class="code" href="../../d9/d0/cmdata_8h.html#a28">KEY_HIVE_EXIT</a> | <a class="code" href="../../d9/d0/cmdata_8h.html#a30">KEY_NO_DELETE</a>;
01410         Link-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
01411         Link-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a317">CmpCopyName</a>(Hive, Link-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>, &amp;Name);
01412         <span class="keywordflow">if</span> (Link-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a> &lt; <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length) {
01413             Link-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>;
01414         }
01415 
01416         <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;systemtime);
01417         Link-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o2">LastWriteTime</a> = systemtime;
01418 
01419         <span class="comment">//</span>
01420         <span class="comment">// Zero out unused fields.</span>
01421         <span class="comment">//</span>
01422         Link-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] = 0;
01423         Link-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>] = 0;
01424         Link-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01425         Link-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01426         Link-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> = 0;
01427         Link-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01428         Link-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a> = 0;
01429 
01430 
01431         <span class="comment">//</span>
01432         <span class="comment">// Fill in the link node's pointer to the root node</span>
01433         <span class="comment">//</span>
01434         Link-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o8">ChildHiveReference</a>.<a class="code" href="../../d5/d5/struct__CM__KEY__REFERENCE.html#o1">KeyHive</a> = Context-&gt;ChildHive.KeyHive;
01435         Link-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o8">ChildHiveReference</a>.<a class="code" href="../../d5/d5/struct__CM__KEY__REFERENCE.html#o0">KeyCell</a> = ChildCell;
01436 
01437         <span class="comment">//</span>
01438         <span class="comment">// Fill in the parent cell's child list</span>
01439         <span class="comment">//</span>
01440         <span class="keywordflow">if</span> (! <a class="code" href="../../d1/d2/cmp_8h.html#a305">CmpAddSubKey</a>(Hive, Cell, LinkCell)) {
01441             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, LinkCell);
01442             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01443         }
01444 
01445         <span class="comment">//</span>
01446         <span class="comment">// Update max keyname and class name length fields</span>
01447         <span class="comment">//</span>
01448         Parent = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Cell);
01449 
01450         <span class="comment">//</span>
01451         <span class="comment">// It seem to me that the original code is wrong.</span>
01452         <span class="comment">// Isn't the definition of MaxNameLen just the length of the subkey?</span>
01453         <span class="comment">//</span>
01454         <span class="keywordflow">if</span> (Parent-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o11">MaxNameLen</a> &lt; <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length) {
01455             Parent-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o11">MaxNameLen</a> = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length;
01456         }
01457 
01458         <span class="keywordflow">if</span> (Parent-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o12">MaxClassLen</a> &lt; Context-&gt;Class.Length) {
01459             Parent-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o12">MaxClassLen</a> = Context-&gt;Class.Length;
01460         }
01461 
01462         <span class="comment">//</span>
01463         <span class="comment">// If the parent has the subkey info or hint cached, free it.</span>
01464         <span class="comment">//</span>
01465         <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
01466         KeyBody = (<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)(*Object);
01467         <a class="code" href="../../d8/d2/cmsubs_8c.html#a15">CmpCleanUpSubKeyInfo</a> (KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o9">ParentKcb</a>);
01468 
01469     } <span class="keywordflow">else</span> {
01470         <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, LinkCell);
01471     }
01472     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01473 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="cmparse.c::CmpDoOpen" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpDoOpen           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Node</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessState</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Attributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">PCM_PARSE_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>CompleteKeyCached</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>CachedKcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00963">963</a> of file <a class="el" href="../../d3/d1/cmparse_8c-source.html">cmparse.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00256">CM_KCB_SYM_LINK_FOUND</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00568">CmpCleanUpKcbValueCache()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00824">CmpCreateKeyControlBlock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01153">CmpDereferenceKeyControlBlock()</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00345">CmpReferenceKeyControlBlock()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00260">CMS_PARSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00264">CMS_POOL</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00526">ENLIST_KEYBODY_IN_KEYBODY_LIST</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d5/d5/regext_8c-source.html#l00458">kcb()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00486">KEY_BODY_TYPE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00442">KEY_PREDEF_HANDLE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00439">KEY_SYM_LINK</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00492">_CM_KEY_BODY::KeyControlBlock</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00230">LOCK_KCB_TREE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00493">_CM_KEY_BODY::NotifyBlock</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00392">ObCheckObjectAccess()</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00055">ObCreateObject()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00494">_CM_KEY_BODY::Process</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01685">SeBackupPrivilege</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01686">SeRestorePrivilege</a>, <a class="el" href="../../d9/d3/privileg_8c-source.html#l00436">SeSinglePrivilegeCheck()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00491">_CM_KEY_BODY::Type</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00231">UNLOCK_KCB_TREE</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01252">CmpCreateLinkNode()</a>, and <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>.
<p>
<pre class="fragment"><div>00978                    :
00979 
00980     Open a registry key, create a keycontrol block.
00981 
00982 Arguments:
00983 
00984     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive
00985 
00986     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - supplies index of node to <span class="keyword">delete</span>
00987 
00988     AccessState - <a class="code" href="../../d4/d9/ke_8h.html#a406a193">Running</a> security access state information <span class="keywordflow">for</span> operation.
00989 
00990     AccessMode - Access mode of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original caller.
00991 
00992     Attributes - Attributes to be applied to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
00993 
00994     Context - <span class="keywordflow">if</span> create or hive root open, points to a <a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">CM_PARSE_CONTEXT</a>
00995               structure,
00996               <span class="keywordflow">if</span> open, <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
00997 
00998     CompleteKeyCached - BOOLEAN to indicate <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> completekey <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> cached.
00999 
01000     CachedKcb - If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> completekey <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> cached, <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> destination.
01001                 If not, <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>.
01002 
01003     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> - Relative name (to BaseName)
01004 
01005     Object - The address of a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> created key object, <span class="keywordflow">if</span>
01006              any.
01007 
01008 Return Value:
01009 
01010     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
01011 
01012 --*/
01013 {
01014     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01015     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> pbody;
01016     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
01017     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>   mode;
01018     BOOLEAN BackupRestore;
01019 
01020     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_PARSE) {
01021         KdPrint((<span class="stringliteral">"CmpDoOpen:\n"</span>));
01022     }
01023     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Context)) {
01024 
01025         <span class="comment">//</span>
01026         <span class="comment">// It's a create of some sort</span>
01027         <span class="comment">//</span>
01028         <span class="keywordflow">if</span> (Context-&gt;CreateLink) {
01029             <span class="comment">//</span>
01030             <span class="comment">// The node already exists as a regular key, so it cannot be</span>
01031             <span class="comment">// turned into a link node.</span>
01032             <span class="comment">//</span>
01033             <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
01034 
01035         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Context-&gt;CreateOptions &amp; REG_OPTION_CREATE_LINK) {
01036             <span class="comment">//</span>
01037             <span class="comment">// Attempt to create a symbolic link has hit an existing key</span>
01038             <span class="comment">// so return an error</span>
01039             <span class="comment">//</span>
01040             <span class="keywordflow">return</span> STATUS_OBJECT_NAME_COLLISION;
01041 
01042         } <span class="keywordflow">else</span> {
01043             <span class="comment">//</span>
01044             <span class="comment">// Operation is an open, so set Disposition</span>
01045             <span class="comment">//</span>
01046             Context-&gt;Disposition = REG_OPENED_EXISTING_KEY;
01047         }
01048     }
01049 
01050     <span class="comment">//</span>
01051     <span class="comment">// Check for symbolic link and caller does not want to open a link</span>
01052     <span class="comment">//</span>
01053     <span class="keywordflow">if</span> (CompleteKeyCached) {
01054         <span class="comment">//</span>
01055         <span class="comment">// The complete key is cached.</span>
01056         <span class="comment">//</span>
01057         <span class="keywordflow">if</span> ((*CachedKcb)-&gt;Flags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a31">KEY_SYM_LINK</a> &amp;&amp; !(Attributes &amp; OBJ_OPENLINK)) {
01058             <span class="comment">//</span>
01059             <span class="comment">// If the key is a symbolic link, check if the link has been resolved.</span>
01060             <span class="comment">// If the link is resolved, change the kcb to the real KCB.</span>
01061             <span class="comment">// Otherwise, return for reparse.</span>
01062             <span class="comment">//</span>
01063             <a class="code" href="../../d1/d2/cmp_8h.html#a16">LOCK_KCB_TREE</a>();
01064             <span class="keywordflow">if</span> ((*CachedKcb)-&gt;ExtFlags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a12">CM_KCB_SYM_LINK_FOUND</a>) {
01065                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = (*CachedKcb)-&gt;ValueCache.RealKcb;
01066 
01067                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;Delete == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01068                     <span class="comment">//</span>
01069                     <span class="comment">// The real key it pointes to had been deleted.</span>
01070                     <span class="comment">// We have no way of knowing if the key has been recreated.</span>
01071                     <span class="comment">// Just clean up the cache and do a reparse.</span>
01072                     <span class="comment">//</span>
01073                     <a class="code" href="../../d8/d2/cmsubs_8c.html#a16">CmpCleanUpKcbValueCache</a>(*CachedKcb);
01074                     <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
01075                     <span class="keywordflow">return</span>(STATUS_REPARSE);
01076                 }
01077 
01078                 <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d2/cmsubs_8c.html#a13">CmpReferenceKeyControlBlock</a>(kcb)) {
01079                     <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
01080                     <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01081                 }
01082             } <span class="keywordflow">else</span> {
01083                 <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
01084                 <span class="keywordflow">return</span>(STATUS_REPARSE);
01085             }
01086             <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
01087         } <span class="keywordflow">else</span> {
01088             <span class="comment">//</span>
01089             <span class="comment">// Not a symbolic link, increase the reference Count of Kcb.</span>
01090             <span class="comment">//</span>
01091             <a class="code" href="../../d1/d2/cmp_8h.html#a16">LOCK_KCB_TREE</a>();
01092             <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = *CachedKcb;
01093             <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d2/cmsubs_8c.html#a13">CmpReferenceKeyControlBlock</a>(kcb)) {
01094                 <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
01095                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01096             }
01097             <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
01098         }
01099     } <span class="keywordflow">else</span> {
01100             <span class="comment">//</span>
01101             <span class="comment">// The key is not in cache, the CachedKcb is the parentkcb of this</span>
01102             <span class="comment">// key to be opened.</span>
01103             <span class="comment">//</span>
01104 
01105         <span class="keywordflow">if</span> (Node-&gt;Flags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a31">KEY_SYM_LINK</a> &amp;&amp; !(Attributes &amp; OBJ_OPENLINK)) {
01106             <span class="comment">//</span>
01107             <span class="comment">// Create a KCB for this symbolic key and put it in delay close.</span>
01108             <span class="comment">//</span>
01109             <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = <a class="code" href="../../d8/d2/cmsubs_8c.html#a20">CmpCreateKeyControlBlock</a>(Hive, Cell, Node, *CachedKcb, FALSE, KeyName);
01110             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>  == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01111                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01112             }
01113             <a class="code" href="../../d8/d2/cmsubs_8c.html#a22">CmpDereferenceKeyControlBlock</a>(kcb);
01114             *CachedKcb = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
01115             <span class="keywordflow">return</span>(STATUS_REPARSE);
01116         }
01117     
01118         <span class="comment">//</span>
01119         <span class="comment">// If key control block does not exist, and cannot be created, fail,</span>
01120         <span class="comment">// else just increment the ref count (done for us by CreateKeyControlBlock)</span>
01121         <span class="comment">//</span>
01122         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = <a class="code" href="../../d8/d2/cmsubs_8c.html#a20">CmpCreateKeyControlBlock</a>(Hive, Cell, Node, *CachedKcb, FALSE, KeyName);
01123         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>  == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01124             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01125         }
01126         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;Delete == FALSE);
01127     
01128         *CachedKcb = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
01129     }
01130 
01131     <span class="comment">//</span>
01132     <span class="comment">// Allocate the object.</span>
01133     <span class="comment">//</span>
01134     status = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>(AccessMode,
01135                             CmpKeyObjectType,
01136                             NULL,
01137                             AccessMode,
01138                             NULL,
01139                             <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">CM_KEY_BODY</a>),
01140                             0,
01141                             0,
01142                             Object);
01143 
01144     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01145 
01146         pbody = (<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)(*Object);
01147 
01148         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_POOL|CMS_PARSE) {
01149             KdPrint((<span class="stringliteral">"CmpDoOpen: object allocated at:%08lx\n"</span>, pbody));
01150         }
01151 
01152         <span class="comment">//</span>
01153         <span class="comment">// Check for predefined handle</span>
01154         <span class="comment">//</span>
01155 
01156         pbody = (<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)(*Object);
01157 
01158         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;Flags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a33">KEY_PREDEF_HANDLE</a>) {
01159             pbody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o0">Type</a> = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ValueCache.Count;
01160             pbody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a> = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
01161             <span class="keywordflow">return</span>(STATUS_PREDEFINED_HANDLE);
01162         } <span class="keywordflow">else</span> {
01163             <span class="comment">//</span>
01164             <span class="comment">// Fill in CM specific fields in the object</span>
01165             <span class="comment">//</span>
01166             pbody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o0">Type</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a78">KEY_BODY_TYPE</a>;
01167             pbody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a> = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
01168             pbody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o2">NotifyBlock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01169             pbody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o3">Process</a> = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
01170             <a class="code" href="../../d1/d2/cmp_8h.html#a81">ENLIST_KEYBODY_IN_KEYBODY_LIST</a>(pbody);
01171         }
01172 
01173     } <span class="keywordflow">else</span> {
01174 
01175         <span class="comment">//</span>
01176         <span class="comment">// Failed to create object, so undo key control block work</span>
01177         <span class="comment">//</span>
01178         <a class="code" href="../../d8/d2/cmsubs_8c.html#a22">CmpDereferenceKeyControlBlock</a>(kcb);
01179         <span class="keywordflow">return</span> status;
01180     }
01181 
01182     <span class="comment">//</span>
01183     <span class="comment">// Check to make sure the caller can access the key.</span>
01184     <span class="comment">//</span>
01185     BackupRestore = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01186     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Context)) {
01187         <span class="keywordflow">if</span> (Context-&gt;CreateOptions &amp; REG_OPTION_BACKUP_RESTORE) {
01188             BackupRestore = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01189         }
01190     }
01191 
01192     status = STATUS_SUCCESS;
01193 
01194     <span class="keywordflow">if</span> (BackupRestore == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01195 
01196         <span class="comment">//</span>
01197         <span class="comment">// this is an open to support a backup or restore</span>
01198         <span class="comment">// operation, do the special case work</span>
01199         <span class="comment">//</span>
01200         AccessState-&gt;RemainingDesiredAccess = 0;
01201         AccessState-&gt;PreviouslyGrantedAccess = 0;
01202 
01203         mode = KeGetPreviousMode();
01204 
01205         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(SeBackupPrivilege, mode)) {
01206             AccessState-&gt;PreviouslyGrantedAccess |=
01207                 KEY_READ | ACCESS_SYSTEM_SECURITY;
01208         }
01209 
01210         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(SeRestorePrivilege, mode)) {
01211             AccessState-&gt;PreviouslyGrantedAccess |=
01212                 KEY_WRITE | ACCESS_SYSTEM_SECURITY | WRITE_DAC | WRITE_OWNER;
01213         }
01214 
01215         <span class="keywordflow">if</span> (AccessState-&gt;PreviouslyGrantedAccess == 0) {
01216             <span class="comment">//</span>
01217             <span class="comment">// relevent privileges not asserted/possessed, so</span>
01218             <span class="comment">// deref (which will cause CmpDeleteKeyObject to clean up)</span>
01219             <span class="comment">// and return an error.</span>
01220             <span class="comment">//</span>
01221             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_PARSE) {
01222                 KdPrint((<span class="stringliteral">"CmpDoOpen for backup restore: access denied\n"</span>));
01223             }
01224             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(*Object);
01225             <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
01226         }
01227 
01228     } <span class="keywordflow">else</span> {
01229 
01230         <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d1/obse_8c.html#a3">ObCheckObjectAccess</a>(*Object,
01231                                   AccessState,
01232                                   TRUE,         <span class="comment">// Type mutex already locked</span>
01233                                   AccessMode,
01234                                   &amp;status))
01235         {
01236             <span class="comment">//</span>
01237             <span class="comment">// Access denied, so deref object, will cause CmpDeleteKeyObject</span>
01238             <span class="comment">// to be called, it will clean up.</span>
01239             <span class="comment">//</span>
01240             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_PARSE) {
01241                 KdPrint((<span class="stringliteral">"CmpDoOpen: access denied\n"</span>));
01242             }
01243             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(*Object);
01244         }
01245     }
01246 
01247     <span class="keywordflow">return</span> status;
01248 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="cmparse.c::CmpGetNextName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpGetNextName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>RemainingName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>NextName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Last</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00860">860</a> of file <a class="el" href="../../d3/d1/cmparse_8c-source.html">cmparse.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00034">MAX_KEY_NAME_LENGTH</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>, and <a class="el" href="../../d6/d9/cmcontrl_8c-source.html#l00256">CmpWalkPath()</a>.
<p>
<pre class="fragment"><div>00867                    :
00868 
00869     This routine parses off <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next component of a registry <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>, returning
00870     all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> interesting state about <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>, including whether <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>'s legal.
00871 
00872 Arguments:
00873 
00874     Current - supplies pointer to variable which points to <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> to parse.
00875               on input - parsing starts from here
00876               on output - updated to reflect starting position <span class="keywordflow">for</span> next call.
00877 
00878     NextName - supplies pointer to a unicode_string, which will be set up
00879                to point into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parse string.
00880 
00881     Last - supplies a pointer to a <span class="keywordtype">boolean</span> - set to <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00882            last component of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name being parse, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
00883 
00884 Return Value:
00885 
00886     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> all <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> well.
00887 
00888     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> illegal name (too <span class="keywordtype">long</span> component, bad character, etc.)
00889         (<span class="keywordflow">if</span> <span class="keyword">false</span>, all out parameter values are bogus.)
00890 
00891 --*/
00892 {
00893     BOOLEAN rc = TRUE;
00894 
00895     <span class="comment">//</span>
00896     <span class="comment">// Deal with NULL paths, and pointers to NULL paths</span>
00897     <span class="comment">//</span>
00898     if ((RemainingName-&gt;Buffer == NULL) || (RemainingName-&gt;Length == 0)) {
00899         *Last = TRUE;
00900         NextName-&gt;Buffer = NULL;
00901         NextName-&gt;Length = 0;
00902         <span class="keywordflow">return</span> TRUE;
00903     }
00904 
00905     <span class="keywordflow">if</span> (*(RemainingName-&gt;Buffer) == UNICODE_NULL) {
00906         *Last = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00907         NextName-&gt;Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00908         NextName-&gt;Length = 0;
00909         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00910     }
00911 
00912     <span class="comment">//</span>
00913     <span class="comment">// Skip over leading path separators</span>
00914     <span class="comment">//</span>
00915     <span class="keywordflow">if</span> (*(RemainingName-&gt;Buffer) == OBJ_NAME_PATH_SEPARATOR) {
00916         RemainingName-&gt;Buffer++;
00917         RemainingName-&gt;Length -= <span class="keyword">sizeof</span>(WCHAR);
00918         RemainingName-&gt;MaximumLength -= <span class="keyword">sizeof</span>(WCHAR);
00919     }
00920 
00921     <span class="comment">//</span>
00922     <span class="comment">// Remember where the component starts, and scan to the end</span>
00923     <span class="comment">//</span>
00924     NextName-&gt;Buffer = RemainingName-&gt;Buffer;
00925     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00926         <span class="keywordflow">if</span> (RemainingName-&gt;Length == 0) {
00927             <span class="keywordflow">break</span>;
00928         }
00929         <span class="keywordflow">if</span> (*RemainingName-&gt;Buffer == OBJ_NAME_PATH_SEPARATOR) {
00930             <span class="keywordflow">break</span>;
00931         }
00932 
00933         <span class="comment">//</span>
00934         <span class="comment">// NOT at end</span>
00935         <span class="comment">// NOT another path sep</span>
00936         <span class="comment">//</span>
00937 
00938         RemainingName-&gt;Buffer++;
00939         RemainingName-&gt;Length -= <span class="keyword">sizeof</span>(WCHAR);
00940         RemainingName-&gt;MaximumLength -= <span class="keyword">sizeof</span>(WCHAR);
00941     }
00942 
00943     <span class="comment">//</span>
00944     <span class="comment">// Compute component length, return error if it's illegal</span>
00945     <span class="comment">//</span>
00946     NextName-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)
00947         ((PUCHAR)RemainingName-&gt;Buffer - (PUCHAR)(NextName-&gt;Buffer));
00948     <span class="keywordflow">if</span> (NextName-&gt;Length &gt; <a class="code" href="../../d9/d0/cmdata_8h.html#a1">MAX_KEY_NAME_LENGTH</a>)
00949     {
00950         rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00951     }
00952     NextName-&gt;MaximumLength = NextName-&gt;Length;
00953 
00954     <span class="comment">//</span>
00955     <span class="comment">// Set last, return success</span>
00956     <span class="comment">//</span>
00957     *Last = (RemainingName-&gt;Length == 0);
00958     <span class="keywordflow">return</span> rc;
00959 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="cmparse.c::CmpGetSymbolicLink" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpGetSymbolicLink           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Node</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SymbolicKcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>RemainingName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01476">1476</a> of file <a class="el" href="../../d3/d1/cmparse_8c-source.html">cmparse.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00256">CM_KCB_SYM_LINK_FOUND</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01982">CmpCacheTable</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00568">CmpCleanUpKcbValueCache()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00699">CmpConstructName()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01243">CmpFindValueByName</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01981">CmpHashTableSize</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00508">CmpIsHKeyValueSmall</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00345">CmpReferenceKeyControlBlock()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00260">CMS_PARSE</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00035">CmSymbolicLinkValueName</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00055">_CM_KEY_HASH::ConvKey</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00498">_CM_KEY_VALUE::Data</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00497">_CM_KEY_VALUE::DataLength</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00291">ExFreePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00475">GET_HASH_ENTRY</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00230">LOCK_KCB_TREE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00056">_CM_KEY_HASH::NextHash</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00107">PHCELL_INDEX</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00281">PROTECTED_POOL</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01883">RtlAppendUnicodeStringToString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01178">RtlUpcaseUnicodeChar()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00294">_CM_KEY_CONTROL_BLOCK::TotalLevels</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00499">_CM_KEY_VALUE::Type</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00231">UNLOCK_KCB_TREE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>.
<p>
<pre class="fragment"><div>01486                    :
01487 
01488     This routine extracts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> symbolic link name from a key, <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01489     marked as a symbolic link.
01490 
01491 Arguments:
01492 
01493     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key.
01494 
01495     Node - Supplies pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key node
01496 
01497     ObjectName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current ObjectName.
01498                  Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> ObjectName.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> name <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> longer
01499                  than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> maximum length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current ObjectName, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01500                  old buffer will be freed and a <span class="keyword">new</span> buffer allocated.
01501 
01502     RemainingName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remaining <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.  If present, <span class="keyword">this</span> will be
01503                 concatenated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> symbolic link to form <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> objectname.
01504 
01505 Return Value:
01506 
01507     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - symbolic link succesfully found
01508 
01509     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not a symbolic link, or an error occurred
01510 
01511 --*/
01512 
01513 {
01514     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01515     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> LinkCell;
01516     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01517     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> LinkValue;
01518     PWSTR LinkName;
01519     PWSTR NewBuffer;
01520     ULONG Length;
01521     ULONG ValueLength;
01522     <span class="keyword">extern</span> ULONG <a class="code" href="../../d1/d2/cmp_8h.html#a202">CmpHashTableSize</a>; 
01523     <span class="keyword">extern</span> <a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a> *<a class="code" href="../../d1/d2/cmp_8h.html#a203">CmpCacheTable</a>;
01524     PUNICODE_STRING ConstructedName;
01525     ULONG  ConvKey=0;
01526     <a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a> KeyHash;
01527     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> RealKcb;
01528     BOOLEAN KcbFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01529     ULONG  Cnt;
01530     WCHAR *Cp;
01531     WCHAR *Cp2;
01532     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> TotalLevels;
01533     BOOLEAN FreeConstructedName = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01534     
01535     <a class="code" href="../../d1/d2/cmp_8h.html#a16">LOCK_KCB_TREE</a>();
01536     <span class="keywordflow">if</span> (SymbolicKcb-&gt;ExtFlags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a12">CM_KCB_SYM_LINK_FOUND</a>) {
01537         <span class="comment">//</span>
01538         <span class="comment">// First see of the real kab for this symbolic name has been found</span>
01539         <span class="comment">// </span>
01540         ConstructedName = <a class="code" href="../../d8/d2/cmsubs_8c.html#a18">CmpConstructName</a>(SymbolicKcb-&gt;ValueCache.RealKcb);
01541         <span class="keywordflow">if</span> (ConstructedName) {
01542             FreeConstructedName = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01543             LinkName = ConstructedName-&gt;Buffer;
01544             ValueLength = ConstructedName-&gt;Length;
01545             Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)ValueLength + <span class="keyword">sizeof</span>(WCHAR);
01546         }
01547     } 
01548     <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
01549 
01550     <span class="keywordflow">if</span> (FreeConstructedName == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01551         <span class="comment">//</span>
01552         <span class="comment">// Find the SymbolicLinkValue value.  This is the name of the symbolic link.</span>
01553         <span class="comment">//</span>
01554         LinkCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(Hive,
01555                                       Node,
01556                                       &amp;CmSymbolicLinkValueName);
01557         <span class="keywordflow">if</span> (LinkCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01558             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_PARSE) {
01559                 KdPrint((<span class="stringliteral">"CmpGetSymbolicLink: couldn't open symbolic link\n"</span>));
01560             }
01561             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01562         }
01563     
01564         LinkValue = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, LinkCell);
01565     
01566         <span class="keywordflow">if</span> (LinkValue-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o4">Type</a> != REG_LINK) {
01567             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_PARSE) {
01568                 KdPrint((<span class="stringliteral">"CmpGetSymbolicLink: link value is wrong type: %08lx"</span>, LinkValue-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o4">Type</a>));
01569             }
01570             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01571         }
01572     
01573         LinkName = (PWSTR)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, LinkValue-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a>);
01574     
01575         <a class="code" href="../../d9/d0/cmdata_8h.html#a38">CmpIsHKeyValueSmall</a>(ValueLength, LinkValue-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o2">DataLength</a>);
01576         Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)ValueLength + <span class="keyword">sizeof</span>(WCHAR);
01577 
01578         <span class="comment">//</span>
01579         <span class="comment">// Now see if we have this kcb cached.</span>
01580         <span class="comment">//</span>
01581         Cp = LinkName;
01582         TotalLevels = 0;
01583         <span class="keywordflow">for</span> (Cnt=0; Cnt&lt;ValueLength; Cnt += <span class="keyword">sizeof</span>(WCHAR)) {
01584             <span class="keywordflow">if</span> (*Cp != OBJ_NAME_PATH_SEPARATOR) {
01585                 ConvKey = 37 * ConvKey + (ULONG) <a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(*Cp);
01586             } <span class="keywordflow">else</span> {
01587                 TotalLevels++;
01588             }
01589             ++Cp;
01590         }
01591 
01592         
01593         KeyHash = <a class="code" href="../../d1/d2/cmp_8h.html#a77">GET_HASH_ENTRY</a>(CmpCacheTable, ConvKey); 
01594 
01595         <a class="code" href="../../d1/d2/cmp_8h.html#a16">LOCK_KCB_TREE</a>();
01596         <span class="keywordflow">while</span> (KeyHash) {
01597             RealKcb =  CONTAINING_RECORD(KeyHash, <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">CM_KEY_CONTROL_BLOCK</a>, KeyHash);
01598             <span class="keywordflow">if</span> ((ConvKey == KeyHash-&gt;<a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html#o0">ConvKey</a>) &amp;&amp; (TotalLevels == RealKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o16">TotalLevels</a>)) {
01599                 ConstructedName = <a class="code" href="../../d8/d2/cmsubs_8c.html#a18">CmpConstructName</a>(RealKcb);
01600                 <span class="keywordflow">if</span> (ConstructedName) {
01601                     FreeConstructedName = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01602                     <span class="keywordflow">if</span> (ConstructedName-&gt;Length == ValueLength) {
01603                         KcbFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01604                         Cp = LinkName;
01605                         Cp2 = ConstructedName-&gt;Buffer;
01606                         <span class="keywordflow">for</span> (Cnt=0; Cnt&lt;ConstructedName-&gt;Length; Cnt += <span class="keyword">sizeof</span>(WCHAR)) {
01607                             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(*Cp) != <a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(*Cp2)) {
01608                                 KcbFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01609                                 <span class="keywordflow">break</span>;
01610                             }
01611                             ++Cp;
01612                             ++Cp2;
01613                         }
01614                         <span class="keywordflow">if</span> (KcbFound) {
01615                             <span class="comment">//</span>
01616                             <span class="comment">// Now the RealKcb is also pointed to by its symbolic link Kcb,</span>
01617                             <span class="comment">// Increase the reference count.</span>
01618                             <span class="comment">// Need to dereference the realkcb when the symbolic kcb is removed.</span>
01619                             <span class="comment">// Do this in CmpCleanUpKcbCacheWithLock();</span>
01620                             <span class="comment">//</span>
01621                             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/cmsubs_8c.html#a13">CmpReferenceKeyControlBlock</a>(RealKcb)) {
01622                                 <span class="comment">//</span>
01623                                 <span class="comment">// This symbolic kcb may have value lookup for the path</span>
01624                                 <span class="comment">// Cleanup the value cache.</span>
01625                                 <span class="comment">//</span>
01626                                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a16">CmpCleanUpKcbValueCache</a>(SymbolicKcb);
01627     
01628                                 SymbolicKcb-&gt;ExtFlags |= <a class="code" href="../../d9/d0/cmdata_8h.html#a12">CM_KCB_SYM_LINK_FOUND</a>;
01629                                 SymbolicKcb-&gt;ValueCache.RealKcb = RealKcb;
01630                             } <span class="keywordflow">else</span> {
01631                                 <span class="comment">//</span>
01632                                 <span class="comment">// We have maxed out the ref count on the real kcb.</span>
01633                                 <span class="comment">// do not cache the symbolic link.</span>
01634                                 <span class="comment">//</span>
01635                             }
01636                             <span class="keywordflow">break</span>;
01637                         }
01638                     }
01639                 } <span class="keywordflow">else</span> {
01640                     <span class="keywordflow">break</span>;
01641                 }
01642             }
01643             <span class="keywordflow">if</span> (FreeConstructedName) {
01644                 <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(ConstructedName, CM_NAME_TAG | PROTECTED_POOL);
01645                 FreeConstructedName = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01646             }
01647             KeyHash = KeyHash-&gt;<a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html#o1">NextHash</a>;
01648         }
01649         <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
01650     }
01651     
01652     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(RemainingName)) {
01653         Length += RemainingName-&gt;Length + <span class="keyword">sizeof</span>(WCHAR);
01654     }
01655 
01656     <span class="comment">//</span>
01657     <span class="comment">// Overflow test: If Length overflows the USHRT_MAX value</span>
01658     <span class="comment">//                cleanup and return FALSE  </span>
01659     <span class="comment">//</span>
01660     <span class="keywordflow">if</span>( Length&gt;0xFFFF ) {
01661         <span class="keywordflow">if</span> (FreeConstructedName) {
01662             <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(ConstructedName, CM_NAME_TAG | PROTECTED_POOL);
01663             FreeConstructedName = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01664         }
01665 
01666         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01667     }
01668 
01669         <span class="keywordflow">if</span> (Length &gt; ObjectName-&gt;MaximumLength) {
01670         UNICODE_STRING NewObjectName;
01671 
01672         <span class="comment">//</span>
01673         <span class="comment">// The new name is too long to fit in the existing ObjectName buffer,</span>
01674         <span class="comment">// so allocate a new buffer.</span>
01675         <span class="comment">//</span>
01676         NewBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, Length);
01677         <span class="keywordflow">if</span> (NewBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01678             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_PARSE) {
01679                 KdPrint((<span class="stringliteral">"CmpGetSymbolicLink: couldn't allocate new name buffer\n"</span>));
01680             }
01681             <span class="keywordflow">if</span> (FreeConstructedName) {
01682                 <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(ConstructedName, CM_NAME_TAG | PROTECTED_POOL);
01683                 FreeConstructedName = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01684             }
01685             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01686         }
01687 
01688         NewObjectName.Buffer = NewBuffer;
01689         NewObjectName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Length;
01690         NewObjectName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)ValueLength;
01691         RtlCopyMemory(NewBuffer, LinkName, ValueLength);
01692         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_PARSE) {
01693             KdPrint((<span class="stringliteral">"CmpGetSymbolicLink: LinkName is %wZ\n"</span>, ObjectName));
01694             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(RemainingName)) {
01695                 KdPrint((<span class="stringliteral">"               RemainingName is %wZ\n"</span>, RemainingName));
01696             } <span class="keywordflow">else</span> {
01697                 KdPrint((<span class="stringliteral">"               RemainingName is NULL\n"</span>));
01698             }
01699         }
01700 
01701         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(RemainingName)) {
01702             NewBuffer[ ValueLength / <span class="keyword">sizeof</span>(WCHAR) ] = OBJ_NAME_PATH_SEPARATOR;
01703             NewObjectName.Length += <span class="keyword">sizeof</span>(WCHAR);
01704             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(&amp;NewObjectName, RemainingName);
01705             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
01706         }
01707 
01708         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ObjectName-&gt;Buffer);
01709         *ObjectName = NewObjectName;
01710     } <span class="keywordflow">else</span> {
01711         <span class="comment">//</span>
01712         <span class="comment">// The new name will fit within the maximum length of the existing</span>
01713         <span class="comment">// ObjectName, so do the expansion in-place. Note that the remaining</span>
01714         <span class="comment">// name must be moved into its new position first since the symbolic</span>
01715         <span class="comment">// link may or may not overlap it.</span>
01716         <span class="comment">//</span>
01717         ObjectName-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)ValueLength;
01718         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(RemainingName)) {
01719             RtlMoveMemory(&amp;ObjectName-&gt;Buffer[(ValueLength / <span class="keyword">sizeof</span>(WCHAR)) + 1],
01720                           RemainingName-&gt;Buffer,
01721                           RemainingName-&gt;Length);
01722             ObjectName-&gt;Buffer[ValueLength / <span class="keyword">sizeof</span>(WCHAR)] = OBJ_NAME_PATH_SEPARATOR;
01723             ObjectName-&gt;Length += RemainingName-&gt;Length + <span class="keyword">sizeof</span>(WCHAR);
01724         }
01725         RtlCopyMemory(ObjectName-&gt;Buffer, LinkName, ValueLength);
01726     }
01727     ObjectName-&gt;Buffer[ObjectName-&gt;Length / <span class="keyword">sizeof</span>(WCHAR)] = UNICODE_NULL;
01728 
01729     <span class="keywordflow">if</span> (FreeConstructedName) {
01730         <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(ConstructedName, CM_NAME_TAG | PROTECTED_POOL);
01731     }
01732     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01733 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="cmparse.c::CmpParseKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpParseKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ParseObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessState</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Attributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>CompleteName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>RemainingName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID Context&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_QUALITY_OF_SERVICE <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a9">SecurityQos</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">145</a> of file <a class="el" href="../../d3/d1/cmparse_8c-source.html">cmparse.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00030">CM_HASH_STACK_SIZE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00260">CM_KCB_CACHE_MASK</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00257">CM_KCB_KEY_NON_EXIST</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00251">CM_KCB_NO_SUBKEY</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00252">CM_KCB_SUBKEY_ONE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00244">CM_SUBKEY_HINT_LENGTH</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00139">CMP_PARSE_GOTO_CREATE</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00138">CMP_PARSE_GOTO_NONE</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00140">CMP_PARSE_GOTO_RETURN</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00141">CMP_PARSE_GOTO_RETURN2</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l02056">CmpAddInfoAfterParseFailure()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01853">CmpCacheLookup()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01737">CmpComputeHashValue()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00824">CmpCreateKeyControlBlock()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01252">CmpCreateLinkNode()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01153">CmpDereferenceKeyControlBlock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01184">CmpDereferenceKeyControlBlockWithLock()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00033">CmpDoCreate()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00963">CmpDoOpen()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00186">CmpFindSubKeyByName()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00860">CmpGetNextName()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01476">CmpGetSymbolicLink()</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00036">CmpMasterHive</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00276">CmpNoMasterCreates</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00345">CmpReferenceKeyControlBlock()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01260">CmpRemoveKeyControlBlock()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00131">CmpStepThroughExit</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00260">CMS_PARSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00774">_CM_PARSE_CONTEXT::CreateLink</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00773">_CM_PARSE_CONTEXT::Disposition</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00649">_CMHIVE::Hive</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d5/d5/regext_8c-source.html#l00458">kcb()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00439">KEY_SYM_LINK</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00280">_CM_KEY_CONTROL_BLOCK::KeyCell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00279">_CM_KEY_CONTROL_BLOCK::KeyHive</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00295">_CM_KEY_CONTROL_BLOCK::KeyNode</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00230">LOCK_KCB_TREE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00107">PHCELL_INDEX</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01178">RtlUpcaseUnicodeChar()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00231">UNLOCK_KCB_TREE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01074">CmpCreateObjectTypes()</a>.
<p>
<pre class="fragment"><div>00159                    :
00160 
00161     This routine interfaces to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NT Object <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a79">Manager</a>.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked when
00162     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object system <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> given <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of an entity to create or open and
00163     a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> or KeyRoot <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> encountered in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.  In practice <span class="keyword">this</span> means
00164     that <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called <span class="keywordflow">for</span> all objects whose names are of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00165     form \REGISTRY\...
00166 
00167     This routine will create a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> object, which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> effectively an open
00168     instance to a registry key node, and <span class="keywordflow">return</span> its address
00169     (<span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> success <span class="keywordflow">case</span>.)
00170 
00171 Arguments:
00172 
00173     ParseObject - Pointer to a KeyRoot or <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>, thus -&gt; KEY_BODY.
00174 
00175     ObjectType - Type of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being opened.
00176 
00177     AccessState - <a class="code" href="../../d4/d9/ke_8h.html#a406a193">Running</a> security access state information <span class="keywordflow">for</span> operation.
00178 
00179     AccessMode - Access mode of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original caller.
00180 
00181     Attributes - Attributes to be applied to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
00182 
00183     CompleteName - Supplies complete name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
00184 
00185     RemainingName - Remaining name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
00186 
00187     Context - <span class="keywordflow">if</span> create or hive root open, points to a <a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">CM_PARSE_CONTEXT</a>
00188               structure,
00189               <span class="keywordflow">if</span> open, <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
00190 
00191     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a14">SecurityQos</a> - Optional security quality of service indicator.
00192 
00193     Object - The address of a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> created key object, <span class="keywordflow">if</span>
00194         any.
00195 
00196 Return Value:
00197 
00198     The function <span class="keywordflow">return</span> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
00199 
00200         a)  Success - This indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function succeeded and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
00201             parameter contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> created key object.
00202 
00203         b)  STATUS_REPARSE - This indicates that a symbolic link key was
00204             found, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> should be reparsed.
00205 
00206         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>)  <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a> - This indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> was not found or created and
00207             no <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object was created.
00208 
00209 --*/
00210 {
00211     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00212     BOOLEAN     rc;
00213     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>      <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00214     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node;
00215     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
00216     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ParentCell;
00217     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> NextCell;
00218     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00219     <a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">PCM_PARSE_CONTEXT</a> lcontext;
00220     UNICODE_STRING Current;
00221     UNICODE_STRING  NextName;   <span class="comment">// Component last returned by CmpGetNextName,</span>
00222                                 <span class="comment">// will always be behind Current.</span>
00223     BOOLEAN     Last;           <span class="comment">// TRUE if component NextName points to</span>
00224                                 <span class="comment">// is the last one in the path.</span>
00225 
00226     <a class="code" href="../../d1/d4/struct__CM__HASH__ENTRY.html">CM_HASH_ENTRY</a>   HashStack[<a class="code" href="../../d2/d2/cmparse_8c.html#a0">CM_HASH_STACK_SIZE</a>];
00227     ULONG           TotalRemainingSubkeys;
00228     ULONG           MatchRemainSubkeyLevel;
00229     ULONG           TotalSubkeys=0;
00230     ULONG           SubkeyParsed;
00231     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00232     <a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a> PCmpCacheEntry=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00233     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   ParentKcb;
00234     UNICODE_STRING  TmpNodeName;
00235     ULONG   namelength;
00236     ULONG   GoToValue = <a class="code" href="../../d2/d2/cmparse_8c.html#a2">CMP_PARSE_GOTO_NONE</a>;
00237     BOOLEAN CompleteKeyCached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00238     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> i,j;
00239     WCHAR *p1;
00240 
00241     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_PARSE) {
00242         KdPrint((<span class="stringliteral">"CmpParseKey:\n\t"</span>));
00243         KdPrint((<span class="stringliteral">"CompleteName = '%wZ'\n\t"</span>, CompleteName));
00244         KdPrint((<span class="stringliteral">"RemainingName = '%wZ'\n"</span>, RemainingName));
00245     }
00246 
00247     <span class="comment">//</span>
00248     <span class="comment">// Strip off any trailing path separators</span>
00249     <span class="comment">//</span>
00250     <span class="keywordflow">while</span> ((RemainingName-&gt;Length &gt; 0) &amp;&amp;
00251            (RemainingName-&gt;Buffer[(RemainingName-&gt;Length/<span class="keyword">sizeof</span>(WCHAR)) - 1] == OBJ_NAME_PATH_SEPARATOR)) {
00252         RemainingName-&gt;Length -= <span class="keyword">sizeof</span>(WCHAR);
00253     }
00254 
00255     Current = *RemainingName;
00256     <span class="keywordflow">if</span> (ObjectType != <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>) {
00257         <span class="keywordflow">return</span> STATUS_OBJECT_TYPE_MISMATCH;
00258     }
00259 
00260     lcontext = (<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">PCM_PARSE_CONTEXT</a>)Context;
00261 
00262     <span class="comment">//</span>
00263     <span class="comment">// Check to make sure the passed in root key is not marked for deletion.</span>
00264     <span class="comment">//</span>
00265     <span class="keywordflow">if</span> (((<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)ParseObject)-&gt;KeyControlBlock-&gt;Delete == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00266         <span class="keywordflow">return</span>(STATUS_KEY_DELETED);
00267     }
00268 
00269     <span class="comment">//</span>
00270     <span class="comment">// Fetch the starting Hive.Cell.  Because of the way the parse</span>
00271     <span class="comment">// paths work, this will always be defined.  (ObOpenObjectByName</span>
00272     <span class="comment">// had to bounce off of a KeyObject or KeyRootObject to get here)</span>
00273     <span class="comment">//</span>
00274     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = ((<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)ParseObject)-&gt;KeyControlBlock;
00275     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyHive;
00276     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyCell;
00277     Node = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyNode;
00278 
00279     <span class="comment">//</span>
00280     <span class="comment">// Compute the hash values of each subkeys</span>
00281     <span class="comment">//</span>
00282     TotalRemainingSubkeys = <a class="code" href="../../d2/d2/cmparse_8c.html#a13">CmpComputeHashValue</a>(HashStack,
00283                                                 &amp;TotalSubkeys,
00284                                                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ConvKey,
00285                                                 &amp;Current);
00286 
00287 
00288     <span class="comment">// Look up from the cache.  kcb will be changed if we find a partial or exact match</span>
00289     <span class="comment">// PCmpCacheEntry, the entry found, will be move to the front of</span>
00290     <span class="comment">// the Cache.</span>
00291 
00292     <a class="code" href="../../d1/d2/cmp_8h.html#a16">LOCK_KCB_TREE</a>();
00293 
00294     status = <a class="code" href="../../d2/d2/cmparse_8c.html#a14">CmpCacheLookup</a>(HashStack,
00295                             TotalRemainingSubkeys,
00296                             &amp;MatchRemainSubkeyLevel,
00297                             &amp;kcb,
00298                             &amp;Current,
00299                             &amp;Hive,
00300                             &amp;Cell);
00301     <span class="comment">//</span>
00302     <span class="comment">// The RefCount of kcb was increased in the CmpCacheLookup process,</span>
00303     <span class="comment">// It is to protect it from being kicked out of cache.</span>
00304     <span class="comment">// Make sure we dereference it after we are done.</span>
00305     <span class="comment">//</span>
00306 
00307     <span class="comment">//</span>
00308     <span class="comment">// First make sure it is OK to proceed.</span>
00309     <span class="comment">//</span>
00310     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00311         <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
00312         <span class="keywordflow">goto</span> JustReturn;
00313     }
00314 
00315     SubkeyParsed = MatchRemainSubkeyLevel;
00316     ParentKcb = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00317 
00318     <span class="comment">//</span>
00319     <span class="comment">// First check if there are further information in the cached kcb.</span>
00320     <span class="comment">// </span>
00321     <span class="comment">// The additional information can be</span>
00322     <span class="comment">// 1. This cached key is a fake key (CM_KCB_KEY_NON_EXIST), then either let it be created</span>
00323     <span class="comment">//    or return STATUS_OBJECT_NAME_NOT_FOUND.</span>
00324     <span class="comment">// 2. The cached key is not the destination and it has no subkey (CM_KCB_NO_SUBKEY).</span>
00325     <span class="comment">// 3. The cached key is not the destination and it has </span>
00326     <span class="comment">//    the first four characters of its subkeys.  If the flag is CM_KCB_SUBKEY_ONE, there is only one subkey</span>
00327     <span class="comment">//    and the four char is embedded in the KCB.  If the flag is CM_KCB_SUBKEY_INFO, then there is</span>
00328     <span class="comment">//    an allocation for these info. </span>
00329     <span class="comment">//</span>
00330     <span class="comment">// We do need to lock KCB tree to protect the KCB being modified.  Currently there is not lock contention problem</span>
00331     <span class="comment">// on KCBs, We can change KCB lock to a read-write lock if this becomes a problem.</span>
00332     <span class="comment">// </span>
00333 
00334     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ExtFlags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a15">CM_KCB_CACHE_MASK</a>) {
00335         <span class="keywordflow">if</span> (MatchRemainSubkeyLevel == TotalRemainingSubkeys) {
00336             <span class="comment">//</span>
00337             <span class="comment">// We have found a cache for the complete path,</span>
00338             <span class="comment">//</span>
00339             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ExtFlags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a13">CM_KCB_KEY_NON_EXIST</a>) {
00340                 <span class="comment">//</span>
00341                 <span class="comment">// This key does not exist.</span>
00342                 <span class="comment">//</span>
00343                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT(lcontext)) {
00344                     ULONG LevelToSkip = TotalRemainingSubkeys-1;
00345                     ULONG i=0;
00346                     <span class="comment">//</span>
00347                     <span class="comment">// The non-existing key is the desination key and lcontext is present.</span>
00348                     <span class="comment">// delete this fake kcb and let the real one be created.</span>
00349                     <span class="comment">//</span>
00350                     <span class="comment">// Temporarily increase the RefCount of the ParentKcb so it's </span>
00351                     <span class="comment">// not removed while removing the fake and creating the real KCB.</span>
00352                     <span class="comment">//</span>
00353                     
00354                     ParentKcb = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ParentKcb;
00355                     
00356                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/cmsubs_8c.html#a13">CmpReferenceKeyControlBlock</a>(ParentKcb)) {
00357                     
00358                         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;Delete = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00359                         <a class="code" href="../../d8/d2/cmsubs_8c.html#a24">CmpRemoveKeyControlBlock</a>(kcb);
00360                         <a class="code" href="../../d8/d2/cmsubs_8c.html#a23">CmpDereferenceKeyControlBlockWithLock</a>(kcb);
00361 
00362                         <span class="comment">//</span>
00363                         <span class="comment">// Update Hive, Cell and Node</span>
00364                         <span class="comment">//</span>
00365                         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = ParentKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a>;
00366                         <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = ParentKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o6">KeyCell</a>;
00367                         Node = ParentKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o17">KeyNode</a>;
00368 
00369                         <span class="comment">//</span>
00370                         <span class="comment">// Now get the child name to be created.</span>
00371                         <span class="comment">//</span>
00372    
00373                         NextName = *RemainingName;
00374                         <span class="keywordflow">if</span> ((NextName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (NextName.Length == 0)) {
00375                             KdPrint((<span class="stringliteral">"Something wrong in finding the child name\n"</span>));
00376                             DbgBreakPoint();
00377                         }
00378                         <span class="comment">//</span>
00379                         <span class="comment">// Skip over leading path separators</span>
00380                         <span class="comment">//</span>
00381                         <span class="keywordflow">if</span> (*(NextName.Buffer) == OBJ_NAME_PATH_SEPARATOR) {
00382                             NextName.Buffer++;
00383                             NextName.Length -= <span class="keyword">sizeof</span>(WCHAR);
00384                             NextName.MaximumLength -= <span class="keyword">sizeof</span>(WCHAR);
00385                         }
00386    
00387                         <span class="keywordflow">while</span> (i &lt; LevelToSkip) {
00388                             <span class="keywordflow">if</span> (*(NextName.Buffer) == OBJ_NAME_PATH_SEPARATOR) {
00389                                 i++;
00390                             }
00391                             NextName.Buffer++;
00392                             NextName.Length -= <span class="keyword">sizeof</span>(WCHAR);
00393                             NextName.MaximumLength -= <span class="keyword">sizeof</span>(WCHAR);
00394                         } 
00395                         GoToValue = <a class="code" href="../../d2/d2/cmparse_8c.html#a3">CMP_PARSE_GOTO_CREATE</a>;
00396                     } <span class="keywordflow">else</span> {
00397                         <span class="comment">//</span>
00398                         <span class="comment">// We have maxed the RefCount of ParentKcb; treate it as key cannot be created.</span>
00399                         <span class="comment">// The ParentKcb will not be dereferenced at the end.</span>
00400                         <span class="comment">//</span>
00401                         status = STATUS_INSUFFICIENT_RESOURCES;
00402                         GoToValue = <a class="code" href="../../d2/d2/cmparse_8c.html#a5">CMP_PARSE_GOTO_RETURN2</a>;
00403                     }
00404                 } <span class="keywordflow">else</span> {
00405                     status = STATUS_OBJECT_NAME_NOT_FOUND;
00406                     GoToValue = <a class="code" href="../../d2/d2/cmparse_8c.html#a4">CMP_PARSE_GOTO_RETURN</a>;
00407                 }
00408             }
00409         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ExtFlags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a13">CM_KCB_KEY_NON_EXIST</a>) {
00410             <span class="comment">//</span>
00411             <span class="comment">// one subkey (not desination) in the path does not exist. no point to continue.</span>
00412             <span class="comment">//</span>
00413             status = STATUS_OBJECT_NAME_NOT_FOUND;
00414             GoToValue = <a class="code" href="../../d2/d2/cmparse_8c.html#a4">CMP_PARSE_GOTO_RETURN</a>;
00415         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ExtFlags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a9">CM_KCB_NO_SUBKEY</a>) {
00416             <span class="comment">//</span>
00417             <span class="comment">// one parent in the path has no subkey. see if it is a create.</span>
00418             <span class="comment">//</span>
00419             <span class="keywordflow">if</span> (((TotalRemainingSubkeys - MatchRemainSubkeyLevel) == 1) &amp;&amp; (ARGUMENT_PRESENT(lcontext))) {
00420                 <span class="comment">//</span>
00421                 <span class="comment">// Now we are going to create this subkey. </span>
00422                 <span class="comment">// The kcb cache will be updated in CmpDoCreate routine.</span>
00423                 <span class="comment">//</span>
00424             } <span class="keywordflow">else</span> {
00425                 status = STATUS_OBJECT_NAME_NOT_FOUND;
00426                 GoToValue = <a class="code" href="../../d2/d2/cmparse_8c.html#a4">CMP_PARSE_GOTO_RETURN</a>;
00427             }
00428         } <span class="keywordflow">else</span> {
00429             <span class="comment">//</span>
00430             <span class="comment">// We have a partial match.  Current is the remaining name to be parsed.</span>
00431             <span class="comment">// The Key has either one or a few subkeys and has index hint. check if it is the candidate.</span>
00432             <span class="comment">//</span>
00433             ULONG HintLength;
00434             ULONG HintCounts;
00435             ULONG CmpCount;
00436             WCHAR c1;
00437             WCHAR c2;
00438             UCHAR *TmpName;
00439             LONG Result;
00440             BOOLEAN NoMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00441             <span class="comment">//</span>
00442             <span class="comment">// When NoMatch is TRUE, we know for sure there is no subkey that can match.</span>
00443             <span class="comment">// When NoMatch is FALSE, it can we either we found a match or</span>
00444             <span class="comment">// there is not enough information.  Either case, we need to continue</span>
00445             <span class="comment">// the parse.</span>
00446             <span class="comment">//</span>
00447 
00448             TmpNodeName = Current;
00449 
00450             rc = <a class="code" href="../../d2/d2/cmparse_8c.html#a21">CmpGetNextName</a>(&amp;TmpNodeName, &amp;NextName, &amp;Last);
00451         
00452             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ExtFlags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a10">CM_KCB_SUBKEY_ONE</a>) {
00453                 HintCounts = 1;
00454                 TmpName = &amp;(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;NameHint[0]);
00455             } <span class="keywordflow">else</span> {
00456                 <span class="comment">//</span>
00457                 <span class="comment">// More than one child, the hint info in not inside the kcb but pointed by kcb.</span>
00458                 <span class="comment">//</span>
00459                 HintCounts = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;IndexHint-&gt;Count;
00460                 TmpName = &amp;(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;IndexHint-&gt;NameHint[0]);
00461             }
00462 
00463             <span class="comment">//</span>
00464             <span class="comment">// use the hint to predict if there is a possible match</span>
00465             <span class="comment">//</span>
00466             <span class="keywordflow">if</span> (NextName.Length &lt; (<span class="keyword">sizeof</span>(WCHAR) * <a class="code" href="../../d9/d0/cmdata_8h.html#a7">CM_SUBKEY_HINT_LENGTH</a>) ) {
00467                 HintLength = NextName.Length / <span class="keyword">sizeof</span>(WCHAR);
00468             } <span class="keywordflow">else</span> {
00469                 HintLength = <a class="code" href="../../d9/d0/cmdata_8h.html#a7">CM_SUBKEY_HINT_LENGTH</a>;
00470             }
00471 
00472             <span class="keywordflow">for</span> (CmpCount=0; CmpCount&lt;HintCounts; CmpCount++) {
00473                 NoMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00474                 
00475                 <span class="keywordflow">if</span>( TmpName[0] == 0) {
00476                     <span class="comment">//</span>
00477                     <span class="comment">// No hint available; assume the subkey exist and go on with the parse</span>
00478                     <span class="comment">//</span>
00479                     <span class="keywordflow">break</span>;
00480                 } 
00481                 
00482                 <span class="keywordflow">for</span> (i=0; i&lt;HintLength; i++) {
00483                     c1 = NextName.Buffer[i];
00484                     c2 = (WCHAR) *TmpName;
00485 
00486                     Result = (LONG)<a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(c1) - (LONG)<a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(c2);
00487                     <span class="keywordflow">if</span> (Result != 0) {
00488                         NoMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00489                         TmpName += (<a class="code" href="../../d9/d0/cmdata_8h.html#a7">CM_SUBKEY_HINT_LENGTH</a>-i); 
00490                         <span class="keywordflow">break</span>;
00491                     }
00492                     TmpName++;
00493                 }
00494                 
00495                 <span class="keywordflow">if</span> (NoMatch == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00496                     <span class="comment">//</span>
00497                     <span class="comment">// There is a match.</span>
00498                     <span class="comment">//</span>
00499                     <span class="keywordflow">break</span>;
00500                 }
00501             }
00502 
00503             <span class="keywordflow">if</span> (NoMatch) {
00504                 <span class="keywordflow">if</span> (((TotalRemainingSubkeys - MatchRemainSubkeyLevel) == 1) &amp;&amp; (ARGUMENT_PRESENT(lcontext))) {
00505                     <span class="comment">//</span>
00506                     <span class="comment">// No we are going to create this subkey. </span>
00507                     <span class="comment">// The kcb cache will be updated in CmpDoCreate.</span>
00508                     <span class="comment">//</span>
00509                 } <span class="keywordflow">else</span> {
00510                     status = STATUS_OBJECT_NAME_NOT_FOUND;
00511                     GoToValue = <a class="code" href="../../d2/d2/cmparse_8c.html#a4">CMP_PARSE_GOTO_RETURN</a>;
00512                 }
00513             }
00514         }
00515     }
00516 
00517     <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
00518 
00519 
00520     <span class="keywordflow">if</span> (GoToValue == <a class="code" href="../../d2/d2/cmparse_8c.html#a3">CMP_PARSE_GOTO_CREATE</a>) {
00521         <span class="keywordflow">goto</span> CreateChild;
00522     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (GoToValue == <a class="code" href="../../d2/d2/cmparse_8c.html#a4">CMP_PARSE_GOTO_RETURN</a>) {
00523         <span class="keywordflow">goto</span> FreeAndReturn;
00524     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (GoToValue == <a class="code" href="../../d2/d2/cmparse_8c.html#a5">CMP_PARSE_GOTO_RETURN2</a>) {
00525         <span class="keywordflow">goto</span> JustReturn;
00526     }
00527 
00528     <span class="keywordflow">if</span> (MatchRemainSubkeyLevel) {
00529         <span class="comment">// Found something, update the information to start the search</span>
00530         <span class="comment">// from the new BaseName</span>
00531 
00532         <span class="comment">//</span>
00533         <span class="comment">// Get the Node address from the kcb.</span>
00534         <span class="comment">// (Always try to utilize the KCB to avoid touching the registry data).</span>
00535         <span class="comment">//</span>
00536         Node = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyNode;
00537 
00538         <span class="keywordflow">if</span> (MatchRemainSubkeyLevel == TotalSubkeys) {
00539             <span class="comment">// The complete key has been found in the cache,</span>
00540             <span class="comment">// go directly to the CmpDoOpen.</span>
00541             
00542             <span class="comment">//</span>
00543             <span class="comment">// Found the whole thing cached.</span>
00544             <span class="comment">// </span>
00545             <span class="comment">//</span>
00546             CompleteKeyCached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00547             <span class="keywordflow">goto</span> Found;
00548         }
00549     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TotalRemainingSubkeys == 0) {
00550         <span class="comment">//</span>
00551         <span class="comment">// BUGBUG John Vert (jvert) 10/7/1997</span>
00552         <span class="comment">//</span>
00553         CompleteKeyCached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00554         <span class="keywordflow">goto</span> Found;
00555     }
00556 
00557     <span class="comment">//</span>
00558     <span class="comment">// Parse the path.</span>
00559     <span class="comment">//</span>
00560 
00561     status = STATUS_SUCCESS;
00562     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00563 
00564         <span class="comment">//</span>
00565         <span class="comment">// Parse out next component of name</span>
00566         <span class="comment">//</span>
00567         rc = <a class="code" href="../../d2/d2/cmparse_8c.html#a21">CmpGetNextName</a>(&amp;Current, &amp;NextName, &amp;Last);
00568         <span class="keywordflow">if</span> ((NextName.Length &gt; 0) &amp;&amp; (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00569 
00570             <span class="comment">//</span>
00571             <span class="comment">// As we iterate through, we will create a kcb for each subkey parsed.</span>
00572             <span class="comment">// </span>
00573             <span class="comment">// Always use the information in kcb to avoid</span>
00574             <span class="comment">// touching registry data.</span>
00575             <span class="comment">//</span>
00576             <span class="keywordflow">if</span> (!(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a31">KEY_SYM_LINK</a>)) {
00577                 <span class="comment">//</span>
00578                 <span class="comment">// Got a legal name component, see if we can find a sub key</span>
00579                 <span class="comment">// that actually has such a name.</span>
00580                 <span class="comment">//</span>
00581                 NextCell = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(Hive,
00582                                                Node,
00583                                                &amp;NextName);
00584 
00585                 <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_PARSE) {
00586                     KdPrint((<span class="stringliteral">"CmpParseKey:\n\t"</span>));
00587                     KdPrint((<span class="stringliteral">"NextName = '%wZ'\n\t"</span>, &amp;NextName));
00588                     KdPrint((<span class="stringliteral">"NextCell = %08lx  Last = %01lx\n"</span>, NextCell, Last));
00589                 }
00590                 <span class="keywordflow">if</span> (NextCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00591                     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = NextCell;
00592                     Node = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,Cell);
00593                     <span class="keywordflow">if</span> (Last == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00594 
00595 Found:
00596                         <span class="comment">//</span>
00597                         <span class="comment">// We will open the key regardless of whether the</span>
00598                         <span class="comment">// call was open or create, so step through exit</span>
00599                         <span class="comment">// portholes here.</span>
00600                         <span class="comment">//</span>
00601 
00602                         <span class="keywordflow">if</span> (CompleteKeyCached == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00603                             <span class="comment">//</span>
00604                             <span class="comment">// If the key found is already cached, </span>
00605                             <span class="comment">// do not need to StepThroughExit</span>
00606                             <span class="comment">// (no kcb is created using exit node).</span>
00607                             <span class="comment">// This prevents us from touching the key node just for the Flags.</span>
00608                             <span class="comment">//</span>
00609                         } <span class="keywordflow">else</span> {
00610                             <a class="code" href="../../d2/d2/cmparse_8c.html#a1">CmpStepThroughExit</a>(Hive, Cell, Node);
00611                         }
00612                         <span class="comment">//</span>
00613                         <span class="comment">// We have found the entire path, so we want to open</span>
00614                         <span class="comment">// it (for both Open and Create calls).</span>
00615                         <span class="comment">// Hive,Cell -&gt; the key we are supposed to open.</span>
00616                         <span class="comment">//</span>
00617 
00618                         status = <a class="code" href="../../d2/d2/cmparse_8c.html#a18">CmpDoOpen</a>(Hive,
00619                                            Cell,
00620                                            Node,
00621                                            AccessState,
00622                                            AccessMode,
00623                                            Attributes,
00624                                            lcontext,
00625                                            CompleteKeyCached,
00626                                            &amp;kcb,
00627                                            &amp;NextName,
00628                                            Object);
00629 
00630                         <span class="keywordflow">if</span> (status == STATUS_REPARSE) {
00631                             <span class="comment">//</span>
00632                             <span class="comment">// The given key was a symbolic link.  Find the name of</span>
00633                             <span class="comment">// its link, and return STATUS_REPARSE to the Object Manager.</span>
00634                             <span class="comment">//</span>
00635 
00636                             <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d2/cmparse_8c.html#a17">CmpGetSymbolicLink</a>(Hive,
00637                                                     Node,
00638                                                     CompleteName,
00639                                                     kcb,
00640                                                     NULL)) {
00641                                 <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_PARSE) {
00642                                     KdPrint((<span class="stringliteral">"CmpParseKey: couldn't find symbolic link name\n"</span>));
00643                                 }
00644                                 status = STATUS_OBJECT_NAME_NOT_FOUND;
00645                             }
00646                         }
00647 
00648                         <span class="keywordflow">break</span>;
00649                     }
00650                     <span class="comment">// else</span>
00651                     <span class="comment">//   Not at end, so we'll simply iterate and consume</span>
00652                     <span class="comment">//   the next component.</span>
00653                     <span class="comment">//</span>
00654                     <span class="comment">//</span>
00655                     <span class="comment">// Step through exit portholes here.</span>
00656                     <span class="comment">// This ensures that no KCB is created using</span>
00657                     <span class="comment">// the Exit node.</span>
00658                     <span class="comment">//</span>
00659 
00660                     <a class="code" href="../../d2/d2/cmparse_8c.html#a1">CmpStepThroughExit</a>(Hive, Cell, Node);
00661 
00662                     <span class="comment">//</span>
00663                     <span class="comment">// Create a kcb for each subkey parsed.</span>
00664                     <span class="comment">//</span>
00665 
00666                     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = <a class="code" href="../../d8/d2/cmsubs_8c.html#a20">CmpCreateKeyControlBlock</a>(Hive,
00667                                                    Cell,
00668                                                    Node,
00669                                                    ParentKcb,
00670                                                    FALSE,
00671                                                    &amp;NextName);
00672             
00673                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>  == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00674                         status = STATUS_INSUFFICIENT_RESOURCES;
00675                         <span class="keywordflow">goto</span> FreeAndReturn;
00676                         <span class="comment">//</span>
00677                         <span class="comment">// Currently, the kcb has one extra reference conut to be decremented.</span>
00678                         <span class="comment">// So, remember it so we can dereference it properly.</span>
00679                         <span class="comment">//</span>
00680                     }
00681                     <span class="comment">//</span>
00682                     <span class="comment">// Now we have created a kcb for the next level,</span>
00683                     <span class="comment">// the kcb in the previous level is no longer needed.</span>
00684                     <span class="comment">// Dereference the parent kcb.</span>
00685                     <span class="comment">//</span>
00686                     <a class="code" href="../../d8/d2/cmsubs_8c.html#a22">CmpDereferenceKeyControlBlock</a>(ParentKcb);
00687 
00688                     ParentKcb = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00689 
00690 
00691                 } <span class="keywordflow">else</span> {
00692                     <span class="comment">//</span>
00693                     <span class="comment">// We did not find a key matching the name, but no</span>
00694                     <span class="comment">// unexpected error occured</span>
00695                     <span class="comment">//</span>
00696 
00697                     <span class="keywordflow">if</span> ((Last == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp; (ARGUMENT_PRESENT(lcontext))) {
00698 
00699 CreateChild:
00700                         <span class="comment">//</span>
00701                         <span class="comment">// Only unfound component is last one, and operation</span>
00702                         <span class="comment">// is a create, so perform the create.</span>
00703                         <span class="comment">//</span>
00704 
00705                         <span class="comment">//</span>
00706                         <span class="comment">// There are two possibilities here.  The normal one</span>
00707                         <span class="comment">// is that we are simply creating a new node.</span>
00708                         <span class="comment">//</span>
00709                         <span class="comment">// The abnormal one is that we are creating a root</span>
00710                         <span class="comment">// node that is linked to the main hive.  In this</span>
00711                         <span class="comment">// case, we must create the link.  Once the link is</span>
00712                         <span class="comment">// created, we can check to see if the root node</span>
00713                         <span class="comment">// exists, then either create it or open it as</span>
00714                         <span class="comment">// necessary.</span>
00715                         <span class="comment">//</span>
00716                         <span class="comment">// CmpCreateLinkNode creates the link, and calls</span>
00717                         <span class="comment">// back to CmpDoCreate or CmpDoOpen to create or open</span>
00718                         <span class="comment">// the root node as appropriate.</span>
00719                         <span class="comment">//</span>
00720 
00721                         <span class="keywordflow">if</span> (lcontext-&gt;<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o4">CreateLink</a>) {
00722                             status = <a class="code" href="../../d2/d2/cmparse_8c.html#a19">CmpCreateLinkNode</a>(Hive,
00723                                                        Cell,
00724                                                        AccessState,
00725                                                        NextName,
00726                                                        AccessMode,
00727                                                        Attributes,
00728                                                        lcontext,
00729                                                        ParentKcb,
00730                                                        Object);
00731 
00732                         } <span class="keywordflow">else</span> {
00733 
00734                             <span class="keywordflow">if</span> ( (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> == &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>)) &amp;&amp;
00735                                  (<a class="code" href="../../d6/d0/cmdat_8c.html#a64">CmpNoMasterCreates</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) ) {
00736                                 <span class="comment">//</span>
00737                                 <span class="comment">// attempting to create a cell in the master</span>
00738                                 <span class="comment">// hive, and not a link, so blow out of here,</span>
00739                                 <span class="comment">// since it wouldn't work anyway.</span>
00740                                 <span class="comment">//</span>
00741                                 status = STATUS_INVALID_PARAMETER;
00742                                 <span class="keywordflow">break</span>;
00743                             }
00744 
00745                             status = <a class="code" href="../../d3/d2/cmparse2_8c.html#a1">CmpDoCreate</a>(Hive,
00746                                                  Cell,
00747                                                  AccessState,
00748                                                  &amp;NextName,
00749                                                  AccessMode,
00750                                                  lcontext,
00751                                                  ParentKcb,
00752                                                  Object);
00753                         }
00754 
00755                         lcontext-&gt;<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o3">Disposition</a> = REG_CREATED_NEW_KEY;
00756                         <span class="keywordflow">break</span>;
00757 
00758                     } <span class="keywordflow">else</span> {
00759 
00760                         <span class="comment">//</span>
00761                         <span class="comment">// Did not find a key to match the component, and</span>
00762                         <span class="comment">// are not at the end of the path.  Thus, open must</span>
00763                         <span class="comment">// fail because the whole path dosn't exist, create must</span>
00764                         <span class="comment">// fail because more than 1 component doesn't exist.</span>
00765                         <span class="comment">//</span>
00766                         <span class="comment">//</span>
00767                         <span class="comment">// We have a lookup failure here, so having additional information</span>
00768                         <span class="comment">// about this kcb may help us not to go through all the code just to fail again.</span>
00769                         <span class="comment">// </span>
00770                         ParentKcb = <a class="code" href="../../d2/d2/cmparse_8c.html#a16">CmpAddInfoAfterParseFailure</a>(Hive,
00771                                                                 Cell,
00772                                                                 Node,
00773                                                                 kcb,
00774                                                                 &amp;NextName
00775                                                                 );
00776                         
00777                         status = STATUS_OBJECT_NAME_NOT_FOUND;
00778                         <span class="keywordflow">break</span>;
00779                     }
00780 
00781                 }
00782 
00783             } <span class="keywordflow">else</span> {
00784                 <span class="comment">//</span>
00785                 <span class="comment">// The given key was a symbolic link.  Find the name of</span>
00786                 <span class="comment">// its link, and return STATUS_REPARSE to the Object Manager.</span>
00787                 <span class="comment">//</span>
00788                 Current.Buffer = NextName.Buffer;
00789                 Current.Length += NextName.Length;
00790                 Current.MaximumLength += NextName.MaximumLength;
00791                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/cmparse_8c.html#a17">CmpGetSymbolicLink</a>(Hive,
00792                                        Node,
00793                                        CompleteName,
00794                                        kcb,
00795                                        &amp;Current)) {
00796 
00797                     status = STATUS_REPARSE;
00798                     <span class="keywordflow">break</span>;
00799 
00800                 } <span class="keywordflow">else</span> {
00801                     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_PARSE) {
00802                         KdPrint((<span class="stringliteral">"CmpParseKey: couldn't find symbolic link name\n"</span>));
00803                     }
00804                     status = STATUS_OBJECT_NAME_NOT_FOUND;
00805                     <span class="keywordflow">break</span>;
00806                 }
00807             }
00808 
00809         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; Last == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00810             <span class="comment">//</span>
00811             <span class="comment">// We will open the \Registry root.</span>
00812             <span class="comment">// Or some strange remaining name that</span>
00813             <span class="comment">// screw up the lookup.</span>
00814             <span class="comment">//</span>
00815             <a class="code" href="../../d2/d2/cmparse_8c.html#a1">CmpStepThroughExit</a>(Hive, Cell, Node);
00816 
00817             <span class="comment">//</span>
00818             <span class="comment">// We have found the entire path, so we want to open</span>
00819             <span class="comment">// it (for both Open and Create calls).</span>
00820             <span class="comment">// Hive,Cell -&gt; the key we are supposed to open.</span>
00821             <span class="comment">//</span>
00822             status = <a class="code" href="../../d2/d2/cmparse_8c.html#a18">CmpDoOpen</a>(Hive,
00823                                Cell,
00824                                Node,
00825                                AccessState,
00826                                AccessMode,
00827                                Attributes,
00828                                lcontext,
00829                                TRUE,
00830                                &amp;kcb,
00831                                &amp;NextName,
00832                                Object);
00833             <span class="keywordflow">break</span>;
00834 
00835         } <span class="keywordflow">else</span> {
00836 
00837             <span class="comment">//</span>
00838             <span class="comment">// bogus path -&gt; fail</span>
00839             <span class="comment">//</span>
00840             status = STATUS_INVALID_PARAMETER;
00841             <span class="keywordflow">break</span>;
00842         }
00843 
00844     } <span class="comment">// while</span>
00845 
00846 FreeAndReturn:
00847     <span class="comment">//</span>
00848     <span class="comment">// Now we have to free the last kcb that still has one extra reference count to</span>
00849     <span class="comment">// protect it from being freed.</span>
00850     <span class="comment">//</span>
00851 
00852     <a class="code" href="../../d8/d2/cmsubs_8c.html#a22">CmpDereferenceKeyControlBlock</a>(ParentKcb);
00853 JustReturn:
00854 
00855     <span class="keywordflow">return</span> status;
00856 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a6" doxytag="cmparse.c::CmpCacheOnFlag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d2/d2/cmparse_8c.html#a6">CmpCacheOnFlag</a> = CM_CACHE_FAKE_KEY          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00023">23</a> of file <a class="el" href="../../d3/d1/cmparse_8c-source.html">cmparse.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/cmparse_8c-source.html#l02056">CmpAddInfoAfterParseFailure()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="cmparse.c::CmpKeyControlBlockRoot" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> <a class="el" href="../../d3/d2/cmparse2_8c.html#a0">CmpKeyControlBlockRoot</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00027">27</a> of file <a class="el" href="../../d3/d1/cmparse_8c-source.html">cmparse.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="cmparse.c::CmpMasterHive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> <a class="el" href="../../d6/d3/cmwraper_8c.html#a7">CmpMasterHive</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00025">25</a> of file <a class="el" href="../../d3/d1/cmparse_8c-source.html">cmparse.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="cmparse.c::CmpNoMasterCreates" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d1/d3/cmsysini_8c.html#a21">CmpNoMasterCreates</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00026">26</a> of file <a class="el" href="../../d3/d1/cmparse_8c-source.html">cmparse.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="cmparse.c::CmSymbolicLinkValueName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UNICODE_STRING <a class="el" href="../../d6/d2/hwprofil_8c.html#a0">CmSymbolicLinkValueName</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00028">28</a> of file <a class="el" href="../../d3/d1/cmparse_8c-source.html">cmparse.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:10 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
