<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cmsysini.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cmsysini.c</h1><a href="../../d1/d3/cmsysini_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    cmsysini.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains init support for the configuration manager,</span>
00012 <span class="comment">    particularly the registry.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Bryan M. Willman (bryanwi) 26-Aug-1991</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Elliot Shmukler (t-ellios) 24-Aug-1998</span>
00021 <span class="comment"></span>
00022 <span class="comment">         Added CmpSaveBootControlSet &amp; CmpDeleteCloneTree in order to</span>
00023 <span class="comment">         perform some of the LKG work that has been moved into the kernel.</span>
00024 <span class="comment">         Modified system initialization to permit operation and LKG control</span>
00025 <span class="comment">         set saves without a CurrentControlSet clone.</span>
00026 <span class="comment"></span>
00027 <span class="comment">--*/</span>
00028 
00029 <span class="preprocessor">#include    "<a class="code" href="../../d1/d2/cmp_8h.html">cmp.h</a>"</span>
00030 <span class="preprocessor">#pragma hdrstop</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#include    "<a class="code" href="../../d2/d9/arccodes_8h.html">arccodes.h</a>"</span>
00032 
00033 <span class="comment">//</span>
00034 <span class="comment">// paths</span>
00035 <span class="comment">//</span>
00036 
<a name="l00037"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a0">00037</a> <span class="preprocessor">#define INIT_SYSTEMROOT_HIVEPATH L"\\SystemRoot\\System32\\Config\\"</span>
00038 <span class="preprocessor"></span>
<a name="l00039"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a1">00039</a> <span class="preprocessor">#define INIT_REGISTRY_MASTERPATH   L"\\REGISTRY\\"</span>
00040 <span class="preprocessor"></span>
00041 <span class="preprocessor">#if DBG</span>
00042 <span class="preprocessor"></span><span class="comment">//</span>
00043 <span class="comment">// Logging support</span>
00044 <span class="comment">//</span>
00045 
00046 ULONG   <a class="code" href="../../d6/d3/cmwraper_8c.html#a5">CmLogLevel</a> = 1;
00047 ULONG   <a class="code" href="../../d6/d3/cmwraper_8c.html#a6">CmLogSelect</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a54">CMS_DEFAULT</a>;
00048 <span class="preprocessor">#endif</span>
00049 <span class="preprocessor"></span>
<a name="l00050"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a9">00050</a> <span class="keyword">extern</span>  <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a>   <a class="code" href="../../d1/d3/cmsysini_8c.html#a9">CmpSystemProcess</a>;
<a name="l00051"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a10">00051</a> <span class="keyword">extern</span>  <a class="code" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a> <a class="code" href="../../d1/d2/cmp_8h.html#a186">CmpRegistryLock</a>;
<a name="l00052"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a11">00052</a> <span class="keyword">extern</span>  <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a>    <a class="code" href="../../d1/d2/cmp_8h.html#a155">CmpKcbLock</a>;
<a name="l00053"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a12">00053</a> <span class="keyword">extern</span>  <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="code" href="../../d1/d2/cmp_8h.html#a177">CmpPostLock</a>;
00054 
<a name="l00055"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a13">00055</a> <span class="keyword">extern</span>  BOOLEAN     <a class="code" href="../../d6/d0/cmdat_8c.html#a68">CmFirstTime</a>;
00056 
00057 
00058 <span class="comment">//</span>
00059 <span class="comment">// List of MACHINE hives to load.</span>
00060 <span class="comment">//</span>
<a name="l00061"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a14">00061</a> <span class="keyword">extern</span>  <a class="code" href="../../d9/d7/struct__HIVE__LIST__ENTRY.html">HIVE_LIST_ENTRY</a> <a class="code" href="../../d6/d0/cmdat_8c.html#a62">CmpMachineHiveList</a>[];
00062 
<a name="l00063"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a2">00063</a> <span class="preprocessor">#define SYSTEM_HIVE_INDEX 3</span>
<a name="l00064"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a3">00064</a> <span class="preprocessor"></span><span class="preprocessor">#define CLONE_HIVE_INDEX 6</span>
00065 <span class="preprocessor"></span>
<a name="l00066"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a4">00066</a> <span class="preprocessor">#define SYSTEM_PATH L"\\registry\\machine\\system"</span>
00067 <span class="preprocessor"></span>
00068 <span class="comment">//</span>
00069 <span class="comment">// special keys for backwards compatibility with 1.0</span>
00070 <span class="comment">//</span>
<a name="l00071"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a5">00071</a> <span class="preprocessor">#define HKEY_PERFORMANCE_TEXT       (( HANDLE ) (ULONG_PTR)((LONG)0x80000050) )</span>
<a name="l00072"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a6">00072</a> <span class="preprocessor"></span><span class="preprocessor">#define HKEY_PERFORMANCE_NLSTEXT    (( HANDLE ) (ULONG_PTR)((LONG)0x80000060) )</span>
00073 <span class="preprocessor"></span>
<a name="l00074"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a15">00074</a> <span class="keyword">extern</span> UNICODE_STRING  <a class="code" href="../../d6/d0/cmdat_8c.html#a34">CmpSystemFileName</a>;
<a name="l00075"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a16">00075</a> <span class="keyword">extern</span> UNICODE_STRING  <a class="code" href="../../d8/d9/cmapi_8c.html#a6">CmSymbolicLinkValueName</a>;
<a name="l00076"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a17">00076</a> <span class="keyword">extern</span> UNICODE_STRING  <a class="code" href="../../d6/d0/cmdat_8c.html#a0">CmpLoadOptions</a>;         <span class="comment">// sys options from FW or boot.ini</span>
<a name="l00077"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a18">00077</a> <span class="keyword">extern</span> PWCHAR <a class="code" href="../../d6/d0/cmdat_8c.html#a59">CmpProcessorControl</a>;
<a name="l00078"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a19">00078</a> <span class="keyword">extern</span> PWCHAR <a class="code" href="../../d6/d0/cmdat_8c.html#a60">CmpControlSessionManager</a>;
00079 
00080 <span class="comment">//</span>
00081 <span class="comment">//</span>
00082 <span class="comment">// Object type definition support.</span>
00083 <span class="comment">//</span>
00084 <span class="comment">// Key objects (CmpKeyObjectType) represent open instances of keys in the</span>
00085 <span class="comment">// registry.  They do not have object names, rather, their names are</span>
00086 <span class="comment">// defined by the registry backing store.</span>
00087 <span class="comment">//</span>
00088 
00089 <span class="comment">//</span>
00090 <span class="comment">// Master Hive</span>
00091 <span class="comment">//</span>
00092 <span class="comment">//  The KEY_NODEs for \REGISTRY, \REGISTRY\MACHINE, and \REGISTRY\USER</span>
00093 <span class="comment">//  are stored in a small memory only hive called the Master Hive.</span>
00094 <span class="comment">//  All other hives have link nodes in this hive which point to them.</span>
00095 <span class="comment">//</span>
<a name="l00096"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a20">00096</a> <span class="keyword">extern</span>   <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>;
<a name="l00097"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a21">00097</a> <span class="keyword">extern</span>   BOOLEAN <a class="code" href="../../d6/d0/cmdat_8c.html#a64">CmpNoMasterCreates</a>;    <span class="comment">// Init False, Set TRUE after we're done to</span>
00098                                         <span class="comment">// prevent random creates in the</span>
00099                                         <span class="comment">// master hive, which is not backed</span>
00100                                         <span class="comment">// by a file.</span>
00101 
<a name="l00102"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a22">00102</a> <span class="keyword">extern</span>   LIST_ENTRY  <a class="code" href="../../d8/d9/cmapi_8c.html#a1">CmpHiveListHead</a>;   <span class="comment">// List of CMHIVEs</span>
00103 
00104 
00105 <span class="comment">//</span>
00106 <span class="comment">// Addresses of object type descriptors:</span>
00107 <span class="comment">//</span>
00108 
<a name="l00109"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a23">00109</a> <span class="keyword">extern</span>   <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>;
00110 
00111 <span class="comment">//</span>
00112 <span class="comment">// Define attributes that Key objects are not allowed to have.</span>
00113 <span class="comment">//</span>
00114 
<a name="l00115"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a7">00115</a> <span class="preprocessor">#define CMP_KEY_INVALID_ATTRIBUTES  (OBJ_EXCLUSIVE  |\</span>
00116 <span class="preprocessor">                                     OBJ_PERMANENT)</span>
00117 <span class="preprocessor"></span>
00118 
00119 <span class="comment">//</span>
00120 <span class="comment">// Global control values</span>
00121 <span class="comment">//</span>
00122 
00123 <span class="comment">//</span>
00124 <span class="comment">// Write-Control:</span>
00125 <span class="comment">//  CmpNoWrite is initially true.  When set this way write and flush</span>
00126 <span class="comment">//  do nothing, simply returning success.  When cleared to FALSE, I/O</span>
00127 <span class="comment">//  is enabled.  This change is made after the I/O system is started</span>
00128 <span class="comment">//  AND autocheck (chkdsk) has done its thing.</span>
00129 <span class="comment">//</span>
00130 
<a name="l00131"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a24">00131</a> <span class="keyword">extern</span> BOOLEAN <a class="code" href="../../d8/d9/cmapi_8c.html#a0">CmpNoWrite</a>;
00132 
<a name="l00133"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a25">00133</a> <span class="keyword">extern</span> BOOLEAN <a class="code" href="../../d7/d0/cmdat2_8c.html#a13">HvShutdownComplete</a>;
00134 
00135 <span class="comment">//</span>
00136 <span class="comment">// Buffer used for quick-stash transfers in CmSetValueKey</span>
00137 <span class="comment">//</span>
<a name="l00138"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a26">00138</a> <span class="keyword">extern</span> PUCHAR  <a class="code" href="../../d8/d9/cmapi_8c.html#a4">CmpStashBuffer</a>;
<a name="l00139"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a27">00139</a> <span class="keyword">extern</span> ULONG   <a class="code" href="../../d8/d9/cmapi_8c.html#a5">CmpStashBufferSize</a>;
00140 
00141 
00142 <span class="comment">//</span>
00143 <span class="comment">// set to true if disk full when trying to save the changes made between system hive loading and registry initalization</span>
00144 <span class="comment">//</span>
<a name="l00145"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a28">00145</a> <span class="keyword">extern</span> BOOLEAN <a class="code" href="../../d7/d0/cmdat2_8c.html#a8">CmpCannotWriteConfiguration</a>;
00146 <span class="comment">//</span>
00147 <span class="comment">// Global "constants"</span>
00148 <span class="comment">//</span>
00149 
<a name="l00150"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a29">00150</a> <span class="keyword">extern</span>   UNICODE_STRING <a class="code" href="../../d6/d0/cmdat_8c.html#a12">nullclass</a>;
00151 
00152 <span class="comment">//</span>
00153 <span class="comment">// Private prototypes</span>
00154 <span class="comment">//</span>
00155 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00156 <a class="code" href="../../d1/d3/cmsysini_8c.html#a30">CmpCreatePredefined</a>(
00157     IN HANDLE Root,
00158     IN PWSTR KeyName,
00159     IN HANDLE PredefinedHandle
00160     );
00161 
00162 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00163 <a class="code" href="../../d1/d3/cmsysini_8c.html#a31">CmpCreatePerfKeys</a>(
00164     VOID
00165     );
00166 
00167 BOOLEAN
00168 <a class="code" href="../../d1/d3/cmsysini_8c.html#a32">CmpLinkKeyToHive</a>(
00169     PWSTR   KeyPath,
00170     PWSTR   HivePath
00171     );
00172 
00173 BOOLEAN
00174 <a class="code" href="../../d1/d3/cmsysini_8c.html#a33">CmpValidateAlternate</a>(
00175     IN HANDLE FileHandle,
00176     IN <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> PrimaryHive
00177     );
00178 
00179 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00180 <a class="code" href="../../d1/d3/cmsysini_8c.html#a34">CmpCreateControlSet</a>(
00181     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
00182     );
00183 
00184 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00185 <a class="code" href="../../d1/d3/cmsysini_8c.html#a35">CmpCloneControlSet</a>(
00186     VOID
00187     );
00188 
00189 BOOLEAN
00190 <a class="code" href="../../d1/d3/cmsysini_8c.html#a36">CmpCreateObjectTypes</a>(
00191     VOID
00192     );
00193 
00194 BOOLEAN
00195 <a class="code" href="../../d1/d3/cmsysini_8c.html#a37">CmpCreateRegistryRoot</a>(
00196     VOID
00197     );
00198 
00199 BOOLEAN
00200 <a class="code" href="../../d1/d3/cmsysini_8c.html#a38">CmpCreateRootNode</a>(
00201     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>   Hive,
00202     IN PWSTR    Name,
00203     OUT PHCELL_INDEX RootCellIndex
00204     );
00205 
00206 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00207 <a class="code" href="../../d1/d3/cmsysini_8c.html#a39">CmpFreeDriverList</a>(
00208     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00209     IN PLIST_ENTRY DriverList
00210     );
00211 
00212 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00213 <a class="code" href="../../d5/d3/cmworker_8c.html#a15">CmpInitializeHiveList</a>(
00214     VOID
00215     );
00216 
00217 BOOLEAN
00218 <a class="code" href="../../d1/d3/cmsysini_8c.html#a41">CmpInitializeSystemHive</a>(
00219     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
00220     );
00221 
00222 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00223 <a class="code" href="../../d1/d3/cmsysini_8c.html#a42">CmpInterlockedFunction</a> (
00224     PWCHAR RegistryValueKey,
00225     VOID (*InterlockedFunction)(VOID)
00226     );
00227 
00228 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00229 <a class="code" href="../../d1/d3/cmsysini_8c.html#a43">CmpConfigureProcessors</a> (
00230     VOID
00231     );
00232 
00233 <span class="preprocessor">#if i386</span>
00234 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00235 <a class="code" href="../../d6/d9/kernlini_8c.html#a60">KeOptimizeProcessorControlState</a> (
00236     VOID
00237     );
00238 <span class="preprocessor">#endif</span>
00239 <span class="preprocessor"></span>
00240 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00241 <a class="code" href="../../d1/d3/cmsysini_8c.html#a44">CmpAddDockingInfo</a> (
00242     IN HANDLE Key,
00243     IN <a class="code" href="../../d0/d1/struct__PROFILE__PARAMETER__BLOCK.html">PROFILE_PARAMETER_BLOCK</a> * ProfileBlock
00244     );
00245 
00246 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00247 <a class="code" href="../../d1/d3/cmsysini_8c.html#a45">CmpAddAliasEntry</a> (
00248     IN HANDLE IDConfigDB,
00249     IN <a class="code" href="../../d0/d1/struct__PROFILE__PARAMETER__BLOCK.html">PROFILE_PARAMETER_BLOCK</a> * ProfileBlock,
00250     IN ULONG  ProfileNumber
00251     );
00252 
00253 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d3/cmsysini_8c.html#a55">CmpDeleteCloneTree</a>(VOID);
00254 
00255 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00256 <a class="code" href="../../d5/d3/cmworker_8c.html#a19">CmpDiskFullWarning</a>(
00257     VOID
00258     );
00259 
00260 
00261 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00262 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmInitSystem1)</span>
00263 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpCreateControlSet)</span>
00264 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpCloneControlSet)</span>
00265 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpCreateObjectTypes)</span>
00266 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpCreateRegistryRoot)</span>
00267 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpCreateRootNode)</span>
00268 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpInitializeSystemHive)</span>
00269 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmGetSystemDriverList)</span>
00270 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpFreeDriverList)</span>
00271 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpInitializeHiveList)</span>
00272 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpLinkHiveToMaster)</span>
00273 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpSetVersionData)</span>
00274 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmBootLastKnownGood)</span>
00275 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpSaveBootControlSet)</span>
00276 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpInitHiveFromFile)</span>
00277 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpIsLastKnownGoodBoot)</span>
00278 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpLinkKeyToHive)</span>
00279 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmShutdownSystem)</span>
00280 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpValidateAlternate)</span>
00281 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpCreatePredefined)</span>
00282 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpCreatePerfKeys)</span>
00283 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpInterlockedFunction)</span>
00284 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpConfigureProcessors)</span>
00285 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpAddDockingInfo)</span>
00286 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpAddAliasEntry)</span>
00287 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpDeleteCloneTree)</span>
00288 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00289 <span class="preprocessor"></span>
00290 
00291 
00292 BOOLEAN
<a name="l00293"></a><a class="code" href="../../d7/d9/cm_8h.html#a30">00293</a> <a class="code" href="../../d7/d9/cm_8h.html#a30">CmInitSystem1</a>(
00294     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
00295     )
00296 <span class="comment">/*++</span>
00297 <span class="comment"></span>
00298 <span class="comment">Routine Description:</span>
00299 <span class="comment"></span>
00300 <span class="comment">    This function is called as part of phase1 init, after the object</span>
00301 <span class="comment">    manager has been inited, but before IoInit.  It's purpose is to</span>
00302 <span class="comment">    set up basic registry object operations, and transform data</span>
00303 <span class="comment">    captured during boot into registry format (whether it was read</span>
00304 <span class="comment">    from the SYSTEM hive file by the osloader or computed by recognizers.)</span>
00305 <span class="comment">    After this call, Nt*Key calls work, but only part of the name</span>
00306 <span class="comment">    space is available and any changes written must be held in</span>
00307 <span class="comment">    memory.</span>
00308 <span class="comment"></span>
00309 <span class="comment">    CmpMachineHiveList entries marked CM_PHASE_1 are available</span>
00310 <span class="comment">    after return from this call, but writes must be held in memory.</span>
00311 <span class="comment"></span>
00312 <span class="comment">    This function will:</span>
00313 <span class="comment"></span>
00314 <span class="comment">        1.  Create the regisrty worker/lazy-write thread</span>
00315 <span class="comment">        2.  Create the registry key object type</span>
00316 <span class="comment">        4.  Create the master hive</span>
00317 <span class="comment">        5.  Create the \REGISTRY node</span>
00318 <span class="comment">        6.  Create a KEY object that refers to \REGISTRY</span>
00319 <span class="comment">        7.  Create \REGISTRY\MACHINE node</span>
00320 <span class="comment">        8.  Create the SYSTEM hive, fill in with data from loader</span>
00321 <span class="comment">        9.  Create the HARDWARE hive, fill in with data from loader</span>
00322 <span class="comment">       10.  Create:</span>
00323 <span class="comment">                \REGISTRY\MACHINE\SYSTEM</span>
00324 <span class="comment">                \REGISTRY\MACHINE\HARDWARE</span>
00325 <span class="comment">                Both of which will be link nodes in the master hive.</span>
00326 <span class="comment"></span>
00327 <span class="comment">    NOTE:   We do NOT free allocated pool in failure case.  This is because</span>
00328 <span class="comment">            our caller is going to bugcheck anyway, and having the memory</span>
00329 <span class="comment">            object to look at is useful.</span>
00330 <span class="comment"></span>
00331 <span class="comment">Arguments:</span>
00332 <span class="comment"></span>
00333 <span class="comment">    LoaderBlock - supplies the LoaderBlock passed in from the OSLoader.</span>
00334 <span class="comment">        By looking through the memory descriptor list we can find the</span>
00335 <span class="comment">        SYSTEM hive which the OSLoader has placed in memory for us.</span>
00336 <span class="comment"></span>
00337 <span class="comment">Return Value:</span>
00338 <span class="comment"></span>
00339 <span class="comment">    TRUE if all operations were successful, false if any failed.</span>
00340 <span class="comment"></span>
00341 <span class="comment">    Bugchecks when something went wrong (CONFIG_INITIALIZATION_FAILED,4,.....)</span>
00342 <span class="comment"></span>
00343 <span class="comment">--*/</span>
00344 {
00345     HANDLE  key1;
00346     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00347     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00348     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status2;
00349     PSECURITY_DESCRIPTOR SecurityDescriptor;
00350     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> HardwareHive;
00351     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CloneHive;
00352     UNICODE_STRING NameString;
00353 
00354     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00355     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) KdPrint((<span class="stringliteral">"CmInitSystem1\n"</span>));
00356 
00357     <span class="comment">//</span>
00358     <span class="comment">// Initialize Names of all registry paths.</span>
00359     <span class="comment">// This simply initializes unicode strings so we don't have to bother</span>
00360     <span class="comment">// with it later. This can not fail.</span>
00361     <span class="comment">//</span>
00362     <a class="code" href="../../d1/d2/cmp_8h.html#a277">CmpInitializeRegistryNames</a>();
00363 
00364     <span class="comment">//</span>
00365     <span class="comment">// Compute registry global quota</span>
00366     <span class="comment">//</span>
00367     <a class="code" href="../../d1/d2/cmp_8h.html#a246">CmpComputeGlobalQuotaAllowed</a>();
00368 
00369     <span class="comment">//</span>
00370     <span class="comment">// Initialize the hive list head</span>
00371     <span class="comment">//</span>
00372     InitializeListHead(&amp;<a class="code" href="../../d8/d9/cmapi_8c.html#a1">CmpHiveListHead</a>);
00373 
00374     <span class="comment">//</span>
00375     <span class="comment">// Initialize the global registry resource</span>
00376     <span class="comment">//</span>
00377     <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a>(&amp;<a class="code" href="../../d1/d2/cmp_8h.html#a186">CmpRegistryLock</a>);
00378 
00379     <span class="comment">//</span>
00380     <span class="comment">// Initialize the KCB tree mutex</span>
00381     <span class="comment">//</span>
00382     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(&amp;<a class="code" href="../../d1/d2/cmp_8h.html#a155">CmpKcbLock</a>);
00383 
00384     <span class="comment">//</span>
00385     <span class="comment">// Initialize the PostList mutex</span>
00386     <span class="comment">//</span>
00387     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(&amp;<a class="code" href="../../d1/d2/cmp_8h.html#a177">CmpPostLock</a>);
00388 
00389     <span class="comment">//</span>
00390     <span class="comment">// Initialize the cache</span>
00391     <span class="comment">//</span>
00392     <a class="code" href="../../d8/d2/cmsubs_8c.html#a26">CmpInitializeCache</a> ();
00393 
00394     <span class="comment">//</span>
00395     <span class="comment">// Save the current process to allow us to attach to it later.</span>
00396     <span class="comment">//</span>
00397     <a class="code" href="../../d1/d3/cmsysini_8c.html#a9">CmpSystemProcess</a> = &amp;<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Pcb;
00398 
00399     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
00400 
00401     <span class="comment">//</span>
00402     <span class="comment">// Create the Key object type.</span>
00403     <span class="comment">//</span>
00404     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d3/cmsysini_8c.html#a36">CmpCreateObjectTypes</a>()) {
00405         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a42">CMS_INIT_ERROR</a>) {
00406             KdPrint((<span class="stringliteral">"CmInitSystem1: CmpCreateObjectTypes failed\n"</span>));
00407         }
00408         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,4,1,0,0); <span class="comment">// could not registrate with object manager</span>
00409         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00410     }
00411 
00412 
00413     <span class="comment">//</span>
00414     <span class="comment">// Create the master hive and initialize it.</span>
00415     <span class="comment">//</span>
00416     status = <a class="code" href="../../d1/d2/cmp_8h.html#a275">CmpInitializeHive</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>,
00417                 <a class="code" href="../../d6/d0/hive_8h.html#a4">HINIT_CREATE</a>,
00418                 <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a>,
00419                 <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>,     <span class="comment">// i.e. no logging, no alterate</span>
00420                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00421                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00422                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00423                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00424                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00425                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00426     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00427         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a42">CMS_INIT_ERROR</a>) {
00428             KdPrint((<span class="stringliteral">"CmInitSystem1: CmpInitializeHive(master) failed\n"</span>));
00429         }
00430         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,4,2,0,0); <span class="comment">// could not initialize master hive</span>
00431         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00432     }
00433 
00434     <span class="comment">//</span>
00435     <span class="comment">// try to allocate a stash buffer.  if we can't get 1 page this</span>
00436     <span class="comment">// early on, we're in deep trouble, so punt.</span>
00437     <span class="comment">//</span>
00438     <a class="code" href="../../d8/d9/cmapi_8c.html#a4">CmpStashBuffer</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>,'bSmC');
00439     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/cmapi_8c.html#a4">CmpStashBuffer</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00440         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,4,3,0,0); <span class="comment">// odds against this are huge</span>
00441         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00442     }
00443     <a class="code" href="../../d8/d9/cmapi_8c.html#a5">CmpStashBufferSize</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00444 
00445     <span class="comment">//</span>
00446     <span class="comment">// Create the \REGISTRY node</span>
00447     <span class="comment">//</span>
00448     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d3/cmsysini_8c.html#a37">CmpCreateRegistryRoot</a>()) {
00449         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a42">CMS_INIT_ERROR</a>) {
00450             KdPrint((<span class="stringliteral">"CmInitSystem1: CmpCreateRegistryRoot failed\n"</span>));
00451         }
00452         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,4,4,0,0); <span class="comment">// could not create root of the registry</span>
00453         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00454     }
00455 
00456     <span class="comment">//</span>
00457     <span class="comment">// --- 6. Create \REGISTRY\MACHINE and \REGISTRY\USER nodes ---</span>
00458     <span class="comment">//</span>
00459 
00460     <span class="comment">//</span>
00461     <span class="comment">// Get default security descriptor for the nodes we will create.</span>
00462     <span class="comment">//</span>
00463     SecurityDescriptor = <a class="code" href="../../d7/d2/cmse_8c.html#a13">CmpHiveRootSecurityDescriptor</a>();
00464 
00465     InitializeObjectAttributes(
00466         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00467         &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a14">CmRegistryMachineName</a>,
00468         OBJ_CASE_INSENSITIVE,
00469         (HANDLE)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00470         SecurityDescriptor
00471         );
00472 
00473     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(
00474                         &amp;key1,
00475                         KEY_READ | KEY_WRITE,
00476                         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00477                         0,
00478                         &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a12">nullclass</a>,
00479                         0,
00480                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00481         )))
00482     {
00483         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SecurityDescriptor);
00484         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a42">CMS_INIT_ERROR</a>) {
00485             KdPrint((<span class="stringliteral">"CmInitSystem1: NtCreateKey(MACHINE) failed\n"</span>));
00486         }
00487         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,4,5,0,0); <span class="comment">// could not create HKLM</span>
00488         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00489     }
00490 
00491     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(key1);
00492 
00493     InitializeObjectAttributes(
00494         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00495         &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a32">CmRegistryUserName</a>,
00496         OBJ_CASE_INSENSITIVE,
00497         (HANDLE)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00498         SecurityDescriptor
00499         );
00500 
00501     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(
00502                         &amp;key1,
00503                         KEY_READ | KEY_WRITE,
00504                         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00505                         0,
00506                         &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a12">nullclass</a>,
00507                         0,
00508                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00509         )))
00510     {
00511         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SecurityDescriptor);
00512         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a42">CMS_INIT_ERROR</a>) {
00513             KdPrint((<span class="stringliteral">"CmInitSystem1: NtCreateKey(USER) failed\n"</span>));
00514         }
00515         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,4,6,0,0); <span class="comment">// could not create HKUSER</span>
00516         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00517     }
00518 
00519     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(key1);
00520 
00521 
00522     <span class="comment">//</span>
00523     <span class="comment">// --- 7. Create the SYSTEM hive, fill in with data from loader ---</span>
00524     <span class="comment">//</span>
00525     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d3/cmsysini_8c.html#a41">CmpInitializeSystemHive</a>(LoaderBlock)) {
00526         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SecurityDescriptor);
00527         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a42">CMS_INIT_ERROR</a>) {
00528             KdPrint((<span class="stringliteral">"CmpInitSystem1: "</span>));
00529             KdPrint((<span class="stringliteral">"Hive allocation failure for SYSTEM\n"</span>));
00530         }
00531         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,4,7,0,0); <span class="comment">// could not create SystemHive</span>
00532         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00533     }
00534 
00535     <span class="comment">//</span>
00536     <span class="comment">// Create the symbolic link \Registry\Machine\System\CurrentControlSet</span>
00537     <span class="comment">//</span>
00538     status = <a class="code" href="../../d1/d3/cmsysini_8c.html#a34">CmpCreateControlSet</a>(LoaderBlock);
00539     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00540         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,4,8,0,0); <span class="comment">// could not create CurrentControlSet</span>
00541         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00542     }
00543 
00544     <span class="comment">//</span>
00545     <span class="comment">// Handle the copying of the CurrentControlSet to a Clone volatile</span>
00546     <span class="comment">// hive (but only if we really want to have a clone)</span>
00547     <span class="comment">//</span>
00548 
00549 <span class="preprocessor">#if CLONE_CONTROL_SET</span>
00550 <span class="preprocessor"></span>
00551     <span class="comment">//</span>
00552     <span class="comment">// Create the Clone temporary hive, link it into the master hive,</span>
00553     <span class="comment">// and make a symbolic link to it.</span>
00554     <span class="comment">//</span>
00555     status = <a class="code" href="../../d1/d2/cmp_8h.html#a275">CmpInitializeHive</a>(&amp;CloneHive,
00556                 <a class="code" href="../../d6/d0/hive_8h.html#a4">HINIT_CREATE</a>,
00557                 <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a>,
00558                 <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>,
00559                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00560                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00561                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00562                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00563                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00564                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00565     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00566         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a42">CMS_INIT_ERROR</a>) {
00567             KdPrint((<span class="stringliteral">"CmpInitSystem1: "</span>));
00568             KdPrint((<span class="stringliteral">"Could not initialize CLONE hive\n"</span>));
00569         }
00570         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,4,9,0,0); <span class="comment">// could not initialize clone hive</span>
00571         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00572     }
00573 
00574     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/cmwraper_8c.html#a28">CmpLinkHiveToMaster</a>(
00575             &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a33">CmRegistrySystemCloneName</a>,
00576             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00577             CloneHive,
00578             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00579             SecurityDescriptor
00580             ) != STATUS_SUCCESS)
00581     {
00582         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a42">CMS_INIT_ERROR</a>) {
00583             KdPrint((<span class="stringliteral">"CmInitSystem1: CmpLinkHiveToMaster(Clone) failed\n"</span>));
00584         }
00585         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,4,10,0,0); <span class="comment">// could not link clone hive to master hive</span>
00586         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00587     }
00588     <a class="code" href="../../d1/d2/cmp_8h.html#a309">CmpAddToHiveFileList</a>(CloneHive);
00589     <a class="code" href="../../d6/d0/cmdat_8c.html#a62">CmpMachineHiveList</a>[<a class="code" href="../../d1/d3/cmsysini_8c.html#a3">CLONE_HIVE_INDEX</a>].<a class="code" href="../../d9/d7/struct__HIVE__LIST__ENTRY.html#o2">CmHive</a> = CloneHive;
00590 
00591     <a class="code" href="../../d1/d3/cmsysini_8c.html#a32">CmpLinkKeyToHive</a>(
00592         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\Clone"</span>,
00593         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\CLONE\\CLONE"</span>
00594         );
00595 
00596 
00597     <span class="comment">//</span>
00598     <span class="comment">// Clone the current control set for the service controller</span>
00599     <span class="comment">//</span>
00600     status = <a class="code" href="../../d1/d3/cmsysini_8c.html#a35">CmpCloneControlSet</a>();
00601 
00602     <span class="comment">//</span>
00603     <span class="comment">// If this didn't work, it's bad, but not bad enough to fail the boot</span>
00604     <span class="comment">//</span>
00605     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
00606 
00607 <span class="preprocessor">#endif</span>
00608 <span class="preprocessor"></span>
00609     <span class="comment">//</span>
00610     <span class="comment">// --- 8. Create the HARDWARE hive, fill in with data from loader ---</span>
00611     <span class="comment">//</span>
00612     status = <a class="code" href="../../d1/d2/cmp_8h.html#a275">CmpInitializeHive</a>(&amp;HardwareHive,
00613                 <a class="code" href="../../d6/d0/hive_8h.html#a4">HINIT_CREATE</a>,
00614                 <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a>,
00615                 <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>,     <span class="comment">// i.e. no log, no alternate</span>
00616                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00617                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00618                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00619                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00620                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00621                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00622     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00623         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SecurityDescriptor);
00624         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a42">CMS_INIT_ERROR</a>) {
00625             KdPrint((<span class="stringliteral">"CmpInitSystem1: "</span>));
00626             KdPrint((<span class="stringliteral">"Could not initialize HARDWARE hive\n"</span>));
00627         }
00628         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,4,11,0,0); <span class="comment">// could not initialize hardware hive</span>
00629         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00630     }
00631 
00632     <span class="comment">//</span>
00633     <span class="comment">// Allocate the root node</span>
00634     <span class="comment">//</span>
00635     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/cmwraper_8c.html#a28">CmpLinkHiveToMaster</a>(
00636             &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a15">CmRegistryMachineHardwareName</a>,
00637             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00638             HardwareHive,
00639             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00640             SecurityDescriptor
00641             ) != STATUS_SUCCESS)
00642     {
00643         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a42">CMS_INIT_ERROR</a>) {
00644             KdPrint((<span class="stringliteral">"CmInitSystem1: CmpLinkHiveToMaster(Hardware) failed\n"</span>));
00645         }
00646         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,4,12,0,0); <span class="comment">// could not link hardware hive to master hive</span>
00647         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00648     }
00649     <a class="code" href="../../d1/d2/cmp_8h.html#a309">CmpAddToHiveFileList</a>(HardwareHive);
00650 
00651     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SecurityDescriptor);
00652 
00653     <a class="code" href="../../d6/d0/cmdat_8c.html#a62">CmpMachineHiveList</a>[0].<a class="code" href="../../d9/d7/struct__HIVE__LIST__ENTRY.html#o2">CmHive</a> = HardwareHive;
00654 
00655     <span class="comment">//</span>
00656     <span class="comment">// put loader configuration tree data to our hardware registry.</span>
00657     <span class="comment">//</span>
00658     status = <a class="code" href="../../d1/d2/cmp_8h.html#a272">CmpInitializeHardwareConfiguration</a>(LoaderBlock);
00659 
00660     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00661         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,4,13,0,0); <span class="comment">// could not initialize hardware configuration</span>
00662         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00663     }
00664 
00665     <a class="code" href="../../d6/d0/cmdat_8c.html#a64">CmpNoMasterCreates</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00666     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00667 
00668     <span class="comment">//</span>
00669     <span class="comment">// put machine dependant configuration data to our hardware registry.</span>
00670     <span class="comment">//</span>
00671     status = <a class="code" href="../../d6/d1/config_2ppc_2init_8c.html#a0">CmpInitializeMachineDependentConfiguration</a>(LoaderBlock);
00672 
00673 
00674     <span class="comment">//</span>
00675     <span class="comment">// store boot loader command tail in registry</span>
00676     <span class="comment">//</span>
00677     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00678         &amp;NameString,
00679         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\REGISTRY\\MACHINE\\SYSTEM\\CurrentControlSet\\Control"</span>
00680         );
00681 
00682     InitializeObjectAttributes(
00683         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00684         &amp;NameString,
00685         OBJ_CASE_INSENSITIVE,
00686         (HANDLE)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00687         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00688         );
00689 
00690     status2 = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(
00691                 &amp;key1,
00692                 KEY_WRITE,
00693                 &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>
00694                 );
00695 
00696     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status2)) {
00697         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00698             &amp;NameString,
00699             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SystemStartOptions"</span>
00700             );
00701 
00702         <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00703             key1,
00704             &amp;NameString,
00705             0,              <span class="comment">// TitleIndex</span>
00706             REG_SZ,
00707             <a class="code" href="../../d6/d0/cmdat_8c.html#a0">CmpLoadOptions</a>.Buffer,
00708             <a class="code" href="../../d6/d0/cmdat_8c.html#a0">CmpLoadOptions</a>.Length
00709             );
00710 
00711         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(key1);
00712     }
00713     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d6/d0/cmdat_8c.html#a0">CmpLoadOptions</a>.Buffer);
00714 
00715 
00716     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00717         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,4,14,0,0); <span class="comment">// could not open CurrentControlSet\\Control</span>
00718         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00719     }
00720 
00721     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00722 }
00723 
00724 
00725 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00726"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a40">00726</a> <a class="code" href="../../d5/d3/cmworker_8c.html#a15">CmpInitializeHiveList</a>(
00727     VOID
00728     )
00729 <span class="comment">/*++</span>
00730 <span class="comment"></span>
00731 <span class="comment">Routine Description:</span>
00732 <span class="comment"></span>
00733 <span class="comment">    This function is called to map hive files to hives.  It both</span>
00734 <span class="comment">    maps existing hives to files, and creates new hives from files.</span>
00735 <span class="comment"></span>
00736 <span class="comment">    It operates on files in "\SYSTEMROOT\CONFIG".</span>
00737 <span class="comment"></span>
00738 <span class="comment">    NOTE:   MUST run in the context of the process that the CmpWorker</span>
00739 <span class="comment">            thread runs in.  Caller is expected to arrange this.</span>
00740 <span class="comment"></span>
00741 <span class="comment">    NOTE:   Will bugcheck on failure.</span>
00742 <span class="comment"></span>
00743 <span class="comment">Arguments:</span>
00744 <span class="comment"></span>
00745 <span class="comment">Return Value:</span>
00746 <span class="comment"></span>
00747 <span class="comment">    NONE.</span>
00748 <span class="comment"></span>
00749 <span class="comment">--*/</span>
00750 {
00751 <span class="preprocessor">    #define MAX_NAME    128</span>
00752 <span class="preprocessor"></span>    UCHAR   FileBuffer[<a class="code" href="../../d1/d3/cmsysini_8c.html#a8">MAX_NAME</a>];
00753     UCHAR   RegBuffer[<a class="code" href="../../d1/d3/cmsysini_8c.html#a8">MAX_NAME</a>];
00754 
00755     UNICODE_STRING TempName;
00756     UNICODE_STRING <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>;
00757     UNICODE_STRING RegName;
00758 
00759     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>  FileStart;
00760     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>  RegStart;
00761     ULONG   i;
00762     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CmHive;
00763     BOOLEAN Allocate;
00764     HANDLE  PrimaryHandle;
00765     HANDLE  LogHandle;
00766     ULONG   PrimaryDisposition;
00767     ULONG   SecondaryDisposition;
00768     ULONG   Length;
00769     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00770     PSECURITY_DESCRIPTOR SecurityDescriptor;
00771     BOOLEAN RegistryLocked = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00772 
00773     PVOID   ErrorParameters;
00774     ULONG   ErrorResponse;
00775     ULONG   ClusterSize;
00776 
00777     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00778     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) KdPrint((<span class="stringliteral">"CmpInitializeHiveList\n"</span>));
00779 
00780     <a class="code" href="../../d8/d9/cmapi_8c.html#a0">CmpNoWrite</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00781 
00782     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.MaximumLength = <a class="code" href="../../d1/d3/cmsysini_8c.html#a8">MAX_NAME</a>;
00783     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Length = 0;
00784     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Buffer = (PWSTR)&amp;(FileBuffer[0]);
00785 
00786     RegName.MaximumLength = <a class="code" href="../../d1/d3/cmsysini_8c.html#a8">MAX_NAME</a>;
00787     RegName.Length = 0;
00788     RegName.Buffer = (PWSTR)&amp;(RegBuffer[0]);
00789 
00790     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00791         &amp;TempName,
00792         <a class="code" href="../../d1/d3/cmsysini_8c.html#a0">INIT_SYSTEMROOT_HIVEPATH</a>
00793         );
00794     <a class="code" href="../../d2/d7/string_8c.html#a16">RtlAppendStringToString</a>((PSTRING)&amp;<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>, (PSTRING)&amp;TempName);
00795     FileStart = <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Length;
00796 
00797     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00798         &amp;TempName,
00799         <a class="code" href="../../d1/d3/cmsysini_8c.html#a1">INIT_REGISTRY_MASTERPATH</a>
00800         );
00801     <a class="code" href="../../d2/d7/string_8c.html#a16">RtlAppendStringToString</a>((PSTRING)&amp;RegName, (PSTRING)&amp;TempName);
00802     RegStart = RegName.Length;
00803 
00804     SecurityDescriptor = <a class="code" href="../../d7/d2/cmse_8c.html#a13">CmpHiveRootSecurityDescriptor</a>();
00805 
00806 
00807     <span class="keywordflow">for</span> (i = 0; <a class="code" href="../../d6/d0/cmdat_8c.html#a62">CmpMachineHiveList</a>[i].<a class="code" href="../../d9/d7/struct__HIVE__LIST__ENTRY.html#o0">Name</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; i++) {
00808 
00809         <span class="comment">//</span>
00810         <span class="comment">// Compute the name of the file, and the name to link to in</span>
00811         <span class="comment">// the registry.</span>
00812         <span class="comment">//</span>
00813 
00814         <span class="comment">// REGISTRY</span>
00815 
00816         RegName.Length = RegStart;
00817         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00818             &amp;TempName,
00819             <a class="code" href="../../d6/d0/cmdat_8c.html#a62">CmpMachineHiveList</a>[i].<a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>
00820             );
00821         <a class="code" href="../../d2/d7/string_8c.html#a16">RtlAppendStringToString</a>((PSTRING)&amp;RegName, (PSTRING)&amp;TempName);
00822 
00823         <span class="comment">// REGISTRY\MACHINE or REGISTRY\USER</span>
00824 
00825         <span class="keywordflow">if</span> (RegName.Buffer[ (RegName.Length / <span class="keyword">sizeof</span>( WCHAR )) - 1 ] == <span class="charliteral">'\\'</span>) {
00826             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00827                 &amp;TempName,
00828                 <a class="code" href="../../d6/d0/cmdat_8c.html#a62">CmpMachineHiveList</a>[i].<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>
00829                 );
00830             <a class="code" href="../../d2/d7/string_8c.html#a16">RtlAppendStringToString</a>((PSTRING)&amp;RegName, (PSTRING)&amp;TempName);
00831         }
00832 
00833         <span class="comment">// REGISTRY\[MACHINE|USER]\HIVE</span>
00834 
00835         <span class="comment">// &lt;sysroot&gt;\config</span>
00836 
00837         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00838             &amp;TempName,
00839             <a class="code" href="../../d6/d0/cmdat_8c.html#a62">CmpMachineHiveList</a>[i].<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>
00840             );
00841         <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Length = FileStart;
00842         <a class="code" href="../../d2/d7/string_8c.html#a16">RtlAppendStringToString</a>((PSTRING)&amp;<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>, (PSTRING)&amp;TempName);
00843 
00844         <span class="comment">// &lt;sysroot&gt;\config\hive</span>
00845 
00846 
00847         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/cmdat_8c.html#a62">CmpMachineHiveList</a>[i].<a class="code" href="../../d9/d7/struct__HIVE__LIST__ENTRY.html#o2">CmHive</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00848 
00849             <span class="comment">//</span>
00850             <span class="comment">// Hive has not been inited in any way.</span>
00851             <span class="comment">//</span>
00852 
00853             Allocate = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00854             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d3/cmsysini_8c.html#a52">CmpInitHiveFromFile</a>(&amp;<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>,
00855                                          <a class="code" href="../../d6/d0/cmdat_8c.html#a62">CmpMachineHiveList</a>[i].Flags,
00856                                          &amp;CmHive,
00857                                          &amp;Allocate,
00858                                          &amp;RegistryLocked
00859                                          );
00860 
00861             <span class="keywordflow">if</span> ( (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) ||
00862                  (CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) )
00863             {
00864                 ErrorParameters = &amp;<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>;
00865                 <a class="code" href="../../d5/d8/ex_8h.html#a306">ExRaiseHardError</a>(
00866                     STATUS_CANNOT_LOAD_REGISTRY_FILE,
00867                     1,
00868                     1,
00869                     (PULONG_PTR)&amp;ErrorParameters,
00870                     OptionOk,
00871                     &amp;ErrorResponse
00872                     );
00873 
00874                 <span class="keywordflow">continue</span>;           <span class="comment">// If we are here it isn't SYSTEM,</span>
00875                                     <span class="comment">// so punt and go on.</span>
00876             }
00877 
00878             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a23">CML_MINOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
00879                 KdPrint((<span class="stringliteral">"CmpInitializeHiveList:\n"</span>));
00880                 KdPrint((<span class="stringliteral">"\tCmHive for '%ws' @"</span>, <a class="code" href="../../d6/d0/cmdat_8c.html#a62">CmpMachineHiveList</a>[i]));
00881                 KdPrint((<span class="stringliteral">"%08lx"</span>, CmHive));
00882             }
00883 
00884             <span class="comment">//</span>
00885             <span class="comment">// Link hive into master hive</span>
00886             <span class="comment">//</span>
00887             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/cmwraper_8c.html#a28">CmpLinkHiveToMaster</a>(
00888                     &amp;RegName,
00889                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00890                     CmHive,
00891                     Allocate,
00892                     SecurityDescriptor
00893                     ) != STATUS_SUCCESS)
00894             {
00895                 <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a42">CMS_INIT_ERROR</a>) {
00896                     KdPrint((<span class="stringliteral">"CmpInitializeHiveList: "</span>));
00897                     KdPrint((<span class="stringliteral">"CmpLinkHiveToMaster failed\n"</span>));
00898                     KdPrint((<span class="stringliteral">"\ti=%d s='%ws'\n"</span>, i, <a class="code" href="../../d6/d0/cmdat_8c.html#a62">CmpMachineHiveList</a>[i]));
00899                 }
00900                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_LIST_FAILED,5,2,i,(ULONG_PTR)&amp;RegName);
00901             }
00902             <a class="code" href="../../d1/d2/cmp_8h.html#a309">CmpAddToHiveFileList</a>(CmHive);
00903 
00904             <span class="keywordflow">if</span> (Allocate) {
00905                 <a class="code" href="../../d0/d2/hivesync_8c.html#a13">HvSyncHive</a>((<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)CmHive);
00906             }
00907 
00908         } <span class="keywordflow">else</span> {
00909 
00910             CmHive = <a class="code" href="../../d6/d0/cmdat_8c.html#a62">CmpMachineHiveList</a>[i].<a class="code" href="../../d9/d7/struct__HIVE__LIST__ENTRY.html#o2">CmHive</a>;
00911 
00912             <span class="keywordflow">if</span> (!(CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a>)) {
00913 
00914                 <span class="comment">//</span>
00915                 <span class="comment">// CmHive already exists.  It is not an entirely volatile</span>
00916                 <span class="comment">// hive (we do nothing for those.)</span>
00917                 <span class="comment">//</span>
00918                 <span class="comment">// First, open the files (Primary and Alternate) that</span>
00919                 <span class="comment">// back the hive.  Stuff their handles into the CmHive</span>
00920                 <span class="comment">// object.  Force the size of the files to match the</span>
00921                 <span class="comment">// in memory images.  Call HvSyncHive to write changes</span>
00922                 <span class="comment">// out to disk.</span>
00923                 <span class="comment">//</span>
00924                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a290">CmpOpenHiveFiles</a>(&amp;<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>,
00925                                           <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">".ALT"</span>,
00926                                           &amp;PrimaryHandle,
00927                                           &amp;LogHandle,
00928                                           &amp;PrimaryDisposition,
00929                                           &amp;SecondaryDisposition,
00930                                           <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00931                                           <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00932                                           &amp;ClusterSize);
00933 
00934                 <span class="keywordflow">if</span> ( ( ! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) ||
00935                      (LogHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) )
00936                 {
00937                     ErrorParameters = &amp;<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>;
00938                     <a class="code" href="../../d5/d8/ex_8h.html#a306">ExRaiseHardError</a>(
00939                         STATUS_CANNOT_LOAD_REGISTRY_FILE,
00940                         1,
00941                         1,
00942                         (PULONG_PTR)&amp;ErrorParameters,
00943                         OptionOk,
00944                         &amp;ErrorResponse
00945                         );
00946 
00947                     <span class="comment">//</span>
00948                     <span class="comment">// WARNNOTE</span>
00949                     <span class="comment">// We've just told the user that something essential,</span>
00950                     <span class="comment">// like the SYSTEM hive, is hosed.  Don't try to run,</span>
00951                     <span class="comment">// we just risk destroying user data.  Punt.</span>
00952                     <span class="comment">//</span>
00953                     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(BAD_SYSTEM_CONFIG_INFO,5,3,i,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00954                 }
00955 
00956                 CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a>] = LogHandle;
00957                 CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>] = PrimaryHandle;
00958 
00959                 Length = CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length + <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00960 
00961                 <span class="comment">//</span>
00962                 <span class="comment">// When an in-memory hive is opened with no backing</span>
00963                 <span class="comment">// file, ClusterSize is assumed to be 1.  When the file</span>
00964                 <span class="comment">// is opened later (for the SYSTEM hive) we need</span>
00965                 <span class="comment">// to update this field in the hive if we are</span>
00966                 <span class="comment">// booting from media where the cluster size &gt; 1</span>
00967                 <span class="comment">//</span>
00968                 <span class="keywordflow">if</span> (CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a> != ClusterSize) {
00969                     <span class="comment">//</span>
00970                     <span class="comment">// The cluster size is different than previous assumed.</span>
00971                     <span class="comment">// Since a cluster in the dirty vector must be either</span>
00972                     <span class="comment">// completely dirty or completely clean, go through the</span>
00973                     <span class="comment">// dirty vector and mark all clusters that contain a dirty</span>
00974                     <span class="comment">// logical sector as completely dirty.</span>
00975                     <span class="comment">//</span>
00976                     PRTL_BITMAP  <a class="code" href="../../d2/d1/structBitMap.html">BitMap</a>;
00977                     ULONG        <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00978 
00979                     <a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a> = &amp;(CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>);
00980                     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
00981                          <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.SizeOfBitMap;
00982                          <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += ClusterSize)
00983                     {
00984                         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a40">RtlAreBitsClear</a> (<a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>, ClusterSize)) {
00985                             <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a34">RtlSetBits</a> (<a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>, ClusterSize);
00986                         }
00987                     }
00988                     <span class="comment">//</span>
00989                     <span class="comment">// Update DirtyCount and Cluster</span>
00990                     <span class="comment">//</span>
00991                     CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> = <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>);
00992                     CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a> = ClusterSize;
00993                 }
00994 
00995                 <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d3/cmwraper_8c.html#a29">CmpFileSetSize</a>(
00996                         (<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)CmHive, <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>, Length) ||
00997                     !<a class="code" href="../../d6/d3/cmwraper_8c.html#a29">CmpFileSetSize</a>(
00998                         (<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)CmHive, <a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a>, Length)
00999                    )
01000                 {
01001                     <span class="comment">//</span>
01002                     <span class="comment">// WARNNOTE</span>
01003                     <span class="comment">// Data written into the system hive since boot</span>
01004                     <span class="comment">// cannot be written out, punt.</span>
01005                     <span class="comment">//</span>
01006                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a8">CmpCannotWriteConfiguration</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01007 
01008                     <span class="comment">//KeBugCheckEx(CANNOT_WRITE_CONFIGURATION,5,4,i,0);</span>
01009                 }
01010 
01011                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FIELD_OFFSET(<a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>) == 0);
01012 
01013                 <span class="keywordflow">if</span> ( (PrimaryDisposition == FILE_CREATED) ||
01014                      (SecondaryDisposition == FILE_CREATED) ||
01015                      (!<a class="code" href="../../d1/d3/cmsysini_8c.html#a33">CmpValidateAlternate</a>(LogHandle,CmHive)))
01016                 {
01017                     <span class="comment">//</span>
01018                     <span class="comment">// Force all data to be written to the secondary (.alt)</span>
01019                     <span class="comment">//</span>
01020                     CmHive-&gt;FileHandles[<a class="code" href="../../d0/d1/hivedata_8h.html#a41">HFILE_TYPE_EXTERNAL</a>] =
01021                         CmHive-&gt;FileHandles[<a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a>];
01022                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/hivesync_8c.html#a15">HvWriteHive</a>((<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)CmHive);
01023                     CmHive-&gt;FileHandles[<a class="code" href="../../d0/d1/hivedata_8h.html#a41">HFILE_TYPE_EXTERNAL</a>] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01024 
01025                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01026                         <span class="comment">//</span>
01027                         <span class="comment">// WARNNOTE</span>
01028                         <span class="comment">//  If we keep running here, we risk REALLY</span>
01029                         <span class="comment">//  screwing the user over (eating all their</span>
01030                         <span class="comment">//  data), while if we fail, we'll at least</span>
01031                         <span class="comment">//  fail clean.</span>
01032                         <span class="comment">//</span>
01033                         <a class="code" href="../../d7/d0/cmdat2_8c.html#a8">CmpCannotWriteConfiguration</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01034 
01035                         <span class="comment">//KeBugCheckEx(CANNOT_WRITE_CONFIGURATION,5,5,0,0);</span>
01036                     }
01037                 }
01038                 <a class="code" href="../../d1/d2/cmp_8h.html#a309">CmpAddToHiveFileList</a>(<a class="code" href="../../d6/d0/cmdat_8c.html#a62">CmpMachineHiveList</a>[i].CmHive);
01039 
01040                 <a class="code" href="../../d0/d2/hivesync_8c.html#a13">HvSyncHive</a>((<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)CmHive);
01041 
01042                 <span class="keywordflow">if</span>( <a class="code" href="../../d7/d0/cmdat2_8c.html#a8">CmpCannotWriteConfiguration</a> ) {
01043                     <span class="comment">//</span>
01044                     <span class="comment">// The system disk is full; Give user a chance to log-on and make room</span>
01045                     <span class="comment">//</span>
01046                     <a class="code" href="../../d5/d3/cmworker_8c.html#a19">CmpDiskFullWarning</a>();
01047                     <a class="code" href="../../d6/d3/cmwraper_8c.html#a11">CmpLazyFlush</a>();
01048                 }
01049             }
01050         }
01051     }   <span class="comment">// for</span>
01052 
01053     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SecurityDescriptor);
01054 
01055     <span class="comment">//</span>
01056     <span class="comment">// Create symbolic link from SECURITY hive into SAM hive.</span>
01057     <span class="comment">//</span>
01058     <a class="code" href="../../d1/d3/cmsysini_8c.html#a32">CmpLinkKeyToHive</a>(
01059         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\Security\\SAM"</span>,
01060         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\SAM\\SAM"</span>
01061         );
01062 
01063     <span class="comment">//</span>
01064     <span class="comment">// Create predefined handles.</span>
01065     <span class="comment">//</span>
01066     <a class="code" href="../../d1/d3/cmsysini_8c.html#a31">CmpCreatePerfKeys</a>();
01067 
01068     <span class="keywordflow">return</span>;
01069 }
01070 
01071 
01072 
01073 BOOLEAN
<a name="l01074"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a36">01074</a> <a class="code" href="../../d1/d3/cmsysini_8c.html#a36">CmpCreateObjectTypes</a>(
01075     VOID
01076     )
01077 <span class="comment">/*++</span>
01078 <span class="comment"></span>
01079 <span class="comment">Routine Description:</span>
01080 <span class="comment"></span>
01081 <span class="comment">    Create the Key object type</span>
01082 <span class="comment"></span>
01083 <span class="comment">Arguments:</span>
01084 <span class="comment"></span>
01085 <span class="comment">    NONE.</span>
01086 <span class="comment"></span>
01087 <span class="comment">Return Value:</span>
01088 <span class="comment"></span>
01089 <span class="comment">    TRUE == success,  FALSE == failure.</span>
01090 <span class="comment"></span>
01091 <span class="comment">--*/</span>
01092 {
01093    <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01094    <a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html">OBJECT_TYPE_INITIALIZER</a> ObjectTypeInitializer;
01095    UNICODE_STRING TypeName;
01096 
01097    <span class="comment">//</span>
01098    <span class="comment">// Structure that describes the mapping of generic access rights to object</span>
01099    <span class="comment">// specific access rights for registry key objects.</span>
01100    <span class="comment">//</span>
01101 
01102    GENERIC_MAPPING <a class="code" href="../../d6/d3/cmwraper_8c.html#a3">CmpKeyMapping</a> = {
01103       KEY_READ,
01104       KEY_WRITE,
01105       KEY_EXECUTE,
01106       KEY_ALL_ACCESS
01107    };
01108 
01109     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01110     <span class="comment">//</span>
01111     <span class="comment">// --- Create the registry key object type ---</span>
01112     <span class="comment">//</span>
01113 
01114     <span class="comment">//</span>
01115     <span class="comment">// Initialize string descriptor.</span>
01116     <span class="comment">//</span>
01117 
01118     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;TypeName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Key"</span>);
01119 
01120     <span class="comment">//</span>
01121     <span class="comment">// Create key object type descriptor.</span>
01122     <span class="comment">//</span>
01123 
01124     RtlZeroMemory(&amp;ObjectTypeInitializer, <span class="keyword">sizeof</span>(ObjectTypeInitializer));
01125     ObjectTypeInitializer.Length = <span class="keyword">sizeof</span>(ObjectTypeInitializer);
01126     ObjectTypeInitializer.InvalidAttributes = <a class="code" href="../../d1/d3/cmsysini_8c.html#a7">CMP_KEY_INVALID_ATTRIBUTES</a>;
01127     ObjectTypeInitializer.GenericMapping = <a class="code" href="../../d6/d3/cmwraper_8c.html#a3">CmpKeyMapping</a>;
01128     ObjectTypeInitializer.ValidAccessMask = KEY_ALL_ACCESS;
01129     ObjectTypeInitializer.DefaultPagedPoolCharge = <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">CM_KEY_BODY</a>);
01130     ObjectTypeInitializer.SecurityRequired = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01131     ObjectTypeInitializer.PoolType = <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>;
01132     ObjectTypeInitializer.MaintainHandleCount = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01133     ObjectTypeInitializer.UseDefaultObject = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01134 
01135     ObjectTypeInitializer.DumpProcedure = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01136     ObjectTypeInitializer.OpenProcedure = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01137     ObjectTypeInitializer.CloseProcedure = <a class="code" href="../../d3/d0/cmclose_8c.html#a0">CmpCloseKeyObject</a>;
01138     ObjectTypeInitializer.DeleteProcedure = <a class="code" href="../../d1/d1/cmdelete_8c.html#a0">CmpDeleteKeyObject</a>;
01139     ObjectTypeInitializer.ParseProcedure = <a class="code" href="../../d1/d2/cmp_8h.html#a208">CmpParseKey</a>;
01140     ObjectTypeInitializer.SecurityProcedure = <a class="code" href="../../d1/d2/cmp_8h.html#a214">CmpSecurityMethod</a>;
01141     ObjectTypeInitializer.QueryNameProcedure = <a class="code" href="../../d1/d2/cmp_8h.html#a211">CmpQueryKeyName</a>;
01142 
01143     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>(
01144                 &amp;TypeName,
01145                 &amp;ObjectTypeInitializer,
01146                 (PSECURITY_DESCRIPTOR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01147                 &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>
01148                 );
01149 
01150 
01151     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01152         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a42">CMS_INIT_ERROR</a>) {
01153             KdPrint((<span class="stringliteral">"CmpCreateObjectTypes: "</span>));
01154             KdPrint((<span class="stringliteral">"ObCreateObjectType(Key) failed %08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01155         }
01156         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01157     }
01158 
01159     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01160 }
01161 
01162 
01163 
01164 BOOLEAN
<a name="l01165"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a37">01165</a> <a class="code" href="../../d1/d3/cmsysini_8c.html#a37">CmpCreateRegistryRoot</a>(
01166     VOID
01167     )
01168 <span class="comment">/*++</span>
01169 <span class="comment"></span>
01170 <span class="comment">Routine Description:</span>
01171 <span class="comment"></span>
01172 <span class="comment">    Manually create \REGISTRY in the master hive, create a key</span>
01173 <span class="comment">    object to refer to it, and insert the key object into</span>
01174 <span class="comment">    the root (\) of the object space.</span>
01175 <span class="comment"></span>
01176 <span class="comment">Arguments:</span>
01177 <span class="comment"></span>
01178 <span class="comment">    None</span>
01179 <span class="comment"></span>
01180 <span class="comment">Return Value:</span>
01181 <span class="comment"></span>
01182 <span class="comment">    TRUE == success, FALSE == failure</span>
01183 <span class="comment"></span>
01184 <span class="comment">--*/</span>
01185 {
01186     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01187     UNICODE_STRING NullString = { 0, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> };
01188     HANDLE  ObjHandle;
01189     PVOID   ObjectPointer;
01190     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> Object;
01191     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
01192     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
01193     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> RootCellIndex;
01194     PSECURITY_DESCRIPTOR SecurityDescriptor;
01195 
01196     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01197     <span class="comment">//</span>
01198     <span class="comment">// --- Create hive entry for \REGISTRY ---</span>
01199     <span class="comment">//</span>
01200 
01201     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d3/cmsysini_8c.html#a38">CmpCreateRootNode</a>(
01202             &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>), <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"REGISTRY"</span>, &amp;RootCellIndex))
01203     {
01204         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01205     }
01206 
01207     <span class="comment">//</span>
01208     <span class="comment">// --- Create a KEY object that refers to \REGISTRY ---</span>
01209     <span class="comment">//</span>
01210 
01211 
01212     <span class="comment">//</span>
01213     <span class="comment">// Create the object manager object</span>
01214     <span class="comment">//</span>
01215 
01216     <span class="comment">//</span>
01217     <span class="comment">// WARNING: \\REGISTRY is not in pool, so if anybody ever tries to</span>
01218     <span class="comment">//          free it, we are in deep trouble.  On the other hand,</span>
01219     <span class="comment">//          this implies somebody has removed \\REGISTRY from the</span>
01220     <span class="comment">//          root, so we're in trouble anyway.</span>
01221     <span class="comment">//</span>
01222 
01223     SecurityDescriptor = <a class="code" href="../../d7/d2/cmse_8c.html#a13">CmpHiveRootSecurityDescriptor</a>();
01224 
01225     InitializeObjectAttributes(
01226         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01227         &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a13">CmRegistryRootName</a>,
01228         OBJ_CASE_INSENSITIVE,
01229         (HANDLE)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01230         SecurityDescriptor
01231         );
01232 
01233 
01234     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>(
01235         <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01236         <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
01237         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01238         <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
01239         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                   <span class="comment">// Parse context</span>
01240         <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">CM_KEY_BODY</a>),
01241         0,
01242         0,
01243         (PVOID *)&amp;Object
01244         );
01245 
01246     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SecurityDescriptor);
01247 
01248     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01249         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a42">CMS_INIT_ERROR</a>) {
01250             KdPrint((<span class="stringliteral">"CmpCreateRegistryRoot: "</span>));
01251             KdPrint((<span class="stringliteral">"ObCreateObject(\\REGISTRY) failed %08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01252         }
01253         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01254     }
01255 
01256     <span class="comment">//</span>
01257     <span class="comment">// Create the key control block</span>
01258     <span class="comment">//</span>
01259     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = <a class="code" href="../../d8/d2/cmsubs_8c.html#a20">CmpCreateKeyControlBlock</a>(
01260             &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>),
01261             RootCellIndex,
01262             (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>,RootCellIndex),
01263             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01264             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01265             &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a13">CmRegistryRootName</a>
01266             );
01267 
01268     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01269         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01270     }
01271 
01272     <span class="comment">//</span>
01273     <span class="comment">// Initialize the type specific body</span>
01274     <span class="comment">//</span>
01275     Object-&gt;Type = <a class="code" href="../../d1/d2/cmp_8h.html#a78">KEY_BODY_TYPE</a>;
01276     Object-&gt;KeyControlBlock = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
01277     Object-&gt;NotifyBlock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01278     Object-&gt;Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
01279     <a class="code" href="../../d1/d2/cmp_8h.html#a81">ENLIST_KEYBODY_IN_KEYBODY_LIST</a>(Object);
01280 
01281     <span class="comment">//</span>
01282     <span class="comment">// Put the object in the root directory</span>
01283     <span class="comment">//</span>
01284     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>(
01285                 Object,
01286                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01287                 (ACCESS_MASK)0,
01288                 0,
01289                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01290                 &amp;ObjHandle
01291                 );
01292 
01293     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01294         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a42">CMS_INIT_ERROR</a>) {
01295             KdPrint((<span class="stringliteral">"CmpCreateRegistryRoot: "</span>));
01296             KdPrint((<span class="stringliteral">"ObInsertObject(\\REGISTRY) failed %08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01297         }
01298         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01299     }
01300 
01301     <span class="comment">//</span>
01302     <span class="comment">// We cannot make the root permanent because registry objects in</span>
01303     <span class="comment">// general are not allowed to be.  (They're stable via virtue of being</span>
01304     <span class="comment">// stored in the registry, not the object manager.)  But we never</span>
01305     <span class="comment">// ever want the root to go away.  So reference it.</span>
01306     <span class="comment">//</span>
01307     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01308                         ObjHandle,
01309                         KEY_READ,
01310                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01311                         <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01312                         &amp;ObjectPointer,
01313                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01314                         )))
01315     {
01316         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a42">CMS_INIT_ERROR</a>) {
01317             KdPrint((<span class="stringliteral">"CmpCreateRegistryRoot: "</span>));
01318             KdPrint((<span class="stringliteral">"ObReferenceObjectByHandle failed %08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01319         }
01320         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01321     }
01322 
01323     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01324 }
01325 
01326 
01327 BOOLEAN
<a name="l01328"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a38">01328</a> <a class="code" href="../../d1/d3/cmsysini_8c.html#a38">CmpCreateRootNode</a>(
01329     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>   Hive,
01330     IN PWSTR    Name,
01331     OUT PHCELL_INDEX RootCellIndex
01332     )
01333 <span class="comment">/*++</span>
01334 <span class="comment"></span>
01335 <span class="comment">Routine Description:</span>
01336 <span class="comment"></span>
01337 <span class="comment">    Manually create the root node of a hive.</span>
01338 <span class="comment"></span>
01339 <span class="comment">Arguments:</span>
01340 <span class="comment"></span>
01341 <span class="comment">    Hive - pointer to a Hive (Hv level) control structure</span>
01342 <span class="comment"></span>
01343 <span class="comment">    Name - pointer to a unicode name string</span>
01344 <span class="comment"></span>
01345 <span class="comment">    RootCellIndex - supplies pointer to a variable to recieve</span>
01346 <span class="comment">                    the cell index of the created node.</span>
01347 <span class="comment"></span>
01348 <span class="comment">Return Value:</span>
01349 <span class="comment"></span>
01350 <span class="comment">    TRUE == success, FALSE == failure</span>
01351 <span class="comment"></span>
01352 <span class="comment">--*/</span>
01353 {
01354     UNICODE_STRING temp;
01355     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> CellData;
01356     <a class="code" href="../../d5/d5/struct__CM__KEY__REFERENCE.html">CM_KEY_REFERENCE</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
01357     LARGE_INTEGER systemtime;
01358 
01359     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01360     <span class="comment">//</span>
01361     <span class="comment">// Allocate the node.</span>
01362     <span class="comment">//</span>
01363     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;temp, <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
01364     *RootCellIndex = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(
01365                 <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01366                 <a class="code" href="../../d1/d2/cmp_8h.html#a98">CmpHKeyNodeSize</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, &amp;temp),
01367                 <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>
01368                 );
01369     <span class="keywordflow">if</span> (*RootCellIndex == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01370         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a42">CMS_INIT_ERROR</a>) {
01371             KdPrint((<span class="stringliteral">"CmpCreateRootNode: HvAllocateCell failed\n"</span>));
01372         }
01373         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01374     }
01375 
01376     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a> = *RootCellIndex;
01377 
01378     CellData = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, *RootCellIndex);
01379 
01380     <span class="comment">//</span>
01381     <span class="comment">// Initialize the node</span>
01382     <span class="comment">//</span>
01383     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o0">Signature</a> = <a class="code" href="../../d9/d0/cmdata_8h.html#a25">CM_KEY_NODE_SIGNATURE</a>;
01384     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> = <a class="code" href="../../d9/d0/cmdata_8h.html#a29">KEY_HIVE_ENTRY</a> | <a class="code" href="../../d9/d0/cmdata_8h.html#a30">KEY_NO_DELETE</a>;
01385     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;systemtime);
01386     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o2">LastWriteTime</a> = systemtime;
01387 <span class="comment">//    CellData-&gt;u.KeyNode.TitleIndex = 0;</span>
01388     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01389 
01390     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] = 0;
01391     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>] = 0;
01392     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01393     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01394 
01395     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> = 0;
01396     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01397     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01398     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o10">Class</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01399     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a> = 0;
01400 
01401     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o14">MaxValueDataLen</a> = 0;
01402     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o11">MaxNameLen</a> = 0;
01403     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o13">MaxValueNameLen</a> = 0;
01404     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o12">MaxClassLen</a> = 0;
01405 
01406     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a317">CmpCopyName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01407                                                  CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>,
01408                                                  &amp;temp);
01409     <span class="keywordflow">if</span> (CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a> &lt; temp.Length) {
01410         CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>;
01411     }
01412 
01413     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>.KeyHive = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
01414     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>.KeyCell = *RootCellIndex;
01415 
01416     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01417 }
01418 
01419 
01420 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01421"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a49">01421</a> <a class="code" href="../../d6/d3/cmwraper_8c.html#a28">CmpLinkHiveToMaster</a>(
01422     PUNICODE_STRING LinkName,
01423     HANDLE RootDirectory,
01424     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CmHive,
01425     BOOLEAN Allocate,
01426     PSECURITY_DESCRIPTOR SecurityDescriptor
01427     )
01428 <span class="comment">/*++</span>
01429 <span class="comment"></span>
01430 <span class="comment">Routine Description:</span>
01431 <span class="comment"></span>
01432 <span class="comment">    The existing, "free floating" hive CmHive describes is linked into</span>
01433 <span class="comment">    the name space at the node named by LinkName.  The node will be created.</span>
01434 <span class="comment">    The hive is assumed to already have an appropriate root node.</span>
01435 <span class="comment"></span>
01436 <span class="comment">Arguments:</span>
01437 <span class="comment"></span>
01438 <span class="comment">    LinkName - supplies a pointer to a unicode string which describes where</span>
01439 <span class="comment">                in the registry name space the hive is to be linked.</span>
01440 <span class="comment">                All components but the last must exist.  The last must not.</span>
01441 <span class="comment"></span>
01442 <span class="comment">    RootDirectory - Supplies the handle the LinkName is relative to.</span>
01443 <span class="comment"></span>
01444 <span class="comment">    CmHive - pointer to a CMHIVE structure describing the hive to link in.</span>
01445 <span class="comment"></span>
01446 <span class="comment">    Allocate - TRUE indicates that the root cell is to be created</span>
01447 <span class="comment">               FALSE indicates the root cell already exists.</span>
01448 <span class="comment"></span>
01449 <span class="comment">    SecurityDescriptor - supplies a pointer to the security descriptor to</span>
01450 <span class="comment">               be placed on the hive root.</span>
01451 <span class="comment"></span>
01452 <span class="comment">Return Value:</span>
01453 <span class="comment"></span>
01454 <span class="comment">    TRUE == success, FALSE == failure</span>
01455 <span class="comment"></span>
01456 <span class="comment">--*/</span>
01457 {
01458     OBJECT_ATTRIBUTES   <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
01459     HANDLE              KeyHandle;
01460     <a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">CM_PARSE_CONTEXT</a>    ParseContext;
01461     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01462     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>        KeyBody;
01463 
01464     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01465     <span class="comment">//</span>
01466     <span class="comment">// Fill in special ParseContext to indicate that we are creating</span>
01467     <span class="comment">// a link node and opening or creating a root node.</span>
01468     <span class="comment">//</span>
01469     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o0">TitleIndex</a> = 0;
01470     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o1">Class</a>.Length = 0;
01471     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o1">Class</a>.MaximumLength = 0;
01472     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o1">Class</a>.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01473     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o2">CreateOptions</a> = 0;
01474     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o4">CreateLink</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01475     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o5">ChildHive</a>.<a class="code" href="../../d5/d5/struct__CM__KEY__REFERENCE.html#o1">KeyHive</a> = &amp;CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>;
01476     <span class="keywordflow">if</span> (Allocate) {
01477 
01478         <span class="comment">//</span>
01479         <span class="comment">// Creating a new root node</span>
01480         <span class="comment">//</span>
01481 
01482         ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o5">ChildHive</a>.<a class="code" href="../../d5/d5/struct__CM__KEY__REFERENCE.html#o0">KeyCell</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01483     } <span class="keywordflow">else</span> {
01484 
01485         <span class="comment">//</span>
01486         <span class="comment">// Opening an existing root node</span>
01487         <span class="comment">//</span>
01488 
01489         ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o5">ChildHive</a>.<a class="code" href="../../d5/d5/struct__CM__KEY__REFERENCE.html#o0">KeyCell</a> = CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a>;
01490     }
01491 
01492     <span class="comment">//</span>
01493     <span class="comment">// Create a path to the hive</span>
01494     <span class="comment">//</span>
01495     InitializeObjectAttributes(
01496         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01497         LinkName,
01498         OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE,
01499         (HANDLE)RootDirectory,
01500         SecurityDescriptor
01501         );
01502 
01503     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01504                                  <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
01505                                  <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01506                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01507                                  KEY_READ | KEY_WRITE,
01508                                  (PVOID)&amp;ParseContext,
01509                                  &amp;KeyHandle );
01510 
01511     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01512         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a42">CMS_INIT_ERROR</a>) {
01513             KdPrint((<span class="stringliteral">"CmpLinkHiveToMaster: "</span>));
01514             KdPrint((<span class="stringliteral">"ObOpenObjectByName() failed %08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01515             KdPrint((<span class="stringliteral">"\tLinkName='%ws'\n"</span>, LinkName));
01516         }
01517         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01518     }
01519 
01520     <span class="comment">//</span>
01521     <span class="comment">// Report the notification event</span>
01522     <span class="comment">//</span>
01523     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(KeyHandle,
01524                                        0,
01525                                        <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
01526                                        <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01527                                        (PVOID *)&amp;KeyBody,
01528                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01529     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01530     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01531         <a class="code" href="../../d6/d3/cmwraper_8c.html#a13">CmpReportNotify</a>(KeyBody-&gt;KeyControlBlock,
01532                         KeyBody-&gt;KeyControlBlock-&gt;KeyHive,
01533                         KeyBody-&gt;KeyControlBlock-&gt;KeyCell,
01534                         REG_NOTIFY_CHANGE_NAME);
01535 
01536         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
01537     }
01538 
01539     ZwClose(KeyHandle);
01540     <span class="keywordflow">return</span> STATUS_SUCCESS;
01541 }
01542 
01543 
01544 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01545"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a50">01545</a> <a class="code" href="../../d1/d3/cmsysini_8c.html#a50">CmpSetVersionData</a>(
01546     VOID
01547     )
01548 <span class="comment">/*++</span>
01549 <span class="comment"></span>
01550 <span class="comment">Routine Description:</span>
01551 <span class="comment"></span>
01552 <span class="comment">    Create \REGISTRY\MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion:</span>
01553 <span class="comment">                CurrentVersion = VER_PRODUCTVERSION_STR             // From ntverp.h</span>
01554 <span class="comment">                CurrentBuildNumber = VER_PRODUCTBUILD               // From ntverp.h</span>
01555 <span class="comment">                CurrentType = "[Multiprocessor|Uniprocessor]        // From NT_UP</span>
01556 <span class="comment">                                [Retail|Free|Checked]"              // From DBG, DEVL</span>
01557 <span class="comment">                SystemRoot = "[c:\nt]"</span>
01558 <span class="comment"></span>
01559 <span class="comment"></span>
01560 <span class="comment">    NOTE:   It is not worth bugchecking over this, so if it doesn't</span>
01561 <span class="comment">            work, just fail.</span>
01562 <span class="comment"></span>
01563 <span class="comment">Arguments:</span>
01564 <span class="comment"></span>
01565 <span class="comment">Return Value:</span>
01566 <span class="comment"></span>
01567 <span class="comment">--*/</span>
01568 {
01569     ANSI_STRING     AnsiString;
01570     UNICODE_STRING  NameString;
01571     UNICODE_STRING  ValueString;
01572     HANDLE          key1, key2;
01573     UCHAR           WorkString[128];
01574     WCHAR           <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>[128];
01575     OBJECT_ATTRIBUTES   <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
01576     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            status;
01577     PUCHAR              proctype;
01578     PUCHAR              buildtype;
01579     PSECURITY_DESCRIPTOR SecurityDescriptor;
01580 
01581     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01582     <span class="comment">//</span>
01583     <span class="comment">// Get default security descriptor for the nodes we will create.</span>
01584     <span class="comment">//</span>
01585     SecurityDescriptor = <a class="code" href="../../d7/d2/cmse_8c.html#a13">CmpHiveRootSecurityDescriptor</a>();
01586 
01587     <span class="comment">//</span>
01588     <span class="comment">// Create the key</span>
01589     <span class="comment">//</span>
01590     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
01591         &amp;NameString,
01592         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft"</span>
01593         );
01594 
01595     InitializeObjectAttributes(
01596         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01597         &amp;NameString,
01598         OBJ_CASE_INSENSITIVE,
01599         (HANDLE)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01600         SecurityDescriptor
01601         );
01602 
01603     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(
01604                 &amp;key1,
01605                 KEY_CREATE_SUB_KEY,
01606                 &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01607                 0,
01608                 &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a12">nullclass</a>,
01609                 0,
01610                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01611                 );
01612 
01613     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01614 <span class="preprocessor">#if DBG</span>
01615 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CMINIT: CreateKey of %wZ failed - Status == %lx\n"</span>,
01616                  &amp;NameString, status);
01617 <span class="preprocessor">#endif</span>
01618 <span class="preprocessor"></span>        <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SecurityDescriptor);
01619         <span class="keywordflow">return</span>;
01620     }
01621 
01622     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
01623         &amp;NameString,
01624         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Windows NT"</span>
01625         );
01626 
01627     InitializeObjectAttributes(
01628         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01629         &amp;NameString,
01630         OBJ_CASE_INSENSITIVE,
01631         key1,
01632         SecurityDescriptor
01633         );
01634 
01635     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(
01636                 &amp;key2,
01637                 KEY_SET_VALUE,
01638                 &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01639                 0,
01640                 &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a12">nullclass</a>,
01641                 0,
01642                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01643                 );
01644     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(key1);
01645     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
01646         &amp;NameString,
01647         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"CurrentVersion"</span>
01648         );
01649 
01650     InitializeObjectAttributes(
01651         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01652         &amp;NameString,
01653         OBJ_CASE_INSENSITIVE,
01654         key2,
01655         SecurityDescriptor
01656         );
01657 
01658     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(
01659                 &amp;key1,
01660                 KEY_SET_VALUE,
01661                 &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01662                 0,
01663                 &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a12">nullclass</a>,
01664                 0,
01665                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01666                 );
01667     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(key2);
01668     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SecurityDescriptor);
01669     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01670 <span class="preprocessor">#if DBG</span>
01671 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CMINIT: CreateKey of %wZ failed - Status == %lx\n"</span>,
01672                  &amp;NameString, status);
01673 <span class="preprocessor">#endif</span>
01674 <span class="preprocessor"></span>        <span class="keywordflow">return</span>;
01675     }
01676 
01677 
01678     <span class="comment">//</span>
01679     <span class="comment">// Set the value entries for the key</span>
01680     <span class="comment">//</span>
01681     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
01682         &amp;NameString,
01683         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"CurrentVersion"</span>
01684         );
01685 
01686     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
01687         key1,
01688         &amp;NameString,
01689         0,              <span class="comment">// TitleIndex</span>
01690         REG_SZ,
01691         <a class="code" href="../../d8/d1/init_8h.html#a8">CmVersionString</a>.Buffer,
01692         <a class="code" href="../../d8/d1/init_8h.html#a8">CmVersionString</a>.Length + <span class="keyword">sizeof</span>( UNICODE_NULL )
01693         );
01694 <span class="preprocessor">#if DBG</span>
01695 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01696         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CMINIT: SetValueKey of %wZ failed - Status == %lx\n"</span>,
01697                  &amp;NameString, status);
01698     }
01699 <span class="preprocessor">#endif</span>
01700 <span class="preprocessor"></span>    (<a class="code" href="../../d8/d2/ldrinit_8c.html#a8">RtlFreeStringRoutine</a>)( <a class="code" href="../../d8/d1/init_8h.html#a8">CmVersionString</a>.Buffer );
01701     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;<a class="code" href="../../d8/d1/init_8h.html#a8">CmVersionString</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01702 
01703     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
01704         &amp;NameString,
01705         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"CurrentBuildNumber"</span>
01706         );
01707 
01708     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(
01709         WorkString,
01710         <span class="stringliteral">"%u"</span>,
01711         <a class="code" href="../../d5/d5/triage_8c.html#a0">NtBuildNumber</a> &amp; 0xFFFF
01712         );
01713     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;AnsiString, WorkString );
01714 
01715     ValueString.Buffer = <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>;
01716     ValueString.Length = 0;
01717     ValueString.MaximumLength = <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a> );
01718 
01719     <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;ValueString, &amp;AnsiString, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01720 
01721     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
01722         key1,
01723         &amp;NameString,
01724         0,              <span class="comment">// TitleIndex</span>
01725         REG_SZ,
01726         ValueString.Buffer,
01727         ValueString.Length + <span class="keyword">sizeof</span>( UNICODE_NULL )
01728         );
01729 <span class="preprocessor">#if DBG</span>
01730 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01731         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CMINIT: SetValueKey of %wZ failed - Status == %lx\n"</span>,
01732                  &amp;NameString, status);
01733     }
01734 <span class="preprocessor">#endif</span>
01735 <span class="preprocessor"></span>
01736     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
01737         &amp;NameString,
01738         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"CurrentType"</span>
01739         );
01740 
01741 <span class="preprocessor">#if defined(NT_UP)</span>
01742 <span class="preprocessor"></span>    proctype = <span class="stringliteral">"Uniprocessor"</span>;
01743 <span class="preprocessor">#else</span>
01744 <span class="preprocessor"></span>    proctype = <span class="stringliteral">"Multiprocessor"</span>;
01745 <span class="preprocessor">#endif</span>
01746 <span class="preprocessor"></span>
01747 <span class="preprocessor">#if DBG</span>
01748 <span class="preprocessor"></span>    buildtype = <span class="stringliteral">"Checked"</span>;
01749 <span class="preprocessor">#else</span>
01750 <span class="preprocessor"></span><span class="preprocessor">#if DEVL</span>
01751 <span class="preprocessor"></span>    buildtype = <span class="stringliteral">"Free"</span>;
01752 <span class="preprocessor">#else</span>
01753 <span class="preprocessor"></span>    buildtype = <span class="stringliteral">"Retail"</span>;
01754 <span class="preprocessor">#endif</span>
01755 <span class="preprocessor"></span>
01756 <span class="preprocessor">#endif</span>
01757 <span class="preprocessor"></span>
01758     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(
01759         WorkString,
01760         <span class="stringliteral">"%s %s"</span>,
01761         proctype,
01762         buildtype
01763         );
01764     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;AnsiString, WorkString );
01765 
01766     ValueString.Buffer = <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>;
01767     ValueString.Length = 0;
01768     ValueString.MaximumLength = <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a> );
01769 
01770     <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;ValueString, &amp;AnsiString, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01771 
01772     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
01773         key1,
01774         &amp;NameString,
01775         0,              <span class="comment">// TitleIndex</span>
01776         REG_SZ,
01777         ValueString.Buffer,
01778         ValueString.Length + <span class="keyword">sizeof</span>( UNICODE_NULL )
01779         );
01780 
01781     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
01782         &amp;NameString,
01783         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"CSDVersion"</span>
01784         );
01785 
01786     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/init_8h.html#a9">CmCSDVersionString</a>.Length != 0) {
01787         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
01788             key1,
01789             &amp;NameString,
01790             0,              <span class="comment">// TitleIndex</span>
01791             REG_SZ,
01792             <a class="code" href="../../d8/d1/init_8h.html#a9">CmCSDVersionString</a>.Buffer,
01793             <a class="code" href="../../d8/d1/init_8h.html#a9">CmCSDVersionString</a>.Length + <span class="keyword">sizeof</span>( UNICODE_NULL )
01794             );
01795 <span class="preprocessor">#if DBG</span>
01796 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01797             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CMINIT: SetValueKey of %wZ failed - Status == %lx\n"</span>,
01798                      &amp;NameString, status);
01799         }
01800 <span class="preprocessor">#endif</span>
01801 <span class="preprocessor"></span>        (<a class="code" href="../../d8/d2/ldrinit_8c.html#a8">RtlFreeStringRoutine</a>)( <a class="code" href="../../d8/d1/init_8h.html#a9">CmCSDVersionString</a>.Buffer );
01802         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;<a class="code" href="../../d8/d1/init_8h.html#a9">CmCSDVersionString</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01803     } <span class="keywordflow">else</span> {
01804         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a16">NtDeleteValueKey</a>(
01805             key1,
01806             &amp;NameString
01807             );
01808 <span class="preprocessor">#if DBG</span>
01809 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; status != STATUS_OBJECT_NAME_NOT_FOUND) {
01810             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CMINIT: DeleteValueKey of %wZ failed - Status == %lx\n"</span>,
01811                      &amp;NameString, status);
01812         }
01813 <span class="preprocessor">#endif</span>
01814 <span class="preprocessor"></span>    }
01815     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;NameString,
01816                          <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SystemRoot"</span>);
01817     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(key1,
01818                            &amp;NameString,
01819                            0,
01820                            REG_SZ,
01821                            <a class="code" href="../../d8/d1/init_8h.html#a3">NtSystemRoot</a>.Buffer,
01822                            <a class="code" href="../../d8/d1/init_8h.html#a3">NtSystemRoot</a>.Length + <span class="keyword">sizeof</span>(UNICODE_NULL));
01823 <span class="preprocessor">#if DBG</span>
01824 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01825         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CMINIT: SetValueKey of %wZ failed - Status == %lx\n"</span>,
01826                  &amp;NameString,
01827                  status);
01828     }
01829 <span class="preprocessor">#endif</span>
01830 <span class="preprocessor"></span>    <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(key1);
01831 
01832     <span class="comment">//</span>
01833     <span class="comment">// Set each processor to it's optimal configuration.</span>
01834     <span class="comment">//</span>
01835     <span class="comment">// Note: this call is performed interlocked such that the user</span>
01836     <span class="comment">// can disable this automatic configuration update.</span>
01837     <span class="comment">//</span>
01838 
01839     <a class="code" href="../../d1/d3/cmsysini_8c.html#a42">CmpInterlockedFunction</a>(<a class="code" href="../../d6/d0/cmdat_8c.html#a59">CmpProcessorControl</a>, <a class="code" href="../../d1/d3/cmsysini_8c.html#a43">CmpConfigureProcessors</a>);
01840 
01841     <span class="keywordflow">return</span>;
01842 }
01843 
01844 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01845"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a42">01845</a> <a class="code" href="../../d1/d3/cmsysini_8c.html#a42">CmpInterlockedFunction</a> (
01846     PWCHAR RegistryValueKey,
01847     VOID (*InterlockedFunction)(VOID)
01848     )
01849 <span class="comment">/*++</span>
01850 <span class="comment"></span>
01851 <span class="comment">Routine Description:</span>
01852 <span class="comment"></span>
01853 <span class="comment">    This routine guards calling the InterlockedFunction in the</span>
01854 <span class="comment">    passed RegistryValueKey.</span>
01855 <span class="comment"></span>
01856 <span class="comment">    The RegistryValueKey will record the status of the first</span>
01857 <span class="comment">    call to the InterlockedFunction.  If the system crashes</span>
01858 <span class="comment">    durning this call then ValueKey will be left in a state</span>
01859 <span class="comment">    where the InterlockedFunction will not be called on subsequent</span>
01860 <span class="comment">    attempts.</span>
01861 <span class="comment"></span>
01862 <span class="comment">Arguments:</span>
01863 <span class="comment"></span>
01864 <span class="comment">    RegistryValueKey - ValueKey name for Control\Session Manager</span>
01865 <span class="comment">    InterlockedFunction - Function to call</span>
01866 <span class="comment"></span>
01867 <span class="comment">Return Value:</span>
01868 <span class="comment"></span>
01869 <span class="comment">    STATUS_SUCCESS  - The interlocked function was successfully called</span>
01870 <span class="comment"></span>
01871 <span class="comment"></span>
01872 <span class="comment">--*/</span>
01873 {
01874     OBJECT_ATTRIBUTES   objectAttributes;
01875     HANDLE              hControl, hSession;
01876     UNICODE_STRING      <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
01877     UCHAR               <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> [<span class="keyword">sizeof</span>(KEY_VALUE_PARTIAL_INFORMATION)+<span class="keyword">sizeof</span>(ULONG)];
01878     ULONG               length, Value;
01879     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            status;
01880 
01881     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01882 
01883     <span class="comment">//</span>
01884     <span class="comment">// Open CurrentControlSet</span>
01885     <span class="comment">//</span>
01886 
01887     InitializeObjectAttributes (
01888         &amp;objectAttributes,
01889         &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a22">CmRegistryMachineSystemCurrentControlSet</a>,
01890         OBJ_CASE_INSENSITIVE,
01891         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01892         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01893         );
01894 
01895     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a> (&amp;hControl, KEY_READ | KEY_WRITE, &amp;objectAttributes);
01896     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01897         <span class="keywordflow">return</span> status;
01898     }
01899 
01900     <span class="comment">//</span>
01901     <span class="comment">// Open Control\Session Manager</span>
01902     <span class="comment">//</span>
01903 
01904     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d6/d0/cmdat_8c.html#a60">CmpControlSessionManager</a>);
01905     InitializeObjectAttributes (
01906         &amp;objectAttributes,
01907         &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>,
01908         OBJ_CASE_INSENSITIVE,
01909         hControl,
01910         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01911         );
01912 
01913     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a> (&amp;hSession, KEY_READ | KEY_WRITE, &amp;objectAttributes );
01914     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (hControl);
01915     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01916         <span class="keywordflow">return</span> status;
01917     }
01918 
01919     <span class="comment">//</span>
01920     <span class="comment">// Read ValueKey to interlock operation with</span>
01921     <span class="comment">//</span>
01922 
01923     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, RegistryValueKey);
01924     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a> (hSession,
01925                               &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>,
01926                               KeyValuePartialInformation,
01927                               <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
01928                               <span class="keyword">sizeof</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>),
01929                               &amp;length );
01930 
01931     Value = 0;
01932     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01933         Value = ((PKEY_VALUE_PARTIAL_INFORMATION)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;Data[0];
01934     }
01935 
01936     <span class="comment">//</span>
01937     <span class="comment">// Value 0  - Before InterlockedFunction</span>
01938     <span class="comment">//       1  - In the middle of InterlockedFunction</span>
01939     <span class="comment">//       2  - After InterlockedFunction</span>
01940     <span class="comment">//</span>
01941     <span class="comment">// If the value is a 0, then we haven't tried calling this</span>
01942     <span class="comment">// interlocked function, set the value to a 1 and try it.</span>
01943     <span class="comment">//</span>
01944     <span class="comment">// If the value is a 1, then we crased durning an execution</span>
01945     <span class="comment">// of the interlocked function last time, don't try it again.</span>
01946     <span class="comment">//</span>
01947     <span class="comment">// If the value is a 2, then we called the interlocked function</span>
01948     <span class="comment">// before and it worked.  Call it again this time.</span>
01949     <span class="comment">//</span>
01950 
01951     <span class="keywordflow">if</span> (Value != 1) {
01952 
01953         <span class="keywordflow">if</span> (Value != 2) {
01954             <span class="comment">//</span>
01955             <span class="comment">// This interlocked function is not known to work.  Write</span>
01956             <span class="comment">// a 1 to this value so we can detect if we crash durning</span>
01957             <span class="comment">// this call.</span>
01958             <span class="comment">//</span>
01959 
01960             Value = 1;
01961             <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (hSession, &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, REG_DWORD, &amp;Value, <span class="keyword">sizeof</span> (Value));
01962             <a class="code" href="../../d7/d7/ntapi_8c.html#a19">NtFlushKey</a>    (hSession);   <span class="comment">// wait until it's on the disk</span>
01963         }
01964 
01965         InterlockedFunction();
01966 
01967         <span class="keywordflow">if</span> (Value != 2) {
01968             <span class="comment">//</span>
01969             <span class="comment">// The worker function didn't crash - update the value for</span>
01970             <span class="comment">// this interlocked function to 2.</span>
01971             <span class="comment">//</span>
01972 
01973             Value = 2;
01974             <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (hSession, &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, REG_DWORD, &amp;Value, <span class="keyword">sizeof</span> (Value));
01975         }
01976 
01977     } <span class="keywordflow">else</span> {
01978         status = STATUS_UNSUCCESSFUL;
01979     }
01980 
01981     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (hSession);
01982     <span class="keywordflow">return</span> status;
01983 }
01984 
01985 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01986"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a43">01986</a> <a class="code" href="../../d1/d3/cmsysini_8c.html#a43">CmpConfigureProcessors</a> (
01987     VOID
01988     )
01989 <span class="comment">/*++</span>
01990 <span class="comment"></span>
01991 <span class="comment">Routine Description:</span>
01992 <span class="comment"></span>
01993 <span class="comment">    Set each processor to it's optimal settings for NT.</span>
01994 <span class="comment"></span>
01995 <span class="comment">--*/</span>
01996 {
01997     ULONG   i;
01998 
01999     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02000 
02001     <span class="comment">//</span>
02002     <span class="comment">// Set each processor into its best NT configuration</span>
02003     <span class="comment">//</span>
02004 
02005     <span class="keywordflow">for</span> (i=0; i &lt; (ULONG)<a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>; i++) {
02006         <a class="code" href="../../d9/d1/thredobj_8c.html#a19">KeSetSystemAffinityThread</a>((KAFFINITY) 1 &lt;&lt; i);
02007 
02008 <span class="preprocessor">#if i386</span>
02009 <span class="preprocessor"></span>        <span class="comment">// for now x86 only</span>
02010         <a class="code" href="../../d6/d9/kernlini_8c.html#a60">KeOptimizeProcessorControlState</a> ();
02011 <span class="preprocessor">#endif</span>
02012 <span class="preprocessor"></span>    }
02013 
02014     <span class="comment">//</span>
02015     <span class="comment">// Restore threads affinity</span>
02016     <span class="comment">//</span>
02017 
02018     <a class="code" href="../../d9/d1/thredobj_8c.html#a16">KeRevertToUserAffinityThread</a>();
02019 }
02020 
02021 BOOLEAN
<a name="l02022"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a41">02022</a> <a class="code" href="../../d1/d3/cmsysini_8c.html#a41">CmpInitializeSystemHive</a>(
02023     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
02024     )
02025 <span class="comment">/*++</span>
02026 <span class="comment"></span>
02027 <span class="comment">Routine Description:</span>
02028 <span class="comment"></span>
02029 <span class="comment">    Initializes the SYSTEM hive based on the raw hive image passed in</span>
02030 <span class="comment">    from the OS Loader.</span>
02031 <span class="comment"></span>
02032 <span class="comment">Arguments:</span>
02033 <span class="comment"></span>
02034 <span class="comment">    LoaderBlock - Supplies a pointer to the Loader Block passed in by</span>
02035 <span class="comment">        the OS Loader.</span>
02036 <span class="comment"></span>
02037 <span class="comment">Return Value:</span>
02038 <span class="comment"></span>
02039 <span class="comment">    TRUE - it worked</span>
02040 <span class="comment"></span>
02041 <span class="comment">    FALSE - it failed</span>
02042 <span class="comment"></span>
02043 <span class="comment">--*/</span>
02044 
02045 {
02046     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> SystemHive;
02047     PVOID HiveImageBase;
02048     BOOLEAN Allocate=<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02049     PSECURITY_DESCRIPTOR SecurityDescriptor;
02050     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02051     STRING  TempString;
02052 
02053 
02054     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02055 
02056     <span class="comment">//</span>
02057     <span class="comment">// capture tail of boot.ini line (load options, portable)</span>
02058     <span class="comment">//</span>
02059     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(
02060         &amp;TempString,
02061         LoaderBlock-&gt;LoadOptions
02062         );
02063 
02064     <a class="code" href="../../d6/d0/cmdat_8c.html#a0">CmpLoadOptions</a>.Length = 0;
02065     <a class="code" href="../../d6/d0/cmdat_8c.html#a0">CmpLoadOptions</a>.MaximumLength = (TempString.Length+1)*<span class="keyword">sizeof</span>(WCHAR);
02066     <a class="code" href="../../d6/d0/cmdat_8c.html#a0">CmpLoadOptions</a>.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
02067                                 <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, (TempString.Length+1)*<span class="keyword">sizeof</span>(WCHAR));
02068 
02069     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/cmdat_8c.html#a0">CmpLoadOptions</a>.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02070         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,5,6,0,0); <span class="comment">// odds against this are huge</span>
02071     }
02072     <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
02073         &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a0">CmpLoadOptions</a>,
02074         &amp;TempString,
02075         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
02076         );
02077     <a class="code" href="../../d6/d0/cmdat_8c.html#a0">CmpLoadOptions</a>.Buffer[TempString.Length] = UNICODE_NULL;
02078     <a class="code" href="../../d6/d0/cmdat_8c.html#a0">CmpLoadOptions</a>.Length += <span class="keyword">sizeof</span>(WCHAR);
02079 
02080 
02081     <span class="comment">//</span>
02082     <span class="comment">// move the loaded registry into the real registry</span>
02083     <span class="comment">//</span>
02084     HiveImageBase = LoaderBlock-&gt;RegistryBase;
02085 
02086     <span class="keywordflow">if</span> (HiveImageBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02087         <span class="comment">//</span>
02088         <span class="comment">// No memory descriptor for the hive, so we must recreate it.</span>
02089         <span class="comment">//</span>
02090         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a275">CmpInitializeHive</a>(&amp;SystemHive,
02091                     <a class="code" href="../../d6/d0/hive_8h.html#a4">HINIT_CREATE</a>,
02092                     0,
02093                     <a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a>,
02094                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02095                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02096                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02097                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02098                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02099                     &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a34">CmpSystemFileName</a>);
02100         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02101             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a42">CMS_INIT_ERROR</a>) {
02102                 KdPrint((<span class="stringliteral">"CmpInitializeSystemHive: "</span>));
02103                 KdPrint((<span class="stringliteral">"Couldn't initialize newly allocated SYSTEM hive\n"</span>));
02104             }
02105             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02106         }
02107         Allocate = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02108 
02109     } <span class="keywordflow">else</span> {
02110 
02111         <span class="comment">//</span>
02112         <span class="comment">// There is a memory image for the hive, copy it and make it active</span>
02113         <span class="comment">//</span>
02114         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a275">CmpInitializeHive</a>(&amp;SystemHive,
02115                     <a class="code" href="../../d6/d0/hive_8h.html#a5">HINIT_MEMORY</a>,
02116                     0,
02117                     <a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a>,
02118                     HiveImageBase,
02119                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02120                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02121                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02122                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02123                     &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a34">CmpSystemFileName</a>);
02124         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02125                 <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a42">CMS_INIT_ERROR</a>) {
02126                 KdPrint((<span class="stringliteral">"CmpInitializeSystemHive: "</span>));
02127                 KdPrint((<span class="stringliteral">"Couldn't initialize OS Loader-loaded SYSTEM hive\n"</span>));
02128             }
02129             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02130         }
02131 
02132         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d2/cmp_8h.html#a294">CmCheckRegistry</a>(SystemHive, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) != 0) {
02133             <span class="comment">//</span>
02134             <span class="comment">// We couldn't use the SYSTEM hive passed in from the loader.</span>
02135             <span class="comment">// We are dead.</span>
02136             <span class="comment">//</span>
02137             <span class="comment">//</span>
02138             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(BAD_SYSTEM_CONFIG_INFO,5,7,0,0);
02139         }
02140         Allocate = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02141     }
02142 
02143     <span class="comment">//</span>
02144     <span class="comment">// Create the link node</span>
02145     <span class="comment">//</span>
02146     SecurityDescriptor = <a class="code" href="../../d7/d2/cmse_8c.html#a13">CmpHiveRootSecurityDescriptor</a>();
02147 
02148     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d3/cmwraper_8c.html#a28">CmpLinkHiveToMaster</a>(&amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a21">CmRegistryMachineSystemName</a>,
02149                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02150                                  SystemHive,
02151                                  Allocate,
02152                                  SecurityDescriptor);
02153     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SecurityDescriptor);
02154 
02155     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02156         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a42">CMS_INIT_ERROR</a>) {
02157             KdPrint((<span class="stringliteral">"CmInitSystem1: CmpLinkHiveToMaster(Hardware) failed\n"</span>));
02158         }
02159         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02160     }
02161 
02162     <a class="code" href="../../d6/d0/cmdat_8c.html#a62">CmpMachineHiveList</a>[<a class="code" href="../../d1/d3/cmsysini_8c.html#a2">SYSTEM_HIVE_INDEX</a>].<a class="code" href="../../d9/d7/struct__HIVE__LIST__ENTRY.html#o2">CmHive</a> = SystemHive;
02163 
02164     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02165 }
02166 
02167 
02168 PHANDLE
<a name="l02169"></a><a class="code" href="../../d7/d9/cm_8h.html#a29">02169</a> <a class="code" href="../../d7/d9/cm_8h.html#a29">CmGetSystemDriverList</a>(
02170     VOID
02171     )
02172 
02173 <span class="comment">/*++</span>
02174 <span class="comment"></span>
02175 <span class="comment">Routine Description:</span>
02176 <span class="comment"></span>
02177 <span class="comment">    Traverses the current SERVICES subtree and creates the list of drivers</span>
02178 <span class="comment">    to be loaded during Phase 1 initialization.</span>
02179 <span class="comment"></span>
02180 <span class="comment">Arguments:</span>
02181 <span class="comment"></span>
02182 <span class="comment">    None</span>
02183 <span class="comment"></span>
02184 <span class="comment">Return Value:</span>
02185 <span class="comment"></span>
02186 <span class="comment">    A pointer to an array of handles, each of which refers to a key in</span>
02187 <span class="comment">    the \Services section of the control set.  The caller will traverse</span>
02188 <span class="comment">    this array and load and initialize the drivers described by the keys.</span>
02189 <span class="comment"></span>
02190 <span class="comment">    The last key will be NULL.  The array is allocated in Pool and should</span>
02191 <span class="comment">    be freed by the caller.</span>
02192 <span class="comment"></span>
02193 <span class="comment">--*/</span>
02194 
02195 {
02196     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
02197     HANDLE SystemHandle;
02198     UNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
02199     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02200     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> KeyBody;
02201     LIST_ENTRY DriverList;
02202     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
02203     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> RootCell;
02204     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ControlCell;
02205     ULONG DriverCount;
02206     PLIST_ENTRY Current;
02207     PHANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
02208     <a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html">PBOOT_DRIVER_LIST_ENTRY</a> <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>;
02209     BOOLEAN Success;
02210     BOOLEAN AutoSelect;
02211 
02212     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02213     InitializeListHead(&amp;DriverList);
02214     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>,
02215                          <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System"</span>);
02216 
02217     InitializeObjectAttributes(&amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
02218                                &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>,
02219                                OBJ_CASE_INSENSITIVE,
02220                                (HANDLE)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02221                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02222     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;SystemHandle,
02223                        KEY_READ,
02224                        &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>);
02225 
02226     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02227         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a42">CMS_INIT_ERROR</a>) {
02228             KdPrint((<span class="stringliteral">"CM: CmGetSystemDriverList couldn't open registry key %wZ\n"</span>,&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>));
02229             KdPrint((<span class="stringliteral">"CM:     status %08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02230         }
02231         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02232     }
02233 
02234 
02235     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( SystemHandle,
02236                                         KEY_QUERY_VALUE,
02237                                         <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
02238                                         <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
02239                                         (PVOID *)(&amp;KeyBody),
02240                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
02241     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02242         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a42">CMS_INIT_ERROR</a>) {
02243             KdPrint((<span class="stringliteral">"CM: CmGetSystemDriverList couldn't dereference Systemhandle\n"</span>));
02244             KdPrint((<span class="stringliteral">"CM:     status %08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02245         }
02246         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(SystemHandle);
02247         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02248     }
02249 
02250     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
02251 
02252     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyBody-&gt;KeyControlBlock-&gt;KeyHive;
02253     RootCell = KeyBody-&gt;KeyControlBlock-&gt;KeyCell;
02254 
02255     <span class="comment">//</span>
02256     <span class="comment">// Now we have found out the PHHIVE and HCELL_INDEX of the root of the</span>
02257     <span class="comment">// SYSTEM hive, we can use all the same code that the OS Loader does.</span>
02258     <span class="comment">//</span>
02259 
02260     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Current"</span>);
02261     ControlCell = <a class="code" href="../../d1/d2/cmp_8h.html#a296">CmpFindControlSet</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
02262                                     RootCell,
02263                                     &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>,
02264                                     &amp;AutoSelect);
02265     <span class="keywordflow">if</span> (ControlCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
02266         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a42">CMS_INIT_ERROR</a>) {
02267             KdPrint((<span class="stringliteral">"CM: CmGetSystemDriverList couldn't find control set\n"</span>));
02268         }
02269         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
02270         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
02271         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(SystemHandle);
02272         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02273     }
02274 
02275     Success = <a class="code" href="../../d1/d2/cmp_8h.html#a297">CmpFindDrivers</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
02276                              ControlCell,
02277                              SystemLoad,
02278                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02279                              &amp;DriverList);
02280 
02281 
02282     <span class="keywordflow">if</span> (!Success) {
02283         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a42">CMS_INIT_ERROR</a>) {
02284             KdPrint((<span class="stringliteral">"CM: CmGetSystemDriverList couldn't find any valid drivers\n"</span>));
02285         }
02286         <a class="code" href="../../d1/d3/cmsysini_8c.html#a39">CmpFreeDriverList</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, &amp;DriverList);
02287         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
02288         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
02289         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(SystemHandle);
02290         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02291     }
02292 
02293     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d2/cmp_8h.html#a302">CmpSortDriverList</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
02294                            ControlCell,
02295                            &amp;DriverList)) {
02296         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a42">CMS_INIT_ERROR</a>) {
02297             KdPrint((<span class="stringliteral">"CM: CmGetSystemDriverList couldn't sort driver list\n"</span>));
02298         }
02299         <a class="code" href="../../d1/d3/cmsysini_8c.html#a39">CmpFreeDriverList</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, &amp;DriverList);
02300         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
02301         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
02302         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(SystemHandle);
02303         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02304     }
02305 
02306     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d2/cmp_8h.html#a301">CmpResolveDriverDependencies</a>(&amp;DriverList)) {
02307         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a42">CMS_INIT_ERROR</a>) {
02308             KdPrint((<span class="stringliteral">"CM: CmGetSystemDriverList couldn't resolve driver dependencies\n"</span>));
02309         }
02310         <a class="code" href="../../d1/d3/cmsysini_8c.html#a39">CmpFreeDriverList</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, &amp;DriverList);
02311         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
02312         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
02313         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(SystemHandle);
02314         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02315     }
02316     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
02317     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
02318     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(SystemHandle);
02319 
02320     <span class="comment">//</span>
02321     <span class="comment">// We now have a fully sorted and ordered list of drivers to be loaded</span>
02322     <span class="comment">// by IoInit.</span>
02323     <span class="comment">//</span>
02324 
02325     <span class="comment">//</span>
02326     <span class="comment">// Count the nodes in the list.</span>
02327     <span class="comment">//</span>
02328     Current = DriverList.Flink;
02329     DriverCount = 0;
02330     <span class="keywordflow">while</span> (Current != &amp;DriverList) {
02331         ++DriverCount;
02332         Current = Current-&gt;Flink;
02333     }
02334 
02335     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = (PHANDLE)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
02336                                      (DriverCount+1) * <span class="keyword">sizeof</span>(HANDLE));
02337 
02338     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02339         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,5,8,0,0); <span class="comment">// odds against this are huge</span>
02340     }
02341 
02342     <span class="comment">//</span>
02343     <span class="comment">// Walk the list, opening each registry key and adding it to the</span>
02344     <span class="comment">// table of handles.</span>
02345     <span class="comment">//</span>
02346     Current = DriverList.Flink;
02347     DriverCount = 0;
02348     <span class="keywordflow">while</span> (Current != &amp;DriverList) {
02349         <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a> = CONTAINING_RECORD(Current,
02350                                         <a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html">BOOT_DRIVER_LIST_ENTRY</a>,
02351                                         Link);
02352 
02353         InitializeObjectAttributes(&amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
02354                                    &amp;<a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>-&gt;RegistryPath,
02355                                    OBJ_CASE_INSENSITIVE,
02356                                    (HANDLE)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02357                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02358 
02359         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>+DriverCount,
02360                            KEY_READ | KEY_WRITE,
02361                            &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>);
02362         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02363             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a42">CMS_INIT_ERROR</a>) {
02364                 KdPrint((<span class="stringliteral">"CM: CmGetSystemDriverList couldn't open driver "</span>));
02365                 KdPrint((<span class="stringliteral">"key %wZ\n"</span>, &amp;<a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>-&gt;RegistryPath));
02366                 KdPrint((<span class="stringliteral">"    status %08lx\n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02367             }
02368         } <span class="keywordflow">else</span> {
02369             ++DriverCount;
02370         }
02371         Current = Current-&gt;Flink;
02372     }
02373     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>[DriverCount] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02374 
02375     <span class="keywordflow">return</span>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
02376 }
02377 
02378 
02379 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02380"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a39">02380</a> <a class="code" href="../../d1/d3/cmsysini_8c.html#a39">CmpFreeDriverList</a>(
02381     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
02382     IN PLIST_ENTRY DriverList
02383     )
02384 
02385 <span class="comment">/*++</span>
02386 <span class="comment"></span>
02387 <span class="comment">Routine Description:</span>
02388 <span class="comment"></span>
02389 <span class="comment">    Walks down the driver list, freeing each node in it.</span>
02390 <span class="comment"></span>
02391 <span class="comment">    Note that this calls the hive's free routine pointer to free the memory.</span>
02392 <span class="comment"></span>
02393 <span class="comment">Arguments:</span>
02394 <span class="comment"></span>
02395 <span class="comment">    Hive - Supplies  a pointer to the hive control structure.</span>
02396 <span class="comment"></span>
02397 <span class="comment">    DriverList - Supplies a pointer to the head of the Driver List.  Note</span>
02398 <span class="comment">            that the head of the list is not actually freed, only all the</span>
02399 <span class="comment">            entries in the list.</span>
02400 <span class="comment"></span>
02401 <span class="comment">Return Value:</span>
02402 <span class="comment"></span>
02403 <span class="comment">    None.</span>
02404 <span class="comment"></span>
02405 <span class="comment">--*/</span>
02406 
02407 {
02408     PLIST_ENTRY Next;
02409     PLIST_ENTRY Current;
02410 
02411     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02412     Current = DriverList-&gt;Flink;
02413     <span class="keywordflow">while</span> (Current != DriverList) {
02414         Next = Current-&gt;Flink;
02415         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)((PVOID)Current, <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">BOOT_DRIVER_NODE</a>));
02416         Current = Next;
02417     }
02418 }
02419 
02420 
02421 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02422"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a52">02422</a> <a class="code" href="../../d1/d3/cmsysini_8c.html#a52">CmpInitHiveFromFile</a>(
02423     IN PUNICODE_STRING FileName,
02424     IN ULONG HiveFlags,
02425     OUT <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> *CmHive,
02426     IN OUT PBOOLEAN Allocate,
02427     IN OUT PBOOLEAN RegistryLocked
02428     )
02429 
02430 <span class="comment">/*++</span>
02431 <span class="comment"></span>
02432 <span class="comment">Routine Description:</span>
02433 <span class="comment"></span>
02434 <span class="comment">    This routine opens a file and log, allocates a CMHIVE, and initializes</span>
02435 <span class="comment">    it.</span>
02436 <span class="comment"></span>
02437 <span class="comment">Arguments:</span>
02438 <span class="comment"></span>
02439 <span class="comment">    FileName - Supplies name of file to be loaded.</span>
02440 <span class="comment"></span>
02441 <span class="comment">    HiveFlags - Supplies hive flags to be passed to CmpInitializeHive</span>
02442 <span class="comment"></span>
02443 <span class="comment">    CmHive   - Returns pointer to initialized hive (if successful)</span>
02444 <span class="comment"></span>
02445 <span class="comment">    Allocate - IN: if TRUE ok to allocate, if FALSE hive must exist</span>
02446 <span class="comment">                    (bug .log may get created)</span>
02447 <span class="comment">               OUT: TRUE if actually created hive, FALSE if existed before</span>
02448 <span class="comment"></span>
02449 <span class="comment">Return Value:</span>
02450 <span class="comment"></span>
02451 <span class="comment">    NTSTATUS</span>
02452 <span class="comment"></span>
02453 <span class="comment">--*/</span>
02454 
02455 {
02456     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> NewHive;
02457     ULONG Disposition;
02458     ULONG SecondaryDisposition;
02459     HANDLE PrimaryHandle;
02460     HANDLE LogHandle;
02461     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02462     ULONG FileType;
02463     ULONG Operation;
02464 
02465     BOOLEAN Success;
02466 
02467     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02468     *CmHive = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02469 
02470     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a290">CmpOpenHiveFiles</a>(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>,
02471                               <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">".LOG"</span>,
02472                               &amp;PrimaryHandle,
02473                               &amp;LogHandle,
02474                               &amp;Disposition,
02475                               &amp;SecondaryDisposition,
02476                               *Allocate,
02477                               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
02478                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02479 
02480     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02481         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02482     }
02483 
02484     <span class="keywordflow">if</span> (LogHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02485         FileType = <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>;
02486     } <span class="keywordflow">else</span> {
02487         FileType = <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>;
02488     }
02489 
02490     <span class="keywordflow">if</span> (Disposition == FILE_CREATED) {
02491         Operation = <a class="code" href="../../d6/d0/hive_8h.html#a4">HINIT_CREATE</a>;
02492         *Allocate = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02493     } <span class="keywordflow">else</span> {
02494         Operation = <a class="code" href="../../d6/d0/hive_8h.html#a6">HINIT_FILE</a>;
02495         *Allocate = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02496     }
02497 
02498     <span class="keywordflow">if</span>( !(*RegistryLocked) ) {
02499         <span class="comment">//</span>
02500         <span class="comment">// Registry should be locked exclusive</span>
02501         <span class="comment">// if not, lock it now and signal this to the caller</span>
02502         <span class="comment">//</span>
02503         <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
02504         *RegistryLocked = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02505     }
02506 
02507     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a275">CmpInitializeHive</a>(&amp;NewHive,
02508                                 Operation,
02509                                 HiveFlags,
02510                                 FileType,
02511                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02512                                 PrimaryHandle,
02513                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02514                                 LogHandle,
02515                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02516                                 <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>
02517                                 );
02518     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02519         ZwClose(PrimaryHandle);
02520         <span class="keywordflow">if</span> (LogHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02521             ZwClose(LogHandle);
02522         }
02523         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02524     } <span class="keywordflow">else</span> {
02525         *CmHive = NewHive;
02526         <span class="keywordflow">return</span>(STATUS_SUCCESS);
02527     }
02528 }
02529 
02530 
02531 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02532"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a44">02532</a> <a class="code" href="../../d1/d3/cmsysini_8c.html#a44">CmpAddDockingInfo</a> (
02533     IN HANDLE Key,
02534     IN <a class="code" href="../../d0/d1/struct__PROFILE__PARAMETER__BLOCK.html">PROFILE_PARAMETER_BLOCK</a> * ProfileBlock
02535     )
02536 <span class="comment">/*++</span>
02537 <span class="comment">Routine Description:</span>
02538 <span class="comment">    Write DockID SerialNumber DockState and Capabilities intot the given</span>
02539 <span class="comment">    registry key.</span>
02540 <span class="comment"></span>
02541 <span class="comment">--*/</span>
02542 {
02543     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
02544     UNICODE_STRING name;
02545     ULONG value;
02546 
02547     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
02548 
02549     value = ProfileBlock-&gt;DockingState;
02550     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a131">CM_HARDWARE_PROFILE_STR_DOCKING_STATE</a>);
02551     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
02552                             &amp;name,
02553                             0,
02554                             REG_DWORD,
02555                             &amp;value,
02556                             <span class="keyword">sizeof</span> (value));
02557 
02558     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
02559         <span class="keywordflow">return</span> status;
02560     }
02561 
02562     value = ProfileBlock-&gt;Capabilities;
02563     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a132">CM_HARDWARE_PROFILE_STR_CAPABILITIES</a>);
02564     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
02565                             &amp;name,
02566                             0,
02567                             REG_DWORD,
02568                             &amp;value,
02569                             <span class="keyword">sizeof</span> (value));
02570 
02571     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
02572         <span class="keywordflow">return</span> status;
02573     }
02574 
02575     value = ProfileBlock-&gt;DockID;
02576     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a133">CM_HARDWARE_PROFILE_STR_DOCKID</a>);
02577     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
02578                             &amp;name,
02579                             0,
02580                             REG_DWORD,
02581                             &amp;value,
02582                             <span class="keyword">sizeof</span> (value));
02583 
02584     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
02585         <span class="keywordflow">return</span> status;
02586     }
02587 
02588     value = ProfileBlock-&gt;SerialNumber;
02589     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a134">CM_HARDWARE_PROFILE_STR_SERIAL_NUMBER</a>);
02590     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
02591                             &amp;name,
02592                             0,
02593                             REG_DWORD,
02594                             &amp;value,
02595                             <span class="keyword">sizeof</span> (value));
02596 
02597     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
02598         <span class="keywordflow">return</span> status;
02599     }
02600 
02601     <span class="keywordflow">return</span> status;
02602 }
02603 
02604 
02605 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02606"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a45">02606</a> <a class="code" href="../../d1/d3/cmsysini_8c.html#a45">CmpAddAliasEntry</a> (
02607     IN HANDLE IDConfigDB,
02608     IN <a class="code" href="../../d0/d1/struct__PROFILE__PARAMETER__BLOCK.html">PROFILE_PARAMETER_BLOCK</a> * ProfileBlock,
02609     IN ULONG  ProfileNumber
02610     )
02611 <span class="comment">/*++</span>
02612 <span class="comment">Routine Description:</span>
02613 <span class="comment">    Create an alias entry in the IDConfigDB database for the given</span>
02614 <span class="comment">    hardware profile.</span>
02615 <span class="comment"></span>
02616 <span class="comment">    Create the "Alias" key if it does not exist.</span>
02617 <span class="comment"></span>
02618 <span class="comment">Parameters:</span>
02619 <span class="comment"></span>
02620 <span class="comment">    IDConfigDB - Pointer to "..\CurrentControlSet\Control\IDConfigDB"</span>
02621 <span class="comment"></span>
02622 <span class="comment">    ProfileBlock - Description of the current Docking information</span>
02623 <span class="comment"></span>
02624 <span class="comment">    ProfileNumber -</span>
02625 <span class="comment"></span>
02626 <span class="comment">--*/</span>
02627 {
02628     OBJECT_ATTRIBUTES attributes;
02629     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        status = STATUS_SUCCESS;
02630     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>            asciiBuffer [128];
02631     WCHAR           unicodeBuffer [128];
02632     ANSI_STRING     ansiString;
02633     UNICODE_STRING  name;
02634     HANDLE          aliasKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02635     HANDLE          aliasEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02636     ULONG           value;
02637     ULONG           disposition;
02638     ULONG           aliasNumber = 0;
02639 
02640     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
02641 
02642     <span class="comment">//</span>
02643     <span class="comment">// Find the Alias Key or Create it if it does not already exist.</span>
02644     <span class="comment">//</span>
02645     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name,<a class="code" href="../../d1/d2/cmp_8h.html#a128">CM_HARDWARE_PROFILE_STR_ALIAS</a>);
02646 
02647     InitializeObjectAttributes (&amp;attributes,
02648                                 &amp;name,
02649                                 OBJ_CASE_INSENSITIVE,
02650                                 IDConfigDB,
02651                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02652 
02653     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a> (&amp;aliasKey,
02654                         KEY_READ | KEY_WRITE,
02655                         &amp;attributes);
02656 
02657     <span class="keywordflow">if</span> (STATUS_OBJECT_NAME_NOT_FOUND == status) {
02658         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a> (&amp;aliasKey,
02659                               KEY_READ | KEY_WRITE,
02660                               &amp;attributes,
02661                               0, <span class="comment">// no title</span>
02662                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <span class="comment">// no class</span>
02663                               0, <span class="comment">// no options</span>
02664                               &amp;disposition);
02665     }
02666 
02667     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
02668         aliasKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02669         <span class="keywordflow">goto</span> Exit;
02670     }
02671 
02672     <span class="comment">//</span>
02673     <span class="comment">// Create an entry key</span>
02674     <span class="comment">//</span>
02675 
02676     <span class="keywordflow">while</span> (aliasNumber &lt; 200) {
02677         aliasNumber++;
02678 
02679         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(asciiBuffer, <span class="stringliteral">"%04d"</span>, aliasNumber);
02680 
02681         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;ansiString, asciiBuffer);
02682         name.MaximumLength = <span class="keyword">sizeof</span>(unicodeBuffer);
02683         name.Buffer = unicodeBuffer;
02684         status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;name,
02685                                               &amp;ansiString,
02686                                               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02687         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (STATUS_SUCCESS == status);
02688 
02689         InitializeObjectAttributes(&amp;attributes,
02690                                    &amp;name,
02691                                    OBJ_CASE_INSENSITIVE,
02692                                    aliasKey,
02693                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02694 
02695         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a> (&amp;aliasEntry,
02696                             KEY_READ | KEY_WRITE,
02697                             &amp;attributes);
02698 
02699         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
02700             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (aliasEntry);
02701 
02702         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (STATUS_OBJECT_NAME_NOT_FOUND == status) {
02703             status = STATUS_SUCCESS;
02704             <span class="keywordflow">break</span>;
02705 
02706         } <span class="keywordflow">else</span> {
02707             <span class="keywordflow">break</span>;
02708         }
02709 
02710     }
02711     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
02712         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
02713             KdPrint((<span class="stringliteral">"CM: cmpCreateAliasEntry error finding new set %08lx\n"</span>,
02714                      status));
02715         }
02716         aliasEntry = 0;
02717         <span class="keywordflow">goto</span> Exit;
02718     }
02719 
02720     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a> (&amp;aliasEntry,
02721                           KEY_READ | KEY_WRITE,
02722                           &amp;attributes,
02723                           0,
02724                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02725                           0,
02726                           &amp;disposition);
02727 
02728     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
02729         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
02730             KdPrint((<span class="stringliteral">"CM: cmpCreateAliasEntry error creating new set %08lx\n"</span>,
02731                      status));
02732         }
02733         aliasEntry = 0;
02734         <span class="keywordflow">goto</span> Exit;
02735     }
02736 
02737     <span class="comment">//</span>
02738     <span class="comment">// Write the standard goo</span>
02739     <span class="comment">//</span>
02740     <a class="code" href="../../d1/d3/cmsysini_8c.html#a44">CmpAddDockingInfo</a> (aliasEntry, ProfileBlock);
02741 
02742     <span class="comment">//</span>
02743     <span class="comment">// Write the Profile Number</span>
02744     <span class="comment">//</span>
02745     value = ProfileNumber;
02746     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a136">CM_HARDWARE_PROFILE_STR_PROFILE_NUMBER</a>);
02747     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (aliasEntry,
02748                             &amp;name,
02749                             0,
02750                             REG_DWORD,
02751                             &amp;value,
02752                             <span class="keyword">sizeof</span> (value));
02753 
02754 Exit:
02755 
02756     <span class="keywordflow">if</span> (aliasKey) {
02757         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (aliasKey);
02758     }
02759 
02760     <span class="keywordflow">if</span> (aliasEntry) {
02761         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (aliasEntry);
02762     }
02763 
02764     <span class="keywordflow">return</span> status;
02765 }
02766 
02767 
02768 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02769"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a53">02769</a> <a class="code" href="../../d1/d3/cmsysini_8c.html#a53">CmpHwprofileDefaultSelect</a> (
02770     IN  <a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">PCM_HARDWARE_PROFILE_LIST</a> ProfileList,
02771     OUT PULONG ProfileIndexToUse,
02772     IN  PVOID Context
02773     )
02774 {
02775     UNREFERENCED_PARAMETER (Context);
02776 
02777     * ProfileIndexToUse = 0;
02778 
02779     <span class="keywordflow">return</span> STATUS_SUCCESS;
02780 }
02781 
02782 
02783 
02784 
02785 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02786"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a34">02786</a> <a class="code" href="../../d1/d3/cmsysini_8c.html#a34">CmpCreateControlSet</a>(
02787     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
02788     )
02789 
02790 <span class="comment">/*++</span>
02791 <span class="comment"></span>
02792 <span class="comment">Routine Description:</span>
02793 <span class="comment"></span>
02794 <span class="comment">    This routine sets up the symbolic links from</span>
02795 <span class="comment"></span>
02796 <span class="comment">        \Registry\Machine\System\CurrentControlSet to</span>
02797 <span class="comment">        \Registry\Machine\System\ControlSetNNN</span>
02798 <span class="comment"></span>
02799 <span class="comment">        \Registry\Machine\System\CurrentControlSet\Hardware Profiles\Current to</span>
02800 <span class="comment">        \Registry\Machine\System\ControlSetNNN\Hardware Profiles\NNNN</span>
02801 <span class="comment"></span>
02802 <span class="comment">    based on the value of \Registry\Machine\System\Select:Current. and</span>
02803 <span class="comment">                          \Registry\Machine\System\ControlSetNNN\Control\IDConfigDB:CurrentConfig</span>
02804 <span class="comment"></span>
02805 <span class="comment">Arguments:</span>
02806 <span class="comment"></span>
02807 <span class="comment">    None</span>
02808 <span class="comment"></span>
02809 <span class="comment">Return Value:</span>
02810 <span class="comment"></span>
02811 <span class="comment">    status</span>
02812 <span class="comment"></span>
02813 <span class="comment">--*/</span>
02814 
02815 {
02816     UNICODE_STRING IDConfigDBName;
02817     UNICODE_STRING SelectName;
02818     UNICODE_STRING CurrentName;
02819     OBJECT_ATTRIBUTES Attributes;
02820     HANDLE SelectHandle;
02821     HANDLE CurrentHandle;
02822     HANDLE IDConfigDB = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02823     HANDLE CurrentProfile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02824     HANDLE ParentOfProfile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02825     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> AsciiBuffer[128];
02826     WCHAR UnicodeBuffer[128];
02827     UCHAR <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>[128];
02828     ULONG ControlSet;
02829     ULONG HWProfile;
02830     PKEY_VALUE_FULL_INFORMATION Value;
02831     ANSI_STRING AnsiString;
02832     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02833     ULONG ResultLength;
02834     ULONG Disposition;
02835     BOOLEAN signalAcpiEvent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02836 
02837     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02838 
02839     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;SelectName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\Select"</span>);
02840     InitializeObjectAttributes(&amp;Attributes,
02841                                &amp;SelectName,
02842                                OBJ_CASE_INSENSITIVE,
02843                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02844                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02845     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;SelectHandle,
02846                        KEY_READ,
02847                        &amp;Attributes);
02848     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02849         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
02850             KdPrint((<span class="stringliteral">"CM: CmpCreateControlSet: Couldn't open Select node %08lx\n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02851         }
02852         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02853     }
02854 
02855     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;CurrentName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Current"</span>);
02856     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(SelectHandle,
02857                              &amp;CurrentName,
02858                              KeyValueFullInformation,
02859                              <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>,
02860                              <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>),
02861                              &amp;ResultLength);
02862     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(SelectHandle);
02863     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02864         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
02865             KdPrint((<span class="stringliteral">"CM: CmpCreateControlSet: Couldn't query Select value %08lx\n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02866         }
02867         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02868     }
02869     Value = (PKEY_VALUE_FULL_INFORMATION)<a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>;
02870     ControlSet = *(PULONG)((PUCHAR)Value + Value-&gt;DataOffset);
02871 
02872     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;CurrentName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet"</span>);
02873     InitializeObjectAttributes(&amp;Attributes,
02874                                &amp;CurrentName,
02875                                OBJ_CASE_INSENSITIVE,
02876                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02877                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02878     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(&amp;CurrentHandle,
02879                          KEY_CREATE_LINK,
02880                          &amp;Attributes,
02881                          0,
02882                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02883                          REG_OPTION_VOLATILE | REG_OPTION_CREATE_LINK,
02884                          &amp;Disposition);
02885     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02886         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
02887             KdPrint((<span class="stringliteral">"CM: CmpCreateControlSet: couldn't create CurrentControlSet %08lx\n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02888         }
02889         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02890     }
02891 
02892     <span class="comment">//</span>
02893     <span class="comment">// Check to make sure that the key was created, not just opened.  Since</span>
02894     <span class="comment">// this key is always created volatile, it should never be present in</span>
02895     <span class="comment">// the hive when we boot.</span>
02896     <span class="comment">//</span>
02897     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Disposition == REG_CREATED_NEW_KEY);
02898 
02899     <span class="comment">//</span>
02900     <span class="comment">// Create symbolic link for current hardware profile.</span>
02901     <span class="comment">//</span>
02902     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(AsciiBuffer, <span class="stringliteral">"\\Registry\\Machine\\System\\ControlSet%03d"</span>, ControlSet);
02903     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;AnsiString, AsciiBuffer);
02904 
02905     CurrentName.MaximumLength = <span class="keyword">sizeof</span>(UnicodeBuffer);
02906     CurrentName.Buffer = UnicodeBuffer;
02907     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;CurrentName,
02908                                           &amp;AnsiString,
02909                                           <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02910     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(CurrentHandle,
02911                            &amp;<a class="code" href="../../d8/d9/cmapi_8c.html#a6">CmSymbolicLinkValueName</a>,
02912                            0,
02913                            REG_LINK,
02914                            CurrentName.Buffer,
02915                            CurrentName.Length);
02916 
02917     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02918         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
02919             KdPrint((<span class="stringliteral">"CM: CmpCreateControlSet: couldn't create symbolic link "</span>));
02920             KdPrint((<span class="stringliteral">"to %wZ\n"</span>,&amp;CurrentName));
02921             KdPrint((<span class="stringliteral">"    Status=%08lx\n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02922         }
02923         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02924     }
02925 
02926     <span class="comment">//</span>
02927     <span class="comment">// Determine the Current Hardware Profile Number</span>
02928     <span class="comment">//</span>
02929     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;IDConfigDBName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Control\\IDConfigDB"</span>);
02930     InitializeObjectAttributes(&amp;Attributes,
02931                                &amp;IDConfigDBName,
02932                                OBJ_CASE_INSENSITIVE,
02933                                CurrentHandle,
02934                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02935     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;IDConfigDB,
02936                        KEY_READ,
02937                        &amp;Attributes);
02938     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(CurrentHandle);
02939 
02940     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02941         IDConfigDB = 0;
02942         <span class="keywordflow">goto</span> Cleanup;
02943     }
02944 
02945     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;CurrentName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"CurrentConfig"</span>);
02946     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(IDConfigDB,
02947                              &amp;CurrentName,
02948                              KeyValueFullInformation,
02949                              <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>,
02950                              <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>),
02951                              &amp;ResultLength);
02952 
02953     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ||
02954         (((PKEY_VALUE_FULL_INFORMATION)<a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>)-&gt;Type != REG_DWORD)) {
02955 
02956         <span class="keywordflow">goto</span> Cleanup;
02957     }
02958 
02959     Value = (PKEY_VALUE_FULL_INFORMATION)<a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>;
02960     HWProfile = *(PULONG)((PUCHAR)Value + Value-&gt;DataOffset);
02961     <span class="comment">//</span>
02962     <span class="comment">// We know now the config set that the user selected.</span>
02963     <span class="comment">// namely: HWProfile.</span>
02964     <span class="comment">//</span>
02965 
02966     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
02967               &amp;CurrentName,
02968               <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Hardware Profiles"</span>);
02969     InitializeObjectAttributes(&amp;Attributes,
02970                                &amp;CurrentName,
02971                                OBJ_CASE_INSENSITIVE,
02972                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02973                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02974     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;ParentOfProfile,
02975                        KEY_READ,
02976                        &amp;Attributes);
02977 
02978     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02979         ParentOfProfile = 0;
02980         <span class="keywordflow">goto</span> Cleanup;
02981     }
02982 
02983     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(AsciiBuffer, <span class="stringliteral">"%04d"</span>,HWProfile);
02984     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;AnsiString, AsciiBuffer);
02985     CurrentName.MaximumLength = <span class="keyword">sizeof</span>(UnicodeBuffer);
02986     CurrentName.Buffer = UnicodeBuffer;
02987     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;CurrentName,
02988                                           &amp;AnsiString,
02989                                           <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02990     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (STATUS_SUCCESS == <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02991 
02992     InitializeObjectAttributes(&amp;Attributes,
02993                                &amp;CurrentName,
02994                                OBJ_CASE_INSENSITIVE,
02995                                ParentOfProfile,
02996                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02997 
02998     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a> (&amp;CurrentProfile,
02999                         KEY_READ | KEY_WRITE,
03000                         &amp;Attributes);
03001 
03002     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03003         CurrentProfile = 0;
03004         <span class="keywordflow">goto</span> Cleanup;
03005     }
03006 
03007     <span class="comment">//</span>
03008     <span class="comment">// We need to determine if Value was selected by exact match</span>
03009     <span class="comment">// (TRUE_MATCH) or because the profile selected was aliasable.</span>
03010     <span class="comment">//</span>
03011     <span class="comment">// If aliasable we need to manufacture another alias entry in the</span>
03012     <span class="comment">// alias table.</span>
03013     <span class="comment">//</span>
03014     <span class="comment">// If the profile information is there and not failed then we should</span>
03015     <span class="comment">// mark the Docking state information:</span>
03016     <span class="comment">// (DockID, SerialNumber, DockState, and Capabilities)</span>
03017     <span class="comment">//</span>
03018 
03019     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != LoaderBlock-&gt;Extension) {
03020         <a class="code" href="../../d3/d2/struct__LOADER__PARAMETER__EXTENSION.html">PLOADER_PARAMETER_EXTENSION</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a>;
03021         <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a> = LoaderBlock-&gt;Extension;
03022         <span class="keywordflow">switch</span> (<a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a>-&gt;Profile.Status) {
03023         <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/profiles_8h.html#a3">HW_PROFILE_STATUS_PRISTINE_MATCH</a>:
03024             <span class="comment">//</span>
03025             <span class="comment">// If the selected profile is pristine then we need to clone.</span>
03026             <span class="comment">//</span>
03027             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d2/hwprofil_8c.html#a7">CmpCloneHwProfile</a> (IDConfigDB,
03028                                         ParentOfProfile,
03029                                         CurrentProfile,
03030                                         HWProfile,
03031                                         <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a>-&gt;Profile.DockingState,
03032                                         &amp;CurrentProfile,
03033                                         &amp;HWProfile);
03034             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03035                 CurrentProfile = 0;
03036                 <span class="keywordflow">goto</span> Cleanup;
03037             }
03038 
03039             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;CurrentName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"CurrentConfig"</span>);
03040             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (IDConfigDB,
03041                                     &amp;CurrentName,
03042                                     0,
03043                                     REG_DWORD,
03044                                     &amp;HWProfile,
03045                                     <span class="keyword">sizeof</span> (HWProfile));
03046             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03047                 <span class="keywordflow">goto</span> Cleanup;
03048             }
03049 
03050             <span class="comment">//</span>
03051             <span class="comment">// Fall through</span>
03052             <span class="comment">//</span>
03053         <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/profiles_8h.html#a1">HW_PROFILE_STATUS_ALIAS_MATCH</a>:
03054             <span class="comment">//</span>
03055             <span class="comment">// Create the alias entry for this profile.</span>
03056             <span class="comment">//</span>
03057 
03058             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d3/cmsysini_8c.html#a45">CmpAddAliasEntry</a> (IDConfigDB,
03059                                        &amp;<a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a>-&gt;Profile,
03060                                        HWProfile);
03061 
03062 <span class="preprocessor">#if 0</span>
03063 <span class="preprocessor"></span>            <span class="comment">//</span>
03064             <span class="comment">// If we are booting in the undocked state, and creating a brand</span>
03065             <span class="comment">// new alias for this undocked state, we need to create an acpi</span>
03066             <span class="comment">// alias as well that points to this new profile.</span>
03067             <span class="comment">//</span>
03068             <span class="comment">// BUGBUG.</span>
03069             <span class="comment">// We are not checking for the case where we may manufacture more</span>
03070             <span class="comment">// than one bios alias entry for the undocked state.</span>
03071             <span class="comment">// If we do create more than one, then we will of course create</span>
03072             <span class="comment">// more than one acpi alias entry for the undocked state.</span>
03073             <span class="comment">//</span>
03074             <span class="comment">// Therefore we are assuming that when undocked the machine always</span>
03075             <span class="comment">// returns the same serial number.  (Not a bad assumption.)</span>
03076             <span class="comment">//</span>
03077             <span class="comment">// But we are also assuming that if we have more than one NT4 style</span>
03078             <span class="comment">// HW profile (which would allow the user to select such a profile</span>
03079             <span class="comment">// for each boot, and the user selected more than one for two</span>
03080             <span class="comment">// different undocked boots, then we will create two undocked acpi</span>
03081             <span class="comment">// aliases.  (Perhaps that is what we actually want.  I'm not sure,</span>
03082             <span class="comment">// but at least it's noted.</span>
03083             <span class="comment">//</span>
03084 
03085             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d7/profiles_8h.html#a6">HW_PROFILE_DOCKSTATE_UNDOCKED</a> == <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a>-&gt;Profile.DockingState) {
03086                 <a class="code" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html">PROFILE_ACPI_DOCKING_STATE</a> newDockState;
03087                 <span class="comment">//</span>
03088                 <span class="comment">// Note the definition of PROFILE_ACPI_DOCKING_STATE has a</span>
03089                 <span class="comment">// WCHAR array of length 1.</span>
03090                 <span class="comment">//</span>
03091 
03092 
03093                 newDockState.<a class="code" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html#o0">DockingState</a> = <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a>-&gt;Profile.DockingState;
03094                 newDockState.<a class="code" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html#o1">SerialLength</a> = 2;
03095                 newDockState.<a class="code" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html#o2">SerialNumber</a>[0] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
03096 
03097                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d2/hwprofil_8c.html#a5">CmpAddAcpiAliasEntry</a> (IDConfigDB,
03098                                                &amp;newDockState,
03099                                                HWProfile,
03100                                                UnicodeBuffer,
03101                                                <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>,
03102                                                <span class="keyword">sizeof</span> (<a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>),
03103                                                <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>); <span class="comment">// Prevent Duplication</span>
03104 
03105                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03106             }
03107 <span class="preprocessor">#endif</span>
03108 <span class="preprocessor"></span>
03109             <span class="comment">//</span>
03110             <span class="comment">// Fall through</span>
03111             <span class="comment">//</span>
03112         <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/profiles_8h.html#a2">HW_PROFILE_STATUS_TRUE_MATCH</a>:
03113             <span class="comment">//</span>
03114             <span class="comment">// Write DockID, SerialNumber, DockState, and Caps into the current</span>
03115             <span class="comment">// Hardware profile.</span>
03116             <span class="comment">//</span>
03117 
03118 <span class="preprocessor">#ifndef DISABLE_CLEAN_HW_PROFILE_INFO</span>
03119 <span class="preprocessor"></span>            <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;CurrentName, <a class="code" href="../../d1/d2/cmp_8h.html#a131">CM_HARDWARE_PROFILE_STR_DOCKING_STATE</a>);
03120             <a class="code" href="../../d7/d7/ntapi_8c.html#a16">NtDeleteValueKey</a> (CurrentProfile, &amp;CurrentName);
03121 
03122             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;CurrentName, <a class="code" href="../../d1/d2/cmp_8h.html#a132">CM_HARDWARE_PROFILE_STR_CAPABILITIES</a>);
03123             <a class="code" href="../../d7/d7/ntapi_8c.html#a16">NtDeleteValueKey</a> (CurrentProfile, &amp;CurrentName);
03124 
03125             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;CurrentName, <a class="code" href="../../d1/d2/cmp_8h.html#a133">CM_HARDWARE_PROFILE_STR_DOCKID</a>);
03126             <a class="code" href="../../d7/d7/ntapi_8c.html#a16">NtDeleteValueKey</a> (CurrentProfile, &amp;CurrentName);
03127 
03128             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;CurrentName, <a class="code" href="../../d1/d2/cmp_8h.html#a134">CM_HARDWARE_PROFILE_STR_SERIAL_NUMBER</a>);
03129             <a class="code" href="../../d7/d7/ntapi_8c.html#a16">NtDeleteValueKey</a> (CurrentProfile, &amp;CurrentName);
03130 <span class="preprocessor">#endif</span>
03131 <span class="preprocessor"></span>
03132             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;CurrentName,
03133                                   <a class="code" href="../../d1/d2/cmp_8h.html#a142">CM_HARDWARE_PROFILE_STR_CURRENT_DOCK_INFO</a>);
03134 
03135             InitializeObjectAttributes (&amp;Attributes,
03136                                         &amp;CurrentName,
03137                                         OBJ_CASE_INSENSITIVE,
03138                                         IDConfigDB,
03139                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03140 
03141             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a> (&amp;CurrentHandle,
03142                                   KEY_READ | KEY_WRITE,
03143                                   &amp;Attributes,
03144                                   0,
03145                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03146                                   REG_OPTION_VOLATILE,
03147                                   &amp;Disposition);
03148 
03149             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (STATUS_SUCCESS == <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03150 
03151             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d3/cmsysini_8c.html#a44">CmpAddDockingInfo</a> (CurrentHandle, &amp;<a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a>-&gt;Profile);
03152 
03153             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d7/profiles_8h.html#a6">HW_PROFILE_DOCKSTATE_UNDOCKED</a> == <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a>-&gt;Profile.DockingState) {
03154                 signalAcpiEvent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03155             }
03156 
03157             <span class="keywordflow">break</span>;
03158 
03159 
03160         <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/profiles_8h.html#a0">HW_PROFILE_STATUS_SUCCESS</a>:
03161         <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/profiles_8h.html#a4">HW_PROFILE_STATUS_FAILURE</a>:
03162             <span class="keywordflow">break</span>;
03163 
03164         <span class="keywordflow">default</span>:
03165             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a> (<span class="stringliteral">"Invalid Profile status state"</span>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03166         }
03167     }
03168 
03169     <span class="comment">//</span>
03170     <span class="comment">// Create the symbolic link.</span>
03171     <span class="comment">//</span>
03172     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;CurrentName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Hardware Profiles\\Current"</span>);
03173     InitializeObjectAttributes(&amp;Attributes,
03174                                &amp;CurrentName,
03175                                OBJ_CASE_INSENSITIVE,
03176                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03177                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03178     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(&amp;CurrentHandle,
03179                          KEY_CREATE_LINK,
03180                          &amp;Attributes,
03181                          0,
03182                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03183                          REG_OPTION_VOLATILE | REG_OPTION_CREATE_LINK,
03184                          &amp;Disposition);
03185     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03186         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
03187             KdPrint((<span class="stringliteral">"CM: CmpCreateControlSet: couldn't create Hardware Profile\\Current %08lx\n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03188         }
03189     } <span class="keywordflow">else</span> {
03190         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Disposition == REG_CREATED_NEW_KEY);
03191 
03192         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(AsciiBuffer, <span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Hardware Profiles\\%04d"</span>,HWProfile);
03193         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;AnsiString, AsciiBuffer);
03194         CurrentName.MaximumLength = <span class="keyword">sizeof</span>(UnicodeBuffer);
03195         CurrentName.Buffer = UnicodeBuffer;
03196         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;CurrentName,
03197                                               &amp;AnsiString,
03198                                               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03199         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (STATUS_SUCCESS == <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03200 
03201         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(CurrentHandle,
03202                                &amp;<a class="code" href="../../d8/d9/cmapi_8c.html#a6">CmSymbolicLinkValueName</a>,
03203                                0,
03204                                REG_LINK,
03205                                CurrentName.Buffer,
03206                                CurrentName.Length);
03207         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03208             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
03209                 KdPrint((<span class="stringliteral">"CM: CmpCreateControlSet: couldn't create symbolic link "</span>));
03210                 KdPrint((<span class="stringliteral">"to %wZ\n"</span>,&amp;CurrentName));
03211                 KdPrint((<span class="stringliteral">"    Status=%08lx\n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03212             }
03213         }
03214     }
03215 
03216     <span class="keywordflow">if</span> (signalAcpiEvent) {
03217         <span class="comment">//</span>
03218         <span class="comment">// We are booting in the undocked state.</span>
03219         <span class="comment">// This is interesting because our buddies in PnP cannot tell</span>
03220         <span class="comment">// us when we are booting without a dock.  They can only tell</span>
03221         <span class="comment">// us when they see a hot undock.</span>
03222         <span class="comment">//</span>
03223         <span class="comment">// Therefore in the interest of matching a boot undocked with</span>
03224         <span class="comment">// a hot undock, we need to simulate an acpi undock event.</span>
03225         <span class="comment">//</span>
03226 
03227         <a class="code" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html">PROFILE_ACPI_DOCKING_STATE</a> newDockState;
03228         HANDLE profile;
03229         BOOLEAN changed;
03230 
03231         newDockState.<a class="code" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html#o0">DockingState</a> = <a class="code" href="../../d6/d7/profiles_8h.html#a6">HW_PROFILE_DOCKSTATE_UNDOCKED</a>;
03232         newDockState.<a class="code" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html#o1">SerialLength</a> = 2;
03233         newDockState.<a class="code" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html#o2">SerialNumber</a>[0] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
03234 
03235         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d2/hwprofil_8c.html#a6">CmSetAcpiHwProfile</a> (&amp;newDockState,
03236                                      <a class="code" href="../../d1/d3/cmsysini_8c.html#a53">CmpHwprofileDefaultSelect</a>,
03237                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03238                                      &amp;profile,
03239                                      &amp;changed);
03240 
03241         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03242         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (profile);
03243     }
03244 
03245 
03246 Cleanup:
03247     <span class="keywordflow">if</span> (IDConfigDB) {
03248         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (IDConfigDB);
03249     }
03250     <span class="keywordflow">if</span> (CurrentProfile) {
03251         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (CurrentProfile);
03252     }
03253     <span class="keywordflow">if</span> (ParentOfProfile) {
03254         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (ParentOfProfile);
03255     }
03256 
03257     <span class="keywordflow">return</span>(STATUS_SUCCESS);
03258 }
03259 
03260 
03261 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03262"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a35">03262</a> <a class="code" href="../../d1/d3/cmsysini_8c.html#a35">CmpCloneControlSet</a>(
03263     VOID
03264     )
03265 
03266 <span class="comment">/*++</span>
03267 <span class="comment"></span>
03268 <span class="comment">Routine Description:</span>
03269 <span class="comment"></span>
03270 <span class="comment">    First, create a new hive, \registry\machine\clone, which will be</span>
03271 <span class="comment">    HIVE_VOLATILE.</span>
03272 <span class="comment"></span>
03273 <span class="comment">    Second, link \Registry\Machine\System\Clone to it.</span>
03274 <span class="comment"></span>
03275 <span class="comment">    Third, tree copy \Registry\Machine\System\CurrentControlSet into</span>
03276 <span class="comment">    \Registry\Machine\System\Clone (and thus into the clone hive.)</span>
03277 <span class="comment"></span>
03278 <span class="comment">    When the service controller is done with the clone hive, it can</span>
03279 <span class="comment">    simply NtUnloadKey it to free its storage.</span>
03280 <span class="comment"></span>
03281 <span class="comment">Arguments:</span>
03282 <span class="comment"></span>
03283 <span class="comment">    None.  \Registry\Machine\System\CurrentControlSet must already exist.</span>
03284 <span class="comment"></span>
03285 <span class="comment">Return Value:</span>
03286 <span class="comment"></span>
03287 <span class="comment">    NTSTATUS</span>
03288 <span class="comment"></span>
03289 <span class="comment">--*/</span>
03290 
03291 {
03292     UNICODE_STRING Current;
03293     UNICODE_STRING Clone;
03294     HANDLE CurrentHandle;
03295     HANDLE CloneHandle;
03296     OBJECT_ATTRIBUTES Attributes;
03297     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03298     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> CurrentKey;
03299     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> CloneKey;
03300     ULONG Disposition;
03301     PSECURITY_DESCRIPTOR Security;
03302     ULONG SecurityLength;
03303 
03304     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03305 
03306     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Current,
03307                          <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet"</span>);
03308     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Clone,
03309                          <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\Clone"</span>);
03310 
03311     InitializeObjectAttributes(&amp;Attributes,
03312                                &amp;Current,
03313                                OBJ_CASE_INSENSITIVE,
03314                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03315                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03316     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;CurrentHandle,
03317                        KEY_READ,
03318                        &amp;Attributes);
03319     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03320         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
03321             KdPrint((<span class="stringliteral">"CM: CmpCloneControlSet couldn't open CurrentControlSet %08lx\n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03322         }
03323         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03324     }
03325 
03326     <span class="comment">//</span>
03327     <span class="comment">// Get the security descriptor from the key so we can create the clone</span>
03328     <span class="comment">// tree with the correct ACL.</span>
03329     <span class="comment">//</span>
03330     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/obse_8c.html#a2">NtQuerySecurityObject</a>(CurrentHandle,
03331                                    DACL_SECURITY_INFORMATION,
03332                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03333                                    0,
03334                                    &amp;SecurityLength);
03335     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>==STATUS_BUFFER_TOO_SMALL) {
03336         Security=<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,SecurityLength);
03337         <span class="keywordflow">if</span> (Security!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03338             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/obse_8c.html#a2">NtQuerySecurityObject</a>(CurrentHandle,
03339                                            DACL_SECURITY_INFORMATION,
03340                                            Security,
03341                                            SecurityLength,
03342                                            &amp;SecurityLength);
03343             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03344                 <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
03345                     KdPrint((<span class="stringliteral">"CM: CmpCloneControlSet - NtQuerySecurityObject failed %08lx\n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03346                 }
03347                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Security);
03348                 Security=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03349             }
03350         }
03351     } <span class="keywordflow">else</span> {
03352         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
03353             KdPrint((<span class="stringliteral">"CM: CmpCloneControlSet - NtQuerySecurityObject returned %08lx\n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03354         }
03355         Security=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03356     }
03357 
03358     InitializeObjectAttributes(&amp;Attributes,
03359                                &amp;Clone,
03360                                OBJ_CASE_INSENSITIVE,
03361                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03362                                Security);
03363     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(&amp;CloneHandle,
03364                          KEY_READ | KEY_WRITE,
03365                          &amp;Attributes,
03366                          0,
03367                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03368                          REG_OPTION_VOLATILE,
03369                          &amp;Disposition);
03370     <span class="keywordflow">if</span> (Security!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03371         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Security);
03372     }
03373     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03374         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
03375             KdPrint((<span class="stringliteral">"CM: CmpCloneControlSet couldn't create Clone %08lx\n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03376         }
03377         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(CurrentHandle);
03378         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03379     }
03380 
03381     <span class="comment">//</span>
03382     <span class="comment">// Check to make sure the key was created.  If it already exists,</span>
03383     <span class="comment">// something is wrong.</span>
03384     <span class="comment">//</span>
03385     <span class="keywordflow">if</span> (Disposition != REG_CREATED_NEW_KEY) {
03386         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
03387         <span class="comment">//  KdPrint(("CM: CmpCloneControlSet: Clone tree already exists!\n"));</span>
03388         }
03389 
03390         <span class="comment">//</span>
03391         <span class="comment">// WARNNOTE:</span>
03392         <span class="comment">//      If somebody somehow managed to create a key in our way,</span>
03393         <span class="comment">//      they'll thwart last known good.  Tough luck.</span>
03394         <span class="comment">//      Claim it worked and go on.</span>
03395         <span class="comment">//</span>
03396         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
03397         <span class="keywordflow">goto</span> Exit;
03398     }
03399 
03400     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(CurrentHandle,
03401                                        KEY_READ,
03402                                        <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
03403                                        <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
03404                                        (PVOID *)(&amp;CurrentKey),
03405                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03406     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03407         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
03408             KdPrint((<span class="stringliteral">"CM: CmpCloneControlSet: couldn't reference CurrentHandle %08lx\n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03409         }
03410         <span class="keywordflow">goto</span> Exit;
03411     }
03412 
03413     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(CloneHandle,
03414                                        KEY_WRITE,
03415                                        <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
03416                                        <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
03417                                        (PVOID *)(&amp;CloneKey),
03418                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03419     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03420         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
03421             KdPrint((<span class="stringliteral">"CM: CmpCloneControlSet: couldn't reference CurrentHandle %08lx\n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03422         }
03423         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)CurrentKey);
03424         <span class="keywordflow">goto</span> Exit;
03425     }
03426 
03427     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
03428 
03429     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/cmp_8h.html#a118">CmpCopyTree</a>(CurrentKey-&gt;KeyControlBlock-&gt;KeyHive,
03430                     CurrentKey-&gt;KeyControlBlock-&gt;KeyCell,
03431                     CloneKey-&gt;KeyControlBlock-&gt;KeyHive,
03432                     CloneKey-&gt;KeyControlBlock-&gt;KeyCell)) {
03433         <span class="comment">//</span>
03434         <span class="comment">// Set the max subkey name property for the new target key.</span>
03435         <span class="comment">//</span>
03436         CloneKey-&gt;KeyControlBlock-&gt;KeyNode-&gt;MaxNameLen = CurrentKey-&gt;KeyControlBlock-&gt;KeyNode-&gt;MaxNameLen;
03437         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
03438     } <span class="keywordflow">else</span> {
03439         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
03440             KdPrint((<span class="stringliteral">"CM: CmpCloneControlSet: tree copy failed.\n"</span>));
03441         }
03442         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REGISTRY_CORRUPT;
03443     }
03444 
03445     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
03446 
03447     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)CurrentKey);
03448     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)CloneKey);
03449 
03450 Exit:
03451     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(CurrentHandle);
03452     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(CloneHandle);
03453     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03454 
03455 }
03456 
03457 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03458"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a54">03458</a> <a class="code" href="../../d1/d3/cmsysini_8c.html#a54">CmpSaveBootControlSet</a>(USHORT ControlSetNum)
03459 <span class="comment">/*++</span>
03460 <span class="comment"></span>
03461 <span class="comment">Routine Description:</span>
03462 <span class="comment"></span>
03463 <span class="comment">   This routine is responsible for saving the control set</span>
03464 <span class="comment">   used to accomplish the latest boot into a different control</span>
03465 <span class="comment">   set (presumably so that the different control set may be</span>
03466 <span class="comment">   marked as the LKG control set).</span>
03467 <span class="comment"></span>
03468 <span class="comment">   This routine is called from NtInitializeRegistry when</span>
03469 <span class="comment">   a boot is accepted via that routine.</span>
03470 <span class="comment"></span>
03471 <span class="comment">Arguments:</span>
03472 <span class="comment"></span>
03473 <span class="comment">   ControlSetNum - The number of the control set that will</span>
03474 <span class="comment">                   be used to save the boot control set.</span>
03475 <span class="comment"></span>
03476 <span class="comment">Return Value:</span>
03477 <span class="comment"></span>
03478 <span class="comment">   NTSTATUS result code from call, among the following:</span>
03479 <span class="comment"></span>
03480 <span class="comment">      STATUS_SUCCESS - everything worked perfectly</span>
03481 <span class="comment">      STATUS_REGISTRY_CORRUPT - could not save the boot control set,</span>
03482 <span class="comment">                                it is likely that the copy or sync</span>
03483 <span class="comment">                                operation used for this save failed</span>
03484 <span class="comment">                                and some part of the boot control</span>
03485 <span class="comment">                                set was not saved.</span>
03486 <span class="comment">--*/</span>
03487 {
03488    UNICODE_STRING SavedBoot, Boot;
03489    HANDLE BootHandle, SavedBootHandle;
03490    OBJECT_ATTRIBUTES Attributes;
03491    <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03492    <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> BootKey, SavedBootKey;
03493    ULONG Disposition;
03494    PSECURITY_DESCRIPTOR Security;
03495    ULONG SecurityLength;
03496    BOOLEAN CopyRet;
03497    WCHAR <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[128];
03498 
03499    <span class="comment">//</span>
03500    <span class="comment">// Figure out where the boot control set is</span>
03501    <span class="comment">//</span>
03502 
03503 <span class="preprocessor">#if CLONE_CONTROL_SET</span>
03504 <span class="preprocessor"></span>
03505    <span class="comment">//</span>
03506    <span class="comment">// If we have cloned the control set, then use the clone</span>
03507    <span class="comment">// since it is guaranteed to have an untouched copy of the</span>
03508    <span class="comment">// boot control set</span>
03509    <span class="comment">//</span>
03510 
03511    <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Boot,
03512                         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\Clone"</span>);
03513 
03514    InitializeObjectAttributes(&amp;Attributes,
03515                               &amp;Boot,
03516                               OBJ_CASE_INSENSITIVE,
03517                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03518                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03519 <span class="preprocessor">#else</span>
03520 <span class="preprocessor"></span>
03521    <span class="comment">//</span>
03522    <span class="comment">// If we are not using the clone, then just use the</span>
03523    <span class="comment">// current control set.</span>
03524    <span class="comment">//</span>
03525 
03526    InitializeObjectAttributes(&amp;Attributes,
03527                               &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a22">CmRegistryMachineSystemCurrentControlSet</a>,
03528                               OBJ_CASE_INSENSITIVE,
03529                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03530                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03531 <span class="preprocessor">#endif</span>
03532 <span class="preprocessor"></span>
03533    <span class="comment">//</span>
03534    <span class="comment">// Open the boot control set</span>
03535    <span class="comment">//</span>
03536 
03537    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;BootHandle,
03538                       KEY_READ,
03539                       &amp;Attributes);
03540 
03541 
03542    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03543 
03544    <span class="comment">//</span>
03545    <span class="comment">// We may be saving the boot control set into a brand new</span>
03546    <span class="comment">// tree that we will create. If this is true, then we will</span>
03547    <span class="comment">// need to create the root node of this tree below</span>
03548    <span class="comment">// and give it the right security descriptor. So, we fish</span>
03549    <span class="comment">// the security descriptor out of the root node of the</span>
03550    <span class="comment">// boot control set tree.</span>
03551    <span class="comment">//</span>
03552 
03553    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/obse_8c.html#a2">NtQuerySecurityObject</a>(BootHandle,
03554                                   DACL_SECURITY_INFORMATION,
03555                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03556                                   0,
03557                                   &amp;SecurityLength);
03558 
03559 
03560    <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>==STATUS_BUFFER_TOO_SMALL) {
03561 
03562       Security=<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,SecurityLength);
03563 
03564       <span class="keywordflow">if</span> (Security!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03565 
03566          <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/obse_8c.html#a2">NtQuerySecurityObject</a>(BootHandle,
03567                                         DACL_SECURITY_INFORMATION,
03568                                         Security,
03569                                         SecurityLength,
03570                                         &amp;SecurityLength);
03571 
03572 
03573          <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03574             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Security);
03575             Security=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03576          }
03577       }
03578 
03579    } <span class="keywordflow">else</span> {
03580       Security=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03581    }
03582 
03583    <span class="comment">//</span>
03584    <span class="comment">// Now, create the path of the control set we will be saving to</span>
03585    <span class="comment">//</span>
03586 
03587    swprintf(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\ControlSet%03d"</span>, ControlSetNum);
03588 
03589    <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;SavedBoot,
03590                         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
03591 
03592    <span class="comment">//</span>
03593    <span class="comment">// Open/Create the control set to which we are saving</span>
03594    <span class="comment">//</span>
03595 
03596    InitializeObjectAttributes(&amp;Attributes,
03597                               &amp;SavedBoot,
03598                               OBJ_CASE_INSENSITIVE,
03599                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03600                               Security);
03601 
03602    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(&amp;SavedBootHandle,
03603                         KEY_READ | KEY_WRITE,
03604                         &amp;Attributes,
03605                         0,
03606                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03607                         REG_OPTION_NON_VOLATILE,
03608                         &amp;Disposition);
03609 
03610 
03611    <span class="keywordflow">if</span> (Security) <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Security);
03612 
03613    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03614       <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(BootHandle);
03615       <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03616    }
03617 
03618    <span class="comment">//</span>
03619    <span class="comment">// Get the key objects for out two controls</span>
03620    <span class="comment">//</span>
03621 
03622    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(BootHandle,
03623                                       KEY_READ,
03624                                       <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
03625                                       <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
03626                                       (PVOID *)(&amp;BootKey),
03627                                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03628 
03629    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) <span class="keywordflow">goto</span> Exit;
03630 
03631    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(SavedBootHandle,
03632                                       KEY_WRITE,
03633                                       <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
03634                                       <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
03635                                       (PVOID *)(&amp;SavedBootKey),
03636                                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03637 
03638 
03639    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03640       <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)BootKey);
03641       <span class="keywordflow">goto</span> Exit;
03642    }
03643 
03644    <span class="comment">//</span>
03645    <span class="comment">// Lock the registry and do the actual saving</span>
03646    <span class="comment">//</span>
03647 
03648    <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
03649 
03650    <span class="keywordflow">if</span> (Disposition == REG_CREATED_NEW_KEY) {
03651 
03652       <span class="comment">//</span>
03653       <span class="comment">// If we are saving to a control set that we have just</span>
03654       <span class="comment">// created, it is most efficient to just copy</span>
03655       <span class="comment">// the boot control set tree into the new control set.</span>
03656       <span class="comment">//</span>
03657 
03658       <span class="comment">//</span>
03659       <span class="comment">// N.B. We copy the volatile keys only if we are using</span>
03660       <span class="comment">//      a clone and thus our boot control set tree is</span>
03661       <span class="comment">//      composed only of volatile keys.</span>
03662       <span class="comment">//</span>
03663 
03664       CopyRet = <a class="code" href="../../d1/d2/cmp_8h.html#a119">CmpCopyTreeEx</a>(BootKey-&gt;KeyControlBlock-&gt;KeyHive,
03665                               BootKey-&gt;KeyControlBlock-&gt;KeyCell,
03666                               SavedBootKey-&gt;KeyControlBlock-&gt;KeyHive,
03667                               SavedBootKey-&gt;KeyControlBlock-&gt;KeyCell,
03668                               <a class="code" href="../../d1/d2/cmp_8h.html#a67">CLONE_CONTROL_SET</a>);
03669 
03670         <span class="comment">//</span>
03671         <span class="comment">// Set the max subkey name property for the new target key.</span>
03672         <span class="comment">//</span>
03673         SavedBootKey-&gt;KeyControlBlock-&gt;KeyNode-&gt;MaxNameLen = BootKey-&gt;KeyControlBlock-&gt;KeyNode-&gt;MaxNameLen;
03674    } <span class="keywordflow">else</span> {
03675 
03676       <span class="comment">//</span>
03677       <span class="comment">// If we are saving to a control set that already exists</span>
03678       <span class="comment">// then its likely that this control set is nearly identical</span>
03679       <span class="comment">// to the boot control set (control sets don't change much</span>
03680       <span class="comment">// between boots).</span>
03681       <span class="comment">//</span>
03682       <span class="comment">// Furthermore, the control set we are saving to must be old</span>
03683       <span class="comment">// and hence has not been modified at all since it ceased</span>
03684       <span class="comment">// being a current control set.</span>
03685       <span class="comment">//</span>
03686       <span class="comment">// Thus, it is most efficient for us to simply synchronize</span>
03687       <span class="comment">// the target control set with the boot control set.</span>
03688       <span class="comment">//</span>
03689 
03690       <span class="comment">//</span>
03691       <span class="comment">// N.B. We sync the volatile keys only if we are using</span>
03692       <span class="comment">//      a clone for the same reasons as stated above.</span>
03693       <span class="comment">//</span>
03694 
03695       CopyRet = <a class="code" href="../../d1/d2/cmp_8h.html#a120">CmpSyncTrees</a>(BootKey-&gt;KeyControlBlock-&gt;KeyHive,
03696                              BootKey-&gt;KeyControlBlock-&gt;KeyCell,
03697                              SavedBootKey-&gt;KeyControlBlock-&gt;KeyHive,
03698                              SavedBootKey-&gt;KeyControlBlock-&gt;KeyCell,
03699                              <a class="code" href="../../d1/d2/cmp_8h.html#a67">CLONE_CONTROL_SET</a>);
03700    }
03701 
03702    <span class="comment">//</span>
03703    <span class="comment">// Check if the Copy/Sync succeeded and adjust our return code</span>
03704    <span class="comment">// accordingly.</span>
03705    <span class="comment">//</span>
03706 
03707    <span class="keywordflow">if</span> (CopyRet) {
03708       <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
03709    } <span class="keywordflow">else</span> {
03710       <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REGISTRY_CORRUPT;
03711    }
03712 
03713    <span class="comment">//</span>
03714    <span class="comment">// All done. Clean up.</span>
03715    <span class="comment">//</span>
03716 
03717    <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
03718 
03719    <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)BootKey);
03720    <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)SavedBootKey);
03721 
03722 Exit:
03723 
03724    <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(BootHandle);
03725    <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(SavedBootHandle);
03726 
03727 <span class="preprocessor">#if CLONE_CONTROL_SET</span>
03728 <span class="preprocessor"></span>
03729    <span class="comment">//</span>
03730    <span class="comment">// If we have been using a clone, then the clone is no longer</span>
03731    <span class="comment">// needed since we have saved its contents into a non-volatile</span>
03732    <span class="comment">// control set. Thus, we can just erase it.</span>
03733    <span class="comment">//</span>
03734 
03735    <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
03736    {
03737       <a class="code" href="../../d1/d3/cmsysini_8c.html#a55">CmpDeleteCloneTree</a>();
03738    }
03739 
03740 <span class="preprocessor">#endif</span>
03741 <span class="preprocessor"></span>
03742    <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03743 
03744 }
03745 
03746 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03747"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a55">03747</a> <a class="code" href="../../d1/d3/cmsysini_8c.html#a55">CmpDeleteCloneTree</a>()
03748 <span class="comment">/*++</span>
03749 <span class="comment"></span>
03750 <span class="comment">Routine Description:</span>
03751 <span class="comment"></span>
03752 <span class="comment">   Deletes the cloned CurrentControlSet by unloading the CLONE hive.</span>
03753 <span class="comment"></span>
03754 <span class="comment">Arguments:</span>
03755 <span class="comment"></span>
03756 <span class="comment">   NONE.</span>
03757 <span class="comment"></span>
03758 <span class="comment">Return Value:</span>
03759 <span class="comment"></span>
03760 <span class="comment">   NTSTATUS return from NtUnloadKey.</span>
03761 <span class="comment"></span>
03762 <span class="comment">--*/</span>
03763 {
03764    OBJECT_ATTRIBUTES   Obja;
03765 
03766    InitializeObjectAttributes(
03767        &amp;Obja,
03768        &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a33">CmRegistrySystemCloneName</a>,
03769        OBJ_CASE_INSENSITIVE,
03770        (HANDLE)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03771        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03772 
03773    <span class="keywordflow">return</span> <a class="code" href="../../d7/d7/ntapi_8c.html#a32">NtUnloadKey</a>(&amp;Obja);
03774 }
03775 
03776 
03777 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03778"></a><a class="code" href="../../d7/d9/cm_8h.html#a34">03778</a> <a class="code" href="../../d7/d9/cm_8h.html#a34">CmBootLastKnownGood</a>(
03779     ULONG ErrorLevel
03780     )
03781 
03782 <span class="comment">/*++</span>
03783 <span class="comment"></span>
03784 <span class="comment">Routine Description:</span>
03785 <span class="comment"></span>
03786 <span class="comment">    This function is called to indicate a failure during the boot process.</span>
03787 <span class="comment">    The actual result is based on the value of ErrorLevel:</span>
03788 <span class="comment"></span>
03789 <span class="comment">        IGNORE - Will return, boot should proceed</span>
03790 <span class="comment">        NORMAL - Will return, boot should proceed</span>
03791 <span class="comment"></span>
03792 <span class="comment">        SEVERE - If not booting LastKnownGood, will switch to LastKnownGood</span>
03793 <span class="comment">                 and reboot the system.</span>
03794 <span class="comment"></span>
03795 <span class="comment">                 If already booting LastKnownGood, will return.  Boot should</span>
03796 <span class="comment">                 proceed.</span>
03797 <span class="comment"></span>
03798 <span class="comment">        CRITICAL - If not booting LastKnownGood, will switch to LastKnownGood</span>
03799 <span class="comment">                 and reboot the system.</span>
03800 <span class="comment"></span>
03801 <span class="comment">                 If already booting LastKnownGood, will bugcheck.</span>
03802 <span class="comment"></span>
03803 <span class="comment">Arguments:</span>
03804 <span class="comment"></span>
03805 <span class="comment">    ErrorLevel - Supplies the severity level of the failure</span>
03806 <span class="comment"></span>
03807 <span class="comment">Return Value:</span>
03808 <span class="comment"></span>
03809 <span class="comment">    None.  If it returns, boot should proceed.  May cause the system to</span>
03810 <span class="comment">    reboot.</span>
03811 <span class="comment"></span>
03812 <span class="comment">--*/</span>
03813 
03814 {
03815     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03816 
03817     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03818 
03819     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/cmdat_8c.html#a68">CmFirstTime</a> != <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03820 
03821         <span class="comment">//</span>
03822         <span class="comment">// NtInitializeRegistry has been called, so handling</span>
03823         <span class="comment">// driver errors is not a task for ScReg.</span>
03824         <span class="comment">// Treat all errors as Normal</span>
03825         <span class="comment">//</span>
03826         <span class="keywordflow">return</span>;
03827     }
03828 
03829     <span class="keywordflow">switch</span> (ErrorLevel) {
03830         <span class="keywordflow">case</span> NormalError:
03831         <span class="keywordflow">case</span> IgnoreError:
03832             <span class="keywordflow">break</span>;
03833 
03834         <span class="keywordflow">case</span> SevereError:
03835             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d3/cmsysini_8c.html#a57">CmpIsLastKnownGoodBoot</a>()) {
03836                 <span class="keywordflow">break</span>;
03837             } <span class="keywordflow">else</span> {
03838                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d7/hal_8h.html#a168">HalSetEnvironmentVariable</a>(<span class="stringliteral">"LastKnownGood"</span>, <span class="stringliteral">"TRUE"</span>);
03839                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
03840                     <a class="code" href="../../d2/d7/hal_8h.html#a177">HalReturnToFirmware</a>(<a class="code" href="../../d4/d9/ke_8h.html#a411a244">HalRebootRoutine</a>);
03841                 }
03842             }
03843             <span class="keywordflow">break</span>;
03844 
03845         <span class="keywordflow">case</span> CriticalError:
03846             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d3/cmsysini_8c.html#a57">CmpIsLastKnownGoodBoot</a>()) {
03847                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CRITICAL_SERVICE_FAILED,5,9,0,0);
03848             } <span class="keywordflow">else</span> {
03849                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d7/hal_8h.html#a168">HalSetEnvironmentVariable</a>(<span class="stringliteral">"LastKnownGood"</span>, <span class="stringliteral">"TRUE"</span>);
03850                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
03851                     <a class="code" href="../../d2/d7/hal_8h.html#a177">HalReturnToFirmware</a>(<a class="code" href="../../d4/d9/ke_8h.html#a411a244">HalRebootRoutine</a>);
03852                 } <span class="keywordflow">else</span> {
03853                     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(SET_ENV_VAR_FAILED,5,10,0,0);
03854                 }
03855             }
03856             <span class="keywordflow">break</span>;
03857     }
03858     <span class="keywordflow">return</span>;
03859 }
03860 
03861 
03862 BOOLEAN
<a name="l03863"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a57">03863</a> <a class="code" href="../../d1/d3/cmsysini_8c.html#a57">CmpIsLastKnownGoodBoot</a>(
03864     VOID
03865     )
03866 
03867 <span class="comment">/*++</span>
03868 <span class="comment"></span>
03869 <span class="comment">Routine Description:</span>
03870 <span class="comment"></span>
03871 <span class="comment">    Determines whether the current system boot is a LastKnownGood boot or</span>
03872 <span class="comment">    not.  It does this by comparing the following two values:</span>
03873 <span class="comment"></span>
03874 <span class="comment">        \registry\machine\system\select:Current</span>
03875 <span class="comment">        \registry\machine\system\select:LastKnownGood</span>
03876 <span class="comment"></span>
03877 <span class="comment">    If both of these values refer to the same control set, and this control</span>
03878 <span class="comment">    set is different from:</span>
03879 <span class="comment"></span>
03880 <span class="comment">        \registry\machine\system\select:Default</span>
03881 <span class="comment"></span>
03882 <span class="comment">    we are booting LastKnownGood.</span>
03883 <span class="comment"></span>
03884 <span class="comment">Arguments:</span>
03885 <span class="comment"></span>
03886 <span class="comment">    None.</span>
03887 <span class="comment"></span>
03888 <span class="comment">Return Value:</span>
03889 <span class="comment"></span>
03890 <span class="comment">    TRUE  - Booting LastKnownGood</span>
03891 <span class="comment">    FALSE - Not booting LastKnownGood</span>
03892 <span class="comment"></span>
03893 <span class="comment">--*/</span>
03894 
03895 {
03896     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03897     ULONG Default;
03898     ULONG Current;
03899     ULONG LKG;
03900     RTL_QUERY_REGISTRY_TABLE QueryTable[] = {
03901         {<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,      RTL_QUERY_REGISTRY_DIRECT,
03902          <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Current"</span>, &amp;Current,
03903          REG_DWORD, (PVOID)&amp;Current, 0 },
03904         {<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,      RTL_QUERY_REGISTRY_DIRECT,
03905          <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"LastKnownGood"</span>, &amp;LKG,
03906          REG_DWORD, (PVOID)&amp;LKG, 0 },
03907         {<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,      RTL_QUERY_REGISTRY_DIRECT,
03908          <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Default"</span>, &amp;Default,
03909          REG_DWORD, (PVOID)&amp;Default, 0 },
03910         {<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,      0,
03911          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03912          REG_NONE, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0 }
03913     };
03914 
03915     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03916 
03917     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a19">RtlQueryRegistryValues</a>(RTL_REGISTRY_ABSOLUTE,
03918                                     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\Select"</span>,
03919                                     QueryTable,
03920                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03921                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03922     <span class="comment">//</span>
03923     <span class="comment">// If this failed, something is severely wrong.</span>
03924     <span class="comment">//</span>
03925 
03926     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03927     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03928         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
03929             KdPrint((<span class="stringliteral">"CmpIsLastKnownGoodBoot: RtlQueryRegistryValues "</span>));
03930             KdPrint((<span class="stringliteral">"failed, Status %08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03931         }
03932         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03933     }
03934 
03935     <span class="keywordflow">if</span> ((LKG == Current) &amp;&amp; (Current != Default)){
03936         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03937     } <span class="keywordflow">else</span> {
03938         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03939     }
03940 }
03941 
03942 
03943 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03944"></a><a class="code" href="../../d7/d9/cm_8h.html#a33">03944</a> <a class="code" href="../../d7/d9/cm_8h.html#a33">CmShutdownSystem</a>(
03945     VOID
03946     )
03947 <span class="comment">/*++</span>
03948 <span class="comment"></span>
03949 <span class="comment">Routine Description:</span>
03950 <span class="comment"></span>
03951 <span class="comment">    Shuts down the registry.</span>
03952 <span class="comment"></span>
03953 <span class="comment">    Call to CmpWorkerThread, which will call back</span>
03954 <span class="comment">    to CmpDoFlushAll();</span>
03955 <span class="comment"></span>
03956 <span class="comment">Arguments:</span>
03957 <span class="comment"></span>
03958 <span class="comment">    NONE</span>
03959 <span class="comment"></span>
03960 <span class="comment">Return Value:</span>
03961 <span class="comment"></span>
03962 <span class="comment">    NONE</span>
03963 <span class="comment"></span>
03964 <span class="comment">--*/</span>
03965 {
03966     <a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html">REGISTRY_COMMAND</a> <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>;
03967 
03968     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03969     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
03970 
03971     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a106">REG_CMD_SHUTDOWN</a>;
03972     <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;<a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>);
03973 
03974     <a class="code" href="../../d7/d0/cmdat2_8c.html#a13">HvShutdownComplete</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;      <span class="comment">// Tell HvSyncHive to ignore all</span>
03975                                     <span class="comment">// further requests</span>
03976 
03977     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
03978     <span class="keywordflow">return</span>;
03979 }
03980 
03981 
03982 BOOLEAN
<a name="l03983"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a32">03983</a> <a class="code" href="../../d1/d3/cmsysini_8c.html#a32">CmpLinkKeyToHive</a>(
03984     PWSTR   KeyPath,
03985     PWSTR   HivePath
03986     )
03987 
03988 <span class="comment">/*++</span>
03989 <span class="comment"></span>
03990 <span class="comment">Routine Description:</span>
03991 <span class="comment"></span>
03992 <span class="comment">    Creates a symbolic link at KeyPath that points to HivePath.</span>
03993 <span class="comment"></span>
03994 <span class="comment">Arguments:</span>
03995 <span class="comment"></span>
03996 <span class="comment">    KeyPath - pointer to unicode string with name of key</span>
03997 <span class="comment">              (e.g. L"\\Registry\\Machine\\Security\\SAM")</span>
03998 <span class="comment"></span>
03999 <span class="comment">    HivePath - pointer to unicode string with name of hive root</span>
04000 <span class="comment">               (e.g. L"\\Registry\\Machine\\SAM\\SAM")</span>
04001 <span class="comment"></span>
04002 <span class="comment">Return Value:</span>
04003 <span class="comment"></span>
04004 <span class="comment">    TRUE if links were successfully created, FALSE otherwise</span>
04005 <span class="comment"></span>
04006 <span class="comment">--*/</span>
04007 
04008 {
04009     UNICODE_STRING <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
04010     UNICODE_STRING LinkName;
04011     OBJECT_ATTRIBUTES Attributes;
04012     HANDLE LinkHandle;
04013     ULONG Disposition;
04014     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04015 
04016     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04017 
04018     <span class="comment">//</span>
04019     <span class="comment">// Create link for CLONE hive</span>
04020     <span class="comment">//</span>
04021 
04022     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>, <a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>);
04023     InitializeObjectAttributes(&amp;Attributes,
04024                                &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>,
04025                                OBJ_CASE_INSENSITIVE,
04026                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04027                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04028     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(&amp;LinkHandle,
04029                          KEY_CREATE_LINK,
04030                          &amp;Attributes,
04031                          0,
04032                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04033                          REG_OPTION_VOLATILE | REG_OPTION_CREATE_LINK,
04034                          &amp;Disposition);
04035     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
04036         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
04037             KdPrint((<span class="stringliteral">"CM: CmpLinkKeyToHive: couldn't create %S\n"</span>, &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>));
04038             KdPrint((<span class="stringliteral">"    Status = %08lx\n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
04039         }
04040         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04041     }
04042 
04043     <span class="comment">//</span>
04044     <span class="comment">// Check to make sure that the key was created, not just opened.  Since</span>
04045     <span class="comment">// this key is always created volatile, it should never be present in</span>
04046     <span class="comment">// the hive when we boot.</span>
04047     <span class="comment">//</span>
04048     <span class="keywordflow">if</span> (Disposition != REG_CREATED_NEW_KEY) {
04049         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
04050             KdPrint((<span class="stringliteral">"CM: CmpLinkKeyToHive: %S already exists!\n"</span>, &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>));
04051         }
04052 
04053         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(LinkHandle);
04054         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04055     }
04056 
04057     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;LinkName, HivePath);
04058     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(LinkHandle,
04059                            &amp;<a class="code" href="../../d8/d9/cmapi_8c.html#a6">CmSymbolicLinkValueName</a>,
04060                            0,
04061                            REG_LINK,
04062                            LinkName.Buffer,
04063                            LinkName.Length);
04064     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(LinkHandle);
04065     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
04066         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
04067             KdPrint((<span class="stringliteral">"CM: CmpLinkKeyToHive: couldn't create symbolic link for %S\n"</span>, HivePath));
04068         }
04069         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04070     }
04071 
04072     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04073 }
04074 
04075 
04076 BOOLEAN
<a name="l04077"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a33">04077</a> <a class="code" href="../../d1/d3/cmsysini_8c.html#a33">CmpValidateAlternate</a>(
04078     IN HANDLE FileHandle,
04079     IN <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> PrimaryHive
04080     )
04081 
04082 <span class="comment">/*++</span>
04083 <span class="comment"></span>
04084 <span class="comment">Routine Description:</span>
04085 <span class="comment"></span>
04086 <span class="comment">    Loads an alternate hive (SYSTEM.ALT) and verifies that it is a</span>
04087 <span class="comment">    valid hive file.</span>
04088 <span class="comment"></span>
04089 <span class="comment">Arguments:</span>
04090 <span class="comment"></span>
04091 <span class="comment">    FileHandle - Supplies a handle to the hive file.</span>
04092 <span class="comment"></span>
04093 <span class="comment">    PrimaryHive - Supplies the CMHIVE structure of the primary hive.</span>
04094 <span class="comment"></span>
04095 <span class="comment">Return Value:</span>
04096 <span class="comment"></span>
04097 <span class="comment">    TRUE - Hive is valid.</span>
04098 <span class="comment"></span>
04099 <span class="comment">    FALSE - Hive is corrupt or in transition.</span>
04100 <span class="comment"></span>
04101 <span class="comment">--*/</span>
04102 
04103 {
04104     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CmHive;
04105     BOOLEAN <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04106     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> Status2;
04107 
04108     Status2 = <a class="code" href="../../d1/d2/cmp_8h.html#a275">CmpInitializeHive</a>(&amp;CmHive,
04109                            <a class="code" href="../../d6/d0/hive_8h.html#a6">HINIT_FILE</a>,
04110                            0,
04111                            <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>,
04112                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04113                            FileHandle,
04114                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04115                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04116                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04117                            &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a34">CmpSystemFileName</a>    <span class="comment">// non system ALT will screw up</span>
04118                            );
04119     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status2)) {
04120         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
04121             KdPrint((<span class="stringliteral">"CmpValidateSecondary: SYSTEM.ALT is corrupt\n"</span>));
04122         }
04123         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04124     }
04125 
04126     <span class="comment">//</span>
04127     <span class="comment">// Compare the timestamps in the baseblock.  These must always be</span>
04128     <span class="comment">// equal to ensure that SYSTEM and SYSTEM.ALT are really the same</span>
04129     <span class="comment">// hive.</span>
04130     <span class="comment">//</span>
04131     <span class="keywordflow">if</span> (CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o3">TimeStamp</a>.QuadPart !=
04132         PrimaryHive-&gt;Hive.BaseBlock-&gt;TimeStamp.QuadPart) {
04133         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>,<a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
04134             KdPrint((<span class="stringliteral">"CmpValidateSecondary: timestamps don't match"</span>));
04135         }
04136         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04137     } <span class="keywordflow">else</span> {
04138         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04139     }
04140 
04141     <span class="comment">//</span>
04142     <span class="comment">// Hive is valid, free up everything we allocated.</span>
04143     <span class="comment">//</span>
04144     RemoveEntryList(&amp;CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o3">HiveList</a>);
04145     <a class="code" href="../../d2/d1/hivefree_8c.html#a0">HvFreeHive</a>(&amp;CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>);
04146     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a> );
04147     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a>);
04148     <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(CmHive, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>));
04149     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
04150 
04151 }
04152 
04153 
04154 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04155"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a31">04155</a> <a class="code" href="../../d1/d3/cmsysini_8c.html#a31">CmpCreatePerfKeys</a>(
04156     VOID
04157     )
04158 
04159 <span class="comment">/*++</span>
04160 <span class="comment"></span>
04161 <span class="comment">Routine Description:</span>
04162 <span class="comment"></span>
04163 <span class="comment">    Creates predefined keys for the performance text to support old apps on 1.0a</span>
04164 <span class="comment"></span>
04165 <span class="comment">Arguments:</span>
04166 <span class="comment"></span>
04167 <span class="comment">    None.</span>
04168 <span class="comment"></span>
04169 <span class="comment">Return Value:</span>
04170 <span class="comment"></span>
04171 <span class="comment">    None.</span>
04172 <span class="comment"></span>
04173 <span class="comment">--*/</span>
04174 
04175 {
04176     HANDLE Perflib;
04177     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04178     WCHAR LanguageId[4];
04179     OBJECT_ATTRIBUTES Attributes;
04180     UNICODE_STRING <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>;
04181     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Language;
04182     LONG i;
04183     WCHAR <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
04184     <span class="keyword">extern</span> PWCHAR <a class="code" href="../../d6/d0/cmdat_8c.html#a58">CmpRegistryPerflibString</a>;
04185 
04186     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>, <a class="code" href="../../d6/d0/cmdat_8c.html#a58">CmpRegistryPerflibString</a>);
04187 
04188     InitializeObjectAttributes(&amp;Attributes,
04189                                &amp;<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>,
04190                                OBJ_CASE_INSENSITIVE,
04191                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04192                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04193     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;Perflib,
04194                        KEY_WRITE,
04195                        &amp;Attributes);
04196     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
04197         <span class="keywordflow">return</span>;
04198     }
04199 
04200 
04201     <span class="comment">//</span>
04202     <span class="comment">// Always create the predefined keys for the english language</span>
04203     <span class="comment">//</span>
04204     <a class="code" href="../../d1/d3/cmsysini_8c.html#a30">CmpCreatePredefined</a>(Perflib,
04205                         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"009"</span>,
04206                         <a class="code" href="../../d1/d3/cmsysini_8c.html#a5">HKEY_PERFORMANCE_TEXT</a>);
04207 
04208     <span class="comment">//</span>
04209     <span class="comment">// If the default language is not english, create a predefined key for</span>
04210     <span class="comment">// that, too.</span>
04211     <span class="comment">//</span>
04212     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a58">PsDefaultSystemLocaleId</a> != 0x00000409) {
04213         Language = LANGIDFROMLCID(<a class="code" href="../../d1/d9/ps_8h.html#a58">PsDefaultSystemLocaleId</a>) &amp; 0xff;
04214         LanguageId[3] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
04215         <span class="keywordflow">for</span> (i=2;i&gt;=0;i--) {
04216             <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> = Language % 16;
04217             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>&gt;9) {
04218                 LanguageId[i]= <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>+<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'A'</span>-10;
04219             } <span class="keywordflow">else</span> {
04220                 LanguageId[i]= <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>+<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'0'</span>;
04221             }
04222             Language = Language &gt;&gt; 4;
04223         }
04224         <a class="code" href="../../d1/d3/cmsysini_8c.html#a30">CmpCreatePredefined</a>(Perflib,
04225                             LanguageId,
04226                             <a class="code" href="../../d1/d3/cmsysini_8c.html#a6">HKEY_PERFORMANCE_NLSTEXT</a>);
04227     }
04228 
04229 
04230 }
04231 
04232 
04233 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04234"></a><a class="code" href="../../d1/d3/cmsysini_8c.html#a30">04234</a> <a class="code" href="../../d1/d3/cmsysini_8c.html#a30">CmpCreatePredefined</a>(
04235     IN HANDLE Root,
04236     IN PWSTR KeyName,
04237     IN HANDLE PredefinedHandle
04238     )
04239 
04240 <span class="comment">/*++</span>
04241 <span class="comment"></span>
04242 <span class="comment">Routine Description:</span>
04243 <span class="comment"></span>
04244 <span class="comment">    Creates a special key that will always return the given predefined handle</span>
04245 <span class="comment">    instead of a real handle.</span>
04246 <span class="comment"></span>
04247 <span class="comment">Arguments:</span>
04248 <span class="comment"></span>
04249 <span class="comment">    Root - supplies the handle the keyname is relative to</span>
04250 <span class="comment"></span>
04251 <span class="comment">    KeyName - supplies the name of the key.</span>
04252 <span class="comment"></span>
04253 <span class="comment">    PredefinedHandle - supplies the predefined handle to be returned when this</span>
04254 <span class="comment">        key is opened.</span>
04255 <span class="comment"></span>
04256 <span class="comment">Return Value:</span>
04257 <span class="comment"></span>
04258 <span class="comment">    None.</span>
04259 <span class="comment"></span>
04260 <span class="comment">--*/</span>
04261 
04262 {
04263     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
04264     <a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">CM_PARSE_CONTEXT</a> ParseContext;
04265     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04266     UNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
04267     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
04268 
04269     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o1">Class</a>.Length = 0;
04270     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o1">Class</a>.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04271 
04272     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o0">TitleIndex</a> = 0;
04273     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o2">CreateOptions</a> = REG_OPTION_VOLATILE | <a class="code" href="../../d1/d2/cmp_8h.html#a112">REG_OPTION_PREDEF_HANDLE</a>;
04274     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o3">Disposition</a> = 0;
04275     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o4">CreateLink</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04276     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o6">PredefinedHandle</a> = PredefinedHandle;
04277 
04278     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>);
04279     InitializeObjectAttributes(&amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
04280                                &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>,
04281                                OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE,
04282                                Root,
04283                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04284 
04285     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>(&amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
04286                                 <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
04287                                 <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
04288                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04289                                 KEY_READ,
04290                                 (PVOID)&amp;ParseContext,
04291                                 &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
04292     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
04293 
04294     ZwClose(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
04295 
04296 }
04297 
04298 
04299 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:29 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
