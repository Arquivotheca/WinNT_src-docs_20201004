<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: psjob.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>psjob.c</h1><a href="../../d1/d1/psjob_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1997  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    psjob.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements bulk of the job object support</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Mark Lucovsky (markl) 22-May-1997</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d8/d1/psp_8h.html">psp.h</a>"</span>
00022 <span class="preprocessor">#include "winerror.h"</span>
00023 
00024 <span class="preprocessor">#pragma alloc_text(PAGE, PspJobDelete)</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, PspJobClose)</span>
00026 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtCreateJobObject)</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtOpenJobObject)</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtAssignProcessToJobObject)</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, PspAddProcessToJob)</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, PspRemoveProcessFromJob)</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, PspExitProcessFromJob)</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtQueryInformationJobObject)</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtSetInformationJobObject)</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, PspApplyJobLimitsToProcessSet)</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, PspApplyJobLimitsToProcess)</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtTerminateJobObject)</span>
00037 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, PspTerminateAllProcessesInJob)</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, PspFoldProcessAccountingIntoJob)</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, PspCaptureTokenFilter)</span>
00040 <span class="preprocessor"></span>
00041 <span class="comment">//</span>
00042 <span class="comment">// move to io.h</span>
<a name="l00043"></a><a class="code" href="../../d1/d1/psjob_8c.html#a0">00043</a> <span class="keyword">extern</span> <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="code" href="../../d3/d5/iodata_8c.html#a34">IoCompletionObjectType</a>;
00044 
00045 
00046 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00047 NTAPI
<a name="l00048"></a><a class="code" href="../../d1/d1/psjob_8c.html#a3">00048</a> <a class="code" href="../../d1/d1/psjob_8c.html#a3">NtCreateJobObject</a> (
00049     OUT PHANDLE JobHandle,
00050     IN ACCESS_MASK DesiredAccess,
00051     IN POBJECT_ATTRIBUTES ObjectAttributes OPTIONAL
00052     )
00053 {
00054 
00055     <a class="code" href="../../d0/d3/struct__EJOB.html">PEJOB</a> Job;
00056     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00057     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00058     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00059 
00060     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00061 
00062     <span class="comment">//</span>
00063     <span class="comment">// Establish an exception handler, probe the output handle address, and</span>
00064     <span class="comment">// attempt to create a job object. If the probe fails, then return the</span>
00065     <span class="comment">// exception code as the service status. Otherwise return the status value</span>
00066     <span class="comment">// returned by the object insertion routine.</span>
00067     <span class="comment">//</span>
00068 
00069     <span class="keywordflow">try</span> {
00070 
00071         <span class="comment">//</span>
00072         <span class="comment">// Get previous processor mode and probe output handle address if</span>
00073         <span class="comment">// necessary.</span>
00074         <span class="comment">//</span>
00075 
00076         PreviousMode = KeGetPreviousMode();
00077         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00078             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>(JobHandle);
00079             }
00080 
00081         <span class="comment">//</span>
00082         <span class="comment">// Allocate job object.</span>
00083         <span class="comment">//</span>
00084 
00085         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>(
00086                     PreviousMode,
00087                     <a class="code" href="../../d9/d8/ntos_8h.html#a4">PsJobType</a>,
00088                     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00089                     PreviousMode,
00090                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00091                     <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d3/struct__EJOB.html">EJOB</a>),
00092                     0,
00093                     0,
00094                     (PVOID *)&amp;Job
00095                     );
00096 
00097         <span class="comment">//</span>
00098         <span class="comment">// If the job object was successfully allocated, then initialize it</span>
00099         <span class="comment">// and attempt to insert the job object in the current</span>
00100         <span class="comment">// process' handle table.</span>
00101         <span class="comment">//</span>
00102 
00103         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00104 
00105             RtlZeroMemory(Job,<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d9/ps_8h.html#a45">EJOB</a>));
00106             InitializeListHead(&amp;Job-&gt;ProcessListHead);
00107             <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;Job-&gt;Event,NotificationEvent,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00108 
00109             <span class="comment">//</span>
00110             <span class="comment">// Job Object gets the SessionId of the Process creating the Job</span>
00111             <span class="comment">// We will use this sessionid to restrict the processes that can</span>
00112             <span class="comment">// be added to a job.</span>
00113             <span class="comment">//</span>
00114             Job-&gt;SessionId = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;SessionId;
00115 
00116             <span class="comment">//</span>
00117             <span class="comment">// Initialize the scheduling class for the Job</span>
00118             <span class="comment">//</span>
00119             Job-&gt;SchedulingClass = <a class="code" href="../../d8/d1/psp_8h.html#a9">PSP_DEFAULT_SCHEDULING_CLASSES</a>;
00120 
00121             <span class="comment">//</span>
00122             <span class="comment">// Insert Job on Job List</span>
00123             <span class="comment">//</span>
00124 
00125             ExAcquireFastMutex(&amp;<a class="code" href="../../d0/d1/psinit_8c.html#a25">PspJobListLock</a>);
00126             InsertTailList(&amp;<a class="code" href="../../d0/d1/psinit_8c.html#a26">PspJobList</a>,&amp;Job-&gt;JobLinks);
00127             ExReleaseFastMutex(&amp;<a class="code" href="../../d0/d1/psinit_8c.html#a25">PspJobListLock</a>);
00128 
00129             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a>(&amp;Job-&gt;JobLock);
00130             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00131 
00132                 <span class="comment">//</span>
00133                 <span class="comment">// Note that ExInitializeResource really can't fail and</span>
00134                 <span class="comment">// is hard coded to return success.</span>
00135                 <span class="comment">//</span>
00136                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Job);
00137 
00138                 }
00139             <span class="keywordflow">else</span> {
00140                 <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(&amp;Job-&gt;MemoryLimitsLock);
00141                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>(
00142                             (PVOID)Job,
00143                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00144                             DesiredAccess,
00145                             0,
00146                             (PVOID *)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00147                             &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>
00148                             );
00149                 }
00150 
00151             <span class="comment">//</span>
00152             <span class="comment">// If the job object was successfully inserted in the current</span>
00153             <span class="comment">// process' handle table, then attempt to write the job object</span>
00154             <span class="comment">// handle value. If the write attempt fails, then do not report</span>
00155             <span class="comment">// an error. When the caller attempts to access the handle value,</span>
00156             <span class="comment">// an access violation will occur.</span>
00157             <span class="comment">//</span>
00158 
00159             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00160                 <span class="keywordflow">try</span> {
00161                     *JobHandle = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00162                     }
00163                 except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00164                     }
00165                 }
00166             }
00167 
00168         <span class="comment">//</span>
00169         <span class="comment">// If an exception occurs during the probe of the output handle address,</span>
00170         <span class="comment">// then always handle the exception and return the exception code as the</span>
00171         <span class="comment">// status value.</span>
00172         <span class="comment">//</span>
00173 
00174         }
00175     except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00176         <span class="keywordflow">return</span> GetExceptionCode();
00177         }
00178 
00179     <span class="comment">//</span>
00180     <span class="comment">// Return service status.</span>
00181     <span class="comment">//</span>
00182 
00183     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00184 }
00185 
00186 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00187 NTAPI
<a name="l00188"></a><a class="code" href="../../d1/d1/psjob_8c.html#a4">00188</a> <a class="code" href="../../d1/d1/psjob_8c.html#a4">NtOpenJobObject</a>(
00189     OUT PHANDLE JobHandle,
00190     IN ACCESS_MASK DesiredAccess,
00191     IN POBJECT_ATTRIBUTES ObjectAttributes
00192     )
00193 {
00194     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00195     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00196     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00197 
00198     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00199 
00200     <span class="comment">//</span>
00201     <span class="comment">// Establish an exception handler, probe the output handle address, and</span>
00202     <span class="comment">// attempt to open the job object. If the probe fails, then return the</span>
00203     <span class="comment">// exception code as the service status. Otherwise return the status value</span>
00204     <span class="comment">// returned by the object open routine.</span>
00205     <span class="comment">//</span>
00206 
00207     <span class="keywordflow">try</span> {
00208 
00209         <span class="comment">//</span>
00210         <span class="comment">// Get previous processor mode and probe output handle address</span>
00211         <span class="comment">// if necessary.</span>
00212         <span class="comment">//</span>
00213 
00214         PreviousMode = KeGetPreviousMode();
00215         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00216             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>(JobHandle);
00217             }
00218 
00219         <span class="comment">//</span>
00220         <span class="comment">// Open handle to the event object with the specified desired access.</span>
00221         <span class="comment">//</span>
00222 
00223         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>(
00224                     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00225                     <a class="code" href="../../d9/d8/ntos_8h.html#a4">PsJobType</a>,
00226                     PreviousMode,
00227                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00228                     DesiredAccess,
00229                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00230                     &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>
00231                     );
00232 
00233         <span class="comment">//</span>
00234         <span class="comment">// If the open was successful, then attempt to write the job object</span>
00235         <span class="comment">// handle value. If the write attempt fails, then do not report an</span>
00236         <span class="comment">// error. When the caller attempts to access the handle value, an</span>
00237         <span class="comment">// access violation will occur.</span>
00238         <span class="comment">//</span>
00239 
00240         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00241             <span class="keywordflow">try</span> {
00242                 *JobHandle = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00243                 }
00244             except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00245                 }
00246             }
00247 
00248         }
00249 
00250     except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00251 
00252         <span class="comment">//</span>
00253         <span class="comment">// If an exception occurs during the probe of the output job handle,</span>
00254         <span class="comment">// then always handle the exception and return the exception code as the</span>
00255         <span class="comment">// status value.</span>
00256         <span class="comment">//</span>
00257 
00258         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00259         }
00260 
00261     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00262 }
00263 
00264 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00265 NTAPI
<a name="l00266"></a><a class="code" href="../../d1/d1/psjob_8c.html#a5">00266</a> <a class="code" href="../../d1/d1/psjob_8c.html#a5">NtAssignProcessToJobObject</a>(
00267     IN HANDLE JobHandle,
00268     IN HANDLE ProcessHandle
00269     )
00270 {
00271     <a class="code" href="../../d0/d3/struct__EJOB.html">PEJOB</a> Job;
00272     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00273     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00274     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00275     BOOLEAN <a class="code" href="../../d5/d7/devprop_8cpp.html#a5">IsAdmin</a> ;
00276 
00277     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00278 
00279     PreviousMode = KeGetPreviousMode();
00280 
00281     <span class="comment">//</span>
00282     <span class="comment">// Reference the process object, lock the process, test for already been assigned</span>
00283     <span class="comment">//</span>
00284 
00285     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00286                 ProcessHandle,
00287                 PROCESS_SET_QUOTA | PROCESS_TERMINATE,
00288                 <a class="code" href="../../d9/d8/ntos_8h.html#a2">PsProcessType</a>,
00289                 PreviousMode,
00290                 (PVOID *)&amp;Process,
00291                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00292                 );
00293     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00294         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00295         }
00296 
00297     <span class="comment">//</span>
00298     <span class="comment">// Quick Check for prior assignment</span>
00299     <span class="comment">//</span>
00300 
00301     <span class="keywordflow">if</span> ( Process-&gt;Job ) {
00302         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00303         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00304         }
00305 
00306 
00307     <span class="comment">//</span>
00308     <span class="comment">// Now reference the job object. Then we need to lock the process and check again</span>
00309     <span class="comment">//</span>
00310 
00311     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00312                 JobHandle,
00313                 JOB_OBJECT_ASSIGN_PROCESS,
00314                 <a class="code" href="../../d9/d8/ntos_8h.html#a4">PsJobType</a>,
00315                 PreviousMode,
00316                 (PVOID *)&amp;Job,
00317                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00318                 );
00319     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00320         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00321         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00322         }
00323 
00324     <span class="comment">//</span>
00325     <span class="comment">// We only allow a process that is running in the Job creator's hydra session</span>
00326     <span class="comment">// to be assigned to the job.</span>
00327     <span class="comment">//</span>
00328 
00329     <span class="keywordflow">if</span> ( Process-&gt;SessionId != Job-&gt;SessionId ) {
00330 
00331         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00332         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Job);
00333         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00334 
00335         }
00336 
00337 
00338     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/ps_2create_8c.html#a22">PsLockProcess</a>(Process,PreviousMode,<a class="code" href="../../d1/d9/ps_8h.html#a155a89">PsLockPollOnTimeout</a>);
00339     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) || Process-&gt;Job ) {
00340         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00341             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PROCESS_IS_TERMINATING;
00342             }
00343         <span class="keywordflow">else</span> {
00344             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
00345             <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
00346             }
00347         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00348         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Job);
00349         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00350         }
00351 
00352     <span class="comment">//</span>
00353     <span class="comment">// Security Rules:  If the job has no-admin set, and it is running</span>
00354     <span class="comment">// as admin, that's not allowed</span>
00355     <span class="comment">//</span>
00356 
00357     <span class="keywordflow">if</span> ( Job-&gt;SecurityLimitFlags &amp; JOB_OBJECT_SECURITY_NO_ADMIN )
00358     {
00359         <a class="code" href="../../d1/d9/ps_8h.html#a21">PsLockProcessSecurityFields</a>();
00360 
00361         <a class="code" href="../../d5/d7/devprop_8cpp.html#a5">IsAdmin</a> = <a class="code" href="../../d4/d3/token_8c.html#a4">SeTokenIsAdmin</a>( Process-&gt;Token );
00362 
00363         <a class="code" href="../../d1/d9/ps_8h.html#a22">PsFreeProcessSecurityFields</a>();
00364 
00365         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d7/devprop_8cpp.html#a5">IsAdmin</a> )
00366         {
00367             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED ;
00368 
00369             <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>( Process );
00370 
00371             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Process );
00372 
00373             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Job );
00374 
00375             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00376         }
00377 
00378     }
00379 
00380     <span class="comment">//</span>
00381     <span class="comment">// If the job has a token filter established,</span>
00382     <span class="comment">// use it to filter the</span>
00383 
00384     <span class="comment">//</span>
00385     <span class="comment">// ref the job for the process</span>
00386     <span class="comment">//</span>
00387 
00388     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(Job);
00389 
00390     Process-&gt;Job = Job;
00391 
00392     <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
00393 
00394     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d1/psp_8h.html#a91">PspAddProcessToJob</a>(Job,Process);
00395     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00396         Job-&gt;TotalTerminatedProcesses++;
00397         <a class="code" href="../../d8/d1/psp_8h.html#a94">PspTerminateProcess</a>(Process,ERROR_NOT_ENOUGH_QUOTA,<a class="code" href="../../d1/d9/ps_8h.html#a155a89">PsLockPollOnTimeout</a>);
00398         }
00399 
00400     <span class="comment">//</span>
00401     <span class="comment">// If the job has UI restrictions and this is a GUI process, call ntuser</span>
00402     <span class="comment">//</span>
00403     <span class="keywordflow">if</span> ( ( Job-&gt;UIRestrictionsClass != JOB_OBJECT_UILIMIT_NONE ) &amp;&amp;
00404          ( Process-&gt;Win32Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) ) {
00405         <a class="code" href="../../d4/d8/struct__WIN32__JOBCALLOUT__PARAMETERS.html">WIN32_JOBCALLOUT_PARAMETERS</a> Parms;
00406 
00407         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00408         <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;Job-&gt;JobLock, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00409 
00410         Parms.<a class="code" href="../../d4/d8/struct__WIN32__JOBCALLOUT__PARAMETERS.html#o0">Job</a> = Job;
00411         Parms.<a class="code" href="../../d4/d8/struct__WIN32__JOBCALLOUT__PARAMETERS.html#o1">CalloutType</a> = <a class="code" href="../../d1/d9/ps_8h.html#a156a94">PsW32JobCalloutAddProcess</a>;
00412         Parms.<a class="code" href="../../d4/d8/struct__WIN32__JOBCALLOUT__PARAMETERS.html#o2">Data</a> = Process-&gt;Win32Process;
00413         <a class="code" href="../../d2/d1/mm_8h.html#a197">MmDispatchWin32Callout</a>( <a class="code" href="../../d8/d1/psp_8h.html#a41">PspW32JobCallout</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, (PVOID)&amp;Parms, &amp;(Job-&gt;SessionId));
00414 
00415         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;Job-&gt;JobLock);
00416         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00417 
00418         }
00419 
00420     <span class="keywordflow">if</span> ( Job-&gt;SecurityLimitFlags &amp; JOB_OBJECT_SECURITY_ONLY_TOKEN )
00421     {
00422         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/psquery_8c.html#a17">PspSetPrimaryToken</a>( ProcessHandle, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, Job-&gt;Token );
00423 
00424         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) )
00425         {
00426             <span class="comment">//</span>
00427             <span class="comment">// What?</span>
00428             <span class="comment">//</span>
00429         }
00430     }
00431 
00432     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00433     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Job);
00434 
00435     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00436 }
00437 
00438 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00439"></a><a class="code" href="../../d8/d1/psp_8h.html#a91">00439</a> <a class="code" href="../../d8/d1/psp_8h.html#a91">PspAddProcessToJob</a>(
00440     <a class="code" href="../../d0/d3/struct__EJOB.html">PEJOB</a> Job,
00441     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
00442     )
00443 {
00444 
00445     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00446     SIZE_T MinWs,MaxWs;
00447 
00448     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00449 
00450 
00451     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00452     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o3">JobLock</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00453 
00454     InsertTailList(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o2">ProcessListHead</a>,&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o75">JobLinks</a>);
00455 
00456     <span class="comment">//</span>
00457     <span class="comment">// Update relevant ADD accounting info.</span>
00458     <span class="comment">//</span>
00459 
00460     Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o9">TotalProcesses</a>++;
00461     Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o10">ActiveProcesses</a>++;
00462 
00463 
00464 
00465     <span class="comment">//</span>
00466     <span class="comment">// Test for active process count exceeding limit</span>
00467     <span class="comment">//</span>
00468 
00469     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00470     <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp; JOB_OBJECT_LIMIT_ACTIVE_PROCESS &amp;&amp;
00471          Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o10">ActiveProcesses</a> &gt; Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o17">ActiveProcessLimit</a> ) {
00472 
00473         <a class="code" href="../../d1/d9/ps_8h.html#a8">PS_SET_CLEAR_BITS</a> (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a>,
00474                            <a class="code" href="../../d1/d9/ps_8h.html#a9">PS_JOB_STATUS_NOT_REALLY_ACTIVE</a> | <a class="code" href="../../d1/d9/ps_8h.html#a10">PS_JOB_STATUS_ACCOUNTING_FOLDED</a>,
00475                            <a class="code" href="../../d1/d9/ps_8h.html#a14">PS_JOB_STATUS_LAST_REPORT_MEMORY</a>);
00476 
00477         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o10">ActiveProcesses</a>--;
00478 
00479         <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a> ) {
00480             <a class="code" href="../../d5/d4/complete_8c.html#a6">IoSetIoCompletion</a>(
00481                 Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a>,
00482                 Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o26">CompletionKey</a>,
00483                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00484                 STATUS_SUCCESS,
00485                 JOB_OBJECT_MSG_ACTIVE_PROCESS_LIMIT,
00486                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00487                 );
00488             }
00489 
00490         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_QUOTA_EXCEEDED;
00491         }
00492 
00493     <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp; JOB_OBJECT_LIMIT_JOB_TIME &amp;&amp; <a class="code" href="../../d2/d8/eventobj_8c.html#a6">KeReadStateEvent</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o0">Event</a>) ) {
00494         <a class="code" href="../../d1/d9/ps_8h.html#a6">PS_SET_BITS</a> (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a>, <a class="code" href="../../d1/d9/ps_8h.html#a9">PS_JOB_STATUS_NOT_REALLY_ACTIVE</a> | <a class="code" href="../../d1/d9/ps_8h.html#a10">PS_JOB_STATUS_ACCOUNTING_FOLDED</a>);
00495 
00496         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o10">ActiveProcesses</a>--;
00497 
00498         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_QUOTA_EXCEEDED;
00499         }
00500 
00501     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS ) {
00502 
00503         <a class="code" href="../../d8/d1/psp_8h.html#a96">PspApplyJobLimitsToProcess</a>(Job,Process);
00504 
00505         <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a>
00506              &amp;&amp; Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a>
00507              &amp;&amp; !(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a9">PS_JOB_STATUS_NOT_REALLY_ACTIVE</a>)
00508              &amp;&amp; !(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a11">PS_JOB_STATUS_NEW_PROCESS_REPORTED</a>)) {
00509 
00510             <a class="code" href="../../d1/d9/ps_8h.html#a8">PS_SET_CLEAR_BITS</a> (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a>,
00511                                <a class="code" href="../../d1/d9/ps_8h.html#a11">PS_JOB_STATUS_NEW_PROCESS_REPORTED</a>,
00512                                <a class="code" href="../../d1/d9/ps_8h.html#a14">PS_JOB_STATUS_LAST_REPORT_MEMORY</a>);
00513 
00514             <a class="code" href="../../d5/d4/complete_8c.html#a6">IoSetIoCompletion</a>(
00515                 Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a>,
00516                 Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o26">CompletionKey</a>,
00517                 (PVOID)Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a>,
00518                 STATUS_SUCCESS,
00519                 JOB_OBJECT_MSG_NEW_PROCESS,
00520                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00521                 );
00522             }
00523 
00524         }
00525 
00526     <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp; JOB_OBJECT_LIMIT_WORKINGSET ) {
00527         MinWs = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o15">MinimumWorkingSetSize</a>;
00528         MaxWs = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o16">MaximumWorkingSetSize</a>;
00529         }
00530     <span class="keywordflow">else</span> {
00531         MinWs = 0;
00532         MaxWs = 0;
00533         }
00534 
00535     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o3">JobLock</a>);
00536 
00537     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00538 
00539     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS ) {
00540 
00541         <span class="keywordflow">if</span> ( MinWs != 0 &amp;&amp; MaxWs != 0 ) {
00542 
00543             <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00544             <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>(&amp;<a class="code" href="../../d8/d1/psp_8h.html#a20">PspWorkingSetChangeHead</a>.<a class="code" href="../../d7/d4/struct__JOB__WORKING__SET__CHANGE__HEAD.html#o1">Lock</a>);
00545 
00546             <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>);
00547             <a class="code" href="../../d4/d0/wslist_8c.html#a31">MmAdjustWorkingSetSize</a>(MinWs,MaxWs,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00548 
00549             <span class="comment">//</span>
00550             <span class="comment">// call MM to Enable hard workingset</span>
00551             <span class="comment">//</span>
00552 
00553             <a class="code" href="../../d4/d0/wslist_8c.html#a22">MmEnforceWorkingSetLimit</a>(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00554 
00555             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00556 
00557             <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>(&amp;<a class="code" href="../../d8/d1/psp_8h.html#a20">PspWorkingSetChangeHead</a>.<a class="code" href="../../d7/d4/struct__JOB__WORKING__SET__CHANGE__HEAD.html#o1">Lock</a>);
00558             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00559 
00560             }
00561         <span class="keywordflow">else</span> {
00562             <a class="code" href="../../d4/d0/wslist_8c.html#a22">MmEnforceWorkingSetLimit</a>(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00563             }
00564 
00565         <span class="keywordflow">if</span> ( !<a class="code" href="../../d4/d0/wslist_8c.html#a30">MmAssignProcessToJob</a>(Process) ) {
00566             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_QUOTA_EXCEEDED;
00567             }
00568 
00569         }
00570 
00571     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00572 }
00573 
00574 <span class="comment">//</span>
00575 <span class="comment">// Only callable from process delete routine !</span>
00576 <span class="comment">// This means that if the above fails, failure is termination of the process !</span>
00577 <span class="comment">//</span>
00578 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00579"></a><a class="code" href="../../d8/d1/psp_8h.html#a92">00579</a> <a class="code" href="../../d8/d1/psp_8h.html#a92">PspRemoveProcessFromJob</a>(
00580     <a class="code" href="../../d0/d3/struct__EJOB.html">PEJOB</a> Job,
00581     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
00582     )
00583 {
00584     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00585 
00586     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00587     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o3">JobLock</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00588 
00589     RemoveEntryList(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o75">JobLinks</a>);
00590 
00591     <span class="comment">//</span>
00592     <span class="comment">// Update REMOVE accounting info</span>
00593     <span class="comment">//</span>
00594 
00595 
00596     <span class="keywordflow">if</span> ( !(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a9">PS_JOB_STATUS_NOT_REALLY_ACTIVE</a>) ) {
00597         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o10">ActiveProcesses</a>--;
00598         <a class="code" href="../../d1/d9/ps_8h.html#a6">PS_SET_BITS</a> (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a>, <a class="code" href="../../d1/d9/ps_8h.html#a9">PS_JOB_STATUS_NOT_REALLY_ACTIVE</a>);
00599         }
00600 
00601     <a class="code" href="../../d8/d1/psp_8h.html#a98">PspFoldProcessAccountingIntoJob</a>(Job,Process);
00602 
00603     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o3">JobLock</a>);
00604     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00605 }
00606 
00607 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00608"></a><a class="code" href="../../d8/d1/psp_8h.html#a93">00608</a> <a class="code" href="../../d8/d1/psp_8h.html#a93">PspExitProcessFromJob</a>(
00609     <a class="code" href="../../d0/d3/struct__EJOB.html">PEJOB</a> Job,
00610     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
00611     )
00612 {
00613 
00614     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00615 
00616     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00617     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o3">JobLock</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00618 
00619     <span class="comment">//</span>
00620     <span class="comment">// Update REMOVE accounting info</span>
00621     <span class="comment">//</span>
00622 
00623 
00624     <span class="keywordflow">if</span> ( !(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a9">PS_JOB_STATUS_NOT_REALLY_ACTIVE</a>) ) {
00625         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o10">ActiveProcesses</a>--;
00626         <a class="code" href="../../d1/d9/ps_8h.html#a6">PS_SET_BITS</a> (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a>, <a class="code" href="../../d1/d9/ps_8h.html#a9">PS_JOB_STATUS_NOT_REALLY_ACTIVE</a>);
00627         }
00628 
00629     <a class="code" href="../../d8/d1/psp_8h.html#a98">PspFoldProcessAccountingIntoJob</a>(Job,Process);
00630 
00631     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o3">JobLock</a>);
00632     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00633 }
00634 
00635 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00636"></a><a class="code" href="../../d8/d1/psp_8h.html#a89">00636</a> <a class="code" href="../../d8/d1/psp_8h.html#a89">PspJobDelete</a>(
00637     IN PVOID Object
00638     )
00639 {
00640     <a class="code" href="../../d0/d3/struct__EJOB.html">PEJOB</a> Job;
00641     <a class="code" href="../../d4/d8/struct__WIN32__JOBCALLOUT__PARAMETERS.html">WIN32_JOBCALLOUT_PARAMETERS</a> Parms;
00642 
00643     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00644 
00645     Job = (<a class="code" href="../../d0/d3/struct__EJOB.html">PEJOB</a>) Object;
00646 
00647     <span class="comment">//</span>
00648     <span class="comment">// call ntuser to delete its job structure</span>
00649     <span class="comment">//</span>
00650 
00651     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00652     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o3">JobLock</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00653 
00654 
00655     Parms.<a class="code" href="../../d4/d8/struct__WIN32__JOBCALLOUT__PARAMETERS.html#o0">Job</a> = Job;
00656     Parms.<a class="code" href="../../d4/d8/struct__WIN32__JOBCALLOUT__PARAMETERS.html#o1">CalloutType</a> = <a class="code" href="../../d1/d9/ps_8h.html#a156a95">PsW32JobCalloutTerminate</a>;
00657     Parms.<a class="code" href="../../d4/d8/struct__WIN32__JOBCALLOUT__PARAMETERS.html#o2">Data</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00658     <a class="code" href="../../d2/d1/mm_8h.html#a197">MmDispatchWin32Callout</a>( <a class="code" href="../../d8/d1/psp_8h.html#a41">PspW32JobCallout</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, (PVOID)&amp;Parms, &amp;(Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o27">SessionId</a>));
00659 
00660     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o3">JobLock</a>);
00661     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00662 
00663     Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> = 0;
00664 
00665     <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a> ) {
00666         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a>);
00667         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00668         }
00669 
00670 
00671     <span class="comment">//</span>
00672     <span class="comment">// Remove Job on Job List</span>
00673     <span class="comment">//</span>
00674 
00675     ExAcquireFastMutex(&amp;<a class="code" href="../../d0/d1/psinit_8c.html#a25">PspJobListLock</a>);
00676     RemoveEntryList(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o1">JobLinks</a>);
00677     ExReleaseFastMutex(&amp;<a class="code" href="../../d0/d1/psinit_8c.html#a25">PspJobListLock</a>);
00678 
00679     <span class="comment">//</span>
00680     <span class="comment">// Free Security clutter:</span>
00681     <span class="comment">//</span>
00682 
00683     <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o22">Token</a> ) {
00684         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o22">Token</a> );
00685         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o22">Token</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
00686         }
00687 
00688     <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a> ) {
00689         <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o1">CapturedSids</a> ) {
00690             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o1">CapturedSids</a> );
00691             }
00692 
00693         <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o7">CapturedPrivileges</a> ) {
00694             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o7">CapturedPrivileges</a> );
00695             }
00696 
00697         <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o4">CapturedGroups</a> ) {
00698             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o4">CapturedGroups</a> );
00699             }
00700 
00701         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a> );
00702 
00703         }
00704 
00705     <a class="code" href="../../d5/d8/ex_8h.html#a73">ExDeleteResource</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o3">JobLock</a>);
00706 }
00707 
00708 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00709"></a><a class="code" href="../../d8/d1/psp_8h.html#a90">00709</a> <a class="code" href="../../d8/d1/psp_8h.html#a90">PspJobClose</a> (
00710     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00711     IN PVOID Object,
00712     IN ACCESS_MASK GrantedAccess,
00713     IN ULONG ProcessHandleCount,
00714     IN ULONG SystemHandleCount
00715     )
00716 <span class="comment">/*++</span>
00717 <span class="comment"></span>
00718 <span class="comment">Routine Description:</span>
00719 <span class="comment"></span>
00720 <span class="comment">    Called by the object manager when a handle is closed to the object.</span>
00721 <span class="comment"></span>
00722 <span class="comment">Arguments:</span>
00723 <span class="comment"></span>
00724 <span class="comment">    Process - Process doing the close</span>
00725 <span class="comment">    Object - Job object being closed</span>
00726 <span class="comment">    GrantedAccess - Access ranted for this handle</span>
00727 <span class="comment">    ProcessHandleCount - Unused and unmaintained by OB</span>
00728 <span class="comment">    SystemHandleCount - Current handle count for this object</span>
00729 <span class="comment"></span>
00730 <span class="comment">Return Value:</span>
00731 <span class="comment"></span>
00732 <span class="comment">    None.</span>
00733 <span class="comment"></span>
00734 <span class="comment">--*/</span>
00735 {
00736     <a class="code" href="../../d0/d3/struct__EJOB.html">PEJOB</a> Job = Object;
00737     PVOID Port;
00738 
00739     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
00740     <span class="comment">//</span>
00741     <span class="comment">// If this isn't the last handle then do nothing.</span>
00742     <span class="comment">//</span>
00743     <span class="keywordflow">if</span> (SystemHandleCount &gt; 1) {
00744         <span class="keywordflow">return</span>;
00745     }
00746 
00747     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00748     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o3">JobLock</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00749     <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o41">MemoryLimitsLock</a>);
00750 
00751     <span class="comment">//</span>
00752     <span class="comment">// Release the completion port</span>
00753     <span class="comment">//</span>
00754     Port = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a>;
00755     Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00756     
00757 
00758     <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o41">MemoryLimitsLock</a>);
00759     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o3">JobLock</a>);
00760     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00761 
00762     <span class="keywordflow">if</span> (Port != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00763         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Port);
00764     }
00765 }
00766 
<a name="l00767"></a><a class="code" href="../../d1/d1/psjob_8c.html#a1">00767</a> ULONG <a class="code" href="../../d1/d1/psjob_8c.html#a1">PspJobInfoLengths</a>[] = {
00768     <span class="keyword">sizeof</span>(JOBOBJECT_BASIC_ACCOUNTING_INFORMATION),         <span class="comment">// JobObjectBasicAccountingInformation</span>
00769     <span class="keyword">sizeof</span>(JOBOBJECT_BASIC_LIMIT_INFORMATION),              <span class="comment">// JobObjectBasicLimitInformation</span>
00770     <span class="keyword">sizeof</span>(JOBOBJECT_BASIC_PROCESS_ID_LIST),                <span class="comment">// JobObjectBasicProcessIdList</span>
00771     <span class="keyword">sizeof</span>(JOBOBJECT_BASIC_UI_RESTRICTIONS),                <span class="comment">// JobObjectBasicUIRestrictions</span>
00772     <span class="keyword">sizeof</span>(JOBOBJECT_SECURITY_LIMIT_INFORMATION),           <span class="comment">// JobObjectSecurityLimitInformation</span>
00773     <span class="keyword">sizeof</span>(JOBOBJECT_END_OF_JOB_TIME_INFORMATION),          <span class="comment">// JobObjectEndOfJobTimeInformation</span>
00774     <span class="keyword">sizeof</span>(JOBOBJECT_ASSOCIATE_COMPLETION_PORT),            <span class="comment">// JobObjectAssociateCompletionPortInformation</span>
00775     <span class="keyword">sizeof</span>(JOBOBJECT_BASIC_AND_IO_ACCOUNTING_INFORMATION),  <span class="comment">// JobObjectBasicAndIoAccountingInformation</span>
00776     <span class="keyword">sizeof</span>(JOBOBJECT_EXTENDED_LIMIT_INFORMATION),           <span class="comment">// JobObjectExtendedLimitInformation</span>
00777     0
00778     };
00779 
00780 <span class="preprocessor">#if defined(_ALPHA_)</span>
00781 <span class="preprocessor"></span>
00782 <span class="comment">//</span>
00783 <span class="comment">// Alpha's run with aligned stacks, so we can require quad alignment</span>
00784 <span class="comment">//</span>
00785 
00786 ULONG <a class="code" href="../../d1/d1/psjob_8c.html#a2">PspJobInfoAlign</a>[] = {
00787     <span class="keyword">sizeof</span>(LARGE_INTEGER),                          <span class="comment">// JobObjectBasicAccountingInformation</span>
00788     <span class="keyword">sizeof</span>(LARGE_INTEGER),                          <span class="comment">// JobObjectBasicLimitInformation</span>
00789     <span class="keyword">sizeof</span>(ULONG),                                  <span class="comment">// JobObjectBasicProcessIdList</span>
00790     <span class="keyword">sizeof</span>(ULONG),                                  <span class="comment">// JobObjectBasicUIRestrictions</span>
00791     <span class="keyword">sizeof</span>(ULONG),                                  <span class="comment">// JobObjectSecurityLimitInformation</span>
00792     <span class="keyword">sizeof</span>(ULONG),                                  <span class="comment">// JobObjectEndOfJobTimeInformation</span>
00793     <span class="keyword">sizeof</span>(PVOID),                                  <span class="comment">// JobObjectAssociateCompletionPortInformation</span>
00794     <span class="keyword">sizeof</span>(LARGE_INTEGER),                          <span class="comment">// JobObjectBasicAndIoAccountingInformation</span>
00795     <span class="keyword">sizeof</span>(LARGE_INTEGER),                          <span class="comment">// JobObjectExtendedLimitInformation</span>
00796     0
00797     };
00798 <span class="preprocessor">#else</span>
<a name="l00799"></a><a class="code" href="../../d1/d1/psjob_8c.html#a2">00799</a> <span class="preprocessor"></span>ULONG <a class="code" href="../../d1/d1/psjob_8c.html#a2">PspJobInfoAlign</a>[] = {
00800     <span class="keyword">sizeof</span>(ULONG),                                  <span class="comment">// JobObjectBasicAccountingInformation</span>
00801     <span class="keyword">sizeof</span>(ULONG),                                  <span class="comment">// JobObjectBasicLimitInformation</span>
00802     <span class="keyword">sizeof</span>(ULONG),                                  <span class="comment">// JobObjectBasicProcessIdList</span>
00803     <span class="keyword">sizeof</span>(ULONG),                                  <span class="comment">// JobObjectBasicUIRestrictions</span>
00804     <span class="keyword">sizeof</span>(ULONG),                                  <span class="comment">// JobObjectSecurityLimitInformation</span>
00805     <span class="keyword">sizeof</span>(ULONG),                                  <span class="comment">// JobObjectEndOfJobTimeInformation</span>
00806     <span class="keyword">sizeof</span>(PVOID),                                  <span class="comment">// JobObjectAssociateCompletionPortInformation</span>
00807     <span class="keyword">sizeof</span>(ULONG),                                  <span class="comment">// JobObjectBasicAndIoAccountingInformation</span>
00808     <span class="keyword">sizeof</span>(ULONG),                                  <span class="comment">// JobObjectExtendedLimitInformation</span>
00809     0
00810     };
00811 <span class="preprocessor">#endif // _ALPHA_</span>
00812 <span class="preprocessor"></span>
00813 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00814"></a><a class="code" href="../../d1/d1/psjob_8c.html#a11">00814</a> <a class="code" href="../../d1/d1/psjob_8c.html#a11">NtQueryInformationJobObject</a>(
00815     IN HANDLE JobHandle,
00816     IN JOBOBJECTINFOCLASS JobObjectInformationClass,
00817     OUT PVOID JobObjectInformation,
00818     IN ULONG JobObjectInformationLength,
00819     OUT PULONG ReturnLength OPTIONAL
00820     )
00821 {
00822     <a class="code" href="../../d0/d3/struct__EJOB.html">PEJOB</a> Job;
00823     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00824     JOBOBJECT_BASIC_AND_IO_ACCOUNTING_INFORMATION AccountingInfo;
00825     JOBOBJECT_BASIC_LIMIT_INFORMATION BasicLimitInfo;
00826     JOBOBJECT_EXTENDED_LIMIT_INFORMATION ExtendedLimitInfo;
00827     JOBOBJECT_BASIC_UI_RESTRICTIONS BasicUIRestrictions;
00828     JOBOBJECT_SECURITY_LIMIT_INFORMATION SecurityLimitInfo ;
00829     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00830     ULONG RequiredLength, RequiredAlign, ActualReturnLength;
00831     PVOID ReturnData;
00832     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00833     PLIST_ENTRY Next;
00834     LARGE_INTEGER UserTime, KernelTime;
00835     PULONG_PTR NextProcessIdSlot;
00836     ULONG WorkingLength;
00837     PJOBOBJECT_BASIC_PROCESS_ID_LIST IdList;
00838     PUCHAR CurrentOffset ;
00839     PTOKEN_GROUPS WorkingGroup ;
00840     PTOKEN_PRIVILEGES WorkingPrivs ;
00841     ULONG RemainingSidBuffer ;
00842     PSID TargetSidBuffer ;
00843     PSID RemainingSid ;
00844     BOOLEAN AlreadyCopied ;
00845 
00846     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00847 
00848     <span class="comment">//</span>
00849     <span class="comment">// Get previous processor mode and probe output argument if necessary.</span>
00850     <span class="comment">//</span>
00851 
00852     <span class="keywordflow">if</span> ( JobObjectInformationClass &gt;= MaxJobObjectInfoClass || JobObjectInformationClass &lt;= 0) {
00853         <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
00854         }
00855 
00856     RequiredLength = <a class="code" href="../../d1/d1/psjob_8c.html#a1">PspJobInfoLengths</a>[JobObjectInformationClass-1];
00857     RequiredAlign = <a class="code" href="../../d1/d1/psjob_8c.html#a2">PspJobInfoAlign</a>[JobObjectInformationClass-1];
00858     ActualReturnLength = RequiredLength;
00859 
00860     <span class="keywordflow">if</span> ( JobObjectInformationLength != RequiredLength ) {
00861 
00862         <span class="comment">//</span>
00863         <span class="comment">// BasicProcessIdList is variable length, so make sure header is</span>
00864         <span class="comment">// ok. Can not enforce an exact match !  Security Limits can be</span>
00865         <span class="comment">// as well, due to the token groups and privs</span>
00866         <span class="comment">//</span>
00867         <span class="keywordflow">if</span> ( ( JobObjectInformationClass == JobObjectBasicProcessIdList ) ||
00868              ( JobObjectInformationClass == JobObjectSecurityLimitInformation ) ) {
00869             <span class="keywordflow">if</span> ( JobObjectInformationLength &lt; RequiredLength ) {
00870                 <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00871                 }
00872             <span class="keywordflow">else</span> {
00873                 RequiredLength = JobObjectInformationLength;
00874                 }
00875             }
00876         <span class="keywordflow">else</span> {
00877             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00878             }
00879         }
00880 
00881 
00882     PreviousMode = KeGetPreviousMode();
00883     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00884         <span class="keywordflow">try</span> {
00885             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
00886                 JobObjectInformation,
00887                 JobObjectInformationLength,
00888                 RequiredAlign
00889                 );
00890             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength)) {
00891                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(ReturnLength);
00892                 }
00893             }
00894         except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00895             <span class="keywordflow">return</span> GetExceptionCode();
00896             }
00897         }
00898 
00899     <span class="comment">//</span>
00900     <span class="comment">// reference the job</span>
00901     <span class="comment">//</span>
00902 
00903     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(JobHandle) ) {
00904         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00905                 JobHandle,
00906                 JOB_OBJECT_QUERY,
00907                 <a class="code" href="../../d9/d8/ntos_8h.html#a4">PsJobType</a>,
00908                 PreviousMode,
00909                 (PVOID *)&amp;Job,
00910                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00911                 );
00912         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00913             <span class="keywordflow">return</span> st;
00914             }
00915         }
00916     <span class="keywordflow">else</span> {
00917 
00918         <span class="comment">//</span>
00919         <span class="comment">// if the current process has a job, NULL means the job of the</span>
00920         <span class="comment">// current process. Query is always allowed for this case</span>
00921         <span class="comment">//</span>
00922 
00923         Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00924 
00925         <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a> ) {
00926             Job = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>;
00927             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(Job);
00928             }
00929         <span class="keywordflow">else</span> {
00930             <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00931             }
00932         }
00933 
00934     AlreadyCopied = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
00935 
00936     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00937     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o3">JobLock</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00938 
00939     <span class="comment">//</span>
00940     <span class="comment">// Check argument validity.</span>
00941     <span class="comment">//</span>
00942 
00943     <span class="keywordflow">switch</span> ( JobObjectInformationClass ) {
00944 
00945     <span class="keywordflow">case</span> JobObjectBasicAccountingInformation:
00946     <span class="keywordflow">case</span> JobObjectBasicAndIoAccountingInformation:
00947 
00948         <span class="comment">//</span>
00949         <span class="comment">// These two cases are identical, EXCEPT that with AndIo, IO information</span>
00950         <span class="comment">// is returned as well, but the first part of the local is identical to</span>
00951         <span class="comment">// basic, and the shorter return'd data length chops what we return.</span>
00952         <span class="comment">//</span>
00953 
00954         RtlZeroMemory(&amp;AccountingInfo.IoInfo,<span class="keyword">sizeof</span>(AccountingInfo.IoInfo));
00955 
00956         AccountingInfo.BasicInfo.TotalUserTime = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o4">TotalUserTime</a>;
00957         AccountingInfo.BasicInfo.TotalKernelTime = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o5">TotalKernelTime</a>;
00958         AccountingInfo.BasicInfo.ThisPeriodTotalUserTime = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o6">ThisPeriodTotalUserTime</a>;
00959         AccountingInfo.BasicInfo.ThisPeriodTotalKernelTime = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o7">ThisPeriodTotalKernelTime</a>;
00960         AccountingInfo.BasicInfo.TotalPageFaultCount = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o8">TotalPageFaultCount</a>;
00961 
00962         AccountingInfo.BasicInfo.TotalProcesses = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o9">TotalProcesses</a>;
00963         AccountingInfo.BasicInfo.ActiveProcesses = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o10">ActiveProcesses</a>;
00964         AccountingInfo.BasicInfo.TotalTerminatedProcesses = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o11">TotalTerminatedProcesses</a>;
00965 
00966         AccountingInfo.IoInfo.ReadOperationCount = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o29">ReadOperationCount</a>;
00967         AccountingInfo.IoInfo.WriteOperationCount = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o30">WriteOperationCount</a>;
00968         AccountingInfo.IoInfo.OtherOperationCount = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o31">OtherOperationCount</a>;
00969         AccountingInfo.IoInfo.ReadTransferCount = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o32">ReadTransferCount</a>;
00970         AccountingInfo.IoInfo.WriteTransferCount = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o33">WriteTransferCount</a>;
00971         AccountingInfo.IoInfo.OtherTransferCount = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o34">OtherTransferCount</a>;
00972 
00973         <span class="comment">//</span>
00974         <span class="comment">// Add in the time and page faults for each process</span>
00975         <span class="comment">//</span>
00976 
00977         Next = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o2">ProcessListHead</a>.Flink;
00978 
00979         <span class="keywordflow">while</span> ( Next != &amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o2">ProcessListHead</a>) {
00980 
00981             Process = (<a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>)(CONTAINING_RECORD(Next,<a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>,JobLinks));
00982             <span class="keywordflow">if</span> ( !(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a10">PS_JOB_STATUS_ACCOUNTING_FOLDED</a>) ) {
00983 
00984                 UserTime.QuadPart = UInt32x32To64(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o5">UserTime</a>,<a class="code" href="../../d4/d9/ke_8h.html#a131">KeMaximumIncrement</a>);
00985                 KernelTime.QuadPart = UInt32x32To64(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o4">KernelTime</a>,<a class="code" href="../../d4/d9/ke_8h.html#a131">KeMaximumIncrement</a>);
00986 
00987                 AccountingInfo.BasicInfo.TotalUserTime.QuadPart += UserTime.QuadPart;
00988                 AccountingInfo.BasicInfo.TotalKernelTime.QuadPart += KernelTime.QuadPart;
00989                 AccountingInfo.BasicInfo.ThisPeriodTotalUserTime.QuadPart += UserTime.QuadPart;
00990                 AccountingInfo.BasicInfo.ThisPeriodTotalKernelTime.QuadPart += KernelTime.QuadPart;
00991                 AccountingInfo.BasicInfo.TotalPageFaultCount += Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a>;
00992 
00993                 AccountingInfo.IoInfo.ReadOperationCount += Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o79">ReadOperationCount</a>.QuadPart;
00994                 AccountingInfo.IoInfo.WriteOperationCount += Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o80">WriteOperationCount</a>.QuadPart;
00995                 AccountingInfo.IoInfo.OtherOperationCount += Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o81">OtherOperationCount</a>.QuadPart;
00996                 AccountingInfo.IoInfo.ReadTransferCount += Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o82">ReadTransferCount</a>.QuadPart;
00997                 AccountingInfo.IoInfo.WriteTransferCount += Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o83">WriteTransferCount</a>.QuadPart;
00998                 AccountingInfo.IoInfo.OtherTransferCount += Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o84">OtherTransferCount</a>.QuadPart;
00999                 }
01000             Next = Next-&gt;Flink;
01001             }
01002 
01003         ReturnData = &amp;AccountingInfo;
01004         st = STATUS_SUCCESS;
01005 
01006         <span class="keywordflow">break</span>;
01007 
01008     <span class="keywordflow">case</span> JobObjectExtendedLimitInformation:
01009     <span class="keywordflow">case</span> JobObjectBasicLimitInformation:
01010 
01011         <span class="comment">//</span>
01012         <span class="comment">// Get the Basic Information</span>
01013         <span class="comment">//</span>
01014         ExtendedLimitInfo.BasicLimitInformation.LimitFlags = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a>;
01015         ExtendedLimitInfo.BasicLimitInformation.MinimumWorkingSetSize = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o15">MinimumWorkingSetSize</a>;
01016         ExtendedLimitInfo.BasicLimitInformation.MaximumWorkingSetSize = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o16">MaximumWorkingSetSize</a>;
01017         ExtendedLimitInfo.BasicLimitInformation.ActiveProcessLimit = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o17">ActiveProcessLimit</a>;
01018         ExtendedLimitInfo.BasicLimitInformation.PriorityClass = (ULONG)Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o19">PriorityClass</a>;
01019         ExtendedLimitInfo.BasicLimitInformation.SchedulingClass = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o28">SchedulingClass</a>;
01020         ExtendedLimitInfo.BasicLimitInformation.Affinity = (ULONG_PTR)Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o18">Affinity</a>;
01021         ExtendedLimitInfo.BasicLimitInformation.PerProcessUserTimeLimit.QuadPart = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o12">PerProcessUserTimeLimit</a>.QuadPart;
01022         ExtendedLimitInfo.BasicLimitInformation.PerJobUserTimeLimit.QuadPart = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o13">PerJobUserTimeLimit</a>.QuadPart;
01023         ReturnData = &amp;ExtendedLimitInfo.BasicLimitInformation;
01024 
01025         <span class="keywordflow">if</span> ( JobObjectInformationClass == JobObjectExtendedLimitInformation ) {
01026 
01027             <span class="comment">//</span>
01028             <span class="comment">// Get Extended Information</span>
01029             <span class="comment">//</span>
01030 
01031             <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o41">MemoryLimitsLock</a>);
01032 
01033             ExtendedLimitInfo.ProcessMemoryLimit = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o36">ProcessMemoryLimit</a> &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01034             ExtendedLimitInfo.JobMemoryLimit = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o37">JobMemoryLimit</a> &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01035             ExtendedLimitInfo.PeakJobMemoryUsed = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o39">PeakJobMemoryUsed</a> &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01036 
01037             ExtendedLimitInfo.PeakProcessMemoryUsed = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o38">PeakProcessMemoryUsed</a> &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01038 
01039             <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o41">MemoryLimitsLock</a>);
01040 
01041 
01042             <span class="comment">//</span>
01043             <span class="comment">// Zero un-used I/O counters</span>
01044             <span class="comment">//</span>
01045             RtlZeroMemory(&amp;ExtendedLimitInfo.IoInfo,<span class="keyword">sizeof</span>(ExtendedLimitInfo.IoInfo));
01046 
01047             ReturnData = &amp;ExtendedLimitInfo;
01048             }
01049 
01050         st = STATUS_SUCCESS;
01051 
01052         <span class="keywordflow">break</span>;
01053 
01054     <span class="keywordflow">case</span> JobObjectBasicUIRestrictions:
01055 
01056         BasicUIRestrictions.UIRestrictionsClass = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o20">UIRestrictionsClass</a>;
01057 
01058         ReturnData = &amp;BasicUIRestrictions;
01059         st = STATUS_SUCCESS;
01060 
01061         <span class="keywordflow">break</span>;
01062 
01063     <span class="keywordflow">case</span> JobObjectBasicProcessIdList:
01064 
01065         IdList = (PJOBOBJECT_BASIC_PROCESS_ID_LIST)JobObjectInformation;
01066         NextProcessIdSlot = &amp;IdList-&gt;ProcessIdList[0];
01067         WorkingLength = FIELD_OFFSET(JOBOBJECT_BASIC_PROCESS_ID_LIST,ProcessIdList);
01068 
01069         AlreadyCopied = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
01070 
01071         <span class="keywordflow">try</span> {
01072 
01073             <span class="comment">//</span>
01074             <span class="comment">// Acounted for in the workinglength = 2*sizeof(ULONG)</span>
01075             <span class="comment">//</span>
01076 
01077             IdList-&gt;NumberOfAssignedProcesses = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o10">ActiveProcesses</a>;
01078             IdList-&gt;NumberOfProcessIdsInList = 0;
01079 
01080             Next = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o2">ProcessListHead</a>.Flink;
01081 
01082             <span class="keywordflow">while</span> ( Next != &amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o2">ProcessListHead</a>) {
01083 
01084                 Process = (<a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>)(CONTAINING_RECORD(Next,<a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>,JobLinks));
01085                 <span class="keywordflow">if</span> ( !(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a9">PS_JOB_STATUS_NOT_REALLY_ACTIVE</a>) ) {
01086                     <span class="keywordflow">if</span> ( !Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a> ) {
01087                         IdList-&gt;NumberOfAssignedProcesses--;
01088                         }
01089                     <span class="keywordflow">else</span> {
01090                         <span class="keywordflow">if</span> ( (RequiredLength - WorkingLength) &gt;= <span class="keyword">sizeof</span>(ULONG_PTR) ) {
01091                             *NextProcessIdSlot++ = (ULONG_PTR)Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a>;
01092                             WorkingLength += <span class="keyword">sizeof</span>(ULONG_PTR);
01093                             IdList-&gt;NumberOfProcessIdsInList++;
01094                             }
01095                         <span class="keywordflow">else</span> {
01096                             st = STATUS_BUFFER_OVERFLOW;
01097                             ActualReturnLength = WorkingLength;
01098                             <span class="keywordflow">break</span>;
01099                             }
01100                         }
01101                     }
01102                 Next = Next-&gt;Flink;
01103                 }
01104             ActualReturnLength = WorkingLength;
01105 
01106             }
01107         except ( <a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>() ) {
01108             st = GetExceptionCode();
01109             ActualReturnLength = 0;
01110             }
01111 
01112         <span class="keywordflow">break</span>;
01113 
01114     <span class="keywordflow">case</span> JobObjectSecurityLimitInformation:
01115 
01116         RtlZeroMemory( &amp;SecurityLimitInfo, <span class="keyword">sizeof</span>( SecurityLimitInfo ) );
01117 
01118         SecurityLimitInfo.SecurityLimitFlags = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o21">SecurityLimitFlags</a> ;
01119 
01120         ReturnData = &amp;SecurityLimitInfo;
01121 
01122         st = STATUS_SUCCESS;
01123 
01124         <span class="comment">//</span>
01125         <span class="comment">// If a filter is present, then we have an ugly marshalling to do.</span>
01126         <span class="comment">//</span>
01127 
01128         <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a> )
01129         {
01130 
01131             <span class="comment">//</span>
01132             <span class="comment">// Compute size needed:</span>
01133             <span class="comment">//</span>
01134 
01135             WorkingLength = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o2">CapturedSidsLength</a> +
01136                             Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o5">CapturedGroupsLength</a> +
01137                             Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o8">CapturedPrivilegesLength</a> ;
01138 
01139             WorkingLength = 0 ;
01140 
01141             <span class="comment">//</span>
01142             <span class="comment">// For each field, if it is present, include the extra stuff</span>
01143             <span class="comment">//</span>
01144 
01145             <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o2">CapturedSidsLength</a> )
01146             {
01147                 WorkingLength += Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o2">CapturedSidsLength</a> +
01148                                  <span class="keyword">sizeof</span>( ULONG );
01149             }
01150 
01151             <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o5">CapturedGroupsLength</a> )
01152             {
01153                 WorkingLength += Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o5">CapturedGroupsLength</a> +
01154                                  <span class="keyword">sizeof</span>( ULONG );
01155 
01156             }
01157 
01158             <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o8">CapturedPrivilegesLength</a> )
01159             {
01160                 WorkingLength += Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o8">CapturedPrivilegesLength</a> +
01161                                  <span class="keyword">sizeof</span>( ULONG );
01162             }
01163 
01164             RequiredLength -= <span class="keyword">sizeof</span>( SecurityLimitInfo );
01165 
01166             <span class="keywordflow">if</span> ( WorkingLength &gt; RequiredLength )
01167             {
01168                 st = STATUS_BUFFER_OVERFLOW ;
01169                 ActualReturnLength = WorkingLength + <span class="keyword">sizeof</span>( SecurityLimitInfo );
01170                 <span class="keywordflow">break</span>;
01171             }
01172 
01173             CurrentOffset = (PUCHAR) (JobObjectInformation) + <span class="keyword">sizeof</span>( SecurityLimitInfo );
01174 
01175             <span class="keywordflow">try</span> {
01176 
01177                 <span class="comment">//</span>
01178                 <span class="comment">//</span>
01179                 <span class="comment">//</span>
01180 
01181                 <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o2">CapturedSidsLength</a> )
01182                 {
01183                     WorkingGroup = (PTOKEN_GROUPS) CurrentOffset ;
01184 
01185                     CurrentOffset += <span class="keyword">sizeof</span>( ULONG );
01186 
01187                     SecurityLimitInfo.RestrictedSids = WorkingGroup ;
01188 
01189                     WorkingGroup-&gt;GroupCount = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o0">CapturedSidCount</a> ;
01190 
01191                     TargetSidBuffer = (PSID) (CurrentOffset +
01192                                                 <span class="keyword">sizeof</span>( SID_AND_ATTRIBUTES ) *
01193                                                 Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o0">CapturedSidCount</a> );
01194 
01195                     st = <a class="code" href="../../d8/d6/sertl_8c.html#a47">RtlCopySidAndAttributesArray</a>(
01196                                 Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o0">CapturedSidCount</a>,
01197                                 Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o1">CapturedSids</a>,
01198                                 WorkingLength,
01199                                 WorkingGroup-&gt;Groups,
01200                                 TargetSidBuffer,
01201                                 &amp;RemainingSid,
01202                                 &amp;RemainingSidBuffer );
01203 
01204                     CurrentOffset += Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o2">CapturedSidsLength</a> ;
01205 
01206                 }
01207 
01208                 <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( st ) )
01209                 {
01210                     leave ;
01211                 }
01212 
01213                 <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o5">CapturedGroupsLength</a> )
01214                 {
01215                     WorkingGroup = (PTOKEN_GROUPS) CurrentOffset ;
01216 
01217                     CurrentOffset += <span class="keyword">sizeof</span>( ULONG );
01218 
01219                     SecurityLimitInfo.SidsToDisable = WorkingGroup ;
01220 
01221                     WorkingGroup-&gt;GroupCount = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o3">CapturedGroupCount</a> ;
01222 
01223                     TargetSidBuffer = (PSID) (CurrentOffset +
01224                                                 <span class="keyword">sizeof</span>( SID_AND_ATTRIBUTES ) *
01225                                                 Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o3">CapturedGroupCount</a> );
01226 
01227                     st = <a class="code" href="../../d8/d6/sertl_8c.html#a47">RtlCopySidAndAttributesArray</a>(
01228                                 Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o3">CapturedGroupCount</a>,
01229                                 Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o4">CapturedGroups</a>,
01230                                 WorkingLength,
01231                                 WorkingGroup-&gt;Groups,
01232                                 TargetSidBuffer,
01233                                 &amp;RemainingSid,
01234                                 &amp;RemainingSidBuffer );
01235 
01236                     CurrentOffset += Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o5">CapturedGroupsLength</a> ;
01237 
01238                 }
01239 
01240                 <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( st ) )
01241                 {
01242                     leave ;
01243                 }
01244 
01245                 <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o8">CapturedPrivilegesLength</a> )
01246                 {
01247                     WorkingPrivs = (PTOKEN_PRIVILEGES) CurrentOffset;
01248 
01249                     CurrentOffset += <span class="keyword">sizeof</span>( ULONG );
01250 
01251                     SecurityLimitInfo.PrivilegesToDelete = WorkingPrivs ;
01252 
01253                     WorkingPrivs-&gt;PrivilegeCount = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o6">CapturedPrivilegeCount</a> ;
01254 
01255                     RtlCopyMemory( WorkingPrivs-&gt;Privileges,
01256                                    Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o7">CapturedPrivileges</a>,
01257                                    Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o23">Filter</a>-&gt;<a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html#o8">CapturedPrivilegesLength</a> );
01258 
01259                 }
01260 
01261                 AlreadyCopied = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
01262 
01263                 RtlCopyMemory( JobObjectInformation,
01264                                &amp;SecurityLimitInfo,
01265                                <span class="keyword">sizeof</span>( SecurityLimitInfo ) );
01266 
01267 
01268             }
01269             except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01270                 st = GetExceptionCode();
01271                 ActualReturnLength = 0 ;
01272                 <span class="keywordflow">break</span>;
01273             }
01274 
01275         }
01276 
01277 
01278         <span class="keywordflow">break</span>;
01279 
01280     <span class="keywordflow">default</span>:
01281 
01282         st = STATUS_INVALID_INFO_CLASS;
01283     }
01284 
01285     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o3">JobLock</a>);
01286     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01287 
01288 
01289     <span class="comment">//</span>
01290     <span class="comment">// Finish Up</span>
01291     <span class="comment">//</span>
01292 
01293     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Job);
01294 
01295 
01296     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01297 
01298         <span class="comment">//</span>
01299         <span class="comment">// Either of these may cause an access violation. The</span>
01300         <span class="comment">// exception handler will return access violation as</span>
01301         <span class="comment">// status code. No further cleanup needs to be done.</span>
01302         <span class="comment">//</span>
01303 
01304         <span class="keywordflow">try</span> {
01305             <span class="keywordflow">if</span> ( !AlreadyCopied ) {
01306                 RtlCopyMemory(JobObjectInformation,ReturnData,RequiredLength);
01307                 }
01308 
01309             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength) ) {
01310                 *ReturnLength = ActualReturnLength;
01311                 }
01312             }
01313         except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01314             <span class="keywordflow">return</span> STATUS_SUCCESS;
01315             }
01316         }
01317 
01318     <span class="keywordflow">return</span> st;
01319 
01320 }
01321 
01322 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01323"></a><a class="code" href="../../d1/d1/psjob_8c.html#a12">01323</a> <a class="code" href="../../d1/d1/psjob_8c.html#a12">NtSetInformationJobObject</a>(
01324     IN HANDLE JobHandle,
01325     IN JOBOBJECTINFOCLASS JobObjectInformationClass,
01326     IN PVOID JobObjectInformation,
01327     IN ULONG JobObjectInformationLength
01328     )
01329 {
01330     <a class="code" href="../../d0/d3/struct__EJOB.html">PEJOB</a> Job;
01331     <a class="code" href="../../d0/d3/struct__EJOB.html">EJOB</a> LocalJob;
01332     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
01333     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
01334     JOBOBJECT_EXTENDED_LIMIT_INFORMATION ExtendedLimitInfo;
01335     JOBOBJECT_BASIC_UI_RESTRICTIONS BasicUIRestrictions;
01336     JOBOBJECT_SECURITY_LIMIT_INFORMATION SecurityLimitInfo ;
01337     JOBOBJECT_END_OF_JOB_TIME_INFORMATION EndOfJobInfo;
01338     JOBOBJECT_ASSOCIATE_COMPLETION_PORT AssociateInfo;
01339     ULONG RequiredAccess ;
01340     ULONG RequiredLength, RequiredAlign;
01341     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
01342     BOOLEAN HasPrivilege;
01343     BOOLEAN <a class="code" href="../../d3/d9/client_2wow_8c.html#a18">IsChild</a> ;
01344     PLIST_ENTRY Next;
01345     <a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html">PPS_JOB_TOKEN_FILTER</a> <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a> ;
01346     PVOID IoCompletion;
01347     PACCESS_TOKEN LocalToken ;
01348     ULONG ValidFlags;
01349     ULONG LimitFlags;
01350     BOOLEAN ProcessWorkingSetHead = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01351     <a class="code" href="../../d8/d4/struct__JOB__WORKING__SET__CHANGE__RECORD.html">PJOB_WORKING_SET_CHANGE_RECORD</a> WsChangeRecord;
01352 
01353 
01354     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01355 
01356     <span class="comment">//</span>
01357     <span class="comment">// Get previous processor mode and probe output argument if necessary.</span>
01358     <span class="comment">//</span>
01359 
01360     <span class="keywordflow">if</span> ( JobObjectInformationClass &gt;= MaxJobObjectInfoClass || JobObjectInformationClass &lt;= 0) {
01361         <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
01362         }
01363     RequiredLength = <a class="code" href="../../d1/d1/psjob_8c.html#a1">PspJobInfoLengths</a>[JobObjectInformationClass-1];
01364     RequiredAlign = <a class="code" href="../../d1/d1/psjob_8c.html#a2">PspJobInfoAlign</a>[JobObjectInformationClass-1];
01365 
01366     PreviousMode = KeGetPreviousMode();
01367     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
01368         <span class="keywordflow">try</span> {
01369             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
01370                 JobObjectInformation,
01371                 JobObjectInformationLength,
01372                 RequiredAlign
01373                 );
01374             }
01375         except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01376             <span class="keywordflow">return</span> GetExceptionCode();
01377             }
01378         }
01379 
01380     <span class="keywordflow">if</span> ( JobObjectInformationLength != RequiredLength ) {
01381         <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01382         }
01383 
01384     <span class="comment">//</span>
01385     <span class="comment">// reference the job</span>
01386     <span class="comment">//</span>
01387 
01388     <span class="keywordflow">if</span> ( JobObjectInformationClass == JobObjectSecurityLimitInformation )
01389     {
01390         RequiredAccess = JOB_OBJECT_SET_SECURITY_ATTRIBUTES ;
01391     }
01392     <span class="keywordflow">else</span>
01393     {
01394         RequiredAccess = JOB_OBJECT_SET_ATTRIBUTES ;
01395     }
01396 
01397     st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01398             JobHandle,
01399             RequiredAccess,
01400             <a class="code" href="../../d9/d8/ntos_8h.html#a4">PsJobType</a>,
01401             PreviousMode,
01402             (PVOID *)&amp;Job,
01403             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01404             );
01405     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01406         <span class="keywordflow">return</span> st;
01407         }
01408 
01409     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01410     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;Job-&gt;JobLock, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01411 
01412     <span class="comment">//</span>
01413     <span class="comment">// Check argument validity.</span>
01414     <span class="comment">//</span>
01415 
01416     <span class="keywordflow">switch</span> ( JobObjectInformationClass ) {
01417 
01418     <span class="keywordflow">case</span> JobObjectExtendedLimitInformation:
01419     <span class="keywordflow">case</span> JobObjectBasicLimitInformation:
01420         <span class="keywordflow">try</span> {
01421             RtlCopyMemory(&amp;ExtendedLimitInfo,JobObjectInformation,RequiredLength);
01422             }
01423         except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01424             st = GetExceptionCode();
01425             }
01426         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01427             <span class="comment">//</span>
01428             <span class="comment">// sanity check LimitFlags</span>
01429             <span class="comment">//</span>
01430             <span class="keywordflow">if</span> ( JobObjectInformationClass == JobObjectBasicLimitInformation) {
01431                 ValidFlags = JOB_OBJECT_BASIC_LIMIT_VALID_FLAGS;
01432                 }
01433             <span class="keywordflow">else</span> {
01434                 ValidFlags = JOB_OBJECT_EXTENDED_LIMIT_VALID_FLAGS;
01435                 }
01436 
01437             <span class="keywordflow">if</span> ( ExtendedLimitInfo.BasicLimitInformation.LimitFlags &amp; ~ValidFlags ) {
01438                 st = STATUS_INVALID_PARAMETER;
01439                 }
01440             <span class="keywordflow">else</span> {
01441 
01442                 LimitFlags = ExtendedLimitInfo.BasicLimitInformation.LimitFlags;
01443 
01444                 <span class="comment">//</span>
01445                 <span class="comment">// Deal with each of the various limit flags</span>
01446                 <span class="comment">//</span>
01447 
01448                 LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> = Job-&gt;LimitFlags;
01449 
01450 
01451                 <span class="comment">//</span>
01452                 <span class="comment">// ACTIVE PROCESS LIMIT</span>
01453                 <span class="comment">//</span>
01454                 <span class="keywordflow">if</span> ( LimitFlags &amp; JOB_OBJECT_LIMIT_ACTIVE_PROCESS ) {
01455 
01456                     <span class="comment">//</span>
01457                     <span class="comment">// Active Process Limit is NOT retroactive. New processes are denied,</span>
01458                     <span class="comment">// but existing ones are not killed just because the limit is</span>
01459                     <span class="comment">// reduced.</span>
01460                     <span class="comment">//</span>
01461 
01462                     LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> |= JOB_OBJECT_LIMIT_ACTIVE_PROCESS;
01463                     LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o17">ActiveProcessLimit</a> = ExtendedLimitInfo.BasicLimitInformation.ActiveProcessLimit;
01464                     }
01465                 <span class="keywordflow">else</span> {
01466                     LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp;= ~JOB_OBJECT_LIMIT_ACTIVE_PROCESS;
01467                     LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o17">ActiveProcessLimit</a> = 0;
01468                     }
01469 
01470                 <span class="comment">//</span>
01471                 <span class="comment">// PRIORITY CLASS LIMIT</span>
01472                 <span class="comment">//</span>
01473                 <span class="keywordflow">if</span> ( LimitFlags &amp; JOB_OBJECT_LIMIT_PRIORITY_CLASS ) {
01474 
01475                     <span class="keywordflow">if</span> ( ExtendedLimitInfo.BasicLimitInformation.PriorityClass &gt; PROCESS_PRIORITY_CLASS_ABOVE_NORMAL ) {
01476                         st = STATUS_INVALID_PARAMETER;
01477                         }
01478                     <span class="keywordflow">else</span> {
01479                         <span class="keywordflow">if</span> ( ExtendedLimitInfo.BasicLimitInformation.PriorityClass == PROCESS_PRIORITY_CLASS_HIGH ||
01480                              ExtendedLimitInfo.BasicLimitInformation.PriorityClass == PROCESS_PRIORITY_CLASS_REALTIME ) {
01481 
01482                             <span class="comment">//</span>
01483                             <span class="comment">// Increasing the base priority of a process is a</span>
01484                             <span class="comment">// privileged operation.  Check for the privilege</span>
01485                             <span class="comment">// here.</span>
01486                             <span class="comment">//</span>
01487 
01488                             HasPrivilege = <a class="code" href="../../d8/d4/privileg_8c.html#a4">SeCheckPrivilegedObject</a>(
01489                                                <a class="code" href="../../d0/d5/se_8h.html#a89">SeIncreaseBasePriorityPrivilege</a>,
01490                                                JobHandle,
01491                                                JOB_OBJECT_SET_ATTRIBUTES,
01492                                                PreviousMode
01493                                                );
01494 
01495                             <span class="keywordflow">if</span> (!HasPrivilege) {
01496                                 st = STATUS_PRIVILEGE_NOT_HELD;
01497                                 }
01498                             }
01499 
01500                         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01501                             LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> |= JOB_OBJECT_LIMIT_PRIORITY_CLASS;
01502                             LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o19">PriorityClass</a> = (UCHAR)ExtendedLimitInfo.BasicLimitInformation.PriorityClass;
01503                             }
01504                         }
01505                     }
01506                 <span class="keywordflow">else</span> {
01507                     LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp;= ~JOB_OBJECT_LIMIT_PRIORITY_CLASS;
01508                     LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o19">PriorityClass</a> = 0;
01509                     }
01510 
01511                 <span class="comment">//</span>
01512                 <span class="comment">// SCHEDULING CLASS LIMIT</span>
01513                 <span class="comment">//</span>
01514                 <span class="keywordflow">if</span> ( LimitFlags &amp; JOB_OBJECT_LIMIT_SCHEDULING_CLASS ) {
01515 
01516                     <span class="keywordflow">if</span> ( ExtendedLimitInfo.BasicLimitInformation.SchedulingClass &gt;= <a class="code" href="../../d8/d1/psp_8h.html#a8">PSP_NUMBER_OF_SCHEDULING_CLASSES</a>) {
01517                         st = STATUS_INVALID_PARAMETER;
01518                         }
01519                     <span class="keywordflow">else</span> {
01520                         <span class="keywordflow">if</span> ( ExtendedLimitInfo.BasicLimitInformation.SchedulingClass &gt; <a class="code" href="../../d8/d1/psp_8h.html#a9">PSP_DEFAULT_SCHEDULING_CLASSES</a> ) {
01521 
01522                             <span class="comment">//</span>
01523                             <span class="comment">// Increasing above the default scheduling class</span>
01524                             <span class="comment">// is a</span>
01525                             <span class="comment">// privileged operation.  Check for the privilege</span>
01526                             <span class="comment">// here.</span>
01527                             <span class="comment">//</span>
01528 
01529                             HasPrivilege = <a class="code" href="../../d8/d4/privileg_8c.html#a4">SeCheckPrivilegedObject</a>(
01530                                                <a class="code" href="../../d0/d5/se_8h.html#a89">SeIncreaseBasePriorityPrivilege</a>,
01531                                                JobHandle,
01532                                                JOB_OBJECT_SET_ATTRIBUTES,
01533                                                PreviousMode
01534                                                );
01535 
01536                             <span class="keywordflow">if</span> (!HasPrivilege) {
01537                                 st = STATUS_PRIVILEGE_NOT_HELD;
01538                                 }
01539                             }
01540 
01541                         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01542                             LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> |= JOB_OBJECT_LIMIT_SCHEDULING_CLASS;
01543                             LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o28">SchedulingClass</a> = ExtendedLimitInfo.BasicLimitInformation.SchedulingClass;
01544                             }
01545                         }
01546                     }
01547                 <span class="keywordflow">else</span> {
01548                     LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp;= ~JOB_OBJECT_LIMIT_SCHEDULING_CLASS;
01549                     LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o28">SchedulingClass</a> = <a class="code" href="../../d8/d1/psp_8h.html#a9">PSP_DEFAULT_SCHEDULING_CLASSES</a> ;
01550                     }
01551 
01552                 <span class="comment">//</span>
01553                 <span class="comment">// AFFINITY LIMIT</span>
01554                 <span class="comment">//</span>
01555                 <span class="keywordflow">if</span> ( LimitFlags &amp; JOB_OBJECT_LIMIT_AFFINITY ) {
01556 
01557                     <span class="keywordflow">if</span> ( !ExtendedLimitInfo.BasicLimitInformation.Affinity ||
01558                          (ExtendedLimitInfo.BasicLimitInformation.Affinity != (ExtendedLimitInfo.BasicLimitInformation.Affinity &amp; <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a>)) ) {
01559                         st = STATUS_INVALID_PARAMETER;
01560                         }
01561                     <span class="keywordflow">else</span> {
01562                         LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> |= JOB_OBJECT_LIMIT_AFFINITY;
01563                         LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o18">Affinity</a> = (KAFFINITY)ExtendedLimitInfo.BasicLimitInformation.Affinity;
01564                         }
01565                     }
01566                 <span class="keywordflow">else</span> {
01567                     LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp;= ~JOB_OBJECT_LIMIT_AFFINITY;
01568                     LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o18">Affinity</a> = 0;
01569                     }
01570 
01571                 <span class="comment">//</span>
01572                 <span class="comment">// PROCESS TIME LIMIT</span>
01573                 <span class="comment">//</span>
01574                 <span class="keywordflow">if</span> ( LimitFlags &amp; JOB_OBJECT_LIMIT_PROCESS_TIME ) {
01575 
01576                     <span class="keywordflow">if</span> ( !ExtendedLimitInfo.BasicLimitInformation.PerProcessUserTimeLimit.QuadPart ) {
01577                         st = STATUS_INVALID_PARAMETER;
01578                         }
01579                     <span class="keywordflow">else</span> {
01580                         LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> |= JOB_OBJECT_LIMIT_PROCESS_TIME;
01581                         LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o12">PerProcessUserTimeLimit</a>.QuadPart = ExtendedLimitInfo.BasicLimitInformation.PerProcessUserTimeLimit.QuadPart;
01582                         }
01583                     }
01584                 <span class="keywordflow">else</span> {
01585                     LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp;= ~JOB_OBJECT_LIMIT_PROCESS_TIME;
01586                     LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o12">PerProcessUserTimeLimit</a>.QuadPart = 0;
01587                     }
01588 
01589                 <span class="comment">//</span>
01590                 <span class="comment">// JOB TIME LIMIT</span>
01591                 <span class="comment">//</span>
01592                 <span class="keywordflow">if</span> ( LimitFlags &amp; JOB_OBJECT_LIMIT_JOB_TIME ) {
01593 
01594                     <span class="keywordflow">if</span> ( !ExtendedLimitInfo.BasicLimitInformation.PerJobUserTimeLimit.QuadPart ) {
01595                         st = STATUS_INVALID_PARAMETER;
01596                         }
01597                     <span class="keywordflow">else</span> {
01598                         LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> |= JOB_OBJECT_LIMIT_JOB_TIME;
01599                         LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o13">PerJobUserTimeLimit</a>.QuadPart = ExtendedLimitInfo.BasicLimitInformation.PerJobUserTimeLimit.QuadPart;
01600                         }
01601                     }
01602                 <span class="keywordflow">else</span> {
01603                     <span class="keywordflow">if</span> ( LimitFlags &amp; JOB_OBJECT_LIMIT_PRESERVE_JOB_TIME ) {
01604 
01605                         <span class="comment">//</span>
01606                         <span class="comment">// If we are supposed to preserve existing job time limits, then</span>
01607                         <span class="comment">// preserve them !</span>
01608                         <span class="comment">//</span>
01609 
01610                         LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> |= (Job-&gt;LimitFlags &amp; JOB_OBJECT_LIMIT_JOB_TIME);
01611                         LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o13">PerJobUserTimeLimit</a>.QuadPart = Job-&gt;PerJobUserTimeLimit.QuadPart;
01612                         }
01613                     <span class="keywordflow">else</span> {
01614                         LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp;= ~JOB_OBJECT_LIMIT_JOB_TIME;
01615                         LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o13">PerJobUserTimeLimit</a>.QuadPart = 0;
01616                         }
01617                     }
01618 
01619                 <span class="comment">//</span>
01620                 <span class="comment">// WORKING SET LIMIT</span>
01621                 <span class="comment">//</span>
01622                 <span class="keywordflow">if</span> ( LimitFlags &amp; JOB_OBJECT_LIMIT_WORKINGSET ) {
01623 
01624 
01625                     <span class="comment">//</span>
01626                     <span class="comment">// the only issue with this check is that when we enforce through the</span>
01627                     <span class="comment">// processes, we may find a process that can not handle the new working set</span>
01628                     <span class="comment">// limit because it will make the process's working set not fluid</span>
01629                     <span class="comment">//</span>
01630 
01631                     <span class="keywordflow">if</span> ( (ExtendedLimitInfo.BasicLimitInformation.MinimumWorkingSetSize == 0 &amp;&amp;
01632                          ExtendedLimitInfo.BasicLimitInformation.MaximumWorkingSetSize == 0)                 ||
01633 
01634                          (ExtendedLimitInfo.BasicLimitInformation.MinimumWorkingSetSize == (SIZE_T)-1 &amp;&amp;
01635                          ExtendedLimitInfo.BasicLimitInformation.MaximumWorkingSetSize == (SIZE_T)-1)        ||
01636 
01637                          (ExtendedLimitInfo.BasicLimitInformation.MinimumWorkingSetSize &gt;
01638                             ExtendedLimitInfo.BasicLimitInformation.MaximumWorkingSetSize)                   ) {
01639 
01640 
01641                         st = STATUS_INVALID_PARAMETER;
01642                         }
01643                     <span class="keywordflow">else</span> {
01644                         LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> |= JOB_OBJECT_LIMIT_WORKINGSET;
01645                         LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o15">MinimumWorkingSetSize</a> = ExtendedLimitInfo.BasicLimitInformation.MinimumWorkingSetSize;
01646                         LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o16">MaximumWorkingSetSize</a> = ExtendedLimitInfo.BasicLimitInformation.MaximumWorkingSetSize;
01647                         }
01648                     }
01649                 <span class="keywordflow">else</span> {
01650                     LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp;= ~JOB_OBJECT_LIMIT_WORKINGSET;
01651                     LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o15">MinimumWorkingSetSize</a> = 0;
01652                     LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o16">MaximumWorkingSetSize</a> = 0;
01653                     }
01654 
01655                 <span class="keywordflow">if</span> ( JobObjectInformationClass == JobObjectExtendedLimitInformation) {
01656                     <span class="comment">//</span>
01657                     <span class="comment">// PROCESS MEMORY LIMIT</span>
01658                     <span class="comment">//</span>
01659                     <span class="keywordflow">if</span> ( LimitFlags &amp; JOB_OBJECT_LIMIT_PROCESS_MEMORY ) {
01660                         <span class="keywordflow">if</span> ( ExtendedLimitInfo.ProcessMemoryLimit &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> ) {
01661                             st = STATUS_INVALID_PARAMETER;
01662                             }
01663                         <span class="keywordflow">else</span> {
01664                             LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> |= JOB_OBJECT_LIMIT_PROCESS_MEMORY;
01665                             LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o36">ProcessMemoryLimit</a> = ExtendedLimitInfo.ProcessMemoryLimit &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01666                             }
01667                         }
01668                     <span class="keywordflow">else</span> {
01669                         LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp;= ~JOB_OBJECT_LIMIT_PROCESS_MEMORY;
01670                         LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o36">ProcessMemoryLimit</a> = 0;
01671                         }
01672 
01673                     <span class="comment">//</span>
01674                     <span class="comment">// JOB WIDE MEMORY LIMIT</span>
01675                     <span class="comment">//</span>
01676                     <span class="keywordflow">if</span> ( LimitFlags &amp; JOB_OBJECT_LIMIT_JOB_MEMORY ) {
01677                         <span class="keywordflow">if</span> ( ExtendedLimitInfo.JobMemoryLimit &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> ) {
01678                             st = STATUS_INVALID_PARAMETER;
01679                             }
01680                         <span class="keywordflow">else</span> {
01681                             LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> |= JOB_OBJECT_LIMIT_JOB_MEMORY;
01682                             LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o37">JobMemoryLimit</a> = ExtendedLimitInfo.JobMemoryLimit &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01683                             }
01684                         }
01685                     <span class="keywordflow">else</span> {
01686                         LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp;= ~JOB_OBJECT_LIMIT_JOB_MEMORY;
01687                         LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o37">JobMemoryLimit</a> = 0;
01688                         }
01689 
01690                     <span class="comment">//</span>
01691                     <span class="comment">// JOB_OBJECT_LIMIT_DIE_ON_UNHANDLED_EXCEPTION</span>
01692                     <span class="comment">//</span>
01693                     <span class="keywordflow">if</span> ( LimitFlags &amp; JOB_OBJECT_LIMIT_DIE_ON_UNHANDLED_EXCEPTION ) {
01694                         LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> |= JOB_OBJECT_LIMIT_DIE_ON_UNHANDLED_EXCEPTION;
01695                         }
01696                     <span class="keywordflow">else</span> {
01697                         LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp;= ~JOB_OBJECT_LIMIT_DIE_ON_UNHANDLED_EXCEPTION;
01698                         }
01699 
01700                     <span class="comment">//</span>
01701                     <span class="comment">// JOB_OBJECT_LIMIT_BREAKAWAY_OK</span>
01702                     <span class="comment">//</span>
01703                     <span class="keywordflow">if</span> ( LimitFlags &amp; JOB_OBJECT_LIMIT_BREAKAWAY_OK ) {
01704                         LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> |= JOB_OBJECT_LIMIT_BREAKAWAY_OK;
01705                         }
01706                     <span class="keywordflow">else</span> {
01707                         LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp;= ~JOB_OBJECT_LIMIT_BREAKAWAY_OK;
01708                         }
01709 
01710                     <span class="comment">//</span>
01711                     <span class="comment">// JOB_OBJECT_LIMIT_SILENT_BREAKAWAY_OK</span>
01712                     <span class="comment">//</span>
01713                     <span class="keywordflow">if</span> ( LimitFlags &amp; JOB_OBJECT_LIMIT_SILENT_BREAKAWAY_OK ) {
01714                         LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> |= JOB_OBJECT_LIMIT_SILENT_BREAKAWAY_OK;
01715                         }
01716                     <span class="keywordflow">else</span> {
01717                         LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp;= ~JOB_OBJECT_LIMIT_SILENT_BREAKAWAY_OK;
01718                         }
01719                     }
01720 
01721                 <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01722 
01723 
01724                     <span class="comment">//</span>
01725                     <span class="comment">// Copy LocalJob to Job</span>
01726                     <span class="comment">//</span>
01727 
01728                     Job-&gt;LimitFlags = LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a>;
01729                     Job-&gt;MinimumWorkingSetSize = LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o15">MinimumWorkingSetSize</a>;
01730                     Job-&gt;MaximumWorkingSetSize = LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o16">MaximumWorkingSetSize</a>;
01731                     Job-&gt;ActiveProcessLimit = LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o17">ActiveProcessLimit</a>;
01732                     Job-&gt;Affinity = LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o18">Affinity</a>;
01733                     Job-&gt;PriorityClass = LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o19">PriorityClass</a>;
01734                     Job-&gt;SchedulingClass = LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o28">SchedulingClass</a>;
01735                     Job-&gt;PerProcessUserTimeLimit.QuadPart = LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o12">PerProcessUserTimeLimit</a>.QuadPart;
01736                     Job-&gt;PerJobUserTimeLimit.QuadPart = LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o13">PerJobUserTimeLimit</a>.QuadPart;
01737 
01738                     <span class="keywordflow">if</span> ( JobObjectInformationClass == JobObjectExtendedLimitInformation) {
01739                         <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>(&amp;Job-&gt;MemoryLimitsLock);
01740                         Job-&gt;ProcessMemoryLimit = LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o36">ProcessMemoryLimit</a>;
01741                         Job-&gt;JobMemoryLimit = LocalJob.<a class="code" href="../../d0/d3/struct__EJOB.html#o37">JobMemoryLimit</a>;
01742                         <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>(&amp;Job-&gt;MemoryLimitsLock);
01743                         }
01744 
01745                     <span class="keywordflow">if</span> ( LimitFlags &amp; JOB_OBJECT_LIMIT_JOB_TIME ) {
01746 
01747                         <span class="comment">//</span>
01748                         <span class="comment">// Take any signalled processes and fold their accounting</span>
01749                         <span class="comment">// intothe job. This way a process that exited clean but still</span>
01750                         <span class="comment">// is open won't impact the next period</span>
01751                         <span class="comment">//</span>
01752 
01753                         Next = Job-&gt;ProcessListHead.Flink;
01754 
01755                         <span class="keywordflow">while</span> ( Next != &amp;Job-&gt;ProcessListHead) {
01756 
01757                             Process = (<a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>)(CONTAINING_RECORD(Next,<a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>,JobLinks));
01758 
01759                             <span class="comment">//</span>
01760                             <span class="comment">// see if process has been signalled.</span>
01761                             <span class="comment">// This indicates that the process has exited. We can't do</span>
01762                             <span class="comment">// this in the exit path becuase of the lock order problem</span>
01763                             <span class="comment">// between the process lock and the job lock since in exit</span>
01764                             <span class="comment">// we hold the process lock for a long time and can't drop</span>
01765                             <span class="comment">// it until thread termination</span>
01766                             <span class="comment">//</span>
01767 
01768                             <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d5/procobj_8c.html#a9">KeReadStateProcess</a>(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>) ) {
01769                                 <a class="code" href="../../d8/d1/psp_8h.html#a98">PspFoldProcessAccountingIntoJob</a>(Job,Process);
01770                                 }
01771                             <span class="keywordflow">else</span> {
01772 
01773                                 LARGE_INTEGER ProcessTime;
01774 
01775                                 <span class="comment">//</span>
01776                                 <span class="comment">// running processes have their current runtime</span>
01777                                 <span class="comment">// added to the programmed limit. This way, you</span>
01778                                 <span class="comment">// can set a limit on a job with processes in the</span>
01779                                 <span class="comment">// job and not have previous runtimes count against</span>
01780                                 <span class="comment">// the limit</span>
01781                                 <span class="comment">//</span>
01782 
01783                                 <span class="keywordflow">if</span> ( !(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a10">PS_JOB_STATUS_ACCOUNTING_FOLDED</a>) ) {
01784                                     ProcessTime.QuadPart = UInt32x32To64(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o5">UserTime</a>,<a class="code" href="../../d4/d9/ke_8h.html#a131">KeMaximumIncrement</a>);
01785                                     Job-&gt;PerJobUserTimeLimit.QuadPart += ProcessTime.QuadPart;
01786                                     }
01787                                 }
01788 
01789                             Next = Next-&gt;Flink;
01790                             }
01791 
01792 
01793                         <span class="comment">//</span>
01794                         <span class="comment">// clear period times and reset the job</span>
01795                         <span class="comment">//</span>
01796 
01797                         Job-&gt;ThisPeriodTotalUserTime.QuadPart = 0;
01798                         Job-&gt;ThisPeriodTotalKernelTime.QuadPart = 0;
01799 
01800                         <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>(&amp;Job-&gt;Event);
01801 
01802                         }
01803 
01804                     <span class="keywordflow">if</span> ( Job-&gt;LimitFlags &amp; JOB_OBJECT_LIMIT_WORKINGSET ) {
01805                         <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>(&amp;<a class="code" href="../../d8/d1/psp_8h.html#a20">PspWorkingSetChangeHead</a>.<a class="code" href="../../d7/d4/struct__JOB__WORKING__SET__CHANGE__HEAD.html#o1">Lock</a>);
01806                         <a class="code" href="../../d8/d1/psp_8h.html#a20">PspWorkingSetChangeHead</a>.<a class="code" href="../../d7/d4/struct__JOB__WORKING__SET__CHANGE__HEAD.html#o2">MinimumWorkingSetSize</a> = Job-&gt;MinimumWorkingSetSize;
01807                         <a class="code" href="../../d8/d1/psp_8h.html#a20">PspWorkingSetChangeHead</a>.<a class="code" href="../../d7/d4/struct__JOB__WORKING__SET__CHANGE__HEAD.html#o3">MaximumWorkingSetSize</a> = Job-&gt;MaximumWorkingSetSize;
01808                         ProcessWorkingSetHead = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01809                         }
01810 
01811                     <a class="code" href="../../d8/d1/psp_8h.html#a95">PspApplyJobLimitsToProcessSet</a>(Job);
01812 
01813                     }
01814                 }
01815 
01816             }
01817         <span class="keywordflow">break</span>;
01818 
01819     <span class="keywordflow">case</span> JobObjectBasicUIRestrictions:
01820         <span class="keywordflow">try</span> {
01821             RtlCopyMemory(&amp;BasicUIRestrictions, JobObjectInformation, RequiredLength);
01822             }
01823         except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01824             st = GetExceptionCode();
01825             }
01826 
01827         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01828             <span class="comment">//</span>
01829             <span class="comment">// sanity check UIRestrictionsClass</span>
01830             <span class="comment">//</span>
01831             <span class="keywordflow">if</span> ( BasicUIRestrictions.UIRestrictionsClass &amp; ~JOB_OBJECT_UI_VALID_FLAGS ) {
01832                 st = STATUS_INVALID_PARAMETER;
01833                 }
01834             <span class="keywordflow">else</span> {
01835 
01836                 <span class="comment">//</span>
01837                 <span class="comment">// Check for switching between UI restrictions</span>
01838                 <span class="comment">//</span>
01839 
01840                 <span class="keywordflow">if</span> ( Job-&gt;UIRestrictionsClass ^ BasicUIRestrictions.UIRestrictionsClass ) {
01841 
01842                     <span class="comment">//</span>
01843                     <span class="comment">// notify ntuser that the UI restrictions have changed</span>
01844                     <span class="comment">//</span>
01845                     <a class="code" href="../../d4/d8/struct__WIN32__JOBCALLOUT__PARAMETERS.html">WIN32_JOBCALLOUT_PARAMETERS</a> Parms;
01846 
01847                     Parms.<a class="code" href="../../d4/d8/struct__WIN32__JOBCALLOUT__PARAMETERS.html#o0">Job</a> = Job;
01848                     Parms.<a class="code" href="../../d4/d8/struct__WIN32__JOBCALLOUT__PARAMETERS.html#o1">CalloutType</a> = <a class="code" href="../../d1/d9/ps_8h.html#a156a93">PsW32JobCalloutSetInformation</a>;
01849                     Parms.<a class="code" href="../../d4/d8/struct__WIN32__JOBCALLOUT__PARAMETERS.html#o2">Data</a> = ULongToPtr(BasicUIRestrictions.UIRestrictionsClass);
01850                     <a class="code" href="../../d2/d1/mm_8h.html#a197">MmDispatchWin32Callout</a>( <a class="code" href="../../d8/d1/psp_8h.html#a41">PspW32JobCallout</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, (PVOID)&amp;Parms, &amp;(Job-&gt;SessionId) );
01851 
01852                     }
01853 
01854 
01855                 <span class="comment">//</span>
01856                 <span class="comment">// save the UI restrictions into the job object</span>
01857                 <span class="comment">//</span>
01858 
01859                 Job-&gt;UIRestrictionsClass = BasicUIRestrictions.UIRestrictionsClass;
01860                 }
01861             }
01862         <span class="keywordflow">break</span>;
01863 
01864         <span class="comment">//</span>
01865         <span class="comment">// SECURITY LIMITS</span>
01866         <span class="comment">//</span>
01867 
01868     <span class="keywordflow">case</span> JobObjectSecurityLimitInformation:
01869 
01870         <span class="keywordflow">try</span> {
01871             RtlCopyMemory(  &amp;SecurityLimitInfo,
01872                             JobObjectInformation,
01873                             RequiredLength );
01874             }
01875         except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01876             st = GetExceptionCode();
01877             }
01878 
01879         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01880 
01881             <span class="keywordflow">if</span> ( SecurityLimitInfo.SecurityLimitFlags &amp;
01882                     (~JOB_OBJECT_SECURITY_VALID_FLAGS))
01883             {
01884                 st = STATUS_INVALID_PARAMETER ;
01885             }
01886             <span class="keywordflow">else</span>
01887             {
01888                 <span class="comment">//</span>
01889                 <span class="comment">// Deal with specific options.  Basic rules:  Once a</span>
01890                 <span class="comment">// flag is on, it is always on (so even with a handle to</span>
01891                 <span class="comment">// the job, a process could not lift the security</span>
01892                 <span class="comment">// restrictions).</span>
01893                 <span class="comment">//</span>
01894 
01895                 <span class="keywordflow">if</span> ( SecurityLimitInfo.SecurityLimitFlags &amp;
01896                             JOB_OBJECT_SECURITY_NO_ADMIN )
01897                 {
01898                     Job-&gt;SecurityLimitFlags |= JOB_OBJECT_SECURITY_NO_ADMIN ;
01899 
01900                     <span class="keywordflow">if</span> ( Job-&gt;Token )
01901                     {
01902                         <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d3/token_8c.html#a4">SeTokenIsAdmin</a>( Job-&gt;Token ) )
01903                         {
01904                             Job-&gt;SecurityLimitFlags &amp;= (~JOB_OBJECT_SECURITY_NO_ADMIN);
01905 
01906                             st = STATUS_INVALID_PARAMETER ;
01907                         }
01908                     }
01909                 }
01910 
01911                 <span class="keywordflow">if</span> ( SecurityLimitInfo.SecurityLimitFlags &amp;
01912                             JOB_OBJECT_SECURITY_RESTRICTED_TOKEN )
01913                 {
01914                     <span class="keywordflow">if</span> ( Job-&gt;SecurityLimitFlags &amp;
01915                             ( JOB_OBJECT_SECURITY_ONLY_TOKEN | JOB_OBJECT_SECURITY_FILTER_TOKENS ) )
01916                     {
01917                         st = STATUS_INVALID_PARAMETER ;
01918                     }
01919                     <span class="keywordflow">else</span>
01920                     {
01921                         Job-&gt;SecurityLimitFlags |= JOB_OBJECT_SECURITY_RESTRICTED_TOKEN ;
01922                     }
01923                 }
01924 
01925                 <span class="comment">//</span>
01926                 <span class="comment">// The forcible token is a little more interesting.  It</span>
01927                 <span class="comment">// cannot be reset, so if there is a pointer there already,</span>
01928                 <span class="comment">// fail the call.  If a filter is already in place, this is</span>
01929                 <span class="comment">// not allowed, either.  If no-admin is set, it is checked</span>
01930                 <span class="comment">// at the end, once the token has been ref'd.</span>
01931                 <span class="comment">//</span>
01932 
01933                 <span class="keywordflow">if</span> ( SecurityLimitInfo.SecurityLimitFlags &amp;
01934                             JOB_OBJECT_SECURITY_ONLY_TOKEN )
01935                 {
01936                     <span class="keywordflow">if</span> ( Job-&gt;Token ||
01937                          (Job-&gt;SecurityLimitFlags &amp; JOB_OBJECT_SECURITY_FILTER_TOKENS) )
01938                     {
01939                         st = STATUS_INVALID_PARAMETER ;
01940                     }
01941                     <span class="keywordflow">else</span>
01942                     {
01943                         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01944                                              SecurityLimitInfo.JobToken,
01945                                             TOKEN_ASSIGN_PRIMARY |
01946                                                 TOKEN_IMPERSONATE |
01947                                                 TOKEN_DUPLICATE ,
01948                                             <a class="code" href="../../d0/d5/se_8h.html#a17">SeTokenObjectType</a>(),
01949                                             PreviousMode,
01950                                             &amp;LocalToken,
01951                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01952 
01953                         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( st ) )
01954                         {
01955                             st = <a class="code" href="../../d4/d3/token_8c.html#a20">SeIsChildTokenByPointer</a>( LocalToken,
01956                                                           &amp;<a class="code" href="../../d3/d9/client_2wow_8c.html#a18">IsChild</a> );
01957 
01958                             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( st ) )
01959                             {
01960                                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( LocalToken );
01961                             }
01962                         }
01963 
01964 
01965                         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( st ) )
01966                         {
01967                             <span class="comment">//</span>
01968                             <span class="comment">// If the token supplied is not a restricted token</span>
01969                             <span class="comment">// based on the caller's ID, then they must have</span>
01970                             <span class="comment">// assign primary privilege in order to associate</span>
01971                             <span class="comment">// the token with the job.</span>
01972                             <span class="comment">//</span>
01973 
01974                             <span class="keywordflow">if</span> ( !<a class="code" href="../../d3/d9/client_2wow_8c.html#a18">IsChild</a> )
01975                             {
01976                                 HasPrivilege = <a class="code" href="../../d8/d4/privileg_8c.html#a4">SeCheckPrivilegedObject</a>(
01977                                                    <a class="code" href="../../d0/d5/se_8h.html#a80">SeAssignPrimaryTokenPrivilege</a>,
01978                                                    JobHandle,
01979                                                    JOB_OBJECT_SET_SECURITY_ATTRIBUTES,
01980                                                    PreviousMode
01981                                                    );
01982 
01983                                 <span class="keywordflow">if</span> ( !HasPrivilege )
01984                                 {
01985                                     st = STATUS_PRIVILEGE_NOT_HELD;
01986                                 }
01987                             }
01988 
01989                             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( st ) )
01990                             {
01991                                 <span class="comment">//</span>
01992                                 <span class="comment">// Grab a reference to the token into the job</span>
01993                                 <span class="comment">// object</span>
01994                                 <span class="comment">//</span>
01995 
01996                                 Job-&gt;Token = LocalToken ;
01997 
01998                                 <span class="comment">//</span>
01999                                 <span class="comment">// Not surprisingly, specifying no-admin and</span>
02000                                 <span class="comment">// supplying an admin token is a no-no.</span>
02001                                 <span class="comment">//</span>
02002 
02003                                 <span class="keywordflow">if</span> ( (Job-&gt;SecurityLimitFlags &amp; JOB_OBJECT_SECURITY_NO_ADMIN) &amp;&amp;
02004                                       <a class="code" href="../../d4/d3/token_8c.html#a4">SeTokenIsAdmin</a>( Job-&gt;Token ) )
02005                                 {
02006                                     st = STATUS_INVALID_PARAMETER ;
02007 
02008                                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Job-&gt;Token );
02009 
02010                                     Job-&gt;Token = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
02011                                 }
02012                                 <span class="keywordflow">else</span>
02013                                 {
02014                                     Job-&gt;SecurityLimitFlags |= JOB_OBJECT_SECURITY_ONLY_TOKEN ;
02015                                 }
02016 
02017                             }
02018                             <span class="keywordflow">else</span>
02019                             {
02020                                 <span class="comment">//</span>
02021                                 <span class="comment">// This is the token was a child or otherwise ok,</span>
02022                                 <span class="comment">// but assign primary was not held, so the</span>
02023                                 <span class="comment">// request was rejected.</span>
02024                                 <span class="comment">//</span>
02025 
02026                                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( LocalToken );
02027                             }
02028 
02029                         }
02030 
02031                     }
02032                 }
02033                 <span class="keywordflow">if</span> ( SecurityLimitInfo.SecurityLimitFlags &amp;
02034                             JOB_OBJECT_SECURITY_FILTER_TOKENS )
02035                 {
02036                     <span class="keywordflow">if</span> ( Job-&gt;SecurityLimitFlags &amp;
02037                           ( JOB_OBJECT_SECURITY_ONLY_TOKEN |
02038                             JOB_OBJECT_SECURITY_FILTER_TOKENS ) )
02039                     {
02040                         st = STATUS_INVALID_PARAMETER ;
02041                     }
02042                     <span class="keywordflow">else</span>
02043                     {
02044                         <span class="comment">//</span>
02045                         <span class="comment">// capture the token restrictions</span>
02046                         <span class="comment">//</span>
02047 
02048                         st = <a class="code" href="../../d8/d1/psp_8h.html#a99">PspCaptureTokenFilter</a>(
02049                                 PreviousMode,
02050                                 &amp;SecurityLimitInfo,
02051                                 &amp;<a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>
02052                                 );
02053 
02054                         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( st ) )
02055                         {
02056                             Job-&gt;SecurityLimitFlags |= JOB_OBJECT_SECURITY_FILTER_TOKENS ;
02057                             Job-&gt;Filter = <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a> ;
02058                         }
02059 
02060                     }
02061                 }
02062 
02063             }
02064         }
02065         <span class="keywordflow">break</span>;
02066 
02067     <span class="keywordflow">case</span> JobObjectEndOfJobTimeInformation:
02068 
02069         <span class="keywordflow">try</span> {
02070             RtlCopyMemory(&amp;EndOfJobInfo,JobObjectInformation,RequiredLength);
02071             }
02072         except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
02073             st = GetExceptionCode();
02074             }
02075 
02076         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
02077             <span class="comment">//</span>
02078             <span class="comment">// sanity check LimitFlags</span>
02079             <span class="comment">//</span>
02080             <span class="keywordflow">if</span> ( EndOfJobInfo.EndOfJobTimeAction &gt; JOB_OBJECT_POST_AT_END_OF_JOB ) {
02081                 st = STATUS_INVALID_PARAMETER;
02082                 }
02083             <span class="keywordflow">else</span> {
02084                 Job-&gt;EndOfJobTimeAction = EndOfJobInfo.EndOfJobTimeAction;
02085                 }
02086             }
02087         <span class="keywordflow">break</span>;
02088 
02089     <span class="keywordflow">case</span> JobObjectAssociateCompletionPortInformation:
02090 
02091         <span class="keywordflow">try</span> {
02092             RtlCopyMemory(&amp;AssociateInfo,JobObjectInformation,RequiredLength);
02093             }
02094         except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
02095             st = GetExceptionCode();
02096             }
02097 
02098         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
02099             <span class="keywordflow">if</span> ( !Job-&gt;CompletionPort &amp;&amp; AssociateInfo.CompletionPort ) {
02100                 st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02101                         AssociateInfo.CompletionPort,
02102                         IO_COMPLETION_MODIFY_STATE,
02103                         <a class="code" href="../../d3/d5/iodata_8c.html#a34">IoCompletionObjectType</a>,
02104                         PreviousMode,
02105                         &amp;IoCompletion,
02106                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02107                         );
02108 
02109                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
02110                     Job-&gt;CompletionKey = AssociateInfo.CompletionKey;
02111                     Job-&gt;CompletionPort = IoCompletion;
02112 
02113                     <span class="comment">//</span>
02114                     <span class="comment">// Now whip through ALL existing processes in the job</span>
02115                     <span class="comment">// and send notification messages</span>
02116                     <span class="comment">//</span>
02117 
02118                     Next = Job-&gt;ProcessListHead.Flink;
02119 
02120                     <span class="keywordflow">while</span> ( Next != &amp;Job-&gt;ProcessListHead) {
02121 
02122                         Process = (<a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>)(CONTAINING_RECORD(Next,<a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>,JobLinks));
02123 
02124 
02125                         <span class="comment">//</span>
02126                         <span class="comment">// If the process is really considered part of the job, has</span>
02127                         <span class="comment">// been assigned its id, and has not yet checked in, do it now</span>
02128                         <span class="comment">//</span>
02129 
02130                         <span class="keywordflow">if</span> ( !(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a9">PS_JOB_STATUS_NOT_REALLY_ACTIVE</a>)
02131                              &amp;&amp; Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a>
02132                              &amp;&amp; !(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a11">PS_JOB_STATUS_NEW_PROCESS_REPORTED</a>)) {
02133 
02134                             <a class="code" href="../../d1/d9/ps_8h.html#a8">PS_SET_CLEAR_BITS</a> (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a>,
02135                                                <a class="code" href="../../d1/d9/ps_8h.html#a11">PS_JOB_STATUS_NEW_PROCESS_REPORTED</a>,
02136                                                <a class="code" href="../../d1/d9/ps_8h.html#a14">PS_JOB_STATUS_LAST_REPORT_MEMORY</a>);
02137 
02138                             <a class="code" href="../../d5/d4/complete_8c.html#a6">IoSetIoCompletion</a>(
02139                                 Job-&gt;CompletionPort,
02140                                 Job-&gt;CompletionKey,
02141                                 (PVOID)Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a>,
02142                                 STATUS_SUCCESS,
02143                                 JOB_OBJECT_MSG_NEW_PROCESS,
02144                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
02145                                 );
02146 
02147                             }
02148                         Next = Next-&gt;Flink;
02149                         }
02150                     }
02151                 }
02152             <span class="keywordflow">else</span> {
02153                 st = STATUS_INVALID_PARAMETER;
02154                 }
02155             }
02156         <span class="keywordflow">break</span>;
02157 
02158 
02159     <span class="keywordflow">default</span>:
02160 
02161         st = STATUS_INVALID_INFO_CLASS;
02162     }
02163 
02164     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;Job-&gt;JobLock);
02165 
02166     <span class="comment">//</span>
02167     <span class="comment">// Working Set Changes are processed outside of the job lock.</span>
02168     <span class="comment">//</span>
02169     <span class="comment">// calling MmAdjust CAN NOT cause MM to call PsChangeJobMemoryUsage !</span>
02170     <span class="comment">//</span>
02171 
02172     <span class="keywordflow">if</span> ( ProcessWorkingSetHead ) {
02173         <span class="keywordflow">if</span> ( !IsListEmpty(&amp;<a class="code" href="../../d8/d1/psp_8h.html#a20">PspWorkingSetChangeHead</a>.<a class="code" href="../../d7/d4/struct__JOB__WORKING__SET__CHANGE__HEAD.html#o0">Links</a>) ) {
02174             <span class="keywordflow">while</span> ( !IsListEmpty(&amp;<a class="code" href="../../d8/d1/psp_8h.html#a20">PspWorkingSetChangeHead</a>.<a class="code" href="../../d7/d4/struct__JOB__WORKING__SET__CHANGE__HEAD.html#o0">Links</a>) ) {
02175                 Next = RemoveHeadList(&amp;<a class="code" href="../../d8/d1/psp_8h.html#a20">PspWorkingSetChangeHead</a>.<a class="code" href="../../d7/d4/struct__JOB__WORKING__SET__CHANGE__HEAD.html#o0">Links</a>);
02176                 WsChangeRecord = CONTAINING_RECORD(Next,<a class="code" href="../../d8/d4/struct__JOB__WORKING__SET__CHANGE__RECORD.html">JOB_WORKING_SET_CHANGE_RECORD</a>,Links);
02177                 <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>(&amp;WsChangeRecord-&gt;<a class="code" href="../../d8/d4/struct__JOB__WORKING__SET__CHANGE__RECORD.html#o1">Process</a>-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>);
02178 
02179                 <a class="code" href="../../d4/d0/wslist_8c.html#a31">MmAdjustWorkingSetSize</a>(
02180                     <a class="code" href="../../d8/d1/psp_8h.html#a20">PspWorkingSetChangeHead</a>.<a class="code" href="../../d7/d4/struct__JOB__WORKING__SET__CHANGE__HEAD.html#o2">MinimumWorkingSetSize</a>,
02181                     <a class="code" href="../../d8/d1/psp_8h.html#a20">PspWorkingSetChangeHead</a>.<a class="code" href="../../d7/d4/struct__JOB__WORKING__SET__CHANGE__HEAD.html#o3">MaximumWorkingSetSize</a>,
02182                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
02183                     );
02184 
02185                 <span class="comment">//</span>
02186                 <span class="comment">// call MM to Enable hard workingset</span>
02187                 <span class="comment">//</span>
02188 
02189                 <a class="code" href="../../d4/d0/wslist_8c.html#a22">MmEnforceWorkingSetLimit</a>(&amp;WsChangeRecord-&gt;<a class="code" href="../../d8/d4/struct__JOB__WORKING__SET__CHANGE__RECORD.html#o1">Process</a>-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02190                 <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
02191                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(WsChangeRecord-&gt;<a class="code" href="../../d8/d4/struct__JOB__WORKING__SET__CHANGE__RECORD.html#o1">Process</a>);
02192                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(WsChangeRecord);
02193                 }
02194             }
02195         <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>(&amp;<a class="code" href="../../d8/d1/psp_8h.html#a20">PspWorkingSetChangeHead</a>.<a class="code" href="../../d7/d4/struct__JOB__WORKING__SET__CHANGE__HEAD.html#o1">Lock</a>);
02196         }
02197     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02198 
02199 
02200     <span class="comment">//</span>
02201     <span class="comment">// Finish Up</span>
02202     <span class="comment">//</span>
02203 
02204     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Job);
02205 
02206     <span class="keywordflow">return</span> st;
02207 }
02208 
02209 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02210"></a><a class="code" href="../../d8/d1/psp_8h.html#a95">02210</a> <a class="code" href="../../d8/d1/psp_8h.html#a95">PspApplyJobLimitsToProcessSet</a>(
02211     <a class="code" href="../../d0/d3/struct__EJOB.html">PEJOB</a> Job
02212     )
02213 {
02214 
02215     PLIST_ENTRY Next;
02216     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
02217     <a class="code" href="../../d8/d4/struct__JOB__WORKING__SET__CHANGE__RECORD.html">PJOB_WORKING_SET_CHANGE_RECORD</a> WsChangeRecord;
02218 
02219     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02220 
02221     <span class="comment">//</span>
02222     <span class="comment">// The job object is held exclusive by the caller</span>
02223     <span class="comment">//</span>
02224 
02225     Next = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o2">ProcessListHead</a>.Flink;
02226 
02227     <span class="keywordflow">while</span> ( Next != &amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o2">ProcessListHead</a>) {
02228 
02229         Process = (<a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>)(CONTAINING_RECORD(Next,<a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>,JobLinks));
02230         <span class="keywordflow">if</span> ( !(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a9">PS_JOB_STATUS_NOT_REALLY_ACTIVE</a>) ) {
02231             <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp; JOB_OBJECT_LIMIT_WORKINGSET ) {
02232                 WsChangeRecord = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
02233                                         <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
02234                                         <span class="keyword">sizeof</span>( *WsChangeRecord ),
02235                                         'rCsP'
02236                                         );
02237                 <span class="keywordflow">if</span> ( WsChangeRecord ) {
02238                     WsChangeRecord-&gt;Process = Process;
02239                     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(Process);
02240                     <span class="comment">//</span>
02241                     <span class="comment">// Avoid double delete since process could be in delete routine during the above ref</span>
02242                     <span class="comment">//</span>
02243                     <span class="keywordflow">if</span> ( <a class="code" href="../../d7/d1/obref_8c.html#a1">ObGetObjectPointerCount</a>(Process) &gt; 1 ) {
02244                         InsertTailList(&amp;<a class="code" href="../../d8/d1/psp_8h.html#a20">PspWorkingSetChangeHead</a>.<a class="code" href="../../d7/d4/struct__JOB__WORKING__SET__CHANGE__HEAD.html#o0">Links</a>,&amp;WsChangeRecord-&gt;Links);
02245                         }
02246                     <span class="keywordflow">else</span> {
02247                         <span class="comment">//</span>
02248                         <span class="comment">// process is possibly in delete routine waiting to come</span>
02249                         <span class="comment">// out of job. DON'T Dereference !</span>
02250                         <span class="comment">//</span>
02251                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(WsChangeRecord);
02252                         }
02253                     }
02254                 }
02255             <a class="code" href="../../d8/d1/psp_8h.html#a96">PspApplyJobLimitsToProcess</a>(Job,Process);
02256             }
02257         Next = Next-&gt;Flink;
02258         }
02259 }
02260 
02261 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02262"></a><a class="code" href="../../d8/d1/psp_8h.html#a96">02262</a> <a class="code" href="../../d8/d1/psp_8h.html#a96">PspApplyJobLimitsToProcess</a>(
02263     <a class="code" href="../../d0/d3/struct__EJOB.html">PEJOB</a> Job,
02264     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
02265     )
02266 {
02267 
02268     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02269     PLIST_ENTRY Next;
02270     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
02271 
02272     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02273 
02274     <span class="comment">//</span>
02275     <span class="comment">// The job object is held exclusive by the caller</span>
02276     <span class="comment">//</span>
02277 
02278     <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp; JOB_OBJECT_LIMIT_PRIORITY_CLASS ) {
02279         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o68">PriorityClass</a> = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o19">PriorityClass</a>;
02280 
02281         <a class="code" href="../../d9/d1/psquery_8c.html#a24">PsSetProcessPriorityByClass</a>(
02282                 Process,
02283                 Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o12">MemoryPriority</a> == <a class="code" href="../../d1/d9/ps_8h.html#a3">MEMORY_PRIORITY_FOREGROUND</a> ?
02284                     <a class="code" href="../../d1/d9/ps_8h.html#a159a109">PsProcessPriorityForeground</a> : <a class="code" href="../../d1/d9/ps_8h.html#a159a108">PsProcessPriorityBackground</a>
02285                 );
02286         }
02287 
02288     <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp; JOB_OBJECT_LIMIT_AFFINITY ) {
02289 
02290         <span class="comment">//</span>
02291         <span class="comment">// the following allows this api to properly if</span>
02292         <span class="comment">// called while the exiting process is blocked holding the</span>
02293         <span class="comment">// createdeletelock. This can happen during debugger/server</span>
02294         <span class="comment">// lpc transactions that occur in pspexitthread</span>
02295         <span class="comment">//</span>
02296 
02297         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/ps_2create_8c.html#a22">PsLockProcess</a>(Process,KeGetPreviousMode(),<a class="code" href="../../d1/d9/ps_8h.html#a155a89">PsLockPollOnTimeout</a>);
02298 
02299         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS ) {
02300             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o10">Affinity</a> = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o18">Affinity</a>;
02301 
02302             Next = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o87">ThreadListHead</a>.Flink;
02303 
02304             <span class="keywordflow">while</span> ( Next != &amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o87">ThreadListHead</a>) {
02305 
02306                 Thread = (<a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>)(CONTAINING_RECORD(Next,<a class="code" href="../../d5/d6/struct__ETHREAD.html">ETHREAD</a>,ThreadListEntry));
02307                 <a class="code" href="../../d9/d1/thredobj_8c.html#a18">KeSetAffinityThread</a>(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>,Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o18">Affinity</a>);
02308                 Next = Next-&gt;Flink;
02309                 }
02310 
02311             <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
02312             }
02313         }
02314 
02315     <span class="keywordflow">if</span> ( !(Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp; JOB_OBJECT_LIMIT_WORKINGSET) ) {
02316         <span class="comment">//</span>
02317         <span class="comment">// call MM to disable hard workingset</span>
02318         <span class="comment">//</span>
02319 
02320         <a class="code" href="../../d4/d0/wslist_8c.html#a22">MmEnforceWorkingSetLimit</a>(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02321         }
02322 
02323     <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o41">MemoryLimitsLock</a>);
02324     <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp; JOB_OBJECT_LIMIT_PROCESS_MEMORY  ) {
02325         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o85">CommitChargeLimit</a> = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o36">ProcessMemoryLimit</a>;
02326         }
02327     <span class="keywordflow">else</span> {
02328         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o85">CommitChargeLimit</a> = 0;
02329         }
02330     <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o41">MemoryLimitsLock</a>);
02331 
02332     <span class="comment">//</span>
02333     <span class="comment">// If the process is NOT IDLE Priority Class, and long fixed quantums</span>
02334     <span class="comment">// are in use, use the scheduling class stored in the job object for this process</span>
02335     <span class="comment">//</span>
02336     <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o68">PriorityClass</a> != PROCESS_PRIORITY_CLASS_IDLE ) {
02337 
02338         <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d1/psinit_8c.html#a37">PspUseJobSchedulingClasses</a> ) {
02339             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o13">ThreadQuantum</a> = <a class="code" href="../../d0/d1/psinit_8c.html#a38">PspJobSchedulingClasses</a>[Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o28">SchedulingClass</a>];
02340             }
02341         <span class="comment">//</span>
02342         <span class="comment">// if the scheduling class is PSP_NUMBER_OF_SCHEDULING_CLASSES-1, then</span>
02343         <span class="comment">// give this process non-preemptive scheduling</span>
02344         <span class="comment">//</span>
02345         <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o28">SchedulingClass</a> == <a class="code" href="../../d8/d1/psp_8h.html#a8">PSP_NUMBER_OF_SCHEDULING_CLASSES</a>-1 ) {
02346             <a class="code" href="../../d3/d5/procobj_8c.html#a12">KeSetDisableQuantumProcess</a>(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02347             }
02348         <span class="keywordflow">else</span> {
02349             <a class="code" href="../../d3/d5/procobj_8c.html#a12">KeSetDisableQuantumProcess</a>(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02350             }
02351 
02352         }
02353 
02354 
02355 }
02356 
02357 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02358"></a><a class="code" href="../../d1/d1/psjob_8c.html#a15">02358</a> <a class="code" href="../../d1/d1/psjob_8c.html#a15">NtTerminateJobObject</a>(
02359     IN HANDLE JobHandle,
02360     IN NTSTATUS ExitStatus
02361     )
02362 {
02363     <a class="code" href="../../d0/d3/struct__EJOB.html">PEJOB</a> Job;
02364     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
02365     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
02366 
02367     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02368 
02369     PreviousMode = KeGetPreviousMode();
02370     st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02371             JobHandle,
02372             JOB_OBJECT_TERMINATE,
02373             <a class="code" href="../../d9/d8/ntos_8h.html#a4">PsJobType</a>,
02374             PreviousMode,
02375             (PVOID *)&amp;Job,
02376             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02377             );
02378     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
02379         <span class="keywordflow">return</span> st;
02380         }
02381 
02382     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
02383     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;Job-&gt;JobLock, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02384 
02385     <a class="code" href="../../d8/d1/psp_8h.html#a97">PspTerminateAllProcessesInJob</a>(Job,ExitStatus,<a class="code" href="../../d1/d9/ps_8h.html#a155a89">PsLockPollOnTimeout</a>);
02386 
02387     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;Job-&gt;JobLock);
02388     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02389 
02390     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Job);
02391 
02392     <span class="keywordflow">return</span> st;
02393 }
02394 
02395 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02396"></a><a class="code" href="../../d1/d1/psjob_8c.html#a16">02396</a> <a class="code" href="../../d1/d1/psjob_8c.html#a16">PsEnforceExecutionTimeLimits</a>(
02397     VOID
02398     )
02399 {
02400     PLIST_ENTRY NextJob;
02401     PLIST_ENTRY NextProcess;
02402     LARGE_INTEGER RunningJobTime;
02403     LARGE_INTEGER ProcessTime;
02404     <a class="code" href="../../d0/d3/struct__EJOB.html">PEJOB</a> Job;
02405     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
02406     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
02407 
02408     ExAcquireFastMutex(&amp;<a class="code" href="../../d0/d1/psinit_8c.html#a25">PspJobListLock</a>);
02409 
02410     <span class="comment">//</span>
02411     <span class="comment">// Look at each job. If time limits are set for the job, then enforce them</span>
02412     <span class="comment">//</span>
02413     NextJob = <a class="code" href="../../d0/d1/psinit_8c.html#a26">PspJobList</a>.Flink;
02414     <span class="keywordflow">while</span> ( NextJob != &amp;<a class="code" href="../../d0/d1/psinit_8c.html#a26">PspJobList</a> ) {
02415         Job = (<a class="code" href="../../d0/d3/struct__EJOB.html">PEJOB</a>)(CONTAINING_RECORD(NextJob,<a class="code" href="../../d0/d3/struct__EJOB.html">EJOB</a>,JobLinks));
02416         <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp; (JOB_OBJECT_LIMIT_PROCESS_TIME | JOB_OBJECT_LIMIT_JOB_TIME) ) {
02417 
02418             <span class="comment">//</span>
02419             <span class="comment">// Job looks like a candidate for time enforcing. Need to get the</span>
02420             <span class="comment">// job lock to be sure, but we don't want to hang waiting for the</span>
02421             <span class="comment">// job lock, so skip the job until next time around if we need to</span>
02422             <span class="comment">//</span>
02423             <span class="comment">//</span>
02424 
02425             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o3">JobLock</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ) {
02426 
02427                 <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp; (JOB_OBJECT_LIMIT_PROCESS_TIME | JOB_OBJECT_LIMIT_JOB_TIME) ) {
02428 
02429                     <span class="comment">//</span>
02430                     <span class="comment">// Job is setup for time limits</span>
02431                     <span class="comment">//</span>
02432 
02433                     RunningJobTime.QuadPart = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o6">ThisPeriodTotalUserTime</a>.QuadPart;
02434 
02435                     NextProcess = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o2">ProcessListHead</a>.Flink;
02436 
02437                     <span class="keywordflow">while</span> ( NextProcess != &amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o2">ProcessListHead</a>) {
02438 
02439                         Process = (<a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>)(CONTAINING_RECORD(NextProcess,<a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>,JobLinks));
02440 
02441                         ProcessTime.QuadPart = UInt32x32To64(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o5">UserTime</a>,<a class="code" href="../../d4/d9/ke_8h.html#a131">KeMaximumIncrement</a>);
02442 
02443                         <span class="keywordflow">if</span> ( !(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a10">PS_JOB_STATUS_ACCOUNTING_FOLDED</a>) ) {
02444                             RunningJobTime.QuadPart += ProcessTime.QuadPart;
02445                             }
02446 
02447                         <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp; JOB_OBJECT_LIMIT_PROCESS_TIME ) {
02448                             <span class="keywordflow">if</span> ( ProcessTime.QuadPart &gt; Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o12">PerProcessUserTimeLimit</a>.QuadPart ) {
02449 
02450                                 <span class="comment">//</span>
02451                                 <span class="comment">// Process Time Limit has been exceeded.</span>
02452                                 <span class="comment">//</span>
02453                                 <span class="comment">// Reference the process. Assert that it is not in its</span>
02454                                 <span class="comment">// delete routine. If all is OK, then nuke and dereferece</span>
02455                                 <span class="comment">// the process</span>
02456                                 <span class="comment">//</span>
02457 
02458                                 <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(Process);
02459 
02460                                 <span class="comment">//</span>
02461                                 <span class="comment">// Avoid double delete since process could be in delete routine during the above ref</span>
02462                                 <span class="comment">//</span>
02463                                 <span class="keywordflow">if</span> ( <a class="code" href="../../d7/d1/obref_8c.html#a1">ObGetObjectPointerCount</a>(Process) &gt; 1 ) {
02464 
02465                                     <span class="keywordflow">if</span> ( !(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a9">PS_JOB_STATUS_NOT_REALLY_ACTIVE</a>) ) {
02466                                         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d1/psp_8h.html#a94">PspTerminateProcess</a>(Process,ERROR_NOT_ENOUGH_QUOTA,<a class="code" href="../../d1/d9/ps_8h.html#a155a90">PsLockReturnTimeout</a>) == STATUS_SUCCESS ) {
02467 
02468                                             Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o11">TotalTerminatedProcesses</a>++;
02469                                             <a class="code" href="../../d1/d9/ps_8h.html#a8">PS_SET_CLEAR_BITS</a> (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a>,
02470                                                                <a class="code" href="../../d1/d9/ps_8h.html#a9">PS_JOB_STATUS_NOT_REALLY_ACTIVE</a>,
02471                                                                <a class="code" href="../../d1/d9/ps_8h.html#a14">PS_JOB_STATUS_LAST_REPORT_MEMORY</a>);
02472                                             Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o10">ActiveProcesses</a>--;
02473 
02474                                             <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a> ) {
02475                                                 <a class="code" href="../../d5/d4/complete_8c.html#a6">IoSetIoCompletion</a>(
02476                                                     Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a>,
02477                                                     Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o26">CompletionKey</a>,
02478                                                     (PVOID)Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a>,
02479                                                     STATUS_SUCCESS,
02480                                                     JOB_OBJECT_MSG_END_OF_PROCESS_TIME,
02481                                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
02482                                                     );
02483                                                 }
02484                                             <a class="code" href="../../d8/d1/psp_8h.html#a98">PspFoldProcessAccountingIntoJob</a>(Job,Process);
02485 
02486                                             }
02487                                         }
02488                                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
02489                                     }
02490                                 }
02491                             }
02492 
02493                         NextProcess = NextProcess-&gt;Flink;
02494                         }
02495                     <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp; JOB_OBJECT_LIMIT_JOB_TIME ) {
02496                         <span class="keywordflow">if</span> ( RunningJobTime.QuadPart &gt; Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o13">PerJobUserTimeLimit</a>.QuadPart ) {
02497 
02498                             <span class="comment">//</span>
02499                             <span class="comment">// Job Time Limit has been exceeded.</span>
02500                             <span class="comment">//</span>
02501                             <span class="comment">// Perform the appropriate action</span>
02502                             <span class="comment">//</span>
02503 
02504                             <span class="keywordflow">switch</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o24">EndOfJobTimeAction</a> ) {
02505 
02506                             <span class="keywordflow">case</span> JOB_OBJECT_TERMINATE_AT_END_OF_JOB:
02507                                 <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d1/psp_8h.html#a97">PspTerminateAllProcessesInJob</a>(Job,ERROR_NOT_ENOUGH_QUOTA,<a class="code" href="../../d1/d9/ps_8h.html#a155a90">PsLockReturnTimeout</a>) ) {
02508                                     <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o10">ActiveProcesses</a> == 0 ) {
02509                                         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o0">Event</a>,0,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02510                                         <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a> ) {
02511                                             <a class="code" href="../../d1/d9/ps_8h.html#a7">PS_CLEAR_BITS</a> (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a>, <a class="code" href="../../d1/d9/ps_8h.html#a14">PS_JOB_STATUS_LAST_REPORT_MEMORY</a>);
02512                                             <a class="code" href="../../d5/d4/complete_8c.html#a6">IoSetIoCompletion</a>(
02513                                                 Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a>,
02514                                                 Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o26">CompletionKey</a>,
02515                                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02516                                                 STATUS_SUCCESS,
02517                                                 JOB_OBJECT_MSG_END_OF_JOB_TIME,
02518                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
02519                                                 );
02520                                             }
02521                                         }
02522                                     }
02523                                 <span class="keywordflow">break</span>;
02524 
02525                             <span class="keywordflow">case</span> JOB_OBJECT_POST_AT_END_OF_JOB:
02526 
02527                                 <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a> ) {
02528                                     <a class="code" href="../../d1/d9/ps_8h.html#a7">PS_CLEAR_BITS</a> (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a>, <a class="code" href="../../d1/d9/ps_8h.html#a14">PS_JOB_STATUS_LAST_REPORT_MEMORY</a>);
02529                                     st = <a class="code" href="../../d5/d4/complete_8c.html#a6">IoSetIoCompletion</a>(
02530                                             Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a>,
02531                                             Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o26">CompletionKey</a>,
02532                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02533                                             STATUS_SUCCESS,
02534                                             JOB_OBJECT_MSG_END_OF_JOB_TIME,
02535                                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
02536                                             );
02537                                     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
02538 
02539                                         <span class="comment">//</span>
02540                                         <span class="comment">// Clear job level time limit</span>
02541                                         <span class="comment">//</span>
02542 
02543                                         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp;= ~JOB_OBJECT_LIMIT_JOB_TIME;
02544                                         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o13">PerJobUserTimeLimit</a>.QuadPart = 0;
02545                                         }
02546                                     }
02547                                 <span class="keywordflow">else</span> {
02548                                     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d1/psp_8h.html#a97">PspTerminateAllProcessesInJob</a>(Job,ERROR_NOT_ENOUGH_QUOTA,<a class="code" href="../../d1/d9/ps_8h.html#a155a90">PsLockReturnTimeout</a>) ) {
02549                                         <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o10">ActiveProcesses</a> == 0 ) {
02550                                             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o0">Event</a>,0,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02551                                             }
02552                                         }
02553                                     }
02554                                 <span class="keywordflow">break</span>;
02555                                 }
02556                             }
02557 
02558                         }
02559 
02560                     }
02561                 <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o3">JobLock</a>);
02562                 }
02563             }
02564         NextJob = NextJob-&gt;Flink;
02565         }
02566     ExReleaseFastMutex(&amp;<a class="code" href="../../d0/d1/psinit_8c.html#a25">PspJobListLock</a>);
02567 }
02568 
02569 BOOLEAN
<a name="l02570"></a><a class="code" href="../../d8/d1/psp_8h.html#a97">02570</a> <a class="code" href="../../d8/d1/psp_8h.html#a97">PspTerminateAllProcessesInJob</a>(
02571     <a class="code" href="../../d0/d3/struct__EJOB.html">PEJOB</a> Job,
02572     NTSTATUS Status,
02573     PSLOCKPROCESSMODE LockMode
02574     )
02575 {
02576     PLIST_ENTRY NextProcess;
02577     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
02578     BOOLEAN TerminatedAProcess;
02579 
02580     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02581 
02582     TerminatedAProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02583     NextProcess = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o2">ProcessListHead</a>.Flink;
02584 
02585     <span class="keywordflow">while</span> ( NextProcess != &amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o2">ProcessListHead</a>) {
02586 
02587         Process = (<a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>)(CONTAINING_RECORD(NextProcess,<a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>,JobLinks));
02588 
02589         <span class="comment">//</span>
02590         <span class="comment">// Reference the process. Assert that it is not in its</span>
02591         <span class="comment">// delete routine. If all is OK, then nuke and dereferece</span>
02592         <span class="comment">// the process</span>
02593         <span class="comment">//</span>
02594 
02595         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(Process);
02596 
02597         <span class="comment">//</span>
02598         <span class="comment">// Avoid double delete since process could be in delete routine during the above ref</span>
02599         <span class="comment">//</span>
02600         <span class="keywordflow">if</span> ( <a class="code" href="../../d7/d1/obref_8c.html#a1">ObGetObjectPointerCount</a>(Process) &gt; 1 ) {
02601             <span class="keywordflow">if</span> ( !(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a9">PS_JOB_STATUS_NOT_REALLY_ACTIVE</a>) ) {
02602 
02603                 <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d1/psp_8h.html#a94">PspTerminateProcess</a>(Process,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>,LockMode) == STATUS_SUCCESS ) {
02604 
02605                     <span class="comment">//</span>
02606                     <span class="comment">// If the lockmode isn't poll, it means we ran out of</span>
02607                     <span class="comment">// job time, so increment the terminated process count</span>
02608                     <span class="comment">// for each nuked process</span>
02609                     <span class="comment">//</span>
02610                     <span class="keywordflow">if</span> ( LockMode != <a class="code" href="../../d1/d9/ps_8h.html#a155a89">PsLockPollOnTimeout</a> ) {
02611                         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o11">TotalTerminatedProcesses</a>++;
02612                         }
02613                     <a class="code" href="../../d1/d9/ps_8h.html#a6">PS_SET_BITS</a> (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a>, <a class="code" href="../../d1/d9/ps_8h.html#a9">PS_JOB_STATUS_NOT_REALLY_ACTIVE</a>);
02614                     Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o10">ActiveProcesses</a>--;
02615 
02616                     <a class="code" href="../../d8/d1/psp_8h.html#a98">PspFoldProcessAccountingIntoJob</a>(Job,Process);
02617 
02618                     TerminatedAProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02619                     }
02620                 }
02621 
02622             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
02623             }
02624 
02625         NextProcess = NextProcess-&gt;Flink;
02626         }
02627     <span class="keywordflow">return</span> TerminatedAProcess;
02628 }
02629 
02630 
02631 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02632"></a><a class="code" href="../../d8/d1/psp_8h.html#a98">02632</a> <a class="code" href="../../d8/d1/psp_8h.html#a98">PspFoldProcessAccountingIntoJob</a>(
02633     <a class="code" href="../../d0/d3/struct__EJOB.html">PEJOB</a> Job,
02634     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
02635     )
02636 {
02637     LARGE_INTEGER UserTime, KernelTime;
02638 
02639     <span class="keywordflow">if</span> ( !(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a10">PS_JOB_STATUS_ACCOUNTING_FOLDED</a>) ) {
02640         UserTime.QuadPart = UInt32x32To64(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o5">UserTime</a>,<a class="code" href="../../d4/d9/ke_8h.html#a131">KeMaximumIncrement</a>);
02641         KernelTime.QuadPart = UInt32x32To64(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o4">KernelTime</a>,<a class="code" href="../../d4/d9/ke_8h.html#a131">KeMaximumIncrement</a>);
02642 
02643         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o4">TotalUserTime</a>.QuadPart += UserTime.QuadPart;
02644         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o5">TotalKernelTime</a>.QuadPart += KernelTime.QuadPart;
02645         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o6">ThisPeriodTotalUserTime</a>.QuadPart += UserTime.QuadPart;
02646         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o7">ThisPeriodTotalKernelTime</a>.QuadPart += KernelTime.QuadPart;
02647 
02648         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o29">ReadOperationCount</a> += Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o79">ReadOperationCount</a>.QuadPart;
02649         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o30">WriteOperationCount</a> += Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o80">WriteOperationCount</a>.QuadPart;
02650         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o31">OtherOperationCount</a> += Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o81">OtherOperationCount</a>.QuadPart;
02651         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o32">ReadTransferCount</a> += Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o82">ReadTransferCount</a>.QuadPart;
02652         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o33">WriteTransferCount</a> += Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o83">WriteTransferCount</a>.QuadPart;
02653         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o34">OtherTransferCount</a> += Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o84">OtherTransferCount</a>.QuadPart;
02654 
02655         Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o8">TotalPageFaultCount</a> += Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a>;
02656 
02657 
02658         <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o86">CommitChargePeak</a> &gt; Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o38">PeakProcessMemoryUsed</a> ) {
02659             Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o38">PeakProcessMemoryUsed</a> = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o86">CommitChargePeak</a>;
02660             }
02661 
02662         <a class="code" href="../../d1/d9/ps_8h.html#a8">PS_SET_CLEAR_BITS</a> (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a>,
02663                            <a class="code" href="../../d1/d9/ps_8h.html#a10">PS_JOB_STATUS_ACCOUNTING_FOLDED</a>,
02664                            <a class="code" href="../../d1/d9/ps_8h.html#a14">PS_JOB_STATUS_LAST_REPORT_MEMORY</a>);
02665 
02666         <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a> &amp;&amp; Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o10">ActiveProcesses</a> == 0) {
02667             <a class="code" href="../../d5/d4/complete_8c.html#a6">IoSetIoCompletion</a>(
02668                 Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a>,
02669                 Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o26">CompletionKey</a>,
02670                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02671                 STATUS_SUCCESS,
02672                 JOB_OBJECT_MSG_ACTIVE_PROCESS_ZERO,
02673                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
02674                 );
02675             }
02676         }
02677 }
02678 
02679 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02680"></a><a class="code" href="../../d8/d1/psp_8h.html#a99">02680</a> <a class="code" href="../../d8/d1/psp_8h.html#a99">PspCaptureTokenFilter</a>(
02681     KPROCESSOR_MODE PreviousMode,
02682     PJOBOBJECT_SECURITY_LIMIT_INFORMATION SecurityLimitInfo,
02683     <a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html">PPS_JOB_TOKEN_FILTER</a> * TokenFilter
02684     )
02685 {
02686     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
02687     <a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html">PPS_JOB_TOKEN_FILTER</a> <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a> ;
02688 
02689     <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
02690                                     <span class="keyword">sizeof</span>( <a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html">PS_JOB_TOKEN_FILTER</a> ),
02691                                     'fTsP' );
02692 
02693     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a> )
02694     {
02695         *TokenFilter = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
02696 
02697         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES ;
02698     }
02699 
02700     RtlZeroMemory( <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>, <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d9/ps_8h.html#a43">PS_JOB_TOKEN_FILTER</a> ) );
02701 
02702     <span class="keywordflow">try</span> {
02703 
02704         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS ;
02705 
02706         <span class="comment">//</span>
02707         <span class="comment">//  Capture Sids to remove</span>
02708         <span class="comment">//</span>
02709 
02710         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( SecurityLimitInfo-&gt;SidsToDisable)) {
02711 
02712             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( SecurityLimitInfo-&gt;SidsToDisable,
02713                           <span class="keyword">sizeof</span>(TOKEN_GROUPS),
02714                           <span class="keyword">sizeof</span>(ULONG) );
02715 
02716             <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedGroupCount = SecurityLimitInfo-&gt;SidsToDisable-&gt;GroupCount;
02717 
02718             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a14">SeCaptureSidAndAttributesArray</a>(
02719                         SecurityLimitInfo-&gt;SidsToDisable-&gt;Groups,
02720                         <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedGroupCount,
02721                         PreviousMode,
02722                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0,
02723                         <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
02724                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02725                         &amp;<a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedGroups,
02726                         &amp;<a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedGroupsLength
02727                         );
02728 
02729         }
02730 
02731         <span class="comment">//</span>
02732         <span class="comment">//  Capture PrivilegesToDelete</span>
02733         <span class="comment">//</span>
02734 
02735         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp;
02736             ARGUMENT_PRESENT(SecurityLimitInfo-&gt;PrivilegesToDelete)) {
02737 
02738             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( SecurityLimitInfo-&gt;PrivilegesToDelete,
02739                           <span class="keyword">sizeof</span>(TOKEN_PRIVILEGES),
02740                           <span class="keyword">sizeof</span>(ULONG) );
02741 
02742             <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedPrivilegeCount = SecurityLimitInfo-&gt;PrivilegesToDelete-&gt;PrivilegeCount;
02743 
02744             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a12">SeCaptureLuidAndAttributesArray</a>(
02745                          SecurityLimitInfo-&gt;PrivilegesToDelete-&gt;Privileges,
02746                          <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedPrivilegeCount,
02747                          PreviousMode,
02748                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0,
02749                          <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
02750                          <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02751                          &amp;<a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedPrivileges,
02752                          &amp;<a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedPrivilegesLength
02753                          );
02754 
02755         }
02756 
02757         <span class="comment">//</span>
02758         <span class="comment">//  Capture Restricted Sids</span>
02759         <span class="comment">//</span>
02760 
02761         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp;
02762             ARGUMENT_PRESENT(SecurityLimitInfo-&gt;RestrictedSids)) {
02763 
02764             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( SecurityLimitInfo-&gt;RestrictedSids,
02765                           <span class="keyword">sizeof</span>(TOKEN_GROUPS),
02766                           <span class="keyword">sizeof</span>(ULONG) );
02767 
02768             <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedSidCount = SecurityLimitInfo-&gt;RestrictedSids-&gt;GroupCount;
02769 
02770             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a14">SeCaptureSidAndAttributesArray</a>(
02771                         SecurityLimitInfo-&gt;RestrictedSids-&gt;Groups,
02772                         <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedSidCount,
02773                         PreviousMode,
02774                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0,
02775                         <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
02776                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02777                         &amp;<a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedSids,
02778                         &amp;<a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedSidsLength
02779                         );
02780 
02781         }
02782 
02783 
02784 
02785     } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
02786 
02787         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
02788     }  <span class="comment">// end_try</span>
02789 
02790     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) )
02791     {
02792         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedSids )
02793         {
02794             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedSids );
02795         }
02796 
02797         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedPrivileges )
02798         {
02799             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedPrivileges );
02800         }
02801 
02802         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedGroups )
02803         {
02804             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedGroups );
02805         }
02806 
02807         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a> );
02808 
02809         <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
02810 
02811     }
02812 
02813     *TokenFilter = <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a> ;
02814 
02815     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
02816 
02817 
02818 }
02819 
02820 
02821 
02822 BOOLEAN
<a name="l02823"></a><a class="code" href="../../d1/d1/psjob_8c.html#a20">02823</a> <a class="code" href="../../d1/d1/psjob_8c.html#a20">PsChangeJobMemoryUsage</a>(
02824     SSIZE_T Amount
02825     )
02826 {
02827     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
02828     <a class="code" href="../../d0/d3/struct__EJOB.html">PEJOB</a> Job;
02829     SIZE_T CurrentJobMemoryUsed;
02830     BOOLEAN ReturnValue;
02831 
02832     ReturnValue = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02833     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
02834     Job = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>;
02835     <span class="keywordflow">if</span> ( Job ) {
02836         <span class="comment">//</span>
02837         <span class="comment">// This routine can be called while hoolding the process lock (during</span>
02838         <span class="comment">// teb deletion... So instead of using the job lock, we must use the</span>
02839         <span class="comment">// memory limits lock. The lock order is always (job lock followed by</span>
02840         <span class="comment">// process lock. The memory limits lock never nests or calls other</span>
02841         <span class="comment">// code while held. It can be grapped while holding the job lock, or the process</span>
02842         <span class="comment">// lock.</span>
02843         <span class="comment">//</span>
02844         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
02845         <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o41">MemoryLimitsLock</a>);
02846 
02847         CurrentJobMemoryUsed = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o40">CurrentJobMemoryUsed</a> + Amount;
02848 
02849         <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp; JOB_OBJECT_LIMIT_JOB_MEMORY &amp;&amp;
02850              CurrentJobMemoryUsed &gt; Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o37">JobMemoryLimit</a> ) {
02851             CurrentJobMemoryUsed = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o40">CurrentJobMemoryUsed</a>;
02852             ReturnValue = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02853 
02854 
02855 
02856             <span class="comment">//</span>
02857             <span class="comment">// Tell the job port that commit has been exceeded, and process id x</span>
02858             <span class="comment">// was the one that hit it.</span>
02859             <span class="comment">//</span>
02860 
02861             <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a>
02862                  &amp;&amp; Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a>
02863                  &amp;&amp; (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a11">PS_JOB_STATUS_NEW_PROCESS_REPORTED</a>)
02864                  &amp;&amp; (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a14">PS_JOB_STATUS_LAST_REPORT_MEMORY</a>) == 0) {
02865 
02866                 <a class="code" href="../../d1/d9/ps_8h.html#a6">PS_SET_BITS</a> (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a>, <a class="code" href="../../d1/d9/ps_8h.html#a14">PS_JOB_STATUS_LAST_REPORT_MEMORY</a>);
02867                 <a class="code" href="../../d5/d4/complete_8c.html#a6">IoSetIoCompletion</a>(
02868                     Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a>,
02869                     Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o26">CompletionKey</a>,
02870                     (PVOID)Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a>,
02871                     STATUS_SUCCESS,
02872                     JOB_OBJECT_MSG_JOB_MEMORY_LIMIT,
02873                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
02874                     );
02875 
02876                 }
02877             }
02878 
02879         <span class="keywordflow">if</span> ( ReturnValue ) {
02880             <span class="comment">//</span>
02881             <span class="comment">// update current and peak counters</span>
02882             <span class="comment">//</span>
02883             Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o40">CurrentJobMemoryUsed</a> = CurrentJobMemoryUsed;
02884             <span class="keywordflow">if</span> ( CurrentJobMemoryUsed &gt; Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o39">PeakJobMemoryUsed</a> ) {
02885                 Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o39">PeakJobMemoryUsed</a> = CurrentJobMemoryUsed;
02886                 }
02887 
02888             <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a> + Amount &gt; Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o38">PeakProcessMemoryUsed</a> ) {
02889                 Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o38">PeakProcessMemoryUsed</a> = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a> + Amount;
02890                 }
02891             }
02892         <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o41">MemoryLimitsLock</a>);
02893         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02894         }
02895 
02896     <span class="keywordflow">return</span> ReturnValue;
02897 }
02898 
02899 
02900 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02901"></a><a class="code" href="../../d1/d1/psjob_8c.html#a21">02901</a> <a class="code" href="../../d1/d1/psjob_8c.html#a21">PsReportProcessMemoryLimitViolation</a>(
02902     VOID
02903     )
02904 {
02905     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
02906     <a class="code" href="../../d0/d3/struct__EJOB.html">PEJOB</a> Job;
02907 
02908     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
02909     Job = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>;
02910     <span class="keywordflow">if</span> ( Job &amp;&amp; (Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp; JOB_OBJECT_LIMIT_PROCESS_MEMORY) ) {
02911         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
02912         <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o41">MemoryLimitsLock</a>);
02913 
02914         <span class="comment">//</span>
02915         <span class="comment">// Tell the job port that commit has been exceeded, and process id x</span>
02916         <span class="comment">// was the one that hit it.</span>
02917         <span class="comment">//</span>
02918 
02919         <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a>
02920              &amp;&amp; Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a>
02921              &amp;&amp; (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a11">PS_JOB_STATUS_NEW_PROCESS_REPORTED</a>)
02922              &amp;&amp; (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a14">PS_JOB_STATUS_LAST_REPORT_MEMORY</a>) == 0) {
02923 
02924             <a class="code" href="../../d1/d9/ps_8h.html#a6">PS_SET_BITS</a> (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a>, <a class="code" href="../../d1/d9/ps_8h.html#a14">PS_JOB_STATUS_LAST_REPORT_MEMORY</a>);
02925             <a class="code" href="../../d5/d4/complete_8c.html#a6">IoSetIoCompletion</a>(
02926                 Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o25">CompletionPort</a>,
02927                 Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o26">CompletionKey</a>,
02928                 (PVOID)Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a>,
02929                 STATUS_SUCCESS,
02930                 JOB_OBJECT_MSG_PROCESS_MEMORY_LIMIT,
02931                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
02932                 );
02933 
02934             }
02935         <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o41">MemoryLimitsLock</a>);
02936         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02937 
02938         }
02939 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:32 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
