<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ctsertl.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ctsertl.c</h1><a href="../../d1/d1/ctsertl_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    ctsertl.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    Common security RTL test routines.</span>
00012 <span class="comment"></span>
00013 <span class="comment">    These routines are used in both the kernel and user mode RTL tests.</span>
00014 <span class="comment"></span>
00015 <span class="comment"></span>
00016 <span class="comment"></span>
00017 <span class="comment">Author:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Jim Kelly       (JimK)     23-Mar-1990</span>
00020 <span class="comment"></span>
00021 <span class="comment">Environment:</span>
00022 <span class="comment"></span>
00023 <span class="comment">    Test of security.</span>
00024 <span class="comment"></span>
00025 <span class="comment">Revision History:</span>
00026 <span class="comment"></span>
00027 <span class="comment">--*/</span>
00028 
00029 <span class="preprocessor">#include "<a class="code" href="../../d2/d6/tsecomm_8c.html">tsecomm.c</a>"</span>
00030 
00031 
00032 
00033 
00035 <span class="comment">//                                                            //</span>
00036 <span class="comment">// Test routines                                              //</span>
00037 <span class="comment">//                                                            //</span>
00039 <span class="comment"></span>
00040 
00041 BOOLEAN
<a name="l00042"></a><a class="code" href="../../d1/d1/ctsertl_8c.html#a14">00042</a> <a class="code" href="../../d1/d1/ctsertl_8c.html#a14">TestSeSid</a>()
00043 {
00044 
00045 <span class="preprocessor">#define TARGET_SID_ARRAY_LENGTH   1024</span>
00046 <span class="preprocessor"></span>
00047 <span class="keyword">typedef</span> <span class="keyword">struct </span>_TALT_SID1 {
00048     ULONG Value[3];
00049 } TALT_SID1;
00050 <span class="keyword">typedef</span> TALT_SID1 *PTALT_SID1;
00051 
00052     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00053 
00054     PVOID Ignore;
00055 
00056     PSID TFredSid;
00057     PSID TBarneySid;
00058     PSID TWilmaSid;
00059     PSID TWilmaSubSid;
00060     PSID TNoSubSid;
00061     PSID TTempSid;
00062 
00063     PSID_AND_ATTRIBUTES SourceArray;
00064     PSID_AND_ATTRIBUTES TargetArray;
00065     ULONG TargetLength;
00066     ULONG OriginalTargetLength;
00067 
00068     ULONG <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>;
00069     ULONG <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>;
00070 
00071     <span class="comment">// Temporary Hack ...</span>
00072     <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a> = 7;
00073     <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a> = 15;
00074     <span class="comment">// End Temporary Hack...</span>
00075 
00076 
00077     TFredSid     = (PSID)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, 256 );
00078     TBarneySid   = (PSID)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, 256 );
00079     TWilmaSid    = (PSID)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, 256 );
00080     TWilmaSubSid = (PSID)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, 256 );
00081     TNoSubSid    = (PSID)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, 256 );
00082     TTempSid     = (PSID)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, 256 );
00083 
00084 
00085     <span class="comment">//</span>
00086     <span class="comment">// Valid SID structure test</span>
00087     <span class="comment">//</span>
00088 
00089     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( TFredSid )) {
00090         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00091         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlValidSid, TFredSid\n"</span>);
00092         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00093     }
00094 
00095     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( TBarneySid )) {
00096         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00097         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlValidSid, TBarneySid\n"</span>);
00098         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00099     }
00100 
00101     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( TWilmaSid )) {
00102         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00103         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlValidSid, TWilmaSid\n"</span>);
00104         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00105     }
00106 
00107     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( TWilmaSubSid )) {
00108         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00109         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlValidSid, TWilmaSubSid\n"</span>);
00110         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00111     }
00112 
00113     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( TNoSubSid )) {
00114         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00115         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlValidSid, TNoSubSid\n"</span>);
00116         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00117     }
00118 
00119 
00120     <span class="comment">//</span>
00121     <span class="comment">// Equal SIDs Test</span>
00122     <span class="comment">//</span>
00123 
00124     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( TFredSid, TBarneySid )) {
00125         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlEqualSid, TFredSid - TBarneySid\n"</span>);
00126         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00127         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00128     }
00129 
00130     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( TFredSid, TFredSid )) {
00131         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlEqualSid, TFredSid - TFredSid\n"</span>);
00132         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00133     }
00134 
00135     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( TWilmaSid, TWilmaSubSid )) {
00136         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00137         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlEqualSid, TWilmaSid - TWilmaSubSid\n"</span>);
00138         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00139     }
00140 
00141     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( TWilmaSid, TNoSubSid )) {
00142         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00143         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlEqualSid, TWilmaSid - TNoSubSid\n"</span>);
00144         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00145     }
00146 
00147 
00148     <span class="comment">//</span>
00149     <span class="comment">// Length Required test</span>
00150     <span class="comment">//</span>
00151 
00152     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( 0 ) != 8) {
00153         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00154         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlLengthRequiredSid, 0 SubAuthorities\n"</span>);
00155         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00156     }
00157 
00158     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( 1 ) != 12) {
00159         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00160         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlLengthRequiredSid, 1 SubAuthorities\n"</span>);
00161         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00162     }
00163 
00164     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( 2 ) != 16) {
00165         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00166         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlLengthRequiredSid, 2 SubAuthorities\n"</span>);
00167         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00168     }
00169 
00170 
00171     <span class="comment">//</span>
00172     <span class="comment">// Length of SID test</span>
00173     <span class="comment">//</span>
00174 
00175     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( TNoSubSid ) != 8) {
00176         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00177         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: SeLengthSid, TNoSubSid\n"</span>);
00178         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00179     }
00180 
00181     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( TFredSid ) != 12) {
00182         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00183         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: SeLengthSid, TFredSid\n"</span>);
00184         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00185     }
00186 
00187     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( TWilmaSubSid ) != 16) {
00188         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00189         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: SeLengthSid, TWilmaSubSid\n"</span>);
00190         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00191     }
00192 
00193 
00194     <span class="comment">//</span>
00195     <span class="comment">// Copy SID Test</span>
00196     <span class="comment">//</span>
00197 
00198     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( 7, TTempSid, TNoSubSid ))) {
00199         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00200         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlCopySid, insufficient TNoSubSid\n"</span>);
00201         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00202     }
00203 
00204 
00205     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( 256, TTempSid, TNoSubSid ))) {
00206         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00207         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlCopySid, TNoSubSid\n"</span>);
00208         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00209     }
00210 
00211     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( TTempSid, TNoSubSid )) {
00212         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00213         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlCopySid compare, TNoSubSid\n"</span>);
00214         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00215     }
00216 
00217 
00218     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( 11, TTempSid, TBarneySid ))) {
00219         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00220         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlCopySid, insufficient TBarneySid\n"</span>);
00221         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00222     }
00223 
00224 
00225     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( 256, TTempSid, TBarneySid ))) {
00226         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00227         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlCopySid, TBarneySid\n"</span>);
00228         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00229     }
00230 
00231     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( TTempSid, TBarneySid )) {
00232         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00233         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlCopySid compare, TBarneySid\n"</span>);
00234         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00235     }
00236 
00237     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( 15, TTempSid, TWilmaSubSid ))) {
00238         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00239         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlCopySid, insufficient TWilmaSubSid\n"</span>);
00240         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00241     }
00242 
00243     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( 256, TTempSid, TWilmaSubSid ))) {
00244         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00245         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlCopySid, TNoSubSid\n"</span>);
00246         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00247     }
00248 
00249     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( TTempSid, TWilmaSubSid )) {
00250         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00251         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlCopySid compare, TWilmaSubSid\n"</span>);
00252         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00253     }
00254 
00255 
00256     <span class="comment">//</span>
00257     <span class="comment">// Validate all the tsevars SIDs</span>
00258     <span class="comment">//</span>
00259 
00260     <span class="comment">//</span>
00261     <span class="comment">//  Bedrock SIDs</span>
00262     <span class="comment">//</span>
00263 
00264 
00265     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( <a class="code" href="../../d4/d6/tsevars_8c.html#a17">BedrockDomainSid</a> )) {
00266         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00267         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlValidSid, BedrockDomainSid\n"</span>);
00268         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00269     }
00270 
00271     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( <a class="code" href="../../d4/d6/tsevars_8c.html#a18">FredSid</a> )) {
00272         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00273         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlValidSid, FredSid\n"</span>);
00274         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00275     }
00276 
00277     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( <a class="code" href="../../d4/d6/tsevars_8c.html#a19">WilmaSid</a> )) {
00278         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00279         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlValidSid, WilmaSid\n"</span>);
00280         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00281     }
00282 
00283     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( <a class="code" href="../../d4/d6/tsevars_8c.html#a20">PebblesSid</a> )) {
00284         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00285         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlValidSid, PebblesSid\n"</span>);
00286         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00287     }
00288 
00289     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( <a class="code" href="../../d4/d6/tsevars_8c.html#a21">DinoSid</a> )) {
00290         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00291         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlValidSid, DinoSid\n"</span>);
00292         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00293     }
00294 
00295     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( <a class="code" href="../../d4/d6/tsevars_8c.html#a22">BarneySid</a> )) {
00296         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00297         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlValidSid, BarneySid\n"</span>);
00298         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00299     }
00300 
00301     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( <a class="code" href="../../d4/d6/tsevars_8c.html#a23">BettySid</a> )) {
00302         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00303         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlValidSid, BettySid\n"</span>);
00304         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00305     }
00306 
00307     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( <a class="code" href="../../d4/d6/tsevars_8c.html#a24">BambamSid</a> )) {
00308         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00309         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlValidSid, BambamSid\n"</span>);
00310         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00311     }
00312 
00313     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( <a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a> )) {
00314         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00315         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlValidSid, FlintstoneSid\n"</span>);
00316         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00317     }
00318 
00319     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( <a class="code" href="../../d4/d6/tsevars_8c.html#a26">RubbleSid</a> )) {
00320         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00321         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlValidSid, RubbleSid\n"</span>);
00322         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00323     }
00324 
00325     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( <a class="code" href="../../d4/d6/tsevars_8c.html#a27">AdultSid</a> )) {
00326         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00327         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlValidSid, AdultSid\n"</span>);
00328         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00329     }
00330 
00331     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( <a class="code" href="../../d4/d6/tsevars_8c.html#a28">ChildSid</a> )) {
00332         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00333         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlValidSid, ChildSid\n"</span>);
00334         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00335     }
00336 
00337     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( <a class="code" href="../../d4/d6/tsevars_8c.html#a29">NeandertholSid</a> )) {
00338         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00339         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlValidSid, NeandertholSid\n"</span>);
00340         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00341     }
00342 
00343     <span class="comment">//</span>
00344     <span class="comment">//  Well known SIDs</span>
00345     <span class="comment">//</span>
00346 
00347     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a7">NullSid</a> )) {
00348         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00349         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlValidSid, NullSid\n"</span>);
00350         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00351     }
00352 
00353     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a> )) {
00354         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00355         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlValidSid, WorldSid\n"</span>);
00356         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00357     }
00358 
00359     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a9">LocalSid</a> )) {
00360         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00361         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlValidSid, CreatorSid\n"</span>);
00362         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00363     }
00364 
00365     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a11">NtAuthoritySid</a> )) {
00366         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00367         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlValidSid, NtAuthoritySid\n"</span>);
00368         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00369     }
00370 
00371     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a12">DialupSid</a> )) {
00372         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00373         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlValidSid, DialupSid\n"</span>);
00374         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00375     }
00376 
00377     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a13">NetworkSid</a> )) {
00378         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00379         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlValidSid, NetworkSid\n"</span>);
00380         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00381     }
00382 
00383     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a14">BatchSid</a> )) {
00384         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00385         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlValidSid, BatchSid\n"</span>);
00386         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00387     }
00388 
00389     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a15">InteractiveSid</a> )) {
00390         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00391         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlValidSid, InteractiveSid\n"</span>);
00392         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00393     }
00394 
00395 
00396     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a16">LocalSystemSid</a> )) {
00397         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00398         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlValidSid, LocalSystemSid\n"</span>);
00399         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00400     }
00401 
00402 
00403 
00404 
00405     <span class="comment">//</span>
00406     <span class="comment">//  Test SidAndAttributesArray copy routine</span>
00407     <span class="comment">//</span>
00408 
00409     SourceArray = (PSID_AND_ATTRIBUTES)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, 100 );
00410     TargetArray = (PSID_AND_ATTRIBUTES)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00411                                                         <a class="code" href="../../d1/d1/ctsertl_8c.html#a0">TARGET_SID_ARRAY_LENGTH</a>
00412                                                         );
00413     TargetLength = <a class="code" href="../../d1/d1/ctsertl_8c.html#a0">TARGET_SID_ARRAY_LENGTH</a> - (5 * <span class="keyword">sizeof</span>(PSID_AND_ATTRIBUTES));
00414     OriginalTargetLength = TargetLength;
00415 
00416     SourceArray[0].Sid = &amp;<a class="code" href="../../d4/d6/tsevars_8c.html#a20">PebblesSid</a>;
00417     SourceArray[0].Attributes = 0;
00418     SourceArray[1].Sid = &amp;<a class="code" href="../../d4/d6/tsevars_8c.html#a25">FlintstoneSid</a>;
00419     SourceArray[1].Attributes = <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>;
00420     SourceArray[2].Sid = &amp;<a class="code" href="../../d4/d6/tsevars_8c.html#a28">ChildSid</a>;
00421     SourceArray[2].Attributes = <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>;
00422     SourceArray[3].Sid = &amp;<a class="code" href="../../d4/d6/tsevars_8c.html#a29">NeandertholSid</a>;
00423     SourceArray[3].Attributes = <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>;
00424     SourceArray[4].Sid = &amp;<a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>;
00425     SourceArray[4].Attributes = <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>;
00426 
00427     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a47">RtlCopySidAndAttributesArray</a>(
00428                  0,
00429                  SourceArray,
00430                  TargetLength,
00431                  TargetArray,
00432                  &amp;(TargetArray[5]),
00433                  &amp;(PSID)Ignore,
00434                  &amp;TargetLength
00435                  );
00436 
00437     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) || TargetLength != OriginalTargetLength ) {
00438         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00439         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtLCopySidAndAttributesArray, Zero length.\n"</span>);
00440         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00441     }
00442 
00443 
00444 
00445     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a47">RtlCopySidAndAttributesArray</a>(
00446                  1,
00447                  SourceArray,
00448                  1,                 <span class="comment">// too short buffer</span>
00449                  TargetArray,
00450                  &amp;(TargetArray[1]),
00451                  &amp;(PSID)Ignore,
00452                  &amp;TargetLength
00453                  );
00454 
00455     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00456         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00457         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtLCopySidAndAttributesArray,\n"</span>);
00458         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**              Buffer Too Short Test.\n"</span>);
00459         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00460     }
00461 
00462 
00463     TargetLength = <a class="code" href="../../d1/d1/ctsertl_8c.html#a0">TARGET_SID_ARRAY_LENGTH</a> - (5 * <span class="keyword">sizeof</span>(PSID_AND_ATTRIBUTES));
00464     OriginalTargetLength = TargetLength;
00465 
00466     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a47">RtlCopySidAndAttributesArray</a>(
00467                  5,
00468                  SourceArray,
00469                  TargetLength,
00470                  TargetArray,
00471                  &amp;(TargetArray[5]),
00472                  &amp;(PSID)Ignore,
00473                  &amp;TargetLength
00474                  );
00475 
00476     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ||
00477         !<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( SourceArray[0].Sid, TargetArray[0].Sid ) ||
00478         !<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( SourceArray[1].Sid, TargetArray[1].Sid ) ||
00479         !<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( SourceArray[2].Sid, TargetArray[2].Sid ) ||
00480         !<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( SourceArray[3].Sid, TargetArray[3].Sid ) ||
00481         !<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( SourceArray[4].Sid, TargetArray[4].Sid ) ||
00482         ( SourceArray[0].Attributes != TargetArray[0].Attributes )  ||
00483         ( SourceArray[1].Attributes != TargetArray[1].Attributes )  ||
00484         ( SourceArray[2].Attributes != TargetArray[2].Attributes )  ||
00485         ( SourceArray[3].Attributes != TargetArray[3].Attributes )  ||
00486         ( SourceArray[4].Attributes != TargetArray[4].Attributes ) ) {
00487 
00488         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00489         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtLCopySidAndAttributesArray,\n"</span>);
00490         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**              Valid copy of 5 SIDs test.\n"</span>);
00491         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00492     }
00493 
00494 
00495 
00496     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00497 
00498 
00499 }
00500 
00501 
00502 BOOLEAN
<a name="l00503"></a><a class="code" href="../../d1/d1/ctsertl_8c.html#a15">00503</a> <a class="code" href="../../d1/d1/ctsertl_8c.html#a15">TestSeSecurityDescriptor</a>()
00504 {
00505     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00506     PSECURITY_DESCRIPTOR TFredDescriptor;
00507     PSECURITY_DESCRIPTOR TBarneyDescriptor;
00508     PSECURITY_DESCRIPTOR TWilmaDescriptor;
00509 
00510     PSECURITY_DESCRIPTOR TTempDescriptor;
00511 
00512     SECURITY_DESCRIPTOR_CONTROL Control;
00513     ULONG Revision;
00514 
00515     PACL <a class="code" href="../../d0/d1/ctseacc_8c.html#a13">TDacl</a>;
00516     BOOLEAN <a class="code" href="../../d0/d1/ctseacc_8c.html#a14">TDaclPresent</a>;
00517     BOOLEAN <a class="code" href="../../d0/d1/ctseacc_8c.html#a15">TDaclDefaulted</a>;
00518 
00519     PACL <a class="code" href="../../d0/d1/ctseacc_8c.html#a16">TSacl</a>;
00520     BOOLEAN <a class="code" href="../../d0/d1/ctseacc_8c.html#a17">TSaclPresent</a>;
00521     BOOLEAN <a class="code" href="../../d0/d1/ctseacc_8c.html#a18">TSaclDefaulted</a>;
00522 
00523     PSID <a class="code" href="../../d0/d1/ctseacc_8c.html#a19">TOwner</a>;
00524     BOOLEAN <a class="code" href="../../d0/d1/ctseacc_8c.html#a20">TOwnerDefaulted</a>;
00525     PSID <a class="code" href="../../d0/d1/ctseacc_8c.html#a21">TGroup</a>;
00526     BOOLEAN <a class="code" href="../../d0/d1/ctseacc_8c.html#a22">TGroupDefaulted</a>;
00527 
00528 
00529     PSID TFredSid;
00530     PSID TBarneySid;
00531     PSID TWilmaSid;
00532     PSID TWilmaSubSid;
00533     PSID TNoSubSid;
00534     PSID TTempSid;
00535 
00536 
00537     TFredDescriptor   = (PSECURITY_DESCRIPTOR)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, 1024 );
00538     TBarneyDescriptor = (PSECURITY_DESCRIPTOR)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, 1024 );
00539     TWilmaDescriptor  = (PSECURITY_DESCRIPTOR)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, 1024 );
00540     TTempDescriptor   = (PSECURITY_DESCRIPTOR)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, 1024 );
00541 
00542 
00543     TFredSid     = (PSID)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, 256 );
00544     TBarneySid   = (PSID)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, 256 );
00545     TWilmaSid    = (PSID)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, 256 );
00546     TWilmaSubSid = (PSID)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, 256 );
00547     TNoSubSid    = (PSID)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, 256 );
00548     TTempSid     = (PSID)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, 256 );
00549 
00550 
00551     <span class="comment">//</span>
00552     <span class="comment">// Build an ACL or two for use.</span>
00553 
00554     <a class="code" href="../../d0/d1/ctseacc_8c.html#a13">TDacl</a>        = (PACL)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, 256 );
00555     <a class="code" href="../../d0/d1/ctseacc_8c.html#a16">TSacl</a>        = (PACL)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, 256 );
00556 
00557     <a class="code" href="../../d0/d1/ctseacc_8c.html#a13">TDacl</a>-&gt;AclRevision=<a class="code" href="../../d0/d1/ctseacc_8c.html#a16">TSacl</a>-&gt;AclRevision=ACL_REVISION;
00558     <a class="code" href="../../d0/d1/ctseacc_8c.html#a13">TDacl</a>-&gt;Sbz1=<a class="code" href="../../d0/d1/ctseacc_8c.html#a16">TSacl</a>-&gt;Sbz1=0;
00559     <a class="code" href="../../d0/d1/ctseacc_8c.html#a13">TDacl</a>-&gt;Sbz2=<a class="code" href="../../d0/d1/ctseacc_8c.html#a16">TSacl</a>-&gt;Sbz2=0;
00560     <a class="code" href="../../d0/d1/ctseacc_8c.html#a13">TDacl</a>-&gt;AclSize=256;
00561     <a class="code" href="../../d0/d1/ctseacc_8c.html#a16">TSacl</a>-&gt;AclSize=8;
00562     <a class="code" href="../../d0/d1/ctseacc_8c.html#a13">TDacl</a>-&gt;AceCount=<a class="code" href="../../d0/d1/ctseacc_8c.html#a16">TSacl</a>-&gt;AceCount=0;
00563 
00564 
00565     <span class="comment">//</span>
00566     <span class="comment">// Create Security Descriptor test</span>
00567     <span class="comment">//</span>
00568 
00569     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>( TTempDescriptor, 0 ))) {
00570         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00571         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlCreateSecurityDescriptor, Rev=0\n"</span>);
00572         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00573     }
00574 
00575     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>( TTempDescriptor, 2 ))) {
00576         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00577         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlCreateSecurityDescriptor, Rev=2\n"</span>);
00578         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00579     }
00580 
00581     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>( TTempDescriptor, 1 ))) {
00582         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00583         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlCreateSecurityDescriptor, Rev=1\n"</span>);
00584         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00585     }
00586 
00587 <span class="preprocessor">#ifdef NOT_YET_DEBUGGED</span>
00588 <span class="preprocessor"></span>    <span class="comment">//</span>
00589     <span class="comment">// Make sure fields have been set properly</span>
00590     <span class="comment">//</span>
00591 
00592     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a58">RtlGetControlSecurityDescriptor</a>( TTempDescriptor,
00593                                                &amp;Control,
00594                                                &amp;Revision))) {
00595         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00596         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlGetControlSecurityDescriptor\n"</span>);
00597         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Call failed.  Status = 0x%lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00598         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00599     }
00600 
00601     <span class="keywordflow">if</span> ( (Control != 0) || (Revision != 1) ) {
00602         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00603         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlGetControlSecurityDescriptor\n"</span>);
00604         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Bad Control or Revision value. \n"</span>);
00605         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Status = 0x%lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00606         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Returned Revision = 0x%lx\n"</span>,Revision );
00607         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Returned Control  = 0x%lx\n"</span>, (ULONG)Control);
00608         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00609     }
00610 <span class="preprocessor">#else</span>
00611 <span class="preprocessor"></span>    DBG_UNREFERENCED_LOCAL_VARIABLE( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00612     DBG_UNREFERENCED_LOCAL_VARIABLE( Revision );
00613     DBG_UNREFERENCED_LOCAL_VARIABLE( Control );
00614 <span class="preprocessor">#endif //NOT_YET_DEFINED</span>
00615 <span class="preprocessor"></span>
00616     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a61">RtlGetDaclSecurityDescriptor</a>( TTempDescriptor,
00617                                                &amp;<a class="code" href="../../d0/d1/ctseacc_8c.html#a14">TDaclPresent</a>,
00618                                                &amp;<a class="code" href="../../d0/d1/ctseacc_8c.html#a13">TDacl</a>,
00619                                                &amp;<a class="code" href="../../d0/d1/ctseacc_8c.html#a15">TDaclDefaulted</a>))) {
00620         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00621         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlGetDaclSecurityDescriptor, Empty\n"</span>);
00622         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00623     }
00624 
00625     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/ctseacc_8c.html#a14">TDaclPresent</a>) {
00626         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00627         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlGetDaclSecurityDescriptor, Empty-TDaclPresent\n"</span>);
00628         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00629     }
00630 
00631     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a63">RtlGetSaclSecurityDescriptor</a>( TTempDescriptor,
00632                                                &amp;<a class="code" href="../../d0/d1/ctseacc_8c.html#a17">TSaclPresent</a>,
00633                                                &amp;<a class="code" href="../../d0/d1/ctseacc_8c.html#a16">TSacl</a>,
00634                                                &amp;<a class="code" href="../../d0/d1/ctseacc_8c.html#a18">TSaclDefaulted</a>))) {
00635         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00636         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlGetSaclSecurityDescriptor, Empty\n"</span>);
00637         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00638     }
00639 
00640     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/ctseacc_8c.html#a17">TSaclPresent</a>) {
00641         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00642         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlGetSaclSecurityDescriptor, Empty-TSaclPresent\n"</span>);
00643         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00644     }
00645 
00646     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a65">RtlGetOwnerSecurityDescriptor</a>( TTempDescriptor,
00647                                                 &amp;<a class="code" href="../../d0/d1/ctseacc_8c.html#a19">TOwner</a>,
00648                                                 &amp;<a class="code" href="../../d0/d1/ctseacc_8c.html#a20">TOwnerDefaulted</a>))) {
00649         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00650         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlGetOwnerSecurityDescriptor, Empty\n"</span>);
00651         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00652     }
00653 
00654     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/ctseacc_8c.html#a19">TOwner</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00655         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00656         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlGetOwnerSecurityDescriptor, Empty-TOwner\n"</span>);
00657         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00658     }
00659 
00660     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a67">RtlGetGroupSecurityDescriptor</a>( TTempDescriptor,
00661                                                 &amp;<a class="code" href="../../d0/d1/ctseacc_8c.html#a21">TGroup</a>,
00662                                                 &amp;<a class="code" href="../../d0/d1/ctseacc_8c.html#a22">TGroupDefaulted</a>))) {
00663         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00664         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlGetGroupSecurityDescriptor, Empty\n"</span>);
00665         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00666     }
00667 
00668     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/ctseacc_8c.html#a21">TGroup</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00669         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00670         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlGetGroupSecurityDescriptor, Empty-TGroup\n"</span>);
00671         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00672     }
00673 
00674     <span class="comment">//</span>
00675     <span class="comment">// Valid Security Descriptor test</span>
00676     <span class="comment">//</span>
00677 
00678     ((SECURITY_DESCRIPTOR *)TTempDescriptor)-&gt;Revision=0;
00679     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a55">RtlValidSecurityDescriptor</a>( TTempDescriptor )) {
00680         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00681         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlValidSecurityDescriptor, Rev=0\n"</span>);
00682         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00683     }
00684     ((SECURITY_DESCRIPTOR *)TTempDescriptor)-&gt;Revision=1;
00685 
00686     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a55">RtlValidSecurityDescriptor</a>( TTempDescriptor )) {
00687         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00688         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlValidSecurityDescriptor, Empty\n"</span>);
00689         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00690     }
00691 
00692 
00693     <span class="comment">//</span>
00694     <span class="comment">// Length test</span>
00695     <span class="comment">//</span>
00696 
00697     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a56">RtlLengthSecurityDescriptor</a>( TTempDescriptor ) != 20) {
00698         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00699         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlLengthSecurityDescriptor, Empty\n"</span>);
00700         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00701     }
00702 
00703     <span class="comment">//</span>
00704     <span class="comment">// Add in an owner</span>
00705     <span class="comment">//</span>
00706 
00707     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a64">RtlSetOwnerSecurityDescriptor</a>( TTempDescriptor, TWilmaSid, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ))) {
00708         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00709         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlSetOwnerSecurityDescriptor, TWilmaSid\n"</span>);
00710         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00711     }
00712     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a56">RtlLengthSecurityDescriptor</a>( TTempDescriptor ) != 32) {
00713         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00714         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlLengthSecurityDescriptor, Wilma Owner\n"</span>);
00715         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00716     }
00717 
00718     <span class="comment">//</span>
00719     <span class="comment">// Add in a Dacl</span>
00720     <span class="comment">//</span>
00721 
00722     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a>( TTempDescriptor, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00723                                               <a class="code" href="../../d0/d1/ctseacc_8c.html#a13">TDacl</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ))) {
00724         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00725         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlSetDaclSecurityDescriptor, TDacl\n"</span>);
00726         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00727     }
00728     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a56">RtlLengthSecurityDescriptor</a>( TTempDescriptor ) != 40) {
00729         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00730         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlLengthSecurityDescriptor, TDacl Dacl\n"</span>);
00731         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00732     }
00733 
00734     <span class="comment">//</span>
00735     <span class="comment">// Add in a Sacl</span>
00736     <span class="comment">//</span>
00737 
00738     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a62">RtlSetSaclSecurityDescriptor</a>( TTempDescriptor, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00739                                               <a class="code" href="../../d0/d1/ctseacc_8c.html#a16">TSacl</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ))) {
00740         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00741         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlSetSaclSecurityDescriptor, TSacl\n"</span>);
00742         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00743     }
00744     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a56">RtlLengthSecurityDescriptor</a>( TTempDescriptor ) != 48) {
00745         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00746         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlLengthSecurityDescriptor, TSacl Sacl\n"</span>);
00747         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00748     }
00749 
00750     <span class="comment">//</span>
00751     <span class="comment">// Add in a Group (with 2 sub-authorities)</span>
00752     <span class="comment">//</span>
00753 
00754     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a66">RtlSetGroupSecurityDescriptor</a>( TTempDescriptor, TWilmaSubSid, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ))) {
00755         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00756         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlSetGroupSecurityDescriptor, TWilmaSubSid\n"</span>);
00757         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00758     }
00759     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a56">RtlLengthSecurityDescriptor</a>( TTempDescriptor ) != 64) {
00760         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00761         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"*Se**     Failure: RtlLengthSecurityDescriptor, WilmaSub Group\n"</span>);
00762         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00763     }
00764 
00765 
00766     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00767 
00768 }
00769 
00770 
00771 BOOLEAN
<a name="l00772"></a><a class="code" href="../../d1/d1/ctsertl_8c.html#a16">00772</a> <a class="code" href="../../d1/d1/ctsertl_8c.html#a16">TestSeAccessMask</a>()
00773 {
00774     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00775 }
00776 
00777 
00778 
00779 
00780 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00781"></a><a class="code" href="../../d1/d1/ctsertl_8c.html#a17">00781</a> <a class="code" href="../../d1/d1/ctsertl_8c.html#a17">DumpAclSizeInfo</a>(PACL_SIZE_INFORMATION AclSizeInfo)
00782 {
00783     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
00784     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Acl size info:\n"</span>);
00785     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"AceCount = %d\n"</span>,AclSizeInfo-&gt;AceCount);
00786     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"AclBytesInUse = %d\n"</span>,AclSizeInfo-&gt;AclBytesInUse);
00787     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"AclBytesFree = %d\n"</span>,AclSizeInfo-&gt;AclBytesFree);
00788     <span class="keywordflow">return</span>;
00789 }
00790 
<a name="l00791"></a><a class="code" href="../../d1/d1/ctsertl_8c.html#a1">00791</a> <span class="preprocessor">#define NUM_ACE 6</span>
00792 <span class="preprocessor"></span>
<a name="l00793"></a><a class="code" href="../../d3/d3/struct__SIMPLE__ACE.html">00793</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d3/d3/struct__SIMPLE__ACE.html">_SIMPLE_ACE</a> {
<a name="l00794"></a><a class="code" href="../../d3/d3/struct__SIMPLE__ACE.html#o0">00794</a>     ACE_HEADER <a class="code" href="../../d3/d3/struct__SIMPLE__ACE.html#o0">Header</a>;
<a name="l00795"></a><a class="code" href="../../d3/d3/struct__SIMPLE__ACE.html#o1">00795</a>     ACCESS_MASK <a class="code" href="../../d3/d3/struct__SIMPLE__ACE.html#o1">Mask</a>;
<a name="l00796"></a><a class="code" href="../../d3/d3/struct__SIMPLE__ACE.html#o2">00796</a>     SID <a class="code" href="../../d3/d3/struct__SIMPLE__ACE.html#o2">Sid</a>;
00797     } <a class="code" href="../../d3/d3/struct__SIMPLE__ACE.html">SIMPLE_ACE</a>, *<a class="code" href="../../d3/d3/struct__SIMPLE__ACE.html">PSIMPLE_ACE</a>;
00798 
00799 
00800 BOOLEAN
<a name="l00801"></a><a class="code" href="../../d1/d1/ctsertl_8c.html#a18">00801</a> <a class="code" href="../../d1/d1/ctsertl_8c.html#a18">TestSeAclRtl</a>()
00802 {
00803 
00804     PACL    <a class="code" href="../../d0/d1/ctseacc_8c.html#a13">TDacl</a>;
00805     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00806 
00807     ACL_REVISION_INFORMATION AclInformation;
00808     ACL_REVISION_INFORMATION AclInformationOut;
00809 
00810     ACL_SIZE_INFORMATION AclSizeInfo;
00811 
00812     PVOID AceList;
00813     PVOID Ace;
00814 
00815     ULONG AceSize;
00816 
00817 <span class="comment">//</span>
00818 <span class="comment">// Define the Dead domain</span>
00819 <span class="comment">//</span>
00820 <span class="comment">//     Dead Domain         S-1-54399-23-18-02</span>
00821 <span class="comment">//     Bobby               S-1-54399-23-18-02-2</span>
00822 <span class="comment">//     Jerry               S-1-54399-23-18-02-3</span>
00823 <span class="comment">//     Phil                S-1-54399-23-18-02-4</span>
00824 <span class="comment">//     Kreutzman           S-1-54399-23-18-02-5</span>
00825 <span class="comment">//     Brent               S-1-54399-23-18-02-6</span>
00826 <span class="comment">//     Micky               S-1-54399-23-18-02-7</span>
00827 <span class="comment">//</span>
00828 
00829 <span class="preprocessor">#define DEAD_AUTHORITY               {0,0,0,0,212,127}</span>
00830 <span class="preprocessor"></span><span class="preprocessor">#define DEAD_SUBAUTHORITY_0          0x00000017L</span>
00831 <span class="preprocessor"></span><span class="preprocessor">#define DEAD_SUBAUTHORITY_1          0x00000012L</span>
00832 <span class="preprocessor"></span><span class="preprocessor">#define DEAD_SUBAUTHORITY_2          0x00000002L</span>
00833 <span class="preprocessor"></span>
00834 <span class="preprocessor">#define BOBBY_RID               0x00000002</span>
00835 <span class="preprocessor"></span><span class="preprocessor">#define JERRY_RID               0x00000003</span>
00836 <span class="preprocessor"></span><span class="preprocessor">#define PHIL_RID                0x00000004</span>
00837 <span class="preprocessor"></span><span class="preprocessor">#define KREUTZMAN_RID           0x00000005</span>
00838 <span class="preprocessor"></span><span class="preprocessor">#define BRENT_RID               0x00000006</span>
00839 <span class="preprocessor"></span><span class="preprocessor">#define MICKY_RID               0x00000007</span>
00840 <span class="preprocessor"></span>
00841     PSID DeadDomainSid;
00842 
00843     PSID BobbySid;
00844     PSID JerrySid;
00845     PSID PhilSid;
00846     PSID KreutzmanSid;
00847     PSID BrentSid;
00848     PSID MickySid;
00849 
00850     ULONG SidWithZeroSubAuthorities;
00851     ULONG SidWithOneSubAuthority;
00852     ULONG SidWithThreeSubAuthorities;
00853     ULONG SidWithFourSubAuthorities;
00854 
00855     SID_IDENTIFIER_AUTHORITY DeadAuthority = <a class="code" href="../../d1/d1/ctsertl_8c.html#a2">DEAD_AUTHORITY</a>;
00856 
00857 
00858     <span class="comment">//</span>
00859     <span class="comment">//  The following SID sizes need to be allocated</span>
00860     <span class="comment">//</span>
00861 
00862     SidWithZeroSubAuthorities  = <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( 0 );
00863     SidWithOneSubAuthority     = <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( 1 );
00864     SidWithThreeSubAuthorities = <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( 3 );
00865     SidWithFourSubAuthorities  = <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( 4 );
00866 
00867     DeadDomainSid   = (PSID)TstAllocatePool(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,SidWithThreeSubAuthorities);
00868 
00869     BobbySid    = (PSID)TstAllocatePool(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,SidWithFourSubAuthorities);
00870     JerrySid    = (PSID)TstAllocatePool(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,SidWithFourSubAuthorities);
00871     PhilSid     = (PSID)TstAllocatePool(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,SidWithFourSubAuthorities);
00872     KreutzmanSid    = (PSID)TstAllocatePool(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,SidWithFourSubAuthorities);
00873 
00874     BrentSid    = (PSID)TstAllocatePool(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,SidWithFourSubAuthorities);
00875     MickySid    = (PSID)TstAllocatePool(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,SidWithFourSubAuthorities);
00876 
00877     <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>( DeadDomainSid,   &amp;DeadAuthority, 3 );
00878     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>( DeadDomainSid, 0)) = <a class="code" href="../../d1/d1/ctsertl_8c.html#a3">DEAD_SUBAUTHORITY_0</a>;
00879     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>( DeadDomainSid, 1)) = <a class="code" href="../../d1/d1/ctsertl_8c.html#a4">DEAD_SUBAUTHORITY_1</a>;
00880     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>( DeadDomainSid, 2)) = <a class="code" href="../../d1/d1/ctsertl_8c.html#a5">DEAD_SUBAUTHORITY_2</a>;
00881 
00882     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( SidWithFourSubAuthorities, BobbySid, DeadDomainSid);
00883     *(<a class="code" href="../../d8/d6/sertl_8c.html#a44">RtlSubAuthorityCountSid</a>( BobbySid )) += 1;
00884     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>( BobbySid, 3)) = <a class="code" href="../../d1/d1/ctsertl_8c.html#a6">BOBBY_RID</a>;
00885 
00886     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( SidWithFourSubAuthorities, JerrySid, DeadDomainSid);
00887     *(<a class="code" href="../../d8/d6/sertl_8c.html#a44">RtlSubAuthorityCountSid</a>( JerrySid )) += 1;
00888     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>( JerrySid, 3)) = <a class="code" href="../../d1/d1/ctsertl_8c.html#a7">JERRY_RID</a>;
00889 
00890     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( SidWithFourSubAuthorities, PhilSid, DeadDomainSid);
00891     *(<a class="code" href="../../d8/d6/sertl_8c.html#a44">RtlSubAuthorityCountSid</a>( PhilSid )) += 1;
00892     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>( PhilSid, 3)) = <a class="code" href="../../d1/d1/ctsertl_8c.html#a8">PHIL_RID</a>;
00893 
00894     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( SidWithFourSubAuthorities, KreutzmanSid, DeadDomainSid);
00895     *(<a class="code" href="../../d8/d6/sertl_8c.html#a44">RtlSubAuthorityCountSid</a>( KreutzmanSid )) += 1;
00896     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>( KreutzmanSid, 3)) = <a class="code" href="../../d1/d1/ctsertl_8c.html#a9">KREUTZMAN_RID</a>;
00897 
00898     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( SidWithFourSubAuthorities, BrentSid, DeadDomainSid);
00899     *(<a class="code" href="../../d8/d6/sertl_8c.html#a44">RtlSubAuthorityCountSid</a>( BrentSid )) += 1;
00900     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>( BrentSid, 3)) = <a class="code" href="../../d1/d1/ctsertl_8c.html#a10">BRENT_RID</a>;
00901 
00902     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( SidWithFourSubAuthorities, MickySid, DeadDomainSid);
00903     *(<a class="code" href="../../d8/d6/sertl_8c.html#a44">RtlSubAuthorityCountSid</a>( MickySid )) += 1;
00904     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>( MickySid, 3)) = <a class="code" href="../../d1/d1/ctsertl_8c.html#a11">MICKY_RID</a>;
00905 
00906     <a class="code" href="../../d0/d1/ctseacc_8c.html#a13">TDacl</a> = (PACL)TstAllocatePool( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, 256 );
00907 
00908     <span class="comment">//DbgBreakPoint();</span>
00909 
00910     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( <a class="code" href="../../d0/d1/ctseacc_8c.html#a13">TDacl</a>, 256, ACL_REVISION ))) {
00911         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00912         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"RtlCreateAcl returned %X \n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00913         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00914     }
00915 
00916     <span class="comment">//DbgBreakPoint();</span>
00917 
00918     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a7">RtlValidAcl</a>( <a class="code" href="../../d0/d1/ctseacc_8c.html#a13">TDacl</a> ) )) {
00919         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00920         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"RtlValidAcl returned %X \n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00921         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00922     }
00923 
00924     <span class="comment">//DbgBreakPoint();</span>
00925 
00926     AclInformation.AclRevision = ACL_REVISION;
00927 
00928     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a9">RtlSetInformationAcl</a>( <a class="code" href="../../d0/d1/ctseacc_8c.html#a13">TDacl</a>, &amp;AclInformation,
00929                 <span class="keyword">sizeof</span>(AclInformation), AclRevisionInformation ) )) {
00930         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00931         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"RtlSetInformation returned %X \n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00932         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00933     }
00934 
00935     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a8">RtlQueryInformationAcl</a>( <a class="code" href="../../d0/d1/ctseacc_8c.html#a13">TDacl</a>, (PVOID)&amp;AclInformationOut,
00936                 <span class="keyword">sizeof</span>(AclInformationOut), AclRevisionInformation ) )) {
00937         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00938         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"RtlQueryInformation returned %X during revision query \n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00939         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00940     }
00941 
00942     <span class="keywordflow">if</span> (AclInformationOut.AclRevision != ACL_REVISION) {
00943         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00944         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"RtlQueryInformation returned incorrect revision \n"</span>);
00945         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00946     }
00947 
00948     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a8">RtlQueryInformationAcl</a>( <a class="code" href="../../d0/d1/ctseacc_8c.html#a13">TDacl</a>, (PVOID)&amp;AclSizeInfo,
00949                 <span class="keyword">sizeof</span>(AclSizeInfo), AclSizeInformation ) )) {
00950         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
00951         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"RtlQueryInformation returned %X during size query \n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00952         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00953     }
00954 
00955     <span class="comment">// DumpAclSizeInfo(&amp;AclSizeInfo);</span>
00956 
00957     AceSize = 6 * SidWithFourSubAuthorities + 1 * SidWithThreeSubAuthorities
00958                     + 7 * (<span class="keyword">sizeof</span>( ACE_HEADER ) + <span class="keyword">sizeof</span>( ACCESS_MASK ));
00959 
00960     AceList = (PVOID)TstAllocatePool(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, AceSize);
00961 
00962     Ace = AceList;
00963 
00964     ((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Header.AceType = ACCESS_ALLOWED_ACE_TYPE;
00965     ((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Header.AceSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)SidWithThreeSubAuthorities +
00966                   (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>(ACE_HEADER) + (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>( ACCESS_MASK );
00967     ((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Header.AceFlags = OBJECT_INHERIT_ACE;
00968     ((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Mask = DELETE;
00969     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>(SidWithThreeSubAuthorities,&amp;((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Sid,DeadDomainSid);
00970 
00971     (ULONG)Ace += ((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;<a class="code" href="../../d3/d3/struct__SIMPLE__ACE.html#o0">Header</a>.AceSize;
00972 
00973     ((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Header.AceType = ACCESS_ALLOWED_ACE_TYPE;
00974     ((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Header.AceSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)SidWithFourSubAuthorities +
00975                   (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>(ACE_HEADER) + (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>( ACCESS_MASK );
00976     ((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Header.AceFlags = OBJECT_INHERIT_ACE;
00977     ((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Mask = DELETE;
00978     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>(SidWithFourSubAuthorities,&amp;((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Sid,BobbySid);
00979 
00980     (ULONG)Ace += ((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;<a class="code" href="../../d3/d3/struct__SIMPLE__ACE.html#o0">Header</a>.AceSize;
00981 
00982     ((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Header.AceType = ACCESS_ALLOWED_ACE_TYPE;
00983     ((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Header.AceSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)SidWithFourSubAuthorities +
00984                   (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>(ACE_HEADER) + (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>( ACCESS_MASK );
00985     ((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Header.AceFlags = OBJECT_INHERIT_ACE;
00986     ((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Mask = DELETE;
00987     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>(SidWithFourSubAuthorities,&amp;((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Sid,JerrySid);
00988 
00989     (ULONG)Ace += ((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;<a class="code" href="../../d3/d3/struct__SIMPLE__ACE.html#o0">Header</a>.AceSize;
00990 
00991     ((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Header.AceType = ACCESS_ALLOWED_ACE_TYPE;
00992     ((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Header.AceSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)SidWithFourSubAuthorities +
00993                   (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>(ACE_HEADER) + (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>( ACCESS_MASK );
00994     ((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Header.AceFlags = OBJECT_INHERIT_ACE;
00995     ((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Mask = DELETE;
00996     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>(SidWithFourSubAuthorities,&amp;((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Sid,PhilSid);
00997 
00998     (ULONG)Ace += ((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;<a class="code" href="../../d3/d3/struct__SIMPLE__ACE.html#o0">Header</a>.AceSize;
00999 
01000     ((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Header.AceType = ACCESS_ALLOWED_ACE_TYPE;
01001     ((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Header.AceSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)SidWithFourSubAuthorities +
01002                   (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>(ACE_HEADER) + (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>( ACCESS_MASK );
01003     ((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Header.AceFlags = OBJECT_INHERIT_ACE;
01004     ((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Mask = DELETE;
01005     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>(SidWithFourSubAuthorities,&amp;((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Sid,KreutzmanSid);
01006 
01007     (ULONG)Ace += ((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;<a class="code" href="../../d3/d3/struct__SIMPLE__ACE.html#o0">Header</a>.AceSize;
01008 
01009     ((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Header.AceType = ACCESS_ALLOWED_ACE_TYPE;
01010     ((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Header.AceSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)SidWithFourSubAuthorities +
01011                   (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>(ACE_HEADER) + (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>( ACCESS_MASK );
01012     ((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Header.AceFlags = OBJECT_INHERIT_ACE;
01013     ((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Mask = DELETE;
01014     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>(SidWithFourSubAuthorities,&amp;((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Sid,BrentSid);
01015 
01016     (ULONG)Ace += ((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;<a class="code" href="../../d3/d3/struct__SIMPLE__ACE.html#o0">Header</a>.AceSize;
01017 
01018     ((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Header.AceType = ACCESS_ALLOWED_ACE_TYPE;
01019     ((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Header.AceSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)SidWithFourSubAuthorities +
01020                   (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>(ACE_HEADER) + (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>( ACCESS_MASK );
01021     ((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Header.AceFlags = OBJECT_INHERIT_ACE;
01022     ((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Mask = DELETE;
01023     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>(SidWithFourSubAuthorities,&amp;((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Sid,MickySid);
01024 
01025     <span class="comment">//DbgBreakPoint();</span>
01026 
01027     <a class="code" href="../../d2/d4/acledit_8c.html#a10">RtlAddAce</a>(<a class="code" href="../../d0/d1/ctseacc_8c.html#a13">TDacl</a>, ACL_REVISION, 0, AceList, AceSize);
01028 
01029     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a8">RtlQueryInformationAcl</a>( <a class="code" href="../../d0/d1/ctseacc_8c.html#a13">TDacl</a>, (PVOID)&amp;AclSizeInfo,
01030                 <span class="keyword">sizeof</span>(AclSizeInfo), AclSizeInformation ) )) {
01031         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"**** Failed **** \n"</span>);
01032         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"RtlQueryInformation returned %X during size query \n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01033         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01034     }
01035 
01036 <span class="preprocessor">#if 0</span>
01037 <span class="preprocessor"></span>    <a class="code" href="../../d3/d6/tseum_8c.html#a0">RtlDumpAcl</a>(<a class="code" href="../../d0/d1/ctseacc_8c.html#a13">TDacl</a>);
01038 <span class="preprocessor">#endif</span>
01039 <span class="preprocessor"></span>
01040     <a class="code" href="../../d2/d4/acledit_8c.html#a12">RtlGetAce</a>( <a class="code" href="../../d0/d1/ctseacc_8c.html#a13">TDacl</a>, 5, &amp;Ace );
01041 
01042     <span class="keywordflow">if</span> ( !<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( &amp;((<a class="code" href="../../d1/d1/ctsertl_8c.html#a13">PSIMPLE_ACE</a>)Ace)-&gt;Sid, BrentSid) ) {
01043         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n **** Failed **** \n"</span>);
01044         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"RtlGetAce returned wrong Ace\n"</span>);
01045         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01046     }
01047 
01048     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d2/d4/acledit_8c.html#a11">RtlDeleteAce</a> (<a class="code" href="../../d0/d1/ctseacc_8c.html#a13">TDacl</a>, 5))) {
01049         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n **** Failed **** \n"</span>);
01050         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"RtlDeleteAce failed\n"</span>);
01051         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01052     }
01053 
01054 <span class="preprocessor">#if 0</span>
01055 <span class="preprocessor"></span>    <a class="code" href="../../d3/d6/tseum_8c.html#a0">RtlDumpAcl</a>(<a class="code" href="../../d0/d1/ctseacc_8c.html#a13">TDacl</a>);
01056 <span class="preprocessor">#endif</span>
01057 <span class="preprocessor"></span>
01058     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01059 }
01060 
01061 
01062 BOOLEAN
<a name="l01063"></a><a class="code" href="../../d1/d1/ctsertl_8c.html#a19">01063</a> <a class="code" href="../../d1/d1/ctsertl_8c.html#a19">TestSeRtl</a>()
01064 {
01065 
01066     BOOLEAN Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01067 
01068     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:   Global Variable Initialization...                        "</span>);
01069     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/tsevars_8c.html#a65">TSeVariableInitialization</a>()) {
01070         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
01071     } <span class="keywordflow">else</span> {
01072         Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01073     }
01074 
01075     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:   SID test...                                              "</span>);
01076     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1/ctsertl_8c.html#a14">TestSeSid</a>()) {
01077         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
01078     } <span class="keywordflow">else</span> {
01079         Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01080     }
01081 
01082     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:   SECURITY_DESCRIPTOR test...                              "</span>);
01083     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1/ctsertl_8c.html#a15">TestSeSecurityDescriptor</a>()) {
01084         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
01085     } <span class="keywordflow">else</span> {
01086         Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01087     }
01088 
01089     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:   ACCESS_MASK test...                                      "</span>);
01090     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1/ctsertl_8c.html#a16">TestSeAccessMask</a>()) {
01091         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
01092     } <span class="keywordflow">else</span> {
01093         Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01094     }
01095 
01096     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Se:   ACL test...                                              "</span>);
01097     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1/ctsertl_8c.html#a18">TestSeAclRtl</a>()) {
01098         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Succeeded.\n"</span>);
01099     } <span class="keywordflow">else</span> {
01100         Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01101     }
01102 
01103     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
01104     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
01105     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    ********************\n"</span>);
01106     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    **                **\n"</span>);
01107 
01108     <span class="keywordflow">if</span> (Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01109         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    ** Test Succeeded **\n"</span>);
01110     } <span class="keywordflow">else</span> {
01111         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    **  Test Failed   **\n"</span>);
01112     }
01113 
01114     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    **                **\n"</span>);
01115     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    ********************\n"</span>);
01116     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
01117     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
01118 
01119     <span class="keywordflow">return</span> Result;
01120 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:37 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
