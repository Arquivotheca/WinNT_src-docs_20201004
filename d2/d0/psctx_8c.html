<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: psctx.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>psctx.c File Reference</h1><code>#include "<a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>"</code><br>

<p>
<a href="../../d3/d9/psctx_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d0/psctx_8c.html#a0">PspQueueApcSpecialApc</a> (IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *NormalRoutine, IN PVOID *NormalContext, IN PVOID *SystemArgument1, IN PVOID *SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSYSAPI NTSTATUS NTAPI&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d0/psctx_8c.html#a1">NtQueueApcThread</a> (IN HANDLE <a class="el" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>, IN PPS_APC_ROUTINE ApcRoutine, IN PVOID ApcArgument1, IN PVOID ApcArgument2, IN PVOID ApcArgument3)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d0/psctx_8c.html#a2">NtGetContextThread</a> (IN HANDLE <a class="el" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>, IN OUT PCONTEXT <a class="el" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d0/psctx_8c.html#a3">NtSetContextThread</a> (IN HANDLE <a class="el" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>, IN PCONTEXT <a class="el" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a2" doxytag="psctx.c::NtGetContextThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtGetContextThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ThreadHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ThreadContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d9/psctx_8c-source.html#l00151">151</a> of file <a class="el" href="../../d3/d9/psctx_8c-source.html">psctx.c</a>.
<p>
References <a class="el" href="../../d9/d0/psp_8h-source.html#l00077">_GETSETCONTEXT::Apc</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00080">_GETSETCONTEXT::Context</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00244">CONTEXT_EXTENDED_INTEGER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d1/psp_8h.html#a12">GETSETCONTEXT</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00639">IS_SYSTEM_THREAD</a>, <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00039">KeInitializeApc()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00217">KeInsertQueueApc()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00078">_GETSETCONTEXT::Mode</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00079">_GETSETCONTEXT::OperationComplete</a>, <a class="el" href="../../d4/d9/ke_8h.html#a403a181">OriginalApcEnvironment</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01339">ProbeAndReadUlong</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d8/d1/psp_8h.html#a74">PspGetSetContextSpecialApc()</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00089">PsThreadType</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00250">_KAPC::SystemArgument1</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00251">_KAPC::SystemArgument2</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00137">ThreadContext</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00138">ThreadHandle</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/rtl_2alpha_2context_8c-source.html#l00193">RtlRemoteCall()</a>.
<p>
<pre class="fragment"><div>00158                    :
00159 
00160     This function returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> usermode context of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified thread. This
00161     function will fail <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a system thread. It will
00162     <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wrong answer <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a non-system thread that does
00163     not execute in user-mode.
00164 
00165 Arguments:
00166 
00167     <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a> - Supplies an open handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread object from
00168                    which to retrieve context information.  The handle
00169                    must allow THREAD_GET_CONTEXT access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread.
00170 
00171     <a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a buffer that will receive
00172                     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified thread.
00173 
00174 Return Value:
00175 
00176     None.
00177 
00178 --*/
00179 
00180 {
00181 
00182     ULONG Alignment;
00183     ULONG ContextFlags;
00184     <a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html">GETSETCONTEXT</a> ContextFrame;
00185     ULONG ContextLength;
00186     KIRQL Irql;
00187     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> Mode;
00188     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00189     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00190 
00191     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00192 
00193     <span class="comment">//</span>
00194     <span class="comment">// Get previous mode and reference specified thread.</span>
00195     <span class="comment">//</span>
00196 
00197     Mode = KeGetPreviousMode();
00198     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(ThreadHandle,
00199                                    THREAD_GET_CONTEXT,
00200                                    PsThreadType,
00201                                    Mode,
00202                                    (PVOID *)&amp;Thread,
00203                                    NULL);
00204 
00205     <span class="comment">//</span>
00206     <span class="comment">// If the reference was successful, the check if the specified thread</span>
00207     <span class="comment">// is a system thread.</span>
00208     <span class="comment">//</span>
00209 
00210     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00211 
00212         <span class="comment">//</span>
00213         <span class="comment">// If the thread is not a system thread, then attempt to get the</span>
00214         <span class="comment">// context of the thread.</span>
00215         <span class="comment">//</span>
00216 
00217         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a18">IS_SYSTEM_THREAD</a>(Thread) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00218 
00219             <span class="comment">//</span>
00220             <span class="comment">// Attempt to get the context of the specified thread.</span>
00221             <span class="comment">//</span>
00222 
00223             <span class="keywordflow">try</span> {
00224 
00225                 <span class="comment">//</span>
00226                 <span class="comment">// Set the default alignment, capture the context flags,</span>
00227                 <span class="comment">// and set the default size of the context record.</span>
00228                 <span class="comment">//</span>
00229 
00230                 Alignment = CONTEXT_ALIGN;
00231                 ContextFlags = <a class="code" href="../../d5/d8/ex_8h.html#a20">ProbeAndReadUlong</a>(&amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>-&gt;ContextFlags);
00232                 ContextLength = <span class="keyword">sizeof</span>(CONTEXT);
00233 
00234 <span class="preprocessor">#if defined(_X86_)</span>
00235 <span class="preprocessor"></span>                <span class="comment">//</span>
00236                 <span class="comment">// CONTEXT_EXTENDED_REGISTERS is SET, then we want sizeof(CONTEXT) set above</span>
00237                 <span class="comment">// otherwise (not set) we only want the old part of the context record.</span>
00238                 <span class="comment">//</span>
00239                 <span class="keywordflow">if</span> ((ContextFlags &amp; CONTEXT_EXTENDED_REGISTERS) != CONTEXT_EXTENDED_REGISTERS) {
00240                     ContextLength = FIELD_OFFSET(CONTEXT, ExtendedRegisters);
00241                 }
00242 <span class="preprocessor">#endif</span>
00243 <span class="preprocessor"></span>
00244 <span class="preprocessor">#if defined(_MIPS_)</span>
00245 <span class="preprocessor"></span>
00246                 <span class="comment">//</span>
00247                 <span class="comment">// The following code is included for backward compatibility</span>
00248                 <span class="comment">// with old code that does not understand extended context</span>
00249                 <span class="comment">// records on MIPS systems.</span>
00250                 <span class="comment">//</span>
00251 
00252                 <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a157">CONTEXT_EXTENDED_INTEGER</a>) != <a class="code" href="../../d6/d7/halmips_8h.html#a157">CONTEXT_EXTENDED_INTEGER</a>) {
00253                     Alignment = <span class="keyword">sizeof</span>(ULONG);
00254                     ContextLength = FIELD_OFFSET(CONTEXT, ContextFlags) + 4;
00255                 }
00256 
00257 <span class="preprocessor">#endif</span>
00258 <span class="preprocessor"></span>
00259                 <span class="keywordflow">if</span> (Mode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00260                     <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(ThreadContext, ContextLength, Alignment);
00261                 }
00262 
00263             } except(EXCEPTION_EXECUTE_HANDLER) {
00264                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00265             }
00266 
00267             <span class="comment">//</span>
00268             <span class="comment">// If an exception did not occur during the probe of the thread</span>
00269             <span class="comment">// context, then get the context of the target thread.</span>
00270             <span class="comment">//</span>
00271 
00272             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00273                 <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o2">OperationComplete</a>,
00274                                   NotificationEvent,
00275                                   FALSE);
00276 
00277                 ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o3">Context</a>.ContextFlags = ContextFlags;
00278 
00279                 ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o1">Mode</a> = Mode;
00280                 <span class="keywordflow">if</span> (Thread == <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()) {
00281                     ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o0">Apc</a>.<a class="code" href="../../d1/d5/struct__KAPC.html#o9">SystemArgument1</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00282                     ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o0">Apc</a>.<a class="code" href="../../d1/d5/struct__KAPC.html#o10">SystemArgument2</a> = Thread;
00283                     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(APC_LEVEL, &amp;Irql);
00284                     <a class="code" href="../../d8/d1/psp_8h.html#a74">PspGetSetContextSpecialApc</a>(&amp;ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o0">Apc</a>,
00285                                                NULL,
00286                                                NULL,
00287                                                &amp;ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o0">Apc</a>.<a class="code" href="../../d1/d5/struct__KAPC.html#o9">SystemArgument1</a>,
00288                                                &amp;ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o0">Apc</a>.<a class="code" href="../../d1/d5/struct__KAPC.html#o10">SystemArgument2</a>);
00289 
00290                     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(Irql);
00291 
00292                     <span class="comment">//</span>
00293                     <span class="comment">// Move context to specfied context record. If an exception</span>
00294                     <span class="comment">// occurs, then silently handle it and return success.</span>
00295                     <span class="comment">//</span>
00296 
00297                     <span class="keywordflow">try</span> {
00298                         RtlMoveMemory(ThreadContext,
00299                                       &amp;ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o3">Context</a>,
00300                                       ContextLength);
00301 
00302                     } except(EXCEPTION_EXECUTE_HANDLER) {
00303                     }
00304 
00305                 } <span class="keywordflow">else</span> {
00306                     <a class="code" href="../../d5/d7/apcobj_8c.html#a1">KeInitializeApc</a>(&amp;ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o0">Apc</a>,
00307                                     &amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>,
00308                                     OriginalApcEnvironment,
00309                                     PspGetSetContextSpecialApc,
00310                                     NULL,
00311                                     NULL,
00312                                     KernelMode,
00313                                     NULL);
00314 
00315                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d7/apcobj_8c.html#a3">KeInsertQueueApc</a>(&amp;ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o0">Apc</a>, NULL, Thread, 2)) {
00316                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
00317 
00318                     } <span class="keywordflow">else</span> {
00319                         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o2">OperationComplete</a>,
00320                                               Executive,
00321                                               KernelMode,
00322                                               FALSE,
00323                                               NULL);
00324                         <span class="comment">//</span>
00325                         <span class="comment">// Move context to specfied context record. If an</span>
00326                         <span class="comment">// exception occurs, then silently handle it and</span>
00327                         <span class="comment">// return success.</span>
00328                         <span class="comment">//</span>
00329 
00330                         <span class="keywordflow">try</span> {
00331                             RtlMoveMemory(ThreadContext,
00332                                           &amp;ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o3">Context</a>,
00333                                           ContextLength);
00334 
00335                         } except(EXCEPTION_EXECUTE_HANDLER) {
00336                         }
00337                     }
00338                 }
00339             }
00340 
00341         } <span class="keywordflow">else</span> {
00342             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_HANDLE;
00343         }
00344 
00345         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
00346     }
00347 
00348     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00349 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="psctx.c::NtQueueApcThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSYSAPI NTSTATUS NTAPI NtQueueApcThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ThreadHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PPS_APC_ROUTINE&nbsp;</td>
          <td class="mdname" nowrap> <em>ApcRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ApcArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ApcArgument2</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ApcArgument3</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d9/psctx_8c-source.html#l00056">56</a> of file <a class="el" href="../../d3/d9/psctx_8c-source.html">psctx.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00265">ExAllocatePoolWithQuotaTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00639">IS_SYSTEM_THREAD</a>, <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00039">KeInitializeApc()</a>, <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00217">KeInsertQueueApc()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a403a181">OriginalApcEnvironment</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00196">PKNORMAL_ROUTINE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00143">POOL_QUOTA_FAIL_INSTEAD_OF_RAISE</a>, <a class="el" href="../../d3/d9/psctx_8c-source.html#l00040">PspQueueApcSpecialApc()</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00089">PsThreadType</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00138">ThreadHandle</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l00944">RtlCreateTimer()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05767">RtlDebugPrintTimes()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l01145">RtlDeleteTimer()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l00809">RtlDeleteTimerQueueEx()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l00256">RtlDeregisterWaitEx()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l01638">RtlpQueueIOWorkerRequest()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l01506">RtlpQueueWorkerRequest()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05503">RtlpWaitForEvent()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l00077">RtlRegisterWait()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l01320">RtlThreadPoolCleanup()</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l01058">RtlUpdateTimer()</a>.
<p>
<pre class="fragment"><div>00066                    :
00067 
00068     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to queue a user-mode APC to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified thread. The APC
00069     will fire when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified thread does an alertable wait
00070 
00071 Arguments:
00072 
00073     <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a> - Supplies a handle to a thread object.  The caller
00074         must have THREAD_SET_CONTEXT access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread.
00075 
00076     ApcRoutine - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC routine to execute when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00077         APC fires.
00078 
00079     ApcArgument1 - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first PVOID passed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC
00080 
00081     ApcArgument2 - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second PVOID passed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC
00082 
00083     ApcArgument3 - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> third PVOID passed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC
00084 
00085 Return Value:
00086 
00087     Returns an NT <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code indicating success or <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> API
00088 
00089 --*/
00090 
00091 {
00092     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00093     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00094     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> Mode;
00095     KIRQL Irql;
00096     <a class="code" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc;
00097 
00098     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00099 
00100     Mode = KeGetPreviousMode();
00101 
00102     st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00103             ThreadHandle,
00104             THREAD_SET_CONTEXT,
00105             PsThreadType,
00106             Mode,
00107             (PVOID *)&amp;Thread,
00108             NULL
00109             );
00110 
00111     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00112         st = STATUS_SUCCESS;
00113         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d9/ps_8h.html#a18">IS_SYSTEM_THREAD</a>(Thread) ) {
00114             st = STATUS_INVALID_HANDLE;
00115             }
00116         <span class="keywordflow">else</span> {
00117             Apc = <a class="code" href="../../d5/d8/ex_8h.html#a5">ExAllocatePoolWithQuotaTag</a>(
00118                     (NonPagedPool | POOL_QUOTA_FAIL_INSTEAD_OF_RAISE),
00119                     <span class="keyword">sizeof</span>(*Apc),
00120                     'pasP'
00121                     );
00122 
00123             <span class="keywordflow">if</span> ( !Apc ) {
00124                 st = STATUS_NO_MEMORY;
00125                 }
00126             <span class="keywordflow">else</span> {
00127                 <a class="code" href="../../d5/d7/apcobj_8c.html#a1">KeInitializeApc</a>(
00128                     Apc,
00129                     &amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>,
00130                     OriginalApcEnvironment,
00131                     PspQueueApcSpecialApc,
00132                     NULL,
00133                     (PKNORMAL_ROUTINE)ApcRoutine,
00134                     UserMode,
00135                     ApcArgument1
00136                     );
00137 
00138                 <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d7/apcobj_8c.html#a3">KeInsertQueueApc</a>(Apc,ApcArgument2,ApcArgument3,0) ) {
00139                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Apc);
00140                     st = STATUS_UNSUCCESSFUL;
00141                     }
00142                 }
00143             }
00144         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
00145         }
00146 
00147     <span class="keywordflow">return</span> st;
00148 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="psctx.c::NtSetContextThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtSetContextThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ThreadHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ThreadContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d9/psctx_8c-source.html#l00352">352</a> of file <a class="el" href="../../d3/d9/psctx_8c-source.html">psctx.c</a>.
<p>
References <a class="el" href="../../d9/d0/psp_8h-source.html#l00077">_GETSETCONTEXT::Apc</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00080">_GETSETCONTEXT::Context</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00244">CONTEXT_EXTENDED_INTEGER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00639">IS_SYSTEM_THREAD</a>, <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00039">KeInitializeApc()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00217">KeInsertQueueApc()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00078">_GETSETCONTEXT::Mode</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00079">_GETSETCONTEXT::OperationComplete</a>, <a class="el" href="../../d4/d9/ke_8h.html#a403a181">OriginalApcEnvironment</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01339">ProbeAndReadUlong</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d8/d1/psp_8h.html#a74">PspGetSetContextSpecialApc()</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00089">PsThreadType</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00250">_KAPC::SystemArgument1</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00251">_KAPC::SystemArgument2</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00137">ThreadContext</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00138">ThreadHandle</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/rtl_2alpha_2context_8c-source.html#l00193">RtlRemoteCall()</a>.
<p>
<pre class="fragment"><div>00359                    :
00360 
00361     This function sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> usermode context of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified thread. This
00362     function will fail <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a system thread. It will
00363     <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wrong answer <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a non-system thread that does
00364     not execute in user-mode.
00365 
00366 Arguments:
00367 
00368     <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a> - Supplies an open handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread object from
00369                    which to retrieve context information.  The handle
00370                    must allow THREAD_SET_CONTEXT access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread.
00371 
00372     <a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a buffer that contains <span class="keyword">new</span>
00373                     context <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified thread.
00374 
00375 Return Value:
00376 
00377     None.
00378 
00379 --*/
00380 
00381 {
00382 
00383     ULONG Alignment;
00384     ULONG ContextFlags;
00385     <a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html">GETSETCONTEXT</a> ContextFrame;
00386     ULONG ContextLength;
00387     KIRQL Irql;
00388     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> Mode;
00389     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00390     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00391 
00392     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00393 
00394     <span class="comment">//</span>
00395     <span class="comment">// Get previous mode and reference specified thread.</span>
00396     <span class="comment">//</span>
00397 
00398     Mode = KeGetPreviousMode();
00399     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(ThreadHandle,
00400                                        THREAD_SET_CONTEXT,
00401                                        PsThreadType,
00402                                        Mode,
00403                                        (PVOID *)&amp;Thread,
00404                                        NULL);
00405 
00406     <span class="comment">//</span>
00407     <span class="comment">// If the reference was successful, the check if the specified thread</span>
00408     <span class="comment">// is a system thread.</span>
00409     <span class="comment">//</span>
00410 
00411     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00412 
00413         <span class="comment">//</span>
00414         <span class="comment">// If the thread is not a system thread, then attempt to get the</span>
00415         <span class="comment">// context of the thread.</span>
00416         <span class="comment">//</span>
00417 
00418         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a18">IS_SYSTEM_THREAD</a>(Thread) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00419 
00420             <span class="comment">//</span>
00421             <span class="comment">// Attempt to get the context of the specified thread.</span>
00422             <span class="comment">//</span>
00423 
00424             <span class="keywordflow">try</span> {
00425 
00426                 <span class="comment">//</span>
00427                 <span class="comment">// Set the default alignment, capture the context flags,</span>
00428                 <span class="comment">// and set the default size of the context record.</span>
00429                 <span class="comment">//</span>
00430 
00431                 Alignment = CONTEXT_ALIGN;
00432                 ContextFlags = <a class="code" href="../../d5/d8/ex_8h.html#a20">ProbeAndReadUlong</a>(&amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>-&gt;ContextFlags);
00433                 ContextLength = <span class="keyword">sizeof</span>(CONTEXT);
00434 
00435 <span class="preprocessor">#if defined(_X86_)</span>
00436 <span class="preprocessor"></span>                <span class="comment">//</span>
00437                 <span class="comment">// CONTEXT_EXTENDED_REGISTERS is SET, then we want sizeof(CONTEXT) set above</span>
00438                 <span class="comment">// otherwise (not set) we only want the old part of the context record.</span>
00439                 <span class="comment">//</span>
00440                 <span class="keywordflow">if</span> ((ContextFlags &amp; CONTEXT_EXTENDED_REGISTERS) != CONTEXT_EXTENDED_REGISTERS) {
00441                     ContextLength = FIELD_OFFSET(CONTEXT, ExtendedRegisters);
00442                 }
00443 <span class="preprocessor">#endif</span>
00444 <span class="preprocessor"></span>
00445 <span class="preprocessor">#if defined(_MIPS_)</span>
00446 <span class="preprocessor"></span>
00447                 <span class="comment">//</span>
00448                 <span class="comment">// The following code is included for backward compatibility</span>
00449                 <span class="comment">// with old code that does not understand extended context</span>
00450                 <span class="comment">// records on MIPS systems.</span>
00451                 <span class="comment">//</span>
00452 
00453                 <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a157">CONTEXT_EXTENDED_INTEGER</a>) != <a class="code" href="../../d6/d7/halmips_8h.html#a157">CONTEXT_EXTENDED_INTEGER</a>) {
00454                     Alignment = <span class="keyword">sizeof</span>(ULONG);
00455                     ContextLength = FIELD_OFFSET(CONTEXT, ContextFlags) + 4;
00456                 }
00457 
00458 <span class="preprocessor">#endif</span>
00459 <span class="preprocessor"></span>
00460                 <span class="keywordflow">if</span> (Mode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00461                     <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(ThreadContext, ContextLength, Alignment);
00462                 }
00463 
00464                 RtlMoveMemory(&amp;ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o3">Context</a>, ThreadContext, ContextLength);
00465 
00466             } except(EXCEPTION_EXECUTE_HANDLER) {
00467                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00468             }
00469 
00470             <span class="comment">//</span>
00471             <span class="comment">// If an exception did not occur during the probe of the thread</span>
00472             <span class="comment">// context, then set the context of the target thread.</span>
00473             <span class="comment">//</span>
00474 
00475             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00476                 <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o2">OperationComplete</a>,
00477                                   NotificationEvent,
00478                                   FALSE);
00479 
00480                 ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o3">Context</a>.ContextFlags = ContextFlags;
00481 
00482                 ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o1">Mode</a> = Mode;
00483                 <span class="keywordflow">if</span> (Thread == <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()) {
00484                     ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o0">Apc</a>.<a class="code" href="../../d1/d5/struct__KAPC.html#o9">SystemArgument1</a> = (PVOID)1;
00485                     ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o0">Apc</a>.<a class="code" href="../../d1/d5/struct__KAPC.html#o10">SystemArgument2</a> = Thread;
00486                     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(APC_LEVEL, &amp;Irql);
00487                     <a class="code" href="../../d8/d1/psp_8h.html#a74">PspGetSetContextSpecialApc</a>(&amp;ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o0">Apc</a>,
00488                                                NULL,
00489                                                NULL,
00490                                                &amp;ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o0">Apc</a>.<a class="code" href="../../d1/d5/struct__KAPC.html#o9">SystemArgument1</a>,
00491                                                &amp;ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o0">Apc</a>.<a class="code" href="../../d1/d5/struct__KAPC.html#o10">SystemArgument2</a>);
00492 
00493                     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(Irql);
00494 
00495                 } <span class="keywordflow">else</span> {
00496                     <a class="code" href="../../d5/d7/apcobj_8c.html#a1">KeInitializeApc</a>(&amp;ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o0">Apc</a>,
00497                                     &amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>,
00498                                     OriginalApcEnvironment,
00499                                     PspGetSetContextSpecialApc,
00500                                     NULL,
00501                                     NULL,
00502                                     KernelMode,
00503                                     NULL);
00504 
00505                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d7/apcobj_8c.html#a3">KeInsertQueueApc</a>(&amp;ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o0">Apc</a>, (PVOID)1, Thread, 2)) {
00506                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
00507 
00508                     } <span class="keywordflow">else</span> {
00509                         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;ContextFrame.<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o2">OperationComplete</a>,
00510                                               Executive,
00511                                               KernelMode,
00512                                               FALSE,
00513                                               NULL);
00514                     }
00515                 }
00516             }
00517 
00518         } <span class="keywordflow">else</span> {
00519             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_HANDLE;
00520         }
00521 
00522         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
00523     }
00524 
00525     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00526 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="psctx.c::PspQueueApcSpecialApc" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspQueueApcSpecialApc           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Apc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d9/psctx_8c-source.html#l00040">40</a> of file <a class="el" href="../../d3/d9/psctx_8c-source.html">psctx.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d3/d9/psctx_8c-source.html#l00056">NtQueueApcThread()</a>.
<p>
<pre class="fragment"><div>00047 {
00048     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00049 
00050     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Apc);
00051 }
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:22 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
