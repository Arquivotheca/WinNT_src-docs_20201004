<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cmdelete.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cmdelete.c</h1><a href="../../d1/d1/cmdelete_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    cmdelete.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the delete object method (used to delete key</span>
00012 <span class="comment">    control blocks  when last handle to a key is closed, and to delete</span>
00013 <span class="comment">    keys marked for deletetion when last reference to them goes away.)</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    Bryan M. Willman (bryanwi) 13-Nov-91</span>
00018 <span class="comment"></span>
00019 <span class="comment">Revision History:</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 
00023 <span class="preprocessor">#include    "<a class="code" href="../../d1/d2/cmp_8h.html">cmp.h</a>"</span>
00024 
00025 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00026 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpDeleteKeyObject)</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00028 <span class="preprocessor"></span>
00029 
00030 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00031"></a><a class="code" href="../../d1/d2/cmp_8h.html#a212">00031</a> <a class="code" href="../../d1/d2/cmp_8h.html#a212">CmpDeleteKeyObject</a>(
00032     IN PVOID Object
00033     )
00034 <span class="comment">/*++</span>
00035 <span class="comment"></span>
00036 <span class="comment">Routine Description:</span>
00037 <span class="comment"></span>
00038 <span class="comment">    This routine interfaces to the NT Object Manager.  It is invoked when</span>
00039 <span class="comment">    the last reference to a particular Key object (or Key Root object)</span>
00040 <span class="comment">    is destroyed.</span>
00041 <span class="comment"></span>
00042 <span class="comment">    If the Key object going away holds the last reference to</span>
00043 <span class="comment">    the extension it is associated with, that extension is destroyed.</span>
00044 <span class="comment"></span>
00045 <span class="comment">Arguments:</span>
00046 <span class="comment"></span>
00047 <span class="comment">    Object - supplies a pointer to a KeyRoot or Key, thus -&gt; KEY_BODY.</span>
00048 <span class="comment"></span>
00049 <span class="comment">Return Value:</span>
00050 <span class="comment"></span>
00051 <span class="comment">    NONE.</span>
00052 <span class="comment"></span>
00053 <span class="comment">--*/</span>
00054 {
00055     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   KeyControlBlock;
00056     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>            KeyBody;
00057 
00058     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00059 
00060     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a28">CMS_NTAPI</a>) {
00061         KdPrint((<span class="stringliteral">"CmpDeleteKeyObject: Object = %08lx\n"</span>, Object));
00062     }
00063 
00064     <a class="code" href="../../d6/d3/cmwraper_8c.html#a14">CmpLockRegistry</a>();
00065 
00066     KeyBody = (<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)Object;
00067 
00068     <span class="keywordflow">if</span> (KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o0">Type</a>==<a class="code" href="../../d1/d2/cmp_8h.html#a78">KEY_BODY_TYPE</a>) {
00069         KeyControlBlock = KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>;
00070 
00071         <span class="comment">//</span>
00072         <span class="comment">// the keybody should be initialized; when kcb is null, something went wrong</span>
00073         <span class="comment">// between the creation and the dereferenciation of the object</span>
00074         <span class="comment">//</span>
00075         <span class="keywordflow">if</span>( KeyControlBlock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00076 
00077             <span class="comment">//</span>
00078             <span class="comment">// Clean up any outstanding notifies attached to the KeyBody</span>
00079             <span class="comment">//</span>
00080             <a class="code" href="../../d1/d2/cmp_8h.html#a288">CmpFlushNotify</a>(KeyBody);
00081 
00082             <span class="comment">//</span>
00083             <span class="comment">// Remove our reference to the KeyControlBlock, clean it up, perform any</span>
00084             <span class="comment">// pend-till-final-close operations.</span>
00085             <span class="comment">//</span>
00086             <span class="comment">// NOTE: Delete notification is seen at the parent of the deleted key,</span>
00087             <span class="comment">//       not the deleted key itself.  If any notify was outstanding on</span>
00088             <span class="comment">//       this key, it was cleared away above us.  Only parent/ancestor</span>
00089             <span class="comment">//       keys will see the report.</span>
00090             <span class="comment">//</span>
00091             <span class="comment">//</span>
00092             <span class="comment">// The dereference will free the KeyControlBlock.  If the key was deleted, it</span>
00093             <span class="comment">// has already been removed from the hash table, and relevent notifications</span>
00094             <span class="comment">// posted then as well.  All we are doing is freeing the tombstone.</span>
00095             <span class="comment">//</span>
00096             <span class="comment">// If it was not deleted, we're both cutting the kcb out of</span>
00097             <span class="comment">// the kcb list/tree, AND freeing its storage.</span>
00098             <span class="comment">//</span>
00099 
00100             <a class="code" href="../../d1/d2/cmp_8h.html#a82">DELIST_KEYBODY_FROM_KEYBODY_LIST</a>(KeyBody);
00101             <a class="code" href="../../d8/d2/cmsubs_8c.html#a22">CmpDereferenceKeyControlBlock</a>(KeyControlBlock);
00102         }
00103     } <span class="keywordflow">else</span> {
00104         <span class="comment">//</span>
00105         <span class="comment">// This must be a predefined handle</span>
00106         <span class="comment">//  some sanity asserts</span>
00107         <span class="comment">//</span>
00108         KeyControlBlock = KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>;
00109 
00110         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o0">Type</a>&amp;<a class="code" href="../../d1/d2/cmp_8h.html#a113">REG_PREDEF_HANDLE_MASK</a>);
00111         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o8">Flags</a>&amp;<a class="code" href="../../d9/d0/cmdata_8h.html#a33">KEY_PREDEF_HANDLE</a> );
00112         
00113         <span class="keywordflow">if</span>( KeyControlBlock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00114             <a class="code" href="../../d8/d2/cmsubs_8c.html#a22">CmpDereferenceKeyControlBlock</a>(KeyControlBlock);
00115         }
00116 
00117     }
00118     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00119     <span class="keywordflow">return</span>;
00120 }
00121 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:27 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
