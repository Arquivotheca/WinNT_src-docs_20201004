<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: multimon.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>multimon.c</h1><a href="../../d1/d5/multimon_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: multimon.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Multimonitor APIs.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 27-Sep-1996 adams     Stub implementation for NT 5.</span>
00010 <span class="comment">* 20-Feb-1997 adams     Port from NT4 SP3.</span>
00011 <span class="comment">\***************************************************************************/</span>
00012 
00013 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00014 <span class="preprocessor">#pragma hdrstop</span>
00015 <span class="preprocessor"></span>
00016 <span class="comment">/* last monitor the cursor was clipped to */</span>
<a name="l00017"></a><a class="code" href="../../d1/d5/multimon_8c.html#a0">00017</a> <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a> <a class="code" href="../../d1/d5/multimon_8c.html#a0">gpMonitorMouse</a>;
00018 
00019 <span class="comment">/***************************************************************************\</span>
00020 <span class="comment">* ClipPointToDesktop</span>
00021 <span class="comment">*</span>
00022 <span class="comment">* Clips the point the nearest monitor on the desktop.</span>
00023 <span class="comment">*</span>
00024 <span class="comment">* Arguments:</span>
00025 <span class="comment">*     lppt - The point to clip.</span>
00026 <span class="comment">*</span>
00027 <span class="comment">* History:</span>
00028 <span class="comment">* 22-Sep-1996 adams     Created.</span>
00029 <span class="comment">* 04-Sep-1998 MCostea   Use _MonitorFromPoint()</span>
00030 <span class="comment">\***************************************************************************/</span>
00031 
00032 <span class="keywordtype">void</span>
<a name="l00033"></a><a class="code" href="../../d4/d1/userk_8h.html#a2078">00033</a> <a class="code" href="../../d4/d1/userk_8h.html#a2078">ClipPointToDesktop</a>(LPPOINT lppt)
00034 {
00035     <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>        pMonitor;
00036 
00037     UserAssert(!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o18">fDesktopIsRect</a> &amp;&amp;
00038                <span class="stringliteral">"You shouldn't call this function if the desktop is a rectangle.\n"</span>
00039                <span class="stringliteral">"Just clip to gpsi-&gt;rcScreen instead."</span>);
00040 
00041     <span class="comment">/*</span>
00042 <span class="comment">     * Optimization: The cursor is likely to be on the monitor it was last on,</span>
00043 <span class="comment">     * so check for that case.</span>
00044 <span class="comment">     */</span>
00045     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d5/multimon_8c.html#a0">gpMonitorMouse</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d3/d6/rect_8c.html#a5">PtInRect</a>(&amp;<a class="code" href="../../d1/d5/multimon_8c.html#a0">gpMonitorMouse</a>-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>, *lppt)) {
00046         <span class="keywordflow">return</span>;
00047     }
00048 
00049     pMonitor = <a class="code" href="../../d9/d1/mmrtl_8c.html#a6">_MonitorFromPoint</a>(*lppt, MONITOR_DEFAULTTONEAREST);
00050 
00051     <span class="comment">/*</span>
00052 <span class="comment">     * Remember the monitor the cursor is on.</span>
00053 <span class="comment">     */</span>
00054     <a class="code" href="../../d1/d5/multimon_8c.html#a0">gpMonitorMouse</a> = pMonitor;
00055 
00056     <span class="keywordflow">if</span> (lppt-&gt;x &lt; pMonitor-&gt;rcMonitor.left) {
00057         lppt-&gt;x = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.left;
00058     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lppt-&gt;x &gt;= pMonitor-&gt;rcMonitor.right) {
00059         lppt-&gt;x = pMonitor-&gt;rcMonitor.right-1;
00060     }
00061     <span class="keywordflow">if</span> (lppt-&gt;y &lt; pMonitor-&gt;rcMonitor.top) {
00062         lppt-&gt;y = pMonitor-&gt;rcMonitor.top;
00063     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lppt-&gt;y &gt;= pMonitor-&gt;rcMonitor.bottom) {
00064         lppt-&gt;y = pMonitor-&gt;rcMonitor.bottom-1;
00065     }
00066 }
00067 
00068 <span class="comment">/***************************************************************************\</span>
00069 <span class="comment">* xxxEnumDisplayMonitors</span>
00070 <span class="comment">*</span>
00071 <span class="comment">* Enumerates the monitors in a display.</span>
00072 <span class="comment">*</span>
00073 <span class="comment">* Arguments:</span>
00074 <span class="comment">*     hdcPaint  - An HDC with a particular visible region. The HDC</span>
00075 <span class="comment">*         passed to lpfnEnum will have the capabilities of that monitor,</span>
00076 <span class="comment">*         with its visible region clipped to the monitor and hdcPaint.</span>
00077 <span class="comment">*         If hdcPaint is NULL, the hdcMonitor passed to lpfnEnum will be NULL.</span>
00078 <span class="comment">*</span>
00079 <span class="comment">*     lprcClip  - A rectangle to clip the area to. If hdcPaint is non-NULL,</span>
00080 <span class="comment">*         the coordinates have the origin of hdcPaint. If hdcPaint is NULL,</span>
00081 <span class="comment">*         the coordinates are virtual screen coordinates. If lprcClip is NULL,</span>
00082 <span class="comment">*         no clipping is performed.</span>
00083 <span class="comment">*</span>
00084 <span class="comment">*     lpfnEnum  - The enumeration function.</span>
00085 <span class="comment">*</span>
00086 <span class="comment">*     dwData    - Application-defined data that is passed through to the</span>
00087 <span class="comment">*         enumeration function.</span>
00088 <span class="comment">*</span>
00089 <span class="comment">*     fInternal - TRUE if the callback is in the kernel, FALSE otherwise.</span>
00090 <span class="comment">*</span>
00091 <span class="comment">* BUGBUG: This function is only a skeleton for the real thing. It needs</span>
00092 <span class="comment">* to handle different displays and possibly different bit depths.</span>
00093 <span class="comment">*</span>
00094 <span class="comment">* History:</span>
00095 <span class="comment">* 22-Sep-1996 adams     Created.</span>
00096 <span class="comment">\***************************************************************************/</span>
00097 
00098 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00099"></a><a class="code" href="../../d4/d1/userk_8h.html#a2076">00099</a> <a class="code" href="../../d4/d1/userk_8h.html#a2076">xxxEnumDisplayMonitors</a>(
00100     HDC             hdcPaint,
00101     LPRECT          lprcPaint,
00102     MONITORENUMPROC lpfnEnum,
00103     LPARAM          lData,
00104     BOOL            fInternal)
00105 {
00106     RECT            rcPaint;
00107     POINT           ptOrg;
00108     RECT            rcMonitorPaint;
00109     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>            fReturn;
00110     <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>        pMonitor;
00111     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>              tlpMonitor;
00112     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00113     <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a>            pdcePaint;
00114     HDC             hdcMonitor;
00115     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>            pwndOrg;
00116 
00117     <span class="comment">/*</span>
00118 <span class="comment">     * Validate the DC passed in.</span>
00119 <span class="comment">     */</span>
00120     <span class="keywordflow">if</span> (hdcPaint) {
00121 
00122         <span class="keywordflow">if</span> ((pdcePaint = <a class="code" href="../../d4/d1/userk_8h.html#a1706">LookupDC</a>(hdcPaint)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00123             RIPMSG0(RIP_WARNING, <span class="stringliteral">"EnumDisplayMonitors: LookupDC failed"</span>);
00124             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00125         }
00126 
00127         pwndOrg = pdcePaint-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a>;
00128 
00129         <span class="comment">/*</span>
00130 <span class="comment">         * Intersect the painting area with the clipbox.  If there</span>
00131 <span class="comment">         * isn't anything, bail out now.</span>
00132 <span class="comment">         */</span>
00133         <span class="keywordflow">if</span> (GreGetClipBox(hdcPaint, &amp;rcPaint, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) == NULLREGION)
00134             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00135 
00136         <span class="keywordflow">if</span> (lprcPaint &amp;&amp; !<a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rcPaint, &amp;rcPaint, lprcPaint))
00137             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00138 
00139         <span class="comment">/*</span>
00140 <span class="comment">         * rcPaint is in dc coordinates.  We must convert to screen</span>
00141 <span class="comment">         * coords so we can intersect with monitors.</span>
00142 <span class="comment">         */</span>
00143         GreGetDCOrg(hdcPaint, &amp;ptOrg);
00144         <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(&amp;rcPaint, ptOrg.x, ptOrg.y);
00145     } <span class="keywordflow">else</span> {
00146         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rcPaint, &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o14">rcScreen</a>);
00147         <span class="keywordflow">if</span> (lprcPaint &amp;&amp; !<a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rcPaint, &amp;rcPaint, lprcPaint))
00148             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00149     }
00150 
00151     fReturn = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00152 
00153     <span class="keywordflow">for</span> (pMonitor = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o13">pMonitorFirst</a>; pMonitor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00154                 pMonitor = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o1">pMonitorNext</a>) {
00155 
00156         <span class="comment">/*</span>
00157 <span class="comment">         * Note: the check for MONF_VISIBLE was removed to allow mirror drivers</span>
00158 <span class="comment">         * to see monitor specific updates.</span>
00159 <span class="comment">         */</span>
00160         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rcMonitorPaint, &amp;rcPaint, &amp;pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>)) {
00161             <span class="keywordflow">continue</span>;
00162         }
00163 
00164         <span class="keywordflow">if</span> (hdcPaint) {
00165 
00166             <span class="keywordflow">if</span> ((hdcMonitor = <a class="code" href="../../d4/d1/userk_8h.html#a1707">GetMonitorDC</a>(pdcePaint, pMonitor)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00167                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"EnumDisplayMonitors: GetMonitorDC failed"</span>);
00168                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00169             }
00170 
00171             <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(&amp;rcMonitorPaint, -ptOrg.x, -ptOrg.y);
00172             GreIntersectClipRect(
00173                     hdcMonitor,
00174                     rcMonitorPaint.left,
00175                     rcMonitorPaint.top,
00176                     rcMonitorPaint.right,
00177                     rcMonitorPaint.bottom);
00178         } <span class="keywordflow">else</span> {
00179 
00180             hdcMonitor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00181         }
00182 
00183         <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pMonitor, &amp;tlpMonitor);
00184 
00185         <span class="keywordflow">if</span> (fInternal) {
00186             fReturn = (*lpfnEnum) (
00187                     (HMONITOR) pMonitor,
00188                     hdcMonitor,
00189                     &amp;rcMonitorPaint,
00190                     lData);
00191 
00192         } <span class="keywordflow">else</span> {
00193             fReturn = <a class="code" href="../../d4/d1/userk_8h.html#a2077">xxxClientMonitorEnumProc</a>(
00194                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pMonitor),
00195                     hdcMonitor,
00196                     &amp;rcMonitorPaint,
00197                     lData,
00198                     lpfnEnum);
00199         }
00200 
00201         <span class="comment">/*</span>
00202 <span class="comment">         * We just called back and the monitor has been freed if</span>
00203 <span class="comment">         * ThreadUnlock returns NULL. The entire monitor configuration may</span>
00204 <span class="comment">         * have changed, the monitors may have been rearranged, so just stop</span>
00205 <span class="comment">         * enumerating at this point.</span>
00206 <span class="comment">         */</span>
00207         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpMonitor) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00208             fReturn = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00209         }
00210 
00211         <span class="keywordflow">if</span> (hdcMonitor)
00212             <a class="code" href="../../d4/d1/userk_8h.html#a1698">ReleaseCacheDC</a>(hdcMonitor, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00213 
00214         <span class="keywordflow">if</span> (!fReturn)
00215             <span class="keywordflow">break</span>;
00216 
00217         <span class="comment">/*</span>
00218 <span class="comment">         * Revalidate hdcPaint, since it could have been messed with</span>
00219 <span class="comment">         * in the callback.</span>
00220 <span class="comment">         */</span>
00221         <span class="keywordflow">if</span> (hdcPaint) {
00222             <span class="keywordflow">if</span> ((pdcePaint = <a class="code" href="../../d4/d1/userk_8h.html#a1706">LookupDC</a>(hdcPaint)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00223                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"EnumDisplayMonitors: LookupDC failed"</span>);
00224                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00225             }
00226 
00227             <span class="keywordflow">if</span> (pdcePaint-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a> != pwndOrg) {
00228                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"EnumDisplayMonitors: wrong window"</span>);
00229                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00230             }
00231         }
00232     }
00233 
00234     <span class="keywordflow">return</span> fReturn;
00235 }
00236 
00237 <span class="comment">/***************************************************************************\</span>
00238 <span class="comment">* DestroyMonitor</span>
00239 <span class="comment">*</span>
00240 <span class="comment">* This function doesn't keep track of the visible monitors count because</span>
00241 <span class="comment">* it assumes that after it was called the count will be recalculated, such</span>
00242 <span class="comment">* as the case during mode changes. For a final unlock the monitor will have</span>
00243 <span class="comment">* been removed from the monitor list already, so the count doesn't need to</span>
00244 <span class="comment">* be recalculated.</span>
00245 <span class="comment">*</span>
00246 <span class="comment">* 5-May-1998    vadimg      created</span>
00247 <span class="comment">\***************************************************************************/</span>
00248 
<a name="l00249"></a><a class="code" href="../../d4/d1/userk_8h.html#a2079">00249</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a2079">DestroyMonitor</a>(<a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a> pMonitor)
00250 {
00251     UserAssert(pMonitor);
00252 
00253     <span class="comment">/*</span>
00254 <span class="comment">     * Remove references to this monitor from the global data.</span>
00255 <span class="comment">     */</span>
00256     <span class="keywordflow">if</span> (pMonitor == <a class="code" href="../../d1/d5/multimon_8c.html#a0">gpMonitorMouse</a>) {
00257         <a class="code" href="../../d1/d5/multimon_8c.html#a0">gpMonitorMouse</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00258     }
00259 
00260     <span class="comment">/*</span>
00261 <span class="comment">     * Remove from the monitor list.</span>
00262 <span class="comment">     */</span>
00263     <a class="code" href="../../d4/d1/userk_8h.html#a752">REMOVE_FROM_LIST</a>(<a class="code" href="../../d0/d2/structtagMONITOR.html">MONITOR</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o13">pMonitorFirst</a>, pMonitor, pMonitorNext);
00264 
00265     <span class="comment">/*</span>
00266 <span class="comment">     * Make sure the primary monitor points to a valid monitor. During the</span>
00267 <span class="comment">     * mode changes the primary monitor will be recalculated as appropriate.</span>
00268 <span class="comment">     */</span>
00269     <span class="keywordflow">if</span> (pMonitor == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o12">pMonitorPrimary</a>) {
00270         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o12">pMonitorPrimary</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o13">pMonitorFirst</a>;
00271     }
00272 
00273     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a971">HMMarkObjectDestroy</a>(pMonitor)) {
00274 
00275         <span class="keywordflow">if</span> (pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o5">hrgnMonitor</a>) {
00276            GreDeleteObject(pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o5">hrgnMonitor</a>);
00277         }
00278     
00279         <a class="code" href="../../d4/d1/userk_8h.html#a970">HMFreeObject</a>(pMonitor);
00280     }
00281 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:53 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
