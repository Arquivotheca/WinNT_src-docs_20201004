<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: kdcpuapi.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>kdcpuapi.c</h1><a href="../../d1/d5/alpha_2kdcpuapi_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment">Copyright (c) 1992  Digital Equipment Corporation</span>
00005 <span class="comment"></span>
00006 <span class="comment">Module Name:</span>
00007 <span class="comment"></span>
00008 <span class="comment">    kdcpuapi.c</span>
00009 <span class="comment"></span>
00010 <span class="comment">Abstract:</span>
00011 <span class="comment"></span>
00012 <span class="comment">    This module implements CPU specific remote debug APIs.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Mark Lucovsky (markl) 04-Sep-1990</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Jeff McLeman (mcleman) 11-June-1992</span>
00021 <span class="comment">    Make this an alpha specific module</span>
00022 <span class="comment"></span>
00023 <span class="comment">    Joe Notarangelo  28-Sep-1992</span>
00024 <span class="comment">    Add Alpha-specific control space semantics.</span>
00025 <span class="comment"></span>
00026 <span class="comment">    Miche Baker-Harvey 22-Oct-1992</span>
00027 <span class="comment">    Added Kdp{Read,Write}IoSpace</span>
00028 <span class="comment">--*/</span>
00029 
00030 <span class="preprocessor">#include "<a class="code" href="../../d1/d7/4_2kdp_8h.html">kdp.h</a>"</span>
00031 
<a name="l00032"></a><a class="code" href="../../d1/d5/alpha_2kdcpuapi_8c.html#a0">00032</a> <span class="preprocessor">#define HEADER_FILE</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#include "kxalpha.h"</span>
00034 
00035 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00036"></a><a class="code" href="../../d0/d7/kdp_8h.html#a96">00036</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a113">KdpSetLoadState</a> (
00037     IN PDBGKD_WAIT_STATE_CHANGE WaitStateChange,
00038     IN PCONTEXT ContextRecord
00039     )
00040 
00041 <span class="comment">/*++</span>
00042 <span class="comment"></span>
00043 <span class="comment">Routine Description:</span>
00044 <span class="comment"></span>
00045 <span class="comment">    Fill in the Wait_State_Change message record for the load symbol case.</span>
00046 <span class="comment"></span>
00047 <span class="comment">Arguments:</span>
00048 <span class="comment"></span>
00049 <span class="comment">    WaitStateChange - Supplies pointer to record to fill in</span>
00050 <span class="comment"></span>
00051 <span class="comment">    ContextRecord - Supplies a pointer to a context record.</span>
00052 <span class="comment"></span>
00053 <span class="comment">Return Value:</span>
00054 <span class="comment"></span>
00055 <span class="comment">    None.</span>
00056 <span class="comment"></span>
00057 <span class="comment">--*/</span>
00058 
00059 {
00060 
00061     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00062     PVOID <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
00063 
00064     <span class="comment">//</span>
00065     <span class="comment">// Copy the immediate instruction stream into the control report structure.</span>
00066     <span class="comment">//</span>
00067 
00068     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> =  <a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(&amp;WaitStateChange-&gt;ControlReport.InstructionStream[0],
00069                            WaitStateChange-&gt;ProgramCounter,
00070                            DBGKD_MAXSTREAM);
00071 
00072     WaitStateChange-&gt;ControlReport.InstructionCount = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00073 
00074     <span class="comment">//</span>
00075     <span class="comment">// Clear breakpoints in the copied instruction stream. If any breakpoints</span>
00076     <span class="comment">// are clear, then recopy the instruction strasm.</span>
00077     <span class="comment">//</span>
00078 
00079     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = (PVOID)((PUCHAR)(WaitStateChange-&gt;ProgramCounter) + <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> - 1);
00080     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a106">KdpDeleteBreakpointRange</a>(WaitStateChange-&gt;ProgramCounter, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00081         <a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(&amp;WaitStateChange-&gt;ControlReport.InstructionStream[0],
00082                       WaitStateChange-&gt;ProgramCounter,
00083                       <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>);
00084     }
00085 
00086     <span class="comment">//</span>
00087     <span class="comment">// Copy the context record into the wait state structure.</span>
00088     <span class="comment">//</span>
00089 
00090     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>((PCHAR)&amp;WaitStateChange-&gt;Context,
00091                   (PCHAR)ContextRecord,
00092                   <span class="keyword">sizeof</span>(*ContextRecord));
00093 
00094     <span class="keywordflow">return</span>;
00095 }
00096 
00097 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00098"></a><a class="code" href="../../d0/d7/kdp_8h.html#a97">00098</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a114">KdpSetStateChange</a> (
00099     IN PDBGKD_WAIT_STATE_CHANGE WaitStateChange,
00100     IN PEXCEPTION_RECORD ExceptionRecord,
00101     IN PCONTEXT ContextRecord,
00102     IN BOOLEAN SecondChance
00103     )
00104 
00105 <span class="comment">/*++</span>
00106 <span class="comment"></span>
00107 <span class="comment">Routine Description:</span>
00108 <span class="comment"></span>
00109 <span class="comment">    Fill in the Wait_State_Change message record.</span>
00110 <span class="comment"></span>
00111 <span class="comment">Arguments:</span>
00112 <span class="comment"></span>
00113 <span class="comment">    WaitStateChange - Supplies pointer to record to fill in</span>
00114 <span class="comment"></span>
00115 <span class="comment">    ExceptionRecord - Supplies a pointer to an exception record.</span>
00116 <span class="comment"></span>
00117 <span class="comment">    ContextRecord - Supplies a pointer to a context record.</span>
00118 <span class="comment"></span>
00119 <span class="comment">    SecondChance - Supplies a boolean value that determines whether this is</span>
00120 <span class="comment">        the first or second chance for the exception.</span>
00121 <span class="comment"></span>
00122 <span class="comment">Return Value:</span>
00123 <span class="comment"></span>
00124 <span class="comment">    None.</span>
00125 <span class="comment"></span>
00126 <span class="comment">--*/</span>
00127 
00128 {
00129 
00130     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00131     PVOID <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
00132 
00133     <span class="comment">//</span>
00134     <span class="comment">// Set up description of event, including exception record</span>
00135     <span class="comment">//</span>
00136 
00137     WaitStateChange-&gt;NewState = DbgKdExceptionStateChange;
00138     WaitStateChange-&gt;ProcessorLevel = <a class="code" href="../../d4/d9/ke_8h.html#a135">KeProcessorLevel</a>;
00139     WaitStateChange-&gt;Processor = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a12">KdpGetCurrentPrcb</a>()-&gt;Number;
00140     WaitStateChange-&gt;NumberProcessors = (ULONG)<a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>;
00141     WaitStateChange-&gt;Thread = (PVOID)<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a13">KdpGetCurrentThread</a>();
00142     WaitStateChange-&gt;ProgramCounter = (PVOID)CONTEXT_TO_PROGRAM_COUNTER(ContextRecord);
00143     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a111">KdpQuickMoveMemory</a>((PCHAR)&amp;WaitStateChange-&gt;u.Exception.ExceptionRecord,
00144                        (PCHAR)ExceptionRecord,
00145                        <span class="keyword">sizeof</span>(EXCEPTION_RECORD));
00146 
00147     WaitStateChange-&gt;u.Exception.FirstChance = !SecondChance;
00148 
00149     <span class="comment">//</span>
00150     <span class="comment">// Copy the immediate instruction stream into the control report structure.</span>
00151     <span class="comment">//</span>
00152 
00153     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> =  <a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(&amp;WaitStateChange-&gt;ControlReport.InstructionStream[0],
00154                            WaitStateChange-&gt;ProgramCounter,
00155                            DBGKD_MAXSTREAM);
00156 
00157     WaitStateChange-&gt;ControlReport.InstructionCount = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00158 
00159     <span class="comment">//</span>
00160     <span class="comment">// Clear breakpoints in the copied instruction stream. If any breakpoints</span>
00161     <span class="comment">// are clear, then recopy the instruction strasm.</span>
00162     <span class="comment">//</span>
00163 
00164     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = (PVOID)((PUCHAR)(WaitStateChange-&gt;ProgramCounter) + <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> - 1);
00165     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a106">KdpDeleteBreakpointRange</a>(WaitStateChange-&gt;ProgramCounter, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00166         <a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(&amp;WaitStateChange-&gt;ControlReport.InstructionStream[0],
00167                       WaitStateChange-&gt;ProgramCounter,
00168                       <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>);
00169     }
00170 
00171     <span class="comment">//</span>
00172     <span class="comment">// Copy the context record into the wait state structure.</span>
00173     <span class="comment">//</span>
00174 
00175     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>((PCHAR)&amp;WaitStateChange-&gt;Context,
00176                   (PCHAR)ContextRecord,
00177                   <span class="keyword">sizeof</span>(*ContextRecord));
00178 
00179     <span class="keywordflow">return</span>;
00180 }
00181 
00182 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00183"></a><a class="code" href="../../d0/d7/kdp_8h.html#a98">00183</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a115">KdpGetStateChange</a> (
00184     IN PDBGKD_MANIPULATE_STATE ManipulateState,
00185     IN PCONTEXT ContextRecord
00186     )
00187 
00188 <span class="comment">/*++</span>
00189 <span class="comment"></span>
00190 <span class="comment">Routine Description:</span>
00191 <span class="comment"></span>
00192 <span class="comment">    Extract continuation control data from Manipulate_State message</span>
00193 <span class="comment"></span>
00194 <span class="comment">    N.B. This is a noop for MIPS.</span>
00195 <span class="comment"></span>
00196 <span class="comment">Arguments:</span>
00197 <span class="comment"></span>
00198 <span class="comment">    ManipulateState - supplies pointer to Manipulate_State packet</span>
00199 <span class="comment"></span>
00200 <span class="comment">    ContextRecord - Supplies a pointer to a context record.</span>
00201 <span class="comment"></span>
00202 <span class="comment">Return Value:</span>
00203 <span class="comment"></span>
00204 <span class="comment">    None.</span>
00205 <span class="comment"></span>
00206 <span class="comment">--*/</span>
00207 
00208 {
00209 }
00210 
00211 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00212"></a><a class="code" href="../../d0/d7/kdp_8h.html#a119">00212</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a132">KdpReadControlSpace</a> (
00213     IN PDBGKD_MANIPULATE_STATE m,
00214     IN PSTRING AdditionalData,
00215     IN PCONTEXT Context
00216     )
00217 
00218 <span class="comment">/*++</span>
00219 <span class="comment"></span>
00220 <span class="comment">Routine Description:</span>
00221 <span class="comment"></span>
00222 <span class="comment">    This function is called in response of a read control space state</span>
00223 <span class="comment">    manipulation message.  Its function is to read implementation</span>
00224 <span class="comment">    specific system data.</span>
00225 <span class="comment"></span>
00226 <span class="comment">Arguments:</span>
00227 <span class="comment"></span>
00228 <span class="comment">    m - Supplies the state manipulation message.</span>
00229 <span class="comment"></span>
00230 <span class="comment">    AdditionalData - Supplies any additional data for the message.</span>
00231 <span class="comment"></span>
00232 <span class="comment">    Context - Supplies the current context.</span>
00233 <span class="comment"></span>
00234 <span class="comment">Return Value:</span>
00235 <span class="comment"></span>
00236 <span class="comment">    None.</span>
00237 <span class="comment"></span>
00238 <span class="comment">--*/</span>
00239 
00240 {
00241 
00242     PDBGKD_READ_MEMORY a = &amp;m-&gt;u.ReadMemory;
00243     ULONG Length;
00244     STRING MessageHeader;
00245     PVOID <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = AdditionalData-&gt;Buffer;
00246 
00247     MessageHeader.Length = <span class="keyword">sizeof</span>(*m);
00248     MessageHeader.Buffer = (PCHAR)m;
00249 
00250     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(AdditionalData-&gt;Length == 0);
00251 
00252     <span class="keywordflow">if</span> (a-&gt;TransferCount &gt; (PACKET_MAX_SIZE - <span class="keyword">sizeof</span>(DBGKD_MANIPULATE_STATE))) {
00253         Length = PACKET_MAX_SIZE - <span class="keyword">sizeof</span>(DBGKD_MANIPULATE_STATE);
00254     } <span class="keywordflow">else</span> {
00255         Length = a-&gt;TransferCount;
00256     }
00257 
00258     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<span class="keyword">sizeof</span>(PVOID) == <span class="keyword">sizeof</span>(ULONG));
00259 
00260 <span class="comment">//NOTENOTE</span>
00261 <span class="comment">//  This code will in fact only work on a uni-processor as the</span>
00262 <span class="comment">//  m-&gt;Processor field is ignored for now</span>
00263 
00264     <span class="comment">//</span>
00265     <span class="comment">// Case on address to determine what part of Control</span>
00266     <span class="comment">// space is being read</span>
00267     <span class="comment">//</span>
00268 
00269     <span class="keywordflow">switch</span>( (ULONG_PTR)a-&gt;TargetBaseAddress ){
00270 
00271         <span class="comment">//</span>
00272         <span class="comment">// Return the pcr address for the current processor.</span>
00273         <span class="comment">//</span>
00274 
00275     <span class="keywordflow">case</span> DEBUG_CONTROL_SPACE_PCR:
00276 
00277         *(PKPCR *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a7">KdpGetPcr</a>();
00278         AdditionalData-&gt;Length = <span class="keyword">sizeof</span>( PKPCR );
00279         a-&gt;ActualBytesRead = AdditionalData-&gt;Length;
00280         m-&gt;ReturnStatus = STATUS_SUCCESS;
00281         <span class="keywordflow">break</span>;
00282 
00283         <span class="comment">//</span>
00284         <span class="comment">// Return the prcb address for the current processor.</span>
00285         <span class="comment">//</span>
00286 
00287     <span class="keywordflow">case</span> DEBUG_CONTROL_SPACE_PRCB:
00288 
00289         *(PKPRCB *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a12">KdpGetCurrentPrcb</a>();
00290         AdditionalData-&gt;Length = <span class="keyword">sizeof</span>( PKPRCB );
00291         a-&gt;ActualBytesRead = AdditionalData-&gt;Length;
00292         m-&gt;ReturnStatus = STATUS_SUCCESS;
00293         <span class="keywordflow">break</span>;
00294 
00295         <span class="comment">//</span>
00296         <span class="comment">// Return the pointer to the current thread address for the</span>
00297         <span class="comment">// current processor.</span>
00298         <span class="comment">//</span>
00299 
00300     <span class="keywordflow">case</span> DEBUG_CONTROL_SPACE_THREAD:
00301 
00302         *(<a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a13">KdpGetCurrentThread</a>();
00303         AdditionalData-&gt;Length = <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> );
00304         a-&gt;ActualBytesRead = AdditionalData-&gt;Length;
00305         m-&gt;ReturnStatus = STATUS_SUCCESS;
00306         <span class="keywordflow">break</span>;
00307 
00308         <span class="comment">//</span>
00309         <span class="comment">// Return the current Thread Environment Block pointer for the</span>
00310         <span class="comment">// current thread on the current processor.</span>
00311         <span class="comment">//</span>
00312 
00313     <span class="keywordflow">case</span> DEBUG_CONTROL_SPACE_TEB:
00314 
00315         *(PVOID *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = (PVOID)NtCurrentTeb();
00316         AdditionalData-&gt;Length = <span class="keyword">sizeof</span>( <span class="keyword">struct </span>_TEB * );
00317         a-&gt;ActualBytesRead = AdditionalData-&gt;Length;
00318         m-&gt;ReturnStatus = STATUS_SUCCESS;
00319         <span class="keywordflow">break</span>;
00320 
00321         <span class="comment">//</span>
00322         <span class="comment">// Return the dpc active flag for the current processor.</span>
00323         <span class="comment">//</span>
00324 
00325     <span class="keywordflow">case</span> DEBUG_CONTROL_SPACE_DPCACTIVE:
00326 
00327         *(BOOLEAN *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = KeIsExecutingDpc();
00328         AdditionalData-&gt;Length = <span class="keyword">sizeof</span>( ULONG );
00329         a-&gt;ActualBytesRead = AdditionalData-&gt;Length;
00330         m-&gt;ReturnStatus = STATUS_SUCCESS;
00331         <span class="keywordflow">break</span>;
00332 
00333         <span class="comment">//</span>
00334         <span class="comment">// Return the internal processor register state.</span>
00335         <span class="comment">//</span>
00336         <span class="comment">// N.B. - the kernel debugger buffer is expected to be allocated</span>
00337         <span class="comment">//        in the 32-bit superpage</span>
00338         <span class="comment">//</span>
00339         <span class="comment">// N.B. - the size of the internal state cannot exceed the size of</span>
00340         <span class="comment">//        the buffer allocated to the kernel debugger via</span>
00341         <span class="comment">//        KDP_MESSAGE_BUFFER_SIZE</span>
00342         <span class="comment">//</span>
00343 
00344     <span class="keywordflow">case</span> DEBUG_CONTROL_SPACE_IPRSTATE:
00345 
00346         <span class="comment">//</span>
00347         <span class="comment">// Guarantee that Buffer is quadword-aligned, and adjust the</span>
00348         <span class="comment">// size of the available buffer accordingly.</span>
00349         <span class="comment">//</span>
00350 
00351         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = (PVOID)( ((ULONG_PTR)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> + 7) &amp; ~7);
00352 
00353         Length = (ULONG)((ULONG_PTR)&amp;AdditionalData-&gt;Buffer[<a class="code" href="../../d0/d7/kdp_8h.html#a14">KDP_MESSAGE_BUFFER_SIZE</a>] -
00354                  (ULONG_PTR)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00355 
00356         AdditionalData-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d7/d7/4_2axp64_2kdpcpu_8h.html#a8">KdpReadInternalProcessorState</a>(
00357                                              <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00358                                              Length );
00359 
00360         <span class="comment">//</span>
00361         <span class="comment">// Check the returned size, if greater than the buffer size than</span>
00362         <span class="comment">// we didn't have a sufficient buffer.  If zero then the call</span>
00363         <span class="comment">// failed otherwise.</span>
00364         <span class="comment">//</span>
00365 
00366         <span class="keywordflow">if</span>( (AdditionalData-&gt;Length &gt; <a class="code" href="../../d0/d7/kdp_8h.html#a14">KDP_MESSAGE_BUFFER_SIZE</a>) ||
00367             (AdditionalData-&gt;Length == 0) ){
00368 
00369             AdditionalData-&gt;Length = 0;
00370             m-&gt;ReturnStatus = STATUS_UNSUCCESSFUL;
00371             a-&gt;ActualBytesRead = 0;
00372 
00373         } <span class="keywordflow">else</span> {
00374 
00375             m-&gt;ReturnStatus = STATUS_SUCCESS;
00376             a-&gt;ActualBytesRead = AdditionalData-&gt;Length;
00377 
00378         }
00379 
00380         <span class="keywordflow">break</span>;
00381 
00382         <span class="comment">//</span>
00383         <span class="comment">// Return the internal processor counter values.</span>
00384         <span class="comment">//</span>
00385         <span class="comment">// N.B. - the kernel debugger buffer is expected to be allocated</span>
00386         <span class="comment">//        in the 32-bit superpage</span>
00387         <span class="comment">//</span>
00388         <span class="comment">// N.B. - the size of the counters structure cannot exceed the size of</span>
00389         <span class="comment">//        the buffer allocated to the kernel debugger via</span>
00390         <span class="comment">//        KDP_MESSAGE_BUFFER_SIZE</span>
00391         <span class="comment">//</span>
00392 
00393     <span class="keywordflow">case</span> DEBUG_CONTROL_SPACE_COUNTERS:
00394 
00395         <span class="comment">//</span>
00396         <span class="comment">// Guarantee that Buffer is quadword-aligned, and adjust the</span>
00397         <span class="comment">// size of the available buffer accordingly.</span>
00398         <span class="comment">//</span>
00399 
00400         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = (PVOID)( ((ULONG_PTR)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> + 7) &amp; ~7);
00401 
00402         Length = (ULONG)((ULONG_PTR)&amp;AdditionalData-&gt;Buffer[<a class="code" href="../../d0/d7/kdp_8h.html#a14">KDP_MESSAGE_BUFFER_SIZE</a>] -
00403                  (ULONG_PTR)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00404 
00405         AdditionalData-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d7/d7/4_2axp64_2kdpcpu_8h.html#a9">KdpReadInternalProcessorCounters</a>(
00406                                              <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00407                                              Length );
00408 
00409         <span class="comment">//</span>
00410         <span class="comment">// Check the returned size, if greater than the buffer size than</span>
00411         <span class="comment">// we didn't have a sufficient buffer.  If zero then the call</span>
00412         <span class="comment">// failed otherwise.</span>
00413         <span class="comment">//</span>
00414 
00415         <span class="keywordflow">if</span>( (AdditionalData-&gt;Length &gt; <a class="code" href="../../d0/d7/kdp_8h.html#a14">KDP_MESSAGE_BUFFER_SIZE</a>) ||
00416             (AdditionalData-&gt;Length == 0) ){
00417 
00418             AdditionalData-&gt;Length = 0;
00419             m-&gt;ReturnStatus = STATUS_UNSUCCESSFUL;
00420             a-&gt;ActualBytesRead = 0;
00421 
00422         } <span class="keywordflow">else</span> {
00423 
00424             m-&gt;ReturnStatus = STATUS_SUCCESS;
00425             a-&gt;ActualBytesRead = AdditionalData-&gt;Length;
00426 
00427         }
00428 
00429         <span class="keywordflow">break</span>;
00430 
00431         <span class="comment">//</span>
00432         <span class="comment">// Uninterpreted Special Space</span>
00433         <span class="comment">//</span>
00434 
00435     <span class="keywordflow">default</span>:
00436 
00437         AdditionalData-&gt;Length = 0;
00438         m-&gt;ReturnStatus = STATUS_UNSUCCESSFUL;
00439         a-&gt;ActualBytesRead = 0;
00440 
00441     }
00442 
00443     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
00444         PACKET_TYPE_KD_STATE_MANIPULATE,
00445         &amp;MessageHeader,
00446         AdditionalData
00447         );
00448 }
00449 
00450 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00451"></a><a class="code" href="../../d0/d7/kdp_8h.html#a120">00451</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a133">KdpWriteControlSpace</a> (
00452     IN PDBGKD_MANIPULATE_STATE m,
00453     IN PSTRING AdditionalData,
00454     IN PCONTEXT Context
00455     )
00456 
00457 <span class="comment">/*++</span>
00458 <span class="comment"></span>
00459 <span class="comment">Routine Description:</span>
00460 <span class="comment"></span>
00461 <span class="comment">    This function is called in response of a write control space state</span>
00462 <span class="comment">    manipulation message.  Its function is to write implementation</span>
00463 <span class="comment">    specific system data.</span>
00464 <span class="comment"></span>
00465 <span class="comment">Arguments:</span>
00466 <span class="comment"></span>
00467 <span class="comment">    m - Supplies the state manipulation message.</span>
00468 <span class="comment"></span>
00469 <span class="comment">    AdditionalData - Supplies any additional data for the message.</span>
00470 <span class="comment"></span>
00471 <span class="comment">    Context - Supplies the current context.</span>
00472 <span class="comment"></span>
00473 <span class="comment">Return Value:</span>
00474 <span class="comment"></span>
00475 <span class="comment">    None.</span>
00476 <span class="comment"></span>
00477 <span class="comment">--*/</span>
00478 
00479 {
00480     PDBGKD_WRITE_MEMORY a = &amp;m-&gt;u.WriteMemory;
00481     ULONG Length;
00482     STRING MessageHeader;
00483 
00484     MessageHeader.Length = <span class="keyword">sizeof</span>(*m);
00485     MessageHeader.Buffer = (PCHAR)m;
00486 
00487     AdditionalData-&gt;Length = 0;
00488     m-&gt;ReturnStatus = STATUS_UNSUCCESSFUL;
00489     a-&gt;ActualBytesWritten = 0;
00490 
00491     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
00492         PACKET_TYPE_KD_STATE_MANIPULATE,
00493         &amp;MessageHeader,
00494         AdditionalData
00495         );
00496 }
00497 
00498 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00499"></a><a class="code" href="../../d0/d7/kdp_8h.html#a121">00499</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a134">KdpReadIoSpace</a> (
00500     IN PDBGKD_MANIPULATE_STATE m,
00501     IN PSTRING AdditionalData,
00502     IN PCONTEXT Context
00503     )
00504 
00505 <span class="comment">/*++</span>
00506 <span class="comment"></span>
00507 <span class="comment">Routine Description:</span>
00508 <span class="comment"></span>
00509 <span class="comment">    This function is called in response of a read io space state</span>
00510 <span class="comment">    manipulation message.  Its function is to read system io</span>
00511 <span class="comment">    locations.</span>
00512 <span class="comment"></span>
00513 <span class="comment">Arguments:</span>
00514 <span class="comment"></span>
00515 <span class="comment">    m - Supplies the state manipulation message.</span>
00516 <span class="comment"></span>
00517 <span class="comment">    AdditionalData - Supplies any additional data for the message.</span>
00518 <span class="comment"></span>
00519 <span class="comment">    Context - Supplies the current context.</span>
00520 <span class="comment"></span>
00521 <span class="comment">Return Value:</span>
00522 <span class="comment"></span>
00523 <span class="comment">    None.</span>
00524 <span class="comment"></span>
00525 <span class="comment">--*/</span>
00526 
00527 {
00528     PDBGKD_READ_WRITE_IO a = &amp;m-&gt;u.ReadWriteIo;
00529     STRING MessageHeader;
00530     INTERFACE_TYPE <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>;
00531     ULONG <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>;
00532     PHYSICAL_ADDRESS IoAddress;
00533     PHYSICAL_ADDRESS TranslatedAddress;
00534     ULONG AddressSpace;
00535     ULONG DataSize;
00536 
00537     MessageHeader.Length = <span class="keyword">sizeof</span>(*m);
00538     MessageHeader.Buffer = (PCHAR)m;
00539 
00540     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(AdditionalData-&gt;Length == 0);
00541 
00542     m-&gt;ReturnStatus = STATUS_SUCCESS;
00543 
00544     <span class="comment">//</span>
00545     <span class="comment">// Capture the input parameters and use the default values for those</span>
00546     <span class="comment">// parameters not specified in the Api.</span>
00547     <span class="comment">//</span>
00548 
00549     <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> = Isa;
00550     <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> = 0;
00551     AddressSpace = 1;
00552     IoAddress.QuadPart = (ULONG_PTR)a-&gt;IoAddress;
00553     DataSize = a-&gt;DataSize;
00554 
00555     <span class="comment">//</span>
00556     <span class="comment">// Zero the return data value.</span>
00557     <span class="comment">//</span>
00558 
00559     a-&gt;DataValue = 0;
00560 
00561     <span class="comment">//</span>
00562     <span class="comment">// Translate the bus address to the physical system address</span>
00563     <span class="comment">// or QVA.</span>
00564     <span class="comment">//</span>
00565 
00566     <span class="keywordflow">if</span>( !<a class="code" href="../../d2/d7/hal_8h.html#a184">HalTranslateBusAddress</a>( <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>,
00567                                  <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>,
00568                                  IoAddress,
00569                                  &amp;AddressSpace,
00570                                  &amp;TranslatedAddress ) ){
00571         m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00572         <span class="keywordflow">goto</span> SendReadIoSpaceResponse;
00573     }
00574 
00575     <span class="comment">//</span>
00576     <span class="comment">// N.B. - for the moment we will only support QVAs ie. when AddressSpace</span>
00577     <span class="comment">//        is one.  It may be in later systems that we will have to</span>
00578     <span class="comment">//        check the address space, map it, perform the virtual read</span>
00579     <span class="comment">//        unmap, and then return the data - only we will have to be</span>
00580     <span class="comment">//        careful about what Irql we are to make sure the memory mgmt</span>
00581     <span class="comment">//        stuff will all work</span>
00582     <span class="comment">//</span>
00583 
00584     <span class="keywordflow">if</span>( !AddressSpace ){
00585         m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00586         <span class="keywordflow">goto</span> SendReadIoSpaceResponse;
00587     }
00588 
00589     <span class="comment">//</span>
00590     <span class="comment">// Do the IO space read using the appropriate HAL routines based upon</span>
00591     <span class="comment">// the default address space (io) and the data size requested.</span>
00592     <span class="comment">//</span>
00593 
00594     <span class="keywordflow">switch</span>( DataSize ){
00595 
00596     <span class="keywordflow">case</span> 1:
00597         a-&gt;DataValue = READ_PORT_UCHAR( (PUCHAR)TranslatedAddress.LowPart );
00598         <span class="keywordflow">break</span>;
00599 
00600     <span class="keywordflow">case</span> 2:
00601         a-&gt;DataValue = READ_PORT_USHORT( (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)TranslatedAddress.LowPart );
00602         <span class="keywordflow">break</span>;
00603 
00604     <span class="keywordflow">case</span> 4:
00605         a-&gt;DataValue = READ_PORT_ULONG((PULONG)TranslatedAddress.LowPart );
00606         <span class="keywordflow">break</span>;
00607 
00608     <span class="keywordflow">default</span>:
00609         m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00610     }
00611 
00612 
00613 SendReadIoSpaceResponse:
00614 
00615     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
00616         PACKET_TYPE_KD_STATE_MANIPULATE,
00617         &amp;MessageHeader,
00618         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00619         );
00620 }
00621 
00622 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00623"></a><a class="code" href="../../d7/d7/4_2axp64_2kdpcpu_8h.html#a10">00623</a> <a class="code" href="../../d7/d7/4_2axp64_2kdpcpu_8h.html#a10">KdpReadIoSpaceExtended</a> (
00624     IN PDBGKD_MANIPULATE_STATE m,
00625     IN PSTRING AdditionalData,
00626     IN PCONTEXT Context
00627     )
00628 
00629 <span class="comment">/*++</span>
00630 <span class="comment"></span>
00631 <span class="comment">Routine Description:</span>
00632 <span class="comment"></span>
00633 <span class="comment">    This function is called in response of a read io space extended state</span>
00634 <span class="comment">    manipulation message.  Its function is to read system io</span>
00635 <span class="comment">    locations.</span>
00636 <span class="comment"></span>
00637 <span class="comment">Arguments:</span>
00638 <span class="comment"></span>
00639 <span class="comment">    m - Supplies the state manipulation message.</span>
00640 <span class="comment"></span>
00641 <span class="comment">    AdditionalData - Supplies any additional data for the message.</span>
00642 <span class="comment"></span>
00643 <span class="comment">    Context - Supplies the current context.</span>
00644 <span class="comment"></span>
00645 <span class="comment">Return Value:</span>
00646 <span class="comment"></span>
00647 <span class="comment">    None.</span>
00648 <span class="comment"></span>
00649 <span class="comment">--*/</span>
00650 
00651 {
00652     PDBGKD_READ_WRITE_IO_EXTENDED a = &amp;m-&gt;u.ReadWriteIoExtended;
00653     ULONG Length;
00654     STRING MessageHeader;
00655     PUCHAR b;
00656     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a> s;
00657     PULONG l;
00658     ULONG <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>;
00659     ULONG AddressSpace;
00660     ULONG SavedAddressSpace;
00661     PHYSICAL_ADDRESS IoAddress;
00662     ULONG DataSize;
00663     PHYSICAL_ADDRESS TranslatedAddress;
00664     INTERFACE_TYPE <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>;
00665 
00666     MessageHeader.Length = <span class="keyword">sizeof</span>(*m);
00667     MessageHeader.Buffer = (PCHAR)m;
00668 
00669     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(AdditionalData-&gt;Length == 0);
00670 
00671     m-&gt;ReturnStatus = STATUS_SUCCESS;
00672 
00673     <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> = a-&gt;InterfaceType;
00674     <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> = a-&gt;BusNumber;
00675     AddressSpace = SavedAddressSpace = a-&gt;AddressSpace;
00676     IoAddress.QuadPart = (ULONG_PTR)a-&gt;IoAddress;
00677     DataSize = a-&gt;DataSize;
00678 
00679     <span class="comment">//</span>
00680     <span class="comment">// Zero the return data value.</span>
00681     <span class="comment">//</span>
00682 
00683     a-&gt;DataValue = 0;
00684 
00685     <span class="comment">//</span>
00686     <span class="comment">// Translate the bus address to the physical system address</span>
00687     <span class="comment">// or QVA.</span>
00688     <span class="comment">//</span>
00689 
00690     <span class="keywordflow">if</span>( !<a class="code" href="../../d2/d7/hal_8h.html#a184">HalTranslateBusAddress</a>( <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>,
00691                                  <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>,
00692                                  IoAddress,
00693                                  &amp;AddressSpace,
00694                                  &amp;TranslatedAddress ) ){
00695         m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00696         <span class="keywordflow">goto</span> SendReadIoSpaceExtendedResponse;
00697     }
00698 
00699     <span class="comment">//</span>
00700     <span class="comment">// N.B. - for the moment we will only support QVAs ie. when AddressSpace</span>
00701     <span class="comment">//        is one.  It may be in later systems that we will have to</span>
00702     <span class="comment">//        check the address space, map it, perform the virtual read</span>
00703     <span class="comment">//        unmap, and then return the data - only we will have to be</span>
00704     <span class="comment">//        careful about what Irql we are to make sure the memory mgmt</span>
00705     <span class="comment">//        stuff will all work</span>
00706     <span class="comment">//</span>
00707 
00708     <span class="keywordflow">if</span>( !AddressSpace ){
00709         m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00710         <span class="keywordflow">goto</span> SendReadIoSpaceExtendedResponse;
00711     }
00712 
00713     <span class="comment">//</span>
00714     <span class="comment">// Do the IO space read using the appropriate HAL routines based upon</span>
00715     <span class="comment">// the original address space and the data size requested.</span>
00716     <span class="comment">//</span>
00717 
00718     <span class="keywordflow">if</span>( !SavedAddressSpace ){
00719 
00720         <span class="comment">//</span>
00721         <span class="comment">// Memory (buffer) space on the bus</span>
00722         <span class="comment">//</span>
00723 
00724         <span class="keywordflow">switch</span>( DataSize ){
00725 
00726         <span class="keywordflow">case</span> 1:
00727             a-&gt;DataValue = READ_REGISTER_UCHAR( (PUCHAR)TranslatedAddress.LowPart );
00728             <span class="keywordflow">break</span>;
00729 
00730         <span class="keywordflow">case</span> 2:
00731             a-&gt;DataValue = READ_REGISTER_USHORT((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)TranslatedAddress.LowPart );
00732             <span class="keywordflow">break</span>;
00733 
00734         <span class="keywordflow">case</span> 4:
00735             a-&gt;DataValue = READ_REGISTER_ULONG((PULONG)TranslatedAddress.LowPart );
00736             <span class="keywordflow">break</span>;
00737 
00738         <span class="keywordflow">default</span>:
00739             m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00740         }
00741 
00742     } <span class="keywordflow">else</span> {
00743 
00744         <span class="comment">//</span>
00745         <span class="comment">// I/O space on the bus</span>
00746         <span class="comment">//</span>
00747 
00748         <span class="keywordflow">switch</span>( DataSize ){
00749 
00750         <span class="keywordflow">case</span> 1:
00751             a-&gt;DataValue = READ_PORT_UCHAR( (PUCHAR)TranslatedAddress.LowPart );
00752             <span class="keywordflow">break</span>;
00753 
00754         <span class="keywordflow">case</span> 2:
00755             a-&gt;DataValue = READ_PORT_USHORT( (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)TranslatedAddress.LowPart );
00756             <span class="keywordflow">break</span>;
00757 
00758         <span class="keywordflow">case</span> 4:
00759             a-&gt;DataValue = READ_PORT_ULONG( (PULONG)TranslatedAddress.LowPart );
00760             <span class="keywordflow">break</span>;
00761 
00762         <span class="keywordflow">default</span>:
00763             m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00764         }
00765     }
00766 
00767 
00768 
00769 SendReadIoSpaceExtendedResponse:
00770 
00771     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
00772         PACKET_TYPE_KD_STATE_MANIPULATE,
00773         &amp;MessageHeader,
00774         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00775         );
00776 }
00777 
00778 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00779"></a><a class="code" href="../../d0/d7/kdp_8h.html#a123">00779</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a136">KdpWriteIoSpace</a> (
00780     IN PDBGKD_MANIPULATE_STATE m,
00781     IN PSTRING AdditionalData,
00782     IN PCONTEXT Context
00783     )
00784 
00785 <span class="comment">/*++</span>
00786 <span class="comment"></span>
00787 <span class="comment">Routine Description:</span>
00788 <span class="comment"></span>
00789 <span class="comment">    This function is called in response of a read io space state</span>
00790 <span class="comment">    manipulation message.  Its function is to read system io</span>
00791 <span class="comment">    locations.</span>
00792 <span class="comment"></span>
00793 <span class="comment">Arguments:</span>
00794 <span class="comment"></span>
00795 <span class="comment">    m - Supplies the state manipulation message.</span>
00796 <span class="comment"></span>
00797 <span class="comment">    AdditionalData - Supplies any additional data for the message.</span>
00798 <span class="comment"></span>
00799 <span class="comment">    Context - Supplies the current context.</span>
00800 <span class="comment"></span>
00801 <span class="comment">Return Value:</span>
00802 <span class="comment"></span>
00803 <span class="comment">    None.</span>
00804 <span class="comment"></span>
00805 <span class="comment">--*/</span>
00806 
00807 {
00808     PDBGKD_READ_WRITE_IO a = &amp;m-&gt;u.ReadWriteIo;
00809     STRING MessageHeader;
00810     INTERFACE_TYPE <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>;
00811     ULONG <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>;
00812     PHYSICAL_ADDRESS IoAddress;
00813     PHYSICAL_ADDRESS TranslatedAddress;
00814     ULONG AddressSpace;
00815     ULONG DataSize;
00816     ULONG Value;
00817 
00818     MessageHeader.Length = <span class="keyword">sizeof</span>(*m);
00819     MessageHeader.Buffer = (PCHAR)m;
00820 
00821     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(AdditionalData-&gt;Length == 0);
00822 
00823     m-&gt;ReturnStatus = STATUS_SUCCESS;
00824 
00825     <span class="comment">//</span>
00826     <span class="comment">// Capture the input parameters and use the default values for those</span>
00827     <span class="comment">// parameters not specified in the Api.</span>
00828     <span class="comment">//</span>
00829 
00830     <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> = Isa;
00831     <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> = 0;
00832     AddressSpace = 1;
00833     IoAddress.QuadPart = (ULONG_PTR)a-&gt;IoAddress;
00834     DataSize = a-&gt;DataSize;
00835     Value = a-&gt;DataValue;
00836 
00837     <span class="comment">//</span>
00838     <span class="comment">// Translate the bus address to the physical system address</span>
00839     <span class="comment">// or QVA.</span>
00840     <span class="comment">//</span>
00841 
00842     <span class="keywordflow">if</span>( !<a class="code" href="../../d2/d7/hal_8h.html#a184">HalTranslateBusAddress</a>( <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>,
00843                                  <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>,
00844                                  IoAddress,
00845                                  &amp;AddressSpace,
00846                                  &amp;TranslatedAddress ) ){
00847         m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00848         <span class="keywordflow">goto</span> SendWriteIoSpaceResponse;
00849     }
00850 
00851     <span class="comment">//</span>
00852     <span class="comment">// N.B. - for the moment we will only support QVAs ie. when AddressSpace</span>
00853     <span class="comment">//        is one.  It may be in later systems that we will have to</span>
00854     <span class="comment">//        check the address space, map it, perform the virtual read</span>
00855     <span class="comment">//        unmap, and then return the data - only we will have to be</span>
00856     <span class="comment">//        careful about what Irql we are to make sure the memory mgmt</span>
00857     <span class="comment">//        stuff will all work</span>
00858     <span class="comment">//</span>
00859 
00860     <span class="keywordflow">if</span>( !AddressSpace ){
00861         m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00862         <span class="keywordflow">goto</span> SendWriteIoSpaceResponse;
00863     }
00864 
00865     <span class="comment">//</span>
00866     <span class="comment">// Do the IO space read using the appropriate HAL routines based upon</span>
00867     <span class="comment">// the default address space (io) and the data size requested.</span>
00868     <span class="comment">//</span>
00869 
00870     <span class="keywordflow">switch</span>( DataSize ){
00871 
00872     <span class="keywordflow">case</span> 1:
00873         WRITE_PORT_UCHAR( (PUCHAR)TranslatedAddress.QuadPart, (UCHAR)Value );
00874         <span class="keywordflow">break</span>;
00875 
00876     <span class="keywordflow">case</span> 2:
00877         WRITE_PORT_USHORT( (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)TranslatedAddress.QuadPart, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Value );
00878         <span class="keywordflow">break</span>;
00879 
00880     <span class="keywordflow">case</span> 4:
00881         WRITE_PORT_ULONG( (PULONG)TranslatedAddress.QuadPart, Value );
00882         <span class="keywordflow">break</span>;
00883 
00884     <span class="keywordflow">default</span>:
00885         m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00886     }
00887 
00888 
00889 SendWriteIoSpaceResponse:
00890 
00891     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
00892         PACKET_TYPE_KD_STATE_MANIPULATE,
00893         &amp;MessageHeader,
00894         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00895         );
00896 }
00897 
00898 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00899"></a><a class="code" href="../../d7/d7/4_2axp64_2kdpcpu_8h.html#a11">00899</a> <a class="code" href="../../d7/d7/4_2axp64_2kdpcpu_8h.html#a11">KdpWriteIoSpaceExtended</a> (
00900     IN PDBGKD_MANIPULATE_STATE m,
00901     IN PSTRING AdditionalData,
00902     IN PCONTEXT Context
00903     )
00904 
00905 <span class="comment">/*++</span>
00906 <span class="comment"></span>
00907 <span class="comment">Routine Description:</span>
00908 <span class="comment"></span>
00909 <span class="comment">    This function is called in response of a read io space extended state</span>
00910 <span class="comment">    manipulation message.  Its function is to read system io</span>
00911 <span class="comment">    locations.</span>
00912 <span class="comment"></span>
00913 <span class="comment">Arguments:</span>
00914 <span class="comment"></span>
00915 <span class="comment">    m - Supplies the state manipulation message.</span>
00916 <span class="comment"></span>
00917 <span class="comment">    AdditionalData - Supplies any additional data for the message.</span>
00918 <span class="comment"></span>
00919 <span class="comment">    Context - Supplies the current context.</span>
00920 <span class="comment"></span>
00921 <span class="comment">Return Value:</span>
00922 <span class="comment"></span>
00923 <span class="comment">    None.</span>
00924 <span class="comment"></span>
00925 <span class="comment">--*/</span>
00926 
00927 {
00928     PDBGKD_READ_WRITE_IO_EXTENDED a = &amp;m-&gt;u.ReadWriteIoExtended;
00929     ULONG Length;
00930     STRING MessageHeader;
00931     PUCHAR b;
00932     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a> s;
00933     PULONG l;
00934     ULONG <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>;
00935     ULONG AddressSpace;
00936     ULONG SavedAddressSpace;
00937     PHYSICAL_ADDRESS IoAddress;
00938     ULONG DataSize;
00939     PHYSICAL_ADDRESS TranslatedAddress;
00940     INTERFACE_TYPE <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>;
00941     ULONG Value;
00942 
00943     MessageHeader.Length = <span class="keyword">sizeof</span>(*m);
00944     MessageHeader.Buffer = (PCHAR)m;
00945 
00946     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(AdditionalData-&gt;Length == 0);
00947 
00948     m-&gt;ReturnStatus = STATUS_SUCCESS;
00949 
00950     <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> = a-&gt;InterfaceType;
00951     <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> = a-&gt;BusNumber;
00952     AddressSpace = SavedAddressSpace = a-&gt;AddressSpace;
00953     IoAddress.QuadPart = (ULONG_PTR)a-&gt;IoAddress;
00954     DataSize = a-&gt;DataSize;
00955     Value = a-&gt;DataValue;
00956 
00957     <span class="comment">//</span>
00958     <span class="comment">// Translate the bus address to the physical system address</span>
00959     <span class="comment">// or QVA.</span>
00960     <span class="comment">//</span>
00961 
00962     <span class="keywordflow">if</span>( !<a class="code" href="../../d2/d7/hal_8h.html#a184">HalTranslateBusAddress</a>( <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>,
00963                                  <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>,
00964                                  IoAddress,
00965                                  &amp;AddressSpace,
00966                                  &amp;TranslatedAddress ) ){
00967         m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00968         <span class="keywordflow">goto</span> SendWriteIoSpaceExtendedResponse;
00969     }
00970 
00971     <span class="comment">//</span>
00972     <span class="comment">// N.B. - for the moment we will only support QVAs ie. when AddressSpace</span>
00973     <span class="comment">//        is one.  It may be in later systems that we will have to</span>
00974     <span class="comment">//        check the address space, map it, perform the virtual read</span>
00975     <span class="comment">//        unmap, and then return the data - only we will have to be</span>
00976     <span class="comment">//        careful about what Irql we are to make sure the memory mgmt</span>
00977     <span class="comment">//        stuff will all work</span>
00978     <span class="comment">//</span>
00979 
00980     <span class="keywordflow">if</span>( !AddressSpace ){
00981         m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
00982         <span class="keywordflow">goto</span> SendWriteIoSpaceExtendedResponse;
00983     }
00984 
00985     <span class="comment">//</span>
00986     <span class="comment">// Do the IO space read using the appropriate HAL routines based upon</span>
00987     <span class="comment">// the original address space and the data size requested.</span>
00988     <span class="comment">//</span>
00989 
00990     <span class="keywordflow">if</span>( !SavedAddressSpace ){
00991 
00992         <span class="comment">//</span>
00993         <span class="comment">// Memory (buffer) space on the bus</span>
00994         <span class="comment">//</span>
00995 
00996         <span class="keywordflow">switch</span>( DataSize ){
00997 
00998         <span class="keywordflow">case</span> 1:
00999             WRITE_REGISTER_UCHAR( (PUCHAR)TranslatedAddress.QuadPart, (UCHAR)Value );
01000             <span class="keywordflow">break</span>;
01001 
01002         <span class="keywordflow">case</span> 2:
01003             WRITE_REGISTER_USHORT( (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)TranslatedAddress.QuadPart, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Value );
01004             <span class="keywordflow">break</span>;
01005 
01006         <span class="keywordflow">case</span> 4:
01007             WRITE_REGISTER_ULONG( (PULONG)TranslatedAddress.QuadPart, Value );
01008             <span class="keywordflow">break</span>;
01009 
01010         <span class="keywordflow">default</span>:
01011             m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
01012         }
01013 
01014     } <span class="keywordflow">else</span> {
01015 
01016         <span class="comment">//</span>
01017         <span class="comment">// I/O space on the bus</span>
01018         <span class="comment">//</span>
01019 
01020         <span class="keywordflow">switch</span>( DataSize ){
01021 
01022         <span class="keywordflow">case</span> 1:
01023             WRITE_PORT_UCHAR( (PUCHAR)TranslatedAddress.QuadPart, (UCHAR)Value );
01024             <span class="keywordflow">break</span>;
01025 
01026         <span class="keywordflow">case</span> 2:
01027             WRITE_PORT_USHORT( (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)TranslatedAddress.QuadPart, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Value);
01028             <span class="keywordflow">break</span>;
01029 
01030         <span class="keywordflow">case</span> 4:
01031             WRITE_PORT_ULONG( (PULONG)TranslatedAddress.QuadPart, Value );
01032             <span class="keywordflow">break</span>;
01033 
01034         <span class="keywordflow">default</span>:
01035             m-&gt;ReturnStatus = STATUS_INVALID_PARAMETER;
01036         }
01037     }
01038 
01039 
01040 
01041 SendWriteIoSpaceExtendedResponse:
01042 
01043     <a class="code" href="../../d1/d7/4_2kdp_8h.html#a116">KdpSendPacket</a>(
01044         PACKET_TYPE_KD_STATE_MANIPULATE,
01045         &amp;MessageHeader,
01046         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01047         );
01048 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:34 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
