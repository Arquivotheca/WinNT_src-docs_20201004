<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: debug.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>debug.c</h1><a href="../../d1/d5/w32_2ntuser_2kernel_2debug_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: debug.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains random debugging related functions.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 17-May-1991 DarrinM   Created.</span>
00010 <span class="comment">* 22-Jan-1992 IanJa     ANSI/Unicode neutral (all debug output is ANSI)</span>
00011 <span class="comment">\***************************************************************************/</span>
00012 
00013 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00014 <span class="preprocessor">#pragma hdrstop</span>
00015 <span class="preprocessor"></span>
00016 <span class="comment">/*</span>
00017 <span class="comment"> * Include stuff necessary to send a datagram to winsrv.</span>
00018 <span class="comment"> */</span>
00019 <span class="preprocessor">#include "ntcsrmsg.h"</span>
00020 <span class="preprocessor">#include "<a class="code" href="../../d2/d0/csrmsg_8h.html">csrmsg.h</a>"</span>
00021 
00022 <span class="comment">/**************************************************************************\</span>
00023 <span class="comment">* ActivateDebugger</span>
00024 <span class="comment">*</span>
00025 <span class="comment">* Force an exception on the active application's context so it will break</span>
00026 <span class="comment">* into the debugger.</span>
00027 <span class="comment">*</span>
00028 <span class="comment">* History:</span>
00029 <span class="comment">* 05-10-91 DarrinM      Created.</span>
00030 <span class="comment">\***************************************************************************/</span>
00031 
<a name="l00032"></a><a class="code" href="../../d4/d1/userk_8h.html#a1146">00032</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1146">xxxActivateDebugger</a>(
00033     UINT fsModifiers)
00034 {
00035     ULONG ArgLength;
00036     <a class="code" href="../../d3/d4/struct__USER__API__MSG.html">USER_API_MSG</a> m;
00037     <a class="code" href="../../d6/d5/struct__ACTIVATEDEBUGGERMSG.html">PACTIVATEDEBUGGERMSG</a> a = &amp;m.<a class="code" href="../../d3/d4/struct__USER__API__MSG.html#o15">u</a>.ActivateDebugger;
00038     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00039     HANDLE hDebugPort;
00040     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00041     <span class="keywordflow">if</span> (fsModifiers &amp; MOD_CONTROL) {
00042 <span class="preprocessor">#if DBG</span>
00043 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (RipOutput(0, RIP_WARNING, <span class="stringliteral">"User debugger"</span>, 0, <span class="stringliteral">"Debug prompt"</span>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00044             DbgBreakPoint();
00045         }
00046 <span class="preprocessor">#endif</span>
00047 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00048     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fsModifiers &amp; MOD_SHIFT) {
00049 
00050         <span class="comment">/*</span>
00051 <span class="comment">         * Bail out if the process is not being debugged.</span>
00052 <span class="comment">         */</span>
00053         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a>-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o18">DebugPort</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00054             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00055 
00056         a-&gt;<a class="code" href="../../d6/d5/struct__ACTIVATEDEBUGGERMSG.html#o0">ClientId</a>.UniqueProcess = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a>-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a>;
00057     } <span class="keywordflow">else</span> {
00058 
00059         <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o5">ptiKeyboard</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))
00060             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00061 
00062         a-&gt;<a class="code" href="../../d6/d5/struct__ACTIVATEDEBUGGERMSG.html#o0">ClientId</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o5">ptiKeyboard</a>-&gt;pEThread-&gt;Cid;
00063 
00064         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00065         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1258">LockProcessByClientId</a>(a-&gt;<a class="code" href="../../d6/d5/struct__ACTIVATEDEBUGGERMSG.html#o0">ClientId</a>.UniqueProcess, &amp;Process);
00066         <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00067 
00068         <span class="comment">/*</span>
00069 <span class="comment">         * Bail out if the process is not being debugged or the process id</span>
00070 <span class="comment">         * is invalid.</span>
00071 <span class="comment">         */</span>
00072         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00073             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00074         
00075         hDebugPort = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o18">DebugPort</a>;
00076         <a class="code" href="../../d4/d1/userk_8h.html#a517">UnlockProcess</a>(Process);
00077 
00078         <span class="keywordflow">if</span> (hDebugPort == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00079             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00080     }
00081 
00082     <span class="comment">/*</span>
00083 <span class="comment">     * Send the datagram to CSR</span>
00084 <span class="comment">     */</span>
00085     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a243">CsrApiPort</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00086         ArgLength = <span class="keyword">sizeof</span>(*a);
00087         ArgLength |= (ArgLength &lt;&lt; 16);
00088         ArgLength +=     ((<span class="keyword">sizeof</span>( CSR_API_MSG ) - <span class="keyword">sizeof</span>( m.<a class="code" href="../../d3/d4/struct__USER__API__MSG.html#o15">u</a> )) &lt;&lt; 16) |
00089                         (FIELD_OFFSET( CSR_API_MSG, u ) - <span class="keyword">sizeof</span>( m.<a class="code" href="../../d3/d4/struct__USER__API__MSG.html#o0">h</a> ));
00090         m.<a class="code" href="../../d3/d4/struct__USER__API__MSG.html#o0">h</a>.u1.Length = ArgLength;
00091         m.<a class="code" href="../../d3/d4/struct__USER__API__MSG.html#o0">h</a>.u2.ZeroInit = 0;
00092         m.<a class="code" href="../../d3/d4/struct__USER__API__MSG.html#o1">CaptureBuffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00093         m.<a class="code" href="../../d3/d4/struct__USER__API__MSG.html#o2">ApiNumber</a> = CSR_MAKE_API_NUMBER( USERSRV_SERVERDLL_INDEX,
00094                                            <a class="code" href="../../d2/d0/csrmsg_8h.html#a35a28">UserpActivateDebugger</a>);
00095         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00096         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/lpcsend_8c.html#a2">LpcRequestPort</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a243">CsrApiPort</a>, (PPORT_MESSAGE)&amp;m);
00097         <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00098         UserAssert(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00099     }
00100 
00101     <span class="comment">/*</span>
00102 <span class="comment">     * Don't eat this event unless we are breaking into CSR! Since we have</span>
00103 <span class="comment">     * choosen an arbitrary hot key like F12 for the debug key, we need to</span>
00104 <span class="comment">     * pass on the key to the application, or apps that want this key would</span>
00105 <span class="comment">     * never see it. If we had an api for installing a debug hot key</span>
00106 <span class="comment">     * (export or MOD_DEBUG flag to RegisterHotKey()), then it would be ok</span>
00107 <span class="comment">     * to eat because the user selected the hot key. But it is not ok to</span>
00108 <span class="comment">     * eat it as long as we've picked an arbitrary hot key. scottlu.</span>
00109 <span class="comment">     */</span>
00110     <span class="keywordflow">if</span> (fsModifiers &amp; MOD_SHIFT)
00111         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00112     <span class="keywordflow">else</span>
00113         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00114 }
00115 
<a name="l00116"></a><a class="code" href="../../d1/d5/w32_2ntuser_2kernel_2debug_8c.html#a1">00116</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a55">GetRipComponent</a>(VOID) { <span class="keywordflow">return</span> RIP_USERKRNL; }
00117 
<a name="l00118"></a><a class="code" href="../../d1/d5/w32_2ntuser_2kernel_2debug_8c.html#a2">00118</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a56">GetDbgTagFlags</a>(<span class="keywordtype">int</span> tag)
00119 {
00120 <span class="preprocessor">#if DEBUGTAGS</span>
00121 <span class="preprocessor"></span>    <span class="keywordflow">return</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ? <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;adwDBGTAGFlags[tag] : 0);
00122 <span class="preprocessor">#else</span>
00123 <span class="preprocessor"></span>    <span class="keywordflow">return</span> 0;
00124     UNREFERENCED_PARAMETER(tag);
00125 <span class="preprocessor">#endif // DEBUGTAGS</span>
00126 <span class="preprocessor"></span>}
00127 
<a name="l00128"></a><a class="code" href="../../d1/d5/w32_2ntuser_2kernel_2debug_8c.html#a3">00128</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a57">GetRipPID</a>(VOID) { <span class="keywordflow">return</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ? <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o2">wRIPPID</a> : 0); }
<a name="l00129"></a><a class="code" href="../../d1/d5/w32_2ntuser_2kernel_2debug_8c.html#a4">00129</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a58">GetRipFlags</a>(VOID) { <span class="keywordflow">return</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ? <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o0">wRIPFlags</a> : <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a393">RIPF_DEFAULT</a>); }
00130 
<a name="l00131"></a><a class="code" href="../../d1/d5/w32_2ntuser_2kernel_2debug_8c.html#a5">00131</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a59">SetRipFlags</a>(DWORD dwRipFlags, DWORD dwRipPID)
00132 {
00133     <a class="code" href="../../d4/d1/userk_8h.html#a1015">_SetRipFlags</a>(dwRipFlags, dwRipPID);
00134 }
00135 
<a name="l00136"></a><a class="code" href="../../d1/d5/w32_2ntuser_2kernel_2debug_8c.html#a6">00136</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d0/d7/server_2server_8c.html#a60">SetDbgTag</a>(<span class="keywordtype">int</span> tag, DWORD dwBitFlags)
00137 {
00138     <a class="code" href="../../d4/d1/userk_8h.html#a1016">_SetDbgTag</a>(tag, dwBitFlags);
00139 }
00140 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:39 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
