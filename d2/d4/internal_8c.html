<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: internal.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>internal.c File Reference</h1><code>#include "<a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>"</code><br>
<code>#include &lt;ioevent.h&gt;</code><br>

<p>
<a href="../../d3/d3/internal_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d2/struct__TRACKING__BUFFER.html">_TRACKING_BUFFER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d3/struct__REMOTE__LINK__BUFFER.html">_REMOTE_LINK_BUFFER</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a0">IsFileLocal</a>(FileObject)&nbsp;&nbsp;&nbsp;( !((FileObject)-&gt;DeviceObject-&gt;Characteristics &amp; FILE_REMOTE_DEVICE) )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a1">GET_OFFSET_LENGTH</a>(CurrentSid, SidBase)&nbsp;&nbsp;&nbsp;( (ULONG) ((PCHAR) CurrentSid - (PCHAR) SidBase) )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a2">SynchronousIo</a>(<a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, FileObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a3">MEMORY_BARRIER</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a4">MESSAGE_SIZE</a></td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef LINK_TRACKING_INFORMATION&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a5">FILE_VOLUMEID_WITH_TYPE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef LINK_TRACKING_INFORMATION *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a6">PFILE_VOLUMEID_WITH_TYPE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d1/d2/struct__TRACKING__BUFFER.html">_TRACKING_BUFFER</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a7">TRACKING_BUFFER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d1/d2/struct__TRACKING__BUFFER.html">_TRACKING_BUFFER</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a8">PTRACKING_BUFFER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d3/struct__REMOTE__LINK__BUFFER.html">_REMOTE_LINK_BUFFER</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a9">REMOTE_LINK_BUFFER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d3/struct__REMOTE__LINK__BUFFER.html">_REMOTE_LINK_BUFFER</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a10">PREMOTE_LINK_BUFFER</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a13">IopResurrectDriver</a> (<a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a14">IopUserRundown</a> (IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a15">IopMarshalIds</a> (OUT <a class="el" href="../../d1/d2/struct__TRACKING__BUFFER.html">PTRACKING_BUFFER</a> TrackingBuffer, IN <a class="el" href="../../d2/d4/internal_8c.html#a6">PFILE_VOLUMEID_WITH_TYPE</a> TargetVolumeId, IN PFILE_OBJECTID_BUFFER TargetObjectId, IN PFILE_TRACKING_INFORMATION TrackingInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a16">IopUnMarshalIds</a> (IN FILE_TRACKING_INFORMATION *TrackingInformation, OUT <a class="el" href="../../d2/d4/internal_8c.html#a5">FILE_VOLUMEID_WITH_TYPE</a> *TargetVolumeId, OUT GUID *TargetObjectId, OUT GUID *TargetMachineId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a17">IopBootLogToFile</a> (PUNICODE_STRING <a class="el" href="../../d0/d0/tdetach_8c.html#a0">String</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a18">IopCopyBootLogRegistryToFile</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a19">IopAbortRequest</a> (IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a20">IopAcquireFileObjectLock</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> RequestorMode, IN BOOLEAN Alertable, OUT PBOOLEAN Interrupted)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a21">IopAllocateIrpCleanup</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> EventObject OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a22">IopAllocateIrpMustSucceed</a> (IN CCHAR StackSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a23">IopApcHardError</a> (IN PVOID StartContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a24">IopCancelAlertedRequest</a> (IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> Event, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a25">IopCheckGetQuotaBufferValidity</a> (IN PFILE_GET_QUOTA_INFORMATION QuotaBuffer, IN ULONG QuotaLength, OUT PULONG_PTR ErrorOffset)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a26">IopCompleteUnloadOrDelete</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN KIRQL Irql)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a27">IopCompletePageWrite</a> (IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *NormalRoutine, IN PVOID *NormalContext, IN PVOID *SystemArgument1, IN PVOID *SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a28">IopCompleteRequest</a> (IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *NormalRoutine, IN PVOID *NormalContext, IN PVOID *SystemArgument1, IN PVOID *SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a29">IopConnectLinkTrackingPort</a> (IN PVOID Parameter)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a30">IopDisassociateThreadIrp</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a31">IopDeallocateApc</a> (IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *NormalRoutine, IN PVOID *NormalContext, IN PVOID *SystemArgument1, IN PVOID *SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a32">IopDropIrp</a> (IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a33">IopExceptionFilter</a> (IN PEXCEPTION_POINTERS ExceptionPointer, OUT PNTSTATUS ExceptionCode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a34">IopExceptionCleanup</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> EventObject OPTIONAL, IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> KernelEvent OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a35">IopFreeIrpAndMdls</a> (IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a36">IopGetDriverNameFromKeyNode</a> (IN HANDLE KeyHandle, OUT PUNICODE_STRING DriverName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a37">IopGetFileName</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN ULONG Length, OUT PVOID FileInformation, OUT PULONG ReturnedLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a38">IopGetMountFlag</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a39">IopGetRegistryKeyInformation</a> (IN HANDLE KeyHandle, OUT PKEY_FULL_INFORMATION *Information)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a40">IopGetRegistryValue</a> (IN HANDLE KeyHandle, IN PWSTR <a class="el" href="../../d8/d2/rtrenval_8c.html#a3">ValueName</a>, OUT PKEY_VALUE_FULL_INFORMATION *Information)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a41">IopGetRegistryValues</a> (IN HANDLE KeyHandle, IN PKEY_VALUE_FULL_INFORMATION *ValueList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a42">IopGetSetObjectId</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN OUT PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN ULONG Length, IN ULONG Function)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a43">IopGetVolumeId</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN OUT <a class="el" href="../../d2/d4/internal_8c.html#a6">PFILE_VOLUMEID_WITH_TYPE</a> ObjectId, IN ULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a44">IopHardErrorThread</a> (IN PVOID StartContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a45">IopInvalidDeviceRequest</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a46">IopIsSameMachine</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> SourceFile, IN HANDLE TargetFile)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a47">IopLoadDriver</a> (IN HANDLE KeyHandle, IN BOOLEAN CheckForSafeBoot)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a48">IopGetDeviceAttachmentBase</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a49">IopGetDeviceAttachmentBaseRef</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a50">IopDecrementDeviceObjectRef</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN BOOLEAN AlwaysUnload)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a51">IopLoadFileSystemDriver</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a52">IopLoadUnloadDriver</a> (IN PVOID Parameter)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a53">IopMountVolume</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN BOOLEAN AllowRawMount, IN BOOLEAN DeviceLockAlreadyHeld, IN BOOLEAN Alertable)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a54">IopInvalidateVolumesForDevice</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a55">IopNotifyPnpWhenChainDereferenced</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *PhysicalDeviceObjects, IN ULONG DeviceObjectCount, IN BOOLEAN Query, OUT <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *VetoingDevice)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a56">IopOpenLinkOrRenameTarget</a> (OUT PHANDLE TargetHandle, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN PVOID RenameBuffer, IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a57">IopOpenRegistryKey</a> (OUT PHANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN HANDLE BaseHandle OPTIONAL, IN PUNICODE_STRING <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>, IN ACCESS_MASK DesiredAccess, IN BOOLEAN Create)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a58">IopQueryXxxInformation</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN ULONG InformationClass, IN ULONG Length, OUT PVOID Information, OUT PULONG ReturnedLength, IN BOOLEAN FileInformation)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a59">IopRaiseHardError</a> (IN PVOID NormalContext, IN PVOID SystemArgument1, IN PVOID SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a60">IopRaiseInformationalHardError</a> (IN PVOID NormalContext, IN PVOID SystemArgument1, IN PVOID SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a61">IopReadyDeviceObjects</a> (IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a62">IopSendMessageToTrackService</a> (IN <a class="el" href="../../d2/d4/internal_8c.html#a6">PFILE_VOLUMEID_WITH_TYPE</a> SourceVolumeId, IN PFILE_OBJECTID_BUFFER SourceObjectId, IN PFILE_TRACKING_INFORMATION TargetObjectInformation)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a63">IopSetEaOrQuotaInformationFile</a> (IN HANDLE FileHandle, OUT PIO_STATUS_BLOCK IoStatusBlock, IN PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN ULONG Length, IN BOOLEAN SetEa)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a64">IopSetRemoteLink</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> DestinationFileObject OPTIONAL, IN PFILE_TRACKING_INFORMATION FileInformation OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a65">IopStartApcHardError</a> (IN PVOID StartContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a66">IopSynchronousApiServiceTail</a> (IN NTSTATUS ReturnedStatus, IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> Event, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> RequestorMode, IN PIO_STATUS_BLOCK LocalIoStatus, OUT PIO_STATUS_BLOCK IoStatusBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a67">IopSynchronousServiceTail</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN BOOLEAN DeferredIoCompletion, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> RequestorMode, IN BOOLEAN SynchronousIo, IN <a class="el" href="../../d0/d6/iop_8h.html#a25">TRANSFER_TYPE</a> TransferType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a68">IopTimerDispatch</a> (IN <a class="el" href="../../d1/d6/struct__KDPC.html">PKDPC</a> Dpc, IN PVOID DeferredContext, IN PVOID SystemArgument1, IN PVOID SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a69">IopTrackLink</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN OUT PIO_STATUS_BLOCK IoStatusBlock, IN PFILE_TRACKING_INFORMATION FileInformation, IN ULONG Length, IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> Event, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> RequestorMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a70">IopUserCompletion</a> (IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *NormalRoutine, IN PVOID *NormalContext, IN PVOID *SystemArgument1, IN PVOID *SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a71">IopXxxControlFile</a> (IN HANDLE FileHandle, IN HANDLE Event OPTIONAL, IN PIO_APC_ROUTINE ApcRoutine OPTIONAL, IN PVOID ApcContext OPTIONAL, OUT PIO_STATUS_BLOCK IoStatusBlock, IN ULONG IoControlCode, IN PVOID InputBuffer OPTIONAL, IN ULONG InputBufferLength, OUT PVOID OutputBuffer OPTIONAL, IN ULONG OutputBufferLength, IN BOOLEAN DeviceIoControl)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a72">IopLookupBusStringFromID</a> (IN HANDLE KeyHandle, IN INTERFACE_TYPE <a class="el" href="../../d6/d0/cmdat_8c.html#a4">InterfaceType</a>, OUT PWCHAR <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN ULONG Length, OUT PULONG BusFlags OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a73">IopSafebootDriverLoad</a> (PUNICODE_STRING DriverId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a74">IopInitializeBootLogging</a> (<a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock, PCHAR HeaderString)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a75">IopBootLog</a> (PUNICODE_STRING LogEntry, BOOLEAN Loaded)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a11">IopDeadIrp</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d4/struct__BOOT__LOG__RECORD.html">PBOOT_LOG_RECORD</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/internal_8c.html#a12">BootLogRecord</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a1" doxytag="internal.c::GET_OFFSET_LENGTH" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define GET_OFFSET_LENGTH          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">CurrentSid,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>SidBase&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;( (ULONG) ((PCHAR) CurrentSid - (PCHAR) SidBase) )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02392">IoCheckEaBufferValidity()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02874">IoCheckQuotaBufferValidity()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00524">IopCheckGetQuotaBufferValidity()</a>, and <a class="el" href="../../d8/d1/qsea_8c-source.html#l00035">NtQueryEaFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="internal.c::IsFileLocal" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IsFileLocal          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">FileObject&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;( !((FileObject)-&gt;DeviceObject-&gt;Characteristics &amp; FILE_REMOTE_DEVICE) )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l00042">42</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l07272">IopTrackLink()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="internal.c::MEMORY_BARRIER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MEMORY_BARRIER          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l01019">IopCompleteRequest()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="internal.c::MESSAGE_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MESSAGE_SIZE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>( (2 * <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d4/internal_8c.html#a5">FILE_VOLUMEID_WITH_TYPE</a> )) + \
                            <span class="keyword">sizeof</span>( FILE_OBJECTID_BUFFER ) +              \
                            <span class="keyword">sizeof</span>( GUID ) + \
                            <span class="keyword">sizeof</span>( <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> ) + \
                            <span class="keyword">sizeof</span>( ULONG ) )
</div></pre>
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l01506">IopConnectLinkTrackingPort()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="internal.c::SynchronousIo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SynchronousIo          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>FileObject&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(  \
    (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a>) ||   \
    (FileObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ? 0 : FileObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>) )
</div></pre>
<p>
Referenced by <a class="el" href="../../d1/d7/dir_8c-source.html#l00057">BuildQueryDirectoryIrp()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l01019">IopCompleteRequest()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l07030">IopSynchronousServiceTail()</a>, and <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a5" doxytag="internal.c::FILE_VOLUMEID_WITH_TYPE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef LINK_TRACKING_INFORMATION <a class="el" href="../../d2/d4/internal_8c.html#a5">FILE_VOLUMEID_WITH_TYPE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l00044">44</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l06127">IopSendMessageToTrackService()</a>, and <a class="el" href="../../d3/d3/internal_8c-source.html#l07272">IopTrackLink()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="internal.c::PFILE_VOLUMEID_WITH_TYPE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef LINK_TRACKING_INFORMATION * <a class="el" href="../../d2/d4/internal_8c.html#a6">PFILE_VOLUMEID_WITH_TYPE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l00044">44</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="internal.c::PREMOTE_LINK_BUFFER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d3/struct__REMOTE__LINK__BUFFER.html">_REMOTE_LINK_BUFFER</a> * <a class="el" href="../../d8/d3/struct__REMOTE__LINK__BUFFER.html">PREMOTE_LINK_BUFFER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="internal.c::PTRACKING_BUFFER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d1/d2/struct__TRACKING__BUFFER.html">_TRACKING_BUFFER</a> * <a class="el" href="../../d1/d2/struct__TRACKING__BUFFER.html">PTRACKING_BUFFER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="internal.c::REMOTE_LINK_BUFFER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d3/struct__REMOTE__LINK__BUFFER.html">_REMOTE_LINK_BUFFER</a>  <a class="el" href="../../d8/d3/struct__REMOTE__LINK__BUFFER.html">REMOTE_LINK_BUFFER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="internal.c::TRACKING_BUFFER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d1/d2/struct__TRACKING__BUFFER.html">_TRACKING_BUFFER</a>  <a class="el" href="../../d1/d2/struct__TRACKING__BUFFER.html">TRACKING_BUFFER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a19" doxytag="internal.c::IopAbortRequest" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopAbortRequest           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Apc</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l00144">144</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d3/d3/internal_8c-source.html#l01019">IopCompleteRequest()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08769">IoRaiseHardError()</a>.
<p>
<pre class="fragment"><div>00150                    :
00151 
00152     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to abort an I/O request.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked during <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00153     rundown of a thread.
00154 
00155 Arguments:
00156 
00157     Apc - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel APC structure.  This structure <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> contained
00158         within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet (<a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>) itself.
00159 
00160 Return Value:
00161 
00162     None.
00163 
00164 --*/
00165 
00166 {
00167     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00168 
00169     <span class="comment">//</span>
00170     <span class="comment">// Invoke the normal special kernel APC routine.</span>
00171     <span class="comment">//</span>
00172 
00173     <a class="code" href="../../d0/d6/iop_8h.html#a157">IopCompleteRequest</a>( Apc,
00174                         &amp;Apc-&gt;NormalRoutine,
00175                         &amp;Apc-&gt;NormalContext,
00176                         &amp;Apc-&gt;SystemArgument1,
00177                         &amp;Apc-&gt;SystemArgument2 );
00178 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="internal.c::IopAcquireFileObjectLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopAcquireFileObjectLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RequestorMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Alertable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Interrupted</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l00181">181</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00595">IopAcquireFastLock</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/dir_8c-source.html#l00057">BuildQueryDirectoryIrp()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00036">IopCloseFile()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00417">IopDeleteFile()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00975">IopGetSetSecurityObject()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05397">IopQueryXxxInformation()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06326">IopSetEaOrQuotaInformationFile()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l08084">IopXxxControlFile()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09835">IoSetInformation()</a>, <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00386">NtFlushBuffersFile()</a>, <a class="el" href="../../d2/d4/lock_8c-source.html#l00035">NtLockFile()</a>, <a class="el" href="../../d1/d7/dir_8c-source.html#l00821">NtNotifyChangeDirectoryFile()</a>, <a class="el" href="../../d8/d1/qsea_8c-source.html#l00035">NtQueryEaFile()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00101">NtQueryInformationFile()</a>, <a class="el" href="../../d1/d2/qsquota_8c-source.html#l00035">NtQueryQuotaInformationFile()</a>, <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00037">NtQueryVolumeInformationFile()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00036">NtReadFile()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00730">NtReadFileScatter()</a>, <a class="el" href="../../d8/d1/qsea_8c-source.html#l00652">NtSetEaFile()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00849">NtSetInformationFile()</a>, <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00492">NtSetVolumeInformationFile()</a>, <a class="el" href="../../d2/d4/lock_8c-source.html#l00458">NtUnlockFile()</a>, <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00035">NtWriteFile()</a>, and <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00801">NtWriteFileGather()</a>.
<p>
<pre class="fragment"><div>00190                    :
00191 
00192     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to acquire <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock <span class="keywordflow">for</span> a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object whenever
00193     there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> contention and obtaining <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fast lock <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> failed.
00194 
00195 Arguments:
00196 
00197     FileObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object whose lock <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be acquired.
00198 
00199     RequestorMode - Processor access mode of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
00200 
00201     Alertable - Indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock should be obtained in an
00202         alertable manner.
00203 
00204     Interrupted - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> variable to receive a BOOLEAN that indicates whether or
00205         not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> attempt to acquire <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock was interrupted by an alert or
00206         an APC.
00207 
00208 Return Value:
00209 
00210     The function status <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
00211 
00212 --*/
00213 {
00214     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00215 
00216     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00217 
00218     <span class="comment">//</span>
00219     <span class="comment">// Assume that the function will not be interrupted by an alert or an</span>
00220     <span class="comment">// APC while attempting to acquire the lock.</span>
00221     <span class="comment">//</span>
00222 
00223     *Interrupted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00224 
00225     <span class="comment">//</span>
00226     <span class="comment">// Loop attempting to acquire the lock for the file object.</span>
00227     <span class="comment">//</span>
00228 
00229     InterlockedIncrement (&amp;FileObject-&gt;Waiters);
00230 
00231     <span class="keywordflow">for</span> (;;) {
00232         <span class="keywordflow">if</span> (!FileObject-&gt;Busy) {
00233 
00234             <span class="comment">//</span>
00235             <span class="comment">// The file object appears to be un-owned, try to acquire it</span>
00236             <span class="comment">//</span>
00237 
00238             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a13">IopAcquireFastLock</a> ( FileObject ) ) {
00239 
00240                 <span class="comment">//</span>
00241                 <span class="comment">// Object was acquired. Remove our count and return success</span>
00242                 <span class="comment">//</span>
00243 
00244                 InterlockedDecrement (&amp;FileObject-&gt;Waiters);
00245                 <span class="keywordflow">return</span> STATUS_SUCCESS;
00246             }
00247         }
00248 
00249         <span class="comment">//</span>
00250         <span class="comment">// Wait for the event that indicates that the thread that currently</span>
00251         <span class="comment">// owns the file object has released it.</span>
00252         <span class="comment">//</span>
00253 
00254         status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;FileObject-&gt;Lock,
00255                                         Executive,
00256                                         RequestorMode,
00257                                         Alertable,
00258                                         (PLARGE_INTEGER) NULL );
00259 
00260         <span class="comment">//</span>
00261         <span class="comment">// If the above wait was interrupted, then indicate so and return.</span>
00262         <span class="comment">// Before returning, however, check the state of the ownership of</span>
00263         <span class="comment">// the file object itself.  If it is not currently owned (the busy</span>
00264         <span class="comment">// flag is clear), then check to see whether or not there are any</span>
00265         <span class="comment">// other waiters.  If so, then set the event to the signaled state</span>
00266         <span class="comment">// again so that they wake up and check the state of the busy flag.</span>
00267         <span class="comment">//</span>
00268 
00269         <span class="keywordflow">if</span> (status == STATUS_USER_APC || status == STATUS_ALERTED) {
00270             InterlockedDecrement (&amp;FileObject-&gt;Waiters);
00271 
00272             <span class="keywordflow">if</span> (!FileObject-&gt;Busy  &amp;&amp;  FileObject-&gt;Waiters) {
00273                 <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;FileObject-&gt;Lock, 0, FALSE );
00274 
00275             }
00276             *Interrupted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00277             <span class="keywordflow">return</span> status;
00278         }
00279     }
00280 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="internal.c::IopAllocateIrpCleanup" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopAllocateIrpCleanup           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> EventObject&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l00284">284</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01491">FO_SYNCHRONOUS_IO</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l01157">IopReleaseFileObjectLock</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/dir_8c-source.html#l00057">BuildQueryDirectoryIrp()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02256">IopGetFileName()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00975">IopGetSetSecurityObject()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05397">IopQueryXxxInformation()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06326">IopSetEaOrQuotaInformationFile()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l08084">IopXxxControlFile()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09835">IoSetInformation()</a>, <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00386">NtFlushBuffersFile()</a>, <a class="el" href="../../d2/d4/lock_8c-source.html#l00035">NtLockFile()</a>, <a class="el" href="../../d1/d7/dir_8c-source.html#l00821">NtNotifyChangeDirectoryFile()</a>, <a class="el" href="../../d8/d1/qsea_8c-source.html#l00035">NtQueryEaFile()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00101">NtQueryInformationFile()</a>, <a class="el" href="../../d1/d2/qsquota_8c-source.html#l00035">NtQueryQuotaInformationFile()</a>, <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00037">NtQueryVolumeInformationFile()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00036">NtReadFile()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00730">NtReadFileScatter()</a>, <a class="el" href="../../d8/d1/qsea_8c-source.html#l00652">NtSetEaFile()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00849">NtSetInformationFile()</a>, <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00492">NtSetVolumeInformationFile()</a>, <a class="el" href="../../d2/d4/lock_8c-source.html#l00458">NtUnlockFile()</a>, <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00035">NtWriteFile()</a>, and <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00801">NtWriteFileGather()</a>.
<p>
<pre class="fragment"><div>00291                    :
00292 
00293     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked internally by those system services that attempt
00294     to allocate an <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> and fail.  This routine cleans up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object
00295     and any event object that has been references and releases any locks
00296     that were taken <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>.
00297 
00298 Arguments:
00299 
00300     FileObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object being worked on.
00301 
00302     EventObject - Optional pointer to a referenced event to be dereferenced.
00303 
00304 Return Value:
00305 
00306     None.
00307 
00308 --*/
00309 
00310 {
00311     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00312 
00313     <span class="comment">//</span>
00314     <span class="comment">// Begin by dereferencing the event, if one was specified.</span>
00315     <span class="comment">//</span>
00316 
00317     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( EventObject )) {
00318         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( EventObject );
00319     }
00320 
00321     <span class="comment">//</span>
00322     <span class="comment">// Release the synchronization semaphore if it is currently held and</span>
00323     <span class="comment">// dereference the file object.</span>
00324     <span class="comment">//</span>
00325 
00326     <span class="keywordflow">if</span> (FileObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>) {
00327         <a class="code" href="../../d0/d6/iop_8h.html#a22">IopReleaseFileObjectLock</a>( FileObject );
00328     }
00329 
00330     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( FileObject );
00331 
00332     <span class="keywordflow">return</span>;
00333 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="internal.c::IopAllocateIrpMustSucceed" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> IopAllocateIrpMustSucceed           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN CCHAR&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>StackSize</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l00336">336</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01680">_IRP::AllocationFlags</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00652">IoAllocateIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07444">IoInitializeIrp()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04269">IoSizeOfIrp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01575">IRP_ALLOCATED_MUST_SUCCEED</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12535">IoCancelFileOpen()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00036">IopCloseFile()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00417">IopDeleteFile()</a>, and <a class="el" href="../../d3/d3/internal_8c-source.html#l04282">IopMountVolume()</a>.
<p>
<pre class="fragment"><div>00342                    :
00343 
00344     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to allocate an <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> when there are no appropriate
00345     packets remaining on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> look-aside list, and no memory was available
00346     from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> general non-paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>, and yet, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> code <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> requiring <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00347     packet has no way of backing <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> and simply returning an error.  There-
00348     fore, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must allocate an <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>.  Hence, <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to allocate
00349     that packet.
00350 
00351 Arguments:
00352 
00353     StackSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> I/O stack locations that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00354         packet must have when allocated.
00355 
00356 Return Value:
00357 
00358     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet.
00359 
00360 --*/
00361 
00362 {
00363     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00364     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> packetSize;
00365 
00366     <span class="comment">//</span>
00367     <span class="comment">// Attempt to allocate the IRP normally and failing that, allocate the</span>
00368     <span class="comment">// IRP from nonpaged must succeed pool.</span>
00369     <span class="comment">//</span>
00370 
00371     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a17">IoAllocateIrp</a>(StackSize, FALSE);
00372     <span class="keywordflow">if</span> (!irp) {
00373         packetSize = <a class="code" href="../../d0/d5/io_8h.html#a245">IoSizeOfIrp</a>(StackSize);
00374         irp = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(NonPagedPoolMustSucceed, packetSize, ' prI');
00375         <a class="code" href="../../d4/d6/iosubs_8c.html#a80">IoInitializeIrp</a>(irp, packetSize, StackSize);
00376         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o17">AllocationFlags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a191">IRP_ALLOCATED_MUST_SUCCEED</a>;
00377     }
00378 
00379     <span class="keywordflow">return</span> irp;
00380 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="internal.c::IopApcHardError" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopApcHardError           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>StartContext</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l00383">383</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05617">IopRaiseHardError()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00120">_IOP_APC_HARD_ERROR_PACKET::Irp</a>, <a class="el" href="../../d0/d6/iop_8h.html#a34">PIOP_APC_HARD_ERROR_PACKET</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00122">_IOP_APC_HARD_ERROR_PACKET::RealDeviceObject</a>, and <a class="el" href="../../d1/d5/iop_8h-source.html#l00121">_IOP_APC_HARD_ERROR_PACKET::Vpb</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l06870">IopStartApcHardError()</a>.
<p>
<pre class="fragment"><div>00389                    :
00390 
00391     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked when we need to <span class="keywordflow">do</span> a hard error pop-up, but <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00392     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>'s originating thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> at APC level, ie. <a class="code" href="../../d0/d5/io_8h.html#a524">IoPageRead</a>.  We in a special
00393     purpose thread that will go away when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user responds to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pop-up.
00394 
00395 Arguments:
00396 
00397     StartContext - Startup context, contains a <a class="code" href="../../d5/d0/struct__IOP__APC__HARD__ERROR__PACKET.html">IOP_APC_HARD_ERROR_PACKET</a>.
00398 
00399 Return Value:
00400 
00401     None.
00402 
00403 --*/
00404 
00405 {
00406     <a class="code" href="../../d5/d0/struct__IOP__APC__HARD__ERROR__PACKET.html">PIOP_APC_HARD_ERROR_PACKET</a> packet;
00407 
00408     packet = StartContext;
00409 
00410     <a class="code" href="../../d0/d6/iop_8h.html#a205">IopRaiseHardError</a>( packet-&gt;<a class="code" href="../../d5/d0/struct__IOP__APC__HARD__ERROR__PACKET.html#o1">Irp</a>, packet-&gt;<a class="code" href="../../d5/d0/struct__IOP__APC__HARD__ERROR__PACKET.html#o2">Vpb</a>, packet-&gt;<a class="code" href="../../d5/d0/struct__IOP__APC__HARD__ERROR__PACKET.html#o3">RealDeviceObject</a> );
00411 
00412     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( packet );
00413 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a75" doxytag="internal.c::IopBootLog" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopBootLog           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>LogEntry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Loaded</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l09046">9046</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d3/d3/internal_8c-source.html#l08925">BootLogRecord</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00183">CmRegistryMachineSystemCurrentControlSetControlBootLog</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04650">_BOOT_LOG_RECORD::FileLogging</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l09284">IopBootLogToFile()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d8/d0/pnpioapi_8c.html#a67">IopSetRegistryStringValue()</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04644">_BOOT_LOG_RECORD::LoadedString</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04649">_BOOT_LOG_RECORD::NextKey</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04645">_BOOT_LOG_RECORD::NotLoadedString</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04648">_BOOT_LOG_RECORD::Resource</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01883">RtlAppendUnicodeStringToString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01763">RtlCopyUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01935">RtlCreateUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00130">Space</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00047">ValueName</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l02525">IopCallDriverAddDevice()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l08928">IopInitializeBootLogging()</a>, and <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>.
<p>
<pre class="fragment"><div>09052                    :
09053 
09054     <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> and write <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> a log entry.  Before <a class="code" href="../../d7/d7/ntapi_8c.html#a20">NtInitializeRegistry</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called, log entries are spooled
09055     into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry.  When NtInitalizeRegistry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> session manager, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
09056     log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> created <span class="keywordflow">if</span> necessary and truncated.  Log entries in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry are
09057     then copied into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry entries are deleted.
09058 
09059 Arguments:
09060 
09061     LogEntry - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a5">text</a> to log.
09062     Loaded - indicates whether to prepend <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="stringliteral">"Loaded"</span> string or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="stringliteral">"Not Loaded"</span> string.
09063 
09064 Return Value:
09065 
09066     <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
09067 
09068 
09069 --*/
09070 {
09071     WCHAR NameBuffer[BOOTLOG_STRSIZE];
09072     UNICODE_STRING <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
09073     UNICODE_STRING <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>;
09074     UNICODE_STRING CrLf;
09075     UNICODE_STRING <a class="code" href="../../d7/d0/cmdat2_8c.html#a32">Space</a>;
09076     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
09077 
09078     WCHAR MessageBuffer[BOOTLOG_STRSIZE];
09079     UNICODE_STRING MessageString = {
09080         0,
09081         BOOTLOG_STRSIZE,
09082         &amp;MessageBuffer[0]
09083     };
09084 
09085     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
09086 
09087     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4/internal_8c.html#a12">BootLogRecord</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09088         <span class="keywordflow">return</span>;
09089     }
09090 
09091     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;<a class="code" href="../../d2/d4/internal_8c.html#a12">BootLogRecord</a>-&gt;<a class="code" href="../../d6/d4/struct__BOOT__LOG__RECORD.html#o4">Resource</a>, TRUE);
09092 
09093     <span class="keywordflow">if</span> (Loaded) {
09094         <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>(&amp;MessageString, &amp;<a class="code" href="../../d2/d4/internal_8c.html#a12">BootLogRecord</a>-&gt;<a class="code" href="../../d6/d4/struct__BOOT__LOG__RECORD.html#o0">LoadedString</a>);
09095     } <span class="keywordflow">else</span> {
09096         <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>(&amp;MessageString, &amp;<a class="code" href="../../d2/d4/internal_8c.html#a12">BootLogRecord</a>-&gt;<a class="code" href="../../d6/d4/struct__BOOT__LOG__RECORD.html#o1">NotLoadedString</a>);
09097     }
09098 
09099     <span class="comment">// add a space after the message prefix</span>
09100 
09101     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Space, L<span class="stringliteral">" "</span>);
09102 
09103     <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(&amp;MessageString, &amp;Space);
09104 
09105     <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(&amp;MessageString, LogEntry);
09106 
09107     <span class="comment">// add a CR LF</span>
09108 
09109     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;CrLf, L<span class="stringliteral">"\r\n"</span>);
09110     <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(&amp;MessageString, &amp;CrLf);
09111 
09112     swprintf(NameBuffer, L<span class="stringliteral">"%d"</span>, <a class="code" href="../../d2/d4/internal_8c.html#a12">BootLogRecord</a>-&gt;<a class="code" href="../../d6/d4/struct__BOOT__LOG__RECORD.html#o5">NextKey</a>++);
09113 
09114     <a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(&amp;KeyName, NameBuffer);
09115     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;ValueName, L<span class="stringliteral">""</span>);
09116 
09117     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/internal_8c.html#a12">BootLogRecord</a>-&gt;<a class="code" href="../../d6/d4/struct__BOOT__LOG__RECORD.html#o6">FileLogging</a>) {
09118         HANDLE hLogKey, hBootKey;
09119 
09120         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a> (
09121             &amp;hBootKey,
09122             NULL,
09123             &amp;CmRegistryMachineSystemCurrentControlSetControlBootLog,
09124             KEY_ALL_ACCESS,
09125             TRUE
09126             );
09127 
09128         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
09129             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a> (
09130                 &amp;hLogKey,
09131                 hBootKey,
09132                 &amp;KeyName,
09133                 KEY_ALL_ACCESS,
09134                 TRUE
09135                 );
09136             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
09137                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a67">IopSetRegistryStringValue</a>(
09138                     hLogKey,
09139                     &amp;ValueName,
09140                     &amp;MessageString
09141                     );
09142                 ZwClose(hLogKey);
09143             }
09144             ZwClose(hBootKey);
09145         }
09146 
09147     } <span class="keywordflow">else</span> {
09148         <a class="code" href="../../d2/d4/internal_8c.html#a17">IopBootLogToFile</a>( &amp;MessageString );
09149     }
09150 
09151     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;KeyName);
09152 
09153     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d2/d4/internal_8c.html#a12">BootLogRecord</a>-&gt;<a class="code" href="../../d6/d4/struct__BOOT__LOG__RECORD.html#o4">Resource</a>);
09154 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="internal.c::IopBootLogToFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopBootLogToFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PUNICODE_STRING&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>String</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l09284">9284</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d3/d3/internal_8c-source.html#l08925">BootLogRecord</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04646">_BOOT_LOG_RECORD::LogFileName</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04648">_BOOT_LOG_RECORD::Resource</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d8/talloc_8c-source.html#l00027">String</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00418">ZwCreateFile()</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l09046">IopBootLog()</a>, and <a class="el" href="../../d3/d3/internal_8c-source.html#l09157">IopCopyBootLogRegistryToFile()</a>.
<p>
<pre class="fragment"><div>09289                    :
09290 
09291     Write <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
09292 
09293 Arguments:
09294 
09295     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> string to write <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>.
09296     Length - number of bytes to write
09297 
09298 Return Value:
09299 
09300     The function status <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
09301 
09302 
09303 --*/
09304 {
09305     OBJECT_ATTRIBUTES ObjA;
09306     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
09307     IO_STATUS_BLOCK IoStatusBlock;
09308     HANDLE FileHandle;
09309     WCHAR UnicodeHeader = 0xfeff;
09310 
09311 
09312     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
09313 
09314     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4/internal_8c.html#a12">BootLogRecord</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09315         <span class="keywordflow">return</span> STATUS_SUCCESS;
09316     }
09317 
09318     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;<a class="code" href="../../d2/d4/internal_8c.html#a12">BootLogRecord</a>-&gt;<a class="code" href="../../d6/d4/struct__BOOT__LOG__RECORD.html#o4">Resource</a>, TRUE);
09319 
09320     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4/internal_8c.html#a12">BootLogRecord</a>-&gt;<a class="code" href="../../d6/d4/struct__BOOT__LOG__RECORD.html#o2">LogFileName</a>.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09321         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d2/d4/internal_8c.html#a12">BootLogRecord</a>-&gt;<a class="code" href="../../d6/d4/struct__BOOT__LOG__RECORD.html#o2">LogFileName</a>, L<span class="stringliteral">"\\SystemRoot\\ntbtlog.txt"</span>);
09322     }
09323 
09324     InitializeObjectAttributes(&amp;ObjA, &amp;<a class="code" href="../../d2/d4/internal_8c.html#a12">BootLogRecord</a>-&gt;<a class="code" href="../../d6/d4/struct__BOOT__LOG__RECORD.html#o2">LogFileName</a>, OBJ_CASE_INSENSITIVE, NULL, NULL);
09325 
09326     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a31">ZwCreateFile</a>(&amp;FileHandle,
09327                             GENERIC_WRITE,
09328                             &amp;ObjA,
09329                             &amp;IoStatusBlock,
09330                             NULL,
09331                             FILE_ATTRIBUTE_NORMAL,
09332                             FILE_SHARE_READ,
09333                             FILE_OPEN_IF,
09334                             FILE_SYNCHRONOUS_IO_NONALERT | FILE_NON_DIRECTORY_FILE | FILE_SEQUENTIAL_ONLY,
09335                             NULL,
09336                             0
09337                             );
09338 
09339     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) &amp;&amp; IoStatusBlock.Information == FILE_CREATED) {
09340 
09341         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwWriteFile(
09342                     FileHandle,
09343                     NULL,
09344                     NULL,
09345                     NULL,
09346                     &amp;IoStatusBlock,
09347                     (PVOID) &amp;UnicodeHeader,
09348                     <span class="keyword">sizeof</span>(WCHAR),
09349                     NULL,
09350                     NULL
09351                     );
09352 
09353     }
09354 
09355     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
09356 
09357         LARGE_INTEGER EndOfFile;
09358 
09359         EndOfFile.HighPart = 0xffffffff;
09360         EndOfFile.LowPart = FILE_WRITE_TO_END_OF_FILE;
09361 
09362         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwWriteFile(
09363                     FileHandle,
09364                     NULL,
09365                     NULL,
09366                     NULL,
09367                     &amp;IoStatusBlock,
09368                     (PVOID) <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Buffer,
09369                     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length,
09370                     &amp;EndOfFile,
09371                     NULL
09372                     );
09373 
09374         ZwClose(FileHandle);
09375     }
09376 
09377     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d2/d4/internal_8c.html#a12">BootLogRecord</a>-&gt;<a class="code" href="../../d6/d4/struct__BOOT__LOG__RECORD.html#o4">Resource</a>);
09378 
09379     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
09380 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="internal.c::IopCancelAlertedRequest" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopCancelAlertedRequest           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Event</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l00417">417</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02149">IoCancelIrp()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00253">KeReadStateEvent()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l05397">IopQueryXxxInformation()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06926">IopSynchronousApiServiceTail()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l07030">IopSynchronousServiceTail()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09835">IoSetInformation()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00101">NtQueryInformationFile()</a>, and <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00849">NtSetInformationFile()</a>.
<p>
<pre class="fragment"><div>00424                    :
00425 
00426     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked when a synchronous I/O operation that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> blocked in
00427     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O system needs to be canceled because <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread making <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request has
00428     either been alerted because <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> going away or because of a CTRL/C.  This
00429     routine carefully attempts to work its way <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current operation so
00430     that local events or other local data will not be accessed once <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service
00431     being interrupted returns.
00432 
00433 Arguments:
00434 
00435     <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> - The address of a kernel event that will be set to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Signaled state
00436         by I/O completion when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> complete.
00437 
00438     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet (<a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>) representing the current request.
00439 
00440 Return Value:
00441 
00442     None.
00443 
00444 --*/
00445 
00446 {
00447     KIRQL irql;
00448     LARGE_INTEGER deltaTime;
00449     BOOLEAN canceled;
00450 
00451     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00452 
00453     <span class="comment">//</span>
00454     <span class="comment">// Begin by blocking special kernel APCs so that the request cannot</span>
00455     <span class="comment">// complete.</span>
00456     <span class="comment">//</span>
00457 
00458     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>( APC_LEVEL, &amp;irql );
00459 
00460     <span class="comment">//</span>
00461     <span class="comment">// Check the state of the event to determine whether or not the</span>
00462     <span class="comment">// packet has already been completed.</span>
00463     <span class="comment">//</span>
00464 
00465     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/eventobj_8c.html#a6">KeReadStateEvent</a>( Event ) == 0) {
00466 
00467         <span class="comment">//</span>
00468         <span class="comment">// The packet has not been completed, so attempt to cancel it.</span>
00469         <span class="comment">//</span>
00470 
00471         canceled = <a class="code" href="../../d4/d6/iosubs_8c.html#a30">IoCancelIrp</a>( Irp );
00472 
00473         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>( irql );
00474 
00475         <span class="keywordflow">if</span> (canceled) {
00476 
00477             <span class="comment">//</span>
00478             <span class="comment">// The packet had a cancel routine, so it was canceled.  Loop,</span>
00479             <span class="comment">// waiting for the packet to complete.  This should occur almost</span>
00480             <span class="comment">// immediately.</span>
00481             <span class="comment">//</span>
00482 
00483             deltaTime.QuadPart = - 10 * 1000 * 10;
00484 
00485             <span class="keywordflow">while</span> (<a class="code" href="../../d2/d8/eventobj_8c.html#a6">KeReadStateEvent</a>( Event ) == 0) {
00486 
00487                 <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a>( KernelMode, FALSE, &amp;deltaTime );
00488 
00489             }
00490 
00491         } <span class="keywordflow">else</span> {
00492 
00493             <span class="comment">//</span>
00494             <span class="comment">// The packet did not have a cancel routine, so simply wait for</span>
00495             <span class="comment">// the event to be set to the Signaled state.  This will save</span>
00496             <span class="comment">// CPU time by not looping, since it is not known when the packet</span>
00497             <span class="comment">// will actually complete.  Note, however, that the cancel flag</span>
00498             <span class="comment">// is set in the packet, so should a driver examine the flag</span>
00499             <span class="comment">// at some point in the future, it will immediately stop</span>
00500             <span class="comment">// processing the request.</span>
00501             <span class="comment">//</span>
00502 
00503             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( Event,
00504                                           Executive,
00505                                           KernelMode,
00506                                           FALSE,
00507                                           (PLARGE_INTEGER) NULL );
00508 
00509         }
00510 
00511     } <span class="keywordflow">else</span> {
00512 
00513         <span class="comment">//</span>
00514         <span class="comment">// The packet has already been completed, so simply lower the</span>
00515         <span class="comment">// IRQL back to its original value and exit.</span>
00516         <span class="comment">//</span>
00517 
00518         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>( irql );
00519 
00520     }
00521 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="internal.c::IopCheckGetQuotaBufferValidity" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopCheckGetQuotaBufferValidity           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PFILE_GET_QUOTA_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>QuotaBuffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>QuotaLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>ErrorOffset</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l00524">524</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d2/d4/internal_8c.html#a1">GET_OFFSET_LENGTH</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01350">RtlLengthSid()</a>, and <a class="el" href="../../d9/d5/sertl_8c-source.html#l00810">RtlValidSid()</a>.
<p>
Referenced by <a class="el" href="../../d1/d2/qsquota_8c-source.html#l00035">NtQueryQuotaInformationFile()</a>.
<p>
<pre class="fragment"><div>00532                    :
00533 
00534     This routine checks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> validity of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified get quota buffer to
00535     guarantee that its <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> proper, no fields hang over, that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00536     not recursive, etc.
00537 
00538 Arguments:
00539 
00540     QuotaBuffer - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> get quota structure
00541         array to be checked.
00542 
00543     QuotaLength - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> quota buffer.
00544 
00545     ErrorOffset - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offset of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offending entry
00546         in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> quota buffer <span class="keywordflow">if</span> an error <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> incurred.  This variable <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>
00547         valid <span class="keywordflow">if</span> an error occurs.
00548 
00549 Return Value:
00550 
00551     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> STATUS_SUCCESS <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> get quota buffer contains a
00552     valid, properly formed list, otherwise STATUS_QUOTA_LIST_INCONSISTENT.
00553 
00554 --*/
00555 
00556 {
00557 
00558 <span class="preprocessor">#define GET_OFFSET_LENGTH( CurrentSid, SidBase ) ( (ULONG) ((PCHAR) CurrentSid - (PCHAR) SidBase) )</span>
00559 <span class="preprocessor"></span>
00560     LONG tempLength;
00561     LONG entrySize;
00562     PFILE_GET_QUOTA_INFORMATION sids;
00563 
00564     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00565 
00566     <span class="comment">//</span>
00567     <span class="comment">// Walk the buffer and ensure that its format is valid.  That is, ensure</span>
00568     <span class="comment">// that it does not walk off the end of the buffer, is not recursive, etc.</span>
00569     <span class="comment">//</span>
00570 
00571     sids = QuotaBuffer;
00572     tempLength = QuotaLength;
00573 
00574     <span class="keywordflow">for</span> (;;) {
00575 
00576         <span class="comment">//</span>
00577         <span class="comment">// Ensure that the current entry is valid.</span>
00578         <span class="comment">//</span>
00579 
00580         <span class="keywordflow">if</span> ((tempLength &lt; (LONG) (FIELD_OFFSET(FILE_GET_QUOTA_INFORMATION, Sid.SubAuthority) +
00581                                   <span class="keyword">sizeof</span> (sids-&gt;Sid.SubAuthority))) ||
00582             !<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( &amp;sids-&gt;Sid)) {
00583 
00584             *ErrorOffset = <a class="code" href="../../d2/d4/internal_8c.html#a1">GET_OFFSET_LENGTH</a>( sids, QuotaBuffer );
00585             <span class="keywordflow">return</span> STATUS_QUOTA_LIST_INCONSISTENT;
00586         }
00587 
00588         <span class="comment">//</span>
00589         <span class="comment">// Get the size of the current entry in the buffer.</span>
00590         <span class="comment">//</span>
00591 
00592         entrySize = FIELD_OFFSET( FILE_GET_QUOTA_INFORMATION, Sid ) + <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>( (&amp;sids-&gt;Sid) );
00593 
00594         <span class="keywordflow">if</span> (sids-&gt;NextEntryOffset) {
00595 
00596             <span class="comment">//</span>
00597             <span class="comment">// There is another entry in the buffer and it must be longword</span>
00598             <span class="comment">// aligned.  Ensure that the offset indicates that it is.  If it</span>
00599             <span class="comment">// isn't, return an invalid parameter status.</span>
00600             <span class="comment">//</span>
00601 
00602             <span class="keywordflow">if</span> (entrySize &gt; (LONG) sids-&gt;NextEntryOffset ||
00603                 sids-&gt;NextEntryOffset &amp; (<span class="keyword">sizeof</span>( ULONG ) - 1)) {
00604                 *ErrorOffset = <a class="code" href="../../d2/d4/internal_8c.html#a1">GET_OFFSET_LENGTH</a>( sids, QuotaBuffer );
00605                 <span class="keywordflow">return</span> STATUS_QUOTA_LIST_INCONSISTENT;
00606 
00607             } <span class="keywordflow">else</span> {
00608 
00609                 <span class="comment">//</span>
00610                 <span class="comment">// There is another entry in the buffer, so account for the</span>
00611                 <span class="comment">// size of the current entry in the length and get a pointer</span>
00612                 <span class="comment">// to the next entry.</span>
00613                 <span class="comment">//</span>
00614 
00615                 tempLength -= sids-&gt;NextEntryOffset;
00616                 <span class="keywordflow">if</span> (tempLength &lt; 0) {
00617                     *ErrorOffset = <a class="code" href="../../d2/d4/internal_8c.html#a1">GET_OFFSET_LENGTH</a>( sids, QuotaBuffer );
00618                     <span class="keywordflow">return</span> STATUS_QUOTA_LIST_INCONSISTENT;
00619                 }
00620                 sids = (PFILE_GET_QUOTA_INFORMATION) ((PCHAR) sids + sids-&gt;NextEntryOffset);
00621             }
00622 
00623         } <span class="keywordflow">else</span> {
00624 
00625             <span class="comment">//</span>
00626             <span class="comment">// There are no other entries in the buffer.  Simply account for</span>
00627             <span class="comment">// the overall buffer length according to the size of the current</span>
00628             <span class="comment">// entry and exit the loop.</span>
00629             <span class="comment">//</span>
00630 
00631             tempLength -= entrySize;
00632             <span class="keywordflow">break</span>;
00633         }
00634     }
00635 
00636     <span class="comment">//</span>
00637     <span class="comment">// All of the entries in the buffer have been processed.  Check to see</span>
00638     <span class="comment">// whether the overall buffer length went negative.  If so, return an</span>
00639     <span class="comment">// error.</span>
00640     <span class="comment">//</span>
00641 
00642     <span class="keywordflow">if</span> (tempLength &lt; 0) {
00643         *ErrorOffset = <a class="code" href="../../d2/d4/internal_8c.html#a1">GET_OFFSET_LENGTH</a>( sids, QuotaBuffer );
00644         <span class="keywordflow">return</span> STATUS_QUOTA_LIST_INCONSISTENT;
00645     }
00646 
00647     <span class="comment">//</span>
00648     <span class="comment">// The format of the get quota buffer was correct, so simply return a</span>
00649     <span class="comment">// success status code.</span>
00650     <span class="comment">//</span>
00651 
00652     <span class="keywordflow">return</span> STATUS_SUCCESS;
00653 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="internal.c::IopCompletePageWrite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopCompletePageWrite           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Apc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l00919">919</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06632">IoFreeIrp()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00048">NT_ERROR</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o24">_IRP::Overlay</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01648">_IRP::PendingReturned</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>.
<p>
<pre class="fragment"><div>00929                    :
00930 
00931     This routine executes as a special kernel APC routine in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context of
00932     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Modified Page <a class="code" href="../../d4/d0/tex_8c.html#a44">Writer</a> (MPW) system thread when an out-page operation
00933     has completed.
00934 
00935     This routine performs the following tasks:
00936 
00937         o   The I/O status is copied.
00938 
00939         o   The Modified Page Writer's APC routine is invoked.
00940 
00941 Arguments:
00942 
00943     Apc - Supplies a pointer to kernel APC structure.
00944 
00945     NormalRoutine - Supplies a pointer to a pointer to the normal function
00946         that was specified when the APC was initialized.
00947 
00948     NormalContext - Supplies a pointer to a pointer to an arbitrary data
00949         structure that was specified when the APC was initialized.
00950 
00951     SystemArgument1 - Supplies a pointer to an argument that contains an
00952         argument that is unused by this routine.
00953 
00954     SystemArgument2 - Supplies a pointer to an argument that contains an
00955         argument that is unused by this routine.
00956 
00957 Return Value:
00958 
00959     None.
00960 
00961 --*/
00962 
00963 {
00964     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00965     PIO_APC_ROUTINE apcRoutine;
00966     PVOID apcContext;
00967     PIO_STATUS_BLOCK ioStatus;
00968 
00969     UNREFERENCED_PARAMETER( NormalRoutine );
00970     UNREFERENCED_PARAMETER( NormalContext );
00971     UNREFERENCED_PARAMETER( SystemArgument1 );
00972     UNREFERENCED_PARAMETER( SystemArgument2 );
00973 
00974     <span class="comment">//</span>
00975     <span class="comment">// Begin by getting the address of the I/O Request Packet from the APC.</span>
00976     <span class="comment">//</span>
00977 
00978     irp = CONTAINING_RECORD( Apc, <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>, Tail.Apc );
00979 
00980     <span class="comment">//</span>
00981     <span class="comment">// If this I/O operation did not complete successfully through the</span>
00982     <span class="comment">// dispatch routine of the driver, then drop everything on the floor</span>
00983     <span class="comment">// now and return to the original call point in the MPW.</span>
00984     <span class="comment">//</span>
00985 
00986     <span class="keywordflow">if</span> (!irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o11">PendingReturned</a> &amp;&amp; <a class="code" href="../../d5/d6/stierr_8h.html#a3">NT_ERROR</a>( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status )) {
00987         <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a>( irp );
00988         <span class="keywordflow">return</span>;
00989     }
00990 
00991     <span class="comment">//</span>
00992     <span class="comment">// Copy the I/O status from the IRP into the caller's I/O status block.</span>
00993     <span class="comment">//</span>
00994 
00995     *irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>;
00996 
00997     <span class="comment">//</span>
00998     <span class="comment">// Copy the pertinent information from the I/O Request Packet into locals</span>
00999     <span class="comment">// and free it.</span>
01000     <span class="comment">//</span>
01001 
01002     apcRoutine = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine;
01003     apcContext = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcContext;
01004     ioStatus = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a>;
01005 
01006     <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a>( irp );
01007 
01008     <span class="comment">//</span>
01009     <span class="comment">// Finally, invoke the MPW's APC routine.</span>
01010     <span class="comment">//</span>
01011 
01012     apcRoutine( apcContext, ioStatus, 0 );
01013 
01014     <span class="keywordflow">return</span>;
01015 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="internal.c::IopCompleteRequest" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopCompleteRequest           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Apc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l01019">1019</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01541">_FILE_OBJECT::CompletionContext</a>, <a class="el" href="../../d4/d9/ke_8h.html#a403a183">CurrentApcEnvironment</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01540">_FILE_OBJECT::Event</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01523">_FILE_OBJECT::FinalStatus</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01533">_FILE_OBJECT::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01491">FO_SYNCHRONOUS_IO</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06632">IoFreeIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06744">IoFreeMdl()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a241a141">IopCompletionPacketIrp</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00758">IopDequeueThreadIrp</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08130">IopDoNameTransmogrify()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l01883">IopExceptionFilter()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12441">IopUpdateOtherTransferCount()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12473">IopUpdateReadTransferCount()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12504">IopUpdateWriteTransferCount()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l07981">IopUserCompletion()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l08051">IopUserRundown()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d8/d5/ioverifier_8h-source.html#l00039">IOVP_COMPLETE_REQUEST</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01554">IRP_BUFFERED_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01558">IRP_CREATE_OPERATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01555">IRP_DEALLOCATE_BUFFER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01556">IRP_INPUT_OPERATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01565">IRP_OB_QUERY_NAME</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01559">IRP_READ_OPERATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01567">IRP_RETRY_IO_COMPLETION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01552">IRP_SYNCHRONOUS_API</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01560">IRP_WRITE_OPERATION</a>, <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00039">KeInitializeApc()</a>, <a class="el" href="../../d9/d2/queueobj_8c-source.html#l00124">KeInsertQueue()</a>, <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00217">KeInsertQueueApc()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01483">_IO_COMPLETION_CONTEXT::Key</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01596">_IRP::MdlAddress</a>, <a class="el" href="../../d2/d4/internal_8c.html#a3">MEMORY_BARRIER</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00414">_MDL::Next</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00048">NT_ERROR</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o24">_IRP::Overlay</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01648">_IRP::PendingReturned</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00196">PKNORMAL_ROUTINE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00214">PKRUNDOWN_ROUTINE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01482">_IO_COMPLETION_CONTEXT::Port</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01641">_IRP::RequestorMode</a>, <a class="el" href="../../d2/d4/internal_8c.html#a2">SynchronousIo</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00347">_ETHREAD::Tcb</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01711">_IRP::UserBuffer</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l00144">IopAbortRequest()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l07030">IopSynchronousServiceTail()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12782">IoRetryIrpCompletions()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00101">NtQueryInformationFile()</a>, and <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00849">NtSetInformationFile()</a>.
<p>
<pre class="fragment"><div>01029                    :
01030 
01031     This routine executes as a special kernel APC routine in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context of
01032     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread which originally requested <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O operation which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> now
01033     being completed.
01034 
01035     This routine performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following tasks:
01036 
01037         o   <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> check <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to determine whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified request ended
01038             with an error status.  If so, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> error code qualifies as one
01039             which should be reported to an error port, then an error port <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01040             looked <span class="keywordflow">for</span> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread/process.   If one exists, then <span class="keyword">this</span> routine
01041             will attempt to set up an LPC to <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.  Otherwise, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will attempt to
01042             set up an LPC to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system error port.
01043 
01044         o   <a class="code" href="../../d9/d0/cmdata_8h.html#a104a97">Copy</a> buffers.
01045 
01046         o   Free MDLs.
01047 
01048         o   <a class="code" href="../../d9/d0/cmdata_8h.html#a104a97">Copy</a> I/O status.
01049 
01050         o   Set event, <span class="keywordflow">if</span> any and dereference <span class="keywordflow">if</span> appropriate.
01051 
01052         o   Dequeue <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread queue as pending I/O request.
01053 
01054         o   Queue APC to thread, <span class="keywordflow">if</span> any.
01055 
01056         o   If no APC <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be queued, then free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> packet now.
01057 
01058 
01059 Arguments:
01060 
01061     Apc - Supplies a pointer to kernel APC structure.
01062 
01063     NormalRoutine - Supplies a pointer to a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> normal function
01064         that was specified when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC was initialied.
01065 
01066     NormalContext - Supplies a pointer to a pointer to an arbitrary data
01067         structure that was specified when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC was initialized.
01068 
01069     SystemArgument1 - Supplies a pointer to an argument that contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01070         address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <span class="keywordflow">for</span> <span class="keyword">this</span> I/O operation.
01071 
01072     SystemArgument2 - Supplies a pointer to an argument that contains an
01073         argument that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used by <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">case</span> of STATUS_REPARSE.
01074 
01075 Return Value:
01076 
01077     None.
01078 
01079 --*/
01080 {
01081 <span class="preprocessor">#define SynchronousIo( Irp, FileObject ) (  \</span>
01082 <span class="preprocessor">    (Irp-&gt;Flags &amp; IRP_SYNCHRONOUS_API) ||   \</span>
01083 <span class="preprocessor">    (FileObject == NULL ? 0 : FileObject-&gt;Flags &amp; FO_SYNCHRONOUS_IO) )</span>
01084 <span class="preprocessor"></span>
01085     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
01086     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> mdl, nextMdl;
01087     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> thread;
01088     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> fileObject;
01089     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
01090 
01091     UNREFERENCED_PARAMETER( NormalRoutine );
01092     UNREFERENCED_PARAMETER( NormalContext );
01093 
01094     <span class="comment">//</span>
01095     <span class="comment">// Begin by getting the address of the I/O Request Packet.  Also, get</span>
01096     <span class="comment">// the address of the current thread and the address of the original file</span>
01097     <span class="comment">// object for this I/O operation.</span>
01098     <span class="comment">//</span>
01099 
01100     irp = CONTAINING_RECORD( Apc, <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>, Tail.Apc );
01101     thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01102     fileObject = (<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>) *SystemArgument1;
01103 
01104     <a class="code" href="../../d7/d6/ioverifier_8h.html#a0">IOVP_COMPLETE_REQUEST</a>(Apc, SystemArgument1, SystemArgument2);
01105 
01106     <span class="comment">//</span>
01107     <span class="comment">// Ensure that the packet is not being completed with a minus one.  This</span>
01108     <span class="comment">// is apparently a common problem in some drivers, and has no meaning</span>
01109     <span class="comment">// as a status code.</span>
01110     <span class="comment">//</span>
01111 
01112     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status != 0xffffffff );
01113 
01114     <span class="comment">//</span>
01115     <span class="comment">// See if we need to do the name transmogrify work.</span>
01116     <span class="comment">//</span>
01117 
01118     <span class="keywordflow">if</span> ( *SystemArgument2 != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01119 
01120         PREPARSE_DATA_BUFFER reparseBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01121 
01122         <span class="comment">//</span>
01123         <span class="comment">// The IO_REPARSE_TAG_MOUNT_POINT tag needs attention.</span>
01124         <span class="comment">//</span>
01125 
01126         <span class="keywordflow">if</span> ( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status == STATUS_REPARSE &amp;&amp;
01127              irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information == IO_REPARSE_TAG_MOUNT_POINT ) {
01128 
01129             reparseBuffer = (PREPARSE_DATA_BUFFER) *SystemArgument2;
01130 
01131             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( reparseBuffer-&gt;ReparseTag == IO_REPARSE_TAG_MOUNT_POINT );
01132             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( reparseBuffer-&gt;ReparseDataLength &lt; MAXIMUM_REPARSE_DATA_BUFFER_SIZE );
01133             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( reparseBuffer-&gt;Reserved &lt; MAXIMUM_REPARSE_DATA_BUFFER_SIZE );
01134 
01135             <a class="code" href="../../d4/d6/iosubs_8c.html#a86">IopDoNameTransmogrify</a>( irp,
01136                                    fileObject,
01137                                    reparseBuffer );
01138         }
01139     }
01140 
01141     <span class="comment">//</span>
01142     <span class="comment">// Check to see whether there is any data in a system buffer which needs</span>
01143     <span class="comment">// to be copied to the caller's buffer.  If so, copy the data and then</span>
01144     <span class="comment">// free the system buffer if necessary.</span>
01145     <span class="comment">//</span>
01146 
01147     <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a178">IRP_BUFFERED_IO</a>) {
01148 
01149         <span class="comment">//</span>
01150         <span class="comment">// Copy the data if this was an input operation.  Note that no copy</span>
01151         <span class="comment">// is performed if the status indicates that a verify operation is</span>
01152         <span class="comment">// required, or if the final status was an error-level severity.</span>
01153         <span class="comment">//</span>
01154 
01155         <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a180">IRP_INPUT_OPERATION</a>  &amp;&amp;
01156             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status != STATUS_VERIFY_REQUIRED &amp;&amp;
01157             !<a class="code" href="../../d5/d6/stierr_8h.html#a3">NT_ERROR</a>( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status )) {
01158 
01159             <span class="comment">//</span>
01160             <span class="comment">// Copy the information from the system buffer to the caller's</span>
01161             <span class="comment">// buffer.  This is done with an exception handler in case</span>
01162             <span class="comment">// the operation fails because the caller's address space</span>
01163             <span class="comment">// has gone away, or it's protection has been changed while</span>
01164             <span class="comment">// the service was executing.</span>
01165             <span class="comment">//</span>
01166 
01167             <span class="keywordflow">try</span> {
01168                 RtlCopyMemory( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o26">UserBuffer</a>,
01169                                irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer,
01170                                irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information );
01171             } except(<a class="code" href="../../d0/d6/iop_8h.html#a169">IopExceptionFilter</a>(GetExceptionInformation(), &amp;status)) {
01172 
01173                 <span class="comment">//</span>
01174                 <span class="comment">// An exception occurred while attempting to copy the</span>
01175                 <span class="comment">// system buffer contents to the caller's buffer.  Set</span>
01176                 <span class="comment">// a new I/O completion status.</span>
01177                 <span class="comment">// If the status is a special one set by Mm then we need to </span>
01178                 <span class="comment">// return here and the operation will be retried in </span>
01179                 <span class="comment">// IoRetryIrpCompletions.</span>
01180                 <span class="comment">//</span>
01181 
01182                 <span class="keywordflow">if</span> (status == STATUS_MULTIPLE_FAULT_VIOLATION) {
01183                     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = fileObject;  <span class="comment">/* Wiped out by APC  overlay */</span>
01184                     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a189">IRP_RETRY_IO_COMPLETION</a>;
01185                     <span class="keywordflow">return</span>;
01186                 }
01187                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = GetExceptionCode();
01188             }
01189         }
01190 
01191         <span class="comment">//</span>
01192         <span class="comment">// Free the buffer if needed.</span>
01193         <span class="comment">//</span>
01194 
01195         <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a179">IRP_DEALLOCATE_BUFFER</a>) {
01196             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer );
01197         }
01198     }
01199 
01200     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp;= ~(<a class="code" href="../../d0/d5/io_8h.html#a179">IRP_DEALLOCATE_BUFFER</a>|<a class="code" href="../../d0/d5/io_8h.html#a178">IRP_BUFFERED_IO</a>);
01201 
01202     <span class="comment">//</span>
01203     <span class="comment">// If there is an MDL (or MDLs) associated with this I/O request,</span>
01204     <span class="comment">// Free it (them) here.  This is accomplished by walking the MDL list</span>
01205     <span class="comment">// hanging off of the IRP and deallocating each MDL encountered.</span>
01206     <span class="comment">//</span>
01207 
01208     <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a>) {
01209         <span class="keywordflow">for</span> (mdl = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a>; mdl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; mdl = nextMdl) {
01210             nextMdl = mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o0">Next</a>;
01211             <a class="code" href="../../d4/d6/iosubs_8c.html#a65">IoFreeMdl</a>( mdl );
01212         }
01213     }
01214     
01215     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01216 
01217     <span class="comment">//</span>
01218     <span class="comment">// Check to see whether or not the I/O operation actually completed.  If</span>
01219     <span class="comment">// it did, then proceed normally.  Otherwise, cleanup everything and get</span>
01220     <span class="comment">// out of here.</span>
01221     <span class="comment">//</span>
01222 
01223     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a3">NT_ERROR</a>( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status ) ||
01224         (<a class="code" href="../../d5/d6/stierr_8h.html#a3">NT_ERROR</a>( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status ) &amp;&amp;
01225         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o11">PendingReturned</a> &amp;&amp;
01226         !<a class="code" href="../../d2/d4/internal_8c.html#a2">SynchronousIo</a>( irp, fileObject ))) {
01227 
01228         PVOID port = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01229         PVOID key;
01230         BOOLEAN createOperation = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01231 
01232         <span class="comment">//</span>
01233         <span class="comment">// If there is an I/O completion port object associated w/this request,</span>
01234         <span class="comment">// save it here so that the file object can be dereferenced.</span>
01235         <span class="comment">//</span>
01236 
01237         <span class="keywordflow">if</span> (fileObject &amp;&amp; fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o26">CompletionContext</a>) {
01238             port = fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o26">CompletionContext</a>-&gt;<a class="code" href="../../d2/d4/struct__IO__COMPLETION__CONTEXT.html#o0">Port</a>;
01239             key = fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o26">CompletionContext</a>-&gt;<a class="code" href="../../d2/d4/struct__IO__COMPLETION__CONTEXT.html#o1">Key</a>;
01240         }
01241 
01242         <span class="comment">//</span>
01243         <span class="comment">// Copy the I/O status from the IRP into the caller's I/O status</span>
01244         <span class="comment">// block. This is done using an exception handler in case the caller's</span>
01245         <span class="comment">// virtual address space for the I/O status block was deleted or</span>
01246         <span class="comment">// its protection was changed to readonly.  Note that if the I/O</span>
01247         <span class="comment">// status block cannot be written, the error is simply ignored since</span>
01248         <span class="comment">// there is no way to tell the caller that something went wrong.</span>
01249         <span class="comment">// This is, of course, by definition, since the I/O status block</span>
01250         <span class="comment">// is where the caller will attempt to look for errors in the first</span>
01251         <span class="comment">// place!</span>
01252         <span class="comment">//</span>
01253 
01254         <span class="keywordflow">try</span> {
01255 
01256             <span class="comment">//</span>
01257             <span class="comment">// Since HasOverlappedIoCompleted and GetOverlappedResult only</span>
01258             <span class="comment">// look at the Status field of the UserIosb to determine if the</span>
01259             <span class="comment">// IRP has completed, the Information field must be written</span>
01260             <span class="comment">// before the Status field.</span>
01261             <span class="comment">//</span>
01262 
01263 <span class="preprocessor">#if defined(_M_ALPHA) &amp;&amp; !defined(NT_UP)</span>
01264 <span class="preprocessor"></span><span class="preprocessor">#define MEMORY_BARRIER()    __MB()</span>
01265 <span class="preprocessor"></span><span class="preprocessor">#else</span>
01266 <span class="preprocessor"></span><span class="preprocessor">#define MEMORY_BARRIER()</span>
01267 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01268 <span class="preprocessor"></span>
01269 <span class="preprocessor">#if defined(_WIN64)</span>
01270 <span class="preprocessor"></span>            PIO_STATUS_BLOCK32    UserIosb32;
01271 
01272             <span class="comment">//</span>
01273             <span class="comment">// If the caller passes a 32 bit IOSB the ApcRoutine has the LSB set to 1</span>
01274             <span class="comment">//</span>
01275             <span class="keywordflow">if</span> ((ULONG_PTR)(irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine) &amp; 1) {
01276                 UserIosb32 = (PIO_STATUS_BLOCK32)irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a>;
01277 
01278                 UserIosb32-&gt;Information = (ULONG)irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information;
01279                 <a class="code" href="../../d2/d4/internal_8c.html#a3">MEMORY_BARRIER</a>();
01280                 UserIosb32-&gt;Status = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
01281             } <span class="keywordflow">else</span> {
01282                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a>-&gt;Information = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information;
01283                 <a class="code" href="../../d2/d4/internal_8c.html#a3">MEMORY_BARRIER</a>();
01284                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a>-&gt;Status = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
01285             }
01286 <span class="preprocessor">#else</span>
01287 <span class="preprocessor"></span>            irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a>-&gt;Information = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information;
01288             <a class="code" href="../../d2/d4/internal_8c.html#a3">MEMORY_BARRIER</a>();
01289             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a>-&gt;Status = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
01290 <span class="preprocessor">#endif  </span><span class="comment">/*_WIN64 */</span>
01291 
01292         } except(<a class="code" href="../../d0/d6/iop_8h.html#a169">IopExceptionFilter</a>(GetExceptionInformation(), &amp;status)) {
01293 
01294             <span class="comment">//</span>
01295             <span class="comment">// An exception was incurred attempting to write the caller's</span>
01296             <span class="comment">// I/O status block.  Simply continue executing as if nothing</span>
01297             <span class="comment">// ever happened since nothing can be done about it anyway.</span>
01298             <span class="comment">// If the status is a multiple fault status, this is a special</span>
01299             <span class="comment">// status sent by the Memory manager. Mark the IRP and return from</span>
01300             <span class="comment">// this routine. Mm will call us back later and we will retry this</span>
01301             <span class="comment">// operation (IoRetryIrpCompletions)</span>
01302             <span class="comment">//</span>
01303             <span class="keywordflow">if</span> (status == STATUS_MULTIPLE_FAULT_VIOLATION) {
01304                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = fileObject;  <span class="comment">/* Wiped out by APC  overlay */</span>
01305                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a189">IRP_RETRY_IO_COMPLETION</a>;
01306                 <span class="keywordflow">return</span>;
01307             }
01308         }
01309 
01310 
01311         <span class="comment">//</span>
01312         <span class="comment">// Determine whether the caller supplied an event that needs to be set</span>
01313         <span class="comment">// to the Signaled state.  If so, then set it; otherwise, set the event</span>
01314         <span class="comment">// in the file object to the Signaled state.</span>
01315         <span class="comment">//</span>
01316         <span class="comment">// It is possible for the event to have been specified as a PKEVENT if</span>
01317         <span class="comment">// this was an I/O operation hand-built for an FSP or an FSD, or</span>
01318         <span class="comment">// some other types of operations such as synchronous I/O APIs.  In</span>
01319         <span class="comment">// any of these cases, the event was not referenced since it is not an</span>
01320         <span class="comment">// object manager event, so it should not be dereferenced.</span>
01321         <span class="comment">//</span>
01322         <span class="comment">// Also, it is possible for there not to be a file object for this IRP.</span>
01323         <span class="comment">// This occurs when an FSP is doing I/O operations to a device driver on</span>
01324         <span class="comment">// behalf of a process doing I/O to a file.  The file object cannot be</span>
01325         <span class="comment">// dereferenced if this is the case.  If this operation was a create</span>
01326         <span class="comment">// operation then the object should not be dereferenced either.  This</span>
01327         <span class="comment">// is because the reference count must be one or it will go away for</span>
01328         <span class="comment">// the caller (not much point in making an object that just got created</span>
01329         <span class="comment">// go away).</span>
01330         <span class="comment">//</span>
01331 
01332         <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a>) {
01333             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a>, 0, FALSE );
01334             <span class="keywordflow">if</span> (fileObject) {
01335                 <span class="keywordflow">if</span> (!(irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a>)) {
01336                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> );
01337                 }
01338                 <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a> &amp;&amp; !(irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a187">IRP_OB_QUERY_NAME</a>)) {
01339                     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o25">Event</a>, 0, FALSE );
01340                     fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o8">FinalStatus</a> = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
01341                 }
01342                 <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a182">IRP_CREATE_OPERATION</a>) {
01343                     createOperation = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01344                     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine = (PIO_APC_ROUTINE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01345                 }
01346             }
01347         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fileObject) {
01348             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o25">Event</a>, 0, FALSE );
01349             fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o8">FinalStatus</a> = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
01350             <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a182">IRP_CREATE_OPERATION</a>) {
01351                 createOperation = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01352                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine = (PIO_APC_ROUTINE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01353             }
01354         }
01355 
01356         <span class="comment">//</span>
01357         <span class="comment">// If this is normal I/O, update the transfer count for this process.</span>
01358         <span class="comment">//</span>
01359 
01360         <span class="keywordflow">if</span> (!(irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a182">IRP_CREATE_OPERATION</a>)) {
01361             <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a183">IRP_READ_OPERATION</a>) {
01362                 <a class="code" href="../../d4/d6/iosubs_8c.html#a133">IopUpdateReadTransferCount</a>( (ULONG) irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information );
01363             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a184">IRP_WRITE_OPERATION</a>) {
01364                 <a class="code" href="../../d4/d6/iosubs_8c.html#a134">IopUpdateWriteTransferCount</a>( (ULONG) irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information );
01365             } <span class="keywordflow">else</span> {
01366                 <span class="comment">//</span>
01367                 <span class="comment">// If the information field contains a pointer then skip the update.</span>
01368                 <span class="comment">// Some PNP IRPs contain this.</span>
01369                 <span class="comment">//</span>
01370                 <span class="keywordflow">if</span> (!((ULONG) irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information &amp; 0x80000000)) {
01371                     <a class="code" href="../../d4/d6/iosubs_8c.html#a132">IopUpdateOtherTransferCount</a>( (ULONG) irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information );
01372                 }
01373             }
01374         }
01375 
01376         <span class="comment">//</span>
01377         <span class="comment">// Dequeue the packet from the thread's pending I/O request list.</span>
01378         <span class="comment">//</span>
01379 
01380         <a class="code" href="../../d0/d6/iop_8h.html#a18">IopDequeueThreadIrp</a>( irp );
01381 
01382         <span class="comment">//</span>
01383         <span class="comment">// If the caller requested an APC, queue it to the thread.  If not, then</span>
01384         <span class="comment">// simply free the packet now.</span>
01385         <span class="comment">//</span>
01386 
01387 <span class="preprocessor">#ifdef  _WIN64</span>
01388 <span class="preprocessor"></span>        <span class="comment">//</span>
01389         <span class="comment">// For 64 bit systems clear the LSB field of the ApcRoutine that indicates whether</span>
01390         <span class="comment">// the IOSB is a 32 bit IOSB or a 64 bit IOSB.</span>
01391         <span class="comment">//</span>
01392         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine =
01393           (PIO_APC_ROUTINE)((LONG_PTR)(irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine) &amp; ~1);
01394 <span class="preprocessor">#endif</span>
01395 <span class="preprocessor"></span>
01396         <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine) {
01397             <a class="code" href="../../d5/d7/apcobj_8c.html#a1">KeInitializeApc</a>( &amp;irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Apc,
01398                              &amp;thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>,
01399                              CurrentApcEnvironment,
01400                              IopUserCompletion,
01401                              (PKRUNDOWN_ROUTINE) IopUserRundown,
01402                              (PKNORMAL_ROUTINE) irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine,
01403                              irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a>,
01404                              irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcContext );
01405 
01406             <a class="code" href="../../d5/d7/apcobj_8c.html#a3">KeInsertQueueApc</a>( &amp;irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Apc,
01407                               irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a>,
01408                               NULL,
01409                               2 );
01410 
01411         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (port &amp;&amp; irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcContext) {
01412 
01413             <span class="comment">//</span>
01414             <span class="comment">// If there is a completion context associated w/this I/O operation,</span>
01415             <span class="comment">// send the message to the port. Tag completion packet as an Irp.</span>
01416             <span class="comment">//</span>
01417 
01418             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.CompletionKey = key;
01419             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.PacketType = <a class="code" href="../../d0/d6/iop_8h.html#a241a141">IopCompletionPacketIrp</a>;
01420 
01421             <a class="code" href="../../d8/d3/queueobj_8c.html#a3">KeInsertQueue</a>( (<a class="code" href="../../d7/d7/struct__KQUEUE.html">PKQUEUE</a>) port,
01422                            &amp;irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.ListEntry );
01423 
01424         } <span class="keywordflow">else</span> {
01425 
01426             <span class="comment">//</span>
01427             <span class="comment">// Free the IRP now since it is no longer needed.</span>
01428             <span class="comment">//</span>
01429 
01430             <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a>( irp );
01431         }
01432 
01433         <span class="keywordflow">if</span> (fileObject &amp;&amp; !createOperation) {
01434 
01435             <span class="comment">//</span>
01436             <span class="comment">// Dereference the file object now.</span>
01437             <span class="comment">//</span>
01438 
01439             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
01440         }
01441 
01442     } <span class="keywordflow">else</span> {
01443 
01444         <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o11">PendingReturned</a> &amp;&amp; fileObject) {
01445 
01446             <span class="comment">//</span>
01447             <span class="comment">// This is an I/O operation that completed as an error for</span>
01448             <span class="comment">// which a pending status was returned and the I/O operation</span>
01449             <span class="comment">// is synchronous.  For this case, the I/O system is waiting</span>
01450             <span class="comment">// on behalf of the caller.  If the reason that the I/O was</span>
01451             <span class="comment">// synchronous is that the file object was opened for synchronous</span>
01452             <span class="comment">// I/O, then the event associated with the file object is set</span>
01453             <span class="comment">// to the signaled state.  If the I/O operation was synchronous</span>
01454             <span class="comment">// because this is a synchronous API, then the event is set to</span>
01455             <span class="comment">// the signaled state.</span>
01456             <span class="comment">//</span>
01457             <span class="comment">// Note also that the status must be returned for both types</span>
01458             <span class="comment">// of synchronous I/O.  If this is a synchronous API, then the</span>
01459             <span class="comment">// I/O system supplies its own status block so it can simply</span>
01460             <span class="comment">// be written;  otherwise, the I/O system will obtain the final</span>
01461             <span class="comment">// status from the file object itself.</span>
01462             <span class="comment">//</span>
01463 
01464             <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a>) {
01465                 *irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>;
01466                 <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a>) {
01467                     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a>, 0, FALSE );
01468                 } <span class="keywordflow">else</span> {
01469                     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o25">Event</a>, 0, FALSE );
01470                 }
01471             } <span class="keywordflow">else</span> {
01472                 fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o8">FinalStatus</a> = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
01473                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o25">Event</a>, 0, FALSE );
01474             }
01475         }
01476 
01477         <span class="comment">//</span>
01478         <span class="comment">// The operation was incomplete.  Perform the general cleanup.  Note</span>
01479         <span class="comment">// that everything is basically dropped on the floor without doing</span>
01480         <span class="comment">// anything.  That is:</span>
01481         <span class="comment">//</span>
01482         <span class="comment">//     IoStatusBlock - Do nothing.</span>
01483         <span class="comment">//     Event - Dereference without setting to Signaled state.</span>
01484         <span class="comment">//     FileObject - Dereference without setting to Signaled state.</span>
01485         <span class="comment">//     ApcRoutine - Do nothing.</span>
01486         <span class="comment">//</span>
01487 
01488         <span class="keywordflow">if</span> (fileObject) {
01489             <span class="keywordflow">if</span> (!(irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a182">IRP_CREATE_OPERATION</a>)) {
01490                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
01491             }
01492         }
01493 
01494         <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> &amp;&amp;
01495             fileObject &amp;&amp;
01496             !(irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a>)) {
01497             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> );
01498         }
01499 
01500         <a class="code" href="../../d0/d6/iop_8h.html#a18">IopDequeueThreadIrp</a>( irp );
01501         <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a>( irp );
01502     }
01503 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="internal.c::IopCompleteUnloadOrDelete" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopCompleteUnloadOrDelete           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN KIRQL&nbsp;</td>
          <td class="mdname" nowrap> <em>Irql</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l00657">657</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01181">_DEVICE_OBJECT::AttachedDevice</a>, <a class="el" href="../../d5/d8/ex_8h.html#a332a206">DelayedWorkQueue</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01366">_DRIVER_OBJECT::DeviceObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00553">DNF_REMOVE_PENDING_CLOSES</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01221">DOE_DELETE_PENDING</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01222">DOE_REMOVE_PENDING</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01223">DOE_REMOVE_PROCESSED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01220">DOE_UNLOAD_PENDING</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00317">_LOAD_PACKET::DriverObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01299">DRVO_UNLOAD_INVOKED</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00316">_LOAD_PACKET::Event</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01961">ExInitializeWorkItem</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00375">ExQueueWorkItem()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01268">_DEVOBJ_EXTENSION::ExtensionFlags</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00955">_FAST_IO_DISPATCH::FastIoDetachDevice</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01367">_DRIVER_OBJECT::Flags</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00084">IopChainDereferenceComplete()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00054">IopDatabaseLock</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03919">IopGetDeviceAttachmentBase()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l04026">IopInsertRemoveDevice()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04169">IopLoadUnloadDriver()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a57">LOAD_PACKET</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01180">_DEVICE_OBJECT::NextDevice</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00484">ObMakeTemporaryObject()</a>, <a class="el" href="../../d0/d5/io_8h.html#a342">PDEVOBJ_EXTENSION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01178">_DEVICE_OBJECT::ReferenceCount</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00942">_FAST_IO_DISPATCH::SizeOfFastIoDispatch</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, and <a class="el" href="../../d1/d5/iop_8h-source.html#l00315">_LOAD_PACKET::WorkQueueItem</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05951">IoDeleteDevice()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06298">IoDetachDevice()</a>, and <a class="el" href="../../d3/d3/internal_8c-source.html#l04022">IopDecrementDeviceObjectRef()</a>.
<p>
<pre class="fragment"><div>00664                    :
00665 
00666     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference count on a device object
00667     transitions to a zero and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> mark <span class="keywordflow">for</span> unload or device has
00668     been marked <span class="keywordflow">for</span> <span class="keyword">delete</span>. This means that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> may be possible to actually
00669     unload <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver or <span class="keyword">delete</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object.  If all
00670     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> devices have a reference count of zero, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00671     actually unloaded.  Note that in order to ensure that <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00672     not invoked twice, at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same time, on two different processors, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00673     I/O database spin lock <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> still held at <span class="keyword">this</span> point.
00674 
00675 Arguments:
00676 
00677     DeviceObject - Supplies a pointer to one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver's device objects,
00678         namely <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> one whose reference count just went to zero.
00679 
00680     Irql - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IRQL of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> time that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O
00681         database lock was acquired.
00682 
00683 Return Value:
00684 
00685     None.
00686 
00687 --*/
00688 
00689 {
00690     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject;
00691     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
00692     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> baseDeviceObject;
00693     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> attachedDeviceObject;
00694     <a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html">PDEVOBJ_EXTENSION</a> deviceExtension;
00695     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
00696 
00697     BOOLEAN unload = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00698 
00699     driverObject = DeviceObject-&gt;DriverObject;
00700 
00701     <span class="keywordflow">if</span> (DeviceObject-&gt;DeviceObjectExtension-&gt;ExtensionFlags &amp; <a class="code" href="../../d0/d5/io_8h.html#a140">DOE_REMOVE_PENDING</a>) {
00702 
00703         <span class="comment">//</span>
00704         <span class="comment">// Run some tests to determine if it is an appropriate time to notify</span>
00705         <span class="comment">// PnP that all file objects in the attachment chain have gone away.</span>
00706         <span class="comment">//</span>
00707 
00708         baseDeviceObject = <a class="code" href="../../d0/d6/iop_8h.html#a173">IopGetDeviceAttachmentBase</a>( DeviceObject );
00709         deviceExtension = baseDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>;
00710         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceExtension-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
00711 
00712         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceNode != NULL);
00713 
00714         <span class="comment">//</span>
00715         <span class="comment">// baseDeviceObject is a PDO, this is a PnP stack.  See if</span>
00716         <span class="comment">// an IRP_MN_REMOVE_DEVICE is pending.</span>
00717         <span class="comment">//</span>
00718 
00719         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; DNF_REMOVE_PENDING_CLOSES);
00720 
00721         <span class="comment">//</span>
00722         <span class="comment">// PnP wants to be notified as soon as all refcounts on all devices in</span>
00723         <span class="comment">// this attachment chain go away.</span>
00724         <span class="comment">//</span>
00725 
00726         attachedDeviceObject = baseDeviceObject;
00727         <span class="keywordflow">while</span> (attachedDeviceObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00728 
00729             <span class="keywordflow">if</span> (attachedDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o2">ReferenceCount</a> != 0) {
00730 
00731                 <span class="comment">//</span>
00732                 <span class="comment">// At least one device object in the attachment chain has</span>
00733                 <span class="comment">// an outstanding open.</span>
00734                 <span class="comment">//</span>
00735 
00736                 ExReleaseSpinLock( &amp;IopDatabaseLock, Irql );
00737 
00738                 <span class="keywordflow">return</span>;
00739             }
00740             attachedDeviceObject = attachedDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>;
00741         }
00742 
00743         <span class="comment">//</span>
00744         <span class="comment">// Now one more time changing DOE_REMOVE_PENDING to</span>
00745         <span class="comment">// DOE_REMOVE_PROCESSED.</span>
00746         <span class="comment">//</span>
00747 
00748         attachedDeviceObject = baseDeviceObject;
00749         <span class="keywordflow">while</span> (attachedDeviceObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00750 
00751             deviceExtension = attachedDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>;
00752 
00753             deviceExtension-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> &amp;= ~<a class="code" href="../../d0/d5/io_8h.html#a140">DOE_REMOVE_PENDING</a>;
00754             deviceExtension-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a141">DOE_REMOVE_PROCESSED</a>;
00755 
00756             attachedDeviceObject = attachedDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>;
00757         }
00758 
00759         <span class="comment">//</span>
00760         <span class="comment">// It is time to give PnP the notification it was waiting for.  We have</span>
00761         <span class="comment">// to release the spinlock before doing so.</span>
00762         <span class="comment">//</span>
00763 
00764         ExReleaseSpinLock( &amp;IopDatabaseLock, Irql );
00765 
00766         <a class="code" href="../../d9/d0/pnpiop_8h.html#a316">IopChainDereferenceComplete</a>( baseDeviceObject );
00767 
00768         <span class="keywordflow">return</span>;
00769     }
00770 
00771     <span class="keywordflow">if</span> (DeviceObject-&gt;DeviceObjectExtension-&gt;ExtensionFlags &amp; <a class="code" href="../../d0/d5/io_8h.html#a139">DOE_DELETE_PENDING</a>) {
00772 
00773         <span class="keywordflow">if</span> ((DeviceObject-&gt;DeviceObjectExtension-&gt;ExtensionFlags &amp;
00774             <a class="code" href="../../d0/d5/io_8h.html#a138">DOE_UNLOAD_PENDING</a>) == 0 ||
00775             driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a143">DRVO_UNLOAD_INVOKED</a>) {
00776 
00777             unload = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00778         }
00779 
00780         <span class="comment">//</span>
00781         <span class="comment">// If another device is attached to this device, inform the former's</span>
00782         <span class="comment">// driver that the device is being deleted.</span>
00783         <span class="comment">//</span>
00784 
00785         <span class="keywordflow">if</span> (DeviceObject-&gt;AttachedDevice) {
00786             <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> fastIoDispatch = DeviceObject-&gt;AttachedDevice-&gt;DriverObject-&gt;FastIoDispatch;
00787             <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> attachedDevice = DeviceObject-&gt;AttachedDevice;
00788 
00789             <span class="comment">//</span>
00790             <span class="comment">// Increment the device reference count so the detach routine</span>
00791             <span class="comment">// does not recurse back to here.</span>
00792             <span class="comment">//</span>
00793 
00794             DeviceObject-&gt;ReferenceCount++;
00795 
00796             ExReleaseSpinLock( &amp;IopDatabaseLock, Irql );
00797 
00798             <span class="keywordflow">if</span> (fastIoDispatch &amp;&amp;
00799                 fastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o0">SizeOfFastIoDispatch</a> &gt; FIELD_OFFSET( <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">FAST_IO_DISPATCH</a>, FastIoDetachDevice ) &amp;&amp;
00800                 fastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o13">FastIoDetachDevice</a>) {
00801                 (fastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o13">FastIoDetachDevice</a>)( attachedDevice, DeviceObject );
00802             }
00803 
00804             ExAcquireSpinLock( &amp;IopDatabaseLock, &amp;Irql );
00805 
00806             <span class="comment">//</span>
00807             <span class="comment">// Restore the reference count value.</span>
00808             <span class="comment">//</span>
00809 
00810             DeviceObject-&gt;ReferenceCount--;
00811 
00812             <span class="keywordflow">if</span> (DeviceObject-&gt;AttachedDevice ||
00813                 DeviceObject-&gt;ReferenceCount != 0) {
00814 
00815 
00816                 ExReleaseSpinLock( &amp;IopDatabaseLock, Irql );
00817                 <span class="keywordflow">return</span>;
00818             }
00819         }
00820 
00821         ExReleaseSpinLock( &amp;IopDatabaseLock, Irql );
00822 
00823         <span class="comment">//</span>
00824         <span class="comment">// Deallocate the memory for the security descriptor that was allocated</span>
00825         <span class="comment">// for this device object.</span>
00826         <span class="comment">//</span>
00827 
00828         <span class="keywordflow">if</span> (DeviceObject-&gt;SecurityDescriptor != (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00829             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( DeviceObject-&gt;SecurityDescriptor );
00830         }
00831 
00832         <span class="comment">//</span>
00833         <span class="comment">// Remove this device object from the driver object's list.</span>
00834         <span class="comment">//</span>
00835 
00836         <a class="code" href="../../d4/d6/iosubs_8c.html#a43">IopInsertRemoveDevice</a>( DeviceObject-&gt;DriverObject, DeviceObject, FALSE );
00837 
00838         <span class="comment">//</span>
00839         <span class="comment">// Finally, dereference the object so it is deleted.</span>
00840         <span class="comment">//</span>
00841 
00842         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( DeviceObject );
00843 
00844         <span class="comment">//</span>
00845         <span class="comment">// Return if the unload does not need to be done.</span>
00846         <span class="comment">//</span>
00847 
00848         <span class="keywordflow">if</span> (!unload) {
00849             <span class="keywordflow">return</span>;
00850         }
00851 
00852         <span class="comment">//</span>
00853         <span class="comment">// Reacquire the spin lock make sure the unload routine does has</span>
00854         <span class="comment">// not been called.</span>
00855         <span class="comment">//</span>
00856 
00857         ExAcquireSpinLock( &amp;IopDatabaseLock, &amp;Irql );
00858 
00859         <span class="keywordflow">if</span> (driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a143">DRVO_UNLOAD_INVOKED</a>) {
00860 
00861             <span class="comment">//</span>
00862             <span class="comment">// Some other thread is doing the unload, release the lock and return.</span>
00863             <span class="comment">//</span>
00864 
00865             ExReleaseSpinLock( &amp;IopDatabaseLock, Irql );
00866             <span class="keywordflow">return</span>;
00867         }
00868     }
00869 
00870     <span class="comment">//</span>
00871     <span class="comment">// Scan the list of device objects for this driver, looking for a</span>
00872     <span class="comment">// non-zero reference count.  If any reference count is non-zero, then</span>
00873     <span class="comment">// the driver may not be unloaded.</span>
00874     <span class="comment">//</span>
00875 
00876     deviceObject = driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o2">DeviceObject</a>;
00877 
00878     <span class="keywordflow">while</span> (deviceObject) {
00879         <span class="keywordflow">if</span> (deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o2">ReferenceCount</a> || deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a> ||
00880             deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> &amp; (<a class="code" href="../../d0/d5/io_8h.html#a139">DOE_DELETE_PENDING</a> | <a class="code" href="../../d0/d5/io_8h.html#a140">DOE_REMOVE_PENDING</a>)) {
00881             unload = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00882             <span class="keywordflow">break</span>;
00883         }
00884         deviceObject = deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o4">NextDevice</a>;
00885     }
00886 
00887     <span class="keywordflow">if</span> (unload) {
00888         driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o3">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a143">DRVO_UNLOAD_INVOKED</a>;
00889     }
00890 
00891     ExReleaseSpinLock( &amp;IopDatabaseLock, Irql );
00892 
00893     <span class="comment">//</span>
00894     <span class="comment">// If the reference counts for all of the devices is zero, then this</span>
00895     <span class="comment">// driver can now be unloaded.</span>
00896     <span class="comment">//</span>
00897 
00898     <span class="keywordflow">if</span> (unload) {
00899         <a class="code" href="../../d0/d2/struct__LOAD__PACKET.html">LOAD_PACKET</a> loadPacket;
00900 
00901         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;loadPacket.<a class="code" href="../../d0/d2/struct__LOAD__PACKET.html#o1">Event</a>, NotificationEvent, FALSE );
00902         loadPacket.<a class="code" href="../../d0/d2/struct__LOAD__PACKET.html#o2">DriverObject</a> = driverObject;
00903         <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>( &amp;loadPacket.<a class="code" href="../../d0/d2/struct__LOAD__PACKET.html#o0">WorkQueueItem</a>,
00904                               IopLoadUnloadDriver,
00905                               &amp;loadPacket );
00906         <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>( &amp;loadPacket.<a class="code" href="../../d0/d2/struct__LOAD__PACKET.html#o0">WorkQueueItem</a>, DelayedWorkQueue );
00907         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;loadPacket.<a class="code" href="../../d0/d2/struct__LOAD__PACKET.html#o1">Event</a>,
00908                                       Executive,
00909                                       KernelMode,
00910                                       FALSE,
00911                                       (PLARGE_INTEGER) NULL );
00912 
00913         <a class="code" href="../../d5/d0/obclose_8c.html#a3">ObMakeTemporaryObject</a>( driverObject );
00914         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( driverObject );
00915     }
00916 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="internal.c::IopConnectLinkTrackingPort" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopConnectLinkTrackingPort           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Parameter</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l01506">1506</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d1/d5/iop_8h-source.html#l00330">_LINK_TRACKING_PACKET::Event</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00331">_LINK_TRACKING_PACKET::FinalStatus</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00346">IopLinkTrackingServiceEvent</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00345">IopLinkTrackingServiceObject</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00253">KeReadStateEvent()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00091">LpcPortObjectType</a>, <a class="el" href="../../d2/d4/internal_8c.html#a4">MESSAGE_SIZE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d6/d5/lpcconn_8c-source.html#l00043">NtConnectPort()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d6/iop_8h.html#a60">PLINK_TRACKING_PACKET</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l06127">IopSendMessageToTrackService()</a>.
<p>
<pre class="fragment"><div>01512                    :
01513 
01514     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to connect to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user-mode link tracking service's
01515     LPC port.  It makes a connection which establishes a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> port,
01516     and then creates a referenced object pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> port.
01517 
01518 Arguments:
01519 
01520     Parameter - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> link tracking packet.
01521 
01522 Return Value:
01523 
01524     None.
01525 
01526 
01527 --*/
01528 
01529 {
01530 <span class="preprocessor">    #define MESSAGE_SIZE    ( (2 * sizeof( FILE_VOLUMEID_WITH_TYPE )) + \</span>
01531 <span class="preprocessor">                            sizeof( FILE_OBJECTID_BUFFER ) +              \</span>
01532 <span class="preprocessor">                            sizeof( GUID ) + \</span>
01533 <span class="preprocessor">                            sizeof( NTSTATUS ) + \</span>
01534 <span class="preprocessor">                            sizeof( ULONG ) )</span>
01535 <span class="preprocessor"></span>
01536     <a class="code" href="../../d8/d1/struct__LINK__TRACKING__PACKET.html">PLINK_TRACKING_PACKET</a> ltp;
01537     HANDLE serviceHandle;
01538     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01539 
01540     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01541     <span class="comment">//</span>
01542     <span class="comment">// Begin by getting a pointer to the link tracking packet.</span>
01543     <span class="comment">//</span>
01544 
01545     ltp = (<a class="code" href="../../d8/d1/struct__LINK__TRACKING__PACKET.html">PLINK_TRACKING_PACKET</a>) Parameter;
01546 
01547 
01548     <span class="comment">//</span>
01549     <span class="comment">// Ensure that the port has not already been opened.</span>
01550     <span class="comment">//</span>
01551 
01552     status = STATUS_SUCCESS;
01553     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d5/iodata_8c.html#a61">IopLinkTrackingServiceObject</a>) {
01554 
01555         UNICODE_STRING portName;
01556         ULONG maxMessageLength;
01557         SECURITY_QUALITY_OF_SERVICE dynamicQos;
01558 
01559         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/eventobj_8c.html#a6">KeReadStateEvent</a>( IopLinkTrackingServiceEvent )) {
01560 
01561             <span class="comment">//</span>
01562             <span class="comment">// Attempt to open a handle to the port.</span>
01563             <span class="comment">//</span>
01564 
01565             <span class="comment">//</span>
01566             <span class="comment">// Set up the security quality of service parameters to use over the</span>
01567             <span class="comment">// port.  Use the most efficient (least overhead) which is dynamic</span>
01568             <span class="comment">// rather than static tracking.</span>
01569             <span class="comment">//</span>
01570 
01571             dynamicQos.ImpersonationLevel = SecurityImpersonation;
01572             dynamicQos.ContextTrackingMode = SECURITY_DYNAMIC_TRACKING;
01573             dynamicQos.EffectiveOnly = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01574 
01575             <span class="comment">//</span>
01576             <span class="comment">// Generate the string structure for describing the port.</span>
01577             <span class="comment">//</span>
01578 
01579             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;portName, L<span class="stringliteral">"\\Security\\TRKWKS_PORT"</span> );
01580 
01581             status = <a class="code" href="../../d5/d6/lpcconn_8c.html#a1">NtConnectPort</a>( &amp;serviceHandle,
01582                                     &amp;portName,
01583                                     &amp;dynamicQos,
01584                                     (PPORT_VIEW) NULL,
01585                                     (PREMOTE_PORT_VIEW) NULL,
01586                                     &amp;maxMessageLength,
01587                                     (PVOID) NULL,
01588                                     (PULONG) NULL );
01589             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01590                 <span class="keywordflow">if</span> (maxMessageLength &gt;= <a class="code" href="../../d2/d4/internal_8c.html#a4">MESSAGE_SIZE</a>) {
01591                     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( serviceHandle,
01592                                                         0,
01593                                                         LpcPortObjectType,
01594                                                         KernelMode,
01595                                                         &amp;IopLinkTrackingServiceObject,
01596                                                         NULL );
01597                     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( serviceHandle );
01598                 } <span class="keywordflow">else</span> {
01599                     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( serviceHandle );
01600                     status = STATUS_INVALID_PARAMETER;
01601                 }
01602             }
01603 
01604         } <span class="keywordflow">else</span> {
01605 
01606             <span class="comment">//</span>
01607             <span class="comment">// The service has not been started so the port does not exist.</span>
01608             <span class="comment">//</span>
01609 
01610             status = STATUS_OBJECT_NAME_NOT_FOUND;
01611         }
01612     }
01613 
01614 
01615     <span class="comment">//</span>
01616     <span class="comment">// Return final status and wake the caller up.</span>
01617     <span class="comment">//</span>
01618     ltp-&gt;<a class="code" href="../../d8/d1/struct__LINK__TRACKING__PACKET.html#o2">FinalStatus</a> = status;
01619     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;ltp-&gt;<a class="code" href="../../d8/d1/struct__LINK__TRACKING__PACKET.html#o1">Event</a>, 0, FALSE );
01620 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="internal.c::IopCopyBootLogRegistryToFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopCopyBootLogRegistryToFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00997">NtInitializeRegistry()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="internal.c::IopDeallocateApc" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopDeallocateApc           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Apc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l01771">1771</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08769">IoRaiseHardError()</a>, and <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08909">IoRaiseInformationalHardError()</a>.
<p>
<pre class="fragment"><div>01781                    :
01782 
01783     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to deallocate an APC that was used to queue a
01784     request to a target thread.  It simple deallocates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC.
01785 
01786 Arguments:
01787 
01788     Apc - Supplies a pointer to kernel APC structure.
01789 
01790     NormalRoutine - Supplies a pointer to a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> normal function
01791         that was specified when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC was initialied.
01792 
01793     NormalContext - Supplies a pointer to a pointer to an arbitrary data
01794         structure that was specified when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC was initialized.
01795 
01796     SystemArgument1, SystemArgument2 - Supplies a set of two pointers to
01797         two arguments that contain untyped data.
01798 
01799 Return Value:
01800 
01801     None.
01802 
01803 --*/
01804 
01805 {
01806     UNREFERENCED_PARAMETER( NormalRoutine );
01807     UNREFERENCED_PARAMETER( NormalContext );
01808     UNREFERENCED_PARAMETER( SystemArgument1 );
01809     UNREFERENCED_PARAMETER( SystemArgument2 );
01810 
01811     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01812 
01813     <span class="comment">//</span>
01814     <span class="comment">// Free the APC.</span>
01815     <span class="comment">//</span>
01816 
01817     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Apc );
01818 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a50" doxytag="internal.c::IopDecrementDeviceObjectRef" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopDecrementDeviceObjectRef           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AlwaysUnload</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l04022">4022</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01221">DOE_DELETE_PENDING</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01222">DOE_REMOVE_PENDING</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01220">DOE_UNLOAD_PENDING</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00657">IopCompleteUnloadOrDelete()</a>, and <a class="el" href="../../d4/d4/iodata_8c-source.html#l00054">IopDatabaseLock</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05378">IoCreateStreamFileObject()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05535">IoCreateStreamFileObjectLite()</a>, <a class="el" href="../../d5/d2/parse_8c-source.html#l00098">IopCheckVpbMounted()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00417">IopDeleteFile()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04077">IopLoadFileSystemDriver()</a>, and <a class="el" href="../../d5/d2/parse_8c-source.html#l00202">IopParseDevice()</a>.
<p>
<pre class="fragment"><div>04029                    :
04030 
04031     The routine decrements <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference count on a device object.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04032     reference count goes to zero and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a candidate <span class="keywordflow">for</span> deletion
04033     then <a class="code" href="../../d2/d4/internal_8c.html#a26">IopCompleteUnloadOrDelete</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> device object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> subject <span class="keywordflow">for</span>
04034     deletion <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AlwaysUnload flag <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keyword">true</span>, or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> pending
04035     deletion or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> pending unload.
04036 
04037 Arguments:
04038 
04039     DeviceObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object whose reference count <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be
04040                    decremented.
04041 
04042     AlwaysUnload - Indicates <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver should be unloaded regardless of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04043                    state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unload flag.
04044 
04045 Return Value:
04046 
04047     None.
04048 
04049 --*/
04050 {
04051     KIRQL irql;
04052 
04053     <span class="comment">//</span>
04054     <span class="comment">// Decrement the reference count on the device object.  If this is the last</span>
04055     <span class="comment">// last reason that this mini-file system recognizer needs to stay around,</span>
04056     <span class="comment">// then unload it.</span>
04057     <span class="comment">//</span>
04058 
04059     ExAcquireSpinLock( &amp;IopDatabaseLock, &amp;irql );
04060 
04061     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( DeviceObject-&gt;ReferenceCount &gt; 0 );
04062 
04063     DeviceObject-&gt;ReferenceCount--;
04064 
04065     <span class="keywordflow">if</span> (!DeviceObject-&gt;ReferenceCount &amp;&amp; (AlwaysUnload ||
04066          DeviceObject-&gt;DeviceObjectExtension-&gt;ExtensionFlags &amp;
04067          (<a class="code" href="../../d0/d5/io_8h.html#a139">DOE_DELETE_PENDING</a> | <a class="code" href="../../d0/d5/io_8h.html#a138">DOE_UNLOAD_PENDING</a> | <a class="code" href="../../d0/d5/io_8h.html#a140">DOE_REMOVE_PENDING</a>))) {
04068 
04069         <a class="code" href="../../d0/d6/iop_8h.html#a155">IopCompleteUnloadOrDelete</a>( DeviceObject, irql );
04070     } <span class="keywordflow">else</span> {
04071         ExReleaseSpinLock( &amp;IopDatabaseLock, irql );
04072     }
04073 
04074 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="internal.c::IopDisassociateThreadIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopDisassociateThreadIrp           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l01623">1623</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01655">_IRP::CurrentLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02488">_IO_STACK_LOCATION::DeviceObject</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00428">IoAllocateErrorLogEntry()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00196">IopCompletionLock</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00056">IopDeadIrp</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l11556">IoWriteErrorLogEntry()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00414">_ETHREAD::IrpList</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01654">_IRP::StackCount</a>, and <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02242">IoCancelThreadIo()</a>.
<p>
<pre class="fragment"><div>01629                    :
01630 
01631     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O requests <span class="keywordflow">for</span> a thread are being
01632     cancelled, but there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a packet at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread's queue that
01633     has not been completed <span class="keywordflow">for</span> such a <span class="keywordtype">long</span> period of time that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> has timed
01634     <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keyword">this</span> routine's responsibility to <span class="keywordflow">try</span> to disassociate that
01635     <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> with <span class="keyword">this</span> thread.
01636 
01637 Arguments:
01638 
01639     None.
01640 
01641 Return Value:
01642 
01643     None.
01644 
01645 --*/
01646 
01647 {
01648     KIRQL irql;
01649     KIRQL spIrql;
01650     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
01651     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> thread;
01652     PLIST_ENTRY entry;
01653     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
01654     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
01655     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject;
01656     WCHAR buffer[512];
01657     POBJECT_NAME_INFORMATION nameInformation;
01658     ULONG nameLength;
01659     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01660     ULONG response;
01661     PIO_ERROR_LOG_PACKET errorLogEntry;
01662 
01663     <span class="comment">//</span>
01664     <span class="comment">// Begin by ensuring that the packet has not already been removed from</span>
01665     <span class="comment">// the thread's queue.</span>
01666     <span class="comment">//</span>
01667 
01668     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>( APC_LEVEL, &amp;irql );
01669 
01670     thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01671 
01672     <span class="comment">//</span>
01673     <span class="comment">// If there are no packets on the IRP list, then simply return now.</span>
01674     <span class="comment">// All of the packets have been fully completed, so the caller will also</span>
01675     <span class="comment">// simply return to its caller.</span>
01676     <span class="comment">//</span>
01677 
01678     <span class="keywordflow">if</span> (IsListEmpty( &amp;thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o18">IrpList</a> )) {
01679         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>( irql );
01680         <span class="keywordflow">return</span>;
01681     }
01682 
01683     <span class="comment">//</span>
01684     <span class="comment">// Get a pointer to the first packet on the queue, and begin examining</span>
01685     <span class="comment">// it.  Note that because the processor is at raised IRQL, and because</span>
01686     <span class="comment">// the packet can only be removed in the context of the currently</span>
01687     <span class="comment">// executing thread, that it is not possible for the packet to be removed</span>
01688     <span class="comment">// from the list.  On the other hand, it IS possible for the packet to</span>
01689     <span class="comment">// be queued to the thread's APC list at this point, and this must be</span>
01690     <span class="comment">// blocked/synchronized in order to examine the request.</span>
01691     <span class="comment">//</span>
01692     <span class="comment">// Begin, therefore, by acquiring the I/O completion spinlock, so that</span>
01693     <span class="comment">// the packet can be safely examined.</span>
01694     <span class="comment">//</span>
01695 
01696     ExAcquireSpinLock( &amp;IopCompletionLock, &amp;spIrql );
01697 
01698     <span class="comment">//</span>
01699     <span class="comment">// Check to see whether or not the packet has been completed (that is,</span>
01700     <span class="comment">// queued to the current thread).  If not, change threads.</span>
01701     <span class="comment">//</span>
01702 
01703     entry = thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o18">IrpList</a>.Flink;
01704     irp = CONTAINING_RECORD( entry, <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>, ThreadListEntry );
01705 
01706     <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a> == irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o12">StackCount</a> + 2) {
01707 
01708         <span class="comment">//</span>
01709         <span class="comment">// The request has just gone through enough of completion that</span>
01710         <span class="comment">// queueing it to the thread is inevitable.  Simply release the</span>
01711         <span class="comment">// lock and return.</span>
01712         <span class="comment">//</span>
01713 
01714         ExReleaseSpinLock( &amp;IopCompletionLock, spIrql );
01715         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>( irql );
01716         <span class="keywordflow">return</span>;
01717     }
01718 
01719     <span class="comment">//</span>
01720     <span class="comment">// The packet has been located, and it is not going through completion</span>
01721     <span class="comment">// at this point.  Switch threads, so that it will not complete through</span>
01722     <span class="comment">// this thread, remove the request from this thread's queue, and release</span>
01723     <span class="comment">// the spinlock.  Final processing of the IRP will occur when I/O</span>
01724     <span class="comment">// completion notices that there is no thread associated with the</span>
01725     <span class="comment">// request.  It will essentially drop the I/O on the floor.</span>
01726     <span class="comment">//</span>
01727     <span class="comment">// Also, while the request is still held, attempt to determine on which</span>
01728     <span class="comment">// device object the operation is being performed.</span>
01729     <span class="comment">//</span>
01730 
01735 
01736     <a class="code" href="../../d2/d4/internal_8c.html#a11">IopDeadIrp</a> = irp;
01737 
01738     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = (<a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01739     entry = RemoveHeadList( &amp;thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o18">IrpList</a> );
01740 
01741     <span class="comment">// Initialize the thread entry. Otherwise the assertion in IoFreeIrp</span>
01742     <span class="comment">// called via IopDeadIrp will fail.</span>
01743     InitializeListHead (&amp;(irp)-&gt;ThreadListEntry);
01744 
01745     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( irp );
01746     <span class="keywordflow">if</span> (irp-&gt;CurrentLocation &lt;= irp-&gt;StackCount) {
01747         deviceObject = irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o57">DeviceObject</a>;
01748     } <span class="keywordflow">else</span> {
01749         deviceObject = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01750     }
01751     ExReleaseSpinLock( &amp;IopCompletionLock, spIrql );
01752     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>( irql );
01753 
01754     <span class="comment">//</span>
01755     <span class="comment">// If a device object could be identified then try to write to the event log about this</span>
01756     <span class="comment">// device object.</span>
01757     <span class="comment">//</span>
01758 
01759     <span class="keywordflow">if</span> (deviceObject) {
01760             errorLogEntry = <a class="code" href="../../d4/d6/iosubs_8c.html#a14">IoAllocateErrorLogEntry</a>(deviceObject, <span class="keyword">sizeof</span>(IO_ERROR_LOG_PACKET));
01761             <span class="keywordflow">if</span> (errorLogEntry) {
01762                 errorLogEntry-&gt;ErrorCode = IO_DRIVER_CANCEL_TIMEOUT;
01763                 <a class="code" href="../../d4/d6/iosubs_8c.html#a123">IoWriteErrorLogEntry</a>(errorLogEntry);
01764             }
01765     }
01766 
01767     <span class="keywordflow">return</span>;
01768 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="internal.c::IopDropIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopDropIrp           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l01821">1821</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06632">IoFreeIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06744">IoFreeMdl()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01558">IRP_CREATE_OPERATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01555">IRP_DEALLOCATE_BUFFER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01552">IRP_SYNCHRONOUS_API</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01596">_IRP::MdlAddress</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00414">_MDL::Next</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>.
<p>
<pre class="fragment"><div>01828                    :
01829 
01830     This routine attempts to drop everything about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01831     floor.
01832 
01833 Arguments:
01834 
01835     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet to be completed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bit bucket.
01836 
01837     FileObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <span class="keywordflow">for</span> which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet was
01838         bound.
01839 
01840 Return Value:
01841 
01842     None.
01843 
01844 --*/
01845 
01846 {
01847     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> mdl;
01848     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> nextMdl;
01849 
01850     <span class="comment">//</span>
01851     <span class="comment">// Free the resources associated with the IRP.</span>
01852     <span class="comment">//</span>
01853 
01854     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a179">IRP_DEALLOCATE_BUFFER</a>) {
01855         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer );
01856     }
01857 
01858     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a>) {
01859         <span class="keywordflow">for</span> (mdl = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a>; mdl; mdl = nextMdl) {
01860             nextMdl = mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o0">Next</a>;
01861             <a class="code" href="../../d4/d6/iosubs_8c.html#a65">IoFreeMdl</a>( mdl );
01862         }
01863     }
01864 
01865     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> &amp;&amp;
01866         FileObject &amp;&amp;
01867         !(<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a>)) {
01868         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> );
01869     }
01870 
01871     <span class="keywordflow">if</span> (FileObject &amp;&amp; !(<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a182">IRP_CREATE_OPERATION</a>)) {
01872         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( FileObject );
01873     }
01874 
01875     <span class="comment">//</span>
01876     <span class="comment">// Finally, free the IRP itself.</span>
01877     <span class="comment">//</span>
01878 
01879     <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a>( Irp );
01880 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="internal.c::IopExceptionCleanup" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopExceptionCleanup           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> EventObject&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> KernelEvent&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l01934">1934</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01491">FO_SYNCHRONOUS_IO</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06632">IoFreeIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06744">IoFreeMdl()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l01157">IopReleaseFileObjectLock</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01596">_IRP::MdlAddress</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/dir_8c-source.html#l00057">BuildQueryDirectoryIrp()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06326">IopSetEaOrQuotaInformationFile()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l08084">IopXxxControlFile()</a>, <a class="el" href="../../d2/d4/lock_8c-source.html#l00035">NtLockFile()</a>, <a class="el" href="../../d1/d7/dir_8c-source.html#l00821">NtNotifyChangeDirectoryFile()</a>, <a class="el" href="../../d8/d1/qsea_8c-source.html#l00035">NtQueryEaFile()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00101">NtQueryInformationFile()</a>, <a class="el" href="../../d1/d2/qsquota_8c-source.html#l00035">NtQueryQuotaInformationFile()</a>, <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00037">NtQueryVolumeInformationFile()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00036">NtReadFile()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00730">NtReadFileScatter()</a>, <a class="el" href="../../d8/d1/qsea_8c-source.html#l00652">NtSetEaFile()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00849">NtSetInformationFile()</a>, <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00492">NtSetVolumeInformationFile()</a>, <a class="el" href="../../d2/d4/lock_8c-source.html#l00458">NtUnlockFile()</a>, <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00035">NtWriteFile()</a>, and <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00801">NtWriteFileGather()</a>.
<p>
<pre class="fragment"><div>01943                    :
01944 
01945     This routine performs generalized cleanup <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O system services when
01946     an exception occurs during caller parameter processing.  This routine
01947     performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following steps:
01948 
01949         o   If a system buffer was allocated <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> freed.
01950 
01951         o   If an <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> was allocated <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> freed.
01952 
01953         o   The <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> freed.
01954 
01955         o   If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> opened <span class="keywordflow">for</span> synchronous I/O, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> semaphore
01956             <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> released.
01957 
01958         o   If an event object was referenced <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> dereferenced.
01959 
01960         o   If a kernel event was allocated, free <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
01961 
01962         o   The <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> dereferenced.
01963 
01964 Arguments:
01965 
01966     FileObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object currently being worked on.
01967 
01968     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> allocated to handle <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O request.
01969 
01970     EventObject - Optional pointer to a referenced event object.
01971 
01972     KernelEvent - Optional pointer to an allocated kernel event.
01973 
01974 Return Value:
01975 
01976     None.
01977 
01978 --*/
01979 
01980 {
01981     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01982 
01983     <span class="comment">//</span>
01984     <span class="comment">// If a system buffer was allocated from nonpaged pool, free it.</span>
01985     <span class="comment">//</span>
01986 
01987     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01988         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer );
01989     }
01990 
01991     <span class="comment">//</span>
01992     <span class="comment">// If an MDL was allocated, free it.</span>
01993     <span class="comment">//</span>
01994 
01995     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01996         <a class="code" href="../../d4/d6/iosubs_8c.html#a65">IoFreeMdl</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> );
01997     }
01998 
01999     <span class="comment">//</span>
02000     <span class="comment">// Free the I/O Request Packet.</span>
02001     <span class="comment">//</span>
02002 
02003     <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a>( Irp );
02004 
02005     <span class="comment">//</span>
02006     <span class="comment">// Finally, release the synchronization semaphore if it is currently</span>
02007     <span class="comment">// held, dereference the event if one was specified, free the kernel</span>
02008     <span class="comment">// event if one was allocated, and dereference the file object.</span>
02009     <span class="comment">//</span>
02010 
02011     <span class="keywordflow">if</span> (FileObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>) {
02012         <a class="code" href="../../d0/d6/iop_8h.html#a22">IopReleaseFileObjectLock</a>( FileObject );
02013     }
02014 
02015     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( EventObject )) {
02016         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( EventObject );
02017     }
02018 
02019     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( KernelEvent )) {
02020         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( KernelEvent );
02021     }
02022 
02023     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( FileObject );
02024 
02025     <span class="keywordflow">return</span>;
02026 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="internal.c::IopExceptionFilter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LONG IopExceptionFilter           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PEXCEPTION_POINTERS&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionPointer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PNTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionCode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l01883">1883</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l01019">IopCompleteRequest()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00036">NtReadFile()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00730">NtReadFileScatter()</a>, <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00035">NtWriteFile()</a>, and <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00801">NtWriteFileGather()</a>.
<p>
<pre class="fragment"><div>01890                    :
01891 
01892     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked when an exception occurs to determine whether or
01893     not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception was due to an error that caused an in-page error status
01894     code exception to be raised.  If so, then <span class="keyword">this</span> routine changes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> code
01895     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception record to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual error code that was originally
01896     raised.
01897 
01898 Arguments:
01899 
01900     ExceptionPointer - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception record.
01901 
01902     ExceptionCode - Variable to receive actual exception code.
01903 
01904 Return Value:
01905 
01906     The function value indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception handler <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be executed.
01907 
01908 --*/
01909 
01910 {
01911     <span class="comment">//</span>
01912     <span class="comment">// Simply check for an in-page error status code and, if the conditions</span>
01913     <span class="comment">// are right, replace it with the actual status code.</span>
01914     <span class="comment">//</span>
01915 
01916     *ExceptionCode = ExceptionPointer-&gt;ExceptionRecord-&gt;ExceptionCode;
01917     <span class="keywordflow">if</span> (*ExceptionCode == STATUS_IN_PAGE_ERROR &amp;&amp;
01918         ExceptionPointer-&gt;ExceptionRecord-&gt;NumberParameters &gt;= 3) {
01919         *ExceptionCode = (LONG) ExceptionPointer-&gt;ExceptionRecord-&gt;ExceptionInformation[2];
01920     }
01921 
01922     <span class="comment">//</span>
01923     <span class="comment">// Translate alignment warnings into alignment errors.</span>
01924     <span class="comment">//</span>
01925 
01926     <span class="keywordflow">if</span> (*ExceptionCode == STATUS_DATATYPE_MISALIGNMENT) {
01927         *ExceptionCode = STATUS_DATATYPE_MISALIGNMENT_ERROR;
01928     }
01929 
01930     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>;
01931 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="internal.c::IopFreeIrpAndMdls" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopFreeIrpAndMdls           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Irp</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l02029">2029</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06632">IoFreeIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06744">IoFreeMdl()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01596">_IRP::MdlAddress</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00414">_MDL::Next</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
<pre class="fragment"><div>02035                    :
02036 
02037     This routine frees <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet and all of its Memory
02038     Descriptor Lists.
02039 
02040 Arguments:
02041 
02042     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet to be freed.
02043 
02044 Return Value:
02045 
02046     None.
02047 
02048 --*/
02049 
02050 {
02051     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> mdl;
02052     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> nextMdl;
02053 
02054     <span class="comment">//</span>
02055     <span class="comment">// If there are any MDLs that need to be freed, free them now.</span>
02056     <span class="comment">//</span>
02057 
02058     <span class="keywordflow">for</span> (mdl = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a>; mdl != (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; mdl = nextMdl) {
02059         nextMdl = mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o0">Next</a>;
02060         <a class="code" href="../../d4/d6/iosubs_8c.html#a65">IoFreeMdl</a>( mdl );
02061     }
02062 
02063     <span class="comment">//</span>
02064     <span class="comment">// Free the IRP.</span>
02065     <span class="comment">//</span>
02066 
02067     <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a>( Irp );
02068     <span class="keywordflow">return</span>;
02069 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a48" doxytag="internal.c::IopGetDeviceAttachmentBase" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> IopGetDeviceAttachmentBase           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l03919">3919</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01283">_DEVOBJ_EXTENSION::AttachedTo</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l00657">IopCompleteUnloadOrDelete()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03967">IopGetDeviceAttachmentBaseRef()</a>, and <a class="el" href="../../d4/d0/objsup_8c-source.html#l00826">IopGetDevicePDO()</a>.
<p>
<pre class="fragment"><div>03925                    :
03926 
03927     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lowest level device object associated with
03928     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device.
03929 
03930 Arguments:
03931 
03932     DeviceObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device <span class="keywordflow">for</span> which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bottom of
03933         attachment chain <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be found.
03934 
03935 Return Value:
03936 
03937     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a reference to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lowest level device attached
03938     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> supplied device object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> that device
03939     object, then a pointer to <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
03940 
03941     N.B. Caller must own <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/iodata_8c.html#a3">IopDatabaseLock</a>.
03942 
03943 --*/
03944 
03945 {
03946     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> baseDeviceObject;
03947     <a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html">PDEVOBJ_EXTENSION</a> deviceExtension;
03948 
03949     <span class="comment">//</span>
03950     <span class="comment">// Descend down the attachment chain until we find a device object</span>
03951     <span class="comment">// that isn't attached to anything else.</span>
03952     <span class="comment">//</span>
03953 
03954     baseDeviceObject = DeviceObject;
03955     deviceExtension = baseDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>;
03956     <span class="keywordflow">while</span> (deviceExtension-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o7">AttachedTo</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03957 
03958         baseDeviceObject = deviceExtension-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o7">AttachedTo</a>;
03959         deviceExtension = baseDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>;
03960     }
03961 
03962     <span class="keywordflow">return</span> baseDeviceObject;
03963 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a49" doxytag="internal.c::IopGetDeviceAttachmentBaseRef" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> IopGetDeviceAttachmentBaseRef           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l03967">3967</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d4/d4/iodata_8c-source.html#l00054">IopDatabaseLock</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03919">IopGetDeviceAttachmentBase()</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>.
<p>
<pre class="fragment"><div>03973                    :
03974 
03975     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lowest level device object associated with
03976     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device.
03977 
03978 Arguments:
03979 
03980     DeviceObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device <span class="keywordflow">for</span> which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bottom of
03981         attachment chain <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be found.
03982 
03983 Return Value:
03984 
03985     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a reference to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lowest level device attached
03986     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> supplied device object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> that device
03987     object, then a pointer to <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
03988 
03989     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> reference <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> taken on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned device object.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03990     responsibility of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller to release <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
03991 
03992 --*/
03993 
03994 {
03995     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> baseDeviceObject;
03996     KIRQL irql;
03997 
03998     <span class="comment">//</span>
03999     <span class="comment">// Any examination of attachment chain linkage must be done with</span>
04000     <span class="comment">// IopDatabaseLock taken.</span>
04001     <span class="comment">//</span>
04002 
04003     ExAcquireSpinLock( &amp;IopDatabaseLock, &amp;irql );
04004 
04005     <span class="comment">//</span>
04006     <span class="comment">// Find the base of the attachment chain.</span>
04007     <span class="comment">//</span>
04008 
04009     baseDeviceObject = <a class="code" href="../../d0/d6/iop_8h.html#a173">IopGetDeviceAttachmentBase</a>( DeviceObject );
04010 
04011     <span class="comment">//</span>
04012     <span class="comment">// Reference the device object before releasing the database lock.</span>
04013     <span class="comment">//</span>
04014 
04015     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( baseDeviceObject );
04016     ExReleaseSpinLock( &amp;IopDatabaseLock, irql );
04017 
04018     <span class="keywordflow">return</span> baseDeviceObject;
04019 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="internal.c::IopGetDriverNameFromKeyNode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopGetDriverNameFromKeyNode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l02072">2072</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01883">RtlAppendUnicodeStringToString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01821">RtlAppendUnicodeToString()</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03165">IopCallDriverAddDeviceQueryRoutine()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03146">IopInitializeSystemDrivers()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04654">IopLoadBootFilterDriver()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>, and <a class="el" href="../../d9/d3/loadunld_8c-source.html#l00244">NtUnloadDriver()</a>.
<p>
<pre class="fragment"><div>02079                    :
02080 
02081     Given a handle to a driver service list key in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry, <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02082     name that represents <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Object <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a79">Manager</a> name space string that should
02083     be used to locate/create <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver object.
02084 
02085 Arguments:
02086 
02087     KeyHandle - Supplies a handle to driver service entry in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry.
02088 
02089     DriverName - Supplies a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a> string descriptor variable in which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02090         name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
02091 
02092 Return Value:
02093 
02094     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
02095 
02096 --*/
02097 
02098 {
02099     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
02100     PKEY_BASIC_INFORMATION keyBasicInformation;
02101     ULONG keyBasicLength;
02102     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02103 
02104     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02105 
02106     <span class="comment">//</span>
02107     <span class="comment">// Get the optional object name for this driver from the value for this</span>
02108     <span class="comment">// key.  If one exists, then its name overrides the default name of the</span>
02109     <span class="comment">// driver.</span>
02110     <span class="comment">//</span>
02111 
02112     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( KeyHandle,
02113                                   L<span class="stringliteral">"ObjectName"</span>,
02114                                   &amp;keyValueInformation );
02115 
02116     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
02117 
02118         PWSTR src, dst;
02119         ULONG i;
02120 
02121         <span class="comment">//</span>
02122         <span class="comment">// The driver entry specifies an object name.  This overrides the</span>
02123         <span class="comment">// default name for the driver.  Use this name to open the driver</span>
02124         <span class="comment">// object.</span>
02125         <span class="comment">//</span>
02126 
02127         <span class="keywordflow">if</span> (!keyValueInformation-&gt;DataLength) {
02128             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
02129             <span class="keywordflow">return</span> STATUS_ILL_FORMED_SERVICE_ENTRY;
02130         }
02131 
02132         DriverName-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (keyValueInformation-&gt;DataLength - <span class="keyword">sizeof</span>( WCHAR ));
02133         DriverName-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) keyValueInformation-&gt;DataLength;
02134 
02135         src = (PWSTR) ((PUCHAR) keyValueInformation + keyValueInformation-&gt;DataOffset);
02136         dst = (PWSTR) keyValueInformation;
02137         <span class="keywordflow">for</span> (i = DriverName-&gt;Length; i; i--) {
02138             *dst++ = *src++;
02139         }
02140 
02141         DriverName-&gt;Buffer = (PWSTR) keyValueInformation;
02142 
02143     } <span class="keywordflow">else</span> {
02144 
02145         PULONG driverType;
02146         PWSTR baseObjectName;
02147         UNICODE_STRING remainderName;
02148 
02149         <span class="comment">//</span>
02150         <span class="comment">// The driver node does not specify an object name, so determine</span>
02151         <span class="comment">// what the default name for the driver object should be based on</span>
02152         <span class="comment">// the information in the key.</span>
02153         <span class="comment">//</span>
02154 
02155         status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( KeyHandle,
02156                                       L<span class="stringliteral">"Type"</span>,
02157                                       &amp;keyValueInformation );
02158         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) || !keyValueInformation-&gt;DataLength) {
02159 
02160             <span class="comment">//</span>
02161             <span class="comment">// There must be some type of "Type" associated with this driver,</span>
02162             <span class="comment">// either DRIVER or FILE_SYSTEM.  Otherwise, this node is ill-</span>
02163             <span class="comment">// formed.</span>
02164             <span class="comment">//</span>
02165 
02166             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
02167                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
02168             }
02169 
02170             <span class="keywordflow">return</span> STATUS_ILL_FORMED_SERVICE_ENTRY;
02171         }
02172 
02173         <span class="comment">//</span>
02174         <span class="comment">// Now determine whether the type of this entry is a driver or a</span>
02175         <span class="comment">// file system.  Begin by assuming that it is a device driver.</span>
02176         <span class="comment">//</span>
02177 
02178         baseObjectName = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Driver\\"</span>;
02179         DriverName-&gt;Length = 8*2;
02180 
02181         driverType = (PULONG) ((PUCHAR) keyValueInformation + keyValueInformation-&gt;DataOffset);
02182 
02183         <span class="keywordflow">if</span> (*driverType == FileSystemType ||
02184             *driverType == RecognizerType) {
02185             baseObjectName = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\FileSystem\\"</span>;
02186             DriverName-&gt;Length = 12*2;
02187         }
02188 
02189         <span class="comment">//</span>
02190         <span class="comment">// Get the name of the key that is being used to describe this</span>
02191         <span class="comment">// driver.  This will return just the last component of the name</span>
02192         <span class="comment">// string, which can be used to formulate the name of the driver.</span>
02193         <span class="comment">//</span>
02194 
02195         status = ZwQueryKey( KeyHandle,
02196                              KeyBasicInformation,
02197                              (PVOID) NULL,
02198                              0,
02199                              &amp;keyBasicLength );
02200 
02201         keyBasicInformation = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( NonPagedPool, keyBasicLength );
02202         <span class="keywordflow">if</span> (!keyBasicInformation) {
02203             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
02204             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02205         }
02206 
02207         status = ZwQueryKey( KeyHandle,
02208                              KeyBasicInformation,
02209                              keyBasicInformation,
02210                              keyBasicLength,
02211                              &amp;keyBasicLength );
02212         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
02213             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyBasicInformation );
02214             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
02215             <span class="keywordflow">return</span> status;
02216         }
02217 
02218         <span class="comment">//</span>
02219         <span class="comment">// Allocate a buffer from pool that is large enough to contain the</span>
02220         <span class="comment">// entire name string of the driver object.</span>
02221         <span class="comment">//</span>
02222 
02223         DriverName-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (DriverName-&gt;Length + keyBasicInformation-&gt;NameLength);
02224         DriverName-&gt;Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( NonPagedPool,
02225                                             DriverName-&gt;MaximumLength );
02226         <span class="keywordflow">if</span> (!DriverName-&gt;Buffer) {
02227             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyBasicInformation );
02228             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
02229             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02230         }
02231 
02232         <span class="comment">//</span>
02233         <span class="comment">// Now form the name of the object to be opened.</span>
02234         <span class="comment">//</span>
02235 
02236         DriverName-&gt;Length = 0;
02237         <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>( DriverName, baseObjectName );
02238         remainderName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) keyBasicInformation-&gt;NameLength;
02239         remainderName.MaximumLength = remainderName.Length;
02240         remainderName.Buffer = &amp;keyBasicInformation-&gt;Name[0];
02241         <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>( DriverName, &amp;remainderName );
02242         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyBasicInformation );
02243         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
02244     }
02245 
02246     <span class="comment">//</span>
02247     <span class="comment">// Finally, simply return to the caller with the name filled in.  Note</span>
02248     <span class="comment">// that the caller must free the buffer pointed to by the Buffer field</span>
02249     <span class="comment">// of the Unicode string descriptor.</span>
02250     <span class="comment">//</span>
02251 
02252     <span class="keywordflow">return</span> STATUS_SUCCESS;
02253 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="internal.c::IopGetFileName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopGetFileName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>FileInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnedLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l02256">2256</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00652">IoAllocateIrp()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00284">IopAllocateIrpCleanup()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l01103">IopQueueThreadIrp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01554">IRP_BUFFERED_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00060">IRP_MJ_QUERY_INFORMATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01565">IRP_OB_QUERY_NAME</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01552">IRP_SYNCHRONOUS_API</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o24">_IRP::Overlay</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01641">_IRP::RequestorMode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01189">_DEVICE_OBJECT::StackSize</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d5/d2/parse_8c-source.html#l01811">IopQueryName()</a>.
<p>
<pre class="fragment"><div>02265                    :
02266 
02267     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to asynchronously obtain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object
02268     when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> was opened <span class="keywordflow">for</span> synchronous I/O, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous mode of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02269     caller was kernel mode, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query was done through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Object <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a79">Manager</a>.
02270     In <span class="keyword">this</span> <span class="keywordflow">case</span>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> situation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> likely that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lazy <a class="code" href="../../d4/d0/tex_8c.html#a44">Writer</a> has incurred a
02271     write error, and <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> attempting to obtain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> so that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
02272     can output a popup.  In doing so, a deadlock can occur because another
02273     thread has locked <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object synchronous I/O lock.  Hence, <span class="keyword">this</span> routine
02274     obtains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> w/o acquiring that lock.
02275 
02276 Arguments:
02277 
02278     FileObject - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object whose name <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be queried.
02279 
02280     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name.
02281 
02282     FileInformation - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name.
02283 
02284     ReturnedLength - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name returned.
02285 
02286 Return Value:
02287 
02288     The status returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> completion status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
02289 
02290 --*/
02291 
02292 {
02293 
02294     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
02295     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02296     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
02297     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
02298     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
02299     IO_STATUS_BLOCK localIoStatus;
02300 
02301     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02302 
02303     <span class="comment">//</span>
02304     <span class="comment">// Reference the file object here so that no special checks need be made</span>
02305     <span class="comment">// in I/O completion to determine whether or not to dereference the file</span>
02306     <span class="comment">// object.</span>
02307     <span class="comment">//</span>
02308 
02309     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( FileObject );
02310 
02311     <span class="comment">//</span>
02312     <span class="comment">// Initialize an event that will be used to synchronize the completion of</span>
02313     <span class="comment">// the query operation.  Note that this is the only way to synchronize this</span>
02314     <span class="comment">// since the file object itself cannot be used since it was opened for</span>
02315     <span class="comment">// synchronous I/O and may be busy.</span>
02316     <span class="comment">//</span>
02317 
02318     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event, SynchronizationEvent, FALSE );
02319 
02320     <span class="comment">//</span>
02321     <span class="comment">// Get the address of the target device object.</span>
02322     <span class="comment">//</span>
02323 
02324     deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject );
02325 
02326     <span class="comment">//</span>
02327     <span class="comment">// Allocate and initialize the I/O Request Packet (IRP) for this operation.</span>
02328     <span class="comment">//</span>
02329 
02330     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a17">IoAllocateIrp</a>( deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a>, FALSE );
02331     <span class="keywordflow">if</span> (!irp) {
02332 
02333         <span class="comment">//</span>
02334         <span class="comment">// An IRP could not be allocated.  Cleanup and return an appropriate</span>
02335         <span class="comment">// error status code.</span>
02336         <span class="comment">//</span>
02337 
02338         <a class="code" href="../../d0/d6/iop_8h.html#a148">IopAllocateIrpCleanup</a>( FileObject, (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) NULL );
02339         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02340     }
02341 
02342     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = FileObject;
02343     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
02344     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>;
02345 
02346     <span class="comment">//</span>
02347     <span class="comment">// Fill in the service independent parameters in the IRP.  Note that the</span>
02348     <span class="comment">// setting of the special query name flag in the packet guarantees that the</span>
02349     <span class="comment">// standard completion for a synchronous file object will not occur because</span>
02350     <span class="comment">// this flag communicates to the I/O completion that it should not do so.</span>
02351     <span class="comment">//</span>
02352 
02353     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = &amp;event;
02354     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a> | <a class="code" href="../../d0/d5/io_8h.html#a187">IRP_OB_QUERY_NAME</a>;
02355     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = &amp;localIoStatus;
02356     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine = (PIO_APC_ROUTINE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02357 
02358     <span class="comment">//</span>
02359     <span class="comment">// Get a pointer to the stack location for the first driver.  This will be</span>
02360     <span class="comment">// used to pass the original function codes and parameters.</span>
02361     <span class="comment">//</span>
02362 
02363     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
02364     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a18">IRP_MJ_QUERY_INFORMATION</a>;
02365     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = FileObject;
02366 
02367     <span class="comment">//</span>
02368     <span class="comment">// Set the system buffer address to the address of the caller's buffer and</span>
02369     <span class="comment">// set the flags so that the buffer is not deallocated.</span>
02370     <span class="comment">//</span>
02371 
02372     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer = FileInformation;
02373     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a178">IRP_BUFFERED_IO</a>;
02374 
02375     <span class="comment">//</span>
02376     <span class="comment">// Copy the caller's parameters to the service-specific portion of the</span>
02377     <span class="comment">// IRP.</span>
02378     <span class="comment">//</span>
02379 
02380     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryFile.Length = Length;
02381     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryFile.FileInformationClass = FileNameInformation;
02382 
02383     <span class="comment">//</span>
02384     <span class="comment">// Insert the packet at the head of the IRP list for the thread.</span>
02385     <span class="comment">//</span>
02386 
02387     <a class="code" href="../../d0/d6/iop_8h.html#a21">IopQueueThreadIrp</a>( irp );
02388 
02389     <span class="comment">//</span>
02390     <span class="comment">// Now simply invoke the driver at its dispatch entry with the IRP.</span>
02391     <span class="comment">//</span>
02392 
02393     status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( deviceObject, irp );
02394 
02395     <span class="comment">//</span>
02396     <span class="comment">// Now get the final status of the operation once the request completes</span>
02397     <span class="comment">// and return the length of the buffer written.</span>
02398     <span class="comment">//</span>
02399 
02400     <span class="keywordflow">if</span> (status == STATUS_PENDING) {
02401         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
02402                                       Executive,
02403                                       KernelMode,
02404                                       FALSE,
02405                                       (PLARGE_INTEGER) NULL );
02406         status = localIoStatus.Status;
02407     }
02408 
02409     *ReturnedLength = (ULONG) localIoStatus.Information;
02410     <span class="keywordflow">return</span> status;
02411 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="internal.c::IopGetMountFlag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopGetMountFlag           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l02414">2414</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00042">IopVpbSpinLock</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01054">VPB_MOUNTED</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00037">NtQueryVolumeInformationFile()</a>.
<p>
<pre class="fragment"><div>02420                    :
02421 
02422     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to determine whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device
02423     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> mounted.
02424 
02425 Arguments:
02426 
02427     DeviceObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object <span class="keywordflow">for</span> which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mount
02428         flag <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> tested.
02429 
02430 Return Value:
02431 
02432     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> mounted, otherwise
02433     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
02434 
02435 
02436 --*/
02437 
02438 {
02439     KIRQL irql;
02440     BOOLEAN deviceMounted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02441 
02442     <span class="comment">//</span>
02443     <span class="comment">// Check to see whether or not the device is mounted.  Note that the caller</span>
02444     <span class="comment">// has probably already looked to see whether or not the device has a VPB</span>
02445     <span class="comment">// outside of owning the lock, so simply get the lock and check it again</span>
02446     <span class="comment">// to start with, rather than checking to see whether or not the device</span>
02447     <span class="comment">// still has a VPB without holding the lock.</span>
02448     <span class="comment">//</span>
02449 
02450     ExAcquireFastLock( &amp;IopVpbSpinLock, &amp;irql );
02451     <span class="keywordflow">if</span> (DeviceObject-&gt;Vpb) {
02452         <span class="keywordflow">if</span> (DeviceObject-&gt;Vpb-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a116">VPB_MOUNTED</a>) {
02453             deviceMounted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02454         }
02455     }
02456     ExReleaseFastLock( &amp;IopVpbSpinLock, irql );
02457 
02458     <span class="keywordflow">return</span> deviceMounted;
02459 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="internal.c::IopGetRegistryKeyInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopGetRegistryKeyInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PKEY_FULL_INFORMATION *&nbsp;</td>
          <td class="mdname" nowrap> <em>Information</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l02462">2462</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04140">IopUnregisterDeviceInterface()</a>, <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00223">pIoQueryBusDescription()</a>, and <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00565">pIoQueryDeviceDescription()</a>.
<p>
<pre class="fragment"><div>02469                    :
02470 
02471     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to retrieve <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full key information <span class="keywordflow">for</span> a
02472     registry key.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done by querying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full key information
02473     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key with a zero-length buffer to determine <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data,
02474     and then allocating a buffer and actually querying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
02475 
02476     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> responsibility of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller to free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
02477 
02478 Arguments:
02479 
02480     KeyHandle - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key handle whose full key information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to
02481         be queried
02482 
02483     Information - Returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated data buffer.
02484 
02485 Return Value:
02486 
02487     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query operation.
02488 
02489 --*/
02490 
02491 {
02492     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02493     PKEY_FULL_INFORMATION infoBuffer;
02494     ULONG keyInfoLength;
02495 
02496     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02497 
02498     <span class="comment">//</span>
02499     <span class="comment">// Figure out how big the data value is so that a buffer of the</span>
02500     <span class="comment">// appropriate size can be allocated.</span>
02501     <span class="comment">//</span>
02502 
02503     status = ZwQueryKey( KeyHandle,
02504                          KeyFullInformation,
02505                          (PVOID) NULL,
02506                          0,
02507                          &amp;keyInfoLength );
02508     <span class="keywordflow">if</span> (status != STATUS_BUFFER_OVERFLOW &amp;&amp;
02509         status != STATUS_BUFFER_TOO_SMALL) {
02510         <span class="keywordflow">return</span> status;
02511     }
02512 
02513     <span class="comment">//</span>
02514     <span class="comment">// Allocate a buffer large enough to contain the entire key data.</span>
02515     <span class="comment">//</span>
02516 
02517     infoBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( NonPagedPool, keyInfoLength );
02518     <span class="keywordflow">if</span> (!infoBuffer) {
02519         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02520     }
02521 
02522     <span class="comment">//</span>
02523     <span class="comment">// Query the full key data for the key.</span>
02524     <span class="comment">//</span>
02525 
02526     status = ZwQueryKey( KeyHandle,
02527                          KeyFullInformation,
02528                          infoBuffer,
02529                          keyInfoLength,
02530                          &amp;keyInfoLength );
02531     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
02532         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( infoBuffer );
02533         <span class="keywordflow">return</span> status;
02534     }
02535 
02536     <span class="comment">//</span>
02537     <span class="comment">// Everything worked, so simply return the address of the allocated</span>
02538     <span class="comment">// buffer to the caller, who is now responsible for freeing it.</span>
02539     <span class="comment">//</span>
02540 
02541     *Information = infoBuffer;
02542     <span class="keywordflow">return</span> STATUS_SUCCESS;
02543 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="internal.c::IopGetRegistryValue" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopGetRegistryValue           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PKEY_VALUE_FULL_INFORMATION *&nbsp;</td>
          <td class="mdname" nowrap> <em>Information</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">2546</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00047">ValueName</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/pnpeisa_8c-source.html#l00201">EisaGetEisaDevicesResources()</a>, <a class="el" href="../../d8/d4/ioerr_8c-source.html#l01200">IoepGetErrCaseDB()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04946">IoGetDeviceInterfaceAlias()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00373">IoGetDeviceProperty()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00810">IoOpenDeviceRegistryKey()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00546">IopAppendStringToValueKey()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02209">IopApplyFunctionToServiceInstances()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l02525">IopCallDriverAddDevice()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03165">IopCallDriverAddDeviceQueryRoutine()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00978">IopCheckDependencies()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l09157">IopCopyBootLogRegistryToFile()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00091">IopCreateMadeupNode()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05453">IopDeleteLegacyKey()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03759">IopDeviceObjectFromDeviceInstance()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02779">IopDriverLoadingFailed()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01477">IopGetDeviceInstanceCsConfigFlags()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02707">IopGetDeviceInterfaces()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04081">IopGetDeviceResourcesFromRegistry()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01411">IopGetDriverDeviceList()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02072">IopGetDriverNameFromKeyNode()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04120">IopGetDriverTagPriority()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05334">IopGetGroupOrderIndex()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04610">IopGetRegistryDwordWithFallback()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04679">IopGetRegistrySecurityWithFallback()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02637">IopGetRegistryValues()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01591">IopGetServiceInstanceCsConfigFlags()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l01454">IopGetServiceType()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03146">IopInitializeSystemDrivers()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03181">IopIsAnyDeviceInstanceEnabled()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03443">IopIsDeviceInstanceEnabled()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l01572">IopIsFirmwareMapperDevicePresent()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02286">IopIsReportedAlready()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00753">IopPrepareDriverLoading()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04000">IopProcessCriticalDeviceRoutine()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09922">IopProcessSetInterfaceState()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04283">IopReadDeviceConfiguration()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04379">IopReadDumpRegistry()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04414">IopRemoveDeviceInterfaces()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00449">IopRemoveStringFromValueKey()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00931">IopServiceInstanceToDeviceInstance()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08959">IopSetSecurityObjectFromRegistry()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04140">IopUnregisterDeviceInterface()</a>, <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l00788">PnPCheckFixedIoOverrideDecodes()</a>, and <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l00759">PnPGetDevnodeExcludeList()</a>.
<p>
<pre class="fragment"><div>02554                    :
02555 
02556     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to retrieve <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data <span class="keywordflow">for</span> a registry key's value.
02557     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done by querying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key with a zero-length buffer
02558     to determine <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value, and then allocating a buffer and
02559     actually querying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
02560 
02561     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> responsibility of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller to free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
02562 
02563 Arguments:
02564 
02565     KeyHandle - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key handle whose value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be queried
02566 
02567     <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> null-terminated <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value.
02568 
02569     Information - Returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated data buffer.
02570 
02571 Return Value:
02572 
02573     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query operation.
02574 
02575 --*/
02576 
02577 {
02578     UNICODE_STRING unicodeString;
02579     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02580     PKEY_VALUE_FULL_INFORMATION infoBuffer;
02581     ULONG keyValueLength;
02582 
02583     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02584 
02585     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;unicodeString, ValueName );
02586 
02587     <span class="comment">//</span>
02588     <span class="comment">// Figure out how big the data value is so that a buffer of the</span>
02589     <span class="comment">// appropriate size can be allocated.</span>
02590     <span class="comment">//</span>
02591 
02592     status = ZwQueryValueKey( KeyHandle,
02593                               &amp;unicodeString,
02594                               KeyValueFullInformation,
02595                               (PVOID) NULL,
02596                               0,
02597                               &amp;keyValueLength );
02598     <span class="keywordflow">if</span> (status != STATUS_BUFFER_OVERFLOW &amp;&amp;
02599         status != STATUS_BUFFER_TOO_SMALL) {
02600         <span class="keywordflow">return</span> status;
02601     }
02602 
02603     <span class="comment">//</span>
02604     <span class="comment">// Allocate a buffer large enough to contain the entire key data value.</span>
02605     <span class="comment">//</span>
02606 
02607     infoBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( NonPagedPool, keyValueLength );
02608     <span class="keywordflow">if</span> (!infoBuffer) {
02609         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02610     }
02611 
02612     <span class="comment">//</span>
02613     <span class="comment">// Query the data for the key value.</span>
02614     <span class="comment">//</span>
02615 
02616     status = ZwQueryValueKey( KeyHandle,
02617                               &amp;unicodeString,
02618                               KeyValueFullInformation,
02619                               infoBuffer,
02620                               keyValueLength,
02621                               &amp;keyValueLength );
02622     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
02623         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( infoBuffer );
02624         <span class="keywordflow">return</span> status;
02625     }
02626 
02627     <span class="comment">//</span>
02628     <span class="comment">// Everything worked, so simply return the address of the allocated</span>
02629     <span class="comment">// buffer to the caller, who is now responsible for freeing it.</span>
02630     <span class="comment">//</span>
02631 
02632     *Information = infoBuffer;
02633     <span class="keywordflow">return</span> STATUS_SUCCESS;
02634 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a41" doxytag="internal.c::IopGetRegistryValues" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopGetRegistryValues           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKEY_VALUE_FULL_INFORMATION *&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueList</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l02637">2637</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00223">pIoQueryBusDescription()</a>, and <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00565">pIoQueryDeviceDescription()</a>.
<p>
<pre class="fragment"><div>02644                    :
02645 
02646     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to retrieve <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> *three* types of data <span class="keywordflow">for</span> a
02647     registry key's.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done by calling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d4/internal_8c.html#a40">IopGetRegistryValue</a> function
02648     with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> three valid key names.
02649 
02650     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> responsibility of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller to free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> three buffers.
02651 
02652 Arguments:
02653 
02654     KeyHandle - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key handle whose value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be queried
02655 
02656     ValueList - Pointer to a buffer in which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> three pointers to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value
02657         entries will be stored.
02658 
02659 Return Value:
02660 
02661     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query operation.
02662 
02663 Note:
02664 
02665     The values are stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> order represented by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O query device
02666     data <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>.
02667 
02668 --*/
02669 
02670 {
02671     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02672 
02673     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02674 
02675     <span class="comment">//</span>
02676     <span class="comment">// Zero out all entries initially.</span>
02677     <span class="comment">//</span>
02678 
02679     *ValueList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02680     *(ValueList + 1) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02681     *(ValueList + 2) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02682 
02683     <span class="comment">//</span>
02684     <span class="comment">// Get the information for each of the three types of entries available.</span>
02685     <span class="comment">// Each time, check if an internal error occurred; If the object name was</span>
02686     <span class="comment">// not found, it only means not data was present, and this does not</span>
02687     <span class="comment">// constitute an error.</span>
02688     <span class="comment">//</span>
02689 
02690     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( KeyHandle,
02691                                   L<span class="stringliteral">"Identifier"</span>,
02692                                   ValueList );
02693 
02694     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) &amp;&amp; (status != STATUS_OBJECT_NAME_NOT_FOUND)) {
02695         <span class="keywordflow">return</span> status;
02696     }
02697 
02698     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( KeyHandle,
02699                                   L<span class="stringliteral">"Configuration Data"</span>,
02700                                   ++ValueList );
02701 
02702     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) &amp;&amp; (status != STATUS_OBJECT_NAME_NOT_FOUND)) {
02703         <span class="keywordflow">return</span> status;
02704     }
02705 
02706     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( KeyHandle,
02707                                   L<span class="stringliteral">"Component Information"</span>,
02708                                   ++ValueList );
02709 
02710     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) &amp;&amp; (status != STATUS_OBJECT_NAME_NOT_FOUND)) {
02711         <span class="keywordflow">return</span> status;
02712     }
02713 
02714     <span class="keywordflow">return</span> STATUS_SUCCESS;
02715 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a42" doxytag="internal.c::IopGetSetObjectId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopGetSetObjectId           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Function</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l02718">2718</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01552">IoBuildDeviceIoControlRequest()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00068">IRP_MJ_FILE_SYSTEM_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00117">IRP_MN_KERNEL_CALL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01552">IRP_SYNCHRONOUS_API</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01711">_IRP::UserBuffer</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l07272">IopTrackLink()</a>.
<p>
<pre class="fragment"><div>02727                    :
02728 
02729     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to obtain or set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> <span class="keywordflow">for</span> a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  If
02730     one does not exist <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>, then one <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> created, provided that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02731     underlying <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system supports object IDs in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first place (query).
02732 
02733 Arguments:
02734 
02735     FileObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> referenced <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object whose <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02736         to be returned or set.
02737 
02738     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a9">file</a> (query) or that
02739         contains the object ID that is to be set on the file.
02740 
02741     Length - The length of the Buffer.
02742 
02743     Function - The FSCTL to send.
02744         FSCTL_LMR_GET_LINK_TRACKING_INFORMATION;
02745         FSCTL_CREATE_OR_GET_OBJECT_ID;
02746         FSCTL_GET_OBJECT_ID;
02747         FSCTL_SET_OBJECT_ID_EXTENDED;
02748         FSCTL_LMR_SET_LINK_TRACKING_INFORMATION;
02749         FSCTL_SET_OBJECT_ID_EXTENDED;
02750         FSCTL_SET_OBJECT_ID;
02751         FSCTL_DELETE_OBJECT_ID;
02752 
02753 Return Value:
02754 
02755     The status returned is the final completion status of the operation.
02756 
02757 --*/
02758 
02759 {
02760     IO_STATUS_BLOCK ioStatus;
02761     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02762     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
02763     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
02764     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
02765     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
02766 
02767     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02768 
02769     <span class="comment">//</span>
02770     <span class="comment">// Initialize the event structure to synchronize completion of the I/O</span>
02771     <span class="comment">// request.</span>
02772     <span class="comment">//</span>
02773 
02774     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event,
02775                        NotificationEvent,
02776                        FALSE );
02777 
02778     <span class="comment">//</span>
02779     <span class="comment">// Build an I/O Request Packet to be sent to the file system driver to get</span>
02780     <span class="comment">// the object ID.</span>
02781     <span class="comment">//</span>
02782 
02783     deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject );
02784 
02785     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a25">IoBuildDeviceIoControlRequest</a>( Function,
02786                                          deviceObject,
02787                                          NULL,
02788                                          0,
02789                                          NULL,
02790                                          0,
02791                                          FALSE,
02792                                          &amp;event,
02793                                          &amp;ioStatus );
02794     <span class="keywordflow">if</span> (!irp) {
02795         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02796     }
02797 
02798     <span class="comment">//</span>
02799     <span class="comment">// Fill in the remainder of the IRP to retrieve the object ID for the</span>
02800     <span class="comment">// file.</span>
02801     <span class="comment">//</span>
02802 
02803     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a>;
02804     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o26">UserBuffer</a> = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
02805     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
02806     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = FileObject;
02807 
02808     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
02809     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = FileObject;
02810     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a26">IRP_MJ_FILE_SYSTEM_CONTROL</a>;
02811     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a51">IRP_MN_KERNEL_CALL</a>;
02812 
02813     <span class="keywordflow">if</span> (Function == FSCTL_LMR_GET_LINK_TRACKING_INFORMATION ||
02814         Function == FSCTL_CREATE_OR_GET_OBJECT_ID ||
02815         Function == FSCTL_GET_OBJECT_ID ) {
02816         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.FileSystemControl.OutputBufferLength = Length;
02817     } <span class="keywordflow">else</span> {
02818         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.FileSystemControl.InputBufferLength = Length;
02819     }
02820 
02821     <span class="comment">//</span>
02822     <span class="comment">// Take out another reference to the file object to guarantee that it does</span>
02823     <span class="comment">// not get deleted.</span>
02824     <span class="comment">//</span>
02825 
02826     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( FileObject );
02827 
02828     <span class="comment">//</span>
02829     <span class="comment">// Call the driver to get the request.</span>
02830     <span class="comment">//</span>
02831 
02832     status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( deviceObject, irp );
02833 
02834     <span class="comment">//</span>
02835     <span class="comment">// Synchronize completion of the request.</span>
02836     <span class="comment">//</span>
02837 
02838     <span class="keywordflow">if</span> (status == STATUS_PENDING) {
02839         status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
02840                                         Executive,
02841                                         KernelMode,
02842                                         FALSE,
02843                                         (PLARGE_INTEGER) NULL );
02844         status = ioStatus.Status;
02845     }
02846 
02847     <span class="keywordflow">return</span> status;
02848 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a43" doxytag="internal.c::IopGetVolumeId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopGetVolumeId           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d2/d4/internal_8c.html#a6">PFILE_VOLUMEID_WITH_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l02851">2851</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01552">IoBuildDeviceIoControlRequest()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00065">IRP_MJ_QUERY_VOLUME_INFORMATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01552">IRP_SYNCHRONOUS_API</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01711">_IRP::UserBuffer</a>.
<p>
<pre class="fragment"><div>02859                    :
02860 
02861     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O System link tracking code to obtain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02862     volume <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> <span class="keywordflow">for</span> a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> that has been <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a100">moved</a> or <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a100">moved</a> between volumes
02863     and potentially between systems.
02864 
02865 Arguments:
02866 
02867     FileObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
02868 
02869     ObjectId - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> buffer to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume object <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>.
02870 
02871     Length - Length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
02872 
02873 Return Value:
02874 
02875     The <span class="keyword">final</span> function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> completion status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
02876 
02877 --*/
02878 
02879 {
02880     IO_STATUS_BLOCK ioStatus;
02881     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02882     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
02883     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
02884     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
02885     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
02886     FILE_FS_OBJECTID_INFORMATION volumeId;
02887 
02888     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02889 
02890     <span class="comment">//</span>
02891     <span class="comment">// Initialize the event structure to synchronize completion of the I/O</span>
02892     <span class="comment">// request.</span>
02893     <span class="comment">//</span>
02894 
02895     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event,
02896                        NotificationEvent,
02897                        FALSE );
02898 
02899     <span class="comment">//</span>
02900     <span class="comment">// Build an I/O Request Packet to be sent to the file system driver to get</span>
02901     <span class="comment">// the volume ID.</span>
02902     <span class="comment">//</span>
02903 
02904     deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject );
02905 
02906     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a25">IoBuildDeviceIoControlRequest</a>( 0,
02907                                          deviceObject,
02908                                          NULL,
02909                                          0,
02910                                          NULL,
02911                                          0,
02912                                          FALSE,
02913                                          &amp;event,
02914                                          &amp;ioStatus );
02915     <span class="keywordflow">if</span> (!irp) {
02916         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02917     }
02918 
02919     <span class="comment">//</span>
02920     <span class="comment">// Fill in the remainder of the IRP to retrieve the volume ID for the</span>
02921     <span class="comment">// file.</span>
02922     <span class="comment">//</span>
02923 
02924     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a>;
02925     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o26">UserBuffer</a> = &amp;volumeId;
02926     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer = &amp;volumeId;
02927     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = FileObject;
02928 
02929     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
02930     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = FileObject;
02931     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a23">IRP_MJ_QUERY_VOLUME_INFORMATION</a>;
02932     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryVolume.Length = <span class="keyword">sizeof</span>( volumeId );
02933     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryVolume.FsInformationClass = FileFsObjectIdInformation;
02934 
02935     <span class="comment">//</span>
02936     <span class="comment">// Take out another reference to the file object to guarantee that it does</span>
02937     <span class="comment">// not get deleted.</span>
02938     <span class="comment">//</span>
02939 
02940     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( FileObject );
02941 
02942     <span class="comment">//</span>
02943     <span class="comment">// Call the driver to get the request.</span>
02944     <span class="comment">//</span>
02945 
02946     status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( deviceObject, irp );
02947 
02948     <span class="comment">//</span>
02949     <span class="comment">// Synchronize completion of the request.</span>
02950     <span class="comment">//</span>
02951 
02952     <span class="keywordflow">if</span> (status == STATUS_PENDING) {
02953         status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
02954                                         Executive,
02955                                         KernelMode,
02956                                         FALSE,
02957                                         (PLARGE_INTEGER) NULL );
02958         status = ioStatus.Status;
02959     }
02960 
02961     <span class="comment">//</span>
02962     <span class="comment">// If the file system returned the volume ID, copy it to the caller's</span>
02963     <span class="comment">// buffer and set the file system tracking type.</span>
02964     <span class="comment">//</span>
02965 
02966     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
02967         ObjectId-&gt;Type = NtfsLinkTrackingInformation;
02968         RtlCopyMemory( ObjectId-&gt;VolumeId,
02969                        &amp;volumeId.ObjectId,
02970                        <span class="keyword">sizeof</span>( GUID ) );
02971     }
02972 
02973     <span class="keywordflow">return</span> status;
02974 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a44" doxytag="internal.c::IopHardErrorThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopHardErrorThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>StartContext</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l02977">2977</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d7/ex_2harderr_8c-source.html#l00700">ExRaiseHardError()</a>, <a class="el" href="../../d7/d7/ex_2harderr_8c-source.html#l00058">ExReadyForErrors</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d6/iop_8h.html#a31">IOP_HARD_ERROR_PACKET</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00210">IopCurrentHardError</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00203">IopHardError</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d6/iop_8h.html#a32">PIOP_HARD_ERROR_PACKET</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00108">_IOP_HARD_ERROR_QUEUE::ThreadStarted</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00105">_IOP_HARD_ERROR_QUEUE::WorkQueue</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00107">_IOP_HARD_ERROR_QUEUE::WorkQueueSemaphore</a>, and <a class="el" href="../../d1/d5/iop_8h-source.html#l00106">_IOP_HARD_ERROR_QUEUE::WorkQueueSpinLock</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>.
<p>
<pre class="fragment"><div>02983                    :
02984 
02985     This function waits <span class="keywordflow">for</span> work on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IopHardErrorQueue, and all calls
02986     <a class="code" href="../../d2/d4/internal_8c.html#a60">IopRaiseInformationalHardError</a> to actually perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pop-ups.
02987 
02988 Arguments:
02989 
02990     StartContext - Startup context; not used.
02991 
02992 Return Value:
02993 
02994     None.
02995 
02996 --*/
02997 
02998 {
02999     KIRQL oldIrql;
03000     PVOID entry;
03001     ULONG parameterPresent;
03002     ULONG_PTR errorParameter;
03003     ULONG errorResponse;
03004     BOOLEAN MoreEntries;
03005     <a class="code" href="../../d7/d0/struct__IOP__HARD__ERROR__PACKET.html">PIOP_HARD_ERROR_PACKET</a> hardErrorPacket;
03006 
03007     UNREFERENCED_PARAMETER( StartContext );
03008 
03009     <span class="comment">//</span>
03010     <span class="comment">// Loop, waiting forever for a hard error packet to be sent to this thread.</span>
03011     <span class="comment">// When one is placed onto the queue, wake up, process it, and continue</span>
03012     <span class="comment">// the loop.</span>
03013     <span class="comment">//</span>
03014 
03015     MoreEntries = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03016 
03017     <span class="keywordflow">do</span> {
03018 
03019         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a25">IopHardError</a>.<a class="code" href="../../d8/d0/struct__IOP__HARD__ERROR__QUEUE.html#o3">WorkQueueSemaphore</a>,
03020                                       Executive,
03021                                       KernelMode,
03022                                       FALSE,
03023                                       (PLARGE_INTEGER) NULL );
03024 
03025         ExAcquireFastLock( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a25">IopHardError</a>.<a class="code" href="../../d8/d0/struct__IOP__HARD__ERROR__QUEUE.html#o2">WorkQueueSpinLock</a>, &amp;oldIrql );
03026 
03027         <span class="comment">//</span>
03028         <span class="comment">// The work queue structures are now exclusively owned, so remove the</span>
03029         <span class="comment">// first packet from the head of the list.</span>
03030         <span class="comment">//</span>
03031 
03032         entry = RemoveHeadList( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a25">IopHardError</a>.<a class="code" href="../../d8/d0/struct__IOP__HARD__ERROR__QUEUE.html#o1">WorkQueue</a> );
03033 
03034         hardErrorPacket = CONTAINING_RECORD( entry,
03035                                              <a class="code" href="../../d7/d0/struct__IOP__HARD__ERROR__PACKET.html">IOP_HARD_ERROR_PACKET</a>,
03036                                              WorkQueueLinks );
03037 
03038         <a class="code" href="../../d3/d5/iodata_8c.html#a26">IopCurrentHardError</a> = hardErrorPacket;
03039 
03040         ExReleaseFastLock( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a25">IopHardError</a>.<a class="code" href="../../d8/d0/struct__IOP__HARD__ERROR__QUEUE.html#o2">WorkQueueSpinLock</a>, oldIrql );
03041 
03042         <span class="comment">//</span>
03043         <span class="comment">// Simply raise the hard error if the system is ready to accept one.</span>
03044         <span class="comment">//</span>
03045 
03046         errorParameter = (ULONG_PTR) &amp;hardErrorPacket-&gt;String;
03047         parameterPresent = (hardErrorPacket-&gt;String.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03048 
03049         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/ex_2harderr_8c.html#a5">ExReadyForErrors</a>) {
03050             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d5/d8/ex_8h.html#a306">ExRaiseHardError</a>( hardErrorPacket-&gt;ErrorStatus,
03051                                      parameterPresent,
03052                                      parameterPresent,
03053                                      parameterPresent ? &amp;errorParameter : NULL,
03054                                      OptionOk,
03055                                      &amp;errorResponse );
03056         }
03057 
03058         <span class="comment">//</span>
03059         <span class="comment">//  If this was the last entry, exit the thread and mark it as so.</span>
03060         <span class="comment">//</span>
03061 
03062         ExAcquireFastLock( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a25">IopHardError</a>.<a class="code" href="../../d8/d0/struct__IOP__HARD__ERROR__QUEUE.html#o2">WorkQueueSpinLock</a>, &amp;oldIrql );
03063 
03064         <a class="code" href="../../d3/d5/iodata_8c.html#a26">IopCurrentHardError</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03065 
03066         <span class="keywordflow">if</span> ( IsListEmpty( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a25">IopHardError</a>.<a class="code" href="../../d8/d0/struct__IOP__HARD__ERROR__QUEUE.html#o1">WorkQueue</a> ) ) {
03067             <a class="code" href="../../d3/d5/iodata_8c.html#a25">IopHardError</a>.<a class="code" href="../../d8/d0/struct__IOP__HARD__ERROR__QUEUE.html#o4">ThreadStarted</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03068             MoreEntries = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03069         }
03070 
03071         ExReleaseFastLock( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a25">IopHardError</a>.<a class="code" href="../../d8/d0/struct__IOP__HARD__ERROR__QUEUE.html#o2">WorkQueueSpinLock</a>, oldIrql );
03072 
03073         <span class="comment">//</span>
03074         <span class="comment">// Now free the packet and the buffer, if one was specified.</span>
03075         <span class="comment">//</span>
03076 
03077         <span class="keywordflow">if</span> (hardErrorPacket-&gt;String.Buffer) {
03078             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( hardErrorPacket-&gt;String.Buffer );
03079         }
03080 
03081         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( hardErrorPacket );
03082 
03083     } <span class="keywordflow">while</span> ( MoreEntries );
03084 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a74" doxytag="internal.c::IopInitializeBootLogging" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopInitializeBootLogging           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LoaderBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>HeaderString</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l08928">8928</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d0/d5/io_8h.html#a400">BOOT_LOG_RECORD</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l08925">BootLogRecord</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02473">ExInitializeResource</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04647">_BOOT_LOG_RECORD::HeaderString</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l09046">IopBootLog()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04644">_BOOT_LOG_RECORD::LoadedString</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01844">_LOADER_PARAMETER_BLOCK::LoadOrderListHead</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04645">_BOOT_LOG_RECORD::NotLoadedString</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00582">PsLoadedModuleList</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00583">PsLoadedModuleResource</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04648">_BOOT_LOG_RECORD::Resource</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00544">RtlCreateUnicodeStringFromAsciiz()</a>, <a class="el" href="../../d1/d7/message_8c-source.html#l00030">RtlFindMessage()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d7/regtest_8c.html#a2">strlen()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>08934                    :
08935 
08936     Initializes strings <span class="keywordflow">for</span> boot logging.
08937 
08938 Arguments:
08939 
08940     LoaderBlock - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loader parameter block
08941 
08942 Return Value:
08943 
08944     <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
08945 
08946 --*/
08947 {
08948     PLDR_DATA_TABLE_ENTRY DataTableEntry;
08949     PMESSAGE_RESOURCE_ENTRY MessageEntry;
08950     ULONG MsgId = 0;
08951     ANSI_STRING AnsiString;
08952     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
08953     PLIST_ENTRY nextEntry;
08954     PLDR_DATA_TABLE_ENTRY driverEntry;
08955 
08956 
08957     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
08958 
08959     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4/internal_8c.html#a12">BootLogRecord</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08960         <span class="keywordflow">return</span>;
08961     }
08962 
08963     <a class="code" href="../../d2/d4/internal_8c.html#a12">BootLogRecord</a> = (<a class="code" href="../../d6/d4/struct__BOOT__LOG__RECORD.html">PBOOT_LOG_RECORD</a>) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(NonPagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__BOOT__LOG__RECORD.html">BOOT_LOG_RECORD</a>));
08964 
08965     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4/internal_8c.html#a12">BootLogRecord</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08966         <span class="keywordflow">return</span>;
08967     }
08968 
08969     RtlZeroMemory(BootLogRecord, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__BOOT__LOG__RECORD.html">BOOT_LOG_RECORD</a>));
08970 
08971     <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a>(&amp;<a class="code" href="../../d2/d4/internal_8c.html#a12">BootLogRecord</a>-&gt;<a class="code" href="../../d6/d4/struct__BOOT__LOG__RECORD.html#o4">Resource</a>);
08972 
08973     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;<a class="code" href="../../d2/d4/internal_8c.html#a12">BootLogRecord</a>-&gt;<a class="code" href="../../d6/d4/struct__BOOT__LOG__RECORD.html#o4">Resource</a>, TRUE);
08974 
08975     DataTableEntry = CONTAINING_RECORD(LoaderBlock-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o0">LoadOrderListHead</a>.Flink,
08976                                         LDR_DATA_TABLE_ENTRY,
08977                                         InLoadOrderLinks);
08978 
08979     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/message_8c.html#a1">RtlFindMessage</a> (DataTableEntry-&gt;DllBase, 11, 0, BOOTLOG_LOADED, &amp;MessageEntry);
08980 
08981     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
08982         AnsiString.Buffer = MessageEntry-&gt;Text;
08983         AnsiString.Length = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(MessageEntry-&gt;Text);
08984         AnsiString.MaximumLength = AnsiString.Length + 1;
08985 
08986         <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;<a class="code" href="../../d2/d4/internal_8c.html#a12">BootLogRecord</a>-&gt;<a class="code" href="../../d6/d4/struct__BOOT__LOG__RECORD.html#o0">LoadedString</a>, &amp;AnsiString, TRUE);
08987 
08988         <span class="comment">// whack the crlf at the end of the string</span>
08989 
08990         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4/internal_8c.html#a12">BootLogRecord</a>-&gt;<a class="code" href="../../d6/d4/struct__BOOT__LOG__RECORD.html#o0">LoadedString</a>.Length &gt; 2 * <span class="keyword">sizeof</span>(WCHAR)) {
08991             <a class="code" href="../../d2/d4/internal_8c.html#a12">BootLogRecord</a>-&gt;<a class="code" href="../../d6/d4/struct__BOOT__LOG__RECORD.html#o0">LoadedString</a>.Length -= 2 * <span class="keyword">sizeof</span>(WCHAR);
08992             <a class="code" href="../../d2/d4/internal_8c.html#a12">BootLogRecord</a>-&gt;<a class="code" href="../../d6/d4/struct__BOOT__LOG__RECORD.html#o0">LoadedString</a>.Buffer[<a class="code" href="../../d2/d4/internal_8c.html#a12">BootLogRecord</a>-&gt;<a class="code" href="../../d6/d4/struct__BOOT__LOG__RECORD.html#o0">LoadedString</a>.Length / <span class="keyword">sizeof</span>(WCHAR)] = UNICODE_NULL;
08993         }
08994     }
08995 
08996     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/message_8c.html#a1">RtlFindMessage</a> (DataTableEntry-&gt;DllBase, 11, 0, BOOTLOG_NOT_LOADED, &amp;MessageEntry);
08997 
08998     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
08999         AnsiString.Buffer = MessageEntry-&gt;Text;
09000         AnsiString.Length = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(MessageEntry-&gt;Text);
09001         AnsiString.MaximumLength = AnsiString.Length + 1;
09002 
09003         <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;<a class="code" href="../../d2/d4/internal_8c.html#a12">BootLogRecord</a>-&gt;<a class="code" href="../../d6/d4/struct__BOOT__LOG__RECORD.html#o1">NotLoadedString</a>, &amp;AnsiString, TRUE);
09004 
09005         <span class="comment">// whack the crlf at the end of the string</span>
09006 
09007         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4/internal_8c.html#a12">BootLogRecord</a>-&gt;<a class="code" href="../../d6/d4/struct__BOOT__LOG__RECORD.html#o1">NotLoadedString</a>.Length &gt; 2 * <span class="keyword">sizeof</span>(WCHAR)) {
09008             <a class="code" href="../../d2/d4/internal_8c.html#a12">BootLogRecord</a>-&gt;<a class="code" href="../../d6/d4/struct__BOOT__LOG__RECORD.html#o1">NotLoadedString</a>.Length -= 2 * <span class="keyword">sizeof</span>(WCHAR);
09009             <a class="code" href="../../d2/d4/internal_8c.html#a12">BootLogRecord</a>-&gt;<a class="code" href="../../d6/d4/struct__BOOT__LOG__RECORD.html#o1">NotLoadedString</a>.Buffer[<a class="code" href="../../d2/d4/internal_8c.html#a12">BootLogRecord</a>-&gt;<a class="code" href="../../d6/d4/struct__BOOT__LOG__RECORD.html#o1">NotLoadedString</a>.Length / <span class="keyword">sizeof</span>(WCHAR)] = UNICODE_NULL;
09010         }
09011     }
09012 
09013     <span class="comment">// The header string (copied from DebugString in Phase1Initialization) appears to have a leading null byte</span>
09014 
09015     HeaderString++;
09016 
09017     <a class="code" href="../../d2/d7/string_8c.html#a13">RtlCreateUnicodeStringFromAsciiz</a>(&amp;<a class="code" href="../../d2/d4/internal_8c.html#a12">BootLogRecord</a>-&gt;<a class="code" href="../../d6/d4/struct__BOOT__LOG__RECORD.html#o3">HeaderString</a>, HeaderString);
09018 
09019     <span class="comment">// Log the drivers loaded by the boot loader</span>
09020 
09021     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( &amp;PsLoadedModuleResource, TRUE );
09022     nextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
09023     <span class="keywordflow">while</span> (nextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
09024 
09025         <span class="comment">//</span>
09026         <span class="comment">// Look at the next boot driver in the list.</span>
09027         <span class="comment">//</span>
09028 
09029         driverEntry = CONTAINING_RECORD( nextEntry,
09030                                          LDR_DATA_TABLE_ENTRY,
09031                                          InLoadOrderLinks );
09032 
09033         <span class="keywordflow">if</span> (driverEntry-&gt;Flags &amp; LDRP_ENTRY_PROCESSED){
09034             <a class="code" href="../../d2/d4/internal_8c.html#a75">IopBootLog</a>(&amp;driverEntry-&gt;FullDllName, TRUE);
09035         }
09036 
09037         nextEntry = nextEntry-&gt;Flink;
09038     }
09039 
09040     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( &amp;PsLoadedModuleResource );
09041 
09042     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d2/d4/internal_8c.html#a12">BootLogRecord</a>-&gt;<a class="code" href="../../d6/d4/struct__BOOT__LOG__RECORD.html#o4">Resource</a>);
09043 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a54" doxytag="internal.c::IopInvalidateVolumesForDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopInvalidateVolumesForDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l04710">4710</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01181">_DEVICE_OBJECT::AttachedDevice</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01552">IoBuildDeviceIoControlRequest()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05535">IoCreateStreamFileObjectLite()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00044">IoFileObjectType</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00094">IopCdRomFileSystemQueueHead</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00065">IopDatabaseResource</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00084">IopDiskFileSystemQueueHead</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00114">IopTapeFileSystemQueueHead</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00068">IRP_MJ_FILE_SYSTEM_CONTROL</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00367">ObOpenObjectByPointer()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01518">_FILE_OBJECT::Vpb</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01186">_DEVICE_OBJECT::Vpb</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00927">IopRemoveDevice()</a>.
<p>
<pre class="fragment"><div>04716                    :
04717 
04718     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to force filesystems to, as completely as possible, <span class="keywordflow">throw</span>
04719     <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> volumes which remain referenced <span class="keywordflow">for</span> a given device.
04720     
04721 Arguments:
04722 
04723     DeviceObject - Pointer to device object <span class="keywordflow">for</span> which volumes are to be
04724         invalidated.
04725 
04726 Return Value:
04727 
04728     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a successful status code <span class="keywordflow">if</span> all filesystems accepted <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04729     operation.  Otherwise, an error code <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
04730 
04731 --*/
04732 
04733 {
04734     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04735     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> finalStatus;
04736     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
04737     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
04738     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> fsDeviceObject;
04739     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> attachedDevice;
04740     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> storageFileObject;
04741     HANDLE storageHandle;
04742     PLIST_ENTRY entry;
04743     PLIST_ENTRY queueHeader;
04744     IO_STATUS_BLOCK ioStatus;
04745     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
04746 
04747     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04748 
04749     <span class="comment">//</span>
04750     <span class="comment">// Now acquire the resource database lock for the I/O system to perform this</span>
04751     <span class="comment">// operation.  This resource protects access to the file system queue.</span>
04752     <span class="comment">//</span>
04753     
04754     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
04755     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( &amp;IopDatabaseResource, TRUE );
04756 
04757     <span class="comment">//</span>
04758     <span class="comment">// Get the actual device that would be mounted on.  This device is the final</span>
04759     <span class="comment">// device in the list of devices which are attached to the specified real device.</span>
04760     <span class="comment">//</span>
04761 
04762     attachedDevice = DeviceObject;
04763     <span class="keywordflow">while</span> (attachedDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>) {
04764         attachedDevice = attachedDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>;
04765     }
04766 
04767     <span class="comment">//</span>
04768     <span class="comment">// Get a handle to this device for use in the fsctl.  The way we have to do</span>
04769     <span class="comment">// this is kind of loopy: note we wind up with two references to clean up.</span>
04770     <span class="comment">//</span>
04771     <span class="comment">// The only use of this fileobject/handle is to communicate the device to</span>
04772     <span class="comment">// invalidate volumes on.  It isn't used for anything else, and must not be.</span>
04773     <span class="comment">//</span>
04774 
04775     <span class="keywordflow">try</span> {
04776 
04777         storageFileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04778         storageFileObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a49">IoCreateStreamFileObjectLite</a>( NULL, attachedDevice );
04779         storageFileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o3">Vpb</a> = attachedDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o10">Vpb</a>;
04780         
04781         storageHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04782         status = <a class="code" href="../../d7/d1/obref_8c.html#a3">ObOpenObjectByPointer</a>( storageFileObject,
04783                                         OBJ_KERNEL_HANDLE,
04784                                         NULL,
04785                                         0,
04786                                         IoFileObjectType,
04787                                         KernelMode,
04788                                         &amp;storageHandle );
04789 
04790     } except(EXCEPTION_EXECUTE_HANDLER) {
04791           
04792         status = GetExceptionCode();
04793     }
04794     
04795     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04796         
04797         <span class="comment">//</span>
04798         <span class="comment">// Determine which type of file system should be invoked based on</span>
04799         <span class="comment">// the device type of the device being invalidated.</span>
04800         <span class="comment">//</span>
04801 
04802         <span class="keywordflow">if</span> (DeviceObject-&gt;DeviceType == FILE_DEVICE_DISK ||
04803             DeviceObject-&gt;DeviceType == FILE_DEVICE_VIRTUAL_DISK) {
04804             queueHeader = &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a6">IopDiskFileSystemQueueHead</a>;
04805         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (DeviceObject-&gt;DeviceType == FILE_DEVICE_CD_ROM) {
04806             queueHeader = &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a7">IopCdRomFileSystemQueueHead</a>;
04807         } <span class="keywordflow">else</span> {
04808             queueHeader = &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a9">IopTapeFileSystemQueueHead</a>;
04809         }
04810 
04811         <span class="comment">//</span>
04812         <span class="comment">// Initialize the event and set the status to set up</span>
04813         <span class="comment">// for the loop.</span>
04814         <span class="comment">//</span>
04815 
04816         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event, NotificationEvent, FALSE );
04817         finalStatus = STATUS_SUCCESS;
04818 
04819         <span class="comment">//</span>
04820         <span class="comment">// Now loop through each of the file systems which have been loaded in</span>
04821         <span class="comment">// the system and ask them to invalidate volumes they have had mounted</span>
04822         <span class="comment">// on it.</span>
04823         <span class="comment">//</span>
04824 
04825         <span class="keywordflow">for</span> (entry = queueHeader-&gt;Flink;
04826              entry != queueHeader;
04827              entry = entry-&gt;Flink) {
04828 
04829             <span class="comment">//</span>
04830             <span class="comment">// If this is the final entry (Raw file system), then break out of the</span>
04831             <span class="comment">// loop at this point, as volumes cannot be invalidated for the caller's</span>
04832             <span class="comment">// purposes in Raw.</span>
04833             <span class="comment">//</span>
04834 
04835             <span class="keywordflow">if</span> (entry-&gt;Flink == queueHeader) {
04836                 <span class="keywordflow">break</span>;
04837             }
04838 
04839             fsDeviceObject = CONTAINING_RECORD( entry, <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">DEVICE_OBJECT</a>, Queue.ListEntry );
04840 
04841             <span class="comment">//</span>
04842             <span class="comment">// It is possible that the file system has been attached to, so</span>
04843             <span class="comment">// walk the attached list for the file system.</span>
04844             <span class="comment">//</span>
04845 
04846             <span class="keywordflow">while</span> (fsDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>) {
04847                 fsDeviceObject = fsDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>;
04848             }
04849 
04850             <span class="comment">//</span>
04851             <span class="comment">// Another file system has been found.  Attempt to invalidate volumes</span>
04852             <span class="comment">// using this file system.</span>
04853             <span class="comment">//</span>
04854             <span class="comment">// Begin by resetting the event being used for synchronization with</span>
04855             <span class="comment">// the I/O operation.</span>
04856             <span class="comment">//</span>
04857 
04858             <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>( &amp;event );
04859 
04860             <span class="comment">//</span>
04861             <span class="comment">// Build an IRP for this operation.</span>
04862             <span class="comment">//</span>
04863 
04864             irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a25">IoBuildDeviceIoControlRequest</a>( FSCTL_INVALIDATE_VOLUMES,
04865                                                  fsDeviceObject,
04866                                                  &amp;storageHandle,
04867                                                  <span class="keyword">sizeof</span>(HANDLE),
04868                                                  NULL,
04869                                                  0,
04870                                                  FALSE,
04871                                                  &amp;event,
04872                                                  &amp;ioStatus );
04873 
04874             <span class="keywordflow">if</span> (irp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04875 
04876                 finalStatus = STATUS_INSUFFICIENT_RESOURCES;
04877                 <span class="keywordflow">break</span>;
04878             }
04879 
04880             irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
04881             irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a26">IRP_MJ_FILE_SYSTEM_CONTROL</a>;
04882 
04883             status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( fsDeviceObject, irp );
04884 
04885             <span class="comment">//</span>
04886             <span class="comment">// Wait for the I/O operation to complete.</span>
04887             <span class="comment">//</span>
04888 
04889             <span class="keywordflow">if</span> (status == STATUS_PENDING) {
04890                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
04891                                               Executive,
04892                                               KernelMode,
04893                                               FALSE,
04894                                               (PLARGE_INTEGER) NULL );
04895 
04896                 status = ioStatus.Status;
04897 
04898             } <span class="keywordflow">else</span> {
04899                 
04900                 <span class="comment">//</span>
04901                 <span class="comment">// Ensure that the proper status value gets picked up.</span>
04902                 <span class="comment">//</span>
04903 
04904                 ioStatus.Status = status;
04905                 ioStatus.Information = 0;
04906             }
04907 
04908             <span class="comment">//</span>
04909             <span class="comment">// Commute status' indicating the operation is not implemented</span>
04910             <span class="comment">// to success.  If a filesystem does not implement, it must not</span>
04911             <span class="comment">// hold volumes that are not mounted.</span>
04912             <span class="comment">//</span>
04913 
04914             <span class="keywordflow">if</span> (status == STATUS_INVALID_DEVICE_REQUEST ||
04915                 status == STATUS_NOT_IMPLEMENTED) {
04916                 
04917                 status = STATUS_SUCCESS;
04918             }
04919 
04920             <span class="comment">//</span>
04921             <span class="comment">//  Hand back the first failure we get, but plow on anyway.</span>
04922             <span class="comment">//</span>
04923             
04924             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( finalStatus ) &amp;&amp; !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04925                 finalStatus = status;
04926             }
04927         }
04928 
04929         <span class="keywordflow">if</span> (storageFileObject) {
04930             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( storageFileObject );
04931             <span class="keywordflow">if</span> (storageHandle) {
04932                 ZwClose( storageHandle );
04933             }
04934         }
04935 
04936         status = finalStatus;
04937     }
04938 
04939     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( &amp;IopDatabaseResource );
04940     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
04941 
04942     <span class="keywordflow">return</span> status;
04943 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a45" doxytag="internal.c::IopInvalidDeviceRequest" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopInvalidDeviceRequest           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l03087">3087</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00056">IO_NO_INCREMENT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02960">IoCompleteRequest</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00077">IRP_MJ_POWER</a>, and <a class="el" href="../../d1/d2/po_8h.html#a79">PoStartNextPowerIrp()</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01071">IoCreateDriver()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>, and <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l00433">IovpAssertIrpStackDownward()</a>.
<p>
<pre class="fragment"><div>03094                    :
03095 
03096     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">default</span> dispatch routine <span class="keywordflow">for</span> all driver entries
03097     not implemented by drivers that have been loaded into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system.  Its
03098     responsibility <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> simply to set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> packet to indicate
03099     that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation requested <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invalid <span class="keywordflow">for</span> <span class="keyword">this</span> device <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>, and then
03100     complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> packet.
03101 
03102 Arguments:
03103 
03104     DeviceObject - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object <span class="keywordflow">for</span> which <span class="keyword">this</span> request <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
03105         bound.  Ignored by <span class="keyword">this</span> routine.
03106 
03107     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet (<a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>) for this
03108         request.
03109 
03110 Return Value:
03111 
03112     The final status is always STATUS_INVALID_DEVICE_REQUEST.
03113 
03114 
03115 --*/
03116 
03117 {
03118     UNREFERENCED_PARAMETER( DeviceObject );
03119 
03120     <span class="comment">//</span>
03121     <span class="comment">// Simply store the appropriate status, complete the request, and return</span>
03122     <span class="comment">// the same status stored in the packet.</span>
03123     <span class="comment">//</span>
03124 
03125     <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>(Irp))-&gt;MajorFunction == <a class="code" href="../../d0/d5/io_8h.html#a35">IRP_MJ_POWER</a>) {
03126         <a class="code" href="../../d1/d2/po_8h.html#a79">PoStartNextPowerIrp</a>(Irp);
03127     }
03128     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = STATUS_INVALID_DEVICE_REQUEST;
03129     <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>( Irp, IO_NO_INCREMENT );
03130     <span class="keywordflow">return</span> STATUS_INVALID_DEVICE_REQUEST;
03131 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a46" doxytag="internal.c::IopIsSameMachine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopIsSameMachine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceFile</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetFile</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l03134">3134</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01179">_DEVICE_OBJECT::DriverObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00952">_FAST_IO_DISPATCH::FastIoDeviceControl</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01403">_DRIVER_OBJECT::FastIoDispatch</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l07272">IopTrackLink()</a>.
<p>
<pre class="fragment"><div>03141                    :
03142 
03143     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to determine whether two <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> objects that represent
03144     files on remote machines actually reside on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same physical system.
03145 
03146 Arguments:
03147 
03148     SourceFile - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
03149 
03150     TargetFile - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
03151 
03152 Return Value:
03153 
03154     The <span class="keyword">final</span> function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> files reside on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same machine,
03155     otherwise <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
03156 
03157 --*/
03158 
03159 {
03160     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
03161     <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> fastIoDispatch;
03162     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_NOT_SAME_DEVICE;
03163     IO_STATUS_BLOCK ioStatus;
03164     HANDLE target = TargetFile;
03165 
03166     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03167 
03168     <span class="comment">//</span>
03169     <span class="comment">// Simply invoke the device I/O control function to determine whether or</span>
03170     <span class="comment">// not the two files are on the same server.  If the fast I/O path does</span>
03171     <span class="comment">// not exist, or the function fails for any reason, then the two files are</span>
03172     <span class="comment">// assumed to not be on the same machine.  Note that this simply means</span>
03173     <span class="comment">// that there will be a performance penalty on open of the target, but</span>
03174     <span class="comment">// the above will only fail if the two files really aren't on the same</span>
03175     <span class="comment">// machine in the first place, or if there's a filter that doesn't under-</span>
03176     <span class="comment">// stand what is being done here.</span>
03177     <span class="comment">//</span>
03178 
03179     deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( SourceFile );
03180 
03181     fastIoDispatch = deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>;
03182     <span class="keywordflow">if</span> (fastIoDispatch &amp;&amp; fastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o10">FastIoDeviceControl</a>) {
03183         <span class="keywordflow">if</span> (fastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o10">FastIoDeviceControl</a>( SourceFile,
03184                                                  TRUE,
03185                                                  (PVOID) &amp;target,
03186                                                  <span class="keyword">sizeof</span>( target ),
03187                                                  (PVOID) NULL,
03188                                                  0,
03189                                                  IOCTL_LMR_ARE_FILE_OBJECTS_ON_SAME_SERVER,
03190                                                  &amp;ioStatus,
03191                                                  deviceObject )) {
03192             status = ioStatus.Status;
03193         }
03194     }
03195 
03196     <span class="keywordflow">return</span> status == STATUS_SUCCESS;
03197 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a47" doxytag="internal.c::IopLoadDriver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopLoadDriver           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>CheckForSafeBoot</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">3200</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03778">CmBootLastKnownGood()</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00170">CmRegistryMachineHardwareDescriptionSystemName</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d0/d5/io_8h.html#a343">DRIVER_EXTENSION</a>, <a class="el" href="../../d0/d5/io_8h.html#a345">DRIVER_OBJECT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01300">DRVO_LEGACY_DRIVER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01303">DRVO_REINIT_REGISTERED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01299">DRVO_UNLOAD_INVOKED</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d0/init_8h-source.html#l00044">InitSafeBootMode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00038">IO_TYPE_DRIVER</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00236">IoDriverObjectType</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l09046">IopBootLog()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l05338">IopDeleteLegacyKey()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l02609">IopDriverLoadingFailed()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02072">IopGetDriverNameFromKeyNode()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03087">IopInvalidDeviceRequest()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03071">IopIsAnyDeviceInstanceEnabled()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l05177">IopIsLegacyDriver()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00753">IopPrepareDriverLoading()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05910">IopReadyDeviceObjects()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05951">IopResurrectDriver()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l08822">IopSafebootDriverLoad()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01740">IopStartDriverDevices()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00084">IRP_MJ_MAXIMUM_FUNCTION</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00153">KeQuerySystemTime()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02106">MmFreeDriverInitialization()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00315">MmLoadSystemImage()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02896">MmUnloadSystemImage()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02018">NtQueryKey()</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00058">NtQueryObject()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00055">ObCreateObject()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00484">ObMakeTemporaryObject()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00095">ObOpenObjectByName()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d5/io_8h.html#a344">PDRIVER_EXTENSION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00522">PDRIVER_INITIALIZE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02166">PERFINFO_DRIVER_INIT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02167">PERFINFO_DRIVER_INIT_COMPLETE</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00110">PnPInitialized</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00582">PsLoadedModuleList</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00583">PsLoadedModuleResource</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01883">RtlAppendUnicodeStringToString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01821">RtlAppendUnicodeToString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00399">RtlEqualString()</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03165">IopCallDriverAddDeviceQueryRoutine()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03146">IopInitializeSystemDrivers()</a>, and <a class="el" href="../../d3/d3/internal_8c-source.html#l04169">IopLoadUnloadDriver()</a>.
<p>
<pre class="fragment"><div>03207                    :
03208 
03209     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to load a device or <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system driver, either
03210     during system initialization, or dynamically <span class="keywordflow">while</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> running.
03211 
03212 Arguments:
03213 
03214     KeyHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver service node in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry
03215         that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver to be loaded.
03216 
03217 Return Value:
03218 
03219     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> load operation.
03220 
03221 Notes:
03222 
03223     Note that <span class="keyword">this</span> routine closes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> KeyHandle before returning.
03224 
03225 
03226 --*/
03227 
03228 {
03229     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03230     PLIST_ENTRY nextEntry;
03231     PLDR_DATA_TABLE_ENTRY driverEntry;
03232     PKEY_BASIC_INFORMATION keyBasicInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03233     PKEY_VALUE_FULL_INFORMATION keyValueInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03234     ULONG keyBasicLength;
03235     UNICODE_STRING baseName;
03236     UNICODE_STRING serviceName = {0, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>};
03237     OBJECT_ATTRIBUTES objectAttributes;
03238     PVOID sectionPointer;
03239     UNICODE_STRING driverName;
03240     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject;
03241     PIMAGE_NT_HEADERS ntHeaders;
03242     PVOID imageBaseAddress;
03243     ULONG_PTR entryPoint;
03244     HANDLE driverHandle;
03245     ULONG i;
03246     POBJECT_NAME_INFORMATION registryPath;
03247 <span class="preprocessor">#if DBG</span>
03248 <span class="preprocessor"></span>    LARGE_INTEGER stime, etime;
03249     ULONG dtime;
03250 <span class="preprocessor">#endif</span>
03251 <span class="preprocessor"></span>
03252     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03253 
03254     driverName.Buffer = (PWSTR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03255 
03256     <span class="comment">//</span>
03257     <span class="comment">// Begin by formulating the name of the driver image file to be loaded.</span>
03258     <span class="comment">// Note that this is used to determine whether or not the driver has</span>
03259     <span class="comment">// already been loaded by the OS loader, not necessarily in actually</span>
03260     <span class="comment">// loading the driver image, since the node can override that name.</span>
03261     <span class="comment">//</span>
03262 
03263     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a24">NtQueryKey</a>( KeyHandle,
03264                          KeyBasicInformation,
03265                          (PVOID) NULL,
03266                          0,
03267                          &amp;keyBasicLength );
03268     <span class="keywordflow">if</span> (status != STATUS_BUFFER_OVERFLOW &amp;&amp;
03269         status != STATUS_BUFFER_TOO_SMALL) {
03270         status = STATUS_ILL_FORMED_SERVICE_ENTRY;
03271         <span class="keywordflow">goto</span> IopLoadExit;
03272     }
03273 
03274     keyBasicInformation = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( NonPagedPool,
03275                                           keyBasicLength + (4 * 2) );
03276     <span class="keywordflow">if</span> (!keyBasicInformation) {
03277         status = STATUS_INSUFFICIENT_RESOURCES;
03278         <span class="keywordflow">goto</span> IopLoadExit;
03279     }
03280 
03281     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a24">NtQueryKey</a>( KeyHandle,
03282                          KeyBasicInformation,
03283                          keyBasicInformation,
03284                          keyBasicLength,
03285                          &amp;keyBasicLength );
03286     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03287         <span class="keywordflow">goto</span> IopLoadExit;
03288     }
03289 
03290     <span class="comment">//</span>
03291     <span class="comment">// Create a Unicode string descriptor which forms the name of the</span>
03292     <span class="comment">// driver.</span>
03293     <span class="comment">//</span>
03294 
03295     baseName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) keyBasicInformation-&gt;NameLength;
03296     baseName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (baseName.Length + (4 * 2));
03297     baseName.Buffer = &amp;keyBasicInformation-&gt;Name[0];
03298 <span class="comment">//#if _PNP_POWER_</span>
03299     serviceName.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, baseName.Length + <span class="keyword">sizeof</span>(UNICODE_NULL));
03300     <span class="keywordflow">if</span> (serviceName.Buffer) {
03301         serviceName.Length = baseName.Length;
03302         serviceName.MaximumLength = serviceName.Length + <span class="keyword">sizeof</span>(UNICODE_NULL);
03303         RtlMoveMemory(serviceName.Buffer, baseName.Buffer, baseName.Length);
03304         serviceName.Buffer[serviceName.Length / <span class="keyword">sizeof</span>(WCHAR)] = UNICODE_NULL;
03305     }
03306 <span class="preprocessor">#if DBG</span>
03307 <span class="preprocessor"></span>      <span class="keywordflow">else</span> {
03308         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopLoadDriver: No memory available for Service Keyname\n"</span>);
03309     }
03310 <span class="preprocessor">#endif</span>
03311 <span class="preprocessor"></span><span class="comment">//#endif</span>
03312     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>( &amp;baseName, L<span class="stringliteral">".SYS"</span> );
03313 
03314     <span class="keywordflow">if</span> (CheckForSafeBoot &amp;&amp; <a class="code" href="../../d8/d1/init_8h.html#a18">InitSafeBootMode</a>) {
03315 
03316         BOOLEAN GroupIsGood = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03317         UNICODE_STRING string;
03318         PKEY_VALUE_PARTIAL_INFORMATION keyValue;
03319         UCHAR nameBuffer[FIELD_OFFSET(KEY_VALUE_PARTIAL_INFORMATION, Data) + 64];
03320         ULONG length;
03321 
03322         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;string, L<span class="stringliteral">"Group"</span> );
03323         keyValue = (PKEY_VALUE_PARTIAL_INFORMATION)nameBuffer;
03324         RtlZeroMemory(nameBuffer, <span class="keyword">sizeof</span>(nameBuffer));
03325 
03326         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(
03327             KeyHandle,
03328             &amp;string,
03329             KeyValuePartialInformation,
03330             keyValue,
03331             <span class="keyword">sizeof</span>(nameBuffer),
03332             &amp;length
03333             );
03334         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03335 
03336             string.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(keyValue-&gt;DataLength - <span class="keyword">sizeof</span>(WCHAR));
03337             string.MaximumLength = string.Length;
03338             string.Buffer = (PWSTR)keyValue-&gt;Data;
03339 
03340             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a223">IopSafebootDriverLoad</a>(&amp;string)) {
03341                 GroupIsGood = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03342             }
03343         }
03344 
03345         <span class="keywordflow">if</span> (!GroupIsGood &amp;&amp; !<a class="code" href="../../d0/d6/iop_8h.html#a223">IopSafebootDriverLoad</a>(&amp;baseName)) {
03346             <span class="comment">//</span>
03347             <span class="comment">// don't load the driver</span>
03348             <span class="comment">//</span>
03349 
03350             <a class="code" href="../../d2/d4/internal_8c.html#a75">IopBootLog</a>(&amp;baseName, FALSE);
03351 
03352             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"SAFEBOOT: skipping device = %wZ(%wZ)\n"</span>,&amp;baseName,&amp;string);
03353             <span class="keywordflow">return</span> STATUS_SUCCESS;
03354         }
03355 
03356     }
03357 
03358     <span class="comment">//</span>
03359     <span class="comment">// See if this driver has already been loaded by the boot loader.</span>
03360     <span class="comment">//</span>
03361 
03362     <span class="comment">//KeEnterCriticalRegion();</span>
03363     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( &amp;PsLoadedModuleResource, TRUE );
03364     nextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
03365     <span class="keywordflow">while</span> (nextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
03366 
03367         <span class="comment">//</span>
03368         <span class="comment">// Look at the next boot driver in the list.</span>
03369         <span class="comment">//</span>
03370 
03371         driverEntry = CONTAINING_RECORD( nextEntry,
03372                                          LDR_DATA_TABLE_ENTRY,
03373                                          InLoadOrderLinks );
03374 
03375         <span class="comment">//</span>
03376         <span class="comment">// If this is not the kernel image (ntoskrnl) and not the HAL (hal),</span>
03377         <span class="comment">// then this is a driver, so initialize it.</span>
03378         <span class="comment">//</span>
03379 
03380         <span class="keywordflow">if</span> ((driverEntry-&gt;Flags &amp; LDRP_ENTRY_PROCESSED) &amp;&amp;
03381             <a class="code" href="../../d2/d7/string_8c.html#a11">RtlEqualString</a>( (PSTRING) &amp;baseName,
03382                             (PSTRING) &amp;driverEntry-&gt;FullDllName,
03383                             TRUE )) {
03384             status = STATUS_IMAGE_ALREADY_LOADED;
03385             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( &amp;PsLoadedModuleResource );
03386             <span class="comment">//KeLeaveCriticalRegion();</span>
03387 
03388             <a class="code" href="../../d2/d4/internal_8c.html#a75">IopBootLog</a>(&amp;baseName, TRUE);
03389 
03390             <span class="keywordflow">goto</span> IopLoadExit;
03391         }
03392 
03393         nextEntry = nextEntry-&gt;Flink;
03394     }
03395     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( &amp;PsLoadedModuleResource );
03396     <span class="comment">//KeLeaveCriticalRegion();</span>
03397 
03398     <span class="comment">//</span>
03399     <span class="comment">// This driver has not already been loaded by the OS loader.  Form the</span>
03400     <span class="comment">// full path name for this driver.  Begin by attempting to determine</span>
03401     <span class="comment">// whether or not the file has an image path.  If so, then use that,</span>
03402     <span class="comment">// otherwise, form one from the above driver name by putting the</span>
03403     <span class="comment">// appropriate path name in front of it.</span>
03404     <span class="comment">//</span>
03405 
03406     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( KeyHandle,
03407                                   L<span class="stringliteral">"ImagePath"</span>,
03408                                   &amp;keyValueInformation );
03409 
03410     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) &amp;&amp; keyValueInformation-&gt;DataLength) {
03411 
03412         <span class="comment">//</span>
03413         <span class="comment">// The driver service node contained an image path name from which</span>
03414         <span class="comment">// the driver is to be loaded.</span>
03415         <span class="comment">//</span>
03416 
03417         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyBasicInformation );
03418         keyBasicInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03419         baseName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) keyValueInformation-&gt;DataLength;
03420         <span class="keywordflow">if</span> (baseName.Length &gt; 0) {
03421             baseName.Length -= <span class="keyword">sizeof</span>( WCHAR );
03422         }
03423         baseName.MaximumLength = baseName.Length;
03424         baseName.Buffer = (PWSTR) ((PUCHAR) keyValueInformation + keyValueInformation-&gt;DataOffset);
03425 
03426         <span class="keywordflow">if</span> (baseName.Buffer[0] != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>) {
03427 
03428             UNICODE_STRING prefixName;
03429             UNICODE_STRING tmpName;
03430             PWCHAR fileName;
03431 
03432             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;prefixName, L<span class="stringliteral">"\\SystemRoot\\"</span> );
03433             fileName = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( NonPagedPool,
03434                                        prefixName.Length + baseName.Length );
03435             <span class="keywordflow">if</span> (!fileName) {
03436                 status = STATUS_INSUFFICIENT_RESOURCES;
03437                 <span class="keywordflow">goto</span> IopLoadExit;
03438             }
03439 
03440             tmpName.Length = baseName.Length;
03441             tmpName.Buffer = baseName.Buffer;
03442             baseName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (prefixName.Length + baseName.Length);
03443             baseName.Length = 0;
03444             baseName.Buffer = fileName;
03445 
03446             <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>( &amp;baseName, &amp;prefixName );
03447             <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>( &amp;baseName, &amp;tmpName );
03448 
03449             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
03450             keyValueInformation = (PKEY_VALUE_FULL_INFORMATION) fileName;
03451         }
03452 
03453     } <span class="keywordflow">else</span> {
03454 
03455         UNICODE_STRING prefixName;
03456         UNICODE_STRING fileName;
03457 
03458         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;prefixName, L<span class="stringliteral">"\\SystemRoot\\System32\\Drivers\\"</span> );
03459 
03460         <span class="comment">//</span>
03461         <span class="comment">// Ensure that the driver entry did not actually contain an image path</span>
03462         <span class="comment">// name, and if it did, free the appropriate pool because it was a key</span>
03463         <span class="comment">// without a value.</span>
03464         <span class="comment">//</span>
03465 
03466         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03467             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
03468         }
03469 
03470         <span class="comment">//</span>
03471         <span class="comment">// The driver entry did not contain an image path name, so the above</span>
03472         <span class="comment">// default name for the driver image is name of the file.  Form a</span>
03473         <span class="comment">// fully qualified path to get to the image file.</span>
03474         <span class="comment">//</span>
03475 
03476         keyValueInformation = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( NonPagedPool,
03477                                               baseName.MaximumLength +
03478                                               prefixName.Length );
03479         <span class="keywordflow">if</span> (!keyValueInformation) {
03480             status = STATUS_INSUFFICIENT_RESOURCES;
03481             <span class="keywordflow">goto</span> IopLoadExit;
03482         }
03483 
03484         fileName.Length = baseName.Length;
03485         fileName.MaximumLength = baseName.MaximumLength;
03486         fileName.Buffer = baseName.Buffer;
03487 
03488         baseName.Length = 0;
03489         baseName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (fileName.Length + prefixName.Length);
03490         baseName.Buffer = (PWSTR) keyValueInformation;
03491 
03492         <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>( &amp;baseName, &amp;prefixName );
03493         <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>( &amp;baseName, &amp;fileName );
03494 
03495         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyBasicInformation );
03496         keyBasicInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03497     }
03498 
03499     <span class="comment">//</span>
03500     <span class="comment">// Now get the name of the driver object.</span>
03501     <span class="comment">//</span>
03502 
03503     status = <a class="code" href="../../d0/d6/iop_8h.html#a175">IopGetDriverNameFromKeyNode</a>( KeyHandle,
03504                                           &amp;driverName );
03505     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03506         <span class="keywordflow">goto</span> IopLoadExit;
03507     }
03508 
03509     InitializeObjectAttributes( &amp;objectAttributes,
03510                                 &amp;driverName,
03511                                 OBJ_PERMANENT,
03512                                 (HANDLE) NULL,
03513                                 (PSECURITY_DESCRIPTOR) NULL );
03514 
03515     <span class="comment">//</span>
03516     <span class="comment">// Load the driver image into memory.  If this fails partway through</span>
03517     <span class="comment">// the operation, then it will automatically be unloaded.</span>
03518     <span class="comment">//</span>
03519 
03520     status = <a class="code" href="../../d8/d8/sysload_8c.html#a53">MmLoadSystemImage</a>( &amp;baseName,
03521                                 NULL,
03522                                 NULL,
03523                                 FALSE,
03524                                 &amp;sectionPointer,
03525                                 (PVOID *) &amp;imageBaseAddress );
03526 
03527     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03528 
03529         <span class="comment">//</span>
03530         <span class="comment">// If the image was not already loaded then exit.</span>
03531         <span class="comment">//</span>
03532 
03533         <span class="keywordflow">if</span> (status != STATUS_IMAGE_ALREADY_LOADED) {
03534 
03535             <a class="code" href="../../d2/d4/internal_8c.html#a75">IopBootLog</a>(&amp;baseName, FALSE);
03536 
03537             <span class="keywordflow">goto</span> IopLoadExit;
03538         }
03539 
03540         <span class="comment">//</span>
03541         <span class="comment">// Open the driver object.</span>
03542         <span class="comment">//</span>
03543 
03544         status = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>( &amp;objectAttributes,
03545                                      IoDriverObjectType,
03546                                      KernelMode,
03547                                      NULL,
03548                                      0,
03549                                      NULL,
03550                                      &amp;driverHandle );
03551 
03552 
03553         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03554 
03555             <a class="code" href="../../d2/d4/internal_8c.html#a75">IopBootLog</a>(&amp;baseName, FALSE);
03556 
03557             <span class="keywordflow">goto</span> IopLoadExit;
03558         }
03559 
03560         <span class="comment">//</span>
03561         <span class="comment">// Reference the handle and obtain a pointer to the driver object so that</span>
03562         <span class="comment">// the handle can be deleted without the object going away.</span>
03563         <span class="comment">//</span>
03564 
03565         status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( driverHandle,
03566                                             0,
03567                                             IoDriverObjectType,
03568                                             KeGetPreviousMode(),
03569                                             (PVOID *) &amp;driverObject,
03570                                             (<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">POBJECT_HANDLE_INFORMATION</a>) NULL );
03571 
03572         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( driverHandle );
03573 
03574         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03575             <a class="code" href="../../d2/d4/internal_8c.html#a75">IopBootLog</a>(&amp;baseName, FALSE);
03576             <span class="keywordflow">goto</span> IopLoadExit;
03577         }
03578 
03579         status = <a class="code" href="../../d2/d4/internal_8c.html#a13">IopResurrectDriver</a>( driverObject );
03580 
03581         <span class="comment">//</span>
03582         <span class="comment">// Regardless of the status the driver object should be dereferenced.</span>
03583         <span class="comment">// if the unload has already run then driver is almost gone. If</span>
03584         <span class="comment">// the driver has been resurrected then the I/O system still has its</span>
03585         <span class="comment">// original reference.</span>
03586         <span class="comment">//</span>
03587 
03588         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( driverObject );
03589         <a class="code" href="../../d2/d4/internal_8c.html#a75">IopBootLog</a>(&amp;baseName, FALSE);
03590         <span class="keywordflow">goto</span> IopLoadExit;
03591     } <span class="keywordflow">else</span> {
03592 
03593         ntHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>( imageBaseAddress );
03594 
03595         <span class="comment">//</span>
03596         <span class="comment">// Check should this driver be loaded.  If yes, the enum subkey</span>
03597         <span class="comment">// of the service will be prepared.</span>
03598         <span class="comment">//</span>
03599 
03600         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a5">IopPrepareDriverLoading</a> (&amp;serviceName, KeyHandle, ntHeaders);
03601         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03602             <a class="code" href="../../d8/d8/sysload_8c.html#a59">MmUnloadSystemImage</a>(sectionPointer);
03603             <a class="code" href="../../d2/d4/internal_8c.html#a75">IopBootLog</a>(&amp;baseName, FALSE);
03604             <span class="keywordflow">goto</span> IopLoadExit;
03605         }
03606 
03607     }
03608 
03609     <span class="comment">//</span>
03610     <span class="comment">// The driver image has now been loaded into memory.  Create the driver</span>
03611     <span class="comment">// object that represents this image.</span>
03612     <span class="comment">//</span>
03613 
03614     status = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>( KeGetPreviousMode(),
03615                              IoDriverObjectType,
03616                              &amp;objectAttributes,
03617                              KernelMode,
03618                              (PVOID) NULL,
03619                              (ULONG) (<span class="keyword">sizeof</span>( <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">DRIVER_OBJECT</a> ) + <span class="keyword">sizeof</span> ( <a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html">DRIVER_EXTENSION</a> )),
03620                              0,
03621                              0,
03622                              (PVOID *) &amp;driverObject );
03623 
03624     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03625         <a class="code" href="../../d2/d4/internal_8c.html#a75">IopBootLog</a>(&amp;baseName, FALSE);
03626         <span class="keywordflow">goto</span> IopLoadExit;
03627     }
03628 
03629     <span class="comment">//</span>
03630     <span class="comment">// Initialize this driver object and insert it into the object table.</span>
03631     <span class="comment">//</span>
03632 
03633     RtlZeroMemory( driverObject, <span class="keyword">sizeof</span>( DRIVER_OBJECT ) + <span class="keyword">sizeof</span> ( DRIVER_EXTENSION) );
03634     driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a> = (<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html">PDRIVER_EXTENSION</a>) (driverObject + 1);
03635     driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a>-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o0">DriverObject</a> = driverObject;
03636 
03637     <span class="keywordflow">for</span> (i = 0; i &lt;= <a class="code" href="../../d0/d5/io_8h.html#a42">IRP_MJ_MAXIMUM_FUNCTION</a>; i++) {
03638         driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o14">MajorFunction</a>[i] = <a class="code" href="../../d2/d4/internal_8c.html#a45">IopInvalidDeviceRequest</a>;
03639     }
03640 
03641     driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o0">Type</a> = <a class="code" href="../../d0/d5/io_8h.html#a3">IO_TYPE_DRIVER</a>;
03642     driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o1">Size</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d0/d5/io_8h.html#a345">DRIVER_OBJECT</a> );
03643     ntHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>( imageBaseAddress );
03644     entryPoint = ntHeaders-&gt;OptionalHeader.AddressOfEntryPoint;
03645     entryPoint += (ULONG_PTR) imageBaseAddress;
03646     <span class="keywordflow">if</span> (!(ntHeaders-&gt;OptionalHeader.DllCharacteristics &amp; IMAGE_DLLCHARACTERISTICS_WDM_DRIVER)) {
03647         driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o3">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a144">DRVO_LEGACY_DRIVER</a>;
03648     }
03649     driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o11">DriverInit</a> = (<a class="code" href="../../d0/d5/io_8h.html#a284">PDRIVER_INITIALIZE</a>) entryPoint;
03650     driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o6">DriverSection</a> = sectionPointer;
03651     driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o4">DriverStart</a> = imageBaseAddress;
03652     driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o5">DriverSize</a> = ntHeaders-&gt;OptionalHeader.SizeOfImage;
03653 
03654     status = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>( driverObject,
03655                              (<a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a>) NULL,
03656                              FILE_READ_DATA,
03657                              0,
03658                              (PVOID *) NULL,
03659                              &amp;driverHandle );
03660     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03661         <a class="code" href="../../d2/d4/internal_8c.html#a75">IopBootLog</a>(&amp;baseName, FALSE);
03662         <span class="keywordflow">goto</span> IopLoadExit;
03663     }
03664 
03665     <span class="comment">//</span>
03666     <span class="comment">// Reference the handle and obtain a pointer to the driver object so that</span>
03667     <span class="comment">// the handle can be deleted without the object going away.</span>
03668     <span class="comment">//</span>
03669 
03670     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( driverHandle,
03671                                         0,
03672                                         IoDriverObjectType,
03673                                         KeGetPreviousMode(),
03674                                         (PVOID *) &amp;driverObject,
03675                                         (<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">POBJECT_HANDLE_INFORMATION</a>) NULL );
03676 
03677     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( driverHandle );
03678 
03679     <span class="comment">//</span>
03680     <span class="comment">// Load the Registry information in the appropriate fields of the device</span>
03681     <span class="comment">// object.</span>
03682     <span class="comment">//</span>
03683 
03684     driverObject-&gt;HardwareDatabase =
03685         &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a17">CmRegistryMachineHardwareDescriptionSystemName</a>;
03686 
03687     <span class="comment">//</span>
03688     <span class="comment">// Store the name of the device driver in the driver object so that it</span>
03689     <span class="comment">// can be easily found by the error log thread.</span>
03690     <span class="comment">//</span>
03691 
03692     driverObject-&gt;DriverName.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool,
03693                                                       driverName.MaximumLength );
03694     <span class="keywordflow">if</span> (driverObject-&gt;DriverName.Buffer) {
03695         driverObject-&gt;DriverName.MaximumLength = driverName.MaximumLength;
03696         driverObject-&gt;DriverName.Length = driverName.Length;
03697 
03698         RtlCopyMemory( driverObject-&gt;DriverName.Buffer,
03699                        driverName.Buffer,
03700                        driverName.MaximumLength );
03701     }
03702 
03703     <span class="comment">//</span>
03704     <span class="comment">// Query the name of the registry path for this driver so that it can</span>
03705     <span class="comment">// be passed to the driver.</span>
03706     <span class="comment">//</span>
03707 
03708     registryPath = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( NonPagedPool, PAGE_SIZE );
03709     <span class="keywordflow">if</span> (!registryPath) {
03710         <a class="code" href="../../d5/d0/obclose_8c.html#a3">ObMakeTemporaryObject</a>( driverObject );
03711         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( driverObject );
03712         status = STATUS_INSUFFICIENT_RESOURCES;
03713         <span class="keywordflow">goto</span> IopLoadExit;
03714     }
03715 
03716     status = <a class="code" href="../../d6/d1/obquery_8c.html#a5">NtQueryObject</a>( KeyHandle,
03717                             ObjectNameInformation,
03718                             registryPath,
03719                             PAGE_SIZE,
03720                             &amp;i );
03721     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03722         <a class="code" href="../../d5/d0/obclose_8c.html#a3">ObMakeTemporaryObject</a>( driverObject );
03723         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( driverObject );
03724         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( registryPath );
03725         <span class="keywordflow">goto</span> IopLoadExit;
03726     }
03727 
03728 <span class="preprocessor">#if DBG</span>
03729 <span class="preprocessor"></span>    <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a> (&amp;stime);
03730 <span class="preprocessor">#endif</span>
03731 <span class="preprocessor"></span>
03732     <span class="comment">//</span>
03733     <span class="comment">// Store the service key name of the device driver in the driver object</span>
03734     <span class="comment">//</span>
03735 
03736     <span class="keywordflow">if</span> (serviceName.Buffer) {
03737         driverObject-&gt;DriverExtension-&gt;ServiceKeyName.Buffer =
03738             <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( NonPagedPool, serviceName.MaximumLength );
03739         <span class="keywordflow">if</span> (driverObject-&gt;DriverExtension-&gt;ServiceKeyName.Buffer) {
03740             driverObject-&gt;DriverExtension-&gt;ServiceKeyName.MaximumLength = serviceName.MaximumLength;
03741             driverObject-&gt;DriverExtension-&gt;ServiceKeyName.Length = serviceName.Length;
03742 
03743             RtlCopyMemory( driverObject-&gt;DriverExtension-&gt;ServiceKeyName.Buffer,
03744                            serviceName.Buffer,
03745                            serviceName.MaximumLength );
03746         }
03747     }
03748 
03749     <span class="comment">//</span>
03750     <span class="comment">// Now invoke the driver's initialization routine to initialize itself.</span>
03751     <span class="comment">//</span>
03752 
03753     <a class="code" href="../../d2/d1/mm_8h.html#a45">PERFINFO_DRIVER_INIT</a>(driverObject);
03754 
03755     status = driverObject-&gt;DriverInit( driverObject, &amp;registryPath-&gt;Name );
03756 
03757     <a class="code" href="../../d2/d1/mm_8h.html#a46">PERFINFO_DRIVER_INIT_COMPLETE</a>(driverObject);
03758 
03759 <span class="preprocessor">#if DBG</span>
03760 <span class="preprocessor"></span>
03761     <span class="comment">//</span>
03762     <span class="comment">// If DriverInit took longer than 5 seconds, print a message.</span>
03763     <span class="comment">//</span>
03764 
03765     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a> (&amp;etime);
03766     dtime  = (ULONG) ((etime.QuadPart - stime.QuadPart) / 1000000);
03767 
03768     <span class="keywordflow">if</span> (dtime &gt; 50) {
03769         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IOLOAD: Driver %wZ took %d.%ds to %s\n"</span>,
03770             &amp;driverName,
03771             dtime/10,
03772             dtime%10,
03773             <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ? <span class="stringliteral">"initialize"</span> : <span class="stringliteral">"fail initialization"</span>
03774             );
03775 
03776     }
03777 <span class="preprocessor">#endif</span>
03778 <span class="preprocessor"></span>
03779     <span class="comment">//</span>
03780     <span class="comment">// Workaround for broken NT 4.0 3D labs driver</span>
03781     <span class="comment">// They zero out some function table entries by mistake.</span>
03782 
03783     <span class="keywordflow">for</span> (i = 0; i &lt;= <a class="code" href="../../d0/d5/io_8h.html#a42">IRP_MJ_MAXIMUM_FUNCTION</a>; i++) {
03784         <span class="keywordflow">if</span> (driverObject-&gt;MajorFunction[i] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03785             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(driverObject-&gt;MajorFunction[i] != NULL);
03786             driverObject-&gt;MajorFunction[i] = <a class="code" href="../../d2/d4/internal_8c.html#a45">IopInvalidDeviceRequest</a>;
03787         }
03788     }
03789 
03790     <span class="comment">//</span>
03791     <span class="comment">// If DriverInit doesn't work, then simply unload the image and mark the driver</span>
03792     <span class="comment">// object as temporary.  This will cause everything to be deleted.</span>
03793     <span class="comment">//</span>
03794 
03795     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( registryPath );
03796 
03797     <span class="comment">//</span>
03798     <span class="comment">// If we load the driver because we think it is a legacy driver and</span>
03799     <span class="comment">// it does not create any device object in its DriverEntry.  We will</span>
03800     <span class="comment">// unload this driver.</span>
03801     <span class="comment">//</span>
03802 
03803     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; !<a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a32">IopIsLegacyDriver</a>(driverObject)) {
03804         <span class="keywordflow">if</span> (driverObject-&gt;DeviceObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
03805             serviceName.Buffer &amp;&amp;
03806             !<a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a19">IopIsAnyDeviceInstanceEnabled</a>(&amp;serviceName, NULL, FALSE) &amp;&amp;
03807             !(driverObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a146">DRVO_REINIT_REGISTERED</a>)) {
03808             <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a18">IopDriverLoadingFailed</a>(KeyHandle, NULL);
03809             status = STATUS_PLUGPLAY_NO_DEVICE;
03810         } <span class="keywordflow">else</span> {
03811 
03812             <span class="comment">//</span>
03813             <span class="comment">// Start the devices controlled by the driver and enumerate them</span>
03814             <span class="comment">// At this point, we know there is at least one device controlled by the driver.</span>
03815             <span class="comment">//</span>
03816 
03817             <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a34">IopDeleteLegacyKey</a>(driverObject);
03818             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/pnpdata_8c.html#a14">PnPInitialized</a>) {
03819                 status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a287">IopStartDriverDevices</a>(driverObject);
03820             }
03821         }
03822         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03823             <span class="keywordflow">if</span> (driverObject-&gt;DriverUnload) {
03824                 driverObject-&gt;Flags |= <a class="code" href="../../d0/d5/io_8h.html#a143">DRVO_UNLOAD_INVOKED</a>;
03825                 driverObject-&gt;DriverUnload(driverObject);
03826                 <a class="code" href="../../d2/d4/internal_8c.html#a75">IopBootLog</a>(&amp;baseName, FALSE);
03827             } <span class="keywordflow">else</span> {
03828 <span class="preprocessor">    #if DBG</span>
03829 <span class="preprocessor"></span>                <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopLoadDriver: A PnP driver %wZ does not support DriverUnload routine.\n"</span>, &amp;driverName);
03830                 <span class="comment">// ASSERT(0);</span>
03831 <span class="preprocessor">    #endif</span>
03832 <span class="preprocessor"></span>            }
03833         }
03834     }
03835 
03836     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03837         <a class="code" href="../../d5/d0/obclose_8c.html#a3">ObMakeTemporaryObject</a>( driverObject );
03838         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( driverObject );
03839     } <span class="keywordflow">else</span> {
03840 
03841         <span class="comment">//</span>
03842         <span class="comment">// Free the memory occupied by the driver's initialization routines.</span>
03843         <span class="comment">//</span>
03844 
03845         <a class="code" href="../../d2/d4/internal_8c.html#a75">IopBootLog</a>(&amp;baseName, TRUE);
03846         <a class="code" href="../../d8/d8/sysload_8c.html#a55">MmFreeDriverInitialization</a>( driverObject-&gt;DriverSection );
03847         <a class="code" href="../../d0/d6/iop_8h.html#a207">IopReadyDeviceObjects</a>( driverObject );
03848     }
03849 
03850 IopLoadExit:
03851 
03852     <span class="comment">//</span>
03853     <span class="comment">// Free any pool that was allocated by this routine that has not yet</span>
03854     <span class="comment">// been freed.</span>
03855     <span class="comment">//</span>
03856 
03857     <span class="keywordflow">if</span> (driverName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03858         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( driverName.Buffer );
03859     }
03860 
03861     <span class="keywordflow">if</span> (keyValueInformation != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03862         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
03863     }
03864 
03865     <span class="keywordflow">if</span> (keyBasicInformation != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03866         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyBasicInformation );
03867     }
03868 
03869     <span class="keywordflow">if</span> (serviceName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03870         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(serviceName.Buffer);
03871     }
03872 
03873     <span class="comment">//</span>
03874     <span class="comment">// If this routine is about to return a failure, then let the Configuration</span>
03875     <span class="comment">// Manager know about it.  But, if STATUS_PLUGPLAY_NO_DEVICE, the device was</span>
03876     <span class="comment">// disabled by hardware profile.  In this case we don't need to report it.</span>
03877     <span class="comment">//</span>
03878 
03879     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) &amp;&amp; (status != STATUS_PLUGPLAY_NO_DEVICE)) {
03880 
03881         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> lStatus;
03882         PULONG errorControl;
03883 
03884         <span class="keywordflow">if</span> (status != STATUS_IMAGE_ALREADY_LOADED) {
03885 
03886             <span class="comment">//</span>
03887             <span class="comment">// If driver was loaded, do not call IopDriverLoadingFailed to change</span>
03888             <span class="comment">// the driver loading status.  Because, obviously, the driver is</span>
03889             <span class="comment">// running.</span>
03890             <span class="comment">//</span>
03891 
03892             <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a18">IopDriverLoadingFailed</a>(KeyHandle, NULL);
03893             lStatus = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( KeyHandle,
03894                                            L<span class="stringliteral">"ErrorControl"</span>,
03895                                            &amp;keyValueInformation );
03896             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( lStatus ) || !keyValueInformation-&gt;DataLength) {
03897                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( lStatus )) {
03898                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
03899                 }
03900             } <span class="keywordflow">else</span> {
03901                 errorControl = (PULONG) ((PUCHAR) keyValueInformation + keyValueInformation-&gt;DataOffset);
03902                 <a class="code" href="../../d7/d9/cm_8h.html#a34">CmBootLastKnownGood</a>( *errorControl );
03903                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
03904             }
03905         }
03906     }
03907 
03908     <span class="comment">//</span>
03909     <span class="comment">// Close the caller's handle and return the final status from the load</span>
03910     <span class="comment">// operation.</span>
03911     <span class="comment">//</span>
03912 
03913     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( KeyHandle );
03914     <span class="keywordflow">return</span> status;
03915 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a51" doxytag="internal.c::IopLoadFileSystemDriver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopLoadFileSystemDriver           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l04077">4077</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01181">_DEVICE_OBJECT::AttachedDevice</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01552">IoBuildDeviceIoControlRequest()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04022">IopDecrementDeviceObjectRef()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00069">IRP_MJ_DEVICE_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00068">IRP_MJ_FILE_SYSTEM_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00115">IRP_MN_LOAD_FILE_SYSTEM</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l04282">IopMountVolume()</a>.
<p>
<pre class="fragment"><div>04083                    :
04084 
04085     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked when a mini-<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system recognizer driver recognizes
04086     a volume as being a particular <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system, but <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver <span class="keywordflow">for</span> that <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
04087     system has not yet been loaded.  This function allows <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mini-driver to
04088     load <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> real <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system, and remove itself from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system, so that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04089     real <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system can mount <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device in question.
04090 
04091 Arguments:
04092 
04093     DeviceObject - Registered <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system device object <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mini-driver.
04094 
04095 Return Value:
04096 
04097     None.
04098 
04099 --*/
04100 
04101 {
04102     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
04103     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04104     IO_STATUS_BLOCK ioStatus;
04105     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
04106     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
04107     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> attachedDevice;
04108 
04109     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04110 
04111     attachedDevice = DeviceObject;
04112     <span class="keywordflow">while</span> (attachedDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>) {
04113         attachedDevice = attachedDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>;
04114     }
04115 
04116     <span class="comment">//</span>
04117     <span class="comment">// Begin by building an I/O Request Packet to have the mini-file system</span>
04118     <span class="comment">// driver load the real file system.</span>
04119     <span class="comment">//</span>
04120 
04121     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event, NotificationEvent, FALSE );
04122 
04123     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a25">IoBuildDeviceIoControlRequest</a>( IRP_MJ_DEVICE_CONTROL,
04124                                          attachedDevice,
04125                                          (PVOID) NULL,
04126                                          0,
04127                                          (PVOID) NULL,
04128                                          0,
04129                                          FALSE,
04130                                          &amp;event,
04131                                          &amp;ioStatus );
04132     <span class="keywordflow">if</span> (irp) {
04133 
04134         <span class="comment">//</span>
04135         <span class="comment">// Change the actual major and minor function codes to be a file system</span>
04136         <span class="comment">// control with a minor function code of load FS driver.</span>
04137         <span class="comment">//</span>
04138 
04139         irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
04140         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a26">IRP_MJ_FILE_SYSTEM_CONTROL</a>;
04141         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a49">IRP_MN_LOAD_FILE_SYSTEM</a>;
04142 
04143         <span class="comment">//</span>
04144         <span class="comment">// Now issue the request.</span>
04145         <span class="comment">//</span>
04146 
04147         status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( attachedDevice, irp );
04148         <span class="keywordflow">if</span> (status == STATUS_PENDING) {
04149             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
04150                                           Executive,
04151                                           KernelMode,
04152                                           FALSE,
04153                                           (PLARGE_INTEGER) NULL );
04154         }
04155     }
04156 
04157     <span class="comment">//</span>
04158     <span class="comment">// Decrement the reference count on the device object.  If this is the last</span>
04159     <span class="comment">// last reason that this mini-file system recognizer needs to stay around,</span>
04160     <span class="comment">// then unload it.</span>
04161     <span class="comment">//</span>
04162 
04163     <a class="code" href="../../d0/d6/iop_8h.html#a161">IopDecrementDeviceObjectRef</a>(DeviceObject, TRUE);
04164 
04165     <span class="keywordflow">return</span>;
04166 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a52" doxytag="internal.c::IopLoadUnloadDriver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopLoadUnloadDriver           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Parameter</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l04169">4169</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d1/d5/iop_8h-source.html#l00345">_REINIT_PACKET::Context</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01330">_DRIVER_EXTENSION::Count</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01378">_DRIVER_OBJECT::DriverExtension</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00317">_LOAD_PACKET::DriverObject</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00343">_REINIT_PACKET::DriverObject</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00344">_REINIT_PACKET::DriverReinitializationRoutine</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00318">_LOAD_PACKET::DriverServiceName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01413">_DRIVER_OBJECT::DriverUnload</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01303">DRVO_REINIT_REGISTERED</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00316">_LOAD_PACKET::Event</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a239">ExInterlockedRemoveHeadList()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00319">_LOAD_PACKET::FinalStatus</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01367">_DRIVER_OBJECT::Flags</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00054">IopDatabaseLock</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00128">IopDriverReinitializeQueueHead</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d6/iop_8h.html#a58">PLOAD_PACKET</a>, <a class="el" href="../../d0/d6/iop_8h.html#a62">PREINIT_PACKET</a>, <a class="el" href="../../d0/d6/iop_8h.html#a61">REINIT_PACKET</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l00657">IopCompleteUnloadOrDelete()</a>, <a class="el" href="../../d9/d3/loadunld_8c-source.html#l00035">NtLoadDriver()</a>, and <a class="el" href="../../d9/d3/loadunld_8c-source.html#l00244">NtUnloadDriver()</a>.
<p>
<pre class="fragment"><div>04175                    :
04176 
04177     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> executed as an EX worker thread routine when a driver <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
04178     to be loaded or unloaded dynamically.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used because some drivers
04179     need to create system threads in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system process, which
04180     cannot be done in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system service that
04181     was invoked to load or unload <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified driver.
04182 
04183 Arguments:
04184 
04185     Parameter - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> load packet describing what work <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be
04186         done.
04187 
04188 Return Value:
04189 
04190     None.
04191 
04192 --*/
04193 
04194 {
04195     <a class="code" href="../../d0/d2/struct__LOAD__PACKET.html">PLOAD_PACKET</a> loadPacket;
04196     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04197     HANDLE keyHandle;
04198 
04199     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04200 
04201     <span class="comment">//</span>
04202     <span class="comment">// Begin by getting a pointer to the load packet.</span>
04203     <span class="comment">//</span>
04204 
04205     loadPacket = (<a class="code" href="../../d0/d2/struct__LOAD__PACKET.html">PLOAD_PACKET</a>) Parameter;
04206 
04207     <span class="comment">//</span>
04208     <span class="comment">// If the driver object field of the packet is non-NULL, then this is</span>
04209     <span class="comment">// a request to complete the unload of a driver.  Simply invoke the</span>
04210     <span class="comment">// driver's unload routine.  Note that the final status of the unload</span>
04211     <span class="comment">// is ignored, so it is not set here.</span>
04212     <span class="comment">//</span>
04213 
04214     <span class="keywordflow">if</span> (loadPacket-&gt;<a class="code" href="../../d0/d2/struct__LOAD__PACKET.html#o2">DriverObject</a>) {
04215 
04216         loadPacket-&gt;<a class="code" href="../../d0/d2/struct__LOAD__PACKET.html#o2">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o13">DriverUnload</a>( loadPacket-&gt;<a class="code" href="../../d0/d2/struct__LOAD__PACKET.html#o2">DriverObject</a> );
04217         status = STATUS_SUCCESS;
04218 
04219     } <span class="keywordflow">else</span> {
04220 
04221         PLIST_ENTRY entry;
04222         <a class="code" href="../../d5/d3/struct__REINIT__PACKET.html">PREINIT_PACKET</a> reinitEntry;
04223 
04224         <span class="comment">//</span>
04225         <span class="comment">// The driver specified by the DriverServiceName is to be loaded.</span>
04226         <span class="comment">// Begin by opening the registry node for this driver.  Note</span>
04227         <span class="comment">// that if this is successful, then the load driver routine is</span>
04228         <span class="comment">// responsible for closing the handle.</span>
04229         <span class="comment">//</span>
04230 
04231         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>( &amp;keyHandle,
04232                                      (HANDLE) NULL,
04233                                      loadPacket-&gt;<a class="code" href="../../d0/d2/struct__LOAD__PACKET.html#o3">DriverServiceName</a>,
04234                                      KEY_READ,
04235                                      FALSE );
04236         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04237 
04238             <span class="comment">//</span>
04239             <span class="comment">// Invoke the internal common routine to perform the work.</span>
04240             <span class="comment">// This is the same routine that is used by the I/O system</span>
04241             <span class="comment">// initialization code to load drivers.</span>
04242             <span class="comment">//</span>
04243 
04244             status = <a class="code" href="../../d0/d6/iop_8h.html#a191">IopLoadDriver</a>( keyHandle, TRUE );
04245 
04246             <span class="comment">//</span>
04247             <span class="comment">// Walk the list reinitialization list in case this driver, or</span>
04248             <span class="comment">// some other driver, has requested to be invoked at a re-</span>
04249             <span class="comment">// initialization entry point.</span>
04250             <span class="comment">//</span>
04251 
04252             <span class="keywordflow">while</span> (entry = <a class="code" href="../../d5/d8/ex_8h.html#a239">ExInterlockedRemoveHeadList</a>( &amp;IopDriverReinitializeQueueHead, &amp;IopDatabaseLock )) {
04253                 reinitEntry = CONTAINING_RECORD( entry, <a class="code" href="../../d5/d3/struct__REINIT__PACKET.html">REINIT_PACKET</a>, ListEntry );
04254 <span class="comment">//#if _PNP_POWER_</span>
04255                 reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o1">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a>-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o2">Count</a>++;
04256                 reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o1">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o3">Flags</a> &amp;= ~<a class="code" href="../../d0/d5/io_8h.html#a146">DRVO_REINIT_REGISTERED</a>;
04257                 reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o2">DriverReinitializationRoutine</a>( reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o1">DriverObject</a>,
04258                                                             reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o3">Context</a>,
04259                                                             reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o1">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a>-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o2">Count</a> );
04260 <span class="comment">//#else</span>
04261 <span class="preprocessor">#if 0</span>
04262 <span class="preprocessor"></span>                reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o1">DriverObject</a>-&gt;Count++;
04263                 reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o2">DriverReinitializationRoutine</a>( reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o1">DriverObject</a>,
04264                                                             reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o3">Context</a>,
04265                                                             reinitEntry-&gt;<a class="code" href="../../d5/d3/struct__REINIT__PACKET.html#o1">DriverObject</a>-&gt;Count );
04266 <span class="preprocessor">#endif // _PNP_POWER_</span>
04267 <span class="preprocessor"></span>                <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( reinitEntry );
04268             }
04269         }
04270     }
04271 
04272     <span class="comment">//</span>
04273     <span class="comment">// Set the final status of the load or unload operation, and indicate to</span>
04274     <span class="comment">// the caller that the operation is now complete.</span>
04275     <span class="comment">//</span>
04276 
04277     loadPacket-&gt;<a class="code" href="../../d0/d2/struct__LOAD__PACKET.html#o4">FinalStatus</a> = status;
04278     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;loadPacket-&gt;<a class="code" href="../../d0/d2/struct__LOAD__PACKET.html#o1">Event</a>, 0, FALSE );
04279 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a72" doxytag="internal.c::IopLookupBusStringFromID" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopLookupBusStringFromID           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN INTERFACE_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>InterfaceType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PWCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG BusFlags&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l08729">8729</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d4/d9/user32_8def-source.html#l00799">c</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00050">InterfaceType</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
<pre class="fragment"><div>08738                    :
08739 
08740     Translates INTERFACE_TYPE to its corresponding WCHAR[] string.
08741 
08742 Arguments:
08743 
08744     KeyHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> opened registry key,
08745         HKLM\System\CurrentControlSet\Control\SystemResources\BusValues.
08746 
08747     <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> interface <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <span class="keywordflow">for</span> which a descriptive
08748         name <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be retrieved.
08749 
08750     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Supplies a pointer to a unicode character buffer that will
08751         receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bus name.  Since <span class="keyword">this</span> buffer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used in an
08752         intermediate step to retrieve a KEY_VALUE_FULL_INFORMATION structure,
08753         <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must be large enough to contain <span class="keyword">this</span> structure (including the
08754         longest value name &amp; data length under KeyHandle).
08755 
08756     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>.
08757 
08758     BusFlags - Optionally receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flags specified in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second
08759         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a> REG_BINARY value.
08760 
08761 Return Value:
08762 
08763     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
08764 
08765 --*/
08766 {
08767     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                        status;
08768     ULONG                           <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>, junk, i, j;
08769     PULONG                          pl;
08770     PKEY_VALUE_FULL_INFORMATION     KeyInformation;
08771     WCHAR                           <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
08772 
08773     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
08774 
08775     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
08776     KeyInformation = (PKEY_VALUE_FULL_INFORMATION) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
08777 
08778     <span class="keywordflow">for</span> (; ;) {
08779         status = ZwEnumerateValueKey (
08780                         KeyHandle,
08781                         Index++,
08782                         KeyValueFullInformation,
08783                         Buffer,
08784                         Length,
08785                         &amp;junk
08786                         );
08787 
08788         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
08789             <span class="keywordflow">return</span> status;
08790         }
08791 
08792         <span class="keywordflow">if</span> (KeyInformation-&gt;Type != REG_BINARY) {
08793             <span class="keywordflow">continue</span>;
08794         }
08795 
08796         pl = (PULONG) ((PUCHAR) KeyInformation + KeyInformation-&gt;DataOffset);
08797         <span class="keywordflow">if</span> ((ULONG) <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> != pl[0]) {
08798             <span class="keywordflow">continue</span>;
08799         }
08800 
08801         <span class="comment">//</span>
08802         <span class="comment">// Found a match - move the name to the start of the buffer</span>
08803         <span class="comment">//</span>
08804 
08805         <span class="keywordflow">if</span>(ARGUMENT_PRESENT(BusFlags)) {
08806             *BusFlags = pl[1];
08807         }
08808 
08809         j = KeyInformation-&gt;NameLength / <span class="keyword">sizeof</span> (WCHAR);
08810         <span class="keywordflow">for</span> (i=0; i &lt; j; i++) {
08811             <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> = KeyInformation-&gt;Name[i];
08812             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[i] = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
08813         }
08814 
08815         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[i] = 0;
08816         <span class="keywordflow">return</span> STATUS_SUCCESS;
08817     }
08818 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="internal.c::IopMarshalIds" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopMarshalIds           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT <a class="el" href="../../d1/d2/struct__TRACKING__BUFFER.html">PTRACKING_BUFFER</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TrackingBuffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d4/internal_8c.html#a6">PFILE_VOLUMEID_WITH_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetVolumeId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFILE_OBJECTID_BUFFER&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetObjectId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFILE_TRACKING_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>TrackingInfo</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l06010">6010</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l07272">IopTrackLink()</a>.
<p>
<pre class="fragment"><div>06019                    :
06020 
06021     This routine marshals <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TargetVolumeId and TargetObjectId
06022     into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> supplied TrackingBuffer in a standard remotable <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>.
06023 
06024     It also clears <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DestinationFile handle to <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, and sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
06025     ObjectInformationLength to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> marshalled data.
06026 
06027 Arguments:
06028 
06029     TrackingBuffer - The buffer to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> marshalled parameters.
06030 
06031     TargetVolumeId - The volume <span class="keywordtype">id</span> to marshal.
06032 
06033     TargetObjectId - The object <span class="keywordtype">id</span> to marshal.
06034 
06035     TrackingInfo   - The additional tracking information to marshal.
06036 
06037 --*/
06038 
06039 {
06040     ULONG ObjectInformationLength = 0;
06041 
06042     TrackingBuffer-&gt;TrackingInformation.DestinationFile = (HANDLE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06043 
06044     RtlZeroMemory( &amp;TrackingBuffer-&gt;TrackingInformation.ObjectInformation[ ObjectInformationLength ],
06045                    <span class="keyword">sizeof</span>(TargetVolumeId-&gt;Type) );
06046 
06047     RtlCopyMemory( &amp;TrackingBuffer-&gt;TrackingInformation.ObjectInformation[ ObjectInformationLength ],
06048                    &amp;TargetVolumeId-&gt;Type,
06049                    <span class="keyword">sizeof</span>(TargetVolumeId-&gt;Type) );
06050     ObjectInformationLength += <span class="keyword">sizeof</span>(TargetVolumeId-&gt;Type);
06051 
06052     RtlCopyMemory( &amp;TrackingBuffer-&gt;TrackingInformation.ObjectInformation[ ObjectInformationLength ],
06053                    &amp;TargetVolumeId-&gt;VolumeId[0],
06054                    <span class="keyword">sizeof</span>(TargetVolumeId-&gt;VolumeId) );
06055     ObjectInformationLength += <span class="keyword">sizeof</span>(TargetVolumeId-&gt;VolumeId);
06056 
06057     RtlCopyMemory( &amp;TrackingBuffer-&gt;TrackingInformation.ObjectInformation[ ObjectInformationLength ],
06058                    &amp;TargetObjectId-&gt;ObjectId[0],
06059                    <span class="keyword">sizeof</span>(TargetObjectId-&gt;ObjectId) );
06060     ObjectInformationLength += <span class="keyword">sizeof</span>(TargetObjectId-&gt;ObjectId);
06061 
06062     RtlCopyMemory( &amp;TrackingBuffer-&gt;TrackingInformation.ObjectInformation[ ObjectInformationLength ],
06063                    &amp;TrackingInfo-&gt;ObjectInformation[0],
06064                    TrackingInfo-&gt;ObjectInformationLength );
06065     ObjectInformationLength += TrackingInfo-&gt;ObjectInformationLength;
06066 
06067     TrackingBuffer-&gt;TrackingInformation.ObjectInformationLength = ObjectInformationLength;
06068 
06069 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a53" doxytag="internal.c::IopMountVolume" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopMountVolume           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AllowRawMount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceLockAlreadyHeld</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Alertable</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l04282">4282</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01181">_DEVICE_OBJECT::AttachedDevice</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01160">DO_SYSTEM_BOOT_PARTITION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01153">DO_VERIFY_VOLUME</a>, <a class="el" href="../../d1/d1/config_2test_2init386_8c-source.html#l00027">dummy()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d5/d8/ex_8h.html#a235">ExInterlockedAddUlong()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02030">_IO_STACK_LOCATION::Flags</a>, <a class="el" href="../../d8/d2/fsrtl_2filter_8c-source.html#l00304">FsRtlIsTotalDeviceFailure()</a>, <a class="el" href="../../d9/d0/init_8h-source.html#l00070">InitializationPhase</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03528">IoIsErrorUserInduced</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00065">IOP_ABORT</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00336">IopAllocateIrpMustSucceed()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00094">IopCdRomFileSystemQueueHead</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00054">IopDatabaseLock</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00065">IopDatabaseResource</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00084">IopDiskFileSystemQueueHead</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04077">IopLoadFileSystemDriver()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00114">IopTapeFileSystemQueueHead</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00068">IRP_MJ_FILE_SYSTEM_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00113">IRP_MN_MOUNT_VOLUME</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01551">IRP_MOUNT_COMPLETION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01557">IRP_SYNCHRONOUS_PAGING_IO</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01178">_DEVICE_OBJECT::ReferenceCount</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01641">_IRP::RequestorMode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01189">_DEVICE_OBJECT::StackSize</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01054">VPB_MOUNTED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01058">VPB_RAW_MOUNT</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01057">VPB_REMOVE_PENDING</a>.
<p>
Referenced by <a class="el" href="../../d5/d2/parse_8c-source.html#l00098">IopCheckVpbMounted()</a>, and <a class="el" href="../../d5/d5/iosubs_8c-source.html#l11389">IoVerifyVolume()</a>.
<p>
<pre class="fragment"><div>04291                    :
04292 
04293     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to mount a volume on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device.  The Volume
04294     Parameter Block (<a class="code" href="../../d7/d7/struct__VPB.html">VPB</a>) for the specified device is a "clean" <a class="code" href="../../d7/d7/struct__VPB.html">VPB</a>.  That is,
04295     it indicates that the volume has never been mounted.  It is up to the file
04296     system that eventually mounts the volume to determine whether the volume is,
04297     or has been, mounted elsewhere.
04298 
04299 Arguments:
04300 
04301     DeviceObject - Pointer to device object on which the volume is to be
04302         mounted.
04303 
04304     AllowRawMount - This parameter tells us if we should continue our
04305         filesystem search to include the Raw file system.  This flag will
04306         only be passed in as TRUE as a result of a DASD open.
04307 
04308     DeviceLockAlreadyHeld - If TRUE, then the caller has already acquired
04309         the device lock and we should not attempt to acquire it.  This is
04310         currently passed in as TRUE when called from IoVerifyVolume.
04311 
04312 Return Value:
04313 
04314     The function value is a successful status code if a volume was successfully
04315     mounted on the device.  Otherwise, an error code is returned.
04316 
04317 
04318 --*/
04319 
04320 {
04321     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04322     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
04323     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
04324     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> fsDeviceObject;
04325     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> attachedDevice;
04326     PLIST_ENTRY entry;
04327     PLIST_ENTRY queueHeader;
04328     IO_STATUS_BLOCK ioStatus;
04329     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
04330     ULONG extraStack;
04331     LIST_ENTRY <a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>;
04332     ULONG rawMountOnly;
04333 
04334     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04335 
04336     <span class="comment">//</span>
04337     <span class="comment">// Obtain the lock for the device to be mounted.  This guarantees that</span>
04338     <span class="comment">// only one thread is attempting to mount (or verify) this particular</span>
04339     <span class="comment">// device at a time.</span>
04340     <span class="comment">//</span>
04341 
04342     <span class="keywordflow">if</span> (!DeviceLockAlreadyHeld) {
04343 
04344         status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;DeviceObject-&gt;DeviceLock,
04345                                         Executive,
04346                                         KeGetPreviousMode(),
04347                                         Alertable,
04348                                         (PLARGE_INTEGER) NULL );
04349 
04350         <span class="comment">//</span>
04351         <span class="comment">// If the wait ended because of an alert or an APC, return now</span>
04352         <span class="comment">// without mounting the device.  Note that as the wait for the</span>
04353         <span class="comment">// event was unsuccessful, we do not set it on exit.</span>
04354         <span class="comment">//</span>
04355 
04356         <span class="keywordflow">if</span> (status == STATUS_ALERTED || status == STATUS_USER_APC) {
04357 
04358             <span class="keywordflow">return</span> status;
04359         }
04360     }
04361 
04362     <span class="comment">//</span>
04363     <span class="comment">// Now acquire the resource database lock for the I/O system to perform this</span>
04364     <span class="comment">// operation.  This resource protects access to the file system queue.</span>
04365     <span class="comment">//</span>
04366 
04367     <span class="comment">//KeEnterCriticalRegion();</span>
04368     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( &amp;IopDatabaseResource, TRUE );
04369 
04370     <span class="comment">//</span>
04371     <span class="comment">// Check the 'mounted' flag of the VPB to ensure that it is still clear.</span>
04372     <span class="comment">// If it is, then no one has gotten in before this to mount the volume.</span>
04373     <span class="comment">// Attempt to mount the volume in this case.</span>
04374     <span class="comment">//</span>
04375 
04376     <span class="keywordflow">if</span> ((DeviceObject-&gt;Vpb-&gt;Flags &amp; (<a class="code" href="../../d0/d5/io_8h.html#a116">VPB_MOUNTED</a> | <a class="code" href="../../d0/d5/io_8h.html#a119">VPB_REMOVE_PENDING</a>)) == 0) {
04377 
04378         <span class="comment">//</span>
04379         <span class="comment">// This volume has never been mounted.  Initialize the event and set the</span>
04380         <span class="comment">// status to unsuccessful to set up for the loop.  Also if the device</span>
04381         <span class="comment">// has the verify bit set, clear it.</span>
04382         <span class="comment">//</span>
04383 
04384         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event, NotificationEvent, FALSE );
04385         status = STATUS_UNSUCCESSFUL;
04386         DeviceObject-&gt;Flags &amp;= ~<a class="code" href="../../d0/d5/io_8h.html#a122">DO_VERIFY_VOLUME</a>;
04387 
04388         <span class="comment">//</span>
04389         <span class="comment">// Get the actual device that this volume is to be mounted on.  This</span>
04390         <span class="comment">// device is the final device in the list of devices which are attached</span>
04391         <span class="comment">// to the specified real device.</span>
04392         <span class="comment">//</span>
04393 
04394         attachedDevice = DeviceObject;
04395         <span class="keywordflow">while</span> (attachedDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>) {
04396             attachedDevice = attachedDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>;
04397         }
04398 
04399         <span class="comment">//</span>
04400         <span class="comment">// Reference the device object so it cannot go away.</span>
04401         <span class="comment">//</span>
04402 
04403         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( attachedDevice );
04404 
04405         <span class="comment">//</span>
04406         <span class="comment">// Determine which type of file system should be invoked based on</span>
04407         <span class="comment">// the device type of the device being mounted.</span>
04408         <span class="comment">//</span>
04409 
04410         <span class="keywordflow">if</span> (DeviceObject-&gt;DeviceType == FILE_DEVICE_DISK ||
04411             DeviceObject-&gt;DeviceType == FILE_DEVICE_VIRTUAL_DISK) {
04412             queueHeader = &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a6">IopDiskFileSystemQueueHead</a>;
04413         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (DeviceObject-&gt;DeviceType == FILE_DEVICE_CD_ROM) {
04414             queueHeader = &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a7">IopCdRomFileSystemQueueHead</a>;
04415         } <span class="keywordflow">else</span> {
04416             queueHeader = &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a9">IopTapeFileSystemQueueHead</a>;
04417         }
04418 
04419         rawMountOnly = (DeviceObject-&gt;Vpb-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a120">VPB_RAW_MOUNT</a>);
04420 
04421         <span class="comment">//</span>
04422         <span class="comment">// Now loop through each of the file systems which have been loaded in</span>
04423         <span class="comment">// the system to see whether anyone understands the media in the device.</span>
04424         <span class="comment">//</span>
04425 
04426         <span class="keywordflow">for</span> (entry = queueHeader-&gt;Flink;
04427              entry != queueHeader &amp;&amp; !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status );
04428              entry = entry-&gt;Flink) {
04429 
04430             <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> savedFsDeviceObject;
04431 
04432             <span class="comment">//</span>
04433             <span class="comment">// If this is the final entry (Raw file system), and it is also</span>
04434             <span class="comment">// not the first entry, and a raw mount is not permitted, then</span>
04435             <span class="comment">// break out of the loop at this point, as this volume cannot</span>
04436             <span class="comment">// be mounted for the caller's purposes.</span>
04437             <span class="comment">//</span>
04438 
04439             <span class="keywordflow">if</span> (!AllowRawMount &amp;&amp; entry-&gt;Flink == queueHeader &amp;&amp; entry != queueHeader-&gt;Flink) {
04440                 <span class="keywordflow">break</span>;
04441             }
04442 
04443             <span class="comment">//</span>
04444             <span class="comment">// If raw mount is the only one requested and this is not the last entry on the list</span>
04445             <span class="comment">// then skip.</span>
04446             <span class="comment">//</span>
04447             <span class="keywordflow">if</span> (rawMountOnly &amp;&amp; (entry-&gt;Flink != queueHeader)) {
04448                 <span class="keywordflow">continue</span>;
04449             }
04450 
04451             fsDeviceObject = CONTAINING_RECORD( entry, <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">DEVICE_OBJECT</a>, Queue.ListEntry );
04452             savedFsDeviceObject = fsDeviceObject;
04453 
04454             <span class="comment">//</span>
04455             <span class="comment">// It is possible that the file system has been attached to, so</span>
04456             <span class="comment">// walk the attached list for the file system.  The number of stack</span>
04457             <span class="comment">// locations that must be allocated in the IRP must include one for</span>
04458             <span class="comment">// the file system itself, and then one for each driver that is</span>
04459             <span class="comment">// attached to it.  Account for all of the stack locations required</span>
04460             <span class="comment">// to get through the mount process.</span>
04461             <span class="comment">//</span>
04462 
04463             extraStack = 1;
04464 
04465             <span class="keywordflow">while</span> (fsDeviceObject-&gt;AttachedDevice) {
04466                 fsDeviceObject = fsDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>;
04467                 extraStack++;
04468             }
04469 
04470             <span class="comment">//</span>
04471             <span class="comment">// Another file system has been found and the volume has still not</span>
04472             <span class="comment">// been mounted.  Attempt to mount the volume using this file</span>
04473             <span class="comment">// system.</span>
04474             <span class="comment">//</span>
04475             <span class="comment">// Begin by resetting the event being used for synchronization with</span>
04476             <span class="comment">// the I/O operation.</span>
04477             <span class="comment">//</span>
04478 
04479             <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>( &amp;event );
04480 
04481             <span class="comment">//</span>
04482             <span class="comment">// Allocate and initialize an IRP for this mount operation.  Notice</span>
04483             <span class="comment">// that the flags for this operation appear the same as a page read</span>
04484             <span class="comment">// operation.  This is because the completion code for both of the</span>
04485             <span class="comment">// operations is exactly the same logic.</span>
04486             <span class="comment">//</span>
04487 
04488             irp = <a class="code" href="../../d0/d6/iop_8h.html#a149">IopAllocateIrpMustSucceed</a>( (CCHAR) (attachedDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a> + extraStack) );
04489             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a175">IRP_MOUNT_COMPLETION</a> | <a class="code" href="../../d0/d5/io_8h.html#a181">IRP_SYNCHRONOUS_PAGING_IO</a>;
04490             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>;
04491             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = &amp;event;
04492             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = &amp;ioStatus;
04493             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
04494             irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
04495             irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a26">IRP_MJ_FILE_SYSTEM_CONTROL</a>;
04496             irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a47">IRP_MN_MOUNT_VOLUME</a>;
04497             irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o2">Flags</a> = AllowRawMount;
04498             irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.MountVolume.Vpb = DeviceObject-&gt;Vpb;
04499             irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.MountVolume.DeviceObject = attachedDevice;
04500 
04501             status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( fsDeviceObject, irp );
04502 
04503             <span class="comment">//</span>
04504             <span class="comment">// Wait for the I/O operation to complete.</span>
04505             <span class="comment">//</span>
04506 
04507             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04508                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
04509                                               Executive,
04510                                               KernelMode,
04511                                               FALSE,
04512                                               (PLARGE_INTEGER) NULL );
04513             } <span class="keywordflow">else</span> {
04514 
04515                 <span class="comment">//</span>
04516                 <span class="comment">// Ensure that the proper status value gets picked up.</span>
04517                 <span class="comment">//</span>
04518 
04519                 ioStatus.Status = status;
04520                 ioStatus.Information = 0;
04521             }
04522 
04523             <span class="comment">//</span>
04524             <span class="comment">// If the operation was successful then set the VPB as mounted.</span>
04525             <span class="comment">//</span>
04526 
04527             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( ioStatus.Status )) {
04528                 status = ioStatus.Status;
04529                 DeviceObject-&gt;Vpb-&gt;Flags = <a class="code" href="../../d0/d5/io_8h.html#a116">VPB_MOUNTED</a>;
04530 
04531                 <span class="comment">//</span>
04532                 <span class="comment">// We explicitly propagate VPB_RAW_MOUNT as the previous</span>
04533                 <span class="comment">// statement that has been there for a long time in NT</span>
04534                 <span class="comment">// could be clearing other flags which should be cleared.</span>
04535                 <span class="comment">//</span>
04536                 <span class="keywordflow">if</span> (rawMountOnly) { 
04537                     DeviceObject-&gt;Vpb-&gt;Flags |= <a class="code" href="../../d0/d5/io_8h.html#a120">VPB_RAW_MOUNT</a>;
04538                 }
04539                 DeviceObject-&gt;Vpb-&gt;DeviceObject-&gt;StackSize = (UCHAR) (attachedDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a> + 1);
04540 
04541             } <span class="keywordflow">else</span> {
04542 
04543                 <span class="comment">//</span>
04544                 <span class="comment">// The mount operation failed.  Make a special check here to</span>
04545                 <span class="comment">// determine whether or not a popup was enabled, and if so,</span>
04546                 <span class="comment">// check to see whether or not the operation was to be aborted.</span>
04547                 <span class="comment">// If so, bail out now and return the error to the caller.</span>
04548                 <span class="comment">//</span>
04549 
04550                 status = ioStatus.Status;
04551                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/io_8h.html#a232">IoIsErrorUserInduced</a>(status) &amp;&amp;
04552                     ioStatus.Information == <a class="code" href="../../d0/d6/iop_8h.html#a0">IOP_ABORT</a>) {
04553                     <span class="keywordflow">break</span>;
04554                 }
04555 
04556                 <span class="comment">//</span>
04557                 <span class="comment">// Also check to see whether or not this is a volume that has</span>
04558                 <span class="comment">// been recognized, but the file system for it needs to be</span>
04559                 <span class="comment">// loaded.  If so, drop the locks held at this point, tell the</span>
04560                 <span class="comment">// mini-file system recognizer to load the driver, and then</span>
04561                 <span class="comment">// reacquire the locks.</span>
04562                 <span class="comment">//</span>
04563 
04564                 <span class="keywordflow">if</span> (status == STATUS_FS_DRIVER_REQUIRED) {
04565 
04566                     <span class="comment">//</span>
04567                     <span class="comment">// Increment the number of reasons that this driver cannot</span>
04568                     <span class="comment">// be unloaded.  Note that this must be done while still</span>
04569                     <span class="comment">// holding the database resource.</span>
04570                     <span class="comment">//</span>
04571 
04572                     <a class="code" href="../../d5/d8/ex_8h.html#a235">ExInterlockedAddUlong</a>( &amp;savedFsDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o2">ReferenceCount</a>,
04573                                            1,
04574                                            &amp;IopDatabaseLock );
04575 
04576                     <span class="comment">//</span>
04577                     <span class="comment">// Release the locks, load the new file system, and unload</span>
04578                     <span class="comment">// the recognizer.</span>
04579                     <span class="comment">//</span>
04580 
04581                     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( &amp;IopDatabaseResource );
04582                     <span class="comment">//KeLeaveCriticalRegion();</span>
04583                     <span class="keywordflow">if</span> (!DeviceLockAlreadyHeld) {
04584                         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;DeviceObject-&gt;DeviceLock, 0, FALSE );
04585                     }
04586                     <a class="code" href="../../d0/d6/iop_8h.html#a192">IopLoadFileSystemDriver</a>( savedFsDeviceObject );
04587 
04588                     <span class="comment">//</span>
04589                     <span class="comment">// Now reacquire the locks, in the correct order, and check</span>
04590                     <span class="comment">// to see if the volume has been mounted before we could</span>
04591                     <span class="comment">// get back.  If so, exit; otherwise, restart the file</span>
04592                     <span class="comment">// file system queue scan from the beginning.</span>
04593                     <span class="comment">//</span>
04594 
04595                     <span class="keywordflow">if</span> (!DeviceLockAlreadyHeld) {
04596                         status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;DeviceObject-&gt;DeviceLock,
04597                                                         Executive,
04598                                                         KeGetPreviousMode(),
04599                                                         Alertable,
04600                                                         (PLARGE_INTEGER) NULL );
04601                         <span class="keywordflow">if</span> (status == STATUS_ALERTED || status == STATUS_USER_APC) {
04602 
04603                             <span class="comment">//</span>
04604                             <span class="comment">// The device was not mounted by us so</span>
04605                             <span class="comment">// drop the reference before returning.</span>
04606                             <span class="comment">//</span>
04607 
04608                             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( attachedDevice );
04609 
04610                             <span class="keywordflow">return</span> status;
04611                         }
04612                     }
04613 
04614                     <span class="comment">//KeEnterCriticalRegion();</span>
04615                     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( &amp;IopDatabaseResource, TRUE );
04616 
04617                     <span class="keywordflow">if</span> (DeviceObject-&gt;Vpb-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a116">VPB_MOUNTED</a>) {
04618 
04619                         <span class="comment">//</span>
04620                         <span class="comment">//  This volume was mounted before we got back.</span>
04621                         <span class="comment">//</span>
04622 
04623                         status = STATUS_SUCCESS;
04624                         <span class="keywordflow">break</span>;
04625                     }
04626 
04627                     <span class="comment">//</span>
04628                     <span class="comment">// Reset the list back to the beginning and start over</span>
04629                     <span class="comment">// again.</span>
04630                     <span class="comment">//</span>
04631 
04632                     <a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>.Flink = queueHeader-&gt;Flink;
04633                     entry = &amp;<a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>;
04634                     status = STATUS_UNRECOGNIZED_VOLUME;
04635                 }
04636 
04637                 <span class="comment">//</span>
04638                 <span class="comment">// If the error wasn't STATUS_UNRECOGNIZED_VOLUME, and this</span>
04639                 <span class="comment">// request is not going to the Raw file system, then there</span>
04640                 <span class="comment">// is no reason to continue looping.</span>
04641                 <span class="comment">//</span>
04642 
04643                 <span class="keywordflow">if</span> (!AllowRawMount &amp;&amp; (status != STATUS_UNRECOGNIZED_VOLUME) &amp;&amp;
04644                     <a class="code" href="../../d1/d8/fsrtl_8h.html#a111">FsRtlIsTotalDeviceFailure</a>(status)) {
04645                     <span class="keywordflow">break</span>;
04646                 }
04647             }
04648         }
04649 
04650         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04651 
04652             <span class="comment">//</span>
04653             <span class="comment">// The device was not mounted by us so</span>
04654             <span class="comment">// drop the reference.</span>
04655             <span class="comment">//</span>
04656 
04657             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( attachedDevice );
04658 
04659         }
04660 
04661     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>((DeviceObject-&gt;Vpb-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a119">VPB_REMOVE_PENDING</a>) != 0) {
04662 
04663         <span class="comment">//</span>
04664         <span class="comment">// Pnp is attempting to remove this volume.  Don't allow the mount.</span>
04665         <span class="comment">//</span>
04666 
04667         status = STATUS_DEVICE_DOES_NOT_EXIST;
04668 
04669     } <span class="keywordflow">else</span> {
04670 
04671         <span class="comment">//</span>
04672         <span class="comment">// The volume for this device has already been mounted.  Return a</span>
04673         <span class="comment">// success code.</span>
04674         <span class="comment">//</span>
04675 
04676         status = STATUS_SUCCESS;
04677     }
04678 
04679     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( &amp;IopDatabaseResource );
04680     <span class="comment">//KeLeaveCriticalRegion();</span>
04681 
04682     <span class="comment">//</span>
04683     <span class="comment">// Release the I/O database resource lock and the synchronization event for</span>
04684     <span class="comment">// the device.</span>
04685     <span class="comment">//</span>
04686 
04687     <span class="keywordflow">if</span> (!DeviceLockAlreadyHeld) {
04688         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;DeviceObject-&gt;DeviceLock, 0, FALSE );
04689     }
04690 
04691     <span class="comment">//</span>
04692     <span class="comment">// Finally, if the mount operation failed, and the target device is the</span>
04693     <span class="comment">// boot partition, then bugcheck the system.  It is not possible for the</span>
04694     <span class="comment">// system to run properly if the system's boot partition cannot be mounted.</span>
04695     <span class="comment">//</span>
04696     <span class="comment">// Note: Don't bugcheck if the system is already booted.</span>
04697     <span class="comment">//</span>
04698 
04699     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) &amp;&amp;
04700         DeviceObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a129">DO_SYSTEM_BOOT_PARTITION</a> &amp;&amp;
04701         <a class="code" href="../../d8/d1/init_8h.html#a21">InitializationPhase</a> &lt; 2) {
04702         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( INACCESSIBLE_BOOT_DEVICE, (ULONG_PTR) DeviceObject, status, 0, 0 );
04703     }
04704 
04705     <span class="keywordflow">return</span> status;
04706 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a55" doxytag="internal.c::IopNotifyPnpWhenChainDereferenced" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopNotifyPnpWhenChainDereferenced           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>PhysicalDeviceObjects</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObjectCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Query</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>VetoingDevice</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l04947">4947</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01181">_DEVICE_OBJECT::AttachedDevice</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01222">DOE_REMOVE_PENDING</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01223">DOE_REMOVE_PROCESSED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01268">_DEVOBJ_EXTENSION::ExtensionFlags</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l00084">IopChainDereferenceComplete()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00054">IopDatabaseLock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01178">_DEVICE_OBJECT::ReferenceCount</a>.
<p>
<pre class="fragment"><div>04956                    :
04957 
04958     Called by PnP when processing a Surprise Removal or a Query Remove.
04959 
04960     In <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">case</span> of Surprise Removal <span class="keyword">this</span> function will set <a class="code" href="../../d0/d5/io_8h.html#a140">DOE_REMOVE_PENDING</a>
04961     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a> flags of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> each PDO and all its attached devices.
04962     For each PDO (and its attachment chain) which currently has a zero
04963     ReferenceCount <a class="code" href="../../d0/d5/io_8h.html#a140">DOE_REMOVE_PENDING</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> reset and <a class="code" href="../../d0/d5/io_8h.html#a141">DOE_REMOVE_PROCESSED</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
04964     set.  <a class="code" href="../../d3/d0/pnpdel_8c.html#a6">IopChainDereferenceComplete</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> then called to notify PnP that
04965     <span class="keyword">this</span> PDO <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ready <span class="keywordflow">for</span> removal.
04966 
04967     Then as each remaining PDO and its attachment chain's ReferenceCount drops
04968     to zero IopCheckUnloadOrDelete will call <a class="code" href="../../d3/d0/pnpdel_8c.html#a6">IopChainDereferenceComplete</a>
04969     (supplied by PnP).
04970 
04971     In <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">case</span> of Query Remove <span class="keyword">this</span> function set <a class="code" href="../../d0/d5/io_8h.html#a141">DOE_REMOVE_PROCESSED</a> on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04972     PDO and all its attached devices to prevent further opens.  It also checks
04973     to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ReferenceCount <span class="keywordflow">for</span> all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDOs and their attached devices <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
04974     zero.  If so <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> leaves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d5/io_8h.html#a141">DOE_REMOVE_PROCESSED</a> set and returns <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.  If
04975     not, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> resets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d5/io_8h.html#a141">DOE_REMOVE_PROCESSED</a> on all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDOs and their attached
04976     devices and returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>.
04977 
04978 Arguments:
04979 
04980     PhysicalDeviceObjects   <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> of PDEVICE_OBJECTs <span class="keywordflow">for</span> all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDOs to be
04981                             checked.
04982 
04983     DeviceObjectCount       <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> of PDEVICE_OBJECTs in PhysicalDeviceObjects.
04984 
04985     Query                   <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> a Query Remove.
04986 
04987     VetoingDevice           Only used <span class="keywordflow">for</span> Query Remove, Set to first PDO with a
04988                             ReferenceCount not equal to zero.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to
04989                             provide feedback to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user as to why <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query
04990                             may have failed.
04991 
04992 
04993 Return Value:
04994 
04995     If Query <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">return</span> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> there are outstanding
04996     opens on any of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDOs or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> attached devices, otherwise <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
04997     returned.
04998 
04999     If Query <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> NOT set then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">return</span> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> always <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>.
05000 
05001 --*/
05002 
05003 {
05004     <a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html">PDEVOBJ_EXTENSION</a> deviceExtension;
05005     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
05006     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> attachedDeviceObject;
05007     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
05008     ULONG referenced;
05009     ULONG pass1SetFlag;
05010     ULONG pass1ClearFlag;
05011     LONG i;
05012     KIRQL irql;
05013 
05014     ExAcquireSpinLock( &amp;IopDatabaseLock, &amp;irql );
05015 
05016     <span class="keywordflow">if</span> (Query) {
05017         pass1SetFlag = <a class="code" href="../../d0/d5/io_8h.html#a141">DOE_REMOVE_PROCESSED</a>;
05018         pass1ClearFlag = 0;
05019     } <span class="keywordflow">else</span> {
05020         pass1SetFlag = <a class="code" href="../../d0/d5/io_8h.html#a140">DOE_REMOVE_PENDING</a>;
05021         pass1ClearFlag = <a class="code" href="../../d0/d5/io_8h.html#a141">DOE_REMOVE_PROCESSED</a>;
05022     }
05023 
05024     <span class="keywordflow">for</span> (i = 0; i &lt; (LONG)DeviceObjectCount; i++) {
05025         deviceObject = PhysicalDeviceObjects[i];
05026         deviceExtension = deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>;
05027 
05028         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceExtension-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
05029 
05030         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( deviceNode != NULL );
05031 
05032         <span class="comment">//</span>
05033         <span class="comment">// Assume that at least one device object has a reference.  Walk the</span>
05034         <span class="comment">// entire chain marking them with DOE_REMOVE_PENDING.</span>
05035         <span class="comment">//</span>
05036 
05037         <span class="comment">//</span>
05038         <span class="comment">// We don't actually care how many aggregate references there actually</span>
05039         <span class="comment">// are.  All we're interested in is whether there are any.  So we'll OR</span>
05040         <span class="comment">// them together rather than adding them.  That way we don't have to do</span>
05041         <span class="comment">// testing or branching and we don't have to worry about overflow in the</span>
05042         <span class="comment">// highly unlikely event that there are a total of more references than</span>
05043         <span class="comment">// will fit in a ULONG.</span>
05044         <span class="comment">//</span>
05045 
05046         referenced = 0;
05047         attachedDeviceObject = deviceObject;
05048         <span class="keywordflow">do</span> {
05049             deviceExtension = attachedDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>;
05050 
05051             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceExtension != NULL);
05052             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(deviceExtension-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> &amp; pass1SetFlag));
05053 
05054 
05055             deviceExtension-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> &amp;= ~pass1ClearFlag;
05056             deviceExtension-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> |= pass1SetFlag;
05057             referenced |= attachedDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o2">ReferenceCount</a>;
05058 
05059             attachedDeviceObject = attachedDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>;
05060 
05061         } <span class="keywordflow">while</span> (attachedDeviceObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05062 
05063         <span class="keywordflow">if</span> (!Query &amp;&amp; referenced == 0) {
05064 
05065             <span class="comment">//</span>
05066             <span class="comment">// There aren't any outstanding references, retraverse the chain and</span>
05067             <span class="comment">// mark them all DOE_REMOVE_PROCESSED.  This will still prevent any</span>
05068             <span class="comment">// opens or attaches from occuring but we won't call</span>
05069             <span class="comment">// IopChainDereferenceComplete in IopCompleteUnloadOrDelete.</span>
05070             <span class="comment">//</span>
05071 
05072             attachedDeviceObject = deviceObject;
05073             <span class="keywordflow">do</span> {
05074                 deviceExtension = attachedDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>;
05075 
05076                 deviceExtension-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> &amp;= ~<a class="code" href="../../d0/d5/io_8h.html#a140">DOE_REMOVE_PENDING</a>;
05077                 deviceExtension-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a141">DOE_REMOVE_PROCESSED</a>;
05078 
05079                 attachedDeviceObject = attachedDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>;
05080 
05081             } <span class="keywordflow">while</span> (attachedDeviceObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05082 
05083             ExReleaseSpinLock( &amp;IopDatabaseLock, irql );
05084 
05085             <a class="code" href="../../d9/d0/pnpiop_8h.html#a316">IopChainDereferenceComplete</a>( deviceObject );
05086 
05087             ExAcquireSpinLock( &amp;IopDatabaseLock, &amp;irql );
05088         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Query &amp;&amp; referenced != 0) {
05089             <span class="keywordflow">break</span>;
05090         }
05091     }
05092 
05093     <span class="keywordflow">if</span> (Query &amp;&amp; referenced != 0) {
05094 
05095         <span class="keywordflow">if</span> (VetoingDevice != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05096             *VetoingDevice = deviceObject;
05097         }
05098 
05099         <span class="keywordflow">for</span> (; i &gt;= 0; i--) {
05100             deviceObject = PhysicalDeviceObjects[i];
05101             deviceExtension = deviceObject-&gt;DeviceObjectExtension;
05102 
05103             <span class="comment">//</span>
05104             <span class="comment">// There are outstanding references, retraverse the chain and</span>
05105             <span class="comment">// unset DOE_REMOVE_PROCESSED.</span>
05106             <span class="comment">//</span>
05107 
05108             attachedDeviceObject = deviceObject;
05109             <span class="keywordflow">do</span> {
05110                 deviceExtension = attachedDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>;
05111 
05112                 deviceExtension-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> &amp;= ~<a class="code" href="../../d0/d5/io_8h.html#a141">DOE_REMOVE_PROCESSED</a>;
05113 
05114                 attachedDeviceObject = attachedDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>;
05115 
05116             } <span class="keywordflow">while</span> (attachedDeviceObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05117         }
05118     }
05119 
05120     ExReleaseSpinLock( &amp;IopDatabaseLock, irql );
05121 
05122     <span class="keywordflow">return</span> !Query || referenced != 0;
05123 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a56" doxytag="internal.c::IopOpenLinkOrRenameTarget" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopOpenLinkOrRenameTarget           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>RenameBuffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l05126">5126</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d5/io_8h.html#a600a406">CreateFileTypeNone</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00047">FileName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01507">FO_OPENED_CASE_SENSITIVE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00233">IO_FORCE_ACCESS_CHECK</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00243">IO_NO_PARAMETER_CHECKING</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00235">IO_OPEN_TARGET_DIRECTORY</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l04502">IoCreateFile()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00044">IoFileObjectType</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09835">IoSetInformation()</a>, and <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00849">NtSetInformationFile()</a>.
<p>
<pre class="fragment"><div>05135                    :
05136 
05137     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> rename, set link and set copy-on-write code
05138     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O system's <a class="code" href="../../d6/d9/restrfil_8c.html#a38">NtSetInformationFile</a> system service when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller has
05139     specified a fully qualified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> name as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target of a rename, set link,
05140     or set copy-on-write operation.  This routine attempts to open <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent
05141     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> and checks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
05142 
05143         o   If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> itself exists, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller must have specified that
05144             <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be replaced, otherwise an error <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
05145 
05146         o   Ensures that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> specification refers to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same volume
05147             upon which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> exists.
05148 
05149 Arguments:
05150 
05151     TargetHandle - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a variable to <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle to
05152         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> opened target <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <span class="keywordflow">if</span> no errors have occurred.
05153 
05154     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> that represents <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current rename
05155         request.
05156 
05157     RenameBuffer - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system intermediate buffer that
05158         contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's rename parameters.
05159 
05160     FileObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object representing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
05161         being renamed.
05162 
05163 Return Value:
05164 
05165     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
05166 
05167 Note:
05168 
05169     This function assumes that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> layout of a rename, set link and set
05170     copy-on-write information structure are exactly <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same.
05171 
05172 --*/
05173 
05174 {
05175     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05176     IO_STATUS_BLOCK ioStatus;
05177     HANDLE handle;
05178     OBJECT_ATTRIBUTES objectAttributes;
05179     UNICODE_STRING newFileName;
05180     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
05181     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> targetFileObject;
05182     <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a> handleInformation;
05183     PFILE_RENAME_INFORMATION renameBuffer = RenameBuffer;
05184 
05185     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05186 
05187     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <span class="keyword">sizeof</span>( FILE_RENAME_INFORMATION ) ==
05188             <span class="keyword">sizeof</span>( FILE_LINK_INFORMATION ) );
05189     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FIELD_OFFSET( FILE_RENAME_INFORMATION, ReplaceIfExists ) ==
05190             FIELD_OFFSET( FILE_LINK_INFORMATION, ReplaceIfExists ) );
05191     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FIELD_OFFSET( FILE_RENAME_INFORMATION, RootDirectory ) ==
05192             FIELD_OFFSET( FILE_LINK_INFORMATION, RootDirectory ) );
05193     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FIELD_OFFSET( FILE_RENAME_INFORMATION, FileNameLength ) ==
05194             FIELD_OFFSET( FILE_LINK_INFORMATION, FileNameLength ) );
05195     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FIELD_OFFSET( FILE_RENAME_INFORMATION, FileName ) ==
05196             FIELD_OFFSET( FILE_LINK_INFORMATION, FileName ) );
05197 
05198     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <span class="keyword">sizeof</span>( FILE_RENAME_INFORMATION ) ==
05199             <span class="keyword">sizeof</span>( FILE_MOVE_CLUSTER_INFORMATION ) );
05200     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FIELD_OFFSET( FILE_RENAME_INFORMATION, ReplaceIfExists ) ==
05201             FIELD_OFFSET( FILE_MOVE_CLUSTER_INFORMATION, ClusterCount ) );
05202     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FIELD_OFFSET( FILE_RENAME_INFORMATION, RootDirectory ) ==
05203             FIELD_OFFSET( FILE_MOVE_CLUSTER_INFORMATION, RootDirectory ) );
05204     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FIELD_OFFSET( FILE_RENAME_INFORMATION, FileNameLength ) ==
05205             FIELD_OFFSET( FILE_MOVE_CLUSTER_INFORMATION, FileNameLength ) );
05206     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FIELD_OFFSET( FILE_RENAME_INFORMATION, FileName ) ==
05207             FIELD_OFFSET( FILE_MOVE_CLUSTER_INFORMATION, FileName ) );
05208 
05209     <span class="comment">//</span>
05210     <span class="comment">// A fully qualified file name was specified.  Begin by attempting to open</span>
05211     <span class="comment">// the parent directory of the specified target file.</span>
05212     <span class="comment">//</span>
05213 
05214     newFileName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) renameBuffer-&gt;FileNameLength;
05215     newFileName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) renameBuffer-&gt;FileNameLength;
05216     newFileName.Buffer = renameBuffer-&gt;FileName;
05217 
05218     InitializeObjectAttributes( &amp;objectAttributes,
05219                                 &amp;newFileName,
05220                                 FileObject-&gt;Flags &amp; FO_OPENED_CASE_SENSITIVE ? 0 : OBJ_CASE_INSENSITIVE,
05221                                 renameBuffer-&gt;RootDirectory,
05222                                 (PSECURITY_DESCRIPTOR) NULL );
05223 
05224     status = <a class="code" href="../../d4/d6/iosubs_8c.html#a46">IoCreateFile</a>( &amp;handle,
05225                            FILE_WRITE_DATA | SYNCHRONIZE,
05226                            &amp;objectAttributes,
05227                            &amp;ioStatus,
05228                            (PLARGE_INTEGER) NULL,
05229                            0,
05230                            FILE_SHARE_READ | FILE_SHARE_WRITE,
05231                            FILE_OPEN,
05232                            FILE_OPEN_FOR_BACKUP_INTENT,
05233                            (PVOID) NULL,
05234                            0L,
05235                            CreateFileTypeNone,
05236                            (PVOID) NULL,
05237                            IO_NO_PARAMETER_CHECKING |
05238                            IO_OPEN_TARGET_DIRECTORY |
05239                            IO_FORCE_ACCESS_CHECK );
05240     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
05241         <span class="comment">//</span>
05242         <span class="comment">// The open operation for the target file's parent directory was</span>
05243         <span class="comment">// successful.  Check to see whether or not the file exists.</span>
05244         <span class="comment">//</span>
05245 
05246         irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( Irp );
05247         <span class="keywordflow">if</span> (irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.SetFile.FileInformationClass == FileLinkInformation &amp;&amp;
05248             !renameBuffer-&gt;ReplaceIfExists &amp;&amp;
05249             ioStatus.Information == FILE_EXISTS) {
05250 
05251             <span class="comment">//</span>
05252             <span class="comment">// The target file exists, and the caller does not want to replace</span>
05253             <span class="comment">// it.  This is a name collision error so cleanup and return.</span>
05254             <span class="comment">//</span>
05255 
05256             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( handle );
05257             status = STATUS_OBJECT_NAME_COLLISION;
05258 
05259         } <span class="keywordflow">else</span> {
05260 
05261             <span class="comment">//</span>
05262             <span class="comment">// Everything up to this point is fine, so dereference the handle</span>
05263             <span class="comment">// to a pointer to the file object and ensure that the two file</span>
05264             <span class="comment">// specifications refer to the same device.</span>
05265             <span class="comment">//</span>
05266 
05267             status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( handle,
05268                                               FILE_WRITE_DATA,
05269                                               IoFileObjectType,
05270                                               UserMode,
05271                                               (PVOID *) &amp;targetFileObject,
05272                                               &amp;handleInformation );
05273             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
05274 
05275                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( targetFileObject );
05276 
05277                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( targetFileObject) !=
05278                     <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject )) {
05279 
05280                     <span class="comment">//</span>
05281                     <span class="comment">// The two files refer to different devices.  Clean everything</span>
05282                     <span class="comment">// up and return an appropriate error.</span>
05283                     <span class="comment">//</span>
05284 
05285                     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( handle );
05286                     status = STATUS_NOT_SAME_DEVICE;
05287 
05288                 } <span class="keywordflow">else</span> {
05289 
05290                     <span class="comment">//</span>
05291                     <span class="comment">// Otherwise, everything worked, so allow the rename operation</span>
05292                     <span class="comment">// to continue.</span>
05293                     <span class="comment">//</span>
05294 
05295                     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.SetFile.FileObject = targetFileObject;
05296                     *TargetHandle = handle;
05297                     status = STATUS_SUCCESS;
05298 
05299                 }
05300 
05301             } <span class="keywordflow">else</span> {
05302 
05303                 <span class="comment">//</span>
05304                 <span class="comment">// There was an error referencing the handle to what should</span>
05305                 <span class="comment">// have been the target directory.  This generally means that</span>
05306                 <span class="comment">// there was a resource problem or the handle was invalid, etc.</span>
05307                 <span class="comment">// Simply attempt to close the handle and return the error.</span>
05308                 <span class="comment">//</span>
05309 
05310                 <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( handle );
05311 
05312             }
05313 
05314         }
05315     }
05316 
05317     <span class="comment">//</span>
05318     <span class="comment">// Return the final status of the operation.</span>
05319     <span class="comment">//</span>
05320 
05321     <span class="keywordflow">return</span> status;
05322 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a57" doxytag="internal.c::IopOpenRegistryKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopOpenRegistryKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE BaseHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Create</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">5325</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d1/d5/consubs_8c-source.html#l00023">Create()</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/netboot_8c-source.html#l00314">IopAddRemoteBootValuesToRegistry()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l02036">IopApplyFunctionToServiceInstances()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01690">IopApplyFunctionToSubKeys()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l09046">IopBootLog()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03841">IopCleanupDeviceRegistryValues()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l09157">IopCopyBootLogRegistryToFile()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00087">IopCreateMadeupNode()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l05338">IopDeleteLegacyKey()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03651">IopDeviceObjectFromDeviceInstance()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03776">IopDeviceObjectToDeviceInstance()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l02609">IopDriverLoadingFailed()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03967">IopGetDeviceResourcesFromRegistry()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l05221">IopGetGroupOrderIndex()</a>, <a class="el" href="../../d2/d7/report_8c-source.html#l00066">IopInitializeResourceMap()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03071">IopIsAnyDeviceInstanceEnabled()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03332">IopIsDeviceInstanceEnabled()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04169">IopLoadUnloadDriver()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01588">IopOpenCurrentHwProfileDeviceInstanceKey()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01342">IopOpenServiceEnumKeys()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00753">IopPrepareDriverLoading()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04379">IopReadDumpRegistry()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l08822">IopSafebootDriverLoad()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00964">IopServiceInstanceToDeviceInstance()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l01982">IopSetupRemoteBootCard()</a>, <a class="el" href="../../d0/d0/dockhwp_8c-source.html#l00862">IopUpdateHardwareProfile()</a>, <a class="el" href="../../d2/d7/report_8c-source.html#l00760">IopWriteResourceList()</a>, <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00070">IoQueryDeviceDescription()</a>, <a class="el" href="../../d2/d7/report_8c-source.html#l00193">IoReportHalResourceUsage()</a>, <a class="el" href="../../d9/d3/loadunld_8c-source.html#l00244">NtUnloadDriver()</a>, <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00223">pIoQueryBusDescription()</a>, and <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00565">pIoQueryDeviceDescription()</a>.
<p>
<pre class="fragment"><div>05335                    :
05336 
05337     Opens or creates a <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a5">VOLATILE</a> registry key <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name passed in based
05338     at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> BaseHandle node.
05339 
05340 Arguments:
05341 
05342     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle which will contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry key that
05343         was opened.
05344 
05345     BaseHandle - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> from which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key must be opened.
05346 
05347     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> - <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> that must be opened/created.
05348 
05349     DesiredAccess - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller needs to
05350         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key.
05351 
05352     <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> - Determines <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be created <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> does not exist.
05353 
05354 Return Value:
05355 
05356    The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
05357 
05358 --*/
05359 
05360 {
05361     OBJECT_ATTRIBUTES objectAttributes;
05362     ULONG disposition;
05363 
05364     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05365 
05366     <span class="comment">//</span>
05367     <span class="comment">// Initialize the object for the key.</span>
05368     <span class="comment">//</span>
05369 
05370     InitializeObjectAttributes( &amp;objectAttributes,
05371                                 KeyName,
05372                                 OBJ_CASE_INSENSITIVE,
05373                                 BaseHandle,
05374                                 (PSECURITY_DESCRIPTOR) NULL );
05375 
05376     <span class="comment">//</span>
05377     <span class="comment">// Create the key or open it, as appropriate based on the caller's</span>
05378     <span class="comment">// wishes.</span>
05379     <span class="comment">//</span>
05380 
05381     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a>) {
05382         <span class="keywordflow">return</span> ZwCreateKey( Handle,
05383                             DesiredAccess,
05384                             &amp;objectAttributes,
05385                             0,
05386                             (PUNICODE_STRING) NULL,
05387                             REG_OPTION_VOLATILE,
05388                             &amp;disposition );
05389     } <span class="keywordflow">else</span> {
05390         <span class="keywordflow">return</span> ZwOpenKey( Handle,
05391                           DesiredAccess,
05392                           &amp;objectAttributes );
05393     }
05394 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a58" doxytag="internal.c::IopQueryXxxInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryXxxInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>InformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Information</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnedLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>FileInformation</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l05397">5397</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01492">FO_ALERTABLE_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01491">FO_SYNCHRONOUS_IO</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00652">IoAllocateIrp()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00595">IopAcquireFastLock</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00181">IopAcquireFileObjectLock()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00284">IopAllocateIrpCleanup()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00417">IopCancelAlertedRequest()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l01103">IopQueueThreadIrp</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l01157">IopReleaseFileObjectLock</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01554">IRP_BUFFERED_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00060">IRP_MJ_QUERY_INFORMATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00065">IRP_MJ_QUERY_VOLUME_INFORMATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01552">IRP_SYNCHRONOUS_API</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o24">_IRP::Overlay</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01641">_IRP::RequestorMode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01189">_DEVICE_OBJECT::StackSize</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08628">IoQueryFileInformation()</a>, and <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08683">IoQueryVolumeInformation()</a>.
<p>
<pre class="fragment"><div>05408                    :
05409 
05410     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested information about a specified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
05411     or volume.  The information returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> determined by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">class </span>that
05412     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified, and <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> placed into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's output buffer.
05413 
05414 Arguments:
05415 
05416     FileObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object about which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested
05417         information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
05418 
05419     FsInformationClass - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of information which should be
05420         returned about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>/volume.
05421 
05422     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer in bytes.
05423 
05424     FsInformation - Supplies a buffer to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested information
05425         returned about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  This buffer must not be pageable and must
05426         reside in system space.
05427 
05428     ReturnedLength - Supplies a variable that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
05429         information written to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
05430 
05431     FileInformation - <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a21">Boolean</a> that indicates whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information requested
05432         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> for a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> or a volume.
05433 
05434 Return Value:
05435 
05436     The status returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> final completion status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
05437 
05438 --*/
05439 
05440 {
05441     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
05442     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05443     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
05444     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
05445     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
05446     IO_STATUS_BLOCK localIoStatus;
05447     BOOLEAN synchronousIo;
05448 
05449     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05450 
05451     <span class="comment">//</span>
05452     <span class="comment">// Reference the file object here so that no special checks need be made</span>
05453     <span class="comment">// in I/O completion to determine whether or not to dereference the file</span>
05454     <span class="comment">// object.</span>
05455     <span class="comment">//</span>
05456 
05457     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( FileObject );
05458 
05459     <span class="comment">//</span>
05460     <span class="comment">// Make a special check here to determine whether this is a synchronous</span>
05461     <span class="comment">// I/O operation.  If it is, then wait here until the file is owned by</span>
05462     <span class="comment">// the current thread.  If this is not a (serialized) synchronous I/O</span>
05463     <span class="comment">// operation, then initialize the local event.</span>
05464     <span class="comment">//</span>
05465 
05466     <span class="keywordflow">if</span> (FileObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>) {
05467 
05468         BOOLEAN interrupted;
05469 
05470         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a13">IopAcquireFastLock</a>( FileObject )) {
05471             status = <a class="code" href="../../d0/d6/iop_8h.html#a147">IopAcquireFileObjectLock</a>( FileObject,
05472                                                KernelMode,
05473                                                (BOOLEAN) ((FileObject-&gt;Flags &amp; FO_ALERTABLE_IO) != 0),
05474                                                &amp;interrupted );
05475             <span class="keywordflow">if</span> (interrupted) {
05476                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( FileObject );
05477                 <span class="keywordflow">return</span> status;
05478             }
05479         }
05480         <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>( &amp;FileObject-&gt;Event );
05481         synchronousIo = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05482     } <span class="keywordflow">else</span> {
05483         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event, SynchronizationEvent, FALSE );
05484         synchronousIo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05485     }
05486 
05487     <span class="comment">//</span>
05488     <span class="comment">// Get the address of the target device object.</span>
05489     <span class="comment">//</span>
05490 
05491     deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject );
05492 
05493     <span class="comment">//</span>
05494     <span class="comment">// Allocate and initialize the I/O Request Packet (IRP) for this operation.</span>
05495     <span class="comment">// The allocation is performed with an exception handler in case the</span>
05496     <span class="comment">// caller does not have enough quota to allocate the packet.</span>
05497     <span class="comment">//</span>
05498 
05499     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a17">IoAllocateIrp</a>( deviceObject-&gt;StackSize, TRUE );
05500     <span class="keywordflow">if</span> (!irp) {
05501 
05502         <span class="comment">//</span>
05503         <span class="comment">// An IRP could not be allocated.  Cleanup and return an appropriate</span>
05504         <span class="comment">// error status code.</span>
05505         <span class="comment">//</span>
05506 
05507         <a class="code" href="../../d0/d6/iop_8h.html#a148">IopAllocateIrpCleanup</a>( FileObject, (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) NULL );
05508 
05509         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05510     }
05511     irp-&gt;Tail.Overlay.OriginalFileObject = FileObject;
05512     irp-&gt;Tail.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
05513     irp-&gt;RequestorMode = <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>;
05514 
05515     <span class="comment">//</span>
05516     <span class="comment">// Fill in the service independent parameters in the IRP.</span>
05517     <span class="comment">//</span>
05518 
05519     <span class="keywordflow">if</span> (synchronousIo) {
05520         irp-&gt;UserEvent = (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05521     } <span class="keywordflow">else</span> {
05522         irp-&gt;UserEvent = &amp;event;
05523         irp-&gt;Flags = <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a>;
05524     }
05525     irp-&gt;UserIosb = &amp;localIoStatus;
05526     irp-&gt;Overlay.AsynchronousParameters.UserApcRoutine = (PIO_APC_ROUTINE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05527 
05528     <span class="comment">//</span>
05529     <span class="comment">// Get a pointer to the stack location for the first driver.  This will be</span>
05530     <span class="comment">// used to pass the original function codes and parameters.</span>
05531     <span class="comment">//</span>
05532 
05533     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
05534     irpSp-&gt;MajorFunction = FileInformation ?
05535                            <a class="code" href="../../d0/d5/io_8h.html#a18">IRP_MJ_QUERY_INFORMATION</a> :
05536                            <a class="code" href="../../d0/d5/io_8h.html#a23">IRP_MJ_QUERY_VOLUME_INFORMATION</a>;
05537     irpSp-&gt;FileObject = FileObject;
05538 
05539     <span class="comment">//</span>
05540     <span class="comment">// Set the system buffer address to the address of the caller's buffer and</span>
05541     <span class="comment">// set the flags so that the buffer is not deallocated.</span>
05542     <span class="comment">//</span>
05543 
05544     irp-&gt;AssociatedIrp.SystemBuffer = Information;
05545     irp-&gt;Flags |= <a class="code" href="../../d0/d5/io_8h.html#a178">IRP_BUFFERED_IO</a>;
05546 
05547     <span class="comment">//</span>
05548     <span class="comment">// Copy the caller's parameters to the service-specific portion of the</span>
05549     <span class="comment">// IRP.</span>
05550     <span class="comment">//</span>
05551 
05552     <span class="keywordflow">if</span> (FileInformation) {
05553         irpSp-&gt;Parameters.QueryFile.Length = Length;
05554         irpSp-&gt;Parameters.QueryFile.FileInformationClass = InformationClass;
05555     } <span class="keywordflow">else</span> {
05556         irpSp-&gt;Parameters.QueryVolume.Length = Length;
05557         irpSp-&gt;Parameters.QueryVolume.FsInformationClass = InformationClass;
05558     }
05559 
05560     <span class="comment">//</span>
05561     <span class="comment">// Insert the packet at the head of the IRP list for the thread.</span>
05562     <span class="comment">//</span>
05563 
05564     <a class="code" href="../../d0/d6/iop_8h.html#a21">IopQueueThreadIrp</a>( irp );
05565 
05566     <span class="comment">//</span>
05567     <span class="comment">// Now simply invoke the driver at its dispatch entry with the IRP.</span>
05568     <span class="comment">//</span>
05569 
05570     status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( deviceObject, irp );
05571 
05572     <span class="comment">//</span>
05573     <span class="comment">// If this operation was a synchronous I/O operation, check the return</span>
05574     <span class="comment">// status to determine whether or not to wait on the file object.  If</span>
05575     <span class="comment">// the file object is to be waited on, wait for the operation to complete</span>
05576     <span class="comment">// and obtain the final status from the file object itself.</span>
05577     <span class="comment">//</span>
05578 
05579     <span class="keywordflow">if</span> (synchronousIo) {
05580         <span class="keywordflow">if</span> (status == STATUS_PENDING) {
05581             status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;FileObject-&gt;Event,
05582                                             Executive,
05583                                             KernelMode,
05584                                             (BOOLEAN) ((FileObject-&gt;Flags &amp; FO_ALERTABLE_IO) != 0),
05585                                             (PLARGE_INTEGER) NULL );
05586             <span class="keywordflow">if</span> (status == STATUS_ALERTED) {
05587                 <a class="code" href="../../d0/d6/iop_8h.html#a151">IopCancelAlertedRequest</a>( &amp;FileObject-&gt;Event, irp );
05588             }
05589             status = FileObject-&gt;FinalStatus;
05590         }
05591         <a class="code" href="../../d0/d6/iop_8h.html#a22">IopReleaseFileObjectLock</a>( FileObject );
05592 
05593     } <span class="keywordflow">else</span> {
05594 
05595         <span class="comment">//</span>
05596         <span class="comment">// This is a normal synchronous I/O operation, as opposed to a</span>
05597         <span class="comment">// serialized synchronous I/O operation.  For this case, wait</span>
05598         <span class="comment">// for the local event and copy the final status information</span>
05599         <span class="comment">// back to the caller.</span>
05600         <span class="comment">//</span>
05601 
05602         <span class="keywordflow">if</span> (status == STATUS_PENDING) {
05603             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
05604                                           Executive,
05605                                           KernelMode,
05606                                           FALSE,
05607                                           (PLARGE_INTEGER) NULL );
05608             status = localIoStatus.Status;
05609         }
05610     }
05611 
05612     *ReturnedLength = (ULONG) localIoStatus.Information;
05613     <span class="keywordflow">return</span> status;
05614 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a59" doxytag="internal.c::IopRaiseHardError" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopRaiseHardError           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l05617">5617</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l02488">_IO_STACK_LOCATION::DeviceObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01179">_DEVICE_OBJECT::DriverObject</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d7/ex_2harderr_8c-source.html#l00700">ExRaiseHardError()</a>, <a class="el" href="../../d7/d7/ex_2harderr_8c-source.html#l00058">ExReadyForErrors</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01070">_VPB::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00070">IO_DISK_INCREMENT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02960">IoCompleteRequest</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00065">IOP_ABORT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01556">IRP_INPUT_OPERATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00068">IRP_MJ_FILE_SYSTEM_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00113">IRP_MN_MOUNT_VOLUME</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01414">_DRIVER_OBJECT::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01065">MAXIMUM_VOLUME_LABEL_LENGTH</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00713">ObQueryNameString()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02168">PERFINFO_DRIVER_MAJORFUNCTION_CALL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02169">PERFINFO_DRIVER_MAJORFUNCTION_RETURN</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01076">_VPB::VolumeLabel</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01071">_VPB::VolumeLabelLength</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01054">VPB_MOUNTED</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l00383">IopApcHardError()</a>, and <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08769">IoRaiseHardError()</a>.
<p>
<pre class="fragment"><div>05625                    :
05626 
05627     This routine raises a hard error popup in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current
05628     thread.  The APC was used to get into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context of <span class="keyword">this</span> thread so that
05629     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> popup would be sent to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate port.
05630 
05631 Arguments:
05632 
05633     NormalContext - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet (<a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>) that
05634         was initially used to request the operation that has failed.
05635 
05636     SystemArgument1 - Supplies a pointer to the media's volume parameter block.
05637         See IoRaiseHardError documentation for more information.
05638 
05639     SystemArgument2 - Supplies a pointer to the real device object.  See
05640         IoRaiseHardError documentation for more information.
05641 
05642 Return Value:
05643 
05644     None.
05645 
05646 --*/
05647 
05648 {
05649     ULONG_PTR parameters[2];
05650     ULONG numberOfParameters;
05651     ULONG parameterMask;
05652     ULONG response;
05653     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05654     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp = (<a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>) NormalContext;
05655     <a class="code" href="../../d7/d7/struct__VPB.html">PVPB</a> vpb = (<a class="code" href="../../d7/d7/struct__VPB.html">PVPB</a>) SystemArgument1;
05656     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> realDeviceObject = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>) SystemArgument2;
05657 
05658     ULONG length;
05659     POBJECT_NAME_INFORMATION objectName;
05660 
05661     UNICODE_STRING labelName;
05662 
05663     <span class="comment">//</span>
05664     <span class="comment">// Determine the name of the device and the volume label of the offending</span>
05665     <span class="comment">// media.  Start by determining the size of the DeviceName, and allocate</span>
05666     <span class="comment">// enough storage for both the ObjectName structure and the string</span>
05667     <span class="comment">// because "that's the ways Steve's routine works".</span>
05668     <span class="comment">//</span>
05669 
05670     <a class="code" href="../../d6/d1/obquery_8c.html#a7">ObQueryNameString</a>( realDeviceObject, NULL, 0, &amp;length );
05671 
05672     <span class="keywordflow">if</span> ((objectName = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, length)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05673 
05674         status = STATUS_INSUFFICIENT_RESOURCES;
05675 
05676     } <span class="keywordflow">else</span> {
05677 
05678         status = STATUS_SUCCESS;
05679     }
05680 
05681     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) ||
05682         !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status = <a class="code" href="../../d6/d1/obquery_8c.html#a7">ObQueryNameString</a>( realDeviceObject,
05683                                                  objectName,
05684                                                  length,
05685                                                  &amp;response ) )) {
05686 
05687         <span class="comment">//</span>
05688         <span class="comment">// Allocation of the pool to put up this popup did not work or</span>
05689         <span class="comment">// something else failed, so there isn't really much that can be</span>
05690         <span class="comment">// done here.  Simply return an error back to the user.</span>
05691         <span class="comment">//</span>
05692 
05693         <span class="keywordflow">if</span> (objectName) {
05694             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( objectName );
05695         }
05696 
05697         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = status;
05698         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = 0;
05699 
05700         <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>( irp, IO_DISK_INCREMENT );
05701 
05702         <span class="keywordflow">return</span>;
05703     }
05704 
05705     <span class="comment">//</span>
05706     <span class="comment">// The volume label has a max size of 32 characters (Unicode).  Convert</span>
05707     <span class="comment">// it to a Unicode string for output in the popup message.</span>
05708     <span class="comment">//</span>
05709 
05710     <span class="keywordflow">if</span> (vpb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; vpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o2">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a116">VPB_MOUNTED</a>) {
05711 
05712         labelName.Buffer = &amp;vpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o8">VolumeLabel</a>[0];
05713         labelName.Length = vpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o3">VolumeLabelLength</a>;
05714         labelName.MaximumLength = <a class="code" href="../../d0/d5/io_8h.html#a121">MAXIMUM_VOLUME_LABEL_LENGTH</a>;
05715 
05716     } <span class="keywordflow">else</span> {
05717 
05718         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;labelName, NULL );
05719     }
05720 
05721     <span class="comment">//</span>
05722     <span class="comment">// Different pop-ups have different printf formats.  Depending on the</span>
05723     <span class="comment">// specific error value, adjust the parameters.</span>
05724     <span class="comment">//</span>
05725 
05726     <span class="keywordflow">switch</span>( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status ) {
05727 
05728     <span class="keywordflow">case</span> STATUS_MEDIA_WRITE_PROTECTED:
05729     <span class="keywordflow">case</span> STATUS_WRONG_VOLUME:
05730 
05731         numberOfParameters = 2;
05732         parameterMask = 3;
05733 
05734         parameters[0] = (ULONG_PTR) &amp;labelName;
05735         parameters[1] = (ULONG_PTR) &amp;objectName-&gt;Name;
05736 
05737         <span class="keywordflow">break</span>;
05738 
05739     <span class="keywordflow">case</span> STATUS_DEVICE_NOT_READY:
05740     <span class="keywordflow">case</span> STATUS_IO_TIMEOUT:
05741     <span class="keywordflow">case</span> STATUS_NO_MEDIA_IN_DEVICE:
05742     <span class="keywordflow">case</span> STATUS_UNRECOGNIZED_MEDIA:
05743 
05744         numberOfParameters = 1;
05745         parameterMask = 1;
05746 
05747         parameters[0] = (ULONG_PTR) &amp;objectName-&gt;Name;
05748         parameters[1] = 0;
05749 
05750         <span class="keywordflow">break</span>;
05751 
05752     <span class="keywordflow">default</span>:
05753 
05754         numberOfParameters = 0;
05755         parameterMask = 0;
05756 
05757     }
05758 
05759     <span class="comment">//</span>
05760     <span class="comment">// Simply raise the hard error.</span>
05761     <span class="comment">//</span>
05762 
05763     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/ex_2harderr_8c.html#a5">ExReadyForErrors</a>) {
05764         status = <a class="code" href="../../d5/d8/ex_8h.html#a306">ExRaiseHardError</a>( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status,
05765                                    numberOfParameters,
05766                                    parameterMask,
05767                                    parameters,
05768                                    OptionCancelTryContinue,
05769                                    &amp;response );
05770 
05771     } <span class="keywordflow">else</span> {
05772 
05773         status = STATUS_UNSUCCESSFUL;
05774         response = ResponseReturnToCaller;
05775     }
05776 
05777     <span class="comment">//</span>
05778     <span class="comment">// Free any pool or other resources that were allocated to output the</span>
05779     <span class="comment">// popup.</span>
05780     <span class="comment">//</span>
05781 
05782     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( objectName );
05783 
05784     <span class="comment">//</span>
05785     <span class="comment">// If there was a problem, or the user didn't want to retry, just</span>
05786     <span class="comment">// complete the request.  Otherwise simply call the driver entry</span>
05787     <span class="comment">// point and retry the IRP as if it had never been tried before.</span>
05788     <span class="comment">//</span>
05789 
05790     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) || response != ResponseTryAgain) {
05791 
05792         <span class="comment">//</span>
05793         <span class="comment">// Before completing the request, make one last check.  If this was</span>
05794         <span class="comment">// a mount request, and the reason for the failure was t/o, no media,</span>
05795         <span class="comment">// or unrecognized media, then set the Information field of the status</span>
05796         <span class="comment">// block to indicate whether or not an abort was performed.</span>
05797         <span class="comment">//</span>
05798 
05799         <span class="keywordflow">if</span> (response == ResponseCancel) {
05800             <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( irp );
05801             <span class="keywordflow">if</span> (irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> == <a class="code" href="../../d0/d5/io_8h.html#a26">IRP_MJ_FILE_SYSTEM_CONTROL</a> &amp;&amp;
05802                 irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> == <a class="code" href="../../d0/d5/io_8h.html#a47">IRP_MN_MOUNT_VOLUME</a>) {
05803                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = <a class="code" href="../../d0/d6/iop_8h.html#a0">IOP_ABORT</a>;
05804             } <span class="keywordflow">else</span> {
05805                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = STATUS_REQUEST_ABORTED;
05806             }
05807         }
05808 
05809         <span class="comment">//</span>
05810         <span class="comment">// An error was incurred, so zero out the information field before</span>
05811         <span class="comment">// completing the request if this was an input operation.  Otherwise,</span>
05812         <span class="comment">// IopCompleteRequest will try to copy to the user's buffer.</span>
05813         <span class="comment">//</span>
05814 
05815         <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a180">IRP_INPUT_OPERATION</a>) {
05816             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = 0;
05817         }
05818 
05819         <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>( irp, IO_DISK_INCREMENT );
05820 
05821     } <span class="keywordflow">else</span> {
05822 
05823         <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( irp );
05824         <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> fsDeviceObject = irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o57">DeviceObject</a>;
05825         <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject = fsDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>;
05826 
05827         <span class="comment">//</span>
05828         <span class="comment">// Retry the request from the top.</span>
05829         <span class="comment">//</span>
05830 
05831         <a class="code" href="../../d2/d1/mm_8h.html#a47">PERFINFO_DRIVER_MAJORFUNCTION_CALL</a>(irp, irpSp, driverObject);
05832 
05833         driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o14">MajorFunction</a>[irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a>]( fsDeviceObject,
05834                                                            irp );
05835 
05836         <a class="code" href="../../d2/d1/mm_8h.html#a48">PERFINFO_DRIVER_MAJORFUNCTION_RETURN</a>(irp, irpSp, driverObject);
05837     }
05838 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a60" doxytag="internal.c::IopRaiseInformationalHardError" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopRaiseInformationalHardError           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l05841">5841</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d1/d5/iop_8h-source.html#l00114">_IOP_HARD_ERROR_PACKET::ErrorStatus</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d7/ex_2harderr_8c-source.html#l00700">ExRaiseHardError()</a>, <a class="el" href="../../d7/d7/ex_2harderr_8c-source.html#l00058">ExReadyForErrors</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00203">IopHardError</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00109">_IOP_HARD_ERROR_QUEUE::NumPendingApcPopups</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00115">_IOP_HARD_ERROR_PACKET::String</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08909">IoRaiseInformationalHardError()</a>.
<p>
<pre class="fragment"><div>05849                    :
05850 
05851     This routine performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual pop-up.  It will called from either <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
05852     hard-error thread, or a APC routine in a user thread after exiting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
05853     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system.
05854 
05855 Arguments:
05856 
05857     NormalContext - Contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pop-up
05858 
05859     SystemArgument1 - not used.
05860 
05861     SystemArgument1 - not used.
05862 
05863 Return Value:
05864 
05865     None.
05866 
05867 --*/
05868 
05869 {
05870     ULONG parameterPresent;
05871     ULONG_PTR errorParameter;
05872     ULONG errorResponse;
05873     <a class="code" href="../../d7/d0/struct__IOP__HARD__ERROR__PACKET.html">PIOP_HARD_ERROR_PACKET</a> hardErrorPacket;
05874 
05875     UNREFERENCED_PARAMETER( SystemArgument1 );
05876     UNREFERENCED_PARAMETER( SystemArgument2 );
05877 
05878     hardErrorPacket = (<a class="code" href="../../d7/d0/struct__IOP__HARD__ERROR__PACKET.html">PIOP_HARD_ERROR_PACKET</a>) NormalContext;
05879 
05880     <span class="comment">//</span>
05881     <span class="comment">// Simply raise the hard error if the system is ready to accept one.</span>
05882     <span class="comment">//</span>
05883 
05884     errorParameter = (ULONG_PTR) &amp;hardErrorPacket-&gt;<a class="code" href="../../d7/d0/struct__IOP__HARD__ERROR__PACKET.html#o2">String</a>;
05885 
05886     parameterPresent = (hardErrorPacket-&gt;<a class="code" href="../../d7/d0/struct__IOP__HARD__ERROR__PACKET.html#o2">String</a>.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05887 
05888     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/ex_2harderr_8c.html#a5">ExReadyForErrors</a>) {
05889         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d5/d8/ex_8h.html#a306">ExRaiseHardError</a>( hardErrorPacket-&gt;<a class="code" href="../../d7/d0/struct__IOP__HARD__ERROR__PACKET.html#o1">ErrorStatus</a>,
05890                                  parameterPresent,
05891                                  parameterPresent,
05892                                  parameterPresent ? &amp;errorParameter : NULL,
05893                                  OptionOk,
05894                                  &amp;errorResponse );
05895     }
05896 
05897     <span class="comment">//</span>
05898     <span class="comment">// Now free the packet and the buffer, if one was specified.</span>
05899     <span class="comment">//</span>
05900 
05901     <span class="keywordflow">if</span> (hardErrorPacket-&gt;<a class="code" href="../../d7/d0/struct__IOP__HARD__ERROR__PACKET.html#o2">String</a>.Buffer) {
05902         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( hardErrorPacket-&gt;<a class="code" href="../../d7/d0/struct__IOP__HARD__ERROR__PACKET.html#o2">String</a>.Buffer );
05903     }
05904 
05905     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( hardErrorPacket );
05906     InterlockedDecrement(&amp;<a class="code" href="../../d3/d5/iodata_8c.html#a25">IopHardError</a>.<a class="code" href="../../d8/d0/struct__IOP__HARD__ERROR__QUEUE.html#o5">NumPendingApcPopups</a>);
05907 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a61" doxytag="internal.c::IopReadyDeviceObjects" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopReadyDeviceObjects           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DriverObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l05910">5910</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01159">DO_DEVICE_INITIALIZING</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01304">DRVO_INITIALIZED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01184">_DEVICE_OBJECT::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01180">_DEVICE_OBJECT::NextDevice</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02812">IopInitializeBuiltinDriver()</a>, and <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>.
<p>
<pre class="fragment"><div>05916                    :
05917 
05918     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to mark all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device objects owned by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
05919     specified driver as having been fully initialized and therefore ready
05920     <span class="keywordflow">for</span> access by other drivers/clients.
05921 
05922 Arguments:
05923 
05924     DriverObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver object <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver
05925         whose devices are to be marked as being <span class="stringliteral">"ready"</span>.
05926 
05927 Return Value:
05928 
05929     None.
05930 
05931 --*/
05932 
05933 {
05934     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject = DriverObject-&gt;DeviceObject;
05935 
05936     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05937 
05938     <span class="comment">//</span>
05939     <span class="comment">// Loop through all of the driver's device objects, clearing the</span>
05940     <span class="comment">// DO_DEVICE_INITIALIZING flag.</span>
05941     <span class="comment">//</span>
05942 
05943     DriverObject-&gt;Flags |= <a class="code" href="../../d0/d5/io_8h.html#a147">DRVO_INITIALIZED</a>;
05944     <span class="keywordflow">while</span> (deviceObject) {
05945         deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> &amp;= ~<a class="code" href="../../d0/d5/io_8h.html#a128">DO_DEVICE_INITIALIZING</a>;
05946         deviceObject = deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o4">NextDevice</a>;
05947     }
05948 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="internal.c::IopResurrectDriver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopResurrectDriver           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DriverObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l05951">5951</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01366">_DRIVER_OBJECT::DeviceObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01220">DOE_UNLOAD_PENDING</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01299">DRVO_UNLOAD_INVOKED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01268">_DEVOBJ_EXTENSION::ExtensionFlags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01367">_DRIVER_OBJECT::Flags</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00054">IopDatabaseLock</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01180">_DEVICE_OBJECT::NextDevice</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>.
<p>
<pre class="fragment"><div>05957                    :
05958 
05959     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to clear unload pending flag on all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device
05960     objects owned by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified driver, <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unload routine has not run.
05961     This allows <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver to come back to life after a pending unload.
05962 
05963 
05964 Arguments:
05965 
05966     DriverObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver object <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver
05967         whose devices are to be cleared.
05968 
05969 Return Value:
05970 
05971     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> - Returns success <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver's unload routine has not run;
05972         otherwise STATUS_IMAGE_ALREADY_LOADED <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
05973 
05974 --*/
05975 
05976 {
05977     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject = DriverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o2">DeviceObject</a>;
05978     KIRQL irql;
05979 
05980     <span class="comment">//</span>
05981     <span class="comment">// Acquire the I/O spinlock that protects the device list and</span>
05982     <span class="comment">// driver flags.</span>
05983     <span class="comment">//</span>
05984 
05985     ExAcquireSpinLock( &amp;IopDatabaseLock, &amp;irql );
05986 
05987     <span class="keywordflow">if</span> (DriverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a143">DRVO_UNLOAD_INVOKED</a> || !deviceObject ||
05988         !(deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a138">DOE_UNLOAD_PENDING</a>)) {
05989 
05990         ExReleaseSpinLock( &amp;IopDatabaseLock, irql );
05991         <span class="keywordflow">return</span> STATUS_IMAGE_ALREADY_LOADED;
05992     }
05993 
05994     <span class="comment">//</span>
05995     <span class="comment">// Loop through all of the driver's device objects, clearing the</span>
05996     <span class="comment">// DOE_UNLOAD_PENDING flag.</span>
05997     <span class="comment">//</span>
05998 
05999     <span class="keywordflow">while</span> (deviceObject) {
06000         deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> &amp;= ~<a class="code" href="../../d0/d5/io_8h.html#a138">DOE_UNLOAD_PENDING</a>;
06001         deviceObject = deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o4">NextDevice</a>;
06002     }
06003 
06004     ExReleaseSpinLock( &amp;IopDatabaseLock, irql );
06005     <span class="keywordflow">return</span> STATUS_SUCCESS;
06006 
06007 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a73" doxytag="internal.c::IopSafebootDriverLoad" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopSafebootDriverLoad           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PUNICODE_STRING&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DriverId</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l08822">8822</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00181">CmRegistryMachineSystemCurrentControlSetControlSafeBoot</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d0/init_8h-source.html#l00044">InitSafeBootMode</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01883">RtlAppendUnicodeStringToString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01821">RtlAppendUnicodeToString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01763">RtlCopyUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l02525">IopCallDriverAddDevice()</a>, and <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>.
<p>
<pre class="fragment"><div>08827                    :
08828 
08829     Checks to see <span class="keywordflow">if</span> a driver or service <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> included
08830     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current safeboot registry section.
08831 
08832 Arguments:
08833 
08834     DriverId - Specifies which driver <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be validated.
08835         The string should contain a driver executable name
08836         like <a class="code" href="../../d8/d7/udbgk_8c.html#a2">foo</a>.sys or a GUID <span class="keywordflow">for</span> a pnp driver <span class="keyword">class</span>.
08837 
08838 Return Value:
08839 
08840     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>    - driver/service <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry
08841     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>   - driver/service <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> NOT in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry
08842 
08843 --*/
08844 {
08845     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
08846     HANDLE hSafeBoot,hGuid;
08847     UNICODE_STRING safeBootKey;
08848     UNICODE_STRING SafeBootTypeString;
08849 
08850 
08851 
08852     <span class="comment">//</span>
08853     <span class="comment">// set the first part of the registry key name</span>
08854     <span class="comment">//</span>
08855 
08856     <span class="keywordflow">switch</span> (<a class="code" href="../../d8/d1/init_8h.html#a18">InitSafeBootMode</a>) {
08857         <span class="keywordflow">case</span> SAFEBOOT_MINIMAL:
08858             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;SafeBootTypeString,SAFEBOOT_MINIMAL_STR_W);
08859             <span class="keywordflow">break</span>;
08860 
08861         <span class="keywordflow">case</span> SAFEBOOT_NETWORK:
08862             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;SafeBootTypeString,SAFEBOOT_NETWORK_STR_W);
08863             <span class="keywordflow">break</span>;
08864 
08865         <span class="keywordflow">case</span> SAFEBOOT_DSREPAIR:
08866             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
08867 
08868         <span class="keywordflow">default</span>:
08869             KdPrint((<span class="stringliteral">"SAFEBOOT: invalid safeboot option = %d\n"</span>,InitSafeBootMode));
08870             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08871     }
08872 
08873     safeBootKey.Length = 0;
08874     safeBootKey.MaximumLength = DriverId-&gt;Length + SafeBootTypeString.Length + (4*<span class="keyword">sizeof</span>(WCHAR));
08875     safeBootKey.Buffer = (PWCHAR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool,safeBootKey.MaximumLength);
08876     <span class="keywordflow">if</span> (!safeBootKey.Buffer) {
08877         KdPrint((<span class="stringliteral">"SAFEBOOT: could not allocate pool\n"</span>));
08878         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08879     }
08880 
08881     <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>(&amp;safeBootKey,&amp;SafeBootTypeString);
08882     status = <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;safeBootKey,L<span class="stringliteral">"\\"</span>);
08883     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08884         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (safeBootKey.Buffer);
08885         KdPrint((<span class="stringliteral">"SAFEBOOT: could not create registry key string = %x\n"</span>,status));
08886         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08887     }
08888     status = <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(&amp;safeBootKey,DriverId);
08889     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08890         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (safeBootKey.Buffer);
08891         KdPrint((<span class="stringliteral">"SAFEBOOT: could not create registry key string = %x\n"</span>,status));
08892         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08893     }
08894 
08895     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a> (
08896         &amp;hSafeBoot,
08897         NULL,
08898         &amp;CmRegistryMachineSystemCurrentControlSetControlSafeBoot,
08899         KEY_ALL_ACCESS,
08900         FALSE
08901         );
08902     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08903         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a> (
08904             &amp;hGuid,
08905             hSafeBoot,
08906             &amp;safeBootKey,
08907             KEY_ALL_ACCESS,
08908             FALSE
08909             );
08910         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hSafeBoot);
08911         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08912             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hGuid);
08913             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(safeBootKey.Buffer);
08914             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
08915         }
08916     }
08917 
08918     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(safeBootKey.Buffer);
08919 
08920     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08921 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a62" doxytag="internal.c::IopSendMessageToTrackService" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopSendMessageToTrackService           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d4/internal_8c.html#a6">PFILE_VOLUMEID_WITH_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceVolumeId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFILE_OBJECTID_BUFFER&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceObjectId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFILE_TRACKING_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetObjectInformation</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l06127">6127</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d5/d8/ex_8h.html#a332a206">DelayedWorkQueue</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00330">_LINK_TRACKING_PACKET::Event</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01961">ExInitializeWorkItem</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00375">ExQueueWorkItem()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00044">FILE_VOLUMEID_WITH_TYPE</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00331">_LINK_TRACKING_PACKET::FinalStatus</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l01506">IopConnectLinkTrackingPort()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00303">IopLinkTrackingPacket</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00302">IopLinkTrackingPortObject</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00346">IopLinkTrackingServiceEvent</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00345">IopLinkTrackingServiceObject</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06072">IopUnMarshalIds()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00253">KeReadStateEvent()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00285">KeResetEvent()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a59">LINK_TRACKING_PACKET</a>, <a class="el" href="../../d7/d6/lpcsend_8c-source.html#l01407">LpcRequestWaitReplyPort()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d3/kernel_2ddetrack_8c-source.html#l01221">Request()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, and <a class="el" href="../../d1/d5/iop_8h-source.html#l00329">_LINK_TRACKING_PACKET::WorkQueueItem</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l07272">IopTrackLink()</a>.
<p>
<pre class="fragment"><div>06135                    :
06136 
06137     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to send a message to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user-mode link tracking
06138     service to inform <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> that a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> has been <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a100">moved</a> so that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> can track <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
06139     by its object <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>.
06140 
06141 Arguments:
06142 
06143     SourceVolumeId - Volume <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
06144 
06145     SourceObjectId - Object <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
06146 
06147     TargetObjectInformation - Volume <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>, object <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
06148 
06149 Return Value:
06150 
06151     The <span class="keyword">final</span> function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> completion status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
06152 
06153 
06154 --*/
06155 
06156 {
06157     <span class="keyword">typedef</span> <span class="keyword">struct </span>_LINK_TRACKING_MESSAGE {
06158         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
06159         ULONG <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a>;
06160         <a class="code" href="../../d2/d4/internal_8c.html#a5">FILE_VOLUMEID_WITH_TYPE</a> SourceVolumeId;    <span class="comment">// src vol type &amp; id</span>
06161         FILE_OBJECTID_BUFFER     SourceObjectId;    <span class="comment">// src obj id &amp; birth info</span>
06162         <a class="code" href="../../d2/d4/internal_8c.html#a5">FILE_VOLUMEID_WITH_TYPE</a> TargetVolumeId;    <span class="comment">// tgt vol type &amp; id</span>
06163         GUID TargetObjectId;                        <span class="comment">// tgt obj id</span>
06164         GUID TargetMachineId;
06165     } LINK_TRACKING_MESSAGE, *PLINK_TRACKING_MESSAGE;
06166 
06167     <span class="keyword">typedef</span> <span class="keyword">struct </span>_LINK_TRACKING_RESPONSE {
06168         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
06169     } LINK_TRACKING_RESPONSE, *PLINK_TRACKING_RESPONSE;
06170 
06171     PPORT_MESSAGE portMessage;
06172     PPORT_MESSAGE portReplyMessage;
06173     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> portReply[ 256 ];
06174     PLINK_TRACKING_MESSAGE requestMessage;
06175     PLINK_TRACKING_RESPONSE replyMessage;
06176     <a class="code" href="../../d8/d1/struct__LINK__TRACKING__PACKET.html">LINK_TRACKING_PACKET</a> ltp;
06177     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
06178     ULONG loopCount = 0;
06179 
06180     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
06181 
06182     <span class="comment">//</span>
06183     <span class="comment">// Begin by determining whether or not the LPC port to the link tracking</span>
06184     <span class="comment">// service has been opened.  If not, then attempt to open it now.</span>
06185     <span class="comment">//</span>
06186 
06187 retry:
06188 
06189     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d5/iodata_8c.html#a61">IopLinkTrackingServiceObject</a>) {
06190 
06191         <span class="comment">//</span>
06192         <span class="comment">// The port has not yet been opened.  Check to see whether or not</span>
06193         <span class="comment">// the service has been started.  If not, then get out now as there</span>
06194         <span class="comment">// will be no port if the service is not running.</span>
06195         <span class="comment">//</span>
06196 
06197         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d8/eventobj_8c.html#a6">KeReadStateEvent</a>( IopLinkTrackingServiceEvent )) {
06198             <span class="keywordflow">return</span> STATUS_NO_TRACKING_SERVICE;
06199         }
06200 
06201                 <span class="keywordflow">for</span> (;; ) {
06202                         status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;IopLinkTrackingPortObject,
06203                                                                                   Executive,
06204                                                                                   KeGetPreviousMode(),
06205                                                                                   FALSE,
06206                                                                                   (PLARGE_INTEGER) NULL );
06207 
06208                         <span class="keywordflow">if</span> ((status == STATUS_USER_APC) || (status == STATUS_ALERTED)) {
06209                                 <span class="keywordflow">return</span> status;
06210                         }
06211 
06212                         <span class="comment">//</span>
06213                         <span class="comment">// There is no referenced object pointer to the</span>
06214                         <span class="comment">// link tracking port so open it.</span>
06215                         <span class="comment">//</span>
06216                         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d5/iodata_8c.html#a61">IopLinkTrackingServiceObject</a>)  {
06217                                 <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>(
06218                                         &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a53">IopLinkTrackingPacket</a>.<a class="code" href="../../d8/d1/struct__LINK__TRACKING__PACKET.html#o0">WorkQueueItem</a>,
06219                                         IopConnectLinkTrackingPort,
06220                                         &amp;IopLinkTrackingPacket);
06221                                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d2/d8/eventobj_8c.html#a7">KeResetEvent</a>(&amp;<a class="code" href="../../d3/d5/iodata_8c.html#a53">IopLinkTrackingPacket</a>.<a class="code" href="../../d8/d1/struct__LINK__TRACKING__PACKET.html#o1">Event</a>);
06222                                 <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a53">IopLinkTrackingPacket</a>.<a class="code" href="../../d8/d1/struct__LINK__TRACKING__PACKET.html#o0">WorkQueueItem</a>,
06223                                                                         DelayedWorkQueue );
06224                                 status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(
06225                                                         &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a53">IopLinkTrackingPacket</a>.<a class="code" href="../../d8/d1/struct__LINK__TRACKING__PACKET.html#o1">Event</a>,
06226                                                         Executive,
06227                                                         KeGetPreviousMode(),
06228                                                         FALSE,
06229                                                         (PLARGE_INTEGER) NULL );
06230 
06231                                 <span class="keywordflow">if</span> ((status == STATUS_USER_APC) || (status == STATUS_ALERTED)) {
06232                                         NOTHING;
06233                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d3/d5/iodata_8c.html#a53">IopLinkTrackingPacket</a>.<a class="code" href="../../d8/d1/struct__LINK__TRACKING__PACKET.html#o2">FinalStatus</a> )) {
06234                                         status = <a class="code" href="../../d3/d5/iodata_8c.html#a53">IopLinkTrackingPacket</a>.<a class="code" href="../../d8/d1/struct__LINK__TRACKING__PACKET.html#o2">FinalStatus</a>;
06235                                 }
06236 
06237                                 <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(&amp;IopLinkTrackingPortObject,
06238                                                 0,
06239                                                 FALSE);
06240                                 <span class="keywordflow">if</span> (status == STATUS_SUCCESS) {
06241                                                 <span class="keywordflow">break</span>;
06242                                 } <span class="keywordflow">else</span> {
06243                                         <span class="keywordflow">return</span> status;
06244                                 }
06245 
06246                         } <span class="keywordflow">else</span> {
06247                                 <span class="comment">//</span>
06248                                 <span class="comment">// The connection is established.</span>
06249                                 <span class="comment">//</span>
06250 
06251                                 <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(&amp;IopLinkTrackingPortObject,
06252                                                 0,
06253                                                 FALSE);
06254                                 <span class="keywordflow">break</span>;
06255                         }
06256         }
06257     }
06258 
06259     <span class="comment">//</span>
06260     <span class="comment">// Form a message from the input parameters and send it to the caller.</span>
06261     <span class="comment">//</span>
06262 
06263     portMessage = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool,
06264                                   <span class="keyword">sizeof</span>( LINK_TRACKING_MESSAGE ) +
06265                                   <span class="keyword">sizeof</span>( PORT_MESSAGE ) );
06266     <span class="keywordflow">if</span> (!portMessage) {
06267         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
06268     }
06269 
06270     requestMessage = (PLINK_TRACKING_MESSAGE) (portMessage + 1);
06271     RtlZeroMemory( requestMessage, <span class="keyword">sizeof</span>(*requestMessage) );
06272 
06273     requestMessage-&gt;Status = STATUS_SUCCESS;
06274     requestMessage-&gt;Request = 0;
06275 
06276     RtlCopyMemory( &amp;requestMessage-&gt;SourceVolumeId,
06277                    SourceVolumeId,
06278                    <span class="keyword">sizeof</span>( FILE_VOLUMEID_WITH_TYPE ) );
06279 
06280     RtlCopyMemory( &amp;requestMessage-&gt;SourceObjectId,
06281                    SourceObjectId,
06282                    <span class="keyword">sizeof</span>( FILE_OBJECTID_BUFFER ) );
06283 
06284     <a class="code" href="../../d2/d4/internal_8c.html#a16">IopUnMarshalIds</a>(  TargetObjectInformation,
06285                    &amp;requestMessage-&gt;TargetVolumeId,
06286                    &amp;requestMessage-&gt;TargetObjectId,
06287                    &amp;requestMessage-&gt;TargetMachineId);
06288 
06289     portMessage-&gt;u1.s1.TotalLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (<span class="keyword">sizeof</span>( PORT_MESSAGE ) +
06290                                               <span class="keyword">sizeof</span>( LINK_TRACKING_MESSAGE ));
06291     portMessage-&gt;u1.s1.DataLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) <span class="keyword">sizeof</span>( LINK_TRACKING_MESSAGE );
06292     portMessage-&gt;u2.ZeroInit = 0;
06293 
06294     status = <a class="code" href="../../d6/d7/lpcsend_8c.html#a3">LpcRequestWaitReplyPort</a>( IopLinkTrackingServiceObject,
06295                                       portMessage,
06296                                       (PPORT_MESSAGE) &amp;portReply[0] );
06297     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
06298         <span class="keywordflow">if</span> (status == STATUS_PORT_DISCONNECTED) {
06299                         status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;IopLinkTrackingPortObject,
06300                                                                                                 Executive,
06301                                                                                                 KeGetPreviousMode(),
06302                                                                                                 FALSE,
06303                                                                                                 (PLARGE_INTEGER) NULL );
06304             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( IopLinkTrackingServiceObject );
06305                         <a class="code" href="../../d3/d5/iodata_8c.html#a61">IopLinkTrackingServiceObject</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06306                         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(&amp;IopLinkTrackingPortObject,
06307                                 0,
06308                                 FALSE);
06309             <span class="keywordflow">if</span> (!loopCount) {
06310                 loopCount += 1;
06311                 <span class="keywordflow">goto</span> retry;
06312             }
06313         }
06314     }
06315 
06316     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
06317         portReplyMessage = (PPORT_MESSAGE) &amp;portReply[0];
06318         replyMessage = (PLINK_TRACKING_RESPONSE) (portReplyMessage + 1);
06319         status = replyMessage-&gt;Status;
06320     }
06321 
06322     <span class="keywordflow">return</span> status;
06323 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a63" doxytag="internal.c::IopSetEaOrQuotaInformationFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopSetEaOrQuotaInformationFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatusBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>SetEa</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l06326">6326</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01154">DO_BUFFERED_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01156">DO_DIRECT_IO</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00127">ExAllocatePoolWithQuota</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01184">_DEVICE_OBJECT::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01492">FO_ALERTABLE_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01491">FO_SYNCHRONOUS_IO</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00652">IoAllocateIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00805">IoAllocateMdl()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02392">IoCheckEaBufferValidity()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02874">IoCheckQuotaBufferValidity()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00044">IoFileObjectType</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00595">IopAcquireFastLock</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00181">IopAcquireFileObjectLock()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00284">IopAllocateIrpCleanup()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l01934">IopExceptionCleanup()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06926">IopSynchronousApiServiceTail()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l07030">IopSynchronousServiceTail()</a>, <a class="el" href="../../d2/d1/mm_8h.html#a344a168">IoReadAccess</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01554">IRP_BUFFERED_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01555">IRP_DEALLOCATE_BUFFER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00063">IRP_MJ_SET_EA</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00081">IRP_MJ_SET_QUOTA</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01552">IRP_SYNCHRONOUS_API</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00238">MmProbeAndLockPages()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a240a140">OtherTransfer</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o24">_IRP::Overlay</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01498">ProbeForWriteIoStatus</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01641">_IRP::RequestorMode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01189">_DEVICE_OBJECT::StackSize</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01711">_IRP::UserBuffer</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>.
<p>
Referenced by <a class="el" href="../../d1/d2/qsquota_8c-source.html#l00602">NtSetQuotaInformationFile()</a>.
<p>
<pre class="fragment"><div>06336                    :
06337 
06338     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NtSetEa[Quota]InformationFile system services
06339     to either modify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> EAs on a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> quota entries on a volume.  All of
06340     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified entries in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer are <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> or volume.
06341 
06342 Arguments:
06343 
06344     FileHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>/volume <span class="keywordflow">for</span> which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entries are
06345         to be applied.
06346 
06347     IoStatusBlock - Address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's I/O status block.
06348 
06349     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Supplies a buffer containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entries to be added/modified.
06350 
06351     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
06352 
06353     SetEa - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> BOOLEAN that indicates whether to change <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> EAs on a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> or
06354         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> quota entries on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume.
06355 
06356 Return Value:
06357 
06358     The status returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> completion status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
06359 
06360 --*/
06361 
06362 {
06363     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
06364     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
06365     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> fileObject;
06366     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
06367     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> event = (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06368     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> requestorMode;
06369     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
06370     IO_STATUS_BLOCK localIoStatus;
06371     BOOLEAN synchronousIo;
06372 
06373     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
06374 
06375     <span class="comment">//</span>
06376     <span class="comment">// Get the previous mode;  i.e., the mode of the caller.</span>
06377     <span class="comment">//</span>
06378 
06379     requestorMode = KeGetPreviousMode();
06380 
06381     <span class="keywordflow">if</span> (requestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
06382 
06383         <span class="comment">//</span>
06384         <span class="comment">// The caller's access mode is user, so probe each of the arguments</span>
06385         <span class="comment">// and capture them as necessary.  If any failures occur, the condition</span>
06386         <span class="comment">// handler will be invoked to handle them.  It will simply cleanup and</span>
06387         <span class="comment">// return an access violation status code back to the system service</span>
06388         <span class="comment">// dispatcher.</span>
06389         <span class="comment">//</span>
06390 
06391         <span class="keywordflow">try</span> {
06392 
06393             <span class="comment">//</span>
06394             <span class="comment">// The IoStatusBlock parameter must be writeable by the caller.</span>
06395             <span class="comment">//</span>
06396 
06397             <a class="code" href="../../d5/d8/ex_8h.html#a31">ProbeForWriteIoStatus</a>( IoStatusBlock);
06398 
06399             <span class="comment">//</span>
06400             <span class="comment">// The Buffer parameter must be readable by the caller.</span>
06401             <span class="comment">//</span>
06402 
06403             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( Buffer, Length, <span class="keyword">sizeof</span>( ULONG ) );
06404 
06405         } except(EXCEPTION_EXECUTE_HANDLER) {
06406 
06407             <span class="comment">//</span>
06408             <span class="comment">// An exception was incurred while probing the caller's parameters.</span>
06409             <span class="comment">// Cleanup and return an appropriate error status code.</span>
06410             <span class="comment">//</span>
06411 
06412             <span class="keywordflow">return</span> GetExceptionCode();
06413         }
06414     }
06415 
06416     <span class="comment">//</span>
06417     <span class="comment">// There were no blatant errors so far, so reference the file object so</span>
06418     <span class="comment">// the target device object can be found.  Note that if the handle does</span>
06419     <span class="comment">// not refer to a file object, or if the caller does not have the required</span>
06420     <span class="comment">// access to the file, then it will fail.</span>
06421     <span class="comment">//</span>
06422 
06423     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( FileHandle,
06424                                         SetEa ? FILE_WRITE_EA : FILE_WRITE_DATA,
06425                                         IoFileObjectType,
06426                                         requestorMode,
06427                                         (PVOID *) &amp;fileObject,
06428                                         NULL );
06429     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
06430         <span class="keywordflow">return</span> status;
06431     }
06432 
06433     <span class="comment">//</span>
06434     <span class="comment">// Make a special check here to determine whether this is a synchronous</span>
06435     <span class="comment">// I/O operation.  If it is, then wait here until the file is owned by</span>
06436     <span class="comment">// the current thread.  If this is not a (serialized) synchronous I/O</span>
06437     <span class="comment">// operation, then allocate and initialize the local event.</span>
06438     <span class="comment">//</span>
06439 
06440     <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>) {
06441 
06442         BOOLEAN interrupted;
06443 
06444         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a13">IopAcquireFastLock</a>( fileObject )) {
06445             status = <a class="code" href="../../d0/d6/iop_8h.html#a147">IopAcquireFileObjectLock</a>( fileObject,
06446                                                requestorMode,
06447                                                (BOOLEAN) ((fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; FO_ALERTABLE_IO) != 0),
06448                                                &amp;interrupted );
06449             <span class="keywordflow">if</span> (interrupted) {
06450                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
06451                 <span class="keywordflow">return</span> status;
06452             }
06453         }
06454         synchronousIo = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06455     } <span class="keywordflow">else</span> {
06456 
06457         <span class="comment">//</span>
06458         <span class="comment">// This is a synchronous API being invoked for a file that is opened</span>
06459         <span class="comment">// for asynchronous I/O.  This means that this system service is</span>
06460         <span class="comment">// to synchronize the completion of the operation before returning</span>
06461         <span class="comment">// to the caller.  A local event is used to do this.</span>
06462         <span class="comment">//</span>
06463 
06464         event = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( NonPagedPool, <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> ) );
06465         <span class="keywordflow">if</span> (!event) {
06466             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
06467             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
06468         }
06469         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( event, SynchronizationEvent, FALSE );
06470         synchronousIo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06471     }
06472 
06473     <span class="comment">//</span>
06474     <span class="comment">// Set the file object to the Not-Signaled state.</span>
06475     <span class="comment">//</span>
06476 
06477     <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>( &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o25">Event</a> );
06478 
06479     <span class="comment">//</span>
06480     <span class="comment">// Get the address of the target device object.</span>
06481     <span class="comment">//</span>
06482 
06483     deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( fileObject );
06484 
06485     <span class="comment">//</span>
06486     <span class="comment">// Allocate and initialize the I/O Request Packet (IRP) for this operation.</span>
06487     <span class="comment">// The allocation is performed with an exception handler in case the</span>
06488     <span class="comment">// caller does not have enough quota to allocate the packet.</span>
06489 
06490     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a17">IoAllocateIrp</a>( deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a>, TRUE );
06491     <span class="keywordflow">if</span> (!irp) {
06492 
06493         <span class="comment">//</span>
06494         <span class="comment">// An IRP could not be allocated.  Cleanup and return an appropriate</span>
06495         <span class="comment">// error status code.</span>
06496         <span class="comment">//</span>
06497 
06498         <span class="keywordflow">if</span> (!(fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>)) {
06499             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( event );
06500         }
06501 
06502         <a class="code" href="../../d0/d6/iop_8h.html#a148">IopAllocateIrpCleanup</a>( fileObject, (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) NULL );
06503 
06504         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
06505     }
06506     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = fileObject;
06507     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
06508     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a> = requestorMode;
06509 
06510     <span class="comment">//</span>
06511     <span class="comment">// Fill in the service independent parameters in the IRP.</span>
06512     <span class="comment">//</span>
06513 
06514     <span class="keywordflow">if</span> (synchronousIo) {
06515         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06516         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = IoStatusBlock;
06517     } <span class="keywordflow">else</span> {
06518         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = event;
06519         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = &amp;localIoStatus;
06520         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a>;
06521     }
06522     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine = (PIO_APC_ROUTINE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06523 
06524     <span class="comment">//</span>
06525     <span class="comment">// Get a pointer to the stack location for the first driver.  This will be</span>
06526     <span class="comment">// used to pass the original function codes and parameters.</span>
06527     <span class="comment">//</span>
06528 
06529     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
06530     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = SetEa ? <a class="code" href="../../d0/d5/io_8h.html#a21">IRP_MJ_SET_EA</a> : <a class="code" href="../../d0/d5/io_8h.html#a39">IRP_MJ_SET_QUOTA</a>;
06531     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = fileObject;
06532 
06533     <span class="comment">//</span>
06534     <span class="comment">// Now determine whether this driver expects to have data buffered to it</span>
06535     <span class="comment">// or whether it performs direct I/O.  This is based on the DO_BUFFERED_IO</span>
06536     <span class="comment">// flag in the device object.  if the flag is set, then a system buffer is</span>
06537     <span class="comment">// allocated and driver's data is copied to it.  If the DO_DIRECT_IO flag</span>
06538     <span class="comment">// is set in the device object, then a Memory Descriptor List (MDL) is</span>
06539     <span class="comment">// allocated and the caller's buffer is locked down using it.  Finally, if</span>
06540     <span class="comment">// the driver specifies neither of the flags, then simply pass the address</span>
06541     <span class="comment">// and length of the buffer and allow the driver to perform all of the</span>
06542     <span class="comment">// checking and buffering if any is required.</span>
06543     <span class="comment">//</span>
06544 
06545     <span class="keywordflow">if</span> (deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a123">DO_BUFFERED_IO</a>) {
06546 
06547         PVOID systemBuffer;
06548         ULONG errorOffset;
06549 
06550         <span class="comment">//</span>
06551         <span class="comment">// The driver wishes the caller's buffer to be copied into an</span>
06552         <span class="comment">// intermediary buffer.  Allocate the system buffer and specify</span>
06553         <span class="comment">// that it should be deallocated on completion.  Also check to</span>
06554         <span class="comment">// ensure that the caller's EA list or quota list is valid.  All</span>
06555         <span class="comment">// of this is performed within an exception handler that will perform</span>
06556         <span class="comment">// cleanup if the operation fails.</span>
06557         <span class="comment">//</span>
06558 
06559         <span class="keywordflow">try</span> {
06560 
06561             <span class="comment">//</span>
06562             <span class="comment">// Allocate the intermediary system buffer and charge the caller</span>
06563             <span class="comment">// quota for its allocation.  Copy the caller's buffer into the</span>
06564             <span class="comment">// system buffer and check to ensure that it is valid.</span>
06565             <span class="comment">//</span>
06566 
06567             systemBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a11">ExAllocatePoolWithQuota</a>( NonPagedPool, Length );
06568 
06569             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer = systemBuffer;
06570 
06571             RtlCopyMemory( systemBuffer, Buffer, Length );
06572 
06573             <span class="keywordflow">if</span> (SetEa) {
06574                 status = <a class="code" href="../../d4/d6/iosubs_8c.html#a33">IoCheckEaBufferValidity</a>( systemBuffer,
06575                                                   Length,
06576                                                   &amp;errorOffset );
06577             } <span class="keywordflow">else</span> {
06578                 status = <a class="code" href="../../d4/d6/iosubs_8c.html#a37">IoCheckQuotaBufferValidity</a>( systemBuffer,
06579                                                      Length,
06580                                                      &amp;errorOffset );
06581             }
06582 
06583             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
06584                 IoStatusBlock-&gt;Status = status;
06585                 IoStatusBlock-&gt;Information = errorOffset;
06586                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( status );
06587             }
06588 
06589         } except(EXCEPTION_EXECUTE_HANDLER) {
06590 
06591             <span class="comment">//</span>
06592             <span class="comment">// An exception was incurred while allocating the buffer, copying</span>
06593             <span class="comment">// the caller's data into it, or walking the buffer.  Determine</span>
06594             <span class="comment">// what happened, cleanup, and return an appropriate error status</span>
06595             <span class="comment">// code.</span>
06596             <span class="comment">//</span>
06597 
06598             <a class="code" href="../../d0/d6/iop_8h.html#a170">IopExceptionCleanup</a>( fileObject,
06599                                  irp,
06600                                  (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) NULL,
06601                                  event );
06602 
06603             <span class="keywordflow">return</span> GetExceptionCode();
06604 
06605         }
06606 
06607         <span class="comment">//</span>
06608         <span class="comment">// Set the flags so that the completion code knows to deallocate the</span>
06609         <span class="comment">// buffer.</span>
06610         <span class="comment">//</span>
06611 
06612         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a178">IRP_BUFFERED_IO</a> | <a class="code" href="../../d0/d5/io_8h.html#a179">IRP_DEALLOCATE_BUFFER</a>;
06613 
06614     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a125">DO_DIRECT_IO</a>) {
06615 
06616         <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> mdl;
06617 
06618         <span class="comment">//</span>
06619         <span class="comment">// This is a direct I/O operation.  Allocate an MDL and invoke the</span>
06620         <span class="comment">// memory management routine to lock the buffer into memory.  This is</span>
06621         <span class="comment">// done using an exception handler that will perform cleanup if the</span>
06622         <span class="comment">// operation fails.</span>
06623         <span class="comment">//</span>
06624 
06625         mdl = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06626 
06627         <span class="keywordflow">try</span> {
06628 
06629             <span class="comment">//</span>
06630             <span class="comment">// Allocate an MDL, charging quota for it, and hang it off of the</span>
06631             <span class="comment">// IRP.  Probe and lock the pages associated with the caller's</span>
06632             <span class="comment">// buffer for read access and fill in the MDL with the PFNs of those</span>
06633             <span class="comment">// pages.</span>
06634             <span class="comment">//</span>
06635 
06636             mdl = <a class="code" href="../../d4/d6/iosubs_8c.html#a19">IoAllocateMdl</a>( Buffer, Length, FALSE, TRUE, irp );
06637             <span class="keywordflow">if</span> (!mdl) {
06638                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INSUFFICIENT_RESOURCES );
06639             }
06640             <a class="code" href="../../d5/d6/iosup_8c.html#a41">MmProbeAndLockPages</a>( mdl, requestorMode, IoReadAccess );
06641 
06642         } except(EXCEPTION_EXECUTE_HANDLER) {
06643 
06644             <span class="comment">//</span>
06645             <span class="comment">// An exception was incurred while either probing the caller's</span>
06646             <span class="comment">// buffer or allocating the MDL.  Determine what actually happened,</span>
06647             <span class="comment">// clean everything up, and return an appropriate error status code.</span>
06648             <span class="comment">//</span>
06649 
06650             <a class="code" href="../../d0/d6/iop_8h.html#a170">IopExceptionCleanup</a>( fileObject,
06651                                  irp,
06652                                  (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) NULL,
06653                                  event );
06654 
06655             <span class="keywordflow">return</span> GetExceptionCode();
06656 
06657         }
06658 
06659     } <span class="keywordflow">else</span> {
06660 
06661         <span class="comment">//</span>
06662         <span class="comment">// Pass the address of the user's buffer so the driver has access to</span>
06663         <span class="comment">// it.  It is now the driver's responsibility to do everything.</span>
06664         <span class="comment">//</span>
06665 
06666         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o26">UserBuffer</a> = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
06667 
06668     }
06669 
06670     <span class="comment">//</span>
06671     <span class="comment">// Copy the caller's parameters to the service-specific portion of the</span>
06672     <span class="comment">// IRP.</span>
06673     <span class="comment">//</span>
06674 
06675     <span class="keywordflow">if</span> (SetEa) {
06676         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.SetEa.Length = Length;
06677     } <span class="keywordflow">else</span> {
06678         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.SetQuota.Length = Length;
06679     }
06680 
06681     <span class="comment">//</span>
06682     <span class="comment">// Queue the packet, call the driver, and synchronize appropriately with</span>
06683     <span class="comment">// I/O completion.</span>
06684     <span class="comment">//</span>
06685 
06686     status = <a class="code" href="../../d0/d6/iop_8h.html#a212">IopSynchronousServiceTail</a>( deviceObject,
06687                                         irp,
06688                                         fileObject,
06689                                         FALSE,
06690                                         requestorMode,
06691                                         synchronousIo,
06692                                         OtherTransfer );
06693 
06694     <span class="comment">//</span>
06695     <span class="comment">// If the file for this operation was not opened for synchronous I/O, then</span>
06696     <span class="comment">// synchronization of completion of the I/O operation has not yet occurred</span>
06697     <span class="comment">// since the allocated event must be used for synchronous APIs on files</span>
06698     <span class="comment">// opened for asynchronous I/O.  Synchronize the completion of the I/O</span>
06699     <span class="comment">// operation now.</span>
06700     <span class="comment">//</span>
06701 
06702     <span class="keywordflow">if</span> (!synchronousIo) {
06703 
06704         status = <a class="code" href="../../d0/d6/iop_8h.html#a211">IopSynchronousApiServiceTail</a>( status,
06705                                                event,
06706                                                irp,
06707                                                requestorMode,
06708                                                &amp;localIoStatus,
06709                                                IoStatusBlock );
06710     }
06711 
06712     <span class="keywordflow">return</span> status;
06713 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a64" doxytag="internal.c::IopSetRemoteLink" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopSetRemoteLink           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> DestinationFileObject&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFILE_TRACKING_INFORMATION FileInformation&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l06716">6716</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01552">IoBuildDeviceIoControlRequest()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00068">IRP_MJ_FILE_SYSTEM_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00117">IRP_MN_KERNEL_CALL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01552">IRP_SYNCHRONOUS_API</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, and <a class="el" href="../../d3/d3/internal_8c-source.html#l00052">_REMOTE_LINK_BUFFER::TrackingInformation</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l07272">IopTrackLink()</a>.
<p>
<pre class="fragment"><div>06724                    :
06725 
06726     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to remote an <a class="code" href="../../d6/d9/restrfil_8c.html#a38">NtSetInformationFile</a> API call via an
06727     FSCTL to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Redirector.  The call will cause <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remote system to perform
06728     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service call to track <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> link <span class="keywordflow">for</span> a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> which was just <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a100">moved</a>.
06729 
06730 Arguments:
06731 
06732     FileObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> that was <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a100">moved</a>.
06733 
06734     DestinationFileObject - Optionally supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span>
06735         destination location <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
06736 
06737     FileInformation - Optionally supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume and <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object IDs of
06738         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
06739 
06740 Return Value:
06741 
06742     The <span class="keyword">final</span> function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> completion status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
06743 
06744 --*/
06745 
06746 {
06747     <a class="code" href="../../d8/d3/struct__REMOTE__LINK__BUFFER.html">REMOTE_LINK_BUFFER</a> remoteBuffer;
06748     IO_STATUS_BLOCK ioStatus;
06749     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
06750     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
06751     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
06752     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
06753     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
06754     ULONG length = 0;
06755 
06756     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
06757 
06758     <span class="comment">//</span>
06759     <span class="comment">// Initialize the event structure to synchronize completion of the I/O</span>
06760     <span class="comment">// request.</span>
06761     <span class="comment">//</span>
06762 
06763     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event,
06764                        NotificationEvent,
06765                        FALSE );
06766 
06767     <span class="comment">//</span>
06768     <span class="comment">// Build an I/O Request Packet to be sent to the file system driver to get</span>
06769     <span class="comment">// the volume ID.</span>
06770     <span class="comment">//</span>
06771 
06772     deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject );
06773 
06774     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a25">IoBuildDeviceIoControlRequest</a>( FSCTL_LMR_SET_LINK_TRACKING_INFORMATION,
06775                                          deviceObject,
06776                                          NULL,
06777                                          0,
06778                                          NULL,
06779                                          0,
06780                                          FALSE,
06781                                          &amp;event,
06782                                          &amp;ioStatus );
06783     <span class="keywordflow">if</span> (!irp) {
06784         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
06785     }
06786 
06787     <span class="comment">//</span>
06788     <span class="comment">// Initialize the remote link buffer according to the input information.</span>
06789     <span class="comment">//</span>
06790 
06791     <span class="keywordflow">if</span> (DestinationFileObject) {
06792 
06793         <span class="comment">// The FileObject and DestinationFileObject are on the same machine</span>
06794         remoteBuffer.<a class="code" href="../../d8/d3/struct__REMOTE__LINK__BUFFER.html#o0">TrackingInformation</a>.TargetFileObject = DestinationFileObject;
06795 
06796         <span class="keywordflow">if</span> (FileInformation) {
06797             <span class="comment">// Copy the ObjectInformation from the FileInformation buffer into</span>
06798             <span class="comment">// the TargetLinkTrackingInformationBuffer.  Set 'length' to include</span>
06799             <span class="comment">// this buffer.</span>
06800 
06801             remoteBuffer.<a class="code" href="../../d8/d3/struct__REMOTE__LINK__BUFFER.html#o0">TrackingInformation</a>.TargetLinkTrackingInformationLength
06802                 = length = FileInformation-&gt;ObjectInformationLength;
06803             RtlCopyMemory( &amp;remoteBuffer.<a class="code" href="../../d8/d3/struct__REMOTE__LINK__BUFFER.html#o0">TrackingInformation</a>.TargetLinkTrackingInformationBuffer,
06804                            FileInformation-&gt;ObjectInformation,
06805                            length );
06806         } <span class="keywordflow">else</span> {
06807             <span class="comment">// We don't have any extra FileInformation.</span>
06808             remoteBuffer.<a class="code" href="../../d8/d3/struct__REMOTE__LINK__BUFFER.html#o0">TrackingInformation</a>.TargetLinkTrackingInformationLength = 0;
06809         }
06810 
06811         <span class="comment">// Increment the length to include the size of the non-optional fields in</span>
06812         <span class="comment">// REMOTE_LINK_TRACKING_INFORMATION.</span>
06813         length += <span class="keyword">sizeof</span>( <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> ) + <span class="keyword">sizeof</span>( ULONG );
06814 
06815     } <span class="keywordflow">else</span> {
06816         <span class="comment">// There's no DestinationFileObject, so all the necessary information is in the</span>
06817         <span class="comment">// FileInformation structure.</span>
06818         length = FileInformation-&gt;ObjectInformationLength + <span class="keyword">sizeof</span>( HANDLE ) + <span class="keyword">sizeof</span>( ULONG );
06819         RtlCopyMemory( &amp;remoteBuffer.<a class="code" href="../../d8/d3/struct__REMOTE__LINK__BUFFER.html#o0">TrackingInformation</a>,
06820                        FileInformation,
06821                        length );
06822         remoteBuffer.<a class="code" href="../../d8/d3/struct__REMOTE__LINK__BUFFER.html#o0">TrackingInformation</a>.TargetFileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06823     }
06824 
06825     <span class="comment">//</span>
06826     <span class="comment">// Fill in the remainder of the IRP to retrieve the object ID for the</span>
06827     <span class="comment">// file.</span>
06828     <span class="comment">//</span>
06829 
06830     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a>;
06831     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer = &amp;remoteBuffer;
06832     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = FileObject;
06833 
06834     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
06835     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = FileObject;
06836     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a26">IRP_MJ_FILE_SYSTEM_CONTROL</a>;
06837     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a51">IRP_MN_KERNEL_CALL</a>;
06838     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.FileSystemControl.InputBufferLength = length;
06839 
06840     <span class="comment">//</span>
06841     <span class="comment">// Take out another reference to the file object to guarantee that it does</span>
06842     <span class="comment">// not get deleted.</span>
06843     <span class="comment">//</span>
06844 
06845     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( FileObject );
06846 
06847     <span class="comment">//</span>
06848     <span class="comment">// Call the driver to get the request.</span>
06849     <span class="comment">//</span>
06850 
06851     status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( deviceObject, irp );
06852 
06853     <span class="comment">//</span>
06854     <span class="comment">// Synchronize completion of the request.</span>
06855     <span class="comment">//</span>
06856 
06857     <span class="keywordflow">if</span> (status == STATUS_PENDING) {
06858         status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
06859                                         Executive,
06860                                         KernelMode,
06861                                         FALSE,
06862                                         (PLARGE_INTEGER) NULL );
06863         status = ioStatus.Status;
06864     }
06865 
06866     <span class="keywordflow">return</span> status;
06867 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a65" doxytag="internal.c::IopStartApcHardError" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopStartApcHardError           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>StartContext</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l06870">6870</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00070">IO_DISK_INCREMENT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02960">IoCompleteRequest</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00383">IopApcHardError()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00175">PsCreateSystemThread()</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08769">IoRaiseHardError()</a>.
<p>
<pre class="fragment"><div>06876                    :
06877 
06878     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked in an ExWorker thread when we need to <span class="keywordflow">do</span> a
06879     hard error pop-up, but <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>'s originating thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> at APC level,
06880     ie. <a class="code" href="../../d0/d5/io_8h.html#a524">IoPageRead</a>.  It starts a thread to hold <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pop-up.
06881 
06882 Arguments:
06883 
06884     StartContext - Startup context, contains a <a class="code" href="../../d5/d0/struct__IOP__APC__HARD__ERROR__PACKET.html">IOP_APC_HARD_ERROR_PACKET</a>.
06885 
06886 Return Value:
06887 
06888     None.
06889 
06890 --*/
06891 
06892 {
06893     HANDLE thread;
06894     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
06895 
06896     <span class="comment">//</span>
06897     <span class="comment">//  Create the hard error pop-up thread.  If for whatever reason we</span>
06898     <span class="comment">//  can't do this then just complete the Irp with the error.</span>
06899     <span class="comment">//</span>
06900 
06901     status = <a class="code" href="../../d2/d8/ps_2create_8c.html#a11">PsCreateSystemThread</a>( &amp;thread,
06902                                    0,
06903                                    (POBJECT_ATTRIBUTES)NULL,
06904                                    (HANDLE)0,
06905                                    (PCLIENT_ID)NULL,
06906                                    IopApcHardError,
06907                                    StartContext );
06908 
06909     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) ) {
06910 
06911 
06912         <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>( ((<a class="code" href="../../d5/d0/struct__IOP__APC__HARD__ERROR__PACKET.html">PIOP_APC_HARD_ERROR_PACKET</a>)StartContext)-&gt;Irp,
06913                            IO_DISK_INCREMENT );
06914         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( StartContext );
06915         <span class="keywordflow">return</span>;
06916     }
06917 
06918     <span class="comment">//</span>
06919     <span class="comment">//  Close thread handle</span>
06920     <span class="comment">//</span>
06921 
06922     ZwClose(thread);
06923 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a66" doxytag="internal.c::IopSynchronousApiServiceTail" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopSynchronousApiServiceTail           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN NTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnedStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Event</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RequestorMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>LocalIoStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatusBlock</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l06926">6926</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00417">IopCancelAlertedRequest()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l06326">IopSetEaOrQuotaInformationFile()</a>, <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00386">NtFlushBuffersFile()</a>, <a class="el" href="../../d8/d1/qsea_8c-source.html#l00035">NtQueryEaFile()</a>, <a class="el" href="../../d1/d2/qsquota_8c-source.html#l00035">NtQueryQuotaInformationFile()</a>, <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00037">NtQueryVolumeInformationFile()</a>, <a class="el" href="../../d8/d1/qsea_8c-source.html#l00652">NtSetEaFile()</a>, <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00492">NtSetVolumeInformationFile()</a>, and <a class="el" href="../../d2/d4/lock_8c-source.html#l00458">NtUnlockFile()</a>.
<p>
<pre class="fragment"><div>06937                    :
06938 
06939     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked when a synchronous API <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked <span class="keywordflow">for</span> a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
06940     that has been opened <span class="keywordflow">for</span> asynchronous I/O.  This function synchronizes
06941     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> completion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O operation on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
06942 
06943 Arguments:
06944 
06945     ReturnedStatus - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status that was returned from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call to
06946         <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>.
06947 
06948     <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> - Address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated kernel event to be used <span class="keywordflow">for</span> synchronization
06949         of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O operation.
06950 
06951     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet submitted to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver.
06952 
06953     RequestorMode - Processor mode of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation was
06954         requested.
06955 
06956     LocalIoStatus - Address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O status block used to capture <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span>
06957         status by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service itself.
06958 
06959     IoStatusBlock - Address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O status block supplied by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller of
06960         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system service.
06961 
06962 Return Value:
06963 
06964     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
06965 
06966 
06967 --*/
06968 
06969 {
06970     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
06971 
06972     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
06973 
06974     <span class="comment">//</span>
06975     <span class="comment">// This is a normal synchronous I/O operation, as opposed to a</span>
06976     <span class="comment">// serialized synchronous I/O operation.  For this case, wait for</span>
06977     <span class="comment">// the local event and copy the final status information back to</span>
06978     <span class="comment">// the caller.</span>
06979     <span class="comment">//</span>
06980 
06981     status = ReturnedStatus;
06982 
06983     <span class="keywordflow">if</span> (status == STATUS_PENDING) {
06984 
06985         status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( Event,
06986                                         Executive,
06987                                         RequestorMode,
06988                                         FALSE,
06989                                         (PLARGE_INTEGER) NULL );
06990 
06991         <span class="keywordflow">if</span> (status == STATUS_ALERTED || status == STATUS_USER_APC) {
06992 
06993             <span class="comment">//</span>
06994             <span class="comment">// The wait request has ended either because the thread was</span>
06995             <span class="comment">// alerted or an APC was queued to this thread, because of</span>
06996             <span class="comment">// thread rundown or CTRL/C processing.  In either case, try</span>
06997             <span class="comment">// to bail out of this I/O request carefully so that the IRP</span>
06998             <span class="comment">// completes before this routine exists or the event will not</span>
06999             <span class="comment">// be around to set to the Signaled state.</span>
07000             <span class="comment">//</span>
07001 
07002             <a class="code" href="../../d0/d6/iop_8h.html#a151">IopCancelAlertedRequest</a>( Event, Irp );
07003 
07004         }
07005 
07006         status = LocalIoStatus-&gt;Status;
07007     }
07008 
07009     <span class="keywordflow">try</span> {
07010 
07011         *IoStatusBlock = *LocalIoStatus;
07012 
07013     } except(EXCEPTION_EXECUTE_HANDLER) {
07014 
07015         <span class="comment">//</span>
07016         <span class="comment">// An exception occurred attempting to write the caller's I/O</span>
07017         <span class="comment">// status block.  Simply change the final status of the operation</span>
07018         <span class="comment">// to the exception code.</span>
07019         <span class="comment">//</span>
07020 
07021         status = GetExceptionCode();
07022     }
07023 
07024     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Event );
07025 
07026     <span class="keywordflow">return</span> status;
07027 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a67" doxytag="internal.c::IopSynchronousServiceTail" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopSynchronousServiceTail           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>DeferredIoCompletion</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RequestorMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>SynchronousIo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/iop_8h.html#a25">TRANSFER_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TransferType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l07030">7030</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01492">FO_ALERTABLE_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00417">IopCancelAlertedRequest()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l01019">IopCompleteRequest()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l01103">IopQueueThreadIrp</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l01157">IopReleaseFileObjectLock</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12345">IopUpdateOtherOperationCount()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12377">IopUpdateReadOperationCount()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12410">IopUpdateWriteOperationCount()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d6/iop_8h.html#a240a140">OtherTransfer</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01648">_IRP::PendingReturned</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00196">PKNORMAL_ROUTINE</a>, <a class="el" href="../../d0/d6/iop_8h.html#a240a138">ReadTransfer</a>, <a class="el" href="../../d2/d4/internal_8c.html#a2">SynchronousIo</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d0/d6/iop_8h.html#a25">TRANSFER_TYPE</a>, and <a class="el" href="../../d0/d6/iop_8h.html#a240a139">WriteTransfer</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l06326">IopSetEaOrQuotaInformationFile()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l08084">IopXxxControlFile()</a>, <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00386">NtFlushBuffersFile()</a>, <a class="el" href="../../d2/d4/lock_8c-source.html#l00035">NtLockFile()</a>, <a class="el" href="../../d1/d7/dir_8c-source.html#l00821">NtNotifyChangeDirectoryFile()</a>, <a class="el" href="../../d1/d7/dir_8c-source.html#l00682">NtQueryDirectoryFile()</a>, <a class="el" href="../../d8/d1/qsea_8c-source.html#l00035">NtQueryEaFile()</a>, <a class="el" href="../../d1/d2/qsquota_8c-source.html#l00035">NtQueryQuotaInformationFile()</a>, <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00037">NtQueryVolumeInformationFile()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00036">NtReadFile()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00730">NtReadFileScatter()</a>, <a class="el" href="../../d8/d1/qsea_8c-source.html#l00652">NtSetEaFile()</a>, <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00492">NtSetVolumeInformationFile()</a>, <a class="el" href="../../d2/d4/lock_8c-source.html#l00458">NtUnlockFile()</a>, <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00035">NtWriteFile()</a>, and <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00801">NtWriteFileGather()</a>.
<p>
<pre class="fragment"><div>07042                    :
07043 
07044     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation of a system service.
07045     It queues <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread's queue, updates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> transfer count,
07046     calls <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver, and finally synchronizes completion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O.
07047 
07048 Arguments:
07049 
07050     DeviceObject - Device on which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to occur.
07051 
07052     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet representing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O operation.
07053 
07054     FileObject - <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> object <span class="keywordflow">for</span> <span class="keyword">this</span> open instantiation.
07055 
07056     DeferredIoCompletion - Indicates whether deferred completion <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> possible.
07057 
07058     RequestorMode - Mode in which request was <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a>.
07059 
07060     <a class="code" href="../../d2/d4/internal_8c.html#a2">SynchronousIo</a> - Indicates whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be synchronous.
07061 
07062     TransferType - Type of transfer being performed: read, write, or other.
07063 
07064 Return Value:
07065 
07066     The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
07067 
07068 --*/
07069 
07070 {
07071     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
07072 
07073     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
07074 
07075     <span class="comment">//</span>
07076     <span class="comment">// Insert the packet at the head of the IRP list for the thread.</span>
07077     <span class="comment">//</span>
07078 
07079     <a class="code" href="../../d0/d6/iop_8h.html#a21">IopQueueThreadIrp</a>( Irp );
07080 
07081     <span class="comment">//</span>
07082     <span class="comment">// Update the operation count statistic for the current process.</span>
07083     <span class="comment">//</span>
07084 
07085     <span class="keywordflow">switch</span>( TransferType ) {
07086 
07087     <span class="keywordflow">case</span> <a class="code" href="../../d0/d6/iop_8h.html#a240a138">ReadTransfer</a>:
07088         <a class="code" href="../../d4/d6/iosubs_8c.html#a130">IopUpdateReadOperationCount</a>();
07089         <span class="keywordflow">break</span>;
07090 
07091     <span class="keywordflow">case</span> <a class="code" href="../../d0/d6/iop_8h.html#a240a139">WriteTransfer</a>:
07092         <a class="code" href="../../d4/d6/iosubs_8c.html#a131">IopUpdateWriteOperationCount</a>();
07093         <span class="keywordflow">break</span>;
07094 
07095     <span class="keywordflow">case</span> <a class="code" href="../../d0/d6/iop_8h.html#a240a140">OtherTransfer</a>:
07096         <a class="code" href="../../d4/d6/iosubs_8c.html#a129">IopUpdateOtherOperationCount</a>();
07097         <span class="keywordflow">break</span>;
07098     }
07099 
07100     <span class="comment">//</span>
07101     <span class="comment">// Now simply invoke the driver at its dispatch entry with the IRP.</span>
07102     <span class="comment">//</span>
07103 
07104     status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( DeviceObject, Irp );
07105 
07106     <span class="comment">//</span>
07107     <span class="comment">// If deferred I/O completion is possible, check for pending returned</span>
07108     <span class="comment">// from the driver.  If the driver did not return pending, then the</span>
07109     <span class="comment">// packet has not actually been completed yet, so complete it here.</span>
07110     <span class="comment">//</span>
07111 
07112     <span class="keywordflow">if</span> (DeferredIoCompletion) {
07113 
07114         <span class="keywordflow">if</span> (status != STATUS_PENDING) {
07115 
07116             <span class="comment">//</span>
07117             <span class="comment">// The I/O operation was completed without returning a status of</span>
07118             <span class="comment">// pending.  This means that at this point, the IRP has not been</span>
07119             <span class="comment">// fully completed.  Complete it now.</span>
07120             <span class="comment">//</span>
07121 
07122             <a class="code" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> normalRoutine;
07123             PVOID normalContext;
07124             KIRQL irql;
07125 
07126             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o11">PendingReturned</a> );
07127 
07128             <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>( APC_LEVEL, &amp;irql );
07129             <a class="code" href="../../d0/d6/iop_8h.html#a157">IopCompleteRequest</a>( &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Apc,
07130                                 &amp;normalRoutine,
07131                                 &amp;normalContext,
07132                                 (PVOID *) &amp;FileObject,
07133                                 &amp;normalContext );
07134             <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>( irql );
07135         }
07136     }
07137 
07138     <span class="comment">//</span>
07139     <span class="comment">// If this operation was a synchronous I/O operation, check the return</span>
07140     <span class="comment">// status to determine whether or not to wait on the file object.  If</span>
07141     <span class="comment">// the file object is to be waited on, wait for the operation to complete</span>
07142     <span class="comment">// and obtain the final status from the file object itself.</span>
07143     <span class="comment">//</span>
07144 
07145     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4/internal_8c.html#a2">SynchronousIo</a>) {
07146 
07147         <span class="keywordflow">if</span> (status == STATUS_PENDING) {
07148 
07149             status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;FileObject-&gt;Event,
07150                                             Executive,
07151                                             RequestorMode,
07152                                             (BOOLEAN) ((FileObject-&gt;Flags &amp; FO_ALERTABLE_IO) != 0),
07153                                             (PLARGE_INTEGER) NULL );
07154 
07155             <span class="keywordflow">if</span> (status == STATUS_ALERTED || status == STATUS_USER_APC) {
07156 
07157                 <span class="comment">//</span>
07158                 <span class="comment">// The wait request has ended either because the thread was alerted</span>
07159                 <span class="comment">// or an APC was queued to this thread, because of thread rundown or</span>
07160                 <span class="comment">// CTRL/C processing.  In either case, try to bail out of this I/O</span>
07161                 <span class="comment">// request carefully so that the IRP completes before this routine</span>
07162                 <span class="comment">// exists so that synchronization with the file object will remain</span>
07163                 <span class="comment">// intact.</span>
07164                 <span class="comment">//</span>
07165 
07166                 <a class="code" href="../../d0/d6/iop_8h.html#a151">IopCancelAlertedRequest</a>( &amp;FileObject-&gt;Event, Irp );
07167 
07168             }
07169 
07170             status = FileObject-&gt;FinalStatus;
07171 
07172         }
07173 
07174         <a class="code" href="../../d0/d6/iop_8h.html#a22">IopReleaseFileObjectLock</a>( FileObject );
07175 
07176     }
07177 
07178     <span class="keywordflow">return</span> status;
07179 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a68" doxytag="internal.c::IopTimerDispatch" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopTimerDispatch           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d6/struct__KDPC.html">PKDPC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Dpc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>DeferredContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l07182">7182</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01036">_IO_TIMER::Context</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01037">_IO_TIMER::DeviceObject</a>, <a class="el" href="../../d0/d5/io_8h.html#a328">IO_TIMER</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00225">IopTimerCount</a>, <a class="el" href="../../d5/d3/alpha_2splocks_8c-source.html#l00050">IopTimerLock</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00222">IopTimerQueueHead</a>, <a class="el" href="../../d0/d5/io_8h.html#a329">PIO_TIMER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01033">_IO_TIMER::TimerFlag</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01035">_IO_TIMER::TimerRoutine</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>.
<p>
<pre class="fragment"><div>07191                    :
07192 
07193     This routine scans <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O system timer database and invokes each driver
07194     that has enabled a timer in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list, once every second.
07195 
07196 Arguments:
07197 
07198     Dpc - Supplies a pointer to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> DPC.
07199 
07200     DeferredContext - Optional deferred context;  not used.
07201 
07202     SystemArgument1 - Optional argument 1;  not used.
07203 
07204     SystemArgument2 - Optional argument 2;  not used.
07205 
07206 Return Value:
07207 
07208     None.
07209 
07210 --*/
07211 
07212 {
07213     PLIST_ENTRY timerEntry;
07214     <a class="code" href="../../d4/d9/struct__IO__TIMER.html">PIO_TIMER</a> timer;
07215     LARGE_INTEGER deltaTime;
07216     KIRQL irql;
07217     ULONG i;
07218 
07219     UNREFERENCED_PARAMETER( Dpc );
07220     UNREFERENCED_PARAMETER( DeferredContext );
07221     UNREFERENCED_PARAMETER( SystemArgument1 );
07222     UNREFERENCED_PARAMETER( SystemArgument2 );
07223 
07224     <span class="comment">//</span>
07225     <span class="comment">// Check to see whether or not there are any timers in the queue that</span>
07226     <span class="comment">// have been enabled.  If so, then walk the list and invoke all of the</span>
07227     <span class="comment">// drivers' routines.  Note that if the counter changes, which it can</span>
07228     <span class="comment">// because the spin lock is not owned, then a timer routine may be</span>
07229     <span class="comment">// missed.  However, this is acceptable, since the driver inserting the</span>
07230     <span class="comment">// entry could be context switched away from, etc.  Therefore, this is</span>
07231     <span class="comment">// not a critical resource for the most part.</span>
07232     <span class="comment">//</span>
07233 
07234     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/iodata_8c.html#a31">IopTimerCount</a>) {
07235 
07236         <span class="comment">//</span>
07237         <span class="comment">// There is at least one timer entry in the queue that is enabled.</span>
07238         <span class="comment">// Walk the queue and invoke each specified timer routine.</span>
07239         <span class="comment">//</span>
07240 
07241         ExAcquireSpinLock( &amp;IopTimerLock, &amp;irql );
07242         i = <a class="code" href="../../d3/d5/iodata_8c.html#a31">IopTimerCount</a>;
07243         timerEntry = <a class="code" href="../../d3/d5/iodata_8c.html#a28">IopTimerQueueHead</a>.Flink;
07244 
07245         <span class="comment">//</span>
07246         <span class="comment">// For each entry found that is enabled, invoke the driver's routine</span>
07247         <span class="comment">// with its specified context parameter.  The local count is used</span>
07248         <span class="comment">// to abort the queue traversal when there are more entries in the</span>
07249         <span class="comment">// queue, but they are not enabled.</span>
07250         <span class="comment">//</span>
07251 
07252         <span class="keywordflow">for</span> (timerEntry = <a class="code" href="../../d3/d5/iodata_8c.html#a28">IopTimerQueueHead</a>.Flink;
07253              (timerEntry != &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a28">IopTimerQueueHead</a>) &amp;&amp; i;
07254              timerEntry = timerEntry-&gt;Flink ) {
07255 
07256             timer = CONTAINING_RECORD( timerEntry, <a class="code" href="../../d4/d9/struct__IO__TIMER.html">IO_TIMER</a>, TimerList );
07257 
07258             <span class="keywordflow">if</span> (timer-&gt;<a class="code" href="../../d4/d9/struct__IO__TIMER.html#o1">TimerFlag</a>) {
07259                 timer-&gt;<a class="code" href="../../d4/d9/struct__IO__TIMER.html#o3">TimerRoutine</a>( timer-&gt;<a class="code" href="../../d4/d9/struct__IO__TIMER.html#o5">DeviceObject</a>, timer-&gt;<a class="code" href="../../d4/d9/struct__IO__TIMER.html#o4">Context</a> );
07260                 i--;
07261             }
07262         }
07263         ExReleaseSpinLock( &amp;IopTimerLock, irql );
07264     }
07265 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a69" doxytag="internal.c::IopTrackLink" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopTrackLink           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatusBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFILE_TRACKING_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>FileInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Event</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RequestorMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l07272">7272</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00127">ExAllocatePoolWithQuota</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00044">FILE_VOLUMEID_WITH_TYPE</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00044">IoFileObjectType</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02718">IopGetSetObjectId()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a184">IopGetVolumeId()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03134">IopIsSameMachine()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06010">IopMarshalIds()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06127">IopSendMessageToTrackService()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06716">IopSetRemoteLink()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00042">IsFileLocal</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00714">RtlCompareMemoryUlong()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00047">_TRACKING_BUFFER::TrackingInformation</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00849">NtSetInformationFile()</a>.
<p>
<pre class="fragment"><div>07283                    :
07284 
07285     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to track a link.  It tracks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>'s Object
07286     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> so that links to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source will follow to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span>
07287     location of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target.
07288 
07289 Arguments:
07290 
07291     FileObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> referenced source <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.
07292 
07293     IoStatusBlock - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's I/O status block.
07294 
07295     FileInformation - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> buffer containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parameters <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d4/conexts_8c.html#a1">move</a> that was
07296         performed.
07297 
07298     Length - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FileInformation buffer.
07299 
07300     <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> - An event to be set to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Signaled state once <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation has been
07301         performed, provided <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> was successful.
07302 
07303     RequestorMode - Requestor mode of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
07304 
07305 N.B. - Note that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> presence of an event indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> was
07306     opened <span class="keywordflow">for</span> asynchronous I/O, otherwise <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> was opened <span class="keywordflow">for</span> synchronous I/O.
07307 
07308 Return Value:
07309 
07310     The status returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> completion status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
07311 
07312 
07313 --*/
07314 
07315 {
07316     PFILE_TRACKING_INFORMATION trackingInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07317     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> dstFileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07318     <a class="code" href="../../d2/d4/internal_8c.html#a5">FILE_VOLUMEID_WITH_TYPE</a> SourceVolumeId;
07319     FILE_OBJECTID_BUFFER SourceObjectId;
07320     FILE_OBJECTID_BUFFER NormalizedObjectId;
07321     FILE_OBJECTID_BUFFER CrossVolumeObjectId;
07322     <a class="code" href="../../d2/d4/internal_8c.html#a5">FILE_VOLUMEID_WITH_TYPE</a> TargetVolumeId;
07323     FILE_OBJECTID_BUFFER TargetObjectId;
07324     <a class="code" href="../../d1/d2/struct__TRACKING__BUFFER.html">TRACKING_BUFFER</a> trackingBuffer;
07325     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
07326 
07327     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
07328 
07329     <span class="comment">//</span>
07330     <span class="comment">// Begin by capturing the caller's buffer, if required.</span>
07331     <span class="comment">//</span>
07332 
07333     <span class="keywordflow">if</span> (RequestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
07334 
07335         <span class="keywordflow">try</span> {
07336             trackingInfo = <a class="code" href="../../d5/d5/cc_8h.html#a11">ExAllocatePoolWithQuota</a>( PagedPool,
07337                                                     Length );
07338             RtlCopyMemory( trackingInfo, FileInformation, Length );
07339 
07340             <span class="keywordflow">if</span> (!trackingInfo-&gt;DestinationFile ||
07341                ((Length - FIELD_OFFSET( FILE_TRACKING_INFORMATION, ObjectInformation )) 
07342                 &lt; trackingInfo-&gt;ObjectInformationLength)) {
07343                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( trackingInfo );
07344                 <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
07345             }
07346 
07347         } except(EXCEPTION_EXECUTE_HANDLER) {
07348 
07349             <span class="comment">//</span>
07350             <span class="comment">// An exception was incurred while allocating the intermediary</span>
07351             <span class="comment">// system buffer or while copying the caller's data into the</span>
07352             <span class="comment">// buffer.  Cleanup and return an appropriate error status code.</span>
07353             <span class="comment">//</span>
07354 
07355             <span class="keywordflow">if</span> (trackingInfo) {
07356                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( trackingInfo );
07357             }
07358 
07359             <span class="keywordflow">return</span> GetExceptionCode();
07360         }
07361     } <span class="keywordflow">else</span> {
07362         trackingInfo = FileInformation;
07363     }
07364 
07365     <span class="comment">//</span>
07366     <span class="comment">// If a destination file handle was specified, convert it to a pointer to</span>
07367     <span class="comment">// a file object.</span>
07368     <span class="comment">//</span>
07369 
07370     <span class="keywordflow">if</span> (trackingInfo-&gt;DestinationFile) {
07371         status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( trackingInfo-&gt;DestinationFile,
07372                                             FILE_WRITE_DATA,
07373                                             IoFileObjectType,
07374                                             RequestorMode,
07375                                             (PVOID *) &amp;dstFileObject,
07376                                             NULL );
07377         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07378             <span class="keywordflow">if</span> (RequestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
07379                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( trackingInfo );
07380             }
07381             <span class="keywordflow">return</span> status;
07382         }
07383     }
07384 
07385     <span class="keywordflow">try</span> {
07386 
07387         <span class="comment">//</span>
07388         <span class="comment">// Determine whether this is a local or a remote link tracking</span>
07389         <span class="comment">// operation.</span>
07390         <span class="comment">//</span>
07391 
07392         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4/internal_8c.html#a0">IsFileLocal</a>( FileObject )) {
07393 
07394             <span class="comment">//</span>
07395             <span class="comment">// The source file, i.e., the one being moved, is a file local to</span>
07396             <span class="comment">// this system.  Determine the form of the target file and track</span>
07397             <span class="comment">// it accordingly.</span>
07398             <span class="comment">//</span>
07399 
07400             <span class="keywordflow">if</span> (trackingInfo-&gt;DestinationFile) {
07401 
07402                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4/internal_8c.html#a0">IsFileLocal</a>( dstFileObject )) {
07403 
07404                     BOOLEAN IdSetOnTarget = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07405 
07406                     <span class="comment">//</span>
07407                     <span class="comment">// The target file is specified as a handle and it is local.</span>
07408                     <span class="comment">// Simply perform the query and set locally.  Note that if</span>
07409                     <span class="comment">// the source file does not have an object ID, then no</span>
07410                     <span class="comment">// tracking will be performed, but it will appear as if the</span>
07411                     <span class="comment">// operation worked.</span>
07412                     <span class="comment">//</span>
07413 
07414                     status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( FileObject,
07415                                                 &amp;SourceObjectId,
07416                                                 <span class="keyword">sizeof</span>( SourceObjectId ),
07417                                                 FSCTL_GET_OBJECT_ID );
07418 
07419                     <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND) {
07420                         <span class="keywordflow">return</span>(STATUS_SUCCESS);
07421                     }
07422 
07423                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07424                         <span class="keywordflow">return</span> status;
07425                     }
07426 
07427                     <span class="comment">//</span>
07428                     <span class="comment">// If the extended info field is zero then this file</span>
07429                     <span class="comment">// has no interesting tracking information.</span>
07430                     <span class="comment">//</span>
07431                     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7/string_8c.html#a17">RtlCompareMemoryUlong</a>(SourceObjectId.BirthObjectId,
07432                                        <span class="keyword">sizeof</span>(SourceObjectId.BirthObjectId),
07433                                        0) == <span class="keyword">sizeof</span>(SourceObjectId.BirthObjectId)) {
07434                             <span class="keywordflow">return</span> (STATUS_SUCCESS);
07435                     }
07436 
07437 
07438                     <span class="comment">//</span>
07439                     <span class="comment">// Get the volume ID of the source and destination</span>
07440                     <span class="comment">//</span>
07441 
07442                     status = <a class="code" href="../../d0/d6/iop_8h.html#a184">IopGetVolumeId</a>( dstFileObject,
07443                                              &amp;TargetVolumeId,
07444                                              <span class="keyword">sizeof</span>( TargetVolumeId ) );
07445                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07446                         <span class="keywordflow">return</span> status;
07447                     }
07448 
07449                     status = <a class="code" href="../../d0/d6/iop_8h.html#a184">IopGetVolumeId</a>( FileObject,
07450                                              &amp;SourceVolumeId,
07451                                              <span class="keyword">sizeof</span>( SourceVolumeId ) );
07452                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07453                         <span class="keywordflow">return</span> status;
07454                     }
07455 
07456                     <span class="comment">//</span>
07457                     <span class="comment">// Delete the ID from the source now, since the</span>
07458                     <span class="comment">// target may be on the same volume.  If there's a</span>
07459                     <span class="comment">// subsequent error, we'll try to restore it.</span>
07460                     <span class="comment">//</span>
07461 
07462                     status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( FileObject,
07463                                                 NULL,
07464                                                 0,
07465                                                 FSCTL_DELETE_OBJECT_ID );
07466                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07467                         <span class="keywordflow">return</span> status;
07468                     }
07469 
07470 
07471                     <span class="comment">//</span>
07472                     <span class="comment">// Set the ID on the target.  If it's a cross-volume</span>
07473                     <span class="comment">// move, set the bit that indicates same.</span>
07474                     <span class="comment">//</span>
07475 
07476                     CrossVolumeObjectId = TargetObjectId = SourceObjectId;
07477                     <span class="keywordflow">if</span>( !RtlEqualMemory( &amp;TargetVolumeId.VolumeId[0],
07478                                          &amp;SourceVolumeId.VolumeId[0],
07479                                          <span class="keyword">sizeof</span>(SourceVolumeId.VolumeId) )) {
07480                         CrossVolumeObjectId.BirthVolumeId[0] |= 1;
07481                     }
07482 
07483                     status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( dstFileObject,
07484                                                 &amp;CrossVolumeObjectId,
07485                                                 <span class="keyword">sizeof</span>( CrossVolumeObjectId ),
07486                                                 FSCTL_SET_OBJECT_ID );
07487 
07488                     <span class="keywordflow">if</span>( status == STATUS_DUPLICATE_NAME ||
07489                         status == STATUS_OBJECT_NAME_COLLISION ) {
07490 
07491                         <span class="comment">// This object ID is already in use on the target volume,</span>
07492                         <span class="comment">// or the dest file already has an object ID.</span>
07493                         <span class="comment">// Get the file's ID (or have NTFS generate a new one).</span>
07494 
07495                         status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( dstFileObject,
07496                                                     &amp;TargetObjectId,
07497                                                     <span class="keyword">sizeof</span>(TargetObjectId),
07498                                                     FSCTL_CREATE_OR_GET_OBJECT_ID );
07499                         <span class="keywordflow">if</span>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
07500 
07501                             <span class="comment">// Write the birth ID</span>
07502 
07503                             status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( dstFileObject,
07504                                                         &amp;CrossVolumeObjectId.ExtendedInfo[0],
07505                                                         <span class="keyword">sizeof</span>( CrossVolumeObjectId.ExtendedInfo ),
07506                                                         FSCTL_SET_OBJECT_ID_EXTENDED );
07507                         }
07508                     }
07509 
07510                     <span class="keywordflow">if</span>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
07511 
07512                         IdSetOnTarget = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
07513 
07514                         <span class="comment">// If this was a cross-volume move, notify the tracking service.</span>
07515 
07516                         <span class="keywordflow">if</span>( !RtlEqualMemory( &amp;TargetVolumeId.VolumeId[0],
07517                                              &amp;SourceVolumeId.VolumeId[0],
07518                                              <span class="keyword">sizeof</span>(SourceVolumeId.VolumeId) )) {
07519 
07520                             <a class="code" href="../../d2/d4/internal_8c.html#a15">IopMarshalIds</a>( &amp;trackingBuffer, &amp;TargetVolumeId, &amp;TargetObjectId, trackingInfo );
07521 
07522                             <span class="comment">// Bit 0 must be reset before notifying tracking service</span>
07523                             NormalizedObjectId = SourceObjectId;
07524                             NormalizedObjectId.BirthVolumeId[0] &amp;= 0xfe;
07525 
07526                             status = <a class="code" href="../../d2/d4/internal_8c.html#a62">IopSendMessageToTrackService</a>( &amp;SourceVolumeId,
07527                                                                    &amp;NormalizedObjectId,
07528                                                                    &amp;trackingBuffer.<a class="code" href="../../d1/d2/struct__TRACKING__BUFFER.html#o0">TrackingInformation</a> );
07529                         }
07530                     }
07531 
07532                     <span class="comment">//</span>
07533                     <span class="comment">// If there was an error after the ObjectID was deleted</span>
07534                     <span class="comment">// from the source.  Try to restore it before returning.</span>
07535                     <span class="comment">//</span>
07536 
07537                     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
07538                         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> statusT = STATUS_SUCCESS;
07539 
07540                         <span class="keywordflow">if</span>( IdSetOnTarget ) {
07541 
07542                             <span class="keywordflow">if</span>( RtlEqualMemory( &amp;TargetObjectId.ObjectId,
07543                                                 &amp;SourceObjectId.ObjectId,
07544                                                 <span class="keyword">sizeof</span>(TargetObjectId.ObjectId) )) {
07545 
07546                                 <span class="comment">// This ID was set with FSCTL_SET_OBJECT_ID</span>
07547                                 statusT = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( dstFileObject,
07548                                                              NULL,
07549                                                              0,
07550                                                              FSCTL_DELETE_OBJECT_ID );
07551 
07552                             } <span class="keywordflow">else</span> {
07553 
07554                                 <span class="comment">// Restore the target's extended data.</span>
07555 
07556                                 statusT = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( dstFileObject,
07557                                                              &amp;TargetObjectId.ExtendedInfo[0],
07558                                                              <span class="keyword">sizeof</span>(TargetObjectId.ExtendedInfo),
07559                                                              FSCTL_SET_OBJECT_ID_EXTENDED );
07560                             }
07561                         }
07562 
07563                         <span class="keywordflow">if</span>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( statusT )) {
07564 
07565                             <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( FileObject,
07566                                                &amp;SourceObjectId,
07567                                                <span class="keyword">sizeof</span>(SourceObjectId),
07568                                                FSCTL_SET_OBJECT_ID );
07569                         }
07570 
07571                         <span class="keywordflow">return</span> status;
07572                     }
07573 
07574 
07575                 } <span class="keywordflow">else</span> {    <span class="comment">// if (IsFileLocal( dstFileObject ))</span>
07576 
07577                     <span class="comment">//</span>
07578                     <span class="comment">// The source file is local, but the destination file object</span>
07579                     <span class="comment">// is remote.  For this case query the target file's object</span>
07580                     <span class="comment">// ID and notify the link tracking system that the file has</span>
07581                     <span class="comment">// been moved across systems.</span>
07582                     <span class="comment">//</span>
07583 
07584                     <span class="comment">//</span>
07585                     <span class="comment">// Begin by ensuring that the source file has an object ID</span>
07586                     <span class="comment">// already.  If not, then just make it appear as if the</span>
07587                     <span class="comment">// operation worked.</span>
07588                     <span class="comment">//</span>
07589 
07590                     status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( FileObject,
07591                                                 &amp;SourceObjectId,
07592                                                 <span class="keyword">sizeof</span>( SourceObjectId ),
07593                                                 FSCTL_GET_OBJECT_ID );
07594                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07595                         <span class="keywordflow">return</span> STATUS_SUCCESS;
07596                     }
07597 
07598 
07599                     <span class="comment">//</span>
07600                     <span class="comment">// If the extended info field is zero then this file</span>
07601                     <span class="comment">// has no interesting tracking information.</span>
07602                     <span class="comment">//</span>
07603                     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7/string_8c.html#a17">RtlCompareMemoryUlong</a>(&amp;SourceObjectId.BirthObjectId,
07604                                        <span class="keyword">sizeof</span>(SourceObjectId.BirthObjectId),
07605                                        0) == <span class="keyword">sizeof</span>(SourceObjectId.BirthObjectId)) {
07606                             <span class="keywordflow">return</span> (STATUS_SUCCESS);
07607                     }
07608 
07609                     <span class="comment">//</span>
07610                     <span class="comment">// Query the volume ID of the target.</span>
07611                     <span class="comment">//</span>
07612 
07613                     status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( dstFileObject,
07614                                                 &amp;TargetVolumeId,
07615                                                 <span class="keyword">sizeof</span>( FILE_VOLUMEID_WITH_TYPE ),
07616                                                 FSCTL_LMR_GET_LINK_TRACKING_INFORMATION );
07617                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07618                         <span class="keywordflow">return</span> status;
07619                     }
07620 
07621                     <span class="comment">//</span>
07622                     <span class="comment">// Query the object ID of the target.</span>
07623                     <span class="comment">//</span>
07624 
07625                     status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( dstFileObject,
07626                                                 &amp;TargetObjectId,
07627                                                 <span class="keyword">sizeof</span>( TargetObjectId ),
07628                                                 FSCTL_CREATE_OR_GET_OBJECT_ID );
07629                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07630                         <span class="keywordflow">return</span> status;
07631                     }
07632 
07633                     <span class="comment">//</span>
07634                     <span class="comment">// Notify the tracking system of the move.</span>
07635                     <span class="comment">//</span>
07636 
07637                     <a class="code" href="../../d2/d4/internal_8c.html#a15">IopMarshalIds</a>( &amp;trackingBuffer, &amp;TargetVolumeId, &amp;TargetObjectId, trackingInfo );
07638                     status = <a class="code" href="../../d0/d6/iop_8h.html#a214">IopTrackLink</a>( FileObject,
07639                                            IoStatusBlock,
07640                                            &amp;trackingBuffer.<a class="code" href="../../d1/d2/struct__TRACKING__BUFFER.html#o0">TrackingInformation</a>,
07641                                            FIELD_OFFSET( FILE_TRACKING_INFORMATION,
07642                                                 ObjectInformation ) +
07643                                                     trackingBuffer.<a class="code" href="../../d1/d2/struct__TRACKING__BUFFER.html#o0">TrackingInformation</a>.ObjectInformationLength,
07644                                            Event,
07645                                            KernelMode );
07646                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07647                         <span class="keywordflow">return</span> status;
07648                     }
07649 
07650                     <span class="comment">//</span>
07651                     <span class="comment">// Delete the ID from the source</span>
07652                     <span class="comment">//</span>
07653 
07654                     status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( FileObject,
07655                                                 NULL,
07656                                                 0,
07657                                                 FSCTL_DELETE_OBJECT_ID );
07658                     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07659                         <span class="keywordflow">return</span> status;
07660                     }
07661 
07662                     <span class="comment">//</span>
07663                     <span class="comment">// Set the Birth ID on the target, turning on the bit</span>
07664                     <span class="comment">// that indicates that this file has been involved in a cross-</span>
07665                     <span class="comment">// volume move.</span>
07666                     <span class="comment">//</span>
07667 
07668                     CrossVolumeObjectId = SourceObjectId;
07669                     CrossVolumeObjectId.BirthVolumeId[0] |= 1;
07670 
07671                     status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( dstFileObject,
07672                                                 &amp;CrossVolumeObjectId.ExtendedInfo[0],
07673                                                 <span class="keyword">sizeof</span>( CrossVolumeObjectId.ExtendedInfo ),
07674                                                 FSCTL_SET_OBJECT_ID_EXTENDED );
07675                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07676 
07677                         <span class="comment">// Try to restore the source</span>
07678                         <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( FileObject,
07679                                            &amp;SourceObjectId,
07680                                            <span class="keyword">sizeof</span>(SourceObjectId),
07681                                            FSCTL_SET_OBJECT_ID );
07682                         <span class="keywordflow">return</span> status;
07683                     }
07684 
07685 
07686                 }   <span class="comment">// if (IsFileLocal( dstFileObject ))</span>
07687 
07688             } <span class="keywordflow">else</span> {    <span class="comment">// if (trackingInfo-&gt;DestinationFile)</span>
07689 
07690                 <span class="comment">//</span>
07691                 <span class="comment">// A destination file handle was not specified.  Simply query</span>
07692                 <span class="comment">// the source file's object ID and call the link tracking code.</span>
07693                 <span class="comment">// Note that the function input buffer contains the volume ID</span>
07694                 <span class="comment">// and file object ID of the target.  Note also that it is</span>
07695                 <span class="comment">// assumed that the source file has an object ID.</span>
07696                 <span class="comment">//</span>
07697 
07698                 status = <a class="code" href="../../d0/d6/iop_8h.html#a184">IopGetVolumeId</a>( FileObject,
07699                                          &amp;SourceVolumeId,
07700                                          <span class="keyword">sizeof</span>( SourceVolumeId ) );
07701                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07702                     <span class="keywordflow">return</span> status;
07703                 }
07704 
07705                 status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( FileObject,
07706                                             &amp;SourceObjectId,
07707                                             <span class="keyword">sizeof</span>( SourceObjectId ),
07708                                             FSCTL_GET_OBJECT_ID );
07709                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07710                     <span class="keywordflow">return</span> status;
07711                 }
07712 
07713                 <span class="comment">//</span>
07714                 <span class="comment">// If the extended info field is zero then this file</span>
07715                 <span class="comment">// has no interesting tracking information.</span>
07716                 <span class="comment">//</span>
07717                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7/string_8c.html#a17">RtlCompareMemoryUlong</a>(SourceObjectId.BirthObjectId,
07718                                        <span class="keyword">sizeof</span>(SourceObjectId.BirthObjectId),
07719                                        0) == <span class="keyword">sizeof</span>(SourceObjectId.BirthObjectId)) {
07720                             <span class="keywordflow">return</span> (STATUS_SUCCESS);
07721                 }
07722                 <span class="comment">//</span>
07723                 <span class="comment">// Inform the user-mode link tracking service that the file</span>
07724                 <span class="comment">// has been moved.</span>
07725                 <span class="comment">//</span>
07726 
07727                 NormalizedObjectId = SourceObjectId;
07728                 NormalizedObjectId.BirthVolumeId[0] &amp;= 0xfe;
07729 
07730                 status = <a class="code" href="../../d2/d4/internal_8c.html#a62">IopSendMessageToTrackService</a>( &amp;SourceVolumeId,
07731                                                        &amp;NormalizedObjectId,
07732                                                        FileInformation );
07733                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07734                     <span class="keywordflow">return</span> status;
07735                 }
07736 
07737             }   <span class="comment">// if (trackingInfo-&gt;DestinationFile) ... else</span>
07738 
07739         } <span class="keywordflow">else</span> {    <span class="comment">// if (IsFileLocal( FileObject ))</span>
07740 
07741             <span class="comment">//</span>
07742             <span class="comment">// The source file is remote.  For this case, remote the operation</span>
07743             <span class="comment">// to the system on which the source file is located.  Begin by</span>
07744             <span class="comment">// ensuring that the source file actually has an object ID.  If</span>
07745             <span class="comment">// not, then get out now since there is nothing to be done.</span>
07746             <span class="comment">//</span>
07747 
07748             status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( FileObject,
07749                                         &amp;SourceObjectId,
07750                                         <span class="keyword">sizeof</span>( SourceObjectId ),
07751                                         FSCTL_GET_OBJECT_ID );
07752 
07753             <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND)
07754             {
07755                 <span class="keywordflow">return</span> STATUS_SUCCESS;
07756             }
07757 
07758             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07759                 <span class="keywordflow">return</span> status;
07760             }
07761 
07762             <span class="comment">//</span>
07763             <span class="comment">// If the extended info field is zero then this file</span>
07764             <span class="comment">// has no interesting tracking information.</span>
07765             <span class="comment">//</span>
07766             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7/string_8c.html#a17">RtlCompareMemoryUlong</a>(SourceObjectId.BirthObjectId,
07767                                       <span class="keyword">sizeof</span>(SourceObjectId.BirthObjectId),
07768                                       0) == <span class="keyword">sizeof</span>(SourceObjectId.BirthObjectId)) {
07769                 <span class="keywordflow">return</span> (STATUS_SUCCESS);
07770             }
07771             <span class="keywordflow">if</span> (trackingInfo-&gt;DestinationFile) {
07772 
07773                 <span class="comment">//</span>
07774                 <span class="comment">// A handle was specified for the destination file.  Determine</span>
07775                 <span class="comment">// whether it is local or remote.  If remote and both handles</span>
07776                 <span class="comment">// refer to the same machine, then ship the entire API to that</span>
07777                 <span class="comment">// machine and have it perform the operation.</span>
07778                 <span class="comment">//</span>
07779                 <span class="comment">// Otherwise, query the target file's object ID, and then redo</span>
07780                 <span class="comment">// the operation.  This will cause the API to be remoted to the</span>
07781                 <span class="comment">// machine where the source file resides.</span>
07782                 <span class="comment">//</span>
07783 
07784                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4/internal_8c.html#a0">IsFileLocal</a>( dstFileObject )) {
07785 
07786                     <span class="comment">//</span>
07787                     <span class="comment">// The source is remote and the destination is local, so</span>
07788                     <span class="comment">// query the object ID of the target and recursively track</span>
07789                     <span class="comment">// the link from the source file's remote node.</span>
07790                     <span class="comment">//</span>
07791 
07792                     status = <a class="code" href="../../d0/d6/iop_8h.html#a184">IopGetVolumeId</a>( dstFileObject,
07793                                              &amp;TargetVolumeId,
07794                                              <span class="keyword">sizeof</span>( TargetVolumeId ) );
07795                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07796                         <span class="keywordflow">return</span> status;
07797                     }
07798 
07799                     status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( dstFileObject,
07800                                                 &amp;TargetObjectId,
07801                                                 <span class="keyword">sizeof</span>( TargetObjectId ),
07802                                                 FSCTL_CREATE_OR_GET_OBJECT_ID );
07803                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07804                         <span class="keywordflow">return</span> status;
07805                     }
07806 
07807 
07808                     <span class="comment">//</span>
07809                     <span class="comment">// Notify the tracking system of the move.</span>
07810                     <span class="comment">//</span>
07811 
07812                     <a class="code" href="../../d2/d4/internal_8c.html#a15">IopMarshalIds</a>( &amp;trackingBuffer, &amp;TargetVolumeId, &amp;TargetObjectId, trackingInfo );
07813 
07814                     status = <a class="code" href="../../d0/d6/iop_8h.html#a214">IopTrackLink</a>( FileObject,
07815                                            IoStatusBlock,
07816                                            &amp;trackingBuffer.<a class="code" href="../../d1/d2/struct__TRACKING__BUFFER.html#o0">TrackingInformation</a>,
07817                                            FIELD_OFFSET( FILE_TRACKING_INFORMATION,
07818                                                 ObjectInformation ) +
07819                                                     trackingBuffer.<a class="code" href="../../d1/d2/struct__TRACKING__BUFFER.html#o0">TrackingInformation</a>.ObjectInformationLength,
07820                                            Event,
07821                                            KernelMode );
07822                     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
07823                         <span class="keywordflow">return</span> status;
07824                     }
07825 
07826                     <span class="comment">//</span>
07827                     <span class="comment">//  Delete the ID from the source</span>
07828                     <span class="comment">//</span>
07829 
07830                     status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( FileObject,
07831                                                 NULL,
07832                                                 0,
07833                                                 FSCTL_DELETE_OBJECT_ID );
07834                     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07835                         <span class="keywordflow">return</span> status;
07836                     }
07837 
07838                     <span class="comment">//</span>
07839                     <span class="comment">// Set the birth ID on the target, also turning on the bit</span>
07840                     <span class="comment">// that indicates that this file has moved across volumes.</span>
07841                     <span class="comment">//</span>
07842 
07843                     CrossVolumeObjectId = SourceObjectId;
07844                     CrossVolumeObjectId.BirthVolumeId[0] |= 1;
07845 
07846                     status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( dstFileObject,
07847                                                 &amp;CrossVolumeObjectId.ExtendedInfo[0],
07848                                                 <span class="keyword">sizeof</span>( CrossVolumeObjectId.ExtendedInfo ),
07849                                                 FSCTL_SET_OBJECT_ID_EXTENDED );
07850 
07851                     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07852 
07853                         <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( FileObject,
07854                                            &amp;SourceObjectId,
07855                                            <span class="keyword">sizeof</span>(SourceObjectId),
07856                                            FSCTL_SET_OBJECT_ID );
07857                         <span class="keywordflow">return</span> status;
07858                     }
07859 
07860                 }   <span class="comment">// if (IsFileLocal( dstFileObject ))</span>
07861 
07862                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a190">IopIsSameMachine</a>( FileObject, trackingInfo-&gt;DestinationFile)) {
07863 
07864                     <span class="comment">//</span>
07865                     <span class="comment">// The source and the target are remote from each other and from</span>
07866                     <span class="comment">// this machine.  Query the object ID of the target and recursively</span>
07867                     <span class="comment">// track the link from the source file's remote node.</span>
07868                     <span class="comment">//</span>
07869 
07870                     <span class="comment">//</span>
07871                     <span class="comment">// Query the volume ID of the target.</span>
07872                     <span class="comment">//</span>
07873 
07874                     status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( dstFileObject,
07875                                                 &amp;TargetVolumeId,
07876                                                 <span class="keyword">sizeof</span>( FILE_VOLUMEID_WITH_TYPE ),
07877                                                 FSCTL_LMR_GET_LINK_TRACKING_INFORMATION );
07878 
07879                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07880                         <span class="keywordflow">return</span> status;
07881                     }
07882 
07883                     <span class="comment">//</span>
07884                     <span class="comment">// Query the object ID of the target.</span>
07885                     <span class="comment">//</span>
07886 
07887                     status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( dstFileObject,
07888                                                 &amp;TargetObjectId,
07889                                                 <span class="keyword">sizeof</span>( TargetObjectId ),
07890                                                 FSCTL_CREATE_OR_GET_OBJECT_ID );
07891                     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07892                         <span class="keywordflow">return</span> status;
07893                     }
07894 
07895                     <span class="comment">//</span>
07896                     <span class="comment">// Notify the tracking system of the move.</span>
07897                     <span class="comment">//</span>
07898 
07899                     <a class="code" href="../../d2/d4/internal_8c.html#a15">IopMarshalIds</a>( &amp;trackingBuffer, &amp;TargetVolumeId, &amp;TargetObjectId, trackingInfo );
07900 
07901                     status = <a class="code" href="../../d0/d6/iop_8h.html#a214">IopTrackLink</a>( FileObject,
07902                                            IoStatusBlock,
07903                                            &amp;trackingBuffer.<a class="code" href="../../d1/d2/struct__TRACKING__BUFFER.html#o0">TrackingInformation</a>,
07904                                            FIELD_OFFSET( FILE_TRACKING_INFORMATION,
07905                                                 ObjectInformation ) +
07906                                                     trackingBuffer.<a class="code" href="../../d1/d2/struct__TRACKING__BUFFER.html#o0">TrackingInformation</a>.ObjectInformationLength,
07907                                            Event,
07908                                            KernelMode );
07909                     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07910                         <span class="keywordflow">return</span> status;
07911                     }
07912 
07913                     <span class="comment">//</span>
07914                     <span class="comment">// Set the birth ID on the target, turning on the bit that indicates</span>
07915                     <span class="comment">// that this file has moved across volumes.</span>
07916                     <span class="comment">//</span>
07917 
07918                     CrossVolumeObjectId = SourceObjectId;
07919                     CrossVolumeObjectId.BirthVolumeId[0] |= 1;
07920 
07921                     status = <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( dstFileObject,
07922                                                 &amp;CrossVolumeObjectId.ExtendedInfo[0],
07923                                                 <span class="keyword">sizeof</span>( CrossVolumeObjectId.ExtendedInfo ),
07924                                                 FSCTL_SET_OBJECT_ID_EXTENDED );
07925 
07926                     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07927                         <a class="code" href="../../d0/d6/iop_8h.html#a182">IopGetSetObjectId</a>( FileObject,
07928                                            &amp;SourceObjectId,
07929                                            <span class="keyword">sizeof</span>(SourceObjectId),
07930                                            FSCTL_SET_OBJECT_ID );
07931                         <span class="keywordflow">return</span> status;
07932                     }
07933 
07934                 } <span class="keywordflow">else</span> {    <span class="comment">// else if (!IopIsSameMachine( FileObject, trackingInfo-&gt;DestinationFile))</span>
07935 
07936                     <span class="comment">//</span>
07937                     <span class="comment">// Both the source and the target are remote and they're</span>
07938                     <span class="comment">// both on the same remote machine.  For this case, remote</span>
07939                     <span class="comment">// the entire API using the file object pointers.</span>
07940                     <span class="comment">//</span>
07941 
07942                     status = <a class="code" href="../../d0/d6/iop_8h.html#a209">IopSetRemoteLink</a>( FileObject, dstFileObject, trackingInfo );
07943 
07944                 }   <span class="comment">// else if (!IopIsSameMachine( FileObject, trackingInfo-&gt;DestinationFile)) ... else</span>
07945 
07946             } <span class="keywordflow">else</span> {    <span class="comment">// if (trackingInfo-&gt;DestinationFile)</span>
07947 
07948                 <span class="comment">//</span>
07949                 <span class="comment">// The source file is remote and the object ID of the target is</span>
07950                 <span class="comment">// contained w/in the tracking buffer.  Simply remote the API</span>
07951                 <span class="comment">// to the remote machine using the source file object pointer</span>
07952                 <span class="comment">// and the object ID of the target in the buffer.</span>
07953                 <span class="comment">//</span>
07954 
07955                 status = <a class="code" href="../../d0/d6/iop_8h.html#a209">IopSetRemoteLink</a>( FileObject, NULL, FileInformation );
07956 
07957             }   <span class="comment">// if (trackingInfo-&gt;DestinationFile) ... else</span>
07958         }   <span class="comment">// if (IsFileLocal( FileObject )) ... else</span>
07959 
07960     } finally {
07961 
07962         <span class="comment">//</span>
07963         <span class="comment">// Ensure that everything has been cleaned up.</span>
07964         <span class="comment">//</span>
07965 
07966         <span class="keywordflow">if</span> (RequestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> &amp;&amp; trackingInfo) {
07967             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( trackingInfo );
07968         }
07969 
07970         <span class="keywordflow">if</span> (dstFileObject ) {
07971             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( dstFileObject );
07972         }
07973 
07974         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( Event, 0, FALSE );
07975     }
07976 
07977     <span class="keywordflow">return</span> status;
07978 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="internal.c::IopUnMarshalIds" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopUnMarshalIds           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN FILE_TRACKING_INFORMATION *&nbsp;</td>
          <td class="mdname" nowrap> <em>TrackingInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d2/d4/internal_8c.html#a5">FILE_VOLUMEID_WITH_TYPE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetVolumeId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT GUID *&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetObjectId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT GUID *&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetMachineId</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l06072">6072</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d6/d3/acpitabl_8h-source.html#l00366">min</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l06127">IopSendMessageToTrackService()</a>.
<p>
<pre class="fragment"><div>06081                    :
06082 
06083     This routine unmarshals <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TargetVolumeId and TargetObjectId
06084     from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> supplied TrackingInformation from a standard remotable <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>.
06085 
06086 Arguments:
06087 
06088     TrackingInformation - The buffer containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> marshalled parameters.
06089 
06090     TargetVolumeId - <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume <span class="keywordtype">id</span>.
06091 
06092     TargetObjectId - <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <span class="keywordtype">id</span>.
06093 
06094     TargetMachineId - <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> to receieve <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> machine <span class="keywordtype">id</span>.
06095 
06096 --*/
06097 
06098 {
06099     ULONG ObjectInformationLength = 0;
06100 
06101     RtlCopyMemory( &amp;TargetVolumeId-&gt;Type,
06102                    &amp;TrackingInformation-&gt;ObjectInformation[ ObjectInformationLength ],
06103                    <span class="keyword">sizeof</span>(TargetVolumeId-&gt;Type) );
06104     ObjectInformationLength += <span class="keyword">sizeof</span>(TargetVolumeId-&gt;Type);
06105 
06106 
06107     RtlCopyMemory( &amp;TargetVolumeId-&gt;VolumeId[0],
06108                    &amp;TrackingInformation-&gt;ObjectInformation[ ObjectInformationLength ],
06109                    <span class="keyword">sizeof</span>(TargetVolumeId-&gt;VolumeId) );
06110     ObjectInformationLength += <span class="keyword">sizeof</span>(TargetVolumeId-&gt;VolumeId);
06111 
06112     RtlCopyMemory( TargetObjectId,
06113                    &amp;TrackingInformation-&gt;ObjectInformation[ ObjectInformationLength ],
06114                    <span class="keyword">sizeof</span>(*TargetObjectId) );
06115     ObjectInformationLength += <span class="keyword">sizeof</span>(*TargetObjectId);
06116 
06117     <span class="keywordflow">if</span>( TrackingInformation-&gt;ObjectInformationLength &gt; ObjectInformationLength ) {
06118         RtlCopyMemory( TargetMachineId,
06119                        &amp;TrackingInformation-&gt;ObjectInformation[ ObjectInformationLength ],
06120                        <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>( <span class="keyword">sizeof</span>(*TargetMachineId), TrackingInformation-&gt;ObjectInformationLength - ObjectInformationLength) );
06121         <span class="comment">// ObjectInformationLength += sizeof(GUID);</span>
06122     }
06123 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a70" doxytag="internal.c::IopUserCompletion" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopUserCompletion           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Apc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l07981">7981</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06632">IoFreeIrp()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l01019">IopCompleteRequest()</a>.
<p>
<pre class="fragment"><div>07991                    :
07992 
07993     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> processing of an <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>.  Everything has
07994     been completed except that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's APC routine must be invoked.  The
07995     system will <span class="keywordflow">do</span> <span class="keyword">this</span> as soon as <span class="keyword">this</span> routine exits.  The <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> processing
07996     remaining to be completed by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O system <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a>
07997     Packet itself.
07998 
07999 Arguments:
08000 
08001     Apc - Supplies a pointer to kernel APC structure.
08002 
08003     NormalRoutine - Supplies a pointer to a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> normal function
08004         that was specified when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC was initialied.
08005 
08006     NormalContext - Supplies a pointer to a pointer to an arbitrary data
08007         structure that was specified when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC was initialized.
08008 
08009     SystemArgument1, SystemArgument2 - Supplies a set of two pointers to
08010         two arguments that contain untyped data.
08011 
08012 Return Value:
08013 
08014     None.
08015 
08016 Note:
08017 
08018     If no other processing <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ever needed, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC can be placed at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
08019     beginning of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>, then <span class="keyword">this</span> routine could be replaced by simply
08020     specifying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> deallocation routine in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC instead
08021     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <span class="keyword">this</span> routine.
08022 
08023 Caution:
08024 
08025     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> also invoked as a general purpose rundown routine <span class="keywordflow">for</span> APCs.
08026     Should <span class="keyword">this</span> code ever need to directly access any of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> other parameters
08027     other than Apc, <span class="keyword">this</span> routine will need to be split into two separate
08028     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a>.  The rundown routine should perform exactly <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following code's
08029     functionality.
08030 
08031 --*/
08032 
08033 {
08034     UNREFERENCED_PARAMETER( NormalRoutine );
08035     UNREFERENCED_PARAMETER( NormalContext );
08036     UNREFERENCED_PARAMETER( SystemArgument1 );
08037     UNREFERENCED_PARAMETER( SystemArgument2 );
08038 
08039     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
08040 
08041     <span class="comment">//</span>
08042     <span class="comment">// Free the packet.</span>
08043     <span class="comment">//</span>
08044 
08045     <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a>( CONTAINING_RECORD( Apc, IRP, Tail.Apc ) );
08046 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="internal.c::IopUserRundown" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopUserRundown           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Apc</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l08051">8051</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06632">IoFreeIrp()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l01019">IopCompleteRequest()</a>.
<p>
<pre class="fragment"><div>08057                    :
08058 
08059     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked during thread termination as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> rundown routine
08060     <span class="keywordflow">for</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> simply calls <a class="code" href="../../d2/d4/internal_8c.html#a70">IopUserCompletion</a>.
08061 
08062 Arguments:
08063 
08064     Apc - Supplies a pointer to kernel APC structure.
08065 
08066 Return Value:
08067 
08068     None.
08069 
08070 
08071 --*/
08072 
08073 {
08074     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
08075 
08076     <span class="comment">//</span>
08077     <span class="comment">// Free the packet.</span>
08078     <span class="comment">//</span>
08079 
08080     <a class="code" href="../../d4/d6/iosubs_8c.html#a63">IoFreeIrp</a>( CONTAINING_RECORD( Apc, <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>, Tail.Apc ) );
08081 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a71" doxytag="internal.c::IopXxxControlFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopXxxControlFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE Event&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PIO_APC_ROUTINE ApcRoutine&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID ApcContext&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatusBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>IoControlCode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID InputBuffer&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>InputBufferLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID OutputBuffer&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>OutputBufferLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceIoControl</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l08084">8084</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
References <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01661">_IRP::Cancel</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01701">_IRP::CancelRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01179">_DEVICE_OBJECT::DriverObject</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00127">ExAllocatePoolWithQuota</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00030">ExEventObjectType</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00952">_FAST_IO_DISPATCH::FastIoDeviceControl</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01403">_DRIVER_OBJECT::FastIoDispatch</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01492">FO_ALERTABLE_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01501">FO_DIRECT_DEVICE_OPEN</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01491">FO_SYNCHRONOUS_IO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00057">_OBJECT_HANDLE_INFORMATION::GrantedAccess</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00805">IoAllocateMdl()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00044">IoFileObjectType</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06786">IoGetAttachedDevice()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00595">IopAcquireFastLock</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00181">IopAcquireFileObjectLock()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00604">IopAllocateIrp</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00284">IopAllocateIrpCleanup()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00768">IopApcRoutinePresent</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l01934">IopExceptionCleanup()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l01157">IopReleaseFileObjectLock</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l07030">IopSynchronousServiceTail()</a>, <a class="el" href="../../d2/d1/mm_8h.html#a344a168">IoReadAccess</a>, <a class="el" href="../../d6/d3/complete_8c-source.html#l00671">IoSetIoCompletion()</a>, <a class="el" href="../../d2/d1/mm_8h.html#a344a169">IoWriteAccess</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01554">IRP_BUFFERED_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01555">IRP_DEALLOCATE_BUFFER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01564">IRP_DEFER_IO_COMPLETION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01556">IRP_INPUT_OPERATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00069">IRP_MJ_DEVICE_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00068">IRP_MJ_FILE_SYSTEM_CONTROL</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d2/d1/mm_8h.html#a141">LOCK_OPERATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01596">_IRP::MdlAddress</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00238">MmProbeAndLockPages()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a177">NonPagedPoolCacheAligned</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a240a140">OtherTransfer</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o24">_IRP::Overlay</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00547">PDRIVER_CANCEL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01648">_IRP::PendingReturned</a>, <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01518">ProbeForWriteIoStatusEx</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01641">_IRP::RequestorMode</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00515">SeComputeGrantedAccesses</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01189">_DEVICE_OBJECT::StackSize</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01711">_IRP::UserBuffer</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>.
<p>
Referenced by <a class="el" href="../../d2/d6/io_2devctrl_8c-source.html#l00034">NtDeviceIoControlFile()</a>, and <a class="el" href="../../d9/d6/io_2fsctrl_8c-source.html#l00034">NtFsControlFile()</a>.
<p>
<pre class="fragment"><div>08100                    :
08101 
08102     This service builds descriptors or MDLs <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> supplied buffer(s) and
08103     passes the untyped data to the driver associated with the file handle.
08104     handle.  It is up to the driver to check the input data and function
08105     IoControlCode for validity, as well as to make the appropriate access
08106     checks.
08107 
08108 Arguments:
08109 
08110     FileHandle - Supplies a handle to the file on which the service is being
08111         performed.
08112 
08113     Event - Supplies an optional event to be set to the Signaled state when
08114         the service is complete.
08115 
08116     ApcRoutine - Supplies an optional APC routine to be executed when the
08117         service is complete.
08118 
08119     ApcContext - Supplies a context parameter to be passed to the ApcRoutine,
08120         if an ApcRoutine was specified.
08121 
08122     IoStatusBlock - Address of the caller's I/O status block.
08123 
08124     IoControlCode - Subfunction code to determine exactly what operation is
08125         being performed.
08126 
08127     InputBuffer - Optionally supplies an input buffer to be passed to the
08128         driver.  Whether or not the buffer is actually optional is dependent
08129         on the IoControlCode.
08130 
08131     InputBufferLength - Length of the InputBuffer in bytes.
08132 
08133     OutputBuffer - Optionally supplies an output buffer to receive information
08134         from the driver.  Whether or not the buffer is actually optional is
08135         dependent on the IoControlCode.
08136 
08137     OutputBufferLength - Length of the OutputBuffer in bytes.
08138 
08139     DeviceIoControl - Determines whether this is a Device or File System
08140         Control function.
08141 
08142 Return Value:
08143 
08144     The status returned is success if the control operation was properly
08145     queued to the I/O system.   Once the operation completes, the status
08146     can be determined by examining the Status field of the I/O status block.
08147 
08148 --*/
08149 
08150 {
08151     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
08152     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
08153     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> fileObject;
08154     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
08155     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> eventObject = (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08156     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
08157     ULONG method;
08158     <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a> handleInformation;
08159     BOOLEAN synchronousIo;
08160     IO_STATUS_BLOCK localIoStatus;
08161     <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> fastIoDispatch;
08162     <a class="code" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> poolType;
08163     PULONG majorFunction;
08164     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> requestorMode;
08165 
08166     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
08167 
08168     <span class="comment">//</span>
08169     <span class="comment">// Get the method that the buffers are being passed by.</span>
08170     <span class="comment">//</span>
08171 
08172     method = IoControlCode &amp; 3;
08173 
08174     <span class="comment">//</span>
08175     <span class="comment">// Check the caller's parameters based on the mode of the caller.</span>
08176     <span class="comment">//</span>
08177 
08178     requestorMode = KeGetPreviousMode();
08179 
08180     <span class="keywordflow">if</span> (requestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
08181 
08182         <span class="comment">//</span>
08183         <span class="comment">// The caller's access mode is not kernel so probe each of the arguments</span>
08184         <span class="comment">// and capture them as necessary.  If any failures occur, the condition</span>
08185         <span class="comment">// handler will be invoked to handle them.  It will simply cleanup and</span>
08186         <span class="comment">// return an access violation status code back to the system service</span>
08187         <span class="comment">// dispatcher.</span>
08188         <span class="comment">//</span>
08189 
08190         <span class="keywordflow">try</span> {
08191 
08192             <span class="comment">//</span>
08193             <span class="comment">// The IoStatusBlock parameter must be writeable by the caller.</span>
08194             <span class="comment">//</span>
08195 
08196             <a class="code" href="../../d5/d8/ex_8h.html#a32">ProbeForWriteIoStatusEx</a>( IoStatusBlock , ApcRoutine);
08197 
08198             <span class="comment">//</span>
08199             <span class="comment">// The output buffer can be used in any one of the following three ways,</span>
08200             <span class="comment">// if it is specified:</span>
08201             <span class="comment">//</span>
08202             <span class="comment">//     0) It can be a normal, buffered output buffer.</span>
08203             <span class="comment">//</span>
08204             <span class="comment">//     1) It can be a DMA input buffer.</span>
08205             <span class="comment">//</span>
08206             <span class="comment">//     2) It can be a DMA output buffer.</span>
08207             <span class="comment">//</span>
08208             <span class="comment">// Which way the buffer is to be used it based on the low-order two bits</span>
08209             <span class="comment">// of the IoControlCode.</span>
08210             <span class="comment">//</span>
08211             <span class="comment">// If the method is 0 we probe the output buffer for write access.</span>
08212             <span class="comment">// If the method is not 3 we probe the input buffer for read access.</span>
08213             <span class="comment">//</span>
08214 
08215             <span class="keywordflow">if</span> (method == 0) {
08216                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT( OutputBuffer )) {
08217                     <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( OutputBuffer,
08218                                    OutputBufferLength,
08219                                    <span class="keyword">sizeof</span>( UCHAR ) );
08220                 } <span class="keywordflow">else</span> {
08221                     OutputBufferLength = 0;
08222                 }
08223             }
08224 
08225             <span class="keywordflow">if</span> (method != 3) {
08226                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT( InputBuffer )) {
08227                     <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( InputBuffer,
08228                                   InputBufferLength,
08229                                   <span class="keyword">sizeof</span>( UCHAR ) );
08230                 } <span class="keywordflow">else</span> {
08231                     InputBufferLength = 0;
08232                 }
08233             }
08234 
08235         } except(EXCEPTION_EXECUTE_HANDLER) {
08236 
08237             <span class="comment">//</span>
08238             <span class="comment">// An exception was incurred while attempting to probe or write</span>
08239             <span class="comment">// one of the caller's parameters.  Simply return an appropriate</span>
08240             <span class="comment">// error status code.</span>
08241             <span class="comment">//</span>
08242 
08243             <span class="keywordflow">return</span> GetExceptionCode();
08244 
08245         }
08246     }
08247 
08248     <span class="comment">//</span>
08249     <span class="comment">// There were no blatant errors so far, so reference the file object so</span>
08250     <span class="comment">// the target device object can be found.  Note that if the handle does</span>
08251     <span class="comment">// not refer to a file object, or if the caller does not have the required</span>
08252     <span class="comment">// access to the file, then it will fail.</span>
08253     <span class="comment">//</span>
08254 
08255     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( FileHandle,
08256                                         0L,
08257                                         IoFileObjectType,
08258                                         requestorMode,
08259                                         (PVOID *) &amp;fileObject,
08260                                         &amp;handleInformation );
08261     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
08262         <span class="keywordflow">return</span> status;
08263     }
08264 
08265     <span class="comment">//</span>
08266     <span class="comment">// If this file has an I/O completion port associated w/it, then ensure</span>
08267     <span class="comment">// that the caller did not supply an APC routine, as the two are mutually</span>
08268     <span class="comment">// exclusive methods for I/O completion notification.</span>
08269     <span class="comment">//</span>
08270 
08271     <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o26">CompletionContext</a> &amp;&amp; <a class="code" href="../../d0/d6/iop_8h.html#a19">IopApcRoutinePresent</a>( ApcRoutine )) {
08272         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
08273         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
08274     }
08275 
08276     <span class="comment">//</span>
08277     <span class="comment">// Now check the access type for this control code to ensure that the</span>
08278     <span class="comment">// caller has the appropriate access to this file object to perform the</span>
08279     <span class="comment">// operation.</span>
08280     <span class="comment">//</span>
08281 
08282     <span class="keywordflow">if</span> (requestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
08283 
08284         ULONG accessMode = (IoControlCode &gt;&gt; 14) &amp; 3;
08285 
08286         <span class="keywordflow">if</span> (accessMode != FILE_ANY_ACCESS) {
08287 
08288             <span class="comment">//</span>
08289             <span class="comment">// This I/O control requires that the caller have read, write,</span>
08290             <span class="comment">// or read/write access to the object.  If this is not the case,</span>
08291             <span class="comment">// then cleanup and return an appropriate error status code.</span>
08292             <span class="comment">//</span>
08293 
08294             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/se_8h.html#a9">SeComputeGrantedAccesses</a>( handleInformation.<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o1">GrantedAccess</a>, accessMode ) != accessMode ) {
08295                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
08296                 <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
08297             }
08298         }
08299     }
08300 
08301     <span class="comment">//</span>
08302     <span class="comment">// Get the address of the event object and set the event to the Not-</span>
08303     <span class="comment">// Signaled state, if an event was specified.  Note here, too, that if</span>
08304     <span class="comment">// the handle does not refer to an event, or if the event cannot be</span>
08305     <span class="comment">// written, then the reference will fail.</span>
08306     <span class="comment">//</span>
08307 
08308     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Event )) {
08309         status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( Event,
08310                                             EVENT_MODIFY_STATE,
08311                                             ExEventObjectType,
08312                                             requestorMode,
08313                                             (PVOID *) &amp;eventObject,
08314                                             NULL );
08315         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
08316             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
08317             <span class="keywordflow">return</span> status;
08318         } <span class="keywordflow">else</span> {
08319             <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>( eventObject );
08320         }
08321     }
08322 
08323     <span class="comment">//</span>
08324     <span class="comment">// Make a special check here to determine whether this is a synchronous</span>
08325     <span class="comment">// I/O operation.  If it is, then wait here until the file is owned by</span>
08326     <span class="comment">// the current thread.</span>
08327     <span class="comment">//</span>
08328 
08329     <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>) {
08330         BOOLEAN interrupted;
08331 
08332         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a13">IopAcquireFastLock</a>( fileObject )) {
08333             status = <a class="code" href="../../d0/d6/iop_8h.html#a147">IopAcquireFileObjectLock</a>( fileObject,
08334                                                requestorMode,
08335                                                (BOOLEAN) ((fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; FO_ALERTABLE_IO) != 0),
08336                                                &amp;interrupted );
08337             <span class="keywordflow">if</span> (interrupted) {
08338                 <span class="keywordflow">if</span> (eventObject) {
08339                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( eventObject );
08340                 }
08341                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
08342                 <span class="keywordflow">return</span> status;
08343             }
08344         }
08345         synchronousIo = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
08346     } <span class="keywordflow">else</span> {
08347         synchronousIo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08348     }
08349 
08350     <span class="comment">//</span>
08351     <span class="comment">// Get the address of the target device object.  If this file represents</span>
08352     <span class="comment">// a device that was opened directly, then simply use the device or its</span>
08353     <span class="comment">// attached device(s) directly.</span>
08354     <span class="comment">//</span>
08355 
08356     <span class="keywordflow">if</span> (!(fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a161">FO_DIRECT_DEVICE_OPEN</a>)) {
08357         deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( fileObject );
08358     } <span class="keywordflow">else</span> {
08359         deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a66">IoGetAttachedDevice</a>( fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o2">DeviceObject</a> );
08360     }
08361 
08362     <span class="keywordflow">if</span> (DeviceIoControl) {
08363 
08364         <span class="comment">//</span>
08365         <span class="comment">// Also get the address of the Fast I/O dispatch structure.</span>
08366         <span class="comment">//</span>
08367 
08368         fastIoDispatch = deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>;
08369 
08370         <span class="comment">//</span>
08371         <span class="comment">// Turbo device control support.  If the device has a fast I/O entry</span>
08372         <span class="comment">// point for DeviceIoControlFile, call the entry point and give it a</span>
08373         <span class="comment">// chance to try to complete the request.  Note if FastIoDeviceControl</span>
08374         <span class="comment">// returns FALSE or we get an I/O error, we simply fall through and</span>
08375         <span class="comment">// go the "long way" and create an Irp.</span>
08376         <span class="comment">//</span>
08377 
08378         <span class="keywordflow">if</span> (fastIoDispatch &amp;&amp; fastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o10">FastIoDeviceControl</a>) {
08379 
08380             <span class="comment">//</span>
08381             <span class="comment">// Before we actually call the fast I/O routine in the driver,</span>
08382             <span class="comment">// we must probe OutputBuffer if the method is 1 or 2.</span>
08383             <span class="comment">//</span>
08384 
08385             <span class="keywordflow">if</span> (requestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> &amp;&amp; ARGUMENT_PRESENT(OutputBuffer)) {
08386 
08387                 <span class="keywordflow">try</span> {
08388 
08389                     <span class="keywordflow">if</span> (method == 1) {
08390                         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( OutputBuffer,
08391                                       OutputBufferLength,
08392                                       <span class="keyword">sizeof</span>( UCHAR ) );
08393                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (method == 2) {
08394                         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( OutputBuffer,
08395                                        OutputBufferLength,
08396                                        <span class="keyword">sizeof</span>( UCHAR ) );
08397                     }
08398 
08399                 } except(EXCEPTION_EXECUTE_HANDLER) {
08400 
08401                     <span class="comment">//</span>
08402                     <span class="comment">// An exception was incurred while attempting to probe</span>
08403                     <span class="comment">// the output buffer.  Clean up and return an</span>
08404                     <span class="comment">// appropriate error status code.</span>
08405                     <span class="comment">//</span>
08406 
08407                     <span class="keywordflow">if</span> (synchronousIo) {
08408                         <a class="code" href="../../d0/d6/iop_8h.html#a22">IopReleaseFileObjectLock</a>( fileObject );
08409                     }
08410 
08411                     <span class="keywordflow">if</span> (eventObject) {
08412                         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( eventObject );
08413                     }
08414 
08415                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
08416 
08417                     <span class="keywordflow">return</span> GetExceptionCode();
08418                 }
08419             }
08420 
08421             <span class="comment">//</span>
08422             <span class="comment">// Call the driver's fast I/O routine.</span>
08423             <span class="comment">//</span>
08424 
08425             <span class="keywordflow">if</span> (fastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o10">FastIoDeviceControl</a>( fileObject,
08426                                                      TRUE,
08427                                                      InputBuffer,
08428                                                      InputBufferLength,
08429                                                      OutputBuffer,
08430                                                      OutputBufferLength,
08431                                                      IoControlCode,
08432                                                      &amp;localIoStatus,
08433                                                      deviceObject )) {
08434 
08435                 <span class="comment">//</span>
08436                 <span class="comment">// The driver successfully performed the I/O in it's</span>
08437                 <span class="comment">// fast device control routine.  Carefully return the</span>
08438                 <span class="comment">// I/O status.</span>
08439                 <span class="comment">//</span>
08440 
08441                 <span class="keywordflow">try</span> {
08442                     *IoStatusBlock = localIoStatus;
08443                 } except( EXCEPTION_EXECUTE_HANDLER ) {
08444                     localIoStatus.Status = GetExceptionCode();
08445                     localIoStatus.Information = 0;
08446                 }
08447 
08448                 <span class="comment">//</span>
08449                 <span class="comment">// If an event was specified, set it.</span>
08450                 <span class="comment">//</span>
08451 
08452                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Event )) {
08453                     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( eventObject, 0, FALSE );
08454                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( eventObject );
08455                 }
08456 
08457                 <span class="comment">//</span>
08458                 <span class="comment">// Note that the file object event need not be set to the</span>
08459                 <span class="comment">// Signaled state, as it is already set.  Release the</span>
08460                 <span class="comment">// file object lock, if necessary.</span>
08461                 <span class="comment">//</span>
08462 
08463                 <span class="keywordflow">if</span> (synchronousIo) {
08464                     <a class="code" href="../../d0/d6/iop_8h.html#a22">IopReleaseFileObjectLock</a>( fileObject );
08465                 }
08466 
08467                 <span class="comment">//</span>
08468                 <span class="comment">// If this file object has a completion port associated with it</span>
08469                 <span class="comment">// and this request has a non-NULL APC context then a completion</span>
08470                 <span class="comment">// message needs to be queued.</span>
08471                 <span class="comment">//</span>
08472 
08473                 <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o26">CompletionContext</a> &amp;&amp; ARGUMENT_PRESENT( ApcContext )) {
08474                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d5/d4/complete_8c.html#a6">IoSetIoCompletion</a>( fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o26">CompletionContext</a>-&gt;<a class="code" href="../../d2/d4/struct__IO__COMPLETION__CONTEXT.html#o0">Port</a>,
08475                                                        fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o26">CompletionContext</a>-&gt;<a class="code" href="../../d2/d4/struct__IO__COMPLETION__CONTEXT.html#o1">Key</a>,
08476                                                        ApcContext,
08477                                                        localIoStatus.Status,
08478                                                        localIoStatus.Information,
08479                                                        TRUE ))) {
08480                         localIoStatus.Status = STATUS_INSUFFICIENT_RESOURCES;
08481                     }
08482                 }
08483 
08484                 <span class="comment">//</span>
08485                 <span class="comment">// Cleanup and return.</span>
08486                 <span class="comment">//</span>
08487 
08488                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
08489                 <span class="keywordflow">return</span> localIoStatus.Status;
08490             }
08491         }
08492 
08493     }
08494 
08495     <span class="comment">//</span>
08496     <span class="comment">// Set the file object to the Not-Signaled state.</span>
08497     <span class="comment">//</span>
08498 
08499     <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>( &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o25">Event</a> );
08500 
08501     <span class="comment">//</span>
08502     <span class="comment">// Allocate and initialize the I/O Request Packet (IRP) for this operation.</span>
08503 
08504     irp = <a class="code" href="../../d0/d6/iop_8h.html#a16">IopAllocateIrp</a>( deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a>, TRUE );
08505 
08506     <span class="keywordflow">if</span> (!irp) {
08507 
08508         <span class="comment">//</span>
08509         <span class="comment">// An IRP could not be allocated.  Cleanup and return an appropriate</span>
08510         <span class="comment">// error status code.</span>
08511         <span class="comment">//</span>
08512 
08513         <a class="code" href="../../d0/d6/iop_8h.html#a148">IopAllocateIrpCleanup</a>( fileObject, eventObject );
08514 
08515         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
08516     }
08517     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = fileObject;
08518     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
08519     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.AuxiliaryBuffer = (PVOID) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08520     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a> = requestorMode;
08521     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o11">PendingReturned</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08522     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
08523     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o25">CancelRoutine</a> = (<a class="code" href="../../d0/d5/io_8h.html#a286">PDRIVER_CANCEL</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08524 
08525     <span class="comment">//</span>
08526     <span class="comment">// Fill in the service independent parameters in the IRP.</span>
08527     <span class="comment">//</span>
08528 
08529     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = eventObject;
08530     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = IoStatusBlock;
08531     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine = ApcRoutine;
08532     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcContext = ApcContext;
08533 
08534     <span class="comment">//</span>
08535     <span class="comment">// Get a pointer to the stack location for the first driver.  This will be</span>
08536     <span class="comment">// used to pass the original function codes and parameters.  Note that</span>
08537     <span class="comment">// setting the major function here also sets:</span>
08538     <span class="comment">//</span>
08539     <span class="comment">//      MinorFunction = 0;</span>
08540     <span class="comment">//      Flags = 0;</span>
08541     <span class="comment">//      Control = 0;</span>
08542     <span class="comment">//</span>
08543 
08544     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
08545     majorFunction = (PULONG) (&amp;irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a>);
08546     *majorFunction = DeviceIoControl ? <a class="code" href="../../d0/d5/io_8h.html#a27">IRP_MJ_DEVICE_CONTROL</a> : <a class="code" href="../../d0/d5/io_8h.html#a26">IRP_MJ_FILE_SYSTEM_CONTROL</a>;
08547     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = fileObject;
08548 
08549     <span class="comment">//</span>
08550     <span class="comment">// Copy the caller's parameters to the service-specific portion of the</span>
08551     <span class="comment">// IRP for those parameters that are the same for all three methods.</span>
08552     <span class="comment">//</span>
08553 
08554     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.DeviceIoControl.OutputBufferLength = OutputBufferLength;
08555     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.DeviceIoControl.InputBufferLength = InputBufferLength;
08556     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.DeviceIoControl.IoControlCode = IoControlCode;
08557 
08558     <span class="comment">//</span>
08559     <span class="comment">// Set the pool type based on the type of function being performed.</span>
08560     <span class="comment">//</span>
08561 
08562     poolType = DeviceIoControl ? <a class="code" href="../../d5/d8/ex_8h.html#a329a177">NonPagedPoolCacheAligned</a> : <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>;
08563 
08564     <span class="comment">//</span>
08565     <span class="comment">// Based on the method that the buffer are being passed, either allocate</span>
08566     <span class="comment">// buffers or build MDLs.  Note that in some cases no probing has taken</span>
08567     <span class="comment">// place so the exception handler must catch access violations.</span>
08568     <span class="comment">//</span>
08569 
08570     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08571     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer = (PVOID) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08572 
08573     <span class="keywordflow">switch</span> ( method ) {
08574 
08575     <span class="keywordflow">case</span> 0:
08576 
08577         <span class="comment">//</span>
08578         <span class="comment">// For this case, allocate a buffer that is large enough to contain</span>
08579         <span class="comment">// both the input and the output buffers.  Copy the input buffer to</span>
08580         <span class="comment">// the allocated buffer and set the appropriate IRP fields.</span>
08581         <span class="comment">//</span>
08582 
08583         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.DeviceIoControl.Type3InputBuffer = (PVOID) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08584 
08585         <span class="keywordflow">try</span> {
08586 
08587             <span class="keywordflow">if</span> (InputBufferLength || OutputBufferLength) {
08588                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer =
08589                     <a class="code" href="../../d5/d5/cc_8h.html#a11">ExAllocatePoolWithQuota</a>( poolType,
08590                                              (InputBufferLength &gt; OutputBufferLength) ? InputBufferLength : OutputBufferLength );
08591 
08592                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT( InputBuffer )) {
08593                     RtlCopyMemory( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer,
08594                                    InputBuffer,
08595                                    InputBufferLength );
08596                 }
08597                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a178">IRP_BUFFERED_IO</a> | <a class="code" href="../../d0/d5/io_8h.html#a179">IRP_DEALLOCATE_BUFFER</a>;
08598                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o26">UserBuffer</a> = OutputBuffer;
08599                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT( OutputBuffer )) {
08600                     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a180">IRP_INPUT_OPERATION</a>;
08601                 }
08602             } <span class="keywordflow">else</span> {
08603                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = 0;
08604                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o26">UserBuffer</a> = (PVOID) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08605             }
08606 
08607         } except(EXCEPTION_EXECUTE_HANDLER) {
08608 
08609             <span class="comment">//</span>
08610             <span class="comment">// An exception was incurred while either allocating the</span>
08611             <span class="comment">// the system buffer or moving the caller's data.  Determine</span>
08612             <span class="comment">// what actually happened, cleanup accordingly, and return</span>
08613             <span class="comment">// an appropriate error status code.</span>
08614             <span class="comment">//</span>
08615 
08616             <a class="code" href="../../d0/d6/iop_8h.html#a170">IopExceptionCleanup</a>( fileObject,
08617                                  irp,
08618                                  eventObject,
08619                                  (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) NULL );
08620 
08621             <span class="keywordflow">return</span> GetExceptionCode();
08622         }
08623 
08624         <span class="keywordflow">break</span>;
08625 
08626     <span class="keywordflow">case</span> 1:
08627     <span class="keywordflow">case</span> 2:
08628 
08629         <span class="comment">//</span>
08630         <span class="comment">// For these two cases, allocate a buffer that is large enough to</span>
08631         <span class="comment">// contain the input buffer, if any, and copy the information to</span>
08632         <span class="comment">// the allocated buffer.  Then build an MDL for either read or write</span>
08633         <span class="comment">// access, depending on the method, for the output buffer.  Note</span>
08634         <span class="comment">// that the buffer length parameters have been jammed to zero for</span>
08635         <span class="comment">// users if the buffer parameter was not passed.  (Kernel callers</span>
08636         <span class="comment">// should be calling the service correctly in the first place.)</span>
08637         <span class="comment">//</span>
08638         <span class="comment">// Note also that it doesn't make a whole lot of sense to specify</span>
08639         <span class="comment">// either method #1 or #2 if the IOCTL does not require the caller</span>
08640         <span class="comment">// to specify an output buffer.</span>
08641         <span class="comment">//</span>
08642 
08643         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = 0;
08644         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.DeviceIoControl.Type3InputBuffer = (PVOID) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08645 
08646         <span class="keywordflow">try</span> {
08647 
08648             <span class="keywordflow">if</span> (InputBufferLength &amp;&amp; ARGUMENT_PRESENT( InputBuffer )) {
08649                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer =
08650                     <a class="code" href="../../d5/d5/cc_8h.html#a11">ExAllocatePoolWithQuota</a>( poolType,
08651                                              InputBufferLength );
08652                 RtlCopyMemory( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer,
08653                                InputBuffer,
08654                                InputBufferLength );
08655                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a178">IRP_BUFFERED_IO</a> | <a class="code" href="../../d0/d5/io_8h.html#a179">IRP_DEALLOCATE_BUFFER</a>;
08656             }
08657 
08658             <span class="keywordflow">if</span> (OutputBufferLength != 0) {
08659                 irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a19">IoAllocateMdl</a>( OutputBuffer,
08660                                                  OutputBufferLength,
08661                                                  FALSE,
08662                                                  TRUE,
08663                                                  irp  );
08664                 <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08665                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INSUFFICIENT_RESOURCES );
08666                 }
08667                 <a class="code" href="../../d5/d6/iosup_8c.html#a41">MmProbeAndLockPages</a>( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a>,
08668                                      requestorMode,
08669                                      (<a class="code" href="../../d2/d1/mm_8h.html#a141">LOCK_OPERATION</a>) ((method == 1) ? IoReadAccess : IoWriteAccess) );
08670             }
08671 
08672         } except(EXCEPTION_EXECUTE_HANDLER) {
08673 
08674             <span class="comment">//</span>
08675             <span class="comment">// An exception was incurred while either allocating the</span>
08676             <span class="comment">// system buffer, copying the caller's data, allocating the</span>
08677             <span class="comment">// MDL, or probing and locking the caller's buffer. Determine</span>
08678             <span class="comment">// what actually happened, cleanup accordingly, and return</span>
08679             <span class="comment">// an appropriate error status code.</span>
08680             <span class="comment">//</span>
08681 
08682             <a class="code" href="../../d0/d6/iop_8h.html#a170">IopExceptionCleanup</a>( fileObject,
08683                                  irp,
08684                                  eventObject,
08685                                  (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) NULL );
08686 
08687             <span class="keywordflow">return</span> GetExceptionCode();
08688         }
08689 
08690         <span class="keywordflow">break</span>;
08691 
08692     <span class="keywordflow">case</span> 3:
08693 
08694         <span class="comment">//</span>
08695         <span class="comment">// For this case, do nothing.  Everything is up to the driver.</span>
08696         <span class="comment">// Simply give the driver a copy of the caller's parameters and</span>
08697         <span class="comment">// let the driver do everything itself.</span>
08698         <span class="comment">//</span>
08699 
08700         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = 0;
08701         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o26">UserBuffer</a> = OutputBuffer;
08702         irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.DeviceIoControl.Type3InputBuffer = InputBuffer;
08703     }
08704 
08705     <span class="comment">//</span>
08706     <span class="comment">// Defer I/O completion for FSCTL requests, but not for IOCTL requests,</span>
08707     <span class="comment">// since file systems set pending properly but device driver do not.</span>
08708     <span class="comment">//</span>
08709 
08710     <span class="keywordflow">if</span> (!DeviceIoControl) {
08711         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a186">IRP_DEFER_IO_COMPLETION</a>;
08712     }
08713 
08714     <span class="comment">//</span>
08715     <span class="comment">// Queue the packet, call the driver, and synchronize appropriately with</span>
08716     <span class="comment">// I/O completion.</span>
08717     <span class="comment">//</span>
08718 
08719     <span class="keywordflow">return</span> <a class="code" href="../../d0/d6/iop_8h.html#a212">IopSynchronousServiceTail</a>( deviceObject,
08720                                       irp,
08721                                       fileObject,
08722                                       (BOOLEAN)!DeviceIoControl,
08723                                       requestorMode,
08724                                       synchronousIo,
08725                                       OtherTransfer );
08726 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a12" doxytag="internal.c::BootLogRecord" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d4/struct__BOOT__LOG__RECORD.html">PBOOT_LOG_RECORD</a> <a class="el" href="../../d2/d4/internal_8c.html#a12">BootLogRecord</a><code> [static]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l08925">8925</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l09046">IopBootLog()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l09284">IopBootLogToFile()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l09157">IopCopyBootLogRegistryToFile()</a>, and <a class="el" href="../../d3/d3/internal_8c-source.html#l08928">IopInitializeBootLogging()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="internal.c::IopDeadIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d2/d4/internal_8c.html#a11">IopDeadIrp</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/internal_8c-source.html#l00056">56</a> of file <a class="el" href="../../d3/d3/internal_8c-source.html">internal.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l01623">IopDisassociateThreadIrp()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:14 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
