<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: conime.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>conime.c</h1><a href="../../d1/d5/ntuser_2imm_2conime_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/**************************************************************************\</span>
00002 <span class="comment">* Module Name: conime.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* client side receiveing stubs</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 19-Sep-1995 v-HirShi Created</span>
00010 <span class="comment">* 12-Jun-1996 v-HirShi Attached to SUR</span>
00011 <span class="comment">\**************************************************************************/</span>
00012 <span class="preprocessor">#include "<a class="code" href="../../d8/d3/w32_2ntuser_2imm_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span>
<a name="l00015"></a><a class="code" href="../../d1/d5/ntuser_2imm_2conime_8c.html#a0">00015</a> <span class="preprocessor">#define GUI_VKEY_MASK (0x00ff)</span>
00016 <span class="preprocessor"></span>
00017 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
00018 <a class="code" href="../../d9/d0/immuser_8h.html#a48">ImmProcessKey</a>(
00019     HWND hWnd,
00020     HKL  hkl,
00021     UINT uVKey,
00022     LPARAM lParam,
00023     DWORD dwHotKeyID
00024     ) ;
00025 
00026 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00027 <a class="code" href="../../d9/d0/immuser_8h.html#a36">ImmSetActiveContext</a>(
00028     HWND   hWnd,
00029     HIMC   hIMC,
00030     BOOL   fFlag
00031     ) ;
00032 
00033 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
<a name="l00034"></a><a class="code" href="../../d1/d5/ntuser_2imm_2conime_8c.html#a3">00034</a> <a class="code" href="../../d1/d5/ntuser_2imm_2conime_8c.html#a3">ImmCallImeConsoleIME</a>(
00035     HWND   hWnd,
00036     UINT   Message,
00037     WPARAM wParam,
00038     LPARAM lParam,
00039     PUINT  puVKey
00040     )
00041 <span class="comment">/*++</span>
00042 <span class="comment"></span>
00043 <span class="comment">Routine Description:</span>
00044 <span class="comment"></span>
00045 <span class="comment">        Called by Console IME to convert Character</span>
00046 <span class="comment">        This routine copy from user\kernel\ntimm.c :: xxxImmProcessKey</span>
00047 <span class="comment">        for Console IME could not calls kernel function.</span>
00048 <span class="comment"></span>
00049 <span class="comment">Arguments:</span>
00050 <span class="comment"></span>
00051 <span class="comment">Return Value:</span>
00052 <span class="comment">--*/</span>
00053 {
00054     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>          dwReturn ;
00055     <a class="code" href="../../d1/d7/structtagIMC.html">PIMC</a>           pImc ;
00056     HIMC           hImc ;
00057     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>           fDBERoman ;
00058     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>           pwnd ;
00059     <a class="code" href="../../d2/d7/structtagIMEDPI.html">PIMEDPI</a>        pImeDpi;
00060     HKL            hkl ;
00061 
00062     dwReturn = 0;
00063     pImc = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00064     fDBERoman = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00065 
00066     <span class="comment">//</span>
00067     <span class="comment">// we're interested in only keyboard messages.</span>
00068     <span class="comment">//</span>
00069     <span class="keywordflow">if</span> ( Message != WM_KEYDOWN    &amp;&amp;
00070          Message != WM_SYSKEYDOWN &amp;&amp;
00071          Message != WM_KEYUP      &amp;&amp;
00072          Message != WM_SYSKEYUP ) {
00073 
00074         <span class="keywordflow">return</span> dwReturn;
00075     }
00076 
00077     hkl = <a class="code" href="../../d3/d8/client_8c.html#a154">GetKeyboardLayout</a>( <a class="code" href="../../d3/d8/winmgrc_8c.html#a18">GetWindowThreadProcessId</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) );
00078     pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>);
00079     <span class="keywordflow">if</span> ( pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00080         <span class="keywordflow">return</span> dwReturn;
00081     }
00082     hImc = <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a5">ImmGetContext</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>);
00083     <span class="keywordflow">if</span> ( hImc == <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a> ){
00084         <span class="keywordflow">return</span> dwReturn;
00085     }
00086 
00087     *puVKey = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)wParam &amp; <a class="code" href="../../d1/d5/ntuser_2imm_2conime_8c.html#a0">GUI_VKEY_MASK</a>;
00088 
00089     <span class="comment">//</span>
00090     <span class="comment">// Check input context</span>
00091     <span class="comment">//</span>
00092     pImc = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a6">HMValidateHandle</a>((HANDLE)hImc, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a253">TYPE_INPUTCONTEXT</a>);
00093     <span class="keywordflow">if</span> ( pImc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00094         <span class="keywordflow">return</span> dwReturn;
00095     }
00096 
00097 <span class="preprocessor">#ifdef LATER</span>
00098 <span class="preprocessor"></span>    <span class="comment">//</span>
00099     <span class="comment">// If there is an easy way to check the input context open/close status</span>
00100     <span class="comment">// from the kernel side, IME_PROP_NO_KEYS_ON_CLOSE checking should be</span>
00101     <span class="comment">// done here in kernel side.  [ 3/10/96 takaok]</span>
00102     <span class="comment">//</span>
00103 
00104     <span class="comment">//</span>
00105     <span class="comment">// Check IME_PROP_NO_KEYS_ON_CLOSE bit</span>
00106     <span class="comment">//</span>
00107     <span class="comment">// if the current imc is not open and IME doesn't need</span>
00108     <span class="comment">// keys when being closed, we don't pass any keyboard</span>
00109     <span class="comment">// input to ime except hotkey and keys that change</span>
00110     <span class="comment">// the keyboard status.</span>
00111     <span class="comment">//</span>
00112     <span class="keywordflow">if</span> ( (piix-&gt;ImeInfo.fdwProperty &amp; IME_PROP_NO_KEYS_ON_CLOSE) &amp;&amp;
00113          (!pimc-&gt;fdwState &amp; IMC_OPEN)                            &amp;&amp;
00114          uVKey != VK_SHIFT                                       &amp;&amp;  <span class="comment">// 0x10</span>
00115          uVKey != VK_CONTROL                                     &amp;&amp;  <span class="comment">// 0x11</span>
00116          uVKey != VK_CAPITAL                                     &amp;&amp;  <span class="comment">// 0x14</span>
00117          uVKey != VK_KANA                                        &amp;&amp;  <span class="comment">// 0x15</span>
00118          uVKey != VK_NUMLOCK                                     &amp;&amp;  <span class="comment">// 0x90</span>
00119          uVKey != VK_SCROLL )                                        <span class="comment">// 0x91</span>
00120     {
00121       <span class="comment">// Check if Korea Hanja conversion mode</span>
00122       <span class="keywordflow">if</span>( !(pimc-&gt;fdwConvMode &amp; IME_CMODE_HANJACONVERT) ) {
00123           <span class="keywordflow">return</span> dwReturn;
00124       }
00125     }
00126 <span class="preprocessor">#endif</span>
00127 <span class="preprocessor"></span>
00128     <span class="comment">//</span>
00129     <span class="comment">// if the IME doesn't need key up messages, we don't call ime.</span>
00130     <span class="comment">//</span>
00131     pImeDpi = <a class="code" href="../../d9/d0/immuser_8h.html#a45">ImmLockImeDpi</a>(hkl);
00132     <span class="keywordflow">if</span> ( pImeDpi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00133         <span class="keywordflow">return</span> dwReturn;
00134     }
00135 
00136     <span class="keywordflow">if</span> ( lParam &amp; 0x80000000 &amp;&amp;          <span class="comment">// set if key up, clear if key down</span>
00137          pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o3">ImeInfo</a>.fdwProperty &amp; IME_PROP_IGNORE_UPKEYS )
00138     {
00139         <span class="keywordflow">return</span> dwReturn;
00140     }
00141 
00142     <span class="comment">//</span>
00143     <span class="comment">// we don't want to handle sys keys since many functions for</span>
00144     <span class="comment">// acceelerators won't work without this</span>
00145     <span class="comment">//</span>
00146     fDBERoman = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)( (*puVKey == VK_DBE_ROMAN)            ||
00147                         (*puVKey == VK_DBE_NOROMAN)          ||
00148                         (*puVKey == VK_DBE_HIRAGANA)         ||
00149                         (*puVKey == VK_DBE_KATAKANA)         ||
00150                         (*puVKey == VK_DBE_CODEINPUT)        ||
00151                         (*puVKey == VK_DBE_NOCODEINPUT)      ||
00152                         (*puVKey == VK_DBE_IME_WORDREGISTER) ||
00153                         (*puVKey == VK_DBE_IME_DIALOG) );
00154 
00155     <span class="keywordflow">if</span> (Message == WM_SYSKEYDOWN || Message == WM_SYSKEYUP ) {
00156         <span class="comment">//</span>
00157         <span class="comment">// IME may be waiting for VK_MENU, VK_F10 or VK_DBE_xxx</span>
00158         <span class="comment">//</span>
00159         <span class="keywordflow">if</span> ( *puVKey != VK_MENU &amp;&amp; *puVKey != VK_F10 &amp;&amp; !fDBERoman ) {
00160             <span class="keywordflow">return</span> dwReturn;
00161         }
00162     }
00163 
00164     <span class="comment">//</span>
00165     <span class="comment">// check if the IME doesn't need ALT key</span>
00166     <span class="comment">//</span>
00167 
00168     <span class="keywordflow">if</span> ( !(pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o3">ImeInfo</a>.fdwProperty &amp; IME_PROP_NEED_ALTKEY) ) {
00169         <span class="comment">//</span>
00170         <span class="comment">// IME doesn't need ALT key</span>
00171         <span class="comment">//</span>
00172         <span class="comment">// we don't pass the ALT and ALT+xxx except VK_DBE_xxx keys.</span>
00173         <span class="comment">//</span>
00174         <span class="keywordflow">if</span> ( ! fDBERoman &amp;&amp;
00175              (*puVKey == VK_MENU || (lParam &amp; 0x20000000))  <span class="comment">// KF_ALTDOWN</span>
00176            )
00177         {
00178             <span class="keywordflow">return</span> dwReturn;
00179         }
00180     }
00181 
00182 
00183     dwReturn = <a class="code" href="../../d9/d0/immuser_8h.html#a48">ImmProcessKey</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, hkl, *puVKey, lParam, IME_INVALID_HOTKEY ) ;
00184     <span class="keywordflow">return</span> dwReturn;
00185 }
00186 
00187 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00188"></a><a class="code" href="../../d1/d5/ntuser_2imm_2conime_8c.html#a4">00188</a> <a class="code" href="../../d1/d5/ntuser_2imm_2conime_8c.html#a4">ImmSetActiveContextConsoleIME</a>(
00189     HWND   hWnd,
00190     BOOL   fFlag
00191     )
00192 
00193 <span class="comment">/*++</span>
00194 <span class="comment"></span>
00195 <span class="comment">Routine Description:</span>
00196 <span class="comment"></span>
00197 <span class="comment">    Set this context as active one.</span>
00198 <span class="comment"></span>
00199 <span class="comment">Arguments:</span>
00200 <span class="comment"></span>
00201 <span class="comment">    hWnd         - the get focus window</span>
00202 <span class="comment">    fFlag        - get focus or kill focus</span>
00203 <span class="comment"></span>
00204 <span class="comment">Return Value:</span>
00205 <span class="comment"></span>
00206 <span class="comment">--*/</span>
00207 
00208 {
00209     HIMC hImc;
00210 
00211     hImc = <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a5">ImmGetContext</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>) ;
00212     <span class="keywordflow">if</span> (hImc == <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>) {
00213         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00214     }
00215     <span class="keywordflow">return</span>(<a class="code" href="../../d9/d0/immuser_8h.html#a36">ImmSetActiveContext</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, hImc, fFlag)) ;
00216 
00217 }
00218 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:33 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
