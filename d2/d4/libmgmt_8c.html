<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: libmgmt.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>libmgmt.c File Reference</h1><code>#include "<a class="el" href="../../d1/d3/w32_2ntuser_2kernel_2precomp_8h-source.html">precomp.h</a>"</code><br>

<p>
<a href="../../d3/d3/libmgmt_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>int&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/libmgmt_8c.html#a4">GetHmodTableIndex</a> (PUNICODE_STRING pstrLibName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/libmgmt_8c.html#a5">AddHmodDependency</a> (int iatom)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/libmgmt_8c.html#a6">RemoveHmodDependency</a> (int iatom)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HANDLE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/libmgmt_8c.html#a7">xxxLoadHmodIndex</a> (int iatom, BOOL bWx86KnownDll)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/libmgmt_8c.html#a8">xxxDoSysExpunge</a> (<a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>int&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/libmgmt_8c.html#a0">catomSysTableEntries</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ATOM&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/libmgmt_8c.html#a1">aatomSysLoaded</a> [CLIBS]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>int&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/libmgmt_8c.html#a2">acatomSysUse</a> [CLIBS]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>int&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/libmgmt_8c.html#a3">acatomSysDepends</a> [CLIBS]</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a5" doxytag="libmgmt.c::AddHmodDependency" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID AddHmodDependency           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">int&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>iatom</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00136">136</a> of file <a class="el" href="../../d3/d3/libmgmt_8c-source.html">libmgmt.c</a>.
<p>
References <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00039">acatomSysDepends</a>, <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00023">catomSysTableEntries</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00674">_SetWinEventHook()</a>, and <a class="el" href="../../d2/d1/hooks_8c-source.html#l00576">zzzSetWindowsHookEx()</a>.
<p>
<pre class="fragment"><div>00138 {
00139     UserAssert(iatom &gt;= 0);
00140     <span class="keywordflow">if</span> (iatom &lt; <a class="code" href="../../d2/d4/libmgmt_8c.html#a0">catomSysTableEntries</a>) {
00141         <a class="code" href="../../d2/d4/libmgmt_8c.html#a3">acatomSysDepends</a>[iatom]++;
00142     }
00143 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="libmgmt.c::GetHmodTableIndex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> int GetHmodTableIndex           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PUNICODE_STRING&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pstrLibName</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00053">53</a> of file <a class="el" href="../../d3/d3/libmgmt_8c-source.html">libmgmt.c</a>.
<p>
References <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00029">aatomSysLoaded</a>, <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00039">acatomSysDepends</a>, <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00034">acatomSysUse</a>, <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00023">catomSysTableEntries</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03404">CLIBS</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01417">ProbeAndReadUnicodeString</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00612">ProbeForReadUnicodeStringBuffer</a>, <a class="el" href="../../d2/d9/w32_2ntuser_2kernel_2atom_8c-source.html#l00035">UserAddAtom()</a>, and <a class="el" href="../../d2/d9/w32_2ntuser_2kernel_2atom_8c-source.html#l00084">UserDeleteAtom()</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00674">_SetWinEventHook()</a>, and <a class="el" href="../../d2/d1/hooks_8c-source.html#l00576">zzzSetWindowsHookEx()</a>.
<p>
<pre class="fragment"><div>00055 {
00056     <span class="keywordtype">int</span> i;
00057     ATOM atom;
00058     UNICODE_STRING strLibName;
00059 
00060     <span class="comment">/*</span>
00061 <span class="comment">     * Probe string</span>
00062 <span class="comment">     */</span>
00063     <span class="keywordflow">try</span> {
00064         strLibName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(pstrLibName);
00065         <a class="code" href="../../d4/d1/userk_8h.html#a61">ProbeForReadUnicodeStringBuffer</a>(strLibName);
00066         atom = <a class="code" href="../../d4/d1/userk_8h.html#a1297">UserAddAtom</a>(strLibName.Buffer, FALSE);
00067     } except (W32ExceptionHandler(FALSE, RIP_WARNING)) {
00068         <span class="keywordflow">return</span> -1;
00069     }
00070 
00071     <span class="comment">/*</span>
00072 <span class="comment">     * If we can't add the atom we're hosed</span>
00073 <span class="comment">     * so return an error.</span>
00074 <span class="comment">     */</span>
00075     <span class="keywordflow">if</span> (atom == 0) {
00076         <span class="keywordflow">return</span> -1;
00077     }
00078 
00079     <span class="comment">/*</span>
00080 <span class="comment">     * Search for atom index</span>
00081 <span class="comment">     */</span>
00082     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d2/d4/libmgmt_8c.html#a0">catomSysTableEntries</a> &amp;&amp; <a class="code" href="../../d2/d4/libmgmt_8c.html#a1">aatomSysLoaded</a>[i] != atom; i++)
00083         ;
00084 
00085     <span class="keywordflow">if</span> (i == <a class="code" href="../../d2/d4/libmgmt_8c.html#a0">catomSysTableEntries</a>) {
00086 
00087         <span class="comment">/*</span>
00088 <span class="comment">         * Find empty entry for atom</span>
00089 <span class="comment">         */</span>
00090         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d2/d4/libmgmt_8c.html#a0">catomSysTableEntries</a> &amp;&amp; <a class="code" href="../../d2/d4/libmgmt_8c.html#a1">aatomSysLoaded</a>[i]; i++)
00091             ;
00092 
00093         <span class="comment">/*</span>
00094 <span class="comment">         * Check if no empty entry found</span>
00095 <span class="comment">         */</span>
00096         <span class="keywordflow">if</span> (i == <a class="code" href="../../d2/d4/libmgmt_8c.html#a0">catomSysTableEntries</a>) {
00097             <span class="keywordflow">if</span> (i == <a class="code" href="../../d4/d1/userk_8h.html#a385">CLIBS</a>) {
00098                 <a class="code" href="../../d4/d1/userk_8h.html#a1299">UserDeleteAtom</a>(atom);
00099                 RIPERR0(ERROR_NOT_ENOUGH_MEMORY,
00100                         RIP_WARNING,
00101                         <span class="stringliteral">"Memory allocation failed in GetHmodTableIndex"</span>);
00102 
00103                 <span class="keywordflow">return</span> -1;
00104             }
00105 
00106             <span class="comment">/*</span>
00107 <span class="comment">             * Increase table size</span>
00108 <span class="comment">             */</span>
00109             <a class="code" href="../../d2/d4/libmgmt_8c.html#a0">catomSysTableEntries</a>++;
00110         }
00111 
00112         <span class="comment">/*</span>
00113 <span class="comment">         * Set entry</span>
00114 <span class="comment">         */</span>
00115         <a class="code" href="../../d2/d4/libmgmt_8c.html#a1">aatomSysLoaded</a>[i] = atom;
00116         <a class="code" href="../../d2/d4/libmgmt_8c.html#a2">acatomSysUse</a>[i] = 0;
00117         <a class="code" href="../../d2/d4/libmgmt_8c.html#a3">acatomSysDepends</a>[i] = 0;
00118     } <span class="keywordflow">else</span> {
00119         <a class="code" href="../../d4/d1/userk_8h.html#a1299">UserDeleteAtom</a>(atom);
00120     }
00121 
00122     <span class="keywordflow">return</span> i;
00123 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="libmgmt.c::RemoveHmodDependency" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RemoveHmodDependency           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">int&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>iatom</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00158">158</a> of file <a class="el" href="../../d3/d3/libmgmt_8c-source.html">libmgmt.c</a>.
<p>
References <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00029">aatomSysLoaded</a>, <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00039">acatomSysDepends</a>, <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00034">acatomSysUse</a>, <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00023">catomSysTableEntries</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00383">gcSysExpunge</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00382">gdwSysExpungeMask</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00879">DestroyEventHook()</a>, and <a class="el" href="../../d2/d1/hooks_8c-source.html#l01976">FreeHook()</a>.
<p>
<pre class="fragment"><div>00160 {
00161 
00162     UserAssert(iatom &gt;= 0);
00163     <span class="keywordflow">if</span> (iatom &lt; <a class="code" href="../../d2/d4/libmgmt_8c.html#a0">catomSysTableEntries</a> &amp;&amp;
00164         --<a class="code" href="../../d2/d4/libmgmt_8c.html#a3">acatomSysDepends</a>[iatom] == 0) {
00165 
00166         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4/libmgmt_8c.html#a2">acatomSysUse</a>[iatom]) {
00167 
00168             <span class="comment">/*</span>
00169 <span class="comment">             * Cause each thread to check for expunged dlls</span>
00170 <span class="comment">             * the next time they awake.</span>
00171 <span class="comment">             */</span>
00172             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a153">gcSysExpunge</a>++;
00173             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a152">gdwSysExpungeMask</a> |= (1 &lt;&lt; iatom);
00174         } <span class="keywordflow">else</span> {
00175             <a class="code" href="../../d2/d4/libmgmt_8c.html#a1">aatomSysLoaded</a>[iatom] = 0;
00176         }
00177     }
00178 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="libmgmt.c::xxxDoSysExpunge" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID xxxDoSysExpunge           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pti</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00253">253</a> of file <a class="el" href="../../d3/d3/libmgmt_8c-source.html">libmgmt.c</a>.
<p>
References <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00029">aatomSysLoaded</a>, <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00039">acatomSysDepends</a>, <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00034">acatomSysUse</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03487">tagPROCESSINFO::ahmodLibLoaded</a>, <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00023">catomSysTableEntries</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03668">CLEARHMODLOADED</a>, <a class="el" href="../../d4/d1/userk_8h.html#a1920">ClientFreeLibrary()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03485">tagPROCESSINFO::cSysExpunge</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00383">gcSysExpunge</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00382">gdwSysExpungeMask</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03319">tagTHREADINFO::ppi</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03665">TESTHMODLOADED</a>, <a class="el" href="../../d2/d9/w32_2ntuser_2kernel_2atom_8c-source.html#l00084">UserDeleteAtom()</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l00213">xxxInternalGetMessage()</a>, and <a class="el" href="../../d7/d2/queue_8c-source.html#l04382">xxxSleepThread()</a>.
<p>
<pre class="fragment"><div>00255 {
00256     <span class="keywordtype">int</span> i;
00257 
00258     <span class="comment">/*</span>
00259 <span class="comment">     * Clear this first before we potentially leave the critical section.</span>
00260 <span class="comment">     */</span>
00261     pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o11">cSysExpunge</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a153">gcSysExpunge</a>;
00262 
00263     <span class="comment">/*</span>
00264 <span class="comment">     * Scan for libraries that have been freed</span>
00265 <span class="comment">     */</span>
00266     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d2/d4/libmgmt_8c.html#a0">catomSysTableEntries</a>; i++) {
00267         <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d4/libmgmt_8c.html#a3">acatomSysDepends</a>[i] == 0) &amp;&amp; (<a class="code" href="../../d2/d4/libmgmt_8c.html#a1">aatomSysLoaded</a>[i] != 0) &amp;&amp;
00268                 <a class="code" href="../../d4/d1/userk_8h.html#a420">TESTHMODLOADED</a>(pti, i)) {
00269 
00270             HANDLE hmodFree = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o13">ahmodLibLoaded</a>[i];
00271 
00272             <span class="comment">/*</span>
00273 <span class="comment">             * Clear this hmod for this process before we leave the</span>
00274 <span class="comment">             * critical section.</span>
00275 <span class="comment">             */</span>
00276             <a class="code" href="../../d4/d1/userk_8h.html#a422">CLEARHMODLOADED</a>(pti, i);
00277 
00278             <span class="comment">/*</span>
00279 <span class="comment">             * Decrement the count of processes that have loaded this</span>
00280 <span class="comment">             * .dll.  If there are no more, then destroy the reference</span>
00281 <span class="comment">             * to this .dll.</span>
00282 <span class="comment">             */</span>
00283             <span class="keywordflow">if</span> (--<a class="code" href="../../d2/d4/libmgmt_8c.html#a2">acatomSysUse</a>[i] == 0) {
00284                 <a class="code" href="../../d4/d1/userk_8h.html#a1299">UserDeleteAtom</a>(aatomSysLoaded[i]);
00285                 <a class="code" href="../../d2/d4/libmgmt_8c.html#a1">aatomSysLoaded</a>[i] = 0;
00286                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a152">gdwSysExpungeMask</a> &amp;= ~(1 &lt;&lt; i);
00287             }
00288 
00289             <span class="comment">/*</span>
00290 <span class="comment">             * Call back the client to free the library...</span>
00291 <span class="comment">             */</span>
00292             <a class="code" href="../../d4/d1/userk_8h.html#a1920">ClientFreeLibrary</a>(hmodFree);
00293         }
00294     }
00295 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="libmgmt.c::xxxLoadHmodIndex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HANDLE xxxLoadHmodIndex           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">int&nbsp;</td>
          <td class="mdname" nowrap> <em>iatom</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>bWx86KnownDll</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00192">192</a> of file <a class="el" href="../../d3/d3/libmgmt_8c-source.html">libmgmt.c</a>.
<p>
References <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00029">aatomSysLoaded</a>, <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00034">acatomSysUse</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03487">tagPROCESSINFO::ahmodLibLoaded</a>, <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00023">catomSysTableEntries</a>, <a class="el" href="../../d4/d1/userk_8h.html#a1920">ClientFreeLibrary()</a>, <a class="el" href="../../d4/d1/userk_8h.html#a1919">ClientLoadLibrary()</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00455">gptiRit</a>, <a class="el" href="../../d4/d8/arcinst_8c-source.html#l00065">MAX_PATH</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03319">tagTHREADINFO::ppi</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03666">SETHMODLOADED</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03665">TESTHMODLOADED</a>, and <a class="el" href="../../d2/d9/w32_2ntuser_2kernel_2atom_8c-source.html#l00101">UserGetAtomName()</a>.
<p>
Referenced by <a class="el" href="../../d2/d1/hooks_8c-source.html#l01288">xxxCallHook2()</a>, and <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00936">xxxGetEventProc()</a>.
<p>
<pre class="fragment"><div>00195 {
00196     WCHAR pszLibName[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00197     HANDLE hmod;
00198     UNICODE_STRING strLibrary;
00199     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>    ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00200 
00201     UserAssert((!gptiRit || <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> != <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;ppi) &amp;&amp;
00202                 <span class="stringliteral">"Shouldn't load global hooks on system process - gptiRit-&gt;ppi is the system process"</span>);
00203 
00204     <span class="keywordflow">if</span> (iatom &gt;= <a class="code" href="../../d2/d4/libmgmt_8c.html#a0">catomSysTableEntries</a>) {
00205         RIPERR0(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"Index out of range"</span>);
00206         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00207     }
00208 
00209     <a class="code" href="../../d4/d1/userk_8h.html#a1300">UserGetAtomName</a>(aatomSysLoaded[iatom], pszLibName, <span class="keyword">sizeof</span>(pszLibName)/<span class="keyword">sizeof</span>(WCHAR));
00210 
00211     <span class="comment">/*</span>
00212 <span class="comment">     * Call back the client to load the library.</span>
00213 <span class="comment">     */</span>
00214     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strLibrary, pszLibName);
00215     hmod = <a class="code" href="../../d4/d1/userk_8h.html#a1919">ClientLoadLibrary</a>(&amp;strLibrary, bWx86KnownDll);
00216 
00217     <span class="keywordflow">if</span> (hmod != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00218         <span class="comment">/*</span>
00219 <span class="comment">         * Check to make sure another thread hasn't loaded this library</span>
00220 <span class="comment">         * while we were outside the critical section.</span>
00221 <span class="comment">         */</span>
00222         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a420">TESTHMODLOADED</a>(ptiCurrent, iatom)) {
00223             <span class="comment">/*</span>
00224 <span class="comment">             * Go ahead and bump the reference count.</span>
00225 <span class="comment">             */</span>
00226             <a class="code" href="../../d2/d4/libmgmt_8c.html#a2">acatomSysUse</a>[iatom]++;
00227             <a class="code" href="../../d4/d1/userk_8h.html#a421">SETHMODLOADED</a>(ptiCurrent, iatom, hmod);
00228 
00229         } <span class="keywordflow">else</span> {
00230             <span class="comment">/*</span>
00231 <span class="comment">             * Another thread loaded it while we were outside the</span>
00232 <span class="comment">             * critical section.  Unload it so the system's</span>
00233 <span class="comment">             * reference count is correct.</span>
00234 <span class="comment">             */</span>
00235             <a class="code" href="../../d4/d1/userk_8h.html#a1920">ClientFreeLibrary</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o13">ahmodLibLoaded</a>[iatom]);
00236         }
00237     }
00238 
00239     <span class="keywordflow">return</span> hmod;
00240 }
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a1" doxytag="libmgmt.c::aatomSysLoaded" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ATOM <a class="el" href="../../d2/d4/libmgmt_8c.html#a1">aatomSysLoaded</a>[CLIBS]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00029">29</a> of file <a class="el" href="../../d3/d3/libmgmt_8c-source.html">libmgmt.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00053">GetHmodTableIndex()</a>, <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00158">RemoveHmodDependency()</a>, <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00253">xxxDoSysExpunge()</a>, and <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00192">xxxLoadHmodIndex()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="libmgmt.c::acatomSysDepends" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> int <a class="el" href="../../d2/d4/libmgmt_8c.html#a3">acatomSysDepends</a>[CLIBS]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00039">39</a> of file <a class="el" href="../../d3/d3/libmgmt_8c-source.html">libmgmt.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00136">AddHmodDependency()</a>, <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00053">GetHmodTableIndex()</a>, <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00158">RemoveHmodDependency()</a>, and <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00253">xxxDoSysExpunge()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="libmgmt.c::acatomSysUse" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> int <a class="el" href="../../d2/d4/libmgmt_8c.html#a2">acatomSysUse</a>[CLIBS]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00034">34</a> of file <a class="el" href="../../d3/d3/libmgmt_8c-source.html">libmgmt.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00053">GetHmodTableIndex()</a>, <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00158">RemoveHmodDependency()</a>, <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00253">xxxDoSysExpunge()</a>, and <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00192">xxxLoadHmodIndex()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="libmgmt.c::catomSysTableEntries" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> int <a class="el" href="../../d2/d4/libmgmt_8c.html#a0">catomSysTableEntries</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00023">23</a> of file <a class="el" href="../../d3/d3/libmgmt_8c-source.html">libmgmt.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00136">AddHmodDependency()</a>, <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00053">GetHmodTableIndex()</a>, <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00158">RemoveHmodDependency()</a>, <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00253">xxxDoSysExpunge()</a>, and <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00192">xxxLoadHmodIndex()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:32 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
