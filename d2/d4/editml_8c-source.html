<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: editml.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>editml.c</h1><a href="../../d1/d5/editml_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/***************************************************************************\</span>
00002 <span class="comment">* editml.c - Edit controls rewrite. Version II of edit controls.</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Multi-Line Support Routines</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* Created: 24-Jul-88 davidds</span>
00009 <span class="comment">\***************************************************************************/</span>
00010 
00011 <span class="preprocessor">#include "<a class="code" href="../../d7/d3/w32_2ntuser_2client_2precomp_8h.html">precomp.h</a>"</span>
00012 <span class="preprocessor">#pragma hdrstop</span>
00013 <span class="preprocessor"></span>
00014 <span class="comment">/*</span>
00015 <span class="comment"> * Number of lines to bump when reallocating index buffer</span>
00016 <span class="comment"> */</span>
<a name="l00017"></a><a class="code" href="../../d1/d5/editml_8c.html#a0">00017</a> <span class="preprocessor">#define LINEBUMP 32</span>
00018 <span class="preprocessor"></span>
00019 <span class="comment">/*</span>
00020 <span class="comment"> * Used for ML scroll updates</span>
00021 <span class="comment"> */</span>
<a name="l00022"></a><a class="code" href="../../d1/d5/editml_8c.html#a1">00022</a> <span class="preprocessor">#define ML_REFRESH  0xffffffff</span>
00023 <span class="preprocessor"></span>
<a name="l00024"></a><a class="code" href="../../d1/d5/editml_8c.html#a2">00024</a> __inline <span class="keywordtype">void</span> <a class="code" href="../../d1/d5/editml_8c.html#a2">MLSanityCheck</a>(<a class="code" href="../../d3/d4/structtagED.html">PED</a> ped)
00025 {
00026     UNREFERENCED_PARAMETER(ped);    <span class="comment">// For free build</span>
00027 
00028     UserAssert(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a> &gt;= ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o4">cLines</a> - 1]);
00029 }
00030 
00031 
00032 <span class="comment">/***************************************************************************\</span>
00033 <span class="comment">*</span>
00034 <span class="comment">*  MLGetLineWidth()</span>
00035 <span class="comment">*</span>
00036 <span class="comment">*  Returns the max width in a line.  ECTabTheTextOut() ensures that max</span>
00037 <span class="comment">*  width won't overflow.</span>
00038 <span class="comment">*</span>
00039 <span class="comment">\***************************************************************************/</span>
<a name="l00040"></a><a class="code" href="../../d1/d5/editml_8c.html#a3">00040</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d1/d5/editml_8c.html#a3">MLGetLineWidth</a>(HDC hdc, LPSTR lpstr, <span class="keywordtype">int</span> nCnt, <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped)
00041 {
00042     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d0/usercli_8h.html#a478">ECTabTheTextOut</a>(hdc, 0, 0, 0, 0, lpstr, nCnt, 0, ped, 0, <a class="code" href="../../d6/d0/usercli_8h.html#a146">ECT_CALC</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>));
00043 }
00044 
00045 <span class="comment">/***************************************************************************\</span>
00046 <span class="comment">*</span>
00047 <span class="comment">*  MLSize()</span>
00048 <span class="comment">*</span>
00049 <span class="comment">*  Handles resizing of the edit control window and updating thereof.</span>
00050 <span class="comment">*</span>
00051 <span class="comment">*  Sets the edit field's formatting area given the passed in "client area".</span>
00052 <span class="comment">*  We fudge it if it doesn't seem reasonable.</span>
00053 <span class="comment">*</span>
00054 <span class="comment">\***************************************************************************/</span>
00055 
<a name="l00056"></a><a class="code" href="../../d6/d0/usercli_8h.html#a512">00056</a> <span class="keywordtype">void</span>   <a class="code" href="../../d6/d0/usercli_8h.html#a512">MLSize</a>(<a class="code" href="../../d3/d4/structtagED.html">PED</a> ped, BOOL fRedraw)
00057 {
00058     <span class="comment">// Calculate the # of lines we can fit in our rectangle.</span>
00059     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o10">ichLinesOnScreen</a> = (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.bottom - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.top) / ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o68">lineHeight</a>;
00060 
00061     <span class="comment">// Make the format rectangle height an integral number of lines</span>
00062     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.bottom = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.top + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o10">ichLinesOnScreen</a> * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o68">lineHeight</a>;
00063 
00064     <span class="comment">// Rebuild the line array</span>
00065     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o34">fWrap</a>) {
00066         <a class="code" href="../../d6/d0/usercli_8h.html#a490">MLBuildchLines</a>(ped, 0, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00067         <a class="code" href="../../d6/d0/usercli_8h.html#a519">MLUpdateiCaretLine</a>(ped);
00068     } <span class="keywordflow">else</span> {
00069         <a class="code" href="../../d6/d0/usercli_8h.html#a517">MLScroll</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,  <a class="code" href="../../d1/d5/editml_8c.html#a1">ML_REFRESH</a>, 0, fRedraw);
00070         <a class="code" href="../../d6/d0/usercli_8h.html#a517">MLScroll</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d1/d5/editml_8c.html#a1">ML_REFRESH</a>, 0, fRedraw);
00071     }
00072 }
00073 
00074 <span class="comment">/***************************************************************************\</span>
00075 <span class="comment">* MLCalcXOffset AorW</span>
00076 <span class="comment">*</span>
00077 <span class="comment">* Calculates the horizontal offset (indent) required for centered</span>
00078 <span class="comment">* and right justified lines.</span>
00079 <span class="comment">*</span>
00080 <span class="comment">* History:</span>
00081 <span class="comment">*</span>
00082 <span class="comment">* Not used if language pack loaded.</span>
00083 <span class="comment">\***************************************************************************/</span>
00084 
<a name="l00085"></a><a class="code" href="../../d6/d0/usercli_8h.html#a500">00085</a> <span class="keywordtype">int</span> <a class="code" href="../../d6/d0/usercli_8h.html#a500">MLCalcXOffset</a>(
00086     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
00087     HDC hdc,
00088     <span class="keywordtype">int</span> lineNumber)
00089 {
00090     PSTR pText;
00091     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> lineLength;
00092     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> lineWidth;
00093 
00094     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o62">format</a> == ES_LEFT)
00095         <span class="keywordflow">return</span> (0);
00096 
00097     lineLength = <a class="code" href="../../d6/d0/usercli_8h.html#a498">MLLine</a>(ped, lineNumber);
00098 
00099     <span class="keywordflow">if</span> (lineLength) {
00100 
00101         pText = <a class="code" href="../../d6/d0/usercli_8h.html#a433">ECLock</a>(ped) + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[lineNumber] * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>;
00102         hdc = <a class="code" href="../../d6/d0/usercli_8h.html#a451">ECGetEditDC</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00103         lineWidth = <a class="code" href="../../d1/d5/editml_8c.html#a3">MLGetLineWidth</a>(hdc, pText, lineLength, ped);
00104         <a class="code" href="../../d6/d0/usercli_8h.html#a452">ECReleaseEditDC</a>(ped, hdc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00105         <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
00106     } <span class="keywordflow">else</span> {
00107         lineWidth = 0;
00108     }
00109 
00110     <span class="comment">/*</span>
00111 <span class="comment">     * If a SPACE or a TAB was eaten at the end of a line by MLBuildchLines</span>
00112 <span class="comment">     * to prevent a delimiter appearing at the begining of a line, the</span>
00113 <span class="comment">     * the following calculation will become negative causing this bug.</span>
00114 <span class="comment">     * So, now, we take zero in such cases.</span>
00115 <span class="comment">     * Fix for Bug #3566 --01/31/91-- SANKAR --</span>
00116 <span class="comment">     */</span>
00117     lineWidth = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(0, (<span class="keywordtype">int</span>)(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.right-ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.left-lineWidth));
00118 
00119     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o62">format</a> == ES_CENTER)
00120         <span class="keywordflow">return</span> (lineWidth / 2);
00121 
00122     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o62">format</a> == ES_RIGHT) {
00123 
00124         <span class="comment">/*</span>
00125 <span class="comment">         * Subtract 1 so that the 1 pixel wide cursor will be in the visible</span>
00126 <span class="comment">         * region on the very right side of the screen.</span>
00127 <span class="comment">         */</span>
00128         <span class="keywordflow">return</span> <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(0, (<span class="keywordtype">int</span>)(lineWidth-1));
00129     }
00130 
00131     <span class="keywordflow">return</span> 0;
00132 }
00133 
00134 <span class="comment">/***************************************************************************\</span>
00135 <span class="comment">* MLMoveSelection AorW</span>
00136 <span class="comment">*</span>
00137 <span class="comment">* Moves the selection character in the direction indicated. Assumes</span>
00138 <span class="comment">* you are starting at a legal point, we decrement/increment the ich. Then,</span>
00139 <span class="comment">* This decrements/increments it some more to get past CRLFs...</span>
00140 <span class="comment">*</span>
00141 <span class="comment">* History:</span>
00142 <span class="comment">\***************************************************************************/</span>
00143 
<a name="l00144"></a><a class="code" href="../../d1/d5/editml_8c.html#a6">00144</a> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> <a class="code" href="../../d1/d5/editml_8c.html#a6">MLMoveSelection</a>(
00145     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
00146     ICH ich,
00147     BOOL fLeft)
00148 {
00149 
00150     <span class="keywordflow">if</span> (fLeft &amp;&amp; ich &gt; 0) {
00151 
00152         <span class="comment">/*</span>
00153 <span class="comment">         * Move left</span>
00154 <span class="comment">         */</span>
00155         ich = <a class="code" href="../../d6/d0/usercli_8h.html#a467">ECPrevIch</a>( ped, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, ich );
00156         <span class="keywordflow">if</span> (ich) {
00157             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>) {
00158                 LPSTR pText;
00159 
00160                 <span class="comment">/*</span>
00161 <span class="comment">                 * Check for CRLF or CRCRLF</span>
00162 <span class="comment">                 */</span>
00163                 pText = <a class="code" href="../../d6/d0/usercli_8h.html#a433">ECLock</a>(ped) + ich;
00164 
00165                 <span class="comment">/*</span>
00166 <span class="comment">                 * Move before CRLF or CRCRLF</span>
00167 <span class="comment">                 */</span>
00168                 <span class="keywordflow">if</span> (*(WORD UNALIGNED *)(pText - 1) == 0x0A0D) {
00169                     ich--;
00170                     <span class="keywordflow">if</span> (ich &amp;&amp; *(pText - 2) == 0x0D)
00171                         ich--;
00172                 }
00173                 <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
00174             } <span class="keywordflow">else</span> { <span class="comment">// !fAnsi</span>
00175                 LPWSTR pwText;
00176 
00177                 <span class="comment">/*</span>
00178 <span class="comment">                 * Check for CRLF or CRCRLF</span>
00179 <span class="comment">                 */</span>
00180                 pwText = (LPWSTR)<a class="code" href="../../d6/d0/usercli_8h.html#a433">ECLock</a>(ped) + ich;
00181 
00182                 <span class="comment">/*</span>
00183 <span class="comment">                 * Move before CRLF or CRCRLF</span>
00184 <span class="comment">                 */</span>
00185                 <span class="keywordflow">if</span> (*(pwText - 1) == 0x0D &amp;&amp; *pwText == 0x0A) {
00186                     ich--;
00187                     <span class="keywordflow">if</span> (ich &amp;&amp; *(pwText - 2) == 0x0D)
00188                         ich--;
00189                 }
00190                 <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
00191             }
00192         }
00193     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!fLeft &amp;&amp; ich &lt; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>) {
00194         <span class="comment">/*</span>
00195 <span class="comment">         * Move right.</span>
00196 <span class="comment">         */</span>
00197         ich = <a class="code" href="../../d6/d0/usercli_8h.html#a468">ECNextIch</a>( ped, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, ich );
00198         <span class="keywordflow">if</span> (ich &lt; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>) {
00199             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>) {
00200                 LPSTR pText;
00201                 pText = <a class="code" href="../../d6/d0/usercli_8h.html#a433">ECLock</a>(ped) + ich;
00202 
00203                 <span class="comment">/*</span>
00204 <span class="comment">                 * Move after CRLF</span>
00205 <span class="comment">                 */</span>
00206                 <span class="keywordflow">if</span> (*(WORD UNALIGNED *)(pText - 1) == 0x0A0D)
00207                     ich++;
00208                 <span class="keywordflow">else</span> {
00209 
00210                     <span class="comment">/*</span>
00211 <span class="comment">                     * Check for CRCRLF</span>
00212 <span class="comment">                     */</span>
00213                     <span class="keywordflow">if</span> (ich &amp;&amp; *(WORD UNALIGNED *)pText == 0x0A0D &amp;&amp; *(pText - 1) == 0x0D)
00214                         ich += 2;
00215                 }
00216                 <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
00217             } <span class="keywordflow">else</span> { <span class="comment">// !fAnsi</span>
00218                 LPWSTR pwText;
00219                 pwText = (LPWSTR)<a class="code" href="../../d6/d0/usercli_8h.html#a433">ECLock</a>(ped) + ich;
00220 
00221                 <span class="comment">/*</span>
00222 <span class="comment">                 * Move after CRLF</span>
00223 <span class="comment">                 */</span>
00224                 <span class="keywordflow">if</span> (*(pwText - 1) == 0x0D &amp;&amp; *pwText == 0x0A)
00225                     ich++;
00226                 <span class="keywordflow">else</span> {
00227 
00228                     <span class="comment">/*</span>
00229 <span class="comment">                     * Check for CRCRLF</span>
00230 <span class="comment">                     */</span>
00231                     <span class="keywordflow">if</span> (ich &amp;&amp; *(pwText - 1) == 0x0D &amp;&amp; *pwText == 0x0D &amp;&amp;
00232                             *(pwText + 1) == 0x0A)
00233                         ich += 2;
00234                 }
00235                 <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
00236             }
00237         }
00238     }
00239     <span class="keywordflow">return</span> (ich);
00240 }
00241 
00242 <span class="comment">/***************************************************************************\</span>
00243 <span class="comment">* MLMoveSelectionRestricted AorW</span>
00244 <span class="comment">*</span>
00245 <span class="comment">* Moves the selection like MLMoveSelection, but also obeys limitations</span>
00246 <span class="comment">* imposed by some languages such as Thai, where the cursor cannot stop</span>
00247 <span class="comment">* between a character and it's attached vowel or tone marks.</span>
00248 <span class="comment">*</span>
00249 <span class="comment">* Only called if the language pack is loaded.</span>
00250 <span class="comment">*</span>
00251 <span class="comment">\***************************************************************************/</span>
00252 
00253 <span class="comment">/***************************************************************************\</span>
00254 <span class="comment">* MLMoveSelectionRestricted AorW</span>
00255 <span class="comment">*</span>
00256 <span class="comment">* Moves the selection like MLMoveSelection, but also obeys limitations</span>
00257 <span class="comment">* imposed by some languages such as Thai, where the cursor cannot stop</span>
00258 <span class="comment">* between a character and it's attached vowel or tone marks.</span>
00259 <span class="comment">*</span>
00260 <span class="comment">* Only called if the language pack is loaded.</span>
00261 <span class="comment">*</span>
00262 <span class="comment">\***************************************************************************/</span>
00263 
<a name="l00264"></a><a class="code" href="../../d1/d5/editml_8c.html#a7">00264</a> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> <a class="code" href="../../d1/d5/editml_8c.html#a7">MLMoveSelectionRestricted</a>(
00265     <a class="code" href="../../d3/d4/structtagED.html">PED</a>  ped,
00266     ICH  ich,
00267     BOOL fLeft)
00268 {
00269     PSTR pText;
00270     HDC  hdc;
00271     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>  ichResult;
00272 
00273     pText = <a class="code" href="../../d6/d0/usercli_8h.html#a433">ECLock</a>(ped);
00274     hdc = <a class="code" href="../../d6/d0/usercli_8h.html#a451">ECGetEditDC</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00275     ichResult = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>-&gt;<a class="code" href="../../d2/d0/structtagLPKEDITCALLOUT.html#o7">EditMoveSelection</a>(ped, hdc, pText, ich, fLeft);
00276     <a class="code" href="../../d6/d0/usercli_8h.html#a452">ECReleaseEditDC</a>(ped, hdc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00277     <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
00278 
00279     <span class="keywordflow">return</span> ichResult;
00280 }
00281 
00282 
00283 <span class="comment">/***************************************************************************\</span>
00284 <span class="comment">* MLSetCaretPosition AorW</span>
00285 <span class="comment">*</span>
00286 <span class="comment">* If the window has the focus, find where the caret belongs and move</span>
00287 <span class="comment">* it there.</span>
00288 <span class="comment">*</span>
00289 <span class="comment">* History:</span>
00290 <span class="comment">\***************************************************************************/</span>
00291 
<a name="l00292"></a><a class="code" href="../../d6/d0/usercli_8h.html#a493">00292</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a493">MLSetCaretPosition</a>(
00293     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
00294     HDC hdc)
00295 {
00296     POINT position;
00297     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> prevLine;
00298     <span class="keywordtype">int</span>  x = -20000;
00299     <span class="keywordtype">int</span>  y = -20000;
00300 
00301     <span class="comment">/*</span>
00302 <span class="comment">     * We will only position the caret if we have the focus since we don't want</span>
00303 <span class="comment">     * to move the caret while another window could own it.</span>
00304 <span class="comment">     */</span>
00305     <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o23">fFocus</a> || !<a class="code" href="../../d6/d9/rtl_2wow_8c.html#a17">_IsWindowVisible</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o15">pwnd</a>))
00306          <span class="keywordflow">return</span>;
00307 
00308     <span class="comment">/*</span>
00309 <span class="comment">     * Find the position of the caret</span>
00310 <span class="comment">     */</span>
00311     <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o40">fCaretHidden</a> &amp;&amp;
00312         ((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>) ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o8">iCaretLine</a> &gt;= ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o9">ichScreenStart</a>) &amp;&amp;
00313         ((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>) ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o8">iCaretLine</a> &lt;  (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o9">ichScreenStart</a> + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o10">ichLinesOnScreen</a>))) {
00314 
00315         RECT    rcRealFmt;
00316 
00317         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o44">f40Compat</a>)
00318         {
00319             <a class="code" href="../../d3/d9/client_2wow_8c.html#a24">GetClientRect</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, &amp;rcRealFmt);
00320             <a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rcRealFmt, &amp;rcRealFmt, &amp;ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>);
00321         } <span class="keywordflow">else</span> {
00322             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rcRealFmt, &amp;ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>);
00323         }
00324 
00325         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o4">cLines</a> - 1 != ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o8">iCaretLine</a> &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> == ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o8">iCaretLine</a> + 1]) {
00326             prevLine = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00327         } <span class="keywordflow">else</span> {
00328             prevLine = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00329         }
00330 
00331         <a class="code" href="../../d6/d0/usercli_8h.html#a494">MLIchToXYPos</a>(ped, hdc, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>, prevLine, &amp;position);
00332 
00333         <span class="keywordflow">if</span> ( (position.y &gt;= rcRealFmt.top) &amp;&amp;
00334              (position.y &lt;= rcRealFmt.bottom - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o68">lineHeight</a>)) {
00335             <span class="keywordtype">int</span> xPos = position.x;
00336             <span class="keywordtype">int</span> cxCaret = <a class="code" href="../../d6/d0/usercli_8h.html#a149">ECGetCaretWidth</a>();
00337 
00338             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o34">fWrap</a> ||
00339                 ((xPos &gt; (rcRealFmt.left - cxCaret)) &amp;&amp;
00340                  (xPos &lt;= rcRealFmt.right))) {
00341                 <span class="comment">// Make sure the caret is in the visible region if word</span>
00342                 <span class="comment">// wrapping. This is so that the caret will be visible if the</span>
00343                 <span class="comment">// line ends with a space.</span>
00344                 x = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(xPos, rcRealFmt.left);
00345                 x = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(x, rcRealFmt.right - cxCaret);
00346                 y = position.y;
00347             }
00348         }
00349     }
00350 
00351     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>) {
00352         <a class="code" href="../../d6/d0/usercli_8h.html#a226">NtUserSetCaretPos</a>(x + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o86">iCaretOffset</a>, y);
00353     } <span class="keywordflow">else</span> {
00354         <a class="code" href="../../d6/d0/usercli_8h.html#a226">NtUserSetCaretPos</a>(x, y);
00355     }
00356 
00357     <span class="comment">// FE_IME : MLSetCaretPosition -- ImmSetCompositionWindow(CFS_RECT)</span>
00358     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a312">fpImmIsIME</a>(<a class="code" href="../../d6/d0/usercli_8h.html#a151">THREAD_HKL</a>())) {
00359         <span class="keywordflow">if</span> (x != -20000 &amp;&amp; y != -20000) {
00360             <a class="code" href="../../d6/d0/usercli_8h.html#a471">ECImmSetCompositionWindow</a>(ped, x, y);
00361         }
00362     }
00363 }
00364 
00365 <span class="comment">/***************************************************************************\</span>
00366 <span class="comment">* MLLine</span>
00367 <span class="comment">*</span>
00368 <span class="comment">* Returns the length of the line (cch) given by lineNumber ignoring any</span>
00369 <span class="comment">* CRLFs in the line.</span>
00370 <span class="comment">*</span>
00371 <span class="comment">* History:</span>
00372 <span class="comment">\***************************************************************************/</span>
00373 
<a name="l00374"></a><a class="code" href="../../d6/d0/usercli_8h.html#a498">00374</a> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> <a class="code" href="../../d6/d0/usercli_8h.html#a498">MLLine</a>(
00375     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
00376     ICH lineNumber)
00377 {
00378     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> result;
00379 
00380     UserAssert(lineNumber &lt; ped-&gt;cLines);
00381 
00382     <span class="keywordflow">if</span> (lineNumber &gt;= ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o4">cLines</a>)
00383         <span class="keywordflow">return</span> (0);
00384 
00385     <span class="keywordflow">if</span> (lineNumber == ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o4">cLines</a> - 1) {
00386 
00387         <span class="comment">/*</span>
00388 <span class="comment">         * Since we can't have a CRLF on the last line</span>
00389 <span class="comment">         */</span>
00390         <span class="keywordflow">return</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a> - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o4">cLines</a> - 1]);
00391     } <span class="keywordflow">else</span> {
00392         result = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[lineNumber + 1] - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[lineNumber];
00393         RIPMSG1(RIP_VERBOSE, <span class="stringliteral">"MLLine result=%d\n"</span>, result);
00394 
00395         <span class="comment">/*</span>
00396 <span class="comment">         * Now check for CRLF or CRCRLF at end of line</span>
00397 <span class="comment">         */</span>
00398         <span class="keywordflow">if</span> (result &gt; 1) {
00399             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>) {
00400                 LPSTR pText;
00401 
00402                 pText = <a class="code" href="../../d6/d0/usercli_8h.html#a433">ECLock</a>(ped) + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[lineNumber + 1] - 2;
00403                 <span class="keywordflow">if</span> (*(WORD UNALIGNED *)pText == 0x0A0D) {
00404                     result -= 2;
00405                     <span class="keywordflow">if</span> (result &amp;&amp; *(--pText) == 0x0D)
00406                         <span class="comment">/*</span>
00407 <span class="comment">                         * In case there was a CRCRLF</span>
00408 <span class="comment">                         */</span>
00409                         result--;
00410                 }
00411             } <span class="keywordflow">else</span> { <span class="comment">// !fAnsi</span>
00412                 LPWSTR pwText;
00413 
00414                 pwText = (LPWSTR)<a class="code" href="../../d6/d0/usercli_8h.html#a433">ECLock</a>(ped) +
00415                         (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[lineNumber + 1] - 2);
00416                 <span class="keywordflow">if</span> (*(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> UNALIGNED *)pwText == 0x000A000D) {
00417                     result = result - 2;
00418                     <span class="keywordflow">if</span> (result &amp;&amp; *(--pwText) == 0x0D)
00419                         <span class="comment">/*</span>
00420 <span class="comment">                         * In case there was a CRCRLF</span>
00421 <span class="comment">                         */</span>
00422                         result--;
00423                 }
00424 
00425             }
00426             <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
00427         }
00428     }
00429     <span class="keywordflow">return</span> (result);
00430 }
00431 
00432 
00433 <span class="comment">/***************************************************************************\</span>
00434 <span class="comment">* MLIchToLine AorW</span>
00435 <span class="comment">*</span>
00436 <span class="comment">* Returns the line number (starting from 0) which contains the given</span>
00437 <span class="comment">* character index. If ich is -1, return the line the first char in the</span>
00438 <span class="comment">* selection is on (the caret if no selection)</span>
00439 <span class="comment">*</span>
00440 <span class="comment">* History:</span>
00441 <span class="comment">\***************************************************************************/</span>
00442 
<a name="l00443"></a><a class="code" href="../../d6/d0/usercli_8h.html#a495">00443</a> <span class="keywordtype">int</span> <a class="code" href="../../d6/d0/usercli_8h.html#a495">MLIchToLine</a>(
00444     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
00445     ICH ich)
00446 {
00447     <span class="keywordtype">int</span> iLo, iHi, iLine;
00448 
00449     iLo = 0;
00450     iHi = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o4">cLines</a>;
00451 
00452     <span class="keywordflow">if</span> (ich == (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>)-1)
00453         ich = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a>;
00454 
00455     <span class="keywordflow">while</span> (iLo &lt; iHi - 1) {
00456         iLine = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>((iHi - iLo)/2, 1) + iLo;
00457 
00458         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[iLine] &gt; ich) {
00459             iHi = iLine;
00460         } <span class="keywordflow">else</span> {
00461             iLo = iLine;
00462         }
00463     }
00464 
00465     <span class="keywordflow">return</span> iLo;
00466 }
00467 
00468 <span class="comment">/***************************************************************************\</span>
00469 <span class="comment">* MLIchToYPos</span>
00470 <span class="comment">*</span>
00471 <span class="comment">* Given an ich, return its y coordinate with respect to the top line</span>
00472 <span class="comment">* displayed in the window. If prevLine is TRUE and if the ich is at the</span>
00473 <span class="comment">* beginning of the line, return the y coordinate of the</span>
00474 <span class="comment">* previous line (if it is not a CRLF).</span>
00475 <span class="comment">*</span>
00476 <span class="comment">* Added for the LPK (3Dec96) - with an LPK installed, calculating X position is</span>
00477 <span class="comment">* a far more processor intensive job. Where only the Y position is required</span>
00478 <span class="comment">* this routine should be called instead of MLIchToXYPos.</span>
00479 <span class="comment">*</span>
00480 <span class="comment">* Called only when LPK installed.</span>
00481 <span class="comment">*</span>
00482 <span class="comment">\***************************************************************************/</span>
00483 
00484 
00485 <span class="comment">/***************************************************************************\</span>
00486 <span class="comment">* MLIchToYPos</span>
00487 <span class="comment">*</span>
00488 <span class="comment">* Given an ich, return its y coordinate with respect to the top line</span>
00489 <span class="comment">* displayed in the window. If prevLine is TRUE and if the ich is at the</span>
00490 <span class="comment">* beginning of the line, return the y coordinate of the</span>
00491 <span class="comment">* previous line (if it is not a CRLF).</span>
00492 <span class="comment">*</span>
00493 <span class="comment">* Added for the LPK (3Dec96) - with an LPK installed, calculating X position is</span>
00494 <span class="comment">* a far more processor intensive job. Where only the Y position is required</span>
00495 <span class="comment">* this routine should be called instead of MLIchToXYPos.</span>
00496 <span class="comment">*</span>
00497 <span class="comment">* Called only when LPK installed.</span>
00498 <span class="comment">*</span>
00499 <span class="comment">\***************************************************************************/</span>
00500 
00501 
<a name="l00502"></a><a class="code" href="../../d1/d5/editml_8c.html#a11">00502</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> <a class="code" href="../../d1/d5/editml_8c.html#a11">MLIchToYPos</a>(
00503     <a class="code" href="../../d3/d4/structtagED.html">PED</a>  ped,
00504     ICH  ich,
00505     BOOL prevLine)
00506 {
00507     <span class="keywordtype">int</span>  iline;
00508     <span class="keywordtype">int</span>  yPosition;
00509     PSTR pText;
00510 
00511     <span class="comment">/*</span>
00512 <span class="comment">     * Determine what line the character is on</span>
00513 <span class="comment">     */</span>
00514     iline = <a class="code" href="../../d6/d0/usercli_8h.html#a495">MLIchToLine</a>(ped, ich);
00515 
00516     <span class="comment">/*</span>
00517 <span class="comment">     * Calc. the yPosition now. Note that this may change by the height of one</span>
00518 <span class="comment">     * char if the prevLine flag is set and the ICH is at the beginning of a</span>
00519 <span class="comment">     * line.</span>
00520 <span class="comment">     */</span>
00521     yPosition = (iline - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o9">ichScreenStart</a>) * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o68">lineHeight</a> + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.top;
00522 
00523     pText = <a class="code" href="../../d6/d0/usercli_8h.html#a433">ECLock</a>(ped);
00524     <span class="keywordflow">if</span> (prevLine &amp;&amp; iline &amp;&amp; (ich == ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[iline]) &amp;&amp;
00525             (!<a class="code" href="../../d6/d0/usercli_8h.html#a154">AWCOMPARECHAR</a>(ped, pText + (ich - 2) * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>, 0x0D) ||
00526              !<a class="code" href="../../d6/d0/usercli_8h.html#a154">AWCOMPARECHAR</a>(ped, pText + (ich - 1) * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>, 0x0A))) {
00527 
00528         <span class="comment">/*</span>
00529 <span class="comment">         * First char in the line. We want Y position of the previous</span>
00530 <span class="comment">         * line if we aren't at the 0th line.</span>
00531 <span class="comment">         */</span>
00532         iline--;
00533 
00534         yPosition = yPosition - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o68">lineHeight</a>;
00535     }
00536     <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
00537 
00538     <span class="keywordflow">return</span> yPosition;
00539 }
00540 
00541 <span class="comment">/***************************************************************************\</span>
00542 <span class="comment">* MLIchToXYPos</span>
00543 <span class="comment">*</span>
00544 <span class="comment">* Given an ich, return its x,y coordinates with respect to the top</span>
00545 <span class="comment">* left character displayed in the window. Returns the coordinates of the top</span>
00546 <span class="comment">* left position of the char. If prevLine is TRUE then if the ich is at the</span>
00547 <span class="comment">* beginning of the line, we will return the coordinates to the right of the</span>
00548 <span class="comment">* last char on the previous line (if it is not a CRLF).</span>
00549 <span class="comment">*</span>
00550 <span class="comment">* History:</span>
00551 <span class="comment">\***************************************************************************/</span>
00552 
<a name="l00553"></a><a class="code" href="../../d6/d0/usercli_8h.html#a494">00553</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a494">MLIchToXYPos</a>(
00554     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
00555     HDC hdc,
00556     ICH ich,
00557     BOOL prevLine,
00558     LPPOINT ppt)
00559 {
00560     <span class="keywordtype">int</span> iline;
00561     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> cch;
00562     <span class="keywordtype">int</span> xPosition, yPosition;
00563     <span class="keywordtype">int</span> xOffset;
00564 
00565     <span class="comment">/*</span>
00566 <span class="comment">     * For horizontal scroll displacement on left justified text and</span>
00567 <span class="comment">     * for indent on centered or right justified text</span>
00568 <span class="comment">     */</span>
00569     PSTR pText, pTextStart, pLineStart;
00570 
00571     <span class="comment">/*</span>
00572 <span class="comment">     * Determine what line the character is on</span>
00573 <span class="comment">     */</span>
00574     iline = <a class="code" href="../../d6/d0/usercli_8h.html#a495">MLIchToLine</a>(ped, ich);
00575 
00576     <span class="comment">/*</span>
00577 <span class="comment">     * Calc. the yPosition now. Note that this may change by the height of one</span>
00578 <span class="comment">     * char if the prevLine flag is set and the ICH is at the beginning of a</span>
00579 <span class="comment">     * line.</span>
00580 <span class="comment">     */</span>
00581     yPosition = (iline - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o9">ichScreenStart</a>) * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o68">lineHeight</a> + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.top;
00582 
00583     <span class="comment">/*</span>
00584 <span class="comment">     * Now determine the xPosition of the character</span>
00585 <span class="comment">     */</span>
00586     pTextStart = <a class="code" href="../../d6/d0/usercli_8h.html#a433">ECLock</a>(ped);
00587 
00588     <span class="keywordflow">if</span> (prevLine &amp;&amp; iline &amp;&amp; (ich == ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[iline]) &amp;&amp;
00589             (!<a class="code" href="../../d6/d0/usercli_8h.html#a154">AWCOMPARECHAR</a>(ped, pTextStart + (ich - 2) * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>, 0x0D) ||
00590             !<a class="code" href="../../d6/d0/usercli_8h.html#a154">AWCOMPARECHAR</a>(ped, pTextStart + (ich - 1) * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>, 0x0A))) {
00591 
00592         <span class="comment">/*</span>
00593 <span class="comment">         * First char in the line. We want text extent upto end of the previous</span>
00594 <span class="comment">         * line if we aren't at the 0th line.</span>
00595 <span class="comment">         */</span>
00596         iline--;
00597 
00598         yPosition = yPosition - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o68">lineHeight</a>;
00599         pLineStart = pTextStart + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[iline] * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>;
00600 
00601         <span class="comment">/*</span>
00602 <span class="comment">         * Note that we are taking the position in front of any CRLFs in the</span>
00603 <span class="comment">         * text.</span>
00604 <span class="comment">         */</span>
00605         cch = <a class="code" href="../../d6/d0/usercli_8h.html#a498">MLLine</a>(ped, iline);
00606 
00607     } <span class="keywordflow">else</span> {
00608 
00609         pLineStart = pTextStart + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[iline] * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>;
00610         pText = pTextStart + ich * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>;
00611 
00612         <span class="comment">/*</span>
00613 <span class="comment">         * Strip off CRLF or CRCRLF. Note that we may be pointing to a CR but in</span>
00614 <span class="comment">         * which case we just want to strip off a single CR or 2 CRs.</span>
00615 <span class="comment">         */</span>
00616 
00617         <span class="comment">/*</span>
00618 <span class="comment">         * We want pText to point to the first CR at the end of the line if</span>
00619 <span class="comment">         * there is one. Thus, we will get an xPosition to the right of the last</span>
00620 <span class="comment">         * visible char on the line otherwise we will be to the left of</span>
00621 <span class="comment">         * character ich.</span>
00622 <span class="comment">         */</span>
00623 
00624         <span class="comment">/*</span>
00625 <span class="comment">         * Check if we at the end of text</span>
00626 <span class="comment">         */</span>
00627         <span class="keywordflow">if</span> (ich &lt; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>) {
00628             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>) {
00629                 <span class="keywordflow">if</span> (ich &amp;&amp; *(WORD UNALIGNED *)(pText - 1) == 0x0A0D) {
00630                     pText--;
00631                     <span class="keywordflow">if</span> (ich &gt; 2 &amp;&amp; *(pText - 1) == 0x0D)
00632                         pText--;
00633                 }
00634             } <span class="keywordflow">else</span> {
00635                 LPWSTR pwText = (LPWSTR)pText;
00636 
00637                 <span class="keywordflow">if</span> (ich &amp;&amp; *(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> UNALIGNED *)(pwText - 1) == 0x000A000D) {
00638                     pwText--;
00639                     <span class="keywordflow">if</span> (ich &gt; 2 &amp;&amp; *(pwText - 1) == 0x0D)
00640                         pwText--;
00641                 }
00642                 pText = (LPSTR)pwText;
00643             }
00644         }
00645 
00646         <span class="keywordflow">if</span> (pText &lt; pLineStart)
00647             pText = pLineStart;
00648 
00649         cch = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>)(pText - pLineStart)/ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>;
00650     }
00651 
00652     <span class="comment">/*</span>
00653 <span class="comment">     * Find out how many pixels we indent the line for funny formats</span>
00654 <span class="comment">     */</span>
00655     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>) {
00656         <span class="comment">/*</span>
00657 <span class="comment">         * Must find position at start of character offset cch from start of line.</span>
00658 <span class="comment">         * This depends on the layout and the reading order</span>
00659 <span class="comment">         */</span>
00660         xPosition = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>-&gt;<a class="code" href="../../d2/d0/structtagLPKEDITCALLOUT.html#o1">EditIchToXY</a>(
00661                           ped, hdc, pLineStart, <a class="code" href="../../d6/d0/usercli_8h.html#a498">MLLine</a>(ped, iline), cch);
00662     } <span class="keywordflow">else</span> {
00663         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o62">format</a> != ES_LEFT) {
00664             xOffset = <a class="code" href="../../d6/d0/usercli_8h.html#a500">MLCalcXOffset</a>(ped, hdc, iline);
00665         } <span class="keywordflow">else</span> {
00666             xOffset = -(<span class="keywordtype">int</span>)ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o11">xOffset</a>;
00667         }
00668 
00669         xPosition = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.left + xOffset +
00670                 <a class="code" href="../../d1/d5/editml_8c.html#a3">MLGetLineWidth</a>(hdc, pLineStart, cch, ped);
00671     }
00672 
00673     <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
00674     ppt-&gt;x = xPosition;
00675     ppt-&gt;y = yPosition;
00676     <span class="keywordflow">return</span> ;
00677 }
00678 
00679 <span class="comment">/***************************************************************************\</span>
00680 <span class="comment">* MLMouseToIch AorW</span>
00681 <span class="comment">*</span>
00682 <span class="comment">* Returns the closest cch to where the mouse point is.  Also optionally</span>
00683 <span class="comment">* returns lineindex in pline (So that we can tell if we are at the beginning</span>
00684 <span class="comment">* of the line or end of the previous line.)</span>
00685 <span class="comment">*</span>
00686 <span class="comment">* History:</span>
00687 <span class="comment">\***************************************************************************/</span>
00688 
<a name="l00689"></a><a class="code" href="../../d1/d5/editml_8c.html#a13">00689</a> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> <a class="code" href="../../d1/d5/editml_8c.html#a13">MLMouseToIch</a>(
00690     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
00691     HDC hdc,
00692     LPPOINT mousePt,
00693     LPICH pline)
00694 {
00695     <span class="keywordtype">int</span> xOffset;
00696     LPSTR pLineStart;
00697     <span class="keywordtype">int</span> height = mousePt-&gt;y;
00698     <span class="keywordtype">int</span> line; <span class="comment">//WASINT</span>
00699     <span class="keywordtype">int</span> width = mousePt-&gt;x;
00700     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> cch;
00701     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> cLineLength;
00702     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> cLineLengthNew;
00703     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> cLineLengthHigh;
00704     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> cLineLengthLow;
00705     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> cLineLengthTemp;
00706     <span class="keywordtype">int</span> textWidth;
00707     <span class="keywordtype">int</span> iCurWidth;
00708     <span class="keywordtype">int</span> lastHighWidth, lastLowWidth;
00709 
00710     <span class="comment">/*</span>
00711 <span class="comment">     * First determine which line the mouse is pointing to.</span>
00712 <span class="comment">     */</span>
00713     line = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o9">ichScreenStart</a>;
00714     <span class="keywordflow">if</span> (height &lt;= ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.top) {
00715 
00716         <span class="comment">/*</span>
00717 <span class="comment">         * Either return 0 (the very first line, or one line before the top line</span>
00718 <span class="comment">         * on the screen. Note that these are signed mins and maxes since we</span>
00719 <span class="comment">         * don't expect (or allow) more than 32K lines.</span>
00720 <span class="comment">         */</span>
00721         line = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(0, line-1);
00722     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (height &gt;= ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.bottom) {
00723 
00724         <span class="comment">/*</span>
00725 <span class="comment">         * Are we below the last line displayed</span>
00726 <span class="comment">         */</span>
00727         line = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(line+(<span class="keywordtype">int</span>)ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o10">ichLinesOnScreen</a>, (<span class="keywordtype">int</span>)(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o4">cLines</a>-1));
00728     } <span class="keywordflow">else</span> {
00729 
00730         <span class="comment">/*</span>
00731 <span class="comment">         * We are somewhere on a line visible on screen</span>
00732 <span class="comment">         */</span>
00733         line = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(line + (<span class="keywordtype">int</span>)((height - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.top) / ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o68">lineHeight</a>),
00734                 (<span class="keywordtype">int</span>)(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o4">cLines</a> - 1));
00735     }
00736 
00737     <span class="comment">/*</span>
00738 <span class="comment">     * Now determine what horizontal character the mouse is pointing to.</span>
00739 <span class="comment">     */</span>
00740     pLineStart = <a class="code" href="../../d6/d0/usercli_8h.html#a433">ECLock</a>(ped) + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[line] * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>;
00741     cLineLength = <a class="code" href="../../d6/d0/usercli_8h.html#a498">MLLine</a>(ped, line); <span class="comment">/* Length is sans CRLF or CRCRLF */</span>
00742     RIPMSG3(RIP_VERBOSE, <span class="stringliteral">"MLLine(ped=%x, line=%d) returned %d\n"</span>, ped, line, cLineLength);
00743     UserAssert((<span class="keywordtype">int</span>)cLineLength &gt;= 0);
00744 
00745     <span class="comment">/*</span>
00746 <span class="comment">     * If the language pack is loaded, visual and logical character order</span>
00747 <span class="comment">     * may differ.</span>
00748 <span class="comment">     */</span>
00749     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>) {
00750         <span class="comment">/*</span>
00751 <span class="comment">         * Use the language pack to find the character nearest the cursor.</span>
00752 <span class="comment">         */</span>
00753         cch = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[line] + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>-&gt;<a class="code" href="../../d2/d0/structtagLPKEDITCALLOUT.html#o2">EditMouseToIch</a>
00754             (ped, hdc, pLineStart, cLineLength, width);
00755     } <span class="keywordflow">else</span> {
00756         <span class="comment">/*</span>
00757 <span class="comment">         * xOffset will be a negative value for center and right justified lines.</span>
00758 <span class="comment">         * ie. We will just displace the lines left by the amount of indent for</span>
00759 <span class="comment">         * right and center justification. Note that ped-&gt;xOffset will be 0 for</span>
00760 <span class="comment">         * these lines since we don't support horizontal scrolling with them.</span>
00761 <span class="comment">         */</span>
00762         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o62">format</a> != ES_LEFT) {
00763             xOffset = <a class="code" href="../../d6/d0/usercli_8h.html#a500">MLCalcXOffset</a>(ped, hdc, line);
00764         } <span class="keywordflow">else</span> {
00765             <span class="comment">/*</span>
00766 <span class="comment">             * So that we handle a horizontally scrolled window for left justified</span>
00767 <span class="comment">             * text.</span>
00768 <span class="comment">             */</span>
00769             xOffset = 0;
00770         }
00771 
00772         width = width - xOffset;
00773 
00774         <span class="comment">/*</span>
00775 <span class="comment">         * The code below is tricky... I depend on the fact that ped-&gt;xOffset is 0</span>
00776 <span class="comment">         * for right and center justified lines</span>
00777 <span class="comment">         */</span>
00778 
00779         <span class="comment">/*</span>
00780 <span class="comment">         * Now find out how many chars fit in the given width</span>
00781 <span class="comment">         */</span>
00782         <span class="keywordflow">if</span> (width &gt;= ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.right) {
00783 
00784             <span class="comment">/*</span>
00785 <span class="comment">             * Return 1+last char in line or one plus the last char visible</span>
00786 <span class="comment">             */</span>
00787             cch = <a class="code" href="../../d6/d0/usercli_8h.html#a443">ECCchInWidth</a>(ped, hdc, pLineStart, cLineLength,
00788                     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.right - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.left + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o11">xOffset</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00789             <span class="comment">//</span>
00790             <span class="comment">// Consider DBCS in case of width &gt;= ped-&gt;rcFmt.right</span>
00791             <span class="comment">//</span>
00792             <span class="comment">// Since ECCchInWidth and MLLineLength takes care of DBCS, we only need to</span>
00793             <span class="comment">// worry about if the last character is a double byte character or not.</span>
00794             <span class="comment">//</span>
00795             <span class="comment">// cch = ped-&gt;chLines[line] + min( ECNextIch(ped, pLineStart, cch), cLineLength);</span>
00796             <span class="comment">//</span>
00797             <span class="comment">// we need to adjust the position. LiZ -- 5/5/93</span>
00798             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o32">fDBCS</a>) {
00799                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> cch2 = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(cch+1,cLineLength);
00800                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a461">ECAdjustIch</a>(ped, pLineStart, cch2) != cch2) {
00801                     <span class="comment">/* Displayed character on the right edge is DBCS */</span>
00802                     cch = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(cch+2,cLineLength);
00803                 } <span class="keywordflow">else</span> {
00804                     cch = cch2;
00805                 }
00806                 cch += ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[line];
00807             } <span class="keywordflow">else</span> {
00808                 cch = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[line] + <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(cch + 1, cLineLength);
00809             }
00810         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (width &lt;= ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.left + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o67">aveCharWidth</a> / 2) {
00811 
00812             <span class="comment">/*</span>
00813 <span class="comment">             * Return first char in line or one minus first char visible. Note that</span>
00814 <span class="comment">             * ped-&gt;xOffset is 0 for right and centered text so we will just return</span>
00815 <span class="comment">             * the first char in the string for them. (Allow a avecharwidth/2</span>
00816 <span class="comment">             * positioning border so that the user can be a little off...</span>
00817 <span class="comment">             */</span>
00818             cch = <a class="code" href="../../d6/d0/usercli_8h.html#a443">ECCchInWidth</a>(ped, hdc, pLineStart, cLineLength,
00819                     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o11">xOffset</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00820             <span class="keywordflow">if</span> (cch)
00821                 cch--;
00822 
00823             cch = <a class="code" href="../../d6/d0/usercli_8h.html#a461">ECAdjustIch</a>( ped, pLineStart, cch );
00824             cch += ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[line];
00825         } <span class="keywordflow">else</span> {
00826 
00827             <span class="keywordflow">if</span> (cLineLength == 0) {
00828                 cch = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[line];
00829                 <span class="keywordflow">goto</span> edUnlock;
00830             }
00831 
00832             iCurWidth = width + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o11">xOffset</a> - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.left;
00833             <span class="comment">/*</span>
00834 <span class="comment">             * If the user clicked past the end of the text, return the last character</span>
00835 <span class="comment">             */</span>
00836             lastHighWidth = <a class="code" href="../../d1/d5/editml_8c.html#a3">MLGetLineWidth</a>(hdc, pLineStart, cLineLength, ped);
00837             <span class="keywordflow">if</span> (lastHighWidth &lt;= iCurWidth) {
00838                 cLineLengthNew = cLineLength;
00839                 <span class="keywordflow">goto</span> edAdjust;
00840             }
00841             <span class="comment">/*</span>
00842 <span class="comment">             * Now the mouse is somewhere on the visible portion of the text</span>
00843 <span class="comment">             * remember cch contains the length of the line.</span>
00844 <span class="comment">             */</span>
00845             cLineLengthLow = 0;
00846             cLineLengthHigh = cLineLength + 1;
00847             lastLowWidth = 0;
00848 
00849             <span class="keywordflow">while</span> (cLineLengthLow &lt; cLineLengthHigh - 1) {
00850 
00851                 cLineLengthNew = (cLineLengthHigh + cLineLengthLow) / 2;
00852 
00853                 <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o32">fDBCS</a>) {
00854                     <span class="comment">/*</span>
00855 <span class="comment">                     * MLGetLineWidth returns meaningless value for truncated DBCS.</span>
00856 <span class="comment">                     */</span>
00857                     cLineLengthTemp = <a class="code" href="../../d6/d0/usercli_8h.html#a461">ECAdjustIch</a>(ped, pLineStart, cLineLengthNew);
00858                     textWidth = <a class="code" href="../../d1/d5/editml_8c.html#a3">MLGetLineWidth</a>(hdc, pLineStart, cLineLengthTemp, ped);
00859 
00860                 } <span class="keywordflow">else</span> {
00861                     textWidth = <a class="code" href="../../d1/d5/editml_8c.html#a3">MLGetLineWidth</a>(hdc, pLineStart, cLineLengthNew, ped);
00862                 }
00863 
00864                 <span class="keywordflow">if</span> (textWidth &gt; iCurWidth) {
00865                     cLineLengthHigh = cLineLengthNew;
00866                     lastHighWidth = textWidth;
00867                 } <span class="keywordflow">else</span> {
00868                     cLineLengthLow = cLineLengthNew;
00869                     lastLowWidth = textWidth;
00870                 }
00871             }
00872 
00873             <span class="comment">/*</span>
00874 <span class="comment">             * When the while ends, you can't know the exact desired position.</span>
00875 <span class="comment">             * Try to see if the mouse pointer was on the farest half</span>
00876 <span class="comment">             * of the char we got and if so, adjust cch.</span>
00877 <span class="comment">             */</span>
00878             <span class="keywordflow">if</span> (cLineLengthLow == cLineLengthNew) {
00879                 <span class="comment">/*</span>
00880 <span class="comment">                 * Need to compare with lastHighWidth</span>
00881 <span class="comment">                 */</span>
00882                 <span class="keywordflow">if</span> ((lastHighWidth - iCurWidth) &lt; (iCurWidth - textWidth)) {
00883                     cLineLengthNew++;
00884                 }
00885             } <span class="keywordflow">else</span> {
00886                 <span class="comment">/*</span>
00887 <span class="comment">                 * Need to compare with lastLowHigh</span>
00888 <span class="comment">                 */</span>
00889                 <span class="keywordflow">if</span> ((iCurWidth - lastLowWidth) &lt; (textWidth - iCurWidth)) {
00890                     cLineLengthNew--;
00891                 }
00892             }
00893 edAdjust:
00894             cLineLength = <a class="code" href="../../d6/d0/usercli_8h.html#a461">ECAdjustIch</a>( ped, pLineStart, cLineLengthNew );
00895 
00896             cch = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[line] + cLineLength;
00897         }
00898     }
00899 edUnlock:
00900     <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
00901 
00902     <span class="keywordflow">if</span> (pline) {
00903         *pline = line;
00904     }
00905     <span class="keywordflow">return</span> cch;
00906 }
00907 
00908 <span class="comment">/***************************************************************************\</span>
00909 <span class="comment">* MLChangeSelection AorW</span>
00910 <span class="comment">*</span>
00911 <span class="comment">* Changes the current selection to have the specified starting and</span>
00912 <span class="comment">* ending values. Properly highlights the new selection and unhighlights</span>
00913 <span class="comment">* anything deselected. If NewMinSel and NewMaxSel are out of order, we swap</span>
00914 <span class="comment">* them. Doesn't update the caret position.</span>
00915 <span class="comment">*</span>
00916 <span class="comment">* History:</span>
00917 <span class="comment">\***************************************************************************/</span>
00918 
<a name="l00919"></a><a class="code" href="../../d6/d0/usercli_8h.html#a513">00919</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a513">MLChangeSelection</a>(
00920     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
00921     HDC hdc,
00922     ICH ichNewMinSel,
00923     ICH ichNewMaxSel)
00924 {
00925 
00926     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> temp;
00927     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> ichOldMinSel, ichOldMaxSel;
00928 
00929     <span class="keywordflow">if</span> (ichNewMinSel &gt; ichNewMaxSel) {
00930         temp = ichNewMinSel;
00931         ichNewMinSel = ichNewMaxSel;
00932         ichNewMaxSel = temp;
00933     }
00934     ichNewMinSel = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(ichNewMinSel, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>);
00935     ichNewMaxSel = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(ichNewMaxSel, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>);
00936 
00937     <span class="comment">/*</span>
00938 <span class="comment">     * Save the current selection</span>
00939 <span class="comment">     */</span>
00940     ichOldMinSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a>;
00941     ichOldMaxSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a>;
00942 
00943     <span class="comment">/*</span>
00944 <span class="comment">     * Set new selection</span>
00945 <span class="comment">     */</span>
00946     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a> = ichNewMinSel;
00947     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a> = ichNewMaxSel;
00948 
00949     <span class="comment">/*</span>
00950 <span class="comment">     * This finds the XOR of the old and new selection regions and redraws it.</span>
00951 <span class="comment">     * There is nothing to repaint if we aren't visible or our selection</span>
00952 <span class="comment">     * is hidden.</span>
00953 <span class="comment">     */</span>
00954     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d9/rtl_2wow_8c.html#a17">_IsWindowVisible</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o15">pwnd</a>) &amp;&amp; (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o23">fFocus</a> || ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o31">fNoHideSel</a>)) {
00955 
00956         <a class="code" href="../../d7/d8/structtagBLOCK.html">BLOCK</a> Blk[2];
00957         <span class="keywordtype">int</span> i;
00958 
00959         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o23">fFocus</a>) {
00960             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a204">NtUserHideCaret</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>);
00961         }
00962 
00963         Blk[0].<a class="code" href="../../d7/d8/structtagBLOCK.html#o0">StPos</a> = ichOldMinSel;
00964         Blk[0].<a class="code" href="../../d7/d8/structtagBLOCK.html#o1">EndPos</a> = ichOldMaxSel;
00965         Blk[1].<a class="code" href="../../d7/d8/structtagBLOCK.html#o0">StPos</a> = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a>;
00966         Blk[1].<a class="code" href="../../d7/d8/structtagBLOCK.html#o1">EndPos</a> = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a>;
00967 
00968         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a457">ECCalcChangeSelection</a>(ped, ichOldMinSel, ichOldMaxSel, (<a class="code" href="../../d7/d8/structtagBLOCK.html">LPBLOCK</a>)&amp;Blk[0], (<a class="code" href="../../d7/d8/structtagBLOCK.html">LPBLOCK</a>)&amp;Blk[1])) {
00969 
00970             <span class="comment">/*</span>
00971 <span class="comment">             * Paint both Blk[0] and Blk[1], if they exist</span>
00972 <span class="comment">             */</span>
00973             <span class="keywordflow">for</span> (i = 0; i &lt; 2; i++) {
00974                 <span class="keywordflow">if</span> (Blk[i].<a class="code" href="../../d7/d8/structtagBLOCK.html#o0">StPos</a> != 0xFFFFFFFF)
00975                     <a class="code" href="../../d6/d0/usercli_8h.html#a486">MLDrawText</a>(ped, hdc, Blk[i].StPos, Blk[i].EndPos, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00976             }
00977         }
00978 
00979         <span class="comment">/*</span>
00980 <span class="comment">         * Update caret.</span>
00981 <span class="comment">         */</span>
00982         <a class="code" href="../../d6/d0/usercli_8h.html#a493">MLSetCaretPosition</a>(ped, hdc);
00983 
00984         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o23">fFocus</a>) {
00985             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a234">NtUserShowCaret</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>);
00986         }
00987 
00988     }
00989 }
00990 
00991 
00992 <span class="comment">/**************************************************************************\</span>
00993 <span class="comment">* MLUpdateiCaretLine AorW</span>
00994 <span class="comment">*</span>
00995 <span class="comment">* This updates the ped-&gt;iCaretLine field from the ped-&gt;ichCaret;</span>
00996 <span class="comment">* Also, when the caret gets to the beginning of next line, pop it up to</span>
00997 <span class="comment">* the end of current line when inserting text;</span>
00998 <span class="comment">*</span>
00999 <span class="comment">* History</span>
01000 <span class="comment">* 4-18-91 Mikehar 31Merge</span>
01001 <span class="comment">\**************************************************************************/</span>
01002 
<a name="l01003"></a><a class="code" href="../../d6/d0/usercli_8h.html#a519">01003</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a519">MLUpdateiCaretLine</a>(<a class="code" href="../../d3/d4/structtagED.html">PED</a> ped)
01004 {
01005     PSTR pText;
01006 
01007     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o8">iCaretLine</a> = <a class="code" href="../../d6/d0/usercli_8h.html#a495">MLIchToLine</a>(ped, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>);
01008 
01009     <span class="comment">/*</span>
01010 <span class="comment">     * If caret gets to beginning of next line, pop it up to end of current line</span>
01011 <span class="comment">     * when inserting text.</span>
01012 <span class="comment">     */</span>
01013     pText = <a class="code" href="../../d6/d0/usercli_8h.html#a433">ECLock</a>(ped) +
01014             (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> - 1) * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>;
01015     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o8">iCaretLine</a> &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o8">iCaretLine</a>] == ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> &amp;&amp;
01016             (!<a class="code" href="../../d6/d0/usercli_8h.html#a154">AWCOMPARECHAR</a>(ped, pText - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>, 0x0D) ||
01017             !<a class="code" href="../../d6/d0/usercli_8h.html#a154">AWCOMPARECHAR</a>(ped, pText, 0x0A)))
01018         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o8">iCaretLine</a>--;
01019     <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
01020 }
01021 
01022 <span class="comment">/***************************************************************************\</span>
01023 <span class="comment">* MLInsertText AorW</span>
01024 <span class="comment">*</span>
01025 <span class="comment">* Adds up to cchInsert characters from lpText to the ped starting at</span>
01026 <span class="comment">* ichCaret. If the ped only allows a maximum number of characters, then we</span>
01027 <span class="comment">* will only add that many characters to the ped. The number of characters</span>
01028 <span class="comment">* actually added is return ed (could be 0). If we can't allocate the required</span>
01029 <span class="comment">* space, we notify the parent with EN_ERRSPACE and no characters are added.</span>
01030 <span class="comment">* We will rebuild the lines array as needed. fUserTyping is true if the</span>
01031 <span class="comment">* input was the result of the user typing at the keyboard. This is so we can</span>
01032 <span class="comment">* do some stuff faster since we will be getting only one or two chars of</span>
01033 <span class="comment">* input.</span>
01034 <span class="comment">*</span>
01035 <span class="comment">* History:</span>
01036 <span class="comment">* Created ???</span>
01037 <span class="comment">* 4-18-91 Mikehar Win31 Merge</span>
01038 <span class="comment">\***************************************************************************/</span>
01039 
<a name="l01040"></a><a class="code" href="../../d6/d0/usercli_8h.html#a483">01040</a> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> <a class="code" href="../../d6/d0/usercli_8h.html#a483">MLInsertText</a>(
01041     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
01042     LPSTR lpText,
01043     ICH cchInsert,
01044     BOOL fUserTyping)
01045 {
01046     HDC hdc;
01047     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> validCch = cchInsert;
01048     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> oldCaret = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>;
01049     <span class="keywordtype">int</span> oldCaretLine = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o8">iCaretLine</a>;
01050     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fCRLF = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01051     LONG ll, hl;
01052     POINT xyPosInitial;
01053     POINT xyPosFinal;
01054     HWND hwndSave = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>;
01055     <a class="code" href="../../d9/d8/structtagUNDO.html">UNDO</a> undo;
01056     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> validCchTemp;
01057 
01058     xyPosInitial.x=0;
01059     xyPosInitial.y=0;
01060     xyPosFinal.x=0;
01061     xyPosFinal.y=0;
01062 
01063     <span class="keywordflow">if</span> (validCch == 0)
01064         <span class="keywordflow">return</span> 0;
01065 
01066     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o2">cchTextMax</a> &lt;= ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>) {
01067 
01068         <span class="comment">/*</span>
01069 <span class="comment">         * When the max chars is reached already, notify parent</span>
01070 <span class="comment">         * Fix for Bug #4183 -- 02/06/91 -- SANKAR --</span>
01071 <span class="comment">         */</span>
01072         <a class="code" href="../../d6/d0/usercli_8h.html#a449">ECNotifyParent</a>(ped,EN_MAXTEXT);
01073         <span class="keywordflow">return</span> 0;
01074     }
01075 
01076     <span class="comment">/*</span>
01077 <span class="comment">     * Limit the amount of text we add</span>
01078 <span class="comment">     */</span>
01079     validCch = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(validCch, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o2">cchTextMax</a> - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>);
01080 
01081     <span class="comment">/*</span>
01082 <span class="comment">     * Make sure we don't split a CRLF in half</span>
01083 <span class="comment">     */</span>
01084     <span class="keywordflow">if</span> (validCch) {
01085         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>) {
01086             <span class="keywordflow">if</span> (*(WORD UNALIGNED *)(lpText + validCch - 1) == 0x0A0D)
01087                 validCch--;
01088         } <span class="keywordflow">else</span> {
01089             <span class="keywordflow">if</span> (*(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> UNALIGNED *)(lpText + (validCch - 1) * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>) == 0x000A000D)
01090                 validCch--;
01091         }
01092     }
01093     <span class="keywordflow">if</span> (!validCch) {
01094         <span class="comment">/*</span>
01095 <span class="comment">         * When the max chars is reached already, notify parent</span>
01096 <span class="comment">         * Fix for Bug #4183 -- 02/06/91 -- SANKAR --</span>
01097 <span class="comment">         */</span>
01098         <a class="code" href="../../d6/d0/usercli_8h.html#a449">ECNotifyParent</a>(ped,EN_MAXTEXT);
01099         <span class="keywordflow">return</span> 0;
01100     }
01101 
01102     <span class="keywordflow">if</span> (validCch == 2) {
01103         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>) {
01104             <span class="keywordflow">if</span> (*(WORD UNALIGNED *)lpText == 0x0A0D)
01105                 fCRLF = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01106         } <span class="keywordflow">else</span> {
01107             <span class="keywordflow">if</span> (*(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> UNALIGNED *)lpText == 0x000A000D)
01108                 fCRLF = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01109         }
01110     }
01111 
01112     <span class="comment">//</span>
01113     <span class="comment">// Save current undo state always, but clear it out only if !AutoVScroll</span>
01114     <span class="comment">//</span>
01115     <a class="code" href="../../d6/d0/usercli_8h.html#a445">ECSaveUndo</a>(<a class="code" href="../../d6/d0/usercli_8h.html#a85">Pundo</a>(ped), (<a class="code" href="../../d9/d8/structtagUNDO.html">PUNDO</a>)&amp;undo, !ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o29">fAutoVScroll</a>);
01116 
01117     hdc = <a class="code" href="../../d6/d0/usercli_8h.html#a451">ECGetEditDC</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01118     <span class="comment">/*</span>
01119 <span class="comment">     * We only need the y position. Since with an LPK loaded</span>
01120 <span class="comment">     * calculating the x position is an intensive job, just</span>
01121 <span class="comment">     * call MLIchToYPos.</span>
01122 <span class="comment">     */</span>
01123     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>)
01124         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>)
01125             xyPosInitial.y = <a class="code" href="../../d1/d5/editml_8c.html#a11">MLIchToYPos</a>(ped, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>-1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01126         <span class="keywordflow">else</span>
01127             <a class="code" href="../../d6/d0/usercli_8h.html#a494">MLIchToXYPos</a>(ped, hdc, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a> - 1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;xyPosInitial);
01128 
01129     <span class="comment">/*</span>
01130 <span class="comment">     * Insert the text</span>
01131 <span class="comment">     */</span>
01132     validCchTemp = validCch;    <span class="comment">// may not be needed, but just for precautions..</span>
01133     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a446">ECInsertText</a>(ped, lpText, &amp;validCchTemp)) {
01134 
01135         <span class="comment">// Restore previous undo buffer if it was cleared</span>
01136         <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o29">fAutoVScroll</a>)
01137             <a class="code" href="../../d6/d0/usercli_8h.html#a445">ECSaveUndo</a>((<a class="code" href="../../d9/d8/structtagUNDO.html">PUNDO</a>)&amp;undo, <a class="code" href="../../d6/d0/usercli_8h.html#a85">Pundo</a>(ped), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01138 
01139         <a class="code" href="../../d6/d0/usercli_8h.html#a452">ECReleaseEditDC</a>(ped, hdc, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01140         <a class="code" href="../../d6/d0/usercli_8h.html#a449">ECNotifyParent</a>(ped, EN_ERRSPACE);
01141         <span class="keywordflow">return</span> (0);
01142     }
01143 
01144 <span class="preprocessor">#if DBG</span>
01145 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (validCch != validCchTemp) {
01146         <span class="comment">/*</span>
01147 <span class="comment">         * All characters in lpText has not been inserted to ped.</span>
01148 <span class="comment">         * This could happen when cch is close to cchMax.</span>
01149 <span class="comment">         * Better revisit this after NT5 ships.</span>
01150 <span class="comment">         */</span>
01151         RIPMSG2(RIP_WARNING, <span class="stringliteral">"MLInsertText: validCch is changed (%x -&gt; %x) in ECInsertText."</span>,
01152             validCch, validCchTemp);
01153     }
01154 <span class="preprocessor">#endif</span>
01155 <span class="preprocessor"></span>
01156     <span class="comment">/*</span>
01157 <span class="comment">     * Note that ped-&gt;ichCaret is updated by ECInsertText</span>
01158 <span class="comment">     */</span>
01159     <a class="code" href="../../d6/d0/usercli_8h.html#a490">MLBuildchLines</a>(ped, (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>)oldCaretLine, (<span class="keywordtype">int</span>)validCch, fCRLF?(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)FALSE:fUserTyping, &amp;ll, &amp;hl);
01160 
01161     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>)
01162        <span class="comment">/*</span>
01163 <span class="comment">        * We only need the y position. Since with an LPK loaded</span>
01164 <span class="comment">        * calculating the x position is an intensive job, just</span>
01165 <span class="comment">        * call MLIchToYPos.</span>
01166 <span class="comment">        */</span>
01167        <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>)
01168            xyPosFinal.y = <a class="code" href="../../d1/d5/editml_8c.html#a11">MLIchToYPos</a>(ped, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>-1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01169        <span class="keywordflow">else</span>
01170            <a class="code" href="../../d6/d0/usercli_8h.html#a494">MLIchToXYPos</a>(ped, hdc, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a> - 1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,&amp;xyPosFinal);
01171 
01172     <span class="keywordflow">if</span> (xyPosFinal.y &lt; xyPosInitial.y &amp;&amp; ((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>)ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o9">ichScreenStart</a>) + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o10">ichLinesOnScreen</a> &gt;= ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o4">cLines</a> - 1) {
01173         RECT rc;
01174 
01175         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>((LPRECT)&amp;rc, (LPRECT)&amp;ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>);
01176         rc.top = xyPosFinal.y + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o68">lineHeight</a>;
01177         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>) {
01178             <span class="keywordtype">int</span> xFarOffset = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o11">xOffset</a> + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.right - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.left;
01179             <span class="comment">// Include left or right margins in display unless clipped</span>
01180             <span class="comment">// by horizontal scrolling.</span>
01181             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o80">wLeftMargin</a>) {
01182                 <span class="keywordflow">if</span> (!(   ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o62">format</a> == ES_LEFT     <span class="comment">// Only ES_LEFT (Nearside alignment) can get clipped</span>
01183                       &amp;&amp; (   (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o51">fRtoLReading</a> &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o11">xOffset</a> &gt; 0)  <span class="comment">// LTR and first char not fully in view</span>
01184                           || ( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o51">fRtoLReading</a> &amp;&amp; xFarOffset &lt; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o64">maxPixelWidth</a>)))) { <span class="comment">//RTL and last char not fully in view</span>
01185                     rc.left  -= ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o80">wLeftMargin</a>;
01186                 }
01187             }
01188 
01189             <span class="comment">// Process right margin</span>
01190             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o81">wRightMargin</a>) {
01191                 <span class="keywordflow">if</span> (!(   ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o62">format</a> == ES_LEFT     <span class="comment">// Only ES_LEFT (Nearside alignment) can get clipped</span>
01192                       &amp;&amp; (   ( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o51">fRtoLReading</a> &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o11">xOffset</a> &gt; 0)  <span class="comment">// RTL and first char not fully in view</span>
01193                           || (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o51">fRtoLReading</a> &amp;&amp; xFarOffset &lt; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o64">maxPixelWidth</a>)))) { <span class="comment">// LTR and last char not fully in view</span>
01194                     rc.right += ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o81">wRightMargin</a>;
01195                 }
01196             }
01197         }
01198         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a206">NtUserInvalidateRect</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, (LPRECT)&amp;rc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01199     }
01200 
01201     <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o29">fAutoVScroll</a>) {
01202         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o10">ichLinesOnScreen</a> &lt; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o4">cLines</a>) {
01203             <a class="code" href="../../d6/d0/usercli_8h.html#a501">MLUndo</a>(ped);
01204             <a class="code" href="../../d6/d0/usercli_8h.html#a444">ECEmptyUndo</a>(<a class="code" href="../../d6/d0/usercli_8h.html#a85">Pundo</a>(ped));
01205 
01206             <a class="code" href="../../d6/d0/usercli_8h.html#a445">ECSaveUndo</a>(&amp;undo, <a class="code" href="../../d6/d0/usercli_8h.html#a85">Pundo</a>(ped), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01207 
01208             <a class="code" href="../../d6/d0/usercli_8h.html#a219">NtUserMessageBeep</a>(0);
01209             <a class="code" href="../../d6/d0/usercli_8h.html#a452">ECReleaseEditDC</a>(ped, hdc, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01210 
01211             <span class="comment">/*</span>
01212 <span class="comment">             * When the max lines is reached already, notify parent</span>
01213 <span class="comment">             * Fix for Bug #7586 -- 10/14/91 -- SANKAR --</span>
01214 <span class="comment">             */</span>
01215             <a class="code" href="../../d6/d0/usercli_8h.html#a449">ECNotifyParent</a>(ped,EN_MAXTEXT);
01216             <span class="keywordflow">return</span> (0);
01217         } <span class="keywordflow">else</span> {
01218             <a class="code" href="../../d6/d0/usercli_8h.html#a444">ECEmptyUndo</a>(&amp;undo);
01219         }
01220     }
01221 
01222     <span class="keywordflow">if</span> (fUserTyping &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o34">fWrap</a>) {
01223         <span class="comment">//</span>
01224         <span class="comment">// To avoid oldCaret points intermediate of DBCS character,</span>
01225         <span class="comment">// adjust oldCaret position if necessary.</span>
01226         <span class="comment">//</span>
01227         <span class="comment">// !!!CR If MLBuildchLines() returns reasonable value ( and I think</span>
01228         <span class="comment">//       it does), we don't probably need this. Check this out later.</span>
01229         <span class="comment">//</span>
01230         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o32">fDBCS</a> &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>) {
01231             oldCaret = <a class="code" href="../../d6/d0/usercli_8h.html#a461">ECAdjustIch</a>(ped,
01232                                    <a class="code" href="../../d6/d0/usercli_8h.html#a433">ECLock</a>(ped),
01233                                    <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>)LOWORD(ll),oldCaret));
01234             <span class="comment">/* ECUnlock(ped); */</span>
01235         } <span class="keywordflow">else</span> { <span class="comment">// same as original code</span>
01236             oldCaret = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>)LOWORD(ll), oldCaret);
01237         }
01238     }
01239 
01240     <span class="comment">// Update ped-&gt;iCaretLine properly.</span>
01241     <a class="code" href="../../d6/d0/usercli_8h.html#a519">MLUpdateiCaretLine</a>(ped);
01242 
01243     <a class="code" href="../../d6/d0/usercli_8h.html#a449">ECNotifyParent</a>(ped, EN_UPDATE);
01244 
01245     <span class="comment">/*</span>
01246 <span class="comment">     * Make sure window still exists.</span>
01247 <span class="comment">     */</span>
01248     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(hwndSave))
01249         <span class="keywordflow">return</span> 0;
01250 
01251     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d9/rtl_2wow_8c.html#a17">_IsWindowVisible</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o15">pwnd</a>)) {
01252 
01253         <span class="comment">//</span>
01254         <span class="comment">// If the current font has negative A widths, we may have to start</span>
01255         <span class="comment">// drawing a few characters before the oldCaret position.</span>
01256         <span class="comment">//</span>
01257         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o77">wMaxNegAcharPos</a>) {
01258             <span class="keywordtype">int</span> iLine = <a class="code" href="../../d6/d0/usercli_8h.html#a495">MLIchToLine</a>(ped, oldCaret);
01259             oldCaret = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>( ((<span class="keywordtype">int</span>)(oldCaret - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o77">wMaxNegAcharPos</a>)),
01260                           ((<span class="keywordtype">int</span>)(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[iLine])));
01261         }
01262 
01263         <span class="comment">// Redraw to end of screen/text if CRLF or large insert</span>
01264         <span class="keywordflow">if</span> (fCRLF || !fUserTyping) {
01265 
01266             <span class="comment">/*</span>
01267 <span class="comment">             * Redraw to end of screen/text if crlf or large insert.</span>
01268 <span class="comment">             */</span>
01269             <a class="code" href="../../d6/d0/usercli_8h.html#a486">MLDrawText</a>(ped, hdc, (fUserTyping ? oldCaret : 0), ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01270         } <span class="keywordflow">else</span>
01271             <a class="code" href="../../d6/d0/usercli_8h.html#a486">MLDrawText</a>(ped, hdc, oldCaret, <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>, (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>)hl), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01272     }
01273 
01274     <a class="code" href="../../d6/d0/usercli_8h.html#a452">ECReleaseEditDC</a>(ped, hdc, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01275 
01276     <span class="comment">/*</span>
01277 <span class="comment">     * Make sure we can see the cursor</span>
01278 <span class="comment">     */</span>
01279     <a class="code" href="../../d6/d0/usercli_8h.html#a485">MLEnsureCaretVisible</a>(ped);
01280 
01281     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o24">fDirty</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01282 
01283     <a class="code" href="../../d6/d0/usercli_8h.html#a449">ECNotifyParent</a>(ped, EN_CHANGE);
01284 
01285     <span class="keywordflow">if</span> (validCch &lt; cchInsert)
01286         <a class="code" href="../../d6/d0/usercli_8h.html#a449">ECNotifyParent</a>(ped, EN_MAXTEXT);
01287 
01288     <span class="keywordflow">if</span> (validCch &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
01289         <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a12">NotifyWinEvent</a>(EVENT_OBJECT_VALUECHANGE, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, OBJID_CLIENT, INDEXID_CONTAINER);
01290     }
01291 
01292     <span class="comment">/*</span>
01293 <span class="comment">     * Make sure the window still exists.</span>
01294 <span class="comment">     */</span>
01295     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(hwndSave))
01296         <span class="keywordflow">return</span> 0;
01297     <span class="keywordflow">else</span>
01298         <span class="keywordflow">return</span> validCch;
01299 }
01300 
01301 <span class="comment">/***************************************************************************\</span>
01302 <span class="comment">*</span>
01303 <span class="comment">*  MLReplaceSel() -</span>
01304 <span class="comment">*</span>
01305 <span class="comment">*  Replaces currently selected text with the passed in text, WITH UNDO</span>
01306 <span class="comment">*  CAPABILITIES.</span>
01307 <span class="comment">*</span>
01308 <span class="comment">\***************************************************************************/</span>
<a name="l01309"></a><a class="code" href="../../d6/d0/usercli_8h.html#a521">01309</a> <span class="keywordtype">void</span>   <a class="code" href="../../d6/d0/usercli_8h.html#a521">MLReplaceSel</a>(<a class="code" href="../../d3/d4/structtagED.html">PED</a> ped, LPSTR lpText)
01310 {
01311     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>  cchText;
01312 
01313     <span class="comment">//</span>
01314     <span class="comment">// Delete text, which will put it into the clean undo buffer.</span>
01315     <span class="comment">//</span>
01316     <a class="code" href="../../d6/d0/usercli_8h.html#a444">ECEmptyUndo</a>(<a class="code" href="../../d6/d0/usercli_8h.html#a85">Pundo</a>(ped));
01317     <a class="code" href="../../d6/d0/usercli_8h.html#a484">MLDeleteText</a>(ped);
01318 
01319     <span class="comment">//</span>
01320     <span class="comment">// B#3356</span>
01321     <span class="comment">// Some apps do "clear" by selecting all of the text, then replacing</span>
01322     <span class="comment">// it with "", in which case MLInsertText() will return 0.  But that</span>
01323     <span class="comment">// doesn't mean failure...</span>
01324     <span class="comment">//</span>
01325     <span class="keywordflow">if</span> ( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> )
01326         cchText = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(lpText);
01327     <span class="keywordflow">else</span>
01328         cchText = wcslen((LPWSTR)lpText);
01329 
01330     <span class="keywordflow">if</span> (cchText ) {
01331         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fFailed;
01332         <a class="code" href="../../d9/d8/structtagUNDO.html">UNDO</a> undo;
01333         HWND hwndSave;
01334 
01335         <span class="comment">//</span>
01336         <span class="comment">// B#1385,1427</span>
01337         <span class="comment">// Save undo buffer, but DO NOT CLEAR IT.  We want to restore it</span>
01338         <span class="comment">// if insertion fails due to OOM.</span>
01339         <span class="comment">//</span>
01340         <a class="code" href="../../d6/d0/usercli_8h.html#a445">ECSaveUndo</a>(<a class="code" href="../../d6/d0/usercli_8h.html#a85">Pundo</a>(ped), (<a class="code" href="../../d9/d8/structtagUNDO.html">PUNDO</a>)&amp;undo, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01341 
01342         hwndSave = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>;
01343         fFailed = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>) !<a class="code" href="../../d6/d0/usercli_8h.html#a483">MLInsertText</a>(ped, lpText, cchText, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01344         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(hwndSave))
01345             <span class="keywordflow">return</span>;
01346 
01347         <span class="keywordflow">if</span> (fFailed) {
01348             <span class="comment">//</span>
01349             <span class="comment">// UNDO the previous edit</span>
01350             <span class="comment">//</span>
01351             <a class="code" href="../../d6/d0/usercli_8h.html#a445">ECSaveUndo</a>((<a class="code" href="../../d9/d8/structtagUNDO.html">PUNDO</a>)&amp;undo, <a class="code" href="../../d6/d0/usercli_8h.html#a85">Pundo</a>(ped), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01352             <a class="code" href="../../d6/d0/usercli_8h.html#a501">MLUndo</a>(ped);
01353         }
01354     }
01355 }
01356 
01357 
01358 <span class="comment">/***************************************************************************\</span>
01359 <span class="comment">* MLDeleteText AorW</span>
01360 <span class="comment">*</span>
01361 <span class="comment">* Deletes the characters between ichMin and ichMax. Returns the</span>
01362 <span class="comment">* number of characters we deleted.</span>
01363 <span class="comment">*</span>
01364 <span class="comment">* History:</span>
01365 <span class="comment">\***************************************************************************/</span>
01366 
<a name="l01367"></a><a class="code" href="../../d6/d0/usercli_8h.html#a484">01367</a> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> <a class="code" href="../../d6/d0/usercli_8h.html#a484">MLDeleteText</a>(
01368     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped)
01369 {
01370     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> minSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a>;
01371     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> maxSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a>;
01372     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> cchDelete;
01373     HDC hdc;
01374     <span class="keywordtype">int</span> minSelLine;
01375     <span class="keywordtype">int</span> maxSelLine;
01376     POINT xyPos;
01377     RECT rc;
01378     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fFastDelete = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01379     LONG hl;
01380     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>  cchcount = 0;
01381 
01382     <span class="comment">/*</span>
01383 <span class="comment">     * Get what line the min selection is on so that we can start rebuilding the</span>
01384 <span class="comment">     * text from there if we delete anything.</span>
01385 <span class="comment">     */</span>
01386     minSelLine = <a class="code" href="../../d6/d0/usercli_8h.html#a495">MLIchToLine</a>(ped, minSel);
01387     maxSelLine = <a class="code" href="../../d6/d0/usercli_8h.html#a495">MLIchToLine</a>(ped, maxSel);
01388     <span class="comment">//</span>
01389     <span class="comment">// Calculate fFastDelete and cchcount</span>
01390     <span class="comment">//</span>
01391     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o32">fDBCS</a>) {
01392         <span class="keywordflow">if</span> ((ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o29">fAutoVScroll</a>) &amp;&amp;
01393             (minSelLine == maxSelLine) &amp;&amp;
01394             (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[minSelLine] != minSel)  &amp;&amp;
01395             (<a class="code" href="../../d6/d0/usercli_8h.html#a468">ECNextIch</a>(ped,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,minSel) == maxSel)) {
01396 
01397                 fFastDelete = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01398                 cchcount = ((maxSel - minSel) == 1) ? 0 : -1;
01399         }
01400     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (((maxSel - minSel) == 1) &amp;&amp; (minSelLine == maxSelLine) &amp;&amp; (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[minSelLine] != minSel)) {
01401             <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o29">fAutoVScroll</a>)
01402                 fFastDelete = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01403             <span class="keywordflow">else</span>
01404                 fFastDelete = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01405     }
01406     <span class="keywordflow">if</span> (!(cchDelete = <a class="code" href="../../d6/d0/usercli_8h.html#a447">ECDeleteText</a>(ped)))
01407         <span class="keywordflow">return</span> (0);
01408 
01409     <span class="comment">/*</span>
01410 <span class="comment">     * Start building lines at minsel line since caretline may be at the max sel</span>
01411 <span class="comment">     * point.</span>
01412 <span class="comment">     */</span>
01413     <span class="keywordflow">if</span> (fFastDelete) {
01414         <span class="comment">//</span>
01415         <span class="comment">// cchcount is (-1) if it's a double byte character</span>
01416         <span class="comment">//</span>
01417         <a class="code" href="../../d6/d0/usercli_8h.html#a491">MLShiftchLines</a>(ped, minSelLine + 1, -2 + cchcount);
01418         <a class="code" href="../../d6/d0/usercli_8h.html#a490">MLBuildchLines</a>(ped, minSelLine, 1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;hl);
01419     } <span class="keywordflow">else</span> {
01420         <a class="code" href="../../d6/d0/usercli_8h.html#a490">MLBuildchLines</a>(ped, <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(minSelLine-1,0), -(<span class="keywordtype">int</span>)cchDelete, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01421     }
01422 
01423     <a class="code" href="../../d6/d0/usercli_8h.html#a519">MLUpdateiCaretLine</a>(ped);
01424 
01425     <a class="code" href="../../d6/d0/usercli_8h.html#a449">ECNotifyParent</a>(ped, EN_UPDATE);
01426 
01427     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d9/rtl_2wow_8c.html#a17">_IsWindowVisible</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o15">pwnd</a>)) {
01428 
01429         <span class="comment">/*</span>
01430 <span class="comment">         * Now update the screen to reflect the deletion</span>
01431 <span class="comment">         */</span>
01432         hdc = <a class="code" href="../../d6/d0/usercli_8h.html#a451">ECGetEditDC</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01433 
01434         <span class="comment">/*</span>
01435 <span class="comment">         * Otherwise just redraw starting at the line we just entered</span>
01436 <span class="comment">         */</span>
01437         minSelLine = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(minSelLine-1,0);
01438         <a class="code" href="../../d6/d0/usercli_8h.html#a486">MLDrawText</a>(ped, hdc, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[minSelLine],
01439                    fFastDelete ? hl : ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01440 
01441         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rc, &amp;ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>);
01442         rc.left  -= ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o80">wLeftMargin</a>;
01443         rc.right += ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o81">wRightMargin</a>;
01444 
01445         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>) {
01446 
01447             <span class="comment">/*</span>
01448 <span class="comment">             * Clear from end of text to end of window.</span>
01449 <span class="comment">             *</span>
01450 <span class="comment">             * We only need the y position. Since with an LPK loaded</span>
01451 <span class="comment">             * calculating the x position is an intensive job, just</span>
01452 <span class="comment">             * call MLIchToYPos.</span>
01453 <span class="comment">             */</span>
01454             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>)
01455                 xyPos.y = <a class="code" href="../../d1/d5/editml_8c.html#a11">MLIchToYPos</a>(ped, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01456             <span class="keywordflow">else</span>
01457                 <a class="code" href="../../d6/d0/usercli_8h.html#a494">MLIchToXYPos</a>(ped, hdc, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;xyPos);
01458             rc.top = xyPos.y + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o68">lineHeight</a>;
01459         }
01460 
01461         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a206">NtUserInvalidateRect</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, &amp;rc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01462         <a class="code" href="../../d6/d0/usercli_8h.html#a452">ECReleaseEditDC</a>(ped, hdc, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01463 
01464         <a class="code" href="../../d6/d0/usercli_8h.html#a485">MLEnsureCaretVisible</a>(ped);
01465     }
01466 
01467     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o24">fDirty</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01468 
01469     <a class="code" href="../../d6/d0/usercli_8h.html#a449">ECNotifyParent</a>(ped, EN_CHANGE);
01470 
01471     <span class="keywordflow">if</span> (cchDelete &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>())
01472         <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a12">NotifyWinEvent</a>(EVENT_OBJECT_VALUECHANGE, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, OBJID_CLIENT, INDEXID_CONTAINER);
01473 
01474     <span class="keywordflow">return</span> cchDelete;
01475 }
01476 
01477 <span class="comment">/***************************************************************************\</span>
01478 <span class="comment">* MLInsertchLine AorW</span>
01479 <span class="comment">*</span>
01480 <span class="comment">* Inserts the line iline and sets its starting character index to be</span>
01481 <span class="comment">* ich. All the other line indices are moved up. Returns TRUE if successful</span>
01482 <span class="comment">* else FALSE and notifies the parent that there was no memory.</span>
01483 <span class="comment">*</span>
01484 <span class="comment">* History:</span>
01485 <span class="comment">\***************************************************************************/</span>
01486 
<a name="l01487"></a><a class="code" href="../../d6/d0/usercli_8h.html#a492">01487</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d0/usercli_8h.html#a492">MLInsertchLine</a>(
01488     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
01489     ICH iLine,
01490     ICH ich,
01491     BOOL fUserTyping)
01492 {
01493     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwSize;
01494 
01495     <span class="keywordflow">if</span> (fUserTyping &amp;&amp; iLine &lt; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o4">cLines</a>) {
01496         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[iLine] = ich;
01497         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01498     }
01499 
01500     dwSize = (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o4">cLines</a> + 2) * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>);
01501 
01502     <span class="keywordflow">if</span> (dwSize &gt; <a class="code" href="../../d6/d0/usercli_8h.html#a139">UserLocalSize</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>)) {
01503         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a981">LPICH</a> hResult;
01504         <span class="comment">/*</span>
01505 <span class="comment">         * Grow the line index buffer</span>
01506 <span class="comment">         */</span>
01507         dwSize += <a class="code" href="../../d1/d5/editml_8c.html#a0">LINEBUMP</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>);
01508         hResult = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a981">LPICH</a>)<a class="code" href="../../d6/d0/usercli_8h.html#a137">UserLocalReAlloc</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>, dwSize, 0);
01509 
01510         <span class="keywordflow">if</span> (!hResult) {
01511             <a class="code" href="../../d6/d0/usercli_8h.html#a449">ECNotifyParent</a>(ped, EN_ERRSPACE);
01512             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01513         }
01514         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a> = hResult;
01515     }
01516 
01517     <span class="comment">/*</span>
01518 <span class="comment">     * Move indices starting at iLine up</span>
01519 <span class="comment">     */</span>
01520     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o4">cLines</a> != iLine)
01521         RtlMoveMemory(&amp;ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[iLine + 1], &amp;ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[iLine],
01522                 (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o4">cLines</a> - iLine) * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
01523     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o4">cLines</a>++;
01524 
01525     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[iLine] = ich;
01526     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01527 }
01528 
01529 <span class="comment">/***************************************************************************\</span>
01530 <span class="comment">* MLShiftchLines AorW</span>
01531 <span class="comment">*</span>
01532 <span class="comment">* Move the starting index of all lines iLine or greater by delta</span>
01533 <span class="comment">* bytes.</span>
01534 <span class="comment">*</span>
01535 <span class="comment">* History:</span>
01536 <span class="comment">\***************************************************************************/</span>
01537 
<a name="l01538"></a><a class="code" href="../../d6/d0/usercli_8h.html#a491">01538</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a491">MLShiftchLines</a>(
01539     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
01540     ICH iLine,
01541     <span class="keywordtype">int</span> delta)
01542 {
01543     <span class="keywordflow">if</span> (iLine &gt;= ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o4">cLines</a>)
01544         <span class="keywordflow">return</span>;
01545 
01546     <span class="comment">/*</span>
01547 <span class="comment">     * Just add delta to the starting point of each line after iLine</span>
01548 <span class="comment">     */</span>
01549     <span class="keywordflow">for</span> (; iLine &lt; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o4">cLines</a>; iLine++)
01550         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[iLine] += delta;
01551 }
01552 
01553 <span class="comment">/***************************************************************************\</span>
01554 <span class="comment">* MLBuildchLines AorW</span>
01555 <span class="comment">*</span>
01556 <span class="comment">* Rebuilds the start of line array (ped-&gt;chLines) starting at line</span>
01557 <span class="comment">* number ichLine.</span>
01558 <span class="comment">*</span>
01559 <span class="comment">* History:</span>
01560 <span class="comment">\***************************************************************************/</span>
01561 
<a name="l01562"></a><a class="code" href="../../d6/d0/usercli_8h.html#a490">01562</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a490">MLBuildchLines</a>(
01563     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
01564     ICH iLine,
01565     <span class="keywordtype">int</span> cchDelta, <span class="comment">// Number of chars added or deleted</span>
01566     BOOL fUserTyping,
01567     PLONG pll,
01568     PLONG phl)
01569 {
01570     PSTR ptext; <span class="comment">/* Starting address of the text */</span>
01571 
01572     <span class="comment">/*</span>
01573 <span class="comment">     * We keep these ICH's so that we can Unlock ped-&gt;hText when we have to grow</span>
01574 <span class="comment">     * the chlines array. With large text handles, it becomes a problem if we</span>
01575 <span class="comment">     * have a locked block in the way.</span>
01576 <span class="comment">     */</span>
01577     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> ichLineStart;
01578     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> ichLineEnd;
01579     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> ichLineEndBeforeCRLF;
01580     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> ichCRLF;
01581 
01582     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> cch;
01583     HDC hdc;
01584 
01585     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fLineBroken = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>; <span class="comment">/* Initially, no new line breaks are made */</span>
01586     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> minCchBreak;
01587     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> maxCchBreak;
01588     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fOnDelimiter;
01589 
01590     <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>) {
01591         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o64">maxPixelWidth</a> = 0;
01592         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o11">xOffset</a> = 0;
01593         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o9">ichScreenStart</a> = 0;
01594         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o4">cLines</a> = 1;
01595 
01596         <span class="keywordflow">if</span> (pll)
01597             *pll = 0;
01598         <span class="keywordflow">if</span> (phl)
01599             *phl = 0;
01600 
01601         <span class="keywordflow">goto</span> UpdateScroll;
01602     }
01603 
01604     <span class="keywordflow">if</span> (fUserTyping &amp;&amp; cchDelta)
01605         <a class="code" href="../../d6/d0/usercli_8h.html#a491">MLShiftchLines</a>(ped, iLine + 1, cchDelta);
01606 
01607     hdc = <a class="code" href="../../d6/d0/usercli_8h.html#a451">ECGetEditDC</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01608 
01609     <span class="keywordflow">if</span> (!iLine &amp;&amp; !cchDelta &amp;&amp; !fUserTyping) {
01610 
01611         <span class="comment">/*</span>
01612 <span class="comment">         * Reset maxpixelwidth only if we will be running through the whole</span>
01613 <span class="comment">         * text. Better too long than too short.</span>
01614 <span class="comment">         */</span>
01615         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o64">maxPixelWidth</a> = 0;
01616 
01617         <span class="comment">/*</span>
01618 <span class="comment">         * Reset number of lines in text since we will be running through all</span>
01619 <span class="comment">         * the text anyway...</span>
01620 <span class="comment">         */</span>
01621         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o4">cLines</a> = 1;
01622     }
01623 
01624     <span class="comment">/*</span>
01625 <span class="comment">     * Set min and max line built to be the starting line</span>
01626 <span class="comment">     */</span>
01627     minCchBreak = maxCchBreak = (cchDelta ? ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[iLine] : 0);
01628 
01629     ptext = <a class="code" href="../../d6/d0/usercli_8h.html#a433">ECLock</a>(ped);
01630 
01631     ichCRLF = ichLineStart = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[iLine];
01632 
01633     <span class="keywordflow">while</span> (ichLineStart &lt; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>) {
01634         <span class="keywordflow">if</span> (ichLineStart &gt;= ichCRLF) {
01635             ichCRLF = ichLineStart;
01636 
01637             <span class="comment">/*</span>
01638 <span class="comment">             * Move ichCRLF ahead to either the first CR or to the end of text.</span>
01639 <span class="comment">             */</span>
01640             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>) {
01641                 <span class="keywordflow">while</span> (ichCRLF &lt; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>) {
01642                     <span class="keywordflow">if</span> (*(ptext + ichCRLF) == 0x0D) {
01643                         <span class="keywordflow">if</span> (*(ptext + ichCRLF + 1) == 0x0A ||
01644                                 *(WORD UNALIGNED *)(ptext + ichCRLF + 1) == 0x0A0D)
01645                             <span class="keywordflow">break</span>;
01646                     }
01647                     ichCRLF++;
01648                 }
01649             } <span class="keywordflow">else</span> {
01650                 LPWSTR pwtext = (LPWSTR)ptext;
01651 
01652                 <span class="keywordflow">while</span> (ichCRLF &lt; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>) {
01653                     <span class="keywordflow">if</span> (*(pwtext + ichCRLF) == 0x0D) {
01654                         <span class="keywordflow">if</span> (*(pwtext + ichCRLF + 1) == 0x0A ||
01655                                 *(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> UNALIGNED *)(pwtext + ichCRLF + 1) == 0x000A000D)
01656                             <span class="keywordflow">break</span>;
01657                     }
01658                     ichCRLF++;
01659                 }
01660             }
01661         }
01662 
01663 
01664         <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o34">fWrap</a>) {
01665 
01666             <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>  LineWidth;
01667             <span class="comment">/*</span>
01668 <span class="comment">             * If we are not word wrapping, line breaks are signified by CRLF.</span>
01669 <span class="comment">             */</span>
01670 
01671             <span class="comment">//</span>
01672             <span class="comment">// If we cut off the line at MAXLINELENGTH, we should</span>
01673             <span class="comment">// adjust ichLineEnd.</span>
01674             <span class="comment">//</span>
01675             <span class="keywordflow">if</span> ((ichCRLF - ichLineStart) &lt;= <a class="code" href="../../d6/d0/usercli_8h.html#a74">MAXLINELENGTH</a>) {
01676                 ichLineEnd = ichCRLF;
01677             } <span class="keywordflow">else</span> {
01678                 ichLineEnd = ichLineStart + <a class="code" href="../../d6/d0/usercli_8h.html#a74">MAXLINELENGTH</a>;
01679                 <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o32">fDBCS</a>) {
01680                     ichLineEnd = <a class="code" href="../../d6/d0/usercli_8h.html#a461">ECAdjustIch</a>( ped, (PSTR)ptext, ichLineEnd);
01681                 }
01682             }
01683 
01684             <span class="comment">/*</span>
01685 <span class="comment">             * We will keep track of what the longest line is for the horizontal</span>
01686 <span class="comment">             * scroll bar thumb positioning.</span>
01687 <span class="comment">             */</span>
01688             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>) {
01689                 LineWidth = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>-&gt;<a class="code" href="../../d2/d0/structtagLPKEDITCALLOUT.html#o4">EditGetLineWidth</a>(
01690                     ped, hdc, ptext + ichLineStart*ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>,
01691                     ichLineEnd - ichLineStart);
01692             } <span class="keywordflow">else</span> {
01693                 LineWidth = <a class="code" href="../../d1/d5/editml_8c.html#a3">MLGetLineWidth</a>(hdc, ptext + ichLineStart * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>,
01694                                             ichLineEnd - ichLineStart,
01695                                             ped);
01696             }
01697             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o64">maxPixelWidth</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o64">maxPixelWidth</a>,(<span class="keywordtype">int</span>)LineWidth);
01698 
01699         } <span class="keywordflow">else</span> {
01700 
01701             <span class="comment">/*</span>
01702 <span class="comment">             * Check if the width of the edit control is non-zero;</span>
01703 <span class="comment">             * a part of the fix for Bug #7402 -- SANKAR -- 01/21/91 --</span>
01704 <span class="comment">             */</span>
01705             <span class="keywordflow">if</span>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.right &gt; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.left) {
01706 
01707                 <span class="comment">/*</span>
01708 <span class="comment">                 * Find the end of the line based solely on text extents</span>
01709 <span class="comment">                 */</span>
01710                 <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>) {
01711                     ichLineEnd = ichLineStart +
01712                         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>-&gt;<a class="code" href="../../d2/d0/structtagLPKEDITCALLOUT.html#o3">EditCchInWidth</a>(
01713                             ped, hdc, ptext + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>*ichLineStart,
01714                             ichCRLF - ichLineStart,
01715                             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.right - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.left);
01716                 } <span class="keywordflow">else</span> {
01717                     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>) {
01718                         ichLineEnd = ichLineStart +
01719                                  <a class="code" href="../../d6/d0/usercli_8h.html#a443">ECCchInWidth</a>(ped, hdc,
01720                                               ptext + ichLineStart,
01721                                               ichCRLF - ichLineStart,
01722                                               ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.right - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.left,
01723                                               <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01724                     } <span class="keywordflow">else</span> {
01725                         ichLineEnd = ichLineStart +
01726                                  <a class="code" href="../../d6/d0/usercli_8h.html#a443">ECCchInWidth</a>(ped, hdc,
01727                                               (LPSTR)((LPWSTR)ptext + ichLineStart),
01728                                               ichCRLF - ichLineStart,
01729                                               ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.right - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.left,
01730                                               <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01731                     }
01732                 }
01733             } <span class="keywordflow">else</span> {
01734                 ichLineEnd = ichLineStart;
01735             }
01736 
01737             <span class="keywordflow">if</span> (ichLineEnd == ichLineStart &amp;&amp; ichCRLF - ichLineStart) {
01738 
01739                 <span class="comment">/*</span>
01740 <span class="comment">                 * Maintain a minimum of one char per line</span>
01741 <span class="comment">                 */</span>
01742                 <span class="comment">//</span>
01743                 <span class="comment">// Since it might be a double byte char, so calling ECNextIch.</span>
01744                 <span class="comment">//</span>
01745                 ichLineEnd = <a class="code" href="../../d6/d0/usercli_8h.html#a468">ECNextIch</a>(ped, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, ichLineEnd);
01746             }
01747 
01748             <span class="comment">/*</span>
01749 <span class="comment">             * Now starting from ichLineEnd, if we are not at a hard line break,</span>
01750 <span class="comment">             * then if we are not at a space AND the char before us is</span>
01751 <span class="comment">             * not a space,(OR if we are at a CR) we will look word left for the</span>
01752 <span class="comment">             * start of the word to break at.</span>
01753 <span class="comment">             * This change was done for TWO reasons:</span>
01754 <span class="comment">             * 1. If we are on a delimiter, no need to look word left to break at.</span>
01755 <span class="comment">             * 2. If the previous char is a delimter, we can break at current char.</span>
01756 <span class="comment">             * Change done by -- SANKAR --01/31/91--</span>
01757 <span class="comment">             */</span>
01758             <span class="keywordflow">if</span> (ichLineEnd != ichCRLF) {
01759                 <span class="keywordflow">if</span>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o63">lpfnNextWord</a>) {
01760                      fOnDelimiter = (<a class="code" href="../../d6/d0/usercli_8h.html#a81">CALLWORDBREAKPROC</a>(*ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o63">lpfnNextWord</a>, ptext,
01761                             ichLineEnd, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>, WB_ISDELIMITER) ||
01762                             <a class="code" href="../../d6/d0/usercli_8h.html#a81">CALLWORDBREAKPROC</a>(*ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o63">lpfnNextWord</a>, ptext, ichLineEnd - 1,
01763                             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>, WB_ISDELIMITER));
01764                 <span class="comment">//</span>
01765                 <span class="comment">// This change was done for FOUR reasons:</span>
01766                 <span class="comment">//</span>
01767                 <span class="comment">// 1. If we are on a delimiter, no need to look word left to break at.</span>
01768                 <span class="comment">// 2. If we are on a double byte character, we can break at current char.</span>
01769                 <span class="comment">// 3. If the previous char is a delimter, we can break at current char.</span>
01770                 <span class="comment">// 4. If the previous char is a double byte character, we can break at current char.</span>
01771                 <span class="comment">//</span>
01772                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>) {
01773                     fOnDelimiter = (<a class="code" href="../../d6/d0/usercli_8h.html#a152">ISDELIMETERA</a>(*(ptext + ichLineEnd)) ||
01774                                     <a class="code" href="../../d6/d0/usercli_8h.html#a464">ECIsDBCSLeadByte</a>(ped, *(ptext + ichLineEnd)));
01775                     <span class="keywordflow">if</span> (!fOnDelimiter) {
01776                         PSTR pPrev = <a class="code" href="../../d6/d0/usercli_8h.html#a466">ECAnsiPrev</a>(ped,ptext,ptext+ichLineEnd);
01777 
01778                         fOnDelimiter = <a class="code" href="../../d6/d0/usercli_8h.html#a152">ISDELIMETERA</a>(*pPrev) ||
01779                                        <a class="code" href="../../d6/d0/usercli_8h.html#a464">ECIsDBCSLeadByte</a>(ped,*pPrev);
01780                     }
01781                 } <span class="keywordflow">else</span> { <span class="comment">// Unicode</span>
01782                     fOnDelimiter = (<a class="code" href="../../d6/d0/usercli_8h.html#a153">ISDELIMETERW</a>(*((LPWSTR)ptext + ichLineEnd))     ||
01783                                     <a class="code" href="../../d5/d2/rtl_2drawtext_8c.html#a35">UserIsFullWidth</a>(CP_ACP,*((LPWSTR)ptext + ichLineEnd))      ||
01784                                     <a class="code" href="../../d6/d0/usercli_8h.html#a153">ISDELIMETERW</a>(*((LPWSTR)ptext + ichLineEnd - 1)) ||
01785                                     <a class="code" href="../../d5/d2/rtl_2drawtext_8c.html#a35">UserIsFullWidth</a>(CP_ACP,*((LPWSTR)ptext + ichLineEnd - 1)));
01786                 }
01787                 <span class="keywordflow">if</span> (!fOnDelimiter ||
01788                     (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> &amp;&amp; *(ptext + ichLineEnd) == 0x0D) ||
01789                     (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> &amp;&amp; *((LPWSTR)ptext + ichLineEnd) == 0x0D)) {
01790 
01791                     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o63">lpfnNextWord</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01792                         cch = <a class="code" href="../../d6/d0/usercli_8h.html#a81">CALLWORDBREAKPROC</a>(*ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o63">lpfnNextWord</a>, (LPSTR)ptext, ichLineEnd,
01793                                 ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>, WB_LEFT);
01794                     } <span class="keywordflow">else</span> {
01795                         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o35">fCalcLines</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01796                         <a class="code" href="../../d6/d0/usercli_8h.html#a438">ECWord</a>(ped, ichLineEnd, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, &amp;cch, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01797                         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o35">fCalcLines</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01798                     }
01799                     <span class="keywordflow">if</span> (cch &gt; ichLineStart) {
01800                         ichLineEnd = cch;
01801                     }
01802 
01803                     <span class="comment">/*</span>
01804 <span class="comment">                     * Now, if the above test fails, it means the word left goes</span>
01805 <span class="comment">                     * back before the start of the line ie. a word is longer</span>
01806 <span class="comment">                     * than a line on the screen. So, we just fit as much of</span>
01807 <span class="comment">                     * the word on the line as possible. Thus, we use the</span>
01808 <span class="comment">                     * pLineEnd we calculated solely on width at the beginning</span>
01809 <span class="comment">                     * of this else block...</span>
01810 <span class="comment">                     */</span>
01811                 }
01812             }
01813         }
01814 <span class="preprocessor">#if 0</span>
01815 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!ISDELIMETERAW((*(ptext + (ichLineEnd - 1)*ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>))) &amp;&amp; ISDELIMETERAW((*(ptext + ichLineEnd*ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>)))) #ERROR
01816 
01817             <span class="keywordflow">if</span> ((*(ptext + ichLineEnd - 1) != <span class="charliteral">' '</span> &amp;&amp;
01818                         *(ptext + ichLineEnd - 1) != VK_TAB) &amp;&amp;
01819                         (*(ptext + ichLineEnd) == <span class="charliteral">' '</span> ||
01820                         *(ptext + ichLineEnd) == VK_TAB))
01821 <span class="preprocessor">#endif</span>
01822 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a154">AWCOMPARECHAR</a>(ped,ptext + ichLineEnd * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>, <span class="charliteral">' '</span>) ||
01823                 <a class="code" href="../../d6/d0/usercli_8h.html#a154">AWCOMPARECHAR</a>(ped,ptext + ichLineEnd * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>, VK_TAB)) {
01824             <span class="comment">/*</span>
01825 <span class="comment">             * Swallow the space at the end of a line.</span>
01826 <span class="comment">             */</span>
01827             <span class="keywordflow">if</span> (ichLineEnd &lt; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>) {
01828                 ichLineEnd++;
01829             }
01830         }
01831 
01832         <span class="comment">/*</span>
01833 <span class="comment">         * Skip over crlf or crcrlf if it exists. Thus, ichLineEnd is the first</span>
01834 <span class="comment">         * character in the next line.</span>
01835 <span class="comment">         */</span>
01836         ichLineEndBeforeCRLF = ichLineEnd;
01837 
01838         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>) {
01839             <span class="keywordflow">if</span> (ichLineEnd &lt; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a> &amp;&amp; *(ptext + ichLineEnd) == 0x0D)
01840                 ichLineEnd += 2;
01841 
01842             <span class="comment">/*</span>
01843 <span class="comment">             * Skip over CRCRLF</span>
01844 <span class="comment">             */</span>
01845             <span class="keywordflow">if</span> (ichLineEnd &lt; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a> &amp;&amp; *(ptext + ichLineEnd) == 0x0A)
01846                 ichLineEnd++;
01847             UserAssert(ichLineEnd &lt;= ped-&gt;cch);
01848         } <span class="keywordflow">else</span> {
01849             <span class="keywordflow">if</span> (ichLineEnd &lt; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a> &amp;&amp; *(((LPWSTR)ptext) + ichLineEnd) == 0x0D)
01850                 ichLineEnd += 2;
01851 
01852             <span class="comment">/*</span>
01853 <span class="comment">             * Skip over CRCRLF</span>
01854 <span class="comment">             */</span>
01855             <span class="keywordflow">if</span> (ichLineEnd &lt; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a> &amp;&amp; *(((LPWSTR)ptext) + ichLineEnd) == 0x0A) {
01856                 ichLineEnd++;
01857                 RIPMSG0(RIP_VERBOSE, <span class="stringliteral">"Skip over CRCRLF\n"</span>);
01858             }
01859             UserAssert(ichLineEnd &lt;= ped-&gt;cch);
01860         }
01861 
01862         <span class="comment">/*</span>
01863 <span class="comment">         * Now, increment iLine, allocate space for the next line, and set its</span>
01864 <span class="comment">         * starting point</span>
01865 <span class="comment">         */</span>
01866         iLine++;
01867 
01868         <span class="keywordflow">if</span> (!fUserTyping || (iLine &gt; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o4">cLines</a> - 1) || (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[iLine] != ichLineEnd)) {
01869 
01870             <span class="comment">/*</span>
01871 <span class="comment">             * The line break occured in a different place than before.</span>
01872 <span class="comment">             */</span>
01873             <span class="keywordflow">if</span> (!fLineBroken) {
01874 
01875                 <span class="comment">/*</span>
01876 <span class="comment">                 * Since we haven't broken a line before, just set the min</span>
01877 <span class="comment">                 * break line.</span>
01878 <span class="comment">                 */</span>
01879                 fLineBroken = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01880                 <span class="keywordflow">if</span> (ichLineEndBeforeCRLF == ichLineEnd)
01881                     minCchBreak = maxCchBreak = (ichLineEnd ? ichLineEnd - 1 : 0);
01882                 <span class="keywordflow">else</span>
01883                     minCchBreak = maxCchBreak = ichLineEndBeforeCRLF;
01884             }
01885             maxCchBreak = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(maxCchBreak, ichLineEnd);
01886 
01887             <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
01888 
01889             <span class="comment">/*</span>
01890 <span class="comment">             * Now insert the new line into the array</span>
01891 <span class="comment">             */</span>
01892             <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a492">MLInsertchLine</a>(ped, iLine, ichLineEnd, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)(cchDelta != 0)))
01893                 <span class="keywordflow">goto</span> EndUp;
01894 
01895             ptext = <a class="code" href="../../d6/d0/usercli_8h.html#a433">ECLock</a>(ped);
01896         } <span class="keywordflow">else</span> {
01897             maxCchBreak = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[iLine];
01898 
01899             <span class="comment">/*</span>
01900 <span class="comment">             * Quick escape</span>
01901 <span class="comment">             */</span>
01902             <span class="keywordflow">goto</span> UnlockAndEndUp;
01903         }
01904 
01905         ichLineStart = ichLineEnd;
01906     } <span class="comment">/* end while (ichLineStart &lt; ped-&gt;cch) */</span>
01907 
01908 
01909     <span class="keywordflow">if</span> (iLine != ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o4">cLines</a>) {
01910         RIPMSG1(RIP_VERBOSE, <span class="stringliteral">"chLines[%d] is being cleared.\n"</span>, iLine);
01911         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o4">cLines</a> = iLine;
01912         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o4">cLines</a>] = 0;
01913     }
01914 
01915     <span class="comment">/*</span>
01916 <span class="comment">     * Note that we incremented iLine towards the end of the while loop so, the</span>
01917 <span class="comment">     * index, iLine, is actually equal to the line count</span>
01918 <span class="comment">     */</span>
01919     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a> &amp;&amp; <a class="code" href="../../d6/d0/usercli_8h.html#a154">AWCOMPARECHAR</a>(ped, ptext + (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a> - 1)*ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>, 0x0A) &amp;&amp;
01920             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o4">cLines</a> - 1] &lt; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>) {
01921 
01922         <span class="comment">/*</span>
01923 <span class="comment">         * Make sure last line has no crlf in it</span>
01924 <span class="comment">         */</span>
01925         <span class="keywordflow">if</span> (!fLineBroken) {
01926 
01927             <span class="comment">/*</span>
01928 <span class="comment">             * Since we haven't broken a line before, just set the min break</span>
01929 <span class="comment">             * line.</span>
01930 <span class="comment">             */</span>
01931             fLineBroken = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01932             minCchBreak = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a> - 1;
01933         }
01934         maxCchBreak = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(maxCchBreak, ichLineEnd);
01935         <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
01936         <a class="code" href="../../d6/d0/usercli_8h.html#a492">MLInsertchLine</a>(ped, iLine, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01937         <a class="code" href="../../d1/d5/editml_8c.html#a2">MLSanityCheck</a>(ped);
01938     } <span class="keywordflow">else</span>
01939 UnlockAndEndUp:
01940         <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
01941 
01942 EndUp:
01943     <a class="code" href="../../d6/d0/usercli_8h.html#a452">ECReleaseEditDC</a>(ped, hdc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01944     <span class="keywordflow">if</span> (pll)
01945         *pll = minCchBreak;
01946     <span class="keywordflow">if</span> (phl)
01947         *phl = maxCchBreak;
01948 
01949 UpdateScroll:
01950     <a class="code" href="../../d6/d0/usercli_8h.html#a517">MLScroll</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d1/d5/editml_8c.html#a1">ML_REFRESH</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01951     <a class="code" href="../../d6/d0/usercli_8h.html#a517">MLScroll</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,  <a class="code" href="../../d1/d5/editml_8c.html#a1">ML_REFRESH</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01952 
01953     <a class="code" href="../../d1/d5/editml_8c.html#a2">MLSanityCheck</a>(ped);
01954 
01955     <span class="keywordflow">return</span>;
01956 }
01957 
01958 <span class="comment">/***************************************************************************\</span>
01959 <span class="comment">*</span>
01960 <span class="comment">*  MLPaint()</span>
01961 <span class="comment">*</span>
01962 <span class="comment">*  Response to WM_PAINT message.</span>
01963 <span class="comment">*</span>
01964 <span class="comment">\***************************************************************************/</span>
<a name="l01965"></a><a class="code" href="../../d1/d5/editml_8c.html#a22">01965</a> <span class="keywordtype">void</span>   <a class="code" href="../../d1/d5/editml_8c.html#a22">MLPaint</a>(<a class="code" href="../../d3/d4/structtagED.html">PED</a> ped, HDC hdc, LPRECT lprc)
01966 {
01967     HFONT       hOldFont;
01968     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>         imin;
01969     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>         imax;
01970 
01971     <span class="comment">//</span>
01972     <span class="comment">// Do we need to draw the border ourself for old apps?</span>
01973     <span class="comment">//</span>
01974     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o45">fFlatBorder</a>)
01975     {
01976         RECT    rcT;
01977 
01978         <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a19">_GetClientRect</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o15">pwnd</a>, &amp;rcT);
01979         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o15">pwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a638">WFSIZEBOX</a>))
01980         {
01981             <a class="code" href="../../d3/d6/rect_8c.html#a7">InflateRect</a>(&amp;rcT, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXBORDER) - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXFRAME),
01982                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYBORDER) - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYFRAME));
01983         }
01984         <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a17">DrawFrame</a>(hdc, &amp;rcT, 1, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a177">DF_WINDOWFRAME</a>);
01985     }
01986 
01987     <a class="code" href="../../d6/d0/usercli_8h.html#a450">ECSetEditClip</a>(ped, hdc, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>) (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o11">xOffset</a> == 0));
01988 
01989     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o66">hFont</a>)
01990         hOldFont = SelectObject(hdc, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o66">hFont</a>);
01991 
01992     <span class="keywordflow">if</span> (!lprc) {
01993         <span class="comment">// no partial rect given -- draw all text</span>
01994         imin = 0;
01995         imax = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>;
01996     } <span class="keywordflow">else</span> {
01997         <span class="comment">// only draw pertinent text</span>
01998         imin = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>) <a class="code" href="../../d1/d5/editml_8c.html#a13">MLMouseToIch</a>(ped, hdc, ((LPPOINT) &amp;lprc-&gt;left), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) - 1;
01999         <span class="keywordflow">if</span> (imin == -1)
02000             imin = 0;
02001 
02002         <span class="comment">// HACK_ALERT:</span>
02003         <span class="comment">// The 3 is required here because, MLMouseToIch() returns decremented</span>
02004         <span class="comment">// value; We must fix MLMouseToIch.</span>
02005         imax = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>) <a class="code" href="../../d1/d5/editml_8c.html#a13">MLMouseToIch</a>(ped, hdc, ((LPPOINT) &amp;lprc-&gt;right), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) + 3;
02006         <span class="keywordflow">if</span> (imax &gt; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>)
02007             imax = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>;
02008     }
02009 
02010     <a class="code" href="../../d6/d0/usercli_8h.html#a486">MLDrawText</a>(ped, hdc, imin, imax, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02011 
02012     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o66">hFont</a>)
02013         SelectObject(hdc, hOldFont);
02014 }
02015 
02016 <span class="comment">/***************************************************************************\</span>
02017 <span class="comment">* MLKeyDown AorW</span>
02018 <span class="comment">*</span>
02019 <span class="comment">* Handles cursor movement and other VIRT KEY stuff. keyMods allows</span>
02020 <span class="comment">* us to make MLKeyDownHandler calls and specify if the modifier keys (shift</span>
02021 <span class="comment">* and control) are up or down. If keyMods == 0, we get the keyboard state</span>
02022 <span class="comment">* using GetKeyState(VK_SHIFT) etc. Otherwise, the bits in keyMods define the</span>
02023 <span class="comment">* state of the shift and control keys.</span>
02024 <span class="comment">*</span>
02025 <span class="comment">* History:</span>
02026 <span class="comment">\***************************************************************************/</span>
02027 
<a name="l02028"></a><a class="code" href="../../d6/d0/usercli_8h.html#a504">02028</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a504">MLKeyDown</a>(
02029     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
02030     UINT virtKeyCode,
02031     <span class="keywordtype">int</span> keyMods)
02032 {
02033     HDC hdc;
02034     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> prevLine;
02035     POINT mousePt;
02036     <span class="keywordtype">int</span> defaultDlgId;
02037     <span class="keywordtype">int</span> iScrollAmt;
02038 
02039     <span class="comment">/*</span>
02040 <span class="comment">     * Variables we will use for redrawing the updated text</span>
02041 <span class="comment">     */</span>
02042 
02043     <span class="comment">/*</span>
02044 <span class="comment">     * new selection is specified by newMinSel, newMaxSel</span>
02045 <span class="comment">     */</span>
02046     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> newMaxSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a>;
02047     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> newMinSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a>;
02048 
02049     <span class="comment">/*</span>
02050 <span class="comment">     * Flags for drawing the updated text</span>
02051 <span class="comment">     */</span>
02052     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> changeSelection = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02053 
02054     <span class="comment">/*</span>
02055 <span class="comment">     * Comparisons we do often</span>
02056 <span class="comment">     */</span>
02057     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> MinEqMax = (newMaxSel == newMinSel);
02058     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> MinEqCar = (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> == newMinSel);
02059     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> MaxEqCar = (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> == newMaxSel);
02060 
02061     <span class="comment">/*</span>
02062 <span class="comment">     * State of shift and control keys.</span>
02063 <span class="comment">     */</span>
02064     <span class="keywordtype">int</span> scState;
02065 
02066     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o22">fMouseDown</a>) {
02067 
02068         <span class="comment">/*</span>
02069 <span class="comment">         * If we are in the middle of a mousedown command, don't do anything.</span>
02070 <span class="comment">         */</span>
02071         <span class="keywordflow">return</span> ;
02072     }
02073 
02074     scState = <a class="code" href="../../d6/d0/usercli_8h.html#a481">ECGetModKeys</a>(keyMods);
02075 
02076     <span class="keywordflow">switch</span> (virtKeyCode) {
02077     <span class="keywordflow">case</span> VK_ESCAPE:
02078         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o38">fInDialogBox</a>) {
02079 
02080             <span class="comment">/*</span>
02081 <span class="comment">             * This condition is removed because, if the dialogbox does not</span>
02082 <span class="comment">             * have a CANCEL button and if ESC is hit when focus is on a</span>
02083 <span class="comment">             * ML edit control the dialogbox must close whether it has cancel</span>
02084 <span class="comment">             * button or not to be consistent with SL edit control;</span>
02085 <span class="comment">             * DefDlgProc takes care of the disabled CANCEL button case.</span>
02086 <span class="comment">             * Fix for Bug #4123 -- 02/07/91 -- SANKAR --</span>
02087 <span class="comment">             */</span>
02088 <span class="preprocessor">#if 0</span>
02089 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o17">hwndParent</a>, IDCANCEL))
02090 <span class="preprocessor">#endif</span>
02091 <span class="preprocessor"></span>
02092                 <span class="comment">/*</span>
02093 <span class="comment">                 * User hit ESC...Send a close message (which in turn sends a</span>
02094 <span class="comment">                 * cancelID to the app in DefDialogProc...</span>
02095 <span class="comment">                 */</span>
02096                 <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o17">hwndParent</a>, WM_CLOSE, 0, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
02097         }
02098         <span class="keywordflow">return</span> ;
02099 
02100     <span class="keywordflow">case</span> VK_RETURN:
02101         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o38">fInDialogBox</a>) {
02102 
02103             <span class="comment">/*</span>
02104 <span class="comment">             * If this multiline edit control is in a dialog box, then we want</span>
02105 <span class="comment">             * the RETURN key to be sent to the default dialog button (if there</span>
02106 <span class="comment">             * is one). CTRL-RETURN will insert a RETURN into the text. Note</span>
02107 <span class="comment">             * that CTRL-RETURN automatically translates into a linefeed (0x0A)</span>
02108 <span class="comment">             * and in the MLCharHandler, we handle this as if a return was</span>
02109 <span class="comment">             * entered.</span>
02110 <span class="comment">             */</span>
02111             <span class="keywordflow">if</span> (scState != <a class="code" href="../../d6/d0/usercli_8h.html#a77">CTRLDOWN</a>) {
02112 
02113                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o15">pwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a711">EFWANTRETURN</a>)) {
02114 
02115                     <span class="comment">/*</span>
02116 <span class="comment">                     * This edit control wants cr to be inserted so break out of</span>
02117 <span class="comment">                     * case.</span>
02118 <span class="comment">                     */</span>
02119                     <span class="keywordflow">return</span> ;
02120                 }
02121 
02122                 defaultDlgId = (<span class="keywordtype">int</span>)(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)LOWORD(<a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o17">hwndParent</a>,
02123                         DM_GETDEFID, 0, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>));
02124                 <span class="keywordflow">if</span> (defaultDlgId) {
02125                     HWND hwnd = <a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o17">hwndParent</a>, defaultDlgId);
02126                     <span class="keywordflow">if</span> (hwnd) {
02127                         <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o17">hwndParent</a>, WM_NEXTDLGCTL, (WPARAM)hwnd, 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
02128                         <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o23">fFocus</a>)
02129                             <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(hwnd, WM_KEYDOWN, VK_RETURN, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
02130                     }
02131                 }
02132             }
02133 
02134             <span class="keywordflow">return</span> ;
02135         }
02136         <span class="keywordflow">break</span>;
02137 
02138     <span class="keywordflow">case</span> VK_TAB:
02139 
02140         <span class="comment">/*</span>
02141 <span class="comment">         * If this multiline edit control is in a dialog box, then we want the</span>
02142 <span class="comment">         * TAB key to take you to the next control, shift TAB to take you to the</span>
02143 <span class="comment">         * previous control. We always want CTRL-TAB to insert a tab into the</span>
02144 <span class="comment">         * edit control regardless of weather or not we're in a dialog box.</span>
02145 <span class="comment">         */</span>
02146         <span class="keywordflow">if</span> (scState == <a class="code" href="../../d6/d0/usercli_8h.html#a77">CTRLDOWN</a>)
02147             <a class="code" href="../../d6/d0/usercli_8h.html#a503">MLChar</a>(ped, virtKeyCode, keyMods);
02148         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o38">fInDialogBox</a>)
02149             <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o17">hwndParent</a>, WM_NEXTDLGCTL, scState == <a class="code" href="../../d6/d0/usercli_8h.html#a78">SHFTDOWN</a>, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
02150 
02151         <span class="keywordflow">return</span> ;
02152 
02153     <span class="keywordflow">case</span> VK_LEFT:
02154         <span class="comment">//</span>
02155         <span class="comment">// If the caret isn't at the beginning, we can move left</span>
02156         <span class="comment">//</span>
02157         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>) {
02158             <span class="comment">// Get new caret pos.</span>
02159             <span class="keywordflow">if</span> (scState &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a77">CTRLDOWN</a>) {
02160                 <span class="comment">// Move caret word left</span>
02161                 <a class="code" href="../../d6/d0/usercli_8h.html#a438">ECWord</a>(ped, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, &amp;ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02162             } <span class="keywordflow">else</span> {
02163                 <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>) {
02164                     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> = <a class="code" href="../../d1/d5/editml_8c.html#a7">MLMoveSelectionRestricted</a>(ped, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02165                 } <span class="keywordflow">else</span> {
02166                     <span class="comment">// Move caret char left</span>
02167                     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> = <a class="code" href="../../d1/d5/editml_8c.html#a6">MLMoveSelection</a>(ped, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02168                 }
02169             }
02170 
02171             <span class="comment">// Get new selection</span>
02172             <span class="keywordflow">if</span> (scState &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a78">SHFTDOWN</a>) {
02173                 <span class="keywordflow">if</span> (MaxEqCar &amp;&amp; !MinEqMax) {
02174                     <span class="comment">// Reduce selection</span>
02175                     newMaxSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>;
02176 
02177                     UserAssert(newMinSel == ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a>);
02178                 } <span class="keywordflow">else</span> {
02179                     <span class="comment">// Extend selection</span>
02180                     newMinSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>;
02181                 }
02182             } <span class="keywordflow">else</span> {
02183                 <span class="comment">// Clear selection</span>
02184                 newMaxSel = newMinSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>;
02185             }
02186 
02187             changeSelection = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02188         } <span class="keywordflow">else</span> {
02189             <span class="comment">//</span>
02190             <span class="comment">// If the user tries to move left and we are at the 0th</span>
02191             <span class="comment">// character and there is a selection, then cancel the</span>
02192             <span class="comment">// selection.</span>
02193             <span class="comment">//</span>
02194             <span class="keywordflow">if</span> ( (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a> != ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a>) &amp;&amp;
02195                 !(scState &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a78">SHFTDOWN</a>) ) {
02196                 changeSelection = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02197                 newMaxSel = newMinSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>;
02198             }
02199         }
02200         <span class="keywordflow">break</span>;
02201 
02202     <span class="keywordflow">case</span> VK_RIGHT:
02203         <span class="comment">//</span>
02204         <span class="comment">// If the caret isn't at the end, we can move right.</span>
02205         <span class="comment">//</span>
02206         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> &lt; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>) {
02207             <span class="comment">//</span>
02208             <span class="comment">// Get new caret pos.</span>
02209             <span class="comment">//</span>
02210             <span class="keywordflow">if</span> (scState &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a77">CTRLDOWN</a>) {
02211                 <span class="comment">// Move caret word right</span>
02212                 <a class="code" href="../../d6/d0/usercli_8h.html#a438">ECWord</a>(ped, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>);
02213             } <span class="keywordflow">else</span> {
02214                 <span class="comment">// Move caret char right</span>
02215                 <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>) {
02216                     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> = <a class="code" href="../../d1/d5/editml_8c.html#a7">MLMoveSelectionRestricted</a>(ped, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02217                 } <span class="keywordflow">else</span> {
02218                     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> = <a class="code" href="../../d1/d5/editml_8c.html#a6">MLMoveSelection</a>(ped, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02219                 }
02220             }
02221 
02222             <span class="comment">//</span>
02223             <span class="comment">// Get new selection.</span>
02224             <span class="comment">//</span>
02225             <span class="keywordflow">if</span> (scState &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a78">SHFTDOWN</a>) {
02226                 <span class="keywordflow">if</span> (MinEqCar &amp;&amp; !MinEqMax) {
02227                     <span class="comment">// Reduce selection</span>
02228                     newMinSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>;
02229 
02230                     UserAssert(newMaxSel == ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a>);
02231                 } <span class="keywordflow">else</span> {
02232                     <span class="comment">// Extend selection</span>
02233                     newMaxSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>;
02234                 }
02235             } <span class="keywordflow">else</span> {
02236                 <span class="comment">// Clear selection</span>
02237                 newMaxSel = newMinSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>;
02238             }
02239 
02240             changeSelection = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02241         } <span class="keywordflow">else</span> {
02242             <span class="comment">//</span>
02243             <span class="comment">// If the user tries to move right and we are at the last</span>
02244             <span class="comment">// character and there is a selection, then cancel the</span>
02245             <span class="comment">// selection.</span>
02246             <span class="comment">//</span>
02247             <span class="keywordflow">if</span> ( (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a> != ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a>) &amp;&amp;
02248                 !(scState &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a78">SHFTDOWN</a>) ) {
02249                 newMaxSel = newMinSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>;
02250                 changeSelection = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02251             }
02252         }
02253         <span class="keywordflow">break</span>;
02254 
02255     <span class="keywordflow">case</span> VK_UP:
02256     <span class="keywordflow">case</span> VK_DOWN:
02257         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o4">cLines</a> - 1 != ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o8">iCaretLine</a> &amp;&amp;
02258                 ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> == ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o8">iCaretLine</a> + 1])
02259             prevLine = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02260         <span class="keywordflow">else</span>
02261             prevLine = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02262 
02263         hdc = <a class="code" href="../../d6/d0/usercli_8h.html#a451">ECGetEditDC</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02264         <a class="code" href="../../d6/d0/usercli_8h.html#a494">MLIchToXYPos</a>(ped, hdc, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>, prevLine, &amp;mousePt);
02265         <a class="code" href="../../d6/d0/usercli_8h.html#a452">ECReleaseEditDC</a>(ped, hdc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02266         mousePt.y += 1 + (virtKeyCode == VK_UP ? -ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o68">lineHeight</a> : ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o68">lineHeight</a>);
02267 
02268         <span class="keywordflow">if</span> (!(scState &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a77">CTRLDOWN</a>)) {
02269             <span class="comment">//</span>
02270             <span class="comment">// Send fake mouse messages to handle this</span>
02271             <span class="comment">// If VK_SHIFT is down, extend selection &amp; move caret up/down</span>
02272             <span class="comment">// 1 line.  Otherwise, clear selection &amp; move caret.</span>
02273             <span class="comment">//</span>
02274             <a class="code" href="../../d6/d0/usercli_8h.html#a497">MLMouseMotion</a>(ped, WM_LBUTTONDOWN,
02275                             !(scState &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a78">SHFTDOWN</a>) ? 0 : MK_SHIFT, &amp;mousePt);
02276             <a class="code" href="../../d6/d0/usercli_8h.html#a497">MLMouseMotion</a>(ped, WM_LBUTTONUP,
02277                             !(scState &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a78">SHFTDOWN</a>) ? 0 : MK_SHIFT, &amp;mousePt);
02278         }
02279         <span class="keywordflow">break</span>;
02280 
02281     <span class="keywordflow">case</span> VK_HOME:
02282         <span class="comment">//</span>
02283         <span class="comment">// Update caret.</span>
02284         <span class="comment">//</span>
02285         <span class="keywordflow">if</span> (scState &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a77">CTRLDOWN</a>) {
02286             <span class="comment">// Move caret to beginning of text.</span>
02287             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> = 0;
02288         } <span class="keywordflow">else</span> {
02289             <span class="comment">// Move caret to beginning of line.</span>
02290             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o8">iCaretLine</a>];
02291         }
02292 
02293         <span class="comment">//</span>
02294         <span class="comment">// Update selection.</span>
02295         <span class="comment">//</span>
02296         newMinSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>;
02297 
02298         <span class="keywordflow">if</span> (scState &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a78">SHFTDOWN</a>) {
02299             <span class="keywordflow">if</span> (MaxEqCar &amp;&amp; !MinEqMax) {
02300                 <span class="keywordflow">if</span> (scState &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a77">CTRLDOWN</a>)
02301                     newMaxSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a>;
02302                 <span class="keywordflow">else</span> {
02303                     newMinSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a>;
02304                     newMaxSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>;
02305                 }
02306             }
02307         } <span class="keywordflow">else</span> {
02308             <span class="comment">// Clear selection</span>
02309             newMaxSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>;
02310         }
02311 
02312         changeSelection = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02313         <span class="keywordflow">break</span>;
02314 
02315     <span class="keywordflow">case</span> VK_END:
02316         <span class="comment">//</span>
02317         <span class="comment">// Update caret.</span>
02318         <span class="comment">//</span>
02319         <span class="keywordflow">if</span> (scState &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a77">CTRLDOWN</a>) {
02320             <span class="comment">// Move caret to end of text.</span>
02321             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>;
02322         } <span class="keywordflow">else</span> {
02323             <span class="comment">// Move caret to end of line.</span>
02324             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o8">iCaretLine</a>] +
02325                 <a class="code" href="../../d6/d0/usercli_8h.html#a498">MLLine</a>(ped, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o8">iCaretLine</a>);
02326         }
02327 
02328         <span class="comment">// Update selection.</span>
02329         newMaxSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>;
02330 
02331         <span class="keywordflow">if</span> (scState &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a78">SHFTDOWN</a>) {
02332             <span class="keywordflow">if</span> (MinEqCar &amp;&amp; !MinEqMax) {
02333                 <span class="comment">// Reduce selection</span>
02334                 <span class="keywordflow">if</span> (scState &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a77">CTRLDOWN</a>) {
02335                     newMinSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a>;
02336                 } <span class="keywordflow">else</span> {
02337                     newMinSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>;
02338                     newMaxSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a>;
02339                 }
02340             }
02341         } <span class="keywordflow">else</span> {
02342             <span class="comment">// Clear selection</span>
02343             newMinSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>;
02344         }
02345 
02346         changeSelection = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02347         <span class="keywordflow">break</span>;
02348 
02349     <span class="comment">// FE_IME // EC_INSERT_COMPOSITION_CHAR : MLKeyDown() : VK_HANJA support</span>
02350     <span class="keywordflow">case</span> VK_HANJA:
02351         <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d0/usercli_8h.html#a476">HanjaKeyHandler</a>( ped ) ) {
02352             changeSelection = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02353             newMinSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>;
02354             newMaxSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> + (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> ? 2 : 1);
02355         }
02356         <span class="keywordflow">break</span>;
02357 
02358     <span class="keywordflow">case</span> VK_PRIOR:
02359     <span class="keywordflow">case</span> VK_NEXT:
02360         <span class="keywordflow">if</span> (!(scState &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a77">CTRLDOWN</a>)) {
02361             <span class="comment">/*</span>
02362 <span class="comment">             * Vertical scroll by one visual screen</span>
02363 <span class="comment">             */</span>
02364             hdc = <a class="code" href="../../d6/d0/usercli_8h.html#a451">ECGetEditDC</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02365             <a class="code" href="../../d6/d0/usercli_8h.html#a494">MLIchToXYPos</a>(ped, hdc, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;mousePt);
02366             <a class="code" href="../../d6/d0/usercli_8h.html#a452">ECReleaseEditDC</a>(ped, hdc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02367             mousePt.y += 1;
02368 
02369             <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, WM_VSCROLL, virtKeyCode == VK_PRIOR ? SB_PAGEUP : SB_PAGEDOWN, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
02370 
02371             <span class="comment">/*</span>
02372 <span class="comment">             * Move the cursor there</span>
02373 <span class="comment">             */</span>
02374             <a class="code" href="../../d6/d0/usercli_8h.html#a497">MLMouseMotion</a>(ped, WM_LBUTTONDOWN, !(scState &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a78">SHFTDOWN</a>) ? 0 : MK_SHIFT, &amp;mousePt);
02375             <a class="code" href="../../d6/d0/usercli_8h.html#a497">MLMouseMotion</a>(ped, WM_LBUTTONUP,   !(scState &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a78">SHFTDOWN</a>) ? 0 : MK_SHIFT, &amp;mousePt);
02376 
02377         } <span class="keywordflow">else</span> {
02378             <span class="comment">/*</span>
02379 <span class="comment">             * Horizontal scroll by one screenful minus one char</span>
02380 <span class="comment">             */</span>
02381             iScrollAmt = ((ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.right - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.left) / ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o67">aveCharWidth</a>) - 1;
02382             <span class="keywordflow">if</span> (virtKeyCode == VK_PRIOR)
02383                 iScrollAmt *= -1; <span class="comment">/* For previous page */</span>
02384 
02385             <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, WM_HSCROLL, MAKELONG(EM_LINESCROLL, iScrollAmt), 0);
02386             <span class="keywordflow">break</span>;
02387         }
02388         <span class="keywordflow">break</span>;
02389 
02390     <span class="keywordflow">case</span> VK_DELETE:
02391         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o39">fReadOnly</a>)
02392             <span class="keywordflow">break</span>;
02393 
02394         <span class="keywordflow">switch</span> (scState) {
02395         <span class="keywordflow">case</span> <a class="code" href="../../d6/d0/usercli_8h.html#a76">NONEDOWN</a>:
02396 
02397             <span class="comment">/*</span>
02398 <span class="comment">             * Clear selection. If no selection, delete (clear) character</span>
02399 <span class="comment">             * right</span>
02400 <span class="comment">             */</span>
02401             <span class="keywordflow">if</span> ((ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a> &lt; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>) &amp;&amp; (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a> == ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a>)) {
02402 
02403                 <span class="comment">/*</span>
02404 <span class="comment">                 * Move cursor forwards and send a backspace message...</span>
02405 <span class="comment">                 */</span>
02406                 <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>) {
02407                     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a> = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>;
02408                     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a> = <a class="code" href="../../d1/d5/editml_8c.html#a7">MLMoveSelectionRestricted</a>(ped, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02409                 } <span class="keywordflow">else</span> {
02410                     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> = <a class="code" href="../../d1/d5/editml_8c.html#a6">MLMoveSelection</a>(ped, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02411                     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a> = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a> = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>;
02412                 }
02413 
02414                 <span class="keywordflow">goto</span> DeleteAnotherChar;
02415             }
02416             <span class="keywordflow">break</span>;
02417 
02418         <span class="keywordflow">case</span> <a class="code" href="../../d6/d0/usercli_8h.html#a78">SHFTDOWN</a>:
02419 
02420             <span class="comment">/*</span>
02421 <span class="comment">             * CUT selection ie. remove and copy to clipboard, or if no</span>
02422 <span class="comment">             * selection, delete (clear) character left.</span>
02423 <span class="comment">             */</span>
02424             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a> == ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a>) {
02425                 <span class="keywordflow">goto</span> DeleteAnotherChar;
02426             } <span class="keywordflow">else</span> {
02427                 <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, WM_CUT, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)0, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
02428             }
02429 
02430             <span class="keywordflow">break</span>;
02431 
02432         <span class="keywordflow">case</span> <a class="code" href="../../d6/d0/usercli_8h.html#a77">CTRLDOWN</a>:
02433 
02434             <span class="comment">/*</span>
02435 <span class="comment">             * Clear selection, or delete to end of line if no selection</span>
02436 <span class="comment">             */</span>
02437             <span class="keywordflow">if</span> ((ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a> &lt; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>) &amp;&amp; (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a> == ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a>)) {
02438                 ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a> = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o8">iCaretLine</a>] +
02439                                                  <a class="code" href="../../d6/d0/usercli_8h.html#a498">MLLine</a>(ped, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o8">iCaretLine</a>);
02440             }
02441             <span class="keywordflow">break</span>;
02442         }
02443 
02444         <span class="keywordflow">if</span> (!(scState &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a78">SHFTDOWN</a>) &amp;&amp; (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a> != ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a>)) {
02445 
02446 DeleteAnotherChar:
02447             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a150">GETAPPVER</a>() &gt;= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>) {
02448                 <a class="code" href="../../d6/d0/usercli_8h.html#a503">MLChar</a>(ped, VK_BACK, 0);
02449             } <span class="keywordflow">else</span> {
02450                 <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o15">pwnd</a>, WM_CHAR, VK_BACK, 0, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>);
02451             }
02452         }
02453 
02454         <span class="comment">/*</span>
02455 <span class="comment">         * No need to update text or selection since BACKSPACE message does it</span>
02456 <span class="comment">         * for us.</span>
02457 <span class="comment">         */</span>
02458         <span class="keywordflow">break</span>;
02459 
02460     <span class="keywordflow">case</span> VK_INSERT:
02461         <span class="keywordflow">if</span> (scState == <a class="code" href="../../d6/d0/usercli_8h.html#a77">CTRLDOWN</a> || scState == <a class="code" href="../../d6/d0/usercli_8h.html#a78">SHFTDOWN</a>) {
02462 
02463             <span class="comment">/*</span>
02464 <span class="comment">             * if CTRLDOWN Copy current selection to clipboard</span>
02465 <span class="comment">             */</span>
02466 
02467             <span class="comment">/*</span>
02468 <span class="comment">             * if SHFTDOWN Paste clipboard</span>
02469 <span class="comment">             */</span>
02470             <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(scState == <a class="code" href="../../d6/d0/usercli_8h.html#a77">CTRLDOWN</a> ? WM_COPY : WM_PASTE), 0, 0);
02471         }
02472         <span class="keywordflow">break</span>;
02473     }
02474 
02475     <span class="keywordflow">if</span> (changeSelection) {
02476         hdc = <a class="code" href="../../d6/d0/usercli_8h.html#a451">ECGetEditDC</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02477         <a class="code" href="../../d6/d0/usercli_8h.html#a513">MLChangeSelection</a>(ped, hdc, newMinSel, newMaxSel);
02478 
02479         <span class="comment">/*</span>
02480 <span class="comment">         * Set the caret's line</span>
02481 <span class="comment">         */</span>
02482         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o8">iCaretLine</a> = <a class="code" href="../../d6/d0/usercli_8h.html#a495">MLIchToLine</a>(ped, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>);
02483 
02484         <span class="keywordflow">if</span> (virtKeyCode == VK_END &amp;&amp;
02485                 <span class="comment">// Next line: Win95 Bug#11822, EditControl repaint (Sankar)</span>
02486                 (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> == ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o8">iCaretLine</a>]) &amp;&amp;
02487                 ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> &lt; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a> &amp;&amp;
02488                 ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o34">fWrap</a> &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o8">iCaretLine</a> &gt; 0) {
02489             LPSTR pText = <a class="code" href="../../d6/d0/usercli_8h.html#a433">ECLock</a>(ped);
02490 
02491             <span class="comment">/*</span>
02492 <span class="comment">             * Handle moving to the end of a word wrapped line. This keeps the</span>
02493 <span class="comment">             * cursor from falling to the start of the next line if we have word</span>
02494 <span class="comment">             * wrapped and there is no CRLF.</span>
02495 <span class="comment">             */</span>
02496             <span class="keywordflow">if</span> ( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> ) {
02497                 <span class="keywordflow">if</span> (*(WORD UNALIGNED *)(pText +
02498                         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o8">iCaretLine</a>] - 2) != 0x0A0D) {
02499                     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o8">iCaretLine</a>--;
02500                 }
02501             } <span class="keywordflow">else</span> {
02502                 <span class="keywordflow">if</span> (*(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> UNALIGNED *)(pText +
02503                      (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o8">iCaretLine</a>] - 2)*ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>) != 0x000A000D) {
02504                     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o8">iCaretLine</a>--;
02505                 }
02506             }
02507             <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
02508         }
02509 
02510         <span class="comment">/*</span>
02511 <span class="comment">         * Since drawtext sets the caret position</span>
02512 <span class="comment">         */</span>
02513         <a class="code" href="../../d6/d0/usercli_8h.html#a493">MLSetCaretPosition</a>(ped, hdc);
02514         <a class="code" href="../../d6/d0/usercli_8h.html#a452">ECReleaseEditDC</a>(ped, hdc, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02515 
02516         <span class="comment">/*</span>
02517 <span class="comment">         * Make sure we can see the cursor</span>
02518 <span class="comment">         */</span>
02519         <a class="code" href="../../d6/d0/usercli_8h.html#a485">MLEnsureCaretVisible</a>(ped);
02520     }
02521 }
02522 
02523 <span class="comment">/***************************************************************************\</span>
02524 <span class="comment">* MLChar</span>
02525 <span class="comment">*</span>
02526 <span class="comment">* Handles character and virtual key input</span>
02527 <span class="comment">*</span>
02528 <span class="comment">* History:</span>
02529 <span class="comment">\***************************************************************************/</span>
02530 
<a name="l02531"></a><a class="code" href="../../d6/d0/usercli_8h.html#a503">02531</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a503">MLChar</a>(
02532     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
02533     DWORD keyValue,
02534     <span class="keywordtype">int</span> keyMods)
02535 {
02536     WCHAR keyPress;
02537     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> updateText = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02538 
02539     <span class="comment">/*</span>
02540 <span class="comment">     * keyValue is either:</span>
02541 <span class="comment">     *    a Virtual Key (eg: VK_TAB, VK_ESCAPE, VK_BACK)</span>
02542 <span class="comment">     *    a character (Unicode or "ANSI")</span>
02543 <span class="comment">     */</span>
02544     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>)
02545         keyPress = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(keyValue);
02546     <span class="keywordflow">else</span>
02547         keyPress = LOWORD(keyValue);
02548 
02549     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o22">fMouseDown</a> || keyPress == VK_ESCAPE) {
02550 
02551         <span class="comment">/*</span>
02552 <span class="comment">         * If we are in the middle of a mousedown command, don't do anything.</span>
02553 <span class="comment">         * Also, just ignore it if we get a translated escape key which happens</span>
02554 <span class="comment">         * with multiline edit controls in a dialog box.</span>
02555 <span class="comment">         */</span>
02556         <span class="keywordflow">return</span> ;
02557     }
02558 
02559     <a class="code" href="../../d6/d0/usercli_8h.html#a477">ECInOutReconversionMode</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02560 
02561     {
02562         <span class="keywordtype">int</span> scState;
02563         scState = <a class="code" href="../../d6/d0/usercli_8h.html#a481">ECGetModKeys</a>(keyMods);
02564 
02565         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o38">fInDialogBox</a> &amp;&amp; scState != <a class="code" href="../../d6/d0/usercli_8h.html#a77">CTRLDOWN</a>) {
02566 
02567             <span class="comment">/*</span>
02568 <span class="comment">             * If this multiline edit control is in a dialog box, then we want the</span>
02569 <span class="comment">             * TAB key to take you to the next control, shift TAB to take you to the</span>
02570 <span class="comment">             * previous control, and CTRL-TAB to insert a tab into the edit control.</span>
02571 <span class="comment">             * We moved the focus when we received the keydown message so we will</span>
02572 <span class="comment">             * ignore the TAB key now unless the ctrl key is down. Also, we want</span>
02573 <span class="comment">             * CTRL-RETURN to insert a return into the text and RETURN to be sent to</span>
02574 <span class="comment">             * the default button.</span>
02575 <span class="comment">             */</span>
02576             <span class="keywordflow">if</span> (keyPress == VK_TAB ||
02577                     (keyPress == VK_RETURN &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o15">pwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a711">EFWANTRETURN</a>)))
02578                 <span class="keywordflow">return</span> ;
02579         }
02580 
02581         <span class="comment">/*</span>
02582 <span class="comment">         * Allow CTRL+C to copy from a read only edit control</span>
02583 <span class="comment">         * Ignore all other keys in read only controls</span>
02584 <span class="comment">         */</span>
02585         <span class="keywordflow">if</span> ((ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o39">fReadOnly</a>) &amp;&amp; !((keyPress == 3) &amp;&amp; (scState == <a class="code" href="../../d6/d0/usercli_8h.html#a77">CTRLDOWN</a>))) {
02586             <span class="keywordflow">return</span> ;
02587         }
02588     }
02589 
02590     <span class="keywordflow">switch</span> (keyPress) {
02591     <span class="keywordflow">case</span> 0x0A: <span class="comment">// linefeed</span>
02592         keyPress = VK_RETURN;
02593         <span class="comment">/*</span>
02594 <span class="comment">         * FALL THRU</span>
02595 <span class="comment">         */</span>
02596 
02597     <span class="keywordflow">case</span> VK_RETURN:
02598     <span class="keywordflow">case</span> VK_TAB:
02599     <span class="keywordflow">case</span> VK_BACK:
02600 DeleteSelection:
02601         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a484">MLDeleteText</a>(ped))
02602             updateText = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02603         <span class="keywordflow">break</span>;
02604 
02605     <span class="keywordflow">default</span>:
02606         <span class="keywordflow">if</span> (keyPress &gt;= TEXT(<span class="charliteral">' '</span>)) {
02607             <span class="comment">/*</span>
02608 <span class="comment">             * If this is in [a-z],[A-Z] and we are an ES_NUMBER</span>
02609 <span class="comment">             * edit field, bail.</span>
02610 <span class="comment">             */</span>
02611             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o44">f40Compat</a> &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o15">pwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a712">EFNUMBER</a>)) {
02612                 <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a459">ECIsCharNumeric</a>(ped, keyPress)) {
02613                     <span class="keywordflow">goto</span> IllegalChar;
02614                 }
02615             }
02616 
02617             <span class="keywordflow">goto</span> DeleteSelection;
02618         }
02619         <span class="keywordflow">break</span>;
02620     }
02621 
02622     <span class="comment">/*</span>
02623 <span class="comment">     * Handle key codes</span>
02624 <span class="comment">     */</span>
02625     <span class="keywordflow">switch</span>(keyPress) {
02626     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
02627 
02628     <span class="comment">// Ctrl+Z == Undo</span>
02629     <span class="keywordflow">case</span> 26:
02630         <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> = WM_UNDO;
02631         <span class="keywordflow">goto</span> SendEditingMessage;
02632         <span class="keywordflow">break</span>;
02633 
02634     <span class="comment">// Ctrl+X == Cut</span>
02635     <span class="keywordflow">case</span> 24:
02636         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a> == ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a>)
02637             <span class="keywordflow">goto</span> IllegalChar;
02638         <span class="keywordflow">else</span>
02639         {
02640             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> = WM_CUT;
02641             <span class="keywordflow">goto</span> SendEditingMessage;
02642         }
02643         <span class="keywordflow">break</span>;
02644 
02645     <span class="comment">// Ctrl+C == Copy</span>
02646     <span class="keywordflow">case</span> 3:
02647         <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> = WM_COPY;
02648         <span class="keywordflow">goto</span> SendEditingMessage;
02649         <span class="keywordflow">break</span>;
02650 
02651     <span class="comment">// Ctrl+V == Paste</span>
02652     <span class="keywordflow">case</span> 22:
02653         <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> = WM_PASTE;
02654 SendEditingMessage:
02655         <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, 0, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
02656         <span class="keywordflow">break</span>;
02657 
02658     <span class="keywordflow">case</span> VK_BACK:
02659         <span class="comment">//</span>
02660         <span class="comment">// Delete any selected text or delete character left if no sel</span>
02661         <span class="comment">//</span>
02662         <span class="keywordflow">if</span> (!updateText &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a>)
02663         {
02664             <span class="comment">//</span>
02665             <span class="comment">// There was no selection to delete so we just delete</span>
02666             <span class="comment">// character left if available</span>
02667             <span class="comment">//</span>
02668             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a> = <a class="code" href="../../d1/d5/editml_8c.html#a6">MLMoveSelection</a>(ped, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02669             <a class="code" href="../../d6/d0/usercli_8h.html#a484">MLDeleteText</a>(ped);
02670         }
02671         <span class="keywordflow">break</span>;
02672 
02673     <span class="keywordflow">default</span>:
02674         <span class="keywordflow">if</span> (keyPress == VK_RETURN)
02675             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>)
02676                 keyValue = 0x0A0D;
02677             <span class="keywordflow">else</span>
02678                 keyValue = 0x000A000D;
02679 
02680         <span class="keywordflow">if</span> (   keyPress &gt;= TEXT(<span class="charliteral">' '</span>)
02681             || keyPress == VK_RETURN
02682             || keyPress == VK_TAB
02683             || keyPress == 0x1E     <span class="comment">// RS - Unicode block separator</span>
02684             || keyPress == 0x1F     <span class="comment">// US - Unicode segment separator</span>
02685             ) {
02686 
02687             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a173">NtUserCallNoParam</a>(SFI_ZZZHIDECURSORNOCAPTURE);
02688             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>) {
02689                 <span class="comment">//</span>
02690                 <span class="comment">// check if it's a leading byte of double byte character</span>
02691                 <span class="comment">//</span>
02692                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a464">ECIsDBCSLeadByte</a>(ped,(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)keyPress)) {
02693                     <span class="keywordtype">int</span> DBCSkey;
02694 
02695                     <span class="keywordflow">if</span> ((DBCSkey = <a class="code" href="../../d6/d0/usercli_8h.html#a460">DbcsCombine</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, keyPress)) != 0)
02696                         keyValue = DBCSkey;
02697                 }
02698                 <a class="code" href="../../d6/d0/usercli_8h.html#a483">MLInsertText</a>(ped, (LPSTR)&amp;keyValue, <a class="code" href="../../d5/d9/ntrtlp_8h.html#a5">HIBYTE</a>(keyValue) ? 2 : 1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02699             } <span class="keywordflow">else</span>
02700                 <a class="code" href="../../d6/d0/usercli_8h.html#a483">MLInsertText</a>(ped, (LPSTR)&amp;keyValue, HIWORD(keyValue) ? 2 : 1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02701         } <span class="keywordflow">else</span> {
02702 IllegalChar:
02703             <a class="code" href="../../d6/d0/usercli_8h.html#a219">NtUserMessageBeep</a>(0);
02704         }
02705         <span class="keywordflow">break</span>;
02706     }
02707 }
02708 
02709 <span class="comment">/***************************************************************************\</span>
02710 <span class="comment">* MLPasteText AorW</span>
02711 <span class="comment">*</span>
02712 <span class="comment">* Pastes a line of text from the clipboard into the edit control</span>
02713 <span class="comment">* starting at ped-&gt;ichCaret. Updates ichMaxSel and ichMinSel to point to the</span>
02714 <span class="comment">* end of the inserted text. Notifies the parent if space cannot be</span>
02715 <span class="comment">* allocated. Returns how many characters were inserted.</span>
02716 <span class="comment">*</span>
02717 <span class="comment">* History:</span>
02718 <span class="comment">\***************************************************************************/</span>
02719 
<a name="l02720"></a><a class="code" href="../../d6/d0/usercli_8h.html#a505">02720</a> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> PASCAL NEAR <a class="code" href="../../d6/d0/usercli_8h.html#a505">MLPasteText</a>(
02721     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped)
02722 {
02723     HANDLE hData;
02724     LPSTR lpchClip;
02725     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> cchAdded = 0;
02726     HCURSOR hCursorOld;
02727 
02728 <span class="preprocessor">#ifdef UNDO_CLEANUP           // #ifdef Added in Chicago  - johnl</span>
02729 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o29">fAutoVScroll</a>) {
02730 
02731         <span class="comment">/*</span>
02732 <span class="comment">         * Empty the undo buffer if this edit control limits the amount of text</span>
02733 <span class="comment">         * the user can add to the window rect. This is so that we can undo this</span>
02734 <span class="comment">         * operation if doing in causes us to exceed the window boundaries.</span>
02735 <span class="comment">         */</span>
02736         <a class="code" href="../../d6/d0/usercli_8h.html#a444">ECEmptyUndo</a>(ped);
02737     }
02738 <span class="preprocessor">#endif</span>
02739 <span class="preprocessor"></span>
02740     hCursorOld = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a224">NtUserSetCursor</a>(LoadCursor(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, IDC_WAIT));
02741 
02742     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a17">OpenClipboard</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>))
02743         <span class="keywordflow">goto</span> PasteExitNoCloseClip;
02744 
02745     <span class="keywordflow">if</span> (!(hData = <a class="code" href="../../d3/d8/client_8c.html#a42">GetClipboardData</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> ? CF_TEXT : CF_UNICODETEXT)) ||
02746             (GlobalFlags(hData) == GMEM_INVALID_HANDLE)) {
02747         RIPMSG1(RIP_WARNING, <span class="stringliteral">"MLPasteText(): couldn't get a valid handle(%x)"</span>, hData);
02748         <span class="keywordflow">goto</span> PasteExit;
02749     }
02750 
02751     <span class="comment">/*</span>
02752 <span class="comment">     * See if any text should be deleted</span>
02753 <span class="comment">     */</span>
02754     <a class="code" href="../../d6/d0/usercli_8h.html#a484">MLDeleteText</a>(ped);
02755 
02756     <a class="code" href="../../d6/d0/usercli_8h.html#a4">USERGLOBALLOCK</a>(hData, lpchClip);
02757     <span class="keywordflow">if</span> (lpchClip == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02758         RIPMSG1(RIP_WARNING, <span class="stringliteral">"MLPasteText: USERGLOBALLOCK(%x) failed."</span>, hData);
02759         <span class="keywordflow">goto</span> PasteExit;
02760     }
02761 
02762     <span class="comment">/*</span>
02763 <span class="comment">     * Get the length of the addition.</span>
02764 <span class="comment">     */</span>
02765     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>)
02766         cchAdded = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(lpchClip);
02767     <span class="keywordflow">else</span>
02768         cchAdded = wcslen((LPWSTR)lpchClip);
02769 
02770     <span class="comment">/*</span>
02771 <span class="comment">     * Insert the text (MLInsertText checks line length)</span>
02772 <span class="comment">     */</span>
02773     cchAdded = <a class="code" href="../../d6/d0/usercli_8h.html#a483">MLInsertText</a>(ped, lpchClip, cchAdded, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02774 
02775     <a class="code" href="../../d6/d0/usercli_8h.html#a1">USERGLOBALUNLOCK</a>(hData);
02776 
02777 PasteExit:
02778     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a129">NtUserCloseClipboard</a>();
02779 
02780 PasteExitNoCloseClip:
02781     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a224">NtUserSetCursor</a>(hCursorOld);
02782 
02783     <span class="keywordflow">return</span> (cchAdded);
02784 }
02785 
02786 <span class="comment">/***************************************************************************\</span>
02787 <span class="comment">* MLMouseMotion AorW</span>
02788 <span class="comment">*</span>
02789 <span class="comment">* History:</span>
02790 <span class="comment">\***************************************************************************/</span>
02791 
<a name="l02792"></a><a class="code" href="../../d6/d0/usercli_8h.html#a497">02792</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a497">MLMouseMotion</a>(
02793     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
02794     UINT message,
02795     UINT virtKeyDown,
02796     LPPOINT mousePt)
02797 {
02798     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fChangedSel = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02799 
02800     HDC hdc = <a class="code" href="../../d6/d0/usercli_8h.html#a451">ECGetEditDC</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02801 
02802     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> ichMaxSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a>;
02803     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> ichMinSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a>;
02804 
02805     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> mouseCch;
02806     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a> mouseLine;
02807     <span class="keywordtype">int</span> i, j;
02808     LONG  ll, lh;
02809 
02810     mouseCch = <a class="code" href="../../d1/d5/editml_8c.html#a13">MLMouseToIch</a>(ped, hdc, mousePt, &amp;mouseLine);
02811 
02812     <span class="comment">/*</span>
02813 <span class="comment">     * Save for timer</span>
02814 <span class="comment">     */</span>
02815     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o18">ptPrevMouse</a> = *mousePt;
02816     ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o19">prevKeys</a> = virtKeyDown;
02817 
02818     <span class="keywordflow">switch</span> (message) {
02819     <span class="keywordflow">case</span> WM_LBUTTONDBLCLK:
02820         <span class="comment">/*</span>
02821 <span class="comment">         * if shift key is down, extend selection to word we double clicked on</span>
02822 <span class="comment">         * else clear current selection and select word.</span>
02823 <span class="comment">         */</span>
02824         <span class="comment">// LiZ -- 5/5/93</span>
02825         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o32">fDBCS</a>) {
02826             LPSTR pText = <a class="code" href="../../d6/d0/usercli_8h.html#a433">ECLock</a>(ped);
02827             <a class="code" href="../../d6/d0/usercli_8h.html#a438">ECWord</a>(ped,ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>,
02828                    <a class="code" href="../../d8/d4/editec_8c.html#a55">ECIsDBCSLeadByte</a>(ped, *(pText+(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>)))
02829                         ? <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> :
02830                           (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> == ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o8">iCaretLine</a>]
02831                               ? <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>), &amp;ll, &amp;lh);
02832             <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
02833         } <span class="keywordflow">else</span> {
02834             <a class="code" href="../../d6/d0/usercli_8h.html#a438">ECWord</a>(ped, mouseCch, !(mouseCch == ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[mouseLine]), &amp;ll, &amp;lh);
02835         }
02836         <span class="keywordflow">if</span> (!(virtKeyDown &amp; MK_SHIFT)) {
02837             <span class="comment">// If shift key isn't down, move caret to mouse point and clear</span>
02838             <span class="comment">// old selection</span>
02839             ichMinSel = ll;
02840             ichMaxSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> = lh;
02841         } <span class="keywordflow">else</span> {
02842             <span class="comment">// Shiftkey is down so we want to maintain the current selection</span>
02843             <span class="comment">// (if any) and just extend or reduce it</span>
02844             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a> == ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>) {
02845                 ichMinSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> = ll;
02846                 <a class="code" href="../../d6/d0/usercli_8h.html#a438">ECWord</a>(ped, ichMaxSel, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, &amp;ll, &amp;lh);
02847             } <span class="keywordflow">else</span> {
02848                 ichMaxSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> = lh;
02849                 <a class="code" href="../../d6/d0/usercli_8h.html#a438">ECWord</a>(ped, ichMinSel, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;ll, &amp;lh);
02850             }
02851         }
02852 
02853         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o82">ichStartMinSel</a> = ll;
02854         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o83">ichStartMaxSel</a> = lh;
02855 
02856         <span class="keywordflow">goto</span> InitDragSelect;
02857 
02858     <span class="keywordflow">case</span> WM_MOUSEMOVE:
02859         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o22">fMouseDown</a>) {
02860 
02861             <span class="comment">/*</span>
02862 <span class="comment">             * Set the system timer to automatically scroll when mouse is</span>
02863 <span class="comment">             * outside of the client rectangle. Speed of scroll depends on</span>
02864 <span class="comment">             * distance from window.</span>
02865 <span class="comment">             */</span>
02866             i = mousePt-&gt;y &lt; 0 ? -mousePt-&gt;y : mousePt-&gt;y - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.bottom;
02867             j = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;dtScroll - ((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)i &lt;&lt; 4);
02868             <span class="keywordflow">if</span> (j &lt; 1)
02869                 j = 1;
02870             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a299">NtUserSetSystemTimer</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a56">IDSYS_SCROLL</a>, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)j, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02871 
02872             fChangedSel = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02873 
02874             <span class="comment">// Extend selection, move caret right</span>
02875             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o82">ichStartMinSel</a> || ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o83">ichStartMaxSel</a>) {
02876                 <span class="comment">// We're in WORD SELECT mode</span>
02877                 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fReverse = (mouseCch &lt;= ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o82">ichStartMinSel</a>);
02878                 <a class="code" href="../../d6/d0/usercli_8h.html#a438">ECWord</a>(ped, mouseCch, !fReverse, &amp;ll, &amp;lh);
02879                 <span class="keywordflow">if</span> (fReverse) {
02880                     ichMinSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> = ll;
02881                     ichMaxSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o83">ichStartMaxSel</a>;
02882                 } <span class="keywordflow">else</span> {
02883                     ichMinSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o82">ichStartMinSel</a>;
02884                     ichMaxSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> = lh;
02885                 }
02886             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a> == ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>) &amp;&amp;
02887                     (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a> != ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a>))
02888                 <span class="comment">// Reduce selection extent</span>
02889                 ichMinSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> = mouseCch;
02890             <span class="keywordflow">else</span>
02891                 <span class="comment">// Extend selection extent</span>
02892                 ichMaxSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> = mouseCch;
02893 
02894             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o8">iCaretLine</a> = mouseLine;
02895         }
02896         <span class="keywordflow">break</span>;
02897 
02898     <span class="keywordflow">case</span> WM_LBUTTONDOWN:
02899         ll = lh = mouseCch;
02900 
02901         <span class="keywordflow">if</span> (!(virtKeyDown &amp; MK_SHIFT)) {
02902             <span class="comment">// If shift key isn't down, move caret to mouse point and clear</span>
02903             <span class="comment">// old selection</span>
02904             ichMinSel = ichMaxSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> = mouseCch;
02905         } <span class="keywordflow">else</span> {
02906             <span class="comment">// Shiftkey is down so we want to maintain the current selection</span>
02907             <span class="comment">// (if any) and just extend or reduce it</span>
02908             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a> == ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>)
02909                 ichMinSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> = mouseCch;
02910             <span class="keywordflow">else</span>
02911                 ichMaxSel = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> = mouseCch;
02912         }
02913 
02914         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o82">ichStartMinSel</a> = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o83">ichStartMaxSel</a> = 0;
02915 
02916 InitDragSelect:
02917         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o8">iCaretLine</a> = mouseLine;
02918 
02919         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o22">fMouseDown</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02920         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a221">NtUserSetCapture</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>);
02921         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o22">fMouseDown</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02922         fChangedSel = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02923 
02924         <span class="comment">// Set the timer so that we can scroll automatically when the mouse</span>
02925         <span class="comment">// is moved outside the window rectangle.</span>
02926         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a299">NtUserSetSystemTimer</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a56">IDSYS_SCROLL</a>, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;dtScroll, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02927         <span class="keywordflow">break</span>;
02928 
02929     <span class="keywordflow">case</span> WM_LBUTTONUP:
02930         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o22">fMouseDown</a>) {
02931 
02932             <span class="comment">/*</span>
02933 <span class="comment">             * Kill the timer so that we don't do auto mouse moves anymore</span>
02934 <span class="comment">             */</span>
02935             <a class="code" href="../../d6/d0/usercli_8h.html#a218">NtUserKillSystemTimer</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a56">IDSYS_SCROLL</a>);
02936             <a class="code" href="../../d6/d0/usercli_8h.html#a225">NtUserReleaseCapture</a>();
02937             <a class="code" href="../../d6/d0/usercli_8h.html#a493">MLSetCaretPosition</a>(ped, hdc);
02938             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o22">fMouseDown</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02939         }
02940         <span class="keywordflow">break</span>;
02941     }
02942 
02943 
02944     <span class="keywordflow">if</span> (fChangedSel) {
02945         <a class="code" href="../../d6/d0/usercli_8h.html#a513">MLChangeSelection</a>(ped, hdc, ichMinSel, ichMaxSel);
02946         <a class="code" href="../../d6/d0/usercli_8h.html#a485">MLEnsureCaretVisible</a>(ped);
02947     }
02948 
02949     <a class="code" href="../../d6/d0/usercli_8h.html#a452">ECReleaseEditDC</a>(ped, hdc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02950 
02951     <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o23">fFocus</a> &amp;&amp; (message == WM_LBUTTONDOWN)) {
02952 
02953         <span class="comment">/*</span>
02954 <span class="comment">         * If we don't have the focus yet, get it</span>
02955 <span class="comment">         */</span>
02956         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a225">NtUserSetFocus</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>);
02957     }
02958 }
02959 
02960 <span class="comment">/***************************************************************************\</span>
02961 <span class="comment">* MLScroll AorW</span>
02962 <span class="comment">*</span>
02963 <span class="comment">* History:</span>
02964 <span class="comment">\***************************************************************************/</span>
02965 
<a name="l02966"></a><a class="code" href="../../d6/d0/usercli_8h.html#a517">02966</a> LONG <a class="code" href="../../d6/d0/usercli_8h.html#a517">MLScroll</a>(
02967     <a class="code" href="../../d3/d4/structtagED.html">PED</a>  ped,
02968     BOOL fVertical,
02969     <span class="keywordtype">int</span>  cmd,
02970     <span class="keywordtype">int</span>  iAmt,
02971     BOOL fRedraw)
02972 {
02973     SCROLLINFO  si;
02974     <span class="keywordtype">int</span>         dx = 0;
02975     <span class="keywordtype">int</span>         dy = 0;
02976     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fIncludeLeftMargin;
02977     <span class="keywordtype">int</span>         newPos;
02978     <span class="keywordtype">int</span>         oldPos;
02979     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fUp = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02980     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>        wFlag;
02981     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       dwTime = 0;
02982 
02983     <span class="keywordflow">if</span> (fRedraw &amp;&amp; (cmd != <a class="code" href="../../d1/d5/editml_8c.html#a1">ML_REFRESH</a>)) {
02984         <a class="code" href="../../d3/d8/client_8c.html#a140">UpdateWindow</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>);
02985     }
02986 
02987     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a> &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o51">fRtoLReading</a> &amp;&amp; !fVertical
02988         &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o64">maxPixelWidth</a> &gt; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.right - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.left) {
02989         <span class="comment">/*</span>
02990 <span class="comment">         * Horizontal scoll of a right oriented window with a scrollbar.</span>
02991 <span class="comment">         * Map the logical xOffset to visual coordinates.</span>
02992 <span class="comment">         */</span>
02993         oldPos = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o64">maxPixelWidth</a>
02994                  - ((<span class="keywordtype">int</span>)ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o11">xOffset</a> + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.right - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.left);
02995     } <span class="keywordflow">else</span>
02996         oldPos = (<span class="keywordtype">int</span>) (fVertical ? ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o9">ichScreenStart</a> : ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o11">xOffset</a>);
02997 
02998     fIncludeLeftMargin = (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o11">xOffset</a> == 0);
02999 
03000     <span class="keywordflow">switch</span> (cmd) {
03001         <span class="keywordflow">case</span> <a class="code" href="../../d1/d5/editml_8c.html#a1">ML_REFRESH</a>:
03002             newPos = oldPos;
03003             <span class="keywordflow">break</span>;
03004 
03005         <span class="keywordflow">case</span> EM_GETTHUMB:
03006             <span class="keywordflow">return</span>(oldPos);
03007 
03008         <span class="keywordflow">case</span> SB_THUMBTRACK:
03009         <span class="keywordflow">case</span> SB_THUMBPOSITION:
03010 
03011             <span class="comment">/*</span>
03012 <span class="comment">             * If the edit contains more than 0xFFFF lines</span>
03013 <span class="comment">             * it means that the scrolbar can return a position</span>
03014 <span class="comment">             * that cannot fit in a WORD (16 bits), so use</span>
03015 <span class="comment">             * GetScrollInfo (which is slower) in this case.</span>
03016 <span class="comment">             */</span>
03017             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o4">cLines</a> &lt; 0xFFFF) {
03018                 newPos = iAmt;
03019             } <span class="keywordflow">else</span> {
03020                 SCROLLINFO si;
03021 
03022                 si.cbSize   = <span class="keyword">sizeof</span>(SCROLLINFO);
03023                 si.fMask    = SIF_TRACKPOS;
03024 
03025                 <a class="code" href="../../d3/d8/winmgrc_8c.html#a21">GetScrollInfo</a>( ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, SB_VERT, &amp;si);
03026 
03027                 newPos = si.nTrackPos;
03028             }
03029             <span class="keywordflow">break</span>;
03030 
03031         <span class="keywordflow">case</span> SB_TOP:      <span class="comment">// == SB_LEFT</span>
03032             newPos = 0;
03033             <span class="keywordflow">break</span>;
03034 
03035         <span class="keywordflow">case</span> SB_BOTTOM:   <span class="comment">// == SB_RIGHT</span>
03036             <span class="keywordflow">if</span> (fVertical)
03037                 newPos = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o4">cLines</a>;
03038             <span class="keywordflow">else</span>
03039                 newPos = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o64">maxPixelWidth</a>;
03040             <span class="keywordflow">break</span>;
03041 
03042         <span class="keywordflow">case</span> SB_PAGEUP:   <span class="comment">// == SB_PAGELEFT</span>
03043             fUp = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03044         <span class="keywordflow">case</span> SB_PAGEDOWN: <span class="comment">// == SB_PAGERIGHT</span>
03045 
03046             <span class="keywordflow">if</span> (fVertical)
03047                 iAmt = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o10">ichLinesOnScreen</a> - 1;
03048             <span class="keywordflow">else</span>
03049                 iAmt = (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.right - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.left) - 1;
03050 
03051             <span class="keywordflow">if</span> (iAmt == 0)
03052                 iAmt++;
03053 
03054             <span class="keywordflow">if</span> (fUp)
03055                 iAmt = -iAmt;
03056             <span class="keywordflow">goto</span> AddDelta;
03057 
03058         <span class="keywordflow">case</span> SB_LINEUP:   <span class="comment">// == SB_LINELEFT</span>
03059             fUp = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03060         <span class="keywordflow">case</span> SB_LINEDOWN: <span class="comment">// == SB_LINERIGHT</span>
03061 
03062             dwTime = iAmt;
03063 
03064             iAmt = 1;
03065 
03066             <span class="keywordflow">if</span> (fUp)
03067                 iAmt = -iAmt;
03068 
03069             <span class="comment">//   |             |</span>
03070             <span class="comment">//   |  FALL THRU  |</span>
03071             <span class="comment">//   V             V</span>
03072 
03073         <span class="keywordflow">case</span> EM_LINESCROLL:
03074             <span class="keywordflow">if</span> (!fVertical)
03075                 iAmt *= ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o67">aveCharWidth</a>;
03076 
03077 AddDelta:
03078             newPos = oldPos + iAmt;
03079             <span class="keywordflow">break</span>;
03080 
03081         <span class="keywordflow">default</span>:
03082             <span class="keywordflow">return</span>(0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
03083     }
03084 
03085     <span class="keywordflow">if</span> (fVertical) {
03086         <span class="keywordflow">if</span> (si.nMax = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o4">cLines</a>)
03087             si.nMax--;
03088 
03089         <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o17">hwndParent</a> ||
03090             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(<a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o17">hwndParent</a>), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>))
03091             si.nPage = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o10">ichLinesOnScreen</a>;
03092         <span class="keywordflow">else</span>
03093             si.nPage = 0;
03094 
03095         wFlag = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a641">WFVSCROLL</a>;
03096     } <span class="keywordflow">else</span>         {
03097         si.nMax  = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o64">maxPixelWidth</a>;
03098         si.nPage = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.right - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.left;
03099         wFlag = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a640">WFHSCROLL</a>;
03100     }
03101 
03102     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(<a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>), wFlag)) {
03103         si.cbSize = <span class="keyword">sizeof</span>(SCROLLINFO);
03104         si.fMask = SIF_ALL | SIF_DISABLENOSCROLL;
03105         si.nMin  = 0;
03106         si.nPos = newPos;
03107         newPos = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a228">NtUserSetScrollInfo</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, fVertical ? SB_VERT : SB_HORZ,
03108                                      &amp;si, fRedraw);
03109     } <span class="keywordflow">else</span> {
03110         <span class="comment">// BOGUS -- this is duped code from ScrollBar code</span>
03111         <span class="comment">// but it's for the case when we want to limit the position without</span>
03112         <span class="comment">// actually having the scroll bar</span>
03113         <span class="keywordtype">int</span> iMaxPos;
03114 
03115         <span class="comment">// Clip page to 0, range + 1</span>
03116         si.nPage = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(<a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>((<span class="keywordtype">int</span>)si.nPage, si.nMax + 1), 0);
03117 
03118 
03119         iMaxPos = si.nMax - (si.nPage ? si.nPage - 1 : 0);
03120         newPos = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(newPos, 0), iMaxPos);
03121     }
03122 
03123     oldPos -= newPos;
03124 
03125     <span class="keywordflow">if</span> (!oldPos)
03126         <span class="keywordflow">return</span>(0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
03127 
03128     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a> &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o51">fRtoLReading</a> &amp;&amp; !fVertical
03129         &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o64">maxPixelWidth</a> &gt; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.right - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.left) {
03130         <span class="comment">// Map visual oldPos and newPos back to logical coordinates</span>
03131         newPos = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o64">maxPixelWidth</a>
03132                  - (newPos + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.right - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.left);
03133         oldPos = -oldPos;
03134         <span class="keywordflow">if</span> (newPos&lt;0) {
03135             <span class="comment">// Compensate for scroll bar returning pos &gt; max-page</span>
03136             oldPos += newPos;
03137             newPos=0;
03138         }
03139     }
03140 
03141     <span class="keywordflow">if</span> (fVertical) {
03142         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o9">ichScreenStart</a> = newPos;
03143         dy = oldPos * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o68">lineHeight</a>;
03144     } <span class="keywordflow">else</span> {
03145         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o11">xOffset</a> = newPos;
03146         dx = oldPos;
03147     }
03148 
03149     <span class="keywordflow">if</span> (cmd != SB_THUMBTRACK)
03150         <span class="comment">// We don't want to notify the parent of thumbtracking since they might</span>
03151         <span class="comment">// try to set the thumb position to something bogus.</span>
03152         <span class="comment">// NOTEPAD used to be guilty of this -- but I rewrote it so it's not.</span>
03153         <span class="comment">// The question is WHO ELSE does this? (jeffbog)</span>
03154         <a class="code" href="../../d6/d0/usercli_8h.html#a449">ECNotifyParent</a>(ped, fVertical ? EN_VSCROLL : EN_HSCROLL);
03155 
03156     <span class="keywordflow">if</span> (fRedraw &amp;&amp; <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a17">_IsWindowVisible</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o15">pwnd</a>)) {
03157         RECT    rc;
03158         RECT    rcUpdate;
03159         RECT    rcClipRect;
03160         HDC     hdc;
03161 
03162         <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a19">_GetClientRect</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o15">pwnd</a>, &amp;rc);
03163         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rcClipRect, &amp;ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>);
03164 
03165         <span class="keywordflow">if</span> (fVertical) { <span class="comment">// Is this a vertical scroll?</span>
03166             rcClipRect.left -= ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o80">wLeftMargin</a>;
03167             rcClipRect.right += ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o81">wRightMargin</a>;
03168         }
03169 
03170         <a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rc, &amp;rc, &amp;rcClipRect);
03171         rc.bottom++;
03172 
03173         <span class="comment">/*</span>
03174 <span class="comment">         * Chicago has this HideCaret but there doesn't appear to be a</span>
03175 <span class="comment">         * corresponding ShowCaret, so we lose the Caret under NT when the</span>
03176 <span class="comment">         * EC scrolls - Johnl</span>
03177 <span class="comment">         *</span>
03178 <span class="comment">         * HideCaret(ped-&gt;hwnd);</span>
03179 <span class="comment">         */</span>
03180 
03181         hdc = <a class="code" href="../../d6/d0/usercli_8h.html#a451">ECGetEditDC</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03182         <a class="code" href="../../d6/d0/usercli_8h.html#a450">ECSetEditClip</a>(ped, hdc, fIncludeLeftMargin);
03183         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o66">hFont</a>)
03184             SelectObject(hdc, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o66">hFont</a>);
03185         <a class="code" href="../../d6/d0/usercli_8h.html#a480">ECGetBrush</a>(ped, hdc);
03186 
03187         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a> &amp;&amp; !fVertical) {
03188             <span class="comment">// Horizontal scroll with complex script support</span>
03189             <span class="keywordtype">int</span> xFarOffset = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o11">xOffset</a> + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.right - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.left;
03190 
03191             rc = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>;
03192             <span class="keywordflow">if</span> (dwTime != 0)
03193                 <a class="code" href="../../d3/d8/winmgrc_8c.html#a38">ScrollWindowEx</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o51">fRtoLReading</a> ? -dx : dx, dy, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03194                         &amp;rcUpdate, MAKELONG(SW_SMOOTHSCROLL | SW_SCROLLCHILDREN, dwTime));
03195             <span class="keywordflow">else</span>
03196                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a257">NtUserScrollDC</a>(hdc, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o51">fRtoLReading</a> ? -dx : dx, dy,
03197                                &amp;rc, &amp;rc, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;rcUpdate);
03198 
03199             <span class="comment">// Handle margins: Blank if clipped by horizontal scrolling,</span>
03200             <span class="comment">// display otherwise.</span>
03201             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o80">wLeftMargin</a>) {
03202                 rc.left  = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.left - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o80">wLeftMargin</a>;
03203                 rc.right = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.left;
03204                 <span class="keywordflow">if</span> (   (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o62">format</a> != ES_LEFT)   <span class="comment">// Always display margin for centred or far-aligned text</span>
03205                     ||  <span class="comment">// Display LTR left margin if first character fully visible</span>
03206                         (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o51">fRtoLReading</a> &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o11">xOffset</a> == 0)
03207                     ||  <span class="comment">// Display RTL left margin if last character fully visible</span>
03208                         (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o51">fRtoLReading</a> &amp;&amp; xFarOffset &gt;= ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o64">maxPixelWidth</a>)) {
03209                     <a class="code" href="../../d3/d6/rect_8c.html#a9">UnionRect</a>(&amp;rcUpdate, &amp;rcUpdate, &amp;rc);
03210                 } <span class="keywordflow">else</span> {
03211                     ExtTextOutW(hdc, rc.left, rc.top,
03212                         ETO_CLIPPED | ETO_OPAQUE | ETO_GLYPH_INDEX,
03213                         &amp;rc, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>, 0, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
03214                 }
03215             }
03216             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o81">wRightMargin</a>) {
03217                 rc.left  = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.right;
03218                 rc.right = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.right + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o81">wRightMargin</a>;
03219                 <span class="keywordflow">if</span> (   (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o62">format</a> != ES_LEFT)   <span class="comment">// Always display margin for centred or far-aligned text</span>
03220                     ||  <span class="comment">// Display RTL right margin if first character fully visible</span>
03221                         (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o51">fRtoLReading</a> &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o11">xOffset</a> == 0)
03222                     ||  <span class="comment">// Display LTR right margin if last character fully visible</span>
03223                         (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o51">fRtoLReading</a> &amp;&amp; xFarOffset &gt;= ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o64">maxPixelWidth</a>)) {
03224                     <a class="code" href="../../d3/d6/rect_8c.html#a9">UnionRect</a>(&amp;rcUpdate, &amp;rcUpdate, &amp;rc);
03225                 } <span class="keywordflow">else</span> {
03226                     ExtTextOutW(hdc, rc.left, rc.top,
03227                         ETO_CLIPPED | ETO_OPAQUE | ETO_GLYPH_INDEX,
03228                         &amp;rc, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>, 0, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
03229                 }
03230             }
03231         } <span class="keywordflow">else</span> {
03232             <span class="keywordflow">if</span> (dwTime != 0)
03233                 <a class="code" href="../../d3/d8/winmgrc_8c.html#a38">ScrollWindowEx</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, dx, dy, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03234                         &amp;rcUpdate, MAKELONG(SW_SMOOTHSCROLL | SW_SCROLLCHILDREN, dwTime));
03235             <span class="keywordflow">else</span>
03236                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a257">NtUserScrollDC</a>(hdc, dx, dy, &amp;rc, &amp;rc, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;rcUpdate);
03237 
03238             <span class="comment">// If we need to wipe out the left margin area</span>
03239             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o80">wLeftMargin</a> &amp;&amp; !fVertical) {
03240                 <span class="comment">// Calculate the rectangle to be wiped out</span>
03241                 rc.right = rc.left;
03242                 rc.left = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(0, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.left - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o80">wLeftMargin</a>);
03243                 <span class="keywordflow">if</span> (rc.left &lt; rc.right) {
03244                     <span class="keywordflow">if</span> (fIncludeLeftMargin &amp;&amp; (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o11">xOffset</a> != 0)) {
03245 
03246                         ExtTextOutW(hdc, rc.left, rc.top, ETO_CLIPPED | ETO_OPAQUE,
03247                             &amp;rc, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>, 0, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
03248                     } <span class="keywordflow">else</span>
03249                         <span class="keywordflow">if</span>((!fIncludeLeftMargin) &amp;&amp; (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o11">xOffset</a> == 0))
03250                             <a class="code" href="../../d3/d6/rect_8c.html#a9">UnionRect</a>(&amp;rcUpdate, &amp;rcUpdate, &amp;rc);
03251                 }
03252             }
03253         }
03254         <a class="code" href="../../d6/d0/usercli_8h.html#a493">MLSetCaretPosition</a>(ped,hdc);
03255 
03256         <a class="code" href="../../d6/d0/usercli_8h.html#a452">ECReleaseEditDC</a>(ped, hdc, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03257         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a206">NtUserInvalidateRect</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, &amp;rcUpdate,
03258                 ((ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o10">ichLinesOnScreen</a> + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o9">ichScreenStart</a>) &gt;= ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o4">cLines</a>));
03259         <a class="code" href="../../d3/d8/client_8c.html#a140">UpdateWindow</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>);
03260     }
03261 
03262     <span class="keywordflow">return</span>(MAKELONG(-oldPos, 1));
03263 }
03264 
03265 <span class="comment">/***************************************************************************\</span>
03266 <span class="comment">* MLSetFocus AorW</span>
03267 <span class="comment">*</span>
03268 <span class="comment">* Gives the edit control the focus and notifies the parent</span>
03269 <span class="comment">* EN_SETFOCUS.</span>
03270 <span class="comment">*</span>
03271 <span class="comment">* History:</span>
03272 <span class="comment">\***************************************************************************/</span>
03273 
<a name="l03274"></a><a class="code" href="../../d1/d5/editml_8c.html#a28">03274</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d5/editml_8c.html#a28">MLSetFocus</a>(
03275     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped)
03276 {
03277     HDC hdc;
03278 
03279     <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o23">fFocus</a>) {
03280         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o23">fFocus</a> = 1; <span class="comment">/* Set focus */</span>
03281 
03282         hdc = <a class="code" href="../../d6/d0/usercli_8h.html#a451">ECGetEditDC</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03283 
03284         <span class="comment">/*</span>
03285 <span class="comment">         * Draw the caret. We need to do this even if the window is hidden</span>
03286 <span class="comment">         * because in dlg box initialization time we may set the focus to a</span>
03287 <span class="comment">         * hidden edit control window. If we don't create the caret etc, it will</span>
03288 <span class="comment">         * never end up showing properly.</span>
03289 <span class="comment">         */</span>
03290         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>) {
03291             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>-&gt;<a class="code" href="../../d2/d0/structtagLPKEDITCALLOUT.html#o12">EditCreateCaret</a> (ped, hdc, <a class="code" href="../../d6/d0/usercli_8h.html#a149">ECGetCaretWidth</a>(), ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o68">lineHeight</a>, 0);
03292         }
03293         <span class="keywordflow">else</span> {
03294             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a247">NtUserCreateCaret</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, (HBITMAP)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d0/usercli_8h.html#a149">ECGetCaretWidth</a>(), ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o68">lineHeight</a>);
03295         }
03296         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a234">NtUserShowCaret</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>);
03297         <a class="code" href="../../d6/d0/usercli_8h.html#a493">MLSetCaretPosition</a>(ped, hdc);
03298 
03299         <span class="comment">/*</span>
03300 <span class="comment">         * Show the current selection. Only if the selection was hidden when we</span>
03301 <span class="comment">         * lost the focus, must we invert (show) it.</span>
03302 <span class="comment">         */</span>
03303         <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o31">fNoHideSel</a> &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a> != ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a> &amp;&amp;
03304                 <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a17">_IsWindowVisible</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o15">pwnd</a>))
03305             <a class="code" href="../../d6/d0/usercli_8h.html#a486">MLDrawText</a>(ped, hdc, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a>, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03306 
03307         <a class="code" href="../../d6/d0/usercli_8h.html#a452">ECReleaseEditDC</a>(ped, hdc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03308 
03309     }
03310 <span class="preprocessor">#if 0</span>
03311 <span class="preprocessor"></span>    <a class="code" href="../../d6/d0/usercli_8h.html#a485">MLEnsureCaretVisible</a>(ped);
03312 <span class="preprocessor">#endif</span>
03313 <span class="preprocessor"></span>
03314     <span class="comment">/*</span>
03315 <span class="comment">     * Notify parent we have the focus</span>
03316 <span class="comment">     */</span>
03317     <a class="code" href="../../d6/d0/usercli_8h.html#a449">ECNotifyParent</a>(ped, EN_SETFOCUS);
03318 }
03319 
03320 <span class="comment">/***************************************************************************\</span>
03321 <span class="comment">* MLKillFocus AorW</span>
03322 <span class="comment">*</span>
03323 <span class="comment">* The edit control loses the focus and notifies the parent via</span>
03324 <span class="comment">* EN_KILLFOCUS.</span>
03325 <span class="comment">*</span>
03326 <span class="comment">* History:</span>
03327 <span class="comment">\***************************************************************************/</span>
03328 
<a name="l03329"></a><a class="code" href="../../d1/d5/editml_8c.html#a29">03329</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d5/editml_8c.html#a29">MLKillFocus</a>(
03330     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped)
03331 {
03332     HDC hdc;
03333 
03334     <span class="comment">/*</span>
03335 <span class="comment">     * Reset the wheel delta count.</span>
03336 <span class="comment">     */</span>
03337     <a class="code" href="../../d1/d8/clglobal_8c.html#a1">gcWheelDelta</a> = 0;
03338 
03339     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o23">fFocus</a>) {
03340         ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o23">fFocus</a> = 0; <span class="comment">/* Clear focus */</span>
03341 
03342         <span class="comment">/*</span>
03343 <span class="comment">         * Do this only if we still have the focus. But we always notify the</span>
03344 <span class="comment">         * parent that we lost the focus whether or not we originally had the</span>
03345 <span class="comment">         * focus.</span>
03346 <span class="comment">         */</span>
03347 
03348         <span class="comment">/*</span>
03349 <span class="comment">         * Hide the current selection if needed</span>
03350 <span class="comment">         */</span>
03351         <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o31">fNoHideSel</a> &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a> != ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a> &amp;&amp;
03352             <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a17">_IsWindowVisible</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o15">pwnd</a>)) {
03353             hdc = <a class="code" href="../../d6/d0/usercli_8h.html#a451">ECGetEditDC</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03354             <a class="code" href="../../d6/d0/usercli_8h.html#a486">MLDrawText</a>(ped, hdc, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a>, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03355             <a class="code" href="../../d6/d0/usercli_8h.html#a452">ECReleaseEditDC</a>(ped, hdc, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03356         }
03357 
03358         <span class="comment">/*</span>
03359 <span class="comment">         * Destroy the caret</span>
03360 <span class="comment">         */</span>
03361         <a class="code" href="../../d6/d0/usercli_8h.html#a215">NtUserDestroyCaret</a>();
03362     }
03363 
03364     <span class="comment">/*</span>
03365 <span class="comment">     * Notify parent that we lost the focus.</span>
03366 <span class="comment">     */</span>
03367     <a class="code" href="../../d6/d0/usercli_8h.html#a449">ECNotifyParent</a>(ped, EN_KILLFOCUS);
03368 }
03369 
03370 <span class="comment">/***************************************************************************\</span>
03371 <span class="comment">* MLEnsureCaretVisible AorW</span>
03372 <span class="comment">*</span>
03373 <span class="comment">* Scrolls the caret into the visible region.</span>
03374 <span class="comment">* Returns TRUE if scrolling was done else return s FALSE.</span>
03375 <span class="comment">*</span>
03376 <span class="comment">* History:</span>
03377 <span class="comment">\***************************************************************************/</span>
03378 
<a name="l03379"></a><a class="code" href="../../d6/d0/usercli_8h.html#a485">03379</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d0/usercli_8h.html#a485">MLEnsureCaretVisible</a>(
03380     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped)
03381 {
03382     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>   iLineMax;
03383     <span class="keywordtype">int</span>    xposition;
03384     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>   fPrevLine;
03385     HDC    hdc;
03386     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>   fVScroll = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03387     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>   fHScroll = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03388 
03389     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d9/rtl_2wow_8c.html#a17">_IsWindowVisible</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o15">pwnd</a>)) {
03390         <span class="keywordtype">int</span> iAmt;
03391         <span class="keywordtype">int</span> iFmtWidth = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.right - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.left;
03392 
03393         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o29">fAutoVScroll</a>) {
03394             iLineMax = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o9">ichScreenStart</a> + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o10">ichLinesOnScreen</a> - 1;
03395 
03396             <span class="keywordflow">if</span> (fVScroll = (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o8">iCaretLine</a> &gt; iLineMax))
03397                 iAmt = iLineMax;
03398             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fVScroll = (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o8">iCaretLine</a> &lt; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o9">ichScreenStart</a>))
03399                 iAmt = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o9">ichScreenStart</a>;
03400 
03401             <span class="keywordflow">if</span> (fVScroll)
03402                 <a class="code" href="../../d6/d0/usercli_8h.html#a517">MLScroll</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, EM_LINESCROLL, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o8">iCaretLine</a> - iAmt, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03403         }
03404 
03405         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o30">fAutoHScroll</a> &amp;&amp; ((<span class="keywordtype">int</span>) ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o64">maxPixelWidth</a> &gt; iFmtWidth)) {
03406             POINT pt;
03407             <span class="comment">/* Get the current position of the caret in pixels */</span>
03408             <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>) (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o4">cLines</a> - 1) != ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o8">iCaretLine</a> &amp;&amp;
03409                 ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a> == ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o8">iCaretLine</a> + 1])
03410                 fPrevLine = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03411             <span class="keywordflow">else</span>
03412                 fPrevLine = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03413 
03414             hdc = <a class="code" href="../../d6/d0/usercli_8h.html#a451">ECGetEditDC</a>(ped,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03415             <a class="code" href="../../d6/d0/usercli_8h.html#a494">MLIchToXYPos</a>(ped, hdc, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o7">ichCaret</a>, fPrevLine, &amp;pt);
03416             <a class="code" href="../../d6/d0/usercli_8h.html#a452">ECReleaseEditDC</a>(ped, hdc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03417             xposition = pt.x;
03418 
03419             <span class="comment">// Remember, MLIchToXYPos returns coordinates with respect to the</span>
03420             <span class="comment">// top left pixel displayed on the screen.  Thus, if xPosition &lt; 0,</span>
03421             <span class="comment">// it means xPosition is less than current ped-&gt;xOffset.</span>
03422 
03423             iFmtWidth /= 3;
03424             <span class="keywordflow">if</span> (fHScroll = (xposition &lt; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.left))
03425                 <span class="comment">// scroll to the left</span>
03426                 iAmt = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.left + iFmtWidth;
03427             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fHScroll = (xposition &gt; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.right))
03428                 <span class="comment">// scroll to the right</span>
03429                 iAmt = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.right - iFmtWidth;
03430 
03431             <span class="keywordflow">if</span> (fHScroll)
03432                 <a class="code" href="../../d6/d0/usercli_8h.html#a517">MLScroll</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, EM_LINESCROLL, (xposition - iAmt) / ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o67">aveCharWidth</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03433         }
03434     }
03435     <span class="keywordflow">return</span>(fVScroll);
03436 }
03437 
03438 <span class="comment">/***************************************************************************\</span>
03439 <span class="comment">* MLEditWndProc</span>
03440 <span class="comment">*</span>
03441 <span class="comment">* Class procedure for all multi line edit controls.</span>
03442 <span class="comment">* Dispatches all messages to the appropriate handlers which are named</span>
03443 <span class="comment">* as follows:</span>
03444 <span class="comment">* SL (single line) prefixes all single line edit control procedures while</span>
03445 <span class="comment">* EC (edit control) prefixes all common handlers.</span>
03446 <span class="comment">*</span>
03447 <span class="comment">* The MLEditWndProc only handles messages specific to multi line edit</span>
03448 <span class="comment">* controls.</span>
03449 <span class="comment">*</span>
03450 <span class="comment">* WARNING: If you add a message here, add it to gawEditWndProc[] in</span>
03451 <span class="comment">* kernel\server.c too, otherwise EditWndProcA/W will send it straight to</span>
03452 <span class="comment">* DefWindowProcWorker</span>
03453 <span class="comment">*</span>
03454 <span class="comment">* History:</span>
03455 <span class="comment">\***************************************************************************/</span>
03456 
<a name="l03457"></a><a class="code" href="../../d6/d0/usercli_8h.html#a502">03457</a> LRESULT <a class="code" href="../../d6/d0/usercli_8h.html#a502">MLEditWndProc</a>(
03458     HWND hwnd,
03459     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
03460     UINT message,
03461     WPARAM wParam,
03462     LPARAM lParam)
03463 {
03464     HDC         hdc;
03465     PAINTSTRUCT ps;
03466     LPRECT      lprc;
03467     POINT       pt;
03468     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       windowstyle;
03469 
03470     <span class="keywordflow">switch</span> (message) {
03471 
03472     <span class="keywordflow">case</span> WM_INPUTLANGCHANGE:
03473         <span class="keywordflow">if</span> (ped &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o23">fFocus</a> &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>) {
03474             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a204">NtUserHideCaret</a>(hwnd);
03475             hdc = <a class="code" href="../../d6/d0/usercli_8h.html#a451">ECGetEditDC</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03476             <a class="code" href="../../d6/d0/usercli_8h.html#a215">NtUserDestroyCaret</a>();
03477             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>-&gt;<a class="code" href="../../d2/d0/structtagLPKEDITCALLOUT.html#o12">EditCreateCaret</a> (ped, hdc, <a class="code" href="../../d6/d0/usercli_8h.html#a149">ECGetCaretWidth</a>(), ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o68">lineHeight</a>, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)lParam);
03478             <a class="code" href="../../d6/d0/usercli_8h.html#a493">MLSetCaretPosition</a>(ped, hdc);
03479             <a class="code" href="../../d6/d0/usercli_8h.html#a452">ECReleaseEditDC</a>(ped, hdc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03480             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a234">NtUserShowCaret</a>(hwnd);
03481         }
03482         <span class="keywordflow">goto</span> PassToDefaultWindowProc;
03483 
03484 
03485     <span class="keywordflow">case</span> WM_STYLECHANGED:
03486         <span class="keywordflow">if</span> (ped &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>) {
03487             <span class="keywordflow">switch</span> (wParam) {
03488 
03489                 <span class="keywordflow">case</span> GWL_STYLE:
03490                     <a class="code" href="../../d6/d0/usercli_8h.html#a426">ECUpdateFormat</a>(ped,
03491                         ((LPSTYLESTRUCT)lParam)-&gt;styleNew,
03492                         GetWindowLong(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, GWL_EXSTYLE));
03493                     <span class="keywordflow">return</span> 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
03494 
03495                 <span class="keywordflow">case</span> GWL_EXSTYLE:
03496                     <a class="code" href="../../d6/d0/usercli_8h.html#a426">ECUpdateFormat</a>(ped,
03497                         GetWindowLong(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, GWL_STYLE),
03498                         ((LPSTYLESTRUCT)lParam)-&gt;styleNew);
03499                     <span class="keywordflow">return</span> 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
03500             }
03501         }
03502 
03503         <span class="keywordflow">goto</span> PassToDefaultWindowProc;
03504 
03505     <span class="keywordflow">case</span> WM_CHAR:
03506 
03507         <span class="comment">/*</span>
03508 <span class="comment">         * wParam - the value of the key</span>
03509 <span class="comment">         * lParam - modifiers, repeat count etc (not used)</span>
03510 <span class="comment">         */</span>
03511         <a class="code" href="../../d6/d0/usercli_8h.html#a503">MLChar</a>(ped, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)wParam, 0);
03512         <span class="keywordflow">break</span>;
03513 
03514     <span class="keywordflow">case</span> WM_ERASEBKGND:  {
03515             HBRUSH  hbr;
03516 
03517             <span class="comment">// USE SAME RULES AS IN ECGetBrush()</span>
03518             <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o44">f40Compat</a> &amp;&amp;
03519                 (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o39">fReadOnly</a> || ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o25">fDisabled</a>))
03520                 hbr = (HBRUSH) CTLCOLOR_STATIC;
03521             <span class="keywordflow">else</span>
03522                 hbr = (HBRUSH) CTLCOLOR_EDIT;
03523 
03524             <a class="code" href="../../d6/d0/usercli_8h.html#a234">FillWindow</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o17">hwndParent</a>, hwnd, (HDC)wParam, hbr);
03525         }
03526         <span class="keywordflow">return</span> ((LONG)<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03527 
03528     <span class="keywordflow">case</span> WM_GETDLGCODE: {
03529             LONG code = DLGC_WANTCHARS | DLGC_HASSETSEL | DLGC_WANTARROWS | DLGC_WANTALLKEYS;
03530 
03531             <span class="comment">/*</span>
03532 <span class="comment">             ** !!! JEFFBOG HACK !!!</span>
03533 <span class="comment">             ** Only set Dialog Box Flag if GETDLGCODE message is generated by</span>
03534 <span class="comment">             ** IsDialogMessage -- if so, the lParam will be a pointer to the</span>
03535 <span class="comment">             ** message structure passed to IsDialogMessage; otherwise, lParam</span>
03536 <span class="comment">             ** will be NULL. Reason for the HACK alert: the wParam &amp; lParam</span>
03537 <span class="comment">             ** for GETDLGCODE is still not clearly defined and may end up</span>
03538 <span class="comment">             ** changing in a way that would throw this off</span>
03539 <span class="comment">             **</span>
03540 <span class="comment">             */</span>
03541             <span class="keywordflow">if</span> (lParam)
03542                ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o38">fInDialogBox</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>; <span class="comment">// Mark ML edit ctrl as in a dialog box</span>
03543 
03544             <span class="comment">/*</span>
03545 <span class="comment">             ** If this is a WM_SYSCHAR message generated by the UNDO keystroke</span>
03546 <span class="comment">             ** we want this message so we can EAT IT in "case WM_SYSCHAR:"</span>
03547 <span class="comment">             */</span>
03548             <span class="keywordflow">if</span> (lParam &amp;&amp; (((LPMSG)lParam)-&gt;message == WM_SYSCHAR) &amp;&amp;
03549                     ((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)((LPMSG)lParam)-&gt;lParam &amp; <a class="code" href="../../d3/d5/editsl_8c.html#a0">SYS_ALTERNATE</a>) &amp;&amp;
03550                     ((WORD)wParam == VK_BACK))
03551                  code |= DLGC_WANTMESSAGE;
03552             <span class="keywordflow">return</span> code;
03553         }
03554 
03555     <span class="keywordflow">case</span> EM_SCROLL:
03556         message = WM_VSCROLL;
03557 
03558         <span class="comment">/*</span>
03559 <span class="comment">         * FALL THROUGH</span>
03560 <span class="comment">         */</span>
03561     <span class="keywordflow">case</span> WM_HSCROLL:
03562     <span class="keywordflow">case</span> WM_VSCROLL:
03563         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a517">MLScroll</a>(ped, (message==WM_VSCROLL), LOWORD(wParam), HIWORD(wParam), <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03564 
03565     <span class="keywordflow">case</span> WM_MOUSEWHEEL:
03566         <span class="comment">/*</span>
03567 <span class="comment">         * Don't handle zoom and datazoom.</span>
03568 <span class="comment">         */</span>
03569         <span class="keywordflow">if</span> (wParam &amp; (MK_SHIFT | MK_CONTROL)) {
03570             <span class="keywordflow">goto</span> PassToDefaultWindowProc;
03571         }
03572 
03573         <a class="code" href="../../d1/d8/clglobal_8c.html#a1">gcWheelDelta</a> -= (<span class="keywordtype">short</span>) HIWORD(wParam);
03574         windowstyle = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o15">pwnd</a>-&gt;style;
03575         <span class="keywordflow">if</span> (    <a class="code" href="../../d4/d1/userk_8h.html#a259">abs</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a1">gcWheelDelta</a>) &gt;= WHEEL_DELTA &amp;&amp;
03576                 <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ucWheelScrollLines &gt; 0 &amp;&amp;
03577                 (windowstyle &amp; (WS_VSCROLL | WS_HSCROLL))) {
03578 
03579             <span class="keywordtype">int</span>     cLineScroll;
03580             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fVert;
03581             <span class="keywordtype">int</span>     cPage;
03582 
03583             <span class="keywordflow">if</span> (windowstyle &amp; WS_VSCROLL) {
03584                 fVert = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03585                 cPage = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o10">ichLinesOnScreen</a>;
03586             } <span class="keywordflow">else</span> {
03587                 fVert = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03588                 cPage = (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.right - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.left) / ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o67">aveCharWidth</a>;
03589             }
03590 
03591             <span class="comment">/*</span>
03592 <span class="comment">             * Limit a roll of one (1) WHEEL_DELTA to scroll one (1) page.</span>
03593 <span class="comment">             */</span>
03594             cLineScroll = (<span class="keywordtype">int</span>) <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(
03595                     (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>) (<a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(1, (cPage - 1))),
03596                     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ucWheelScrollLines);
03597 
03598             cLineScroll *= (<a class="code" href="../../d1/d8/clglobal_8c.html#a1">gcWheelDelta</a> / WHEEL_DELTA);
03599             UserAssert(cLineScroll != 0);
03600             <a class="code" href="../../d1/d8/clglobal_8c.html#a1">gcWheelDelta</a> = <a class="code" href="../../d1/d8/clglobal_8c.html#a1">gcWheelDelta</a> % WHEEL_DELTA;
03601             <a class="code" href="../../d6/d0/usercli_8h.html#a517">MLScroll</a>(ped, fVert, EM_LINESCROLL, cLineScroll, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03602         }
03603 
03604         <span class="keywordflow">break</span>;
03605 
03606     <span class="keywordflow">case</span> WM_KEYDOWN:
03607 
03608         <span class="comment">/*</span>
03609 <span class="comment">         * wParam - virt keycode of the given key</span>
03610 <span class="comment">         * lParam - modifiers such as repeat count etc. (not used)</span>
03611 <span class="comment">         */</span>
03612         <a class="code" href="../../d6/d0/usercli_8h.html#a504">MLKeyDown</a>(ped, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)wParam, 0);
03613         <span class="keywordflow">break</span>;
03614 
03615     <span class="keywordflow">case</span> WM_KILLFOCUS:
03616 
03617         <span class="comment">/*</span>
03618 <span class="comment">         * wParam - handle of the window that receives the input focus</span>
03619 <span class="comment">         * lParam - not used</span>
03620 <span class="comment">         */</span>
03621         <a class="code" href="../../d1/d5/editml_8c.html#a29">MLKillFocus</a>(ped);
03622         <span class="keywordflow">break</span>;
03623 
03624     <span class="keywordflow">case</span> WM_CAPTURECHANGED:
03625         <span class="comment">//</span>
03626         <span class="comment">// wParam -- unused</span>
03627         <span class="comment">// lParam -- hwnd of window gaining capture.</span>
03628         <span class="comment">//</span>
03629         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o22">fMouseDown</a>) {
03630             <span class="comment">//</span>
03631             <span class="comment">// We don't change the caret pos here.  If this is happening</span>
03632             <span class="comment">// due to button up, then we'll change the pos in the</span>
03633             <span class="comment">// handler after ReleaseCapture().  Otherwise, just end</span>
03634             <span class="comment">// gracefully because someone else has stolen capture out</span>
03635             <span class="comment">// from under us.</span>
03636             <span class="comment">//</span>
03637 
03638             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o22">fMouseDown</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03639             <a class="code" href="../../d6/d0/usercli_8h.html#a218">NtUserKillSystemTimer</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a56">IDSYS_SCROLL</a>);
03640         }
03641         <span class="keywordflow">break</span>;
03642 
03643     <span class="keywordflow">case</span> <a class="code" href="../../d1/d1/bench_8c.html#a4">WM_SYSTIMER</a>:
03644 
03645         <span class="comment">/*</span>
03646 <span class="comment">         * This allows us to automatically scroll if the user holds the mouse</span>
03647 <span class="comment">         * outside the edit control window. We simulate mouse moves at timer</span>
03648 <span class="comment">         * intervals set in MouseMotionHandler.</span>
03649 <span class="comment">         */</span>
03650         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o22">fMouseDown</a>)
03651             <a class="code" href="../../d6/d0/usercli_8h.html#a497">MLMouseMotion</a>(ped, WM_MOUSEMOVE, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o19">prevKeys</a>, &amp;ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o18">ptPrevMouse</a>);
03652         <span class="keywordflow">break</span>;
03653 
03654     <span class="keywordflow">case</span> WM_MBUTTONDOWN:
03655         <a class="code" href="../../d6/d0/usercli_8h.html#a782">EnterReaderModeHelper</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>);
03656         <span class="keywordflow">break</span>;
03657 
03658     <span class="keywordflow">case</span> WM_MOUSEMOVE:
03659         UserAssert(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o22">fMouseDown</a>);
03660 
03661         <span class="comment">/*</span>
03662 <span class="comment">         * FALL THROUGH</span>
03663 <span class="comment">         */</span>
03664     <span class="keywordflow">case</span> WM_LBUTTONDBLCLK:
03665     <span class="keywordflow">case</span> WM_LBUTTONDOWN:
03666     <span class="keywordflow">case</span> WM_LBUTTONUP:
03667         <span class="comment">/*</span>
03668 <span class="comment">         * wParam - contains a value that indicates which virtual keys are down</span>
03669 <span class="comment">           lParam - contains x and y coords of the mouse cursor</span>
03670 <span class="comment">         */</span>
03671         POINTSTOPOINT(pt, lParam);
03672         <a class="code" href="../../d6/d0/usercli_8h.html#a497">MLMouseMotion</a>(ped, message, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)wParam, &amp;pt);
03673         <span class="keywordflow">break</span>;
03674 
03675     <span class="keywordflow">case</span> WM_CREATE:
03676 
03677         <span class="comment">/*</span>
03678 <span class="comment">         * wParam - handle to window being created</span>
03679 <span class="comment">         * lParam - points to a CREATESTRUCT that contains copies of parameters</span>
03680 <span class="comment">         * passed to the CreateWindow function.</span>
03681 <span class="comment">         */</span>
03682         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a507">MLCreate</a>(ped, (LPCREATESTRUCT)lParam));
03683 
03684     <span class="keywordflow">case</span> WM_PRINTCLIENT:
03685         <a class="code" href="../../d1/d5/editml_8c.html#a22">MLPaint</a>(ped, (HDC) wParam, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03686         <span class="keywordflow">break</span>;
03687 
03688     <span class="keywordflow">case</span> WM_PAINT:
03689         <span class="comment">/*</span>
03690 <span class="comment">         * wParam - can be hdc from subclassed paint</span>
03691 <span class="comment">           lParam - not used</span>
03692 <span class="comment">         */</span>
03693         <span class="keywordflow">if</span> (wParam) {
03694             hdc = (HDC) wParam;
03695             lprc = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03696         } <span class="keywordflow">else</span> {
03697             hdc = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a246">NtUserBeginPaint</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, &amp;ps);
03698             lprc = &amp;ps.rcPaint;
03699         }
03700 
03701         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d9/rtl_2wow_8c.html#a17">_IsWindowVisible</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o15">pwnd</a>))
03702             <a class="code" href="../../d1/d5/editml_8c.html#a22">MLPaint</a>(ped, hdc, lprc);
03703 
03704         <span class="keywordflow">if</span> (!wParam)
03705             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a248">NtUserEndPaint</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, &amp;ps);
03706         <span class="keywordflow">break</span>;
03707 
03708     <span class="keywordflow">case</span> WM_PASTE:
03709 
03710         <span class="comment">/*</span>
03711 <span class="comment">         * wParam - not used</span>
03712 <span class="comment">           lParam - not used</span>
03713 <span class="comment">         */</span>
03714         <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o39">fReadOnly</a>)
03715             <a class="code" href="../../d6/d0/usercli_8h.html#a505">MLPasteText</a>(ped);
03716         <span class="keywordflow">break</span>;
03717 
03718     <span class="keywordflow">case</span> WM_SETFOCUS:
03719 
03720         <span class="comment">/*</span>
03721 <span class="comment">         * wParam - handle of window that loses the input focus (may be NULL)</span>
03722 <span class="comment">           lParam - not used</span>
03723 <span class="comment">         */</span>
03724         <a class="code" href="../../d1/d5/editml_8c.html#a28">MLSetFocus</a>(ped);
03725         <span class="keywordflow">break</span>;
03726 
03727     <span class="keywordflow">case</span> WM_SIZE:
03728 
03729         <span class="comment">/*</span>
03730 <span class="comment">         * wParam - defines the type of resizing fullscreen, sizeiconic,</span>
03731 <span class="comment">                    sizenormal etc.</span>
03732 <span class="comment">           lParam - new width in LOWORD, new height in HIGHWORD of client area</span>
03733 <span class="comment">         */</span>
03734         <a class="code" href="../../d6/d0/usercli_8h.html#a482">ECSize</a>(ped, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03735         <span class="keywordflow">break</span>;
03736 
03737     <span class="keywordflow">case</span> EM_FMTLINES:
03738 
03739         <span class="comment">/*</span>
03740 <span class="comment">         * wParam - indicates disposition of end-of-line chars. If non</span>
03741 <span class="comment">         * zero, the chars CR CR LF are placed at the end of a word</span>
03742 <span class="comment">         * wrapped line. If wParam is zero, the end of line chars are</span>
03743 <span class="comment">         * removed. This is only done when the user gets a handle (via</span>
03744 <span class="comment">         * EM_GETHANDLE) to the text. lParam - not used.</span>
03745 <span class="comment">         */</span>
03746         <span class="keywordflow">if</span> (wParam)
03747             <a class="code" href="../../d6/d0/usercli_8h.html#a508">MLInsertCrCrLf</a>(ped);
03748         <span class="keywordflow">else</span>
03749             <a class="code" href="../../d6/d0/usercli_8h.html#a499">MLStripCrCrLf</a>(ped);
03750         <a class="code" href="../../d6/d0/usercli_8h.html#a490">MLBuildchLines</a>(ped, 0, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03751         <span class="keywordflow">return</span> (LONG)(wParam != 0);
03752 
03753     <span class="keywordflow">case</span> EM_GETHANDLE:
03754 
03755         <span class="comment">/*</span>
03756 <span class="comment">         * wParam - not used</span>
03757 <span class="comment">            lParam - not used</span>
03758 <span class="comment">         */</span>
03759 
03760         <span class="comment">/*</span>
03761 <span class="comment">         * Returns a handle to the edit control's text.</span>
03762 <span class="comment">         */</span>
03763 
03764         <span class="comment">/*</span>
03765 <span class="comment">         * Null terminate the string. Note that we are guaranteed to have the</span>
03766 <span class="comment">         * memory for the NULL since ECInsertText allocates an extra</span>
03767 <span class="comment">         * WCHAR for the NULL terminator.</span>
03768 <span class="comment">         */</span>
03769 
03770         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>)
03771             *(<a class="code" href="../../d6/d0/usercli_8h.html#a433">ECLock</a>(ped) + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>) = 0;
03772         <span class="keywordflow">else</span>
03773             *((LPWSTR)<a class="code" href="../../d6/d0/usercli_8h.html#a433">ECLock</a>(ped) + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a>) = 0;
03774         <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
03775         <span class="keywordflow">return</span> ((LRESULT)ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o0">hText</a>);
03776 
03777     <span class="keywordflow">case</span> EM_GETLINE:
03778 
03779         <span class="comment">/*</span>
03780 <span class="comment">         * wParam - line number to copy (0 is first line)</span>
03781 <span class="comment">         * lParam - buffer to copy text to. First WORD is max # of bytes to</span>
03782 <span class="comment">         * copy</span>
03783 <span class="comment">         */</span>
03784         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a510">MLGetLine</a>(ped, (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>)wParam, (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>)*(WORD UNALIGNED *)lParam, (LPSTR)lParam);
03785 
03786     <span class="keywordflow">case</span> EM_LINEFROMCHAR:
03787 
03788         <span class="comment">/*</span>
03789 <span class="comment">         * wParam - Contains the index value for the desired char in the text</span>
03790 <span class="comment">         * of the edit control. These are 0 based.</span>
03791 <span class="comment">         * lParam - not used</span>
03792 <span class="comment">         */</span>
03793         <span class="keywordflow">return</span> (LRESULT)<a class="code" href="../../d6/d0/usercli_8h.html#a495">MLIchToLine</a>(ped, (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>)wParam);
03794 
03795     <span class="keywordflow">case</span> EM_LINEINDEX:
03796 
03797         <span class="comment">/*</span>
03798 <span class="comment">         * wParam - specifies the desired line number where the number of the</span>
03799 <span class="comment">         * first line is 0. If linenumber = 0, the line with the caret is used.</span>
03800 <span class="comment">         * lParam - not used.</span>
03801 <span class="comment">         * This function return s the number of character positions that occur</span>
03802 <span class="comment">         * preceeding the first char in a given line.</span>
03803 <span class="comment">         */</span>
03804         <span class="keywordflow">return</span> (LRESULT)<a class="code" href="../../d6/d0/usercli_8h.html#a511">MLLineIndex</a>(ped, (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>)wParam);
03805 
03806     <span class="keywordflow">case</span> EM_LINELENGTH:
03807 
03808         <span class="comment">/*</span>
03809 <span class="comment">         * wParam - specifies the character index of a character in the</span>
03810 <span class="comment">           specified line, where the first line is 0. If -1, the length</span>
03811 <span class="comment">           of the current line (with the caret) is return ed not including the</span>
03812 <span class="comment">           length of any selected text.</span>
03813 <span class="comment">           lParam - not used</span>
03814 <span class="comment">         */</span>
03815         <span class="keywordflow">return</span> (LRESULT)<a class="code" href="../../d6/d0/usercli_8h.html#a520">MLLineLength</a>(ped, (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>)wParam);
03816 
03817     <span class="keywordflow">case</span> EM_LINESCROLL:
03818 
03819         <span class="comment">/*</span>
03820 <span class="comment">         * wParam - not used</span>
03821 <span class="comment">           lParam - Contains the number of lines and char positions to scroll</span>
03822 <span class="comment">         */</span>
03823         <a class="code" href="../../d6/d0/usercli_8h.html#a517">MLScroll</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,  EM_LINESCROLL, (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03824         <a class="code" href="../../d6/d0/usercli_8h.html#a517">MLScroll</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, EM_LINESCROLL, (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)wParam, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03825         <span class="keywordflow">break</span>;
03826 
03827     <span class="keywordflow">case</span> EM_REPLACESEL:
03828 
03829         <span class="comment">/*</span>
03830 <span class="comment">         * wParam - flag for 4.0+ apps saying whether to clear undo</span>
03831 <span class="comment">           lParam - Points to a null terminated replacement text.</span>
03832 <span class="comment">         */</span>
03833         <a class="code" href="../../d6/d0/usercli_8h.html#a521">MLReplaceSel</a>(ped, (LPSTR)lParam);
03834         <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o44">f40Compat</a> || !wParam)
03835             <a class="code" href="../../d6/d0/usercli_8h.html#a444">ECEmptyUndo</a>(<a class="code" href="../../d6/d0/usercli_8h.html#a85">Pundo</a>(ped));
03836         <span class="keywordflow">break</span>;
03837 
03838     <span class="keywordflow">case</span> EM_SETHANDLE:
03839 
03840         <span class="comment">/*</span>
03841 <span class="comment">         * wParam - contains a handle to the text buffer</span>
03842 <span class="comment">           lParam - not used</span>
03843 <span class="comment">         */</span>
03844         <a class="code" href="../../d6/d0/usercli_8h.html#a509">MLSetHandle</a>(ped, (HANDLE)wParam);
03845         <span class="keywordflow">break</span>;
03846 
03847     <span class="keywordflow">case</span> EM_SETRECT:
03848     <span class="keywordflow">case</span> EM_SETRECTNP:
03849 
03850         <span class="comment">//</span>
03851         <span class="comment">// wParamLo --    not used</span>
03852         <span class="comment">// lParam --    LPRECT with new formatting area</span>
03853         <span class="comment">//</span>
03854         <a class="code" href="../../d6/d0/usercli_8h.html#a482">ECSize</a>(ped, (LPRECT) lParam, (message != EM_SETRECTNP));
03855         <span class="keywordflow">break</span>;
03856 
03857     <span class="keywordflow">case</span> EM_SETSEL:
03858 
03859         <span class="comment">/*</span>
03860 <span class="comment">         * wParam - Under 3.1, specifies if we should scroll caret into</span>
03861 <span class="comment">         * view or not. 0 == scroll into view. 1 == don't scroll</span>
03862 <span class="comment">         * lParam - starting pos in lowword ending pos in high word</span>
03863 <span class="comment">         *</span>
03864 <span class="comment">         * Under Win32, wParam is the starting pos, lParam is the</span>
03865 <span class="comment">         * ending pos, and the caret is not scrolled into view.</span>
03866 <span class="comment">         * The message EM_SCROLLCARET forces the caret to be scrolled</span>
03867 <span class="comment">         * into view.</span>
03868 <span class="comment">         */</span>
03869         <a class="code" href="../../d6/d0/usercli_8h.html#a506">MLSetSelection</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>)wParam, (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>)lParam);
03870         <span class="keywordflow">break</span>;
03871 
03872     <span class="keywordflow">case</span> EM_SCROLLCARET:
03873 
03874         <span class="comment">/*</span>
03875 <span class="comment">         * Scroll caret into view</span>
03876 <span class="comment">         */</span>
03877         <a class="code" href="../../d6/d0/usercli_8h.html#a485">MLEnsureCaretVisible</a>(ped);
03878         <span class="keywordflow">break</span>;
03879 
03880     <span class="keywordflow">case</span> EM_GETFIRSTVISIBLELINE:
03881 
03882         <span class="comment">/*</span>
03883 <span class="comment">         * Returns the first visible line for multiline edit controls.</span>
03884 <span class="comment">         */</span>
03885         <span class="keywordflow">return</span> (LONG)ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o9">ichScreenStart</a>;
03886 
03887     <span class="keywordflow">case</span> WM_SYSKEYDOWN:
03888         <span class="keywordflow">if</span> (((WORD)wParam == VK_BACK) &amp;&amp; ((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)lParam &amp; <a class="code" href="../../d3/d5/editsl_8c.html#a0">SYS_ALTERNATE</a>)) {
03889             <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, EM_UNDO, 0, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
03890             <span class="keywordflow">break</span>;
03891         }
03892         <span class="keywordflow">goto</span> PassToDefaultWindowProc;
03893 
03894     <span class="keywordflow">case</span> WM_UNDO:
03895     <span class="keywordflow">case</span> EM_UNDO:
03896         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a501">MLUndo</a>(ped);
03897 
03898     <span class="keywordflow">case</span> EM_SETTABSTOPS:
03899 
03900         <span class="comment">/*</span>
03901 <span class="comment">         * This sets the tab stop positions for multiline edit controls.</span>
03902 <span class="comment">         * wParam - Number of tab stops</span>
03903 <span class="comment">         * lParam - Far ptr to a UINT array containing the Tab stop positions</span>
03904 <span class="comment">         */</span>
03905         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a516">MLSetTabStops</a>(ped, (<span class="keywordtype">int</span>)wParam, (LPINT)lParam);
03906 
03907     <span class="keywordflow">case</span> EM_POSFROMCHAR:
03908         <span class="comment">//</span>
03909         <span class="comment">// wParam --    char index in text</span>
03910         <span class="comment">// lParam --    not used</span>
03911         <span class="comment">// This function returns the (x,y) position of the character</span>
03912         <span class="comment">//</span>
03913     <span class="keywordflow">case</span> EM_CHARFROMPOS:
03914         <span class="comment">//</span>
03915         <span class="comment">// wParam --    unused</span>
03916         <span class="comment">// lParam --    pt in client coordinates</span>
03917         <span class="comment">// This function returns</span>
03918         <span class="comment">//      LOWORD: the position of the closest character</span>
03919         <span class="comment">//              to the passed in point.  Beware of</span>
03920         <span class="comment">//              points not actually in the edit client...</span>
03921         <span class="comment">//      HIWORD: the index of the line the char is on</span>
03922         <span class="comment">//</span>
03923         {
03924             LONG  xyPos;
03925             LONG  line;
03926 
03927             hdc = <a class="code" href="../../d6/d0/usercli_8h.html#a451">ECGetEditDC</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03928 
03929             <span class="keywordflow">if</span> (message == EM_POSFROMCHAR) {
03930                 <a class="code" href="../../d6/d0/usercli_8h.html#a494">MLIchToXYPos</a>(ped, hdc, (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>)wParam, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;pt);
03931                 xyPos = MAKELONG(pt.x, pt.y);
03932             } <span class="keywordflow">else</span> {
03933                 POINTSTOPOINT(pt, lParam);
03934                 xyPos = <a class="code" href="../../d1/d5/editml_8c.html#a13">MLMouseToIch</a>(ped, hdc, &amp;pt, &amp;line);
03935                 xyPos = MAKELONG(xyPos, line);
03936             }
03937 
03938             <a class="code" href="../../d6/d0/usercli_8h.html#a452">ECReleaseEditDC</a>(ped, hdc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03939             <span class="keywordflow">return</span>((LRESULT)xyPos);
03940             <span class="keywordflow">break</span>;
03941         }
03942 
03943     <span class="keywordflow">case</span> WM_SETREDRAW:
03944         <a class="code" href="../../d6/d0/usercli_8h.html#a610">DefWindowProcWorker</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o15">pwnd</a>, message, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03945         <span class="keywordflow">if</span> (wParam) {
03946 
03947             <span class="comment">/*</span>
03948 <span class="comment">             * Backwards compatability hack needed so that winraid's edit</span>
03949 <span class="comment">             * controls work fine.</span>
03950 <span class="comment">             */</span>
03951             <a class="code" href="../../d6/d0/usercli_8h.html#a239">RedrawWindow</a>(hwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, RDW_INVALIDATE | RDW_ERASE | RDW_FRAME);
03952         }
03953       <span class="keywordflow">break</span>;
03954 
03955 <span class="preprocessor">#if LATER</span>
03956 <span class="preprocessor"></span>    <span class="keywordflow">case</span> WM_IME_ENDCOMPOSITION:
03957         <a class="code" href="../../d6/d0/usercli_8h.html#a477">ECInOutReconversionMode</a>(ped, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03958         <span class="keywordflow">break</span>;
03959 <span class="preprocessor">#endif</span>
03960 <span class="preprocessor"></span>
03961     <span class="keywordflow">default</span>:
03962 PassToDefaultWindowProc:
03963         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a610">DefWindowProcWorker</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o15">pwnd</a>, message, wParam, lParam, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a>);
03964     }
03965 
03966     <span class="keywordflow">return</span> 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
03967 } <span class="comment">/* MLEditWndProc */</span>
03968 
03969 
03970 <span class="comment">/***************************************************************************\</span>
03971 <span class="comment">* MLDrawText AorW</span>
03972 <span class="comment">*</span>
03973 <span class="comment">*  This function draws all the characters between ichStart and ichEnd for</span>
03974 <span class="comment">*  the given Multiline Edit Control.</span>
03975 <span class="comment">*</span>
03976 <span class="comment">*  This function divides the block of text between ichStart and ichEnd</span>
03977 <span class="comment">*  into lines and each line into strips of text based on the selection</span>
03978 <span class="comment">*  attributes. It calls ECTabTheTextOut() to draw each strip.</span>
03979 <span class="comment">*  This takes care of the Negative A anc C widths of the current font, if</span>
03980 <span class="comment">*  it has any, on either side of each strip of text.</span>
03981 <span class="comment">*</span>
03982 <span class="comment">*  NOTE: If the language pack is loaded the text is not divided into strips,</span>
03983 <span class="comment">*  nor is selection highlighting performed here. Whole lines are passed</span>
03984 <span class="comment">*  to the language pack to display with tab expansion and selection</span>
03985 <span class="comment">*  highlighting. (Since the language pack supports scripts with complex</span>
03986 <span class="comment">*  character re-ordering rules, only it can do this).</span>
03987 <span class="comment">*</span>
03988 <span class="comment">* History:</span>
03989 <span class="comment">\***************************************************************************/</span>
03990 
<a name="l03991"></a><a class="code" href="../../d6/d0/usercli_8h.html#a486">03991</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a486">MLDrawText</a>(
03992     <a class="code" href="../../d3/d4/structtagED.html">PED</a> ped,
03993     HDC hdc,
03994     ICH ichStart,
03995     ICH ichEnd,
03996     BOOL fSelChange)
03997 {
03998     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   textColorSave;
03999     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   bkColorSave;
04000     PSTR    pText;
04001     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>    wCurLine;
04002     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>    wEndLine;
04003     <span class="keywordtype">int</span>     xOffset;
04004     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>     LengthToDraw;
04005     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>     CurStripLength;
04006     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>     ichAttrib, ichNewStart;
04007     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>     ExtraLengthForNegA;
04008     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a980">ICH</a>     ichT;
04009     <span class="keywordtype">int</span>     iRemainingLengthInLine;
04010     <span class="keywordtype">int</span>     xStPos, xClipStPos, xClipEndPos, yPos;
04011     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fFirstLineOfBlock   = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04012     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fDrawEndOfLineStrip = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04013     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fDrawOnSameLine     = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04014     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fSelected                = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04015     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fLineBegins      = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04016     <a class="code" href="../../d6/d7/structSTRIPINFO.html">STRIPINFO</a>   NegCInfo;
04017     POINT   pt;
04018 
04019     <span class="comment">//</span>
04020     <span class="comment">// Just return if nothing to draw</span>
04021     <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o10">ichLinesOnScreen</a>)
04022         <span class="keywordflow">return</span>;
04023 
04024     <a class="code" href="../../d6/d0/usercli_8h.html#a480">ECGetBrush</a>(ped, hdc);
04025 
04026     <span class="comment">//</span>
04027     <span class="comment">// Adjust the value of ichStart such that we need to draw only those lines</span>
04028     <span class="comment">// visible on the screen.</span>
04029     <span class="comment">//</span>
04030     <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)ichStart &lt; (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o9">ichScreenStart</a>]) {
04031         ichStart = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o9">ichScreenStart</a>];
04032         <span class="keywordflow">if</span> (ichStart &gt; ichEnd)
04033             <span class="keywordflow">return</span>;
04034     }
04035 
04036     <span class="comment">// Adjust the value of ichEnd such that we need to draw only those lines</span>
04037     <span class="comment">// visible on the screen.</span>
04038     wCurLine = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o9">ichScreenStart</a>+ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o10">ichLinesOnScreen</a>,ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o4">cLines</a>-1);
04039     ichT = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[wCurLine] + <a class="code" href="../../d6/d0/usercli_8h.html#a498">MLLine</a>(ped, wCurLine);
04040     ichEnd = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(ichEnd, ichT);
04041 
04042     wCurLine = <a class="code" href="../../d6/d0/usercli_8h.html#a495">MLIchToLine</a>(ped, ichStart);    <span class="comment">// Starting line.</span>
04043     wEndLine = <a class="code" href="../../d6/d0/usercli_8h.html#a495">MLIchToLine</a>(ped, ichEnd);           <span class="comment">// Ending line.</span>
04044 
04045     UserAssert(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[wCurLine] &lt;= ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a> + 1);
04046     UserAssert(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[wEndLine] &lt;= ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o3">cch</a> + 1);
04047 
04048     <span class="keywordflow">if</span> (fSelChange &amp;&amp; (GetBkMode(hdc) != OPAQUE))
04049     {
04050         <span class="comment">/*</span>
04051 <span class="comment">         * if changing selection on a transparent edit control, just</span>
04052 <span class="comment">         * draw those lines from scratch</span>
04053 <span class="comment">         */</span>
04054         RECT rcStrip;
04055         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rcStrip, &amp;ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>);
04056         rcStrip.left -= ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o80">wLeftMargin</a>;
04057         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>) {
04058             rcStrip.right += ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o81">wRightMargin</a>;
04059         }
04060         rcStrip.top += (wCurLine - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o9">ichScreenStart</a>) * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o68">lineHeight</a>;
04061         rcStrip.bottom = rcStrip.top + ((wEndLine - wCurLine) + 1) * ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o68">lineHeight</a>;
04062         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a206">NtUserInvalidateRect</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>, &amp;rcStrip, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04063         <span class="keywordflow">return</span>;
04064     }
04065 
04066     <span class="comment">// If it is either centered or right-justified, then draw the whole lines.</span>
04067     <span class="comment">// Also draw whole lines if the language pack is handling line layout.</span>
04068     <span class="keywordflow">if</span> ((ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o62">format</a> != ES_LEFT) || (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>)) {
04069         ichStart = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[wCurLine];
04070         ichEnd = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[wEndLine] + <a class="code" href="../../d6/d0/usercli_8h.html#a498">MLLine</a>(ped, wEndLine);
04071     }
04072 
04073     pText = <a class="code" href="../../d6/d0/usercli_8h.html#a433">ECLock</a>(ped);
04074 
04075     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a204">NtUserHideCaret</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>);
04076 
04077     <span class="comment">//</span>
04078     <span class="comment">// If ichStart stays on Second byte of DBCS, we have to</span>
04079     <span class="comment">// adjust it. LiZ -- 5/5/93</span>
04080     <span class="comment">//</span>
04081     <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o32">fDBCS</a>) {
04082         ichStart = <a class="code" href="../../d6/d0/usercli_8h.html#a461">ECAdjustIch</a>( ped, pText, ichStart );
04083     }
04084     UserAssert(ichStart &lt;= ped-&gt;cch);
04085     UserAssert(ichEnd &lt;= ped-&gt;cch);
04086 
04087     <span class="keywordflow">while</span> (ichStart &lt;= ichEnd) {
04088         <span class="comment">// Pass whole lines to the language pack to display with selection</span>
04089         <span class="comment">// marking and tab expansion.</span>
04090         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>) {
04091             ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o84">pLpkEditCallout</a>-&gt;<a class="code" href="../../d2/d0/structtagLPKEDITCALLOUT.html#o5">EditDrawText</a>(
04092                 ped, hdc, pText + ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>*ichStart,
04093                 <a class="code" href="../../d1/d5/editml_8c.html#a9">MLLine</a>(ped, wCurLine),
04094                 (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a> - (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)ichStart, (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a> - (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)ichStart,
04095                 <a class="code" href="../../d1/d5/editml_8c.html#a11">MLIchToYPos</a>(ped, ichStart, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>));
04096         } <span class="keywordflow">else</span> {
04097         <span class="comment">// xStPos:      The starting Position where the string must be drawn.</span>
04098         <span class="comment">// xClipStPos:  The starting position for the clipping rect for the block.</span>
04099         <span class="comment">// xClipEndPos: The ending position for the clipping rect for the block.</span>
04100 
04101         <span class="comment">// Calculate the xyPos of starting point of the block.</span>
04102         <a class="code" href="../../d6/d0/usercli_8h.html#a494">MLIchToXYPos</a>(ped, hdc, ichStart, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;pt);
04103         xClipStPos = xStPos = pt.x;
04104         yPos = pt.y;
04105 
04106         <span class="comment">// The attributes of the block is the same as that of ichStart.</span>
04107         ichAttrib = ichStart;
04108 
04109         <span class="comment">// If the current font has some negative C widths and if this is the</span>
04110         <span class="comment">// begining of a block, we must start drawing some characters before the</span>
04111         <span class="comment">// block to account for the negative C widths of the strip before the</span>
04112         <span class="comment">// current strip; In this case, reset ichStart and xStPos.</span>
04113 
04114         <span class="keywordflow">if</span> (fFirstLineOfBlock &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o78">wMaxNegC</a>) {
04115             fFirstLineOfBlock = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04116             ichNewStart = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(((<span class="keywordtype">int</span>)(ichStart - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o79">wMaxNegCcharPos</a>)), ((<span class="keywordtype">int</span>)ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[wCurLine]));
04117 
04118             <span class="comment">// If ichStart needs to be changed, then change xStPos also accordingly.</span>
04119             <span class="keywordflow">if</span> (ichNewStart != ichStart) {
04120                 <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o32">fDBCS</a>) {
04121                     <span class="comment">//</span>
04122                     <span class="comment">// Adjust DBCS alignment...</span>
04123                     <span class="comment">//</span>
04124                     ichNewStart = <a class="code" href="../../d6/d0/usercli_8h.html#a462">ECAdjustIchNext</a>( ped, pText, ichNewStart );
04125                 }
04126                 <a class="code" href="../../d6/d0/usercli_8h.html#a494">MLIchToXYPos</a>(ped, hdc, ichStart = ichNewStart, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;pt);
04127                 xStPos = pt.x;
04128             }
04129         }
04130 
04131         <span class="comment">// Calc the number of characters remaining to be drawn in the current line.</span>
04132         iRemainingLengthInLine = <a class="code" href="../../d6/d0/usercli_8h.html#a498">MLLine</a>(ped, wCurLine) -
04133                                 (ichStart - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[wCurLine]);
04134 
04135         <span class="comment">// If this is the last line of a block, we may not have to draw all the</span>
04136         <span class="comment">// remaining lines; We must draw only upto ichEnd.</span>
04137         <span class="keywordflow">if</span> (wCurLine == wEndLine)
04138             LengthToDraw = ichEnd - ichStart;
04139         <span class="keywordflow">else</span>
04140             LengthToDraw = iRemainingLengthInLine;
04141 
04142         <span class="comment">// Find out how many pixels we indent the line for non-left-justified</span>
04143         <span class="comment">// formats</span>
04144         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o62">format</a> != ES_LEFT)
04145             xOffset = <a class="code" href="../../d6/d0/usercli_8h.html#a500">MLCalcXOffset</a>(ped, hdc, wCurLine);
04146         <span class="keywordflow">else</span>
04147             xOffset = -((<span class="keywordtype">int</span>)(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o11">xOffset</a>));
04148 
04149         <span class="comment">// Check if this is the begining of a line.</span>
04150         <span class="keywordflow">if</span> (ichAttrib == ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[wCurLine]) {
04151             fLineBegins = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04152             xClipStPos = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.left - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o80">wLeftMargin</a>;
04153         }
04154 
04155         <span class="comment">//</span>
04156         <span class="comment">// The following loop divides this 'wCurLine' into strips based on the</span>
04157         <span class="comment">// selection attributes and draw them strip by strip.</span>
04158         <span class="keywordflow">do</span>  {
04159             <span class="comment">//</span>
04160             <span class="comment">// If ichStart is pointing at CRLF or CRCRLF, then iRemainingLength</span>
04161             <span class="comment">// could have become negative because MLLine does not include</span>
04162             <span class="comment">// CR and LF at the end of a line.</span>
04163             <span class="comment">//</span>
04164             <span class="keywordflow">if</span> (iRemainingLengthInLine &lt; 0)  <span class="comment">// If Current line is completed,</span>
04165                 <span class="keywordflow">break</span>;                   <span class="comment">// go on to the next line.</span>
04166 
04167             <span class="comment">//</span>
04168             <span class="comment">// Check if a part of the block is selected and if we need to</span>
04169             <span class="comment">// show it with a different attribute.</span>
04170             <span class="comment">//</span>
04171             <span class="keywordflow">if</span> (!(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a> == ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a> ||
04172                         ichAttrib &gt;= ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a> ||
04173                         ichEnd   &lt;  ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a> ||
04174                         (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o31">fNoHideSel</a> &amp;&amp; !ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o23">fFocus</a>))) {
04175                 <span class="comment">//</span>
04176                 <span class="comment">// OK! There is a selection somewhere in this block!</span>
04177                 <span class="comment">// Check if this strip has selection attribute.</span>
04178                 <span class="comment">//</span>
04179                 <span class="keywordflow">if</span> (ichAttrib &lt; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a>) {
04180                     fSelected = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;  <span class="comment">// This strip is not selected</span>
04181 
04182                     <span class="comment">// Calculate the length of this strip with normal attribute.</span>
04183                     CurStripLength = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(ichStart+LengthToDraw, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o5">ichMinSel</a>)-ichStart;
04184                     fLineBegins = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04185                 } <span class="keywordflow">else</span> {
04186                     <span class="comment">// The current strip has the selection attribute.</span>
04187                     <span class="keywordflow">if</span> (fLineBegins) {  <span class="comment">// Is it the first part of a line?</span>
04188                         <span class="comment">// Then, draw the left margin area with normal attribute.</span>
04189                         fSelected = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04190                         CurStripLength = 0;
04191                         xClipStPos = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.left - ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o80">wLeftMargin</a>;
04192                         fLineBegins = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04193                     } <span class="keywordflow">else</span> {
04194                         <span class="comment">// Else, draw the strip with selection attribute.</span>
04195                         fSelected = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04196                         CurStripLength = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(ichStart+LengthToDraw, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o6">ichMaxSel</a>)-ichStart;
04197 
04198                         <span class="comment">// Select in the highlight colors.</span>
04199                         bkColorSave = SetBkColor(hdc, <a class="code" href="../../d3/d9/client_2wow_8c.html#a15">GetSysColor</a>(COLOR_HIGHLIGHT));
04200                         <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o25">fDisabled</a>)
04201                             textColorSave = SetTextColor(hdc, <a class="code" href="../../d3/d9/client_2wow_8c.html#a15">GetSysColor</a>(COLOR_HIGHLIGHTTEXT));
04202                     }
04203                 }
04204             } <span class="keywordflow">else</span> {
04205                 <span class="comment">// The whole strip has no selection attributes.</span>
04206                 CurStripLength = LengthToDraw;
04207             }
04208 
04209             <span class="comment">//</span>
04210             <span class="comment">// Other than the current strip, do we still have anything</span>
04211             <span class="comment">// left to be drawn in the current line?</span>
04212             <span class="comment">//</span>
04213             fDrawOnSameLine = (LengthToDraw != CurStripLength);
04214 
04215             <span class="comment">//</span>
04216             <span class="comment">// When we draw this strip, we need to draw some more characters</span>
04217             <span class="comment">// beyond the end of this strip to account for the negative A</span>
04218             <span class="comment">// widths of the characters that follow this strip.</span>
04219             <span class="comment">//</span>
04220             ExtraLengthForNegA = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(iRemainingLengthInLine-CurStripLength, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o77">wMaxNegAcharPos</a>);
04221 
04222             <span class="comment">//</span>
04223             <span class="comment">// The blank strip at the end of the line needs to be drawn with</span>
04224             <span class="comment">// normal attribute irrespective of whether the line has selection</span>
04225             <span class="comment">// attribute or not. Hence, if the last strip of the line has selection</span>
04226             <span class="comment">// attribute, then this blank strip needs to be drawn separately.</span>
04227             <span class="comment">// Else, we can draw the blank strip along with the last strip.</span>
04228             <span class="comment">//</span>
04229 
04230             <span class="comment">// Is this the last strip of the current line?</span>
04231             <span class="keywordflow">if</span> (iRemainingLengthInLine == (<span class="keywordtype">int</span>)CurStripLength) {
04232                 <span class="keywordflow">if</span> (fSelected) { <span class="comment">// Does this strip have selection attribute?</span>
04233                     <span class="comment">// Then we need to draw the end of line strip separately.</span>
04234                     fDrawEndOfLineStrip = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;  <span class="comment">// Draw the end of line strip.</span>
04235                     <a class="code" href="../../d6/d0/usercli_8h.html#a494">MLIchToXYPos</a>(ped, hdc, ichStart+CurStripLength, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, &amp;pt);
04236                     xClipEndPos = pt.x;
04237                 } <span class="keywordflow">else</span> {
04238                     <span class="comment">//</span>
04239                     <span class="comment">// Set the xClipEndPos to a big value sothat the blank</span>
04240                     <span class="comment">// strip will be drawn automatically when the last strip</span>
04241                     <span class="comment">// is drawn.</span>
04242                     <span class="comment">//</span>
04243                     xClipEndPos = <a class="code" href="../../d6/d0/usercli_8h.html#a73">MAXCLIPENDPOS</a>;
04244                 }
04245             } <span class="keywordflow">else</span> {
04246                 <span class="comment">//</span>
04247                 <span class="comment">// This is not the last strip of this line; So, set the ending</span>
04248                 <span class="comment">// clip position accurately.</span>
04249                 <span class="comment">//</span>
04250                 <a class="code" href="../../d6/d0/usercli_8h.html#a494">MLIchToXYPos</a>(ped, hdc, ichStart+CurStripLength, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;pt);
04251                 xClipEndPos = pt.x;
04252             }
04253 
04254             <span class="comment">//</span>
04255             <span class="comment">// Draw the current strip starting from xStPos, clipped to the area</span>
04256             <span class="comment">// between xClipStPos and xClipEndPos. Obtain "NegCInfo" and use it</span>
04257             <span class="comment">// in drawing the next strip.</span>
04258             <span class="comment">//</span>
04259             <a class="code" href="../../d6/d0/usercli_8h.html#a478">ECTabTheTextOut</a>(hdc, xClipStPos, xClipEndPos,
04260                     xStPos, yPos, (LPSTR)(pText+ichStart*ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>),
04261                 CurStripLength+ExtraLengthForNegA, ichStart, ped,
04262                 ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.left+xOffset, fSelected ? <a class="code" href="../../d6/d0/usercli_8h.html#a148">ECT_SELECTED</a> : <a class="code" href="../../d6/d0/usercli_8h.html#a147">ECT_NORMAL</a>, &amp;NegCInfo);
04263 
04264             <span class="keywordflow">if</span> (fSelected) {
04265                 <span class="comment">//</span>
04266                 <span class="comment">// If this strip was selected, then the next strip won't have</span>
04267                 <span class="comment">// selection attribute</span>
04268                 <span class="comment">//</span>
04269                 fSelected = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04270                 SetBkColor(hdc, bkColorSave);
04271                 <span class="keywordflow">if</span> (!ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o25">fDisabled</a>)
04272                     SetTextColor(hdc, textColorSave);
04273             }
04274 
04275             <span class="comment">// Do we have one more strip to draw on the current line?</span>
04276             <span class="keywordflow">if</span> (fDrawOnSameLine || fDrawEndOfLineStrip) {
04277                 <span class="keywordtype">int</span>  iLastDrawnLength;
04278 
04279                 <span class="comment">//</span>
04280                 <span class="comment">// Next strip's attribute is decided based on the char at ichAttrib</span>
04281                 <span class="comment">//</span>
04282                 ichAttrib = ichStart + CurStripLength;
04283 
04284                 <span class="comment">//</span>
04285                 <span class="comment">// When drawing the next strip, start at a few chars before</span>
04286                 <span class="comment">// the actual start to account for the Neg 'C' of the strip</span>
04287                 <span class="comment">// just drawn.</span>
04288                 <span class="comment">//</span>
04289                 iLastDrawnLength = CurStripLength +ExtraLengthForNegA - NegCInfo.<a class="code" href="../../d6/d7/structSTRIPINFO.html#o2">nCount</a>;
04290                 <span class="comment">//</span>
04291                 <span class="comment">// Adjust DBCS alignment...</span>
04292                 <span class="comment">//</span>
04293                 <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o42">fAnsi</a> &amp;&amp; ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o32">fDBCS</a>) {
04294                     ichNewStart = <a class="code" href="../../d6/d0/usercli_8h.html#a461">ECAdjustIch</a>(ped,pText,ichStart+iLastDrawnLength);
04295                     iLastDrawnLength = ichNewStart - ichStart;
04296                     ichStart = ichNewStart;
04297                 } <span class="keywordflow">else</span> {
04298                     ichStart += iLastDrawnLength;
04299                 }
04300                 LengthToDraw -= iLastDrawnLength;
04301                 iRemainingLengthInLine -= iLastDrawnLength;
04302 
04303                 <span class="comment">//</span>
04304                 <span class="comment">// The start of clip rect for the next strip.</span>
04305                 <span class="comment">//</span>
04306                 xStPos = NegCInfo.<a class="code" href="../../d6/d7/structSTRIPINFO.html#o3">XStartPos</a>;
04307                 xClipStPos = xClipEndPos;
04308             }
04309 
04310             <span class="comment">// Draw the blank strip at the end of line seperately, if required.</span>
04311             <span class="keywordflow">if</span> (fDrawEndOfLineStrip) {
04312                 <a class="code" href="../../d6/d0/usercli_8h.html#a478">ECTabTheTextOut</a>(hdc, xClipStPos, <a class="code" href="../../d6/d0/usercli_8h.html#a73">MAXCLIPENDPOS</a>, xStPos, yPos,
04313                     (LPSTR)(pText+ichStart*ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o60">cbChar</a>), LengthToDraw, ichStart,
04314                     ped, ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o16">rcFmt</a>.left+xOffset, <a class="code" href="../../d6/d0/usercli_8h.html#a147">ECT_NORMAL</a>, &amp;NegCInfo);
04315 
04316                 fDrawEndOfLineStrip = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04317             }
04318         }
04319         <span class="keywordflow">while</span>(fDrawOnSameLine);   <span class="comment">// do while loop ends here.</span>
04320         }
04321 
04322         <span class="comment">// Let us move on to the next line of this block to be drawn.</span>
04323         wCurLine++;
04324         <span class="keywordflow">if</span> (ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o4">cLines</a> &gt; wCurLine)
04325             ichStart = ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o61">chLines</a>[wCurLine];
04326         <span class="keywordflow">else</span>
04327             ichStart = ichEnd+1;   <span class="comment">// We have reached the end of the text.</span>
04328     }  <span class="comment">// while loop ends here</span>
04329 
04330     <a class="code" href="../../d6/d0/usercli_8h.html#a434">ECUnlock</a>(ped);
04331 
04332     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a234">NtUserShowCaret</a>(ped-&gt;<a class="code" href="../../d3/d4/structtagED.html#o14">hwnd</a>);
04333     <a class="code" href="../../d6/d0/usercli_8h.html#a493">MLSetCaretPosition</a>(ped, hdc);
04334 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:48 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
