<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: translate.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>translate.c</h1><a href="../../d1/d5/translate_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1997  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    translate.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This is the default pnp IRQ translator.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Andy Thornton (andrewth) 7-June-97</span>
00016 <span class="comment"></span>
00017 <span class="comment">Environment:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Kernel Mode Driver.</span>
00020 <span class="comment"></span>
00021 <span class="comment">Notes:</span>
00022 <span class="comment"></span>
00023 <span class="comment">    This should only be temporary and will be replaced by a call into the HAL</span>
00024 <span class="comment">    to retrieve its translators.</span>
00025 <span class="comment"></span>
00026 <span class="comment">Revision History:</span>
00027 <span class="comment"></span>
00028 <span class="comment">--*/</span>
00029 
00030 
00031 <span class="preprocessor">#include "<a class="code" href="../../d9/d8/ntos_8h.html">ntos.h</a>"</span>
00032 <span class="preprocessor">#include "<a class="code" href="../../d4/d7/haldisp_8h.html">haldisp.h</a>"</span>
00033 <span class="preprocessor">#include &lt;wdmguid.h&gt;</span>
00034 
00035 <span class="comment">//</span>
00036 <span class="comment">// Iteration macros</span>
00037 <span class="comment">//</span>
00038 
00039 <span class="comment">//</span>
00040 <span class="comment">// Control macro (used like a for loop) which iterates over all entries in</span>
00041 <span class="comment">// a standard doubly linked list.  Head is the list head and the entries are of</span>
00042 <span class="comment">// type Type.  A member called ListEntry is assumed to be the LIST_ENTRY</span>
00043 <span class="comment">// structure linking the entries together.  Current contains a pointer to each</span>
00044 <span class="comment">// entry in turn.</span>
00045 <span class="comment">//</span>
<a name="l00046"></a><a class="code" href="../../d1/d5/translate_8c.html#a0">00046</a> <span class="preprocessor">#define FOR_ALL_IN_LIST(Type, Head, Current)                            \</span>
00047 <span class="preprocessor">    for((Current) = CONTAINING_RECORD((Head)-&gt;Flink, Type, ListEntry);  \</span>
00048 <span class="preprocessor">       (Head) != &amp;(Current)-&gt;ListEntry;                                 \</span>
00049 <span class="preprocessor">       (Current) = CONTAINING_RECORD((Current)-&gt;ListEntry.Flink,        \</span>
00050 <span class="preprocessor">                                     Type,                              \</span>
00051 <span class="preprocessor">                                     ListEntry)                         \</span>
00052 <span class="preprocessor">       )</span>
00053 <span class="preprocessor"></span><span class="comment">//</span>
00054 <span class="comment">// Similar to the above only iteration is over an array of length _Size.</span>
00055 <span class="comment">//</span>
<a name="l00056"></a><a class="code" href="../../d1/d5/translate_8c.html#a1">00056</a> <span class="preprocessor">#define FOR_ALL_IN_ARRAY(_Array, _Size, _Current)                       \</span>
00057 <span class="preprocessor">    for ( (_Current) = (_Array);                                        \</span>
00058 <span class="preprocessor">          (_Current) &lt; (_Array) + (_Size);                              \</span>
00059 <span class="preprocessor">          (_Current)++ )</span>
00060 <span class="preprocessor"></span>
00061 <span class="comment">//</span>
00062 <span class="comment">// As above only iteration begins with the entry _Current</span>
00063 <span class="comment">//</span>
<a name="l00064"></a><a class="code" href="../../d1/d5/translate_8c.html#a2">00064</a> <span class="preprocessor">#define FOR_REST_IN_ARRAY(_Array, _Size, _Current)                      \</span>
00065 <span class="preprocessor">    for ( ;                                                             \</span>
00066 <span class="preprocessor">          (_Current) &lt; (_Array) + (_Size);                              \</span>
00067 <span class="preprocessor">          (_Current)++ )</span>
00068 <span class="preprocessor"></span>
<a name="l00069"></a><a class="code" href="../../d1/d5/translate_8c.html#a3">00069</a> <span class="preprocessor">#define HAL_IRQ_TRANSLATOR_VERSION 0</span>
00070 <span class="preprocessor"></span>
00071 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00072 <a class="code" href="../../d1/d5/translate_8c.html#a5">FstubTranslateResource</a>(
00073     IN  PVOID Context,
00074     IN  PCM_PARTIAL_RESOURCE_DESCRIPTOR Source,
00075     IN  RESOURCE_TRANSLATION_DIRECTION Direction,
00076     IN  ULONG AlternativesCount OPTIONAL,
00077     IN  IO_RESOURCE_DESCRIPTOR Alternatives[] OPTIONAL,
00078     IN  <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> PhysicalDeviceObject,
00079     OUT PCM_PARTIAL_RESOURCE_DESCRIPTOR Target
00080     );
00081 
00082 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00083 <a class="code" href="../../d1/d5/translate_8c.html#a6">FstubTranslateRequirement</a> (
00084     IN  PVOID Context,
00085     IN  PIO_RESOURCE_DESCRIPTOR Source,
00086     IN  <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> PhysicalDeviceObject,
00087     OUT PULONG TargetCount,
00088     OUT PIO_RESOURCE_DESCRIPTOR *Target
00089     );
00090 
00091 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00092 <a class="code" href="../../d1/d5/translate_8c.html#a7">FstubTranslatorNull</a>(
00093     IN PVOID Context
00094     );
00095 
<a name="l00096"></a><a class="code" href="../../d1/d5/translate_8c.html#a4">00096</a> <span class="keyword">extern</span> <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> <a class="code" href="../../d1/d5/translate_8c.html#a4">McaPhysicalBusDevice</a>;
00097 
00098 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00099 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,xHalGetInterruptTranslator)</span>
00100 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,FstubTranslateResource)</span>
00101 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,FstubTranslateRequirement)</span>
00102 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,FstubTranslatorNull)</span>
00103 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00104 <span class="preprocessor"></span>
00105 
00106 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00107"></a><a class="code" href="../../d1/d5/translate_8c.html#a8">00107</a> <a class="code" href="../../d1/d5/translate_8c.html#a8">xHalGetInterruptTranslator</a>(
00108         IN INTERFACE_TYPE ParentInterfaceType,
00109         IN ULONG ParentBusNumber,
00110         IN INTERFACE_TYPE BridgeInterfaceType,
00111         IN USHORT Size,
00112         IN USHORT Version,
00113         OUT <a class="code" href="../../d3/d2/struct__TRANSLATOR__INTERFACE.html">PTRANSLATOR_INTERFACE</a> Translator,
00114         OUT PULONG BridgeBusNumber
00115         )
00116 <span class="comment">/*++</span>
00117 <span class="comment"></span>
00118 <span class="comment">Routine Description:</span>
00119 <span class="comment"></span>
00120 <span class="comment"></span>
00121 <span class="comment">Arguments:</span>
00122 <span class="comment"></span>
00123 <span class="comment">        ParentInterfaceType - The type of the bus the bridge lives on (normally PCI).</span>
00124 <span class="comment"></span>
00125 <span class="comment">        ParentBusNumber - The number of the bus the bridge lives on.</span>
00126 <span class="comment"></span>
00127 <span class="comment">        ParentSlotNumber - The slot number the bridge lives in (where valid).</span>
00128 <span class="comment"></span>
00129 <span class="comment">        BridgeInterfaceType - The bus type the bridge provides (ie ISA for a PCI-ISA bridge).</span>
00130 <span class="comment"></span>
00131 <span class="comment">        ResourceType - The resource type we want to translate.</span>
00132 <span class="comment"></span>
00133 <span class="comment">        Size - The size of the translator buffer.</span>
00134 <span class="comment"></span>
00135 <span class="comment">        Version - The version of the translator interface requested.</span>
00136 <span class="comment"></span>
00137 <span class="comment">        Translator - Pointer to the buffer where the translator should be returned</span>
00138 <span class="comment"></span>
00139 <span class="comment">        BridgeBusNumber - Pointer to where the bus number of the bridge bus should be returned</span>
00140 <span class="comment"></span>
00141 <span class="comment">Return Value:</span>
00142 <span class="comment"></span>
00143 <span class="comment">    Returns the status of this operation.</span>
00144 <span class="comment"></span>
00145 <span class="comment">--*/</span>
00146 {
00147     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00148 
00149 <span class="preprocessor">#if defined(NO_LEGACY_DRIVERS)</span>
00150 <span class="preprocessor"></span>    <span class="keywordflow">return</span> STATUS_SUCCESS;
00151 }
00152 <span class="preprocessor">#else</span>
00153 <span class="preprocessor"></span>
00154     UNREFERENCED_PARAMETER(ParentInterfaceType);
00155     UNREFERENCED_PARAMETER(ParentBusNumber);
00156 
00157     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Version == HAL_IRQ_TRANSLATOR_VERSION);
00158     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Size &gt;= <span class="keyword">sizeof</span> (<a class="code" href="../../d3/d2/struct__TRANSLATOR__INTERFACE.html">TRANSLATOR_INTERFACE</a>));
00159 
00160     <span class="keywordflow">switch</span> (BridgeInterfaceType) {
00161     <span class="keywordflow">case</span> Eisa:
00162     <span class="keywordflow">case</span> Isa:
00163     <span class="keywordflow">case</span> MicroChannel:
00164     <span class="keywordflow">case</span> InterfaceTypeUndefined:    <span class="comment">// special "IDE" cookie</span>
00165 
00166         <span class="comment">//</span>
00167         <span class="comment">// Pass back an interface for an IRQ translator.</span>
00168         <span class="comment">//</span>
00169         RtlZeroMemory(Translator, <span class="keyword">sizeof</span> (<a class="code" href="../../d3/d2/struct__TRANSLATOR__INTERFACE.html">TRANSLATOR_INTERFACE</a>));
00170 
00171         Translator-&gt;Size = <span class="keyword">sizeof</span> (<a class="code" href="../../d3/d2/struct__TRANSLATOR__INTERFACE.html">TRANSLATOR_INTERFACE</a>);
00172         Translator-&gt;Version = <a class="code" href="../../d1/d5/translate_8c.html#a3">HAL_IRQ_TRANSLATOR_VERSION</a>;
00173         Translator-&gt;InterfaceReference = &amp;<a class="code" href="../../d1/d5/translate_8c.html#a7">FstubTranslatorNull</a>;
00174         Translator-&gt;InterfaceDereference = &amp;<a class="code" href="../../d1/d5/translate_8c.html#a7">FstubTranslatorNull</a>;
00175         Translator-&gt;TranslateResources = &amp;<a class="code" href="../../d1/d5/translate_8c.html#a5">FstubTranslateResource</a>;
00176         Translator-&gt;TranslateResourceRequirements = &amp;<a class="code" href="../../d1/d5/translate_8c.html#a6">FstubTranslateRequirement</a>;
00177 
00178         <span class="keywordflow">if</span> (BridgeInterfaceType == InterfaceTypeUndefined) {
00179             Translator-&gt;Context = (PVOID)Isa;
00180         } <span class="keywordflow">else</span> {
00181             Translator-&gt;Context = (PVOID)BridgeInterfaceType;
00182         }
00183 
00184         <span class="keywordflow">return</span> STATUS_SUCCESS;
00185 
00186     <span class="keywordflow">default</span>:
00187         <span class="keywordflow">return</span> STATUS_NOT_IMPLEMENTED;
00188     }
00189 }
00190 
00191 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00192"></a><a class="code" href="../../d1/d5/translate_8c.html#a5">00192</a> <a class="code" href="../../d1/d5/translate_8c.html#a5">FstubTranslateResource</a>(
00193     IN  PVOID Context,
00194     IN  PCM_PARTIAL_RESOURCE_DESCRIPTOR Source,
00195     IN  RESOURCE_TRANSLATION_DIRECTION Direction,
00196     IN  ULONG AlternativesCount OPTIONAL,
00197     IN  IO_RESOURCE_DESCRIPTOR Alternatives[] OPTIONAL,
00198     IN  <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> PhysicalDeviceObject,
00199     OUT PCM_PARTIAL_RESOURCE_DESCRIPTOR Target
00200     )
00201 {
00202     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00203     ULONG affinity, currentVector, translatedVector;
00204     KIRQL irql;
00205     PIO_RESOURCE_DESCRIPTOR currentAlternative;
00206 
00207     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00208     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Source-&gt;Type == CmResourceTypeInterrupt);
00209 
00210     <span class="comment">//</span>
00211     <span class="comment">// Copy unchanged fields</span>
00212     <span class="comment">//</span>
00213 
00214     *Target = *Source;
00215 
00216     <span class="keywordflow">switch</span> (Direction) {
00217     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a176a135">TranslateChildToParent</a>:
00218 
00219         <span class="comment">//</span>
00220         <span class="comment">// Perform the translation - The interrupt source is</span>
00221         <span class="comment">// ISA.</span>
00222         <span class="comment">//</span>
00223 
00224         Target-&gt;u.Interrupt.Vector = <a class="code" href="../../d2/d7/hal_8h.html#a181">HalGetInterruptVector</a>(
00225                                          (INTERFACE_TYPE)(ULONG_PTR)Context,
00226                                          0,     <span class="comment">// assume bus 0 ??? BUGBUG ???</span>
00227                                          Source-&gt;u.Interrupt.Vector,
00228                                          Source-&gt;u.Interrupt.Vector,
00229                                          &amp;irql,
00230                                          &amp;affinity
00231                                          );
00232 
00233         Target-&gt;u.Interrupt.Level = irql;
00234         Target-&gt;u.Interrupt.Affinity = affinity;
00235 
00236         status = STATUS_TRANSLATION_COMPLETE;
00237 
00238         <span class="keywordflow">break</span>;
00239 
00240     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a176a136">TranslateParentToChild</a>:
00241 
00242         <span class="comment">//</span>
00243         <span class="comment">// Translate each alternative and when we match then use the value we</span>
00244         <span class="comment">// just translated</span>
00245         <span class="comment">//</span>
00246 
00247         <a class="code" href="../../d1/d5/translate_8c.html#a1">FOR_ALL_IN_ARRAY</a>(Alternatives, AlternativesCount, currentAlternative) {
00248 
00249             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(currentAlternative-&gt;Type == CmResourceTypeInterrupt);
00250 
00251             currentVector = currentAlternative-&gt;u.Interrupt.MinimumVector;
00252 
00253             <span class="keywordflow">while</span> (currentVector &lt;=
00254                        currentAlternative-&gt;u.Interrupt.MaximumVector) {
00255 
00256                 translatedVector = <a class="code" href="../../d2/d7/hal_8h.html#a181">HalGetInterruptVector</a>((INTERFACE_TYPE)(ULONG_PTR)Context,
00257                                                          0,<span class="comment">// BUGBUG - assume bus 0</span>
00258                                                          currentVector,
00259                                                          currentVector,
00260                                                          &amp;irql,
00261                                                          &amp;affinity
00262                                                         );
00263 
00264 
00265 
00266                 <span class="keywordflow">if</span> (translatedVector == Source-&gt;u.Interrupt.Vector) {
00267 
00268                     <span class="comment">//</span>
00269                     <span class="comment">// We found our vector - fill in the target and return</span>
00270                     <span class="comment">//</span>
00271 
00272                     Target-&gt;u.Interrupt.Vector = currentVector;
00273                     Target-&gt;u.Interrupt.Level = Target-&gt;u.Interrupt.Vector;
00274                     Target-&gt;u.Interrupt.Affinity = 0xFFFFFFFF;
00275                     <span class="keywordflow">return</span> STATUS_SUCCESS;
00276                 }
00277 
00278                 currentVector++;
00279             }
00280 
00281         }
00282 
00283         status = STATUS_UNSUCCESSFUL;
00284 
00285         <span class="keywordflow">break</span>;
00286     }
00287 
00288     <span class="keywordflow">return</span> status;
00289 }
00290 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00291"></a><a class="code" href="../../d1/d5/translate_8c.html#a6">00291</a> <a class="code" href="../../d1/d5/translate_8c.html#a6">FstubTranslateRequirement</a> (
00292     IN  PVOID Context,
00293     IN  PIO_RESOURCE_DESCRIPTOR Source,
00294     IN  <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> PhysicalDeviceObject,
00295     OUT PULONG TargetCount,
00296     OUT PIO_RESOURCE_DESCRIPTOR *Target
00297     )
00298 {
00299     ULONG affinity;
00300     KIRQL irql;
00301 
00302     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00303     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Source-&gt;Type == CmResourceTypeInterrupt);
00304 
00305     *Target = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00306                                     <span class="keyword">sizeof</span>(IO_RESOURCE_DESCRIPTOR),
00307                                     'btsF'
00308                                     );
00309 
00310     <span class="keywordflow">if</span> (!*Target) {
00311         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00312     }
00313 
00314     *TargetCount = 1;
00315 
00316     <span class="comment">//</span>
00317     <span class="comment">// Copy unchanged fields</span>
00318     <span class="comment">//</span>
00319 
00320     **Target = *Source;
00321 
00322     (*Target)-&gt;u.Interrupt.MinimumVector =
00323         <a class="code" href="../../d2/d7/hal_8h.html#a181">HalGetInterruptVector</a>(
00324             (INTERFACE_TYPE)(ULONG_PTR)Context,
00325             0,     <span class="comment">// assume bus 0 ??? BUGBUG ???</span>
00326             Source-&gt;u.Interrupt.MinimumVector,
00327             Source-&gt;u.Interrupt.MinimumVector,
00328             &amp;irql,
00329             &amp;affinity
00330             );
00331 
00332 
00333     (*Target)-&gt;u.Interrupt.MaximumVector =
00334         <a class="code" href="../../d2/d7/hal_8h.html#a181">HalGetInterruptVector</a>(
00335             (INTERFACE_TYPE)(ULONG_PTR)Context,
00336             0,     <span class="comment">// assume bus 0 ??? BUGBUG ???</span>
00337             Source-&gt;u.Interrupt.MaximumVector,
00338             Source-&gt;u.Interrupt.MaximumVector,
00339             &amp;irql,
00340             &amp;affinity
00341             );
00342 
00343 
00344     <span class="keywordflow">return</span> STATUS_TRANSLATION_COMPLETE;
00345 }
00346 
00347 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00348"></a><a class="code" href="../../d1/d5/translate_8c.html#a7">00348</a> <a class="code" href="../../d1/d5/translate_8c.html#a7">FstubTranslatorNull</a>(
00349     IN PVOID Context
00350     )
00351 {
00352     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00353     <span class="keywordflow">return</span>;
00354 }
00355 <span class="preprocessor">#endif // NO_LEGACY_DRIVERS</span>
00356 <span class="preprocessor"></span>
00357 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:03 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
