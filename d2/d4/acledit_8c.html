<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: acledit.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>acledit.c File Reference</h1><code>#include &lt;<a class="el" href="../../d6/d8/ntrtlp_8h-source.html">ntrtlp.h</a>&gt;</code><br>
<code>#include &lt;seopaque.h&gt;</code><br>

<p>
<a href="../../d3/d3/acledit_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/acledit_8c.html#a0">FirstAce</a>(Acl)&nbsp;&nbsp;&nbsp;((PVOID)((PUCHAR)(Acl) + sizeof(ACL)))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/acledit_8c.html#a1">NextAce</a>(Ace)&nbsp;&nbsp;&nbsp;((PVOID)((PUCHAR)(Ace) + ((PACE_HEADER)(Ace))-&gt;AceSize))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/acledit_8c.html#a2">LongAligned</a>(ptr)&nbsp;&nbsp;&nbsp;(LongAlign(ptr) == ((PVOID)(ptr)))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/acledit_8c.html#a3">WordAligned</a>(ptr)&nbsp;&nbsp;&nbsp;(WordAlign(ptr) == ((PVOID)(ptr)))</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/acledit_8c.html#a4">RtlpAddData</a> (IN PVOID From, IN ULONG FromSize, IN PVOID To, IN ULONG ToSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/acledit_8c.html#a5">RtlpDeleteData</a> (IN PVOID Data, IN ULONG RemoveSize, IN ULONG TotalSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a> (IN PACL Acl, IN ULONG AclLength, IN ULONG AclRevision)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/acledit_8c.html#a7">RtlValidAcl</a> (IN PACL Acl)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/acledit_8c.html#a8">RtlQueryInformationAcl</a> (IN PACL Acl, OUT PVOID AclInformation, IN ULONG AclInformationLength, IN ACL_INFORMATION_CLASS AclInformationClass)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/acledit_8c.html#a9">RtlSetInformationAcl</a> (IN PACL Acl, IN PVOID AclInformation, IN ULONG AclInformationLength, IN ACL_INFORMATION_CLASS AclInformationClass)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/acledit_8c.html#a10">RtlAddAce</a> (IN OUT PACL Acl, IN ULONG AceRevision, IN ULONG StartingAceIndex, IN PVOID AceList, IN ULONG AceListLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/acledit_8c.html#a11">RtlDeleteAce</a> (IN OUT PACL Acl, IN ULONG AceIndex)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/acledit_8c.html#a12">RtlGetAce</a> (IN PACL Acl, ULONG AceIndex, OUT PVOID *Ace)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/acledit_8c.html#a13">RtlAddCompoundAce</a> (IN PACL Acl, IN ULONG AceRevision, IN UCHAR CompoundAceType, IN ACCESS_MASK AccessMask, IN PSID ServerSid, IN PSID ClientSid)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/acledit_8c.html#a14">RtlpAddKnownAce</a> (IN OUT PACL Acl, IN ULONG AceRevision, IN ULONG AceFlags, IN ACCESS_MASK AccessMask, IN PSID Sid, IN UCHAR NewType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/acledit_8c.html#a15">RtlpAddKnownObjectAce</a> (IN OUT PACL Acl, IN ULONG AceRevision, IN ULONG AceFlags, IN ACCESS_MASK AccessMask, IN GUID *ObjectTypeGuid OPTIONAL, IN GUID *InheritedObjectTypeGuid OPTIONAL, IN PSID Sid, IN UCHAR NewType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> (IN OUT PACL Acl, IN ULONG AceRevision, IN ACCESS_MASK AccessMask, IN PSID Sid)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/acledit_8c.html#a17">RtlAddAccessAllowedAceEx</a> (IN OUT PACL Acl, IN ULONG AceRevision, IN ULONG AceFlags, IN ACCESS_MASK AccessMask, IN PSID Sid)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/acledit_8c.html#a18">RtlAddAccessDeniedAce</a> (IN OUT PACL Acl, IN ULONG AceRevision, IN ACCESS_MASK AccessMask, IN PSID Sid)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/acledit_8c.html#a19">RtlAddAccessDeniedAceEx</a> (IN OUT PACL Acl, IN ULONG AceRevision, IN ULONG AceFlags, IN ACCESS_MASK AccessMask, IN PSID Sid)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/acledit_8c.html#a20">RtlAddAuditAccessAce</a> (IN OUT PACL Acl, IN ULONG AceRevision, IN ACCESS_MASK AccessMask, IN PSID Sid, IN BOOLEAN AuditSuccess, IN BOOLEAN AuditFailure)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/acledit_8c.html#a21">RtlAddAuditAccessAceEx</a> (IN OUT PACL Acl, IN ULONG AceRevision, IN ULONG AceFlags, IN ACCESS_MASK AccessMask, IN PSID Sid, IN BOOLEAN AuditSuccess, IN BOOLEAN AuditFailure)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/acledit_8c.html#a22">RtlAddAccessAllowedObjectAce</a> (IN OUT PACL Acl, IN ULONG AceRevision, IN ULONG AceFlags, IN ACCESS_MASK AccessMask, IN GUID *ObjectTypeGuid OPTIONAL, IN GUID *InheritedObjectTypeGuid OPTIONAL, IN PSID Sid)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/acledit_8c.html#a23">RtlAddAccessDeniedObjectAce</a> (IN OUT PACL Acl, IN ULONG AceRevision, IN ULONG AceFlags, IN ACCESS_MASK AccessMask, IN GUID *ObjectTypeGuid OPTIONAL, IN GUID *InheritedObjectTypeGuid OPTIONAL, IN PSID Sid)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/acledit_8c.html#a24">RtlAddAuditAccessObjectAce</a> (IN OUT PACL Acl, IN ULONG AceRevision, IN ULONG AceFlags, IN ACCESS_MASK AccessMask, IN GUID *ObjectTypeGuid OPTIONAL, IN GUID *InheritedObjectTypeGuid OPTIONAL, IN PSID Sid, IN BOOLEAN AuditSuccess, IN BOOLEAN AuditFailure)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/acledit_8c.html#a25">RtlFirstFreeAce</a> (IN PACL Acl, OUT PVOID *FirstFree)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="acledit.c::FirstAce" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FirstAce          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Acl&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((PVOID)((PUCHAR)(Acl) + sizeof(ACL)))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/acledit_8c-source.html#l00042">42</a> of file <a class="el" href="../../d3/d3/acledit_8c-source.html">acledit.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="acledit.c::LongAligned" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LongAligned          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ptr&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(LongAlign(ptr) == ((PVOID)(ptr)))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/acledit_8c-source.html#l00056">56</a> of file <a class="el" href="../../d3/d3/acledit_8c-source.html">acledit.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/acledit_8c-source.html#l00187">RtlValidAcl()</a>, and <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l02414">SeValidSecurityDescriptor()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="acledit.c::NextAce" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define NextAce          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Ace&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((PVOID)((PUCHAR)(Ace) + ((PACE_HEADER)(Ace))-&gt;AceSize))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/acledit_8c-source.html#l00054">54</a> of file <a class="el" href="../../d3/d3/acledit_8c-source.html">acledit.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="acledit.c::WordAligned" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define WordAligned          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ptr&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(WordAlign(ptr) == ((PVOID)(ptr)))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/acledit_8c-source.html#l00057">57</a> of file <a class="el" href="../../d3/d3/acledit_8c-source.html">acledit.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/acledit_8c-source.html#l00187">RtlValidAcl()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a16" doxytag="acledit.c::RtlAddAccessAllowedAce" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlAddAccessAllowedAce           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>Acl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AceRevision</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMask</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>Sid</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/acledit_8c-source.html#l01607">1607</a> of file <a class="el" href="../../d3/d3/acledit_8c-source.html">acledit.c</a>.
<p>
References <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, and <a class="el" href="../../d3/d3/acledit_8c-source.html#l01242">RtlpAddKnownAce()</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/cmse_8c-source.html#l01227">CmpHiveRootSecurityDescriptor()</a>, <a class="el" href="../../d1/d6/server_2server_8c-source.html#l00705">CreateBSMEventSD()</a>, <a class="el" href="../../d6/d8/arcsec_8c-source.html#l00168">IopApplySystemPartitionProt()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l01545">ObpGetDosDevicesProtection()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01860">RtlDefaultNpAcl()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l01010">SeMakeAnonymousLogonToken()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l00536">SeMakeSystemToken()</a>, <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00049">SepCreateImpersonationTokenDacl()</a>, <a class="el" href="../../d0/d5/seinit_8c-source.html#l00184">SepInitializationPhase1()</a>, <a class="el" href="../../d9/d4/seglobal_8c-source.html#l00651">SepInitSystemDacls()</a>, <a class="el" href="../../d1/d9/rmmain_8c-source.html#l00060">SeRmInitPhase1()</a>, and <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00551">SmbTraceStart()</a>.
<p>
<pre class="fragment"><div>01616                    :
01617 
01618     This routine adds an ACCESS_ALLOWED ACE to an ACL.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01619     expected to be a common form of ACL modification.
01620 
01621     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> very bland ACE header <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> placed in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE.  It provides no
01622     inheritance and no ACE flags.
01623 
01624 Arguments:
01625 
01626     Acl - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl being modified
01627 
01628     AceRevision - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl/Ace revision of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE being added
01629 
01630     AccessMask - The mask of accesses to be granted to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified SID.
01631 
01632     Sid - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID being granted access.
01633 
01634 Return Value:
01635 
01636     STATUS_SUCCESS - The ACE was successfully added.
01637 
01638     STATUS_INVALID_ACL - The specified ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not properly formed.
01639 
01640     STATUS_REVISION_MISMATCH - The specified revision <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not known
01641         or <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> incompatible with that of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL.
01642 
01643     STATUS_ALLOTTED_SPACE_EXCEEDED - The <span class="keyword">new</span> ACE does not fit into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01644         ACL.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> larger ACL buffer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required.
01645 
01646     STATUS_INVALID_SID - The provided SID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not a structurally valid
01647         SID.
01648 
01649 --*/
01650 
01651 {
01652     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01653 
01654     <span class="keywordflow">return</span> <a class="code" href="../../d2/d4/acledit_8c.html#a14">RtlpAddKnownAce</a> (
01655                Acl,
01656                AceRevision,
01657                0,   <span class="comment">// No inherit flags</span>
01658                AccessMask,
01659                Sid,
01660                ACCESS_ALLOWED_ACE_TYPE
01661                );
01662 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="acledit.c::RtlAddAccessAllowedAceEx" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlAddAccessAllowedAceEx           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>Acl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AceRevision</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AceFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMask</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>Sid</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/acledit_8c-source.html#l01666">1666</a> of file <a class="el" href="../../d3/d3/acledit_8c-source.html">acledit.c</a>.
<p>
References <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, and <a class="el" href="../../d3/d3/acledit_8c-source.html#l01242">RtlpAddKnownAce()</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08501">IopOpenDeviceParametersSubkey()</a>.
<p>
<pre class="fragment"><div>01676                    :
01677 
01678     This routine adds an ACCESS_ALLOWED ACE to an ACL.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01679     expected to be a common form of ACL modification.
01680 
01681 Arguments:
01682 
01683     Acl - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl being modified
01684 
01685     AceRevision - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl/Ace revision of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE being added
01686 
01687     AceFlags - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> inherit flags <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE.
01688 
01689     AccessMask - The mask of accesses to be granted to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified SID.
01690 
01691     Sid - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID being granted access.
01692 
01693 Return Value:
01694 
01695     STATUS_SUCCESS - The ACE was successfully added.
01696 
01697     STATUS_INVALID_ACL - The specified ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not properly formed.
01698 
01699     STATUS_REVISION_MISMATCH - The specified revision <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not known
01700         or <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> incompatible with that of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL.
01701 
01702     STATUS_ALLOTTED_SPACE_EXCEEDED - The <span class="keyword">new</span> ACE does not fit into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01703         ACL.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> larger ACL buffer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required.
01704 
01705     STATUS_INVALID_SID - The provided SID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not a structurally valid
01706         SID.
01707 
01708     STATUS_INVALID_PARAMETER - The AceFlags parameter was invalid.
01709 
01710 --*/
01711 
01712 {
01713     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01714 
01715     <span class="keywordflow">return</span> <a class="code" href="../../d2/d4/acledit_8c.html#a14">RtlpAddKnownAce</a> (
01716                Acl,
01717                AceRevision,
01718                AceFlags,
01719                AccessMask,
01720                Sid,
01721                ACCESS_ALLOWED_ACE_TYPE
01722                );
01723 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="acledit.c::RtlAddAccessAllowedObjectAce" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlAddAccessAllowedObjectAce           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>Acl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AceRevision</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AceFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMask</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN GUID *ObjectTypeGuid&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN GUID *InheritedObjectTypeGuid&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>Sid</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/acledit_8c-source.html#l02008">2008</a> of file <a class="el" href="../../d3/d3/acledit_8c-source.html">acledit.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l01242">RtlpAddKnownAce()</a>, and <a class="el" href="../../d3/d3/acledit_8c-source.html#l01405">RtlpAddKnownObjectAce()</a>.
<p>
<pre class="fragment"><div>02020                    :
02021 
02022     This routine adds an object specific ACCESS_ALLOWED ACE to an ACL.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02023     expected to be a common form of ACL modification.
02024 
02025 Arguments:
02026 
02027     Acl - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl being modified
02028 
02029     AceRevision - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl/Ace revision of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE being added
02030 
02031     AceFlags - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> inherit flags <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE.
02032 
02033     AccessMask - The mask of accesses to be granted to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified SID.
02034 
02035     ObjectTypeGuid - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> GUID of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <span class="keyword">this</span> ACE applies to.
02036         If <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, no object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> GUID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> placed in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE.
02037 
02038     InheritedObjectTypeGuid - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> GUID of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> that will
02039         inherit <span class="keyword">this</span> ACE.  If <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, no inherited object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> GUID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> placed in
02040         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE.
02041 
02042     Sid - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID being granted access.
02043 
02044 Return Value:
02045 
02046     STATUS_SUCCESS - The ACE was successfully added.
02047 
02048     STATUS_INVALID_ACL - The specified ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not properly formed.
02049 
02050     STATUS_REVISION_MISMATCH - The specified revision <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not known
02051         or <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> incompatible with that of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL.
02052 
02053     STATUS_ALLOTTED_SPACE_EXCEEDED - The <span class="keyword">new</span> ACE does not fit into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02054         ACL.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> larger ACL buffer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required.
02055 
02056     STATUS_INVALID_SID - The provided SID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not a structurally valid
02057         SID.
02058 
02059     STATUS_INVALID_PARAMETER - The AceFlags parameter was invalid.
02060 
02061 --*/
02062 
02063 {
02064     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
02065 
02066     <span class="comment">//</span>
02067     <span class="comment">// If no object types are specified,</span>
02068     <span class="comment">//  build a non-object ACE.</span>
02069     <span class="comment">//</span>
02070     <span class="keywordflow">if</span> (ObjectTypeGuid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; InheritedObjectTypeGuid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02071         <span class="keywordflow">return</span> <a class="code" href="../../d2/d4/acledit_8c.html#a14">RtlpAddKnownAce</a> (
02072                    Acl,
02073                    AceRevision,
02074                    AceFlags,
02075                    AccessMask,
02076                    Sid,
02077                    ACCESS_ALLOWED_ACE_TYPE
02078                    );
02079     }
02080 
02081     <span class="keywordflow">return</span> <a class="code" href="../../d2/d4/acledit_8c.html#a15">RtlpAddKnownObjectAce</a> (
02082                Acl,
02083                AceRevision,
02084                AceFlags,
02085                AccessMask,
02086                ObjectTypeGuid,
02087                InheritedObjectTypeGuid,
02088                Sid,
02089                ACCESS_ALLOWED_OBJECT_ACE_TYPE
02090                );
02091 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="acledit.c::RtlAddAccessDeniedAce" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlAddAccessDeniedAce           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>Acl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AceRevision</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMask</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>Sid</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/acledit_8c-source.html#l01727">1727</a> of file <a class="el" href="../../d3/d3/acledit_8c-source.html">acledit.c</a>.
<p>
References <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, and <a class="el" href="../../d3/d3/acledit_8c-source.html#l01242">RtlpAddKnownAce()</a>.
<p>
<pre class="fragment"><div>01736                    :
01737 
01738     This routine adds an ACCESS_DENIED ACE to an ACL.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01739     expected to be a common form of ACL modification.
01740 
01741     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> very bland ACE header <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> placed in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE.  It provides no
01742     inheritance and no ACE flags.
01743 
01744 Arguments:
01745 
01746     Acl - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl being modified
01747 
01748     AceRevision - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl/Ace revision of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE being added
01749 
01750     AccessMask - The mask of accesses to be denied to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified SID.
01751 
01752     Sid - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID being denied access.
01753 
01754 Return Value:
01755 
01756     STATUS_SUCCESS - The ACE was successfully added.
01757 
01758     STATUS_INVALID_ACL - The specified ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not properly formed.
01759 
01760     STATUS_REVISION_MISMATCH - The specified revision <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not known
01761         or <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> incompatible with that of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL.
01762 
01763     STATUS_ALLOTTED_SPACE_EXCEEDED - The <span class="keyword">new</span> ACE does not fit into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01764         ACL.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> larger ACL buffer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required.
01765 
01766     STATUS_INVALID_SID - The provided SID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not a structurally valid
01767         SID.
01768 
01769 --*/
01770 
01771 {
01772     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01773 
01774     <span class="keywordflow">return</span> <a class="code" href="../../d2/d4/acledit_8c.html#a14">RtlpAddKnownAce</a> (
01775                Acl,
01776                AceRevision,
01777                0,   <span class="comment">// No inherit flags</span>
01778                AccessMask,
01779                Sid,
01780                ACCESS_DENIED_ACE_TYPE
01781                );
01782 
01783 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="acledit.c::RtlAddAccessDeniedAceEx" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlAddAccessDeniedAceEx           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>Acl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AceRevision</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AceFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMask</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>Sid</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/acledit_8c-source.html#l01787">1787</a> of file <a class="el" href="../../d3/d3/acledit_8c-source.html">acledit.c</a>.
<p>
References <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, and <a class="el" href="../../d3/d3/acledit_8c-source.html#l01242">RtlpAddKnownAce()</a>.
<p>
<pre class="fragment"><div>01797                    :
01798 
01799     This routine adds an ACCESS_DENIED ACE to an ACL.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01800     expected to be a common form of ACL modification.
01801 
01802 Arguments:
01803 
01804     Acl - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl being modified
01805 
01806     AceRevision - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl/Ace revision of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE being added
01807 
01808     AceFlags - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> inherit flags <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE.
01809 
01810     AccessMask - The mask of accesses to be denied to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified SID.
01811 
01812     Sid - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID being denied access.
01813 
01814 Return Value:
01815 
01816     STATUS_SUCCESS - The ACE was successfully added.
01817 
01818     STATUS_INVALID_ACL - The specified ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not properly formed.
01819 
01820     STATUS_REVISION_MISMATCH - The specified revision <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not known
01821         or <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> incompatible with that of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL.
01822 
01823     STATUS_ALLOTTED_SPACE_EXCEEDED - The <span class="keyword">new</span> ACE does not fit into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01824         ACL.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> larger ACL buffer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required.
01825 
01826     STATUS_INVALID_SID - The provided SID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not a structurally valid
01827         SID.
01828 
01829     STATUS_INVALID_PARAMETER - The AceFlags parameter was invalid.
01830 
01831 --*/
01832 
01833 {
01834     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01835 
01836     <span class="keywordflow">return</span> <a class="code" href="../../d2/d4/acledit_8c.html#a14">RtlpAddKnownAce</a> (
01837                Acl,
01838                AceRevision,
01839                AceFlags,
01840                AccessMask,
01841                Sid,
01842                ACCESS_DENIED_ACE_TYPE
01843                );
01844 
01845 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="acledit.c::RtlAddAccessDeniedObjectAce" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlAddAccessDeniedObjectAce           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>Acl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AceRevision</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AceFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMask</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN GUID *ObjectTypeGuid&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN GUID *InheritedObjectTypeGuid&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>Sid</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/acledit_8c-source.html#l02095">2095</a> of file <a class="el" href="../../d3/d3/acledit_8c-source.html">acledit.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l01242">RtlpAddKnownAce()</a>, and <a class="el" href="../../d3/d3/acledit_8c-source.html#l01405">RtlpAddKnownObjectAce()</a>.
<p>
<pre class="fragment"><div>02107                    :
02108 
02109     This routine adds an object specific ACCESS_DENIED ACE to an ACL.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02110     expected to be a common form of ACL modification.
02111 
02112 Arguments:
02113 
02114     Acl - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl being modified
02115 
02116     AceRevision - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl/Ace revision of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE being added
02117 
02118     AceFlags - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> inherit flags <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE.
02119 
02120     AccessMask - The mask of accesses to be granted to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified SID.
02121 
02122     ObjectTypeGuid - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> GUID of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <span class="keyword">this</span> ACE applies to.
02123         If <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, no object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> GUID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> placed in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE.
02124 
02125     InheritedObjectTypeGuid - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> GUID of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> that will
02126         inherit <span class="keyword">this</span> ACE.  If <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, no inherited object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> GUID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> placed in
02127         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE.
02128 
02129     Sid - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID being denied access.
02130 
02131 Return Value:
02132 
02133     STATUS_SUCCESS - The ACE was successfully added.
02134 
02135     STATUS_INVALID_ACL - The specified ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not properly formed.
02136 
02137     STATUS_REVISION_MISMATCH - The specified revision <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not known
02138         or <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> incompatible with that of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL.
02139 
02140     STATUS_ALLOTTED_SPACE_EXCEEDED - The <span class="keyword">new</span> ACE does not fit into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02141         ACL.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> larger ACL buffer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required.
02142 
02143     STATUS_INVALID_SID - The provided SID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not a structurally valid
02144         SID.
02145 
02146     STATUS_INVALID_PARAMETER - The AceFlags parameter was invalid.
02147 
02148 --*/
02149 
02150 {
02151     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
02152 
02153     <span class="comment">//</span>
02154     <span class="comment">// If no object types are specified,</span>
02155     <span class="comment">//  build a non-object ACE.</span>
02156     <span class="comment">//</span>
02157     <span class="keywordflow">if</span> (ObjectTypeGuid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; InheritedObjectTypeGuid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02158         <span class="keywordflow">return</span> <a class="code" href="../../d2/d4/acledit_8c.html#a14">RtlpAddKnownAce</a> (
02159                    Acl,
02160                    AceRevision,
02161                    AceFlags,
02162                    AccessMask,
02163                    Sid,
02164                    ACCESS_DENIED_ACE_TYPE
02165                    );
02166     }
02167 
02168     <span class="keywordflow">return</span> <a class="code" href="../../d2/d4/acledit_8c.html#a15">RtlpAddKnownObjectAce</a> (
02169                Acl,
02170                AceRevision,
02171                AceFlags,
02172                AccessMask,
02173                ObjectTypeGuid,
02174                InheritedObjectTypeGuid,
02175                Sid,
02176                ACCESS_DENIED_OBJECT_ACE_TYPE
02177                );
02178 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="acledit.c::RtlAddAce" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlAddAce           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>Acl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AceRevision</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>StartingAceIndex</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>AceList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AceListLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/acledit_8c-source.html#l00718">718</a> of file <a class="el" href="../../d3/d3/acledit_8c-source.html">acledit.c</a>.
<p>
References <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00053">FirstAce</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00059">NextAce</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l02599">RtlFirstFreeAce()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l02684">RtlpAddData()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00187">RtlValidAcl()</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00299">CreateDAclToken()</a>, <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00091">CreateSecurityDescriptor()</a>, <a class="el" href="../../d5/d2/rtsetsec_8c-source.html#l00122">GenerateDescriptor()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08501">IopOpenDeviceParametersSubkey()</a>, <a class="el" href="../../d2/d8/tacl_8c-source.html#l00055">main()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01260">RtlCreateAndSetSD()</a>, <a class="el" href="../../d4/d5/tseum_8c-source.html#l00282">TestAddAce()</a>, and <a class="el" href="../../d2/d0/ctsertl_8c-source.html#l00801">TestSeAclRtl()</a>.
<p>
<pre class="fragment"><div>00728                    :
00729 
00730     This routine adds a string of ACEs to an ACL.
00731 
00732 Arguments:
00733 
00734     Acl - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl being modified
00735 
00736     AceRevision - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl/Ace revision of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE being added
00737 
00738     StartingAceIndex - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE index which will be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> index of
00739         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first ace inserted in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> acl. 0 <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> beginning of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list
00740         and MAXULONG <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list.
00741 
00742     AceList - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of Aces to be added to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl
00743 
00744     AceListLength - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AceList buffer
00745 
00746 Return Value:
00747 
00748     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - STATUS_SUCCESS <span class="keywordflow">if</span> successful, and an appropriate error
00749         status otherwise
00750 
00751 --*/
00752 
00753 {
00754     PVOID FirstFree;
00755 
00756     PACE_HEADER Ace;
00757     ULONG NewAceCount;
00758 
00759     PVOID AcePosition;
00760     ULONG i;
00761     UCHAR NewRevision;
00762 
00763     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00764 
00765     <span class="comment">//</span>
00766     <span class="comment">//  Check the ACL structure</span>
00767     <span class="comment">//</span>
00768 
00769     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a7">RtlValidAcl</a>(Acl)) {
00770 
00771         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00772 
00773     }
00774 
00775     <span class="comment">//</span>
00776     <span class="comment">//  Locate the first free ace and check to see that the Acl is</span>
00777     <span class="comment">//  well formed.</span>
00778     <span class="comment">//</span>
00779 
00780     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a25">RtlFirstFreeAce</a>( Acl, &amp;FirstFree )) {
00781 
00782         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00783 
00784     }
00785 
00786     <span class="comment">//</span>
00787     <span class="comment">// If the AceRevision is greater than the ACL revision, then we want to</span>
00788     <span class="comment">// increase the ACL revision to be the same as the new ACE revision.</span>
00789     <span class="comment">// We can do this because our previously defined ACE types ( 0 -&gt; 3 ) have</span>
00790     <span class="comment">// not changed structure nor been discontinued in the new revision.  So</span>
00791     <span class="comment">// we can bump the revision and the older types will not be misinterpreted.</span>
00792     <span class="comment">//</span>
00793     <span class="comment">// Compute what the final revision of the ACL is going to be, and save it</span>
00794     <span class="comment">// for later so we can update it once we know we're going to succeed.</span>
00795     <span class="comment">//</span>
00796 
00797     NewRevision = (UCHAR)AceRevision &gt; Acl-&gt;AclRevision ? (UCHAR)AceRevision : Acl-&gt;AclRevision;
00798 
00799     <span class="comment">//</span>
00800     <span class="comment">// Check that the AceList is well formed, we do this by simply zooming</span>
00801     <span class="comment">// down the Ace list until we're equal to or have exceeded the ace list</span>
00802     <span class="comment">// length.  If we are equal to the length then we're well formed otherwise</span>
00803     <span class="comment">// we're ill-formed.  We'll also calculate how many Ace's there are</span>
00804     <span class="comment">// in the AceList</span>
00805     <span class="comment">//</span>
00806     <span class="comment">// In addition, now we have to make sure that we haven't been handed an</span>
00807     <span class="comment">// ACE type that is inappropriate for the AceRevision that was passed</span>
00808     <span class="comment">// in.</span>
00809     <span class="comment">//</span>
00810 
00811     <span class="keywordflow">for</span> (Ace = AceList, NewAceCount = 0;
00812          Ace &lt; (PACE_HEADER)((PUCHAR)AceList + AceListLength);
00813          Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>( Ace ), NewAceCount++) {
00814 
00815         <span class="comment">//</span>
00816         <span class="comment">// Ensure the ACL revision allows this ACE type.</span>
00817         <span class="comment">//</span>
00818 
00819         <span class="keywordflow">if</span> ( Ace-&gt;AceType &lt;= ACCESS_MAX_MS_V2_ACE_TYPE ) {
00820             <span class="comment">// V2 ACE are always valid.</span>
00821         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( Ace-&gt;AceType &lt;= ACCESS_MAX_MS_V3_ACE_TYPE ) {
00822             <span class="keywordflow">if</span> ( AceRevision &lt; ACL_REVISION3 ) {
00823                 <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00824             }
00825         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( Ace-&gt;AceType &lt;= ACCESS_MAX_MS_V4_ACE_TYPE ) {
00826             <span class="keywordflow">if</span> ( AceRevision &lt; ACL_REVISION4 ) {
00827                 <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00828             }
00829         }
00830     }
00831 
00832     <span class="comment">//</span>
00833     <span class="comment">//  Check to see if we've exceeded the ace list length</span>
00834     <span class="comment">//</span>
00835 
00836     <span class="keywordflow">if</span> (Ace &gt; (PACE_HEADER)((PUCHAR)AceList + AceListLength)) {
00837 
00838         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00839 
00840     }
00841 
00842     <span class="comment">//</span>
00843     <span class="comment">//  Check to see if there is enough room in the Acl to store the additional</span>
00844     <span class="comment">//  Ace list</span>
00845     <span class="comment">//</span>
00846 
00847     <span class="keywordflow">if</span> (FirstFree == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
00848         (PUCHAR)FirstFree + AceListLength &gt; (PUCHAR)Acl + Acl-&gt;AclSize) {
00849 
00850         <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00851 
00852     }
00853 
00854     <span class="comment">//</span>
00855     <span class="comment">//  All of the input has checked okay, we now need to locate the position</span>
00856     <span class="comment">//  where to insert the new ace list.  We won't check the acl for</span>
00857     <span class="comment">//  validity because we did earlier when got the first free ace position.</span>
00858     <span class="comment">//</span>
00859 
00860     AcePosition = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>( Acl );
00861 
00862     <span class="keywordflow">for</span> (i = 0; i &lt; StartingAceIndex &amp;&amp; i &lt; Acl-&gt;AceCount; i++) {
00863 
00864         AcePosition = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>( AcePosition );
00865 
00866     }
00867 
00868     <span class="comment">//</span>
00869     <span class="comment">//  Now Ace points to where we want to insert the ace list,  We do the</span>
00870     <span class="comment">//  insertion by adding ace list to the acl and shoving over the remainder</span>
00871     <span class="comment">//  of the list down the acl.  We know this will work because we earlier</span>
00872     <span class="comment">//  check to make sure the new acl list will fit in the acl size</span>
00873     <span class="comment">//</span>
00874 
00875     <a class="code" href="../../d2/d4/acledit_8c.html#a4">RtlpAddData</a>( AceList, AceListLength,
00876              AcePosition, (ULONG) ((PUCHAR)FirstFree - (PUCHAR)AcePosition));
00877 
00878     <span class="comment">//</span>
00879     <span class="comment">//  Update the Acl Header</span>
00880     <span class="comment">//</span>
00881 
00882     Acl-&gt;AceCount = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(Acl-&gt;AceCount + NewAceCount);
00883 
00884     Acl-&gt;AclRevision = NewRevision;
00885 
00886     <span class="comment">//</span>
00887     <span class="comment">//  And return to our caller</span>
00888     <span class="comment">//</span>
00889 
00890     <span class="keywordflow">return</span> STATUS_SUCCESS;
00891 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="acledit.c::RtlAddAuditAccessAce" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlAddAuditAccessAce           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>Acl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AceRevision</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMask</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>Sid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AuditSuccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AuditFailure</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/acledit_8c-source.html#l01849">1849</a> of file <a class="el" href="../../d3/d3/acledit_8c-source.html">acledit.c</a>.
<p>
References <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, and <a class="el" href="../../d3/d3/acledit_8c-source.html#l01242">RtlpAddKnownAce()</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>.
<p>
<pre class="fragment"><div>01860                    :
01861 
01862     This routine adds a SYSTEM_AUDIT ACE to an ACL.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01863     expected to be a common form of ACL modification.
01864 
01865     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> very bland ACE header <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> placed in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE.  It provides no
01866     inheritance.
01867 
01868     Parameters are used to indicate whether auditing <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be performed
01869     on success, <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>, or both.
01870 
01871 Arguments:
01872 
01873     Acl - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl being modified
01874 
01875     AceRevision - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl/Ace revision of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE being added
01876 
01877     AccessMask - The mask of accesses to be denied to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified SID.
01878 
01879     Sid - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID to be audited.
01880 
01881     AuditSuccess - If <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, indicates successful access attempts are to be
01882         audited.
01883 
01884     AuditFailure - If <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, indicated failed access attempts are to be
01885         audited.
01886 
01887 Return Value:
01888 
01889     STATUS_SUCCESS - The ACE was successfully added.
01890 
01891     STATUS_INVALID_ACL - The specified ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not properly formed.
01892 
01893     STATUS_REVISION_MISMATCH - The specified revision <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not known
01894         or <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> incompatible with that of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL.
01895 
01896     STATUS_ALLOTTED_SPACE_EXCEEDED - The <span class="keyword">new</span> ACE does not fit into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01897         ACL.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> larger ACL buffer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required.
01898 
01899     STATUS_INVALID_SID - The provided SID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not a structurally valid
01900         SID.
01901 
01902 --*/
01903 
01904 {
01905     ULONG AceFlags = 0;
01906     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01907 
01908     <span class="keywordflow">if</span> (AuditSuccess) {
01909         AceFlags |= SUCCESSFUL_ACCESS_ACE_FLAG;
01910     }
01911     <span class="keywordflow">if</span> (AuditFailure) {
01912         AceFlags |= FAILED_ACCESS_ACE_FLAG;
01913     }
01914 
01915     <span class="keywordflow">return</span> <a class="code" href="../../d2/d4/acledit_8c.html#a14">RtlpAddKnownAce</a> (
01916                 Acl,
01917                 AceRevision,
01918                 AceFlags,
01919                 AccessMask,
01920                 Sid,
01921                 SYSTEM_AUDIT_ACE_TYPE );
01922 
01923 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="acledit.c::RtlAddAuditAccessAceEx" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlAddAuditAccessAceEx           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>Acl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AceRevision</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AceFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMask</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>Sid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AuditSuccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AuditFailure</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/acledit_8c-source.html#l01926">1926</a> of file <a class="el" href="../../d3/d3/acledit_8c-source.html">acledit.c</a>.
<p>
References <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, and <a class="el" href="../../d3/d3/acledit_8c-source.html#l01242">RtlpAddKnownAce()</a>.
<p>
<pre class="fragment"><div>01938                    :
01939 
01940     This routine adds a SYSTEM_AUDIT ACE to an ACL.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01941     expected to be a common form of ACL modification.
01942 
01943     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> very bland ACE header <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> placed in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE.  It provides no
01944     inheritance.
01945 
01946     Parameters are used to indicate whether auditing <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be performed
01947     on success, <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>, or both.
01948 
01949 Arguments:
01950 
01951     Acl - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl being modified
01952 
01953     AceRevision - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl/Ace revision of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE being added
01954 
01955     AceFlags - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> inherit flags <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE.
01956 
01957     AccessMask - The mask of accesses to be denied to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified SID.
01958 
01959     Sid - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID to be audited.
01960 
01961     AuditSuccess - If <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, indicates successful access attempts are to be
01962         audited.
01963 
01964     AuditFailure - If <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, indicated failed access attempts are to be
01965         audited.
01966 
01967 Return Value:
01968 
01969     STATUS_SUCCESS - The ACE was successfully added.
01970 
01971     STATUS_INVALID_ACL - The specified ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not properly formed.
01972 
01973     STATUS_REVISION_MISMATCH - The specified revision <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not known
01974         or <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> incompatible with that of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL.
01975 
01976     STATUS_ALLOTTED_SPACE_EXCEEDED - The <span class="keyword">new</span> ACE does not fit into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01977         ACL.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> larger ACL buffer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required.
01978 
01979     STATUS_INVALID_SID - The provided SID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not a structurally valid
01980         SID.
01981 
01982     STATUS_INVALID_PARAMETER - The AceFlags parameter was invalid.
01983 
01984 --*/
01985 
01986 {
01987     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01988 
01989     <span class="keywordflow">if</span> (AuditSuccess) {
01990         AceFlags |= SUCCESSFUL_ACCESS_ACE_FLAG;
01991     }
01992     <span class="keywordflow">if</span> (AuditFailure) {
01993         AceFlags |= FAILED_ACCESS_ACE_FLAG;
01994     }
01995 
01996     <span class="keywordflow">return</span> <a class="code" href="../../d2/d4/acledit_8c.html#a14">RtlpAddKnownAce</a> (
01997                 Acl,
01998                 AceRevision,
01999                 AceFlags,
02000                 AccessMask,
02001                 Sid,
02002                 SYSTEM_AUDIT_ACE_TYPE );
02003 
02004 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="acledit.c::RtlAddAuditAccessObjectAce" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlAddAuditAccessObjectAce           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>Acl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AceRevision</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AceFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMask</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN GUID *ObjectTypeGuid&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN GUID *InheritedObjectTypeGuid&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>Sid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AuditSuccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AuditFailure</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/acledit_8c-source.html#l02182">2182</a> of file <a class="el" href="../../d3/d3/acledit_8c-source.html">acledit.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l01242">RtlpAddKnownAce()</a>, and <a class="el" href="../../d3/d3/acledit_8c-source.html#l01405">RtlpAddKnownObjectAce()</a>.
<p>
<pre class="fragment"><div>02196                    :
02197 
02198     This routine adds an object specific ACCESS_DENIED ACE to an ACL.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02199     expected to be a common form of ACL modification.
02200 
02201 Arguments:
02202 
02203     Acl - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl being modified
02204 
02205     AceRevision - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl/Ace revision of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE being added
02206 
02207     AceFlags - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> inherit flags <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE.
02208 
02209     AccessMask - The mask of accesses to be granted to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified SID.
02210 
02211     ObjectTypeGuid - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> GUID of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <span class="keyword">this</span> ACE applies to.
02212         If <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, no object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> GUID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> placed in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE.
02213 
02214     InheritedObjectTypeGuid - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> GUID of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> that will
02215         inherit <span class="keyword">this</span> ACE.  If <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, no inherited object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> GUID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> placed in
02216         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE.
02217 
02218     Sid - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID to be audited.
02219 
02220     AuditSuccess - If <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, indicates successful access attempts are to be
02221         audited.
02222 
02223     AuditFailure - If <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, indicated failed access attempts are to be
02224         audited.
02225 
02226 Return Value:
02227 
02228     STATUS_SUCCESS - The ACE was successfully added.
02229 
02230     STATUS_INVALID_ACL - The specified ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not properly formed.
02231 
02232     STATUS_REVISION_MISMATCH - The specified revision <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not known
02233         or <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> incompatible with that of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL.
02234 
02235     STATUS_ALLOTTED_SPACE_EXCEEDED - The <span class="keyword">new</span> ACE does not fit into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02236         ACL.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> larger ACL buffer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required.
02237 
02238     STATUS_INVALID_SID - The provided SID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not a structurally valid
02239         SID.
02240 
02241     STATUS_INVALID_PARAMETER - The AceFlags parameter was invalid.
02242 
02243 --*/
02244 
02245 {
02246     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
02247 
02248     <span class="keywordflow">if</span> (AuditSuccess) {
02249         AceFlags |= SUCCESSFUL_ACCESS_ACE_FLAG;
02250     }
02251     <span class="keywordflow">if</span> (AuditFailure) {
02252         AceFlags |= FAILED_ACCESS_ACE_FLAG;
02253     }
02254 
02255     <span class="comment">//</span>
02256     <span class="comment">// If no object types are specified,</span>
02257     <span class="comment">//  build a non-object ACE.</span>
02258     <span class="comment">//</span>
02259     <span class="keywordflow">if</span> (ObjectTypeGuid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; InheritedObjectTypeGuid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02260         <span class="keywordflow">return</span> <a class="code" href="../../d2/d4/acledit_8c.html#a14">RtlpAddKnownAce</a> (
02261                    Acl,
02262                    AceRevision,
02263                    AceFlags,
02264                    AccessMask,
02265                    Sid,
02266                    SYSTEM_AUDIT_ACE_TYPE
02267                    );
02268     }
02269 
02270     <span class="keywordflow">return</span> <a class="code" href="../../d2/d4/acledit_8c.html#a15">RtlpAddKnownObjectAce</a> (
02271                Acl,
02272                AceRevision,
02273                AceFlags,
02274                AccessMask,
02275                ObjectTypeGuid,
02276                InheritedObjectTypeGuid,
02277                Sid,
02278                SYSTEM_AUDIT_OBJECT_ACE_TYPE
02279                );
02280 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="acledit.c::RtlAddCompoundAce" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlAddCompoundAce           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>Acl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AceRevision</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>CompoundAceType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMask</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>ServerSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientSid</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/acledit_8c-source.html#l01098">1098</a> of file <a class="el" href="../../d3/d3/acledit_8c-source.html">acledit.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01380">RtlCopySid()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l02599">RtlFirstFreeAce()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00187">RtlValidAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00810">RtlValidSid()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>01109                    :
01110 
01111     This routine adds a KNOWN_COMPOUND_ACE to an ACL.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01112     expected to be a common form of ACL modification.
01113 
01114 Arguments:
01115 
01116     Acl - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl being modified
01117 
01118     AceRevision - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl/Ace revision of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE being added
01119 
01120     CompoundAceType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of compound ACE being added.
01121         Currently <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> defined <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> COMPOUND_ACE_IMPERSONATION.
01122 
01123     AccessMask - The mask of accesses to be granted to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified SID pair.
01124 
01125     ServerSid - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> SID to be placed in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE.
01126 
01127     ClientSid - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Client SID to be placed in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE.
01128 
01129 Return Value:
01130 
01131     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - STATUS_SUCCESS <span class="keywordflow">if</span> successful and an appropriate error
01132         status otherwise
01133 
01134     STATUS_INVALID_PARAMETER - The AceFlags parameter was invalid.
01135 
01136 --*/
01137 
01138 
01139 
01140 
01141 {
01142     PVOID FirstFree;
01143     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> AceSize;
01144     PKNOWN_COMPOUND_ACE GrantAce;
01145     UCHAR NewRevision;
01146 
01147     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01148 
01149     <span class="comment">//</span>
01150     <span class="comment">// Validate the structure of the SID</span>
01151     <span class="comment">//</span>
01152 
01153     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>(ServerSid) || !<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>(ClientSid)) {
01154         <span class="keywordflow">return</span> STATUS_INVALID_SID;
01155     }
01156 
01157     <span class="comment">//</span>
01158     <span class="comment">//  Check the ACL &amp; ACE revision levels</span>
01159     <span class="comment">// Compund ACEs become valid in version 3.</span>
01160     <span class="comment">//</span>
01161 
01162     <span class="keywordflow">if</span> ( Acl-&gt;AclRevision &gt; ACL_REVISION4 ||
01163          AceRevision &lt; ACL_REVISION3 ||
01164          AceRevision &gt; ACL_REVISION4 ) {
01165         <span class="keywordflow">return</span> STATUS_REVISION_MISMATCH;
01166     }
01167 
01168     <span class="comment">//</span>
01169     <span class="comment">// Calculate the new revision of the ACL.  The new revision is the maximum</span>
01170     <span class="comment">// of the old revision and and new ACE's revision.  This is possible because</span>
01171     <span class="comment">// the format of previously defined ACEs did not change across revisions.</span>
01172     <span class="comment">//</span>
01173 
01174     NewRevision = Acl-&gt;AclRevision &gt; (UCHAR)AceRevision ? Acl-&gt;AclRevision : (UCHAR)AceRevision;
01175 
01176     <span class="comment">//</span>
01177     <span class="comment">//  Locate the first free ace and check to see that the Acl is</span>
01178     <span class="comment">//  well formed.</span>
01179     <span class="comment">//</span>
01180 
01181     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a7">RtlValidAcl</a>( Acl )) {
01182         <span class="keywordflow">return</span> STATUS_INVALID_ACL;
01183     }
01184 
01185     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a25">RtlFirstFreeAce</a>( Acl, &amp;FirstFree )) {
01186 
01187         <span class="keywordflow">return</span> STATUS_INVALID_ACL;
01188     }
01189 
01190     <span class="comment">//</span>
01191     <span class="comment">//  Check to see if there is enough room in the Acl to store the new</span>
01192     <span class="comment">//  ACE</span>
01193     <span class="comment">//</span>
01194 
01195     AceSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<span class="keyword">sizeof</span>(KNOWN_COMPOUND_ACE) -
01196                        <span class="keyword">sizeof</span>(ULONG)              +
01197                        <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(ClientSid)    +
01198                        <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(ServerSid)
01199                        );
01200 
01201     <span class="keywordflow">if</span> (  FirstFree == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
01202           ((PUCHAR)FirstFree + AceSize &gt; ((PUCHAR)Acl + Acl-&gt;AclSize))
01203        ) {
01204 
01205         <span class="keywordflow">return</span> STATUS_ALLOTTED_SPACE_EXCEEDED;
01206     }
01207 
01208     <span class="comment">//</span>
01209     <span class="comment">// Add the ACE to the end of the ACL</span>
01210     <span class="comment">//</span>
01211 
01212     GrantAce = (PKNOWN_COMPOUND_ACE)FirstFree;
01213     GrantAce-&gt;Header.AceFlags = 0;
01214     GrantAce-&gt;Header.AceType = ACCESS_ALLOWED_COMPOUND_ACE_TYPE;
01215     GrantAce-&gt;Header.AceSize = AceSize;
01216     GrantAce-&gt;Mask = AccessMask;
01217     GrantAce-&gt;CompoundAceType = CompoundAceType;
01218     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(ServerSid), (PSID)(&amp;GrantAce-&gt;SidStart), ServerSid );
01219     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(ClientSid), (PSID)(((PCHAR)&amp;GrantAce-&gt;SidStart) + <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(ServerSid)), ClientSid );
01220 
01221     <span class="comment">//</span>
01222     <span class="comment">// Increment the number of ACEs by 1.</span>
01223     <span class="comment">//</span>
01224 
01225     Acl-&gt;AceCount += 1;
01226 
01227     <span class="comment">//</span>
01228     <span class="comment">// Adjust the Acl revision, if necessary</span>
01229     <span class="comment">//</span>
01230 
01231     Acl-&gt;AclRevision = NewRevision;
01232 
01233     <span class="comment">//</span>
01234     <span class="comment">//  And return to our caller</span>
01235     <span class="comment">//</span>
01236 
01237     <span class="keywordflow">return</span> STATUS_SUCCESS;
01238 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="acledit.c::RtlCreateAcl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlCreateAcl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>Acl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AclLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AclRevision</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/acledit_8c-source.html#l00099">99</a> of file <a class="el" href="../../d3/d3/acledit_8c-source.html">acledit.c</a>.
<p>
References <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/cmse_8c-source.html#l01227">CmpHiveRootSecurityDescriptor()</a>, <a class="el" href="../../d1/d6/server_2server_8c-source.html#l00705">CreateBSMEventSD()</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00299">CreateDAclToken()</a>, <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00091">CreateSecurityDescriptor()</a>, <a class="el" href="../../d5/d2/rtsetsec_8c-source.html#l00122">GenerateDescriptor()</a>, <a class="el" href="../../d6/d8/arcsec_8c-source.html#l00168">IopApplySystemPartitionProt()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08501">IopOpenDeviceParametersSubkey()</a>, <a class="el" href="../../d2/d8/tacl_8c-source.html#l00055">main()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l01545">ObpGetDosDevicesProtection()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01260">RtlCreateAndSetSD()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01860">RtlDefaultNpAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l05893">RtlpComputeMergedAcl2()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l07461">RtlpConvertAclToAutoInherit()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l08588">RtlpCreateServerAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l04716">RtlpInheritAcl2()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l01010">SeMakeAnonymousLogonToken()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l00536">SeMakeSystemToken()</a>, <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00049">SepCreateImpersonationTokenDacl()</a>, <a class="el" href="../../d0/d5/seinit_8c-source.html#l00184">SepInitializationPhase1()</a>, <a class="el" href="../../d9/d4/seglobal_8c-source.html#l00651">SepInitSystemDacls()</a>, <a class="el" href="../../d1/d9/rmmain_8c-source.html#l00060">SeRmInitPhase1()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00551">SmbTraceStart()</a>, <a class="el" href="../../d4/d5/tseum_8c-source.html#l00282">TestAddAce()</a>, <a class="el" href="../../d4/d5/tseum_8c-source.html#l00134">TestCreateAcl()</a>, <a class="el" href="../../d2/d0/ctsertl_8c-source.html#l00801">TestSeAclRtl()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l07648">TestTokenAssignPrimary()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00421">TestTokenCreate()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l03311">TestTokenSet()</a>.
<p>
<pre class="fragment"><div>00107                    :
00108 
00109     This routine initializes an ACL data structure.  After initialization
00110     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an ACL with no ACE (i.e., a deny all access type ACL)
00111 
00112 Arguments:
00113 
00114     Acl - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL being initialized
00115 
00116     AclLength - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ace buffer in bytes
00117 
00118     AclRevision - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> revision <span class="keywordflow">for</span> <span class="keyword">this</span> Acl
00119 
00120 Return Value:
00121 
00122     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - STATUS_SUCCESS <span class="keywordflow">if</span> successful
00123 
00124                STATUS_BUFFER_TOO_SMALL <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AclLength <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> too small,
00125 
00126                STATUS_INVALID_PARAMETER <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> revision <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> of range
00127 
00128 --*/
00129 
00130 {
00131     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00132 
00133     <span class="comment">//</span>
00134     <span class="comment">//  Check to see the size of the buffer is large enough to hold at</span>
00135     <span class="comment">//  least the ACL header</span>
00136     <span class="comment">//</span>
00137 
00138     <span class="keywordflow">if</span> (AclLength &lt; <span class="keyword">sizeof</span>(ACL)) {
00139 
00140         <span class="comment">//</span>
00141         <span class="comment">//  Buffer to small even for the ACL header</span>
00142         <span class="comment">//</span>
00143 
00144         <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00145 
00146     }
00147 
00148     <span class="comment">//</span>
00149     <span class="comment">//  Check to see if the revision is currently valid.  Later versions</span>
00150     <span class="comment">//  of this procedure might accept more revision levels</span>
00151     <span class="comment">//</span>
00152 
00153     <span class="keywordflow">if</span> (AclRevision &lt; MIN_ACL_REVISION || AclRevision &gt; MAX_ACL_REVISION) {
00154 
00155         <span class="comment">//</span>
00156         <span class="comment">//  Revision not current</span>
00157         <span class="comment">//</span>
00158 
00159         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00160 
00161     }
00162 
00163     <span class="keywordflow">if</span> ( AclLength &gt; MAXUSHORT ) {
00164 
00165         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00166     }
00167 
00168     <span class="comment">//</span>
00169     <span class="comment">//  Initialize the ACL</span>
00170     <span class="comment">//</span>
00171 
00172     Acl-&gt;AclRevision = (UCHAR)AclRevision;  <span class="comment">// Used to hardwire ACL_REVISION2 here</span>
00173     Acl-&gt;Sbz1 = 0;
00174     Acl-&gt;AclSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (AclLength &amp; 0xfffc);
00175     Acl-&gt;AceCount = 0;
00176     Acl-&gt;Sbz2 = 0;
00177 
00178     <span class="comment">//</span>
00179     <span class="comment">//  And return to our caller</span>
00180     <span class="comment">//</span>
00181 
00182     <span class="keywordflow">return</span> STATUS_SUCCESS;
00183 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="acledit.c::RtlDeleteAce" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlDeleteAce           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>Acl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AceIndex</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/acledit_8c-source.html#l00895">895</a> of file <a class="el" href="../../d3/d3/acledit_8c-source.html">acledit.c</a>.
<p>
References <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00053">FirstAce</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00059">NextAce</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l02599">RtlFirstFreeAce()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l02764">RtlpDeleteData()</a>, and <a class="el" href="../../d3/d3/acledit_8c-source.html#l00187">RtlValidAcl()</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00299">CreateDAclToken()</a>, <a class="el" href="../../d2/d8/tacl_8c-source.html#l00055">main()</a>, <a class="el" href="../../d4/d5/tseum_8c-source.html#l00402">TestDeleteAce()</a>, and <a class="el" href="../../d2/d0/ctsertl_8c-source.html#l00801">TestSeAclRtl()</a>.
<p>
<pre class="fragment"><div>00902                    :
00903 
00904     This routine deletes one ACE from an ACL.
00905 
00906 Arguments:
00907 
00908     Acl - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl being modified
00909 
00910     AceIndex - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> index of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Ace to <span class="keyword">delete</span>.
00911 
00912 Return Value:
00913 
00914     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - STATUS_SUCCESS <span class="keywordflow">if</span> successful and an appropriate error
00915         status otherwise
00916 
00917 --*/
00918 
00919 {
00920     PVOID FirstFree;
00921 
00922     PACE_HEADER Ace;
00923     ULONG i;
00924 
00925     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00926 
00927     <span class="comment">//</span>
00928     <span class="comment">//  Check the ACL structure</span>
00929     <span class="comment">//</span>
00930 
00931     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a7">RtlValidAcl</a>(Acl)) {
00932 
00933         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00934 
00935     }
00936 
00937     <span class="comment">//</span>
00938     <span class="comment">//  Make sure the AceIndex is within proper range, it's ulong so we know</span>
00939     <span class="comment">//  it can't be negative</span>
00940     <span class="comment">//</span>
00941 
00942     <span class="keywordflow">if</span> (AceIndex &gt;= Acl-&gt;AceCount) {
00943 
00944         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00945 
00946     }
00947 
00948     <span class="comment">//</span>
00949     <span class="comment">//  Locate the first free spot, this will tell us how much data</span>
00950     <span class="comment">//  we'll need to colapse.  If the results is false then the acl is</span>
00951     <span class="comment">//  ill-formed</span>
00952     <span class="comment">//</span>
00953 
00954     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a25">RtlFirstFreeAce</a>( Acl, &amp;FirstFree )) {
00955 
00956         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00957 
00958     }
00959 
00960     <span class="comment">//</span>
00961     <span class="comment">//  Now locate the ace that we're going to delete.  This loop</span>
00962     <span class="comment">//  doesn't need to check the acl for being well formed.</span>
00963     <span class="comment">//</span>
00964 
00965     Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>( Acl );
00966 
00967     <span class="keywordflow">for</span> (i = 0; i &lt; AceIndex; i++) {
00968 
00969         Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>( Ace );
00970 
00971     }
00972 
00973     <span class="comment">//</span>
00974     <span class="comment">//  We've found the ace to delete to simply copy over the rest of</span>
00975     <span class="comment">//  the acl over this ace.  The delete data procedure also deletes</span>
00976     <span class="comment">//  rest of the string that it's moving over so we don't have to</span>
00977     <span class="comment">//</span>
00978 
00979     <a class="code" href="../../d2/d4/acledit_8c.html#a5">RtlpDeleteData</a>( Ace, Ace-&gt;AceSize, (ULONG) ((PUCHAR)FirstFree - (PUCHAR)Ace));
00980 
00981     <span class="comment">//</span>
00982     <span class="comment">//  Update the Acl header</span>
00983     <span class="comment">//</span>
00984 
00985     Acl-&gt;AceCount--;
00986 
00987     <span class="comment">//</span>
00988     <span class="comment">//  And return to our caller</span>
00989     <span class="comment">//</span>
00990 
00991     <span class="keywordflow">return</span> STATUS_SUCCESS;
00992 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="acledit.c::RtlFirstFreeAce" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlFirstFreeAce           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>Acl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>FirstFree</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/acledit_8c-source.html#l02599">2599</a> of file <a class="el" href="../../d3/d3/acledit_8c-source.html">acledit.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00053">FirstAce</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00059">NextAce</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/acledit_8c-source.html#l00718">RtlAddAce()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l01098">RtlAddCompoundAce()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00895">RtlDeleteAce()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l01242">RtlpAddKnownAce()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l01405">RtlpAddKnownObjectAce()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l04371">RtlpCopyAces()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l05381">RtlpGenerateInheritedAce()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l04716">RtlpInheritAcl2()</a>, and <a class="el" href="../../d3/d3/acledit_8c-source.html#l00460">RtlQueryInformationAcl()</a>.
<p>
<pre class="fragment"><div>02606                    :
02607 
02608     This routine returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first free byte in an Acl
02609     or <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> acl <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ill-formed.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> full then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02610     <span class="keywordflow">return</span> pointer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> byte immediately following <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> acl, and
02611     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> will be returned.
02612 
02613 Arguments:
02614 
02615     Acl - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl to examine
02616 
02617     FirstFree - Receives a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first free position in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl
02618 
02619 Return Value:
02620 
02621     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> well formed and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
02622 
02623 --*/
02624 
02625 {
02626     PACE_HEADER Ace;
02627     ULONG i;
02628 
02629     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
02630 
02631     <span class="comment">//</span>
02632     <span class="comment">//  To find the first free spot in the Acl we need to search for</span>
02633     <span class="comment">//  the last ace.  We do this by zooming down the list until</span>
02634     <span class="comment">//  we've exhausted the ace count or the ace size (which ever comes</span>
02635     <span class="comment">//  first).  In the following loop Ace points to the next spot</span>
02636     <span class="comment">//  for an Ace and I is the ace index</span>
02637     <span class="comment">//</span>
02638 
02639     *FirstFree = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02640 
02641     <span class="keywordflow">for</span> ( i=0, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>( Acl );
02642           i &lt; Acl-&gt;AceCount;
02643           i++, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>( Ace )) {
02644 
02645         <span class="comment">//</span>
02646         <span class="comment">//  Check to make sure we haven't overrun the Acl buffer</span>
02647         <span class="comment">//  with our Ace pointer.  If we have then our input is bogus.</span>
02648         <span class="comment">//</span>
02649 
02650         <span class="keywordflow">if</span> (Ace &gt;= (PACE_HEADER)((PUCHAR)Acl + Acl-&gt;AclSize)) {
02651 
02652             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02653 
02654         }
02655 
02656     }
02657 
02658     <span class="comment">//</span>
02659     <span class="comment">//  Now Ace points to the first free spot in the Acl so set the</span>
02660     <span class="comment">//  output variable and check to make sure it is still in the Acl</span>
02661     <span class="comment">//  or just one beyond the end of the acl (i.e., the acl is full).</span>
02662     <span class="comment">//</span>
02663 
02664     <span class="keywordflow">if</span> (Ace &lt;= (PACE_HEADER)((PUCHAR)Acl + Acl-&gt;AclSize)) {
02665 
02666         *FirstFree = Ace;
02667     }
02668 
02669     <span class="comment">//</span>
02670     <span class="comment">//  The Acl is well formed so return the first free spot we've found</span>
02671     <span class="comment">//  (or NULL if there is no free space for another ACE)</span>
02672     <span class="comment">//</span>
02673 
02674     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02675 
02676 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="acledit.c::RtlGetAce" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlGetAce           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>Acl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AceIndex</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Ace</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/acledit_8c-source.html#l00996">996</a> of file <a class="el" href="../../d3/d3/acledit_8c-source.html">acledit.c</a>.
<p>
References <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00053">FirstAce</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00059">NextAce</a>, and <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/cmse_8c-source.html#l01227">CmpHiveRootSecurityDescriptor()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12098">IopCreateDefaultDeviceSecurityDescriptor()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08501">IopOpenDeviceParametersSubkey()</a>, <a class="el" href="../../d2/d8/tacl_8c-source.html#l00055">main()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l01545">ObpGetDosDevicesProtection()</a>, <a class="el" href="../../d4/d5/tseum_8c-source.html#l00451">TestGetAce()</a>, and <a class="el" href="../../d2/d0/ctsertl_8c-source.html#l00801">TestSeAclRtl()</a>.
<p>
<pre class="fragment"><div>01004                    :
01005 
01006     This routine returns a pointer to an ACE in an ACl referenced by
01007     ACE index
01008 
01009 Arguments:
01010 
01011     Acl - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL being queried
01012 
01013     AceIndex - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Ace index to locate
01014 
01015     Ace - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL
01016 
01017 Return Value:
01018 
01019     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - STATUS_SUCCESS <span class="keywordflow">if</span> successful and an appropriate error
01020         status otherwise
01021 
01022 --*/
01023 
01024 {
01025     ULONG i;
01026 
01027     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01028 
01029     <span class="comment">//</span>
01030     <span class="comment">//  Check the ACL revision level</span>
01031     <span class="comment">//</span>
01032 
01033     <span class="keywordflow">if</span> (!ValidAclRevision(Acl)) {
01034 
01035         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01036 
01037     }
01038 
01039     <span class="comment">//</span>
01040     <span class="comment">//  Check the AceIndex against the Ace count of the Acl, it's ulong so</span>
01041     <span class="comment">//  we know it can't be negative</span>
01042     <span class="comment">//</span>
01043 
01044     <span class="keywordflow">if</span> (AceIndex &gt;= Acl-&gt;AceCount) {
01045 
01046         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01047 
01048     }
01049 
01050     <span class="comment">//</span>
01051     <span class="comment">//  To find the Ace requested by zooming down the Ace List.</span>
01052     <span class="comment">//</span>
01053 
01054     *Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>( Acl );
01055 
01056     <span class="keywordflow">for</span> (i = 0; i &lt; AceIndex; i++) {
01057 
01058         <span class="comment">//</span>
01059         <span class="comment">//  Check to make sure we haven't overrun the Acl buffer</span>
01060         <span class="comment">//  with our ace pointer.  If we have then our input is bogus</span>
01061         <span class="comment">//</span>
01062 
01063         <span class="keywordflow">if</span> (*Ace &gt;= (PVOID)((PUCHAR)Acl + Acl-&gt;AclSize)) {
01064 
01065             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01066 
01067         }
01068 
01069         <span class="comment">//</span>
01070         <span class="comment">//  And move Ace to the next ace position</span>
01071         <span class="comment">//</span>
01072 
01073         *Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>( *Ace );
01074 
01075     }
01076 
01077     <span class="comment">//</span>
01078     <span class="comment">//  Now Ace points to the Ace we're after, but make sure we aren't</span>
01079     <span class="comment">//  beyond the Acl.</span>
01080     <span class="comment">//</span>
01081 
01082     <span class="keywordflow">if</span> (*Ace &gt;= (PVOID)((PUCHAR)Acl + Acl-&gt;AclSize)) {
01083 
01084         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01085 
01086     }
01087 
01088     <span class="comment">//</span>
01089     <span class="comment">//  The Ace is still within the Acl so return success to our caller</span>
01090     <span class="comment">//</span>
01091 
01092     <span class="keywordflow">return</span> STATUS_SUCCESS;
01093 
01094 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="acledit.c::RtlpAddData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpAddData           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>From</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FromSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>To</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ToSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/acledit_8c-source.html#l02684">2684</a> of file <a class="el" href="../../d3/d3/acledit_8c-source.html">acledit.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/acledit_8c-source.html#l00718">RtlAddAce()</a>.
<p>
<pre class="fragment"><div>02693                    :
02694 
02695     This routine copies data to a string of bytes.  It does <span class="keyword">this</span> by moving
02696     over data in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> to string so that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> from string will fit.  It also
02697     assumes that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> checks that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data will fit in memory have already
02698     been done.  Pictorally <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> results are as follows.
02699 
02700     Before:
02701 
02702         From -&gt; ffffffffff
02703 
02704         To   -&gt; tttttttttttttttt
02705 
02706     After:
02707 
02708         From -&gt; ffffffffff
02709 
02710         To   -&gt; fffffffffftttttttttttttttt
02711 
02712 Arguments:
02713 
02714     From - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source buffer
02715 
02716     FromSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> from buffer in bytes
02717 
02718     To - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> destination buffer
02719 
02720     ToSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> to buffer in bytes
02721 
02722 Return Value:
02723 
02724     None
02725 
02726 --*/
02727 
02728 {
02729     LONG i;
02730 
02731     <span class="comment">//</span>
02732     <span class="comment">//  Shift over the To buffer enough to fit in the From buffer</span>
02733     <span class="comment">//</span>
02734 
02735     <span class="keywordflow">for</span> (i = ToSize - 1; i &gt;= 0; i--) {
02736 
02737         ((PUCHAR)To)[i+FromSize] = ((PUCHAR)To)[i];
02738     }
02739 
02740     <span class="comment">//</span>
02741     <span class="comment">//  Now copy over the From buffer</span>
02742     <span class="comment">//</span>
02743 
02744     <span class="keywordflow">for</span> (i = 0; (ULONG)i &lt; FromSize; i += 1) {
02745 
02746         ((PUCHAR)To)[i] = ((PUCHAR)From)[i];
02747 
02748     }
02749 
02750     <span class="comment">//</span>
02751     <span class="comment">//  and return to our caller</span>
02752     <span class="comment">//</span>
02753 
02754     <span class="keywordflow">return</span>;
02755 
02756 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="acledit.c::RtlpAddKnownAce" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpAddKnownAce           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>Acl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AceRevision</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AceFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMask</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>Sid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>NewType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/acledit_8c-source.html#l01242">1242</a> of file <a class="el" href="../../d3/d3/acledit_8c-source.html">acledit.c</a>.
<p>
References <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00066">_KNOWN_ACE::Header</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00067">_KNOWN_ACE::Mask</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01380">RtlCopySid()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l02599">RtlFirstFreeAce()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00187">RtlValidAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00810">RtlValidSid()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00068">_KNOWN_ACE::SidStart</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/acledit_8c-source.html#l01607">RtlAddAccessAllowedAce()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l01666">RtlAddAccessAllowedAceEx()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l02008">RtlAddAccessAllowedObjectAce()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l01727">RtlAddAccessDeniedAce()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l01787">RtlAddAccessDeniedAceEx()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l02095">RtlAddAccessDeniedObjectAce()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l01849">RtlAddAuditAccessAce()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l01926">RtlAddAuditAccessAceEx()</a>, and <a class="el" href="../../d3/d3/acledit_8c-source.html#l02182">RtlAddAuditAccessObjectAce()</a>.
<p>
<pre class="fragment"><div>01253                    :
01254 
01255     This routine adds <a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">KNOWN_ACE</a> to an ACL.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01256     expected to be a common form of ACL modification.
01257 
01258     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> very bland ACE header <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> placed in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE.  It provides no
01259     inheritance and no ACE flags.  The <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
01260 
01261 Arguments:
01262 
01263     Acl - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl being modified
01264 
01265     AceRevision - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl/Ace revision of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE being added
01266 
01267     AceFlags - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> inherit flags <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE.
01268 
01269     AccessMask - The mask of accesses to be denied to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified SID.
01270 
01271     Sid - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID being denied access.
01272 
01273     NewType - Type of ACE to be added.
01274 
01275 Return Value:
01276 
01277     STATUS_SUCCESS - The ACE was successfully added.
01278 
01279     STATUS_INVALID_ACL - The specified ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not properly formed.
01280 
01281     STATUS_REVISION_MISMATCH - The specified revision <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not known
01282         or <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> incompatible with that of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL.
01283 
01284     STATUS_ALLOTTED_SPACE_EXCEEDED - The <span class="keyword">new</span> ACE does not fit into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01285         ACL.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> larger ACL buffer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required.
01286 
01287     STATUS_INVALID_SID - The provided SID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not a structurally valid
01288         SID.
01289 
01290     STATUS_INVALID_PARAMETER - The AceFlags parameter was invalid.
01291 
01292 --*/
01293 
01294 {
01295     PVOID FirstFree;
01296     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> AceSize;
01297     <a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a> GrantAce;
01298     UCHAR NewRevision;
01299     ULONG TestedAceFlags;
01300 
01301     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01302 
01303     <span class="comment">//</span>
01304     <span class="comment">// Validate the structure of the SID</span>
01305     <span class="comment">//</span>
01306 
01307     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>(Sid)) {
01308         <span class="keywordflow">return</span> STATUS_INVALID_SID;
01309     }
01310 
01311     <span class="comment">//</span>
01312     <span class="comment">//  Check the ACL &amp; ACE revision levels</span>
01313     <span class="comment">//</span>
01314 
01315     <span class="keywordflow">if</span> ( Acl-&gt;AclRevision &gt; ACL_REVISION4 || AceRevision &gt; ACL_REVISION4 ) {
01316 
01317         <span class="keywordflow">return</span> STATUS_REVISION_MISMATCH;
01318     }
01319 
01320     <span class="comment">//</span>
01321     <span class="comment">// Calculate the new revision of the ACL.  The new revision is the maximum</span>
01322     <span class="comment">// of the old revision and and new ACE's revision.  This is possible because</span>
01323     <span class="comment">// the format of previously defined ACEs did not change across revisions.</span>
01324     <span class="comment">//</span>
01325 
01326     NewRevision = Acl-&gt;AclRevision &gt; (UCHAR)AceRevision ? Acl-&gt;AclRevision : (UCHAR)AceRevision;
01327 
01328     <span class="comment">//</span>
01329     <span class="comment">// Validate the AceFlags.</span>
01330     <span class="comment">//</span>
01331 
01332     TestedAceFlags = AceFlags &amp; ~VALID_INHERIT_FLAGS;
01333     <span class="keywordflow">if</span> ( TestedAceFlags != 0 ) {
01334 
01335         <span class="keywordflow">if</span> ( NewType == SYSTEM_AUDIT_ACE_TYPE ) {
01336             TestedAceFlags &amp;=
01337                 ~(SUCCESSFUL_ACCESS_ACE_FLAG|FAILED_ACCESS_ACE_FLAG);
01338         }
01339 
01340         <span class="keywordflow">if</span> ( TestedAceFlags != 0 ) {
01341             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01342         }
01343     }
01344 
01345     <span class="comment">//</span>
01346     <span class="comment">//  Locate the first free ace and check to see that the Acl is</span>
01347     <span class="comment">//  well formed.</span>
01348     <span class="comment">//</span>
01349 
01350     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a7">RtlValidAcl</a>( Acl )) {
01351         <span class="keywordflow">return</span> STATUS_INVALID_ACL;
01352     }
01353     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a25">RtlFirstFreeAce</a>( Acl, &amp;FirstFree )) {
01354 
01355         <span class="keywordflow">return</span> STATUS_INVALID_ACL;
01356     }
01357 
01358     <span class="comment">//</span>
01359     <span class="comment">//  Check to see if there is enough room in the Acl to store the new</span>
01360     <span class="comment">//  ACE</span>
01361     <span class="comment">//</span>
01362 
01363     AceSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<span class="keyword">sizeof</span>(ACE_HEADER) +
01364                       <span class="keyword">sizeof</span>(ACCESS_MASK) +
01365                       <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(Sid));
01366 
01367     <span class="keywordflow">if</span> (  FirstFree == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
01368           ((PUCHAR)FirstFree + AceSize &gt; ((PUCHAR)Acl + Acl-&gt;AclSize))
01369        ) {
01370 
01371         <span class="keywordflow">return</span> STATUS_ALLOTTED_SPACE_EXCEEDED;
01372     }
01373 
01374     <span class="comment">//</span>
01375     <span class="comment">// Add the ACE to the end of the ACL</span>
01376     <span class="comment">//</span>
01377 
01378     GrantAce = (<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a>)FirstFree;
01379     GrantAce-&gt;<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html#o0">Header</a>.AceFlags = (UCHAR)AceFlags;
01380     GrantAce-&gt;<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html#o0">Header</a>.AceType = NewType;
01381     GrantAce-&gt;<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html#o0">Header</a>.AceSize = AceSize;
01382     GrantAce-&gt;<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html#o1">Mask</a> = AccessMask;
01383     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(Sid), (PSID)(&amp;GrantAce-&gt;<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html#o2">SidStart</a>), Sid );
01384 
01385     <span class="comment">//</span>
01386     <span class="comment">// Increment the number of ACEs by 1.</span>
01387     <span class="comment">//</span>
01388 
01389     Acl-&gt;AceCount += 1;
01390 
01391     <span class="comment">//</span>
01392     <span class="comment">// Adjust the Acl revision, if necessary</span>
01393     <span class="comment">//</span>
01394 
01395     Acl-&gt;AclRevision = NewRevision;
01396 
01397     <span class="comment">//</span>
01398     <span class="comment">//  And return to our caller</span>
01399     <span class="comment">//</span>
01400 
01401     <span class="keywordflow">return</span> STATUS_SUCCESS;
01402 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="acledit.c::RtlpAddKnownObjectAce" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpAddKnownObjectAce           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>Acl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AceRevision</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AceFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMask</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN GUID *ObjectTypeGuid&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN GUID *InheritedObjectTypeGuid&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>Sid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>NewType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/acledit_8c-source.html#l01405">1405</a> of file <a class="el" href="../../d3/d3/acledit_8c-source.html">acledit.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01380">RtlCopySid()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l02599">RtlFirstFreeAce()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00187">RtlValidAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00810">RtlValidSid()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/acledit_8c-source.html#l02008">RtlAddAccessAllowedObjectAce()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l02095">RtlAddAccessDeniedObjectAce()</a>, and <a class="el" href="../../d3/d3/acledit_8c-source.html#l02182">RtlAddAuditAccessObjectAce()</a>.
<p>
<pre class="fragment"><div>01418                    :
01419 
01420     This routine adds <a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">KNOWN_ACE</a> to an ACL.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01421     expected to be a common form of ACL modification.
01422 
01423     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> very bland ACE header <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> placed in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE.  It provides no
01424     inheritance and no ACE flags.  The <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
01425 
01426 Arguments:
01427 
01428     Acl - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl being modified
01429 
01430     AceRevision - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl/Ace revision of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE being added
01431 
01432     AceFlags - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> inherit flags <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE.
01433 
01434     AccessMask - The mask of accesses to be denied to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified SID.
01435 
01436     ObjectTypeGuid - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> GUID of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <span class="keyword">this</span> ACE applies to.
01437         If <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, no object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> GUID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> placed in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE.
01438 
01439     InheritedObjectTypeGuid - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> GUID of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> that will
01440         inherit <span class="keyword">this</span> ACE.  If <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, no inherited object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> GUID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> placed in
01441         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE.
01442 
01443     Sid - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID being denied access.
01444 
01445     NewType - Type of ACE to be added.
01446 
01447 Return Value:
01448 
01449     STATUS_SUCCESS - The ACE was successfully added.
01450 
01451     STATUS_INVALID_ACL - The specified ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not properly formed.
01452 
01453     STATUS_REVISION_MISMATCH - The specified revision <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not known
01454         or <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> incompatible with that of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL.
01455 
01456     STATUS_ALLOTTED_SPACE_EXCEEDED - The <span class="keyword">new</span> ACE does not fit into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01457         ACL.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> larger ACL buffer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required.
01458 
01459     STATUS_INVALID_SID - The provided SID <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not a structurally valid
01460         SID.
01461 
01462     STATUS_INVALID_PARAMETER - The AceFlags parameter was invalid.
01463 
01464 --*/
01465 
01466 {
01467     PVOID FirstFree;
01468     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> AceSize;
01469     PKNOWN_OBJECT_ACE GrantAce;
01470     UCHAR NewRevision;
01471     ULONG TestedAceFlags;
01472     ULONG AceObjectFlags = 0;
01473     ULONG SidSize;
01474     PCHAR Where;
01475 
01476     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01477 
01478     <span class="comment">//</span>
01479     <span class="comment">// Validate the structure of the SID</span>
01480     <span class="comment">//</span>
01481 
01482     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>(Sid)) {
01483         <span class="keywordflow">return</span> STATUS_INVALID_SID;
01484     }
01485 
01486     <span class="comment">//</span>
01487     <span class="comment">//  Check the ACL &amp; ACE revision levels</span>
01488     <span class="comment">// Object ACEs became valid in version 4.</span>
01489     <span class="comment">//</span>
01490 
01491     <span class="keywordflow">if</span> ( Acl-&gt;AclRevision &gt; ACL_REVISION4 || AceRevision != ACL_REVISION4 ) {
01492 
01493         <span class="keywordflow">return</span> STATUS_REVISION_MISMATCH;
01494     }
01495 
01496     <span class="comment">//</span>
01497     <span class="comment">// Calculate the new revision of the ACL.  The new revision is the maximum</span>
01498     <span class="comment">// of the old revision and and new ACE's revision.  This is possible because</span>
01499     <span class="comment">// the format of previously defined ACEs did not change across revisions.</span>
01500     <span class="comment">//</span>
01501 
01502     NewRevision = Acl-&gt;AclRevision &gt; (UCHAR)AceRevision ? Acl-&gt;AclRevision : (UCHAR)AceRevision;
01503 
01504     <span class="comment">//</span>
01505     <span class="comment">// Validate the AceFlags.</span>
01506     <span class="comment">//</span>
01507 
01508 
01509     TestedAceFlags = AceFlags &amp; ~VALID_INHERIT_FLAGS;
01510     <span class="keywordflow">if</span> ( TestedAceFlags != 0 ) {
01511 
01512         <span class="keywordflow">if</span> ( NewType == SYSTEM_AUDIT_ACE_TYPE ||
01513              NewType == SYSTEM_AUDIT_OBJECT_ACE_TYPE ) {
01514             TestedAceFlags &amp;=
01515                 ~(SUCCESSFUL_ACCESS_ACE_FLAG|FAILED_ACCESS_ACE_FLAG);
01516         }
01517 
01518         <span class="keywordflow">if</span> ( TestedAceFlags != 0 ) {
01519             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01520         }
01521     }
01522 
01523     <span class="comment">//</span>
01524     <span class="comment">//  Locate the first free ace and check to see that the Acl is</span>
01525     <span class="comment">//  well formed.</span>
01526     <span class="comment">//</span>
01527 
01528     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a7">RtlValidAcl</a>( Acl )) {
01529         <span class="keywordflow">return</span> STATUS_INVALID_ACL;
01530     }
01531     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a25">RtlFirstFreeAce</a>( Acl, &amp;FirstFree )) {
01532 
01533         <span class="keywordflow">return</span> STATUS_INVALID_ACL;
01534     }
01535 
01536     <span class="comment">//</span>
01537     <span class="comment">//  Check to see if there is enough room in the Acl to store the new</span>
01538     <span class="comment">//  ACE</span>
01539     <span class="comment">//</span>
01540 
01541     SidSize = <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(Sid);
01542     AceSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<span class="keyword">sizeof</span>(ACE_HEADER) +
01543                       <span class="keyword">sizeof</span>(ACCESS_MASK) +
01544                       <span class="keyword">sizeof</span>(ULONG) +
01545                       SidSize);
01546 
01547     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(ObjectTypeGuid) ) {
01548         AceObjectFlags |= ACE_OBJECT_TYPE_PRESENT;
01549         AceSize += <span class="keyword">sizeof</span>(GUID);
01550     }
01551 
01552     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(InheritedObjectTypeGuid) ) {
01553         AceObjectFlags |= ACE_INHERITED_OBJECT_TYPE_PRESENT;
01554         AceSize += <span class="keyword">sizeof</span>(GUID);
01555     }
01556 
01557     <span class="keywordflow">if</span> (  FirstFree == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
01558           ((PUCHAR)FirstFree + AceSize &gt; ((PUCHAR)Acl + Acl-&gt;AclSize))
01559        ) {
01560 
01561         <span class="keywordflow">return</span> STATUS_ALLOTTED_SPACE_EXCEEDED;
01562     }
01563 
01564     <span class="comment">//</span>
01565     <span class="comment">// Add the ACE to the end of the ACL</span>
01566     <span class="comment">//</span>
01567 
01568     GrantAce = (PKNOWN_OBJECT_ACE)FirstFree;
01569     GrantAce-&gt;Header.AceFlags = (UCHAR) AceFlags;
01570     GrantAce-&gt;Header.AceType = NewType;
01571     GrantAce-&gt;Header.AceSize = AceSize;
01572     GrantAce-&gt;Mask = AccessMask;
01573     GrantAce-&gt;Flags = AceObjectFlags;
01574     Where = (PCHAR) (&amp;GrantAce-&gt;SidStart);
01575     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(ObjectTypeGuid) ) {
01576         RtlCopyMemory( Where, ObjectTypeGuid, <span class="keyword">sizeof</span>(GUID) );
01577         Where += <span class="keyword">sizeof</span>(GUID);
01578     }
01579     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(InheritedObjectTypeGuid) ) {
01580         RtlCopyMemory( Where, InheritedObjectTypeGuid, <span class="keyword">sizeof</span>(GUID) );
01581         Where += <span class="keyword">sizeof</span>(GUID);
01582     }
01583     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( SidSize, (PSID)Where, Sid );
01584     Where += SidSize;
01585 
01586     <span class="comment">//</span>
01587     <span class="comment">// Increment the number of ACEs by 1.</span>
01588     <span class="comment">//</span>
01589 
01590     Acl-&gt;AceCount += 1;
01591 
01592     <span class="comment">//</span>
01593     <span class="comment">// Adjust the Acl revision, if necessary</span>
01594     <span class="comment">//</span>
01595 
01596     Acl-&gt;AclRevision = NewRevision;
01597 
01598     <span class="comment">//</span>
01599     <span class="comment">//  And return to our caller</span>
01600     <span class="comment">//</span>
01601 
01602     <span class="keywordflow">return</span> STATUS_SUCCESS;
01603 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="acledit.c::RtlpDeleteData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpDeleteData           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Data</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>RemoveSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>TotalSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/acledit_8c-source.html#l02764">2764</a> of file <a class="el" href="../../d3/d3/acledit_8c-source.html">acledit.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/acledit_8c-source.html#l00895">RtlDeleteAce()</a>.
<p>
<pre class="fragment"><div>02772                    :
02773 
02774     This routine deletes a string of bytes from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> front of a data buffer
02775     and compresses <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data.  It also zeros <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> string
02776     that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no longer in use.  Pictorially <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> results are as follows
02777 
02778     Before:
02779 
02780         Data       = DDDDDddddd
02781         RemoveSize = 5
02782         TotalSize  = 10
02783 
02784     After:
02785 
02786         Data      = ddddd00000
02787 
02788 Arguments:
02789 
02790     Data - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data being altered
02791 
02792     RemoveSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes to <span class="keyword">delete</span> from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> front
02793         of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data buffer
02794 
02795     TotalSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> total number of bytes in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data buffer
02796         before <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">delete</span> operation
02797 
02798 Return Value:
02799 
02800     None
02801 
02802 --*/
02803 
02804 {
02805     ULONG i;
02806 
02807     <span class="comment">//</span>
02808     <span class="comment">//  Shift over the buffer to remove the amount</span>
02809     <span class="comment">//</span>
02810 
02811     <span class="keywordflow">for</span> (i = RemoveSize; i &lt; TotalSize; i++) {
02812 
02813         ((PUCHAR)Data)[i-RemoveSize] = ((PUCHAR)Data)[i];
02814 
02815     }
02816 
02817     <span class="comment">//</span>
02818     <span class="comment">//  Now as a safety precaution we'll zero out the rest of the string</span>
02819     <span class="comment">//</span>
02820 
02821     <span class="keywordflow">for</span> (i = TotalSize - RemoveSize; i &lt; TotalSize; i++) {
02822 
02823         ((PUCHAR)Data)[i] = 0;
02824     }
02825 
02826     <span class="comment">//</span>
02827     <span class="comment">//  And return to our caller</span>
02828     <span class="comment">//</span>
02829 
02830     <span class="keywordflow">return</span>;
02831 
02832 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="acledit.c::RtlQueryInformationAcl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlQueryInformationAcl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>Acl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>AclInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AclInformationLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACL_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>AclInformationClass</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/acledit_8c-source.html#l00460">460</a> of file <a class="el" href="../../d3/d3/acledit_8c-source.html">acledit.c</a>.
<p>
References <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l02599">RtlFirstFreeAce()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08501">IopOpenDeviceParametersSubkey()</a>, <a class="el" href="../../d2/d8/tacl_8c-source.html#l00055">main()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02265">RtlLengthUsedSecurityDescriptor()</a>, <a class="el" href="../../d4/d5/tseum_8c-source.html#l00184">TestQueryInformationAcl()</a>, and <a class="el" href="../../d2/d0/ctsertl_8c-source.html#l00801">TestSeAclRtl()</a>.
<p>
<pre class="fragment"><div>00469                    :
00470 
00471     This routine returns to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller information about an ACL.  The requested
00472     information can be AclRevisionInformation, or AclSizeInformation.
00473 
00474 Arguments:
00475 
00476     Acl - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl being examined
00477 
00478     AclInformation - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information being
00479         requested
00480 
00481     AclInformationLength - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AclInformation buffer
00482         in bytes
00483 
00484     AclInformationClass - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of information being requested
00485 
00486 Return Value:
00487 
00488     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - STATUS_SUCCESS <span class="keywordflow">if</span> successful and an appropriate error
00489         status otherwise
00490 
00491 --*/
00492 
00493 {
00494     PACL_REVISION_INFORMATION RevisionInfo;
00495     PACL_SIZE_INFORMATION SizeInfo;
00496 
00497 
00498     PVOID FirstFree;
00499     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00500 
00501     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00502 
00503     <span class="comment">//</span>
00504     <span class="comment">//  Check the ACL revision level</span>
00505     <span class="comment">//</span>
00506 
00507     <span class="keywordflow">if</span> (!ValidAclRevision( Acl )) {
00508 
00509         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00510 
00511     }
00512 
00513     <span class="comment">//</span>
00514     <span class="comment">//  Case on the information class being requested</span>
00515     <span class="comment">//</span>
00516 
00517     <span class="keywordflow">switch</span> (AclInformationClass) {
00518 
00519     <span class="keywordflow">case</span> AclRevisionInformation:
00520 
00521         <span class="comment">//</span>
00522         <span class="comment">//  Make sure the buffer size is correct</span>
00523         <span class="comment">//</span>
00524 
00525         <span class="keywordflow">if</span> (AclInformationLength &lt; <span class="keyword">sizeof</span>(ACL_REVISION_INFORMATION)) {
00526 
00527             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00528 
00529         }
00530 
00531         <span class="comment">//</span>
00532         <span class="comment">//  Get the Acl revision and return</span>
00533         <span class="comment">//</span>
00534 
00535         RevisionInfo = (PACL_REVISION_INFORMATION)AclInformation;
00536         RevisionInfo-&gt;AclRevision = Acl-&gt;AclRevision;
00537 
00538         <span class="keywordflow">break</span>;
00539 
00540     <span class="keywordflow">case</span> AclSizeInformation:
00541 
00542         <span class="comment">//</span>
00543         <span class="comment">//  Make sure the buffer size is correct</span>
00544         <span class="comment">//</span>
00545 
00546         <span class="keywordflow">if</span> (AclInformationLength &lt; <span class="keyword">sizeof</span>(ACL_SIZE_INFORMATION)) {
00547 
00548             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00549 
00550         }
00551 
00552         <span class="comment">//</span>
00553         <span class="comment">//  Locate the first free spot in the Acl</span>
00554         <span class="comment">//</span>
00555 
00556         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a25">RtlFirstFreeAce</a>( Acl, &amp;FirstFree )) {
00557 
00558             <span class="comment">//</span>
00559             <span class="comment">//  The input Acl is ill-formed</span>
00560             <span class="comment">//</span>
00561 
00562             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00563 
00564         }
00565 
00566         <span class="comment">//</span>
00567         <span class="comment">//  Given a pointer to the first free spot we can now easily compute</span>
00568         <span class="comment">//  the number of free bytes and used bytes in the Acl.</span>
00569         <span class="comment">//</span>
00570 
00571         SizeInfo = (PACL_SIZE_INFORMATION)AclInformation;
00572         SizeInfo-&gt;AceCount = Acl-&gt;AceCount;
00573 
00574         <span class="keywordflow">if</span> (FirstFree == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00575 
00576             <span class="comment">//</span>
00577             <span class="comment">//  With a null first free we don't have any free space in the Acl</span>
00578             <span class="comment">//</span>
00579 
00580             SizeInfo-&gt;AclBytesInUse = Acl-&gt;AclSize;
00581 
00582             SizeInfo-&gt;AclBytesFree = 0;
00583 
00584         } <span class="keywordflow">else</span> {
00585 
00586             <span class="comment">//</span>
00587             <span class="comment">//  The first free is not null so we have some free room left in</span>
00588             <span class="comment">//  the acl</span>
00589             <span class="comment">//</span>
00590 
00591             SizeInfo-&gt;AclBytesInUse = (ULONG)((PUCHAR)FirstFree - (PUCHAR)Acl);
00592 
00593             SizeInfo-&gt;AclBytesFree = Acl-&gt;AclSize - SizeInfo-&gt;AclBytesInUse;
00594 
00595         }
00596 
00597         <span class="keywordflow">break</span>;
00598 
00599     <span class="keywordflow">default</span>:
00600 
00601         <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
00602 
00603     }
00604 
00605     <span class="comment">//</span>
00606     <span class="comment">//  and return to our caller</span>
00607     <span class="comment">//</span>
00608 
00609     <span class="keywordflow">return</span> STATUS_SUCCESS;
00610 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="acledit.c::RtlSetInformationAcl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlSetInformationAcl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>Acl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>AclInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AclInformationLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACL_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>AclInformationClass</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/acledit_8c-source.html#l00614">614</a> of file <a class="el" href="../../d3/d3/acledit_8c-source.html">acledit.c</a>.
<p>
References <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/ctsertl_8c-source.html#l00801">TestSeAclRtl()</a>, and <a class="el" href="../../d4/d5/tseum_8c-source.html#l00239">TestSetInformationAcl()</a>.
<p>
<pre class="fragment"><div>00623                    :
00624 
00625     This routine sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state of an ACL.  For now <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> revision
00626     level can be set and <span class="keywordflow">for</span> now <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> a revision level of 1 <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> accepted
00627     so <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> rather simple
00628 
00629 Arguments:
00630 
00631     Acl - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl being altered
00632 
00633     AclInformation - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information being
00634         set
00635 
00636     AclInformationLength - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Acl information buffer
00637 
00638     AclInformationClass - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of information begin set
00639 
00640 Return Value:
00641 
00642     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - STATUS_SUCCESS <span class="keywordflow">if</span> successful and an appropriate error
00643         status otherwise
00644 
00645 --*/
00646 
00647 {
00648     PACL_REVISION_INFORMATION RevisionInfo;
00649 
00650     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00651 
00652     <span class="comment">//</span>
00653     <span class="comment">//  Check the ACL revision level</span>
00654     <span class="comment">//</span>
00655 
00656     <span class="keywordflow">if</span> (!ValidAclRevision( Acl )) {
00657 
00658         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00659 
00660     }
00661 
00662     <span class="comment">//</span>
00663     <span class="comment">//  Case on the information class being requested</span>
00664     <span class="comment">//</span>
00665 
00666     <span class="keywordflow">switch</span> (AclInformationClass) {
00667 
00668     <span class="keywordflow">case</span> AclRevisionInformation:
00669 
00670         <span class="comment">//</span>
00671         <span class="comment">//  Make sure the buffer size is correct</span>
00672         <span class="comment">//</span>
00673 
00674         <span class="keywordflow">if</span> (AclInformationLength &lt; <span class="keyword">sizeof</span>(ACL_REVISION_INFORMATION)) {
00675 
00676             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00677 
00678         }
00679 
00680         <span class="comment">//</span>
00681         <span class="comment">//  Get the Acl requested ACL revision level</span>
00682         <span class="comment">//</span>
00683 
00684         RevisionInfo = (PACL_REVISION_INFORMATION)AclInformation;
00685 
00686         <span class="comment">//</span>
00687         <span class="comment">//  Don't let them lower the revision of an ACL.</span>
00688         <span class="comment">//</span>
00689 
00690         <span class="keywordflow">if</span> (RevisionInfo-&gt;AclRevision &lt; Acl-&gt;AclRevision ) {
00691 
00692             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00693         }
00694 
00695         <span class="comment">//</span>
00696         <span class="comment">// Assign the new revision.</span>
00697         <span class="comment">//</span>
00698 
00699         Acl-&gt;AclRevision = (UCHAR)RevisionInfo-&gt;AclRevision;
00700 
00701         <span class="keywordflow">break</span>;
00702 
00703     <span class="keywordflow">default</span>:
00704 
00705         <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
00706 
00707     }
00708 
00709     <span class="comment">//</span>
00710     <span class="comment">//  and return to our caller</span>
00711     <span class="comment">//</span>
00712 
00713     <span class="keywordflow">return</span> STATUS_SUCCESS;
00714 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="acledit.c::RtlValidAcl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlValidAcl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACL&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Acl</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d3/acledit_8c-source.html#l00187">187</a> of file <a class="el" href="../../d3/d3/acledit_8c-source.html">acledit.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d1/rtdmpsec_8c.html#a3">KNOWN_ACE</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00056">LongAligned</a>, <a class="el" href="../../d4/d1/rtdmpsec_8c.html#a4">PKNOWN_ACE</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d3/d3/acledit_8c-source.html#l00057">WordAligned</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/acledit_8c-source.html#l00718">RtlAddAce()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l01098">RtlAddCompoundAce()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00895">RtlDeleteAce()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l01242">RtlpAddKnownAce()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l01405">RtlpAddKnownObjectAce()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l07461">RtlpConvertAclToAutoInherit()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l11089">RtlValidRelativeSecurityDescriptor()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02066">RtlValidSecurityDescriptor()</a>, <a class="el" href="../../d6/d5/sep_8c-source.html#l00036">SepCheckAcl()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l02414">SeValidSecurityDescriptor()</a>, <a class="el" href="../../d2/d0/ctsertl_8c-source.html#l00801">TestSeAclRtl()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l01434">TestTokenQuery()</a>.
<p>
<pre class="fragment"><div>00193                    :
00194 
00195     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> validates an ACL.
00196 
00197     This involves validating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> revision level of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL and ensuring
00198     that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of ACEs specified in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AceCount fit in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> space
00199     specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AclSize field of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL header.
00200 
00201 Arguments:
00202 
00203     Acl - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACL structure to validate.
00204 
00205 Return Value:
00206 
00207     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure of Acl <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid.
00208 
00209 --*/
00210 
00211 {
00212     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00213 
00214     <span class="keywordflow">try</span> {
00215         PACE_HEADER Ace;
00216         PISID Sid;
00217         PISID Sid2;
00218         ULONG i;
00219         UCHAR AclRevision = ACL_REVISION2;
00220 
00221 
00222         <span class="comment">//</span>
00223         <span class="comment">//  Check the ACL revision level</span>
00224         <span class="comment">//</span>
00225         <span class="keywordflow">if</span> (!ValidAclRevision(Acl)) {
00226             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00227         }
00228 
00229 
00230         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a3">WordAligned</a>(&amp;Acl-&gt;AclSize)) {
00231             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00232         }
00233 
00234         <span class="keywordflow">if</span> (Acl-&gt;AclSize &lt; <span class="keyword">sizeof</span>(ACL)) {
00235             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00236         }
00237         <span class="comment">//</span>
00238         <span class="comment">// Validate all of the ACEs.</span>
00239         <span class="comment">//</span>
00240 
00241         Ace = ((PVOID)((PUCHAR)(Acl) + <span class="keyword">sizeof</span>(ACL)));
00242 
00243         <span class="keywordflow">for</span> (i = 0; i &lt; Acl-&gt;AceCount; i++) {
00244 
00245             <span class="comment">//</span>
00246             <span class="comment">//  Check to make sure we haven't overrun the Acl buffer</span>
00247             <span class="comment">//  with our ace pointer.  Make sure the ACE_HEADER is in</span>
00248             <span class="comment">//  the ACL also.</span>
00249             <span class="comment">//</span>
00250 
00251             <span class="keywordflow">if</span> ((PUCHAR)Ace + <span class="keyword">sizeof</span>(ACE_HEADER) &gt;= ((PUCHAR)Acl + Acl-&gt;AclSize)) {
00252                 <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00253             }
00254 
00255             <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a3">WordAligned</a>(&amp;Ace-&gt;AceSize)) {
00256                 <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00257             }
00258 
00259             <span class="keywordflow">if</span> ((PUCHAR)Ace + Ace-&gt;AceSize &gt; ((PUCHAR)Acl + Acl-&gt;AclSize)) {
00260                 <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00261             }
00262 
00263             <span class="comment">//</span>
00264             <span class="comment">// It is now safe to reference fields in the ACE header.</span>
00265             <span class="comment">//</span>
00266 
00267             <span class="comment">//</span>
00268             <span class="comment">// The ACE header fits into the ACL, if this is a known type of ACE,</span>
00269             <span class="comment">// make sure the SID is within the bounds of the ACE</span>
00270             <span class="comment">//</span>
00271 
00272             <span class="keywordflow">if</span> (IsKnownAceType(Ace)) {
00273 
00274                 <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a2">LongAligned</a>(Ace-&gt;AceSize)) {
00275                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00276                 }
00277 
00278                 <span class="keywordflow">if</span> (Ace-&gt;AceSize &lt; <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">KNOWN_ACE</a>) - <span class="keyword">sizeof</span>(ULONG) + <span class="keyword">sizeof</span>(SID) - <span class="keyword">sizeof</span>(ULONG)) {
00279                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00280                 }
00281 
00282                 <span class="comment">//</span>
00283                 <span class="comment">// It's now safe to reference the parts of the SID structure, though</span>
00284                 <span class="comment">// not the SID itself.</span>
00285                 <span class="comment">//</span>
00286 
00287                 Sid = (PISID) &amp; (((<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a>)Ace)-&gt;SidStart);
00288 
00289                 <span class="keywordflow">if</span> (Sid-&gt;Revision != SID_REVISION) {
00290                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00291                 }
00292 
00293                 <span class="keywordflow">if</span> (Sid-&gt;SubAuthorityCount &gt; SID_MAX_SUB_AUTHORITIES) {
00294                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00295                 }
00296 
00297                 <span class="comment">//</span>
00298                 <span class="comment">// SeLengthSid computes the size of the SID based on the subauthority count,</span>
00299                 <span class="comment">// so it is safe to use even though we don't know that the body of the SID</span>
00300                 <span class="comment">// is safe to reference.</span>
00301                 <span class="comment">//</span>
00302 
00303                 <span class="keywordflow">if</span> (Ace-&gt;AceSize &lt; <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">KNOWN_ACE</a>) - <span class="keyword">sizeof</span>(ULONG) + <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( Sid )) {
00304                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00305                 }
00306 
00307 
00308             <span class="comment">//</span>
00309             <span class="comment">// If it's a compound ACE, then perform roughly the same set of tests, but</span>
00310             <span class="comment">// check the validity of both SIDs.</span>
00311             <span class="comment">//</span>
00312 
00313             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IsCompoundAceType(Ace)) {
00314 
00315                 <span class="comment">//</span>
00316                 <span class="comment">// Compound ACEs became valid in revision 3</span>
00317                 <span class="comment">//</span>
00318                 <span class="keywordflow">if</span> ( Acl-&gt;AclRevision &lt; ACL_REVISION3 ) {
00319                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00320                 }
00321 
00322                 <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a2">LongAligned</a>(Ace-&gt;AceSize)) {
00323                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00324                 }
00325 
00326                 <span class="keywordflow">if</span> (Ace-&gt;AceSize &lt; <span class="keyword">sizeof</span>(KNOWN_COMPOUND_ACE) - <span class="keyword">sizeof</span>(ULONG) + <span class="keyword">sizeof</span>(SID)) {
00327                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00328                 }
00329 
00330                 <span class="comment">//</span>
00331                 <span class="comment">// The only currently defined Compound ACE is an Impersonation ACE.</span>
00332                 <span class="comment">//</span>
00333 
00334                 <span class="keywordflow">if</span> (((PKNOWN_COMPOUND_ACE)Ace)-&gt;CompoundAceType != COMPOUND_ACE_IMPERSONATION) {
00335                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00336                 }
00337 
00338                 <span class="comment">//</span>
00339                 <span class="comment">// Examine the first SID and make sure it's structurally valid,</span>
00340                 <span class="comment">// and it lies within the boundaries of the ACE.</span>
00341                 <span class="comment">//</span>
00342 
00343                 Sid = (PISID) &amp; (((PKNOWN_COMPOUND_ACE)Ace)-&gt;SidStart);
00344 
00345                 <span class="keywordflow">if</span> (Sid-&gt;Revision != SID_REVISION) {
00346                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00347                 }
00348 
00349                 <span class="keywordflow">if</span> (Sid-&gt;SubAuthorityCount &gt; SID_MAX_SUB_AUTHORITIES) {
00350                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00351                 }
00352 
00353                 <span class="comment">//</span>
00354                 <span class="comment">// Compound ACEs contain two SIDs.  Make sure this ACE is large enough to contain</span>
00355                 <span class="comment">// not only the first SID, but the body of the 2nd.</span>
00356                 <span class="comment">//</span>
00357 
00358                 <span class="keywordflow">if</span> (Ace-&gt;AceSize &lt; <span class="keyword">sizeof</span>(KNOWN_COMPOUND_ACE) - <span class="keyword">sizeof</span>(ULONG) + <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( Sid ) + <span class="keyword">sizeof</span>(SID)) {
00359                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00360                 }
00361 
00362                 <span class="comment">//</span>
00363                 <span class="comment">// It is safe to reference the interior of the 2nd SID.</span>
00364                 <span class="comment">//</span>
00365 
00366                 Sid2 = (PISID) ((PUCHAR)Sid + <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( Sid ));
00367 
00368                 <span class="keywordflow">if</span> (Sid2-&gt;Revision != SID_REVISION) {
00369                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00370                 }
00371 
00372                 <span class="keywordflow">if</span> (Sid2-&gt;SubAuthorityCount &gt; SID_MAX_SUB_AUTHORITIES) {
00373                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00374                 }
00375 
00376                 <span class="keywordflow">if</span> (Ace-&gt;AceSize &lt; <span class="keyword">sizeof</span>(KNOWN_COMPOUND_ACE) - <span class="keyword">sizeof</span>(ULONG) + <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( Sid ) + <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( Sid2 )) {
00377                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00378                 }
00379 
00380 
00381             <span class="comment">//</span>
00382             <span class="comment">// If it's an object ACE, then perform roughly the same set of tests.</span>
00383             <span class="comment">//</span>
00384 
00385             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IsObjectAceType(Ace)) {
00386                 ULONG GuidSize=0;
00387 
00388                 <span class="comment">//</span>
00389                 <span class="comment">// Object ACEs became valid in revision 4</span>
00390                 <span class="comment">//</span>
00391                 <span class="keywordflow">if</span> ( Acl-&gt;AclRevision &lt; ACL_REVISION4 ) {
00392                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00393                 }
00394 
00395                 <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a2">LongAligned</a>(Ace-&gt;AceSize)) {
00396                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00397                 }
00398 
00399                 <span class="comment">//</span>
00400                 <span class="comment">// Ensure there is room for the ACE header.</span>
00401                 <span class="comment">//</span>
00402                 <span class="keywordflow">if</span> (Ace-&gt;AceSize &lt; <span class="keyword">sizeof</span>(KNOWN_OBJECT_ACE) - <span class="keyword">sizeof</span>(ULONG)) {
00403                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00404                 }
00405 
00406 
00407                 <span class="comment">//</span>
00408                 <span class="comment">// Ensure there is room for the GUIDs and SID header</span>
00409                 <span class="comment">//</span>
00410                 <span class="keywordflow">if</span> ( RtlObjectAceObjectTypePresent( Ace ) ) {
00411                     GuidSize += <span class="keyword">sizeof</span>(GUID);
00412                 }
00413 
00414                 <span class="keywordflow">if</span> ( RtlObjectAceInheritedObjectTypePresent( Ace ) ) {
00415                     GuidSize += <span class="keyword">sizeof</span>(GUID);
00416                 }
00417 
00418                 <span class="keywordflow">if</span> (Ace-&gt;AceSize &lt; <span class="keyword">sizeof</span>(KNOWN_OBJECT_ACE) - <span class="keyword">sizeof</span>(ULONG) + GuidSize + <span class="keyword">sizeof</span>(SID)) {
00419                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00420                 }
00421 
00422                 <span class="comment">//</span>
00423                 <span class="comment">// It's now safe to reference the parts of the SID structure, though</span>
00424                 <span class="comment">// not the SID itself.</span>
00425                 <span class="comment">//</span>
00426 
00427                 Sid = (PISID) RtlObjectAceSid( Ace );
00428 
00429                 <span class="keywordflow">if</span> (Sid-&gt;Revision != SID_REVISION) {
00430                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00431                 }
00432 
00433                 <span class="keywordflow">if</span> (Sid-&gt;SubAuthorityCount &gt; SID_MAX_SUB_AUTHORITIES) {
00434                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00435                 }
00436 
00437                 <span class="keywordflow">if</span> (Ace-&gt;AceSize &lt; <span class="keyword">sizeof</span>(KNOWN_OBJECT_ACE) - <span class="keyword">sizeof</span>(ULONG) + GuidSize + <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( Sid ) ) {
00438                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00439                 }
00440             }
00441 
00442             <span class="comment">//</span>
00443             <span class="comment">//  And move Ace to the next ace position</span>
00444             <span class="comment">//</span>
00445 
00446             Ace = ((PVOID)((PUCHAR)(Ace) + ((PACE_HEADER)(Ace))-&gt;AceSize));
00447         }
00448 
00449         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00450 
00451     } except(EXCEPTION_EXECUTE_HANDLER) {
00452 
00453         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00454     }
00455 
00456 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:49 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
