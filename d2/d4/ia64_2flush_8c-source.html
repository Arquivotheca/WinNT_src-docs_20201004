<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: flush.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>flush.c</h1><a href="../../d1/d5/ia64_2flush_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/*++</span>
00003 <span class="comment"></span>
00004 <span class="comment">Module Name:</span>
00005 <span class="comment"></span>
00006 <span class="comment">    flush.c</span>
00007 <span class="comment"></span>
00008 <span class="comment">Abstract:</span>
00009 <span class="comment"></span>
00010 <span class="comment">    This module implements IA64 machine dependent kernel functions to flush</span>
00011 <span class="comment">    the data and instruction caches and to flush I/O buffers.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    07-Mar-1996</span>
00016 <span class="comment">    </span>
00017 <span class="comment">    Bernard Lint</span>
00018 <span class="comment">    M. Jayakumar (Muthurajan.Jayakumar@intel.com)</span>
00019 <span class="comment"></span>
00020 <span class="comment"></span>
00021 <span class="comment">Environment:</span>
00022 <span class="comment"></span>
00023 <span class="comment">    Kernel mode only.</span>
00024 <span class="comment"></span>
00025 <span class="comment">Revision History:</span>
00026 <span class="comment"></span>
00027 <span class="comment">--*/</span>
00028 
00029 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00030 <span class="preprocessor">#include "kxia64.h"</span>
00031 
00032 <span class="comment">//</span>
00033 <span class="comment">// PROBE_VISIBILITY_PAL_SUPPORT flag is one time write (RESET) only and multiple time read</span>
00034 <span class="comment">// only flag. It is used to check to see if the processor needs PAL_SUPPORT for VISIBILITY // in prefetches. Once the check is made, this flag optimizes such that further checks are // eliminated.</span>
00035 <span class="comment">//</span>
00036  
<a name="l00037"></a><a class="code" href="../../d1/d5/ia64_2flush_8c.html#a0">00037</a> ULONG <a class="code" href="../../d1/d5/ia64_2flush_8c.html#a0">ProbePalVisibilitySupport</a>=1;
<a name="l00038"></a><a class="code" href="../../d1/d5/ia64_2flush_8c.html#a1">00038</a> ULONG <a class="code" href="../../d1/d5/ia64_2flush_8c.html#a1">NeedPalVisibilitySupport</a>=1;
<a name="l00039"></a><a class="code" href="../../d1/d5/ia64_2flush_8c.html#a2">00039</a> <span class="keyword">extern</span> KSPIN_LOCK <a class="code" href="../../d1/d5/ia64_2flush_8c.html#a2">KiCacheFlushLock</a>;
00040 <span class="comment">//</span>
00041 <span class="comment">// Define forward referenced prototyes.</span>
00042 <span class="comment">//</span>
00043 
00044 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00045 <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a1">KiSweepDcacheTarget</a> (
00046     IN PULONG SignalDone,
00047     IN PVOID Parameter1,
00048     IN PVOID Parameter2,
00049     IN PVOID Parameter3
00050     );
00051 
00052 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00053 <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a2">KiSweepIcacheTarget</a> (
00054     IN PULONG SignalDone,
00055     IN PVOID Parameter1,
00056     IN PVOID Parameter2,
00057     IN PVOID Parameter3
00058     );
00059 
00060 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00061 <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a4">KiFlushIoBuffersTarget</a> (
00062     IN PKIPI_CONTEXT SignalDone,
00063     IN PVOID Mdl,
00064     IN PVOID ReadOperation,
00065     IN PVOID DmaOperation
00066     );
00067 
00068 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00069 <a class="code" href="../../d1/d5/ia64_2flush_8c.html#a6">KiSyncCacheTarget</a>(
00070     IN PKIPI_CONTEXT SignalDone,
00071     IN PVOID Parameter1,
00072     IN PVOID Parameter2,
00073     IN PVOID Parameter3
00074     );
00075 
00076 ULONG_PTR
00077 <a class="code" href="../../d1/d5/ia64_2flush_8c.html#a7">KiSyncMC_DrainTarget</a>(
00078     );
00079 
00080 
00081 ULONG_PTR
00082 <a class="code" href="../../d1/d5/ia64_2flush_8c.html#a8">KiSyncMC_Drain</a>(
00083     IN BOOLEAN AllProcessors,
00084     IN PVOID BaseAddress,
00085     IN ULONG Length
00086     );
00087 
00088 ULONG_PTR
00089 <a class="code" href="../../d1/d5/ia64_2flush_8c.html#a9">KiSyncPrefetchVisibleTarget</a>(
00090     );
00091 
00092 ULONG_PTR
00093 <a class="code" href="../../d1/d5/ia64_2flush_8c.html#a10">KiSyncPrefetchVisible</a> (
00094     IN BOOLEAN AllProcessors,
00095     IN PVOID BaseAddress,
00096     IN ULONG Length
00097     );
00098 
00099 
00100 
00101 
00102 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00103"></a><a class="code" href="../../d1/d5/ia64_2flush_8c.html#a6">00103</a> <a class="code" href="../../d1/d5/ia64_2flush_8c.html#a6">KiSyncCacheTarget</a> (
00104     IN PKIPI_CONTEXT SignalDone,
00105     IN PVOID Parameter1,
00106     IN PVOID Parameter2,
00107     IN PVOID Parameter3
00108     )
00109 
00110 <span class="comment">/*++</span>
00111 <span class="comment">Routine Description:</span>
00112 <span class="comment"></span>
00113 <span class="comment">    This function synchronizes the I-fetch pipeline. Typically this routine will be</span>
00114 <span class="comment">    executed by every processor in the system in response to an IPI after the cache</span>
00115 <span class="comment">    is flushed. Each processor executing RFI while leaving the IPI produces the</span>
00116 <span class="comment">    serialization effect that is required after isync to make sure that further</span>
00117 <span class="comment">    instruction prefetches wait till the ISYNC completes.</span>
00118 <span class="comment"></span>
00119 <span class="comment">Arguements:</span>
00120 <span class="comment"></span>
00121 <span class="comment">    SignalDone Supplies a pointer to a variable that is cleared when the</span>
00122 <span class="comment">    requested operation has been performed.</span>
00123 <span class="comment"></span>
00124 <span class="comment">    Parameter1 - Parameter3 - Not used.</span>
00125 <span class="comment"></span>
00126 <span class="comment">Return Value:</span>
00127 <span class="comment"></span>
00128 <span class="comment">    Nothing.</span>
00129 <span class="comment">--*/</span>
00130 {
00131 
00132 <span class="preprocessor">#if !defined(NT_UP)</span>
00133 <span class="preprocessor"></span>
00134     __synci();
00135     <a class="code" href="../../d0/d0/ki_8h.html#a93">KiIpiSignalPacketDone</a>(SignalDone);
00136 
00137 <span class="preprocessor">#endif</span>
00138 <span class="preprocessor"></span>    <span class="keywordflow">return</span>;
00139 
00140 }
00141 
00142 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00143"></a><a class="code" href="../../d1/d5/ia64_2flush_8c.html#a11">00143</a> <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a7">KeSweepIcache</a> (
00144     IN BOOLEAN AllProcessors
00145     )
00146 
00147 <span class="comment">/*++</span>
00148 <span class="comment"></span>
00149 <span class="comment">Routine Description:</span>
00150 <span class="comment"></span>
00151 <span class="comment">    This function flushes the instruction cache on all processors that are</span>
00152 <span class="comment">    currently running threads which are children of the current process or</span>
00153 <span class="comment">    flushes the instruction cache on all processors in the host configuration.</span>
00154 <span class="comment"></span>
00155 <span class="comment">    N.B. Although PowerPC maintains cache coherency across processors, we</span>
00156 <span class="comment">    use the flash invalidate function (h/w) for I-Cache sweeps which doesn't</span>
00157 <span class="comment">    maintain coherency so we still do the MP I-Cache flush in s/w.   plj.</span>
00158 <span class="comment"></span>
00159 <span class="comment">Arguments:</span>
00160 <span class="comment"></span>
00161 <span class="comment">    AllProcessors - Supplies a boolean value that determines which instruction</span>
00162 <span class="comment">        caches are flushed.</span>
00163 <span class="comment"></span>
00164 <span class="comment">Return Value:</span>
00165 <span class="comment"></span>
00166 <span class="comment">    None.</span>
00167 <span class="comment"></span>
00168 <span class="comment">--*/</span>
00169 
00170 {
00171 
00172     KIRQL OldIrql;
00173     KAFFINITY TargetProcessors;
00174 
00175     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00176 
00177 <span class="preprocessor">#if !defined(NT_UP)</span>
00178 <span class="preprocessor"></span>    <span class="comment">// </span>
00179     <span class="comment">// Acquire cache flush spinlock</span>
00180     <span class="comment">// Cache flush is not MP safe yet</span>
00181     <span class="comment">//</span>
00182     <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a>(&amp;<a class="code" href="../../d1/d5/ia64_2flush_8c.html#a2">KiCacheFlushLock</a>, &amp;OldIrql);
00183 
00184 <span class="preprocessor">#endif</span>
00185 <span class="preprocessor"></span>
00186     HalSweepDcache();
00187     HalSweepIcache();
00188 
00189 <span class="preprocessor">#if !defined(NT_UP)</span>
00190 <span class="preprocessor"></span>
00191     <span class="comment">//</span>
00192     <span class="comment">// Compute the set of target processors and send the sweep parameters</span>
00193     <span class="comment">// to the target processors, if any, for execution.</span>
00194     <span class="comment">//</span>
00195 
00196     TargetProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a> &amp; PCR-&gt;NotMember;
00197     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00198         <a class="code" href="../../d0/d0/ki_8h.html#a91">KiIpiSendPacket</a>(TargetProcessors,
00199                         <a class="code" href="../../d9/d4/alpha_2flush_8c.html#a2">KiSweepIcacheTarget</a>,
00200                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00201                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00202                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00203     }
00204 
00205 
00206     <span class="comment">//</span>
00207     <span class="comment">// Wait until all target processors have finished sweeping their</span>
00208     <span class="comment">// instruction caches.</span>
00209     <span class="comment">//</span>
00210 
00211 
00212     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00213         <a class="code" href="../../d2/d1/xipi_8c.html#a2">KiIpiStallOnPacketTargets</a>(TargetProcessors);
00214     }
00215 
00216     <span class="comment">//</span>
00217     <span class="comment">// Lower IRQL to its previous level and return.</span>
00218     <span class="comment">//</span>
00219 
00220     <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a>(&amp;<a class="code" href="../../d1/d5/ia64_2flush_8c.html#a2">KiCacheFlushLock</a>, OldIrql);
00221 
00222 <span class="preprocessor">#endif</span>
00223 <span class="preprocessor"></span>
00224     <span class="keywordflow">return</span>;
00225 }
00226 
00227 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00228"></a><a class="code" href="../../d1/d5/ia64_2flush_8c.html#a4">00228</a> <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a2">KiSweepIcacheTarget</a> (
00229     IN PULONG SignalDone,
00230     IN PVOID Parameter1,
00231     IN PVOID Parameter2,
00232     IN PVOID Parameter3
00233     )
00234 
00235 <span class="comment">/*++</span>
00236 <span class="comment"></span>
00237 <span class="comment">Routine Description:</span>
00238 <span class="comment"></span>
00239 <span class="comment">    This is the target function for sweeping the instruction cache on</span>
00240 <span class="comment">    target processors.</span>
00241 <span class="comment"></span>
00242 <span class="comment">Arguments:</span>
00243 <span class="comment"></span>
00244 <span class="comment">    SignalDone Supplies a pointer to a variable that is cleared when the</span>
00245 <span class="comment">        requested operation has been performed.</span>
00246 <span class="comment"></span>
00247 <span class="comment">    Parameter1 - Parameter3 - Not used.</span>
00248 <span class="comment"></span>
00249 <span class="comment">Return Value:</span>
00250 <span class="comment"></span>
00251 <span class="comment">    None.</span>
00252 <span class="comment"></span>
00253 <span class="comment">--*/</span>
00254 
00255 {
00256 
00257     <span class="comment">//</span>
00258     <span class="comment">// Sweep the instruction cache on the current processor and clear</span>
00259     <span class="comment">// the sweep instruction cache packet address to signal the source</span>
00260     <span class="comment">// to continue.</span>
00261     <span class="comment">//</span>
00262 
00263 <span class="preprocessor">#if !defined(NT_UP)</span>
00264 <span class="preprocessor"></span>
00265     HalSweepDcache();
00266     HalSweepIcache();
00267 
00268     <a class="code" href="../../d0/d0/ki_8h.html#a93">KiIpiSignalPacketDone</a>(SignalDone);
00269 
00270 <span class="preprocessor">#endif</span>
00271 <span class="preprocessor"></span>
00272     <span class="keywordflow">return</span>;
00273 }
00274 
00275 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00276"></a><a class="code" href="../../d1/d5/ia64_2flush_8c.html#a12">00276</a> <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a6">KeSweepDcache</a> (
00277     IN BOOLEAN AllProcessors
00278     )
00279 
00280 <span class="comment">/*++</span>
00281 <span class="comment"></span>
00282 <span class="comment">Routine Description:</span>
00283 <span class="comment"></span>
00284 <span class="comment">    This function flushes the data cache on all processors that are currently</span>
00285 <span class="comment">    running threads which are children of the current process or flushes the</span>
00286 <span class="comment">    data cache on all processors in the host configuration.</span>
00287 <span class="comment"></span>
00288 <span class="comment">    N.B. PowerPC maintains cache coherency across processors however</span>
00289 <span class="comment">    in this routine, the range of addresses being flushed is unknown</span>
00290 <span class="comment">    so we must still broadcast the request to the other processors.</span>
00291 <span class="comment"></span>
00292 <span class="comment">Arguments:</span>
00293 <span class="comment"></span>
00294 <span class="comment">    AllProcessors - Supplies a boolean value that determines which data</span>
00295 <span class="comment">        caches are flushed.</span>
00296 <span class="comment"></span>
00297 <span class="comment">Return Value:</span>
00298 <span class="comment"></span>
00299 <span class="comment">    None.</span>
00300 <span class="comment"></span>
00301 <span class="comment">--*/</span>
00302 
00303 {
00304 
00305     KIRQL OldIrql;
00306     KAFFINITY TargetProcessors;
00307 
00308     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00309 
00310 <span class="preprocessor">#if !defined(NT_UP)</span>
00311 <span class="preprocessor"></span>    <span class="comment">// </span>
00312     <span class="comment">// Acquire cache flush spinlock</span>
00313     <span class="comment">// Cache flush is not MP safe yet</span>
00314     <span class="comment">//</span>
00315     <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a>(&amp;<a class="code" href="../../d1/d5/ia64_2flush_8c.html#a2">KiCacheFlushLock</a>, &amp;OldIrql);
00316 
00317 <span class="preprocessor">#endif</span>
00318 <span class="preprocessor"></span>
00319     HalSweepDcache();
00320 
00321 <span class="preprocessor">#if !defined(NT_UP)</span>
00322 <span class="preprocessor"></span>
00323     <span class="comment">//</span>
00324     <span class="comment">// Compute the set of target processors and send the sweep parameters</span>
00325     <span class="comment">// to the target processors, if any, for execution.</span>
00326     <span class="comment">//</span>
00327 
00328     TargetProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a> &amp; PCR-&gt;NotMember;
00329     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00330         <a class="code" href="../../d0/d0/ki_8h.html#a91">KiIpiSendPacket</a>(TargetProcessors,
00331                         <a class="code" href="../../d9/d4/alpha_2flush_8c.html#a1">KiSweepDcacheTarget</a>,
00332                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00333                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00334                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00335     }
00336 
00337 
00338     <span class="comment">//</span>
00339     <span class="comment">// Wait until all target processors have finished sweeping their</span>
00340     <span class="comment">// data caches.</span>
00341     <span class="comment">//</span>
00342 
00343 
00344     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00345         <a class="code" href="../../d2/d1/xipi_8c.html#a2">KiIpiStallOnPacketTargets</a>(TargetProcessors);
00346     }
00347 
00348     <span class="comment">//</span>
00349     <span class="comment">// Lower IRQL to its previous level and return.</span>
00350     <span class="comment">//</span>
00351 
00352     <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a>(&amp;<a class="code" href="../../d1/d5/ia64_2flush_8c.html#a2">KiCacheFlushLock</a>, OldIrql);
00353 
00354 <span class="preprocessor">#endif</span>
00355 <span class="preprocessor"></span>
00356     <span class="keywordflow">return</span>;
00357 }
00358 
00359 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00360"></a><a class="code" href="../../d1/d5/ia64_2flush_8c.html#a3">00360</a> <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a1">KiSweepDcacheTarget</a> (
00361     IN PULONG SignalDone,
00362     IN PVOID Parameter1,
00363     IN PVOID Parameter2,
00364     IN PVOID Parameter3
00365     )
00366 
00367 <span class="comment">/*++</span>
00368 <span class="comment"></span>
00369 <span class="comment">Routine Description:</span>
00370 <span class="comment"></span>
00371 <span class="comment">    This is the target function for sweeping the data cache on target</span>
00372 <span class="comment">    processors.</span>
00373 <span class="comment"></span>
00374 <span class="comment">Arguments:</span>
00375 <span class="comment"></span>
00376 <span class="comment">    SignalDone Supplies a pointer to a variable that is cleared when the</span>
00377 <span class="comment">        requested operation has been performed.</span>
00378 <span class="comment"></span>
00379 <span class="comment">    Parameter1 - Parameter3 - Not used.</span>
00380 <span class="comment"></span>
00381 <span class="comment">Return Value:</span>
00382 <span class="comment"></span>
00383 <span class="comment">    None.</span>
00384 <span class="comment"></span>
00385 <span class="comment">--*/</span>
00386 
00387 {
00388 
00389     <span class="comment">//</span>
00390     <span class="comment">// Sweep the data cache on the current processor and clear the sweep</span>
00391     <span class="comment">// data cache packet address to signal the source to continue.</span>
00392     <span class="comment">//</span>
00393 
00394 <span class="preprocessor">#if !defined(NT_UP)</span>
00395 <span class="preprocessor"></span>
00396     HalSweepDcache();
00397     <a class="code" href="../../d0/d0/ki_8h.html#a93">KiIpiSignalPacketDone</a>(SignalDone);
00398 
00399 <span class="preprocessor">#endif</span>
00400 <span class="preprocessor"></span>
00401     <span class="keywordflow">return</span>;
00402 }
00403 
00404 
00405 
00406 ULONG_PTR
<a name="l00407"></a><a class="code" href="../../d1/d5/ia64_2flush_8c.html#a7">00407</a> <a class="code" href="../../d1/d5/ia64_2flush_8c.html#a7">KiSyncMC_DrainTarget</a>(
00408     )
00409 
00410 <span class="comment">/*++</span>
00411 <span class="comment"></span>
00412 <span class="comment">Routine Description:</span>
00413 <span class="comment"></span>
00414 <span class="comment">    This is the target function for issuing PAL_MC_DRAIN to drain</span>
00415 <span class="comment">    prefetches, demand references and pending fc cache line evictions on the</span>
00416 <span class="comment">    target CPU it executes.</span>
00417 <span class="comment"></span>
00418 <span class="comment">Argument:</span>
00419 <span class="comment"></span>
00420 <span class="comment">    None</span>
00421 <span class="comment"></span>
00422 <span class="comment"></span>
00423 <span class="comment">Return Value:</span>
00424 <span class="comment"></span>
00425 <span class="comment">   Returns the status from the function HalCallPal</span>
00426 <span class="comment"></span>
00427 <span class="comment">--*/</span>
00428 
00429 {
00430     ULONG_PTR <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00431 
00432     <span class="comment">//</span>
00433     <span class="comment">// Call HalCallPal to drain.</span>
00434     <span class="comment">//</span>
00435 
00436     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = HalCallPal(PAL_MC_DRAIN,
00437         0,
00438         0,
00439         0,
00440         0,
00441         0,
00442         0,
00443         0);
00444 
00445     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == PAL_STATUS_SUCCESS);
00446 
00447     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00448 
00449 }
00450 
00451 
00452 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00453"></a><a class="code" href="../../d1/d5/ia64_2flush_8c.html#a13">00453</a> <a class="code" href="../../d1/d5/ia64_2flush_8c.html#a13">KeSweepCacheRange</a> (
00454     IN BOOLEAN AllProcessors,
00455     IN PVOID BaseAddress,
00456     IN ULONG Length
00457     )
00458 
00459 <span class="comment">/*++</span>
00460 <span class="comment"></span>
00461 <span class="comment">Routine Description:</span>
00462 <span class="comment"></span>
00463 <span class="comment">    This function is used to flush a range of virtual addresses from both the</span>
00464 <span class="comment">    instruction and data cache on all processors in the system.</span>
00465 <span class="comment"></span>
00466 <span class="comment">    Irrespective of the length of the range, it should not call SweepIcache</span>
00467 <span class="comment">    or SweepDcache. This is because SweepDcache will only sweep D cache and</span>
00468 <span class="comment">    not the I cache and Vice versa. Since the caller of KeSweepCacheRange assumes</span>
00469 <span class="comment">    both the caches are being swept, one cannot call SweepIcache or SweepDcache</span>
00470 <span class="comment">    in trying to optimize.</span>
00471 <span class="comment"></span>
00472 <span class="comment"></span>
00473 <span class="comment">    Arguments:</span>
00474 <span class="comment"></span>
00475 <span class="comment">    AllProcessors - Not used</span>
00476 <span class="comment"></span>
00477 <span class="comment">    BaseAddress - Supplies a pointer to the base of the range that is flushed.</span>
00478 <span class="comment"></span>
00479 <span class="comment">    Length - Supplies the length of the range that is flushed if the base</span>
00480 <span class="comment">        address is specified.</span>
00481 <span class="comment"></span>
00482 <span class="comment">    Return Value:</span>
00483 <span class="comment"></span>
00484 <span class="comment">        None.</span>
00485 <span class="comment"></span>
00486 <span class="comment"></span>
00487 <span class="comment">--*/</span>
00488 
00489 {
00490      KIRQL OldIrql;
00491      KAFFINITY TargetProcessors;
00492 
00493     <span class="comment">//</span>
00494     <span class="comment">// We will not raise IRQL to synchronization level so that we can allow</span>
00495     <span class="comment">// a context switch in between Flush Cache. FC need not run in the same processor</span>
00496     <span class="comment">// throughout. It can be context switched. So no binding is done to any processor.</span>
00497     <span class="comment">//</span>
00498     <span class="comment">//</span>
00499 
00500     HalSweepCacheRange(BaseAddress,Length);
00501 
00502     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= KiSynchIrql);
00503 
00504     <span class="comment">//</span>
00505     <span class="comment">// Raise IRQL to synchronization level to prevent a context switch.</span>
00506     <span class="comment">//</span>
00507 
00508 <span class="preprocessor">#if !defined(NT_UP)</span>
00509 <span class="preprocessor"></span>
00510     OldIrql = KeRaiseIrqlToSynchLevel();
00511 
00512     <span class="comment">//</span>
00513     <span class="comment">// Compute the set of target processors and send the sync parameters</span>
00514     <span class="comment">// to the target processors, if any, for execution.</span>
00515     <span class="comment">//</span>
00516 
00517     TargetProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a> &amp; PCR-&gt;NotMember;
00518     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00519     <a class="code" href="../../d0/d0/ki_8h.html#a91">KiIpiSendPacket</a>(TargetProcessors,
00520                     <a class="code" href="../../d1/d5/ia64_2flush_8c.html#a6">KiSyncCacheTarget</a>,
00521                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00522                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00523                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00524     }
00525 
00526 <span class="preprocessor">#endif</span>
00527 <span class="preprocessor"></span>
00528     <span class="comment">//</span>
00529     <span class="comment">// Synchronize the Instruction Prefetch pipe in the local processor.</span>
00530     <span class="comment">//</span>
00531 
00532     __synci();
00533     __isrlz();
00534 
00535     <span class="comment">//</span>
00536     <span class="comment">// Wait until all target processors have finished sweeping the their</span>
00537     <span class="comment">// data cache.</span>
00538     <span class="comment">//</span>
00539 
00540 <span class="preprocessor">#if !defined(NT_UP)</span>
00541 <span class="preprocessor"></span>
00542     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00543         <a class="code" href="../../d2/d1/xipi_8c.html#a2">KiIpiStallOnPacketTargets</a>(TargetProcessors);
00544     }
00545 
00546     <span class="comment">//</span>
00547     <span class="comment">// Lower IRQL to its previous level and return.</span>
00548     <span class="comment">//</span>
00549 
00550     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00551 
00552 <span class="preprocessor">#endif</span>
00553 <span class="preprocessor"></span>
00554     <span class="keywordflow">return</span>;
00555 
00556 }
00557 
00558 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00559"></a><a class="code" href="../../d1/d5/ia64_2flush_8c.html#a14">00559</a> <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a8">KeSweepIcacheRange</a> (
00560     IN BOOLEAN AllProcessors,
00561     IN PVOID BaseAddress,
00562     IN ULONG Length
00563     )
00564 
00565 <span class="comment">/*++</span>
00566 <span class="comment"></span>
00567 <span class="comment">Routine Description:</span>
00568 <span class="comment"></span>
00569 <span class="comment">    This function is used to flush a range of virtual addresses from the</span>
00570 <span class="comment">    primary instruction cache on all processors in the host configuration.</span>
00571 <span class="comment"></span>
00572 <span class="comment">     If the length of the range is greater than the size of the</span>
00573 <span class="comment">    instruction cache, then one can call HalSweepIcache which calls</span>
00574 <span class="comment">    SAL to flush the entire cache. Since SAL does not take care of MP</span>
00575 <span class="comment">    flushing, HalSweepIcache has to use IPI mechanism to execute SAL</span>
00576 <span class="comment">    flush from each processor. We need to weight the overhead of all these</span>
00577 <span class="comment">    versus using HalSweepIcacheRange and avoiding IPI mechanism since</span>
00578 <span class="comment">    HalSweepIcacheRange uses fc instruction and fc instruction takes care of MP.</span>
00579 <span class="comment"></span>
00580 <span class="comment">Arguments:</span>
00581 <span class="comment"></span>
00582 <span class="comment">    AllProcessors -  Not used</span>
00583 <span class="comment"></span>
00584 <span class="comment">    BaseAddress - Supplies a pointer to the base of the range that is flushed.</span>
00585 <span class="comment"></span>
00586 <span class="comment">    Length - Supplies the length of the range that is flushed if the base</span>
00587 <span class="comment">        address is specified.</span>
00588 <span class="comment"></span>
00589 <span class="comment">Return Value:</span>
00590 <span class="comment"></span>
00591 <span class="comment">    None.</span>
00592 <span class="comment"></span>
00593 <span class="comment">    Note:  For performance reason, we may update KeSweepIcacheRange to do the following:</span>
00594 <span class="comment">           if the range asked to sweep is very large, we may call KeSweepIcache to flush</span>
00595 <span class="comment">           the full cache.</span>
00596 <span class="comment"></span>
00597 <span class="comment"></span>
00598 <span class="comment"></span>
00599 <span class="comment">--*/</span>
00600 
00601 {
00602     KIRQL OldIrql;
00603     KAFFINITY TargetProcessors;
00604 
00605     <span class="comment">//</span>
00606     <span class="comment">// We will not raise IRQL to synchronization level so that we can allow</span>
00607     <span class="comment">// a context switch in between Flush Cache. FC need not run in the same processor</span>
00608     <span class="comment">// throughout. It can be context switched. So no binding is done to any processor.</span>
00609     <span class="comment">//</span>
00610     <span class="comment">//</span>
00611 
00612     HalSweepIcacheRange(BaseAddress,Length);
00613 
00614     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= KiSynchIrql);
00615 
00616     <span class="comment">//</span>
00617     <span class="comment">// Raise IRQL to synchronization level to prevent a context switch.</span>
00618     <span class="comment">//</span>
00619 
00620 <span class="preprocessor">#if !defined(NT_UP)</span>
00621 <span class="preprocessor"></span>
00622     OldIrql = KeRaiseIrqlToSynchLevel();
00623 
00624     <span class="comment">//</span>
00625     <span class="comment">// Compute the set of target processors and send the sync parameters</span>
00626     <span class="comment">// to the target processors, if any, for execution.</span>
00627     <span class="comment">//</span>
00628 
00629     TargetProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a> &amp; PCR-&gt;NotMember;
00630     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00631         <a class="code" href="../../d0/d0/ki_8h.html#a91">KiIpiSendPacket</a>(TargetProcessors,
00632             <a class="code" href="../../d1/d5/ia64_2flush_8c.html#a6">KiSyncCacheTarget</a>,
00633             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00634             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00635             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00636     }
00637 
00638 <span class="preprocessor">#endif</span>
00639 <span class="preprocessor"></span>
00640     <span class="comment">//</span>
00641     <span class="comment">// Synchronize the Instruction Prefetch pipe in the local processor.</span>
00642     <span class="comment">//</span>
00643 
00644     __synci();
00645     __isrlz();
00646 
00647     <span class="comment">//</span>
00648     <span class="comment">// Wait until all target processors have finished sweeping the their</span>
00649     <span class="comment">// data cache.</span>
00650     <span class="comment">//</span>
00651 
00652 <span class="preprocessor">#if !defined(NT_UP)</span>
00653 <span class="preprocessor"></span>
00654     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00655         <a class="code" href="../../d2/d1/xipi_8c.html#a2">KiIpiStallOnPacketTargets</a>(TargetProcessors);
00656     }
00657 
00658     <span class="comment">//</span>
00659     <span class="comment">// Lower IRQL to its previous level and return.</span>
00660     <span class="comment">//</span>
00661 
00662     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00663 
00664 <span class="preprocessor">#endif</span>
00665 <span class="preprocessor"></span>
00666     <span class="keywordflow">return</span>;
00667 
00668 
00669 }
00670 
00671 
00672 
00673 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00674"></a><a class="code" href="../../d1/d5/ia64_2flush_8c.html#a15">00674</a> <a class="code" href="../../d1/d5/ia64_2flush_8c.html#a15">KeSweepDcacheRange</a> (
00675     IN BOOLEAN AllProcessors,
00676     IN PVOID BaseAddress,
00677     IN ULONG Length
00678     )
00679 
00680 <span class="comment">/*++</span>
00681 <span class="comment"></span>
00682 <span class="comment">Routine Description:</span>
00683 <span class="comment"></span>
00684 <span class="comment">    This function is used to flush a range of virtual addresses from the</span>
00685 <span class="comment">    primary data cache on all processors in the host configuration.</span>
00686 <span class="comment"></span>
00687 <span class="comment">     If the length of the range is greater than the size of the</span>
00688 <span class="comment">    data cache, then one can call HalSweepDcache which calls</span>
00689 <span class="comment">    SAL to flush the entire cache. Since SAL does not take care of MP</span>
00690 <span class="comment">    flushing, HalSweepDcache has to use IPI mechanism to execute SAL</span>
00691 <span class="comment">    flush from each processor. We need to weight the overhead of all these</span>
00692 <span class="comment">    versus using HalSweepDcacheRange and avoiding IPI mechanism since</span>
00693 <span class="comment">    HalSweepDcacheRange uses fc instruction and fc instruction takes care of MP.</span>
00694 <span class="comment"></span>
00695 <span class="comment">Arguments:</span>
00696 <span class="comment"></span>
00697 <span class="comment">    AllProcessors -  Not used</span>
00698 <span class="comment"></span>
00699 <span class="comment">    BaseAddress - Supplies a pointer to the base of the range that is flushed.</span>
00700 <span class="comment"></span>
00701 <span class="comment">    Length - Supplies the length of the range that is flushed if the base</span>
00702 <span class="comment">        address is specified.</span>
00703 <span class="comment"></span>
00704 <span class="comment">Return Value:</span>
00705 <span class="comment"></span>
00706 <span class="comment">    None.</span>
00707 <span class="comment"></span>
00708 <span class="comment">    Note:  For performance reason, we may update KeSweepDcacheRange to do the following:</span>
00709 <span class="comment">           if the range asked to sweep is very large, we may call KeSweepDcache to flush</span>
00710 <span class="comment">           the full cache.</span>
00711 <span class="comment"></span>
00712 <span class="comment"></span>
00713 <span class="comment"></span>
00714 <span class="comment">--*/</span>
00715 
00716 {
00717     KIRQL OldIrql;
00718     KAFFINITY TargetProcessors;
00719 
00720     <span class="comment">//</span>
00721     <span class="comment">// We will not raise IRQL to synchronization level so that we can allow</span>
00722     <span class="comment">// a context switch in between Flush Cache. FC need not run in the same processor</span>
00723     <span class="comment">// throughout. It can be context switched. So no binding is done to any processor.</span>
00724     <span class="comment">//</span>
00725     <span class="comment">//</span>
00726 
00727     HalSweepDcacheRange(BaseAddress,Length);
00728 
00729     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= KiSynchIrql);
00730 
00731     <span class="comment">//</span>
00732     <span class="comment">// Raise IRQL to synchronization level to prevent a context switch.</span>
00733     <span class="comment">//</span>
00734 
00735 <span class="preprocessor">#if !defined(NT_UP)</span>
00736 <span class="preprocessor"></span>
00737     OldIrql = KeRaiseIrqlToSynchLevel();
00738 
00739     <span class="comment">//</span>
00740     <span class="comment">// Compute the set of target processors and send the sync parameters</span>
00741     <span class="comment">// to the target processors, if any, for execution.</span>
00742     <span class="comment">//</span>
00743 
00744     TargetProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a> &amp; PCR-&gt;NotMember;
00745     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00746         <a class="code" href="../../d0/d0/ki_8h.html#a91">KiIpiSendPacket</a>(TargetProcessors,
00747             <a class="code" href="../../d1/d5/ia64_2flush_8c.html#a6">KiSyncCacheTarget</a>,
00748             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00749             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00750             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00751     }
00752 
00753 <span class="preprocessor">#endif</span>
00754 <span class="preprocessor"></span>
00755     <span class="comment">//</span>
00756     <span class="comment">// Synchronize the Instruction Prefetch pipe in the local processor.</span>
00757     <span class="comment">//</span>
00758 
00759     __synci();
00760     __isrlz();
00761 
00762     <span class="comment">//</span>
00763     <span class="comment">// Wait until all target processors have finished sweeping the their</span>
00764     <span class="comment">// data cache.</span>
00765     <span class="comment">//</span>
00766 
00767 <span class="preprocessor">#if !defined(NT_UP)</span>
00768 <span class="preprocessor"></span>
00769     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00770         <a class="code" href="../../d2/d1/xipi_8c.html#a2">KiIpiStallOnPacketTargets</a>(TargetProcessors);
00771     }
00772 
00773     <span class="comment">//</span>
00774     <span class="comment">// Lower IRQL to its previous level and return.</span>
00775     <span class="comment">//</span>
00776 
00777     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00778 
00779 <span class="preprocessor">#endif</span>
00780 <span class="preprocessor"></span>
00781     <span class="keywordflow">return</span>;
00782 
00783 
00784 }
00785 
00786 ULONG_PTR
<a name="l00787"></a><a class="code" href="../../d1/d5/ia64_2flush_8c.html#a8">00787</a> <a class="code" href="../../d1/d5/ia64_2flush_8c.html#a8">KiSyncMC_Drain</a> (
00788     IN BOOLEAN AllProcessors,
00789     IN PVOID BaseAddress,
00790     IN ULONG Length
00791     )
00792 
00793 <span class="comment">/*++</span>
00794 <span class="comment"></span>
00795 <span class="comment">Routine Description:</span>
00796 <span class="comment"></span>
00797 <span class="comment">    KiSyncMC_Drain issues  PAL_MC_DRAIN to drain either prefetches, demand references</span>
00798 <span class="comment">    or pending fc cache line evictions to all the processors in the system.</span>
00799 <span class="comment">    DrainTypePointer points to the variable, DrainType, which determines the type of</span>
00800 <span class="comment">    drain to be performed. This is typically used when changing the memory attribute</span>
00801 <span class="comment">    from WB to UC.</span>
00802 <span class="comment"></span>
00803 <span class="comment">Arguments:</span>
00804 <span class="comment"></span>
00805 <span class="comment">    AllProcessors - All processors in the system.</span>
00806 <span class="comment"></span>
00807 <span class="comment">    BaseAddress - Supplies a pointer to the base of the range that is to be drained.</span>
00808 <span class="comment"></span>
00809 <span class="comment">    Length - Supplies the length of the range that is drained for the base</span>
00810 <span class="comment">        address specified.</span>
00811 <span class="comment"></span>
00812 <span class="comment">Return Value:</span>
00813 <span class="comment"></span>
00814 <span class="comment">    Note:  This is used when changing attributes of WB pages to UC pages.</span>
00815 <span class="comment"></span>
00816 <span class="comment"></span>
00817 <span class="comment">--*/</span>
00818 
00819 {
00820     ULONG_PTR <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00821     <span class="comment">//</span>
00822     <span class="comment">// KiIpiGenericCall returns ULONG_PTR as the function value of the specified function</span>
00823     <span class="comment">//</span>
00824 
00825     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d2/d1/xipi_8c.html#a1">KiIpiGenericCall</a> (
00826                 (<a class="code" href="../../d0/d0/ki_8h.html#a33">PKIPI_BROADCAST_WORKER</a>)<a class="code" href="../../d1/d5/ia64_2flush_8c.html#a7">KiSyncMC_DrainTarget</a>,
00827                 (ULONG_PTR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00828                 );
00829 
00830     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == PAL_STATUS_SUCCESS);
00831 
00832     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00833 
00834 
00835 }
00836 
00837 ULONG_PTR
<a name="l00838"></a><a class="code" href="../../d1/d5/ia64_2flush_8c.html#a9">00838</a> <a class="code" href="../../d1/d5/ia64_2flush_8c.html#a9">KiSyncPrefetchVisibleTarget</a>(
00839     )
00840 
00841 <span class="comment">/*++</span>
00842 <span class="comment"></span>
00843 <span class="comment">Routine Description:</span>
00844 <span class="comment"></span>
00845 <span class="comment">    This is the target function for issuing PAL_PREFETCH VISIBILITY </span>
00846 <span class="comment">    on the target CPU it executes.</span>
00847 <span class="comment"></span>
00848 <span class="comment">Argument:</span>
00849 <span class="comment"></span>
00850 <span class="comment">    Not used.</span>
00851 <span class="comment"></span>
00852 <span class="comment"></span>
00853 <span class="comment">Return Value:</span>
00854 <span class="comment"></span>
00855 <span class="comment">   Returns the status from the function HalCallPal</span>
00856 <span class="comment"></span>
00857 <span class="comment">--*/</span>
00858 
00859 {
00860     ULONG_PTR <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00861 
00862     <span class="comment">//</span>
00863     <span class="comment">// Call HalCallPal to drain.</span>
00864     <span class="comment">//</span>
00865 
00866     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = HalCallPal(PAL_PREFETCH_VISIBILITY,
00867         0,
00868         0,
00869         0,
00870         0,
00871         0,
00872         0,
00873         0);
00874 
00875 
00876     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != PAL_STATUS_ERROR);
00877 
00878     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00879 
00880 }
00881 
00882 
00883 
00884 ULONG_PTR
<a name="l00885"></a><a class="code" href="../../d1/d5/ia64_2flush_8c.html#a10">00885</a> <a class="code" href="../../d1/d5/ia64_2flush_8c.html#a10">KiSyncPrefetchVisible</a> (
00886     IN BOOLEAN AllProcessors,
00887     IN PVOID BaseAddress,
00888     IN ULONG Length
00889     )
00890 
00891 <span class="comment">/*++</span>
00892 <span class="comment"></span>
00893 <span class="comment">Routine Description:</span>
00894 <span class="comment"></span>
00895 <span class="comment">    KiSyncPrefetchVisible issues  PAL_PREFETCH_VISIBILITY to cause the processor to make</span>
00896 <span class="comment">    all pending prefetches visible to subsequent fc instructions; or does nothing, on </span>
00897 <span class="comment">    processor implementations which does not require PAL support for disabling prefetch </span>
00898 <span class="comment">    in the architectural sequence. On processors that require PAL support for this</span>
00899 <span class="comment">    sequence, the actions performed by this procedure may include any or all</span>
00900 <span class="comment">    of the following (or none, as long as the processor guarantees that </span>
00901 <span class="comment">    prefetches that were issued prior to this call are not resident in the </span>
00902 <span class="comment">    processor's caches after the architected sequence is complete.</span>
00903 <span class="comment">    This is typically used when changing the memory attribute from WB to UC.</span>
00904 <span class="comment"></span>
00905 <span class="comment">Arguments:</span>
00906 <span class="comment"></span>
00907 <span class="comment">    AllProcessors - All processors in the system.</span>
00908 <span class="comment"></span>
00909 <span class="comment">    BaseAddress - Supplies a pointer to the base of the range that is to be drained.</span>
00910 <span class="comment"></span>
00911 <span class="comment">    Length - Supplies the length of the range that is drained for the base</span>
00912 <span class="comment">        address specified.</span>
00913 <span class="comment"></span>
00914 <span class="comment">Return Value:</span>
00915 <span class="comment"></span>
00916 <span class="comment">    Status of the PAL CALL</span>
00917 <span class="comment">      0  Success</span>
00918 <span class="comment">      1  Call not needed</span>
00919 <span class="comment">      -3 Error returned</span>
00920 <span class="comment">    </span>
00921 <span class="comment">    Note:  This is used when changing attributes of WB pages to UC pages.</span>
00922 <span class="comment"></span>
00923 <span class="comment"></span>
00924 <span class="comment">--*/</span>
00925 
00926 {
00927     ULONG_PTR <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00928     
00929     <span class="keywordflow">switch</span> (<a class="code" href="../../d1/d5/ia64_2flush_8c.html#a0">ProbePalVisibilitySupport</a>) {
00930         <span class="keywordflow">case</span> 0: 
00931             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d5/ia64_2flush_8c.html#a1">NeedPalVisibilitySupport</a> == 0)
00932                <span class="keywordflow">return</span> PAL_STATUS_SUPPORT_NOT_NEEDED;
00933             <span class="keywordflow">else</span> {
00934                <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d2/d1/xipi_8c.html#a1">KiIpiGenericCall</a> (
00935                             (<a class="code" href="../../d0/d0/ki_8h.html#a33">PKIPI_BROADCAST_WORKER</a>)<a class="code" href="../../d1/d5/ia64_2flush_8c.html#a9">KiSyncPrefetchVisibleTarget</a>,
00936                             (ULONG_PTR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00937                             );
00938             
00939                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != PAL_STATUS_ERROR);
00940                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00941                 
00942             }
00943             <span class="keywordflow">break</span>;
00944 
00945         <span class="keywordflow">case</span> 1:
00946             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d5/ia64_2flush_8c.html#a9">KiSyncPrefetchVisibleTarget</a>();
00947    
00948             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != PAL_STATUS_ERROR);
00949    
00950             <a class="code" href="../../d1/d5/ia64_2flush_8c.html#a0">ProbePalVisibilitySupport</a> = 0;
00951 
00952             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == PAL_STATUS_SUPPORT_NOT_NEEDED) {
00953                 <a class="code" href="../../d1/d5/ia64_2flush_8c.html#a1">NeedPalVisibilitySupport</a> = 0;
00954                 <span class="keywordflow">return</span> PAL_STATUS_SUPPORT_NOT_NEEDED;
00955             } <span class="keywordflow">else</span> {
00956 
00957                                                 
00958                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d2/d1/xipi_8c.html#a1">KiIpiGenericCall</a> (
00959                             (<a class="code" href="../../d0/d0/ki_8h.html#a33">PKIPI_BROADCAST_WORKER</a>)<a class="code" href="../../d1/d5/ia64_2flush_8c.html#a9">KiSyncPrefetchVisibleTarget</a>,
00960                             (ULONG_PTR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00961                             );
00962             
00963                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != PAL_STATUS_ERROR);
00964             
00965                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00966                 
00967             }
00968 
00969             <span class="keywordflow">break</span>;
00970         
00971     }
00972     
00973 
00974 }
00975 
00976 
00977 
00978 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00979"></a><a class="code" href="../../d1/d5/ia64_2flush_8c.html#a16">00979</a> <a class="code" href="../../d1/d5/ia64_2flush_8c.html#a16">KeSweepCacheRangeWithDrain</a> (
00980     IN BOOLEAN AllProcessors,
00981     IN PVOID BaseAddress,
00982     IN ULONG Length
00983     )
00984 
00985 <span class="comment">/*++</span>
00986 <span class="comment"></span>
00987 <span class="comment">Routine Description:</span>
00988 <span class="comment"></span>
00989 <span class="comment">    This function is used to drain prefetches,demand references followed by flushing</span>
00990 <span class="comment">    the cache followed by draining pending fc cache line evictions to a specified range</span>
00991 <span class="comment">    address in all processors in the system.</span>
00992 <span class="comment"></span>
00993 <span class="comment"></span>
00994 <span class="comment">Arguments:</span>
00995 <span class="comment"></span>
00996 <span class="comment">    AllProcessors -  All processors in the system.</span>
00997 <span class="comment"></span>
00998 <span class="comment">    BaseAddress - Supplies a pointer to the base of the range that is flushed and drained.</span>
00999 <span class="comment"></span>
01000 <span class="comment">    Length - Supplies the length of the range that is flushed and drained for the base</span>
01001 <span class="comment">        address is specified.</span>
01002 <span class="comment"></span>
01003 <span class="comment">Return Value:</span>
01004 <span class="comment"></span>
01005 <span class="comment">    None.</span>
01006 <span class="comment"></span>
01007 <span class="comment">    Note:  This is used when changing attributes of WB pages to UC pages.</span>
01008 <span class="comment"></span>
01009 <span class="comment">--*/</span>
01010 
01011 {
01012     ULONG_PTR <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01013 
01014     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d5/ia64_2flush_8c.html#a10">KiSyncPrefetchVisible</a>(
01015                  AllProcessors,
01016                  BaseAddress,
01017                  Length
01018                  );
01019 
01020     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != PAL_STATUS_ERROR);
01021     
01022 
01023     <a class="code" href="../../d1/d5/ia64_2flush_8c.html#a13">KeSweepCacheRange</a> (
01024         AllProcessors,
01025         BaseAddress,
01026         Length
01027         );
01028 
01029     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d5/ia64_2flush_8c.html#a8">KiSyncMC_Drain</a> (
01030                  AllProcessors,
01031                  BaseAddress,
01032                  Length
01033                  );
01034 
01035     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == PAL_STATUS_SUCCESS);
01036 
01037     <span class="keywordflow">return</span>;
01038 
01039 
01040 }
01041 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:02 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
