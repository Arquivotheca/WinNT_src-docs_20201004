<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: menu.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>menu.c</h1><a href="../../d1/d7/ntcon_2server_2menu_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    menu.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">        This file implements the system menu management.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Therese Stowell (thereses) Jan-24-1992 (swiped from Win3.1)</span>
00016 <span class="comment"></span>
00017 <span class="comment">--*/</span>
00018 
00019 <span class="preprocessor">#include "<a class="code" href="../../d6/d3/w32_2ntcon_2server_2precomp_8h.html">precomp.h</a>"</span>
00020 <span class="preprocessor">#pragma hdrstop</span>
00021 <span class="preprocessor"></span>
00022 
00023 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00024"></a><a class="code" href="../../d1/d7/ntcon_2server_2menu_8c.html#a0">00024</a> <a class="code" href="../../d1/d7/ntcon_2server_2menu_8c.html#a0">MyModifyMenuItem</a>(
00025     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00026     IN UINT ItemId
00027     )
00028 <span class="comment">/*++</span>
00029 <span class="comment"></span>
00030 <span class="comment">   This routine edits the indicated control to one word. This is used to</span>
00031 <span class="comment">        trim the Accelerator key text off of the end of the standard menu</span>
00032 <span class="comment">        items because we don't support the accelerators.</span>
00033 <span class="comment"></span>
00034 <span class="comment">--*/</span>
00035 
00036 {
00037     WCHAR ItemString[30];
00038     <span class="keywordtype">int</span> ItemLength;
00039     MENUITEMINFO mii;
00040 
00041     ItemLength = LoadString(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a4">ghInstance</a>,ItemId,ItemString,<a class="code" href="../../d2/d3/tnlsxlat_8c.html#a0">NELEM</a>(ItemString));
00042     <span class="keywordflow">if</span> (ItemLength == 0) {
00043         <span class="comment">//DbgPrint("LoadString in MyModifyMenu failed %d\n",GetLastError());</span>
00044         <span class="keywordflow">return</span>;
00045     }
00046 
00047     mii.cbSize = <span class="keyword">sizeof</span>(mii);
00048     mii.fMask = MIIM_STRING;
00049     mii.dwTypeData = ItemString;
00050 
00051     <span class="keywordflow">if</span> (ItemId == SC_CLOSE) {
00052         mii.fMask |= MIIM_BITMAP;
00053         mii.hbmpItem = HBMMENU_POPUP_CLOSE;
00054     }
00055 
00056     <a class="code" href="../../d5/d9/cltxt_8h.html#a30">SetMenuItemInfo</a>(Console-&gt;hMenu, ItemId, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;mii);
00057 
00058 }
00059 
00060 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00061"></a><a class="code" href="../../d1/d7/ntcon_2server_2menu_8c.html#a1">00061</a> <a class="code" href="../../d1/d7/ntcon_2server_2menu_8c.html#a1">InitSystemMenu</a>(
00062     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
00063     )
00064 {
00065     WCHAR ItemString[30];
00066     <span class="keywordtype">int</span> ItemLength;
00067 
00068     <span class="comment">//</span>
00069     <span class="comment">// load the clipboard menu.</span>
00070     <span class="comment">//</span>
00071 
00072     Console-&gt;hHeirMenu = LoadMenu(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a4">ghInstance</a>, MAKEINTRESOURCE(<a class="code" href="../../d6/d7/menu_8h.html#a17">ID_WOMENU</a>));
00073     <span class="keywordflow">if</span> (Console-&gt;hHeirMenu) {
00074         ItemLength = LoadString(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a4">ghInstance</a>,<a class="code" href="../../d6/d7/menu_8h.html#a14">cmEdit</a>,ItemString,<a class="code" href="../../d2/d3/tnlsxlat_8c.html#a0">NELEM</a>(ItemString));
00075         <span class="keywordflow">if</span> (ItemLength == 0)
00076             KdPrint((<span class="stringliteral">"LoadString 1 failed %d\n"</span>,GetLastError()));
00077     }
00078     <span class="keywordflow">else</span>
00079         KdPrint((<span class="stringliteral">"LoadMenu 1 failed %d\n"</span>,GetLastError()));
00080 
00081     <span class="comment">//</span>
00082     <span class="comment">// edit the accelerators off of the standard items.</span>
00083     <span class="comment">//</span>
00084 
00085     <a class="code" href="../../d1/d7/ntcon_2server_2menu_8c.html#a0">MyModifyMenuItem</a>(Console,SC_CLOSE);
00086 
00087     <span class="comment">//</span>
00088     <span class="comment">// Append the clipboard menu to system menu</span>
00089     <span class="comment">//</span>
00090 
00091     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d9/cltxt_8h.html#a33">AppendMenu</a>(Console-&gt;hMenu,
00092                MF_POPUP | MF_STRING,
00093                (ULONG_PTR)Console-&gt;hHeirMenu,
00094                <span class="comment">//"Edit"</span>
00095                ItemString
00096               )) {
00097         KdPrint((<span class="stringliteral">"AppendMenu 1 failed %d\n"</span>,GetLastError()));
00098     }
00099 
00100     <span class="comment">//</span>
00101     <span class="comment">// Add other items to system menu</span>
00102     <span class="comment">//</span>
00103 
00104     ItemLength = LoadString(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a4">ghInstance</a>,<a class="code" href="../../d6/d7/menu_8h.html#a16">cmDefaults</a>,ItemString,<a class="code" href="../../d2/d3/tnlsxlat_8c.html#a0">NELEM</a>(ItemString));
00105     <span class="keywordflow">if</span> (ItemLength == 0)
00106         KdPrint((<span class="stringliteral">"LoadString %d failed %d\n"</span>,<a class="code" href="../../d6/d7/menu_8h.html#a16">cmDefaults</a>,GetLastError()));
00107     <span class="keywordflow">if</span> (ItemLength) {
00108         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d9/cltxt_8h.html#a33">AppendMenu</a>(Console-&gt;hMenu, MF_STRING, <a class="code" href="../../d6/d7/menu_8h.html#a16">cmDefaults</a>, ItemString)) {
00109             KdPrint((<span class="stringliteral">"AppendMenu %d failed %d\n"</span>,<a class="code" href="../../d6/d7/menu_8h.html#a16">cmDefaults</a>,GetLastError()));
00110         }
00111     }
00112     ItemLength = LoadString(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a4">ghInstance</a>,<a class="code" href="../../d6/d7/menu_8h.html#a15">cmControl</a>,ItemString,<a class="code" href="../../d2/d3/tnlsxlat_8c.html#a0">NELEM</a>(ItemString));
00113     <span class="keywordflow">if</span> (ItemLength == 0)
00114         KdPrint((<span class="stringliteral">"LoadString %d failed %d\n"</span>,<a class="code" href="../../d6/d7/menu_8h.html#a15">cmControl</a>,GetLastError()));
00115     <span class="keywordflow">if</span> (ItemLength) {
00116         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d9/cltxt_8h.html#a33">AppendMenu</a>(Console-&gt;hMenu, MF_STRING, <a class="code" href="../../d6/d7/menu_8h.html#a15">cmControl</a>, ItemString)) {
00117             KdPrint((<span class="stringliteral">"AppendMenu %d failed %d\n"</span>,<a class="code" href="../../d6/d7/menu_8h.html#a15">cmControl</a>,GetLastError()));
00118         }
00119     }
00120 }
00121 
00122 
00123 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00124"></a><a class="code" href="../../d1/d7/ntcon_2server_2menu_8c.html#a2">00124</a> <a class="code" href="../../d1/d7/ntcon_2server_2menu_8c.html#a2">InitializeMenu</a>(
00125     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
00126     )
00127 <span class="comment">/*++</span>
00128 <span class="comment"></span>
00129 <span class="comment">    this initializes the system menu when a WM_INITMENU message</span>
00130 <span class="comment">    is read.</span>
00131 <span class="comment"></span>
00132 <span class="comment">--*/</span>
00133 
00134 {
00135     HMENU hMenu = Console-&gt;hMenu;
00136     HMENU hHeirMenu = Console-&gt;hHeirMenu;
00137 
00138     <span class="comment">//</span>
00139     <span class="comment">// if we're in graphics mode, disable size menu</span>
00140     <span class="comment">//</span>
00141 
00142     <span class="keywordflow">if</span> (!(Console-&gt;CurrentScreenBuffer-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>)) {
00143         <a class="code" href="../../d3/d9/client_2wow_8c.html#a28">EnableMenuItem</a>(hMenu,SC_SIZE,MF_GRAYED);
00144     }
00145 
00146     <span class="comment">//</span>
00147     <span class="comment">// if the console is iconic, disable Mark and Scroll.</span>
00148     <span class="comment">//</span>
00149 
00150     <span class="keywordflow">if</span> (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a0">CONSOLE_IS_ICONIC</a>) {
00151         <a class="code" href="../../d3/d9/client_2wow_8c.html#a28">EnableMenuItem</a>(hHeirMenu,<a class="code" href="../../d6/d7/menu_8h.html#a10">cmMark</a>,MF_GRAYED);
00152         <a class="code" href="../../d3/d9/client_2wow_8c.html#a28">EnableMenuItem</a>(hHeirMenu,<a class="code" href="../../d6/d7/menu_8h.html#a11">cmScroll</a>,MF_GRAYED);
00153     } <span class="keywordflow">else</span> {
00154 
00155         <span class="comment">//</span>
00156         <span class="comment">// if the console is not iconic</span>
00157         <span class="comment">//   if there are no scroll bars</span>
00158         <span class="comment">//       or we're in mark mode</span>
00159         <span class="comment">//       disable scroll</span>
00160         <span class="comment">//   else</span>
00161         <span class="comment">//       enable scroll</span>
00162         <span class="comment">//</span>
00163         <span class="comment">//   if we're in scroll mode</span>
00164         <span class="comment">//       disable mark</span>
00165         <span class="comment">//   else</span>
00166         <span class="comment">//       enable mark</span>
00167 
00168         <span class="keywordflow">if</span> ((Console-&gt;CurrentScreenBuffer-&gt;WindowMaximizedX &amp;&amp;
00169              Console-&gt;CurrentScreenBuffer-&gt;WindowMaximizedY) ||
00170              Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a4">CONSOLE_SELECTING</a>) {
00171             <a class="code" href="../../d3/d9/client_2wow_8c.html#a28">EnableMenuItem</a>(hHeirMenu,<a class="code" href="../../d6/d7/menu_8h.html#a11">cmScroll</a>,MF_GRAYED);
00172         } <span class="keywordflow">else</span> {
00173             <a class="code" href="../../d3/d9/client_2wow_8c.html#a28">EnableMenuItem</a>(hHeirMenu,<a class="code" href="../../d6/d7/menu_8h.html#a11">cmScroll</a>,MF_ENABLED);
00174         }
00175         <span class="keywordflow">if</span> (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a5">CONSOLE_SCROLLING</a>) {
00176             <a class="code" href="../../d3/d9/client_2wow_8c.html#a28">EnableMenuItem</a>(hHeirMenu,<a class="code" href="../../d6/d7/menu_8h.html#a10">cmMark</a>,MF_GRAYED);
00177         } <span class="keywordflow">else</span> {
00178             <a class="code" href="../../d3/d9/client_2wow_8c.html#a28">EnableMenuItem</a>(hHeirMenu,<a class="code" href="../../d6/d7/menu_8h.html#a10">cmMark</a>,MF_ENABLED);
00179         }
00180     }
00181 
00182     <span class="comment">//</span>
00183     <span class="comment">// if we're selecting or scrolling, disable Paste.</span>
00184     <span class="comment">// otherwise enable it.</span>
00185     <span class="comment">//</span>
00186 
00187     <span class="keywordflow">if</span> (Console-&gt;Flags &amp; (<a class="code" href="../../d1/d7/server_8h.html#a4">CONSOLE_SELECTING</a> | <a class="code" href="../../d1/d7/server_8h.html#a5">CONSOLE_SCROLLING</a>)) {
00188         <a class="code" href="../../d3/d9/client_2wow_8c.html#a28">EnableMenuItem</a>(hHeirMenu,<a class="code" href="../../d6/d7/menu_8h.html#a9">cmPaste</a>,MF_GRAYED);
00189     } <span class="keywordflow">else</span> {
00190         <a class="code" href="../../d3/d9/client_2wow_8c.html#a28">EnableMenuItem</a>(hHeirMenu,<a class="code" href="../../d6/d7/menu_8h.html#a9">cmPaste</a>,MF_ENABLED);
00191     }
00192 
00193     <span class="comment">//</span>
00194     <span class="comment">// if app has active selection, enable copy; else disabled</span>
00195     <span class="comment">//</span>
00196 
00197     <span class="keywordflow">if</span> (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a4">CONSOLE_SELECTING</a> &amp;&amp;
00198         Console-&gt;SelectionFlags &amp; <a class="code" href="../../d1/d7/server_8h.html#a27">CONSOLE_SELECTION_NOT_EMPTY</a>) {
00199         <a class="code" href="../../d3/d9/client_2wow_8c.html#a28">EnableMenuItem</a>(hHeirMenu,<a class="code" href="../../d6/d7/menu_8h.html#a8">cmCopy</a>,MF_ENABLED);
00200     } <span class="keywordflow">else</span> {
00201         <a class="code" href="../../d3/d9/client_2wow_8c.html#a28">EnableMenuItem</a>(hHeirMenu,<a class="code" href="../../d6/d7/menu_8h.html#a8">cmCopy</a>,MF_GRAYED);
00202     }
00203 
00204     <span class="comment">//</span>
00205     <span class="comment">// disable close</span>
00206     <span class="comment">//</span>
00207 
00208     <span class="keywordflow">if</span> (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a6">CONSOLE_DISABLE_CLOSE</a>)
00209         <a class="code" href="../../d3/d9/client_2wow_8c.html#a28">EnableMenuItem</a>(hMenu,SC_CLOSE,MF_GRAYED);
00210     <span class="keywordflow">else</span>
00211         <a class="code" href="../../d3/d9/client_2wow_8c.html#a28">EnableMenuItem</a>(hMenu,SC_CLOSE,MF_ENABLED);
00212 
00213     <span class="comment">//</span>
00214     <span class="comment">// enable Move if not iconic</span>
00215     <span class="comment">//</span>
00216 
00217     <span class="keywordflow">if</span> (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a0">CONSOLE_IS_ICONIC</a>) {
00218         <a class="code" href="../../d3/d9/client_2wow_8c.html#a28">EnableMenuItem</a>(hMenu,SC_MOVE,MF_GRAYED);
00219     } <span class="keywordflow">else</span> {
00220         <a class="code" href="../../d3/d9/client_2wow_8c.html#a28">EnableMenuItem</a>(hMenu,SC_MOVE,MF_ENABLED);
00221     }
00222 
00223     <span class="comment">//</span>
00224     <span class="comment">// enable Settings if not already doing it</span>
00225     <span class="comment">//</span>
00226 
00227     <span class="keywordflow">if</span> (Console-&gt;hWndProperties &amp;&amp; <a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(Console-&gt;hWndProperties)) {
00228         <a class="code" href="../../d3/d9/client_2wow_8c.html#a28">EnableMenuItem</a>(hMenu,<a class="code" href="../../d6/d7/menu_8h.html#a15">cmControl</a>,MF_GRAYED);
00229     } <span class="keywordflow">else</span> {
00230         <a class="code" href="../../d3/d9/client_2wow_8c.html#a28">EnableMenuItem</a>(hMenu,<a class="code" href="../../d6/d7/menu_8h.html#a15">cmControl</a>,MF_ENABLED);
00231         Console-&gt;hWndProperties = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00232     }
00233 }
00234 
00235 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00236"></a><a class="code" href="../../d1/d7/ntcon_2server_2menu_8c.html#a3">00236</a> <a class="code" href="../../d1/d7/ntcon_2server_2menu_8c.html#a3">SetWinText</a>(
00237     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00238     IN UINT wID,
00239     IN BOOL Add
00240     )
00241 
00242 <span class="comment">/*++</span>
00243 <span class="comment"></span>
00244 <span class="comment">    This routine adds or removes the name to or from the</span>
00245 <span class="comment">    beginning of the window title.  The possible names</span>
00246 <span class="comment">    are "Scroll", "Mark", "Paste", and "Copy".</span>
00247 <span class="comment"></span>
00248 <span class="comment">--*/</span>
00249 
00250 {
00251     WCHAR TextBuf[256];
00252     PWCHAR TextBufPtr;
00253     <span class="keywordtype">int</span> TextLength;
00254     <span class="keywordtype">int</span> NameLength;
00255     WCHAR NameString[20];
00256 
00257     NameLength = LoadString(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a4">ghInstance</a>,wID,NameString,
00258                                   <span class="keyword">sizeof</span>(NameString)/<span class="keyword">sizeof</span>(WCHAR));
00259     <span class="keywordflow">if</span> (Add) {
00260         RtlCopyMemory(TextBuf,NameString,NameLength*<span class="keyword">sizeof</span>(WCHAR));
00261         TextBuf[NameLength] = <span class="charliteral">' '</span>;
00262         TextBufPtr = TextBuf + NameLength + 1;
00263     } <span class="keywordflow">else</span> {
00264         TextBufPtr = TextBuf;
00265     }
00266     TextLength = <a class="code" href="../../d5/d9/cltxt_8h.html#a21">GetWindowText</a>(Console-&gt;hWnd,
00267                                   TextBufPtr,
00268                                   <span class="keyword">sizeof</span>(TextBuf)/<span class="keyword">sizeof</span>(WCHAR)-NameLength-1);
00269     <span class="keywordflow">if</span> (TextLength == 0)
00270         <span class="keywordflow">return</span>;
00271     <span class="keywordflow">if</span> (Add) {
00272         TextBufPtr = TextBuf;
00273     } <span class="keywordflow">else</span> {
00274         <span class="comment">/*</span>
00275 <span class="comment">         * The window title might have already been reset, so make sure</span>
00276 <span class="comment">         * the name is there before trying to remove it.</span>
00277 <span class="comment">         */</span>
00278         <span class="keywordflow">if</span> (wcsncmp(NameString, TextBufPtr, NameLength) != 0)
00279             <span class="keywordflow">return</span>;
00280         TextBufPtr = TextBuf + NameLength + 1;
00281     }
00282     <a class="code" href="../../d5/d9/cltxt_8h.html#a23">SetWindowText</a>(Console-&gt;hWnd,TextBufPtr);
00283 }
00284 
00285 
00286 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00287"></a><a class="code" href="../../d1/d7/ntcon_2server_2menu_8c.html#a4">00287</a> <a class="code" href="../../d1/d7/ntcon_2server_2menu_8c.html#a4">PropertiesDlgShow</a>(
00288     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00289     IN BOOL fCurrent
00290     )
00291 
00292 <span class="comment">/*++</span>
00293 <span class="comment"></span>
00294 <span class="comment">    Displays the properties dialog and updates the window state,</span>
00295 <span class="comment">    if necessary.</span>
00296 <span class="comment"></span>
00297 <span class="comment">--*/</span>
00298 
00299 {
00300     HANDLE hSection = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00301     HANDLE hClientSection = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00302     HANDLE hThread;
00303     SIZE_T ulViewSize;
00304     LARGE_INTEGER li;
00305     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00306     PCONSOLE_STATE_INFO pStateInfo;
00307     <a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">PCONSOLE_PROCESS_HANDLE</a> ProcessHandleRecord;
00308     <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo;
00309     LPTHREAD_START_ROUTINE MyPropRoutine;
00310 
00311     <span class="comment">/*</span>
00312 <span class="comment">     * Map the shared memory block handle into the client side process's</span>
00313 <span class="comment">     * address space.</span>
00314 <span class="comment">     */</span>
00315     ProcessHandleRecord = CONTAINING_RECORD(Console-&gt;ProcessHandleList.Blink,
00316                                             <a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">CONSOLE_PROCESS_HANDLE</a>,
00317                                             ListLink);
00318     <span class="comment">/*</span>
00319 <span class="comment">     * For global properties pass in hWnd for the hClientSection</span>
00320 <span class="comment">     */</span>
00321     <span class="keywordflow">if</span> (!fCurrent) {
00322         hClientSection = Console-&gt;hWnd;
00323         <span class="keywordflow">goto</span> PropCallback;
00324     }
00325 
00326     <span class="comment">/*</span>
00327 <span class="comment">     * Create a shared memory block.</span>
00328 <span class="comment">     */</span>
00329     li.QuadPart = <span class="keyword">sizeof</span>(CONSOLE_STATE_INFO) + Console-&gt;OriginalTitleLength;
00330     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/creasect_8c.html#a19">NtCreateSection</a>(&amp;hSection,
00331                              SECTION_ALL_ACCESS,
00332                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00333                              &amp;li,
00334                              PAGE_READWRITE,
00335                              SEC_COMMIT,
00336                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00337     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00338         KdPrint((<span class="stringliteral">"CONSRV: error %x creating file mapping\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00339         <span class="keywordflow">return</span>;
00340     }
00341 
00342     <span class="comment">/*</span>
00343 <span class="comment">     * Get a pointer to the shared memory block.</span>
00344 <span class="comment">     */</span>
00345     pStateInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00346     ulViewSize = 0;
00347     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a20">NtMapViewOfSection</a>(hSection,
00348                                 NtCurrentProcess(),
00349                                 &amp;pStateInfo,
00350                                 0,
00351                                 0,
00352                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00353                                 &amp;ulViewSize,
00354                                 ViewUnmap,
00355                                 0,
00356                                 PAGE_READWRITE);
00357     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00358         KdPrint((<span class="stringliteral">"CONSRV: error %x mapping view of file\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00359         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hSection);
00360         <span class="keywordflow">return</span>;
00361     }
00362 
00363     <span class="comment">/*</span>
00364 <span class="comment">     * Fill in the shared memory block with the current values.</span>
00365 <span class="comment">     */</span>
00366     ScreenInfo = Console-&gt;CurrentScreenBuffer;
00367     pStateInfo-&gt;Length = li.LowPart;
00368     pStateInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a> = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>;
00369     pStateInfo-&gt;WindowSize.X = <a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo);
00370     pStateInfo-&gt;WindowSize.Y = <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo);
00371     pStateInfo-&gt;WindowPosX = Console-&gt;WindowRect.left;
00372     pStateInfo-&gt;WindowPosY = Console-&gt;WindowRect.top;
00373     <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
00374         pStateInfo-&gt;FontSize = <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo);
00375         pStateInfo-&gt;FontFamily = <a class="code" href="../../d8/d5/consrv_8h.html#a63">SCR_FAMILY</a>(ScreenInfo);
00376         pStateInfo-&gt;FontWeight = <a class="code" href="../../d8/d5/consrv_8h.html#a67">SCR_FONTWEIGHT</a>(ScreenInfo);
00377         wcscpy(pStateInfo-&gt;FaceName, <a class="code" href="../../d8/d5/consrv_8h.html#a65">SCR_FACENAME</a>(ScreenInfo));
00378 <span class="preprocessor">#if defined(FE_SB)</span>
00379 <span class="preprocessor"></span><span class="comment">// if TT font has external leading, the Size.Y &lt;&gt; SizeWant.Y</span>
00380 <span class="comment">// if we still pass actual Size.Y to console.cpl to query font,</span>
00381 <span class="comment">// it will be incorrect. Jun-26-1996</span>
00382 
00383         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a32">CONSOLE_IS_DBCS_ENABLED</a>() &amp;&amp;
00384             <a class="code" href="../../d7/d6/font_8h.html#a2">TM_IS_TT_FONT</a>(<a class="code" href="../../d8/d5/consrv_8h.html#a63">SCR_FAMILY</a>(ScreenInfo)))
00385         {
00386             <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d5/consrv_8h.html#a64">SCR_FONTNUMBER</a>(ScreenInfo) &gt;= 0 ) &amp;&amp;
00387                 (<a class="code" href="../../d8/d5/consrv_8h.html#a64">SCR_FONTNUMBER</a>(ScreenInfo) &lt; <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a27">NumberOfFonts</a>)) {
00388 
00389                 pStateInfo-&gt;FontSize = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[<a class="code" href="../../d8/d5/consrv_8h.html#a64">SCR_FONTNUMBER</a>(ScreenInfo)].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o2">SizeWant</a>;
00390             }
00391         }
00392 <span class="preprocessor">#endif</span>
00393 <span class="preprocessor"></span>        pStateInfo-&gt;CursorSize = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorSize;
00394     }
00395     pStateInfo-&gt;FullScreen = Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN;
00396     pStateInfo-&gt;QuickEdit = Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a11">CONSOLE_QUICK_EDIT_MODE</a>;
00397     pStateInfo-&gt;AutoPosition = Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a16">CONSOLE_AUTO_POSITION</a>;
00398     pStateInfo-&gt;InsertMode = Console-&gt;InsertMode;
00399     pStateInfo-&gt;ScreenAttributes = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o8">Attributes</a>;
00400     pStateInfo-&gt;PopupAttributes = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o9">PopupAttributes</a>;
00401     pStateInfo-&gt;HistoryBufferSize = Console-&gt;CommandHistorySize;
00402     pStateInfo-&gt;NumberOfHistoryBuffers = Console-&gt;MaxCommandHistories;
00403     pStateInfo-&gt;HistoryNoDup = Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a20">CONSOLE_HISTORY_NODUP</a>;
00404     RtlCopyMemory(pStateInfo-&gt;ColorTable,
00405                   Console-&gt;ColorTable,
00406                   <span class="keyword">sizeof</span>(Console-&gt;ColorTable));
00407     pStateInfo-&gt;hWnd = Console-&gt;hWnd;
00408     wcscpy(pStateInfo-&gt;ConsoleTitle, Console-&gt;OriginalTitle);
00409 <span class="preprocessor">#if defined(FE_SB)</span>
00410 <span class="preprocessor"></span>    pStateInfo-&gt;CodePage = Console-&gt;OutputCP;
00411 <span class="preprocessor">#endif</span>
00412 <span class="preprocessor"></span>    <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(), pStateInfo);
00413 
00414     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>(NtCurrentProcess(),
00415                                hSection,
00416                                ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o1">ProcessHandle</a>,
00417                                &amp;hClientSection,
00418                                0,
00419                                0,
00420                                DUPLICATE_SAME_ACCESS);
00421     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00422         KdPrint((<span class="stringliteral">"CONSRV: error %x mapping handle to client\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00423         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hSection);
00424         <span class="keywordflow">return</span>;
00425     }
00426 
00427 PropCallback:
00428     <span class="comment">/*</span>
00429 <span class="comment">     * Get a pointer to the client-side properties routine.</span>
00430 <span class="comment">     */</span>
00431     MyPropRoutine = ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o5">PropRoutine</a>;
00432     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(MyPropRoutine);
00433 
00434     <span class="comment">/*</span>
00435 <span class="comment">     * Call back into the client process to spawn the properties dialog.</span>
00436 <span class="comment">     */</span>
00437     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00438     hThread = <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a19">InternalCreateCallbackThread</a>(ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o1">ProcessHandle</a>,
00439                                            (ULONG_PTR)MyPropRoutine,
00440                                            (ULONG_PTR)hClientSection);
00441     <span class="keywordflow">if</span> (!hThread) {
00442         KdPrint((<span class="stringliteral">"CONSRV: CreateRemoteThread failed %d\n"</span>, GetLastError()));
00443     }
00444     <a class="code" href="../../d8/d5/consrv_8h.html#a42">LockConsole</a>(Console);
00445 
00446     <span class="comment">/*</span>
00447 <span class="comment">     * Close any open handles and free allocated memory.</span>
00448 <span class="comment">     */</span>
00449     <span class="keywordflow">if</span> (hThread)
00450         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hThread);
00451     <span class="keywordflow">if</span> (hSection)
00452         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hSection);
00453 
00454     <span class="keywordflow">return</span>;
00455 }
00456 
00457 
00458 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00459"></a><a class="code" href="../../d1/d7/ntcon_2server_2menu_8c.html#a5">00459</a> <a class="code" href="../../d1/d7/ntcon_2server_2menu_8c.html#a5">PropertiesUpdate</a>(
00460     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00461     IN HANDLE hClientSection
00462     )
00463 
00464 <span class="comment">/*++</span>
00465 <span class="comment"></span>
00466 <span class="comment">    Updates the console state from information sent by the properties</span>
00467 <span class="comment">    dialog box.</span>
00468 <span class="comment"></span>
00469 <span class="comment">--*/</span>
00470 
00471 {
00472     HANDLE hSection;
00473     SIZE_T ulViewSize;
00474     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00475     PCONSOLE_STATE_INFO pStateInfo;
00476     <a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">PCONSOLE_PROCESS_HANDLE</a> ProcessHandleRecord;
00477     <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo;
00478     ULONG FontIndex;
00479     WINDOWPLACEMENT wp;
00480     COORD NewSize;
00481     <a class="code" href="../../d0/d9/struct__WINDOW__LIMITS.html">WINDOW_LIMITS</a> WindowLimits;
00482 
00483     <span class="comment">/*</span>
00484 <span class="comment">     * Map the shared memory block handle into our address space.</span>
00485 <span class="comment">     */</span>
00486     ProcessHandleRecord = CONTAINING_RECORD(Console-&gt;ProcessHandleList.Blink,
00487                                             <a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">CONSOLE_PROCESS_HANDLE</a>,
00488                                             ListLink);
00489     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>(ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o1">ProcessHandle</a>,
00490                                hClientSection,
00491                                NtCurrentProcess(),
00492                                &amp;hSection,
00493                                0,
00494                                0,
00495                                DUPLICATE_SAME_ACCESS);
00496     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00497         KdPrint((<span class="stringliteral">"CONSRV: error %x mapping client handle\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00498         <span class="keywordflow">return</span>;
00499     }
00500 
00501     <span class="comment">/*</span>
00502 <span class="comment">     * Get a pointer to the shared memory block.</span>
00503 <span class="comment">     */</span>
00504     pStateInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00505     ulViewSize = 0;
00506     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a20">NtMapViewOfSection</a>(hSection,
00507                                 NtCurrentProcess(),
00508                                 &amp;pStateInfo,
00509                                 0,
00510                                 0,
00511                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00512                                 &amp;ulViewSize,
00513                                 ViewUnmap,
00514                                 0,
00515                                 PAGE_READONLY);
00516     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00517         KdPrint((<span class="stringliteral">"CONSRV: error %x mapping view of file\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00518         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hSection);
00519         <span class="keywordflow">return</span>;
00520     }
00521 
00522     <span class="comment">/*</span>
00523 <span class="comment">     * Verify the size of the shared memory block.</span>
00524 <span class="comment">     */</span>
00525     <span class="keywordflow">if</span> (ulViewSize &lt; <span class="keyword">sizeof</span>(CONSOLE_STATE_INFO)) {
00526         KdPrint((<span class="stringliteral">"CONSRV: sizeof(hSection) &lt; sizeof(CONSOLE_STATE_INFO)\n"</span>));
00527         <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(), pStateInfo);
00528         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hSection);
00529         <span class="keywordflow">return</span>;
00530     }
00531 
00532     ScreenInfo = Console-&gt;CurrentScreenBuffer;
00533 <span class="preprocessor">#if defined(FE_SB)</span>
00534 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Console-&gt;OutputCP != pStateInfo-&gt;CodePage)
00535     {
00536         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> CodePage = Console-&gt;OutputCP;
00537 
00538         Console-&gt;OutputCP = pStateInfo-&gt;CodePage;
00539         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a32">CONSOLE_IS_DBCS_ENABLED</a>())
00540             Console-&gt;fIsDBCSOutputCP = !!<a class="code" href="../../d0/d3/dbcs_8h.html#a46">IsAvailableFarEastCodePage</a>(Console-&gt;OutputCP);
00541         <span class="keywordflow">else</span>
00542             Console-&gt;fIsDBCSOutputCP = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00543         SetConsoleCPInfo(Console,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00544 <span class="preprocessor">#if defined(FE_IME)</span>
00545 <span class="preprocessor"></span>        SetImeOutputCodePage(Console, ScreenInfo, CodePage);
00546 <span class="preprocessor">#endif // FE_IME</span>
00547 <span class="preprocessor"></span>    }
00548     <span class="keywordflow">if</span> (Console-&gt;CP != pStateInfo-&gt;CodePage)
00549     {
00550         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> CodePage = Console-&gt;CP;
00551 
00552         Console-&gt;CP = pStateInfo-&gt;CodePage;
00553         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a32">CONSOLE_IS_DBCS_ENABLED</a>())
00554             Console-&gt;fIsDBCSCP = !!<a class="code" href="../../d0/d3/dbcs_8h.html#a46">IsAvailableFarEastCodePage</a>(Console-&gt;CP);
00555         <span class="keywordflow">else</span>
00556             Console-&gt;fIsDBCSCP = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00557         SetConsoleCPInfo(Console,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00558 <span class="preprocessor">#if defined(FE_IME)</span>
00559 <span class="preprocessor"></span>        SetImeCodePage(Console);
00560 <span class="preprocessor">#endif // FE_IME</span>
00561 <span class="preprocessor"></span>    }
00562 <span class="preprocessor">#endif // FE_SB</span>
00563 <span class="preprocessor"></span>
00564     <span class="comment">/*</span>
00565 <span class="comment">     * Update the console state from the supplied values.</span>
00566 <span class="comment">     */</span>
00567     <span class="keywordflow">if</span> (!(Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>) &amp;&amp;
00568         (pStateInfo-&gt;ScreenBufferSize.X != ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X ||
00569          pStateInfo-&gt;ScreenBufferSize.Y != ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y)) {
00570 
00571         <a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html">PCOOKED_READ_DATA</a> CookedReadData = Console-&gt;lpCookedReadData;
00572 
00573         <span class="keywordflow">if</span> (CookedReadData &amp;&amp; CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o12">NumberOfVisibleChars</a>) {
00574             <a class="code" href="../../d4/d1/cmdline_8h.html#a41">DeleteCommandLine</a>(CookedReadData, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00575         }
00576         <a class="code" href="../../d6/d2/output_8c.html#a58">ResizeScreenBuffer</a>(ScreenInfo,
00577                            pStateInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>,
00578                            <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00579         <span class="keywordflow">if</span> (CookedReadData &amp;&amp; CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o12">NumberOfVisibleChars</a>) {
00580             <a class="code" href="../../d4/d1/cmdline_8h.html#a42">RedrawCommandLine</a>(CookedReadData);
00581         }
00582     }
00583 <span class="preprocessor">#if !defined(FE_SB)</span>
00584 <span class="preprocessor"></span>    FontIndex = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a25">FindCreateFont</a>(pStateInfo-&gt;FontFamily,
00585                                pStateInfo-&gt;FaceName,
00586                                pStateInfo-&gt;FontSize,
00587                                pStateInfo-&gt;FontWeight);
00588 <span class="preprocessor">#else</span>
00589 <span class="preprocessor"></span>    FontIndex = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a25">FindCreateFont</a>(pStateInfo-&gt;FontFamily,
00590                                pStateInfo-&gt;FaceName,
00591                                pStateInfo-&gt;FontSize,
00592                                pStateInfo-&gt;FontWeight,
00593                                pStateInfo-&gt;CodePage);
00594 <span class="preprocessor">#endif</span>
00595 <span class="preprocessor"></span>
00596 <span class="preprocessor">#if defined(FE_SB)</span>
00597 <span class="preprocessor"></span><span class="preprocessor">#if defined(i386)</span>
00598 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (! (Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN)) {
00599         <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a33">SetScreenBufferFont</a>(ScreenInfo, FontIndex, pStateInfo-&gt;CodePage);
00600     }
00601     <span class="keywordflow">else</span> {
00602         <a class="code" href="../../d8/d5/consrv_8h.html#a293">ChangeDispSettings</a>(Console, Console-&gt;hWnd, 0);
00603         <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a33">SetScreenBufferFont</a>(ScreenInfo, FontIndex, pStateInfo-&gt;CodePage);
00604         <a class="code" href="../../d7/d4/server_2private_8c.html#a48">ConvertToFullScreen</a>(Console);
00605         <a class="code" href="../../d8/d5/consrv_8h.html#a293">ChangeDispSettings</a>(Console, Console-&gt;hWnd, CDS_FULLSCREEN);
00606     }
00607 <span class="preprocessor">#else // i386</span>
00608 <span class="preprocessor"></span>    <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a33">SetScreenBufferFont</a>(ScreenInfo, FontIndex, pStateInfo-&gt;CodePage);
00609 <span class="preprocessor">#endif</span>
00610 <span class="preprocessor"></span><span class="preprocessor">#else // FE_SB</span>
00611 <span class="preprocessor"></span>    <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a33">SetScreenBufferFont</a>(ScreenInfo, FontIndex);
00612 <span class="preprocessor">#endif // FE_SB</span>
00613 <span class="preprocessor"></span>    <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a4">SetCursorInformation</a>(ScreenInfo,
00614                          pStateInfo-&gt;CursorSize,
00615                          ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorVisible);
00616 
00617     <a class="code" href="../../d6/d2/output_8c.html#a39">GetWindowLimits</a>(ScreenInfo, &amp;WindowLimits);
00618     NewSize.X = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(pStateInfo-&gt;WindowSize.X, WindowLimits.<a class="code" href="../../d0/d9/struct__WINDOW__LIMITS.html#o1">MaximumWindowSize</a>.X);
00619     NewSize.Y = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(pStateInfo-&gt;WindowSize.Y, WindowLimits.<a class="code" href="../../d0/d9/struct__WINDOW__LIMITS.html#o1">MaximumWindowSize</a>.Y);
00620     <span class="keywordflow">if</span> (NewSize.X != <a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo) ||
00621         NewSize.Y != <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo)) {
00622         wp.length = <span class="keyword">sizeof</span>(wp);
00623         <a class="code" href="../../d6/d0/usercli_8h.html#a238">GetWindowPlacement</a>(Console-&gt;hWnd, &amp;wp);
00624         wp.rcNormalPosition.right += (NewSize.X - <a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo)) *
00625                             <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X;
00626         wp.rcNormalPosition.bottom += (NewSize.Y - <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo)) *
00627                              <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).Y;
00628         SetWindowPlacement(Console-&gt;hWnd, &amp;wp);
00629     }
00630 
00631 <span class="preprocessor">#ifdef i386</span>
00632 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a12">FullScreenInitialized</a>) {
00633         <span class="keywordflow">if</span> (pStateInfo-&gt;FullScreen == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00634             <span class="keywordflow">if</span> (Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN) {
00635                 <a class="code" href="../../d7/d4/server_2private_8c.html#a49">ConvertToWindowed</a>(Console);
00636 <span class="preprocessor">#if defined(FE_SB)</span>
00637 <span class="preprocessor"></span>                <span class="comment">/*</span>
00638 <span class="comment">                 * Should not sets 0 always.</span>
00639 <span class="comment">                 * because exist CONSOLE_FULLSCREEN_HARDWARE bit by avobe</span>
00640 <span class="comment">                 *   else {</span>
00641 <span class="comment">                 *       ChangeDispSettings(Console, Console-&gt;hWnd, 0);</span>
00642 <span class="comment">                 *       SetScreenBufferFont(ScreenInfo, FontIndex, pStateInfo-&gt;CodePage);</span>
00643 <span class="comment">                 *       ConvertToFullScreen(Console);</span>
00644 <span class="comment">                 *       ChangeDispSettings(Console, Console-&gt;hWnd, CDS_FULLSCREEN);</span>
00645 <span class="comment">                 *   }</span>
00646 <span class="comment">                 * block.</span>
00647 <span class="comment">                 *</span>
00648 <span class="comment">                 * This block enable as follows:</span>
00649 <span class="comment">                 *   1. console window is full screen</span>
00650 <span class="comment">                 *   2. open property by ALT+SPACE</span>
00651 <span class="comment">                 *   3. changes window mode by settings.</span>
00652 <span class="comment">                 */</span>
00653                 Console-&gt;FullScreenFlags &amp;= ~CONSOLE_FULLSCREEN;
00654 <span class="preprocessor">#else</span>
00655 <span class="preprocessor"></span>                <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN_HARDWARE));
00656                 Console-&gt;FullScreenFlags = 0;
00657 <span class="preprocessor">#endif</span>
00658 <span class="preprocessor"></span>
00659                 <a class="code" href="../../d8/d5/consrv_8h.html#a293">ChangeDispSettings</a>(Console, Console-&gt;hWnd, 0);
00660             }
00661         } <span class="keywordflow">else</span> {
00662             <span class="keywordflow">if</span> (Console-&gt;FullScreenFlags == 0) {
00663                 <a class="code" href="../../d7/d4/server_2private_8c.html#a48">ConvertToFullScreen</a>(Console);
00664                 Console-&gt;FullScreenFlags |= CONSOLE_FULLSCREEN;
00665 
00666                 <a class="code" href="../../d8/d5/consrv_8h.html#a293">ChangeDispSettings</a>(Console, Console-&gt;hWnd, CDS_FULLSCREEN);
00667             }
00668         }
00669     }
00670 <span class="preprocessor">#endif</span>
00671 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (pStateInfo-&gt;QuickEdit) {
00672         Console-&gt;Flags |= <a class="code" href="../../d1/d7/server_8h.html#a11">CONSOLE_QUICK_EDIT_MODE</a>;
00673     } <span class="keywordflow">else</span> {
00674         Console-&gt;Flags &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a11">CONSOLE_QUICK_EDIT_MODE</a>;
00675     }
00676     <span class="keywordflow">if</span> (pStateInfo-&gt;AutoPosition) {
00677         Console-&gt;Flags |= <a class="code" href="../../d1/d7/server_8h.html#a16">CONSOLE_AUTO_POSITION</a>;
00678     } <span class="keywordflow">else</span> {
00679         Console-&gt;Flags &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a16">CONSOLE_AUTO_POSITION</a>;
00680         <a class="code" href="../../d3/d4/w32_2ntuser_2client_2nt6_2pch_8h.html#a0">SetWindowPos</a>(Console-&gt;hWnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00681                         pStateInfo-&gt;WindowPosX,
00682                         pStateInfo-&gt;WindowPosY,
00683                         0, 0, SWP_NOZORDER | SWP_NOSIZE);
00684     }
00685     <span class="keywordflow">if</span> (Console-&gt;InsertMode != pStateInfo-&gt;InsertMode) {
00686         <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a5">SetCursorMode</a>(ScreenInfo, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00687         Console-&gt;InsertMode = (pStateInfo-&gt;InsertMode != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00688 <span class="preprocessor">#ifdef FE_SB</span>
00689 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (Console-&gt;lpCookedReadData) {
00690             ((<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html">PCOOKED_READ_DATA</a>)Console-&gt;lpCookedReadData)-&gt;InsertMode = Console-&gt;InsertMode;
00691         }
00692 <span class="preprocessor">#endif</span>
00693 <span class="preprocessor"></span>    }
00694 
00695     RtlCopyMemory(Console-&gt;ColorTable,
00696                   pStateInfo-&gt;ColorTable,
00697                   <span class="keyword">sizeof</span>(Console-&gt;ColorTable));
00698     <a class="code" href="../../d9/d4/ntcon_2server_2getset_8c.html#a20">SetScreenColors</a>(ScreenInfo,
00699                     pStateInfo-&gt;ScreenAttributes,
00700                     pStateInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o9">PopupAttributes</a>,
00701                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00702 
00703     <a class="code" href="../../d8/d5/consrv_8h.html#a261">ResizeCommandHistoryBuffers</a>(Console, pStateInfo-&gt;HistoryBufferSize);
00704     Console-&gt;MaxCommandHistories = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)pStateInfo-&gt;NumberOfHistoryBuffers;
00705     <span class="keywordflow">if</span> (pStateInfo-&gt;HistoryNoDup) {
00706         Console-&gt;Flags |= <a class="code" href="../../d1/d7/server_8h.html#a20">CONSOLE_HISTORY_NODUP</a>;
00707     } <span class="keywordflow">else</span> {
00708         Console-&gt;Flags &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a20">CONSOLE_HISTORY_NODUP</a>;
00709     }
00710 
00711 <span class="preprocessor">#if defined(FE_IME)</span>
00712 <span class="preprocessor"></span>    SetUndetermineAttribute(Console) ;
00713 <span class="preprocessor">#endif</span>
00714 <span class="preprocessor"></span>
00715     <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(), pStateInfo);
00716     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hSection);
00717 
00718     <span class="keywordflow">return</span>;
00719 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:44 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
