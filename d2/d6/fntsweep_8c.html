<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: fntsweep.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>fntsweep.c File Reference</h1><code>#include "<a class="el" href="../../d8/d2/w32_2ntuser_2client_2precomp_8h-source.html">precomp.h</a>"</code><br>
<code>#include &lt;setupbat.h&gt;</code><br>

<p>
<a href="../../d3/d5/fntsweep_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/fntsweep_8c.html#a0">LAST_SWEEP_TIME</a>&nbsp;&nbsp;&nbsp;L"LastSweepTime"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/fntsweep_8c.html#a1">UPGRADED_TYPE1</a>&nbsp;&nbsp;&nbsp;L"UpgradedType1"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/fntsweep_8c.html#a2">DWORDALIGN</a>(X)&nbsp;&nbsp;&nbsp;(((X) + 3) &amp; ~3)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/fntsweep_8c.html#a3">EXT_TRUETYPE</a>&nbsp;&nbsp;&nbsp;L"(TrueType)"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/fntsweep_8c.html#a4">EXT_FOT</a>&nbsp;&nbsp;&nbsp;L".FOT"</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef VOID(*&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/fntsweep_8c.html#a14">PFNENTRY</a> )(HKEY hkey, WCHAR *, ULONG, WCHAR *, ULONG)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/fntsweep_8c.html#a15">bCheckIfDualBootingWithWin31</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/fntsweep_8c.html#a16">vNullTermWideString</a> (WCHAR *pwcDest, WCHAR *pwcSrc, ULONG ulLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/fntsweep_8c.html#a17">bCheckFontEntry</a> (WCHAR *pwcName, WCHAR *pwcExtension)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/fntsweep_8c.html#a18">vProcessFontEntry</a> (HKEY hkey, WCHAR *pwcValueName, ULONG ulValueNameLength, WCHAR *pwcFileName, ULONG ulFileNameLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/fntsweep_8c.html#a19">vMoveFileFromSystemToFontsDir</a> (WCHAR *pwcFile)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/fntsweep_8c.html#a20">vProcessType1FontEntry</a> (HKEY hkey, WCHAR *pwcValueName, ULONG ulValueNameLength, WCHAR *pwcValueData, ULONG ulValueDataLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/fntsweep_8c.html#a21">vAddType1Font</a> (WCHAR *pwcValueData, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="el" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/fntsweep_8c.html#a22">vAddRemoteType1Font</a> (HKEY hkey, WCHAR *pwcValueName, ULONG ulValueNameLength, WCHAR *pwcValueData, ULONG ulValueDataLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/fntsweep_8c.html#a23">vAddLocalType1Font</a> (HKEY hkey, WCHAR *pwcValueName, ULONG ulValueNameLength, WCHAR *pwcValueData, ULONG ulValueDataLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/fntsweep_8c.html#a24">vSweepFonts</a> (PCWSTR pwszFontListKey, PCWSTR pwszFontSweepKey, <a class="el" href="../../d2/d6/fntsweep_8c.html#a14">PFNENTRY</a> pfnProcessFontEntry, BOOL bForceEnum)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/fntsweep_8c.html#a25">bLoadableFontDrivers</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/fntsweep_8c.html#a26">bCheckAndDeleteTTF</a> (HKEY hkey, PKEY_FULL_INFORMATION pKeyInfo, PKEY_VALUE_FULL_INFORMATION KeyValueInfo, PKEY_VALUE_BASIC_INFORMATION KeyValueBasicInfo, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cjData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/fntsweep_8c.html#a27">bCleanConvertedTTFs</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/fntsweep_8c.html#a28">vCleanConvertedTTFs</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/fntsweep_8c.html#a29">vFontSweep</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/fntsweep_8c.html#a30">vLoadT1Fonts</a> (<a class="el" href="../../d2/d6/fntsweep_8c.html#a14">PFNENTRY</a> pfnProcessFontEntry)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/fntsweep_8c.html#a31">vLoadLocalT1Fonts</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/fntsweep_8c.html#a32">vLoadRemoteT1Fonts</a> ()</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>CONST WCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/fntsweep_8c.html#a5">pwszType1Key</a> [] = L"\\Registry\\Machine\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Type 1 Installer\\Type 1 Fonts"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>CONST WCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/fntsweep_8c.html#a6">pwszSweepType1Key</a> [] = L"\\Registry\\Machine\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Type 1 Installer\\LastType1Sweep"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>CONST WCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/fntsweep_8c.html#a7">pwszUpdType1Key</a> [] = L"\\Registry\\Machine\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Type 1 Installer\\Upgraded Type1"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>CONST WCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/fntsweep_8c.html#a8">pwszFontsKey</a> [] = L"\\Registry\\Machine\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Fonts"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>CONST WCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/fntsweep_8c.html#a9">pwszSweepKey</a> [] = L"\\Registry\\Machine\\Software\\Microsoft\\Windows NT\\CurrentVersion\\LastFontSweep"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>CONST WCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/fntsweep_8c.html#a10">pwszFontDrivers</a> [] = L"\\Registry\\Machine\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Font Drivers"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>WCHAR *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/fntsweep_8c.html#a11">gpwcSystemDir</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>WCHAR *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/fntsweep_8c.html#a12">gpwcFontsDir</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/fntsweep_8c.html#a13">gbWin31Upgrade</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a2" doxytag="fntsweep.c::DWORDALIGN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DWORDALIGN          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">X&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(((X) + 3) &amp; ~3)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00036">36</a> of file <a class="el" href="../../d3/d5/fntsweep_8c-source.html">fntsweep.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00996">bCleanConvertedTTFs()</a>, and <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00577">vSweepFonts()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="fntsweep.c::EXT_FOT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define EXT_FOT&nbsp;&nbsp;&nbsp;L".FOT"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00135">135</a> of file <a class="el" href="../../d3/d5/fntsweep_8c-source.html">fntsweep.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00138">vProcessFontEntry()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="fntsweep.c::EXT_TRUETYPE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define EXT_TRUETYPE&nbsp;&nbsp;&nbsp;L"(TrueType)"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00134">134</a> of file <a class="el" href="../../d3/d5/fntsweep_8c-source.html">fntsweep.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00138">vProcessFontEntry()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="fntsweep.c::LAST_SWEEP_TIME" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LAST_SWEEP_TIME&nbsp;&nbsp;&nbsp;L"LastSweepTime"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00033">33</a> of file <a class="el" href="../../d3/d5/fntsweep_8c-source.html">fntsweep.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00577">vSweepFonts()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="fntsweep.c::UPGRADED_TYPE1" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UPGRADED_TYPE1&nbsp;&nbsp;&nbsp;L"UpgradedType1"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00034">34</a> of file <a class="el" href="../../d3/d5/fntsweep_8c-source.html">fntsweep.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01132">vCleanConvertedTTFs()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a14" doxytag="fntsweep.c::PFNENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef VOID(* <a class="el" href="../../d2/d6/fntsweep_8c.html#a14">PFNENTRY</a>)(HKEY hkey, WCHAR *, ULONG, WCHAR *, ULONG)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00562">562</a> of file <a class="el" href="../../d3/d5/fntsweep_8c-source.html">fntsweep.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a26" doxytag="fntsweep.c::bCheckAndDeleteTTF" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL bCheckAndDeleteTTF           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HKEY&nbsp;</td>
          <td class="mdname" nowrap> <em>hkey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PKEY_FULL_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>pKeyInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PKEY_VALUE_FULL_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyValueInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PKEY_VALUE_BASIC_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyValueBasicInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>cjData</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00882">882</a> of file <a class="el" href="../../d3/d5/fntsweep_8c-source.html">fntsweep.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">BYTE</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d4/d8/arcinst_8c-source.html#l00065">MAX_PATH</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00504">NtDeleteValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00756">NtEnumerateValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00089">vNullTermWideString()</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00996">bCleanConvertedTTFs()</a>.
<p>
<pre class="fragment"><div>00889 {
00890     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00891     UNICODE_STRING UnicodeString;
00892     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       dwReturnLength;
00893     ULONG       iFont;
00894     WCHAR       awcTmp[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>], *pFontName, *pType1Name, *pwcFile;
00895     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        bDelTTFfile, bRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00896     FLONG       fl;
00897     WCHAR       awcType1Name[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];  <span class="comment">// null-terminated pType1Name</span>
00898     WCHAR       awcFontName[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];   <span class="comment">// null-terminated pFontName</span>
00899     WCHAR       awcFile[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];       <span class="comment">// null-terminated pwcFile</span>
00900 
00901     <span class="comment">// pKeyInfo holds the full info on the key "Fonts"</span>
00902     <span class="keywordflow">for</span> (iFont = 0; iFont &lt; pKeyInfo-&gt;Values; iFont++)
00903     {
00904         RtlZeroMemory(KeyValueInfo-&gt;Name, cjData);
00905         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a18">NtEnumerateValueKey</a>(
00906                     hkey,
00907                     iFont,
00908                     KeyValueFullInformation,
00909                     KeyValueInfo,
00910                     <span class="keyword">sizeof</span>(*KeyValueInfo) + cjData,
00911                     &amp;dwReturnLength);
00912 
00913         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
00914         {
00915             UserAssert(KeyValueInfo-&gt;NameLength &lt;= pKeyInfo-&gt;MaxValueNameLen);
00916             UserAssert(KeyValueInfo-&gt;DataLength &lt;= pKeyInfo-&gt;MaxValueDataLen);
00917             UserAssert(KeyValueInfo-&gt;Type == REG_SZ);
00918 
00919             bDelTTFfile = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00920 
00921             <span class="comment">// Make sure we use null-terminated strings</span>
00922             <a class="code" href="../../d2/d6/fntsweep_8c.html#a16">vNullTermWideString</a> (awcType1Name,
00923                                  KeyValueBasicInfo-&gt;Name,
00924                                  KeyValueBasicInfo-&gt;NameLength / <span class="keyword">sizeof</span>(WCHAR));
00925             <a class="code" href="../../d2/d6/fntsweep_8c.html#a16">vNullTermWideString</a> (awcFontName,
00926                                  KeyValueInfo-&gt;Name,
00927                                  KeyValueInfo-&gt;NameLength / <span class="keyword">sizeof</span>(WCHAR));
00928             <a class="code" href="../../d2/d6/fntsweep_8c.html#a16">vNullTermWideString</a> (awcFile,
00929                                  (WCHAR *) ((BYTE *)KeyValueInfo + KeyValueInfo-&gt;DataOffset),
00930                                  KeyValueInfo-&gt;DataLength / <span class="keyword">sizeof</span>(WCHAR));
00931             pType1Name = awcType1Name;
00932             pFontName = awcFontName;
00933             pwcFile = awcFile;
00934 
00935             <span class="keywordflow">while</span>((*pType1Name) &amp;&amp; (*pType1Name++ == *pFontName++))
00936                 ;
00937 
00938             <span class="comment">// if the font name match the type1 name</span>
00939             <span class="comment">// check whether this is a ttf font</span>
00940             <span class="keywordflow">if</span> ((*pType1Name == 0) &amp;&amp; (*pFontName++ == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">' '</span>))
00941             {
00942                 WCHAR *pTrueType = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"(TrueType)"</span>;
00943 
00944                 <span class="keywordflow">while</span>(*pTrueType &amp;&amp; (*pTrueType++ == *pFontName++))
00945                     ;
00946                 <span class="keywordflow">if</span> (*pTrueType == 0)
00947                 {
00948                     bDelTTFfile = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00949                 }
00950             }
00951 
00952             <span class="keywordflow">if</span> (bDelTTFfile)
00953             {
00954                 <span class="comment">// delete the converted TTF file</span>
00955                 <span class="keywordflow">if</span> (bRet = bMakePathNameW(awcTmp, pwcFile, NULL, &amp;fl))
00956                 {
00957                     UserVerify((bRet = DeleteFileW(awcTmp)));
00958                 }
00959 
00960                 <span class="comment">// remove the reg entry</span>
00961                 *pFontName = 0;
00962                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, awcFontName);
00963                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a16">NtDeleteValueKey</a>(hkey, (PUNICODE_STRING)&amp;UnicodeString);
00964 
00965                 <span class="comment">// decrement the number of values under [Fonts]</span>
00966                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
00967                     pKeyInfo-&gt;Values--;
00968                 <span class="keywordflow">else</span>
00969                     bRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00970 
00971                 <span class="keywordflow">break</span>;
00972             }
00973         }
00974         <span class="keywordflow">else</span>
00975         {
00976             bRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00977             <span class="keywordflow">break</span>;
00978         }
00979     }
00980 
00981     <span class="keywordflow">return</span> bRet;
00982 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="fntsweep.c::bCheckFontEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL bCheckFontEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">WCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>pwcName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>pwcExtension</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00112">112</a> of file <a class="el" href="../../d3/d5/fntsweep_8c-source.html">fntsweep.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00138">vProcessFontEntry()</a>.
<p>
<pre class="fragment"><div>00113 {
00114     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00115     LONG cwc = (LONG)wcslen(pwcName) - (LONG)wcslen(pwcExtension);
00116     <span class="keywordflow">if</span> (cwc &gt; 0)
00117     {
00118         bRet = !_wcsicmp(&amp;pwcName[cwc], pwcExtension);
00119     }
00120     <span class="keywordflow">return</span> bRet;
00121 
00122 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="fntsweep.c::bCheckIfDualBootingWithWin31" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL bCheckIfDualBootingWithWin31           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00043">43</a> of file <a class="el" href="../../d3/d5/fntsweep_8c-source.html">fntsweep.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d4/d8/arcinst_8c-source.html#l00065">MAX_PATH</a>, and <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01237">vFontSweep()</a>.
<p>
<pre class="fragment"><div>00044 {
00045     WCHAR <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[32];
00046     WCHAR awcWindowsDir[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00047     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwRet;
00048     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>  cwchWinPath = GetSystemWindowsDirectoryW(awcWindowsDir, MAX_PATH);
00049 
00050 <span class="comment">// the cwchWinPath value does not include the terminating zero</span>
00051 
00052     <span class="keywordflow">if</span> (awcWindowsDir[cwchWinPath - 1] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>)
00053     {
00054         cwchWinPath -= 1;
00055     }
00056     awcWindowsDir[cwchWinPath] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>; <span class="comment">// make sure to zero terminated</span>
00057 
00058     lstrcatW(awcWindowsDir, L<span class="stringliteral">"\\system32\\"</span>);
00059     lstrcatW(awcWindowsDir, WINNT_GUI_FILE_W);
00060 
00061     dwRet = GetPrivateProfileStringW(
00062                 WINNT_DATA_W,
00063                 WINNT_D_WIN31UPGRADE_W,
00064                 WINNT_A_NO_W,
00065                 Buffer,
00066                 <span class="keyword">sizeof</span>(Buffer)/<span class="keyword">sizeof</span>(WCHAR),
00067                 awcWindowsDir
00068                 );
00069 
00070 <span class="preprocessor">    #if DBGSWEEP</span>
00071 <span class="preprocessor"></span>    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n dwRet = %ld, win31upgrade = %ws\n\n"</span>, dwRet, Buffer);
00072 <span class="preprocessor">    #endif</span>
00073 <span class="preprocessor"></span>
00074     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)(dwRet ? (!lstrcmpiW(Buffer,WINNT_A_YES)) : 0);
00075 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="fntsweep.c::bCleanConvertedTTFs" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL bCleanConvertedTTFs           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00996">996</a> of file <a class="el" href="../../d3/d5/fntsweep_8c-source.html">fntsweep.c</a>.
<p>
References <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00882">bCheckAndDeleteTTF()</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00036">DWORDALIGN</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00756">NtEnumerateValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02018">NtQueryKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00029">pwszFontsKey</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00025">pwszType1Key</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00958">UserLocalAlloc</a>, and <a class="el" href="../../d7/d9/usercli_8h-source.html#l00960">UserLocalFree</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01132">vCleanConvertedTTFs()</a>.
<p>
<pre class="fragment"><div>00997 {
00998     UNICODE_STRING UnicodeString;
00999     OBJECT_ATTRIBUTES ObjA;
01000     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01001     HKEY        hkeyFonts = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hkeyType1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01002     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       dwReturnLength;
01003     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       iFontT1, cjData;
01004     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       cjMaxValueNameT1, cjMaxValueNameFonts;
01005     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        bRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, bError = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01006 
01007     KEY_FULL_INFORMATION KeyInfoType1, KeyInfoFonts;
01008     PKEY_VALUE_BASIC_INFORMATION KeyValueBasicInfo;
01009     PKEY_VALUE_FULL_INFORMATION KeyValueInfo;
01010 
01011     <span class="comment">// Open and query the value from the "Type1 Fonts" key</span>
01012     <span class="comment">// No need to continue if not succeed or no Type1 font listed</span>
01013     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, pwszType1Key);
01014     InitializeObjectAttributes(&amp;ObjA,
01015             &amp;UnicodeString,
01016             OBJ_CASE_INSENSITIVE,
01017             NULL,
01018             NULL);
01019 
01020     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;hkeyType1,
01021                     KEY_READ | KEY_WRITE,
01022                     &amp;ObjA);
01023 
01024     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01025     {
01026         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a24">NtQueryKey</a>(hkeyType1,
01027                     KeyFullInformation,
01028                     &amp;KeyInfoType1,
01029                     <span class="keyword">sizeof</span>(KeyInfoType1),
01030                     &amp;dwReturnLength);
01031 
01032         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) &amp;&amp; KeyInfoType1.Values)
01033         {
01034             UserAssert(!(KeyInfoType1.ClassLength | KeyInfoType1.SubKeys |
01035                          KeyInfoType1.MaxNameLen | KeyInfoType1.MaxClassLen));
01036 
01037             cjMaxValueNameT1 = <a class="code" href="../../d2/d6/fntsweep_8c.html#a2">DWORDALIGN</a>(KeyInfoType1.MaxValueNameLen + <span class="keyword">sizeof</span>(WCHAR));
01038 
01039             <span class="comment">// Alloc buffer big enough to hold the longest Name</span>
01040             <span class="keywordflow">if</span> (KeyValueBasicInfo = <a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(0, <span class="keyword">sizeof</span>(*KeyValueBasicInfo) + cjMaxValueNameT1))
01041             {
01042                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, pwszFontsKey);
01043                 InitializeObjectAttributes(&amp;ObjA,
01044                                     &amp;UnicodeString,
01045                                     OBJ_CASE_INSENSITIVE,
01046                                     NULL,
01047                                     NULL);
01048                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;hkeyFonts,
01049                                 KEY_READ | KEY_WRITE,
01050                                 &amp;ObjA);
01051 
01052                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01053                 {
01054                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a24">NtQueryKey</a>(hkeyFonts,
01055                                 KeyFullInformation,
01056                                 &amp;KeyInfoFonts,
01057                                 <span class="keyword">sizeof</span>(KeyInfoFonts),
01058                                 &amp;dwReturnLength);
01059 
01060                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) &amp;&amp; KeyInfoFonts.Values)
01061                     {
01062                         UserAssert(!(KeyInfoFonts.ClassLength | KeyInfoFonts.SubKeys |
01063                                      KeyInfoFonts.MaxNameLen | KeyInfoFonts.MaxClassLen));
01064 
01065                         cjMaxValueNameFonts = <a class="code" href="../../d2/d6/fntsweep_8c.html#a2">DWORDALIGN</a>(KeyInfoFonts.MaxValueNameLen + <span class="keyword">sizeof</span>(WCHAR));
01066                         KeyInfoFonts.MaxValueDataLen = <a class="code" href="../../d2/d6/fntsweep_8c.html#a2">DWORDALIGN</a>(KeyInfoFonts.MaxValueDataLen);
01067                         cjData = cjMaxValueNameFonts + KeyInfoFonts.MaxValueDataLen;
01068 
01069                         <span class="comment">// Alloc buffer big enough to hold the longest Name and Value</span>
01070                         <span class="keywordflow">if</span> (KeyValueInfo = <a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(0, <span class="keyword">sizeof</span>(*KeyValueInfo) + cjData))
01071                         {
01072                             <span class="comment">// Enum the "Type1 Fonts" key</span>
01073                             <span class="keywordflow">for</span> (iFontT1 = 0; iFontT1 &lt; KeyInfoType1.Values; iFontT1++)
01074                             {
01075                                 RtlZeroMemory(KeyValueBasicInfo-&gt;Name, cjMaxValueNameT1);
01076                                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a18">NtEnumerateValueKey</a>(
01077                                             hkeyType1,
01078                                             iFontT1,
01079                                             KeyValueBasicInformation,
01080                                             KeyValueBasicInfo,
01081                                             <span class="keyword">sizeof</span>(*KeyValueBasicInfo) + cjMaxValueNameT1,
01082                                             &amp;dwReturnLength);
01083 
01084                                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01085                                 {
01086                                     UserAssert(KeyValueBasicInfo-&gt;NameLength &lt;= KeyInfoType1.MaxValueNameLen);
01087                                     UserAssert(KeyValueBasicInfo-&gt;Type == REG_MULTI_SZ);
01088 
01089                                     <span class="comment">// For each Type1 font, check to see whether</span>
01090                                     <span class="comment">// there is corresponding converted TTF</span>
01091                                     <span class="comment">// Delete the TTF file and reg entry if any</span>
01092 
01093                                     bRet = <a class="code" href="../../d2/d6/fntsweep_8c.html#a26">bCheckAndDeleteTTF</a>(hkeyFonts, &amp;KeyInfoFonts, KeyValueInfo,
01094                                                             KeyValueBasicInfo, cjData);
01095                                     <span class="keywordflow">if</span> (!bRet)
01096                                     {
01097                                         bError = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01098                                     }
01099                                 }
01100                             }
01101                             <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(KeyValueInfo);
01102                             <span class="comment">// no type1 fonts installed</span>
01103                             <span class="keywordflow">if</span> (KeyInfoType1.Values == 0)
01104                             {
01105                                 bRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01106                             }
01107                         }
01108                     }
01109                     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hkeyFonts);
01110                 }  <span class="comment">// NtOpenKey (hkeyFonts)</span>
01111                 <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(KeyValueBasicInfo);
01112             }
01113         }  <span class="comment">// NtQueryKey (hkeyType1)</span>
01114         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hkeyType1);
01115     }
01116 
01117     <span class="keywordflow">return</span> (bRet &amp;&amp; !bError);
01118 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="fntsweep.c::bLoadableFontDrivers" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL bLoadableFontDrivers           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00818">818</a> of file <a class="el" href="../../d3/d5/fntsweep_8c-source.html">fntsweep.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02018">NtQueryKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00031">pwszFontDrivers</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01277">vLoadT1Fonts()</a>.
<p>
<pre class="fragment"><div>00819 {
00820     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00821     UNICODE_STRING       UnicodeString;
00822     OBJECT_ATTRIBUTES    ObjA;
00823     KEY_FULL_INFORMATION KeyInfo;
00824     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>                dwReturnLength;
00825     HKEY                 hkey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00826     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>                 bRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00827 
00828 <span class="comment">// open the font drivers key and check if there are any entries, if so</span>
00829 <span class="comment">// return true. If that is the case we will call AddFontResourceW on</span>
00830 <span class="comment">// Type 1 fonts at boot time, right after user had logged on</span>
00831 <span class="comment">// PostScript printer drivers are not initialized at this time yet,</span>
00832 <span class="comment">// it is safe to do it at this time.</span>
00833 
00834     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, pwszFontDrivers);
00835     InitializeObjectAttributes(&amp;ObjA,
00836                                &amp;UnicodeString,
00837                                OBJ_CASE_INSENSITIVE,
00838                                NULL,
00839                                NULL);
00840     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;hkey,
00841                        KEY_READ,
00842                        &amp;ObjA);
00843 
00844     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
00845     {
00846     <span class="comment">// get the number of entries in the [Fonts] section</span>
00847 
00848         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a24">NtQueryKey</a>(hkey,
00849                     KeyFullInformation,
00850                     &amp;KeyInfo,
00851                     <span class="keyword">sizeof</span>(KeyInfo),
00852                     &amp;dwReturnLength);
00853 
00854         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) &amp;&amp; KeyInfo.Values)
00855         {
00856             UserAssert(!(KeyInfo.ClassLength | KeyInfo.SubKeys | KeyInfo.MaxNameLen | KeyInfo.MaxClassLen));
00857 
00858         <span class="comment">// externally loadable drivers are present, force sweep</span>
00859 
00860             bRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00861         }
00862 
00863         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hkey);
00864     }
00865     <span class="keywordflow">return</span> bRet;
00866 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="fntsweep.c::vAddLocalType1Font" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID vAddLocalType1Font           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HKEY&nbsp;</td>
          <td class="mdname" nowrap> <em>hkey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>pwcValueName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ulValueNameLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>pwcValueData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ulValueDataLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00546">546</a> of file <a class="el" href="../../d3/d5/fntsweep_8c-source.html">fntsweep.c</a>.
<p>
References <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00489">vAddType1Font()</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01300">vLoadLocalT1Fonts()</a>.
<p>
<pre class="fragment"><div>00553 {
00554     UNREFERENCED_PARAMETER(hkey);
00555     UNREFERENCED_PARAMETER(pwcValueName);
00556     UNREFERENCED_PARAMETER(ulValueNameLength);
00557     UNREFERENCED_PARAMETER(ulValueDataLength);
00558     <a class="code" href="../../d2/d6/fntsweep_8c.html#a21">vAddType1Font</a>(pwcValueData, AFRW_ADD_LOCAL_FONT);
00559 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="fntsweep.c::vAddRemoteType1Font" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID vAddRemoteType1Font           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HKEY&nbsp;</td>
          <td class="mdname" nowrap> <em>hkey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>pwcValueName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ulValueNameLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>pwcValueData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ulValueDataLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00531">531</a> of file <a class="el" href="../../d3/d5/fntsweep_8c-source.html">fntsweep.c</a>.
<p>
References <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00489">vAddType1Font()</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01305">vLoadRemoteT1Fonts()</a>.
<p>
<pre class="fragment"><div>00538 {
00539     UNREFERENCED_PARAMETER(hkey);
00540     UNREFERENCED_PARAMETER(pwcValueName);
00541     UNREFERENCED_PARAMETER(ulValueNameLength);
00542     UNREFERENCED_PARAMETER(ulValueDataLength);
00543     <a class="code" href="../../d2/d6/fntsweep_8c.html#a21">vAddType1Font</a>(pwcValueData, AFRW_ADD_REMOTE_FONT);
00544 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="fntsweep.c::vAddType1Font" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID vAddType1Font           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">WCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>pwcValueData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>dwFlags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00489">489</a> of file <a class="el" href="../../d3/d5/fntsweep_8c-source.html">fntsweep.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d4/d7/propapi_8h-source.html#l00043">dwFlags</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00546">vAddLocalType1Font()</a>, and <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00531">vAddRemoteType1Font()</a>.
<p>
<pre class="fragment"><div>00493 {
00494     WCHAR *pwcPFM, *pwcPFB, *pwcMMM;
00495 
00496 <span class="preprocessor">    #if DBG</span>
00497 <span class="preprocessor"></span>    <span class="keywordtype">int</span> iRet;
00498 <span class="preprocessor">    #endif</span>
00499 <span class="preprocessor"></span>
00500 <span class="comment">// skip unused boolean value in this multi reg_sz string:</span>
00501 
00502     <span class="keywordflow">if</span> ((pwcValueData[0] != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>) &amp;&amp; (pwcValueData[1] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>))
00503     {
00504         pwcPFM = &amp;pwcValueData[2];
00505         pwcPFB = pwcPFM + wcslen(pwcPFM) + 1; <span class="comment">// add 1 for zero separator</span>
00506         pwcMMM = pwcPFB + wcslen(pwcPFB) + 1; <span class="comment">// may of may not be there.</span>
00507 
00508     <span class="comment">// replace space by separator and call addfontresourcew</span>
00509 
00510         pwcPFB[-1] = PATH_SEPARATOR;
00511 
00512     <span class="comment">// if this is a multiple master font, need one more separator:</span>
00513 
00514         <span class="keywordflow">if</span> (pwcMMM[0] != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>)
00515             pwcMMM[-1] = PATH_SEPARATOR;
00516 
00517 <span class="preprocessor">        #if DBG</span>
00518 <span class="preprocessor"></span>            iRet =
00519 <span class="preprocessor">        #endif</span>
00520 <span class="preprocessor"></span>
00521         GdiAddFontResourceW(pwcPFM, dwFlags, NULL);
00522 
00523 <span class="preprocessor">        #if DBGSWEEP</span>
00524 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"%ld = GdiAddFontResourceW(%ws, 0x%lx);\n"</span>,
00525                 iRet, pwcPFM, dwFlags);
00526 <span class="preprocessor">        #endif</span>
00527 <span class="preprocessor"></span>    }
00528 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="fntsweep.c::vCleanConvertedTTFs" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID vCleanConvertedTTFs           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01132">1132</a> of file <a class="el" href="../../d3/d5/fntsweep_8c-source.html">fntsweep.c</a>.
<p>
References <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00996">bCleanConvertedTTFs()</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00166">NtCreateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00027">pwszUpdType1Key</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00034">UPGRADED_TYPE1</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01237">vFontSweep()</a>.
<p>
<pre class="fragment"><div>01133 {
01134     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    bNeedUpgrade = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01135     UNICODE_STRING UnicodeString;
01136     OBJECT_ATTRIBUTES ObjA;
01137     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>      dwReturnLength;
01138     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>   <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01139     HKEY       hkeyUpgradeType1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01140 
01141     <span class="keyword">struct </span>{
01142         KEY_VALUE_PARTIAL_INFORMATION;
01143         LARGE_INTEGER;
01144     } UpgradeValueInfo;
01145     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>      UpgradeValue = 0;
01146 
01147     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, pwszUpdType1Key);
01148     InitializeObjectAttributes(&amp;ObjA,
01149                            &amp;UnicodeString,
01150                            OBJ_CASE_INSENSITIVE,
01151                            NULL,
01152                            NULL);
01153 
01154     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;hkeyUpgradeType1,
01155                    KEY_READ | KEY_WRITE,
01156                    &amp;ObjA);
01157 
01158     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01159     {
01160         <span class="comment">// Key doesn't exist, run for the first time</span>
01161         <span class="comment">// Create the key, open it for writing</span>
01162 
01163         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  dwDisposition;
01164 
01165         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(&amp;hkeyUpgradeType1,
01166                          KEY_WRITE,
01167                          &amp;ObjA,
01168                          0,
01169                          NULL,
01170                          REG_OPTION_NON_VOLATILE,
01171                          &amp;dwDisposition);
01172         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01173         {
01174             bNeedUpgrade = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01175         }
01176     }
01177     <span class="keywordflow">else</span>
01178     {
01179         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, UPGRADED_TYPE1);
01180         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(hkeyUpgradeType1,
01181                          &amp;UnicodeString,
01182                          KeyValuePartialInformation,
01183                          &amp;UpgradeValueInfo,
01184                          <span class="keyword">sizeof</span>(UpgradeValueInfo),
01185                          &amp;dwReturnLength);
01186 
01187         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01188         {
01189             UserAssert(UpgradeValueInfo.Type == REG_DWORD);
01190             UserAssert(UpgradeValueInfo.DataLength == <span class="keyword">sizeof</span>(UpgradeValue));
01191             RtlCopyMemory(&amp;UpgradeValue, &amp;UpgradeValueInfo.Data, <span class="keyword">sizeof</span>(UpgradeValue));
01192 
01193             <span class="comment">// Done if the value is non-zero.</span>
01194             <span class="keywordflow">if</span> (UpgradeValue == 0)
01195             {
01196                bNeedUpgrade = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01197             }
01198         }
01199     }
01200 
01201     <span class="keywordflow">if</span> (bNeedUpgrade)
01202     {
01203         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6/fntsweep_8c.html#a27">bCleanConvertedTTFs</a>())
01204         {
01205             UpgradeValue = 1;
01206         }
01207 
01208         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, UPGRADED_TYPE1);
01209         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(hkeyUpgradeType1,
01210               &amp;UnicodeString,
01211               0,
01212               REG_DWORD,
01213               &amp;UpgradeValue,
01214               <span class="keyword">sizeof</span>(UpgradeValue));
01215         UserAssert(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
01216     }
01217 
01218     <span class="keywordflow">if</span> (hkeyUpgradeType1)
01219     {
01220         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hkeyUpgradeType1);
01221     }
01222 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="fntsweep.c::vFontSweep" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID vFontSweep           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01237">1237</a> of file <a class="el" href="../../d3/d5/fntsweep_8c-source.html">fntsweep.c</a>.
<p>
References <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00043">bCheckIfDualBootingWithWin31()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00040">gbWin31Upgrade</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00038">gpwcSystemDir</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00029">pwszFontsKey</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00030">pwszSweepKey</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00026">pwszSweepType1Key</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00025">pwszType1Key</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01132">vCleanConvertedTTFs()</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00138">vProcessFontEntry()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00450">vProcessType1FontEntry()</a>, and <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00577">vSweepFonts()</a>.
<p>
<pre class="fragment"><div>01238 {
01239 <span class="comment">// check if shared windows directory installation:</span>
01240 
01241     <a class="code" href="../../d2/d6/fntsweep_8c.html#a13">gbWin31Upgrade</a> = <a class="code" href="../../d2/d6/fntsweep_8c.html#a15">bCheckIfDualBootingWithWin31</a>();
01242 
01243 <span class="comment">// before we sweep the files to the Fonts directory,</span>
01244 <span class="comment">// check whether the 'converted' ttf's have been rmoved</span>
01245 
01246     <a class="code" href="../../d2/d6/fntsweep_8c.html#a28">vCleanConvertedTTFs</a>();
01247 
01248 <span class="comment">// sweep fonts in the [Fonts] key</span>
01249 
01250     <a class="code" href="../../d2/d6/fntsweep_8c.html#a24">vSweepFonts</a>(pwszFontsKey, pwszSweepKey, vProcessFontEntry, FALSE);
01251 
01252 <span class="comment">// now sweep type 1 fonts, if any</span>
01253 
01254     <a class="code" href="../../d2/d6/fntsweep_8c.html#a24">vSweepFonts</a>(pwszType1Key, pwszSweepType1Key, vProcessType1FontEntry, FALSE);
01255 
01256 <span class="comment">// one of the two routines above may have initialized %windir%\system</span>
01257 <span class="comment">// and %windir%\fonts directories. Free the memory associated with this</span>
01258 
01259     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6/fntsweep_8c.html#a11">gpwcSystemDir</a>)
01260     {
01261         LocalFree(gpwcSystemDir);
01262         <a class="code" href="../../d2/d6/fntsweep_8c.html#a11">gpwcSystemDir</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01263     }
01264 
01265 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="fntsweep.c::vLoadLocalT1Fonts" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID vLoadLocalT1Fonts           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01300">1300</a> of file <a class="el" href="../../d3/d5/fntsweep_8c-source.html">fntsweep.c</a>.
<p>
References <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00546">vAddLocalType1Font()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01277">vLoadT1Fonts()</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
<pre class="fragment"><div>01301 {
01302     <a class="code" href="../../d2/d6/fntsweep_8c.html#a30">vLoadT1Fonts</a>(vAddLocalType1Font);
01303 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="fntsweep.c::vLoadRemoteT1Fonts" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID vLoadRemoteT1Fonts           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01305">1305</a> of file <a class="el" href="../../d3/d5/fntsweep_8c-source.html">fntsweep.c</a>.
<p>
References <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00531">vAddRemoteType1Font()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01277">vLoadT1Fonts()</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
<pre class="fragment"><div>01306 {
01307     <a class="code" href="../../d2/d6/fntsweep_8c.html#a30">vLoadT1Fonts</a>(vAddRemoteType1Font);
01308 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="fntsweep.c::vLoadT1Fonts" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID vLoadT1Fonts           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d6/fntsweep_8c.html#a14">PFNENTRY</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pfnProcessFontEntry</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01277">1277</a> of file <a class="el" href="../../d3/d5/fntsweep_8c-source.html">fntsweep.c</a>.
<p>
References <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00818">bLoadableFontDrivers()</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00038">gpwcSystemDir</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00026">pwszSweepType1Key</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00025">pwszType1Key</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, and <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00577">vSweepFonts()</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01300">vLoadLocalT1Fonts()</a>, and <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01305">vLoadRemoteT1Fonts()</a>.
<p>
<pre class="fragment"><div>01278 {
01279 
01280     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6/fntsweep_8c.html#a25">bLoadableFontDrivers</a>())
01281     {
01282 <span class="preprocessor">    #if DBGSWEEP</span>
01283 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"vLoadT1Fonts(0x%lx) was called\n"</span>, pfnProcessFontEntry);
01284 <span class="preprocessor">    #endif</span>
01285 <span class="preprocessor"></span>    <span class="comment">// now enum and add remote type1 fonts if any</span>
01286 
01287         <a class="code" href="../../d2/d6/fntsweep_8c.html#a24">vSweepFonts</a>(pwszType1Key, pwszSweepType1Key, pfnProcessFontEntry, TRUE);
01288 
01289     <span class="comment">// if the routines above initialized %windir%\system</span>
01290     <span class="comment">// and %windir%\fonts directories. Free the memory associated with this</span>
01291 
01292         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6/fntsweep_8c.html#a11">gpwcSystemDir</a>)
01293         {
01294             LocalFree(gpwcSystemDir);
01295             <a class="code" href="../../d2/d6/fntsweep_8c.html#a11">gpwcSystemDir</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01296         }
01297     }
01298 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="fntsweep.c::vMoveFileFromSystemToFontsDir" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID vMoveFileFromSystemToFontsDir           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">WCHAR *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pwcFile</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00360">360</a> of file <a class="el" href="../../d3/d5/fntsweep_8c-source.html">fntsweep.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00039">gpwcFontsDir</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d4/d8/arcinst_8c-source.html#l00065">MAX_PATH</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00450">vProcessType1FontEntry()</a>.
<p>
<pre class="fragment"><div>00361 {
00362     WCHAR awcTmpBuf[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00363     WCHAR awcTmp[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00364     FLONG fl;
00365     WCHAR *pwcTmp;
00366 
00367 <span class="preprocessor">#if DBG</span>
00368 <span class="preprocessor"></span>    <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  bOk;
00369 <span class="preprocessor">#endif</span>
00370 <span class="preprocessor"></span>
00371     <span class="keywordflow">if</span> (bMakePathNameW(awcTmp, pwcFile,NULL, &amp;fl))
00372     {
00373     <span class="comment">// If the font is in the system subdirectory we will just move it</span>
00374     <span class="comment">// to the fonts subdirectory. The path in the registry is relative</span>
00375     <span class="comment">// and we will leave it alone.</span>
00376 
00377         <span class="keywordflow">if</span>
00378         (
00379             (fl &amp; (FONT_IN_SYSTEM_DIR | FONT_RELATIVE_PATH)) ==
00380             (FONT_IN_SYSTEM_DIR | FONT_RELATIVE_PATH)
00381         )
00382         {
00383         <span class="comment">// find the bare file part, this is what will be written</span>
00384         <span class="comment">// in the registry</span>
00385 
00386             pwcTmp = &amp;awcTmp[wcslen(awcTmp) - 1];
00387             <span class="keywordflow">while</span> ((pwcTmp &gt;= awcTmp) &amp;&amp; (*pwcTmp != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>) &amp;&amp; (*pwcTmp != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">':'</span>))
00388                 pwcTmp--;
00389 
00390             <span class="keywordflow">if</span> (pwcTmp &gt; awcTmp)
00391                 pwcTmp++;
00392 
00393         <span class="comment">// need to move the font to fonts dir, can reuse the</span>
00394         <span class="comment">// buffer on the stack to build the full destination path</span>
00395 
00396             wcscpy(awcTmpBuf, gpwcFontsDir);
00397             lstrcatW(awcTmpBuf, L<span class="stringliteral">"\\"</span>);
00398             lstrcatW(awcTmpBuf, pwcTmp);
00399 
00400         <span class="comment">// note that MoveFile should succeed, for if there was</span>
00401         <span class="comment">// a font file of the same file name in %windir%\fonts dir</span>
00402         <span class="comment">// we would not have been in this code path.</span>
00403 
00404 <span class="preprocessor">            #if DBG</span>
00405 <span class="preprocessor"></span>                bOk =
00406 <span class="preprocessor">            #endif</span>
00407 <span class="preprocessor"></span>                MoveFileW(awcTmp, awcTmpBuf);
00408 
00409             RIPMSG3(RIP_VERBOSE,
00410                     <span class="stringliteral">"move %ws to %ws %s"</span>,
00411                     awcTmp,
00412                     awcTmpBuf,
00413                     (bOk) ? <span class="stringliteral">"succeeded"</span> : <span class="stringliteral">"failed"</span>);
00414         }
00415 <span class="preprocessor">        #if DBG</span>
00416 <span class="preprocessor"></span>        <span class="keywordflow">else</span>
00417         {
00418             RIPMSG2(RIP_WARNING,
00419                     <span class="stringliteral">"File %ws not in system directory, fl = 0x%lx\n"</span>,
00420                     awcTmp, fl);
00421         }
00422 <span class="preprocessor">        #endif</span>
00423 <span class="preprocessor"></span>
00424     }
00425 <span class="preprocessor">    #if DBG</span>
00426 <span class="preprocessor"></span>    <span class="keywordflow">else</span>
00427     {
00428         RIPMSG1(RIP_WARNING, <span class="stringliteral">"Could not locate %ws"</span>, pwcFile);
00429     }
00430 <span class="preprocessor">    #endif</span>
00431 <span class="preprocessor"></span>}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="fntsweep.c::vNullTermWideString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID vNullTermWideString           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">WCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>pwcDest</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>pwcSrc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ulLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00089">89</a> of file <a class="el" href="../../d3/d5/fntsweep_8c-source.html">fntsweep.c</a>.
<p>
References <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00882">bCheckAndDeleteTTF()</a>, and <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00138">vProcessFontEntry()</a>.
<p>
<pre class="fragment"><div>00090 {
00091     ULONG index;
00092 
00093     <span class="keywordflow">for</span> (index = 0; index &lt; ulLength; index++) {
00094         *pwcDest++ = *pwcSrc++;
00095     }
00096     *pwcDest = <span class="charliteral">'\0'</span>;
00097 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="fntsweep.c::vProcessFontEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID vProcessFontEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HKEY&nbsp;</td>
          <td class="mdname" nowrap> <em>hkey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>pwcValueName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ulValueNameLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>pwcFileName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ulFileNameLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00138">138</a> of file <a class="el" href="../../d3/d5/fntsweep_8c-source.html">fntsweep.c</a>.
<p>
References <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00112">bCheckFontEntry()</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00135">EXT_FOT</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00134">EXT_TRUETYPE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00040">gbWin31Upgrade</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00039">gpwcFontsDir</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d4/d8/arcinst_8c-source.html#l00065">MAX_PATH</a>, <a class="el" href="../../d6/d3/acpitabl_8h-source.html#l00366">min</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00089">vNullTermWideString()</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01237">vFontSweep()</a>.
<p>
<pre class="fragment"><div>00145 {
00146     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00147     UNICODE_STRING UnicodeString;
00148     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  bFot = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00149     WCHAR awcTTF[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00150     WCHAR awcTmpBuf[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00151     WCHAR *pwcTTF;
00152     FLONG fl, fl2;
00153     FLONG flEmbed;
00154     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwPidTid;
00155     WCHAR awcValueName[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];  <span class="comment">// null-terminated pwcValueName</span>
00156     WCHAR awcFileName[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];   <span class="comment">// null-terminated pwcFileName</span>
00157     
00158 
00159     <span class="comment">// Make sure the ValueName is null-terminated</span>
00160     ulValueNameLength = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(MAX_PATH - 1, ulValueNameLength);
00161     <a class="code" href="../../d2/d6/fntsweep_8c.html#a16">vNullTermWideString</a> (awcValueName, pwcValueName, ulValueNameLength);
00162     
00163     <span class="comment">// Make sure the FileName is null-terminated</span>
00164     ulFileNameLength = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(MAX_PATH - 1, ulFileNameLength);
00165     <a class="code" href="../../d2/d6/fntsweep_8c.html#a16">vNullTermWideString</a> (awcFileName, pwcFileName, ulFileNameLength);
00166     
00167     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6/fntsweep_8c.html#a17">bCheckFontEntry</a>(awcValueName, EXT_TRUETYPE))
00168     {
00169     <span class="comment">// This is a tt entry, either .fot or .ttf</span>
00170 
00171         <span class="keywordflow">if</span> (bFot = <a class="code" href="../../d2/d6/fntsweep_8c.html#a17">bCheckFontEntry</a>(awcFileName, EXT_FOT))
00172         {
00173         <span class="comment">// this is an .fot entry, must find ttf pointed to by .fot,</span>
00174         <span class="comment">// but first must get the full path to the .fot file</span>
00175         <span class="comment">// for cGetTTFFromFOT routine expects it. We will also need</span>
00176         <span class="comment">// the full path to the .fot file so that we can delete it</span>
00177         <span class="comment">// eventually.</span>
00178 
00179             <span class="keywordflow">if</span> (bMakePathNameW(awcTmpBuf, awcFileName, NULL, &amp;fl2))
00180             {
00181                 <span class="keywordflow">if</span> (cGetTTFFromFOT(awcTmpBuf, MAX_PATH, awcTTF, &amp;fl, &amp;flEmbed, &amp;dwPidTid, TRUE) &amp;&amp;
00182                     !(fl &amp; FONT_ISNOT_FOT))
00183                 {
00184                 <span class="comment">// fix the entry to point to .ttf file. At this point</span>
00185                 <span class="comment">// awcTTF points to the FULL path to the .ttf file.</span>
00186                 <span class="comment">// However, we will only need a relative path to the</span>
00187                 <span class="comment">// .ttf file, when the .ttf file is in the %windir%\system</span>
00188                 <span class="comment">// or %windir%\fonts directories. In case the file is in the</span>
00189                 <span class="comment">// %windir%\system directory we shall copy it to %windir%\fonts</span>
00190                 <span class="comment">// directory and write the relative path to the registry.</span>
00191                 <span class="comment">// In case it is in the %windir%\fonts directory we do not</span>
00192                 <span class="comment">// touch the file and also just write the relative path to the</span>
00193                 <span class="comment">// registry. In any other case we just write the full .ttf</span>
00194                 <span class="comment">// path to the registry.</span>
00195 
00196                 <span class="comment">// first delete the .fot file, it is no longer needed</span>
00197 
00198                     <span class="keywordflow">if</span> (bFot &amp;&amp; !<a class="code" href="../../d2/d6/fntsweep_8c.html#a13">gbWin31Upgrade</a>)
00199                     {
00200                         UserVerify(DeleteFileW(awcTmpBuf));
00201                     }
00202 
00203                     <span class="keywordflow">if</span> ((fl &amp; (FONT_IN_FONTS_DIR | FONT_IN_SYSTEM_DIR)) == 0)
00204                     {
00205                     <span class="comment">// if ttf file is not in either the system or the fonts</span>
00206                     <span class="comment">// directories, just write the full path to the registry</span>
00207 
00208                         pwcTTF = awcTTF;
00209                     }
00210                     <span class="keywordflow">else</span>
00211                     {
00212                     <span class="comment">// find the bare file part, this is what will be written</span>
00213                     <span class="comment">// in the registry</span>
00214 
00215                         pwcTTF = &amp;awcTTF[wcslen(awcTTF) - 1];
00216                         <span class="keywordflow">while</span> ((pwcTTF &gt;= awcTTF) &amp;&amp; (*pwcTTF != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>) &amp;&amp; (*pwcTTF != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">':'</span>))
00217                             pwcTTF--;
00218                         pwcTTF++;
00219 
00220                         <span class="keywordflow">if</span> (fl &amp; FONT_IN_SYSTEM_DIR)
00221                         {
00222                         <span class="comment">// need to move the ttf to fonts dir, can reuse the</span>
00223                         <span class="comment">// buffer on the stack:</span>
00224 
00225                             wcscpy(awcTmpBuf, gpwcFontsDir);
00226                             lstrcatW(awcTmpBuf, L<span class="stringliteral">"\\"</span>);
00227                             lstrcatW(awcTmpBuf, pwcTTF);
00228 
00229                         <span class="comment">// note that MoveFile should succeed, for if there was</span>
00230                         <span class="comment">// a ttf file of the same file name in %windir%\fonts dir</span>
00231                         <span class="comment">// we would not have been in this code path.</span>
00232 
00233                                 RIPMSG2(RIP_VERBOSE, <span class="stringliteral">"Moving %ws to %ws"</span>, awcTTF, awcTmpBuf);
00234                                 <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d6/fntsweep_8c.html#a13">gbWin31Upgrade</a>)
00235                                 {
00236                                     UserVerify(MoveFileW(awcTTF, awcTmpBuf));
00237                                 }
00238                                 <span class="keywordflow">else</span>
00239                                 {
00240                                 <span class="comment">// Boolean value TRUE means "do not copy if target exists"</span>
00241 
00242                                     UserVerify(CopyFileW(awcTTF, awcTmpBuf, TRUE));
00243                                 }
00244                         }
00245                     }
00246 
00247                     RIPMSG2(RIP_VERBOSE, <span class="stringliteral">"writing to the registry:\n    %ws=%ws"</span>, pwcValueName, pwcTTF);
00248                     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, awcValueName);
00249                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(hkey,
00250                                            &amp;UnicodeString,
00251                                            0,
00252                                            REG_SZ,
00253                                            pwcTTF,
00254                                            (wcslen(pwcTTF)+1) * <span class="keyword">sizeof</span>(WCHAR));
00255                     UserAssert(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
00256                 }
00257 <span class="preprocessor">                #if DBG</span>
00258 <span class="preprocessor"></span>                <span class="keywordflow">else</span>
00259                 {
00260                     RIPMSG1(RIP_WARNING, <span class="stringliteral">"Could not locate ttf pointed to by %ws"</span>, awcTmpBuf);
00261                 }
00262 <span class="preprocessor">                #endif</span>
00263 <span class="preprocessor"></span>            }
00264 <span class="preprocessor">            #if DBG</span>
00265 <span class="preprocessor"></span>            <span class="keywordflow">else</span>
00266             {
00267                 RIPMSG1(RIP_WARNING, <span class="stringliteral">"Could not locate .fot:  %ws"</span>, awcFileName);
00268             }
00269 <span class="preprocessor">            #endif</span>
00270 <span class="preprocessor"></span>        }
00271     }
00272     <span class="keywordflow">else</span>
00273     {
00274     <span class="comment">// not a true type case. little bit simpler,</span>
00275     <span class="comment">// we will use awcTTF buffer for the full path name, and pwcTTF</span>
00276     <span class="comment">// as local variable even though these TTF names are misnomer</span>
00277     <span class="comment">// for these are not tt fonts</span>
00278 
00279         <span class="keywordflow">if</span> (bMakePathNameW(awcTTF, awcFileName,NULL, &amp;fl))
00280         {
00281         <span class="comment">// At this point</span>
00282         <span class="comment">// awcTTF points to the FULL path to the font file.</span>
00283 
00284         <span class="comment">// If the font is in the system subdirectory we will just move it</span>
00285         <span class="comment">// to the fonts subdirectory. If the path in the registry is relative</span>
00286         <span class="comment">// we will leave it alone. If it is an absolute path, we shall</span>
00287         <span class="comment">// fix the registry entry to only contain relative path, the</span>
00288         <span class="comment">// absolute path is redundant.</span>
00289 
00290             <span class="keywordflow">if</span> (fl &amp; (FONT_IN_SYSTEM_DIR | FONT_IN_FONTS_DIR))
00291             {
00292             <span class="comment">// find the bare file part, this is what will be written</span>
00293             <span class="comment">// in the registry</span>
00294 
00295                 pwcTTF = &amp;awcTTF[wcslen(awcTTF) - 1];
00296                 <span class="keywordflow">while</span> ((pwcTTF &gt;= awcTTF) &amp;&amp; (*pwcTTF != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>) &amp;&amp; (*pwcTTF != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">':'</span>))
00297                     pwcTTF--;
00298                 pwcTTF++;
00299 
00300                 <span class="keywordflow">if</span> (fl &amp; FONT_IN_SYSTEM_DIR)
00301                 {
00302                 <span class="comment">// need to move the font to fonts dir, can reuse the</span>
00303                 <span class="comment">// buffer on the stack to build the full destination path</span>
00304 
00305                     wcscpy(awcTmpBuf, gpwcFontsDir);
00306                     lstrcatW(awcTmpBuf, L<span class="stringliteral">"\\"</span>);
00307                     lstrcatW(awcTmpBuf, pwcTTF);
00308 
00309                 <span class="comment">// note that MoveFile should succeed, for if there was</span>
00310                 <span class="comment">// a font file of the same file name in %windir%\fonts dir</span>
00311                 <span class="comment">// we would not have been in this code path. The only time</span>
00312                 <span class="comment">// it could fail if the path in the registry is absolute.</span>
00313 
00314                     RIPMSG2(RIP_VERBOSE, <span class="stringliteral">"Moving %ws to %ws"</span>, awcTTF, awcTmpBuf);
00315                     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d6/fntsweep_8c.html#a13">gbWin31Upgrade</a>)
00316                     {
00317                         UserVerify(MoveFileW(awcTTF, awcTmpBuf));
00318                     }
00319                     <span class="keywordflow">else</span>
00320                     {
00321                     <span class="comment">// Boolean value TRUE means "do not copy if target exists"</span>
00322 
00323                         UserVerify(CopyFileW(awcTTF, awcTmpBuf, TRUE));
00324                     }
00325                 }
00326 
00327             <span class="comment">// check if the file path in the registry is absolute,</span>
00328             <span class="comment">// if so make it relative:</span>
00329 
00330                 <span class="keywordflow">if</span> (!(fl &amp; FONT_RELATIVE_PATH))
00331                 {
00332                     RIPMSG2(RIP_VERBOSE, <span class="stringliteral">"writing to the registry:\n    %ws=%ws"</span>, pwcValueName, pwcTTF);
00333                     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, awcValueName);
00334                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(hkey,
00335                                            &amp;UnicodeString,
00336                                            0,
00337                                            REG_SZ,
00338                                            pwcTTF,
00339                                            (wcslen(pwcTTF)+1) * <span class="keyword">sizeof</span>(WCHAR));
00340                     UserAssert(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
00341                 }
00342             }
00343         }
00344     }
00345 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="fntsweep.c::vProcessType1FontEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID vProcessType1FontEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HKEY&nbsp;</td>
          <td class="mdname" nowrap> <em>hkey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>pwcValueName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ulValueNameLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>pwcValueData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ulValueDataLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00450">450</a> of file <a class="el" href="../../d3/d5/fntsweep_8c-source.html">fntsweep.c</a>.
<p>
References <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00360">vMoveFileFromSystemToFontsDir()</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01237">vFontSweep()</a>.
<p>
<pre class="fragment"><div>00457 {
00458     WCHAR *pwcPFM, *pwcPFB;
00459 
00460     UNREFERENCED_PARAMETER(hkey);
00461     UNREFERENCED_PARAMETER(pwcValueName);
00462     UNREFERENCED_PARAMETER(ulValueNameLength);
00463     UNREFERENCED_PARAMETER(ulValueDataLength);
00464 
00465 <span class="comment">// skip unused boolean value in this multi reg_sz string:</span>
00466 
00467     <span class="keywordflow">if</span> ((pwcValueData[0] != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>) &amp;&amp; (pwcValueData[1] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>))
00468     {
00469         pwcPFM = &amp;pwcValueData[2];
00470         pwcPFB = pwcPFM + wcslen(pwcPFM) + 1; <span class="comment">// add 1 for zero separator</span>
00471 
00472         <a class="code" href="../../d2/d6/fntsweep_8c.html#a19">vMoveFileFromSystemToFontsDir</a>(pwcPFM);
00473         <a class="code" href="../../d2/d6/fntsweep_8c.html#a19">vMoveFileFromSystemToFontsDir</a>(pwcPFB);
00474     }
00475 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="fntsweep.c::vSweepFonts" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID vSweepFonts           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PCWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>pwszFontListKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PCWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>pwszFontSweepKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d6/fntsweep_8c.html#a14">PFNENTRY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pfnProcessFontEntry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>bForceEnum</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00577">577</a> of file <a class="el" href="../../d3/d5/fntsweep_8c-source.html">fntsweep.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">BYTE</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00036">DWORDALIGN</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00039">gpwcFontsDir</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00038">gpwcSystemDir</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00033">LAST_SWEEP_TIME</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00166">NtCreateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00756">NtEnumerateValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02018">NtQueryKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00958">UserLocalAlloc</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00960">UserLocalFree</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01237">vFontSweep()</a>, and <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01277">vLoadT1Fonts()</a>.
<p>
<pre class="fragment"><div>00583 {
00584     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>      cjMaxValueName;
00585     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>      iFont;
00586     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>   <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00587     UNICODE_STRING UnicodeString;
00588     OBJECT_ATTRIBUTES ObjA;
00589     KEY_FULL_INFORMATION KeyInfo;
00590     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>      dwReturnLength;
00591 
00592     PKEY_VALUE_FULL_INFORMATION KeyValueInfo;
00593     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>       *pjValueData;
00594 
00595     HKEY       hkey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00596     <span class="keyword">struct </span>{
00597         KEY_VALUE_PARTIAL_INFORMATION;
00598         LARGE_INTEGER;
00599     } SweepValueInfo;
00600     LARGE_INTEGER LastSweepTime;
00601     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>       bSweep = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00602 
00603     HKEY       hkeyLastSweep;
00604     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>      cjData;
00605 
00606     <span class="keywordflow">if</span> (!bForceEnum)
00607     {
00608     <span class="comment">// first check if anything needs to be done, that is, if anybody</span>
00609     <span class="comment">// touched the [Fonts] section of the registry since the last time we sweeped it.</span>
00610     <span class="comment">// get the time of the last sweep of the fonts section of the registry:</span>
00611 
00612         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, pwszFontSweepKey);
00613         InitializeObjectAttributes(&amp;ObjA,
00614                                    &amp;UnicodeString,
00615                                    OBJ_CASE_INSENSITIVE,
00616                                    NULL,
00617                                    NULL);
00618         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;hkeyLastSweep,
00619                            KEY_READ | KEY_WRITE,
00620                            &amp;ObjA);
00621 
00622         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
00623         {
00624             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  dwDisposition;
00625 
00626         <span class="comment">// We are running for the first time, we need to create the key</span>
00627         <span class="comment">// for it does not exist as yet at this time</span>
00628 
00629             bSweep = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00630 
00631         <span class="comment">// Create the key, open it for writing, since we will have to</span>
00632         <span class="comment">// store the time when the [Fonts] section of the registry was last swept</span>
00633 
00634             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(&amp;hkeyLastSweep,
00635                                  KEY_WRITE,
00636                                  &amp;ObjA,
00637                                  0,
00638                                  NULL,
00639                                  REG_OPTION_NON_VOLATILE,
00640                                  &amp;dwDisposition);
00641 
00642             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
00643                 <span class="keywordflow">return</span>;
00644         }
00645         <span class="keywordflow">else</span>
00646         {
00647             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, LAST_SWEEP_TIME);
00648             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(hkeyLastSweep,
00649                                      &amp;UnicodeString,
00650                                      KeyValuePartialInformation,
00651                                      &amp;SweepValueInfo,
00652                                      <span class="keyword">sizeof</span>(SweepValueInfo),
00653                                      &amp;dwReturnLength);
00654             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
00655             {
00656                 bSweep = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>; <span class="comment">// force sweep, something is suspicious</span>
00657             }
00658             <span class="keywordflow">else</span>
00659             {
00660                 UserAssert(SweepValueInfo.Type == REG_BINARY);
00661                 UserAssert(SweepValueInfo.DataLength == <span class="keyword">sizeof</span>(LastSweepTime));
00662                 RtlCopyMemory(&amp;LastSweepTime, &amp;SweepValueInfo.Data, <span class="keyword">sizeof</span>(LastSweepTime));
00663             }
00664         }
00665     }
00666     <span class="keywordflow">else</span>
00667     {
00668         bSweep = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00669     }
00670 
00671 <span class="comment">// now open the Fonts key and get the time the key last changed:</span>
00672 <span class="comment">// now get the time of the time of the last change is bigger than</span>
00673 <span class="comment">// the time of last sweep, must sweep again:</span>
00674 
00675     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, pwszFontListKey);
00676     InitializeObjectAttributes(&amp;ObjA,
00677                                &amp;UnicodeString,
00678                                OBJ_CASE_INSENSITIVE,
00679                                NULL,
00680                                NULL);
00681     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;hkey,
00682                        KEY_READ | KEY_WRITE,
00683                        &amp;ObjA);
00684 
00685     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
00686     {
00687     <span class="comment">// get the number of entries in the [Fonts] section</span>
00688 
00689         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a24">NtQueryKey</a>(hkey,
00690                     KeyFullInformation,
00691                     &amp;KeyInfo,
00692                     <span class="keyword">sizeof</span>(KeyInfo),
00693                     &amp;dwReturnLength);
00694 
00695         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) &amp;&amp; KeyInfo.Values)
00696         {
00697             UserAssert(!(KeyInfo.ClassLength | KeyInfo.SubKeys | KeyInfo.MaxNameLen | KeyInfo.MaxClassLen));
00698 
00699         <span class="comment">// now let us check if the fonts need to be sweeped. This is the case</span>
00700         <span class="comment">// when the registry last write time is bigger than the last sweep time</span>
00701 
00702             <span class="keywordflow">if</span> (!bSweep)
00703             {
00704                 <span class="keywordflow">if</span> (KeyInfo.LastWriteTime.QuadPart != LastSweepTime.QuadPart ) {
00705                     bSweep = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00706                 }
00707             }
00708 
00709         <span class="comment">// init system dir, we will need it:</span>
00710 
00711             <span class="keywordflow">if</span> (bSweep &amp;&amp;
00712                 bInitSystemAndFontsDirectoriesW(&amp;gpwcSystemDir, &amp;gpwcFontsDir))
00713             {
00714             <span class="comment">// alloc buffer big enough to hold the biggest ValueName and ValueData</span>
00715 
00716                 cjMaxValueName = <a class="code" href="../../d2/d6/fntsweep_8c.html#a2">DWORDALIGN</a>(KeyInfo.MaxValueNameLen + <span class="keyword">sizeof</span>(WCHAR));
00717 
00718             <span class="comment">// allocate temporary buffer into which we are going to suck the contents</span>
00719             <span class="comment">// of the registry</span>
00720 
00721                 KeyInfo.MaxValueDataLen = <a class="code" href="../../d2/d6/fntsweep_8c.html#a2">DWORDALIGN</a>(KeyInfo.MaxValueDataLen);
00722                 cjData = cjMaxValueName +    <span class="comment">// space for the value name</span>
00723                          KeyInfo.MaxValueDataLen ;    <span class="comment">// space for the value data</span>
00724 
00725                 <span class="keywordflow">if</span> (KeyValueInfo = <a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(0, <span class="keyword">sizeof</span>(*KeyValueInfo) + cjData))
00726                 {
00727                     <span class="keywordflow">for</span> (iFont = 0; iFont &lt; KeyInfo.Values; iFont++)
00728                     {
00729                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a18">NtEnumerateValueKey</a>(
00730                                     hkey,
00731                                     iFont,
00732                                     KeyValueFullInformation,
00733                                     KeyValueInfo,
00734                                     <span class="keyword">sizeof</span>(*KeyValueInfo) + cjData,
00735                                     &amp;dwReturnLength);
00736 
00737                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
00738                         {
00739                             UserAssert(KeyValueInfo-&gt;NameLength &lt;= KeyInfo.MaxValueNameLen);
00740                             UserAssert(KeyValueInfo-&gt;DataLength &lt;= KeyInfo.MaxValueDataLen);
00741                             UserAssert((KeyValueInfo-&gt;Type == REG_SZ) || (KeyValueInfo-&gt;Type == REG_MULTI_SZ));
00742 
00743                         <span class="comment">// data goes into the second half of the buffer</span>
00744 
00745                             pjValueData = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *)KeyValueInfo + KeyValueInfo-&gt;DataOffset;
00746 
00747                         <span class="comment">// see if the font files are where the registry claims they are.</span>
00748                         <span class="comment">// It is unfortunate we have to do this because SearchPathW</span>
00749                         <span class="comment">// is slow because it touches the disk.</span>
00750 
00751                             (*pfnProcessFontEntry)(hkey,
00752                                                    KeyValueInfo-&gt;Name,
00753                                                    KeyValueInfo-&gt;NameLength / <span class="keyword">sizeof</span>(WCHAR),
00754                                                    (WCHAR *)pjValueData,
00755                                                    KeyValueInfo-&gt;DataLength / <span class="keyword">sizeof</span>(WCHAR));
00756                         }
00757                     }
00758 
00759                     <span class="keywordflow">if</span> (!bForceEnum)
00760                     {
00761                     <span class="comment">// now that the sweep is completed, get the last write time</span>
00762                     <span class="comment">// and store it as the LastSweepTime at the appropriate location</span>
00763 
00764                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a24">NtQueryKey</a>(hkey,
00765                                     KeyFullInformation,
00766                                     &amp;KeyInfo,
00767                                     <span class="keyword">sizeof</span>(KeyInfo),
00768                                     &amp;dwReturnLength);
00769                         UserAssert(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
00770 
00771                     <span class="comment">// now remember the result</span>
00772 
00773                         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, LAST_SWEEP_TIME);
00774                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(hkeyLastSweep,
00775                                                &amp;UnicodeString,
00776                                                0,
00777                                                REG_BINARY,
00778                                                &amp;KeyInfo.LastWriteTime,
00779                                                <span class="keyword">sizeof</span>(KeyInfo.LastWriteTime));
00780                         UserAssert(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
00781                     }
00782 
00783                 <span class="comment">// free the memory that will be no longer needed</span>
00784 
00785                     <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(KeyValueInfo);
00786                 }
00787             }
00788         }
00789         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hkey);
00790     }
00791 
00792     <span class="keywordflow">if</span> (!bForceEnum)
00793     {
00794         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hkeyLastSweep);
00795     }
00796 }
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a13" doxytag="fntsweep.c::gbWin31Upgrade" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL <a class="el" href="../../d2/d6/fntsweep_8c.html#a13">gbWin31Upgrade</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00040">40</a> of file <a class="el" href="../../d3/d5/fntsweep_8c-source.html">fntsweep.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01237">vFontSweep()</a>, and <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00138">vProcessFontEntry()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="fntsweep.c::gpwcFontsDir" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> WCHAR* <a class="el" href="../../d2/d6/fntsweep_8c.html#a12">gpwcFontsDir</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00039">39</a> of file <a class="el" href="../../d3/d5/fntsweep_8c-source.html">fntsweep.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00360">vMoveFileFromSystemToFontsDir()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00138">vProcessFontEntry()</a>, and <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00577">vSweepFonts()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="fntsweep.c::gpwcSystemDir" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> WCHAR* <a class="el" href="../../d2/d6/fntsweep_8c.html#a11">gpwcSystemDir</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00038">38</a> of file <a class="el" href="../../d3/d5/fntsweep_8c-source.html">fntsweep.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01237">vFontSweep()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01277">vLoadT1Fonts()</a>, and <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00577">vSweepFonts()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="fntsweep.c::pwszFontDrivers" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> CONST WCHAR <a class="el" href="../../d2/d6/fntsweep_8c.html#a10">pwszFontDrivers</a>[] = L"\\Registry\\Machine\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Font Drivers"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00031">31</a> of file <a class="el" href="../../d3/d5/fntsweep_8c-source.html">fntsweep.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00818">bLoadableFontDrivers()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="fntsweep.c::pwszFontsKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> CONST WCHAR <a class="el" href="../../d2/d6/fntsweep_8c.html#a8">pwszFontsKey</a>[] = L"\\Registry\\Machine\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Fonts"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00029">29</a> of file <a class="el" href="../../d3/d5/fntsweep_8c-source.html">fntsweep.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00996">bCleanConvertedTTFs()</a>, and <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01237">vFontSweep()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="fntsweep.c::pwszSweepKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> CONST WCHAR <a class="el" href="../../d2/d6/fntsweep_8c.html#a9">pwszSweepKey</a>[] = L"\\Registry\\Machine\\Software\\Microsoft\\Windows NT\\CurrentVersion\\LastFontSweep"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00030">30</a> of file <a class="el" href="../../d3/d5/fntsweep_8c-source.html">fntsweep.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01237">vFontSweep()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="fntsweep.c::pwszSweepType1Key" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> CONST WCHAR <a class="el" href="../../d2/d6/fntsweep_8c.html#a6">pwszSweepType1Key</a>[] = L"\\Registry\\Machine\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Type 1 Installer\\LastType1Sweep"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00026">26</a> of file <a class="el" href="../../d3/d5/fntsweep_8c-source.html">fntsweep.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01237">vFontSweep()</a>, and <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01277">vLoadT1Fonts()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="fntsweep.c::pwszType1Key" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> CONST WCHAR <a class="el" href="../../d2/d6/fntsweep_8c.html#a5">pwszType1Key</a>[] = L"\\Registry\\Machine\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Type 1 Installer\\Type 1 Fonts"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00025">25</a> of file <a class="el" href="../../d3/d5/fntsweep_8c-source.html">fntsweep.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00996">bCleanConvertedTTFs()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01237">vFontSweep()</a>, and <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01277">vLoadT1Fonts()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="fntsweep.c::pwszUpdType1Key" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> CONST WCHAR <a class="el" href="../../d2/d6/fntsweep_8c.html#a7">pwszUpdType1Key</a>[] = L"\\Registry\\Machine\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Type 1 Installer\\Upgraded Type1"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00027">27</a> of file <a class="el" href="../../d3/d5/fntsweep_8c-source.html">fntsweep.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01132">vCleanConvertedTTFs()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:44 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
