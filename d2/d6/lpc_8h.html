<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: lpc.h File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>lpc.h File Reference</h1>
<p>
<a href="../../d3/d5/lpc_8h-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d4/struct__LPCP__NONPAGED__PORT__QUEUE.html">_LPCP_NONPAGED_PORT_QUEUE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d5/struct__LPCP__PORT__QUEUE.html">_LPCP_PORT_QUEUE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d5/struct__LPCP__PORT__ZONE.html">_LPCP_PORT_ZONE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">_LPCP_PORT_OBJECT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d4/struct__LPCP__MESSAGE.html">_LPCP_MESSAGE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html">_LPCP_CONNECTION_MESSAGE</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/lpc_8h.html#a0">LPCP_ZONE_ALIGNMENT</a>&nbsp;&nbsp;&nbsp;16</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/lpc_8h.html#a1">LPCP_ZONE_ALIGNMENT_MASK</a>&nbsp;&nbsp;&nbsp;~(LPCP_ZONE_ALIGNMENT-1)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/lpc_8h.html#a2">LPCP_ZONE_MAX_POOL_USAGE</a>&nbsp;&nbsp;&nbsp;(8*PAGE_SIZE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>&nbsp;&nbsp;&nbsp;0x0000000F</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/lpc_8h.html#a4">SERVER_CONNECTION_PORT</a>&nbsp;&nbsp;&nbsp;0x00000001</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/lpc_8h.html#a5">UNCONNECTED_COMMUNICATION_PORT</a>&nbsp;&nbsp;&nbsp;0x00000002</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/lpc_8h.html#a6">SERVER_COMMUNICATION_PORT</a>&nbsp;&nbsp;&nbsp;0x00000003</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/lpc_8h.html#a7">CLIENT_COMMUNICATION_PORT</a>&nbsp;&nbsp;&nbsp;0x00000004</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/lpc_8h.html#a8">PORT_WAITABLE</a>&nbsp;&nbsp;&nbsp;0x20000000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/lpc_8h.html#a9">PORT_NAME_DELETED</a>&nbsp;&nbsp;&nbsp;0x40000000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/lpc_8h.html#a10">PORT_DYNAMIC_SECURITY</a>&nbsp;&nbsp;&nbsp;0x80000000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/lpc_8h.html#a11">PORT_DELETED</a>&nbsp;&nbsp;&nbsp;0x10000000</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d4/struct__LPCP__NONPAGED__PORT__QUEUE.html">_LPCP_NONPAGED_PORT_QUEUE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/lpc_8h.html#a15">LPCP_NONPAGED_PORT_QUEUE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d4/struct__LPCP__NONPAGED__PORT__QUEUE.html">_LPCP_NONPAGED_PORT_QUEUE</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/lpc_8h.html#a16">PLPCP_NONPAGED_PORT_QUEUE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d5/struct__LPCP__PORT__QUEUE.html">_LPCP_PORT_QUEUE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/lpc_8h.html#a17">LPCP_PORT_QUEUE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d5/struct__LPCP__PORT__QUEUE.html">_LPCP_PORT_QUEUE</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/lpc_8h.html#a18">PLPCP_PORT_QUEUE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d1/d5/struct__LPCP__PORT__ZONE.html">_LPCP_PORT_ZONE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/lpc_8h.html#a19">LPCP_PORT_ZONE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d1/d5/struct__LPCP__PORT__ZONE.html">_LPCP_PORT_ZONE</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/lpc_8h.html#a20">PLPCP_PORT_ZONE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">_LPCP_PORT_OBJECT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/lpc_8h.html#a21">LPCP_PORT_OBJECT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">_LPCP_PORT_OBJECT</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/lpc_8h.html#a22">PLPCP_PORT_OBJECT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d5/d4/struct__LPCP__MESSAGE.html">_LPCP_MESSAGE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/lpc_8h.html#a23">LPCP_MESSAGE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d5/d4/struct__LPCP__MESSAGE.html">_LPCP_MESSAGE</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/lpc_8h.html#a24">PLPCP_MESSAGE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html">_LPCP_CONNECTION_MESSAGE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/lpc_8h.html#a25">LPCP_CONNECTION_MESSAGE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html">_LPCP_CONNECTION_MESSAGE</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/lpc_8h.html#a26">PLPCP_CONNECTION_MESSAGE</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/lpc_8h.html#a27">LpcInitSystem</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/lpc_8h.html#a28">LpcExitThread</a> (<a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/lpc_8h.html#a29">LpcDumpThread</a> (<a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread, IN <a class="el" href="../../d0/d5/struct__OBJECT__DUMP__CONTROL.html">POB_DUMP_CONTROL</a> Control OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/lpc_8h.html#a30">LpcRequestPort</a> (IN PVOID PortAddress, IN PPORT_MESSAGE <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/lpc_8h.html#a31">LpcRequestWaitReplyPort</a> (IN PVOID PortAddress, IN PPORT_MESSAGE <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>, OUT PPORT_MESSAGE ReplyMessage)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/lpc_8h.html#a12">LpcCallOperationCount</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/lpc_8h.html#a13">LpcCallBackOperationCount</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/lpc_8h.html#a14">LpcDatagramOperationCount</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a7" doxytag="lpc.h::CLIENT_COMMUNICATION_PORT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CLIENT_COMMUNICATION_PORT&nbsp;&nbsp;&nbsp;0x00000004          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/lpc_8h-source.html#l00134">134</a> of file <a class="el" href="../../d3/d5/lpc_8h-source.html">lpc.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/lpcclose_8c-source.html#l00110">LpcpDeletePort()</a>, <a class="el" href="../../d2/d6/lpcpriv_8c-source.html#l00296">LpcpFreePortClientSecurity()</a>, <a class="el" href="../../d7/d6/lpcsend_8c-source.html#l01181">LpcRequestPort()</a>, <a class="el" href="../../d7/d6/lpcsend_8c-source.html#l01407">LpcRequestWaitReplyPort()</a>, <a class="el" href="../../d5/d6/lpcrecv_8c-source.html#l00029">NtReplyWaitReceivePort()</a>, <a class="el" href="../../d5/d6/lpcrecv_8c-source.html#l00635">NtReplyWaitReceivePortEx()</a>, <a class="el" href="../../d7/d6/lpcsend_8c-source.html#l00032">NtRequestPort()</a>, <a class="el" href="../../d7/d6/lpcsend_8c-source.html#l00395">NtRequestWaitReplyPort()</a>, and <a class="el" href="../../d6/d5/lpcconn_8c-source.html#l00084">NtSecureConnectPort()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="lpc.h::LPCP_ZONE_ALIGNMENT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LPCP_ZONE_ALIGNMENT&nbsp;&nbsp;&nbsp;16          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/lpc_8h-source.html#l00084">84</a> of file <a class="el" href="../../d3/d5/lpc_8h-source.html">lpc.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/lpcinit_8c-source.html#l00076">LpcInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="lpc.h::LPCP_ZONE_ALIGNMENT_MASK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LPCP_ZONE_ALIGNMENT_MASK&nbsp;&nbsp;&nbsp;~(LPCP_ZONE_ALIGNMENT-1)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/lpc_8h-source.html#l00085">85</a> of file <a class="el" href="../../d3/d5/lpc_8h-source.html">lpc.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/lpcinit_8c-source.html#l00076">LpcInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="lpc.h::LPCP_ZONE_MAX_POOL_USAGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LPCP_ZONE_MAX_POOL_USAGE&nbsp;&nbsp;&nbsp;(8*PAGE_SIZE)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/lpc_8h-source.html#l00091">91</a> of file <a class="el" href="../../d3/d5/lpc_8h-source.html">lpc.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/lpcinit_8c-source.html#l00076">LpcInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="lpc.h::PORT_DELETED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PORT_DELETED&nbsp;&nbsp;&nbsp;0x10000000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/lpc_8h-source.html#l00138">138</a> of file <a class="el" href="../../d3/d5/lpc_8h-source.html">lpc.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d6/lpcpriv_8c-source.html#l00032">NtImpersonateClientOfPort()</a>, <a class="el" href="../../d7/d6/lpcsend_8c-source.html#l00032">NtRequestPort()</a>, and <a class="el" href="../../d8/d0/obref_8c-source.html#l01124">ObfDereferenceObject()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="lpc.h::PORT_DYNAMIC_SECURITY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PORT_DYNAMIC_SECURITY&nbsp;&nbsp;&nbsp;0x80000000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/lpc_8h-source.html#l00137">137</a> of file <a class="el" href="../../d3/d5/lpc_8h-source.html">lpc.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d6/lpcpriv_8c-source.html#l00296">LpcpFreePortClientSecurity()</a>, <a class="el" href="../../d2/d6/lpcpriv_8c-source.html#l00032">NtImpersonateClientOfPort()</a>, and <a class="el" href="../../d6/d5/lpcconn_8c-source.html#l00084">NtSecureConnectPort()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="lpc.h::PORT_NAME_DELETED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PORT_NAME_DELETED&nbsp;&nbsp;&nbsp;0x40000000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/lpc_8h-source.html#l00136">136</a> of file <a class="el" href="../../d3/d5/lpc_8h-source.html">lpc.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00104">LpcpDestroyPortQueue()</a>, and <a class="el" href="../../d6/d5/lpcconn_8c-source.html#l00084">NtSecureConnectPort()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="lpc.h::PORT_TYPE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PORT_TYPE&nbsp;&nbsp;&nbsp;0x0000000F          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/lpc_8h-source.html#l00130">130</a> of file <a class="el" href="../../d3/d5/lpc_8h-source.html">lpc.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/lpcclose_8c-source.html#l00031">LpcpClosePort()</a>, <a class="el" href="../../d4/d5/lpcclose_8c-source.html#l00110">LpcpDeletePort()</a>, <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00104">LpcpDestroyPortQueue()</a>, <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00980">LpcpFindDataInfoMessage()</a>, <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00879">LpcpFreeDataInfoMessage()</a>, <a class="el" href="../../d2/d6/lpcpriv_8c-source.html#l00296">LpcpFreePortClientSecurity()</a>, <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00809">LpcpSaveDataInfoMessage()</a>, <a class="el" href="../../d7/d6/lpcsend_8c-source.html#l01181">LpcRequestPort()</a>, <a class="el" href="../../d7/d6/lpcsend_8c-source.html#l01407">LpcRequestWaitReplyPort()</a>, <a class="el" href="../../d5/d5/lpccompl_8c-source.html#l00836">NtCompleteConnectPort()</a>, <a class="el" href="../../d2/d6/lpcpriv_8c-source.html#l00032">NtImpersonateClientOfPort()</a>, <a class="el" href="../../d5/d6/lpcrecv_8c-source.html#l00029">NtReplyWaitReceivePort()</a>, <a class="el" href="../../d5/d6/lpcrecv_8c-source.html#l00635">NtReplyWaitReceivePortEx()</a>, <a class="el" href="../../d7/d6/lpcsend_8c-source.html#l00032">NtRequestPort()</a>, <a class="el" href="../../d7/d6/lpcsend_8c-source.html#l00395">NtRequestWaitReplyPort()</a>, and <a class="el" href="../../d6/d5/lpcconn_8c-source.html#l00084">NtSecureConnectPort()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="lpc.h::PORT_WAITABLE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PORT_WAITABLE&nbsp;&nbsp;&nbsp;0x20000000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/lpc_8h-source.html#l00135">135</a> of file <a class="el" href="../../d3/d5/lpc_8h-source.html">lpc.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/lpccreat_8c-source.html#l00136">LpcpCreatePort()</a>, <a class="el" href="../../d7/d6/lpcsend_8c-source.html#l01181">LpcRequestPort()</a>, <a class="el" href="../../d7/d6/lpcsend_8c-source.html#l01407">LpcRequestWaitReplyPort()</a>, <a class="el" href="../../d5/d6/lpcrecv_8c-source.html#l00029">NtReplyWaitReceivePort()</a>, <a class="el" href="../../d5/d6/lpcrecv_8c-source.html#l00635">NtReplyWaitReceivePortEx()</a>, <a class="el" href="../../d7/d6/lpcsend_8c-source.html#l00032">NtRequestPort()</a>, <a class="el" href="../../d7/d6/lpcsend_8c-source.html#l00395">NtRequestWaitReplyPort()</a>, and <a class="el" href="../../d6/d5/lpcconn_8c-source.html#l00084">NtSecureConnectPort()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="lpc.h::SERVER_COMMUNICATION_PORT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SERVER_COMMUNICATION_PORT&nbsp;&nbsp;&nbsp;0x00000003          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/lpc_8h-source.html#l00133">133</a> of file <a class="el" href="../../d3/d5/lpc_8h-source.html">lpc.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/lpcclose_8c-source.html#l00110">LpcpDeletePort()</a>, <a class="el" href="../../d7/d6/lpcsend_8c-source.html#l01181">LpcRequestPort()</a>, <a class="el" href="../../d7/d6/lpcsend_8c-source.html#l01407">LpcRequestWaitReplyPort()</a>, <a class="el" href="../../d5/d5/lpccompl_8c-source.html#l00040">NtAcceptConnectPort()</a>, <a class="el" href="../../d5/d5/lpccompl_8c-source.html#l00836">NtCompleteConnectPort()</a>, <a class="el" href="../../d2/d6/lpcpriv_8c-source.html#l00032">NtImpersonateClientOfPort()</a>, <a class="el" href="../../d7/d6/lpcsend_8c-source.html#l00032">NtRequestPort()</a>, and <a class="el" href="../../d7/d6/lpcsend_8c-source.html#l00395">NtRequestWaitReplyPort()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="lpc.h::SERVER_CONNECTION_PORT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SERVER_CONNECTION_PORT&nbsp;&nbsp;&nbsp;0x00000001          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/lpc_8h-source.html#l00131">131</a> of file <a class="el" href="../../d3/d5/lpc_8h-source.html">lpc.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/lpcclose_8c-source.html#l00031">LpcpClosePort()</a>, <a class="el" href="../../d7/d5/lpccreat_8c-source.html#l00136">LpcpCreatePort()</a>, <a class="el" href="../../d4/d5/lpcclose_8c-source.html#l00110">LpcpDeletePort()</a>, <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00104">LpcpDestroyPortQueue()</a>, <a class="el" href="../../d7/d6/lpcsend_8c-source.html#l01181">LpcRequestPort()</a>, <a class="el" href="../../d7/d6/lpcsend_8c-source.html#l01407">LpcRequestWaitReplyPort()</a>, <a class="el" href="../../d7/d6/lpcsend_8c-source.html#l00032">NtRequestPort()</a>, <a class="el" href="../../d7/d6/lpcsend_8c-source.html#l00395">NtRequestWaitReplyPort()</a>, and <a class="el" href="../../d6/d5/lpcconn_8c-source.html#l00084">NtSecureConnectPort()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="lpc.h::UNCONNECTED_COMMUNICATION_PORT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UNCONNECTED_COMMUNICATION_PORT&nbsp;&nbsp;&nbsp;0x00000002          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/lpc_8h-source.html#l00132">132</a> of file <a class="el" href="../../d3/d5/lpc_8h-source.html">lpc.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/lpccreat_8c-source.html#l00136">LpcpCreatePort()</a>, <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00980">LpcpFindDataInfoMessage()</a>, <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00879">LpcpFreeDataInfoMessage()</a>, and <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00809">LpcpSaveDataInfoMessage()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a25" doxytag="lpc.h::LPCP_CONNECTION_MESSAGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html">_LPCP_CONNECTION_MESSAGE</a>  <a class="el" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html">LPCP_CONNECTION_MESSAGE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="lpc.h::LPCP_MESSAGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d5/d4/struct__LPCP__MESSAGE.html">_LPCP_MESSAGE</a>  <a class="el" href="../../d5/d4/struct__LPCP__MESSAGE.html">LPCP_MESSAGE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="lpc.h::LPCP_NONPAGED_PORT_QUEUE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d4/struct__LPCP__NONPAGED__PORT__QUEUE.html">_LPCP_NONPAGED_PORT_QUEUE</a>  <a class="el" href="../../d8/d4/struct__LPCP__NONPAGED__PORT__QUEUE.html">LPCP_NONPAGED_PORT_QUEUE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="lpc.h::LPCP_PORT_OBJECT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">_LPCP_PORT_OBJECT</a>  <a class="el" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">LPCP_PORT_OBJECT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d5/lpccreat_8c-source.html#l00136">LpcpCreatePort()</a>, <a class="el" href="../../d5/d5/lpccompl_8c-source.html#l00040">NtAcceptConnectPort()</a>, and <a class="el" href="../../d6/d5/lpcconn_8c-source.html#l00084">NtSecureConnectPort()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="lpc.h::LPCP_PORT_QUEUE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d5/struct__LPCP__PORT__QUEUE.html">_LPCP_PORT_QUEUE</a>  <a class="el" href="../../d0/d5/struct__LPCP__PORT__QUEUE.html">LPCP_PORT_QUEUE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="lpc.h::LPCP_PORT_ZONE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d1/d5/struct__LPCP__PORT__ZONE.html">_LPCP_PORT_ZONE</a>  <a class="el" href="../../d1/d5/struct__LPCP__PORT__ZONE.html">LPCP_PORT_ZONE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="lpc.h::PLPCP_CONNECTION_MESSAGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html">_LPCP_CONNECTION_MESSAGE</a> * <a class="el" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html">PLPCP_CONNECTION_MESSAGE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="lpc.h::PLPCP_MESSAGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d5/d4/struct__LPCP__MESSAGE.html">_LPCP_MESSAGE</a> * <a class="el" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="lpc.h::PLPCP_NONPAGED_PORT_QUEUE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d4/struct__LPCP__NONPAGED__PORT__QUEUE.html">_LPCP_NONPAGED_PORT_QUEUE</a> * <a class="el" href="../../d8/d4/struct__LPCP__NONPAGED__PORT__QUEUE.html">PLPCP_NONPAGED_PORT_QUEUE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="lpc.h::PLPCP_PORT_OBJECT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">_LPCP_PORT_OBJECT</a> * <a class="el" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="lpc.h::PLPCP_PORT_QUEUE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d5/struct__LPCP__PORT__QUEUE.html">_LPCP_PORT_QUEUE</a> * <a class="el" href="../../d0/d5/struct__LPCP__PORT__QUEUE.html">PLPCP_PORT_QUEUE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="lpc.h::PLPCP_PORT_ZONE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d1/d5/struct__LPCP__PORT__ZONE.html">_LPCP_PORT_ZONE</a> * <a class="el" href="../../d1/d5/struct__LPCP__PORT__ZONE.html">PLPCP_PORT_ZONE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a29" doxytag="lpc.h::LpcDumpThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LpcDumpThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d5/struct__OBJECT__DUMP__CONTROL.html">POB_DUMP_CONTROL</a> Control&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="lpc.h::LpcExitThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LpcExitThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Thread</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d5/lpcclose_8c-source.html#l00281">281</a> of file <a class="el" href="../../d4/d5/lpcclose_8c-source.html">lpcclose.c</a>.
<p>
References <a class="el" href="../../d3/d5/lpc_8h-source.html#l00142">_LPCP_MESSAGE::Entry</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00447">_ETHREAD::LpcExitThreadCalled</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00093">LpcpAcquireLpcpLock</a>, <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00642">LpcpFreeToPortZone()</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00108">LpcpReleaseLpcpLock</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00320">LpcpTrace</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00371">_ETHREAD::LpcReplyChain</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00395">_ETHREAD::LpcReplyMessage</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00396">_ETHREAD::LpcReplyMessageId</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00151">_LPCP_MESSAGE::RepliedToThread</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00690">PspExitThread()</a>.
<p>
<pre class="fragment"><div>00287                    :
00288 
00289     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called whenever a thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> exiting and need to cleanup <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00290     lpc port <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread.
00291 
00292 Arguments:
00293 
00294     Thread - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread being terminated
00295 
00296 Return Value:
00297 
00298     None.
00299 
00300 --*/
00301 
00302 {
00303     <a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a> Msg;
00304 
00305     <span class="comment">//</span>
00306     <span class="comment">//  Acquire the mutex that protects the LpcReplyMessage field of</span>
00307     <span class="comment">//  the thread.  Zero the field so nobody else tries to process it</span>
00308     <span class="comment">//  when we release the lock.</span>
00309     <span class="comment">//</span>
00310 
00311     <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
00312 
00313     <span class="keywordflow">if</span> (!IsListEmpty( &amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> )) {
00314 
00315         RemoveEntryList( &amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> );
00316     }
00317 
00318     <span class="comment">//</span>
00319     <span class="comment">//  Indicate that this thread is exiting</span>
00320     <span class="comment">//</span>
00321 
00322     Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o32">LpcExitThreadCalled</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00323     Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o15">LpcReplyMessageId</a> = 0;
00324 
00325     <span class="comment">//</span>
00326     <span class="comment">//  If we need to reply to a message then if the thread that we need to reply</span>
00327     <span class="comment">//  to is still around we want to dereference the thread and free the message</span>
00328     <span class="comment">//</span>
00329 
00330     Msg = Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o14">LpcReplyMessage</a>;
00331 
00332     <span class="keywordflow">if</span> (Msg != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00333 
00334         Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o14">LpcReplyMessage</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00335 
00336         <span class="keywordflow">if</span> (Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o6">RepliedToThread</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00337 
00338             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o6">RepliedToThread</a> );
00339 
00340             Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o6">RepliedToThread</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00341         }
00342 
00343         <a class="code" href="../../d0/d7/lpcp_8h.html#a13">LpcpTrace</a>(( <span class="stringliteral">"Cleanup Msg %lx (%d) for Thread %lx allocated\n"</span>, Msg, IsListEmpty( &amp;Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o0">Entry</a> ), Thread ));
00344 
00345         <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, TRUE );
00346     }
00347 
00348     <span class="comment">//</span>
00349     <span class="comment">//  Free the global lpc lock</span>
00350     <span class="comment">//</span>
00351 
00352     <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00353 
00354     <span class="comment">//</span>
00355     <span class="comment">//  And return to our caller</span>
00356     <span class="comment">//</span>
00357 
00358     <span class="keywordflow">return</span>;
00359 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="lpc.h::LpcInitSystem" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN LpcInitSystem           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/lpcinit_8c-source.html#l00076">76</a> of file <a class="el" href="../../d8/d5/lpcinit_8c-source.html">lpcinit.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00084">LPCP_ZONE_ALIGNMENT</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00085">LPCP_ZONE_ALIGNMENT_MASK</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00091">LPCP_ZONE_MAX_POOL_USAGE</a>, <a class="el" href="../../d4/d5/lpcclose_8c-source.html#l00031">LpcpClosePort()</a>, <a class="el" href="../../d4/d5/lpcclose_8c-source.html#l00110">LpcpDeletePort()</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00086">LpcpInitializeLpcpLock</a>, <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00287">LpcpInitializePortZone()</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00069">LpcpNextCallbackId</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00067">LpcpNextMessageId</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00091">LpcPortObjectType</a>, <a class="el" href="../../d8/d5/lpcinit_8c-source.html#l00034">LpcpPortMapping</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00092">LpcWaitablePortObjectType</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d1/obtype_8c-source.html#l00069">ObCreateObjectType()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00082                    :
00083 
00084     This function performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system initialization <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LPC package.
00085     LPC stands <span class="keywordflow">for</span> Local Inter-Process Communication.
00086 
00087 Arguments:
00088 
00089     None.
00090 
00091 Return Value:
00092 
00093     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> successful and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> an error occurred.
00094 
00095     The following errors can occur:
00096 
00097     - insufficient memory
00098 
00099 --*/
00100 
00101 {
00102     <a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html">OBJECT_TYPE_INITIALIZER</a> ObjectTypeInitializer;
00103     UNICODE_STRING PortTypeName;
00104     ULONG ZoneElementSize;
00105     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00106 
00107     <span class="comment">//</span>
00108     <span class="comment">//  Initialize our global lpc lock</span>
00109     <span class="comment">//</span>
00110 
00111     <a class="code" href="../../d0/d7/lpcp_8h.html#a2">LpcpInitializeLpcpLock</a>();
00112 
00113     <span class="comment">//</span>
00114     <span class="comment">//  Create the object type for the port object</span>
00115     <span class="comment">//</span>
00116 
00117     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;PortTypeName, L<span class="stringliteral">"Port"</span> );
00118 
00119     RtlZeroMemory( &amp;ObjectTypeInitializer, <span class="keyword">sizeof</span>( ObjectTypeInitializer ));
00120 
00121     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o0">Length</a> = <span class="keyword">sizeof</span>( ObjectTypeInitializer );
00122     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> = <a class="code" href="../../d7/d6/lpcinit_8c.html#a2">LpcpPortMapping</a>;
00123     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o8">MaintainTypeList</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00124     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o9">PoolType</a> = <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>;
00125     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o10">DefaultPagedPoolCharge</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">LPCP_PORT_OBJECT</a> );
00126     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o11">DefaultNonPagedPoolCharge</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d8/d4/struct__LPCP__NONPAGED__PORT__QUEUE.html">LPCP_NONPAGED_PORT_QUEUE</a> );
00127     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o3">InvalidAttributes</a> = OBJ_VALID_ATTRIBUTES ^ PORT_VALID_OBJECT_ATTRIBUTES;
00128     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o5">ValidAccessMask</a> = PORT_ALL_ACCESS;
00129     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o14">CloseProcedure</a> = <a class="code" href="../../d3/d6/lpcclose_8c.html#a0">LpcpClosePort</a>;
00130     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o15">DeleteProcedure</a> = <a class="code" href="../../d3/d6/lpcclose_8c.html#a1">LpcpDeletePort</a>;
00131     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o1">UseDefaultObject</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
00132 
00133     <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>( &amp;PortTypeName,
00134                         &amp;ObjectTypeInitializer,
00135                         (PSECURITY_DESCRIPTOR)NULL,
00136                         &amp;LpcPortObjectType );
00137 
00138     <span class="comment">//</span>
00139     <span class="comment">//  Create the object type for the waitable port object</span>
00140     <span class="comment">//</span>
00141 
00142     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;PortTypeName, L<span class="stringliteral">"WaitablePort"</span> );
00143     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o9">PoolType</a> = <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a> ;
00144     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o1">UseDefaultObject</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
00145 
00146     <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>( &amp;PortTypeName,
00147                         &amp;ObjectTypeInitializer,
00148                         (PSECURITY_DESCRIPTOR)NULL,
00149                         &amp;LpcWaitablePortObjectType );
00150 
00151     <span class="comment">//</span>
00152     <span class="comment">//  Initialize the lpc message and callback id counters</span>
00153     <span class="comment">//</span>
00154 
00155     <a class="code" href="../../d0/d7/lpcp_8h.html#a18">LpcpNextMessageId</a> = 1;
00156     <a class="code" href="../../d0/d7/lpcp_8h.html#a19">LpcpNextCallbackId</a> = 1;
00157 
00158     <span class="comment">//</span>
00159     <span class="comment">//  Initialize the lpc port zone.  Each element can contain a max</span>
00160     <span class="comment">//  message, plus an LPCP message structure, plus an LPCP connection</span>
00161     <span class="comment">//  message</span>
00162     <span class="comment">//</span>
00163 
00164     ZoneElementSize = PORT_MAXIMUM_MESSAGE_LENGTH +
00165                       <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">LPCP_MESSAGE</a> ) +
00166                       <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html">LPCP_CONNECTION_MESSAGE</a> );
00167 
00168     <span class="comment">//</span>
00169     <span class="comment">//  Round up the size to the next 16 byte alignment</span>
00170     <span class="comment">//</span>
00171 
00172     ZoneElementSize = (ZoneElementSize + <a class="code" href="../../d2/d6/lpc_8h.html#a0">LPCP_ZONE_ALIGNMENT</a> - 1) &amp;
00173                       <a class="code" href="../../d2/d6/lpc_8h.html#a1">LPCP_ZONE_ALIGNMENT_MASK</a>;
00174 
00175     <span class="comment">//</span>
00176     <span class="comment">//  Initialize the zone</span>
00177     <span class="comment">//</span>
00178 
00179     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d7/lpcqueue_8c.html#a2">LpcpInitializePortZone</a>( ZoneElementSize,
00180                                      PAGE_SIZE,
00181                                      LPCP_ZONE_MAX_POOL_USAGE );
00182 
00183     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00184 
00185         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00186     }
00187 
00188     <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00189 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="lpc.h::LpcRequestPort" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI NTSTATUS LpcRequestPort           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>PortAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PPORT_MESSAGE&nbsp;</td>
          <td class="mdname" nowrap> <em>RequestMessage</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d6/lpcsend_8c-source.html#l01181">1181</a> of file <a class="el" href="../../d7/d6/lpcsend_8c-source.html">lpcsend.c</a>.
<p>
References <a class="el" href="../../d3/d5/lpc_8h-source.html#l00134">CLIENT_COMMUNICATION_PORT</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00108">_LPCP_PORT_OBJECT::ConnectedPort</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00107">_LPCP_PORT_OBJECT::ConnectionPort</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00142">_LPCP_MESSAGE::Entry</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00106">_LPCP_PORT_OBJECT::Flags</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00048">LPC_RELEASE_WAIT_INCREMENT</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00093">LpcpAcquireLpcpLock</a>, <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00558">LpcpAllocateFromPortZone()</a>, <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00642">LpcpFreeToPortZone()</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00071">LpcpGenerateMessageId</a>, <a class="el" href="../../d8/d5/lpcinit_8c-source.html#l00193">LpcpGetCreatorName()</a>, <a class="el" href="../../d0/d7/lpcp_8h.html#a31">LpcpMoveMessage()</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00108">LpcpReleaseLpcpLock</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00320">LpcpTrace</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00114">_LPCP_PORT_OBJECT::MaxMessageLength</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00109">_LPCP_PORT_OBJECT::MsgQueue</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00130">PORT_TYPE</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00135">PORT_WAITABLE</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00153">_LPCP_MESSAGE::PortContext</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00113">_LPCP_PORT_OBJECT::PortContext</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00081">_LPCP_PORT_QUEUE::ReceiveHead</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00151">_LPCP_MESSAGE::RepliedToThread</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00154">_LPCP_MESSAGE::Request</a>, <a class="el" href="../../d9/d9/ctlpcqos_8c-source.html#l00025">RequestMessage</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00079">_LPCP_PORT_QUEUE::Semaphore</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00133">SERVER_COMMUNICATION_PORT</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00131">SERVER_CONNECTION_PORT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d3/d5/lpc_8h-source.html#l00123">_LPCP_PORT_OBJECT::WaitEvent</a>.
<p>
Referenced by <a class="el" href="../../d4/d5/lpcclose_8c-source.html#l00110">LpcpDeletePort()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00690">PspExitThread()</a>, and <a class="el" href="../../d2/d4/w32_2ntuser_2kernel_2debug_8c-source.html#l00032">xxxActivateDebugger()</a>.
<p>
<pre class="fragment"><div>01188                    :
01189 
01190     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> similar to <a class="code" href="../../d6/d7/lpcsend_8c.html#a0">NtRequestPort</a> but without <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> based
01191     interface.
01192 
01193 Arguments:
01194 
01195     PortAddress - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> communication port to send
01196         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request message to.
01197 
01198     <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a> - Specifies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request message.  The Type
01199         field of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set to LPC_DATAGRAM by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service.
01200 
01201 Return Value:
01202 
01203     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> status code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation was
01204         successful.
01205 
01206 --*/
01207 
01208 {
01209     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> PortObject = (<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a>)PortAddress;
01210     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> QueuePort;
01211     ULONG MsgType;
01212     <a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a> Msg;
01213     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
01214 
01215     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01216 
01217     <span class="comment">//</span>
01218     <span class="comment">//  Get previous processor mode and validate parameters</span>
01219     <span class="comment">//</span>
01220 
01221     PreviousMode = KeGetPreviousMode();
01222 
01223     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;u2.s2.Type != 0) {
01224 
01225         MsgType = <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;u2.s2.Type &amp; ~LPC_KERNELMODE_MESSAGE;
01226 
01227         <span class="keywordflow">if</span> ((MsgType &lt; LPC_DATAGRAM) ||
01228             (MsgType &gt; LPC_CLIENT_DIED)) {
01229 
01230             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01231         }
01232 
01233         <span class="comment">//</span>
01234         <span class="comment">//  If previous mode is kernel, allow the LPC_KERNELMODE_MESSAGE</span>
01235         <span class="comment">//  bit to be passed in message type field.</span>
01236         <span class="comment">//</span>
01237 
01238         <span class="keywordflow">if</span> ((PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) &amp;&amp;
01239             (<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;u2.s2.Type &amp; LPC_KERNELMODE_MESSAGE)) {
01240 
01241             MsgType |= LPC_KERNELMODE_MESSAGE;
01242         }
01243 
01244     } <span class="keywordflow">else</span> {
01245 
01246         MsgType = LPC_DATAGRAM;
01247     }
01248 
01249     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;u2.s2.DataInfoOffset != 0) {
01250 
01251         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01252     }
01253 
01254     <span class="comment">//</span>
01255     <span class="comment">//  Validate the message length</span>
01256     <span class="comment">//</span>
01257 
01258     <span class="keywordflow">if</span> (((ULONG)<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;u1.s1.TotalLength &gt; PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o9">MaxMessageLength</a>) ||
01259         ((ULONG)<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;u1.s1.TotalLength &lt;= (ULONG)<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;u1.s1.DataLength)) {
01260 
01261         <span class="keywordflow">return</span> STATUS_PORT_MESSAGE_TOO_LONG;
01262     }
01263 
01264     <span class="comment">//</span>
01265     <span class="comment">//  Allocate a message block</span>
01266     <span class="comment">//</span>
01267 
01268     <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
01269 
01270     Msg = (<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a>)<a class="code" href="../../d3/d7/lpcqueue_8c.html#a4">LpcpAllocateFromPortZone</a>( <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;u1.s1.TotalLength );
01271 
01272     <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
01273 
01274     <span class="keywordflow">if</span> (Msg == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01275 
01276         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01277     }
01278 
01279     <span class="comment">//</span>
01280     <span class="comment">//  Fill in the message block.</span>
01281     <span class="comment">//</span>
01282 
01283     Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o6">RepliedToThread</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01284     Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o7">PortContext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01285 
01286     <a class="code" href="../../d0/d7/lpcp_8h.html#a31">LpcpMoveMessage</a>( &amp;Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>,
01287                      RequestMessage,
01288                      (RequestMessage + 1),
01289                      MsgType,
01290                      &amp;<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid );
01291 
01292     <span class="comment">//</span>
01293     <span class="comment">//  Acquire the global Lpc mutex that guards the LpcReplyMessage</span>
01294     <span class="comment">//  field of the thread and the request message queue.  Stamp the</span>
01295     <span class="comment">//  request message with a serial number, insert the message at</span>
01296     <span class="comment">//  the tail of the request message queue</span>
01297     <span class="comment">//</span>
01298     <span class="comment">//  This all needs to be performed with APCs disabled to avoid</span>
01299     <span class="comment">//  the situation where something gets put on the queue and this</span>
01300     <span class="comment">//  thread gets suspended before being able to release the semaphore.</span>
01301     <span class="comment">//</span>
01302 
01303     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01304 
01305     <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
01306 
01307     <span class="keywordflow">if</span> ((PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) != <a class="code" href="../../d2/d6/lpc_8h.html#a4">SERVER_CONNECTION_PORT</a>) {
01308 
01309         QueuePort = PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o3">ConnectedPort</a>;
01310 
01311         <span class="keywordflow">if</span> (QueuePort != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01312 
01313             <span class="keywordflow">if</span> ((PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) == <a class="code" href="../../d2/d6/lpc_8h.html#a7">CLIENT_COMMUNICATION_PORT</a>) {
01314 
01315                 Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o7">PortContext</a> = QueuePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o8">PortContext</a>;
01316                 QueuePort = PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o2">ConnectionPort</a>;
01317 
01318             <span class="comment">//</span>
01319             <span class="comment">//  **** this test and assignment are bogus because we earlier</span>
01320             <span class="comment">//       unconditionally set the QueuePort value</span>
01321             <span class="comment">//</span>
01322 
01323             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) != <a class="code" href="../../d2/d6/lpc_8h.html#a6">SERVER_COMMUNICATION_PORT</a>) {
01324 
01325                 QueuePort = PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o2">ConnectionPort</a>;
01326             }
01327         }
01328 
01329     } <span class="keywordflow">else</span> {
01330 
01331         QueuePort = PortObject;
01332     }
01333 
01334     <span class="comment">//</span>
01335     <span class="comment">//  At this point we have an LPC message ready to send and if queue port is</span>
01336     <span class="comment">//  not null then we have a port to actually send the message off to</span>
01337     <span class="comment">//</span>
01338 
01339     <span class="keywordflow">if</span> (QueuePort != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01340 
01341         Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.MessageId = <a class="code" href="../../d0/d7/lpcp_8h.html#a0">LpcpGenerateMessageId</a>();
01342         Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.CallbackId = 0;
01343 
01344         <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;LpcReplyMessageId = 0;
01345 
01346         InsertTailList( &amp;QueuePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o4">MsgQueue</a>.<a class="code" href="../../d0/d5/struct__LPCP__PORT__QUEUE.html#o2">ReceiveHead</a>, &amp;Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o0">Entry</a> );
01347 
01348         <a class="code" href="../../d0/d7/lpcp_8h.html#a13">LpcpTrace</a>(( <span class="stringliteral">"%s Send DataGram (%s) Msg %lx [%08x %08x %08x %08x] to Port %lx (%s)\n"</span>,
01349                     <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ImageFileName,
01350                     LpcpMessageTypeName[ Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.u2.s2.Type &amp; ~LPC_KERNELMODE_MESSAGE ],
01351                     Msg,
01352                     *((PULONG)(Msg+1)+0),
01353                     *((PULONG)(Msg+1)+1),
01354                     *((PULONG)(Msg+1)+2),
01355                     *((PULONG)(Msg+1)+3),
01356                     QueuePort,
01357                     <a class="code" href="../../d7/d6/lpcinit_8c.html#a5">LpcpGetCreatorName</a>( QueuePort )));
01358 
01359         <span class="comment">//</span>
01360         <span class="comment">//  Release the mutex, increment the request message queue</span>
01361         <span class="comment">//  semaphore by one for the newly inserted request message,</span>
01362         <span class="comment">//  then exit the critical region.</span>
01363         <span class="comment">//</span>
01364 
01365         <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
01366 
01367         <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>( QueuePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o4">MsgQueue</a>.<a class="code" href="../../d0/d5/struct__LPCP__PORT__QUEUE.html#o1">Semaphore</a>,
01368                             LPC_RELEASE_WAIT_INCREMENT,
01369                             1L,
01370                             FALSE );
01371 
01372 
01373         <span class="keywordflow">if</span> ( QueuePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a8">PORT_WAITABLE</a> ) {
01374 
01375             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;QueuePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o18">WaitEvent</a>,
01376                         LPC_RELEASE_WAIT_INCREMENT,
01377                         FALSE );
01378         }
01379 
01380         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01381 
01382         <span class="keywordflow">return</span> STATUS_SUCCESS;
01383 
01384     }
01385 
01386     <span class="comment">//</span>
01387     <span class="comment">//  At this point we have a message but not a valid port to queue it off</span>
01388     <span class="comment">//  to so we'll release the unused message, release our lock and enable</span>
01389     <span class="comment">//  APC again</span>
01390     <span class="comment">//</span>
01391 
01392     <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, TRUE );
01393 
01394     <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
01395 
01396     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01397 
01398     <span class="comment">//</span>
01399     <span class="comment">//  And return the error status to our caller</span>
01400     <span class="comment">//</span>
01401 
01402     <span class="keywordflow">return</span> STATUS_PORT_DISCONNECTED;
01403 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="lpc.h::LpcRequestWaitReplyPort" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS LpcRequestWaitReplyPort           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>PortAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PPORT_MESSAGE&nbsp;</td>
          <td class="mdname" nowrap> <em>RequestMessage</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PPORT_MESSAGE&nbsp;</td>
          <td class="mdname" nowrap> <em>ReplyMessage</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d6/lpcsend_8c-source.html#l01407">1407</a> of file <a class="el" href="../../d7/d6/lpcsend_8c-source.html">lpcsend.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00388">_ETHREAD::Cid</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00134">CLIENT_COMMUNICATION_PORT</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00108">_LPCP_PORT_OBJECT::ConnectedPort</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00107">_LPCP_PORT_OBJECT::ConnectionPort</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00142">_LPCP_MESSAGE::Entry</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00106">_LPCP_PORT_OBJECT::Flags</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00085">KeReadStateSemaphore()</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00048">LPC_RELEASE_WAIT_INCREMENT</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00447">_ETHREAD::LpcExitThreadCalled</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00093">LpcpAcquireLpcpLock</a>, <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00558">LpcpAllocateFromPortZone()</a>, <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00642">LpcpFreeToPortZone()</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00074">LpcpGenerateCallbackId</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00071">LpcpGenerateMessageId</a>, <a class="el" href="../../d8/d5/lpcinit_8c-source.html#l00193">LpcpGetCreatorName()</a>, <a class="el" href="../../d0/d7/lpcp_8h.html#a31">LpcpMoveMessage()</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00108">LpcpReleaseLpcpLock</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00320">LpcpTrace</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00371">_ETHREAD::LpcReplyChain</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00119">_LPCP_PORT_OBJECT::LpcReplyChainHead</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00395">_ETHREAD::LpcReplyMessage</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00396">_ETHREAD::LpcReplyMessageId</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00394">_ETHREAD::LpcReplySemaphore</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00114">_LPCP_PORT_OBJECT::MaxMessageLength</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00109">_LPCP_PORT_OBJECT::MsgQueue</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00130">PORT_TYPE</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00135">PORT_WAITABLE</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00153">_LPCP_MESSAGE::PortContext</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00113">_LPCP_PORT_OBJECT::PortContext</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d2/d9/pscid_8c-source.html#l00027">PsLookupProcessThreadByCid()</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00081">_LPCP_PORT_QUEUE::ReceiveHead</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00151">_LPCP_MESSAGE::RepliedToThread</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l03425">ReplyMessage()</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00154">_LPCP_MESSAGE::Request</a>, <a class="el" href="../../d9/d9/ctlpcqos_8c-source.html#l00025">RequestMessage</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00079">_LPCP_PORT_QUEUE::Semaphore</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00133">SERVER_COMMUNICATION_PORT</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00131">SERVER_CONNECTION_PORT</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00638">THREAD_TO_PROCESS</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00123">_LPCP_PORT_OBJECT::WaitEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00007">WrExecutive</a>, and <a class="el" href="../../d4/d9/ke_8h.html#a407a215">WrLpcReply</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/dbgkport_8c-source.html#l00031">DbgkpSendApiMessage()</a>, <a class="el" href="../../d7/d7/ex_2harderr_8c-source.html#l00349">ExpRaiseHardError()</a>, and <a class="el" href="../../d3/d3/internal_8c-source.html#l06127">IopSendMessageToTrackService()</a>.
<p>
<pre class="fragment"><div>01415                    :
01416 
01417     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> similar to <a class="code" href="../../d6/d7/lpcsend_8c.html#a1">NtRequestWaitReplyPort</a> but without <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01418     handle based interface
01419 
01420 Arguments:
01421 
01422     PortAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> communication port object to send <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01423         request message to.
01424 
01425     <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a> - Specifies a pointer to a request message to send.
01426 
01427     <a class="code" href="../../d3/d8/client_8c.html#a125">ReplyMessage</a> - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a variable that will receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01428         reply message.  This parameter may point to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same buffer as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01429         <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a> parameter.
01430 
01431 Return Value:
01432 
01433     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> status code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation was
01434         successful.
01435 
01436 --*/
01437 
01438 {
01439     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> PortObject = (<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a>)PortAddress;
01440     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> QueuePort;
01441     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> RundownPort;
01442     <a class="code" href="../../d8/d7/struct__KSEMAPHORE.html">PKSEMAPHORE</a> ReleaseSemaphore;
01443     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01444     ULONG MsgType;
01445     <a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a> Msg;
01446     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> CurrentThread;
01447     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> WakeupThread;
01448     BOOLEAN CallbackRequest;
01449     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
01450 
01451     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01452 
01453     CurrentThread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01454 
01455     <span class="keywordflow">if</span> (CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o32">LpcExitThreadCalled</a>) {
01456 
01457         <span class="keywordflow">return</span> STATUS_THREAD_IS_TERMINATING;
01458     }
01459 
01460     <span class="comment">//</span>
01461     <span class="comment">//  Get previous processor mode and validate parameters</span>
01462     <span class="comment">//</span>
01463 
01464     PreviousMode = KeGetPreviousMode();
01465     MsgType = <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;u2.s2.Type &amp; ~LPC_KERNELMODE_MESSAGE;
01466     CallbackRequest = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01467 
01468     <span class="keywordflow">switch</span> (MsgType) {
01469 
01470     <span class="keywordflow">case</span> 0:
01471 
01472         MsgType = LPC_REQUEST;
01473         <span class="keywordflow">break</span>;
01474 
01475     <span class="keywordflow">case</span> LPC_REQUEST:
01476 
01477         CallbackRequest = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01478         <span class="keywordflow">break</span>;
01479 
01480     <span class="keywordflow">case</span> LPC_CLIENT_DIED:
01481     <span class="keywordflow">case</span> LPC_PORT_CLOSED:
01482     <span class="keywordflow">case</span> LPC_EXCEPTION:
01483     <span class="keywordflow">case</span> LPC_DEBUG_EVENT:
01484     <span class="keywordflow">case</span> LPC_ERROR_EVENT:
01485 
01486         <span class="keywordflow">break</span>;
01487 
01488     <span class="keywordflow">default</span> :
01489 
01490         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01491     }
01492 
01493     <span class="comment">//</span>
01494     <span class="comment">//  Allow the LPC_KERNELMODE_MESSAGE</span>
01495     <span class="comment">//  bit to be passed in message type field. Don't check the previous mode !!!</span>
01496     <span class="comment">//</span>
01497 
01498     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;u2.s2.Type &amp; LPC_KERNELMODE_MESSAGE) {
01499 
01500         MsgType |= LPC_KERNELMODE_MESSAGE;
01501     }
01502 
01503     <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;u2.s2.Type = (CSHORT)MsgType;
01504 
01505     <span class="comment">//</span>
01506     <span class="comment">//  Validate the message length</span>
01507     <span class="comment">//</span>
01508 
01509     <span class="keywordflow">if</span> (((ULONG)<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;u1.s1.TotalLength &gt; PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o9">MaxMessageLength</a>) ||
01510         ((ULONG)<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;u1.s1.TotalLength &lt;= (ULONG)<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;u1.s1.DataLength)) {
01511 
01512         <span class="keywordflow">return</span> STATUS_PORT_MESSAGE_TOO_LONG;
01513     }
01514 
01515     <span class="comment">//</span>
01516     <span class="comment">//  Determine which port to queue the message to and get client</span>
01517     <span class="comment">//  port context if client sending to server.  Also validate</span>
01518     <span class="comment">//  length of message being sent.</span>
01519     <span class="comment">//</span>
01520 
01521     <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
01522 
01523     Msg = (<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a>)<a class="code" href="../../d3/d7/lpcqueue_8c.html#a4">LpcpAllocateFromPortZone</a>( <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;u1.s1.TotalLength );
01524 
01525     <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
01526 
01527     <span class="keywordflow">if</span> (Msg == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01528 
01529         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01530     }
01531 
01532     <span class="keywordflow">if</span> (CallbackRequest) {
01533 
01534         <span class="comment">//</span>
01535         <span class="comment">//  Check for a valid request message id</span>
01536         <span class="comment">//</span>
01537 
01538         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;MessageId == 0) {
01539 
01540             <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, FALSE );
01541 
01542             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01543         }
01544 
01545         <span class="comment">//</span>
01546         <span class="comment">//  Translate the ClientId from the request into a</span>
01547         <span class="comment">//  thread pointer.  This is a referenced pointer to keep the thread</span>
01548         <span class="comment">//  from evaporating out from under us.</span>
01549         <span class="comment">//</span>
01550 
01551         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d0/pscid_8c.html#a0">PsLookupProcessThreadByCid</a>( &amp;<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;ClientId,
01552                                              NULL,
01553                                              &amp;WakeupThread );
01554 
01555         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
01556 
01557             <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, FALSE );
01558 
01559             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01560         }
01561 
01562         <span class="comment">//</span>
01563         <span class="comment">//  Acquire the mutex that gaurds the LpcReplyMessage field of</span>
01564         <span class="comment">//  the thread and get the pointer to the message that the thread</span>
01565         <span class="comment">//  is waiting for a reply to.</span>
01566         <span class="comment">//</span>
01567 
01568         <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
01569 
01570         <span class="comment">//</span>
01571         <span class="comment">//  See if the thread is waiting for a reply to the message</span>
01572         <span class="comment">//  specified on this call.  If not then a bogus message</span>
01573         <span class="comment">//  has been specified, so release the mutex, dereference the thread</span>
01574         <span class="comment">//  and return failure.</span>
01575         <span class="comment">//</span>
01576 
01577         <span class="keywordflow">if</span> ((WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o15">LpcReplyMessageId</a> != <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;MessageId)
01578 
01579                 ||
01580 
01581             ((WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o14">LpcReplyMessage</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01582              (((<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a>)(WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o14">LpcReplyMessage</a>))-&gt;Request.u2.s2.Type &amp; ~LPC_KERNELMODE_MESSAGE) != LPC_REQUEST)) {
01583 
01584             <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, TRUE );
01585 
01586             <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
01587 
01588             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( WakeupThread );
01589 
01590             <span class="keywordflow">return</span> STATUS_REPLY_MESSAGE_MISMATCH;
01591         }
01592 
01593         QueuePort = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01594         Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o7">PortContext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01595 
01596         <span class="keywordflow">if</span> ((PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) == <a class="code" href="../../d2/d6/lpc_8h.html#a4">SERVER_CONNECTION_PORT</a>) {
01597 
01598             RundownPort = PortObject;
01599 
01600         } <span class="keywordflow">else</span> {
01601 
01602             RundownPort = PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o3">ConnectedPort</a>;
01603 
01604             <span class="keywordflow">if</span> (RundownPort == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01605 
01606                 <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, TRUE );
01607 
01608                 <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
01609 
01610                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( WakeupThread );
01611 
01612                 <span class="keywordflow">return</span> STATUS_PORT_DISCONNECTED;
01613             }
01614 
01615             <span class="keywordflow">if</span> ((PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) == <a class="code" href="../../d2/d6/lpc_8h.html#a7">CLIENT_COMMUNICATION_PORT</a>) {
01616 
01617                 Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o7">PortContext</a> = RundownPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o8">PortContext</a>;
01618             }
01619         }
01620 
01621         <span class="comment">//</span>
01622         <span class="comment">//  Allocate and initialize a request message</span>
01623         <span class="comment">//</span>
01624 
01625         <a class="code" href="../../d0/d7/lpcp_8h.html#a31">LpcpMoveMessage</a>( &amp;Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>,
01626                          RequestMessage,
01627                          (RequestMessage + 1),
01628                          0,
01629                          &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a> );
01630 
01631         Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.CallbackId = <a class="code" href="../../d0/d7/lpcp_8h.html#a1">LpcpGenerateCallbackId</a>();
01632 
01633         <a class="code" href="../../d0/d7/lpcp_8h.html#a13">LpcpTrace</a>(( <span class="stringliteral">"%s CallBack Request (%s) Msg %lx (%u.%u) [%08x %08x %08x %08x] to Thread %lx (%s)\n"</span>,
01634                     <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ImageFileName,
01635                     LpcpMessageTypeName[ Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.u2.s2.Type &amp; ~LPC_KERNELMODE_MESSAGE ],
01636                     Msg,
01637                     Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.MessageId,
01638                     Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.CallbackId,
01639                     *((PULONG)(Msg+1)+0),
01640                     *((PULONG)(Msg+1)+1),
01641                     *((PULONG)(Msg+1)+2),
01642                     *((PULONG)(Msg+1)+3),
01643                     WakeupThread,
01644                     <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>( WakeupThread )-&gt;ImageFileName ));
01645 
01646         <span class="comment">//</span>
01647         <span class="comment">//  Add an extra reference so LpcExitThread does not evaporate</span>
01648         <span class="comment">//  the pointer before we get to the wait below</span>
01649         <span class="comment">//</span>
01650 
01651         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( WakeupThread );
01652 
01653         Msg-&gt;RepliedToThread = WakeupThread;
01654 
01655         WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o15">LpcReplyMessageId</a> = 0;
01656         WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o14">LpcReplyMessage</a> = (PVOID)Msg;
01657 
01658         <span class="comment">//</span>
01659         <span class="comment">//  Remove the thread from the reply rundown list as we are sending a callback</span>
01660         <span class="comment">//</span>
01661 
01662         <span class="keywordflow">if</span> (!IsListEmpty( &amp;WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> )) {
01663 
01664             RemoveEntryList( &amp;WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> );
01665 
01666             InitializeListHead( &amp;WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> );
01667         }
01668 
01669         CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o15">LpcReplyMessageId</a> = Msg-&gt;Request.MessageId;
01670         CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o14">LpcReplyMessage</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01671 
01672         InsertTailList( &amp;RundownPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o14">LpcReplyChainHead</a>, &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> );
01673 
01674         <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
01675 
01676         <span class="comment">//</span>
01677         <span class="comment">//  Wake up the thread that is waiting for an answer to its request</span>
01678         <span class="comment">//  inside of NtRequestWaitReplyPort or NtReplyWaitReplyPort</span>
01679         <span class="comment">//</span>
01680 
01681         ReleaseSemaphore = &amp;WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o13">LpcReplySemaphore</a>;
01682 
01683     } <span class="keywordflow">else</span> {
01684 
01685         <span class="comment">//</span>
01686         <span class="comment">//  There is no callbreak requested</span>
01687         <span class="comment">//</span>
01688 
01689         <a class="code" href="../../d0/d7/lpcp_8h.html#a31">LpcpMoveMessage</a>( &amp;Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>,
01690                          RequestMessage,
01691                          (RequestMessage + 1),
01692                          0,
01693                          &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a> );
01694 
01695         <span class="comment">//</span>
01696         <span class="comment">//  Acquire the global Lpc mutex that gaurds the LpcReplyMessage</span>
01697         <span class="comment">//  field of the thread and the request message queue.  Stamp the</span>
01698         <span class="comment">//  request message with a serial number, insert the message at</span>
01699         <span class="comment">//  the tail of the request message queue and remember the address</span>
01700         <span class="comment">//  of the message in the LpcReplyMessage field for the current thread.</span>
01701         <span class="comment">//</span>
01702 
01703         <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
01704 
01705         Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o7">PortContext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01706 
01707         <span class="keywordflow">if</span> ((PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) != <a class="code" href="../../d2/d6/lpc_8h.html#a4">SERVER_CONNECTION_PORT</a>) {
01708 
01709             QueuePort = PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o3">ConnectedPort</a>;
01710 
01711             <span class="keywordflow">if</span> (QueuePort == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01712 
01713                 <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, TRUE );
01714 
01715                 <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
01716 
01717                 <span class="keywordflow">return</span> STATUS_PORT_DISCONNECTED;
01718             }
01719 
01720             RundownPort = QueuePort;
01721 
01722             <span class="keywordflow">if</span> ((PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) == <a class="code" href="../../d2/d6/lpc_8h.html#a7">CLIENT_COMMUNICATION_PORT</a>) {
01723 
01724                 Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o7">PortContext</a> = QueuePort-&gt;PortContext;
01725                 QueuePort = PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o2">ConnectionPort</a>;
01726 
01727             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) != <a class="code" href="../../d2/d6/lpc_8h.html#a6">SERVER_COMMUNICATION_PORT</a>) {
01728 
01729                 QueuePort = PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o2">ConnectionPort</a>;
01730             }
01731 
01732         } <span class="keywordflow">else</span> {
01733 
01734             QueuePort = PortObject;
01735             RundownPort = PortObject;
01736         }
01737 
01738         Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o6">RepliedToThread</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01739         Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.MessageId = <a class="code" href="../../d0/d7/lpcp_8h.html#a0">LpcpGenerateMessageId</a>();
01740         Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.CallbackId = 0;
01741 
01742         CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o15">LpcReplyMessageId</a> = Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.MessageId;
01743         CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o14">LpcReplyMessage</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01744 
01745         InsertTailList( &amp;QueuePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o4">MsgQueue</a>.<a class="code" href="../../d0/d5/struct__LPCP__PORT__QUEUE.html#o2">ReceiveHead</a>, &amp;Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o0">Entry</a> );
01746         InsertTailList( &amp;RundownPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o14">LpcReplyChainHead</a>, &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> );
01747 
01748         <a class="code" href="../../d0/d7/lpcp_8h.html#a13">LpcpTrace</a>(( <span class="stringliteral">"%s Send Request (%s) Msg %lx (%u) [%08x %08x %08x %08x] to Port %lx (%s)\n"</span>,
01749                     <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ImageFileName,
01750                     LpcpMessageTypeName[ Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.u2.s2.Type &amp; ~LPC_KERNELMODE_MESSAGE ],
01751                     Msg,
01752                     Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.MessageId,
01753                     *((PULONG)(Msg+1)+0),
01754                     *((PULONG)(Msg+1)+1),
01755                     *((PULONG)(Msg+1)+2),
01756                     *((PULONG)(Msg+1)+3),
01757                     QueuePort,
01758                     <a class="code" href="../../d7/d6/lpcinit_8c.html#a5">LpcpGetCreatorName</a>( QueuePort )));
01759 
01760         <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
01761 
01762         <span class="comment">//</span>
01763         <span class="comment">//  Increment the request message queue semaphore by one for</span>
01764         <span class="comment">//  the newly inserted request message.  Release the spin</span>
01765         <span class="comment">//  lock, while remaining at the dispatcher IRQL.  Then wait for the</span>
01766         <span class="comment">//  reply to this request by waiting on the LpcReplySemaphore</span>
01767         <span class="comment">//  for the current thread.</span>
01768         <span class="comment">//</span>
01769 
01770         ReleaseSemaphore = QueuePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o4">MsgQueue</a>.<a class="code" href="../../d0/d5/struct__LPCP__PORT__QUEUE.html#o1">Semaphore</a>;
01771 
01772         <span class="keywordflow">if</span> ( QueuePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a8">PORT_WAITABLE</a> ) {
01773 
01774             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;QueuePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o18">WaitEvent</a>,
01775                         LPC_RELEASE_WAIT_INCREMENT,
01776                         FALSE );
01777         }
01778     }
01779 
01780     <span class="comment">//</span>
01781     <span class="comment">//  At this point we've enqueued our request and if necessary</span>
01782     <span class="comment">//  set ourselves up for the callback or reply.</span>
01783     <span class="comment">//</span>
01784     <span class="comment">//  So now wake up the other end</span>
01785     <span class="comment">//</span>
01786 
01787     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>( ReleaseSemaphore,
01788                                  1,
01789                                  1,
01790                                  FALSE );
01791 
01792     <span class="keywordflow">if</span> (CallbackRequest) {
01793 
01794         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( WakeupThread );
01795     }
01796 
01797     <span class="comment">//</span>
01798     <span class="comment">//  And wait for a reply</span>
01799     <span class="comment">//</span>
01800 
01801     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o13">LpcReplySemaphore</a>,
01802                                     WrLpcReply,
01803                                     KernelMode,
01804                                     FALSE,
01805                                     NULL );
01806 
01807     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_USER_APC) {
01808 
01809         <span class="comment">//</span>
01810         <span class="comment">//  if the semaphore is signaled, then clear it</span>
01811         <span class="comment">//</span>
01812 
01813         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d6/semphobj_8c.html#a2">KeReadStateSemaphore</a>( &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o13">LpcReplySemaphore</a> )) {
01814 
01815             <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o13">LpcReplySemaphore</a>,
01816                                    WrExecutive,
01817                                    KernelMode,
01818                                    FALSE,
01819                                    NULL );
01820 
01821             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01822         }
01823     }
01824 
01825     <span class="comment">//</span>
01826     <span class="comment">//  Acquire the LPC mutex.  Remove the reply message from the current thread</span>
01827     <span class="comment">//</span>
01828 
01829     <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
01830 
01831     Msg = CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o14">LpcReplyMessage</a>;
01832 
01833     CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o14">LpcReplyMessage</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01834     CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o15">LpcReplyMessageId</a> = 0;
01835 
01836     <span class="comment">//</span>
01837     <span class="comment">//  Remove the thread from the reply rundown list in case we did not wakeup due to</span>
01838     <span class="comment">//  a reply</span>
01839     <span class="comment">//</span>
01840 
01841     <span class="keywordflow">if</span> (!IsListEmpty( &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> )) {
01842 
01843         RemoveEntryList( &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> );
01844 
01845         InitializeListHead( &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> );
01846     }
01847 
01848 <span class="preprocessor">#if DBG</span>
01849 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Msg != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01850 
01851         <a class="code" href="../../d0/d7/lpcp_8h.html#a13">LpcpTrace</a>(( <span class="stringliteral">"%s Got Reply Msg %lx (%u) [%08x %08x %08x %08x] for Thread %lx (%s)\n"</span>,
01852                     <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ImageFileName,
01853                     Msg,
01854                     Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.MessageId,
01855                     *((PULONG)(Msg+1)+0),
01856                     *((PULONG)(Msg+1)+1),
01857                     *((PULONG)(Msg+1)+2),
01858                     *((PULONG)(Msg+1)+3),
01859                     CurrentThread,
01860                     <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>( CurrentThread )-&gt;ImageFileName ));
01861     }
01862 <span class="preprocessor">#endif</span>
01863 <span class="preprocessor"></span>
01864     <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
01865 
01866     <span class="comment">//</span>
01867     <span class="comment">//  If the wait succeeded, copy the reply to the reply buffer.</span>
01868     <span class="comment">//</span>
01869 
01870     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
01871 
01872         <span class="keywordflow">if</span> (Msg != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01873 
01874             <a class="code" href="../../d0/d7/lpcp_8h.html#a31">LpcpMoveMessage</a>( ReplyMessage,
01875                              &amp;Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>,
01876                              (&amp;Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>) + 1,
01877                              0,
01878                              NULL );
01879 
01880             <span class="comment">//</span>
01881             <span class="comment">//  Acquire the LPC mutex and decrement the reference count for the</span>
01882             <span class="comment">//  message.  If the reference count goes to zero the message will be</span>
01883             <span class="comment">//  deleted.</span>
01884             <span class="comment">//</span>
01885 
01886             <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
01887 
01888             <span class="keywordflow">if</span> (Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o6">RepliedToThread</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01889 
01890                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o6">RepliedToThread</a> );
01891 
01892                 Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o6">RepliedToThread</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01893             }
01894 
01895             <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, TRUE );
01896 
01897             <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
01898 
01899         } <span class="keywordflow">else</span> {
01900 
01901             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_LPC_REPLY_LOST;
01902         }
01903 
01904     } <span class="keywordflow">else</span> {
01905 
01906         <span class="comment">//</span>
01907         <span class="comment">//  Wait failed, acquire the LPC mutex and free the message.</span>
01908         <span class="comment">//</span>
01909 
01910         <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
01911 
01912         <span class="keywordflow">if</span> (Msg != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01913 
01914             <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, TRUE );
01915         }
01916 
01917         <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
01918     }
01919 
01920     <span class="comment">//</span>
01921     <span class="comment">//  And return to our caller</span>
01922     <span class="comment">//</span>
01923 
01924     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01925 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a13" doxytag="lpc.h::LpcCallBackOperationCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d2/d6/lpc_8h.html#a13">LpcCallBackOperationCount</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/lpc_8h-source.html#l00065">65</a> of file <a class="el" href="../../d3/d5/lpc_8h-source.html">lpc.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="lpc.h::LpcCallOperationCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d2/d6/lpc_8h.html#a12">LpcCallOperationCount</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/lpc_8h-source.html#l00064">64</a> of file <a class="el" href="../../d3/d5/lpc_8h-source.html">lpc.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="lpc.h::LpcDatagramOperationCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d2/d6/lpc_8h.html#a14">LpcDatagramOperationCount</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/lpc_8h-source.html#l00066">66</a> of file <a class="el" href="../../d3/d5/lpc_8h-source.html">lpc.h</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:33 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
