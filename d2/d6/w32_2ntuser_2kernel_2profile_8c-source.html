<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: profile.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>profile.c</h1><a href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: profile.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains code to emulate ini file mapping.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 30-Nov-1993 SanfordS  Created.</span>
00010 <span class="comment">\***************************************************************************/</span>
00011 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00012 <span class="preprocessor">#pragma hdrstop</span>
00013 <span class="preprocessor"></span>
00014 <span class="comment">/***************************************************************************\</span>
00015 <span class="comment">* aFastRegMap[]</span>
00016 <span class="comment">*</span>
00017 <span class="comment">* This array maps section ids (PMAP_) to cached registry keys and section</span>
00018 <span class="comment">* addresses within the registry.  IF INI FILE MAPPING CHANGES ARE MADE,</span>
00019 <span class="comment">* THIS TABLE MUST BE UPDATED.</span>
00020 <span class="comment">*</span>
00021 <span class="comment">* The first character of the szSection field indicates what root the</span>
00022 <span class="comment">* section is in. (or locked open status)</span>
00023 <span class="comment">*      M = LocalMachine</span>
00024 <span class="comment">*      U = CurrentUser</span>
00025 <span class="comment">*      L = Locked open - used only on M mappings.</span>
00026 <span class="comment">*</span>
00027 <span class="comment">* History:</span>
00028 <span class="comment">\***************************************************************************/</span>
<a name="l00029"></a><a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a0">00029</a> <span class="preprocessor">#define PROOT_CPANEL     0</span>
<a name="l00030"></a><a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a1">00030</a> <span class="preprocessor"></span><span class="preprocessor">#define PROOT_ACCESS     1</span>
<a name="l00031"></a><a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a2">00031</a> <span class="preprocessor"></span><span class="preprocessor">#define PROOT_CURRENTM   2</span>
<a name="l00032"></a><a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a3">00032</a> <span class="preprocessor"></span><span class="preprocessor">#define PROOT_CURRENTU   3</span>
<a name="l00033"></a><a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a4">00033</a> <span class="preprocessor"></span><span class="preprocessor">#define PROOT_CONTROL    4</span>
<a name="l00034"></a><a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a5">00034</a> <span class="preprocessor"></span><span class="preprocessor">#define PROOT_SERVICES   5</span>
<a name="l00035"></a><a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a6">00035</a> <span class="preprocessor"></span><span class="preprocessor">#define PROOT_KEYBOARD   6</span>
00036 <span class="preprocessor"></span>
<a name="l00037"></a><a class="code" href="../../d1/d5/structtagFASTREGMAP.html">00037</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d1/d5/structtagFASTREGMAP.html">tagFASTREGMAP</a> {
<a name="l00038"></a><a class="code" href="../../d1/d5/structtagFASTREGMAP.html#o0">00038</a>     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d1/d5/structtagFASTREGMAP.html#o0">idRoot</a>;
<a name="l00039"></a><a class="code" href="../../d1/d5/structtagFASTREGMAP.html#o1">00039</a>     PCWSTR <a class="code" href="../../d1/d5/structtagFASTREGMAP.html#o1">szSection</a>;
00040 } <a class="code" href="../../d1/d5/structtagFASTREGMAP.html">FASTREGMAP</a>, *<a class="code" href="../../d1/d5/structtagFASTREGMAP.html">PFASTREGMAP</a>;
00041 
<a name="l00042"></a><a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a9">00042</a> CONST PCWSTR <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a9">aFastRegRoot</a>[] = {
00043     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"UControl Panel\\"</span>,                                    <span class="comment">// PROOT_CPANEL</span>
00044     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"UControl Panel\\Accessibility\\"</span>,                     <span class="comment">// PROOT_ACCESS</span>
00045     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"MSoftware\\Microsoft\\Windows NT\\CurrentVersion\\"</span>,  <span class="comment">// PROOT_CURRENTM</span>
00046     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"USoftware\\Microsoft\\Windows NT\\CurrentVersion\\"</span>,  <span class="comment">// PROOT_CURRENTU</span>
00047     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"MSystem\\CurrentControlSet\\Control\\"</span>,               <span class="comment">// PROOT_CONTROL</span>
00048     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"MSystem\\CurrentControlSet\\Services\\"</span>,              <span class="comment">// PROOT_SERVICES</span>
00049     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"UKeyboard Layout\\"</span>,                                  <span class="comment">// PROOT_KEYBOARD</span>
00050 };
00051 
<a name="l00052"></a><a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a10">00052</a> CONST <a class="code" href="../../d1/d5/structtagFASTREGMAP.html">FASTREGMAP</a> <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a10">aFastRegMap</a>[<a class="code" href="../../d4/d1/userk_8h.html#a734">PMAP_LAST</a> + 1] = {
00053     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a0">PROOT_CPANEL</a>,   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Colors"</span> },                          <span class="comment">// PMAP_COLORS</span>
00054     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a0">PROOT_CPANEL</a>,   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Cursors"</span> },                         <span class="comment">// PMAP_CURSORS</span>
00055     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a2">PROOT_CURRENTM</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Windows"</span> },                         <span class="comment">// PMAP_WINDOWSM</span>
00056     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a3">PROOT_CURRENTU</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Windows"</span> },                         <span class="comment">// PMAP_WINDOWSU</span>
00057     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a0">PROOT_CPANEL</a>,   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Desktop"</span> },                         <span class="comment">// PMAP_DESKTOP</span>
00058     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a0">PROOT_CPANEL</a>,   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Icons"</span> },                           <span class="comment">// PMAP_ICONS</span>
00059     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a2">PROOT_CURRENTM</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Fonts"</span> },                           <span class="comment">// PMAP_FONTS</span>
00060     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a3">PROOT_CURRENTU</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"TrueType"</span> },                        <span class="comment">// PMAP_TRUETYPE</span>
00061     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a4">PROOT_CONTROL</a>,  <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Keyboard Layout"</span> },                 <span class="comment">// PMAP_KBDLAYOUT</span>
00062     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a5">PROOT_SERVICES</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"RIT"</span> },                             <span class="comment">// PMAP_INPUT</span>
00063     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a2">PROOT_CURRENTM</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Compatibility"</span> },                   <span class="comment">// PMAP_COMPAT</span>
00064     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a4">PROOT_CONTROL</a>,  <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Session Manager\\SubSystems"</span> },     <span class="comment">// PMAP_SUBSYSTEMS</span>
00065     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a0">PROOT_CPANEL</a>,   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Sound"</span> },                           <span class="comment">// PMAP_BEEP</span>
00066     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a0">PROOT_CPANEL</a>,   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Mouse"</span> },                           <span class="comment">// PMAP_MOUSE</span>
00067     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a0">PROOT_CPANEL</a>,   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Keyboard"</span> },                        <span class="comment">// PMAP_KEYBOARD</span>
00068     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a1">PROOT_ACCESS</a>,   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"StickyKeys"</span> },                      <span class="comment">// PMAP_STICKYKEYS</span>
00069     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a1">PROOT_ACCESS</a>,   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Keyboard Response"</span> },               <span class="comment">// PMAP_KEYBOARDRESPONSE</span>
00070     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a1">PROOT_ACCESS</a>,   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"MouseKeys"</span> },                       <span class="comment">// PMAP_MOUSEKEYS</span>
00071     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a1">PROOT_ACCESS</a>,   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ToggleKeys"</span> },                      <span class="comment">// PMAP_TOGGLEKEYS</span>
00072     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a1">PROOT_ACCESS</a>,   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"TimeOut"</span> },                         <span class="comment">// PMAP_TIMEOUT</span>
00073     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a1">PROOT_ACCESS</a>,   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SoundSentry"</span> },                     <span class="comment">// PMAP_SOUNDSENTRY</span>
00074     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a1">PROOT_ACCESS</a>,   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ShowSounds"</span> },                      <span class="comment">// PMAP_SHOWSOUNDS</span>
00075     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a2">PROOT_CURRENTM</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"AeDebug"</span> },                         <span class="comment">// PMAP_AEDEBUG</span>
00076     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a4">PROOT_CONTROL</a>,  <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"NetworkProvider"</span> },                 <span class="comment">// PMAP_NETWORK</span>
00077     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a0">PROOT_CPANEL</a>,   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Desktop\\WindowMetrics"</span> },          <span class="comment">// PMAP_METRICS</span>
00078     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a6">PROOT_KEYBOARD</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span> },                                <span class="comment">// PMAP_UKBDLAYOUT</span>
00079     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a6">PROOT_KEYBOARD</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Toggle"</span> },                          <span class="comment">// PMAP_UKBDLAYOUTTOGGLE</span>
00080     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a2">PROOT_CURRENTM</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Winlogon"</span> },                        <span class="comment">// PMAP_WINLOGON</span>
00081     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a1">PROOT_ACCESS</a>,   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Keyboard Preference"</span> },             <span class="comment">// PMAP_KEYBOARDPREF</span>
00082     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a1">PROOT_ACCESS</a>,   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Blind Access"</span> },                    <span class="comment">// PMAP_SCREENREADER</span>
00083     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a1">PROOT_ACCESS</a>,   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"HighContrast"</span> },                    <span class="comment">// PMAP_HIGHCONTRAST</span>
00084     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a2">PROOT_CURRENTM</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"IME Compatibility"</span> },               <span class="comment">// PMAP_IMECOMPAT</span>
00085     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a2">PROOT_CURRENTM</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"IMM"</span> },                             <span class="comment">// PMAP_IMM</span>
00086     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a4">PROOT_CONTROL</a>,  <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Session Manager\\SubSystems\\Pool"</span> },<span class="comment">// PMAP_POOLLIMITS</span>
00087     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a2">PROOT_CURRENTM</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Compatibility32"</span> },                  <span class="comment">// PMAP_COMPAT32</span>
00088     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a2">PROOT_CURRENTM</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"WOW\\SetupPrograms"</span> },               <span class="comment">// PMAP_SETUPPROGRAMNAMES</span>
00089     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a0">PROOT_CPANEL</a>,   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Input Method"</span> },                     <span class="comment">// PMAP_INPUTMETHOD</span>
00090     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a2">PROOT_CURRENTM</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Compatibility2"</span> },                   <span class="comment">// PMAP_COMPAT2</span>
00091     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a5">PROOT_SERVICES</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Mouclass\\Parameters"</span> },             <span class="comment">// PMAP_MOUCLASS_PARAMS</span>
00092     { <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a5">PROOT_SERVICES</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Kbdclass\\Parameters"</span> },             <span class="comment">// PMAP_KBDCLASS_PARAMS</span>
00093 };
00094 
<a name="l00095"></a><a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a11">00095</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a11">gdwPolicyFlags</a> = <a class="code" href="../../d4/d1/userk_8h.html#a739">POLICY_ALL</a>;
<a name="l00096"></a><a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a12">00096</a> WCHAR <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a12">PreviousUserStringBuf</a>[256];
<a name="l00097"></a><a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a13">00097</a> UNICODE_STRING <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a13">PreviousUserString</a> = {0, <span class="keyword">sizeof</span> <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a12">PreviousUserStringBuf</a>, <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a12">PreviousUserStringBuf</a>};
<a name="l00098"></a><a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a14">00098</a> LUID <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a14">luidPrevious</a>;
00099 
<a name="l00100"></a><a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a15">00100</a> CONST WCHAR <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a15">wszDefaultUser</a>[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\User\\.Default"</span>;
<a name="l00101"></a><a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a16">00101</a> UNICODE_STRING <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a16">DefaultUserString</a> = {<span class="keyword">sizeof</span> <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a15">wszDefaultUser</a> - <span class="keyword">sizeof</span>(WCHAR), <span class="keyword">sizeof</span> <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a15">wszDefaultUser</a>, (WCHAR *)<a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a15">wszDefaultUser</a>};
00102 
<a name="l00103"></a><a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a19">00103</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a19">InitPreviousUserString</a>(<span class="keywordtype">void</span>) {
00104     UNICODE_STRING UserString;
00105     LUID           luidCaller;
00106 
00107     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00108 
00109     <span class="comment">/*</span>
00110 <span class="comment">     * Speed hack, check if luid of this process == system or previous to</span>
00111 <span class="comment">     * save work.</span>
00112 <span class="comment">     */</span>
00113     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d4/d1/userk_8h.html#a961">GetProcessLuid</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;luidCaller))) {
00114 
00115         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;luidCaller, &amp;<a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a14">luidPrevious</a>)) {
00116             <span class="keywordflow">return</span>;   <span class="comment">// same as last time - no work.</span>
00117         }
00118         <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a14">luidPrevious</a> = luidCaller;
00119 
00120         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;luidCaller, &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a244">luidSystem</a>))
00121             <span class="keywordflow">goto</span> DefaultUser;
00122 
00123     } <span class="keywordflow">else</span> {
00124         <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a14">luidPrevious</a> = RtlConvertLongToLuid(0);
00125     }
00126 
00127     <span class="comment">/*</span>
00128 <span class="comment">     * Set up current user registry base string.</span>
00129 <span class="comment">     */</span>
00130     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a26">RtlFormatCurrentUserKeyPath</a>(&amp;UserString))) {
00131 
00132 DefaultUser:
00133 
00134         <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>(&amp;<a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a13">PreviousUserString</a>, &amp;<a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a16">DefaultUserString</a>);
00135 
00136     } <span class="keywordflow">else</span> {
00137         UserAssert(<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a12">PreviousUserStringBuf</a>) &gt;= UserString.Length + 4);
00138         <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>(&amp;<a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a13">PreviousUserString</a>, &amp;UserString);
00139         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;UserString);
00140     }
00141 
00142     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;<a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a13">PreviousUserString</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\"</span>);
00143 
00144 }
00145 
<a name="l00146"></a><a class="code" href="../../d8/d3/structtagPROFILEUSERNAME.html">00146</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d8/d3/structtagPROFILEUSERNAME.html">tagPROFILEUSERNAME</a> {
<a name="l00147"></a><a class="code" href="../../d8/d3/structtagPROFILEUSERNAME.html#o0">00147</a>     WCHAR <a class="code" href="../../d8/d3/structtagPROFILEUSERNAME.html#o0">awcName</a>[<a class="code" href="../../d4/d1/userk_8h.html#a735">MAXPROFILEBUF</a>];
<a name="l00148"></a><a class="code" href="../../d8/d3/structtagPROFILEUSERNAME.html#o1">00148</a>     UNICODE_STRING <a class="code" href="../../d8/d3/structtagPROFILEUSERNAME.html#o1">NameString</a>;
00149 } <a class="code" href="../../d8/d3/structtagPROFILEUSERNAME.html">PROFILEUSERNAME</a>, *<a class="code" href="../../d8/d3/structtagPROFILEUSERNAME.html">PPROFILEUSERNAME</a>;
00150 
<a name="l00151"></a><a class="code" href="../../d4/d1/userk_8h.html#a2000">00151</a> PUNICODE_STRING <a class="code" href="../../d4/d1/userk_8h.html#a2000">CreateProfileUserName</a>(<a class="code" href="../../d5/d1/struct__TL.html">TL</a> *ptl)
00152 {
00153     <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a18">PPROFILEUSERNAME</a> pMapName;
00154 
00155     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00156 
00157     pMapName = UserAllocPoolWithQuota(<span class="keyword">sizeof</span> (<a class="code" href="../../d8/d3/structtagPROFILEUSERNAME.html">PROFILEUSERNAME</a>), TAG_PROFILEUSERNAME);
00158     <span class="keywordflow">if</span> (!pMapName) {
00159         RIPMSG0(RIP_WARNING, <span class="stringliteral">"CreateProfileUserName: Allocation failed"</span>);
00160         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00161     }
00162 
00163     <a class="code" href="../../d4/d1/userk_8h.html#a137">ThreadLockPool</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), pMapName, ptl);
00164     pMapName-&gt;<a class="code" href="../../d8/d3/structtagPROFILEUSERNAME.html#o1">NameString</a>.Length = 0;
00165     pMapName-&gt;<a class="code" href="../../d8/d3/structtagPROFILEUSERNAME.html#o1">NameString</a>.MaximumLength = <span class="keyword">sizeof</span> (pMapName-&gt;<a class="code" href="../../d8/d3/structtagPROFILEUSERNAME.html#o0">awcName</a>);
00166     pMapName-&gt;<a class="code" href="../../d8/d3/structtagPROFILEUSERNAME.html#o1">NameString</a>.Buffer = pMapName-&gt;<a class="code" href="../../d8/d3/structtagPROFILEUSERNAME.html#o0">awcName</a>;
00167 
00168     <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a19">InitPreviousUserString</a>();
00169 
00170     <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>(&amp;pMapName-&gt;<a class="code" href="../../d8/d3/structtagPROFILEUSERNAME.html#o1">NameString</a>, &amp;<a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a13">PreviousUserString</a>);
00171     <span class="keywordflow">return</span> &amp;(pMapName-&gt;<a class="code" href="../../d8/d3/structtagPROFILEUSERNAME.html#o1">NameString</a>);
00172 }
00173 
<a name="l00174"></a><a class="code" href="../../d4/d1/userk_8h.html#a2001">00174</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a2001">FreeProfileUserName</a>(PUNICODE_STRING pProfileUserName,<a class="code" href="../../d5/d1/struct__TL.html">TL</a> *ptl) {
00175     UNREFERENCED_PARAMETER(ptl);
00176     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00177     <span class="keywordflow">if</span> (pProfileUserName) {
00178         <a class="code" href="../../d4/d1/userk_8h.html#a139">ThreadUnlockAndFreePool</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), ptl);
00179     }
00180 }
00181 
00182 <span class="comment">/*****************************************************************************\</span>
00183 <span class="comment">* RemoteOpenCacheKeyEx</span>
00184 <span class="comment">*</span>
00185 <span class="comment">* History:</span>
00186 <span class="comment">* 21-Jan-1998 CLupu  Ported from Citrix.</span>
00187 <span class="comment">\*****************************************************************************/</span>
<a name="l00188"></a><a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a22">00188</a> HANDLE <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a22">RemoteOpenCacheKeyEx</a>(
00189     UINT        idSection,
00190     ACCESS_MASK amRequest)
00191 {
00192     OBJECT_ATTRIBUTES OA;
00193     WCHAR             UnicodeStringBuf[512];
00194     UNICODE_STRING    UnicodeString;
00195     LONG              <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00196     HANDLE            hKey;
00197 
00198     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00199 
00200     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00201 
00202     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a9">aFastRegRoot</a>[<a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a10">aFastRegMap</a>[idSection].<a class="code" href="../../d1/d5/structtagFASTREGMAP.html#o0">idRoot</a>][0] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'M'</span>)
00203         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00204 
00205     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a351">gstrBaseWinStationName</a>[0] == 0)
00206         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00207 
00208     <span class="keywordflow">if</span> (amRequest != KEY_READ)
00209         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00210 
00211     UserAssert(idSection &lt;= <a class="code" href="../../d4/d1/userk_8h.html#a734">PMAP_LAST</a>);
00212     UnicodeString.Length        = 0;
00213     UnicodeString.MaximumLength = <span class="keyword">sizeof</span>(UnicodeStringBuf);
00214     UnicodeString.Buffer        = UnicodeStringBuf;
00215 
00216     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;UnicodeString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\"</span>);
00217     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;UnicodeString, WINSTATION_REG_NAME);
00218 
00219     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;UnicodeString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\"</span>);
00220     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;UnicodeString, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a351">gstrBaseWinStationName</a>);
00221     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;UnicodeString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\"</span>);
00222     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;UnicodeString, WIN_USEROVERRIDE);
00223     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;UnicodeString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\"</span>);
00224 
00225     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;UnicodeString,
00226                                       (PWSTR)(&amp;<a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a9">aFastRegRoot</a>[<a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a10">aFastRegMap</a>[idSection].idRoot][1]));
00227     UserAssert(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00228 
00229     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;UnicodeString,
00230                                       (PWSTR)(<a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a10">aFastRegMap</a>[idSection].szSection));
00231     UserAssert(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00232 
00233     <span class="comment">/*</span>
00234 <span class="comment">     * Open the key for kernel mode access</span>
00235 <span class="comment">     */</span>
00236     InitializeObjectAttributes(&amp;OA,
00237                                &amp;UnicodeString,
00238                                OBJ_CASE_INSENSITIVE,
00239                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00240                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00241 
00242     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwOpenKey(&amp;hKey, amRequest, &amp;OA);
00243 
00244     <span class="keywordflow">return</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ? hKey : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00245 }
00246 
00247 <span class="comment">/*****************************************************************************\</span>
00248 <span class="comment">* OpenCacheKeyEx</span>
00249 <span class="comment">*</span>
00250 <span class="comment">* Attempts to open a cached key for a given section.  If we are calling</span>
00251 <span class="comment">* for a client thread, we must check the access rights for the key after</span>
00252 <span class="comment">* opening it.</span>
00253 <span class="comment">*</span>
00254 <span class="comment">* Returns fSuccess.</span>
00255 <span class="comment">*</span>
00256 <span class="comment">* Note -- param 1 can be NULL.  If the section name is a per-user registry</span>
00257 <span class="comment">*         section, we ill use the first parameter if available or set up</span>
00258 <span class="comment">*         and use the cached one if the first parameter is NULL.</span>
00259 <span class="comment">*</span>
00260 <span class="comment">* History:</span>
00261 <span class="comment">* 03-Dec-1993 SanfordS  Created.</span>
00262 <span class="comment">\*****************************************************************************/</span>
<a name="l00263"></a><a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a23">00263</a> HANDLE <a class="code" href="../../d4/d1/userk_8h.html#a2002">OpenCacheKeyEx</a>(
00264     PUNICODE_STRING pMapName OPTIONAL,
00265     UINT        idSection,
00266     ACCESS_MASK amRequest,
00267     PDWORD      pdwPolicyFlags
00268     )
00269 {
00270     OBJECT_ATTRIBUTES OA;
00271     WCHAR             UnicodeStringBuf[256];
00272     UNICODE_STRING    UnicodeString;
00273     LONG              <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00274     HANDLE            hKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00275     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>         peCurrent = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00276     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>             dwPolicyFlags;
00277 
00278     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00279 
00280     UserAssert(idSection &lt;= <a class="code" href="../../d4/d1/userk_8h.html#a734">PMAP_LAST</a>);
00281 
00282     <span class="comment">/*</span>
00283 <span class="comment">     * If we're opening the desktop key for read access, we should be checking</span>
00284 <span class="comment">     * for relevant policy.</span>
00285 <span class="comment">     */</span>
00286     <span class="keywordflow">if</span> (idSection == <a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a> &amp;&amp; amRequest == KEY_READ &amp;&amp; pdwPolicyFlags) {
00287         UserAssert(!(*pdwPolicyFlags &amp; ~<a class="code" href="../../d4/d1/userk_8h.html#a739">POLICY_ALL</a>));
00288         dwPolicyFlags = *pdwPolicyFlags;
00289     } <span class="keywordflow">else</span> {
00290         dwPolicyFlags = <a class="code" href="../../d4/d1/userk_8h.html#a736">POLICY_NONE</a>;
00291     }
00292 
00293 TryAgain:
00294 
00295     UnicodeString.Length        = 0;
00296     UnicodeString.MaximumLength = <span class="keyword">sizeof</span>(UnicodeStringBuf);
00297     UnicodeString.Buffer        = UnicodeStringBuf;
00298 
00299 
00300     <span class="keywordflow">if</span> (dwPolicyFlags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a738">POLICY_MACHINE</a>) {
00301         dwPolicyFlags &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a738">POLICY_MACHINE</a>;
00302         <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;UnicodeString,
00303                                  <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\"</span>);
00304         <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;UnicodeString,
00305                                  <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Software\\Policies\\Microsoft\\Windows\\"</span>);
00306     } <span class="keywordflow">else</span> {
00307         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a9">aFastRegRoot</a>[<a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a10">aFastRegMap</a>[idSection].<a class="code" href="../../d1/d5/structtagFASTREGMAP.html#o0">idRoot</a>][0] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'M'</span>) {
00308             <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;UnicodeString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\"</span>);
00309         } <span class="keywordflow">else</span> {
00310             <span class="keywordflow">if</span> (!pMapName) {
00311                 <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a19">InitPreviousUserString</a>();
00312                 <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(
00313                     &amp;UnicodeString,
00314                     &amp;<a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a13">PreviousUserString</a>);
00315             } <span class="keywordflow">else</span> {
00316                 <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(
00317                     &amp;UnicodeString,
00318                     pMapName);
00319             }
00320         }
00321         <span class="keywordflow">if</span> (dwPolicyFlags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a737">POLICY_USER</a>) {
00322             dwPolicyFlags &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a737">POLICY_USER</a>;
00323             <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;UnicodeString,
00324                                      <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Software\\Policies\\Microsoft\\Windows\\"</span>);
00325         } <span class="keywordflow">else</span> {
00326             dwPolicyFlags &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a736">POLICY_NONE</a>;
00327         }
00328 
00329     }
00330 
00331     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;UnicodeString,
00332                              (PWSTR)&amp;<a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a9">aFastRegRoot</a>[<a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a10">aFastRegMap</a>[idSection].idRoot][1]);
00333 
00334     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;UnicodeString,
00335                              (PWSTR)<a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a10">aFastRegMap</a>[idSection].szSection);
00336 
00337 
00338     <span class="comment">/*</span>
00339 <span class="comment">     * Open the key for kernel mode access</span>
00340 <span class="comment">     */</span>
00341     InitializeObjectAttributes(&amp;OA,
00342                                &amp;UnicodeString,
00343                                OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE,
00344                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00345                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00346 
00347     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwOpenKey(&amp;hKey, amRequest, &amp;OA);
00348 
00349     <span class="keywordflow">if</span> (
00350         (amRequest == KEY_READ)   ||     <span class="comment">/*</span>
00351 <span class="comment">                                          * We must be able to read</span>
00352 <span class="comment">                                          * our registry settings.</span>
00353 <span class="comment">                                          */</span>
00354         (peCurrent == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a>)  ||
00355         (peCurrent == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a300">gpepInit</a>)
00356              ) {
00357 
00358     } <span class="keywordflow">else</span> {
00359         <span class="comment">/*</span>
00360 <span class="comment">         * Now check if the user has access to the key</span>
00361 <span class="comment">         */</span>
00362 
00363         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00364             PVOID pKey;
00365             <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> Status2;
00366             Status2 = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(hKey,
00367                                         amRequest,
00368                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00369                                         <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00370                                         &amp;pKey,
00371                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00372 
00373             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status2)) {
00374                 <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1271">AccessCheckObject</a>(pKey, amRequest, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a303">KeyMapping</a>)) {
00375                     ZwClose(hKey);
00376                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
00377                 }
00378                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pKey);
00379             } <span class="keywordflow">else</span> {
00380                 ZwClose(hKey);
00381                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
00382             }
00383         }
00384 
00385     }
00386 
00387 <span class="preprocessor">#if DBG</span>
00388 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00389         UnicodeStringBuf[UnicodeString.Length / 2] = 0;
00390 
00391         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;UniqueProcessId != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a>) {
00392             RIPMSG1(RIP_WARNING | RIP_THERESMORE, <span class="stringliteral">"OpenCacheKeyEx failed with Status = %lx key:"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00393             RIPMSG1(RIP_WARNING | RIP_THERESMORE | RIP_NONAME | RIP_NONEWLINE, <span class="stringliteral">" %ws\\"</span>, UnicodeStringBuf);
00394         }
00395     }
00396 <span class="preprocessor">#endif DBG</span>
00397 <span class="preprocessor"></span>
00398     <span class="comment">/*</span>
00399 <span class="comment">     * If we didn't succeed and we're not down to bottom of policy chain, try again.</span>
00400 <span class="comment">     */</span>
00401     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp; dwPolicyFlags) {
00402         <span class="keywordflow">goto</span> TryAgain;
00403     }
00404 
00405     <span class="comment">/*</span>
00406 <span class="comment">     * Update policy level</span>
00407 <span class="comment">     */</span>
00408     <span class="keywordflow">if</span> (pdwPolicyFlags) {
00409         *pdwPolicyFlags = dwPolicyFlags;
00410     }
00411 
00412     <span class="keywordflow">return</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ? hKey : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00413 }
00414 
00415 
00416 <span class="comment">/*****************************************************************************\</span>
00417 <span class="comment">* CheckDesktopPolicy</span>
00418 <span class="comment">*</span>
00419 <span class="comment">* Check if a desktop value has an associated policy.</span>
00420 <span class="comment">*</span>
00421 <span class="comment">* Returns TRUE if there is a policy, FALSE otherwise.</span>
00422 <span class="comment">*</span>
00423 <span class="comment">* History:</span>
00424 <span class="comment">* 07-Feb-2000 JerrySh   Created.</span>
00425 <span class="comment">\*****************************************************************************/</span>
<a name="l00426"></a><a class="code" href="../../d4/d1/userk_8h.html#a2003">00426</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a2003">CheckDesktopPolicy</a>(
00427     PUNICODE_STRING pProfileUserName OPTIONAL,
00428     PCWSTR      lpKeyName
00429     )
00430 {
00431     WCHAR          szKey[80];
00432     HANDLE         hKey;
00433     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>          cbSize;
00434     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>       <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00435     UNICODE_STRING UnicodeString;
00436     KEY_VALUE_BASIC_INFORMATION  KeyInfo;
00437     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>          dwPolicyFlags = <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a11">gdwPolicyFlags</a> &amp; (<a class="code" href="../../d4/d1/userk_8h.html#a738">POLICY_MACHINE</a> | <a class="code" href="../../d4/d1/userk_8h.html#a737">POLICY_USER</a>);
00438 
00439     <span class="comment">/*</span>
00440 <span class="comment">     * If there is no policy or the caller is winlogon, let it go.</span>
00441 <span class="comment">     */</span>
00442     <span class="keywordflow">if</span> (!dwPolicyFlags || <a class="code" href="../../d4/d1/userk_8h.html#a19">GetCurrentProcessId</a>() == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a>) {
00443         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00444     }
00445 
00446     <span class="comment">/*</span>
00447 <span class="comment">     * Convert the ID to a string if we need to.</span>
00448 <span class="comment">     */</span>
00449     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(lpKeyName)) {
00450         <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(lpKeyName), szKey, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(szKey));
00451         lpKeyName = szKey;
00452     }
00453 
00454 TryAgain:
00455 
00456     <span class="comment">/*</span>
00457 <span class="comment">     * Try to open a key.</span>
00458 <span class="comment">     */</span>
00459     <span class="keywordflow">if</span> ((hKey = <a class="code" href="../../d4/d1/userk_8h.html#a2002">OpenCacheKeyEx</a>(pProfileUserName,
00460                                <a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>,
00461                                KEY_READ,
00462                                &amp;dwPolicyFlags)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00463         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00464     }
00465 
00466     <span class="comment">/*</span>
00467 <span class="comment">     * See if the value exists.</span>
00468 <span class="comment">     */</span>
00469     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, lpKeyName);
00470     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQueryValueKey(hKey,
00471                              &amp;UnicodeString,
00472                              KeyValueBasicInformation,
00473                              &amp;KeyInfo,
00474                              <span class="keyword">sizeof</span>(KeyInfo),
00475                              &amp;cbSize);
00476 
00477     ZwClose(hKey);
00478 
00479     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a3">NT_ERROR</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00480         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00481     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dwPolicyFlags) {
00482         <span class="keywordflow">goto</span> TryAgain;
00483     } <span class="keywordflow">else</span> {
00484         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00485     }
00486 }
00487 
00488 
00489 <span class="comment">/*****************************************************************************\</span>
00490 <span class="comment">* CheckDesktopPolicyChange</span>
00491 <span class="comment">*</span>
00492 <span class="comment">* Check if policy has changed since last time we checked.</span>
00493 <span class="comment">*</span>
00494 <span class="comment">* Returns TRUE if policy changed, FASLE otherwise.</span>
00495 <span class="comment">*</span>
00496 <span class="comment">* History:</span>
00497 <span class="comment">* 07-Feb-2000 JerrySh   Created.</span>
00498 <span class="comment">\*****************************************************************************/</span>
<a name="l00499"></a><a class="code" href="../../d4/d1/userk_8h.html#a2004">00499</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a2004">CheckDesktopPolicyChange</a>(
00500     PUNICODE_STRING pProfileUserName OPTIONAL
00501     )
00502 {
00503     <span class="keyword">static</span> LARGE_INTEGER  LastMachineWriteTime;
00504     <span class="keyword">static</span> LARGE_INTEGER  LastUserWriteTime;
00505     KEY_BASIC_INFORMATION KeyInfo;
00506     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>                  bPolicyChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00507     HANDLE                hKey;
00508     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>                 cbSize;
00509     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>                 dwPolicyFlags;
00510 
00511     <span class="comment">/*</span>
00512 <span class="comment">     * Check if machine policy has changed since last time we checked.</span>
00513 <span class="comment">     */</span>
00514     dwPolicyFlags = <a class="code" href="../../d4/d1/userk_8h.html#a738">POLICY_MACHINE</a>;
00515     KeyInfo.LastWriteTime.QuadPart = 0;
00516     hKey = <a class="code" href="../../d4/d1/userk_8h.html#a2002">OpenCacheKeyEx</a>(pProfileUserName,
00517                           <a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>,
00518                           KEY_READ,
00519                           &amp;dwPolicyFlags);
00520     <span class="keywordflow">if</span> (hKey) {
00521         ZwQueryKey(hKey,
00522                    KeyValueBasicInformation,
00523                    &amp;KeyInfo,
00524                    <span class="keyword">sizeof</span>(KeyInfo),
00525                    &amp;cbSize);
00526         ZwClose(hKey);
00527         <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a11">gdwPolicyFlags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a738">POLICY_MACHINE</a>;
00528     } <span class="keywordflow">else</span> {
00529         <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a11">gdwPolicyFlags</a> &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a738">POLICY_MACHINE</a>;
00530     }
00531     <span class="keywordflow">if</span> (LastMachineWriteTime.QuadPart != KeyInfo.LastWriteTime.QuadPart) {
00532         LastMachineWriteTime.QuadPart = KeyInfo.LastWriteTime.QuadPart;
00533         bPolicyChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00534     }
00535 
00536     <span class="comment">/*</span>
00537 <span class="comment">     * Check if user policy has changed since last time we checked.</span>
00538 <span class="comment">     */</span>
00539     dwPolicyFlags = <a class="code" href="../../d4/d1/userk_8h.html#a737">POLICY_USER</a>;
00540     KeyInfo.LastWriteTime.QuadPart = 0;
00541     hKey = <a class="code" href="../../d4/d1/userk_8h.html#a2002">OpenCacheKeyEx</a>(pProfileUserName,
00542                           <a class="code" href="../../d4/d1/userk_8h.html#a698">PMAP_DESKTOP</a>,
00543                           KEY_READ,
00544                           &amp;dwPolicyFlags);
00545     <span class="keywordflow">if</span> (hKey) {
00546         ZwQueryKey(hKey,
00547                    KeyValueBasicInformation,
00548                    &amp;KeyInfo,
00549                    <span class="keyword">sizeof</span>(KeyInfo),
00550                    &amp;cbSize);
00551         ZwClose(hKey);
00552         <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a11">gdwPolicyFlags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a737">POLICY_USER</a>;
00553     } <span class="keywordflow">else</span> {
00554         <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a11">gdwPolicyFlags</a> &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a737">POLICY_USER</a>;
00555     }
00556     <span class="keywordflow">if</span> (LastUserWriteTime.QuadPart != KeyInfo.LastWriteTime.QuadPart) {
00557         LastUserWriteTime.QuadPart = KeyInfo.LastWriteTime.QuadPart;
00558         bPolicyChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00559     }
00560 
00561     <span class="keywordflow">return</span> bPolicyChanged;
00562 }
00563 
00564 
00565 <span class="comment">/*****************************************************************************\</span>
00566 <span class="comment">* FastGetProfileDwordW</span>
00567 <span class="comment">*</span>
00568 <span class="comment">* Reads a REG_DWORD type key from the registry.</span>
00569 <span class="comment">*</span>
00570 <span class="comment">* returns value read or default value on failure.</span>
00571 <span class="comment">*</span>
00572 <span class="comment">* History:</span>
00573 <span class="comment">* 02-Dec-1993 SanfordS  Created.</span>
00574 <span class="comment">\*****************************************************************************/</span>
<a name="l00575"></a><a class="code" href="../../d4/d1/userk_8h.html#a2006">00575</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d1/userk_8h.html#a2006">FastGetProfileDwordW</a>(PUNICODE_STRING pProfileUserName OPTIONAL,
00576     UINT    idSection,
00577     LPCWSTR lpKeyName,
00578     DWORD   dwDefault
00579     )
00580 {
00581     HANDLE         hKey;
00582     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>          cbSize;
00583     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>          dwRet;
00584     LONG           <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00585     UNICODE_STRING UnicodeString;
00586     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>           Buf[<span class="keyword">sizeof</span>(KEY_VALUE_PARTIAL_INFORMATION) + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)];
00587 
00588     UserAssert(idSection &lt;= <a class="code" href="../../d4/d1/userk_8h.html#a734">PMAP_LAST</a>);
00589 
00590     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>) {
00591 
00592         hKey = <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a22">RemoteOpenCacheKeyEx</a>(idSection, KEY_READ);
00593         <span class="keywordflow">if</span> (hKey != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00594             <span class="keywordflow">goto</span> Override;
00595         }
00596     }
00597 
00598     <span class="keywordflow">if</span> ((hKey = <a class="code" href="../../d4/d1/userk_8h.html#a2002">OpenCacheKeyEx</a>(pProfileUserName,
00599                                idSection,
00600                                KEY_READ,
00601                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00602         RIPMSG1(RIP_WARNING | RIP_NONAME, <span class="stringliteral">"%ws"</span>, lpKeyName);
00603         <span class="keywordflow">return</span> dwDefault;
00604     }
00605 
00606 Override:
00607 
00608     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, lpKeyName);
00609     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQueryValueKey(hKey,
00610                              &amp;UnicodeString,
00611                              KeyValuePartialInformation,
00612                              (PKEY_VALUE_PARTIAL_INFORMATION)Buf,
00613                              <span class="keyword">sizeof</span>(Buf),
00614                              &amp;cbSize);
00615 
00616     dwRet = dwDefault;
00617 
00618     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00619 
00620         dwRet = *((PDWORD)((PKEY_VALUE_PARTIAL_INFORMATION)Buf)-&gt;Data);
00621 
00622     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_OBJECT_NAME_NOT_FOUND) {
00623 
00624         RIPMSG1(RIP_WARNING,
00625                 <span class="stringliteral">"FastGetProfileDwordW: ObjectName not found: %ws"</span>,
00626                 lpKeyName);
00627     }
00628 
00629     ZwClose(hKey);
00630 
00631     <span class="keywordflow">return</span> dwRet;
00632 }
00633 
00634 <span class="comment">/*****************************************************************************\</span>
00635 <span class="comment">* FastGetProfileKeysW()</span>
00636 <span class="comment">*</span>
00637 <span class="comment">* Reads all key names in the given section.</span>
00638 <span class="comment">*</span>
00639 <span class="comment">* History:</span>
00640 <span class="comment">* 15-Dec-1994 JimA      Created.</span>
00641 <span class="comment">\*****************************************************************************/</span>
<a name="l00642"></a><a class="code" href="../../d4/d1/userk_8h.html#a2005">00642</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d1/userk_8h.html#a2005">FastGetProfileKeysW</a>(PUNICODE_STRING pProfileUserName OPTIONAL,
00643     UINT    idSection,
00644     LPCWSTR lpDefault,
00645     LPWSTR  *lpReturnedString
00646     )
00647 {
00648     HANDLE                       hKey;
00649     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>                        cchSize;
00650     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>                        cchKey;
00651     LONG                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00652     WCHAR                        <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[256 + 6];
00653     PKEY_VALUE_BASIC_INFORMATION pKeyInfo;
00654     ULONG                        iValue;
00655     LPWSTR                       lpTmp;
00656     LPWSTR                       lpKeys = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00657     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>                        dwPoolSize;
00658 
00659     UserAssert(idSection &lt;= <a class="code" href="../../d4/d1/userk_8h.html#a734">PMAP_LAST</a>);
00660 
00661     <span class="keywordflow">if</span> ((hKey = <a class="code" href="../../d4/d1/userk_8h.html#a2002">OpenCacheKeyEx</a>(pProfileUserName,
00662                                idSection,
00663                                KEY_READ,
00664                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00665         RIPMSG0(RIP_WARNING | RIP_NONAME, <span class="stringliteral">""</span>);
00666         <span class="keywordflow">goto</span> DefExit;
00667     }
00668 
00669     pKeyInfo          = (PKEY_VALUE_BASIC_INFORMATION)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00670     cchSize           = 0;
00671     *lpReturnedString = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00672     iValue            = 0;
00673 
00674     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00675 
00676 <span class="preprocessor">#if DBG</span>
00677 <span class="preprocessor"></span>        wcscpy(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> + 256, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"DON'T"</span>);
00678 <span class="preprocessor">#endif</span>
00679 <span class="preprocessor"></span>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwEnumerateValueKey(hKey,
00680                                      iValue,
00681                                      KeyValueBasicInformation,
00682                                      pKeyInfo,
00683                                      <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>),
00684                                      &amp;cchKey);
00685 
00686         UserAssert(_wcsicmp(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> + 256, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"DON'T"</span>) == 0);
00687 
00688         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NO_MORE_ENTRIES) {
00689 
00690             <span class="keywordflow">break</span>;
00691 
00692         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00693 
00694             <span class="keywordflow">if</span> (lpKeys) {
00695                 UserFreePool(lpKeys);
00696                 lpKeys = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00697             }
00698             <span class="keywordflow">goto</span> DefExit;
00699         }
00700 
00701         UserAssert(pKeyInfo-&gt;NameLength * <span class="keyword">sizeof</span>(WCHAR) &lt;=
00702                    <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>) - <span class="keyword">sizeof</span>(KEY_VALUE_BASIC_INFORMATION));
00703 
00704         UserAssert(cchKey &lt;= <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>));
00705 
00706         <span class="comment">/*</span>
00707 <span class="comment">         * A key was found.  Allocate space for it.  Note that</span>
00708 <span class="comment">         * NameLength is in bytes.</span>
00709 <span class="comment">         */</span>
00710         cchKey   = cchSize;
00711         cchSize += pKeyInfo-&gt;NameLength + <span class="keyword">sizeof</span>(WCHAR);
00712 
00713         <span class="keywordflow">if</span> (lpKeys == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00714 
00715             dwPoolSize = cchSize + <span class="keyword">sizeof</span>(WCHAR);
00716             lpKeys = UserAllocPoolWithQuota(dwPoolSize, TAG_PROFILE);
00717 
00718         } <span class="keywordflow">else</span> {
00719 
00720             lpTmp = lpKeys;
00721             lpKeys = UserReAllocPoolWithQuota(lpTmp,
00722                                               dwPoolSize,
00723                                               cchSize + <span class="keyword">sizeof</span>(WCHAR),
00724                                               TAG_PROFILE);
00725 
00726             <span class="comment">/*</span>
00727 <span class="comment">             * Free the original buffer if the allocation fails</span>
00728 <span class="comment">             */</span>
00729             <span class="keywordflow">if</span> (lpKeys == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00730                 UserFreePool(lpTmp);
00731             }
00732             dwPoolSize = cchSize + <span class="keyword">sizeof</span>(WCHAR);
00733         }
00734 
00735         <span class="comment">/*</span>
00736 <span class="comment">         * Check for out of memory.</span>
00737 <span class="comment">         */</span>
00738         <span class="keywordflow">if</span> (lpKeys == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00739             <span class="keywordflow">goto</span> DefExit;
00740 
00741         <span class="comment">/*</span>
00742 <span class="comment">         * NULL terminate the string and append it to</span>
00743 <span class="comment">         * the key list.</span>
00744 <span class="comment">         */</span>
00745         UserAssert(pKeyInfo-&gt;NameLength &lt; <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>) - <span class="keyword">sizeof</span>(KEY_VALUE_BASIC_INFORMATION));
00746 
00747         RtlCopyMemory(&amp;lpKeys[cchKey / <span class="keyword">sizeof</span>(WCHAR)], pKeyInfo-&gt;Name, pKeyInfo-&gt;NameLength);
00748         lpKeys[(cchKey + pKeyInfo-&gt;NameLength) / <span class="keyword">sizeof</span>(WCHAR)] = 0;
00749 
00750         iValue++;
00751     }
00752 
00753     <span class="comment">/*</span>
00754 <span class="comment">     * If no keys were found, return the default.</span>
00755 <span class="comment">     */</span>
00756     <span class="keywordflow">if</span> (iValue == 0) {
00757 
00758 DefExit:
00759 
00760         cchSize = wcslen(lpDefault)+1;
00761         lpKeys  = UserAllocPoolWithQuota((cchSize+1) * <span class="keyword">sizeof</span>(WCHAR), TAG_PROFILE);
00762 
00763         <span class="keywordflow">if</span> (lpKeys)
00764             wcscpy(lpKeys, lpDefault);
00765         <span class="keywordflow">else</span>
00766             cchSize = 0;
00767 
00768     } <span class="keywordflow">else</span> {
00769 
00770         <span class="comment">/*</span>
00771 <span class="comment">         * Turn the byte count into a char count.</span>
00772 <span class="comment">         */</span>
00773         cchSize /= <span class="keyword">sizeof</span>(WCHAR);
00774     }
00775 
00776     <span class="comment">/*</span>
00777 <span class="comment">     * Make sure hKey is closed.</span>
00778 <span class="comment">     */</span>
00779     <span class="keywordflow">if</span> (hKey)
00780         ZwClose(hKey);
00781 
00782     <span class="comment">/*</span>
00783 <span class="comment">     * Append the ending NULL.</span>
00784 <span class="comment">     */</span>
00785     <span class="keywordflow">if</span> (lpKeys)
00786         lpKeys[cchSize] = 0;
00787 
00788     *lpReturnedString = lpKeys;
00789 
00790     <span class="keywordflow">return</span> cchSize;
00791 }
00792 
00793 <span class="comment">/*****************************************************************************\</span>
00794 <span class="comment">* FastGetProfileStringW()</span>
00795 <span class="comment">*</span>
00796 <span class="comment">* Implements a fast version of the standard API using predefined registry</span>
00797 <span class="comment">* section indecies (PMAP_) that reference lazy-opened, cached registry</span>
00798 <span class="comment">* handles.  FastCloseProfileUserMapping() should be called to clean up</span>
00799 <span class="comment">* cached entries when fast profile calls are completed.</span>
00800 <span class="comment">*</span>
00801 <span class="comment">* This api does NOT implement the NULL lpKeyName feature of the real API.</span>
00802 <span class="comment">*</span>
00803 <span class="comment">* History:</span>
00804 <span class="comment">* 02-Dec-1993 SanfordS  Created.</span>
00805 <span class="comment">\*****************************************************************************/</span>
<a name="l00806"></a><a class="code" href="../../d4/d1/userk_8h.html#a2007">00806</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d1/userk_8h.html#a2007">FastGetProfileStringW</a>(PUNICODE_STRING pProfileUserName OPTIONAL,
00807     UINT    idSection,
00808     LPCWSTR lpKeyName,
00809     LPCWSTR lpDefault,
00810     LPWSTR  lpReturnedString,
00811     DWORD   cchBuf
00812     )
00813 {
00814     HANDLE                         hKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00815     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>                          cbSize;
00816     LONG                           <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00817     UNICODE_STRING                 UnicodeString;
00818     PKEY_VALUE_PARTIAL_INFORMATION pKeyInfo;
00819     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>                           bRemoteOverride = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00820     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>                          dwPolicyFlags = <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a11">gdwPolicyFlags</a>;
00821 
00822 
00823     UserAssert(idSection &lt;= <a class="code" href="../../d4/d1/userk_8h.html#a734">PMAP_LAST</a>);
00824     UserAssert(lpKeyName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00825 
00826     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>) {
00827         hKey = <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a22">RemoteOpenCacheKeyEx</a>(idSection, KEY_READ);
00828         <span class="keywordflow">if</span> (hKey != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00829             bRemoteOverride = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00830             <span class="keywordflow">goto</span> Override;
00831         }
00832     }
00833 
00834 TryAgain:
00835     <span class="keywordflow">if</span> ((hKey = <a class="code" href="../../d4/d1/userk_8h.html#a2002">OpenCacheKeyEx</a>(pProfileUserName,
00836                                idSection,
00837                                KEY_READ,
00838                                &amp;dwPolicyFlags)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00839 
00840 <span class="preprocessor">#if DBG</span>
00841 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;UniqueProcessId != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a>) {
00842             RIPMSG1(RIP_WARNING | RIP_NONAME, <span class="stringliteral">"%ws"</span>, lpKeyName);
00843         }
00844 <span class="preprocessor">#endif</span>
00845 <span class="preprocessor"></span>        <span class="keywordflow">goto</span> DefExit;
00846     }
00847 
00848 Override:
00849 
00850     cbSize = (cchBuf * <span class="keyword">sizeof</span>(WCHAR)) +
00851             FIELD_OFFSET(KEY_VALUE_PARTIAL_INFORMATION, Data);
00852 
00853     <span class="keywordflow">if</span> ((pKeyInfo = UserAllocPoolWithQuota(cbSize, TAG_PROFILE)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00854         <span class="keywordflow">goto</span> DefExit;
00855 
00856     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, lpKeyName);
00857     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQueryValueKey(hKey,
00858                              &amp;UnicodeString,
00859                              KeyValuePartialInformation,
00860                              pKeyInfo,
00861                              cbSize,
00862                              &amp;cbSize);
00863 
00864     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_OVERFLOW) {
00865         RIPMSG0(RIP_WARNING, <span class="stringliteral">"FastGetProfileStringW: Buffer overflow"</span>);
00866         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00867     }
00868 
00869     UserAssert(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) || (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_OBJECT_NAME_NOT_FOUND));
00870 
00871     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00872 
00873         <span class="keywordflow">if</span> (pKeyInfo-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(WCHAR)) {
00874 
00875             ((LPWSTR)(pKeyInfo-&gt;Data))[cchBuf - 1] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00876             wcscpy(lpReturnedString, (LPWSTR)pKeyInfo-&gt;Data);
00877 
00878         } <span class="keywordflow">else</span> {
00879             <span class="comment">/*</span>
00880 <span class="comment">             * Appears to be a bug with empty strings - only first</span>
00881 <span class="comment">             * byte is set to NULL. (SAS)</span>
00882 <span class="comment">             */</span>
00883             lpReturnedString[0] = TEXT(<span class="charliteral">'\0'</span>);
00884         }
00885 
00886         cchBuf = pKeyInfo-&gt;DataLength;
00887 
00888         UserFreePool(pKeyInfo);
00889 
00890         ZwClose(hKey);
00891 
00892         <span class="comment">/*</span>
00893 <span class="comment">         * data length includes terminating zero [bodind]</span>
00894 <span class="comment">         */</span>
00895         <span class="keywordflow">return</span> (cchBuf / <span class="keyword">sizeof</span>(WCHAR));
00896 
00897     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bRemoteOverride) {
00898         bRemoteOverride = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00899         UserFreePool(pKeyInfo);
00900         ZwClose(hKey);
00901         hKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00902         <span class="keywordflow">goto</span> TryAgain;
00903 
00904     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dwPolicyFlags) {
00905         UserFreePool(pKeyInfo);
00906         ZwClose(hKey);
00907         <span class="keywordflow">goto</span> TryAgain;
00908     }
00909 
00910     UserFreePool(pKeyInfo);
00911 
00912 DefExit:
00913 
00914     <span class="comment">/*</span>
00915 <span class="comment">     * Make sure the key is closed.</span>
00916 <span class="comment">     */</span>
00917     <span class="keywordflow">if</span> (hKey)
00918         ZwClose(hKey);
00919 
00920     <span class="comment">/*</span>
00921 <span class="comment">     * wcscopy copies terminating zero, but the length returned by</span>
00922 <span class="comment">     * wcslen does not, so add 1 to be consistent with success</span>
00923 <span class="comment">     * return [bodind]</span>
00924 <span class="comment">     */</span>
00925     <span class="keywordflow">if</span> (lpDefault != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00926         cchBuf = wcslen(lpDefault) + 1;
00927         RtlCopyMemory(lpReturnedString, lpDefault, cchBuf * <span class="keyword">sizeof</span>(WCHAR));
00928         <span class="keywordflow">return</span> cchBuf;
00929     }
00930 
00931     <span class="keywordflow">return</span> 0;
00932 }
00933 
00934 <span class="comment">/*****************************************************************************\</span>
00935 <span class="comment">* FastGetProfileIntW()</span>
00936 <span class="comment">*</span>
00937 <span class="comment">* Implements a fast version of the standard API using predefined registry</span>
00938 <span class="comment">* section indecies (PMAP_) that reference lazy-opened, cached registry</span>
00939 <span class="comment">* handles.  FastCloseProfileUserMapping() should be called to clean up</span>
00940 <span class="comment">* cached entries when fast profile calls are completed.</span>
00941 <span class="comment">*</span>
00942 <span class="comment">* History:</span>
00943 <span class="comment">* 02-Dec-1993 SanfordS  Created.</span>
00944 <span class="comment">\*****************************************************************************/</span>
<a name="l00945"></a><a class="code" href="../../d4/d1/userk_8h.html#a2008">00945</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d4/d1/userk_8h.html#a2008">FastGetProfileIntW</a>(PUNICODE_STRING pProfileUserName OPTIONAL,
00946     UINT    idSection,
00947     LPCWSTR lpKeyName,
00948     UINT    nDefault
00949     )
00950 {
00951     WCHAR          ValueBuf[40];
00952     UNICODE_STRING Value;
00953     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>           ReturnValue;
00954 
00955     UserAssert(idSection &lt;= <a class="code" href="../../d4/d1/userk_8h.html#a734">PMAP_LAST</a>);
00956 
00957     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a2007">FastGetProfileStringW</a>(pProfileUserName,
00958                                idSection,
00959                                lpKeyName,
00960                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00961                                ValueBuf,
00962                                <span class="keyword">sizeof</span>(ValueBuf) / <span class="keyword">sizeof</span>(WCHAR)
00963                                )) {
00964 
00965         <span class="keywordflow">return</span> nDefault;
00966     }
00967 
00968     <span class="comment">/*</span>
00969 <span class="comment">     * Convert string to int.</span>
00970 <span class="comment">     */</span>
00971     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Value, ValueBuf);
00972     <a class="code" href="../../d9/d3/cnvint_8c.html#a4">RtlUnicodeStringToInteger</a>(&amp;Value, 10, &amp;ReturnValue);
00973 
00974     <span class="keywordflow">return</span> ReturnValue;
00975 }
00976 
00977 <span class="comment">/*****************************************************************************\</span>
00978 <span class="comment">* FastWriteProfileStringW</span>
00979 <span class="comment">*</span>
00980 <span class="comment">* Implements a fast version of the standard API using predefined registry</span>
00981 <span class="comment">* section indecies (PMAP_) that reference lazy-opened, cached registry</span>
00982 <span class="comment">* handles.  FastCloseProfileUserMapping() should be called to clean up</span>
00983 <span class="comment">* cached entries when fast profile calls are completed.</span>
00984 <span class="comment">*</span>
00985 <span class="comment">* History:</span>
00986 <span class="comment">* 02-Dec-1993 SanfordS  Created.</span>
00987 <span class="comment">\*****************************************************************************/</span>
<a name="l00988"></a><a class="code" href="../../d4/d1/userk_8h.html#a2009">00988</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a2009">FastWriteProfileStringW</a>(PUNICODE_STRING pProfileUserName OPTIONAL,
00989     UINT    idSection,
00990     LPCWSTR lpKeyName,
00991     LPCWSTR lpString
00992     )
00993 {
00994     HANDLE         hKey;
00995     LONG           <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00996     UNICODE_STRING UnicodeString;
00997 
00998     UserAssert(idSection &lt;= <a class="code" href="../../d4/d1/userk_8h.html#a734">PMAP_LAST</a>);
00999 
01000     <span class="keywordflow">if</span> ((hKey = <a class="code" href="../../d4/d1/userk_8h.html#a2002">OpenCacheKeyEx</a>(pProfileUserName,
01001                                idSection,
01002                                KEY_WRITE,
01003                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01004         RIPMSG1(RIP_WARNING | RIP_NONAME, <span class="stringliteral">"%ws"</span>, lpKeyName);
01005         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01006     }
01007 
01008     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, lpKeyName);
01009     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwSetValueKey(hKey,
01010                            &amp;UnicodeString,
01011                            0,
01012                            REG_SZ,
01013                            (PVOID)lpString,
01014                            (wcslen(lpString) + 1) * <span class="keyword">sizeof</span>(WCHAR));
01015 
01016     ZwClose(hKey);
01017 
01018     <span class="keywordflow">return</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01019 }
01020 
01021 <span class="comment">/*****************************************************************************\</span>
01022 <span class="comment">* FastGetProfileIntFromID</span>
01023 <span class="comment">*</span>
01024 <span class="comment">* Just like FastGetProfileIntW except it reads the USER string table for the</span>
01025 <span class="comment">* key name.</span>
01026 <span class="comment">*</span>
01027 <span class="comment">* History:</span>
01028 <span class="comment">* 02-Dec-1993 SanfordS  Created.</span>
01029 <span class="comment">* 25-Feb-1995 BradG     Added TWIPS -&gt; Pixel conversion.</span>
01030 <span class="comment">\*****************************************************************************/</span>
<a name="l01031"></a><a class="code" href="../../d4/d1/userk_8h.html#a2010">01031</a> <span class="keywordtype">int</span> <a class="code" href="../../d4/d1/userk_8h.html#a2010">FastGetProfileIntFromID</a>(PUNICODE_STRING pProfileUserName OPTIONAL,
01032     UINT idSection,
01033     UINT idKey,
01034     <span class="keywordtype">int</span>  def
01035     )
01036 {
01037     <span class="keywordtype">int</span>   result;
01038     WCHAR szKey[80];
01039 
01040 
01041     UserAssert(idSection &lt;= <a class="code" href="../../d4/d1/userk_8h.html#a734">PMAP_LAST</a>);
01042 
01043     <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>, idKey, szKey, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(szKey));
01044 
01045     result = <a class="code" href="../../d4/d1/userk_8h.html#a2008">FastGetProfileIntW</a>(pProfileUserName,idSection, szKey, def);
01046 
01047     <span class="comment">/*</span>
01048 <span class="comment">     * If you change the below list of STR_* make sure you make a</span>
01049 <span class="comment">     * corresponding change in SetWindowMetricInt (rare.c)</span>
01050 <span class="comment">     */</span>
01051     <span class="keywordflow">switch</span> (idKey) {
01052     <span class="keywordflow">case</span> STR_BORDERWIDTH:
01053     <span class="keywordflow">case</span> STR_SCROLLWIDTH:
01054     <span class="keywordflow">case</span> STR_SCROLLHEIGHT:
01055     <span class="keywordflow">case</span> STR_CAPTIONWIDTH:
01056     <span class="keywordflow">case</span> STR_CAPTIONHEIGHT:
01057     <span class="keywordflow">case</span> STR_SMCAPTIONWIDTH:
01058     <span class="keywordflow">case</span> STR_SMCAPTIONHEIGHT:
01059     <span class="keywordflow">case</span> STR_MENUWIDTH:
01060     <span class="keywordflow">case</span> STR_MENUHEIGHT:
01061     <span class="keywordflow">case</span> STR_ICONHORZSPACING:
01062     <span class="keywordflow">case</span> STR_ICONVERTSPACING:
01063     <span class="keywordflow">case</span> STR_MINWIDTH:
01064     <span class="keywordflow">case</span> STR_MINHORZGAP:
01065     <span class="keywordflow">case</span> STR_MINVERTGAP:
01066         <span class="comment">/*</span>
01067 <span class="comment">         * Convert any registry values stored in TWIPS back to pixels</span>
01068 <span class="comment">         */</span>
01069         <span class="keywordflow">if</span> (result &lt; 0)
01070             result = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a141">MultDiv</a>(-result, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;dmLogPixels, 72 * 20);
01071         <span class="keywordflow">break</span>;
01072     }
01073 
01074     <span class="keywordflow">return</span> result;
01075 }
01076 
01077 <span class="comment">/*****************************************************************************\</span>
01078 <span class="comment">* FastGetProfileIntFromID</span>
01079 <span class="comment">*</span>
01080 <span class="comment">* Just like FastGetProfileStringW except it reads the USER string table for</span>
01081 <span class="comment">* the key name.</span>
01082 <span class="comment">*</span>
01083 <span class="comment">* History:</span>
01084 <span class="comment">* 02-Dec-1993 SanfordS  Created.</span>
01085 <span class="comment">\*****************************************************************************/</span>
<a name="l01086"></a><a class="code" href="../../d4/d1/userk_8h.html#a2011">01086</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d1/userk_8h.html#a2011">FastGetProfileStringFromIDW</a>(PUNICODE_STRING pProfileUserName OPTIONAL,
01087     UINT    idSection,
01088     UINT    idKey,
01089     LPCWSTR lpDefault,
01090     LPWSTR  lpReturnedString,
01091     DWORD   cch
01092     )
01093 {
01094     WCHAR szKey[80];
01095 
01096     UserAssert(idSection &lt;= <a class="code" href="../../d4/d1/userk_8h.html#a734">PMAP_LAST</a>);
01097 
01098     <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>, idKey, szKey, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(szKey));
01099 
01100     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a2007">FastGetProfileStringW</a>(pProfileUserName,
01101                                  idSection,
01102                                  szKey,
01103                                  lpDefault,
01104                                  lpReturnedString,
01105                                  cch
01106                                  );
01107 }
01108 
01109 <span class="comment">/*****************************************************************************\</span>
01110 <span class="comment">* FastWriteProfileValue</span>
01111 <span class="comment">*</span>
01112 <span class="comment">* History:</span>
01113 <span class="comment">* 06/10/96 GerardoB Renamed and added uType parameter</span>
01114 <span class="comment">\*****************************************************************************/</span>
<a name="l01115"></a><a class="code" href="../../d4/d1/userk_8h.html#a2012">01115</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a2012">FastWriteProfileValue</a>(PUNICODE_STRING pProfileUserName OPTIONAL,
01116     UINT    idSection,
01117     LPCWSTR lpKeyName,
01118     UINT    uType,
01119     LPBYTE  lpStruct,
01120     UINT    cbSizeStruct
01121     )
01122 {
01123     HANDLE         hKey;
01124     LONG           <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01125     UNICODE_STRING UnicodeString;
01126     WCHAR          szKey[<a class="code" href="../../d4/d1/userk_8h.html#a247">SERVERSTRINGMAXSIZE</a>];
01127 
01128     UserAssert(idSection &lt;= <a class="code" href="../../d4/d1/userk_8h.html#a734">PMAP_LAST</a>);
01129 
01130     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(lpKeyName)) {
01131         *szKey = (WCHAR)0;
01132         <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(lpKeyName), szKey, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(szKey));
01133         UserAssert(*szKey != (WCHAR)0);
01134         lpKeyName = szKey;
01135     }
01136 
01137     <span class="keywordflow">if</span> ((hKey = <a class="code" href="../../d4/d1/userk_8h.html#a2002">OpenCacheKeyEx</a>(pProfileUserName,
01138                                idSection,
01139                                KEY_WRITE,
01140                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01141         RIPMSG1(RIP_WARNING, <span class="stringliteral">"FastWriteProfileValue: Failed to open cache-key (%ws)"</span>, lpKeyName);
01142         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01143     }
01144 
01145     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, lpKeyName);
01146 
01147     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwSetValueKey(hKey,
01148                            &amp;UnicodeString,
01149                            0,
01150                            uType,
01151                            lpStruct,
01152                            cbSizeStruct);
01153     ZwClose(hKey);
01154 
01155 <span class="preprocessor">#if DBG</span>
01156 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01157         RIPMSG3 (RIP_WARNING, <span class="stringliteral">"FastWriteProfileValue: ZwSetValueKey Failed. Status:%#lx idSection:%#lx KeyName:%s"</span>,
01158                  <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, idSection, UnicodeString.Buffer);
01159     }
01160 <span class="preprocessor">#endif</span>
01161 <span class="preprocessor"></span>
01162     <span class="keywordflow">return</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01163 }
01164 
01165 <span class="comment">/*****************************************************************************\</span>
01166 <span class="comment">* FastGetProfileValue</span>
01167 <span class="comment">*</span>
01168 <span class="comment">* If cbSizeReturn is 0, just return the size of the data</span>
01169 <span class="comment">*</span>
01170 <span class="comment">* History:</span>
01171 <span class="comment">* 06/10/96 GerardoB Renamed</span>
01172 <span class="comment">\*****************************************************************************/</span>
<a name="l01173"></a><a class="code" href="../../d4/d1/userk_8h.html#a2013">01173</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d1/userk_8h.html#a2013">FastGetProfileValue</a>(PUNICODE_STRING pProfileUserName OPTIONAL,
01174     UINT    idSection,
01175     LPCWSTR lpKeyName,
01176     LPBYTE  lpDefault,
01177     LPBYTE  lpReturn,
01178     UINT    cbSizeReturn
01179     )
01180 {
01181     HANDLE                         hKey;
01182     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>                           cbSize;
01183     LONG                           <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01184     UNICODE_STRING                 UnicodeString;
01185     PKEY_VALUE_PARTIAL_INFORMATION pKeyInfo;
01186     WCHAR                          szKey[<a class="code" href="../../d4/d1/userk_8h.html#a247">SERVERSTRINGMAXSIZE</a>];
01187     KEY_VALUE_PARTIAL_INFORMATION  KeyInfo;
01188 
01189     UserAssert(idSection &lt;= <a class="code" href="../../d4/d1/userk_8h.html#a734">PMAP_LAST</a>);
01190 
01191     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(lpKeyName)) {
01192         *szKey = (WCHAR)0;
01193         <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(lpKeyName), szKey, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(szKey));
01194         UserAssert(*szKey != (WCHAR)0);
01195         lpKeyName = szKey;
01196     }
01197 
01198     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a328">gbRemoteSession</a>) {
01199         hKey = <a class="code" href="../../d1/d7/w32_2ntuser_2kernel_2profile_8c.html#a22">RemoteOpenCacheKeyEx</a>(idSection, KEY_READ);
01200         <span class="keywordflow">if</span> (hKey != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01201             <span class="keywordflow">goto</span> Override;
01202         }
01203     }
01204 
01205     <span class="keywordflow">if</span> ((hKey = <a class="code" href="../../d4/d1/userk_8h.html#a2002">OpenCacheKeyEx</a>(pProfileUserName,
01206                                idSection,
01207                                KEY_READ,
01208                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01209         <span class="comment">// if hi-word of lpKeName is 0, it is a resource number not a string</span>
01210 
01211         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(lpKeyName))
01212             RIPMSG1(RIP_WARNING, <span class="stringliteral">"FastGetProfileValue: Failed to open cache-key (%08x)"</span>, lpKeyName);
01213         <span class="keywordflow">else</span>
01214             RIPMSG1(RIP_WARNING | RIP_NONAME, <span class="stringliteral">"%ws"</span>, lpKeyName);
01215 
01216         <span class="keywordflow">goto</span> DefExit;
01217     }
01218 
01219 Override:
01220 
01221     <span class="keywordflow">if</span> (cbSizeReturn == 0) {
01222         cbSize = <span class="keyword">sizeof</span>(KeyInfo);
01223         pKeyInfo = &amp;KeyInfo;
01224     } <span class="keywordflow">else</span> {
01225         cbSize = cbSizeReturn + FIELD_OFFSET(KEY_VALUE_PARTIAL_INFORMATION, Data);
01226         <span class="keywordflow">if</span> ((pKeyInfo = UserAllocPoolWithQuota(cbSize, TAG_PROFILE)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01227             <span class="keywordflow">goto</span> DefExit;
01228         }
01229     }
01230 
01231     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, lpKeyName);
01232 
01233     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQueryValueKey(hKey,
01234                              &amp;UnicodeString,
01235                              KeyValuePartialInformation,
01236                              pKeyInfo,
01237                              cbSize,
01238                              &amp;cbSize);
01239 
01240     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01241 
01242         UserAssert(cbSizeReturn &gt;= pKeyInfo-&gt;DataLength);
01243 
01244         cbSize = pKeyInfo-&gt;DataLength;
01245         RtlCopyMemory(lpReturn, pKeyInfo-&gt;Data, cbSize);
01246 
01247         <span class="keywordflow">if</span> (cbSizeReturn != 0) {
01248             UserFreePool(pKeyInfo);
01249         }
01250         ZwClose(hKey);
01251 
01252         <span class="keywordflow">return</span> cbSize;
01253     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_OVERFLOW) &amp;&amp; (cbSizeReturn == 0)) {
01254         ZwClose(hKey);
01255         <span class="keywordflow">return</span> pKeyInfo-&gt;DataLength;
01256     }
01257 
01258 <span class="preprocessor">#if DBG</span>
01259 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_OBJECT_NAME_NOT_FOUND) {
01260         RIPMSG3 (RIP_WARNING, <span class="stringliteral">"FastGetProfileValue: ZwQueryValueKey Failed. Status:%#lx idSection:%#lx KeyName:%s"</span>,
01261                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, idSection, UnicodeString.Buffer);
01262     }
01263 <span class="preprocessor">#endif</span>
01264 <span class="preprocessor"></span>
01265     <span class="keywordflow">if</span> (cbSizeReturn != 0) {
01266         UserFreePool(pKeyInfo);
01267     }
01268 
01269 DefExit:
01270 
01271     <span class="keywordflow">if</span> (hKey)
01272         ZwClose(hKey);
01273 
01274     <span class="keywordflow">if</span> (lpDefault) {
01275         RtlMoveMemory(lpReturn, lpDefault, cbSizeReturn);
01276         <span class="keywordflow">return</span> cbSizeReturn;
01277     }
01278 
01279     <span class="keywordflow">return</span> 0;
01280 }
01281 
01282 <span class="comment">/*****************************************************************************\</span>
01283 <span class="comment">* UT_FastGetProfileIntsW</span>
01284 <span class="comment">*</span>
01285 <span class="comment">* Repeatedly calls FastGetProfileIntW on the given table.</span>
01286 <span class="comment">*</span>
01287 <span class="comment">* History:</span>
01288 <span class="comment">* 02-Dec-1993 SanfordS  Created.</span>
01289 <span class="comment">\*****************************************************************************/</span>
<a name="l01290"></a><a class="code" href="../../d4/d1/userk_8h.html#a2014">01290</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a2014">FastGetProfileIntsW</a>(PUNICODE_STRING pProfileUserName OPTIONAL,
01291     <a class="code" href="../../d0/d4/structtagPROFINTINFO.html">PPROFINTINFO</a> ppii
01292     )
01293 {
01294     WCHAR szKey[40];
01295 
01296     <span class="keywordflow">while</span> (ppii-&gt;<a class="code" href="../../d0/d4/structtagPROFINTINFO.html#o0">idSection</a> != 0) {
01297 
01298         <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>,
01299                              <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(ppii-&gt;<a class="code" href="../../d0/d4/structtagPROFINTINFO.html#o1">lpKeyName</a>),
01300                              szKey,
01301                              <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(szKey));
01302 
01303         *ppii-&gt;<a class="code" href="../../d0/d4/structtagPROFINTINFO.html#o3">puResult</a> = <a class="code" href="../../d4/d1/userk_8h.html#a2008">FastGetProfileIntW</a>(pProfileUserName,
01304                                                  ppii-&gt;<a class="code" href="../../d0/d4/structtagPROFINTINFO.html#o0">idSection</a>,
01305                                                  szKey,
01306                                                  ppii-&gt;<a class="code" href="../../d0/d4/structtagPROFINTINFO.html#o2">nDefault</a>
01307                                                  );
01308         ppii++;
01309     }
01310 
01311     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01312 }
01313 
01314 <span class="comment">/***************************************************************************\</span>
01315 <span class="comment">* UpdateWinIni</span>
01316 <span class="comment">*</span>
01317 <span class="comment">* Handles impersonation stuff and writes the given value to the registry.</span>
01318 <span class="comment">*</span>
01319 <span class="comment">* History:</span>
01320 <span class="comment">* 28-Jun-1991 MikeHar       Ported.</span>
01321 <span class="comment">* 03-Dec-1993 SanfordS      Used FastProfile calls, moved to profile.c</span>
01322 <span class="comment">\***************************************************************************/</span>
<a name="l01323"></a><a class="code" href="../../d4/d1/userk_8h.html#a2015">01323</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a2015">FastUpdateWinIni</a>(PUNICODE_STRING pProfileUserName OPTIONAL,
01324     UINT         idSection,
01325     UINT         wKeyNameId,
01326     LPWSTR       lpszValue
01327     )
01328 {
01329     WCHAR            szKeyName[40];
01330     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>             bResult = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01331 
01332     UserAssert(idSection &lt;= <a class="code" href="../../d4/d1/userk_8h.html#a734">PMAP_LAST</a>);
01333 
01334     <a class="code" href="../../d4/d1/userk_8h.html#a248">ServerLoadString</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>,
01335                          wKeyNameId,
01336                          szKeyName,
01337                          <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(szKeyName));
01338 
01339     bResult = <a class="code" href="../../d4/d1/userk_8h.html#a2009">FastWriteProfileStringW</a>(pProfileUserName,
01340                                           idSection, szKeyName, lpszValue);
01341 
01342     <span class="keywordflow">return</span> bResult;
01343 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:28 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
