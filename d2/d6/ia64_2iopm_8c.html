<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ia64/iopm.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>iopm.c File Reference</h1><code>#include "<a class="el" href="../../d1/d9/ki_8h-source.html">ki.h</a>"</code><br>

<p>
<a href="../../d3/d5/ia64_2iopm_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/ia64_2iopm_8c.html#a1">KiIA32SetPortMemory</a> (<a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/ia64_2iopm_8c.html#a2">KeIA32SetIoAccessMap</a> (ULONG MapNumber, PKIO_ACCESS_MAP IoAccessMap)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/ia64_2iopm_8c.html#a3">KeIA32QueryIoAccessMap</a> (ULONG MapNumber, PKIO_ACCESS_MAP IoAccessMap)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/ia64_2iopm_8c.html#a4">KeIA32IoSetAccessProcess</a> (<a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process, ULONG MapNumber)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/ia64_2iopm_8c.html#a5">KeIA32PortIsAccessable</a> (<a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process, ULONG Port, ULONG <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>PKIO_ACCESS_MAP&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d6/ia64_2iopm_8c.html#a0">VdmIoMaps</a> [IOPM_COUNT]</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a4" doxytag="ia64/iopm.c::KeIA32IoSetAccessProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KeIA32IoSetAccessProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>MapNumber</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/ia64_2iopm_8c-source.html#l00227">227</a> of file <a class="el" href="../../d3/d5/ia64_2iopm_8c-source.html">ia64/iopm.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, and <a class="el" href="../../d3/d5/ia64_2iopm_8c-source.html#l00363">KiIA32SetPortMemory()</a>.
<p>
<pre class="fragment"><div>00233                    :
00234 
00235     Set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> i/o access map which controls user mode i/o access
00236     <span class="keywordflow">for</span> a particular process.
00237 
00238 Arguments:
00239 
00240     Process - Pointer to kernel process object describing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00241     process which <span class="keywordflow">for</span> which a map <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be set.
00242 
00243     MapNumber - Number of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> map to set.  Value of map <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00244     defined by <a class="code" href="../../d2/d6/ia64_2iopm_8c.html#a4">KeIA32IoSetAccessProcess</a>.  Setting MapNumber
00245     to IO_ACCESS_MAP_NONE will disallow any user mode i/o
00246     access from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process.
00247 
00248 Return Value:
00249 
00250     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> success, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> <a class="code" href="../../d8/d3/rtvbatcr_8c.html#a1">failure</a> (illegal MapNumber)
00251 
00252 --*/
00253 
00254 {
00255     <span class="comment">//</span>
00256     <span class="comment">// Reject illegal requests</span>
00257     <span class="comment">//</span>
00258 
00259     <span class="keywordflow">if</span> (MapNumber &gt; IOPM_COUNT) {
00260         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00261     }
00262 
00263     <span class="comment">//</span>
00264     <span class="comment">// Store new offset in process object,  compute current set of</span>
00265     <span class="comment">// active processors for process, if this cpu is one, set IOPM.</span>
00266     <span class="comment">//</span>
00267 
00268     Process-&gt;IOCurMap = MapNumber;
00269     <span class="keywordflow">if</span> (Process-&gt;IOCurMap == IO_ACCESS_MAP_NONE) {
00270         <span class="comment">//</span>
00271         <span class="comment">// BUGBUG: Need to set the EFLAGS.iopl back to 0 for this process</span>
00272         <span class="comment">// And all its threads?</span>
00273         <span class="comment">//</span>
00274         }
00275         <span class="keywordflow">else</span> {
00276         <span class="comment">//</span>
00277         <span class="comment">// BUGBUG: Need to set the EFLAGS.iopl to 3 for this process</span>
00278         <span class="comment">// And all its threads?</span>
00279         <span class="comment">//</span>
00280         }
00281 
00282     <span class="keywordflow">return</span> (<a class="code" href="../../d2/d6/ia64_2iopm_8c.html#a1">KiIA32SetPortMemory</a>(Process));
00283 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="ia64/iopm.c::KeIA32PortIsAccessable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KeIA32PortIsAccessable           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Port</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Size</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/ia64_2iopm_8c-source.html#l00287">287</a> of file <a class="el" href="../../d3/d5/ia64_2iopm_8c-source.html">ia64/iopm.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, and <a class="el" href="../../d3/d5/ia64_2iopm_8c-source.html#l00044">VdmIoMaps</a>.
<p>
<pre class="fragment"><div>00294                    :
00295 
00296     Checks to see <span class="keywordflow">if</span> a particular port <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> accessable by a particular process
00297 
00298 Arguments:
00299 
00300     Process - Pointer to kernel process object
00301 
00302     Port - port number to check
00303 
00304     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - size of access (1, 2 or 4 bytes)
00305 
00306 Return Value:
00307 
00308     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> port <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> accessable, <span class="keyword">false</span> <span class="keywordflow">if</span> port <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not
00309 
00310 --*/
00311 {
00312     ULONG byte;
00313     ULONG bit;
00314     ULONG val;
00315     ULONG ToTest;
00316     PUCHAR ioBits;
00317 
00318     <span class="keywordflow">if</span> (Process-&gt;IOCurMap == IO_ACCESS_MAP_NONE) {
00319         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00320     }
00321 
00322     <span class="comment">//</span>
00323     <span class="comment">// Make sure everything is legit...</span>
00324     <span class="comment">//</span>
00325     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Process-&gt;IOCurMap &lt;= IOPM_COUNT);
00326     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Port &lt; (64 * 1024));
00327     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((Size == 1) || (Size == 2) || (Size == 4));
00328 
00329     ioBits = <a class="code" href="../../d2/d6/ia64_2iopm_8c.html#a0">VdmIoMaps</a>[Process-&gt;IOCurMap - 1];
00330 
00331     <span class="comment">//</span>
00332     <span class="comment">// Get the byte to be tested</span>
00333     <span class="comment">//</span>
00334     byte = Port &gt;&gt; 3;
00335 
00336     <span class="comment">//</span>
00337     <span class="comment">// This handles boundary conditions...</span>
00338     <span class="comment">//</span>
00339     ToTest = ioBits[byte] | (ioBits[byte + 1] &lt;&lt; 8);
00340 
00341     <span class="comment">//</span>
00342     <span class="comment">// And get the specific bit</span>
00343     <span class="comment">//</span>
00344     bit = Port &amp; 0x07;
00345 
00346     <span class="comment">//</span>
00347     <span class="comment">// Really want Size to be 1, 2, or 3 so we can use it for shifting and</span>
00348     <span class="comment">// we want val to be a mask for the port access</span>
00349     <span class="comment">// (2^Size -1 == mask for size of port access)...</span>
00350     <span class="comment">//</span>
00351     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> == 4) {
00352         val = 7 &lt;&lt; bit;
00353     }
00354     <span class="keywordflow">else</span> {
00355         val = ((1 &lt;&lt; <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>) - 1) &lt;&lt; bit;
00356     }
00357 
00358     <span class="keywordflow">return</span> (! (ToTest &amp; val));
00359 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="ia64/iopm.c::KeIA32QueryIoAccessMap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KeIA32QueryIoAccessMap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>MapNumber</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PKIO_ACCESS_MAP&nbsp;</td>
          <td class="mdname" nowrap> <em>IoAccessMap</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/ia64_2iopm_8c-source.html#l00156">156</a> of file <a class="el" href="../../d3/d5/ia64_2iopm_8c-source.html">ia64/iopm.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d3/d5/ia64_2iopm_8c-source.html#l00044">VdmIoMaps</a>.
<p>
<pre class="fragment"><div>00163                    :
00164 
00165     The specified i/o access map will be dumped into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
00166     map 0 <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a constant, but will be dumped anyway.
00167 
00168 Arguments:
00169 
00170     MapNumber - Number of access map to set.  map 0 <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> fixed.
00171 
00172     IoAccessMap - Pointer to buffer (64K bits, 8K bytes) which
00173            <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> definition of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access map.
00174            Must be in non-paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
00175 
00176 Return Value:
00177 
00178     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> successful.  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> <a class="code" href="../../d8/d3/rtvbatcr_8c.html#a1">failure</a> (attempt to query a map
00179     which does not exist)
00180 
00181 --*/
00182 
00183 {
00184     PVOID Map;
00185     KIRQL OldIrql;
00186 
00187     <span class="comment">//</span>
00188     <span class="comment">// Reject illegal requests</span>
00189     <span class="comment">//</span>
00190 
00191     <span class="keywordflow">if</span> (MapNumber &gt; IOPM_COUNT) {
00192         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00193     }
00194 
00195     <span class="comment">//</span>
00196     <span class="comment">// BUGBUG: Do we care if a context switch occurs? What if someone</span>
00197     <span class="comment">// else is modifying map N? (just an issue with MP systems...)</span>
00198     <span class="comment">//</span>
00199 
00200     <span class="comment">//</span>
00201     <span class="comment">// Copy out the map</span>
00202     <span class="comment">//</span>
00203 
00204     <span class="keywordflow">if</span> (MapNumber == IO_ACCESS_MAP_NONE) {
00205 
00206         <span class="comment">//</span>
00207         <span class="comment">// no access case, simply return a map of all 1s</span>
00208         <span class="comment">//</span>
00209                 RtlFillMemory((PVOID) IoAccessMap, IOPM_SIZE, 0x0ff);
00210 
00211     } <span class="keywordflow">else</span> {
00212 
00213         <span class="comment">//</span>
00214         <span class="comment">// normal case, just copy the bits</span>
00215         <span class="comment">//</span>
00216 
00217         Map = <a class="code" href="../../d2/d6/ia64_2iopm_8c.html#a0">VdmIoMaps</a>[MapNumber-1];
00218         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Map != NULL);
00219         RtlMoveMemory((PVOID)IoAccessMap, Map, IOPM_SIZE);
00220     }
00221 
00222     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00223 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="ia64/iopm.c::KeIA32SetIoAccessMap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KeIA32SetIoAccessMap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>MapNumber</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PKIO_ACCESS_MAP&nbsp;</td>
          <td class="mdname" nowrap> <em>IoAccessMap</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/ia64_2iopm_8c-source.html#l00048">48</a> of file <a class="el" href="../../d3/d5/ia64_2iopm_8c-source.html">ia64/iopm.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d5/ia64_2iopm_8c-source.html#l00363">KiIA32SetPortMemory()</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00128">KiLockContextSwap</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00131">KiUnlockContextSwap</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, and <a class="el" href="../../d3/d5/ia64_2iopm_8c-source.html#l00044">VdmIoMaps</a>.
<p>
<pre class="fragment"><div>00055                    :
00056 
00057     The specified i/o access map will be set to match <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00058     definition specified by IoAccessMap (i.e. enable/disable
00059     those ports) before <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call returns.  The change will take
00060     effect on all processors.
00061 
00062     <a class="code" href="../../d2/d6/ia64_2iopm_8c.html#a2">KeIA32SetIoAccessMap</a> does not give any process enhanced I/O
00063     access, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> merely defines a particular access map.
00064 
00065 Arguments:
00066 
00067     MapNumber - Number of access map to set.  Map 0 <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> fixed.
00068 
00069     IoAccessMap - Pointer to bitvector (64K bits, 8K bytes) which
00070            defines <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified access map.  Must be in
00071            non-paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
00072 
00073 Return Value:
00074 
00075     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> successful.  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> <a class="code" href="../../d8/d3/rtvbatcr_8c.html#a1">failure</a> (attempt to set a map
00076     which does not exist, attempt to set map 0)
00077 
00078 --*/
00079 
00080 {
00081 
00082     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> CurrentProcess;
00083     KIRQL OldIrql;
00084     PVOID pt;
00085     PUCHAR p;
00086     ULONG i;
00087     BOOLEAN res;
00088 
00089     <span class="comment">//</span>
00090     <span class="comment">// Reject illegal requests</span>
00091     <span class="comment">//</span>
00092 
00093     <span class="keywordflow">if</span> ((MapNumber &gt; IOPM_COUNT) || (MapNumber == IO_ACCESS_MAP_NONE)) {
00094         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00095     }
00096 
00097     <span class="comment">//</span>
00098     <span class="comment">// If the map N hasn't been allocated, then allocate it now.</span>
00099     <span class="comment">// Don't need to ever free this since it is a system wide</span>
00100     <span class="comment">// resource... Once allocated, stays till reboot.</span>
00101     <span class="comment">// This implies we might want to allocate it early, but we can</span>
00102     <span class="comment">// deal with that later...</span>
00103     <span class="comment">//</span>
00104 
00105     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6/ia64_2iopm_8c.html#a0">VdmIoMaps</a>[MapNumber - 1] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00106         <span class="comment">// Allocate a little extra to handle wrap-around...</span>
00107         p = (PUCHAR) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(NonPagedPool, PIOPM_SIZE);
00108         <span class="keywordflow">if</span> (p == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00109             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00110         }
00111 
00112         <span class="comment">//</span>
00113         <span class="comment">// And set it all to "no-access"</span>
00114                 <span class="comment">// (and don't forget the little extra)</span>
00115         <span class="comment">//</span>
00116                 RtlFillMemory((PVOID) p, PIOPM_SIZE, 0x0ff);
00117 
00118         <a class="code" href="../../d2/d6/ia64_2iopm_8c.html#a0">VdmIoMaps</a>[MapNumber - 1] = p;
00119     }
00120 
00121     <span class="comment">//</span>
00122     <span class="comment">// Acquire the context swap lock so a context switch will not occur.</span>
00123     <span class="comment">//</span>
00124     <span class="comment">// BUGBUG: Is this really needed?</span>
00125     <span class="comment">//</span>
00126 
00127     <a class="code" href="../../d0/d0/ki_8h.html#a11">KiLockContextSwap</a>(&amp;OldIrql);
00128 
00129     <span class="comment">//</span>
00130     <span class="comment">// Copy the IOPM map and load the map for the current process.</span>
00131     <span class="comment">//</span>
00132 
00133     pt = <a class="code" href="../../d2/d6/ia64_2iopm_8c.html#a0">VdmIoMaps</a>[MapNumber-1];
00134     RtlMoveMemory(pt, (PVOID)IoAccessMap, IOPM_SIZE);
00135     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00136 
00137     CurrentProcess-&gt;IOCurMap = MapNumber;
00138 
00139         <span class="comment">//</span>
00140         <span class="comment">// BUGBUG: Need to set the EFLAGS.iopl to 3 for this process</span>
00141         <span class="comment">// and all threads in the process as well?</span>
00142         <span class="comment">//</span>
00143 
00144     res = <a class="code" href="../../d2/d6/ia64_2iopm_8c.html#a1">KiIA32SetPortMemory</a>(CurrentProcess);
00145 
00146     <span class="comment">//</span>
00147     <span class="comment">// Restore IRQL and unlock the context swap lock.</span>
00148     <span class="comment">//</span>
00149 
00150     <a class="code" href="../../d0/d0/ki_8h.html#a12">KiUnlockContextSwap</a>(OldIrql);
00151     <span class="keywordflow">return</span> res;
00152 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="ia64/iopm.c::KiIA32SetPortMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KiIA32SetPortMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Process</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/ia64_2iopm_8c-source.html#l00363">363</a> of file <a class="el" href="../../d3/d5/ia64_2iopm_8c-source.html">ia64/iopm.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d3/d5/ia64_2iopm_8c-source.html#l00044">VdmIoMaps</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/ia64_2iopm_8c-source.html#l00227">KeIA32IoSetAccessProcess()</a>, and <a class="el" href="../../d3/d5/ia64_2iopm_8c-source.html#l00048">KeIA32SetIoAccessMap()</a>.
<p>
<pre class="fragment"><div>00368                    :
00369 
00370     Based on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IO access allowed <span class="keywordflow">for</span> a particular process, set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory
00371     map accordingly...
00372 
00373 Arguments:
00374 
00375     Process - Pointer to kernel process object
00376 
00377 Return Value:
00378 
00379     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> able to setup <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory pages
00380 
00381 Notes:
00382         It would be a lot faster to use a bit searching algorithm
00383         looking <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first 0 bit (accessible) instead of 
00384         doing 8192 calls to the memory system... Of course, we may
00385         do this infrequently enough that it may not matter...
00386 
00387 --*/
00388 {
00389     PUCHAR ioBits;
00390     ULONG i;
00391     PVOID VirtualPort;
00392 
00393     <span class="keywordflow">if</span> (Process-&gt;IOCurMap == IO_ACCESS_MAP_NONE) {
00394         <span class="comment">// Unmap all of the IOBASE memory?</span>
00395         <span class="comment">// Or set them all as Inaccesable?</span>
00396 
00397         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00398     }
00399 
00400     ioBits = <a class="code" href="../../d2/d6/ia64_2iopm_8c.html#a0">VdmIoMaps</a>[Process-&gt;IOCurMap - 1];
00401 
00402     <span class="keywordflow">for</span> (i = 0; i &lt; IOPM_SIZE; i++) {
00403         <span class="comment">// VirtualPort = (i &lt;&lt; SHIFT_8K) + IOBASE;</span>
00404         <span class="keywordflow">if</span> ((*ioBits &amp; 0x000f) == 0) {
00405             <span class="comment">// These four ports can be set read/writable</span>
00406             <span class="comment">// Call memory manager to set read/writable + IO special</span>
00407         }
00408         <span class="keywordflow">else</span> {
00409             <span class="comment">// Call memory manager to set as inaccessable/unmap</span>
00410         }
00411 
00412         <span class="comment">// VirtualPort = (i &lt;&lt; SHIFT_8K) + IOBASE + (4K_PAGE);</span>
00413         <span class="keywordflow">if</span> ((*ioBits++ &amp; 0x00f0) == 0) {
00414             <span class="comment">// These four ports can be set read/writable</span>
00415             <span class="comment">// Call memory manager to set read/writable + IO special</span>
00416         }
00417         <span class="keywordflow">else</span> {
00418             <span class="comment">// Call memory manager to set as inaccessable/unmap</span>
00419         }
00420     }
00421 
00422     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00423 }
}
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a0" doxytag="ia64/iopm.c::VdmIoMaps" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PKIO_ACCESS_MAP <a class="el" href="../../d2/d6/ia64_2iopm_8c.html#a0">VdmIoMaps</a>[IOPM_COUNT]<code> [static]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/ia64_2iopm_8c-source.html#l00044">44</a> of file <a class="el" href="../../d3/d5/ia64_2iopm_8c-source.html">ia64/iopm.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/ia64_2iopm_8c-source.html#l00287">KeIA32PortIsAccessable()</a>, <a class="el" href="../../d3/d5/ia64_2iopm_8c-source.html#l00156">KeIA32QueryIoAccessMap()</a>, <a class="el" href="../../d3/d5/ia64_2iopm_8c-source.html#l00048">KeIA32SetIoAccessMap()</a>, and <a class="el" href="../../d3/d5/ia64_2iopm_8c-source.html#l00363">KiIA32SetPortMemory()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:20 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
