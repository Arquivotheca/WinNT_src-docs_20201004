<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: context.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>context.c</h1><a href="../../d1/d6/ke_2ia64_2context_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Module Name:</span>
00004 <span class="comment"></span>
00005 <span class="comment">    context.c</span>
00006 <span class="comment"></span>
00007 <span class="comment">Abstract:</span>
00008 <span class="comment"></span>
00009 <span class="comment">    This module implement the code that transfer machine state between</span>
00010 <span class="comment">    context and kernel trap/exception frames.</span>
00011 <span class="comment"></span>
00012 <span class="comment">Author:</span>
00013 <span class="comment"></span>
00014 <span class="comment">    William K. Cheung (wcheung) 06-Mar-1998</span>
00015 <span class="comment"></span>
00016 <span class="comment">Environment:</span>
00017 <span class="comment"></span>
00018 <span class="comment">    Kernel mode only.</span>
00019 <span class="comment"></span>
00020 <span class="comment">Revision History:</span>
00021 <span class="comment"></span>
00022 <span class="comment">--*/</span>
00023 
00024 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00025 
00026 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00027 <a class="code" href="../../d8/d0/rtl_2ia64_2miscc_8c.html#a0">RtlpFlushRSE</a> (
00028     OUT PULONGLONG BackingStore,
00029     OUT PULONGLONG RNat
00030     );
00031 
<a name="l00032"></a><a class="code" href="../../d1/d6/ke_2ia64_2context_8c.html#a0">00032</a> <span class="preprocessor">#define ALIGN_NATS(Result, Source, Start, AddressOffset, Mask)    \</span>
00033 <span class="preprocessor">    if (AddressOffset == Start) {                                       \</span>
00034 <span class="preprocessor">        Result = (ULONGLONG)Source;                                     \</span>
00035 <span class="preprocessor">    } else if (AddressOffset &lt; Start) {                                 \</span>
00036 <span class="preprocessor">        Result = (ULONGLONG)(Source &lt;&lt; (Start - AddressOffset));        \</span>
00037 <span class="preprocessor">    } else {                                                            \</span>
00038 <span class="preprocessor">        Result = (ULONGLONG)((Source &gt;&gt; (AddressOffset - Start)) |      \</span>
00039 <span class="preprocessor">                             (Source &lt;&lt; (64 + Start - AddressOffset))); \</span>
00040 <span class="preprocessor">    }                                                                   \</span>
00041 <span class="preprocessor">    Result = Result &amp; (ULONGLONG)Mask</span>
00042 <span class="preprocessor"></span>
<a name="l00043"></a><a class="code" href="../../d1/d6/ke_2ia64_2context_8c.html#a1">00043</a> <span class="preprocessor">#define EXTRACT_NATS(Result, Source, Start, AddressOffset, Mask)        \</span>
00044 <span class="preprocessor">    Result = (ULONGLONG)(Source &amp; (ULONGLONG)Mask);                     \</span>
00045 <span class="preprocessor">    if (AddressOffset &lt; Start) {                                        \</span>
00046 <span class="preprocessor">        Result = Result &gt;&gt; (Start - AddressOffset);                     \</span>
00047 <span class="preprocessor">    } else if (AddressOffset &gt; Start) {                                 \</span>
00048 <span class="preprocessor">        Result = ((Result &lt;&lt; (AddressOffset - Start)) |                 \</span>
00049 <span class="preprocessor">                  (Result &gt;&gt; (64 + Start - AddressOffset)));            \</span>
00050 <span class="preprocessor">    }</span>
00051 <span class="preprocessor"></span>
00052 
00053 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00054"></a><a class="code" href="../../d5/d0/psctxi64_8c.html#a2">00054</a> <a class="code" href="../../d5/d0/psctxi64_8c.html#a2">KiGetDebugContext</a> (
00055     IN PKTRAP_FRAME TrapFrame,
00056     IN OUT PCONTEXT ContextFrame
00057     )
00058 
00059 <span class="comment">/*++</span>
00060 <span class="comment"></span>
00061 <span class="comment">Routine Description:</span>
00062 <span class="comment"></span>
00063 <span class="comment">    This routine moves the user mode h/w debug registers from the debug register</span>
00064 <span class="comment">    save area in the kernel stack to the context record.</span>
00065 <span class="comment"></span>
00066 <span class="comment">Arguments:</span>
00067 <span class="comment"></span>
00068 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame from which volatile context</span>
00069 <span class="comment">        should be copied into the context record.</span>
00070 <span class="comment"></span>
00071 <span class="comment">    ContextFrame - Supplies a pointer to the context frame that receives the</span>
00072 <span class="comment">        context.</span>
00073 <span class="comment"></span>
00074 <span class="comment">Return Value:</span>
00075 <span class="comment"></span>
00076 <span class="comment">    None.</span>
00077 <span class="comment"></span>
00078 <span class="comment">Note:</span>
00079 <span class="comment">    </span>
00080 <span class="comment">    PSR.db must be set to activate the debug registers.</span>
00081 <span class="comment"></span>
00082 <span class="comment">    This is used for getting user mode debug registers.</span>
00083 <span class="comment"></span>
00084 <span class="comment">--*/</span>
00085 
00086 {
00087     PKDEBUG_REGISTERS DebugRegistersSaveArea;
00088 
00089     <span class="keywordflow">if</span> (TrapFrame-&gt;PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
00090         DebugRegistersSaveArea = GET_DEBUG_REGISTER_SAVEAREA();
00091 
00092         RtlCopyMemory(&amp;ContextFrame-&gt;DbI0, 
00093                       (PVOID)DebugRegistersSaveArea,
00094                       <span class="keyword">sizeof</span>(KDEBUG_REGISTERS));
00095     }
00096 }
00097 
00098 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00099"></a><a class="code" href="../../d5/d0/psctxi64_8c.html#a3">00099</a> <a class="code" href="../../d5/d0/psctxi64_8c.html#a3">KiSetDebugContext</a> (
00100     IN OUT PKTRAP_FRAME TrapFrame,
00101     IN PCONTEXT ContextFrame,
00102     IN KPROCESSOR_MODE PreviousMode
00103     )
00104 <span class="comment">/*++</span>
00105 <span class="comment"></span>
00106 <span class="comment">Routine Description:</span>
00107 <span class="comment"></span>
00108 <span class="comment">    This routine moves the debug context from the specified context frame into</span>
00109 <span class="comment">    the debug registers save area in the kernel stack.</span>
00110 <span class="comment"></span>
00111 <span class="comment">Arguments:</span>
00112 <span class="comment"></span>
00113 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame.</span>
00114 <span class="comment"></span>
00115 <span class="comment">    ContextFrame - Supplies a pointer to a context frame that contains the</span>
00116 <span class="comment">        context that is to be copied.</span>
00117 <span class="comment"></span>
00118 <span class="comment">    PreviousMode - Supplies the processor mode for the target context.</span>
00119 <span class="comment"></span>
00120 <span class="comment">Return Value:</span>
00121 <span class="comment"></span>
00122 <span class="comment">    None.</span>
00123 <span class="comment"></span>
00124 <span class="comment">Notes:</span>
00125 <span class="comment"></span>
00126 <span class="comment">   PSR.db must be set to activate the debug registers.</span>
00127 <span class="comment">   </span>
00128 <span class="comment">   This is used for setting up debug registers for user mode.</span>
00129 <span class="comment"></span>
00130 <span class="comment">--*/</span>
00131 
00132 {
00133     PKDEBUG_REGISTERS DebugRegistersSaveArea;  <span class="comment">// User mode h/w debug registers</span>
00134 
00135     <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
00136 
00137         DebugRegistersSaveArea = GET_DEBUG_REGISTER_SAVEAREA();
00138 
00139         <span class="comment">//</span>
00140         <span class="comment">// Sanitize the debug control regs. Leave the addresses unchanged.</span>
00141         <span class="comment">//</span>
00142 
00143         DebugRegistersSaveArea-&gt;DbI0 = ContextFrame-&gt;DbI0;
00144         DebugRegistersSaveArea-&gt;DbI1 = SANITIZE_DR(ContextFrame-&gt;DbI1,<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00145         DebugRegistersSaveArea-&gt;DbI2 = ContextFrame-&gt;DbI2;
00146         DebugRegistersSaveArea-&gt;DbI3 = SANITIZE_DR(ContextFrame-&gt;DbI3,<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00147         DebugRegistersSaveArea-&gt;DbI4 = ContextFrame-&gt;DbI4;
00148         DebugRegistersSaveArea-&gt;DbI5 = SANITIZE_DR(ContextFrame-&gt;DbI5,<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00149         DebugRegistersSaveArea-&gt;DbI6 = ContextFrame-&gt;DbI6;
00150         DebugRegistersSaveArea-&gt;DbI7 = SANITIZE_DR(ContextFrame-&gt;DbI7,<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00151 
00152         DebugRegistersSaveArea-&gt;DbD0 = ContextFrame-&gt;DbD0;
00153         DebugRegistersSaveArea-&gt;DbD1 = SANITIZE_DR(ContextFrame-&gt;DbD1,<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00154         DebugRegistersSaveArea-&gt;DbD2 = ContextFrame-&gt;DbD2;
00155         DebugRegistersSaveArea-&gt;DbD3 = SANITIZE_DR(ContextFrame-&gt;DbD3,<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00156         DebugRegistersSaveArea-&gt;DbD4 = ContextFrame-&gt;DbD4;
00157         DebugRegistersSaveArea-&gt;DbD5 = SANITIZE_DR(ContextFrame-&gt;DbD5,<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00158         DebugRegistersSaveArea-&gt;DbD6 = ContextFrame-&gt;DbD6;
00159         DebugRegistersSaveArea-&gt;DbD7 = SANITIZE_DR(ContextFrame-&gt;DbD7,<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00160 
00161     }
00162 }
00163 
00164 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00165"></a><a class="code" href="../../d1/d6/ke_2ia64_2context_8c.html#a5">00165</a> <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a9">KeContextFromKframes</a> (
00166     IN PKTRAP_FRAME TrapFrame,
00167     IN PKEXCEPTION_FRAME ExceptionFrame,
00168     IN OUT PCONTEXT ContextFrame
00169     )
00170 
00171 <span class="comment">/*++</span>
00172 <span class="comment"></span>
00173 <span class="comment">Routine Description:</span>
00174 <span class="comment"></span>
00175 <span class="comment">    This routine moves the selected contents of the specified trap and exception</span>
00176 <span class="comment">    frames into the specified context frame according to the specified context</span>
00177 <span class="comment">    flags.</span>
00178 <span class="comment"></span>
00179 <span class="comment">Arguments:</span>
00180 <span class="comment"></span>
00181 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame from which volatile context</span>
00182 <span class="comment">        should be copied into the context record.</span>
00183 <span class="comment"></span>
00184 <span class="comment">    ExceptionFrame - Supplies a pointer to an exception frame from which context</span>
00185 <span class="comment">        should be copied into the context record.</span>
00186 <span class="comment"></span>
00187 <span class="comment">    ContextFrame - Supplies a pointer to the context frame that receives the</span>
00188 <span class="comment">        context copied from the trap and exception frames.</span>
00189 <span class="comment"></span>
00190 <span class="comment">Return Value:</span>
00191 <span class="comment"></span>
00192 <span class="comment">    None.</span>
00193 <span class="comment"></span>
00194 <span class="comment">--*/</span>
00195 
00196 {
00197     ULONGLONG IntNats1, IntNats2;
00198     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> R1Offset, R4Offset;
00199     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> RNatSaveIndex;
00200     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> BsFrameSize;
00201     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> TempFrameSize;
00202 
00203     <span class="comment">//</span>
00204     <span class="comment">// Set control information if specified.</span>
00205     <span class="comment">//</span>
00206 
00207     <span class="keywordflow">if</span> ((ContextFrame-&gt;ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) {
00208 
00209         ContextFrame-&gt;IntGp = TrapFrame-&gt;IntGp;
00210         ContextFrame-&gt;IntSp = TrapFrame-&gt;IntSp;
00211         ContextFrame-&gt;ApUNAT = TrapFrame-&gt;ApUNAT;
00212         ContextFrame-&gt;BrRp = TrapFrame-&gt;BrRp;
00213         ContextFrame-&gt;ApCCV = TrapFrame-&gt;ApCCV;
00214         ContextFrame-&gt;ApDCR = TrapFrame-&gt;ApDCR;
00215 
00216         ContextFrame-&gt;StFPSR = TrapFrame-&gt;StFPSR;
00217         ContextFrame-&gt;StIPSR = TrapFrame-&gt;StIPSR;
00218         ContextFrame-&gt;StIIP = TrapFrame-&gt;StIIP;
00219         ContextFrame-&gt;StIFS = TrapFrame-&gt;StIFS;
00220 
00221 
00222         <span class="comment">//</span>
00223         <span class="comment">// Set RSE control states from the trap frame.</span>
00224         <span class="comment">//</span>
00225 
00226         ContextFrame-&gt;RsPFS = TrapFrame-&gt;RsPFS;
00227 
00228         BsFrameSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(TrapFrame-&gt;StIFS &amp; PFS_SIZE_MASK);
00229         RNatSaveIndex = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (TrapFrame-&gt;RsBSP &gt;&gt; 3) &amp; NAT_BITS_PER_RNAT_REG;
00230         TempFrameSize = BsFrameSize - RNatSaveIndex;
00231         <span class="keywordflow">while</span> (TempFrameSize &gt; 0) {
00232             BsFrameSize++;
00233             TempFrameSize -= NAT_BITS_PER_RNAT_REG;
00234         }
00235 
00236         ContextFrame-&gt;RsBSP = TrapFrame-&gt;RsBSP - BsFrameSize * 8;
00237         ContextFrame-&gt;RsBSPSTORE = ContextFrame-&gt;RsBSP;
00238         ContextFrame-&gt;RsRSC = TrapFrame-&gt;RsRSC;
00239         ContextFrame-&gt;RsRNAT = TrapFrame-&gt;RsRNAT;
00240 
00241 <span class="preprocessor">#if DEBUG</span>
00242 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KeContextFromKFrames: RsRNAT = 0x%I64x\n"</span>,
00243                  ContextFrame-&gt;RsRNAT);
00244 <span class="preprocessor">#endif // DEBUG</span>
00245 <span class="preprocessor"></span>
00246         <span class="comment">//</span>
00247         <span class="comment">// Set preserved applicaton registers from exception frame.</span>
00248         <span class="comment">//</span>
00249 
00250         ContextFrame-&gt;ApLC = ExceptionFrame-&gt;ApLC;
00251         ContextFrame-&gt;ApEC = (ExceptionFrame-&gt;ApEC &gt;&gt; PFS_EC_SHIFT) &amp; PFS_EC_MASK;
00252 
00253         <span class="comment">//</span>
00254         <span class="comment">// Get iA status from the application registers</span>
00255         <span class="comment">//</span>
00256 
00257         ContextFrame-&gt;StFCR = __getReg(CV_IA64_AR21);
00258         ContextFrame-&gt;Eflag = __getReg(CV_IA64_AR24);
00259         ContextFrame-&gt;SegCSD = __getReg(CV_IA64_AR25);
00260         ContextFrame-&gt;SegSSD = __getReg(CV_IA64_AR26);
00261         ContextFrame-&gt;Cflag = __getReg(CV_IA64_AR27);
00262         ContextFrame-&gt;StFSR = __getReg(CV_IA64_AR28);
00263         ContextFrame-&gt;StFIR = __getReg(CV_IA64_AR29);
00264         ContextFrame-&gt;StFDR = __getReg(CV_IA64_AR30);
00265 
00266     }
00267 
00268     <span class="comment">//</span>
00269     <span class="comment">// Set integer register contents if specified.</span>
00270     <span class="comment">//</span>
00271 
00272     <span class="keywordflow">if</span> ((ContextFrame-&gt;ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) {
00273 
00274         ContextFrame-&gt;IntT0 = TrapFrame-&gt;IntT0;
00275         ContextFrame-&gt;IntT1 = TrapFrame-&gt;IntT1;
00276         ContextFrame-&gt;IntT2 = TrapFrame-&gt;IntT2;
00277         ContextFrame-&gt;IntT3 = TrapFrame-&gt;IntT3;
00278         ContextFrame-&gt;IntT4 = TrapFrame-&gt;IntT4;
00279         ContextFrame-&gt;IntV0 = TrapFrame-&gt;IntV0;
00280         ContextFrame-&gt;IntTeb = TrapFrame-&gt;IntTeb;
00281         ContextFrame-&gt;Preds = TrapFrame-&gt;Preds;
00282 
00283         <span class="comment">//</span>
00284         <span class="comment">// t5 - t22</span>
00285         <span class="comment">// </span>
00286 
00287         memcpy(&amp;ContextFrame-&gt;IntT5, &amp;TrapFrame-&gt;IntT5, 18*<span class="keyword">sizeof</span>(ULONGLONG));
00288 
00289         <span class="comment">//</span>
00290         <span class="comment">// Set branch registers from trap frame &amp; exception frame</span>
00291         <span class="comment">//</span>
00292 
00293         ContextFrame-&gt;BrT0 = TrapFrame-&gt;BrT0;
00294         ContextFrame-&gt;BrT1 = TrapFrame-&gt;BrT1;
00295 
00296         memcpy(&amp;ContextFrame-&gt;BrS0, &amp;ExceptionFrame-&gt;BrS0, 5*<span class="keyword">sizeof</span>(ULONGLONG));
00297 
00298         <span class="comment">//</span>
00299         <span class="comment">// Set integer registers s0 - s3 from exception frame.</span>
00300         <span class="comment">//</span>
00301 
00302         ContextFrame-&gt;IntS0 = ExceptionFrame-&gt;IntS0;
00303         ContextFrame-&gt;IntS1 = ExceptionFrame-&gt;IntS1;
00304         ContextFrame-&gt;IntS2 = ExceptionFrame-&gt;IntS2;
00305         ContextFrame-&gt;IntS3 = ExceptionFrame-&gt;IntS3;
00306 
00307         <span class="comment">//</span>
00308         <span class="comment">// Set the integer nats field in the context</span>
00309         <span class="comment">//</span>
00310 
00311         R1Offset = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((ULONG_PTR)(&amp;TrapFrame-&gt;IntGp) &gt;&gt; 3) &amp; 0x3f;
00312         R4Offset = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((ULONG_PTR)(&amp;ExceptionFrame-&gt;IntS0) &gt;&gt; 3) &amp; 0x3f;
00313 
00314         <a class="code" href="../../d1/d6/ke_2ia64_2context_8c.html#a0">ALIGN_NATS</a>(IntNats1, TrapFrame-&gt;IntNats, 1, R1Offset, 0xFFFFFF0E);
00315         <a class="code" href="../../d1/d6/ke_2ia64_2context_8c.html#a0">ALIGN_NATS</a>(IntNats2, ExceptionFrame-&gt;IntNats, 4, R4Offset, 0xF0);
00316         ContextFrame-&gt;IntNats = IntNats1 | IntNats2;
00317 
00318 <span class="preprocessor">#if DEBUG</span>
00319 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KeContextFromKFrames: TF-&gt;IntNats = 0x%I64x, R1OffSet = 0x%x, R4Offset = 0x%x\n"</span>,
00320                  TrapFrame-&gt;IntNats, R1Offset, R4Offset);
00321         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KeContextFromKFrames: CF-&gt;IntNats = 0x%I64x, IntNats1 = 0x%I64x, IntNats2 = 0x%I64x\n"</span>,
00322                  ContextFrame-&gt;IntNats, IntNats1, IntNats2);
00323 <span class="preprocessor">#endif // DEBUG</span>
00324 <span class="preprocessor"></span>
00325     }
00326 
00327     <span class="comment">//</span>
00328     <span class="comment">// Set lower floating register contents if specified.</span>
00329     <span class="comment">//</span>
00330 
00331     <span class="keywordflow">if</span> ((ContextFrame-&gt;ContextFlags &amp; CONTEXT_LOWER_FLOATING_POINT) == CONTEXT_LOWER_FLOATING_POINT) {
00332 
00333         <span class="comment">//</span>
00334         <span class="comment">// Set EM + ia32 FP status</span>
00335         <span class="comment">//</span>
00336         
00337         ContextFrame-&gt;StFPSR = TrapFrame-&gt;StFPSR;
00338 
00339         <span class="comment">//</span>
00340         <span class="comment">// Set floating registers fs0 - fs19 from exception frame.</span>
00341         <span class="comment">//</span>
00342 
00343         RtlCopyIa64FloatRegisterContext(&amp;ContextFrame-&gt;FltS0,
00344                                         &amp;ExceptionFrame-&gt;FltS0,
00345                                         <span class="keyword">sizeof</span>(FLOAT128) * (4));
00346 
00347         RtlCopyIa64FloatRegisterContext(&amp;ContextFrame-&gt;FltS4, 
00348                                         &amp;ExceptionFrame-&gt;FltS4,
00349                                         16*<span class="keyword">sizeof</span>(FLOAT128));
00350 
00351         <span class="comment">//</span>
00352         <span class="comment">// Set floating registers ft0 - ft9 from trap frame.</span>
00353         <span class="comment">//</span>
00354 
00355         RtlCopyIa64FloatRegisterContext(&amp;ContextFrame-&gt;FltT0,
00356                                         &amp;TrapFrame-&gt;FltT0,
00357                                         <span class="keyword">sizeof</span>(FLOAT128) * (10));
00358 
00359     }
00360 
00361     <span class="keywordflow">if</span> ((ContextFrame-&gt;ContextFlags &amp; CONTEXT_HIGHER_FLOATING_POINT) == CONTEXT_HIGHER_FLOATING_POINT) {
00362 
00363         ContextFrame-&gt;StFPSR = TrapFrame-&gt;StFPSR;
00364 
00365         <span class="comment">//</span>
00366         <span class="comment">// Set floating regs f32 - f127 from higher floating point save area</span>
00367         <span class="comment">//</span>
00368 
00369         <span class="keywordflow">if</span> (TrapFrame-&gt;PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
00370 
00371             RtlCopyIa64FloatRegisterContext(
00372                 &amp;ContextFrame-&gt;FltF32, 
00373                 (PFLOAT128)GET_HIGH_FLOATING_POINT_REGISTER_SAVEAREA(),
00374                 96*<span class="keyword">sizeof</span>(FLOAT128)
00375                 );
00376         }
00377 
00378     }
00379 
00380     <span class="comment">//</span>
00381     <span class="comment">// Get user debug registers from save area in kernel stack.</span>
00382     <span class="comment">// Note: PSR.db must be set to activate the debug registers.</span>
00383     <span class="comment">//</span>
00384 
00385     <span class="keywordflow">if</span> ((ContextFrame-&gt;ContextFlags &amp; CONTEXT_DEBUG) == CONTEXT_DEBUG) {
00386         <a class="code" href="../../d5/d0/psctxi64_8c.html#a2">KiGetDebugContext</a>(TrapFrame, ContextFrame);
00387     }
00388 
00389     <span class="keywordflow">return</span>;
00390 }
00391 
00392 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00393"></a><a class="code" href="../../d1/d6/ke_2ia64_2context_8c.html#a6">00393</a> <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a10">KeContextToKframes</a> (
00394     IN OUT PKTRAP_FRAME TrapFrame,
00395     IN OUT PKEXCEPTION_FRAME ExceptionFrame,
00396     IN PCONTEXT ContextFrame,
00397     IN ULONG ContextFlags,
00398     IN KPROCESSOR_MODE PreviousMode
00399     )
00400 
00401 <span class="comment">/*++</span>
00402 <span class="comment"></span>
00403 <span class="comment">Routine Description:</span>
00404 <span class="comment"></span>
00405 <span class="comment">    This routine moves the selected contents of the specified context frame into</span>
00406 <span class="comment">    the specified trap and exception frames according to the specified context</span>
00407 <span class="comment">    flags.</span>
00408 <span class="comment"></span>
00409 <span class="comment">Arguments:</span>
00410 <span class="comment"></span>
00411 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame that receives the volatile</span>
00412 <span class="comment">        context from the context record.</span>
00413 <span class="comment"></span>
00414 <span class="comment">    ExceptionFrame - Supplies a pointer to an exception frame that receives</span>
00415 <span class="comment">        the nonvolatile context from the context record.</span>
00416 <span class="comment"></span>
00417 <span class="comment">    ContextFrame - Supplies a pointer to a context frame that contains the</span>
00418 <span class="comment">        context that is to be copied into the trap and exception frames.</span>
00419 <span class="comment"></span>
00420 <span class="comment">    ContextFlags - Supplies the set of flags that specify which parts of the</span>
00421 <span class="comment">        context frame are to be copied into the trap and exception frames.</span>
00422 <span class="comment"></span>
00423 <span class="comment">    PreviousMode - Supplies the processor mode for which the trap and exception</span>
00424 <span class="comment">        frames are being built.</span>
00425 <span class="comment"></span>
00426 <span class="comment">Return Value:</span>
00427 <span class="comment"></span>
00428 <span class="comment">    None.</span>
00429 <span class="comment"></span>
00430 <span class="comment">--*/</span>
00431 
00432 {
00433     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> R1Offset, R4Offset;
00434     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> RNatSaveIndex; 
00435     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> BsFrameSize;
00436     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> TempFrameSize;
00437 
00438     <span class="comment">//</span>
00439     <span class="comment">// Set control information if specified.</span>
00440     <span class="comment">//</span>
00441 
00442     <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) {
00443 
00444         TrapFrame-&gt;IntGp = ContextFrame-&gt;IntGp;
00445         TrapFrame-&gt;IntSp = ContextFrame-&gt;IntSp;
00446         TrapFrame-&gt;ApUNAT = ContextFrame-&gt;ApUNAT;
00447         TrapFrame-&gt;BrRp = ContextFrame-&gt;BrRp;
00448         TrapFrame-&gt;ApCCV = ContextFrame-&gt;ApCCV;
00449         TrapFrame-&gt;ApDCR = SANITIZE_DCR(ContextFrame-&gt;ApDCR, PreviousMode);
00450 
00451         <span class="comment">//</span>
00452         <span class="comment">// Set preserved applicaton registers in exception frame.</span>
00453         <span class="comment">//</span>
00454 
00455         ExceptionFrame-&gt;ApLC = ContextFrame-&gt;ApLC;
00456         ExceptionFrame-&gt;ApEC &amp;= ~(PFS_EC_MASK &lt;&lt; PFS_EC_MASK);
00457         ExceptionFrame-&gt;ApEC |= ((ContextFrame-&gt;ApEC &amp; PFS_EC_MASK) &lt;&lt; PFS_EC_SHIFT);
00458 
00459         <span class="comment">//</span>
00460         <span class="comment">// Set RSE control states in the trap frame.</span>
00461         <span class="comment">//</span>
00462 
00463         TrapFrame-&gt;RsPFS = ContextFrame-&gt;RsPFS;
00464 
00465         BsFrameSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ContextFrame-&gt;StIFS &amp; PFS_SIZE_MASK);
00466         RNatSaveIndex = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((ContextFrame-&gt;RsBSP &gt;&gt; 3) &amp; NAT_BITS_PER_RNAT_REG);
00467 
00468         TempFrameSize = RNatSaveIndex + BsFrameSize - NAT_BITS_PER_RNAT_REG;
00469         <span class="keywordflow">while</span> (TempFrameSize &gt;= 0) {
00470             BsFrameSize++;
00471             TempFrameSize -= NAT_BITS_PER_RNAT_REG;
00472         }
00473 
00474         TrapFrame-&gt;RsBSPSTORE = ContextFrame-&gt;RsBSPSTORE + BsFrameSize * 8;
00475         TrapFrame-&gt;RsBSP = TrapFrame-&gt;RsBSPSTORE;
00476         TrapFrame-&gt;RsRSC = ContextFrame-&gt;RsRSC;
00477         TrapFrame-&gt;RsRNAT = ContextFrame-&gt;RsRNAT;
00478 
00479 <span class="preprocessor">#if DEBUG</span>
00480 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KeContextToKFrames: RsRNAT = 0x%I64x\n"</span>, TrapFrame-&gt;RsRNAT);
00481 <span class="preprocessor">#endif // DEBUG</span>
00482 <span class="preprocessor"></span>
00483         <span class="comment">//</span>
00484         <span class="comment">// Set FPSR, IPSR, IIP, and IFS in the trap frame.</span>
00485         <span class="comment">//</span>
00486 
00487         TrapFrame-&gt;StFPSR = SANITIZE_FSR(ContextFrame-&gt;StFPSR, PreviousMode);
00488         TrapFrame-&gt;StIPSR = SANITIZE_PSR(ContextFrame-&gt;StIPSR, PreviousMode);
00489         <span class="keywordflow">if</span> (((TrapFrame-&gt;StIPSR &gt;&gt; PSR_RI) &amp; 3) == 3) {
00490             TrapFrame-&gt;StIPSR &amp;= ~(3i64 &lt;&lt; PSR_RI);
00491         }
00492         TrapFrame-&gt;StIFS  = SANITIZE_IFS(ContextFrame-&gt;StIFS, PreviousMode);
00493         TrapFrame-&gt;StIIP  = ContextFrame-&gt;StIIP;
00494 
00495         <span class="comment">//</span>
00496         <span class="comment">// DebugActive controls h/w debug registers. Set if new psr.db = 1</span>
00497         <span class="comment">//</span>
00498 
00499         <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;DebugActive = ((TrapFrame-&gt;StIPSR &amp; (1I64 &lt;&lt; PSR_DB)) != 0);
00500 
00501         <span class="comment">//</span>
00502         <span class="comment">// Set application registers directly</span>
00503         <span class="comment">// *** TBD SANATIZE??</span>
00504         <span class="comment">//</span>
00505 
00506         <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a> ) {
00507             __setReg(CV_IA64_AR21, ContextFrame-&gt;StFCR);
00508             __setReg(CV_IA64_AR24, ContextFrame-&gt;Eflag);
00509             __setReg(CV_IA64_AR25, ContextFrame-&gt;SegCSD);
00510             __setReg(CV_IA64_AR26, ContextFrame-&gt;SegSSD);
00511             __setReg(CV_IA64_AR27, ContextFrame-&gt;Cflag);
00512             __setReg(CV_IA64_AR28, ContextFrame-&gt;StFSR);
00513             __setReg(CV_IA64_AR29, ContextFrame-&gt;StFIR);
00514             __setReg(CV_IA64_AR30, ContextFrame-&gt;StFDR);
00515         }
00516     }
00517 
00518     <span class="comment">//</span>
00519     <span class="comment">// Set integer registers contents if specified.</span>
00520     <span class="comment">//</span>
00521 
00522     <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) {
00523 
00524         TrapFrame-&gt;IntT0 = ContextFrame-&gt;IntT0;
00525         TrapFrame-&gt;IntT1 = ContextFrame-&gt;IntT1;
00526         TrapFrame-&gt;IntT2 = ContextFrame-&gt;IntT2;
00527         TrapFrame-&gt;IntT3 = ContextFrame-&gt;IntT3;
00528         TrapFrame-&gt;IntT4 = ContextFrame-&gt;IntT4;
00529         TrapFrame-&gt;IntV0 = ContextFrame-&gt;IntV0;
00530         TrapFrame-&gt;IntTeb = ContextFrame-&gt;IntTeb;
00531         TrapFrame-&gt;Preds = ContextFrame-&gt;Preds;
00532 
00533         <span class="comment">//</span>
00534         <span class="comment">// t5 - t22</span>
00535         <span class="comment">//</span>
00536 
00537         memcpy(&amp;TrapFrame-&gt;IntT5, &amp;ContextFrame-&gt;IntT5, 18*<span class="keyword">sizeof</span>(ULONGLONG));
00538 
00539         <span class="comment">//</span>
00540         <span class="comment">// Set integer registers s0 - s3 in exception frame.</span>
00541         <span class="comment">//</span>
00542 
00543         ExceptionFrame-&gt;IntS0 = ContextFrame-&gt;IntS0;
00544         ExceptionFrame-&gt;IntS1 = ContextFrame-&gt;IntS1;
00545         ExceptionFrame-&gt;IntS2 = ContextFrame-&gt;IntS2;
00546         ExceptionFrame-&gt;IntS3 = ContextFrame-&gt;IntS3;
00547 
00548         <span class="comment">//</span>
00549         <span class="comment">// Set the integer nats field in the trap &amp; exception frames</span>
00550         <span class="comment">//</span>
00551 
00552         R1Offset = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((ULONG_PTR)(&amp;TrapFrame-&gt;IntGp) &gt;&gt; 3) &amp; 0x3f;
00553         R4Offset = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((ULONG_PTR)(&amp;ExceptionFrame-&gt;IntS0) &gt;&gt; 3) &amp; 0x3f;
00554 
00555         <a class="code" href="../../d1/d6/ke_2ia64_2context_8c.html#a1">EXTRACT_NATS</a>(TrapFrame-&gt;IntNats, ContextFrame-&gt;IntNats,
00556                      1, R1Offset, 0xFFFFFF0E);
00557         <a class="code" href="../../d1/d6/ke_2ia64_2context_8c.html#a1">EXTRACT_NATS</a>(ExceptionFrame-&gt;IntNats, ContextFrame-&gt;IntNats,
00558                      4, R4Offset, 0xF0);
00559 
00560 <span class="preprocessor">#if DEBUG</span>
00561 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KeContextToKFrames: TF-&gt;IntNats = 0x%I64x, ContestFrame-&gt;IntNats = 0x%I64x, R1OffSet = 0x%x\n"</span>,
00562                  TrapFrame-&gt;IntNats, ContextFrame-&gt;IntNats, R1Offset);
00563         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KeContextToKFrames: EF-&gt;IntNats = 0x%I64x, R4OffSet = 0x%x\n"</span>,
00564                  ExceptionFrame-&gt;IntNats, R4Offset);
00565 <span class="preprocessor">#endif // DEBUG</span>
00566 <span class="preprocessor"></span>
00567         <span class="comment">//</span>
00568         <span class="comment">// Set other branch registers in trap and exception frames</span>
00569         <span class="comment">//</span>
00570 
00571         TrapFrame-&gt;BrT0 = ContextFrame-&gt;BrT0;
00572         TrapFrame-&gt;BrT1 = ContextFrame-&gt;BrT1;
00573 
00574         memcpy(&amp;ExceptionFrame-&gt;BrS0, &amp;ContextFrame-&gt;BrS0, 5*<span class="keyword">sizeof</span>(ULONGLONG));
00575 
00576     }
00577 
00578     <span class="comment">//</span>
00579     <span class="comment">// Set lower floating register contents if specified.</span>
00580     <span class="comment">//</span>
00581 
00582     <span class="keywordflow">if</span> ((ContextFlags &amp; CONTEXT_LOWER_FLOATING_POINT) == CONTEXT_LOWER_FLOATING_POINT) {
00583 
00584         TrapFrame-&gt;StFPSR = SANITIZE_FSR(ContextFrame-&gt;StFPSR, PreviousMode);
00585 
00586         <span class="comment">//</span>
00587         <span class="comment">// Set floating registers fs0 - fs19 in exception frame.</span>
00588         <span class="comment">//</span>
00589 
00590         RtlCopyIa64FloatRegisterContext(&amp;ExceptionFrame-&gt;FltS0, 
00591                                         &amp;ContextFrame-&gt;FltS0,
00592                                         <span class="keyword">sizeof</span>(FLOAT128) * (4));
00593 
00594         RtlCopyIa64FloatRegisterContext(&amp;ExceptionFrame-&gt;FltS4, 
00595                                         &amp;ContextFrame-&gt;FltS4,
00596                                         16*<span class="keyword">sizeof</span>(FLOAT128));
00597 
00598         <span class="comment">//</span>
00599         <span class="comment">// Set floating registers ft0 - ft9 in trap frame.</span>
00600         <span class="comment">//</span>
00601 
00602         RtlCopyIa64FloatRegisterContext(&amp;TrapFrame-&gt;FltT0, 
00603                                         &amp;ContextFrame-&gt;FltT0,
00604                                         <span class="keyword">sizeof</span>(FLOAT128) * (10));
00605 
00606     }
00607 
00608     <span class="comment">//</span>
00609     <span class="comment">// Set higher floating register contents if specified.</span>
00610     <span class="comment">//</span>
00611 
00612     <span class="keywordflow">if</span> ((ContextFlags &amp; CONTEXT_HIGHER_FLOATING_POINT) == CONTEXT_HIGHER_FLOATING_POINT) {
00613 
00614         TrapFrame-&gt;StFPSR = SANITIZE_FSR(ContextFrame-&gt;StFPSR, PreviousMode);
00615 
00616         <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
00617 
00618             <span class="comment">//</span>
00619             <span class="comment">// Update the higher floating point save area (f32-f127) and </span>
00620             <span class="comment">// set the corresponding modified bit in the PSR to 1.</span>
00621             <span class="comment">//</span>
00622 
00623             RtlCopyIa64FloatRegisterContext(
00624                 (PFLOAT128)GET_HIGH_FLOATING_POINT_REGISTER_SAVEAREA(),
00625                 &amp;ContextFrame-&gt;FltF32,
00626                 96*<span class="keyword">sizeof</span>(FLOAT128)
00627                 );
00628 
00629             TrapFrame-&gt;StIPSR |= (1i64 &lt;&lt; PSR_DFH);
00630         }
00631 
00632     }
00633 
00634     <span class="comment">//</span>
00635     <span class="comment">// Set debug registers.</span>
00636     <span class="comment">//</span>
00637 
00638     <span class="keywordflow">if</span> ((ContextFlags &amp; CONTEXT_DEBUG) == CONTEXT_DEBUG) {
00639         <a class="code" href="../../d5/d0/psctxi64_8c.html#a3">KiSetDebugContext</a> (TrapFrame, ContextFrame, PreviousMode);
00640     }
00641 
00642     <span class="keywordflow">return</span>;
00643 }
00644 
00645 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00646"></a><a class="code" href="../../d5/d0/psctxi64_8c.html#a4">00646</a> <a class="code" href="../../d5/d0/psctxi64_8c.html#a4">KiFlushUserRseState</a> (
00647     IN PKTRAP_FRAME TrapFrame
00648     )
00649 
00650 <span class="comment">/*++</span>
00651 <span class="comment"></span>
00652 <span class="comment">Routine Description:</span>
00653 <span class="comment"></span>
00654 <span class="comment">    This routine flushes the user rse state from the kernel backing store to the</span>
00655 <span class="comment">    user backing store. The user context frame is update to reflect the new </span>
00656 <span class="comment">    context state.</span>
00657 <span class="comment"></span>
00658 <span class="comment">Arguments:</span>
00659 <span class="comment"></span>
00660 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame.</span>
00661 <span class="comment"></span>
00662 <span class="comment">Return Value:</span>
00663 <span class="comment"></span>
00664 <span class="comment">    None.</span>
00665 <span class="comment"></span>
00666 <span class="comment">--*/</span>
00667 
00668 {
00669     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> BsFrameSize;
00670     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> RNatSaveIndex;
00671     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> Temp;
00672     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> TearPointOffset;
00673     ULONGLONG TopBound, BottomBound;
00674     ULONGLONG UserRnats1, UserRnats2;
00675     ULONGLONG Mask;
00676 
00677     <span class="comment">//</span>
00678     <span class="comment">// Copy user stacked registers' contents to user backing store.</span>
00679     <span class="comment">// N.B. Stack overflow could happen.</span>
00680     <span class="comment">//</span>
00681 
00682     <span class="keywordflow">try</span> {
00683 
00684         BsFrameSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(TrapFrame-&gt;RsBSP - TrapFrame-&gt;RsBSPSTORE);
00685 
00686         <span class="keywordflow">if</span> (BsFrameSize) {
00687 
00688             ULONGLONG Bsp, Rnat, KernelInitBsp;
00689 
00690             <span class="comment">//</span>
00691             <span class="comment">// Copy the dirty stacked registers back into the</span>
00692             <span class="comment">// user backing store</span>
00693             <span class="comment">//</span>
00694 
00695             <a class="code" href="../../d8/d0/rtl_2ia64_2miscc_8c.html#a0">RtlpFlushRSE</a>(&amp;Bsp, &amp;Rnat);
00696             TearPointOffset = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) TrapFrame-&gt;RsBSPSTORE &amp; 0x1F8;
00697 
00698             KernelInitBsp= (PCR-&gt;InitialBStore | TearPointOffset) + BsFrameSize;
00699             <span class="keywordflow">if</span> ((KernelInitBsp | RNAT_ALIGNMENT) != (Bsp | RNAT_ALIGNMENT)) {
00700                 Rnat = *(PULONGLONG)(KernelInitBsp | RNAT_ALIGNMENT);
00701             }
00702 
00703             RtlCopyMemory((PVOID)(TrapFrame-&gt;RsBSPSTORE),
00704                          (PVOID)(PCR-&gt;InitialBStore + TearPointOffset),
00705                          BsFrameSize);
00706 
00707             TopBound = TrapFrame-&gt;RsBSP | RNAT_ALIGNMENT;
00708             BottomBound = TrapFrame-&gt;RsBSPSTORE | RNAT_ALIGNMENT;
00709 
00710             RNatSaveIndex = TearPointOffset &gt;&gt; 3;
00711             Mask = (((1ULL &lt;&lt; (NAT_BITS_PER_RNAT_REG - RNatSaveIndex)) - 1) &lt;&lt; RNatSaveIndex);
00712             UserRnats1 = TrapFrame-&gt;RsRNAT &amp; ((1ULL &lt;&lt; RNatSaveIndex) - 1);
00713 
00714             <span class="keywordflow">if</span> (TopBound &gt; BottomBound) {
00715 
00716                 <span class="comment">//</span>
00717                 <span class="comment">// user dirty stacked GR span across at least one RNAT</span>
00718                 <span class="comment">// boundary; need to deposit the valid RNAT bits from</span>
00719                 <span class="comment">// the trap frame into the kernel backing store.  Also,</span>
00720                 <span class="comment">// the RNAT field in the trap frame has to be updated.</span>
00721                 <span class="comment">//</span>
00722 
00723                 UserRnats2 = *(PULONGLONG)BottomBound &amp; Mask;
00724                 *(PULONGLONG)BottomBound = UserRnats1 | UserRnats2;
00725                 TrapFrame-&gt;RsRNAT = Rnat;
00726                 
00727 <span class="preprocessor">#if DEBUG</span>
00728 <span class="preprocessor"></span>                <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KiFlushUserRseState 1: UserRnats1 = 0x%I64x, UserRnats2 = 0x%I64x, TF-&gt;RsRNAT = 0x%I64x\n"</span>,
00729                          UserRnats1, UserRnats2, TrapFrame-&gt;RsRNAT);
00730 <span class="preprocessor">#endif // DEBUG</span>
00731 <span class="preprocessor"></span>
00732             } <span class="keywordflow">else</span> {
00733 
00734                 <span class="comment">//</span>
00735                 <span class="comment">// user stacked register region does not span across an</span>
00736                 <span class="comment">// RNAT boundary; combine the RNAT fields from both the</span>
00737                 <span class="comment">// trap frame and the context frame.</span>
00738                 <span class="comment">//</span>
00739 
00740                 UserRnats2 = Rnat &amp; Mask;
00741                 TrapFrame-&gt;RsRNAT = UserRnats1 | UserRnats2;
00742 
00743 <span class="preprocessor">#if DEBUG</span>
00744 <span class="preprocessor"></span>                <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KiFlushUserRseState 2: UserRnats1 = 0x%I64x, UserRnats2 = 0x%I64x, TF-&gt;RsRNAT = 0x%I64x\n"</span>,
00745                          UserRnats1, UserRnats2, TrapFrame-&gt;RsRNAT);
00746 <span class="preprocessor">#endif // DEBUG</span>
00747 <span class="preprocessor"></span>
00748             }
00749         }
00750 
00751         <span class="comment">//</span>
00752         <span class="comment">// Successfully copied to user backing store; set the user's</span>
00753         <span class="comment">// bspstore to the value of its own bsp.</span>
00754         <span class="comment">//</span>
00755 
00756         TrapFrame-&gt;RsBSPSTORE = TrapFrame-&gt;RsBSP;
00757 
00758     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00759         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"WARNING: Exception raised in krnl-to-user bstore copy\n"</span>);
00760     }
00761 
00762     <span class="keywordflow">return</span>;
00763 }
00764 
00765 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00766"></a><a class="code" href="../../d6/d1/ia64_2thredini_8c.html#a2">00766</a> <a class="code" href="../../d6/d1/ia64_2thredini_8c.html#a2">KeContextToKframesSpecial</a> (
00767     IN <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread,
00768     IN OUT PKTRAP_FRAME TrapFrame,
00769     IN OUT PKEXCEPTION_FRAME ExceptionFrame,
00770     IN PCONTEXT ContextFrame,
00771     IN ULONG ContextFlags
00772     )
00773 
00774 <span class="comment">/*++</span>
00775 <span class="comment"></span>
00776 <span class="comment">Routine Description:</span>
00777 <span class="comment"></span>
00778 <span class="comment">    This routine moves the selected contents of the specified context frame into</span>
00779 <span class="comment">    the specified trap and exception frames according to the specified context</span>
00780 <span class="comment">    flags.</span>
00781 <span class="comment"></span>
00782 <span class="comment">Arguments:</span>
00783 <span class="comment"></span>
00784 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame that receives the volatile</span>
00785 <span class="comment">        context from the context record.</span>
00786 <span class="comment"></span>
00787 <span class="comment">    ExceptionFrame - Supplies a pointer to an exception frame that receives</span>
00788 <span class="comment">        the nonvolatile context from the context record.</span>
00789 <span class="comment"></span>
00790 <span class="comment">    ContextFrame - Supplies a pointer to a context frame that contains the</span>
00791 <span class="comment">        context that is to be copied into the trap and exception frames.</span>
00792 <span class="comment"></span>
00793 <span class="comment">    ContextFlags - Supplies the set of flags that specify which parts of the</span>
00794 <span class="comment">        context frame are to be copied into the trap and exception frames.</span>
00795 <span class="comment"></span>
00796 <span class="comment">    PreviousMode - Supplies the processor mode for which the trap and exception</span>
00797 <span class="comment">        frames are being built.</span>
00798 <span class="comment"></span>
00799 <span class="comment">Return Value:</span>
00800 <span class="comment"></span>
00801 <span class="comment">    None.</span>
00802 <span class="comment"></span>
00803 <span class="comment">--*/</span>
00804 
00805 {
00806     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> R1Offset, R4Offset;
00807     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> RNatSaveIndex; 
00808     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> BsFrameSize;
00809     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> TempFrameSize;
00810 
00811     <span class="comment">//</span>
00812     <span class="comment">// Set control information if specified.</span>
00813     <span class="comment">//</span>
00814 
00815     <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) {
00816 
00817         TrapFrame-&gt;IntGp = ContextFrame-&gt;IntGp;
00818         TrapFrame-&gt;IntSp = ContextFrame-&gt;IntSp;
00819         TrapFrame-&gt;ApUNAT = ContextFrame-&gt;ApUNAT;
00820         TrapFrame-&gt;BrRp = ContextFrame-&gt;BrRp;
00821         TrapFrame-&gt;ApCCV = ContextFrame-&gt;ApCCV;
00822         TrapFrame-&gt;ApDCR = SANITIZE_DCR(ContextFrame-&gt;ApDCR, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00823 
00824         <span class="comment">//</span>
00825         <span class="comment">// Set preserved applicaton registers in exception frame.</span>
00826         <span class="comment">//</span>
00827 
00828         ExceptionFrame-&gt;ApLC = ContextFrame-&gt;ApLC;
00829         ExceptionFrame-&gt;ApEC &amp;= ~(PFS_EC_MASK &lt;&lt; PFS_EC_MASK);
00830         ExceptionFrame-&gt;ApEC |= ((ContextFrame-&gt;ApEC &amp; PFS_EC_MASK) &lt;&lt; PFS_EC_SHIFT);
00831 
00832         <span class="comment">//</span>
00833         <span class="comment">// Set RSE control states in the trap frame.</span>
00834         <span class="comment">//</span>
00835 
00836         TrapFrame-&gt;RsPFS = ContextFrame-&gt;RsPFS;
00837 
00838         BsFrameSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ContextFrame-&gt;StIFS &amp; PFS_SIZE_MASK);
00839         RNatSaveIndex = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((ContextFrame-&gt;RsBSP &gt;&gt; 3) &amp; NAT_BITS_PER_RNAT_REG);
00840 
00841         TempFrameSize = RNatSaveIndex + BsFrameSize - NAT_BITS_PER_RNAT_REG;
00842         <span class="keywordflow">while</span> (TempFrameSize &gt;= 0) {
00843             BsFrameSize++;
00844             TempFrameSize -= NAT_BITS_PER_RNAT_REG;
00845         }
00846 
00847         TrapFrame-&gt;RsBSPSTORE = ContextFrame-&gt;RsBSPSTORE + BsFrameSize * 8;
00848         TrapFrame-&gt;RsBSP = TrapFrame-&gt;RsBSPSTORE;
00849         TrapFrame-&gt;RsRSC = ContextFrame-&gt;RsRSC;
00850         TrapFrame-&gt;RsRNAT = ContextFrame-&gt;RsRNAT;
00851 
00852 <span class="preprocessor">#if DEBUG</span>
00853 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KeContextToKFrames: RsRNAT = 0x%I64x\n"</span>, TrapFrame-&gt;RsRNAT);
00854 <span class="preprocessor">#endif // DEBUG</span>
00855 <span class="preprocessor"></span>
00856         <span class="comment">//</span>
00857         <span class="comment">// Set FPSR, IPSR, IIP, and IFS in the trap frame.</span>
00858         <span class="comment">//</span>
00859 
00860         TrapFrame-&gt;StFPSR = SANITIZE_FSR(ContextFrame-&gt;StFPSR, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00861         TrapFrame-&gt;StIPSR = SANITIZE_PSR(ContextFrame-&gt;StIPSR, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00862         <span class="keywordflow">if</span> (((TrapFrame-&gt;StIPSR &gt;&gt; PSR_RI) &amp; 3) == 3) {
00863             TrapFrame-&gt;StIPSR &amp;= ~(3i64 &lt;&lt; PSR_RI);
00864         }
00865         TrapFrame-&gt;StIFS  = SANITIZE_IFS(ContextFrame-&gt;StIFS, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00866         TrapFrame-&gt;StIIP  = ContextFrame-&gt;StIIP;
00867 
00868         <span class="comment">//</span>
00869         <span class="comment">// DebugActive controls h/w debug registers. Set if new psr.db = 1</span>
00870         <span class="comment">//</span>
00871 
00872         <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;DebugActive = ((TrapFrame-&gt;StIPSR &amp; (1I64 &lt;&lt; PSR_DB)) != 0);
00873 
00874         <span class="comment">//</span>
00875         <span class="comment">// Set application registers directly</span>
00876         <span class="comment">//</span>
00877 
00878         <span class="keywordflow">if</span> (Thread == <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()) {
00879             __setReg(CV_IA64_AR21, ContextFrame-&gt;StFCR);
00880             __setReg(CV_IA64_AR24, ContextFrame-&gt;Eflag);
00881             __setReg(CV_IA64_AR25, ContextFrame-&gt;SegCSD);
00882             __setReg(CV_IA64_AR26, ContextFrame-&gt;SegSSD);
00883             __setReg(CV_IA64_AR27, ContextFrame-&gt;Cflag);
00884             __setReg(CV_IA64_AR28, ContextFrame-&gt;StFSR);
00885             __setReg(CV_IA64_AR29, ContextFrame-&gt;StFIR);
00886             __setReg(CV_IA64_AR30, ContextFrame-&gt;StFDR);
00887         } <span class="keywordflow">else</span> {
00888             PKAPPLICATION_REGISTERS AppRegs;
00889 
00890             AppRegs = GET_APPLICATION_REGISTER_SAVEAREA(Thread-&gt;StackBase);
00891             AppRegs-&gt;Ar21 = ContextFrame-&gt;StFCR;
00892             AppRegs-&gt;Ar24 = ContextFrame-&gt;Eflag;
00893             AppRegs-&gt;Ar25 = ContextFrame-&gt;SegCSD;
00894             AppRegs-&gt;Ar26 = ContextFrame-&gt;SegSSD;
00895             AppRegs-&gt;Ar27 = ContextFrame-&gt;Cflag;
00896             AppRegs-&gt;Ar28 = ContextFrame-&gt;StFSR;
00897             AppRegs-&gt;Ar29 = ContextFrame-&gt;StFIR;
00898             AppRegs-&gt;Ar30 = ContextFrame-&gt;StFDR;
00899         }
00900     }
00901 
00902     <span class="comment">//</span>
00903     <span class="comment">// Set integer registers contents if specified.</span>
00904     <span class="comment">//</span>
00905 
00906     <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) {
00907 
00908         TrapFrame-&gt;IntT0 = ContextFrame-&gt;IntT0;
00909         TrapFrame-&gt;IntT1 = ContextFrame-&gt;IntT1;
00910         TrapFrame-&gt;IntT2 = ContextFrame-&gt;IntT2;
00911         TrapFrame-&gt;IntT3 = ContextFrame-&gt;IntT3;
00912         TrapFrame-&gt;IntT4 = ContextFrame-&gt;IntT4;
00913         TrapFrame-&gt;IntV0 = ContextFrame-&gt;IntV0;
00914         TrapFrame-&gt;IntTeb = ContextFrame-&gt;IntTeb;
00915         TrapFrame-&gt;Preds = ContextFrame-&gt;Preds;
00916 
00917         <span class="comment">//</span>
00918         <span class="comment">// t5 - t22</span>
00919         <span class="comment">//</span>
00920 
00921         memcpy(&amp;TrapFrame-&gt;IntT5, &amp;ContextFrame-&gt;IntT5, 18*<span class="keyword">sizeof</span>(ULONGLONG));
00922 
00923         <span class="comment">//</span>
00924         <span class="comment">// Set integer registers s0 - s3 in exception frame.</span>
00925         <span class="comment">//</span>
00926 
00927         ExceptionFrame-&gt;IntS0 = ContextFrame-&gt;IntS0;
00928         ExceptionFrame-&gt;IntS1 = ContextFrame-&gt;IntS1;
00929         ExceptionFrame-&gt;IntS2 = ContextFrame-&gt;IntS2;
00930         ExceptionFrame-&gt;IntS3 = ContextFrame-&gt;IntS3;
00931 
00932         <span class="comment">//</span>
00933         <span class="comment">// Set the integer nats field in the trap &amp; exception frames</span>
00934         <span class="comment">//</span>
00935 
00936         R1Offset = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((ULONG_PTR)(&amp;TrapFrame-&gt;IntGp) &gt;&gt; 3) &amp; 0x3f;
00937         R4Offset = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((ULONG_PTR)(&amp;ExceptionFrame-&gt;IntS0) &gt;&gt; 3) &amp; 0x3f;
00938 
00939         <a class="code" href="../../d1/d6/ke_2ia64_2context_8c.html#a1">EXTRACT_NATS</a>(TrapFrame-&gt;IntNats, ContextFrame-&gt;IntNats,
00940                      1, R1Offset, 0xFFFFFF0E);
00941         <a class="code" href="../../d1/d6/ke_2ia64_2context_8c.html#a1">EXTRACT_NATS</a>(ExceptionFrame-&gt;IntNats, ContextFrame-&gt;IntNats,
00942                      4, R4Offset, 0xF0);
00943 
00944 <span class="preprocessor">#if DEBUG</span>
00945 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KeContextToKFrames: TF-&gt;IntNats = 0x%I64x, ContestFrame-&gt;IntNats = 0x%I64x, R1OffSet = 0x%x\n"</span>,
00946                  TrapFrame-&gt;IntNats, ContextFrame-&gt;IntNats, R1Offset);
00947         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KeContextToKFrames: EF-&gt;IntNats = 0x%I64x, R4OffSet = 0x%x\n"</span>,
00948                  ExceptionFrame-&gt;IntNats, R4Offset);
00949 <span class="preprocessor">#endif // DEBUG</span>
00950 <span class="preprocessor"></span>
00951         <span class="comment">//</span>
00952         <span class="comment">// Set other branch registers in trap and exception frames</span>
00953         <span class="comment">//</span>
00954 
00955         TrapFrame-&gt;BrT0 = ContextFrame-&gt;BrT0;
00956         TrapFrame-&gt;BrT1 = ContextFrame-&gt;BrT1;
00957 
00958         memcpy(&amp;ExceptionFrame-&gt;BrS0, &amp;ContextFrame-&gt;BrS0, 5*<span class="keyword">sizeof</span>(ULONGLONG));
00959 
00960     }
00961 
00962     <span class="comment">//</span>
00963     <span class="comment">// Set lower floating register contents if specified.</span>
00964     <span class="comment">//</span>
00965 
00966     <span class="keywordflow">if</span> ((ContextFlags &amp; CONTEXT_LOWER_FLOATING_POINT) == CONTEXT_LOWER_FLOATING_POINT) {
00967 
00968         TrapFrame-&gt;StFPSR = SANITIZE_FSR(ContextFrame-&gt;StFPSR, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00969 
00970         <span class="comment">//</span>
00971         <span class="comment">// Set floating registers fs0 - fs19 in exception frame.</span>
00972         <span class="comment">//</span>
00973 
00974         RtlCopyIa64FloatRegisterContext(&amp;ExceptionFrame-&gt;FltS0, 
00975                                         &amp;ContextFrame-&gt;FltS0,
00976                                         <span class="keyword">sizeof</span>(FLOAT128) * (4));
00977 
00978         RtlCopyIa64FloatRegisterContext(&amp;ExceptionFrame-&gt;FltS4, 
00979                                         &amp;ContextFrame-&gt;FltS4,
00980                                         16*<span class="keyword">sizeof</span>(FLOAT128));
00981 
00982         <span class="comment">//</span>
00983         <span class="comment">// Set floating registers ft0 - ft9 in trap frame.</span>
00984         <span class="comment">//</span>
00985 
00986         RtlCopyIa64FloatRegisterContext(&amp;TrapFrame-&gt;FltT0, 
00987                                         &amp;ContextFrame-&gt;FltT0,
00988                                         <span class="keyword">sizeof</span>(FLOAT128) * (10));
00989 
00990     }
00991 
00992     <span class="comment">//</span>
00993     <span class="comment">// Set higher floating register contents if specified.</span>
00994     <span class="comment">//</span>
00995 
00996     <span class="keywordflow">if</span> ((ContextFlags &amp; CONTEXT_HIGHER_FLOATING_POINT) == CONTEXT_HIGHER_FLOATING_POINT) {
00997 
00998         TrapFrame-&gt;StFPSR = SANITIZE_FSR(ContextFrame-&gt;StFPSR, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00999 
01000         <span class="comment">//</span>
01001         <span class="comment">// Update the higher floating point save area (f32-f127) and </span>
01002         <span class="comment">// set the corresponding modified bit in the PSR to 1.</span>
01003         <span class="comment">//</span>
01004 
01005         RtlCopyIa64FloatRegisterContext(
01006             (PFLOAT128)GET_HIGH_FLOATING_POINT_REGISTER_SAVEAREA(),
01007             &amp;ContextFrame-&gt;FltF32,
01008             96*<span class="keyword">sizeof</span>(FLOAT128)
01009             );
01010 
01011         TrapFrame-&gt;StIPSR |= (1i64 &lt;&lt; PSR_DFH);
01012 
01013     }
01014 
01015     <span class="comment">//</span>
01016     <span class="comment">// Set debug registers.</span>
01017     <span class="comment">//</span>
01018 
01019     <span class="keywordflow">if</span> ((ContextFlags &amp; CONTEXT_DEBUG) == CONTEXT_DEBUG) {
01020         <a class="code" href="../../d5/d0/psctxi64_8c.html#a3">KiSetDebugContext</a> (TrapFrame, ContextFrame, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
01021     }
01022 
01023     <span class="keywordflow">return</span>;
01024 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:33 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
