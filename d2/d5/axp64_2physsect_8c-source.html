<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: physsect.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>physsect.c</h1><a href="../../d1/d6/axp64_2physsect_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment">Copyright (c) 1992  Digital Equipment Corporation</span>
00005 <span class="comment"></span>
00006 <span class="comment">Module Name:</span>
00007 <span class="comment"></span>
00008 <span class="comment">   physsect.c</span>
00009 <span class="comment"></span>
00010 <span class="comment">Abstract:</span>
00011 <span class="comment"></span>
00012 <span class="comment">    This module contains the routine for mapping physical sections for</span>
00013 <span class="comment">    ALPHA machines.</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    Lou Perazzoli (loup) 22-May-1989</span>
00018 <span class="comment">    Joe Notarangelo      21-Sep-1992</span>
00019 <span class="comment"></span>
00020 <span class="comment">Revision History:</span>
00021 <span class="comment"></span>
00022 <span class="comment">--*/</span>
00023 
00024 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00025 
00026 <span class="comment">//#define FIRSTDBG 1</span>
00027 <span class="comment">//#define AGGREGATE_DBG FIRSTDBG</span>
00028 
00029 <span class="keyword">static</span>
00030 ULONG
00031 <a class="code" href="../../d1/d6/axp64_2physsect_8c.html#a3">MaximumAlignment</a>(
00032     ULONG Offset
00033     );
00034 
00035 <span class="keyword">static</span>
00036 ULONG
00037 <a class="code" href="../../d1/d6/axp64_2physsect_8c.html#a4">AggregatePages</a>(
00038     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>,
00039     PFN_NUMBER,
00040     ULONG,
00041     PULONG
00042     );
00043 
00044 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00045"></a><a class="code" href="../../d1/d6/axp64_2physsect_8c.html#a2">00045</a> <a class="code" href="../../d4/d8/mi_8h.html#a913">MiMapViewOfPhysicalSection</a> (
00046     IN <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea,
00047     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00048     IN PVOID *CapturedBase,
00049     IN PLARGE_INTEGER SectionOffset,
00050     IN PSIZE_T CapturedViewSize,
00051     IN ULONG ProtectionMask,
00052     IN ULONG_PTR ZeroBits,
00053     IN ULONG AllocationType,
00054     IN BOOLEAN WriteCombined,
00055     OUT PBOOLEAN ReleasedWsMutex
00056     )
00057 
00058 <span class="comment">/*++</span>
00059 <span class="comment"></span>
00060 <span class="comment">Routine Description:</span>
00061 <span class="comment"></span>
00062 <span class="comment">    This routine maps the specified physical section into the</span>
00063 <span class="comment">    specified process's address space.</span>
00064 <span class="comment"></span>
00065 <span class="comment">Arguments:</span>
00066 <span class="comment"></span>
00067 <span class="comment">    see MmMapViewOfSection above...</span>
00068 <span class="comment"></span>
00069 <span class="comment">    ControlArea - Supplies the control area for the section.</span>
00070 <span class="comment"></span>
00071 <span class="comment">    Process - Supplies the process pointer which is receiving the section.</span>
00072 <span class="comment"></span>
00073 <span class="comment">    ProtectionMask - Supplies the initial page protection-mask.</span>
00074 <span class="comment"></span>
00075 <span class="comment">    ReleasedWsMutex - Supplies FALSE, receives TRUE if the working set</span>
00076 <span class="comment">                      mutex is released.</span>
00077 <span class="comment"></span>
00078 <span class="comment">Return Value:</span>
00079 <span class="comment"></span>
00080 <span class="comment">    Status of the map view operation.</span>
00081 <span class="comment"></span>
00082 <span class="comment">Environment:</span>
00083 <span class="comment"></span>
00084 <span class="comment">    Kernel Mode, working set mutex and address creation mutex held.</span>
00085 <span class="comment"></span>
00086 <span class="comment">--*/</span>
00087 
00088 {
00089     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
00090     PVOID StartingAddress;
00091     PVOID EndingAddress;
00092     KIRQL OldIrql;
00093     KIRQL OldIrql2;
00094     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
00095     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00096     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00097     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
00098     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00099     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
00100     SIZE_T PhysicalViewSize;
00101     ULONG Alignment;
00102     ULONG PagesToMap;
00103     PFN_NUMBER NextPfn;
00104     PVOID UsedPageTableHandle;
00105     PVOID UsedPageDirectoryHandle;
00106     <a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">PMI_PHYSICAL_VIEW</a> PhysicalView;
00107 
00108     <span class="comment">//</span>
00109     <span class="comment">// Physical memory section.</span>
00110     <span class="comment">//</span>
00111 
00112 <span class="preprocessor">#ifdef FIRSTDBG</span>
00113 <span class="preprocessor"></span>
00114     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Physsect CaptureBase = %x  SectionOffset = %x\n"</span>,
00115               CapturedBase, SectionOffset-&gt;LowPart );
00116     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Physsect Allocation Type = %x, MEM_LARGE_PAGES = %x\n"</span>,
00117               AllocationType, MEM_LARGE_PAGES );
00118 
00119 <span class="preprocessor">#endif //FIRSTDBG</span>
00120 <span class="preprocessor"></span>
00121     <span class="comment">//</span>
00122     <span class="comment">// Compute the alignment we require for the virtual mapping.</span>
00123     <span class="comment">// The default is 64K to match protection boundaries.</span>
00124     <span class="comment">// Larger page sizes are used if MEM_LARGE_PAGES is requested.</span>
00125     <span class="comment">// The Alpha AXP architecture supports granularity hints so that</span>
00126     <span class="comment">// larger pages can be defined in the following multiples of</span>
00127     <span class="comment">// PAGE_SIZE:</span>
00128     <span class="comment">//            8**(GH) * PAGE_SIZE, where GH element of {0,1,2,3}</span>
00129     <span class="comment">//</span>
00130 
00131     Alignment = <a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a>;
00132 
00133     <span class="keywordflow">if</span>( AllocationType &amp; MEM_LARGE_PAGES ){
00134 
00135         <span class="comment">//</span>
00136         <span class="comment">// MaxAlignment is the maximum boundary alignment of the</span>
00137         <span class="comment">// SectionOffset (where the maximum boundary is one of the possible</span>
00138         <span class="comment">//                granularity hints boundaries)</span>
00139         <span class="comment">//</span>
00140 
00141         ULONG MaxAlignment = <a class="code" href="../../d1/d6/axp64_2physsect_8c.html#a3">MaximumAlignment</a>( SectionOffset-&gt;LowPart );
00142 
00143         Alignment = (MaxAlignment &gt; Alignment) ? MaxAlignment : Alignment;
00144 
00145 <span class="preprocessor">#ifdef FIRSTDBG</span>
00146 <span class="preprocessor"></span>
00147         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Alignment = %x, SectionOffset = %x\n"</span>,
00148                        Alignment, SectionOffset-&gt;LowPart );
00149 
00150 <span class="preprocessor">#endif //FIRSTDBG</span>
00151 <span class="preprocessor"></span>
00152     }
00153 
00154 
00155     <a class="code" href="../../d4/d8/mi_8h.html#a154">LOCK_WS</a> (Process);
00156 
00157     <span class="keywordflow">if</span> (*CapturedBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00158 
00159         <span class="comment">//</span>
00160         <span class="comment">// Attempt to locate address space.  This could raise an</span>
00161         <span class="comment">// exception.</span>
00162         <span class="comment">//</span>
00163 
00164         <span class="keywordflow">try</span> {
00165 
00166             <span class="comment">//</span>
00167             <span class="comment">// Find a starting address on an alignment boundary.</span>
00168             <span class="comment">//</span>
00169 
00170 
00171             PhysicalViewSize = (SectionOffset-&gt;LowPart + *CapturedViewSize) -
00172                                (ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a91">MI_64K_ALIGN</a>(SectionOffset-&gt;LowPart);
00173 
00174             StartingAddress = <a class="code" href="../../d6/d3/vadtree_8c.html#a3">MiFindEmptyAddressRange</a> (PhysicalViewSize,
00175                                                        Alignment,
00176                                                        (ULONG)ZeroBits);
00177 
00178         } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00179 
00180             <span class="keywordflow">return</span> GetExceptionCode();
00181         }
00182 
00183         EndingAddress = (PVOID)(((ULONG_PTR)StartingAddress +
00184                                 PhysicalViewSize - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>));
00185 
00186         StartingAddress = (PVOID)((ULONG_PTR)StartingAddress +
00187                                      (SectionOffset-&gt;LowPart &amp; (<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a> - 1)));
00188 
00189         <span class="keywordflow">if</span> (ZeroBits &gt; 0) {
00190             <span class="keywordflow">if</span> (EndingAddress &gt; (PVOID)((LONG_PTR)0xFFFFFFFF &gt;&gt; ZeroBits)) {
00191                 <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00192             }
00193         }
00194 
00195     } <span class="keywordflow">else</span> {
00196 
00197         <span class="comment">//</span>
00198         <span class="comment">// Check to make sure the specified base address to ending address</span>
00199         <span class="comment">// is currently unused.</span>
00200         <span class="comment">//</span>
00201 
00202         PhysicalViewSize = (SectionOffset-&gt;LowPart + *CapturedViewSize) -
00203                                 (ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a91">MI_64K_ALIGN</a>(SectionOffset-&gt;LowPart);
00204 
00205         StartingAddress = (PVOID)((ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a91">MI_64K_ALIGN</a>(*CapturedBase) +
00206                                     (SectionOffset-&gt;LowPart &amp; (<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a> - 1)));
00207 
00208         EndingAddress = (PVOID)(((ULONG_PTR)StartingAddress +
00209                                 *CapturedViewSize - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>));
00210 
00211         Vad = <a class="code" href="../../d4/d8/mi_8h.html#a98">MiCheckForConflictingVad</a> (StartingAddress, EndingAddress);
00212         <span class="keywordflow">if</span> (Vad != (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00213 <span class="preprocessor">#if 0</span>
00214 <span class="preprocessor"></span>            MiDumpConflictingVad (StartingAddress, EndingAddress, Vad);
00215 <span class="preprocessor">#endif</span>
00216 <span class="preprocessor"></span>
00217             <span class="keywordflow">return</span> STATUS_CONFLICTING_ADDRESSES;
00218         }
00219     }
00220 
00221     <span class="comment">//</span>
00222     <span class="comment">// An unoccuppied address range has been found, build the virtual</span>
00223     <span class="comment">// address descriptor to describe this range.</span>
00224     <span class="comment">//</span>
00225 
00226     <span class="comment">//</span>
00227     <span class="comment">// Establish an exception handler and attempt to allocate</span>
00228     <span class="comment">// the pool and charge quota.  Note that the InsertVad routine</span>
00229     <span class="comment">// will also charge quota which could raise an exception.</span>
00230     <span class="comment">//</span>
00231 
00232     <span class="keywordflow">try</span>  {
00233 
00234         PhysicalView = (<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">PMI_PHYSICAL_VIEW</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00235                                                                  <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">MI_PHYSICAL_VIEW</a>),
00236                                                                  <a class="code" href="../../d4/d8/mi_8h.html#a231">MI_PHYSICAL_VIEW_KEY</a>);
00237         <span class="keywordflow">if</span> (PhysicalView == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00238             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INSUFFICIENT_RESOURCES);
00239         }
00240 
00241         Vad = (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d6/struct__MMVAD.html">MMVAD</a>), ' daV');
00242         <span class="keywordflow">if</span> (Vad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00243             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INSUFFICIENT_RESOURCES);
00244         }
00245 
00246         PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o1">Vad</a> = Vad;
00247         PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o2">StartVa</a> = StartingAddress;
00248         PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o3">EndVa</a> = EndingAddress;
00249 
00250         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a> = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (StartingAddress);
00251         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a> = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (EndingAddress);
00252         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a> = ControlArea;
00253         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.LongFlags = 0;
00254         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.Inherit = ViewUnmap;
00255         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PhysicalMapping = 1;
00256         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o19">u4</a>.Banked = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00257         <span class="comment">// Vad-&gt;u.VadFlags.ImageMap = 0;</span>
00258         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.Protection = ProtectionMask;
00259         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.CopyOnWrite = 0;
00260         <span class="comment">// Vad-&gt;u.VadFlags.LargePages = 0;</span>
00261         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o9">FirstPrototypePte</a> =
00262                        (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a180">MI_CONVERT_PHYSICAL_BUS_TO_PFN</a>(*SectionOffset));
00263 
00264         <span class="comment">//</span>
00265         <span class="comment">// Set the first prototype PTE field in the Vad.</span>
00266         <span class="comment">//</span>
00267 
00268         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o10">LastContiguousPte</a> =
00269                        (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a180">MI_CONVERT_PHYSICAL_BUS_TO_PFN</a>(*SectionOffset));
00270 
00271         <span class="comment">//</span>
00272         <span class="comment">// Insert the VAD.  This could get an exception.</span>
00273         <span class="comment">//</span>
00274 
00275         <a class="code" href="../../d6/d3/vadtree_8c.html#a0">MiInsertVad</a> (Vad);
00276 
00277     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00278 
00279         <span class="keywordflow">if</span> (PhysicalView != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00280             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (PhysicalView);
00281         }
00282 
00283         <span class="keywordflow">if</span> (Vad != (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00284 
00285             <span class="comment">//</span>
00286             <span class="comment">// The pool allocation suceeded, but the quota charge</span>
00287             <span class="comment">// in InsertVad failed, deallocate the pool and return</span>
00288             <span class="comment">// and error.</span>
00289             <span class="comment">//</span>
00290 
00291             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Vad);
00292             <span class="keywordflow">return</span> GetExceptionCode();
00293         }
00294         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00295     }
00296 
00297     <span class="comment">// Increment the count of the number of views for the</span>
00298     <span class="comment">// section object.  This requires the PFN mutex to be held.</span>
00299     <span class="comment">//</span>
00300 
00301     <a class="code" href="../../d4/d8/mi_8h.html#a133">LOCK_AWE</a> (Process, OldIrql);
00302     <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql2);
00303 
00304     InsertHeadList (&amp;Process-&gt;PhysicalVadList, &amp;PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o0">ListEntry</a>);
00305 
00306     ControlArea-&gt;NumberOfMappedViews += 1;
00307     ControlArea-&gt;NumberOfUserReferences += 1;
00308     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;NumberOfSectionReferences != 0);
00309 
00310     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql2);
00311     <a class="code" href="../../d4/d8/mi_8h.html#a134">UNLOCK_AWE</a> (Process, OldIrql);
00312 
00313     <span class="comment">//</span>
00314     <span class="comment">// Build the PTEs in the address space.</span>
00315     <span class="comment">//</span>
00316 
00317     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (StartingAddress);
00318     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (StartingAddress);
00319     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (StartingAddress);
00320     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (EndingAddress);
00321 
00322 <span class="preprocessor">#if defined (_WIN64)</span>
00323 <span class="preprocessor"></span>    <a class="code" href="../../d4/d8/mi_8h.html#a245">MiMakePpeExistAndMakeValid</a> (PointerPpe, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00324     <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
00325         UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
00326         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a181">MI_GET_USED_PTES_FROM_HANDLE</a> (UsedPageDirectoryHandle) == 0); 
00327         <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
00328     }
00329 <span class="preprocessor">#endif</span>
00330 <span class="preprocessor"></span>
00331     <a class="code" href="../../d0/d2/mmsup_8c.html#a7">MiMakePdeExistAndMakeValid</a>(PointerPde, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00332 
00333     Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
00334 
00335     PagesToMap = (ULONG)((((ULONG_PTR)EndingAddress - (ULONG_PTR)StartingAddress))
00336                    + (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>-1) ) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00337 
00338     NextPfn = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a180">MI_CONVERT_PHYSICAL_BUS_TO_PFN</a>(*SectionOffset);
00339 
00340 <span class="preprocessor">#ifdef FIRSTDBG</span>
00341 <span class="preprocessor"></span>
00342     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Physsect, PagesToMap = %x  NextPfn = %x\n"</span>,
00343                    PagesToMap, NextPfn );
00344 
00345 <span class="preprocessor">#endif //FIRSTDBG</span>
00346 <span class="preprocessor"></span>
00347     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
00348                        NextPfn,
00349                        ProtectionMask,
00350                        PointerPte);
00351 
00352     <span class="keywordflow">if</span> (WriteCombined == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00353         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a111">MI_SET_PTE_WRITE_COMBINE</a> (TempPte);
00354     }
00355 
00356     <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write) {
00357             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.FaultOnWrite = 1;
00358     }
00359 
00360     <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
00361 
00362         ULONG PagesTogether;
00363         ULONG GranularityHint;
00364 
00365         <span class="comment">//</span>
00366         <span class="comment">// Compute the number of pages that can be mapped together</span>
00367         <span class="comment">//</span>
00368 
00369         <span class="keywordflow">if</span>( AllocationType &amp; MEM_LARGE_PAGES ){
00370             PagesTogether = <a class="code" href="../../d1/d6/axp64_2physsect_8c.html#a4">AggregatePages</a>( PointerPte,
00371                                             NextPfn,
00372                                             PagesToMap,
00373                                             &amp;GranularityHint );
00374         } <span class="keywordflow">else</span> {
00375             PagesTogether = 1;
00376             GranularityHint = 0;
00377         }
00378 
00379 <span class="preprocessor">#ifdef FIRSTDBG</span>
00380 <span class="preprocessor"></span>
00381         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Physsect  PointerPte = %x, NextPfn = %x\n"</span>,
00382                        PointerPte, NextPfn );
00383         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Va = %x  TempPte.Pfn = %x\n"</span>,
00384                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>( PointerPte ),
00385                        TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber );
00386         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: PagesToMap = %x\n"</span>, PagesToMap );
00387         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: PagesTogether = %x, GH = %x\n"</span>,
00388                        PagesTogether, GranularityHint );
00389 
00390 <span class="preprocessor">#endif //FIRSTDBG</span>
00391 <span class="preprocessor"></span>
00392         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.GranularityHint = GranularityHint;
00393 
00394         NextPfn += PagesTogether;
00395         PagesToMap -= PagesTogether;
00396 
00397         UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte));
00398 
00399         <span class="keywordflow">while</span>( PagesTogether-- ){
00400 
00401             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPte)) {
00402 
00403                 PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
00404 
00405                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a166">MiIsPteOnPpeBoundary</a> (PointerPte)) {
00406                     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
00407                     <a class="code" href="../../d4/d8/mi_8h.html#a245">MiMakePpeExistAndMakeValid</a> (PointerPpe, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00408                     <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
00409                         UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
00410                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a181">MI_GET_USED_PTES_FROM_HANDLE</a> (UsedPageDirectoryHandle) == 0); 
00411                 
00412                         <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
00413                     }
00414                 }
00415 
00416                 <a class="code" href="../../d0/d2/mmsup_8c.html#a7">MiMakePdeExistAndMakeValid</a> (PointerPde, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00417                 Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
00418                 UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte));
00419             }
00420 
00421             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PointerPte-&gt;u.Long == 0 );
00422 
00423             *PointerPte = TempPte;
00424 <span class="preprocessor">#if PFN_CONSISTENCY</span>
00425 <span class="preprocessor"></span>            <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00426 <span class="preprocessor">#endif</span>
00427 <span class="preprocessor"></span>            Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
00428 <span class="preprocessor">#if PFN_CONSISTENCY</span>
00429 <span class="preprocessor"></span>            <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00430 <span class="preprocessor">#endif</span>
00431 <span class="preprocessor"></span>
00432             <span class="comment">//</span>
00433             <span class="comment">// Increment the count of non-zero page table entries for this</span>
00434             <span class="comment">// page table and the number of private pages for the process.</span>
00435             <span class="comment">//</span>
00436 
00437             <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageTableHandle);
00438 
00439             PointerPte += 1;
00440 
00441             TempPte.u.Hard.PageFrameNumber += 1;
00442 
00443         } <span class="comment">// while (PagesTogether-- )</span>
00444 
00445     }  <span class="comment">// while (PointerPte &lt;= LastPte)</span>
00446 
00447     <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (Process);
00448     *ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00449 
00450     <span class="comment">//</span>
00451     <span class="comment">// Update the current virtual size in the process header.</span>
00452     <span class="comment">//</span>
00453 
00454     *CapturedViewSize = (ULONG)((ULONG_PTR)EndingAddress - (ULONG_PTR)StartingAddress + 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00455     Process-&gt;VirtualSize += *CapturedViewSize;
00456 
00457     <span class="keywordflow">if</span> (Process-&gt;VirtualSize &gt; Process-&gt;PeakVirtualSize) {
00458         Process-&gt;PeakVirtualSize = Process-&gt;VirtualSize;
00459     }
00460 
00461     <span class="comment">//</span>
00462     <span class="comment">// Translate the virtual address to a quasi-virtual address for</span>
00463     <span class="comment">// use by drivers that touch mapped devices.  Note: the routine</span>
00464     <span class="comment">// HalCreateQva will not translate the StartingAddress if the</span>
00465     <span class="comment">// StartingAddress is within system memory address space.</span>
00466     <span class="comment">//</span>
00467     <span class="comment">// N.B. - It will not work to attempt map addresses that begin in</span>
00468     <span class="comment">// system memory and extend through i/o space.</span>
00469     <span class="comment">//</span>
00470 
00471     *CapturedBase = HalCreateQva( *SectionOffset, StartingAddress );
00472 
00473     <span class="keywordflow">return</span> STATUS_SUCCESS;
00474 }
00475 
00476 
00477 ULONG
<a name="l00478"></a><a class="code" href="../../d1/d6/axp64_2physsect_8c.html#a3">00478</a> <a class="code" href="../../d1/d6/axp64_2physsect_8c.html#a3">MaximumAlignment</a>(
00479     IN ULONG Offset
00480     )
00481 <span class="comment">/*++</span>
00482 <span class="comment"></span>
00483 <span class="comment">Routine Description:</span>
00484 <span class="comment"></span>
00485 <span class="comment">    This routine returns the maximum granularity hint alignment boundary</span>
00486 <span class="comment">    to which Offset is naturally aligned.</span>
00487 <span class="comment"></span>
00488 <span class="comment">Arguments:</span>
00489 <span class="comment"></span>
00490 <span class="comment">    Offset - Supplies the address offset to check for alignment.</span>
00491 <span class="comment"></span>
00492 <span class="comment">Return Value:</span>
00493 <span class="comment"></span>
00494 <span class="comment">    The number which represents the largest natural alignment of Offset.</span>
00495 <span class="comment"></span>
00496 <span class="comment">Environment:</span>
00497 <span class="comment"></span>
00498 <span class="comment">--*/</span>
00499 {
00500 
00501     <span class="keywordflow">if</span>( (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &amp; (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a37">GH3_PAGE_SIZE</a> - 1)) == 0 ){
00502         <span class="keywordflow">return</span> <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a37">GH3_PAGE_SIZE</a>;
00503     }
00504 
00505     <span class="keywordflow">if</span>( (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &amp; (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a39">GH2_PAGE_SIZE</a> - 1)) == 0 ){
00506         <span class="keywordflow">return</span> <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a39">GH2_PAGE_SIZE</a>;
00507     }
00508 
00509     <span class="keywordflow">if</span>( (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &amp; (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a41">GH1_PAGE_SIZE</a> - 1)) == 0 ){
00510         <span class="keywordflow">return</span> <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a41">GH1_PAGE_SIZE</a>;
00511     }
00512 
00513     <span class="keywordflow">if</span>( (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1)) == 0 ){
00514         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00515     }
00516 
00517     <span class="keywordflow">return</span> 0;
00518 }
00519 
00520 
00521 ULONG
<a name="l00522"></a><a class="code" href="../../d1/d6/axp64_2physsect_8c.html#a4">00522</a> <a class="code" href="../../d1/d6/axp64_2physsect_8c.html#a4">AggregatePages</a>(
00523     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>  PointerPte,
00524     IN PFN_NUMBER Pfn,
00525     IN ULONG   Pages,
00526     OUT PULONG GranularityHint
00527     )
00528 <span class="comment">/*++</span>
00529 <span class="comment"></span>
00530 <span class="comment">Routine Description:</span>
00531 <span class="comment"></span>
00532 <span class="comment">    This routine computes the number of standard size pages that can be</span>
00533 <span class="comment">    aggregated into a single large page and returns the granularity hint</span>
00534 <span class="comment">    for that size large page.</span>
00535 <span class="comment"></span>
00536 <span class="comment">Arguments:</span>
00537 <span class="comment"></span>
00538 <span class="comment">    PointerPte - Supplies the PTE pointer for the starting virtual address</span>
00539 <span class="comment">                     of the mapping.</span>
00540 <span class="comment">    Pfn - Supplies the starting page frame number of the memory to be</span>
00541 <span class="comment">                     mapped.</span>
00542 <span class="comment">    Pages - Supplies the number of pages to map.</span>
00543 <span class="comment"></span>
00544 <span class="comment">    GranularityHint - Receives the granularity hint for the large page used</span>
00545 <span class="comment">                         to aggregate the standard pages.</span>
00546 <span class="comment"></span>
00547 <span class="comment">Return Value:</span>
00548 <span class="comment"></span>
00549 <span class="comment">    The number of pages that can be aggregated together.</span>
00550 <span class="comment"></span>
00551 <span class="comment">Environment:</span>
00552 <span class="comment"></span>
00553 <span class="comment">--*/</span>
00554 {
00555 
00556     ULONG MaxVirtualAlignment;
00557     ULONG MaxPhysicalAlignment;
00558     ULONG MaxPageAlignment;
00559     ULONG MaxAlignment;
00560 
00561     <span class="comment">//</span>
00562     <span class="comment">// Determine the largest page that will map a maximum of Pages.</span>
00563     <span class="comment">// The largest page must be both virtually and physically aligned</span>
00564     <span class="comment">// to the large page size boundary.</span>
00565     <span class="comment">// Determine the largest common alignment for the virtual and</span>
00566     <span class="comment">// physical addresses, factor in Pages, and then match to the</span>
00567     <span class="comment">// largest page size possible via the granularity hints.</span>
00568     <span class="comment">//</span>
00569 
00570     MaxVirtualAlignment =
00571         <a class="code" href="../../d1/d6/axp64_2physsect_8c.html#a3">MaximumAlignment</a>((ULONG)((ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte)));
00572 
00573     MaxPhysicalAlignment = <a class="code" href="../../d1/d6/axp64_2physsect_8c.html#a3">MaximumAlignment</a>( (ULONG)(Pfn &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>) );
00574 
00575     MaxPageAlignment = (ULONG)(Pages &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00576 
00577 <span class="preprocessor">#ifdef AGGREGATE_DBG</span>
00578 <span class="preprocessor"></span>
00579     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Aggregate MaxVirtualAlign = %x\n"</span>, MaxVirtualAlignment );
00580     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Aggregate MaxPhysicalAlign = %x\n"</span>, MaxPhysicalAlignment );
00581     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Aggregate MaxPageAlign = %x\n"</span>, MaxPageAlignment );
00582 
00583 <span class="preprocessor">#endif //AGGREGATE_DBG</span>
00584 <span class="preprocessor"></span>    <span class="comment">//</span>
00585     <span class="comment">// Maximum alignment is the minimum of the virtual and physical alignments.</span>
00586     <span class="comment">//</span>
00587 
00588     MaxAlignment =  (MaxVirtualAlignment &gt; MaxPhysicalAlignment) ?
00589                         MaxPhysicalAlignment : MaxVirtualAlignment;
00590     MaxAlignment = (MaxAlignment &gt; MaxPageAlignment) ?
00591                         MaxPageAlignment : MaxAlignment;
00592 
00593     <span class="comment">//</span>
00594     <span class="comment">// Convert MaxAlignment to granularity hint value</span>
00595     <span class="comment">//</span>
00596 
00597     <span class="keywordflow">if</span>( (MaxAlignment &amp; (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a37">GH3_PAGE_SIZE</a> - 1)) == 0 ){
00598 
00599         *GranularityHint = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a36">GH3</a>;
00600 
00601     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( (MaxAlignment &amp; (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a39">GH2_PAGE_SIZE</a> - 1)) == 0 ){
00602 
00603         *GranularityHint = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a38">GH2</a>;
00604 
00605     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( (MaxAlignment &amp; (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a41">GH1_PAGE_SIZE</a> - 1)) == 0 ){
00606 
00607         *GranularityHint = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a40">GH1</a>;
00608 
00609     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( (MaxAlignment &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1)) == 0 ){
00610 
00611         *GranularityHint = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a42">GH0</a>;
00612 
00613     } <span class="keywordflow">else</span> {
00614 
00615         *GranularityHint = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a42">GH0</a>;
00616 
00617 <span class="preprocessor">#if DBG</span>
00618 <span class="preprocessor"></span>
00619         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Aggregate Physical pages - not page aligned\n"</span> );
00620 
00621 <span class="preprocessor">#endif //DBG</span>
00622 <span class="preprocessor"></span>
00623     } <span class="comment">// end, if then elseif</span>
00624 
00625     <span class="comment">//</span>
00626     <span class="comment">// Return number of pages aggregated.</span>
00627     <span class="comment">//</span>
00628 
00629     <span class="keywordflow">return</span>( MaxAlignment &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a> );
00630 
00631 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:09 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
