<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: fmtexp.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>fmtexp.c</h1><a href="../../d1/d6/fmtexp_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="preprocessor">#include "<a class="code" href="../../d3/d3/arcinst_2precomp_8h.html">precomp.h</a>"</span>
00002 <span class="preprocessor">#pragma hdrstop</span>
00003 <span class="preprocessor"></span>
<a name="l00004"></a><a class="code" href="../../d1/d6/fmtexp_8c.html#a0">00004</a> <span class="preprocessor">#define READ_SIZE   65536</span>
00005 <span class="preprocessor"></span>
<a name="l00006"></a><a class="code" href="../../d8/d1/structUNALIGNED__SECTOR__ZERO.html">00006</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00007"></a><a class="code" href="../../d8/d1/structUNALIGNED__SECTOR__ZERO.html#o0">00007</a>     UCHAR   IntelNearJumpCommand[1];    <span class="comment">// Intel Jump command</span>
<a name="l00008"></a><a class="code" href="../../d8/d1/structUNALIGNED__SECTOR__ZERO.html#o1">00008</a>     UCHAR   BootStrapJumpOffset[2];     <span class="comment">// offset of boot strap code</span>
<a name="l00009"></a><a class="code" href="../../d8/d1/structUNALIGNED__SECTOR__ZERO.html#o2">00009</a>     UCHAR   OemData[8];                     <span class="comment">// OEM data</span>
<a name="l00010"></a><a class="code" href="../../d8/d1/structUNALIGNED__SECTOR__ZERO.html#o3">00010</a>     UCHAR   BytesPerSector[2];          <span class="comment">// BPB</span>
<a name="l00011"></a><a class="code" href="../../d8/d1/structUNALIGNED__SECTOR__ZERO.html#o4">00011</a>     UCHAR   SectorsPerCluster[1];       <span class="comment">//</span>
<a name="l00012"></a><a class="code" href="../../d8/d1/structUNALIGNED__SECTOR__ZERO.html#o5">00012</a>     UCHAR   ReservedSectors[2];         <span class="comment">//</span>
<a name="l00013"></a><a class="code" href="../../d8/d1/structUNALIGNED__SECTOR__ZERO.html#o6">00013</a>     UCHAR   Fats[1];                    <span class="comment">//</span>
<a name="l00014"></a><a class="code" href="../../d8/d1/structUNALIGNED__SECTOR__ZERO.html#o7">00014</a>     UCHAR   RootEntries[2];             <span class="comment">//</span>
<a name="l00015"></a><a class="code" href="../../d8/d1/structUNALIGNED__SECTOR__ZERO.html#o8">00015</a>     UCHAR   Sectors[2];                 <span class="comment">//</span>
<a name="l00016"></a><a class="code" href="../../d8/d1/structUNALIGNED__SECTOR__ZERO.html#o9">00016</a>     UCHAR   Media[1];                   <span class="comment">//</span>
<a name="l00017"></a><a class="code" href="../../d8/d1/structUNALIGNED__SECTOR__ZERO.html#o10">00017</a>     UCHAR   SectorsPerFat[2];           <span class="comment">//</span>
<a name="l00018"></a><a class="code" href="../../d8/d1/structUNALIGNED__SECTOR__ZERO.html#o11">00018</a>     UCHAR   SectorsPerTrack[2];         <span class="comment">//</span>
<a name="l00019"></a><a class="code" href="../../d8/d1/structUNALIGNED__SECTOR__ZERO.html#o12">00019</a>     UCHAR   Heads[2];                   <span class="comment">//</span>
<a name="l00020"></a><a class="code" href="../../d8/d1/structUNALIGNED__SECTOR__ZERO.html#o13">00020</a>     UCHAR   HiddenSectors[4];           <span class="comment">//</span>
<a name="l00021"></a><a class="code" href="../../d8/d1/structUNALIGNED__SECTOR__ZERO.html#o14">00021</a>     UCHAR   LargeSectors[4];            <span class="comment">//</span>
<a name="l00022"></a><a class="code" href="../../d8/d1/structUNALIGNED__SECTOR__ZERO.html#o15">00022</a>         UCHAR   PhysicalDrive[1];                   <span class="comment">// 0 = removable, 80h = fixed</span>
<a name="l00023"></a><a class="code" href="../../d8/d1/structUNALIGNED__SECTOR__ZERO.html#o16">00023</a>         UCHAR   CurrentHead[1];                     <span class="comment">// not used by fs utils</span>
<a name="l00024"></a><a class="code" href="../../d8/d1/structUNALIGNED__SECTOR__ZERO.html#o17">00024</a>         UCHAR   Signature[1];                       <span class="comment">// boot signature</span>
<a name="l00025"></a><a class="code" href="../../d8/d1/structUNALIGNED__SECTOR__ZERO.html#o18">00025</a>         UCHAR   SerialNumber[4];            <span class="comment">// serial number</span>
<a name="l00026"></a><a class="code" href="../../d8/d1/structUNALIGNED__SECTOR__ZERO.html#o19">00026</a>         UCHAR   Label[11];                          <span class="comment">// volume label, aligned padded</span>
<a name="l00027"></a><a class="code" href="../../d8/d1/structUNALIGNED__SECTOR__ZERO.html#o20">00027</a>         UCHAR   SystemIdText[8];            <span class="comment">// system ID, FAT for example</span>
00028 } <a class="code" href="../../d8/d1/structUNALIGNED__SECTOR__ZERO.html">UNALIGNED_SECTOR_ZERO</a>, *<a class="code" href="../../d1/d6/fmtexp_8c.html#a8">PUNALIGNED_SECTOR_ZERO</a>;
00029 
00030 
<a name="l00031"></a><a class="code" href="../../d1/d6/fmtexp_8c.html#a1">00031</a> <span class="preprocessor">#define CSEC_FAT32MEG   65536</span>
<a name="l00032"></a><a class="code" href="../../d1/d6/fmtexp_8c.html#a2">00032</a> <span class="preprocessor"></span><span class="preprocessor">#define CSEC_FAT16BIT   32680</span>
<a name="l00033"></a><a class="code" href="../../d1/d6/fmtexp_8c.html#a3">00033</a> <span class="preprocessor"></span><span class="preprocessor">#define SYSID_FAT12BIT  1</span>
<a name="l00034"></a><a class="code" href="../../d1/d6/fmtexp_8c.html#a4">00034</a> <span class="preprocessor"></span><span class="preprocessor">#define SYSID_FAT16BIT  4</span>
<a name="l00035"></a><a class="code" href="../../d1/d6/fmtexp_8c.html#a5">00035</a> <span class="preprocessor"></span><span class="preprocessor">#define SYSID_FAT32MEG  6</span>
<a name="l00036"></a><a class="code" href="../../d1/d6/fmtexp_8c.html#a6">00036</a> <span class="preprocessor"></span><span class="preprocessor">#define MIN_CLUS_BIG    4085    // Minimum clusters for a big FAT.</span>
<a name="l00037"></a><a class="code" href="../../d1/d6/fmtexp_8c.html#a7">00037</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_CLUS_BIG    65525   // Maximum + 1 clusters for big FAT.</span>
00038 <span class="preprocessor"></span>
00039 
00040 
00041 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l00042"></a><a class="code" href="../../d1/d6/fmtexp_8c.html#a9">00042</a> <a class="code" href="../../d1/d6/fmtexp_8c.html#a9">FmtIsFatPartition</a>(
00043     IN  ULONG       PartitionId,
00044     IN  ULONG       SectorSize,
00045     OUT PBOOLEAN    IsFatPartition
00046     )
00047 <span class="comment">/*++</span>
00048 <span class="comment"></span>
00049 <span class="comment">Routine Description:</span>
00050 <span class="comment"></span>
00051 <span class="comment">    This routine computes whether or not the given partition is a FAT</span>
00052 <span class="comment">    partition.</span>
00053 <span class="comment"></span>
00054 <span class="comment">Arguments:</span>
00055 <span class="comment"></span>
00056 <span class="comment">    VolumeId        - Supplies the volume to check.</span>
00057 <span class="comment">    SectorSize      - Supplies the number of bytes per sector.</span>
00058 <span class="comment">    IsFatPartition  - Returns whether or not the partition is FAT.</span>
00059 <span class="comment"></span>
00060 <span class="comment">Return Value:</span>
00061 <span class="comment"></span>
00062 <span class="comment">    LowReadSectors, ENOMEM, ESUCCESS</span>
00063 <span class="comment"></span>
00064 <span class="comment">--*/</span>
00065 {
00066     PUCHAR      <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00067     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>  r;
00068 
00069     <span class="keywordflow">if</span> (!(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d4/d9/arcinst_8h.html#a20">AllocateMemory</a>(<a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>*2))) {
00070         <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>;
00071     }
00072 
00073     r = <a class="code" href="../../d1/d6/low_8c.html#a13">LowReadSectors</a>(PartitionId, <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>, 0, 2, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00074 
00075     <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00076         <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00077         <span class="keywordflow">return</span> r;
00078     }
00079 
00080     *IsFatPartition = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[510] == 0x55 &amp;&amp;
00081                       <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[511] == 0xAA &amp;&amp;
00082                       <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[0x10] != 0 &amp;&amp;
00083                       <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[0x15] == <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[<a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>] &amp;&amp;
00084                       <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[<a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a> + 1] == 0xFF &amp;&amp;
00085                       <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[<a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a> + 2] == 0xFF;
00086 
00087     <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00088     <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>;
00089 }
00090 
00091 
00092 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l00093"></a><a class="code" href="../../d1/d6/fmtexp_8c.html#a10">00093</a> <a class="code" href="../../d1/d6/fmtexp_8c.html#a10">FmtIsFat</a>(
00094     IN  PCHAR       PartitionPath,
00095     OUT PBOOLEAN    IsFatPartition
00096     )
00097 <span class="comment">/*++</span>
00098 <span class="comment"></span>
00099 <span class="comment">Routine Description:</span>
00100 <span class="comment"></span>
00101 <span class="comment">    This routine computes whether or not the given partition is a FAT</span>
00102 <span class="comment">    partition.</span>
00103 <span class="comment"></span>
00104 <span class="comment">Arguments:</span>
00105 <span class="comment"></span>
00106 <span class="comment">    PartitionPath   - Supplies a path to the partition.</span>
00107 <span class="comment">    IsFatPartition  - Returns whether or not the partition is FAT.</span>
00108 <span class="comment"></span>
00109 <span class="comment">Return Value:</span>
00110 <span class="comment"></span>
00111 <span class="comment">    ArcOpen, ArcClose, LowGetPartitionGeometry, FmtIsFatPartition</span>
00112 <span class="comment"></span>
00113 <span class="comment">--*/</span>
00114 {
00115     ULONG       partition_id;
00116     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>  r;
00117     ULONG       total_sectors, sector_size, sec_per_track, heads;
00118 
00119     r = <a class="code" href="../../d1/d6/low_8c.html#a12">LowGetPartitionGeometry</a>(PartitionPath, &amp;total_sectors, &amp;sector_size,
00120                                 &amp;sec_per_track, &amp;heads);
00121 
00122     <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00123         <span class="keywordflow">return</span> r;
00124     }
00125 
00126     r = <a class="code" href="../../d1/d9/arc_8h.html#a32">ArcOpen</a>(PartitionPath, <a class="code" href="../../d1/d9/arc_8h.html#a317a238">ArcOpenReadOnly</a>, &amp;partition_id);
00127 
00128     <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00129         <span class="keywordflow">return</span> r;
00130     }
00131 
00132     r = <a class="code" href="../../d1/d6/fmtexp_8c.html#a9">FmtIsFatPartition</a>(partition_id, sector_size, IsFatPartition);
00133 
00134     <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00135         <a class="code" href="../../d1/d9/arc_8h.html#a29">ArcClose</a>(partition_id);
00136         <span class="keywordflow">return</span> r;
00137     }
00138 
00139     <span class="keywordflow">return</span> <a class="code" href="../../d1/d9/arc_8h.html#a29">ArcClose</a>(partition_id);
00140 }
00141 
00142 
00143 
00144 
00145 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>
<a name="l00146"></a><a class="code" href="../../d1/d6/fmtexp_8c.html#a11">00146</a> <a class="code" href="../../d1/d6/fmtexp_8c.html#a11">ComputeSecPerCluster</a>(
00147     IN  ULONG   NumSectors,
00148     IN  BOOLEAN SmallFat
00149     )
00150 <span class="comment">/*++</span>
00151 <span class="comment"></span>
00152 <span class="comment">Routine Description:</span>
00153 <span class="comment"></span>
00154 <span class="comment">    This routine computes the number of sectors per cluster.</span>
00155 <span class="comment"></span>
00156 <span class="comment">Arguments:</span>
00157 <span class="comment"></span>
00158 <span class="comment">    NumSectors  - Supplies the number of sectors on the disk.</span>
00159 <span class="comment">    SmallFat    - Supplies whether or not the FAT should be small.</span>
00160 <span class="comment"></span>
00161 <span class="comment">Return Value:</span>
00162 <span class="comment"></span>
00163 <span class="comment">    The number of sectors per cluster necessary.</span>
00164 <span class="comment"></span>
00165 <span class="comment">--*/</span>
00166 {
00167     ULONG   threshold;
00168     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>  sec_per_clus;
00169     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>  min_sec_per_clus;
00170 
00171     threshold = SmallFat ? <a class="code" href="../../d1/d6/fmtexp_8c.html#a6">MIN_CLUS_BIG</a> : <a class="code" href="../../d1/d6/fmtexp_8c.html#a7">MAX_CLUS_BIG</a>;
00172     sec_per_clus = 1;
00173 
00174     <span class="keywordflow">while</span> (NumSectors &gt;= threshold) {
00175         sec_per_clus *= 2;
00176         threshold *= 2;
00177     }
00178 
00179     <span class="keywordflow">if</span> (SmallFat) {
00180         min_sec_per_clus = 8;
00181     } <span class="keywordflow">else</span> {
00182         min_sec_per_clus = 4;
00183     }
00184 
00185     <span class="keywordflow">return</span> <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(sec_per_clus, min_sec_per_clus);
00186 }
00187 
00188 
00189 ULONG
<a name="l00190"></a><a class="code" href="../../d1/d6/fmtexp_8c.html#a12">00190</a> <a class="code" href="../../d1/d6/fmtexp_8c.html#a12">ComputeNewSerialNumber</a>(
00191     IN  ULONG   Seed
00192     )
00193 <span class="comment">/*++</span>
00194 <span class="comment"></span>
00195 <span class="comment">Routine Description:</span>
00196 <span class="comment"></span>
00197 <span class="comment">    This routine computes a new serial number for a volume.</span>
00198 <span class="comment"></span>
00199 <span class="comment">Arguments:</span>
00200 <span class="comment"></span>
00201 <span class="comment">    Seed    - Supplies a seed for the serial number.</span>
00202 <span class="comment"></span>
00203 <span class="comment">Return Value:</span>
00204 <span class="comment"></span>
00205 <span class="comment">    A new volume serial number.</span>
00206 <span class="comment"></span>
00207 <span class="comment">--*/</span>
00208 {
00209     PUCHAR  p;
00210     ULONG   i;
00211 
00212     p = (PUCHAR) &amp;<a class="code" href="../../d4/d4/tprefix_8c.html#a2">Seed</a>;
00213 
00214     <span class="keywordflow">for</span> (i = 0; i &lt; <span class="keyword">sizeof</span>(ULONG); i++) {
00215 
00216         <a class="code" href="../../d4/d4/tprefix_8c.html#a2">Seed</a> += p[i];
00217         <a class="code" href="../../d4/d4/tprefix_8c.html#a2">Seed</a> = (<a class="code" href="../../d4/d4/tprefix_8c.html#a2">Seed</a> &gt;&gt; 2) + (<a class="code" href="../../d4/d4/tprefix_8c.html#a2">Seed</a> &lt;&lt; 30);
00218     }
00219 
00220     <span class="keywordflow">return</span> <a class="code" href="../../d4/d4/tprefix_8c.html#a2">Seed</a>;
00221 }
00222 
00223 
00224 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00225"></a><a class="code" href="../../d1/d6/fmtexp_8c.html#a13">00225</a> <a class="code" href="../../d1/d6/fmtexp_8c.html#a13">EditFat</a>(
00226     IN      USHORT  ClusterNumber,
00227     IN      USHORT  ClusterEntry,
00228     IN OUT  PUCHAR  Fat,
00229     IN      BOOLEAN SmallFat
00230     )
00231 <span class="comment">/*++</span>
00232 <span class="comment"></span>
00233 <span class="comment">Routine Description:</span>
00234 <span class="comment"></span>
00235 <span class="comment">    This routine edits the FAT entry 'ClusterNumber' with 'ClusterEntry'.</span>
00236 <span class="comment"></span>
00237 <span class="comment">Arguments:</span>
00238 <span class="comment"></span>
00239 <span class="comment">    ClusterNumber   - Supplies the number of the cluster to edit.</span>
00240 <span class="comment">    ClusterEntry    - Supplies the new value for that cluster number.</span>
00241 <span class="comment">    Fat             - Supplies the FAT to edit.</span>
00242 <span class="comment">    SmallFat        - Supplies whether or not the FAT is small.</span>
00243 <span class="comment"></span>
00244 <span class="comment">Return Value:</span>
00245 <span class="comment"></span>
00246 <span class="comment">    None.</span>
00247 <span class="comment"></span>
00248 <span class="comment">--*/</span>
00249 {
00250     ULONG   <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
00251 
00252     <span class="keywordflow">if</span> (SmallFat) {
00253 
00254         <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = ClusterNumber*3;
00255         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>%2) {
00256                 Fat[<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>/2] = (UCHAR) ((Fat[<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>/2]&amp;0x0F) | ((ClusterEntry&amp;0x000F)&lt;&lt;4));
00257             Fat[<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>/2 + 1] = (UCHAR) ((ClusterEntry&amp;0x0FF0)&gt;&gt;4);
00258         } <span class="keywordflow">else</span> {
00259             Fat[<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>/2] = (UCHAR) (ClusterEntry&amp;0x00FF);
00260                 Fat[<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>/2 + 1] = (UCHAR) ((Fat[<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>/2 + 1]&amp;0xF0) |
00261                                     ((ClusterEntry&amp;0x0F00)&gt;&gt;8));
00262         }
00263 
00264     } <span class="keywordflow">else</span> {
00265 
00266         ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>) Fat)[ClusterNumber] = ClusterEntry;
00267 
00268     }
00269 }
00270 
00271 
00272 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l00273"></a><a class="code" href="../../d1/d6/fmtexp_8c.html#a14">00273</a> <a class="code" href="../../d1/d6/fmtexp_8c.html#a14">FmtFillFormatBuffer</a>(
00274     IN  ULONG   NumberOfSectors,
00275     IN  ULONG   SectorSize,
00276     IN  ULONG   SectorsPerTrack,
00277     IN  ULONG   NumberOfHeads,
00278     IN  ULONG   NumberOfHiddenSectors,
00279     OUT PVOID   FormatBuffer,
00280     IN  ULONG   FormatBufferSize,
00281     OUT PULONG  SuperAreaSize,
00282     IN  ULONG   TimeSeed,
00283     IN  PULONG  BadSectorsList,
00284     IN  ULONG   NumberOfBadSectors
00285     )
00286 <span class="comment">/*++</span>
00287 <span class="comment"></span>
00288 <span class="comment">Routine Description:</span>
00289 <span class="comment"></span>
00290 <span class="comment">    This routine computes a FAT super area based on the disk size,</span>
00291 <span class="comment">    disk geometry, and bad sectors of the volume.</span>
00292 <span class="comment"></span>
00293 <span class="comment">Arguments:</span>
00294 <span class="comment"></span>
00295 <span class="comment">    NumberOfSectors         - Supplies the number of sectors on the volume.</span>
00296 <span class="comment">    SectorSize              - Supplies the number of bytes per sector.</span>
00297 <span class="comment">    SectorsPerTrack         - Supplies the number of sectors per track.</span>
00298 <span class="comment">    NumberOfHeads           - Supplies the number of heads.</span>
00299 <span class="comment">    NumberOfHiddenSectors   - Supplies the number of hidden sectors.</span>
00300 <span class="comment">    FormatBuffer            - Returns the super area for the volume.</span>
00301 <span class="comment">    FormatBufferSize        - Supplies the number of bytes in the supplied</span>
00302 <span class="comment">                                buffer.</span>
00303 <span class="comment">    SuperAreaSize           - Returns the number of bytes in the super area.</span>
00304 <span class="comment">    TimeSeed                - Supplies a time seed for serial number.</span>
00305 <span class="comment">    BadSectorsList          - Supplies the list of bad sectors on the volume.</span>
00306 <span class="comment">    NumberOfBadSectors      - Supplies the number of bad sectors in the list.</span>
00307 <span class="comment"></span>
00308 <span class="comment">Return Value:</span>
00309 <span class="comment"></span>
00310 <span class="comment">    ENOMEM  - The buffer wasn't big enough.</span>
00311 <span class="comment">    E2BIG   - The disk is too large to be formatted.</span>
00312 <span class="comment">    EIO     - There is a bad sector in the super area.</span>
00313 <span class="comment">    EINVAL  - There is a bad sector off the end of the disk.</span>
00314 <span class="comment">    ESUCCESS</span>
00315 <span class="comment"></span>
00316 <span class="comment">--*/</span>
00317 {
00318     <a class="code" href="../../d1/d6/fmtexp_8c.html#a8">PUNALIGNED_SECTOR_ZERO</a>  psecz;
00319     PUCHAR                  puchar;
00320     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>                  tmp_ushort;
00321     ULONG                   tmp_ulong;
00322     BOOLEAN                 small_fat;
00323     ULONG                   num_sectors;
00324     ULONG                   partition_id;
00325     ULONG                   sec_per_fat;
00326     ULONG                   sec_per_root;
00327     ULONG                   sec_per_clus;
00328     ULONG                   i;
00329     ULONG                   sec_per_sa;
00330 
00331 
00332     <span class="comment">// First memset the buffer to all zeros;</span>
00333     memset(FormatBuffer, 0, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) FormatBufferSize);
00334 
00335 
00336     <span class="comment">// Make sure that there's enough room for the BPB.</span>
00337 
00338     <span class="keywordflow">if</span> (!FormatBuffer || FormatBufferSize &lt; <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>) {
00339         <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>;
00340     }
00341 
00342     <span class="comment">// Compute the number of sectors on disk.</span>
00343     num_sectors = NumberOfSectors;
00344 
00345     <span class="comment">// Compute the partition identifier.</span>
00346     partition_id = num_sectors &lt; <a class="code" href="../../d1/d6/fmtexp_8c.html#a2">CSEC_FAT16BIT</a> ? <a class="code" href="../../d1/d6/fmtexp_8c.html#a3">SYSID_FAT12BIT</a> :
00347                    num_sectors &lt; <a class="code" href="../../d1/d6/fmtexp_8c.html#a1">CSEC_FAT32MEG</a> ? <a class="code" href="../../d1/d6/fmtexp_8c.html#a4">SYSID_FAT16BIT</a> :
00348                                                  <a class="code" href="../../d1/d6/fmtexp_8c.html#a5">SYSID_FAT32MEG</a>;
00349 
00350     <span class="comment">// Compute whether or not to have a big or small FAT.</span>
00351     small_fat = (BOOLEAN) (partition_id == <a class="code" href="../../d1/d6/fmtexp_8c.html#a3">SYSID_FAT12BIT</a>);
00352 
00353 
00354     psecz = (<a class="code" href="../../d1/d6/fmtexp_8c.html#a8">PUNALIGNED_SECTOR_ZERO</a>) FormatBuffer;
00355     puchar = (PUCHAR) FormatBuffer;
00356 
00357     <span class="comment">// Set up the jump instruction.</span>
00358     psecz-&gt;IntelNearJumpCommand[0] = 0xEB;
00359     tmp_ushort = 0x903C;
00360     memcpy(psecz-&gt;BootStrapJumpOffset, &amp;tmp_ushort, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>));
00361 
00362     <span class="comment">// Set up the OEM data.</span>
00363     memcpy(psecz-&gt;OemData, <span class="stringliteral">"WINNT1.0"</span>, 8); <span class="comment">// BUGBUG norbertk</span>
00364 
00365     <span class="comment">// Set up the bytes per sector.</span>
00366     tmp_ushort = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>;
00367     memcpy(psecz-&gt;BytesPerSector, &amp;tmp_ushort, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>));
00368 
00369     <span class="comment">// Set up the number of sectors per cluster.</span>
00370     sec_per_clus = <a class="code" href="../../d1/d6/fmtexp_8c.html#a11">ComputeSecPerCluster</a>(num_sectors, small_fat);
00371     <span class="keywordflow">if</span> (sec_per_clus &gt; 128) {
00372 
00373         <span class="comment">// The disk is too large to be formatted.</span>
00374         <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a2">E2BIG</a>;
00375     }
00376     psecz-&gt;SectorsPerCluster[0] = (UCHAR) sec_per_clus;
00377 
00378     <span class="comment">// Set up the number of reserved sectors.</span>
00379     tmp_ushort = 1;
00380     memcpy(psecz-&gt;ReservedSectors, &amp;tmp_ushort, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>));
00381 
00382     <span class="comment">// Set up the number of FATs.</span>
00383     psecz-&gt;Fats[0] = 2;
00384 
00385     <span class="comment">// Set up the number of root entries and number of sectors for the root.</span>
00386     tmp_ushort = 512;
00387     memcpy(psecz-&gt;RootEntries, &amp;tmp_ushort, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>));
00388     sec_per_root = (512*32 - 1)/<a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a> + 1;
00389 
00390     <span class="comment">// Set up the number of sectors.</span>
00391     <span class="keywordflow">if</span> (num_sectors &gt;= 1&lt;&lt;16) {
00392         tmp_ushort = 0;
00393         tmp_ulong = num_sectors;
00394     } <span class="keywordflow">else</span> {
00395         tmp_ushort = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) num_sectors;
00396         tmp_ulong = 0;
00397     }
00398     memcpy(psecz-&gt;Sectors, &amp;tmp_ushort, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>));
00399     memcpy(psecz-&gt;LargeSectors, &amp;tmp_ulong, <span class="keyword">sizeof</span>(ULONG));
00400 
00401     <span class="comment">// Set up the media byte.</span>
00402     psecz-&gt;Media[0] = 0xF8;
00403 
00404     <span class="comment">// Set up the number of sectors per FAT.</span>
00405     <span class="keywordflow">if</span> (small_fat) {
00406         sec_per_fat = num_sectors/(2 + <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>*sec_per_clus*2/3);
00407     } <span class="keywordflow">else</span> {
00408         sec_per_fat = num_sectors/(2 + <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>*sec_per_clus/2);
00409     }
00410     sec_per_fat++;
00411     tmp_ushort = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) sec_per_fat;
00412     memcpy(psecz-&gt;SectorsPerFat, &amp;tmp_ushort, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>));
00413 
00414     <span class="comment">// Set up the number of sectors per track.</span>
00415     tmp_ushort = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) SectorsPerTrack;
00416     memcpy(psecz-&gt;SectorsPerTrack, &amp;tmp_ushort, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>));
00417 
00418     <span class="comment">// Set up the number of heads.</span>
00419     tmp_ushort = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) NumberOfHeads;
00420     memcpy(psecz-&gt;Heads, &amp;tmp_ushort, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>));
00421 
00422     <span class="comment">// Set up the number of hidden sectors.</span>
00423     memcpy(psecz-&gt;HiddenSectors, &amp;NumberOfHiddenSectors, <span class="keyword">sizeof</span>(ULONG));
00424 
00425     <span class="comment">// Set up the physical drive number.</span>
00426     psecz-&gt;PhysicalDrive[0] = 0x80;
00427 
00428     <span class="comment">// Set up the BPB signature.</span>
00429     psecz-&gt;Signature[0] = 0x29;
00430 
00431     <span class="comment">// Set up the serial number.</span>
00432     tmp_ulong = <a class="code" href="../../d1/d6/fmtexp_8c.html#a12">ComputeNewSerialNumber</a>(TimeSeed);
00433     memcpy(psecz-&gt;SerialNumber, &amp;tmp_ulong, <span class="keyword">sizeof</span>(ULONG));
00434 
00435     <span class="comment">// Set up the system id.</span>
00436     memcpy(psecz-&gt;SystemIdText, <span class="stringliteral">"FAT     "</span>, 8);
00437 
00438     <span class="comment">// Set up the boot signature.</span>
00439     puchar[510] = 0x55;
00440     puchar[511] = 0xAA;
00441 
00442 
00443     <span class="comment">// Now make sure that the buffer has enough room for both of the</span>
00444     <span class="comment">// FATs and the root directory.</span>
00445 
00446     sec_per_sa = 1 + 2*sec_per_fat + sec_per_root;
00447     *SuperAreaSize = <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>*sec_per_sa;
00448     <span class="keywordflow">if</span> (*SuperAreaSize &gt; FormatBufferSize) {
00449         <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>;
00450     }
00451 
00452 
00453     <span class="comment">// Set up the first FAT.</span>
00454 
00455     puchar[<a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>] = 0xF8;
00456     puchar[<a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a> + 1] = 0xFF;
00457     puchar[<a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a> + 2] = 0xFF;
00458 
00459     <span class="keywordflow">if</span> (!small_fat) {
00460         puchar[<a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a> + 3] = 0xFF;
00461     }
00462 
00463 
00464     <span class="keywordflow">for</span> (i = 0; i &lt; NumberOfBadSectors; i++) {
00465 
00466         <span class="keywordflow">if</span> (BadSectorsList[i] &lt; sec_per_sa) {
00467             <span class="comment">// There's a bad sector in the super area.</span>
00468             <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a9">EIO</a>;
00469         }
00470 
00471         <span class="keywordflow">if</span> (BadSectorsList[i] &gt;= num_sectors) {
00472             <span class="comment">// Bad sector out of range.</span>
00473             <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a8">EINVAL</a>;
00474         }
00475 
00476         <span class="comment">// Compute the bad cluster number;</span>
00477         tmp_ushort = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)
00478                      ((BadSectorsList[i] - sec_per_sa)/sec_per_clus + 2);
00479 
00480         <a class="code" href="../../d1/d6/fmtexp_8c.html#a13">EditFat</a>(tmp_ushort, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) 0xFFF7, &amp;puchar[<a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>], small_fat);
00481     }
00482 
00483 
00484     <span class="comment">// Copy the first FAT onto the second.</span>
00485 
00486     memcpy(&amp;puchar[<a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>*(1 + sec_per_fat)],
00487            &amp;puchar[<a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>],
00488            (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>*sec_per_fat);
00489 
00490     <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>;
00491 }
00492 
00493 
00494 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l00495"></a><a class="code" href="../../d1/d6/fmtexp_8c.html#a15">00495</a> <a class="code" href="../../d1/d6/fmtexp_8c.html#a15">FmtVerifySectors</a>(
00496     IN  ULONG       PartitionId,
00497     IN  ULONG       NumberOfSectors,
00498     IN  ULONG       SectorSize,
00499     OUT PULONG*     BadSectorsList,
00500     OUT PULONG      NumberOfBadSectors
00501     )
00502 <span class="comment">/*++</span>
00503 <span class="comment"></span>
00504 <span class="comment">Routine Description:</span>
00505 <span class="comment"></span>
00506 <span class="comment">    This routine verifies all of the sectors on the volume.</span>
00507 <span class="comment">    It returns a pointer to a list of bad sectors.  The pointer</span>
00508 <span class="comment">    will be NULL if there was an error detected.</span>
00509 <span class="comment"></span>
00510 <span class="comment">Arguments:</span>
00511 <span class="comment"></span>
00512 <span class="comment">    PartitionId         - Supplies a handle to the partition for reading.</span>
00513 <span class="comment">    NumberOfSectors     - Supplies the number of partition sectors.</span>
00514 <span class="comment">    SectorSize          - Supplies the number of bytes per sector.</span>
00515 <span class="comment">    BadSectorsList      - Returns the list of bad sectors.</span>
00516 <span class="comment">    NumberOfBadSectors  - Returns the number of bad sectors in the list.</span>
00517 <span class="comment"></span>
00518 <span class="comment">Return Value:</span>
00519 <span class="comment"></span>
00520 <span class="comment">    ENOMEM, ESUCCESS</span>
00521 <span class="comment"></span>
00522 <span class="comment">--*/</span>
00523 {
00524     ULONG           num_read_sec;
00525     PVOID           read_buffer;
00526     ULONG           i, j;
00527     PULONG          bad_sec_buf;
00528     ULONG           max_num_bad;
00529     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>      r;
00530     ULONG           percent;
00531 
00532     <span class="keywordflow">if</span> (!(read_buffer = <a class="code" href="../../d4/d9/arcinst_8h.html#a20">AllocateMemory</a>(<a class="code" href="../../d1/d6/fmtexp_8c.html#a0">READ_SIZE</a>))) {
00533         <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>;
00534     }
00535 
00536     max_num_bad = 100;
00537     <span class="keywordflow">if</span> (!(bad_sec_buf = (PULONG) <a class="code" href="../../d4/d9/arcinst_8h.html#a20">AllocateMemory</a>(max_num_bad*<span class="keyword">sizeof</span>(ULONG)))) {
00538         <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(read_buffer);
00539         <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>;
00540     }
00541 
00542     *NumberOfBadSectors = 0;
00543 
00544     num_read_sec = <a class="code" href="../../d1/d6/fmtexp_8c.html#a0">READ_SIZE</a>/<a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>;
00545 
00546 
00547     percent = 1;
00548     <span class="keywordflow">for</span> (i = 0; i &lt; NumberOfSectors; i += num_read_sec) {
00549 
00550         <span class="keywordflow">if</span> (percent != i*100/NumberOfSectors) {
00551             percent = i*100/NumberOfSectors;
00552             <a class="code" href="../../d4/d9/arcinst_8h.html#a114">AlPrint</a>(<span class="stringliteral">"%s%d percent formatted.\r"</span>, <a class="code" href="../../d9/d6/almisc_8c.html#a7">MSGMARGIN</a>, percent);
00553         }
00554 
00555         <span class="keywordflow">if</span> (i + num_read_sec &gt; NumberOfSectors) {
00556             num_read_sec = NumberOfSectors - i;
00557         }
00558 
00559         r = <a class="code" href="../../d1/d6/low_8c.html#a13">LowReadSectors</a>(PartitionId, <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>, i,
00560                            num_read_sec, read_buffer);
00561 
00562         <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00563 
00564             <span class="keywordflow">for</span> (j = 0; j &lt; num_read_sec; j++) {
00565 
00566                 r = <a class="code" href="../../d1/d6/low_8c.html#a13">LowReadSectors</a>(PartitionId, <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>, i+j, 1,
00567                                    read_buffer);
00568 
00569                 <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00570 
00571                     <span class="keywordflow">if</span> (*NumberOfBadSectors == max_num_bad) {
00572 
00573                         max_num_bad += 100;
00574                         <span class="keywordflow">if</span> (!(bad_sec_buf = (PULONG)
00575                               <a class="code" href="../../d4/d9/arcinst_8h.html#a21">ReallocateMemory</a>(bad_sec_buf,
00576                                                max_num_bad*<span class="keyword">sizeof</span>(ULONG)))) {
00577 
00578                             <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(read_buffer);
00579                             <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(bad_sec_buf);
00580                             <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>;
00581                         }
00582                     }
00583 
00584                     bad_sec_buf[(*NumberOfBadSectors)++] = i + j;
00585                 }
00586             }
00587         }
00588     }
00589 
00590     <a class="code" href="../../d4/d9/arcinst_8h.html#a114">AlPrint</a>(<span class="stringliteral">"%s100 percent formatted.\r\n"</span>,<a class="code" href="../../d9/d6/almisc_8c.html#a7">MSGMARGIN</a>);
00591 
00592     *BadSectorsList = bad_sec_buf;
00593 
00594     <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(read_buffer);
00595 
00596     <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>;
00597 }
00598 
00599 
00600 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l00601"></a><a class="code" href="../../d1/d6/fmtexp_8c.html#a16">00601</a> <a class="code" href="../../d1/d6/fmtexp_8c.html#a16">FmtFatFormat</a>(
00602     IN  PCHAR   PartitionPath,
00603     IN  ULONG   HiddenSectorCount
00604     )
00605 <span class="comment">/*++</span>
00606 <span class="comment"></span>
00607 <span class="comment">Routine Description:</span>
00608 <span class="comment"></span>
00609 <span class="comment">    This routine does a FAT format on the given partition.</span>
00610 <span class="comment"></span>
00611 <span class="comment">Arguments:</span>
00612 <span class="comment"></span>
00613 <span class="comment">    PartitionPath   - Supplies a path to the partition to format.</span>
00614 <span class="comment"></span>
00615 <span class="comment">Return Value:</span>
00616 <span class="comment"></span>
00617 <span class="comment">    LowGetPartitionGeometry, ArcOpen,</span>
00618 <span class="comment">    FmtVerifySectors, FmtFillFormatBuffer, LowWriteSectors,</span>
00619 <span class="comment">    ArcClose, ENOMEM</span>
00620 <span class="comment"></span>
00621 <span class="comment">--*/</span>
00622 {
00623     ULONG           num_sectors;
00624     ULONG           sector_size;
00625     ULONG           sec_per_track;
00626     ULONG           heads;
00627     ULONG           hidden_sectors;
00628     PULONG          bad_sectors;
00629     ULONG           num_bad_sectors;
00630     PVOID           format_buffer;
00631     ULONG           max_sec_per_sa;
00632     ULONG           super_area_size;
00633     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>      r;
00634     ULONG           partition_id;
00635     ULONG           time_seed;
00636     PTIME_FIELDS    ptime_fields;
00637 
00638 
00639     r = <a class="code" href="../../d1/d6/low_8c.html#a12">LowGetPartitionGeometry</a>(PartitionPath, &amp;num_sectors,
00640                                 &amp;sector_size, &amp;sec_per_track, &amp;heads);
00641 
00642     <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00643         <span class="keywordflow">return</span> r;
00644     }
00645 
00646     hidden_sectors = HiddenSectorCount;
00647 
00648     r = <a class="code" href="../../d1/d9/arc_8h.html#a32">ArcOpen</a>(PartitionPath, <a class="code" href="../../d1/d9/arc_8h.html#a317a240">ArcOpenReadWrite</a>, &amp;partition_id);
00649 
00650     <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00651         <span class="keywordflow">return</span> r;
00652     }
00653 
00654     bad_sectors = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00655 
00656     r = <a class="code" href="../../d1/d6/fmtexp_8c.html#a15">FmtVerifySectors</a>(partition_id, num_sectors, sector_size,
00657                          &amp;bad_sectors, &amp;num_bad_sectors);
00658 
00659     <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00660         <a class="code" href="../../d1/d9/arc_8h.html#a29">ArcClose</a>(partition_id);
00661         <span class="keywordflow">return</span> r;
00662     }
00663 
00664     max_sec_per_sa = 1 +
00665                      2*((2*65536 - 1)/sector_size + 1) +
00666                      ((512*32 - 1)/sector_size + 1);
00667 
00668     ptime_fields = <a class="code" href="../../d1/d9/arc_8h.html#a27">ArcGetTime</a>();
00669 
00670     time_seed = (ptime_fields-&gt;Year - 1970)*366*24*60*60 +
00671                 (ptime_fields-&gt;Month)*31*24*60*60 +
00672                 (ptime_fields-&gt;Day)*24*60*60 +
00673                 (ptime_fields-&gt;Hour)*60*60 +
00674                 (ptime_fields-&gt;Minute)*60 +
00675                 (ptime_fields-&gt;Second);
00676 
00677     <span class="keywordflow">if</span> (!(format_buffer = <a class="code" href="../../d4/d9/arcinst_8h.html#a20">AllocateMemory</a>(max_sec_per_sa*sector_size))) {
00678 
00679         <span class="keywordflow">if</span> (bad_sectors) {
00680             <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(bad_sectors);
00681         }
00682         <a class="code" href="../../d1/d9/arc_8h.html#a29">ArcClose</a>(partition_id);
00683         <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>;
00684     }
00685 
00686     r = <a class="code" href="../../d1/d6/fmtexp_8c.html#a14">FmtFillFormatBuffer</a>(num_sectors,
00687                             sector_size,
00688                             sec_per_track,
00689                             heads,
00690                             hidden_sectors,
00691                             format_buffer,
00692                             max_sec_per_sa*sector_size,
00693                             &amp;super_area_size,
00694                             time_seed,
00695                             bad_sectors,
00696                             num_bad_sectors);
00697 
00698 
00699     <span class="keywordflow">if</span> (bad_sectors) {
00700         <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(bad_sectors);
00701     }
00702 
00703     <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00704         <a class="code" href="../../d1/d9/arc_8h.html#a29">ArcClose</a>(partition_id);
00705         <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(format_buffer);
00706         <span class="keywordflow">return</span> r;
00707     }
00708 
00709     r = <a class="code" href="../../d1/d6/low_8c.html#a14">LowWriteSectors</a>(partition_id, sector_size, 0,
00710                         super_area_size/sector_size, format_buffer);
00711 
00712     <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(format_buffer);
00713 
00714     <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00715         <a class="code" href="../../d1/d9/arc_8h.html#a29">ArcClose</a>(partition_id);
00716         <span class="keywordflow">return</span> r;
00717     }
00718 
00719     <span class="keywordflow">return</span> <a class="code" href="../../d1/d9/arc_8h.html#a29">ArcClose</a>(partition_id);
00720 }
00721 
00722 
00723 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l00724"></a><a class="code" href="../../d1/d6/fmtexp_8c.html#a17">00724</a> <a class="code" href="../../d1/d6/fmtexp_8c.html#a17">FmtQueryFatPartitionList</a>(
00725     OUT PCHAR** FatPartitionList,
00726     OUT PULONG  ListLength
00727     )
00728 <span class="comment">/*++</span>
00729 <span class="comment"></span>
00730 <span class="comment">Routine Description:</span>
00731 <span class="comment"></span>
00732 <span class="comment">    This routine browses the component tree for all disk peripherals</span>
00733 <span class="comment">    and the attempts to open partitions on all of them.  It add all</span>
00734 <span class="comment">    FAT partitions to the list and returns it.</span>
00735 <span class="comment"></span>
00736 <span class="comment">Arguments:</span>
00737 <span class="comment"></span>
00738 <span class="comment">    FatPartitionList    - Returns a list of FAT partitions.</span>
00739 <span class="comment">    ListLength          - Returns the length of the list.</span>
00740 <span class="comment"></span>
00741 <span class="comment">Return Value:</span>
00742 <span class="comment"></span>
00743 <span class="comment">    LowQueryPathList, ArcOpen, ArcClose, FmtIsFat, EIO, ENOMEM, ESUCCESS</span>
00744 <span class="comment"></span>
00745 <span class="comment">--*/</span>
00746 {
00747     <a class="code" href="../../d1/d9/arc_8h.html#a56">CONFIGURATION_TYPE</a>          config_type;
00748     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>                  r;
00749     PCHAR*                      peripheral_list;
00750     ULONG                       peripheral_list_length;
00751     ULONG                       i, j;
00752     ULONG                       num_partitions;
00753     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>                        partition_buf[21];
00754     ULONG                       partition_id;
00755     PCHAR*                      fat_partition_list;
00756     ULONG                       fat_partition_list_length;
00757     BOOLEAN                     is_fat;
00758     PCHAR                       partition_name;
00759 
00760 
00761     <span class="comment">// First get a list of the all of the disk peripheral paths.</span>
00762 
00763     config_type = <a class="code" href="../../d1/d9/arc_8h.html#a315a212">DiskPeripheral</a>;
00764     r = <a class="code" href="../../d1/d6/low_8c.html#a19">LowQueryPathList</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;config_type, &amp;peripheral_list,
00765                          &amp;peripheral_list_length);
00766 
00767     <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00768         <span class="keywordflow">return</span> r;
00769     }
00770 
00771     <span class="comment">// Now we have a list of disk peripheral paths.</span>
00772 
00773 
00774 
00775     <span class="comment">// Next, count how many partitions there are.</span>
00776 
00777     num_partitions = 0;
00778     <span class="keywordflow">for</span> (i = 0; i &lt; peripheral_list_length; i++) {
00779 
00780         partition_name = <a class="code" href="../../d4/d9/arcinst_8h.html#a20">AllocateMemory</a>(<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(peripheral_list[i]) + 21);
00781 
00782         <span class="keywordflow">if</span> (!partition_name) {
00783             <a class="code" href="../../d1/d6/low_8c.html#a20">LowFreePathList</a>(peripheral_list, peripheral_list_length);
00784             <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>;
00785         }
00786 
00787         <span class="keywordflow">for</span> (j = 1; ; j++) {
00788 
00789             strcpy(partition_name, peripheral_list[i]);
00790             <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(partition_buf, <span class="stringliteral">"partition(%d)"</span>, j);
00791             strcat(partition_name, partition_buf);
00792 
00793             r = <a class="code" href="../../d1/d9/arc_8h.html#a32">ArcOpen</a>(partition_name, <a class="code" href="../../d1/d9/arc_8h.html#a317a238">ArcOpenReadOnly</a>, &amp;partition_id);
00794 
00795             <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00796                 <span class="keywordflow">break</span>;
00797             }
00798 
00799             num_partitions++;
00800 
00801             r = <a class="code" href="../../d1/d9/arc_8h.html#a29">ArcClose</a>(partition_id);
00802 
00803             <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00804                 <a class="code" href="../../d1/d6/low_8c.html#a20">LowFreePathList</a>(peripheral_list, peripheral_list_length);
00805                 <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(partition_name);
00806                 <span class="keywordflow">return</span> r;
00807             }
00808         }
00809 
00810         <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(partition_name);
00811     }
00812 
00813     <span class="comment">// 'num_partitions' indicates the number of partitions on the disk.</span>
00814 
00815 
00816     <span class="comment">// Allocate a buffer for the FAT partitions list.  There can be</span>
00817     <span class="comment">// no more FAT partitions then there are partitions.</span>
00818 
00819     fat_partition_list = (PCHAR*) <a class="code" href="../../d4/d9/arcinst_8h.html#a20">AllocateMemory</a>(num_partitions*<span class="keyword">sizeof</span>(PCHAR));
00820 
00821     <span class="keywordflow">if</span> (!fat_partition_list) {
00822         <a class="code" href="../../d1/d6/low_8c.html#a20">LowFreePathList</a>(peripheral_list, peripheral_list_length);
00823         <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>;
00824     }
00825 
00826     <span class="keywordflow">for</span> (i = 0; i &lt; num_partitions; i++) {
00827         fat_partition_list[i] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00828     }
00829 
00830     fat_partition_list_length = 0;
00831 
00832     <span class="comment">// 'fat_partition_list_length' indicates the number of FAT partitions.</span>
00833 
00834 
00835 
00836     <span class="comment">// Now go through all of the peripherals trying all possible</span>
00837     <span class="comment">// partitions on each.  Test these to see if they are FAT and</span>
00838     <span class="comment">// put the FAT ones in 'fat_partitions_list'.</span>
00839 
00840     <span class="keywordflow">for</span> (i = 0; i &lt; peripheral_list_length; i++) {
00841 
00842         partition_name = <a class="code" href="../../d4/d9/arcinst_8h.html#a20">AllocateMemory</a>(<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(peripheral_list[i]) + 21);
00843 
00844         <span class="keywordflow">if</span> (!partition_name) {
00845             <a class="code" href="../../d1/d6/low_8c.html#a20">LowFreePathList</a>(peripheral_list, peripheral_list_length);
00846             <a class="code" href="../../d1/d6/low_8c.html#a20">LowFreePathList</a>(fat_partition_list, fat_partition_list_length);
00847             <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>;
00848         }
00849 
00850         <span class="keywordflow">for</span> (j = 1; ; j++) {
00851 
00852             strcpy(partition_name, peripheral_list[i]);
00853             <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(partition_buf, <span class="stringliteral">"partition(%d)"</span>, j);
00854             strcat(partition_name, partition_buf);
00855 
00856             r = <a class="code" href="../../d1/d9/arc_8h.html#a32">ArcOpen</a>(partition_name, <a class="code" href="../../d1/d9/arc_8h.html#a317a238">ArcOpenReadOnly</a>, &amp;partition_id);
00857 
00858             <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00859                 <span class="keywordflow">break</span>;
00860             }
00861 
00862             r = <a class="code" href="../../d1/d9/arc_8h.html#a29">ArcClose</a>(partition_id);
00863 
00864             <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00865                 <a class="code" href="../../d1/d6/low_8c.html#a20">LowFreePathList</a>(peripheral_list, peripheral_list_length);
00866                 <a class="code" href="../../d1/d6/low_8c.html#a20">LowFreePathList</a>(fat_partition_list, fat_partition_list_length);
00867                 <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(partition_name);
00868                 <span class="keywordflow">return</span> r;
00869             }
00870 
00871             r = <a class="code" href="../../d1/d6/fmtexp_8c.html#a10">FmtIsFat</a>(partition_name, &amp;is_fat);
00872 
00873             <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00874                 <a class="code" href="../../d1/d6/low_8c.html#a20">LowFreePathList</a>(peripheral_list, peripheral_list_length);
00875                 <a class="code" href="../../d1/d6/low_8c.html#a20">LowFreePathList</a>(fat_partition_list, fat_partition_list_length);
00876                 <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(partition_name);
00877                 <span class="keywordflow">return</span> r;
00878             }
00879 
00880             <span class="keywordflow">if</span> (is_fat) {
00881 
00882                 <span class="keywordflow">if</span> (fat_partition_list_length == num_partitions) {
00883                     <span class="comment">// This can't happen.</span>
00884                     <a class="code" href="../../d1/d6/low_8c.html#a20">LowFreePathList</a>(peripheral_list, peripheral_list_length);
00885                     <a class="code" href="../../d1/d6/low_8c.html#a20">LowFreePathList</a>(fat_partition_list, fat_partition_list_length);
00886                     <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(partition_name);
00887                     <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a9">EIO</a>;
00888                 }
00889 
00890                 fat_partition_list[fat_partition_list_length] =
00891                         <a class="code" href="../../d4/d9/arcinst_8h.html#a20">AllocateMemory</a>(<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(partition_name) + 1);
00892 
00893                 <span class="keywordflow">if</span> (!fat_partition_list[fat_partition_list_length]) {
00894                     <a class="code" href="../../d1/d6/low_8c.html#a20">LowFreePathList</a>(peripheral_list, peripheral_list_length);
00895                     <a class="code" href="../../d1/d6/low_8c.html#a20">LowFreePathList</a>(fat_partition_list, fat_partition_list_length);
00896                     <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(partition_name);
00897                     <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>;
00898                 }
00899 
00900                 strcpy(fat_partition_list[fat_partition_list_length], partition_name);
00901 
00902                 fat_partition_list_length++;
00903             }
00904         }
00905 
00906         <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(partition_name);
00907     }
00908 
00909     <a class="code" href="../../d1/d6/low_8c.html#a20">LowFreePathList</a>(peripheral_list, peripheral_list_length);
00910 
00911     *FatPartitionList = fat_partition_list;
00912     *ListLength = fat_partition_list_length;
00913 
00914     <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>;
00915 }
00916 
00917 
00918 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l00919"></a><a class="code" href="../../d1/d6/fmtexp_8c.html#a18">00919</a> <a class="code" href="../../d1/d6/fmtexp_8c.html#a18">FmtFreeFatPartitionList</a>(
00920     IN OUT  PCHAR*  FatPartitionList,
00921     IN      ULONG   ListLength
00922     )
00923 <span class="comment">/*++</span>
00924 <span class="comment"></span>
00925 <span class="comment">Routine Description:</span>
00926 <span class="comment"></span>
00927 <span class="comment">    This routine frees up the heap space taken by the FAT partition</span>
00928 <span class="comment">    list.</span>
00929 <span class="comment"></span>
00930 <span class="comment">Arguments:</span>
00931 <span class="comment"></span>
00932 <span class="comment">    FatPartitionList    - Supplies the buffer to free.</span>
00933 <span class="comment">    ListLength          - Supplies the buffer length.</span>
00934 <span class="comment"></span>
00935 <span class="comment">Return Value:</span>
00936 <span class="comment"></span>
00937 <span class="comment">    LowFreePathList</span>
00938 <span class="comment"></span>
00939 <span class="comment">--*/</span>
00940 {
00941     <span class="keywordflow">return</span> <a class="code" href="../../d1/d6/low_8c.html#a20">LowFreePathList</a>(FatPartitionList, ListLength);
00942 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:02 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
