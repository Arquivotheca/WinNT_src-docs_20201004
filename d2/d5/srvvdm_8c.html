<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: srvvdm.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>srvvdm.c File Reference</h1><code>#include "<a class="el" href="../../d7/d2/w32_2ntcon_2server_2precomp_8h-source.html">precomp.h</a>"</code><br>

<p>
<a href="../../d3/d4/srvvdm_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d5/srvvdm_8c.html#a0">SrvVDMConsoleOperation</a> (IN OUT PCSR_API_MSG m, IN OUT PCSR_REPLY_STATUS ReplyStatus)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a0" doxytag="srvvdm.c::SrvVDMConsoleOperation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG SrvVDMConsoleOperation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PCSR_API_MSG&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCSR_REPLY_STATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>ReplyStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d4/srvvdm_8c-source.html#l00024">24</a> of file <a class="el" href="../../d3/d4/srvvdm_8c-source.html">srvvdm.c</a>.
<p>
References <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01627">ApiPreamble()</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00634">_CONSOLE_VDM_MSG::Bool</a>, <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">BYTE</a>, <a class="el" href="../../d4/d8/client_2wow_8c-source.html#l00593">ClientToScreen()</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00365">CM_HIDE_WINDOW</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00383">CONSOLE_CLIENTPROCESSID</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00099">CONSOLE_FULLSCREEN_NOPAINT</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00093">CONSOLE_NO_WINDOW</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00094">CONSOLE_VDM_REGISTERED</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00632">_CONSOLE_VDM_MSG::ConsoleHandle</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00180">ConsoleHeapAlloc</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00193">ConsoleHeapFree</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00199">ConsoleHeapSize</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00164">_CONSOLE_INFORMATION::Flags</a>, <a class="el" href="../../d4/d8/client_2wow_8c-source.html#l00608">GetClientRect()</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00137">_CONSOLE_INFORMATION::hWnd</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00633">_CONSOLE_VDM_MSG::iFunction</a>, <a class="el" href="../../d4/d8/client_2wow_8c-source.html#l00525">IsIconic()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">PBYTE</a>, <a class="el" href="../../d5/d5/conmsg_8h.html#a124">PCONSOLE_VDM_MSG</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00635">_CONSOLE_VDM_MSG::Point</a>, <a class="el" href="../../d1/d7/ntcftxt_8h-source.html#l00427">PostMessage()</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00636">_CONSOLE_VDM_MSG::Rect</a>, <a class="el" href="../../d4/d8/client_2wow_8c-source.html#l00670">ScreenToClient()</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00204">_CONSOLE_INFORMATION::StateBuffer</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00206">_CONSOLE_INFORMATION::StateLength</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l04103">UnlockConsole()</a>, and <a class="el" href="../../d2/d6/server_8h-source.html#l00196">_CONSOLE_INFORMATION::VDMProcessId</a>.
<p>
<pre class="fragment"><div>00028 {
00029     <a class="code" href="../../d2/d7/struct__CONSOLE__VDM__MSG.html">PCONSOLE_VDM_MSG</a> a = (<a class="code" href="../../d2/d7/struct__CONSOLE__VDM__MSG.html">PCONSOLE_VDM_MSG</a>)&amp;m-&gt;u.ApiMessageData;
00030     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00031     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
00032 
00033     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d2/d7/struct__CONSOLE__VDM__MSG.html#o0">ConsoleHandle</a>,
00034                          &amp;Console
00035                         );
00036     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00037         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00038     }
00039     <span class="keywordflow">if</span> (!(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>) ||
00040         (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o52">VDMProcessId</a> != <a class="code" href="../../d1/d7/server_8h.html#a80">CONSOLE_CLIENTPROCESSID</a>())) {
00041         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00042     } <span class="keywordflow">else</span> {
00043         <span class="keywordflow">switch</span> (a-&gt;<a class="code" href="../../d2/d7/struct__CONSOLE__VDM__MSG.html#o1">iFunction</a>) {
00044             <span class="keywordflow">case</span> VDM_HIDE_WINDOW:
00045                 <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o8">hWnd</a>,
00046                              CM_HIDE_WINDOW,
00047                              0,
00048                              0
00049                            );
00050                 <span class="keywordflow">break</span>;
00051             <span class="keywordflow">case</span> VDM_IS_ICONIC:
00052                 a-&gt;<a class="code" href="../../d2/d7/struct__CONSOLE__VDM__MSG.html#o2">Bool</a> = <a class="code" href="../../d3/d9/client_2wow_8c.html#a19">IsIconic</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o8">hWnd</a>);
00053                 <span class="keywordflow">break</span>;
00054             <span class="keywordflow">case</span> VDM_CLIENT_RECT:
00055                 <a class="code" href="../../d3/d9/client_2wow_8c.html#a24">GetClientRect</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o8">hWnd</a>,&amp;a-&gt;<a class="code" href="../../d2/d7/struct__CONSOLE__VDM__MSG.html#o4">Rect</a>);
00056                 <span class="keywordflow">break</span>;
00057             <span class="keywordflow">case</span> VDM_CLIENT_TO_SCREEN:
00058                 <a class="code" href="../../d3/d9/client_2wow_8c.html#a23">ClientToScreen</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o8">hWnd</a>,&amp;a-&gt;<a class="code" href="../../d2/d7/struct__CONSOLE__VDM__MSG.html#o3">Point</a>);
00059                 <span class="keywordflow">break</span>;
00060             <span class="keywordflow">case</span> VDM_SCREEN_TO_CLIENT:
00061                 <a class="code" href="../../d3/d9/client_2wow_8c.html#a27">ScreenToClient</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o8">hWnd</a>,&amp;a-&gt;<a class="code" href="../../d2/d7/struct__CONSOLE__VDM__MSG.html#o3">Point</a>);
00062                 <span class="keywordflow">break</span>;
00063             <span class="keywordflow">case</span> VDM_IS_HIDDEN:
00064                 a-&gt;<a class="code" href="../../d2/d7/struct__CONSOLE__VDM__MSG.html#o2">Bool</a> = ((Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a8">CONSOLE_NO_WINDOW</a>) != 0);
00065                 <span class="keywordflow">break</span>;
00066             <span class="keywordflow">case</span> VDM_FULLSCREEN_NOPAINT:
00067                 <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d2/d7/struct__CONSOLE__VDM__MSG.html#o2">Bool</a>) {
00068                     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> |= <a class="code" href="../../d1/d7/server_8h.html#a14">CONSOLE_FULLSCREEN_NOPAINT</a>;
00069                 } <span class="keywordflow">else</span> {
00070                     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a14">CONSOLE_FULLSCREEN_NOPAINT</a>;
00071                 }
00072                 <span class="keywordflow">break</span>;
00073 <span class="preprocessor">#if defined(FE_SB)</span>
00074 <span class="preprocessor"></span>            <span class="keywordflow">case</span> VDM_SET_VIDEO_MODE:
00075                 Console-&gt;fVDMVideoMode = (a-&gt;<a class="code" href="../../d2/d7/struct__CONSOLE__VDM__MSG.html#o2">Bool</a> != 0);
00076                 <span class="keywordflow">break</span>;
00077 <span class="preprocessor">#if defined(i386)</span>
00078 <span class="preprocessor"></span>            <span class="keywordflow">case</span> VDM_SAVE_RESTORE_HW_STATE:
00079                 <span class="keywordflow">if</span> (ISNECPC98(gdwMachineId)) {
00080                     <span class="comment">// This function is used by MVDM to save/restore HW state</span>
00081                     <span class="comment">// when it executes DOS-AP on Fullscreen again.</span>
00082                     <span class="comment">// It is called from MVDM\SOFTPC\HOST\SRC\NT_FULSC.C.</span>
00083                     VIDEO_HARDWARE_STATE State;
00084                     ULONG StateSize = <span class="keyword">sizeof</span>(State);
00085 
00086                     State.StateHeader = Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o58">StateBuffer</a>;
00087                     State.StateLength = Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o60">StateLength</a>;
00088 
00089 
00090                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GdiFullscreenControl(a-&gt;<a class="code" href="../../d2/d7/struct__CONSOLE__VDM__MSG.html#o2">Bool</a> ? FullscreenControlRestoreHardwareState
00091                                                           : FullscreenControlSaveHardwareState,
00092                                                   &amp;State,
00093                                                   StateSize,
00094                                                   &amp;State,
00095                                                   &amp;StateSize);
00096                 }
00097                 <span class="keywordflow">break</span>;
00098             <span class="keywordflow">case</span> VDM_VIDEO_IOCTL:
00099                 <span class="keywordflow">if</span> (ISNECPC98(gdwMachineId)) {
00100                     <span class="comment">// This function is used by MVDM to access CG.</span>
00101                     <span class="comment">// It is called from MVDM\SOFTPC\HOST\SRC\NT_CGW.C.</span>
00102                     PVOID InBuffer;
00103 
00104                     <span class="keywordflow">if</span> (!CsrValidateMessageBuffer(m, &amp;a-&gt;VDMIoctlParam.lpvInBuffer, a-&gt;VDMIoctlParam.cbInBuffer, <span class="keyword">sizeof</span>(BYTE)) ||
00105                         !CsrValidateMessageBuffer(m, &amp;a-&gt;VDMIoctlParam.lpvOutBuffer, a-&gt;VDMIoctlParam.cbOutBuffer, <span class="keyword">sizeof</span>(BYTE))) {
00106                         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00107                         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00108                     }
00109                 
00110                     InBuffer = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(
00111                                          <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TMP_DBCS_TAG ),
00112                                          a-&gt;VDMIoctlParam.cbInBuffer + <span class="keyword">sizeof</span>(DWORD)
00113                                         );
00114                     <span class="keywordflow">if</span> (InBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00115                     {
00116                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00117                         <span class="keywordflow">break</span>;
00118                     }
00119 
00120                     *((PDWORD)InBuffer) = a-&gt;VDMIoctlParam.dwIoControlCode;
00121                     RtlCopyMemory((PBYTE)InBuffer + <span class="keyword">sizeof</span>(DWORD),
00122                                   a-&gt;VDMIoctlParam.lpvInBuffer,
00123                                   a-&gt;VDMIoctlParam.cbInBuffer
00124                                  );
00125 
00126                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GdiFullscreenControl(
00127                                  FullscreenControlSpecificVideoControl,
00128                                  InBuffer,
00129                                  <a class="code" href="../../d8/d5/consrv_8h.html#a39">ConsoleHeapSize</a>(InBuffer),
00130                                  a-&gt;VDMIoctlParam.lpvOutBuffer,
00131                                  a-&gt;VDMIoctlParam.lpvOutBuffer ?
00132                                      &amp;a-&gt;VDMIoctlParam.cbOutBuffer : 0
00133                                  );
00134 
00135                     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(InBuffer);
00136                 }
00137                 <span class="keywordflow">break</span>;
00138 <span class="preprocessor">#endif</span>
00139 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00140 <span class="preprocessor"></span>            <span class="keywordflow">default</span>:
00141                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
00142         }
00143     }
00144 
00145     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00146     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00147     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
00148 }
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:40 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
