<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: low.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>low.c</h1><a href="../../d1/d6/low_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="preprocessor">#include "<a class="code" href="../../d3/d3/arcinst_2precomp_8h.html">precomp.h</a>"</span>
00002 <span class="preprocessor">#pragma hdrstop</span>
00003 <span class="preprocessor"></span><span class="preprocessor">#include &lt;bootmbr.h&gt;</span>
00004 
00005 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l00006"></a><a class="code" href="../../d1/d6/low_8c.html#a9">00006</a> <a class="code" href="../../d1/d6/low_8c.html#a9">LowOpenDisk</a>(
00007     IN  PCHAR   DevicePath,
00008     OUT PULONG  DiskId
00009     )
00010 <span class="comment">/*++</span>
00011 <span class="comment"></span>
00012 <span class="comment">Routine Description:</span>
00013 <span class="comment"></span>
00014 <span class="comment">    This routine opens the supplied device for DASD access.</span>
00015 <span class="comment"></span>
00016 <span class="comment">Arguments:</span>
00017 <span class="comment"></span>
00018 <span class="comment">    DevicePath  - Supplies the device path to be opened.</span>
00019 <span class="comment">    DiskId      - Returns the disk id.</span>
00020 <span class="comment"></span>
00021 <span class="comment">Return Value:</span>
00022 <span class="comment"></span>
00023 <span class="comment">    ArcOpen</span>
00024 <span class="comment"></span>
00025 <span class="comment">--*/</span>
00026 {
00027    <span class="keywordtype">char</span> buffer[256];
00028 
00029    <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(buffer,<span class="stringliteral">"%spartition(0)"</span>,DevicePath);
00030 
00031    <span class="keywordflow">return</span> <a class="code" href="../../d1/d9/arc_8h.html#a32">ArcOpen</a>(buffer, <a class="code" href="../../d1/d9/arc_8h.html#a317a240">ArcOpenReadWrite</a>, DiskId);
00032 }
00033 
00034 
00035 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l00036"></a><a class="code" href="../../d1/d6/low_8c.html#a10">00036</a> <a class="code" href="../../d1/d6/low_8c.html#a10">LowCloseDisk</a>(
00037     IN  ULONG    DiskId
00038     )
00039 <span class="comment">/*++</span>
00040 <span class="comment"></span>
00041 <span class="comment">Routine Description:</span>
00042 <span class="comment"></span>
00043 <span class="comment">    This routine closes the supplied device.</span>
00044 <span class="comment"></span>
00045 <span class="comment">Arguments:</span>
00046 <span class="comment"></span>
00047 <span class="comment">    DiskId      - Supplies the disk id.</span>
00048 <span class="comment"></span>
00049 <span class="comment">Return Value:</span>
00050 <span class="comment"></span>
00051 <span class="comment">    ArcClose</span>
00052 <span class="comment"></span>
00053 <span class="comment">--*/</span>
00054 {
00055     <span class="keywordflow">return</span> <a class="code" href="../../d1/d9/arc_8h.html#a29">ArcClose</a>(DiskId);
00056 }
00057 
00058 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l00059"></a><a class="code" href="../../d1/d6/low_8c.html#a11">00059</a> <a class="code" href="../../d1/d6/low_8c.html#a11">LowGetDriveGeometry</a>(
00060     IN  PCHAR   DevicePath,
00061     OUT PULONG  TotalSectorCount,
00062     OUT PULONG  SectorSize,
00063     OUT PULONG  SectorsPerTrack,
00064     OUT PULONG  Heads
00065     )
00066 {
00067     <span class="keywordtype">char</span> <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[256];
00068 
00069     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,<span class="stringliteral">"%spartition(0)"</span>,DevicePath);
00070     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d6/low_8c.html#a12">LowGetPartitionGeometry</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,TotalSectorCount,<a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>,SectorsPerTrack,Heads));
00071 }
00072 
00073 
00074 
00075 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l00076"></a><a class="code" href="../../d1/d6/low_8c.html#a12">00076</a> <a class="code" href="../../d1/d6/low_8c.html#a12">LowGetPartitionGeometry</a>(
00077     IN  PCHAR   PartitionPath,
00078     OUT PULONG  TotalSectorCount,
00079     OUT PULONG  SectorSize,
00080     OUT PULONG  SectorsPerTrack,
00081     OUT PULONG  Heads
00082     )
00083 <span class="comment">/*++</span>
00084 <span class="comment"></span>
00085 <span class="comment">Routine Description:</span>
00086 <span class="comment"></span>
00087 <span class="comment">    This routine computes the drive geometry for the given partition or</span>
00088 <span class="comment">    physical disk.</span>
00089 <span class="comment"></span>
00090 <span class="comment">Arguments:</span>
00091 <span class="comment"></span>
00092 <span class="comment">    PartitionPath   - Supplies a path to the partition or physical disk.</span>
00093 <span class="comment">    NumberOfSectors - Returns the number of sectors.</span>
00094 <span class="comment">    SectorSize      - Returns the sector size.</span>
00095 <span class="comment">    SectorsPerTrack - Returns the number of sectors per track.</span>
00096 <span class="comment">    Heads           - Returns the number of heads.</span>
00097 <span class="comment"></span>
00098 <span class="comment">Return Value:</span>
00099 <span class="comment"></span>
00100 <span class="comment">    ArcOpen, ArcGetFileInformation, ArcClose, E2BIG, ESUCCESS</span>
00101 <span class="comment"></span>
00102 <span class="comment">--*/</span>
00103 {
00104     <a class="code" href="../../d6/d1/struct__FILE__INFORMATION.html">FILE_INFORMATION</a>    file_info;
00105     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>          r;
00106     ULONG               fileid;
00107     LARGE_INTEGER       l;
00108     CM_DISK_GEOMETRY_DEVICE_DATA    *DiskGeometry;
00109     <a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html">CONFIGURATION_COMPONENT</a>         *DiskComponent;
00110     CM_PARTIAL_RESOURCE_LIST        *DiskConfiguration;
00111     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>                            DataBuffer[<span class="keyword">sizeof</span>(CM_PARTIAL_RESOURCE_LIST) +
00112                                                <span class="keyword">sizeof</span>(CM_DISK_GEOMETRY_DEVICE_DATA)];
00113     CM_PARTIAL_RESOURCE_DESCRIPTOR  *DiskData;
00114 
00115     <span class="comment">// Always assume 512 bytes per sector.</span>
00116 
00117     *<a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>      = 512;
00118 
00119     <span class="comment">// Assume the SCSI default values for number of heads and sectors per track</span>
00120 
00121     *SectorsPerTrack = 32;
00122     *Heads           = 64;
00123 
00124     <span class="comment">// See if there is device specific data describing the geometry of</span>
00125     <span class="comment">// the drive.  If there is none, then just use the default SCSI</span>
00126     <span class="comment">// values.</span>
00127 
00128     DiskComponent = <a class="code" href="../../d1/d9/arc_8h.html#a22">ArcGetComponent</a>(PartitionPath);
00129 
00130     <span class="keywordflow">if</span> (DiskComponent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00131         <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a8">EINVAL</a>;
00132     }
00133 
00134     <span class="comment">//</span>
00135     <span class="comment">// See if the ConfigurationDataLength is correct</span>
00136     <span class="comment">// It should contain one DeviceSpecific resource descriptor</span>
00137     <span class="comment">//</span>
00138 
00139     <span class="keywordflow">if</span> (DiskComponent-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o7">ConfigurationDataLength</a> == <span class="keyword">sizeof</span>(CM_PARTIAL_RESOURCE_LIST) +
00140                                                   <span class="keyword">sizeof</span>(CM_DISK_GEOMETRY_DEVICE_DATA)  ) {
00141 
00142         DiskConfiguration = (CM_PARTIAL_RESOURCE_LIST *)DataBuffer;
00143 
00144         r = <a class="code" href="../../d1/d9/arc_8h.html#a23">ArcGetConfigurationData</a>(DiskConfiguration,DiskComponent);
00145 
00146         <span class="keywordflow">if</span> (r == <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00147 
00148             <span class="comment">//</span>
00149             <span class="comment">// See if the Configuration Data has ARC version 1.3 or greater</span>
00150             <span class="comment">//</span>
00151 
00152             <span class="keywordflow">if</span>  ( (DiskConfiguration-&gt;Version == 1 &amp;&amp; DiskConfiguration-&gt;Revision &gt;=3 ) ||
00153                   (DiskConfiguration-&gt;Version &gt;  1)                                        ) {
00154 
00155                 DiskData = &amp;(DiskConfiguration-&gt;PartialDescriptors[DiskConfiguration-&gt;Count-1]);
00156 
00157                 <span class="keywordflow">if</span> (DiskData-&gt;Type == CmResourceTypeDeviceSpecific) {
00158 
00159                     <span class="keywordflow">if</span> (DiskData-&gt;u.DeviceSpecificData.DataSize == <span class="keyword">sizeof</span>(CM_DISK_GEOMETRY_DEVICE_DATA)) {
00160                         DiskGeometry     = (CM_DISK_GEOMETRY_DEVICE_DATA *)
00161                                            &amp;(DiskConfiguration-&gt;PartialDescriptors[DiskConfiguration-&gt;Count]);
00162                         *SectorsPerTrack = DiskGeometry-&gt;SectorsPerTrack;
00163                         *Heads           = DiskGeometry-&gt;NumberOfHeads;
00164                         *<a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>      = DiskGeometry-&gt;BytesPerSector;
00165                     }
00166                 }
00167             }
00168         }
00169     }
00170 
00171 <span class="comment">//    PrintError("SectorSize = %08x",*SectorSize);</span>
00172 <span class="comment">//    PrintError("SectorsPerTrack = %08x",*SectorsPerTrack);</span>
00173 <span class="comment">//    PrintError("Heads = %08x",*Heads);</span>
00174 
00175     r = <a class="code" href="../../d1/d9/arc_8h.html#a32">ArcOpen</a>(PartitionPath, <a class="code" href="../../d1/d9/arc_8h.html#a317a238">ArcOpenReadOnly</a>, &amp;fileid);
00176 
00177     <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00178         <span class="keywordflow">return</span> r;
00179     }
00180 
00181     r = <a class="code" href="../../d1/d9/arc_8h.html#a36">ArcGetFileInformation</a>(fileid, &amp;file_info);
00182 
00183     <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00184         <span class="keywordflow">return</span> r;
00185     }
00186 
00187     r = <a class="code" href="../../d1/d9/arc_8h.html#a29">ArcClose</a>(fileid);
00188 
00189     <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00190         <span class="keywordflow">return</span> r;
00191     }
00192 
00193     l.QuadPart = file_info.<a class="code" href="../../d6/d1/struct__FILE__INFORMATION.html#o1">EndingAddress</a>.QuadPart -
00194                  file_info.<a class="code" href="../../d6/d1/struct__FILE__INFORMATION.html#o0">StartingAddress</a>.QuadPart;
00195 
00196     l.QuadPart = ((ULONGLONG)l.QuadPart) / ((ULONGLONG)(*SectorSize));
00197 
00198     <span class="keywordflow">if</span> (l.HighPart) {
00199         <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a2">E2BIG</a>;
00200     }
00201 
00202     *TotalSectorCount = l.LowPart;
00203 
00204     <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>;
00205 }
00206 
00207 
<a name="l00208"></a><a class="code" href="../../d1/d6/low_8c.html#a0">00208</a> <span class="preprocessor">#define MAX_TRANSFER    65536</span>
00209 <span class="preprocessor"></span>
00210 
00211 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l00212"></a><a class="code" href="../../d1/d6/low_8c.html#a13">00212</a> <a class="code" href="../../d1/d6/low_8c.html#a13">LowReadSectors</a>(
00213     IN  ULONG   VolumeId,
00214     IN  ULONG   SectorSize,
00215     IN  ULONG   StartingSector,
00216     IN  ULONG   NumberOfSectors,
00217     OUT PVOID   Buffer
00218     )
00219 <span class="comment">/*++</span>
00220 <span class="comment"></span>
00221 <span class="comment">Routine Description:</span>
00222 <span class="comment"></span>
00223 <span class="comment">    This routine reads 'NumberOfSectors' sectors starting at sector</span>
00224 <span class="comment">    'StartingSector' on the volume with ID 'VolumeId'.</span>
00225 <span class="comment"></span>
00226 <span class="comment">Arguments:</span>
00227 <span class="comment"></span>
00228 <span class="comment">    VolumeId        - Supplies the ID for the volume.</span>
00229 <span class="comment">    SectorSize      - Supplies the number of bytes per sector.</span>
00230 <span class="comment">    StartingSector  - Supplies the starting sector for the read.</span>
00231 <span class="comment">    NumberOfSectors - Supplies the number of sectors to read.</span>
00232 <span class="comment">    Buffer          - Returns the read in sectors.</span>
00233 <span class="comment"></span>
00234 <span class="comment">Return Value:</span>
00235 <span class="comment"></span>
00236 <span class="comment">    ArcSeek, ArcRead, EIO, ESUCCESS</span>
00237 <span class="comment"></span>
00238 <span class="comment">--*/</span>
00239 {
00240     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>    r;
00241     ULONG         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
00242     LARGE_INTEGER l;
00243     ULONG         i;
00244     ULONG         transfer;
00245     PCHAR         buf;
00246     ULONG         total;
00247 
00248 
00249     l.QuadPart = UInt32x32To64(StartingSector,<a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>);
00250 
00251     buf = (PCHAR) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00252 
00253     r = <a class="code" href="../../d1/d9/arc_8h.html#a34">ArcSeek</a>(VolumeId, &amp;l, <a class="code" href="../../d1/d9/arc_8h.html#a318a248">SeekAbsolute</a>);
00254 
00255     <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00256         <span class="keywordflow">return</span> r;
00257     }
00258 
00259     total = <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>*NumberOfSectors;
00260 
00261     <span class="keywordflow">for</span> (i = 0; i &lt; total; i += <a class="code" href="../../d1/d6/low_8c.html#a0">MAX_TRANSFER</a>) {
00262 
00263         transfer = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(<a class="code" href="../../d1/d6/low_8c.html#a0">MAX_TRANSFER</a>, total - i);
00264 
00265         r = <a class="code" href="../../d1/d9/arc_8h.html#a33">ArcRead</a>(VolumeId, &amp;buf[i], transfer, &amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>);
00266 
00267         <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00268             <span class="keywordflow">return</span> r;
00269         }
00270 
00271         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> != transfer) {
00272             <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a9">EIO</a>;
00273         }
00274     }
00275 
00276     <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>;
00277 }
00278 
00279 
00280 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l00281"></a><a class="code" href="../../d1/d6/low_8c.html#a14">00281</a> <a class="code" href="../../d1/d6/low_8c.html#a14">LowWriteSectors</a>(
00282     IN  ULONG   VolumeId,
00283     IN  ULONG   SectorSize,
00284     IN  ULONG   StartingSector,
00285     IN  ULONG   NumberOfSectors,
00286     IN  PVOID   Buffer
00287     )
00288 <span class="comment">/*++</span>
00289 <span class="comment"></span>
00290 <span class="comment">Routine Description:</span>
00291 <span class="comment"></span>
00292 <span class="comment">    This routine write 'NumberOfSectors' sectors starting at sector</span>
00293 <span class="comment">    'StartingSector' on the volume with ID 'VolumeId'.</span>
00294 <span class="comment"></span>
00295 <span class="comment">Arguments:</span>
00296 <span class="comment"></span>
00297 <span class="comment">    VolumeId        - Supplies the ID for the volume.</span>
00298 <span class="comment">    SectorSize      - Supplies the number of bytes per sector.</span>
00299 <span class="comment">    StartingSector  - Supplies the starting sector for the write.</span>
00300 <span class="comment">    NumberOfSectors - Supplies the number of sectors to write.</span>
00301 <span class="comment">    Buffer          - Supplies the sectors to write.</span>
00302 <span class="comment"></span>
00303 <span class="comment">Return Value:</span>
00304 <span class="comment"></span>
00305 <span class="comment">    ArcSeek, ArcWrite, EIO, ESUCCESS</span>
00306 <span class="comment"></span>
00307 <span class="comment">--*/</span>
00308 {
00309     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>    r;
00310     ULONG         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
00311     LARGE_INTEGER l;
00312     ULONG         i;
00313     ULONG         transfer;
00314     PCHAR         buf;
00315     ULONG         total;
00316 
00317     l.QuadPart = UInt32x32To64(StartingSector,<a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>);
00318 
00319     buf = (PCHAR) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00320 
00321     r = <a class="code" href="../../d1/d9/arc_8h.html#a34">ArcSeek</a>(VolumeId, &amp;l, <a class="code" href="../../d1/d9/arc_8h.html#a318a248">SeekAbsolute</a>);
00322 
00323     <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00324         <span class="keywordflow">return</span> r;
00325     }
00326 
00327     total = <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>*NumberOfSectors;
00328 
00329     <span class="keywordflow">for</span> (i = 0; i &lt; total; i += <a class="code" href="../../d1/d6/low_8c.html#a0">MAX_TRANSFER</a>) {
00330 
00331         transfer = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(<a class="code" href="../../d1/d6/low_8c.html#a0">MAX_TRANSFER</a>, total - i);
00332 
00333         r = <a class="code" href="../../d1/d9/arc_8h.html#a35">ArcWrite</a>(VolumeId, &amp;buf[i], transfer, &amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>);
00334 
00335         <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00336             <span class="keywordflow">return</span> r;
00337         }
00338 
00339         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> != transfer) {
00340             <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a9">EIO</a>;
00341         }
00342     }
00343 
00344     <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>;
00345 }
00346 
00347 
00348 <span class="comment">/******************** DAVIDRO CODE *************************************/</span>
00349 <span class="comment">/*++</span>
00350 <span class="comment"></span>
00351 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00352 <span class="comment"></span>
00353 <span class="comment">Module Name:</span>
00354 <span class="comment"></span>
00355 <span class="comment">    alpath.c</span>
00356 <span class="comment"></span>
00357 <span class="comment">Abstract:</span>
00358 <span class="comment"></span>
00359 <span class="comment">    This module provides ARC pathname functions.</span>
00360 <span class="comment"></span>
00361 <span class="comment">Author:</span>
00362 <span class="comment"></span>
00363 <span class="comment">    David M. Robinson (davidro) 13-November-1991</span>
00364 <span class="comment"></span>
00365 <span class="comment">Revision History:</span>
00366 <span class="comment"></span>
00367 <span class="comment">--*/</span>
00368 
00369 <span class="comment">//</span>
00370 <span class="comment">// Define the ARC pathname mnemonics.</span>
00371 <span class="comment">//</span>
00372 
<a name="l00373"></a><a class="code" href="../../d1/d6/low_8c.html#a5">00373</a> PCHAR <a class="code" href="../../d1/d6/low_8c.html#a5">MnemonicTable</a>[] = {
00374     <span class="stringliteral">"arc"</span>,
00375     <span class="stringliteral">"cpu"</span>,
00376     <span class="stringliteral">"fpu"</span>,
00377     <span class="stringliteral">"pic"</span>,
00378     <span class="stringliteral">"pdc"</span>,
00379     <span class="stringliteral">"sic"</span>,
00380     <span class="stringliteral">"sdc"</span>,
00381     <span class="stringliteral">"sc"</span>,
00382     <span class="stringliteral">"eisa"</span>,
00383     <span class="stringliteral">"tc"</span>,
00384     <span class="stringliteral">"scsi"</span>,
00385     <span class="stringliteral">"dti"</span>,
00386     <span class="stringliteral">"multi"</span>,
00387     <span class="stringliteral">"disk"</span>,
00388     <span class="stringliteral">"tape"</span>,
00389     <span class="stringliteral">"cdrom"</span>,
00390     <span class="stringliteral">"worm"</span>,
00391     <span class="stringliteral">"serial"</span>,
00392     <span class="stringliteral">"net"</span>,
00393     <span class="stringliteral">"video"</span>,
00394     <span class="stringliteral">"par"</span>,
00395     <span class="stringliteral">"point"</span>,
00396     <span class="stringliteral">"key"</span>,
00397     <span class="stringliteral">"audio"</span>,
00398     <span class="stringliteral">"other"</span>,
00399     <span class="stringliteral">"rdisk"</span>,
00400     <span class="stringliteral">"fdisk"</span>,
00401     <span class="stringliteral">"tape"</span>,
00402     <span class="stringliteral">"modem"</span>,
00403     <span class="stringliteral">"monitor"</span>,
00404     <span class="stringliteral">"print"</span>,
00405     <span class="stringliteral">"pointer"</span>,
00406     <span class="stringliteral">"keyboard"</span>,
00407     <span class="stringliteral">"term"</span>,
00408     <span class="stringliteral">"other"</span>,
00409     <span class="stringliteral">"line"</span>,
00410     <span class="stringliteral">"netper"</span>,
00411     <span class="stringliteral">"memory"</span>
00412     };
00413 
00414 <span class="comment">//</span>
00415 <span class="comment">// Static storage for the pathname return value.</span>
00416 <span class="comment">//</span>
00417 
<a name="l00418"></a><a class="code" href="../../d1/d6/low_8c.html#a6">00418</a> <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> <a class="code" href="../../d1/d6/low_8c.html#a6">Pathname</a>[256];
00419 
00420 
00421 PCHAR
<a name="l00422"></a><a class="code" href="../../d1/d6/low_8c.html#a15">00422</a> <a class="code" href="../../d1/d6/low_8c.html#a15">AlGetPathnameFromComponent</a> (
00423     IN <a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html">PCONFIGURATION_COMPONENT</a> Component
00424     )
00425 
00426 <span class="comment">/*++</span>
00427 <span class="comment"></span>
00428 <span class="comment">Routine Description:</span>
00429 <span class="comment"></span>
00430 <span class="comment">    This function builds an ARC pathname for the specified component.</span>
00431 <span class="comment"></span>
00432 <span class="comment">Arguments:</span>
00433 <span class="comment"></span>
00434 <span class="comment">    Component - Supplies a pointer to a configuration component.</span>
00435 <span class="comment"></span>
00436 <span class="comment">Return Value:</span>
00437 <span class="comment"></span>
00438 <span class="comment">    Returns a pointer to a string which contains the ARC pathname for the</span>
00439 <span class="comment">    component.  NOTE: The string is stored in static storage, and must be</span>
00440 <span class="comment">    copied by the user before another call to this routine.</span>
00441 <span class="comment"></span>
00442 <span class="comment">--*/</span>
00443 {
00444     <a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html">PCONFIGURATION_COMPONENT</a> ParentComponent;
00445     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> NewSegment[16];
00446     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> Tempname[256];
00447 
00448     <a class="code" href="../../d1/d6/low_8c.html#a6">Pathname</a>[0] = 0;
00449 
00450     <span class="comment">//</span>
00451     <span class="comment">// Loop while not at the root component.</span>
00452     <span class="comment">//</span>
00453 
00454     <span class="keywordflow">while</span> ((ParentComponent = <a class="code" href="../../d1/d9/arc_8h.html#a18">ArcGetParent</a>(Component)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00455 
00456         <span class="comment">//</span>
00457         <span class="comment">// Build new pathname segment from the Component type and key.</span>
00458         <span class="comment">//</span>
00459 
00460         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(NewSegment,
00461                 <span class="stringliteral">"%s(%d)"</span>,
00462                 <a class="code" href="../../d1/d6/low_8c.html#a5">MnemonicTable</a>[Component-&gt;Type],
00463                 Component-&gt;Key);
00464 
00465         <span class="comment">//</span>
00466         <span class="comment">// Add the new segment as a prefix of the current pathname.</span>
00467         <span class="comment">//</span>
00468 
00469         strcpy(Tempname, <a class="code" href="../../d1/d6/low_8c.html#a6">Pathname</a>);
00470         strcpy(<a class="code" href="../../d1/d6/low_8c.html#a6">Pathname</a>, NewSegment);
00471         strcat(<a class="code" href="../../d1/d6/low_8c.html#a6">Pathname</a>, Tempname);
00472 
00473         <span class="comment">//</span>
00474         <span class="comment">// Move to the parent component.</span>
00475         <span class="comment">//</span>
00476 
00477         Component = ParentComponent;
00478     }
00479 
00480     <span class="keywordflow">return</span> <a class="code" href="../../d1/d6/low_8c.html#a6">Pathname</a>;
00481 }
00482 <span class="comment">/******************* END OF DAVIDRO CODE *********************************/</span>
00483 
00484 
00485 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l00486"></a><a class="code" href="../../d1/d6/low_8c.html#a16">00486</a> <a class="code" href="../../d1/d6/low_8c.html#a16">LowQueryPathFromComponent</a>(
00487     IN  <a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html">PCONFIGURATION_COMPONENT</a>    Component,
00488     OUT PCHAR*                      Path
00489     )
00490 <span class="comment">/*++</span>
00491 <span class="comment"></span>
00492 <span class="comment">Routine Description:</span>
00493 <span class="comment"></span>
00494 <span class="comment">    This routine computes a path from a component.  The resulting</span>
00495 <span class="comment">    path is allocated on the heap.</span>
00496 <span class="comment"></span>
00497 <span class="comment">Arguments:</span>
00498 <span class="comment"></span>
00499 <span class="comment">    Component   - Supplies a component.</span>
00500 <span class="comment">    Path        - Returns the path corresponding to that component.</span>
00501 <span class="comment"></span>
00502 <span class="comment">Return Value:</span>
00503 <span class="comment"></span>
00504 <span class="comment">    ENOMEM, ESUCCESS</span>
00505 <span class="comment"></span>
00506 <span class="comment">--*/</span>
00507 {
00508     PCHAR   p;
00509     PCHAR   <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>;
00510 
00511     p = <a class="code" href="../../d1/d6/low_8c.html#a15">AlGetPathnameFromComponent</a>(Component);
00512 
00513     <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> = <a class="code" href="../../d4/d9/arcinst_8h.html#a20">AllocateMemory</a>(<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(p) + 1);
00514 
00515     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>) {
00516         <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>;
00517     }
00518 
00519     strcpy(<a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>, p);
00520 
00521     *Path = <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>;
00522 
00523     <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>;
00524 }
00525 
00526 
00527 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l00528"></a><a class="code" href="../../d1/d6/low_8c.html#a17">00528</a> <a class="code" href="../../d1/d6/low_8c.html#a17">LowTraverseChildren</a>(
00529     IN      <a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html">PCONFIGURATION_COMPONENT</a>    Parent,
00530     IN      CONFIGURATION_CLASS*        ConfigClass OPTIONAL,
00531     IN      CONFIGURATION_TYPE*         ConfigType OPTIONAL,
00532     IN OUT  <a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html">PCONFIGURATION_COMPONENT</a>*   MatchingArray OPTIONAL,
00533     IN OUT  PULONG                      CurrentLength
00534     )
00535 <span class="comment">/*++</span>
00536 <span class="comment"></span>
00537 <span class="comment">Routine Description:</span>
00538 <span class="comment"></span>
00539 <span class="comment">    This routine traverses the trees whose parent is 'Parent'.</span>
00540 <span class="comment">    If the Matching array is provided then it will be filled</span>
00541 <span class="comment">    with pointers to all of the components whose type and class</span>
00542 <span class="comment">    match 'ConfigType' and 'ConfigClass'.  Also, the 'CurrentLength'</span>
00543 <span class="comment">    is incremented by the number of nodes that match.</span>
00544 <span class="comment"></span>
00545 <span class="comment">Arguments:</span>
00546 <span class="comment"></span>
00547 <span class="comment">    Parent          - Supplies the root of the tree.</span>
00548 <span class="comment">    ConfigClass     - Supplies the class to search for.</span>
00549 <span class="comment">    ConfigType      - Supplies the type to search for.</span>
00550 <span class="comment">    CurrentLength   - Supplies the current count.</span>
00551 <span class="comment"></span>
00552 <span class="comment">Return Value:</span>
00553 <span class="comment"></span>
00554 <span class="comment">    ESUCCESS</span>
00555 <span class="comment"></span>
00556 <span class="comment">--*/</span>
00557 {
00558     <a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html">PCONFIGURATION_COMPONENT</a>    pc;
00559     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>                  r;
00560 
00561     <span class="keywordflow">if</span> (!(pc = <a class="code" href="../../d1/d9/arc_8h.html#a17">ArcGetChild</a>(Parent))) {
00562         <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>;
00563     }
00564 
00565     <span class="keywordflow">for</span> (;;) {
00566 
00567         <span class="keywordflow">if</span> ((!ConfigClass || pc-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o0">Class</a> == *ConfigClass) &amp;&amp;
00568             (!ConfigType  || pc-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o1">Type</a>  == *ConfigType)) {
00569 
00570             <span class="keywordflow">if</span> (MatchingArray) {
00571 
00572                 MatchingArray[*<a class="code" href="../../d6/d0/ctaccess_8c.html#a47">CurrentLength</a>] = pc;
00573             }
00574 
00575             (*CurrentLength)++;
00576         }
00577 
00578         r = <a class="code" href="../../d1/d6/low_8c.html#a17">LowTraverseChildren</a>(pc, ConfigClass, ConfigType,
00579                                 MatchingArray, <a class="code" href="../../d6/d0/ctaccess_8c.html#a47">CurrentLength</a>);
00580 
00581         <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00582             <span class="keywordflow">return</span> r;
00583         }
00584 
00585         <span class="keywordflow">if</span> (!(pc = <a class="code" href="../../d1/d9/arc_8h.html#a19">ArcGetPeer</a>(pc))) {
00586             <span class="keywordflow">break</span>;
00587         }
00588     }
00589 
00590     <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>;
00591 }
00592 
00593 
00594 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l00595"></a><a class="code" href="../../d1/d6/low_8c.html#a18">00595</a> <a class="code" href="../../d1/d6/low_8c.html#a18">LowQueryComponentList</a>(
00596     IN  CONFIGURATION_CLASS*        ConfigClass OPTIONAL,
00597     IN  CONFIGURATION_TYPE*             ConfigType OPTIONAL,
00598     OUT <a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html">PCONFIGURATION_COMPONENT</a>**  ComponentList,
00599     OUT PULONG                      ListLength
00600     )
00601 <span class="comment">/*++</span>
00602 <span class="comment"></span>
00603 <span class="comment">Routine Description:</span>
00604 <span class="comment"></span>
00605 <span class="comment">    This routine returns an array of components whose class and</span>
00606 <span class="comment">    type match the ones given.  (Since each parameter is optional,</span>
00607 <span class="comment">    you can do type-only and class-only searches.)</span>
00608 <span class="comment"></span>
00609 <span class="comment">    The array is allocated on the heap and contains pointers to</span>
00610 <span class="comment">    the actual components (NOT copies).</span>
00611 <span class="comment"></span>
00612 <span class="comment">Arguments:</span>
00613 <span class="comment"></span>
00614 <span class="comment">    ConfigClass     - Supplies the configuation class to search for.</span>
00615 <span class="comment">    ConfigType      - Supplies the configuration type to search for.</span>
00616 <span class="comment">    ComponentList   - Returns a list of pointers to components whose</span>
00617 <span class="comment">                        class and type match 'ConfigClass' and</span>
00618 <span class="comment">                        'ConfigType'.</span>
00619 <span class="comment">    ListLength      - Returns the number of components in the list.</span>
00620 <span class="comment"></span>
00621 <span class="comment">Return Value:</span>
00622 <span class="comment"></span>
00623 <span class="comment">    LowTraverseChildren, ENOMEM</span>
00624 <span class="comment"></span>
00625 <span class="comment">--*/</span>
00626 {
00627     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>  r;
00628 
00629     *ListLength = 0;
00630 
00631     r = <a class="code" href="../../d1/d6/low_8c.html#a17">LowTraverseChildren</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, ConfigClass, ConfigType, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, ListLength);
00632 
00633     <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00634         <span class="keywordflow">return</span> r;
00635     }
00636 
00637     <span class="keywordflow">if</span> (!(*ComponentList = (<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html">PCONFIGURATION_COMPONENT</a>*) <a class="code" href="../../d4/d9/arcinst_8h.html#a20">AllocateMemory</a>(
00638             (*ListLength)*<span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html">PCONFIGURATION_COMPONENT</a>)))) {
00639 
00640         <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>;
00641     }
00642 
00643     *ListLength = 0;
00644 
00645     <span class="keywordflow">return</span> <a class="code" href="../../d1/d6/low_8c.html#a17">LowTraverseChildren</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, ConfigClass, ConfigType,
00646                                *ComponentList, ListLength);
00647 }
00648 
00649 
00650 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l00651"></a><a class="code" href="../../d1/d6/low_8c.html#a19">00651</a> <a class="code" href="../../d1/d6/low_8c.html#a19">LowQueryPathList</a>(
00652     IN  CONFIGURATION_CLASS*        ConfigClass OPTIONAL,
00653     IN  CONFIGURATION_TYPE*             ConfigType OPTIONAL,
00654     OUT PCHAR**                     PathList,
00655     OUT PULONG                      ListLength
00656     )
00657 <span class="comment">/*++</span>
00658 <span class="comment"></span>
00659 <span class="comment">Routine Description:</span>
00660 <span class="comment"></span>
00661 <span class="comment">    This routine returns a list of paths to the components that are</span>
00662 <span class="comment">    of class ConfigClass and of type ConfigType.</span>
00663 <span class="comment"></span>
00664 <span class="comment">Arguments:</span>
00665 <span class="comment"></span>
00666 <span class="comment">    ConfigClass     - Supplies the configuation class to search for.</span>
00667 <span class="comment">    ConfigType      - Supplies the configuration type to search for.</span>
00668 <span class="comment">    PathList        - Returns a list of paths to the components.</span>
00669 <span class="comment">    ListLength      - Returns the number of components in the list.</span>
00670 <span class="comment"></span>
00671 <span class="comment">Return Value:</span>
00672 <span class="comment"></span>
00673 <span class="comment">    LowQueryComponentList, LowQueryPathFromComponent</span>
00674 <span class="comment"></span>
00675 <span class="comment">--*/</span>
00676 {
00677     <a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html">PCONFIGURATION_COMPONENT</a>*   component_list;
00678     ULONG                       list_length;
00679     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>                  r;
00680     ULONG                       i;
00681     PCHAR*                      path_list;
00682 
00683     r = <a class="code" href="../../d1/d6/low_8c.html#a18">LowQueryComponentList</a>(ConfigClass, ConfigType,
00684                               &amp;component_list, &amp;list_length);
00685 
00686     <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00687         <span class="keywordflow">return</span> r;
00688     }
00689 
00690     <span class="keywordflow">if</span> (!(path_list = (PCHAR*) <a class="code" href="../../d4/d9/arcinst_8h.html#a20">AllocateMemory</a>(list_length*<span class="keyword">sizeof</span>(PCHAR)))) {
00691         <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(component_list);
00692         <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>;
00693     }
00694 
00695 
00696     <span class="keywordflow">for</span> (i = 0; i &lt; list_length; i++) {
00697         path_list[i] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00698     }
00699 
00700     <span class="keywordflow">for</span> (i = 0; i &lt; list_length; i++) {
00701 
00702         r = <a class="code" href="../../d1/d6/low_8c.html#a16">LowQueryPathFromComponent</a>(component_list[i], &amp;path_list[i]);
00703 
00704         <span class="keywordflow">if</span> (r != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00705             <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(component_list);
00706             <a class="code" href="../../d1/d6/low_8c.html#a20">LowFreePathList</a>(path_list, list_length);
00707             <span class="keywordflow">return</span> r;
00708         }
00709     }
00710 
00711     <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(component_list);
00712 
00713     *PathList = path_list;
00714     *ListLength = list_length;
00715 
00716     <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>;
00717 }
00718 
00719 
00720 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l00721"></a><a class="code" href="../../d1/d6/low_8c.html#a20">00721</a> <a class="code" href="../../d1/d6/low_8c.html#a20">LowFreePathList</a>(
00722     IN  PCHAR*  PathList,
00723     IN  ULONG   ListLength
00724     )
00725 <span class="comment">/*++</span>
00726 <span class="comment"></span>
00727 <span class="comment">Routine Description:</span>
00728 <span class="comment"></span>
00729 <span class="comment">    This routine frees up the space taken by the path lists.</span>
00730 <span class="comment"></span>
00731 <span class="comment">Arguments:</span>
00732 <span class="comment"></span>
00733 <span class="comment">    PathList    - Supplies the paths.</span>
00734 <span class="comment">    ListLength  - Supplies the number of paths.</span>
00735 <span class="comment"></span>
00736 <span class="comment">Return Value:</span>
00737 <span class="comment"></span>
00738 <span class="comment">    ESUCCESS</span>
00739 <span class="comment"></span>
00740 <span class="comment">--*/</span>
00741 {
00742     ULONG i;
00743 
00744     <span class="keywordflow">for</span> (i = 0; i &lt; ListLength; i++) {
00745         <span class="keywordflow">if</span> (PathList[i]) {
00746             <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(PathList[i]);
00747         }
00748     }
00749     <a class="code" href="../../d4/d9/arcinst_8h.html#a22">FreeMemory</a>(PathList);
00750 
00751     <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>;
00752 }
00753 
00754 
00755 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l00756"></a><a class="code" href="../../d1/d6/low_8c.html#a21">00756</a> <a class="code" href="../../d1/d6/low_8c.html#a21">LowQueryFdiskPathList</a>(
00757     OUT PCHAR** PathList,
00758     OUT PULONG  ListLength
00759     )
00760 <span class="comment">/*++</span>
00761 <span class="comment"></span>
00762 <span class="comment">Routine Description:</span>
00763 <span class="comment"></span>
00764 <span class="comment">    This routine returns a list of paths to all the devices of interest</span>
00765 <span class="comment">    to FDISK.</span>
00766 <span class="comment"></span>
00767 <span class="comment">Arguments:</span>
00768 <span class="comment"></span>
00769 <span class="comment">    PathList    - Returns a list of paths.</span>
00770 <span class="comment">    ListLength  - Returns the length of the list.</span>
00771 <span class="comment"></span>
00772 <span class="comment">Return Value:</span>
00773 <span class="comment"></span>
00774 <span class="comment">    LowQueryComponentList, LowQueryPathFromComponent, ESUCCESS</span>
00775 <span class="comment"></span>
00776 <span class="comment">--*/</span>
00777 {
00778     <a class="code" href="../../d1/d9/arc_8h.html#a56">CONFIGURATION_TYPE</a>  config_type;
00779 
00780     config_type = <a class="code" href="../../d1/d9/arc_8h.html#a315a212">DiskPeripheral</a>;
00781     <span class="keywordflow">return</span> <a class="code" href="../../d1/d6/low_8c.html#a19">LowQueryPathList</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;config_type, PathList, ListLength);
00782 }
00783 
00784 
00785 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l00786"></a><a class="code" href="../../d1/d6/low_8c.html#a22">00786</a> <a class="code" href="../../d1/d6/low_8c.html#a22">LowFreeFdiskPathList</a>(
00787     IN OUT  PCHAR*  PathList,
00788     IN      ULONG   ListLength
00789     )
00790 <span class="comment">/*++</span>
00791 <span class="comment"></span>
00792 <span class="comment">Routine Description:</span>
00793 <span class="comment"></span>
00794 <span class="comment">    This routine frees up the space taken by the path lists.</span>
00795 <span class="comment"></span>
00796 <span class="comment">Arguments:</span>
00797 <span class="comment"></span>
00798 <span class="comment">    PathList    - Supplies the paths.</span>
00799 <span class="comment">    ListLength  - Supplies the number of paths.</span>
00800 <span class="comment"></span>
00801 <span class="comment">Return Value:</span>
00802 <span class="comment"></span>
00803 <span class="comment">    ESUCCESS</span>
00804 <span class="comment"></span>
00805 <span class="comment">--*/</span>
00806 {
00807     <span class="keywordflow">return</span> <a class="code" href="../../d1/d6/low_8c.html#a20">LowFreePathList</a>(PathList, ListLength);
00808 }
00809 
00810 
00811 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l00812"></a><a class="code" href="../../d1/d6/low_8c.html#a23">00812</a> <a class="code" href="../../d1/d6/low_8c.html#a23">LowGetDiskLayout</a>(
00813     IN  PCHAR                      Path,
00814     OUT PDRIVE_LAYOUT_INFORMATION* DriveLayout
00815     )
00816 {
00817     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>                status;
00818     ULONG                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00819     ULONG                     i,ExtendedStart,BootSector,Entry;
00820     ULONG                     <a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>,bps;
00821     BOOLEAN                   Link,mbr;
00822     PDRIVE_LAYOUT_INFORMATION DriveInfo;
00823     PPARTITION_INFORMATION    p;
00824     PCHAR                     SectorBuffer;
00825     <a class="code" href="../../d5/d8/struct__PARTITION__DESCRIPTOR.html">PPARTITION_DESCRIPTOR</a>     ptable;
00826 
00827 
00828 <span class="preprocessor">#define PSTART(p)  (                                \</span>
00829 <span class="preprocessor">        (ULONG) ((p)-&gt;StartingSectorLsb0) +           \</span>
00830 <span class="preprocessor">        (ULONG) ((p)-&gt;StartingSectorLsb1 &lt;&lt; 8) +      \</span>
00831 <span class="preprocessor">        (ULONG) ((p)-&gt;StartingSectorMsb0 &lt;&lt; 16) +     \</span>
00832 <span class="preprocessor">        (ULONG) ((p)-&gt;StartingSectorMsb1 &lt;&lt; 24) )</span>
00833 <span class="preprocessor"></span>
00834 <span class="preprocessor">#define PLENGTH(p)   (                              \</span>
00835 <span class="preprocessor">        (ULONG) ((p)-&gt;PartitionLengthLsb0) +          \</span>
00836 <span class="preprocessor">        (ULONG) ((p)-&gt;PartitionLengthLsb1 &lt;&lt; 8) +     \</span>
00837 <span class="preprocessor">        (ULONG) ((p)-&gt;PartitionLengthMsb0 &lt;&lt; 16) +    \</span>
00838 <span class="preprocessor">        (ULONG) ((p)-&gt;PartitionLengthMsb1 &lt;&lt; 24) )</span>
00839 <span class="preprocessor"></span>
00840 
00841 
00842     <span class="keywordflow">if</span>((DriveInfo = <a class="code" href="../../d4/d6/memory_8c.html#a22">AlAllocateHeap</a>(<span class="keyword">sizeof</span>(DRIVE_LAYOUT_INFORMATION) + (500*<span class="keyword">sizeof</span>(PARTITION_INFORMATION)))) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00843         <span class="keywordflow">return</span>(<a class="code" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>);
00844     }
00845     p = &amp;DriveInfo-&gt;PartitionEntry[0];
00846 
00847     <span class="keywordflow">if</span>((status = <a class="code" href="../../d1/d6/low_8c.html#a11">LowGetDriveGeometry</a>(Path,&amp;<a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>,&amp;bps,&amp;<a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>,&amp;<a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>)) != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00848         <a class="code" href="../../d4/d6/memory_8c.html#a23">AlDeallocateHeap</a>(DriveInfo);
00849         <span class="keywordflow">return</span>(status);
00850     }
00851 
00852     <span class="keywordflow">if</span>((SectorBuffer = <a class="code" href="../../d4/d6/memory_8c.html#a22">AlAllocateHeap</a>(bps)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00853         <a class="code" href="../../d4/d6/memory_8c.html#a23">AlDeallocateHeap</a>(DriveInfo);
00854         <span class="keywordflow">return</span>(<a class="code" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>);
00855     }
00856 
00857     ptable = (<a class="code" href="../../d5/d8/struct__PARTITION__DESCRIPTOR.html">PPARTITION_DESCRIPTOR</a>)(SectorBuffer + (2*<a class="code" href="../../d2/d7/hal_8h.html#a10">PARTITION_TABLE_OFFSET</a>));
00858 
00859     <span class="keywordflow">if</span>((status = <a class="code" href="../../d1/d6/low_8c.html#a9">LowOpenDisk</a>(Path,&amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>)) != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00860         <a class="code" href="../../d4/d6/memory_8c.html#a23">AlDeallocateHeap</a>(SectorBuffer);
00861         <a class="code" href="../../d4/d6/memory_8c.html#a23">AlDeallocateHeap</a>(DriveInfo);
00862         <span class="keywordflow">return</span>(status);
00863     }
00864 
00865     mbr = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00866     Entry = 0;
00867     BootSector = 0;
00868     ExtendedStart = 0;
00869     status = <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>;
00870 
00871     <span class="keywordflow">do</span> {
00872 
00873         <span class="keywordflow">if</span>((status = <a class="code" href="../../d1/d6/low_8c.html#a13">LowReadSectors</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,bps,BootSector,1,SectorBuffer)) != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00874             <span class="keywordflow">break</span>;
00875         }
00876 
00877         <span class="comment">// This is to catch the case where there is no MBR yet.</span>
00878 
00879         <span class="keywordflow">if</span>(((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)SectorBuffer)[<a class="code" href="../../d2/d7/hal_8h.html#a11">BOOT_SIGNATURE_OFFSET</a>] != <a class="code" href="../../d2/d7/hal_8h.html#a12">BOOT_RECORD_SIGNATURE</a>) {
00880             <span class="keywordflow">break</span>;
00881         }
00882 
00883         Link = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00884 
00885         <span class="keywordflow">for</span>(i=0; i&lt;<a class="code" href="../../d2/d7/hal_8h.html#a9">NUM_PARTITION_TABLE_ENTRIES</a>; i++) {
00886 
00887             <span class="keywordflow">if</span>(ptable[i].<a class="code" href="../../d5/d8/struct__PARTITION__DESCRIPTOR.html#o4">PartitionType</a> == <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>) {
00888 
00889                 <span class="comment">// set as unused.</span>
00890 
00891                 p[Entry].PartitionType    = <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>;
00892                 p[Entry].BootIndicator    = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00893                 p[Entry].RewritePartition = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00894                 p[Entry].PartitionLength.QuadPart  = 0;
00895                 p[Entry].HiddenSectors    = 0;
00896                 p[Entry].StartingOffset.QuadPart   = 0;
00897                 p[Entry].RecognizedPartition = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00898 
00899             } <span class="keywordflow">else</span> {
00900 
00901                 LARGE_INTEGER   Result1, Result2;
00902 
00903                 p[Entry].PartitionType    = ptable[i].<a class="code" href="../../d5/d8/struct__PARTITION__DESCRIPTOR.html#o4">PartitionType</a>;
00904                 p[Entry].BootIndicator    = ptable[i].<a class="code" href="../../d5/d8/struct__PARTITION__DESCRIPTOR.html#o0">ActiveFlag</a>;
00905                 p[Entry].RewritePartition = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00906                 p[Entry].PartitionLength.QuadPart  = UInt32x32To64(<a class="code" href="../../d1/d6/low_8c.html#a2">PLENGTH</a>(ptable + i),bps);
00907 
00908                 <span class="comment">// BUGBUG (tedm) the following are not correct for link</span>
00909                 <span class="comment">//               entries in the extended partition.</span>
00910                 <span class="comment">//               But fdisk does not use these values in</span>
00911                 <span class="comment">//               this case so blow it off.  As of</span>
00912                 <span class="comment">//               11/13/91, IoReadPartitionTable has the</span>
00913                 <span class="comment">//               same bug.</span>
00914 
00915                 p[Entry].HiddenSectors    = <a class="code" href="../../d1/d6/low_8c.html#a1">PSTART</a>(ptable + i);
00916                 Result1.QuadPart = UInt32x32To64(<a class="code" href="../../d1/d6/low_8c.html#a1">PSTART</a>(ptable + i),bps);
00917                 Result2.QuadPart = UInt32x32To64(BootSector,bps);
00918                 p[Entry].StartingOffset.QuadPart = Result1.QuadPart + Result2.QuadPart;
00919 
00920                 p[Entry].RecognizedPartition = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;     <span class="comment">// BUGBUG this is broken</span>
00921 
00922                 <span class="keywordflow">if</span>(p[Entry].PartitionType == <a class="code" href="../../d4/d9/arcinst_8h.html#a176a71">SYSID_EXTENDED</a>) {
00923 
00924                     Link = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00925 
00926                     <span class="keywordflow">if</span>(mbr) {
00927                         mbr = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00928                         BootSector = <a class="code" href="../../d1/d6/low_8c.html#a1">PSTART</a>(ptable + i);
00929                         ExtendedStart = BootSector;
00930                     } <span class="keywordflow">else</span> {
00931                         BootSector = ExtendedStart + <a class="code" href="../../d1/d6/low_8c.html#a1">PSTART</a>(ptable + i);
00932                     }
00933                 }
00934             }
00935             Entry++;
00936         }
00937     } <span class="keywordflow">while</span>(Link);
00938 
00939     <a class="code" href="../../d1/d6/low_8c.html#a10">LowCloseDisk</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
00940 
00941     <a class="code" href="../../d4/d6/memory_8c.html#a23">AlDeallocateHeap</a>(SectorBuffer);
00942 
00943     <span class="keywordflow">if</span>(status != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
00944 
00945         <a class="code" href="../../d4/d6/memory_8c.html#a23">AlDeallocateHeap</a>(DriveInfo);
00946         <span class="keywordflow">return</span>(status);
00947     }
00948 
00949     <span class="comment">// reallocate DriveInfo, set PartitionCount field.</span>
00950     <span class="comment">// DriveInfo is shrinking.</span>
00951 
00952     DriveInfo = <a class="code" href="../../d4/d6/memory_8c.html#a24">AlReallocateHeap</a>(DriveInfo,
00953                                    <span class="keyword">sizeof</span>(DRIVE_LAYOUT_INFORMATION)
00954                                  + ((Entry - 1) * <span class="keyword">sizeof</span>(PARTITION_INFORMATION))
00955                                 );
00956 
00957     DriveInfo-&gt;PartitionCount = Entry;
00958 
00959     *DriveLayout = DriveInfo;
00960 
00961     <span class="keywordflow">return</span>(<a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>);
00962 }
00963 
00964 
00965 <span class="comment">//</span>
00966 <span class="comment">// cylinder/head/sector stuff placed in partition table</span>
00967 <span class="comment">//</span>
00968 
<a name="l00969"></a><a class="code" href="../../d4/d8/struct__tagCHS.html">00969</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d4/d8/struct__tagCHS.html">_tagCHS</a> {
<a name="l00970"></a><a class="code" href="../../d4/d8/struct__tagCHS.html#o0">00970</a>     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d4/d8/struct__tagCHS.html#o0">StartCylinder</a>;
<a name="l00971"></a><a class="code" href="../../d4/d8/struct__tagCHS.html#o1">00971</a>     UCHAR  <a class="code" href="../../d4/d8/struct__tagCHS.html#o1">StartHead</a>;
<a name="l00972"></a><a class="code" href="../../d4/d8/struct__tagCHS.html#o2">00972</a>     UCHAR  <a class="code" href="../../d4/d8/struct__tagCHS.html#o2">StartSector</a>;
<a name="l00973"></a><a class="code" href="../../d4/d8/struct__tagCHS.html#o3">00973</a>     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d4/d8/struct__tagCHS.html#o3">EndCylinder</a>;
<a name="l00974"></a><a class="code" href="../../d4/d8/struct__tagCHS.html#o4">00974</a>     UCHAR  <a class="code" href="../../d4/d8/struct__tagCHS.html#o4">EndHead</a>;
<a name="l00975"></a><a class="code" href="../../d4/d8/struct__tagCHS.html#o5">00975</a>     UCHAR  <a class="code" href="../../d4/d8/struct__tagCHS.html#o5">EndSector</a>;
00976 } <a class="code" href="../../d4/d8/struct__tagCHS.html">CHS</a>, *<a class="code" href="../../d4/d8/struct__tagCHS.html">PCHS</a>;
00977 
00978 
00979 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00980"></a><a class="code" href="../../d1/d6/low_8c.html#a24">00980</a> <a class="code" href="../../d1/d6/low_8c.html#a24">CalculateCHSVals</a>(
00981     IN  ULONG Start,
00982     IN  ULONG Size,
00983     IN  ULONG spt,
00984     IN  ULONG h,
00985     OUT PCHS  chs
00986     )
00987 {
00988     ULONG spc = spt * h;        <span class="comment">// sectors per cylinder</span>
00989     ULONG r;
00990     ULONG <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>+<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>-1;
00991 
00992     chs-&gt;StartCylinder = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>/spc);
00993     r = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> % spc;
00994     chs-&gt;StartHead = (UCHAR)(r / spt);
00995     chs-&gt;StartSector = (UCHAR)((r % spt) + 1);      <span class="comment">// sector is 1-based</span>
00996 
00997     chs-&gt;EndCylinder = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>/spc);
00998     r = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> % spc;
00999     chs-&gt;EndHead = (UCHAR)(r / spt);
01000     chs-&gt;EndSector = (UCHAR)((r % spt) + 1);        <span class="comment">// sector is 1-based</span>
01001 }
01002 
01003 
01004 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01005"></a><a class="code" href="../../d1/d6/low_8c.html#a25">01005</a> <a class="code" href="../../d1/d6/low_8c.html#a25">SetPartitionTableEntry</a>(
01006     IN OUT <a class="code" href="../../d5/d8/struct__PARTITION__DESCRIPTOR.html">PPARTITION_DESCRIPTOR</a> p,
01007     IN     UCHAR                 Active,
01008     IN     UCHAR                 SysID,
01009     IN     ULONG                 RelativeSector,
01010     IN     ULONG                 SectorCount,
01011     IN     PCHS                  chs
01012     )
01013 {
01014     <span class="comment">// first get the easy ones out of the way.</span>
01015 
01016     p-&gt;ActiveFlag    = <a class="code" href="../../d7/d7/fs__rec_8h.html#a39a20">Active</a>;
01017     p-&gt;PartitionType = SysID;
01018 
01019     <span class="keywordflow">if</span>(chs) {
01020         p-&gt;StartingTrack = chs-&gt;StartHead;
01021         p-&gt;EndingTrack   = chs-&gt;EndHead;
01022     } <span class="keywordflow">else</span> {
01023         p-&gt;StartingTrack = 0;
01024         p-&gt;EndingTrack   = 0;
01025     }
01026 
01027     <span class="keywordflow">if</span>(chs) {
01028 
01029         <span class="comment">// pack sector/cyl values</span>
01030 
01031         p-&gt;StartingCylinderLsb = (chs-&gt;StartSector &amp; 0x3f) | ((chs-&gt;StartCylinder &gt;&gt; 2) &amp; 0xc0);
01032         p-&gt;StartingCylinderMsb = (UCHAR)chs-&gt;StartCylinder;
01033 
01034         p-&gt;EndingCylinderLsb   = (chs-&gt;EndSector   &amp; 0x3f) | ((chs-&gt;EndCylinder   &gt;&gt; 2) &amp; 0xc0);
01035         p-&gt;EndingCylinderMsb   = (UCHAR)chs-&gt;EndCylinder;
01036 
01037     } <span class="keywordflow">else</span> {
01038 
01039         p-&gt;StartingCylinderLsb = 0;
01040         p-&gt;StartingCylinderMsb = 0;
01041 
01042         p-&gt;EndingCylinderLsb   = 0;
01043         p-&gt;EndingCylinderMsb   = 0;
01044     }
01045 
01046     <span class="comment">// now handle the relative and total sector counts</span>
01047 
01048     p-&gt;StartingSectorLsb0  = (UCHAR)(RelativeSector &gt;&gt; 0 );
01049     p-&gt;StartingSectorLsb1  = (UCHAR)(RelativeSector &gt;&gt; 8 );
01050     p-&gt;StartingSectorMsb0  = (UCHAR)(RelativeSector &gt;&gt; 16);
01051     p-&gt;StartingSectorMsb1  = (UCHAR)(RelativeSector &gt;&gt; 24);
01052 
01053     p-&gt;PartitionLengthLsb0 = (UCHAR)(SectorCount    &gt;&gt; 0 );
01054     p-&gt;PartitionLengthLsb1 = (UCHAR)(SectorCount    &gt;&gt; 8 );
01055     p-&gt;PartitionLengthMsb0 = (UCHAR)(SectorCount    &gt;&gt; 16);
01056     p-&gt;PartitionLengthMsb1 = (UCHAR)(SectorCount    &gt;&gt; 24);
01057 }
01058 
01059 
<a name="l01060"></a><a class="code" href="../../d1/d6/low_8c.html#a3">01060</a> <span class="preprocessor">#define ZeroPartitionTableEntry(p) SetPartitionTableEntry(p,0,SYSID_UNUSED,0,0,NULL);</span>
01061 <span class="preprocessor"></span>
01062 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01063"></a><a class="code" href="../../d1/d6/low_8c.html#a26">01063</a> <a class="code" href="../../d1/d6/low_8c.html#a26">ZeroPartitionTable</a>(
01064     <a class="code" href="../../d5/d8/struct__PARTITION__DESCRIPTOR.html">PPARTITION_DESCRIPTOR</a> PartitionTable
01065     )
01066 {
01067     ULONG i;
01068 
01069     <span class="keywordflow">for</span>(i=0; i&lt;<a class="code" href="../../d4/d9/arcinst_8h.html#a27">ENTRIES_PER_BOOTSECTOR</a>; i++) {
01070         <a class="code" href="../../d1/d6/low_8c.html#a3">ZeroPartitionTableEntry</a>(PartitionTable+i);
01071     }
01072 }
01073 
01074 
01075 <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>
<a name="l01076"></a><a class="code" href="../../d1/d6/low_8c.html#a27">01076</a> <a class="code" href="../../d1/d6/low_8c.html#a27">LowSetDiskLayout</a>(
01077     IN PCHAR                     Path,
01078     IN PDRIVE_LAYOUT_INFORMATION DriveLayout
01079     )
01080 {
01081     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a>             status;
01082     ULONG                   <a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>,bps,spt,h;
01083     PCHAR                   SectorBuffer;
01084     ULONG                   <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
01085     <a class="code" href="../../d5/d8/struct__PARTITION__DESCRIPTOR.html">PPARTITION_DESCRIPTOR</a>   PartitionTable;
01086     PPARTITION_INFORMATION  p;
01087     BOOLEAN                 mbr = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,Update;
01088     ULONG                   BootSector = 0,ExtendedPartitionStart = 0,
01089                             NextBootSector;
01090     ULONG                   i,j,UsedCount;
01091     <a class="code" href="../../d4/d8/struct__tagCHS.html">CHS</a>                     chs;
01092 
01093 
01094 <span class="preprocessor">#define SECCNT(l) ((ULONG)(((ULONGLONG)l.QuadPart)/((ULONGLONG)bps)))</span>
01095 <span class="preprocessor"></span>
01096 
01097     <a class="code" href="../../d4/d9/arcinst_8h.html#a28">ASRT</a>(DriveLayout-&gt;PartitionCount);
01098 
01099     <span class="keywordflow">if</span>((status = <a class="code" href="../../d1/d6/low_8c.html#a11">LowGetDriveGeometry</a>(Path,&amp;<a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>,&amp;bps,&amp;spt,&amp;h)) != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
01100         <span class="keywordflow">return</span>(status);
01101     }
01102 
01103     <span class="comment">// allocate a buffer for sector I/O</span>
01104 
01105     <span class="keywordflow">if</span>((SectorBuffer = <a class="code" href="../../d4/d6/memory_8c.html#a22">AlAllocateHeap</a>(bps)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01106         <span class="keywordflow">return</span>(<a class="code" href="../../d2/d9/arccodes_8h.html#a24a17">ENOMEM</a>);
01107     }
01108 
01109     <span class="comment">//</span>
01110     <span class="comment">// Use x86 bootcode as a template so the disk will boot an x86</span>
01111     <span class="comment">// if it is moved to disk0 on an x86 machine.</span>
01112     <span class="comment">//</span>
01113     RtlMoveMemory(SectorBuffer,x86BootCode,<a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(X86BOOTCODE_SIZE,bps));
01114 
01115     ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)SectorBuffer)[<a class="code" href="../../d2/d7/hal_8h.html#a11">BOOT_SIGNATURE_OFFSET</a>] = <a class="code" href="../../d2/d7/hal_8h.html#a12">BOOT_RECORD_SIGNATURE</a>;
01116     PartitionTable = (<a class="code" href="../../d5/d8/struct__PARTITION__DESCRIPTOR.html">PPARTITION_DESCRIPTOR</a>)(&amp;(((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)SectorBuffer)[<a class="code" href="../../d2/d7/hal_8h.html#a10">PARTITION_TABLE_OFFSET</a>]));
01117 
01118     <span class="keywordflow">if</span>((status = <a class="code" href="../../d1/d6/low_8c.html#a9">LowOpenDisk</a>(Path,&amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>)) != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
01119         <a class="code" href="../../d4/d6/memory_8c.html#a23">AlDeallocateHeap</a>(SectorBuffer);
01120         <span class="keywordflow">return</span>(status);
01121     }
01122 
01123     <a class="code" href="../../d4/d9/arcinst_8h.html#a28">ASRT</a>(!(DriveLayout-&gt;PartitionCount % <a class="code" href="../../d4/d9/arcinst_8h.html#a27">ENTRIES_PER_BOOTSECTOR</a>));
01124     <span class="keywordflow">for</span>(i=0; i&lt;DriveLayout-&gt;PartitionCount; i+=<a class="code" href="../../d4/d9/arcinst_8h.html#a27">ENTRIES_PER_BOOTSECTOR</a>) {
01125 
01126         Update = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01127         UsedCount = 0;
01128 
01129         <a class="code" href="../../d1/d6/low_8c.html#a26">ZeroPartitionTable</a>(PartitionTable);
01130 
01131         <span class="keywordflow">for</span>(j=0; j&lt;<a class="code" href="../../d4/d9/arcinst_8h.html#a27">ENTRIES_PER_BOOTSECTOR</a>; j++) {
01132 
01133             p = &amp;DriveLayout-&gt;PartitionEntry[i+j];
01134 
01135             <span class="keywordflow">switch</span>(p-&gt;PartitionType) {
01136             <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>:
01137                 <a class="code" href="../../d1/d6/low_8c.html#a3">ZeroPartitionTableEntry</a>(PartitionTable+j);
01138                 <span class="keywordflow">break</span>;
01139 
01140             <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/arcinst_8h.html#a176a71">SYSID_EXTENDED</a>:
01141                 NextBootSector = <a class="code" href="../../d1/d6/low_8c.html#a4">SECCNT</a>(p-&gt;StartingOffset);
01142                 <a class="code" href="../../d1/d6/low_8c.html#a24">CalculateCHSVals</a>(NextBootSector,<a class="code" href="../../d1/d6/low_8c.html#a4">SECCNT</a>(p-&gt;PartitionLength),spt,h,&amp;chs);
01143                 <a class="code" href="../../d1/d6/low_8c.html#a25">SetPartitionTableEntry</a>(PartitionTable+j,
01144                                        p-&gt;BootIndicator,
01145                                        <a class="code" href="../../d4/d9/arcinst_8h.html#a176a71">SYSID_EXTENDED</a>,
01146                                        <a class="code" href="../../d1/d6/low_8c.html#a4">SECCNT</a>(p-&gt;StartingOffset) - ExtendedPartitionStart,
01147                                        <a class="code" href="../../d1/d6/low_8c.html#a4">SECCNT</a>(p-&gt;PartitionLength),
01148                                        &amp;chs
01149                                       );
01150                 <span class="keywordflow">if</span>(mbr) {
01151                     mbr = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01152                     ExtendedPartitionStart = NextBootSector;
01153                 }
01154                 <span class="keywordflow">break</span>;
01155 
01156             <span class="keywordflow">default</span>:
01157                 <a class="code" href="../../d1/d6/low_8c.html#a24">CalculateCHSVals</a>(<a class="code" href="../../d1/d6/low_8c.html#a4">SECCNT</a>(p-&gt;StartingOffset),<a class="code" href="../../d1/d6/low_8c.html#a4">SECCNT</a>(p-&gt;PartitionLength),spt,h,&amp;chs);
01158                 <a class="code" href="../../d1/d6/low_8c.html#a25">SetPartitionTableEntry</a>(PartitionTable+j,
01159                                        p-&gt;BootIndicator,
01160                                        p-&gt;<a class="code" href="../../d5/d8/struct__PARTITION__DESCRIPTOR.html#o4">PartitionType</a>,
01161                                        <a class="code" href="../../d1/d6/low_8c.html#a4">SECCNT</a>(p-&gt;StartingOffset) - BootSector,
01162                                        <a class="code" href="../../d1/d6/low_8c.html#a4">SECCNT</a>(p-&gt;PartitionLength),
01163                                        &amp;chs
01164                                       );
01165                 <span class="keywordflow">break</span>;
01166             }
01167             Update = Update || p-&gt;RewritePartition;
01168 
01169             <span class="keywordflow">if</span>(p-&gt;PartitionType != <a class="code" href="../../d4/d9/arcinst_8h.html#a176a70">SYSID_UNUSED</a>) {
01170                 UsedCount++;
01171             }
01172         }
01173         <span class="keywordflow">if</span>(Update || !UsedCount) {
01174             <span class="keywordflow">if</span>((status = <a class="code" href="../../d1/d6/low_8c.html#a14">LowWriteSectors</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,bps,BootSector,1,SectorBuffer)) != <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
01175                 <a class="code" href="../../d1/d6/low_8c.html#a10">LowCloseDisk</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
01176                 <a class="code" href="../../d4/d6/memory_8c.html#a23">AlDeallocateHeap</a>(SectorBuffer);
01177                 <span class="keywordflow">return</span>(status);
01178             }
01179         }
01180         BootSector = NextBootSector;
01181     }
01182 
01183     <a class="code" href="../../d1/d6/low_8c.html#a10">LowCloseDisk</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
01184     <a class="code" href="../../d4/d6/memory_8c.html#a23">AlDeallocateHeap</a>(SectorBuffer);
01185     <span class="keywordflow">return</span>(<a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>);
01186 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:39 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
