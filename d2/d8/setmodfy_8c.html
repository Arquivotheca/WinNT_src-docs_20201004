<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: setmodfy.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>setmodfy.c File Reference</h1><code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">mi.h</a>"</code><br>

<p>
<a href="../../d3/d7/setmodfy_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/setmodfy_8c.html#a0">MiSetModifyBit</a> (IN <a class="el" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/setmodfy_8c.html#a1">MiDetermineUserGlobalPteMask</a> (IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> Pte)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/setmodfy_8c.html#a2">MiSetDirtyBit</a> (IN PVOID FaultingAddress, IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte, IN ULONG PfnHeld)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a1" doxytag="setmodfy.c::MiDetermineUserGlobalPteMask" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG FASTCALL MiDetermineUserGlobalPteMask           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Pte</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/setmodfy_8c-source.html#l00084">84</a> of file <a class="el" href="../../d3/d7/setmodfy_8c-source.html">setmodfy.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05296">MI_IS_SESSION_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05701">MiHighestUserPde</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05700">MiHighestUserPte</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00146">MM_SYSTEM_CACHE_WORKING_SET</a>, <a class="el" href="../../d3/d1/data386_8c-source.html#l00036">MmPteGlobal</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00124">PDE_TOP</a>, and <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>.
<p>
Referenced by <a class="el" href="../../d2/d1/mm_2i386_2init386_8c-source.html#l00058">MiInitMachineDependent()</a>.
<p>
<pre class="fragment"><div>00090                    :
00091 
00092     Builds a mask to OR with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE frame field.
00093     This mask has <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> valid and access bits set and
00094     has <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> global and owner bits set based on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00095     address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE.
00096 
00097     *******************  NOTE *********************************************
00098         THIS ROUTINE DOES NOT CHECK FOR PDEs WHICH NEED TO BE
00099         <a class="code" href="../../d9/d7/profman_8c.html#a17">SET</a> GLOBAL AS IT ASSUMES PDEs FOR SYSTEM <a class="code" href="../../d9/d7/udf_8h.html#a27">SPACE</a> ARE
00100         PROPERLY <a class="code" href="../../d9/d7/profman_8c.html#a17">SET</a> AT INITIALIZATION TIME!
00101 
00102 Arguments:
00103 
00104     Pte - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE in which to fill.
00105 
00106 Return Value:
00107 
00108     Mask to OR into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> frame to make a valid PTE.
00109 
00110 Environment:
00111 
00112     Kernel mode, 386 specific.
00113 
00114 --*/
00115 
00116 
00117 {
00118     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> Mask;
00119 
00120     Mask.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = 0;
00121     Mask.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid = 1;
00122     Mask.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Accessed = 1;
00123 
00124     <span class="keywordflow">if</span> (Pte &lt;= <a class="code" href="../../d4/d8/mi_8h.html#a755">MiHighestUserPte</a>) {
00125         Mask.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Owner = 1;
00126     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Pte &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PTE_BASE)) ||
00127         (Pte &gt;= <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (MM_SYSTEM_CACHE_WORKING_SET))) {
00128             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a355">MI_IS_SESSION_PTE</a> (Pte) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00129 <span class="preprocessor">#if defined (_X86PAE_)</span>
00130 <span class="preprocessor"></span>              <span class="keywordflow">if</span> ((Pte &lt; (PMMPTE)PDE_BASE) || (Pte &gt; (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a5">PDE_TOP</a>))
00131 <span class="preprocessor">#endif</span>
00132 <span class="preprocessor"></span>                Mask.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long |= <a class="code" href="../../d2/d2/data386_8c.html#a2">MmPteGlobal</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
00133             }
00134     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Pte &gt;= <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (NULL)) &amp;&amp; (Pte &lt;= <a class="code" href="../../d4/d8/mi_8h.html#a756">MiHighestUserPde</a>)) {
00135         Mask.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Owner = 1;
00136     }
00137 
00138     <span class="comment">//</span>
00139     <span class="comment">// Since the valid, accessed, global and owner bits are always in the</span>
00140     <span class="comment">// low dword of the PTE, returning a ULONG is ok.</span>
00141     <span class="comment">//</span>
00142 
00143     <span class="keywordflow">return</span> (ULONG)Mask.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
00144 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="setmodfy.c::MiSetDirtyBit" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiSetDirtyBit           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>FaultingAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PointerPte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PfnHeld</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/setmodfy_8c-source.html#l00152">152</a> of file <a class="el" href="../../d3/d7/setmodfy_8c-source.html">setmodfy.c</a>.
<p>
References <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01313">MI_SET_ACCESSED_IN_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00710">MI_SET_PTE_DIRTY</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02513">MI_WRITE_VALID_PTE_NEW_PROTECTION</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l01014">MiReleasePageFileSpace()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, and <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>.
<p>
<pre class="fragment"><div>00160                    :
00161 
00162     This routine sets dirty in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified PTE and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> modify bit in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00163     corresponding PFN element.  If any page <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> space <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allocated, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
00164     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> deallocated.
00165 
00166 Arguments:
00167 
00168     FaultingAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> faulting address.
00169 
00170     PointerPte - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding valid PTE.
00171 
00172     PfnHeld - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN lock <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already held.
00173 
00174 Return Value:
00175 
00176     None.
00177 
00178 Environment:
00179 
00180     Kernel mode, APCs disabled, Working set mutex held.
00181 
00182 --*/
00183 
00184 {
00185     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00186     ULONG PageFrameIndex;
00187     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00188 
00189     <span class="comment">//</span>
00190     <span class="comment">// The page is NOT copy on write, update the PTE setting both the</span>
00191     <span class="comment">// dirty bit and the accessed bit. Note, that as this PTE is in</span>
00192     <span class="comment">// the TB, the TB must be flushed.</span>
00193     <span class="comment">//</span>
00194 
00195     TempPte = *PointerPte;
00196     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
00197     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a137">MI_SET_ACCESSED_IN_PTE</a> (&amp;TempPte, 1);
00198     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a188">MI_WRITE_VALID_PTE_NEW_PROTECTION</a>(PointerPte, TempPte);
00199 
00200     <span class="comment">//</span>
00201     <span class="comment">// Check state of PFN lock and if not held, don't update PFN database.</span>
00202     <span class="comment">//</span>
00203 
00204     <span class="keywordflow">if</span> (PfnHeld) {
00205 
00206         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(PointerPte);
00207         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
00208 
00209         <span class="comment">//</span>
00210         <span class="comment">// Set the modified field in the PFN database, also, if the physical</span>
00211         <span class="comment">// page is currently in a paging file, free up the page file space</span>
00212         <span class="comment">// as the contents are now worthless.</span>
00213         <span class="comment">//</span>
00214 
00215         <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
00216                              (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress == 0)) {
00217 
00218             <span class="comment">//</span>
00219             <span class="comment">// This page is in page file format, deallocate the page file space.</span>
00220             <span class="comment">//</span>
00221 
00222             <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
00223 
00224             <span class="comment">//</span>
00225             <span class="comment">// Change original PTE to indicate no page file space is reserved,</span>
00226             <span class="comment">// otherwise the space will be deallocated when the PTE is</span>
00227             <span class="comment">// deleted.</span>
00228             <span class="comment">//</span>
00229 
00230             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh = 0;
00231         }
00232 
00233         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 1;
00234     }
00235 
00236     <span class="comment">//</span>
00237     <span class="comment">// The TB entry must be flushed as the valid PTE with the dirty bit clear</span>
00238     <span class="comment">// has been fetched into the TB. If it isn't flushed, another fault</span>
00239     <span class="comment">// is generated as the dirty bit is not set in the cached TB entry.</span>
00240     <span class="comment">//</span>
00241 
00242     KeFillEntryTb ((PHARDWARE_PTE)PointerPte, FaultingAddress, TRUE);
00243     <span class="keywordflow">return</span>;
00244 }
<span class="preprocessor">#endif</span>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="setmodfy.c::MiSetModifyBit" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiSetModifyBit           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Pfn</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/setmodfy_8c-source.html#l00026">26</a> of file <a class="el" href="../../d3/d7/setmodfy_8c-source.html">setmodfy.c</a>.
<p>
References <a class="el" href="../../d9/d5/deleteva_8c-source.html#l01014">MiReleasePageFileSpace()</a>.
<p>
<pre class="fragment"><div>00032                    :
00033 
00034     This routine sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> modify bit in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified PFN element
00035     and deallocates and allocated page <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> space.
00036 
00037 Arguments:
00038 
00039     Pfn - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN element to update.
00040 
00041 Return Value:
00042 
00043     None.
00044 
00045 Environment:
00046 
00047     Kernel mode, APCs disabled, Working set mutex held and PFN lock held.
00048 
00049 --*/
00050 
00051 {
00052 
00053     <span class="comment">//</span>
00054     <span class="comment">// Set the modified field in the PFN database, also, if the physical</span>
00055     <span class="comment">// page is currently in a paging file, free up the page file space</span>
00056     <span class="comment">// as the contents are now worthless.</span>
00057     <span class="comment">//</span>
00058 
00059     Pfn-&gt;u3.e1.Modified = 1;
00060 
00061     <span class="keywordflow">if</span> (Pfn-&gt;OriginalPte.u.Soft.Prototype == 0) {
00062 
00063         <span class="comment">//</span>
00064         <span class="comment">// This page is in page file format, deallocate the page file space.</span>
00065         <span class="comment">//</span>
00066 
00067         <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (Pfn-&gt;OriginalPte);
00068 
00069         <span class="comment">//</span>
00070         <span class="comment">// Change original PTE to indicate no page file space is reserved,</span>
00071         <span class="comment">// otherwise the space will be deallocated when the PTE is</span>
00072         <span class="comment">// deleted.</span>
00073         <span class="comment">//</span>
00074 
00075         Pfn-&gt;OriginalPte.u.Soft.PageFileHigh = 0;
00076     }
00077 
00078 
00079     <span class="keywordflow">return</span>;
00080 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:38 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
