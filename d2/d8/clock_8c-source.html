<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: clock.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>clock.c</h1><a href="../../d1/d9/clock_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Module Name:</span>
00004 <span class="comment"></span>
00005 <span class="comment">    clock.c</span>
00006 <span class="comment"></span>
00007 <span class="comment">Abstract:</span>
00008 <span class="comment"></span>
00009 <span class="comment">    This module implements the platform specific clock interrupt processing</span>
00010 <span class="comment">    routines in for the kernel.</span>
00011 <span class="comment"></span>
00012 <span class="comment">Author:</span>
00013 <span class="comment"></span>
00014 <span class="comment">    Edward G. Chron (echron) 10-Apr-1996 </span>
00015 <span class="comment"></span>
00016 <span class="comment">Environment:</span>
00017 <span class="comment"></span>
00018 <span class="comment">    Kernel mode only.</span>
00019 <span class="comment"></span>
00020 <span class="comment">Revision History:</span>
00021 <span class="comment"></span>
00022 <span class="comment">--*/</span>
00023 
00024 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00025 <span class="preprocessor">#include &lt;<a class="code" href="../../d3/d4/ia64_8h.html">ia64.h</a>&gt;</span>
00026 <span class="preprocessor">#include &lt;ntia64.h&gt;</span>
00027 <span class="preprocessor">#include &lt;ntexapi.h&gt;</span>
00028 
00029 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00030 <a class="code" href="../../d1/d9/clock_8c.html#a0">KiProcessProfileList</a> (
00031     IN PKTRAP_FRAME    TrFrame,
00032     IN KPROFILE_SOURCE Source,
00033     IN PLIST_ENTRY     ListHead
00034     );
00035 
00036 
00037 BOOLEAN
<a name="l00038"></a><a class="code" href="../../d1/d9/clock_8c.html#a1">00038</a> <a class="code" href="../../d1/d9/clock_8c.html#a1">KiChkTimerExpireSysDpc</a> (
00039     IN ULONGLONG     TickCount
00040     )
00041 
00042 <span class="comment">/*++</span>
00043 <span class="comment"></span>
00044 <span class="comment">Routine Description:</span>
00045 <span class="comment"></span>
00046 <span class="comment">    This routine determines if it should attempt to place a timer expiration DPC </span>
00047 <span class="comment">    in the system DPC list and to drive the DPC by initiating a dispatch level interrupt </span>
00048 <span class="comment">    on the current processor.</span>
00049 <span class="comment"></span>
00050 <span class="comment">    N.B. If DPC is already inserted on the DPC list, we're done.</span>
00051 <span class="comment"></span>
00052 <span class="comment">Arguments:</span>
00053 <span class="comment"></span>
00054 <span class="comment">    TickCount - The lower tick count, timer table hand value</span>
00055 <span class="comment"></span>
00056 <span class="comment">Return Value:</span>
00057 <span class="comment"></span>
00058 <span class="comment">    BOOLEAN - Set to true if Queued DPC or if DPC already Queued.</span>
00059 <span class="comment"></span>
00060 <span class="comment">--*/</span>
00061 
00062 {
00063     BOOLEAN     ret = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;    <span class="comment">// No DPC queued, default return value.</span>
00064 
00065     PLIST_ENTRY ListHead = &amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a3">KiTimerTableListHead</a>[(ULONG)<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a7">TickCount</a>%<a class="code" href="../../d4/d9/ke_8h.html#a10">TIMER_TABLE_SIZE</a>];
00066     PLIST_ENTRY NextEntry = ListHead-&gt;Flink;
00067 
00068     <span class="comment">//</span>
00069     <span class="comment">// Check to see if the list is empty.</span>
00070     <span class="comment">//</span>
00071     <span class="keywordflow">if</span> (NextEntry != ListHead) {
00072         <a class="code" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a>   Timer = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d3/d8/struct__KTIMER.html">KTIMER</a>, TimerListEntry);
00073         ULONGLONG TimeValue = Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o1">DueTime</a>.QuadPart;
00074 
00075         <span class="comment">//</span>
00076         <span class="comment">// See if timer expired.</span>
00077         <span class="comment">//</span>
00078 
00079         <span class="keywordflow">if</span> (TimeValue &lt;= SharedUserData-&gt;InterruptTime) {
00080     
00081             PKPRCB Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00082             <a class="code" href="../../d1/d6/struct__KDPC.html">PKDPC</a>  Dpc  = &amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a58">KiTimerExpireDpc</a>;
00083 
00084             _disable();
00085 <span class="preprocessor">#if !defined(NT_UP)    </span>
00086 <span class="preprocessor"></span>            KiAcquireSpinLock(&amp;Prcb-&gt;DpcLock);
00087 <span class="preprocessor">#endif </span>
00088 <span class="preprocessor"></span>            <span class="comment">//</span>
00089             <span class="comment">// Insert DPC only if not already inserted.</span>
00090             <span class="comment">//</span>
00091             <span class="keywordflow">if</span> (Dpc-&gt;<a class="code" href="../../d1/d6/struct__KDPC.html#o8">Lock</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00092 
00093                 <span class="comment">//</span>
00094                 <span class="comment">// Put timer expiration DPC in the system DPC list and initiate</span>
00095                 <span class="comment">// a dispatch interrupt on the current processor.</span>
00096                 <span class="comment">//</span>
00097 
00098                 Prcb-&gt;DpcCount += 1;
00099                 Prcb-&gt;DpcQueueDepth += 1;
00100                 Dpc-&gt;<a class="code" href="../../d1/d6/struct__KDPC.html#o8">Lock</a> = &amp;Prcb-&gt;DpcLock;
00101                 Dpc-&gt;<a class="code" href="../../d1/d6/struct__KDPC.html#o6">SystemArgument1</a> = (PVOID)<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a7">TickCount</a>;
00102                 Dpc-&gt;<a class="code" href="../../d1/d6/struct__KDPC.html#o7">SystemArgument2</a> = 0;
00103                 InsertTailList(&amp;Prcb-&gt;DpcListHead, &amp;Dpc-&gt;<a class="code" href="../../d1/d6/struct__KDPC.html#o3">DpcListEntry</a>);
00104                 <a class="code" href="../../d9/d4/intsupc_8c.html#a3">KiRequestSoftwareInterrupt</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00105             }
00106 
00107             ret = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00108 
00109 <span class="preprocessor">#if !defined(NT_UP)    </span>
00110 <span class="preprocessor"></span>            KiReleaseSpinLock(&amp;Prcb-&gt;DpcLock);
00111 <span class="preprocessor">#endif </span>
00112 <span class="preprocessor"></span>
00113             _enable();
00114         }
00115     }
00116 
00117     <span class="keywordflow">return</span>(ret);
00118 }
00119 
00120 
00121 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00122"></a><a class="code" href="../../d1/d9/clock_8c.html#a2">00122</a> <a class="code" href="../../d1/d9/clock_8c.html#a2">KeUpdateSystemTime</a> (
00123     IN PKTRAP_FRAME TrFrame,
00124     IN ULONG        Increment
00125     )
00126 
00127 <span class="comment">/*++</span>
00128 <span class="comment"></span>
00129 <span class="comment">Routine Description:</span>
00130 <span class="comment"></span>
00131 <span class="comment">    This routine is executed on a single processor in the processor complex.</span>
00132 <span class="comment">    It's function is to update the system time and to check to determine if a</span>
00133 <span class="comment">    timer has expired.</span>
00134 <span class="comment"></span>
00135 <span class="comment">    N.B. This routine is executed on a single processor in a multiprocess system.</span>
00136 <span class="comment">    The remainder of the processors in the complex execute the quantum end and </span>
00137 <span class="comment">    runtime update code.</span>
00138 <span class="comment"></span>
00139 <span class="comment">Arguments:</span>
00140 <span class="comment"></span>
00141 <span class="comment">    TrFrame   - Supplies a pointer to a trap frame.</span>
00142 <span class="comment"></span>
00143 <span class="comment">    Increment - The time increment to be used to adjust the time slice for the next</span>
00144 <span class="comment">                tick. The value is supplied in 100ns units.</span>
00145 <span class="comment"></span>
00146 <span class="comment">Return Value:</span>
00147 <span class="comment"></span>
00148 <span class="comment">    None.</span>
00149 <span class="comment"></span>
00150 <span class="comment">--*/</span>
00151 
00152 {
00153     <span class="keywordtype">long</span>       SaveTickOffset;
00154     LARGE_INTEGER SystemTime;
00155 
00156     SharedUserData-&gt;InterruptTime += <a class="code" href="../../d6/d4/rtl_2random_8c.html#a1">Increment</a>;
00157     SharedUserData-&gt;InterruptHigh2Time = (LONG)(SharedUserData-&gt;InterruptTime &gt;&gt; 32);
00158     <a class="code" href="../../d0/d0/ki_8h.html#a66">KiTickOffset</a>                  -= <a class="code" href="../../d6/d4/rtl_2random_8c.html#a1">Increment</a>;
00159 
00160     SaveTickOffset = <a class="code" href="../../d0/d0/ki_8h.html#a66">KiTickOffset</a>;
00161 
00162     <span class="keywordflow">if</span> ((LONG)<a class="code" href="../../d0/d0/ki_8h.html#a66">KiTickOffset</a> &gt; 0)
00163     {
00164         <span class="comment">//</span>
00165         <span class="comment">// Tick has not completed (100ns time units remain).</span>
00166         <span class="comment">//</span>
00167         <span class="comment">// Determine if a timer has expired at the current hand value.</span>
00168         <span class="comment">//</span>
00169 
00170         <a class="code" href="../../d1/d9/clock_8c.html#a1">KiChkTimerExpireSysDpc</a>(<a class="code" href="../../d4/d9/ke_8h.html#a147">KeTickCount</a>); 
00171 
00172     } <span class="keywordflow">else</span> {
00173 
00174         <span class="comment">//</span>
00175         <span class="comment">// Tick has completed, tick count set to maximum increase plus any </span>
00176         <span class="comment">// residue and system time is updated.</span>
00177         <span class="comment">//</span>
00178         <span class="comment">// Compute next tick offset.</span>
00179         <span class="comment">//</span>
00180 
00181         <a class="code" href="../../d0/d0/ki_8h.html#a66">KiTickOffset</a> += <a class="code" href="../../d4/d9/ke_8h.html#a131">KeMaximumIncrement</a>;
00182         SystemTime.HighPart = SharedUserData-&gt;SystemHigh1Time;
00183         SystemTime.LowPart  = SharedUserData-&gt;SystemLowTime;
00184         SystemTime.QuadPart += <a class="code" href="../../d4/d9/ke_8h.html#a152">KeTimeAdjustment</a>;
00185         SharedUserData-&gt;SystemHigh1Time = SystemTime.HighPart;
00186         SharedUserData-&gt;SystemLowTime = SystemTime.LowPart;
00187         SharedUserData-&gt;SystemHigh2Time = SystemTime.HighPart;
00188         ++<a class="code" href="../../d4/d9/ke_8h.html#a147">KeTickCount</a>;
00189         SharedUserData-&gt;TickCountLow = (ULONG)<a class="code" href="../../d4/d9/ke_8h.html#a147">KeTickCount</a>;
00190 
00191         <span class="comment">//</span>
00192         <span class="comment">// Determine if a timer has expired at either the current hand value or </span>
00193         <span class="comment">// the next hand value.</span>
00194         <span class="comment">//</span>
00195 
00196         <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d9/clock_8c.html#a1">KiChkTimerExpireSysDpc</a>(<a class="code" href="../../d4/d9/ke_8h.html#a147">KeTickCount</a> - 1))
00197             <a class="code" href="../../d1/d9/clock_8c.html#a1">KiChkTimerExpireSysDpc</a>(<a class="code" href="../../d4/d9/ke_8h.html#a147">KeTickCount</a>);
00198 
00199     }
00200 
00201     <span class="keywordflow">if</span> (SaveTickOffset &lt;= 0) {
00202         <a class="code" href="../../d1/d9/clock_8c.html#a3">KeUpdateRunTime</a>(TrFrame);
00203     }
00204 }
00205 
00206 
00207 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00208"></a><a class="code" href="../../d1/d9/clock_8c.html#a3">00208</a> <a class="code" href="../../d1/d9/clock_8c.html#a3">KeUpdateRunTime</a> (
00209     IN PKTRAP_FRAME TrFrame
00210     )
00211 
00212 <span class="comment">/*++</span>
00213 <span class="comment"></span>
00214 <span class="comment">Routine Description:</span>
00215 <span class="comment"></span>
00216 <span class="comment">    This routine is executed on all processors in the processor complex.</span>
00217 <span class="comment">    It's function is to update the run time of the current thread, udpate the run</span>
00218 <span class="comment">    time for the thread's process, and decrement the current thread's quantum.</span>
00219 <span class="comment"></span>
00220 <span class="comment">Arguments:</span>
00221 <span class="comment"></span>
00222 <span class="comment">    TrFrame - Supplies a pointer to a trap frame.</span>
00223 <span class="comment"></span>
00224 <span class="comment">Return Value:</span>
00225 <span class="comment"></span>
00226 <span class="comment">    None.</span>
00227 <span class="comment"></span>
00228 <span class="comment">--*/</span>
00229 
00230 {
00231     KSPIN_LOCK <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>;
00232     PKPRCB    Prcb    = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00233     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>  Thread  = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00234     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>;
00235 
00236     <span class="comment">//</span>
00237     <span class="comment">// If thread was executing in user mode:</span>
00238     <span class="comment">//    increment the thread user time.</span>
00239     <span class="comment">//    atomically increment the process user time.</span>
00240     <span class="comment">// else If the old IRQL is greater than the DPC level:</span>
00241     <span class="comment">//         increment the time executing interrupt service routines.</span>
00242     <span class="comment">//      else If the old IRQL is less than the DPC level or If a DPC is not active:</span>
00243     <span class="comment">//              increment the thread kernel time.</span>
00244     <span class="comment">//              atomically increment the process kernel time.</span>
00245     <span class="comment">//      else</span>
00246     <span class="comment">//              increment time executing DPC routines.</span>
00247     <span class="comment">//</span>
00248 
00249     <span class="keywordflow">if</span> (TrFrame-&gt;PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00250         ++Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o55">UserTime</a>;
00251 
00252         <span class="comment">// Atomic Update of Process User Time required.</span>
00253         <a class="code" href="../../d8/d4/intrloc2_8c.html#a0">ExInterlockedIncrementLong</a>(&amp;Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o5">UserTime</a>, &amp;<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>);
00254 
00255         <span class="comment">// Update the time spent in user mode for the current processor.</span>
00256         ++Prcb-&gt;UserTime;           
00257     } <span class="keywordflow">else</span> {
00258 
00259         <span class="keywordflow">if</span> (TrFrame-&gt;OldIrql &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
00260             ++Prcb-&gt;InterruptTime;
00261         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((TrFrame-&gt;OldIrql &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) || 
00262                    (Prcb-&gt;DpcRoutineActive == 0)) {
00263             ++Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o54">KernelTime</a>;
00264             <a class="code" href="../../d8/d4/intrloc2_8c.html#a0">ExInterlockedIncrementLong</a>(&amp;Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o4">KernelTime</a>, &amp;<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>);
00265         } <span class="keywordflow">else</span> {
00266             ++Prcb-&gt;DpcTime;
00267         }
00268 
00269         <span class="comment">//</span>
00270         <span class="comment">// Update the time spent in kernel mode for the current processor.</span>
00271         <span class="comment">//</span>
00272 
00273         ++Prcb-&gt;KernelTime;         
00274     }
00275 
00276     <span class="comment">// </span>
00277     <span class="comment">// Update the DPC request rate which is computed as the average between the</span>
00278     <span class="comment">// previous rate and the current rate. </span>
00279     <span class="comment">// Update the DPC last count with the current DPC count.</span>
00280     <span class="comment">//</span>
00281     Prcb-&gt;DpcRequestRate = ((Prcb-&gt;DpcCount - Prcb-&gt;DpcLastCount) + Prcb-&gt;DpcRequestRate) &gt;&gt; 1;
00282     Prcb-&gt;DpcLastCount = Prcb-&gt;DpcCount;
00283 
00284     <span class="comment">//</span>
00285     <span class="comment">// If the DPC queue depth is not zero and a DPC routine is not active.</span>
00286     <span class="comment">//      Request a dispatch interrupt.</span>
00287     <span class="comment">//      Decrement the maximum DPC queue depth.</span>
00288     <span class="comment">//      Reset the threshold counter if appropriate.</span>
00289     <span class="comment">//</span>
00290     <span class="keywordflow">if</span> (Prcb-&gt;DpcQueueDepth != 0 &amp;&amp; Prcb-&gt;DpcRoutineActive == 0) {
00291 
00292         Prcb-&gt;AdjustDpcThreshold = <a class="code" href="../../d8/d0/cmdat3_8c.html#a66">KiAdjustDpcThreshold</a>;
00293 
00294         <span class="comment">// Need to request a DPC interrupt. </span>
00295         <a class="code" href="../../d9/d4/intsupc_8c.html#a3">KiRequestSoftwareInterrupt</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00296 
00297         <span class="keywordflow">if</span> (Prcb-&gt;DpcRequestRate &lt; <a class="code" href="../../d8/d0/cmdat3_8c.html#a67">KiIdealDpcRate</a> &amp;&amp; Prcb-&gt;MaximumDpcQueueDepth &gt; 1)
00298             --Prcb-&gt;MaximumDpcQueueDepth;
00299     } <span class="keywordflow">else</span> {
00300         <span class="comment">//</span>
00301         <span class="comment">// The DPC queue is empty or a DPC routine is active or a DPC interrupt</span>
00302         <span class="comment">// has been requested. Count down the adjustment threshold and if the count</span>
00303         <span class="comment">// reaches zero, then increment the maximum DPC queue depth but not above</span>
00304         <span class="comment">// the initial value. Also, reset the adjustment threshold value.</span>
00305         <span class="comment">//</span>
00306         --Prcb-&gt;AdjustDpcThreshold;
00307         <span class="keywordflow">if</span> (Prcb-&gt;AdjustDpcThreshold == 0) {
00308             Prcb-&gt;AdjustDpcThreshold = <a class="code" href="../../d8/d0/cmdat3_8c.html#a66">KiAdjustDpcThreshold</a>;
00309             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a64">KiMaximumDpcQueueDepth</a> != Prcb-&gt;MaximumDpcQueueDepth)
00310                 ++Prcb-&gt;MaximumDpcQueueDepth;
00311         }    
00312     }
00313 
00314     <span class="comment">//</span>
00315     <span class="comment">// Decrement current thread quantum and determine if quantum end has occurred.</span>
00316     <span class="comment">//</span>
00317     Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o27">Quantum</a> -= <a class="code" href="../../d4/d9/ke_8h.html#a0">CLOCK_QUANTUM_DECREMENT</a>;
00318 
00319     <span class="comment">// Set quantum end if time expired, for any thread except idle thread. </span>
00320     <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o27">Quantum</a> == 0 &amp;&amp; Thread != Prcb-&gt;IdleThread)  {
00321         
00322         Prcb-&gt;QuantumEnd = 1;
00323 
00324         <span class="comment">// Need to request a DPC interrupt. </span>
00325         <a class="code" href="../../d9/d4/intsupc_8c.html#a3">KiRequestSoftwareInterrupt</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00326     }
00327 
00328 }
00329 
00330 
00331 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00332"></a><a class="code" href="../../d1/d9/clock_8c.html#a4">00332</a> <a class="code" href="../../d1/d9/clock_8c.html#a4">KiDecrementQuantum</a> (
00333     )
00334 
00335 <span class="comment">/*++</span>
00336 <span class="comment"></span>
00337 <span class="comment">Routine Description:</span>
00338 <span class="comment"></span>
00339 <span class="comment">    This routine is executed on all processors in the processor complex.</span>
00340 <span class="comment">    Decrement current thread quantum and check to determine if a quantum end</span>
00341 <span class="comment">    has occurred.</span>
00342 <span class="comment"></span>
00343 <span class="comment">Arguments:</span>
00344 <span class="comment"></span>
00345 <span class="comment">    None.</span>
00346 <span class="comment"></span>
00347 <span class="comment">Return Value:</span>
00348 <span class="comment"></span>
00349 <span class="comment">    None.</span>
00350 <span class="comment"></span>
00351 <span class="comment">--*/</span>
00352 
00353 {
00354     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>  Thread  = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00355     PKPRCB    Prcb    = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00356 
00357     Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o27">Quantum</a> -= <a class="code" href="../../d4/d9/ke_8h.html#a0">CLOCK_QUANTUM_DECREMENT</a>;
00358 
00359     <span class="comment">// Set quantum end if time expired, for any thread except idle thread. </span>
00360     <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o27">Quantum</a> == 0 &amp;&amp; Thread != Prcb-&gt;IdleThread) 
00361         Prcb-&gt;QuantumEnd = 1;
00362 }
00363 
00364 
00365 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00366"></a><a class="code" href="../../d1/d9/clock_8c.html#a5">00366</a> <a class="code" href="../../d1/d9/clock_8c.html#a5">KeProfileInterrupt</a> (
00367     IN PKTRAP_FRAME TrFrame
00368     )
00369 <span class="comment">/*++</span>
00370 <span class="comment"></span>
00371 <span class="comment">Routine Description:</span>
00372 <span class="comment"></span>
00373 <span class="comment">    This routine is executed on all processors in the processor complex.</span>
00374 <span class="comment">    The routine is entered as the result of an interrupt generated by the profile</span>
00375 <span class="comment">    timer. Its function is to update the profile information for the currently</span>
00376 <span class="comment">    active profile objects.</span>
00377 <span class="comment"></span>
00378 <span class="comment">    N.B. KeProfileInterrupt is an alternate entry for backwards compatability that</span>
00379 <span class="comment">         sets the source to zero (ProfileTime).</span>
00380 <span class="comment"></span>
00381 <span class="comment">Arguments:</span>
00382 <span class="comment"></span>
00383 <span class="comment">    TrFrame   - Supplies a pointer to a trap frame.</span>
00384 <span class="comment"></span>
00385 <span class="comment">Return Value:</span>
00386 <span class="comment"></span>
00387 <span class="comment">    None.</span>
00388 <span class="comment"></span>
00389 <span class="comment">--*/</span>
00390 
00391 {
00392     KPROFILE_SOURCE Source = 0;
00393 
00394     <a class="code" href="../../d1/d9/clock_8c.html#a6">KeProfileInterruptWithSource</a>(TrFrame, Source);
00395 
00396     <span class="keywordflow">return</span>;
00397 }
00398 
00399 
00400 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00401"></a><a class="code" href="../../d1/d9/clock_8c.html#a6">00401</a> <a class="code" href="../../d1/d9/clock_8c.html#a6">KeProfileInterruptWithSource</a> (
00402     IN PKTRAP_FRAME    TrFrame,
00403     IN KPROFILE_SOURCE Source
00404     )
00405 <span class="comment">/*++</span>
00406 <span class="comment"></span>
00407 <span class="comment">Routine Description:</span>
00408 <span class="comment"></span>
00409 <span class="comment">    This routine is executed on all processors in the processor complex.</span>
00410 <span class="comment">    The routine is entered as the result of an interrupt generated by the profile</span>
00411 <span class="comment">    timer. Its function is to update the profile information for the currently</span>
00412 <span class="comment">    active profile objects.</span>
00413 <span class="comment"></span>
00414 <span class="comment">    N.B. KeProfileInterruptWithSource is not currently fully implemented by any of</span>
00415 <span class="comment">         the architectures.</span>
00416 <span class="comment"></span>
00417 <span class="comment">Arguments:</span>
00418 <span class="comment"></span>
00419 <span class="comment">    TrFrame - Supplies a pointer to a trap frame.</span>
00420 <span class="comment"></span>
00421 <span class="comment">    Source  - Supplies the source of the profile interrupt.</span>
00422 <span class="comment"></span>
00423 <span class="comment">Return Value:</span>
00424 <span class="comment"></span>
00425 <span class="comment">    None.</span>
00426 <span class="comment"></span>
00427 <span class="comment">--*/</span>
00428 
00429 {
00430     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>  Thread  = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00431     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>;
00432 
00433 <span class="preprocessor">#if !defined(NT_UP)    </span>
00434 <span class="preprocessor"></span>    KiAcquireSpinLock(&amp;<a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a14">KiProfileLock</a>);
00435 <span class="preprocessor">#endif </span>
00436 <span class="preprocessor"></span>
00437     <a class="code" href="../../d1/d9/clock_8c.html#a0">KiProcessProfileList</a>(TrFrame, Source, &amp;Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o1">ProfileListHead</a>);
00438 
00439     <a class="code" href="../../d1/d9/clock_8c.html#a0">KiProcessProfileList</a>(TrFrame, Source, &amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a56">KiProfileListHead</a>);        
00440 
00441 <span class="preprocessor">#if !defined(NT_UP)    </span>
00442 <span class="preprocessor"></span>    KiAcquireSpinLock(&amp;<a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a14">KiProfileLock</a>);
00443 <span class="preprocessor">#endif </span>
00444 <span class="preprocessor"></span>    <span class="keywordflow">return</span>;
00445 }
00446 
00447 
00448 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00449"></a><a class="code" href="../../d1/d9/clock_8c.html#a0">00449</a> <a class="code" href="../../d1/d9/clock_8c.html#a0">KiProcessProfileList</a> (
00450     IN PKTRAP_FRAME    TrFrame,
00451     IN KPROFILE_SOURCE Source,
00452     IN PLIST_ENTRY     ListHead
00453     )
00454 <span class="comment">/*++</span>
00455 <span class="comment"></span>
00456 <span class="comment">Routine Description:</span>
00457 <span class="comment"></span>
00458 <span class="comment">    This routine is executed on all processors in the processor complex.</span>
00459 <span class="comment">    The routine is entered as the result of an interrupt generated by the profile</span>
00460 <span class="comment">    timer. Its function is to update the profile information for the currently</span>
00461 <span class="comment">    active profile objects.</span>
00462 <span class="comment"></span>
00463 <span class="comment">    N.B. KeProfileInterruptWithSource is not currently fully implemented by any of</span>
00464 <span class="comment">         the architectures.</span>
00465 <span class="comment"></span>
00466 <span class="comment">Arguments:</span>
00467 <span class="comment"></span>
00468 <span class="comment">    TrFrame  - Supplies a pointer to a trap frame.</span>
00469 <span class="comment"></span>
00470 <span class="comment">    Source   - Supplies the source of the profile interrupt.</span>
00471 <span class="comment"></span>
00472 <span class="comment">    ListHead - Supplies a pointer to a profile list.</span>
00473 <span class="comment"></span>
00474 <span class="comment">Return Value:</span>
00475 <span class="comment"></span>
00476 <span class="comment">    None.</span>
00477 <span class="comment"></span>
00478 <span class="comment">--*/</span>
00479 
00480 {
00481     PLIST_ENTRY NextEntry = ListHead-&gt;Flink;
00482     PKPRCB Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00483 
00484     <span class="comment">//</span>
00485     <span class="comment">// Scan profile list and increment profile buckets as appropriate.</span>
00486     <span class="comment">//</span>
00487     <span class="keywordflow">for</span> (; NextEntry != ListHead; NextEntry = NextEntry-&gt;Flink) {
00488 
00489         PCHAR  BucketPter;
00490         PULONG BucketValue;
00491         
00492         <a class="code" href="../../d6/d7/struct__KPROFILE.html">PKPROFILE</a> Profile = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d6/d7/struct__KPROFILE.html">KPROFILE</a>, ProfileListEntry);
00493 
00494         <span class="keywordflow">if</span> (Profile-&gt;<a class="code" href="../../d6/d7/struct__KPROFILE.html#o10">Source</a> != Source || ((Profile-&gt;<a class="code" href="../../d6/d7/struct__KPROFILE.html#o9">Affinity</a> &amp; Prcb-&gt;SetMember) == 0))
00495             <span class="keywordflow">continue</span>;
00496         
00497         <span class="keywordflow">if</span> ((PVOID)TrFrame-&gt;StIIP &lt; Profile-&gt;<a class="code" href="../../d6/d7/struct__KPROFILE.html#o4">RangeBase</a> || (PVOID)TrFrame-&gt;StIIP &gt; Profile-&gt;<a class="code" href="../../d6/d7/struct__KPROFILE.html#o5">RangeLimit</a>)
00498             <span class="keywordflow">continue</span>;
00499 
00500         BucketPter = (PCHAR)Profile-&gt;<a class="code" href="../../d6/d7/struct__KPROFILE.html#o7">Buffer</a> +
00501                      ((((PCHAR)TrFrame-&gt;StIIP - (PCHAR)Profile-&gt;<a class="code" href="../../d6/d7/struct__KPROFILE.html#o4">RangeBase</a>)
00502                      &gt;&gt; Profile-&gt;<a class="code" href="../../d6/d7/struct__KPROFILE.html#o6">BucketShift</a>) &amp; 0xFFFFFFFC);
00503 
00504         BucketValue = (PULONG) BucketPter;
00505         ++BucketValue;
00506     }   
00507 
00508     <span class="keywordflow">return</span>;
00509 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:25 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
