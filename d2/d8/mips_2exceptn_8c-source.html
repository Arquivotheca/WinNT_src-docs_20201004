<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: exceptn.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>exceptn.c</h1><a href="../../d1/d9/mips_2exceptn_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    exceptn.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implement the code necessary to dispatch expections to the</span>
00012 <span class="comment">    proper mode and invoke the exception dispatcher.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    David N. Cutler (davec) 3-Apr-1990</span>
00017 <span class="comment"></span>
00018 <span class="comment">Environment:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Kernel mode only.</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00027 <span class="preprocessor">#pragma hdrstop</span>
<a name="l00028"></a><a class="code" href="../../d1/d9/mips_2exceptn_8c.html#a0">00028</a> <span class="preprocessor"></span><span class="preprocessor">#define HEADER_FILE</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#include "kxmips.h"</span>
00030 
00031 <span class="comment">//</span>
00032 <span class="comment">// Define multiply overflow and divide by zero breakpoint instruction values.</span>
00033 <span class="comment">//</span>
00034 
<a name="l00035"></a><a class="code" href="../../d1/d9/mips_2exceptn_8c.html#a1">00035</a> <span class="preprocessor">#define KDDEBUG_BREAKPOINT ((SPEC_OP &lt;&lt; 26) | (BREAKIN_BREAKPOINT &lt;&lt; 16) | BREAK_OP)</span>
<a name="l00036"></a><a class="code" href="../../d1/d9/mips_2exceptn_8c.html#a2">00036</a> <span class="preprocessor"></span><span class="preprocessor">#define DIVIDE_BREAKPOINT ((SPEC_OP &lt;&lt; 26) | (DIVIDE_BY_ZERO_BREAKPOINT &lt;&lt; 16) | BREAK_OP)</span>
<a name="l00037"></a><a class="code" href="../../d1/d9/mips_2exceptn_8c.html#a3">00037</a> <span class="preprocessor"></span><span class="preprocessor">#define MULTIPLY_BREAKPOINT ((SPEC_OP &lt;&lt; 26) | (MULTIPLY_OVERFLOW_BREAKPOINT &lt;&lt; 16) | BREAK_OP)</span>
<a name="l00038"></a><a class="code" href="../../d1/d9/mips_2exceptn_8c.html#a4">00038</a> <span class="preprocessor"></span><span class="preprocessor">#define OVERFLOW_BREAKPOINT ((SPEC_OP &lt;&lt; 26) | (DIVIDE_OVERFLOW_BREAKPOINT &lt;&lt; 16) | BREAK_OP)</span>
00039 <span class="preprocessor"></span>
00040 <span class="comment">//</span>
00041 <span class="comment">// Define external kernel breakpoint instruction value.</span>
00042 <span class="comment">//</span>
00043 
<a name="l00044"></a><a class="code" href="../../d1/d9/mips_2exceptn_8c.html#a5">00044</a> <span class="preprocessor">#define KERNEL_BREAKPOINT_INSTRUCTION 0x16000d</span>
00045 <span class="preprocessor"></span>
00046 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00047"></a><a class="code" href="../../d1/d9/mips_2exceptn_8c.html#a6">00047</a> <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a9">KeContextFromKframes</a> (
00048     IN PKTRAP_FRAME TrapFrame,
00049     IN PKEXCEPTION_FRAME ExceptionFrame,
00050     IN OUT PCONTEXT ContextFrame
00051     )
00052 
00053 <span class="comment">/*++</span>
00054 <span class="comment"></span>
00055 <span class="comment">Routine Description:</span>
00056 <span class="comment"></span>
00057 <span class="comment">    This routine moves the selected contents of the specified trap and exception frames</span>
00058 <span class="comment">    frames into the specified context frame according to the specified context</span>
00059 <span class="comment">    flags.</span>
00060 <span class="comment"></span>
00061 <span class="comment">Arguments:</span>
00062 <span class="comment"></span>
00063 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame from which volatile context</span>
00064 <span class="comment">        should be copied into the context record.</span>
00065 <span class="comment"></span>
00066 <span class="comment">    ExceptionFrame - Supplies a pointer to an exception frame from which context</span>
00067 <span class="comment">        should be copied into the context record.</span>
00068 <span class="comment"></span>
00069 <span class="comment">    ContextFrame - Supplies a pointer to the context frame that receives the</span>
00070 <span class="comment">        context copied from the trap and exception frames.</span>
00071 <span class="comment"></span>
00072 <span class="comment">Return Value:</span>
00073 <span class="comment"></span>
00074 <span class="comment">    None.</span>
00075 <span class="comment"></span>
00076 <span class="comment">--*/</span>
00077 
00078 {
00079 
00080     ULONG ContextFlags;
00081 
00082     <span class="comment">//</span>
00083     <span class="comment">// Set control information if specified.</span>
00084     <span class="comment">//</span>
00085 
00086     ContextFlags = ContextFrame-&gt;ContextFlags;
00087     <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) {
00088 
00089         <span class="comment">//</span>
00090         <span class="comment">// Set integer register gp, ra, sp, FIR, and PSR.</span>
00091         <span class="comment">//</span>
00092 
00093         ContextFrame-&gt;XIntGp = TrapFrame-&gt;XIntGp;
00094         ContextFrame-&gt;XIntSp = TrapFrame-&gt;XIntSp;
00095         ContextFrame-&gt;Fir = TrapFrame-&gt;Fir;
00096         ContextFrame-&gt;Psr = TrapFrame-&gt;Psr;
00097         ContextFrame-&gt;XIntRa = TrapFrame-&gt;XIntRa;
00098     }
00099 
00100     <span class="comment">//</span>
00101     <span class="comment">// Set integer register contents if specified.</span>
00102     <span class="comment">//</span>
00103 
00104     <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) {
00105 
00106         <span class="comment">//</span>
00107         <span class="comment">// Set integer registers zero, and, at - t9, k0, k1, lo, and hi.</span>
00108         <span class="comment">//</span>
00109 
00110         ContextFrame-&gt;XIntZero = 0;
00111         ContextFrame-&gt;XIntAt = TrapFrame-&gt;XIntAt;
00112         ContextFrame-&gt;XIntV0 = TrapFrame-&gt;XIntV0;
00113         ContextFrame-&gt;XIntV1 = TrapFrame-&gt;XIntV1;
00114         ContextFrame-&gt;XIntA0 = TrapFrame-&gt;XIntA0;
00115         ContextFrame-&gt;XIntA1 = TrapFrame-&gt;XIntA1;
00116         ContextFrame-&gt;XIntA2 = TrapFrame-&gt;XIntA2;
00117         ContextFrame-&gt;XIntA3 = TrapFrame-&gt;XIntA3;
00118         ContextFrame-&gt;XIntT0 = TrapFrame-&gt;XIntT0;
00119         ContextFrame-&gt;XIntT1 = TrapFrame-&gt;XIntT1;
00120         ContextFrame-&gt;XIntT2 = TrapFrame-&gt;XIntT2;
00121         ContextFrame-&gt;XIntT3 = TrapFrame-&gt;XIntT3;
00122         ContextFrame-&gt;XIntT4 = TrapFrame-&gt;XIntT4;
00123         ContextFrame-&gt;XIntT5 = TrapFrame-&gt;XIntT5;
00124         ContextFrame-&gt;XIntT6 = TrapFrame-&gt;XIntT6;
00125         ContextFrame-&gt;XIntT7 = TrapFrame-&gt;XIntT7;
00126         ContextFrame-&gt;XIntT8 = TrapFrame-&gt;XIntT8;
00127         ContextFrame-&gt;XIntT9 = TrapFrame-&gt;XIntT9;
00128         ContextFrame-&gt;XIntK0 = 0;
00129         ContextFrame-&gt;XIntK1 = 0;
00130         ContextFrame-&gt;XIntLo = TrapFrame-&gt;XIntLo;
00131         ContextFrame-&gt;XIntHi = TrapFrame-&gt;XIntHi;
00132 
00133         <span class="comment">//</span>
00134         <span class="comment">// Set integer registers s0 - s7, and s8.</span>
00135         <span class="comment">//</span>
00136 
00137         ContextFrame-&gt;XIntS0 = TrapFrame-&gt;XIntS0;
00138         ContextFrame-&gt;XIntS1 = TrapFrame-&gt;XIntS1;
00139         ContextFrame-&gt;XIntS2 = TrapFrame-&gt;XIntS2;
00140         ContextFrame-&gt;XIntS3 = TrapFrame-&gt;XIntS3;
00141         ContextFrame-&gt;XIntS4 = TrapFrame-&gt;XIntS4;
00142         ContextFrame-&gt;XIntS5 = TrapFrame-&gt;XIntS5;
00143         ContextFrame-&gt;XIntS6 = TrapFrame-&gt;XIntS6;
00144         ContextFrame-&gt;XIntS7 = TrapFrame-&gt;XIntS7;
00145         ContextFrame-&gt;XIntS8 = TrapFrame-&gt;XIntS8;
00146     }
00147 
00148     <span class="comment">//</span>
00149     <span class="comment">// Set floating register contents if specified.</span>
00150     <span class="comment">//</span>
00151 
00152     <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a154">CONTEXT_FLOATING_POINT</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a154">CONTEXT_FLOATING_POINT</a>) {
00153 
00154         <span class="comment">//</span>
00155         <span class="comment">// Set floating registers f0 - f19.</span>
00156         <span class="comment">//</span>
00157 
00158         RtlMoveMemory(&amp;ContextFrame-&gt;FltF0, &amp;TrapFrame-&gt;FltF0,
00159                      <span class="keyword">sizeof</span>(ULONG) * (20));
00160 
00161         <span class="comment">//</span>
00162         <span class="comment">// Set floating registers f20 - f31.</span>
00163         <span class="comment">//</span>
00164 
00165         RtlMoveMemory(&amp;ContextFrame-&gt;FltF20, &amp;ExceptionFrame-&gt;FltF20,
00166                      <span class="keyword">sizeof</span>(ULONG) * (12));
00167 
00168         <span class="comment">//</span>
00169         <span class="comment">// Set floating status register.</span>
00170         <span class="comment">//</span>
00171 
00172         ContextFrame-&gt;Fsr = TrapFrame-&gt;Fsr;
00173     }
00174 
00175     <span class="keywordflow">return</span>;
00176 }
00177 
00178 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00179"></a><a class="code" href="../../d1/d9/mips_2exceptn_8c.html#a7">00179</a> <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a10">KeContextToKframes</a> (
00180     IN OUT PKTRAP_FRAME TrapFrame,
00181     IN OUT PKEXCEPTION_FRAME ExceptionFrame,
00182     IN PCONTEXT ContextFrame,
00183     IN ULONG ContextFlags,
00184     IN KPROCESSOR_MODE PreviousMode
00185     )
00186 
00187 <span class="comment">/*++</span>
00188 <span class="comment"></span>
00189 <span class="comment">Routine Description:</span>
00190 <span class="comment"></span>
00191 <span class="comment">    This routine moves the selected contents of the specified context frame into</span>
00192 <span class="comment">    the specified trap and exception frames according to the specified context</span>
00193 <span class="comment">    flags.</span>
00194 <span class="comment"></span>
00195 <span class="comment">Arguments:</span>
00196 <span class="comment"></span>
00197 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame that receives the volatile</span>
00198 <span class="comment">        context from the context record.</span>
00199 <span class="comment"></span>
00200 <span class="comment">    ExceptionFrame - Supplies a pointer to an exception frame that receives</span>
00201 <span class="comment">        the nonvolatile context from the context record.</span>
00202 <span class="comment"></span>
00203 <span class="comment">    ContextFrame - Supplies a pointer to a context frame that contains the</span>
00204 <span class="comment">        context that is to be copied into the trap and exception frames.</span>
00205 <span class="comment"></span>
00206 <span class="comment">    ContextFlags - Supplies the set of flags that specify which parts of the</span>
00207 <span class="comment">        context frame are to be copied into the trap and exception frames.</span>
00208 <span class="comment"></span>
00209 <span class="comment">    PreviousMode - Supplies the processor mode for which the trap and exception</span>
00210 <span class="comment">        frames are being built.</span>
00211 <span class="comment"></span>
00212 <span class="comment">Return Value:</span>
00213 <span class="comment"></span>
00214 <span class="comment">    None.</span>
00215 <span class="comment"></span>
00216 <span class="comment">--*/</span>
00217 
00218 {
00219 
00220     <span class="comment">//</span>
00221     <span class="comment">// Set control information if specified.</span>
00222     <span class="comment">//</span>
00223 
00224     <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) {
00225 
00226         <span class="comment">//</span>
00227         <span class="comment">// Set integer register gp, sp, ra, FIR, and PSR.</span>
00228         <span class="comment">//</span>
00229 
00230         TrapFrame-&gt;XIntGp = ContextFrame-&gt;XIntGp;
00231         TrapFrame-&gt;XIntSp = ContextFrame-&gt;XIntSp;
00232         TrapFrame-&gt;Fir = ContextFrame-&gt;Fir;
00233         TrapFrame-&gt;Psr = SANITIZE_PSR(ContextFrame-&gt;Psr, PreviousMode);
00234         TrapFrame-&gt;XIntRa = ContextFrame-&gt;XIntRa;
00235     }
00236 
00237     <span class="comment">//</span>
00238     <span class="comment">// Set integer registers contents if specified.</span>
00239     <span class="comment">//</span>
00240 
00241     <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) {
00242 
00243         <span class="comment">//</span>
00244         <span class="comment">// Set integer registers at - t9, lo, and hi.</span>
00245         <span class="comment">//</span>
00246 
00247         TrapFrame-&gt;XIntAt = ContextFrame-&gt;XIntAt;
00248         TrapFrame-&gt;XIntV0 = ContextFrame-&gt;XIntV0;
00249         TrapFrame-&gt;XIntV1 = ContextFrame-&gt;XIntV1;
00250         TrapFrame-&gt;XIntA0 = ContextFrame-&gt;XIntA0;
00251         TrapFrame-&gt;XIntA1 = ContextFrame-&gt;XIntA1;
00252         TrapFrame-&gt;XIntA2 = ContextFrame-&gt;XIntA2;
00253         TrapFrame-&gt;XIntA3 = ContextFrame-&gt;XIntA3;
00254         TrapFrame-&gt;XIntT0 = ContextFrame-&gt;XIntT0;
00255         TrapFrame-&gt;XIntT1 = ContextFrame-&gt;XIntT1;
00256         TrapFrame-&gt;XIntT2 = ContextFrame-&gt;XIntT2;
00257         TrapFrame-&gt;XIntT3 = ContextFrame-&gt;XIntT3;
00258         TrapFrame-&gt;XIntT4 = ContextFrame-&gt;XIntT4;
00259         TrapFrame-&gt;XIntT5 = ContextFrame-&gt;XIntT5;
00260         TrapFrame-&gt;XIntT6 = ContextFrame-&gt;XIntT6;
00261         TrapFrame-&gt;XIntT7 = ContextFrame-&gt;XIntT7;
00262         TrapFrame-&gt;XIntT8 = ContextFrame-&gt;XIntT8;
00263         TrapFrame-&gt;XIntT9 = ContextFrame-&gt;XIntT9;
00264         TrapFrame-&gt;XIntLo = ContextFrame-&gt;XIntLo;
00265         TrapFrame-&gt;XIntHi = ContextFrame-&gt;XIntHi;
00266 
00267         <span class="comment">//</span>
00268         <span class="comment">// Set integer registers s0 - s7, and s8.</span>
00269         <span class="comment">//</span>
00270 
00271         TrapFrame-&gt;XIntS0 = ContextFrame-&gt;XIntS0;
00272         TrapFrame-&gt;XIntS1 = ContextFrame-&gt;XIntS1;
00273         TrapFrame-&gt;XIntS2 = ContextFrame-&gt;XIntS2;
00274         TrapFrame-&gt;XIntS3 = ContextFrame-&gt;XIntS3;
00275         TrapFrame-&gt;XIntS4 = ContextFrame-&gt;XIntS4;
00276         TrapFrame-&gt;XIntS5 = ContextFrame-&gt;XIntS5;
00277         TrapFrame-&gt;XIntS6 = ContextFrame-&gt;XIntS6;
00278         TrapFrame-&gt;XIntS7 = ContextFrame-&gt;XIntS7;
00279         TrapFrame-&gt;XIntS8 = ContextFrame-&gt;XIntS8;
00280     }
00281 
00282     <span class="comment">//</span>
00283     <span class="comment">// Set floating register contents if specified.</span>
00284     <span class="comment">//</span>
00285 
00286     <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a154">CONTEXT_FLOATING_POINT</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a154">CONTEXT_FLOATING_POINT</a>) {
00287 
00288         <span class="comment">//</span>
00289         <span class="comment">// Set floating registers f0 - f19.</span>
00290         <span class="comment">//</span>
00291 
00292         RtlMoveMemory(&amp;TrapFrame-&gt;FltF0, &amp;ContextFrame-&gt;FltF0,
00293                      <span class="keyword">sizeof</span>(ULONG) * (20));
00294 
00295         <span class="comment">//</span>
00296         <span class="comment">// Set floating registers f20 - f31.</span>
00297         <span class="comment">//</span>
00298 
00299         RtlMoveMemory(&amp;ExceptionFrame-&gt;FltF20, &amp;ContextFrame-&gt;FltF20,
00300                      <span class="keyword">sizeof</span>(ULONG) * (12));
00301 
00302         <span class="comment">//</span>
00303         <span class="comment">// Set floating status register.</span>
00304         <span class="comment">//</span>
00305 
00306         TrapFrame-&gt;Fsr = SANITIZE_FSR(ContextFrame-&gt;Fsr, PreviousMode);
00307     }
00308 
00309     <span class="keywordflow">return</span>;
00310 }
00311 
00312 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00313"></a><a class="code" href="../../d1/d9/mips_2exceptn_8c.html#a8">00313</a> <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a11">KiDispatchException</a> (
00314     IN PEXCEPTION_RECORD ExceptionRecord,
00315     IN PKEXCEPTION_FRAME ExceptionFrame,
00316     IN PKTRAP_FRAME TrapFrame,
00317     IN KPROCESSOR_MODE PreviousMode,
00318     IN BOOLEAN FirstChance
00319     )
00320 
00321 <span class="comment">/*++</span>
00322 <span class="comment"></span>
00323 <span class="comment">Routine Description:</span>
00324 <span class="comment"></span>
00325 <span class="comment">    This function is called to dispatch an exception to the proper mode and</span>
00326 <span class="comment">    to cause the exception dispatcher to be called.</span>
00327 <span class="comment"></span>
00328 <span class="comment">    If the exception is a data misalignment, the previous mode is user, this</span>
00329 <span class="comment">    is the first chance for handling the exception, and the current thread</span>
00330 <span class="comment">    has enabled automatic alignment fixup, then an attempt is made to emulate</span>
00331 <span class="comment">    the unaligned reference. Data misalignment exceptions are never emulated</span>
00332 <span class="comment">    for kernel mode.</span>
00333 <span class="comment"></span>
00334 <span class="comment">    If the exception is a floating exception (N.B. the pseudo status</span>
00335 <span class="comment">    STATUS_FLOAT_STACK_CHECK is used to signify this and is converted to the</span>
00336 <span class="comment">    proper code by the floating emulation routine), then an attempt is made</span>
00337 <span class="comment">    to emulate the floating operation if it is not implemented.</span>
00338 <span class="comment"></span>
00339 <span class="comment">    If the exception is neither a data misalignment nor a floating point</span>
00340 <span class="comment">    exception and the the previous mode is kernel, then the exception</span>
00341 <span class="comment">    dispatcher is called directly to process the exception. Otherwise the</span>
00342 <span class="comment">    exception record, exception frame, and trap frame contents are copied</span>
00343 <span class="comment">    to the user mode stack. The contents of the exception frame and trap</span>
00344 <span class="comment">    are then modified such that when control is returned, execution will</span>
00345 <span class="comment">    commense in user mode in a routine which will call the exception</span>
00346 <span class="comment">    dispatcher.</span>
00347 <span class="comment"></span>
00348 <span class="comment">Arguments:</span>
00349 <span class="comment"></span>
00350 <span class="comment">    ExceptionRecord - Supplies a pointer to an exception record.</span>
00351 <span class="comment"></span>
00352 <span class="comment">    ExceptionFrame - Supplies a pointer to an exception frame.</span>
00353 <span class="comment"></span>
00354 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame.</span>
00355 <span class="comment"></span>
00356 <span class="comment">    PreviousMode - Supplies the previous processor mode.</span>
00357 <span class="comment"></span>
00358 <span class="comment">    FirstChance - Supplies a boolean variable that specifies whether this</span>
00359 <span class="comment">        is the first (TRUE) or second (FALSE) time that this exception has</span>
00360 <span class="comment">        been processed.</span>
00361 <span class="comment"></span>
00362 <span class="comment">Return Value:</span>
00363 <span class="comment"></span>
00364 <span class="comment">    None.</span>
00365 <span class="comment"></span>
00366 <span class="comment">--*/</span>
00367 
00368 {
00369 
00370     CONTEXT ContextFrame;
00371     PULONG Destination;
00372     EXCEPTION_RECORD ExceptionRecord1;
00373     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00374     LONG Length;
00375     PULONGLONG Source;
00376     BOOLEAN UserApcPending;
00377     ULONG UserStack1;
00378     ULONG UserStack2;
00379 
00380     <span class="comment">//</span>
00381     <span class="comment">// If the exception is an access violation, and the previous mode is</span>
00382     <span class="comment">// user mode, then attempt to emulate a load or store operation if</span>
00383     <span class="comment">// the exception address is at the end of a page.</span>
00384     <span class="comment">//</span>
00385     <span class="comment">// N.B. The following is a workaround for a r4000 chip bug where an</span>
00386     <span class="comment">//      address privilege violation is reported as a access violation</span>
00387     <span class="comment">//      on a load or store instruction that is the last instruction</span>
00388     <span class="comment">//      in a page.</span>
00389     <span class="comment">//</span>
00390 
00391     <span class="keywordflow">if</span> ((ExceptionRecord-&gt;ExceptionCode == STATUS_ACCESS_VIOLATION) &amp;&amp;
00392         (((ULONG)ExceptionRecord-&gt;ExceptionAddress &amp; 0xffc) == 0xffc) &amp;&amp;
00393         (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) &amp;&amp;
00394         (<a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a18">KiEmulateReference</a>(ExceptionRecord, ExceptionFrame, TrapFrame) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00395         <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;KeAlignmentFixupCount += 1;
00396         <span class="keywordflow">goto</span> Handled2;
00397     }
00398 
00399     <span class="comment">//</span>
00400     <span class="comment">// If the exception is a data bus error, then process the error.</span>
00401     <span class="comment">//</span>
00402     <span class="comment">// N.B. A special exception code is used to signal a data bus error.</span>
00403     <span class="comment">//      This code is equivalent to the bug check code merged with a</span>
00404     <span class="comment">//      reserved facility code and the reserved bit set.</span>
00405     <span class="comment">//</span>
00406     <span class="comment">// N.B. If control returns, then it is assumed that the error has been</span>
00407     <span class="comment">//      corrected.</span>
00408     <span class="comment">//</span>
00409 
00410     <span class="keywordflow">if</span> (ExceptionRecord-&gt;ExceptionCode == (<a class="code" href="../../d6/d7/halmips_8h.html#a2">DATA_BUS_ERROR</a> | 0xdfff0000)) {
00411 
00412         <span class="comment">//</span>
00413         <span class="comment">// N.B. The following is a workaround for a r4000 chip bug where an</span>
00414         <span class="comment">//      address privilege violation is reported as a data bus error</span>
00415         <span class="comment">//      on a load or store instruction that is the last instruction</span>
00416         <span class="comment">//      in a page.</span>
00417         <span class="comment">//</span>
00418 
00419         <span class="keywordflow">if</span> ((ExceptionRecord-&gt;ExceptionInformation[1] &lt; 0x80000000) &amp;&amp;
00420             (((ULONG)ExceptionRecord-&gt;ExceptionAddress &amp; 0xffc) == 0xffc) &amp;&amp;
00421             (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>)) {
00422             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a18">KiEmulateReference</a>(ExceptionRecord, ExceptionFrame, TrapFrame) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00423                 <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;KeAlignmentFixupCount += 1;
00424                 <span class="keywordflow">goto</span> Handled2;
00425             }
00426         }
00427 
00428         <a class="code" href="../../d1/d2/mips_2buserror_8c.html#a2">KiDataBusError</a>(ExceptionRecord, ExceptionFrame, TrapFrame);
00429         <span class="keywordflow">goto</span> Handled2;
00430     }
00431 
00432     <span class="comment">//</span>
00433     <span class="comment">// If the exception is an instruction bus error, then process the error.</span>
00434     <span class="comment">//</span>
00435     <span class="comment">// N.B. A special exception code is used to signal an instruction bus</span>
00436     <span class="comment">//      error. This code is equivalent to the bug check code merged</span>
00437     <span class="comment">//      with a reserved facility code and the reserved bit set.</span>
00438     <span class="comment">//</span>
00439     <span class="comment">// N.B. If control returns, then it is assumed that the error hand been</span>
00440     <span class="comment">//      corrected.</span>
00441     <span class="comment">//</span>
00442 
00443     <span class="keywordflow">if</span> (ExceptionRecord-&gt;ExceptionCode == (<a class="code" href="../../d6/d7/halmips_8h.html#a5">INSTRUCTION_BUS_ERROR</a> | 0xdfff0000)) {
00444         <a class="code" href="../../d1/d2/mips_2buserror_8c.html#a3">KiInstructionBusError</a>(ExceptionRecord, ExceptionFrame, TrapFrame);
00445         <span class="keywordflow">goto</span> Handled2;
00446     }
00447 
00448     <span class="comment">//</span>
00449     <span class="comment">// If the exception is a data misalignment, this is the first change for</span>
00450     <span class="comment">// handling the exception, and the current thread has enabled automatic</span>
00451     <span class="comment">// alignment fixup, then attempt to emulate the unaligned reference.</span>
00452     <span class="comment">//</span>
00453 
00454     <span class="keywordflow">if</span> ((ExceptionRecord-&gt;ExceptionCode == STATUS_DATATYPE_MISALIGNMENT) &amp;&amp;
00455         (FirstChance != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
00456         ((<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;AutoAlignment != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ||
00457          (<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;ApcState.Process-&gt;AutoAlignment != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ||
00458          (((ExceptionRecord-&gt;ExceptionInformation[1] &amp; 0x7fff0000) == 0x7fff0000) &amp;&amp;
00459          (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>))) &amp;&amp;
00460         (<a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a18">KiEmulateReference</a>(ExceptionRecord, ExceptionFrame, TrapFrame) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00461         <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;KeAlignmentFixupCount += 1;
00462         <span class="keywordflow">goto</span> Handled2;
00463     }
00464 
00465     <span class="comment">//</span>
00466     <span class="comment">// If the exception is a floating exception, then attempt to emulate the</span>
00467     <span class="comment">// operation.</span>
00468     <span class="comment">//</span>
00469     <span class="comment">// N.B. The pseudo status STATUS_FLOAT_STACK_CHECK is used to signify</span>
00470     <span class="comment">//      that the exception is a floating exception and that this it the</span>
00471     <span class="comment">//      first chance for handling the exception. The floating emulation</span>
00472     <span class="comment">//      routine converts the status code to the proper floating status</span>
00473     <span class="comment">//      value.</span>
00474     <span class="comment">//</span>
00475 
00476     <span class="keywordflow">if</span> ((ExceptionRecord-&gt;ExceptionCode == STATUS_FLOAT_STACK_CHECK) &amp;&amp;
00477         (<a class="code" href="../../d3/d4/mips_2floatem_8c.html#a32">KiEmulateFloating</a>(ExceptionRecord, ExceptionFrame, TrapFrame) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00478         TrapFrame-&gt;Fsr = SANITIZE_FSR(TrapFrame-&gt;Fsr, PreviousMode);
00479         <span class="keywordflow">goto</span> Handled2;
00480     }
00481 
00482     <span class="comment">//</span>
00483     <span class="comment">// If the exception is a breakpoint, then translate it to an appropriate</span>
00484     <span class="comment">// exception code if it is a division by zero or an integer overflow</span>
00485     <span class="comment">// caused by multiplication.</span>
00486     <span class="comment">//</span>
00487 
00488     <span class="keywordflow">if</span> (ExceptionRecord-&gt;ExceptionCode == STATUS_BREAKPOINT) {
00489         <span class="keywordflow">if</span> (ExceptionRecord-&gt;ExceptionInformation[0] == <a class="code" href="../../d1/d9/mips_2exceptn_8c.html#a2">DIVIDE_BREAKPOINT</a>) {
00490             ExceptionRecord-&gt;ExceptionCode = STATUS_INTEGER_DIVIDE_BY_ZERO;
00491 
00492         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((ExceptionRecord-&gt;ExceptionInformation[0] == <a class="code" href="../../d1/d9/mips_2exceptn_8c.html#a3">MULTIPLY_BREAKPOINT</a>) ||
00493                    (ExceptionRecord-&gt;ExceptionInformation[0] == <a class="code" href="../../d1/d9/mips_2exceptn_8c.html#a4">OVERFLOW_BREAKPOINT</a>)) {
00494             ExceptionRecord-&gt;ExceptionCode = STATUS_INTEGER_OVERFLOW;
00495 
00496         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ExceptionRecord-&gt;ExceptionInformation[0] == <a class="code" href="../../d1/d9/mips_2exceptn_8c.html#a1">KDDEBUG_BREAKPOINT</a>) {
00497             TrapFrame-&gt;Fir += 4;
00498         }
00499     }
00500 
00501     <span class="comment">//</span>
00502     <span class="comment">// Move machine state from trap and exception frames to a context frame,</span>
00503     <span class="comment">// and increment the number of exceptions dispatched.</span>
00504     <span class="comment">//</span>
00505 
00506     ContextFrame.ContextFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a152">CONTEXT_FULL</a>;
00507     <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a9">KeContextFromKframes</a>(TrapFrame, ExceptionFrame, &amp;ContextFrame);
00508     <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;KeExceptionDispatchCount += 1;
00509 
00510     <span class="comment">//</span>
00511     <span class="comment">// Select the method of handling the exception based on the previous mode.</span>
00512     <span class="comment">//</span>
00513 
00514     <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00515 
00516         <span class="comment">//</span>
00517         <span class="comment">// Previous mode was kernel.</span>
00518         <span class="comment">//</span>
00519         <span class="comment">// If this is the first chance, the kernel debugger is active, and</span>
00520         <span class="comment">// the exception is a kernel breakpoint, then give the kernel debugger</span>
00521         <span class="comment">// a chance to handle the exception.</span>
00522         <span class="comment">//</span>
00523         <span class="comment">// If this is the first chance and the kernel debugger is not active</span>
00524         <span class="comment">// or does not handle the exception, then attempt to find a frame</span>
00525         <span class="comment">// handler to handle the exception.</span>
00526         <span class="comment">//</span>
00527         <span class="comment">// If this is the second chance or the exception is not handled, then</span>
00528         <span class="comment">// if the kernel debugger is active, then give the kernel debugger a</span>
00529         <span class="comment">// second chance to handle the exception. If the kernel debugger does</span>
00530         <span class="comment">// not handle the exception, then bug check.</span>
00531         <span class="comment">//</span>
00532 
00533         <span class="keywordflow">if</span> (FirstChance != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00534 
00535             <span class="comment">//</span>
00536             <span class="comment">// If the kernel debugger is active, the exception is a breakpoint,</span>
00537             <span class="comment">// and the breakpoint is handled by the kernel debugger, then give</span>
00538             <span class="comment">// the kernel debugger a chance to handle the exception.</span>
00539             <span class="comment">//</span>
00540 
00541             <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00542                (ExceptionRecord-&gt;ExceptionCode == STATUS_BREAKPOINT) &amp;&amp;
00543                (<a class="code" href="../../d3/d9/4_2ia64_2kdtrap_8c.html#a1">KdIsThisAKdTrap</a>(ExceptionRecord,
00544                                 &amp;ContextFrame,
00545                                 <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00546 
00547                 <span class="keywordflow">if</span> (((<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a>) (TrapFrame,
00548                                        ExceptionFrame,
00549                                        ExceptionRecord,
00550                                        &amp;ContextFrame,
00551                                        <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00552                                        <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00553 
00554                     <span class="keywordflow">goto</span> Handled1;
00555                 }
00556             }
00557 
00558             <span class="comment">//</span>
00559             <span class="comment">// This is the first chance to handle the exception.</span>
00560             <span class="comment">//</span>
00561 
00562             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a7">RtlDispatchException</a>(ExceptionRecord, &amp;ContextFrame) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00563                 <span class="keywordflow">goto</span> Handled1;
00564             }
00565         }
00566 
00567         <span class="comment">//</span>
00568         <span class="comment">// This is the second chance to handle the exception.</span>
00569         <span class="comment">//</span>
00570 
00571         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00572             <span class="keywordflow">if</span> (((<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a>) (TrapFrame,
00573                                    ExceptionFrame,
00574                                    ExceptionRecord,
00575                                    &amp;ContextFrame,
00576                                    PreviousMode,
00577                                    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00578                 <span class="keywordflow">goto</span> Handled1;
00579             }
00580         }
00581 
00582         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a13">KMODE_EXCEPTION_NOT_HANDLED</a>,
00583                      ExceptionRecord-&gt;ExceptionCode,
00584                      (ULONG)ExceptionRecord-&gt;ExceptionAddress,
00585                      ExceptionRecord-&gt;ExceptionInformation[0],
00586                      ExceptionRecord-&gt;ExceptionInformation[1]);
00587 
00588     } <span class="keywordflow">else</span> {
00589 
00590         <span class="comment">//</span>
00591         <span class="comment">// Previous mode was user.</span>
00592         <span class="comment">//</span>
00593         <span class="comment">// If this is the first chance, the kernel debugger is active, the</span>
00594         <span class="comment">// exception is a kernel breakpoint, and the current process is not</span>
00595         <span class="comment">// being debugged, or the current process is being debugged, but the</span>
00596         <span class="comment">// the breakpoint is not a kernel breakpoint instruction, then give</span>
00597         <span class="comment">// the kernel debugger a chance to handle the exception.</span>
00598         <span class="comment">//</span>
00599         <span class="comment">// If this is the first chance and the current process has a debugger</span>
00600         <span class="comment">// port, then send a message to the debugger port and wait for a reply.</span>
00601         <span class="comment">// If the debugger handles the exception, then continue execution. Else</span>
00602         <span class="comment">// transfer the exception information to the user stack, transition to</span>
00603         <span class="comment">// user mode, and attempt to dispatch the exception to a frame based</span>
00604         <span class="comment">// handler. If a frame based handler handles the exception, then continue</span>
00605         <span class="comment">// execution. Otherwise, execute the raise exception system service</span>
00606         <span class="comment">// which will call this routine a second time to process the exception.</span>
00607         <span class="comment">//</span>
00608         <span class="comment">// If this is the second chance and the current process has a debugger</span>
00609         <span class="comment">// port, then send a message to the debugger port and wait for a reply.</span>
00610         <span class="comment">// If the debugger handles the exception, then continue execution. Else</span>
00611         <span class="comment">// if the current process has a subsystem port, then send a message to</span>
00612         <span class="comment">// the subsystem port and wait for a reply. If the subsystem handles the</span>
00613         <span class="comment">// exception, then continue execution. Else terminate the thread.</span>
00614         <span class="comment">//</span>
00615 
00616         <span class="keywordflow">if</span> (FirstChance != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00617 
00618             <span class="comment">//</span>
00619             <span class="comment">// If the kernel debugger is active, the exception is a kernel</span>
00620             <span class="comment">// breakpoint, and the current process is not being debugged,</span>
00621             <span class="comment">// or the current process is being debugged, but the breakpoint</span>
00622             <span class="comment">// is not a kernel breakpoint instruction, then give the kernel</span>
00623             <span class="comment">// debugger a chance to handle the exception.</span>
00624             <span class="comment">//</span>
00625 
00626             <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00627                (ExceptionRecord-&gt;ExceptionCode == STATUS_BREAKPOINT) &amp;&amp;
00628                (<a class="code" href="../../d3/d9/4_2ia64_2kdtrap_8c.html#a1">KdIsThisAKdTrap</a>(ExceptionRecord,
00629                                 &amp;ContextFrame,
00630                                 <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
00631                ((<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;DebugPort == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00632                ((<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;DebugPort != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00633                (ExceptionRecord-&gt;ExceptionInformation[0] !=
00634                                             <a class="code" href="../../d1/d9/mips_2exceptn_8c.html#a5">KERNEL_BREAKPOINT_INSTRUCTION</a>)))) {
00635 
00636                <span class="keywordflow">if</span> (((<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a>) (TrapFrame,
00637                                       ExceptionFrame,
00638                                       ExceptionRecord,
00639                                       &amp;ContextFrame,
00640                                       <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
00641                                       <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00642 
00643                     <span class="keywordflow">goto</span> Handled1;
00644                 }
00645             }
00646 
00647             <span class="comment">//</span>
00648             <span class="comment">// This is the first chance to handle the exception.</span>
00649             <span class="comment">//</span>
00650 
00651             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d3/dbgk_8h.html#a5">DbgkForwardException</a>(ExceptionRecord, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00652                 TrapFrame-&gt;Fsr = SANITIZE_FSR(TrapFrame-&gt;Fsr, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00653                 <span class="keywordflow">goto</span> Handled2;
00654             }
00655 
00656             <span class="comment">//</span>
00657             <span class="comment">// Transfer exception information to the user stack, transition</span>
00658             <span class="comment">// to user mode, and attempt to dispatch the exception to a frame</span>
00659             <span class="comment">// based handler.</span>
00660             <span class="comment">//</span>
00661 
00662         repeat:
00663             <span class="keywordflow">try</span> {
00664 
00665                 <span class="comment">//</span>
00666                 <span class="comment">// Coerce the 64-bit integer register context to 32-bits</span>
00667                 <span class="comment">// and store in the 32-bit context area of the context</span>
00668                 <span class="comment">// record.</span>
00669                 <span class="comment">//</span>
00670                 <span class="comment">// N.B. This only works becasue the 32- and 64-bit integer</span>
00671                 <span class="comment">//      register context does not overlap in the context</span>
00672                 <span class="comment">//      record.</span>
00673                 <span class="comment">//</span>
00674 
00675                 Destination = &amp;ContextFrame.IntZero;
00676                 Source = &amp;ContextFrame.XIntZero;
00677                 <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; 32; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00678                     *Destination++ = (ULONG)*Source++;
00679                 }
00680 
00681                 <span class="comment">//</span>
00682                 <span class="comment">// Compute length of exception record and new aligned stack</span>
00683                 <span class="comment">// address.</span>
00684                 <span class="comment">//</span>
00685 
00686                 Length = (<span class="keyword">sizeof</span>(EXCEPTION_RECORD) + 7) &amp; (~7);
00687                 UserStack1 = (ULONG)(ContextFrame.XIntSp &amp; (~7)) - Length;
00688 
00689                 <span class="comment">//</span>
00690                 <span class="comment">// Probe user stack area for writeability and then transfer the</span>
00691                 <span class="comment">// exception record to the user stack area.</span>
00692                 <span class="comment">//</span>
00693 
00694                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>((PCHAR)UserStack1, Length, <span class="keyword">sizeof</span>(QUAD));
00695                 RtlMoveMemory((PVOID)UserStack1, ExceptionRecord, Length);
00696 
00697                 <span class="comment">//</span>
00698                 <span class="comment">// Compute length of context record and new aligned user stack</span>
00699                 <span class="comment">// pointer.</span>
00700                 <span class="comment">//</span>
00701 
00702                 Length = <span class="keyword">sizeof</span>(CONTEXT);
00703                 UserStack2 = UserStack1 - Length;
00704 
00705                 <span class="comment">//</span>
00706                 <span class="comment">// Probe user stack area for writeability and then transfer the</span>
00707                 <span class="comment">// context record to the user stack.</span>
00708                 <span class="comment">//</span>
00709 
00710                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>((PCHAR)UserStack2, Length, <span class="keyword">sizeof</span>(QUAD));
00711                 RtlMoveMemory((PVOID)UserStack2, &amp;ContextFrame, <span class="keyword">sizeof</span>(CONTEXT));
00712 
00713                 <span class="comment">//</span>
00714                 <span class="comment">// Set address of exception record, context record, and the</span>
00715                 <span class="comment">// and the new stack pointer in the current trap frame.</span>
00716                 <span class="comment">//</span>
00717 
00718                 TrapFrame-&gt;XIntSp = (LONG)UserStack2;
00719                 TrapFrame-&gt;XIntS8 = (LONG)UserStack2;
00720                 TrapFrame-&gt;XIntS0 = (LONG)UserStack1;
00721                 TrapFrame-&gt;XIntS1 = (LONG)UserStack2;
00722 
00723                 <span class="comment">//</span>
00724                 <span class="comment">// Sanitize the floating status register so a recursive</span>
00725                 <span class="comment">// exception will not occur.</span>
00726                 <span class="comment">//</span>
00727 
00728                 TrapFrame-&gt;Fsr = SANITIZE_FSR(ContextFrame.Fsr, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00729 
00730                 <span class="comment">//</span>
00731                 <span class="comment">// Set the address of the exception routine that will call the</span>
00732                 <span class="comment">// exception dispatcher and then return to the trap handler.</span>
00733                 <span class="comment">// The trap handler will restore the exception and trap frame</span>
00734                 <span class="comment">// context and continue execution in the routine that will</span>
00735                 <span class="comment">// call the exception dispatcher.</span>
00736                 <span class="comment">//</span>
00737 
00738                 TrapFrame-&gt;Fir = <a class="code" href="../../d4/d9/ke_8h.html#a150">KeUserExceptionDispatcher</a>;
00739                 <span class="keywordflow">return</span>;
00740 
00741             <span class="comment">//</span>
00742             <span class="comment">// If an exception occurs, then copy the new exception information</span>
00743             <span class="comment">// to an exception record and handle the exception.</span>
00744             <span class="comment">//</span>
00745 
00746             } except (<a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a12">KiCopyInformation</a>(&amp;ExceptionRecord1,
00747                                (GetExceptionInformation())-&gt;ExceptionRecord)) {
00748 
00749                 <span class="comment">//</span>
00750                 <span class="comment">// If the exception is a stack overflow, then attempt</span>
00751                 <span class="comment">// to raise the stack overflow exception. Otherwise,</span>
00752                 <span class="comment">// the user's stack is not accessible, or is misaligned,</span>
00753                 <span class="comment">// and second chance processing is performed.</span>
00754                 <span class="comment">//</span>
00755 
00756                 <span class="keywordflow">if</span> (ExceptionRecord1.ExceptionCode == STATUS_STACK_OVERFLOW) {
00757                     ExceptionRecord1.ExceptionAddress = ExceptionRecord-&gt;ExceptionAddress;
00758                     RtlMoveMemory((PVOID)ExceptionRecord,
00759                                   &amp;ExceptionRecord1, <span class="keyword">sizeof</span>(EXCEPTION_RECORD));
00760                     <span class="keywordflow">goto</span> repeat;
00761                 }
00762             }
00763         }
00764 
00765         <span class="comment">//</span>
00766         <span class="comment">// This is the second chance to handle the exception.</span>
00767         <span class="comment">//</span>
00768 
00769         UserApcPending = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;ApcState.UserApcPending;
00770         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d3/dbgk_8h.html#a5">DbgkForwardException</a>(ExceptionRecord, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00771             TrapFrame-&gt;Fsr = SANITIZE_FSR(TrapFrame-&gt;Fsr, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00772             <span class="keywordflow">goto</span> Handled2;
00773 
00774         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d3/dbgk_8h.html#a5">DbgkForwardException</a>(ExceptionRecord, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00775 
00776             <span class="comment">//</span>
00777             <span class="comment">// If a user APC was not previously pending and one is now</span>
00778             <span class="comment">// pending, then the thread has been terminated and the PC</span>
00779             <span class="comment">// must be forced to a legal address so an infinite loop does</span>
00780             <span class="comment">// not occur for the case where a jump to an unmapped address</span>
00781             <span class="comment">// occured.</span>
00782             <span class="comment">//</span>
00783 
00784             <span class="keywordflow">if</span> ((UserApcPending == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
00785                 (<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;ApcState.UserApcPending != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00786                 TrapFrame-&gt;Fir = (ULONG)USPCR;
00787             }
00788 
00789             TrapFrame-&gt;Fsr = SANITIZE_FSR(TrapFrame-&gt;Fsr, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00790             <span class="keywordflow">goto</span> Handled2;
00791 
00792         } <span class="keywordflow">else</span> {
00793             ZwTerminateProcess(NtCurrentProcess(), ExceptionRecord-&gt;ExceptionCode);
00794             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a13">KMODE_EXCEPTION_NOT_HANDLED</a>,
00795                          ExceptionRecord-&gt;ExceptionCode,
00796                          (ULONG)ExceptionRecord-&gt;ExceptionAddress,
00797                          ExceptionRecord-&gt;ExceptionInformation[0],
00798                          ExceptionRecord-&gt;ExceptionInformation[1]);
00799         }
00800     }
00801 
00802     <span class="comment">//</span>
00803     <span class="comment">// Move machine state from context frame to trap and exception frames and</span>
00804     <span class="comment">// then return to continue execution with the restored state.</span>
00805     <span class="comment">//</span>
00806 
00807 Handled1:
00808     <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a10">KeContextToKframes</a>(TrapFrame, ExceptionFrame, &amp;ContextFrame,
00809                        ContextFrame.ContextFlags, PreviousMode);
00810 
00811     <span class="comment">//</span>
00812     <span class="comment">// Exception was handled by the debugger or the associated subsystem</span>
00813     <span class="comment">// and state was modified, if necessary, using the get state and set</span>
00814     <span class="comment">// state capabilities. Therefore the context frame does not need to</span>
00815     <span class="comment">// be transfered to the trap and exception frames.</span>
00816     <span class="comment">//</span>
00817 
00818 Handled2:
00819     <span class="keywordflow">return</span>;
00820 }
00821 
00822 ULONG
<a name="l00823"></a><a class="code" href="../../d1/d9/mips_2exceptn_8c.html#a9">00823</a> <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a12">KiCopyInformation</a> (
00824     IN OUT PEXCEPTION_RECORD ExceptionRecord1,
00825     IN PEXCEPTION_RECORD ExceptionRecord2
00826     )
00827 
00828 <span class="comment">/*++</span>
00829 <span class="comment"></span>
00830 <span class="comment">Routine Description:</span>
00831 <span class="comment"></span>
00832 <span class="comment">    This function is called from an exception filter to copy the exception</span>
00833 <span class="comment">    information from one exception record to another when an exception occurs.</span>
00834 <span class="comment"></span>
00835 <span class="comment">Arguments:</span>
00836 <span class="comment"></span>
00837 <span class="comment">    ExceptionRecord1 - Supplies a pointer to the destination exception record.</span>
00838 <span class="comment"></span>
00839 <span class="comment">    ExceptionRecord2 - Supplies a pointer to the source exception record.</span>
00840 <span class="comment"></span>
00841 <span class="comment">Return Value:</span>
00842 <span class="comment"></span>
00843 <span class="comment">    A value of EXCEPTION_EXECUTE_HANDLER is returned as the function value.</span>
00844 <span class="comment"></span>
00845 <span class="comment">--*/</span>
00846 
00847 {
00848 
00849     <span class="comment">//</span>
00850     <span class="comment">// Copy one exception record to another and return value that causes</span>
00851     <span class="comment">// an exception handler to be executed.</span>
00852     <span class="comment">//</span>
00853 
00854     RtlMoveMemory((PVOID)ExceptionRecord1,
00855                   (PVOID)ExceptionRecord2,
00856                   <span class="keyword">sizeof</span>(EXCEPTION_RECORD));
00857 
00858     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>;
00859 }
00860 
00861 
00862 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00863"></a><a class="code" href="../../d1/d9/mips_2exceptn_8c.html#a10">00863</a> <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a13">KeRaiseUserException</a>(
00864     IN NTSTATUS ExceptionCode
00865     )
00866 
00867 <span class="comment">/*++</span>
00868 <span class="comment"></span>
00869 <span class="comment">Routine Description:</span>
00870 <span class="comment"></span>
00871 <span class="comment">    This function causes an exception to be raised in the calling thread's</span>
00872 <span class="comment">    usermode context. This is accomplished by editing the trap frame the</span>
00873 <span class="comment">    kernel was entered with to point to trampoline code that raises the</span>
00874 <span class="comment">    requested exception.</span>
00875 <span class="comment"></span>
00876 <span class="comment">Arguments:</span>
00877 <span class="comment"></span>
00878 <span class="comment">    ExceptionCode - Supplies the status value to be used as the exception</span>
00879 <span class="comment">        code for the exception that is to be raised.</span>
00880 <span class="comment"></span>
00881 <span class="comment">Return Value:</span>
00882 <span class="comment"></span>
00883 <span class="comment">    The status value that should be returned by the caller.</span>
00884 <span class="comment"></span>
00885 <span class="comment">--*/</span>
00886 
00887 {
00888 
00889     PKTRAP_FRAME TrapFrame;
00890 
00891     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetPreviousMode() == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00892 
00893     TrapFrame = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;TrapFrame;
00894     TrapFrame-&gt;Fir = <a class="code" href="../../d4/d9/ke_8h.html#a151">KeRaiseUserExceptionDispatcher</a>;
00895     <span class="keywordflow">return</span> ExceptionCode;
00896 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:57 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
