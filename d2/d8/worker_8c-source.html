<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: worker.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>worker.c</h1><a href="../../d1/d9/worker_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/*++</span>
00003 <span class="comment"></span>
00004 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00005 <span class="comment"></span>
00006 <span class="comment">Module Name:</span>
00007 <span class="comment"></span>
00008 <span class="comment">    worker.c</span>
00009 <span class="comment"></span>
00010 <span class="comment">Abstract:</span>
00011 <span class="comment"></span>
00012 <span class="comment">    This module implements a worker thread and a set of functions for</span>
00013 <span class="comment">    passing work to it.</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    Steve Wood (stevewo) 25-Jul-1991</span>
00018 <span class="comment"></span>
00019 <span class="comment"></span>
00020 <span class="comment">Revision History:</span>
00021 <span class="comment"></span>
00022 <span class="comment">--*/</span>
00023 
00024 <span class="preprocessor">#include "<a class="code" href="../../d4/d0/exp_8h.html">exp.h</a>"</span>
00025 
00026 <span class="comment">//</span>
00027 <span class="comment">// Define balance set wait object types.</span>
00028 <span class="comment">//</span>
00029 
<a name="l00030"></a><a class="code" href="../../d1/d9/worker_8c.html#a31">00030</a> <span class="keyword">typedef</span> <span class="keyword">enum</span> <a class="code" href="../../d1/d9/worker_8c.html#a31">_BALANCE_OBJECT</a> {
00031     <a class="code" href="../../d1/d9/worker_8c.html#a31a18">TimerExpiration</a>,
00032     <a class="code" href="../../d1/d9/worker_8c.html#a31a19">ThreadSetManagerEvent</a>,
00033     <a class="code" href="../../d1/d9/worker_8c.html#a31a20">MaximumBalanceObject</a>
00034 } <a class="code" href="../../d1/d9/worker_8c.html#a11">BALANCE_OBJECT</a>;
00035 
00036 <span class="comment">//</span>
00037 <span class="comment">// If this assertion fails then we must supply our own array of wait blocks.</span>
00038 <span class="comment">//</span>
00039 
00040 <a class="code" href="../../d1/d9/worker_8c.html#a21">C_ASSERT</a>(MaximumBalanceObject &lt; THREAD_WAIT_OBJECTS);
00041 
00042 <span class="comment">//</span>
00043 <span class="comment">// Define priorities for delayed and critical worker threads. Note that these do not run</span>
00044 <span class="comment">// at realtime. They run at csrss and below csrss to avoid pre-empting the</span>
00045 <span class="comment">// user interface under heavy load.</span>
00046 <span class="comment">//</span>
00047 
<a name="l00048"></a><a class="code" href="../../d1/d9/worker_8c.html#a0">00048</a> <span class="preprocessor">#define DELAYED_WORK_QUEUE_PRIORITY         (12 - NORMAL_BASE_PRIORITY)</span>
<a name="l00049"></a><a class="code" href="../../d1/d9/worker_8c.html#a1">00049</a> <span class="preprocessor"></span><span class="preprocessor">#define CRITICAL_WORK_QUEUE_PRIORITY        (13 - NORMAL_BASE_PRIORITY)</span>
<a name="l00050"></a><a class="code" href="../../d1/d9/worker_8c.html#a2">00050</a> <span class="preprocessor"></span><span class="preprocessor">#define HYPER_CRITICAL_WORK_QUEUE_PRIORITY  (15 - NORMAL_BASE_PRIORITY)</span>
00051 <span class="preprocessor"></span>
00052 <span class="comment">//</span>
00053 <span class="comment">// Number of worker threads to create for each type of system.</span>
00054 <span class="comment">//</span>
00055 
<a name="l00056"></a><a class="code" href="../../d1/d9/worker_8c.html#a3">00056</a> <span class="preprocessor">#define MAX_ADDITIONAL_THREADS 16</span>
<a name="l00057"></a><a class="code" href="../../d1/d9/worker_8c.html#a4">00057</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_ADDITIONAL_DYNAMIC_THREADS 16</span>
00058 <span class="preprocessor"></span>
<a name="l00059"></a><a class="code" href="../../d1/d9/worker_8c.html#a5">00059</a> <span class="preprocessor">#define SMALL_NUMBER_OF_THREADS 2</span>
<a name="l00060"></a><a class="code" href="../../d1/d9/worker_8c.html#a6">00060</a> <span class="preprocessor"></span><span class="preprocessor">#define MEDIUM_NUMBER_OF_THREADS 3</span>
<a name="l00061"></a><a class="code" href="../../d1/d9/worker_8c.html#a7">00061</a> <span class="preprocessor"></span><span class="preprocessor">#define LARGE_NUMBER_OF_THREADS 5</span>
00062 <span class="preprocessor"></span>
00063 <span class="comment">//</span>
00064 <span class="comment">// 10-minute timeout used for terminating dynamic work item worker threads.</span>
00065 <span class="comment">//</span>
00066 
<a name="l00067"></a><a class="code" href="../../d1/d9/worker_8c.html#a8">00067</a> <span class="preprocessor">#define DYNAMIC_THREAD_TIMEOUT ((LONGLONG)10 * 60 * 1000 * 1000 * 10)</span>
00068 <span class="preprocessor"></span>
00069 <span class="comment">//</span>
00070 <span class="comment">// 1-second timeout used for waking up the worker thread set manager.</span>
00071 <span class="comment">//</span>
00072 
<a name="l00073"></a><a class="code" href="../../d1/d9/worker_8c.html#a9">00073</a> <span class="preprocessor">#define THREAD_SET_INTERVAL (1 * 1000 * 1000 * 10)</span>
00074 <span class="preprocessor"></span>
00075 <span class="comment">//</span>
00076 <span class="comment">// Flag to pass in to the worker thread, indicating whether it is dynamic</span>
00077 <span class="comment">// or not. </span>
00078 <span class="comment">//</span>
00079 
<a name="l00080"></a><a class="code" href="../../d1/d9/worker_8c.html#a10">00080</a> <span class="preprocessor">#define DYNAMIC_WORKER_THREAD 0x80000000</span>
00081 <span class="preprocessor"></span>
00082 <span class="comment">//</span>
00083 <span class="comment">// Per-queue dynamic thread state.</span>
00084 <span class="comment">//</span>
00085 
<a name="l00086"></a><a class="code" href="../../d1/d9/worker_8c.html#a12">00086</a> <a class="code" href="../../d8/d7/struct__EX__WORK__QUEUE.html">EX_WORK_QUEUE</a> <a class="code" href="../../d1/d9/worker_8c.html#a12">ExWorkerQueue</a>[<a class="code" href="../../d5/d8/ex_8h.html#a332a208">MaximumWorkQueue</a>];
00087 
00088 <span class="comment">//</span>
00089 <span class="comment">// Additional worker threads... Controlled using registry settings</span>
00090 <span class="comment">//</span>
00091 
<a name="l00092"></a><a class="code" href="../../d1/d9/worker_8c.html#a13">00092</a> ULONG <a class="code" href="../../d8/d0/cmdat3_8c.html#a50">ExpAdditionalCriticalWorkerThreads</a>;
<a name="l00093"></a><a class="code" href="../../d1/d9/worker_8c.html#a14">00093</a> ULONG <a class="code" href="../../d8/d0/cmdat3_8c.html#a51">ExpAdditionalDelayedWorkerThreads</a>;
00094 
<a name="l00095"></a><a class="code" href="../../d1/d9/worker_8c.html#a15">00095</a> ULONG <a class="code" href="../../d1/d9/worker_8c.html#a15">ExCriticalWorkerThreads</a>;
<a name="l00096"></a><a class="code" href="../../d1/d9/worker_8c.html#a16">00096</a> ULONG <a class="code" href="../../d1/d9/worker_8c.html#a16">ExDelayedWorkerThreads</a>;
00097 
00098 <span class="comment">//</span>
00099 <span class="comment">// Global event to wake up the thread set manager.</span>
00100 <span class="comment">//</span>
00101 
<a name="l00102"></a><a class="code" href="../../d1/d9/worker_8c.html#a17">00102</a> <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d1/d9/worker_8c.html#a17">ExThreadSetManagerEvent</a>;
00103 
00104 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00105 <a class="code" href="../../d1/d9/worker_8c.html#a22">ExpCheckDynamicThreadCount</a>( VOID );
00106 
00107 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00108 <a class="code" href="../../d1/d9/worker_8c.html#a23">ExpCreateWorkerThread</a>(
00109     <a class="code" href="../../d5/d8/ex_8h.html#a110">WORK_QUEUE_TYPE</a> QueueType,
00110     BOOLEAN Dynamic
00111     );
00112     
00113 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00114 <a class="code" href="../../d1/d9/worker_8c.html#a24">ExpDetectWorkerThreadDeadlock</a>( VOID );
00115 
00116 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00117 <a class="code" href="../../d1/d9/worker_8c.html#a25">ExpWorkerThreadBalanceManager</a>(
00118     IN PVOID StartContext
00119     );
00120     
00121 <span class="comment">//</span>
00122 <span class="comment">// Procedure prototype for the worker thread.</span>
00123 <span class="comment">//</span>
00124 
00125 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00126 <a class="code" href="../../d1/d9/worker_8c.html#a26">ExpWorkerThread</a>(
00127     IN PVOID StartContext
00128     );
00129 
00130 <span class="preprocessor">#if DBG</span>
00131 <span class="preprocessor"></span>
00132 EXCEPTION_DISPOSITION
00133 ExpWorkerThreadFilter(
00134     IN PWORKER_THREAD_ROUTINE WorkerRoutine,
00135     IN PVOID Parameter,
00136     IN PEXCEPTION_POINTERS ExceptionInfo
00137     );
00138 
00139 <span class="preprocessor">#endif</span>
00140 <span class="preprocessor"></span>
00141 PVOID
00142 <a class="code" href="../../d1/d9/worker_8c.html#a27">ExpCheckForWorker</a>(
00143     IN PVOID p,
00144     IN ULONG Size
00145     );
00146 
00147 
00148 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00149 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, ExpWorkerInitialization)</span>
00150 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ExpCheckDynamicThreadCount)</span>
00151 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ExpCreateWorkerThread)</span>
00152 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ExpDetectWorkerThreadDeadlock)</span>
00153 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ExpWorkerThreadBalanceManager)</span>
00154 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00155 <span class="preprocessor"></span>
00156 
00157 BOOLEAN
00158 __inline
<a name="l00159"></a><a class="code" href="../../d1/d9/worker_8c.html#a28">00159</a> <a class="code" href="../../d1/d9/worker_8c.html#a28">ExpNewThreadNecessary</a>(
00160     IN WORK_QUEUE_TYPE QueueType
00161     )
00162 
00163 <span class="comment">/*++</span>
00164 <span class="comment"></span>
00165 <span class="comment">Routine Description:</span>
00166 <span class="comment"></span>
00167 <span class="comment">    This function checks the supplied worker queue and determines whether</span>
00168 <span class="comment">    it is appropriate to spin up a dynamic worker thread for that queue.</span>
00169 <span class="comment"></span>
00170 <span class="comment">Arguments:</span>
00171 <span class="comment"></span>
00172 <span class="comment">    QueueType - Supplies the type of the queue that should be examined.</span>
00173 <span class="comment"></span>
00174 <span class="comment">Return Value:</span>
00175 <span class="comment"></span>
00176 <span class="comment">    TRUE if the given work queue would benefit from the creation of an</span>
00177 <span class="comment">    additional thread, FALSE if not.</span>
00178 <span class="comment"></span>
00179 <span class="comment">--*/</span>
00180 {
00181     <a class="code" href="../../d8/d7/struct__EX__WORK__QUEUE.html">PEX_WORK_QUEUE</a> Queue;
00182 
00183     Queue = &amp;<a class="code" href="../../d1/d9/worker_8c.html#a12">ExWorkerQueue</a>[QueueType];
00184 
00185     <span class="keywordflow">if</span> (Queue-&gt;<a class="code" href="../../d8/d7/struct__EX__WORK__QUEUE.html#o5">MakeThreadsAsNecessary</a> != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> &amp;&amp;
00186         IsListEmpty( &amp;Queue-&gt;<a class="code" href="../../d8/d7/struct__EX__WORK__QUEUE.html#o0">WorkerQueue</a>.<a class="code" href="../../d7/d7/struct__KQUEUE.html#o1">EntryListHead</a> ) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> &amp;&amp;
00187         Queue-&gt;<a class="code" href="../../d8/d7/struct__EX__WORK__QUEUE.html#o0">WorkerQueue</a>.<a class="code" href="../../d7/d7/struct__KQUEUE.html#o2">CurrentCount</a> &lt; Queue-&gt;<a class="code" href="../../d8/d7/struct__EX__WORK__QUEUE.html#o0">WorkerQueue</a>.<a class="code" href="../../d7/d7/struct__KQUEUE.html#o3">MaximumCount</a> &amp;&amp;
00188         Queue-&gt;<a class="code" href="../../d8/d7/struct__EX__WORK__QUEUE.html#o1">DynamicThreadCount</a> &lt; <a class="code" href="../../d1/d9/worker_8c.html#a4">MAX_ADDITIONAL_DYNAMIC_THREADS</a>) {
00189 
00190         <span class="comment">//</span>
00191         <span class="comment">// We know these things:</span>
00192         <span class="comment">//</span>
00193         <span class="comment">// - This queue is eligible for dynamic creation of threads to try</span>
00194         <span class="comment">//   to keep the CPUs busy,</span>
00195         <span class="comment">//</span>
00196         <span class="comment">// - There are work items waiting in the queue,</span>
00197         <span class="comment">//</span>
00198         <span class="comment">// - The number of runable worker threads for this queue is less than</span>
00199         <span class="comment">//   the number of processors on this system, and</span>
00200         <span class="comment">//</span>
00201         <span class="comment">// - We haven't reached the maximum dynamic thread count.</span>
00202         <span class="comment">//</span>
00203         <span class="comment">// An additional worker thread at this point will help clear the</span>
00204         <span class="comment">// backlog.</span>
00205         <span class="comment">//</span>
00206 
00207         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00208 
00209     } <span class="keywordflow">else</span> {
00210 
00211         <span class="comment">//</span>
00212         <span class="comment">// One of the above conditions is false.</span>
00213         <span class="comment">//</span>
00214 
00215         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00216     }
00217 }
00218 
00219 BOOLEAN
<a name="l00220"></a><a class="code" href="../../d1/d9/worker_8c.html#a29">00220</a> <a class="code" href="../../d1/d9/worker_8c.html#a29">ExpWorkerInitialization</a>(
00221     VOID
00222     )
00223 
00224 {
00225 
00226     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00227     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00228     ULONG NumberOfDelayedThreads;
00229     ULONG NumberOfCriticalThreads;
00230     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00231     HANDLE Thread;
00232     BOOLEAN NtAs;
00233     <a class="code" href="../../d5/d8/ex_8h.html#a110">WORK_QUEUE_TYPE</a> WorkQueueType;
00234 
00235     <span class="comment">//</span>
00236     <span class="comment">// Set the number of worker threads based on the system size.</span>
00237     <span class="comment">//</span>
00238 
00239     NtAs = <a class="code" href="../../d5/d1/mminit_8c.html#a58">MmIsThisAnNtAsSystem</a>();
00240     <span class="keywordflow">switch</span> (<a class="code" href="../../d5/d1/mminit_8c.html#a57">MmQuerySystemSize</a>()) {
00241     <span class="keywordflow">case</span> <a class="code" href="../../d2/d1/mm_8h.html#a343a165">MmSmallSystem</a>:
00242         NumberOfDelayedThreads = <a class="code" href="../../d1/d9/worker_8c.html#a6">MEDIUM_NUMBER_OF_THREADS</a>;
00243         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &gt; ((12*1024*1024)/<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) ) {
00244             NumberOfCriticalThreads = <a class="code" href="../../d1/d9/worker_8c.html#a6">MEDIUM_NUMBER_OF_THREADS</a>;
00245         } <span class="keywordflow">else</span> {
00246             NumberOfCriticalThreads = <a class="code" href="../../d1/d9/worker_8c.html#a5">SMALL_NUMBER_OF_THREADS</a>;
00247         }
00248         <span class="keywordflow">break</span>;
00249 
00250     <span class="keywordflow">case</span> <a class="code" href="../../d2/d1/mm_8h.html#a343a166">MmMediumSystem</a>:
00251         NumberOfDelayedThreads = <a class="code" href="../../d1/d9/worker_8c.html#a6">MEDIUM_NUMBER_OF_THREADS</a>;
00252         NumberOfCriticalThreads = <a class="code" href="../../d1/d9/worker_8c.html#a6">MEDIUM_NUMBER_OF_THREADS</a>;
00253         <span class="keywordflow">if</span> ( NtAs ) {
00254             NumberOfCriticalThreads += <a class="code" href="../../d1/d9/worker_8c.html#a6">MEDIUM_NUMBER_OF_THREADS</a>;
00255             }
00256         <span class="keywordflow">break</span>;
00257 
00258     <span class="keywordflow">case</span> <a class="code" href="../../d2/d1/mm_8h.html#a343a167">MmLargeSystem</a>:
00259         NumberOfDelayedThreads = <a class="code" href="../../d1/d9/worker_8c.html#a6">MEDIUM_NUMBER_OF_THREADS</a>;
00260         NumberOfCriticalThreads = <a class="code" href="../../d1/d9/worker_8c.html#a7">LARGE_NUMBER_OF_THREADS</a>;
00261         <span class="keywordflow">if</span> ( NtAs ) {
00262             NumberOfCriticalThreads += <a class="code" href="../../d1/d9/worker_8c.html#a7">LARGE_NUMBER_OF_THREADS</a>;
00263             }
00264         <span class="keywordflow">break</span>;
00265 
00266     <span class="keywordflow">default</span>:
00267         NumberOfDelayedThreads = <a class="code" href="../../d1/d9/worker_8c.html#a5">SMALL_NUMBER_OF_THREADS</a>;
00268         NumberOfCriticalThreads = <a class="code" href="../../d1/d9/worker_8c.html#a5">SMALL_NUMBER_OF_THREADS</a>;
00269     }
00270 
00271 
00272     <span class="comment">//</span>
00273     <span class="comment">// Initialize the work Queue objects.</span>
00274     <span class="comment">//</span>
00275 
00276     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d0/cmdat3_8c.html#a50">ExpAdditionalCriticalWorkerThreads</a> &gt; <a class="code" href="../../d1/d9/worker_8c.html#a3">MAX_ADDITIONAL_THREADS</a> ) {
00277         <a class="code" href="../../d8/d0/cmdat3_8c.html#a50">ExpAdditionalCriticalWorkerThreads</a> = <a class="code" href="../../d1/d9/worker_8c.html#a3">MAX_ADDITIONAL_THREADS</a>;
00278         }
00279 
00280     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d0/cmdat3_8c.html#a51">ExpAdditionalDelayedWorkerThreads</a> &gt; <a class="code" href="../../d1/d9/worker_8c.html#a3">MAX_ADDITIONAL_THREADS</a> ) {
00281         <a class="code" href="../../d8/d0/cmdat3_8c.html#a51">ExpAdditionalDelayedWorkerThreads</a> = <a class="code" href="../../d1/d9/worker_8c.html#a3">MAX_ADDITIONAL_THREADS</a>;
00282         }
00283 
00284     <span class="comment">//</span>
00285     <span class="comment">// Initialize the ExWorkerQueue[] array.</span>
00286     <span class="comment">// </span>
00287 
00288     <span class="keywordflow">for</span> (WorkQueueType = 0; WorkQueueType &lt; <a class="code" href="../../d5/d8/ex_8h.html#a332a208">MaximumWorkQueue</a>; WorkQueueType++) {
00289 
00290         RtlZeroMemory(&amp;<a class="code" href="../../d1/d9/worker_8c.html#a12">ExWorkerQueue</a>[WorkQueueType],
00291                       <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7/struct__EX__WORK__QUEUE.html">EX_WORK_QUEUE</a>));
00292 
00293         <a class="code" href="../../d8/d3/queueobj_8c.html#a1">KeInitializeQueue</a>(&amp;<a class="code" href="../../d1/d9/worker_8c.html#a12">ExWorkerQueue</a>[WorkQueueType].WorkerQueue, 0);
00294     }
00295 
00296     <span class="comment">//</span>
00297     <span class="comment">// We only create dynamic threads for the critical work queue (note</span>
00298     <span class="comment">// this doesn't apply to dynamic threads created to break deadlocks.)</span>
00299     <span class="comment">//</span>
00300     <span class="comment">// The rationale is this: folks who use the delayed work queue are</span>
00301     <span class="comment">// not time critical, and the hypercritical queue is used rarely</span>
00302     <span class="comment">// by folks who are non-blocking.</span>
00303     <span class="comment">//</span>
00304 
00305     <a class="code" href="../../d1/d9/worker_8c.html#a12">ExWorkerQueue</a>[<a class="code" href="../../d5/d8/ex_8h.html#a332a205">CriticalWorkQueue</a>].<a class="code" href="../../d8/d7/struct__EX__WORK__QUEUE.html#o5">MakeThreadsAsNecessary</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00306 
00307     <span class="comment">//</span>
00308     <span class="comment">// Initialize the global thread set manager event.</span>
00309     <span class="comment">//</span>
00310 
00311     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;<a class="code" href="../../d1/d9/worker_8c.html#a17">ExThreadSetManagerEvent</a>,
00312                       SynchronizationEvent,
00313                       <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00314 
00315     <span class="comment">//</span>
00316     <span class="comment">// Create the desired number of executive worker threads for each</span>
00317     <span class="comment">// of the work queues.</span>
00318     <span class="comment">//</span>
00319 
00320     InitializeObjectAttributes(&amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00321 
00322     <span class="comment">//</span>
00323     <span class="comment">// Create any builtin critical and delayed worker threads.</span>
00324     <span class="comment">//</span>
00325 
00326     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; (NumberOfCriticalThreads + <a class="code" href="../../d8/d0/cmdat3_8c.html#a50">ExpAdditionalCriticalWorkerThreads</a>); <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00327 
00328         <span class="comment">//</span>
00329         <span class="comment">// Create a worker thread to service the critical work queue.</span>
00330         <span class="comment">//</span>
00331 
00332         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d9/worker_8c.html#a23">ExpCreateWorkerThread</a>( <a class="code" href="../../d5/d8/ex_8h.html#a332a205">CriticalWorkQueue</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00333         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00334             <span class="keywordflow">break</span>;
00335         }
00336         <a class="code" href="../../d1/d9/worker_8c.html#a15">ExCriticalWorkerThreads</a>++;
00337     }
00338 
00339 
00340     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; (NumberOfDelayedThreads + <a class="code" href="../../d8/d0/cmdat3_8c.html#a51">ExpAdditionalDelayedWorkerThreads</a>); <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00341 
00342         <span class="comment">//</span>
00343         <span class="comment">// Create a worker thread to service the delayed work queue.</span>
00344         <span class="comment">//</span>
00345 
00346         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d9/worker_8c.html#a23">ExpCreateWorkerThread</a>( <a class="code" href="../../d5/d8/ex_8h.html#a332a206">DelayedWorkQueue</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00347         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00348             <span class="keywordflow">break</span>;
00349         }
00350 
00351         <a class="code" href="../../d1/d9/worker_8c.html#a16">ExDelayedWorkerThreads</a>++;
00352     }
00353 
00354     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d9/worker_8c.html#a23">ExpCreateWorkerThread</a>( <a class="code" href="../../d5/d8/ex_8h.html#a332a207">HyperCriticalWorkQueue</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00355 
00356     <span class="comment">//</span>
00357     <span class="comment">// Create the worker thread set manager thread.</span>
00358     <span class="comment">//</span>
00359 
00360     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/ps_2create_8c.html#a11">PsCreateSystemThread</a>(&amp;Thread,
00361                                   THREAD_ALL_ACCESS,
00362                                   &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00363                                   0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00364                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00365                                   <a class="code" href="../../d1/d9/worker_8c.html#a25">ExpWorkerThreadBalanceManager</a>,
00366                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00367     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00368         ZwClose( Thread );
00369     }
00370 
00371     <span class="keywordflow">return</span> (BOOLEAN)<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00372 }
00373 
00374 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00375"></a><a class="code" href="../../d5/d8/ex_8h.html#a261">00375</a> <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>(
00376     IN <a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">PWORK_QUEUE_ITEM</a> WorkItem,
00377     IN WORK_QUEUE_TYPE QueueType
00378     )
00379 
00380 <span class="comment">/*++</span>
00381 <span class="comment"></span>
00382 <span class="comment">Routine Description:</span>
00383 <span class="comment"></span>
00384 <span class="comment">    This function inserts a work item into a work queue that is processed</span>
00385 <span class="comment">    by a worker thread of the corresponding type.</span>
00386 <span class="comment"></span>
00387 <span class="comment">Arguments:</span>
00388 <span class="comment"></span>
00389 <span class="comment">    WorkItem - Supplies a pointer to the work item to add the the queue.</span>
00390 <span class="comment">        This structure must be located in NonPagedPool. The work item</span>
00391 <span class="comment">        structure contains a doubly linked list entry, the address of a</span>
00392 <span class="comment">        routine to call and a parameter to pass to that routine.</span>
00393 <span class="comment"></span>
00394 <span class="comment">    QueueType - Specifies the type of work queue that the work item</span>
00395 <span class="comment">        should be placed in.</span>
00396 <span class="comment"></span>
00397 <span class="comment">Return Value:</span>
00398 <span class="comment"></span>
00399 <span class="comment">    None</span>
00400 <span class="comment"></span>
00401 <span class="comment">--*/</span>
00402 
00403 {
00404 
00405     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(QueueType &lt; <a class="code" href="../../d5/d8/ex_8h.html#a332a208">MaximumWorkQueue</a>);
00406     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(WorkItem-&gt;List.Flink == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00407 
00408     <span class="comment">//</span>
00409     <span class="comment">// Insert the work item in the appropriate queue object.</span>
00410     <span class="comment">//</span>
00411 
00412     <a class="code" href="../../d8/d3/queueobj_8c.html#a3">KeInsertQueue</a>(&amp;<a class="code" href="../../d1/d9/worker_8c.html#a12">ExWorkerQueue</a>[QueueType].WorkerQueue, &amp;WorkItem-&gt;List);
00413 
00414     <span class="comment">//</span>
00415     <span class="comment">// Determine whether another thread should be created, and signal the</span>
00416     <span class="comment">// thread set balance manager if so.</span>
00417     <span class="comment">//</span>
00418 
00419     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/worker_8c.html#a28">ExpNewThreadNecessary</a>(QueueType) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00420         
00421         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;<a class="code" href="../../d1/d9/worker_8c.html#a17">ExThreadSetManagerEvent</a>,
00422                     0,
00423                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00424     }
00425 
00426     <span class="keywordflow">return</span>;
00427 }
00428 
00429 
00430 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00431"></a><a class="code" href="../../d1/d9/worker_8c.html#a25">00431</a> <a class="code" href="../../d1/d9/worker_8c.html#a25">ExpWorkerThreadBalanceManager</a>(
00432     IN PVOID StartContext
00433     )
00434 
00435 <span class="comment">/*++</span>
00436 <span class="comment"></span>
00437 <span class="comment">Routine Description:</span>
00438 <span class="comment"></span>
00439 <span class="comment">    This function is the startup code for the worker thread manager thread.</span>
00440 <span class="comment">    The worker thread manager thread is created during system initialization</span>
00441 <span class="comment">    and begins execution in this function.</span>
00442 <span class="comment"></span>
00443 <span class="comment">    This thread is responsible for detecting and breaking circular deadlocks</span>
00444 <span class="comment">    in the system worker thread queues.  It will also create and destroy</span>
00445 <span class="comment">    additional worker threads as needed based on loading.</span>
00446 <span class="comment"></span>
00447 <span class="comment">Arguments:</span>
00448 <span class="comment"></span>
00449 <span class="comment">    Context - Supplies a pointer to an arbitrary data structure (NULL).</span>
00450 <span class="comment"></span>
00451 <span class="comment">Return Value:</span>
00452 <span class="comment"></span>
00453 <span class="comment">    None.</span>
00454 <span class="comment"></span>
00455 <span class="comment">--*/</span>
00456 {
00457     <a class="code" href="../../d3/d8/struct__KTIMER.html">KTIMER</a> PeriodTimer;
00458     LARGE_INTEGER DueTime;
00459     PVOID WaitObjects[<a class="code" href="../../d1/d9/worker_8c.html#a31a20">MaximumBalanceObject</a>];
00460     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00461 
00462     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00463 
00464     <span class="comment">//</span>
00465     <span class="comment">// Raise the thread priority to just higher than the priority of the</span>
00466     <span class="comment">// critical work queue.</span>
00467     <span class="comment">//</span>
00468 
00469     <a class="code" href="../../d9/d1/thredobj_8c.html#a20">KeSetBasePriorityThread</a>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>(),
00470                             <a class="code" href="../../d1/d9/worker_8c.html#a1">CRITICAL_WORK_QUEUE_PRIORITY</a>+1);
00471 
00472     <span class="comment">//</span>
00473     <span class="comment">// Initialize the periodic timer and set the manager period.</span>
00474     <span class="comment">//</span>
00475 
00476     <a class="code" href="../../d3/d2/timerobj_8c.html#a1">KeInitializeTimer</a>(&amp;PeriodTimer);
00477     DueTime.QuadPart = - <a class="code" href="../../d1/d9/worker_8c.html#a9">THREAD_SET_INTERVAL</a>;
00478 
00479     <span class="comment">//</span>
00480     <span class="comment">// Initialize the wait object array.</span>
00481     <span class="comment">//</span>
00482 
00483     WaitObjects[<a class="code" href="../../d1/d9/worker_8c.html#a31a18">TimerExpiration</a>] = (PVOID)&amp;PeriodTimer;
00484     WaitObjects[<a class="code" href="../../d1/d9/worker_8c.html#a31a19">ThreadSetManagerEvent</a>] = (PVOID)&amp;<a class="code" href="../../d1/d9/worker_8c.html#a17">ExThreadSetManagerEvent</a>;
00485 
00486     <span class="comment">//</span>
00487     <span class="comment">// Loop forever processing events.</span>
00488     <span class="comment">//</span>
00489 
00490     <span class="keywordflow">while</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ) {
00491 
00492         <span class="comment">//</span>
00493         <span class="comment">// Set the timer to expire at the next periodic interval.</span>
00494         <span class="comment">//</span>
00495 
00496         <a class="code" href="../../d3/d2/timerobj_8c.html#a6">KeSetTimer</a>(&amp;PeriodTimer, DueTime, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00497 
00498         <span class="comment">//</span>
00499         <span class="comment">// Wake up when the timer expires or the set manager event is</span>
00500         <span class="comment">// signalled.</span>
00501         <span class="comment">//</span>
00502 
00503         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a3">KeWaitForMultipleObjects</a>(<a class="code" href="../../d1/d9/worker_8c.html#a31a20">MaximumBalanceObject</a>,
00504                                           WaitObjects,
00505                                           WaitAny,
00506                                           <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
00507                                           <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00508                                           <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00509                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00510                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00511 
00512         <span class="keywordflow">switch</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
00513 
00514             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/worker_8c.html#a31a18">TimerExpiration</a>:
00515 
00516                 <span class="comment">//</span>
00517                 <span class="comment">// Periodic timer expiration - go see if any work queues</span>
00518                 <span class="comment">// are deadlocked.</span>
00519                 <span class="comment">//</span>
00520         
00521                 <a class="code" href="../../d1/d9/worker_8c.html#a24">ExpDetectWorkerThreadDeadlock</a>();
00522                 <span class="keywordflow">break</span>;
00523 
00524             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/worker_8c.html#a31a19">ThreadSetManagerEvent</a>:
00525 
00526                 <span class="comment">//</span>
00527                 <span class="comment">// Someone has asked us to check some metrics to determine</span>
00528                 <span class="comment">// whether we should create another worker thread.</span>
00529                 <span class="comment">//</span>
00530 
00531                 <a class="code" href="../../d1/d9/worker_8c.html#a22">ExpCheckDynamicThreadCount</a>();
00532                 <span class="keywordflow">break</span>;
00533         }
00534     }
00535 }
00536 
00537 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00538"></a><a class="code" href="../../d1/d9/worker_8c.html#a26">00538</a> <a class="code" href="../../d1/d9/worker_8c.html#a26">ExpWorkerThread</a>(
00539     IN PVOID StartContext
00540     )
00541 
00542 {
00543 
00544     PLIST_ENTRY Entry;
00545     <a class="code" href="../../d5/d8/ex_8h.html#a110">WORK_QUEUE_TYPE</a> QueueType;
00546     <a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">PWORK_QUEUE_ITEM</a> WorkItem;
00547     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> WaitMode;
00548     LARGE_INTEGER TimeoutValue;
00549     PLARGE_INTEGER Timeout;
00550     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00551     BOOLEAN DynamicThread;
00552     <a class="code" href="../../d8/d7/struct__EX__WORK__QUEUE.html">PEX_WORK_QUEUE</a> WorkerQueue;
00553     PVOID WorkerRoutine;
00554     PVOID Parameter;
00555 
00556     WaitMode = <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>;
00557 
00558     <span class="comment">//</span>
00559     <span class="comment">// Set timeout value etc according to whether we are static or dynamic.</span>
00560     <span class="comment">//</span>
00561 
00562     <span class="keywordflow">if</span> (((ULONG_PTR)StartContext &amp; <a class="code" href="../../d1/d9/worker_8c.html#a10">DYNAMIC_WORKER_THREAD</a>) == 0) {
00563 
00564         <span class="comment">//</span>
00565         <span class="comment">// We are being created as a static thread.  As such it will not</span>
00566         <span class="comment">// terminate, so there is no point in timing out waiting for a work</span>
00567         <span class="comment">// item.</span>
00568         <span class="comment">//</span>
00569 
00570         Timeout = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00571 
00572     } <span class="keywordflow">else</span> {
00573 
00574         <span class="comment">//</span>
00575         <span class="comment">// This is a dynamic worker thread.  It has a non-infinite timeout</span>
00576         <span class="comment">// so that it can eventually terminate.</span>
00577         <span class="comment">//</span>
00578 
00579         TimeoutValue.QuadPart = -<a class="code" href="../../d1/d9/worker_8c.html#a8">DYNAMIC_THREAD_TIMEOUT</a>;
00580         Timeout = &amp;TimeoutValue;
00581     }
00582 
00583     Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00584 
00585     <span class="comment">//</span>
00586     <span class="comment">// If the thread is a critical worker thread, then set the thread</span>
00587     <span class="comment">// priority to the lowest realtime level. Otherwise, set the base</span>
00588     <span class="comment">// thread priority to time critical.</span>
00589     <span class="comment">//</span>
00590 
00591     QueueType = (<a class="code" href="../../d5/d8/ex_8h.html#a110">WORK_QUEUE_TYPE</a>)
00592                 ((ULONG_PTR)StartContext &amp; ~<a class="code" href="../../d1/d9/worker_8c.html#a10">DYNAMIC_WORKER_THREAD</a>);
00593 
00594     WorkerQueue = &amp;<a class="code" href="../../d1/d9/worker_8c.html#a12">ExWorkerQueue</a>[QueueType];
00595 
00596     <span class="keywordflow">switch</span> ( QueueType ) {
00597 
00598         <span class="keywordflow">case</span> <a class="code" href="../../d5/d8/ex_8h.html#a332a207">HyperCriticalWorkQueue</a>:
00599 
00600             <span class="comment">//</span>
00601             <span class="comment">// Always make stack for this thread resident</span>
00602             <span class="comment">// so that worker pool deadlock magic can run</span>
00603             <span class="comment">// even when what we are trying to do is inpage</span>
00604             <span class="comment">// the hyper critical worker thread's stack.</span>
00605             <span class="comment">// Without this fix, we hold the process lock</span>
00606             <span class="comment">// but this thread's stack can't come in, and</span>
00607             <span class="comment">// the deadlock detection cannot create new threads</span>
00608             <span class="comment">// to break the system deadlock.</span>
00609             <span class="comment">//</span>
00610 
00611             WaitMode = <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>;
00612             <span class="keywordflow">break</span>;
00613 
00614         <span class="keywordflow">case</span> <a class="code" href="../../d5/d8/ex_8h.html#a332a205">CriticalWorkQueue</a>:
00615             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d1/mminit_8c.html#a58">MmIsThisAnNtAsSystem</a>() ) {
00616                 WaitMode = <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>;
00617                 }
00618 
00619             <span class="keywordflow">break</span>;
00620     }
00621 
00622 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
00623 <span class="preprocessor"></span>    <span class="comment">//</span>
00624     <span class="comment">// In diskless NT scenarios ensure that the kernel stack of the worker</span>
00625     <span class="comment">// threads will not be swapped out.</span>
00626     <span class="comment">//</span>
00627 
00628     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/io_8h.html#a399">IoRemoteBootClient</a>) {
00629         <a class="code" href="../../d9/d1/thredobj_8c.html#a23">KeSetKernelStackSwapEnable</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00630     }
00631 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
00632 <span class="preprocessor"></span>
00633     <span class="comment">//</span>
00634     <span class="comment">// Loop forever waiting for a work queue item, calling the processing</span>
00635     <span class="comment">// routine, and then waiting for another work queue item.</span>
00636     <span class="comment">//</span>
00637 
00638     <span class="keywordflow">do</span> {
00639 
00640         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00641 
00642             <span class="comment">//</span>
00643             <span class="comment">// Wait until something is put in the queue or until we time out.</span>
00644             <span class="comment">//</span>
00645             <span class="comment">// By specifying a wait mode of UserMode, the thread's kernel</span>
00646             <span class="comment">// stack is swappable.</span>
00647             <span class="comment">//</span>
00648 
00649             Entry = <a class="code" href="../../d8/d3/queueobj_8c.html#a5">KeRemoveQueue</a>(&amp;WorkerQueue-&gt;<a class="code" href="../../d8/d7/struct__EX__WORK__QUEUE.html#o0">WorkerQueue</a>,
00650                                   WaitMode,
00651                                   Timeout);
00652             <span class="keywordflow">if</span> ((ULONG_PTR)Entry != STATUS_TIMEOUT) {
00653 
00654                 <span class="comment">//</span>
00655                 <span class="comment">// This is a real work item, break out of the timeout loop</span>
00656                 <span class="comment">// and go process.</span>
00657                 <span class="comment">//</span>
00658 
00659                 <span class="keywordflow">break</span>;
00660             }
00661 
00662             <span class="comment">// </span>
00663             <span class="comment">// These things are known:</span>
00664             <span class="comment">//</span>
00665             <span class="comment">// - Static worker threads do not time out, so this is a dynamic</span>
00666             <span class="comment">//   worker thread.</span>
00667             <span class="comment">//</span>
00668             <span class="comment">// - This thread has been waiting for a long time with nothing</span>
00669             <span class="comment">//   to do.</span>
00670             <span class="comment">//</span>
00671 
00672             <span class="keywordflow">if</span> (IsListEmpty( &amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o18">IrpList</a> ) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00673 
00674                 <span class="comment">//</span>
00675                 <span class="comment">// There is still I/O pending, can't terminate yet.</span>
00676                 <span class="comment">//</span>
00677 
00678                 <span class="keywordflow">continue</span>;
00679             }
00680 
00681             <span class="comment">//</span>
00682             <span class="comment">// This dynamic thread can be terminated.</span>
00683             <span class="comment">//</span>
00684 
00685 <span class="preprocessor">#if DBG</span>
00686 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"EXWORKER: Dynamic type %d thread no longer needed,"</span>
00687                      <span class="stringliteral">" terminating.\n"</span>,
00688                      QueueType );
00689 <span class="preprocessor">#endif</span>
00690 <span class="preprocessor"></span>
00691             InterlockedDecrement(
00692                 &amp;WorkerQueue-&gt;<a class="code" href="../../d8/d7/struct__EX__WORK__QUEUE.html#o1">DynamicThreadCount</a> );
00693 
00694 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
00695 <span class="preprocessor"></span>            <span class="comment">//</span>
00696             <span class="comment">// We will bugcheck if we terminate a thread with stack swapping</span>
00697             <span class="comment">// disabled.</span>
00698             <span class="comment">//</span>
00699 
00700             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/io_8h.html#a399">IoRemoteBootClient</a>) {
00701                 <a class="code" href="../../d9/d1/thredobj_8c.html#a23">KeSetKernelStackSwapEnable</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00702             }
00703 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
00704 <span class="preprocessor"></span>
00705             <span class="keywordflow">return</span>;
00706         }
00707 
00708         <span class="comment">//</span>
00709         <span class="comment">// Update the total number of work items processed.</span>
00710         <span class="comment">// </span>
00711 
00712         InterlockedIncrement( &amp;WorkerQueue-&gt;<a class="code" href="../../d8/d7/struct__EX__WORK__QUEUE.html#o2">WorkItemsProcessed</a> );
00713 
00714         WorkItem = CONTAINING_RECORD(Entry, <a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">WORK_QUEUE_ITEM</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>);
00715         WorkerRoutine = WorkItem-&gt;<a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html#o1">WorkerRoutine</a>;
00716         Parameter = WorkItem-&gt;<a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html#o2">Parameter</a>;
00717 
00718         <span class="comment">//</span>
00719         <span class="comment">// Execute the specified routine.</span>
00720         <span class="comment">//</span>
00721 
00722 <span class="preprocessor">#if DBG</span>
00723 <span class="preprocessor"></span>
00724         <span class="keywordflow">try</span> {
00725 
00726             ((<a class="code" href="../../d5/d8/ex_8h.html#a111">PWORKER_THREAD_ROUTINE</a>)WorkerRoutine)(Parameter);
00727 
00728             <span class="keywordflow">if</span> (KeGetCurrentIrql() != 0) {
00729                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"EXWORKER: worker exit at IRQL %d, worker routine %x, "</span>
00730                         <span class="stringliteral">"parameter %x, item %x\n"</span>,
00731                         KeGetCurrentIrql(), WorkerRoutine, Parameter, WorkItem);
00732 
00733                 DbgBreakPoint();
00734             }
00735 
00736             <span class="comment">//</span>
00737             <span class="comment">// Catch worker routines that forget to do KeLeaveCriticalRegion.</span>
00738             <span class="comment">//</span>
00739             <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o30">KernelApcDisable</a> != 0) {
00740                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"EXWORKER: worker exit with APCs disabled, worker routine %x, "</span>
00741                         <span class="stringliteral">"parameter %x, item %x\n"</span>,
00742                         WorkerRoutine, Parameter, WorkItem);
00743 
00744                 DbgBreakPoint();
00745                 Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o30">KernelApcDisable</a> = 0;
00746             }
00747 
00748             <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o35">ActiveImpersonationInfo</a>) {
00749                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(
00750                     IMPERSONATING_WORKER_THREAD,
00751                     (ULONG_PTR)WorkerRoutine,
00752                     (ULONG_PTR)Parameter,
00753                     (ULONG_PTR)WorkItem,
00754                     0);
00755             }
00756 
00757         } except( ExpWorkerThreadFilter(WorkerRoutine,
00758                                         Parameter,
00759                                         GetExceptionInformation() )) {
00760         }
00761 
00762 <span class="preprocessor">#else</span>
00763 <span class="preprocessor"></span>
00764         ((<a class="code" href="../../d5/d8/ex_8h.html#a111">PWORKER_THREAD_ROUTINE</a>)WorkerRoutine)(Parameter);
00765 
00766         <span class="comment">//</span>
00767         <span class="comment">// Catch worker routines that forget to do KeLeaveCriticalRegion.</span>
00768         <span class="comment">// It has to be zero at this point. In the debug case we enter a </span>
00769         <span class="comment">// breakpoint. In the non-debug case just zero the flag so that</span>
00770         <span class="comment">// APCs can continue to fire to this thread.</span>
00771         <span class="comment">//</span>
00772 
00773         <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o30">KernelApcDisable</a> != 0) {
00774             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"EXWORKER: worker exit with APCs disabled, worker routine %x, "</span>
00775                     <span class="stringliteral">"parameter %x, item %x\n"</span>,
00776                     WorkerRoutine, Parameter, WorkItem);
00777 
00778             Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o30">KernelApcDisable</a> = 0;
00779         }
00780 
00781         <span class="keywordflow">if</span> (KeGetCurrentIrql() != 0) {
00782             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(
00783                 WORKER_THREAD_RETURNED_AT_BAD_IRQL,
00784                 (ULONG_PTR)WorkerRoutine,
00785                 (ULONG_PTR)KeGetCurrentIrql(),
00786                 (ULONG_PTR)Parameter,
00787                 (ULONG_PTR)WorkItem
00788                 );
00789             }
00790 
00791         <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o35">ActiveImpersonationInfo</a>) {
00792             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(
00793                 IMPERSONATING_WORKER_THREAD,
00794                 (ULONG_PTR)WorkerRoutine,
00795                 (ULONG_PTR)Parameter,
00796                 (ULONG_PTR)WorkItem,
00797                 0
00798                 );
00799         }
00800 <span class="preprocessor">#endif</span>
00801 <span class="preprocessor"></span>
00802     } <span class="keywordflow">while</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00803 }
00804 
00805 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00806"></a><a class="code" href="../../d1/d9/worker_8c.html#a22">00806</a> <a class="code" href="../../d1/d9/worker_8c.html#a22">ExpCheckDynamicThreadCount</a>( VOID )
00807 
00808 <span class="comment">/*++</span>
00809 <span class="comment"></span>
00810 <span class="comment">Routine Description:</span>
00811 <span class="comment"></span>
00812 <span class="comment">    This routine is called when there is reason to believe that a work queue</span>
00813 <span class="comment">    might benefit from the creation of an additional worker thread.</span>
00814 <span class="comment"></span>
00815 <span class="comment">    This routine checks each queue to determine whether it would benefit from</span>
00816 <span class="comment">    an additional worker thread (see ExpNewThreadNecessary()), and creates</span>
00817 <span class="comment">    one if so.</span>
00818 <span class="comment"></span>
00819 <span class="comment">Arguments:</span>
00820 <span class="comment"></span>
00821 <span class="comment">    None.</span>
00822 <span class="comment"></span>
00823 <span class="comment">Return Value:</span>
00824 <span class="comment"></span>
00825 <span class="comment">    None.</span>
00826 <span class="comment"></span>
00827 <span class="comment">--*/</span>
00828 {
00829     <a class="code" href="../../d5/d8/ex_8h.html#a110">WORK_QUEUE_TYPE</a> QueueType;
00830 
00831     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00832 
00833     <span class="comment">//</span>
00834     <span class="comment">// Check each worker queue.</span>
00835     <span class="comment">//</span>
00836 
00837     <span class="keywordflow">for</span> (QueueType = 0; QueueType &lt; <a class="code" href="../../d5/d8/ex_8h.html#a332a208">MaximumWorkQueue</a>; QueueType++) {
00838 
00839         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/worker_8c.html#a28">ExpNewThreadNecessary</a>(QueueType)) {
00840 
00841             <span class="comment">//</span>
00842             <span class="comment">// Create a new thread for this queue.  We explicitly ignore</span>
00843             <span class="comment">// an error from ExpCreateDynamicThread(): there's nothing</span>
00844             <span class="comment">// we can or should do in the event of a failure.</span>
00845             <span class="comment">//</span>
00846 
00847             <a class="code" href="../../d1/d9/worker_8c.html#a23">ExpCreateWorkerThread</a>(QueueType, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00848         }
00849     }
00850 }
00851 
00852 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00853"></a><a class="code" href="../../d1/d9/worker_8c.html#a24">00853</a> <a class="code" href="../../d1/d9/worker_8c.html#a24">ExpDetectWorkerThreadDeadlock</a>( VOID )
00854 
00855 <span class="comment">/*++</span>
00856 <span class="comment"></span>
00857 <span class="comment">Routine Description:</span>
00858 <span class="comment"></span>
00859 <span class="comment">    This function creates new work item threads if a possible deadlock is</span>
00860 <span class="comment">    detected.</span>
00861 <span class="comment"></span>
00862 <span class="comment">Arguments:</span>
00863 <span class="comment"></span>
00864 <span class="comment">    None.</span>
00865 <span class="comment"></span>
00866 <span class="comment">Return Value:</span>
00867 <span class="comment"></span>
00868 <span class="comment">    None</span>
00869 <span class="comment"></span>
00870 <span class="comment">--*/</span>
00871 
00872 {
00873     LONG QueueDepth;
00874     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00875     LONG ThreadCount;
00876     LONG NewThreadCount;
00877     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00878     HANDLE Thread;
00879     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00880     <a class="code" href="../../d8/d7/struct__EX__WORK__QUEUE.html">PEX_WORK_QUEUE</a> Queue;
00881 
00882     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00883 
00884     <span class="comment">//</span>
00885     <span class="comment">// Process each queue type.</span>
00886     <span class="comment">// </span>
00887 
00888     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d5/d8/ex_8h.html#a332a208">MaximumWorkQueue</a>; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00889 
00890         Queue = &amp;<a class="code" href="../../d1/d9/worker_8c.html#a12">ExWorkerQueue</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00891 
00892         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Queue-&gt;<a class="code" href="../../d8/d7/struct__EX__WORK__QUEUE.html#o1">DynamicThreadCount</a> &lt;=
00893                 <a class="code" href="../../d1/d9/worker_8c.html#a4">MAX_ADDITIONAL_DYNAMIC_THREADS</a> );
00894 
00895         <span class="keywordflow">if</span> (Queue-&gt;<a class="code" href="../../d8/d7/struct__EX__WORK__QUEUE.html#o4">QueueDepthLastPass</a> &gt; 0 &amp;&amp;
00896 
00897             Queue-&gt;<a class="code" href="../../d8/d7/struct__EX__WORK__QUEUE.html#o2">WorkItemsProcessed</a> ==
00898                 Queue-&gt;<a class="code" href="../../d8/d7/struct__EX__WORK__QUEUE.html#o3">WorkItemsProcessedLastPass</a> &amp;&amp;
00899 
00900             Queue-&gt;<a class="code" href="../../d8/d7/struct__EX__WORK__QUEUE.html#o1">DynamicThreadCount</a> &lt;
00901                 <a class="code" href="../../d1/d9/worker_8c.html#a4">MAX_ADDITIONAL_DYNAMIC_THREADS</a>) {
00902 
00903             <span class="comment">//</span>
00904             <span class="comment">// These things are known:</span>
00905             <span class="comment">//</span>
00906             <span class="comment">// - There were work items waiting in the queue at the last pass.</span>
00907             <span class="comment">// - No work items have been processed since the last pass.</span>
00908             <span class="comment">// - We haven't yet created the maximum number of dynamic threads.</span>
00909             <span class="comment">//</span>
00910             <span class="comment">// Things look like they're stuck, create a new thread.</span>
00911             <span class="comment">//</span>
00912 
00913 <span class="preprocessor">#if DBG</span>
00914 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"EXWORKER: Work item deadlock detected, creating "</span>
00915                      <span class="stringliteral">"type %d worker thread\n"</span>,
00916                      <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> );
00917 <span class="preprocessor">#endif</span>
00918 <span class="preprocessor"></span>
00919             <span class="comment">//</span>
00920             <span class="comment">// Create a new thread for this queue.  We explicitly ignore</span>
00921             <span class="comment">// an error from ExpCreateDynamicThread(): we'll try again in</span>
00922             <span class="comment">// another detection period if the queue looks like it's still</span>
00923             <span class="comment">// stuck.</span>
00924             <span class="comment">//</span>
00925 
00926             <a class="code" href="../../d1/d9/worker_8c.html#a23">ExpCreateWorkerThread</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00927         }
00928 
00929         <span class="comment">//</span>
00930         <span class="comment">// Update some bookkeeping.</span>
00931         <span class="comment">//</span>
00932         <span class="comment">// Note that WorkItemsProcessed and the queue depth must be recorded</span>
00933         <span class="comment">// in that order to avoid getting a false deadlock indication.</span>
00934         <span class="comment">//</span>
00935 
00936         Queue-&gt;<a class="code" href="../../d8/d7/struct__EX__WORK__QUEUE.html#o3">WorkItemsProcessedLastPass</a> = Queue-&gt;<a class="code" href="../../d8/d7/struct__EX__WORK__QUEUE.html#o2">WorkItemsProcessed</a>;
00937         Queue-&gt;<a class="code" href="../../d8/d7/struct__EX__WORK__QUEUE.html#o4">QueueDepthLastPass</a> = <a class="code" href="../../d8/d3/queueobj_8c.html#a2">KeReadStateQueue</a>( &amp;Queue-&gt;<a class="code" href="../../d8/d7/struct__EX__WORK__QUEUE.html#o0">WorkerQueue</a> );
00938     }
00939 }
00940 
00941 <span class="preprocessor">#if DBG</span>
00942 <span class="preprocessor"></span>
00943 EXCEPTION_DISPOSITION
00944 ExpWorkerThreadFilter(
00945     IN PWORKER_THREAD_ROUTINE WorkerRoutine,
00946     IN PVOID Parameter,
00947     IN PEXCEPTION_POINTERS ExceptionInfo
00948     )
00949 {
00950     KdPrint((<span class="stringliteral">"EXWORKER: exception in worker routine %p(%p)\n"</span>, WorkerRoutine, Parameter));
00951     KdPrint((<span class="stringliteral">"  exception record at %p\n"</span>, ExceptionInfo-&gt;ExceptionRecord));
00952     KdPrint((<span class="stringliteral">"  context record at %p\n"</span>,ExceptionInfo-&gt;ContextRecord));
00953 
00954     <span class="keywordflow">try</span> {
00955         DbgBreakPoint();
00956 
00957     } except (EXCEPTION_EXECUTE_HANDLER) {
00958         <span class="comment">//</span>
00959         <span class="comment">// No kernel debugger attached, so let the system thread</span>
00960         <span class="comment">// exception handler call KeBugCheckEx.</span>
00961         <span class="comment">//</span>
00962         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a34">EXCEPTION_CONTINUE_SEARCH</a>);
00963     }
00964 
00965     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>);
00966 }
00967 
00968 <span class="preprocessor">#endif</span>
00969 <span class="preprocessor"></span>
00970 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00971"></a><a class="code" href="../../d1/d9/worker_8c.html#a23">00971</a> <a class="code" href="../../d1/d9/worker_8c.html#a23">ExpCreateWorkerThread</a>(
00972     WORK_QUEUE_TYPE QueueType,
00973     BOOLEAN Dynamic
00974     )
00975 
00976 <span class="comment">/*++</span>
00977 <span class="comment"></span>
00978 <span class="comment">Routine Description:</span>
00979 <span class="comment"></span>
00980 <span class="comment">    This function creates a single new static or dynamic worker thread for</span>
00981 <span class="comment">    the given queue type.</span>
00982 <span class="comment"></span>
00983 <span class="comment">Arguments:</span>
00984 <span class="comment"></span>
00985 <span class="comment">    QueueType - Supplies the type of the queue for which the worker thread</span>
00986 <span class="comment">                should be created.</span>
00987 <span class="comment"></span>
00988 <span class="comment">    Dynamic - If TRUE, the worker thread is created as a dynamic thread that</span>
00989 <span class="comment">              will terminate after a sufficient period of inactivity.  If FALSE,</span>
00990 <span class="comment">              the worker thread will never terminate.</span>
00991 <span class="comment"></span>
00992 <span class="comment"></span>
00993 <span class="comment">Return Value:</span>
00994 <span class="comment"></span>
00995 <span class="comment">    The final status of the operation.</span>
00996 <span class="comment"></span>
00997 <span class="comment">Notes:</span>
00998 <span class="comment"></span>
00999 <span class="comment">    This routine is only called from the worker thread set balance thread,</span>
01000 <span class="comment">    therefore it will not be reentered.</span>
01001 <span class="comment"></span>
01002 <span class="comment">--*/</span>
01003 
01004 {
01005     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
01006     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01007     HANDLE <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>;
01008     ULONG Context;
01009     ULONG BasePriority;
01010     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
01011 
01012     InitializeObjectAttributes(&amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01013 
01014     Context = QueueType;
01015     <span class="keywordflow">if</span> (Dynamic != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01016         Context |= <a class="code" href="../../d1/d9/worker_8c.html#a10">DYNAMIC_WORKER_THREAD</a>;
01017     }
01018 
01019     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/ps_2create_8c.html#a11">PsCreateSystemThread</a>(&amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
01020                                   THREAD_ALL_ACCESS,
01021                                   &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01022                                   0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01023                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01024                                   <a class="code" href="../../d1/d9/worker_8c.html#a26">ExpWorkerThread</a>,
01025                                   (PVOID)Context);
01026     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01027 <span class="preprocessor">#if DBG</span>
01028 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"EXWORKER: Worker thread creation failed, status %08x\n"</span>,
01029                  <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01030 <span class="preprocessor">#endif</span>
01031 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01032     }
01033 
01034     <span class="keywordflow">if</span> (Dynamic != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01035 
01036 <span class="preprocessor">#if DBG</span>
01037 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"EXWORKER: Created dynamic thread type %d, %d total\n"</span>,
01038                  QueueType,
01039                  <a class="code" href="../../d1/d9/worker_8c.html#a12">ExWorkerQueue</a>[QueueType].DynamicThreadCount);
01040 <span class="preprocessor">#endif</span>
01041 <span class="preprocessor"></span>
01042         InterlockedIncrement( &amp;<a class="code" href="../../d1/d9/worker_8c.html#a12">ExWorkerQueue</a>[QueueType].DynamicThreadCount );
01043     }
01044 
01045     <span class="comment">//</span>
01046     <span class="comment">// Set the priority according to the type of worker thread.</span>
01047     <span class="comment">//</span>
01048 
01049     <span class="keywordflow">switch</span> (QueueType) {
01050    
01051         <span class="keywordflow">case</span> <a class="code" href="../../d5/d8/ex_8h.html#a332a207">HyperCriticalWorkQueue</a>:
01052 
01053             BasePriority = <a class="code" href="../../d1/d9/worker_8c.html#a2">HYPER_CRITICAL_WORK_QUEUE_PRIORITY</a>;
01054             <span class="keywordflow">break</span>;
01055 
01056         <span class="keywordflow">case</span> <a class="code" href="../../d5/d8/ex_8h.html#a332a205">CriticalWorkQueue</a>:
01057 
01058             BasePriority = <a class="code" href="../../d1/d9/worker_8c.html#a1">CRITICAL_WORK_QUEUE_PRIORITY</a>;
01059             <span class="keywordflow">break</span>;
01060 
01061         <span class="keywordflow">case</span> <a class="code" href="../../d5/d8/ex_8h.html#a332a206">DelayedWorkQueue</a>:
01062 
01063             BasePriority = <a class="code" href="../../d1/d9/worker_8c.html#a0">DELAYED_WORK_QUEUE_PRIORITY</a>;
01064             <span class="keywordflow">break</span>;
01065     }
01066 
01067     <span class="comment">//</span>
01068     <span class="comment">// Set the base priority of the just-created thread.</span>
01069     <span class="comment">// </span>
01070 
01071     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
01072                                         THREAD_SET_INFORMATION,
01073                                         <a class="code" href="../../d9/d8/ntos_8h.html#a3">PsThreadType</a>,
01074                                         <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01075                                         (PVOID *)&amp;Thread,
01076                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01077     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01078 
01079         <a class="code" href="../../d9/d1/thredobj_8c.html#a20">KeSetBasePriorityThread</a>( &amp;Thread-&gt;Tcb, BasePriority );
01080         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Thread );
01081 
01082     } <span class="keywordflow">else</span> {
01083 
01084         <span class="comment">//</span>
01085         <span class="comment">// The thread was created but we were unable to reference it.  This is</span>
01086         <span class="comment">// very odd... just leave it at the default priority, better than no</span>
01087         <span class="comment">// thread at all.</span>
01088         <span class="comment">//</span>
01089 
01090     }
01091 
01092     ZwClose( <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a> );
01093     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01094 }
01095 
01096 PVOID
<a name="l01097"></a><a class="code" href="../../d4/d0/exp_8h.html#a49">01097</a> <a class="code" href="../../d1/d9/worker_8c.html#a27">ExpCheckForWorker</a>(
01098     IN PVOID p,
01099     IN ULONG Size
01100     )
01101 
01102 {
01103     KIRQL OldIrql;
01104     PLIST_ENTRY Entry;
01105     PCHAR BeginBlock;
01106     PCHAR EndBlock;
01107     <a class="code" href="../../d5/d8/ex_8h.html#a110">WORK_QUEUE_TYPE</a> wqt;
01108 
01109     BeginBlock = (PCHAR)p;
01110     EndBlock = (PCHAR)p + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
01111 
01112     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a> (&amp;OldIrql);
01113     <span class="keywordflow">for</span> (wqt = <a class="code" href="../../d5/d8/ex_8h.html#a332a205">CriticalWorkQueue</a>; wqt &lt; <a class="code" href="../../d5/d8/ex_8h.html#a332a208">MaximumWorkQueue</a>; wqt++) {
01114         <span class="keywordflow">for</span> (Entry = (PLIST_ENTRY) <a class="code" href="../../d1/d9/worker_8c.html#a12">ExWorkerQueue</a>[wqt].<a class="code" href="../../d8/d7/struct__EX__WORK__QUEUE.html#o0">WorkerQueue</a>.<a class="code" href="../../d7/d7/struct__KQUEUE.html#o1">EntryListHead</a>.Flink;
01115              Entry &amp;&amp; (Entry != (PLIST_ENTRY) &amp;<a class="code" href="../../d1/d9/worker_8c.html#a12">ExWorkerQueue</a>[wqt].<a class="code" href="../../d8/d7/struct__EX__WORK__QUEUE.html#o0">WorkerQueue</a>.<a class="code" href="../../d7/d7/struct__KQUEUE.html#o1">EntryListHead</a>);
01116              Entry = Entry-&gt;Flink) {
01117            <span class="keywordflow">if</span> (((PCHAR) Entry &gt;= BeginBlock) &amp;&amp; ((PCHAR) Entry &lt; EndBlock)) {
01118               <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(WORKER_INVALID,
01119                            0x0,
01120                            (ULONG_PTR)Entry,
01121                            (ULONG_PTR)BeginBlock,
01122                            (ULONG_PTR)EndBlock);
01123  
01124            }
01125         }
01126     }
01127     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a> (OldIrql);
01128 
01129     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01130 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:26 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
