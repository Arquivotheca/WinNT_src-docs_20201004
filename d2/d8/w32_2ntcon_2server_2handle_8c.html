<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: w32/ntcon/server/handle.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>handle.c File Reference</h1><code>#include "<a class="el" href="../../d7/d2/w32_2ntcon_2server_2precomp_8h-source.html">precomp.h</a>"</code><br>

<p>
<a href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a0">HandleFromIndex</a>(i)&nbsp;&nbsp;&nbsp;((HANDLE)((i &amp; 0xFFFF) | (<a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a7">ConsoleId</a>++ &lt;&lt; 16)))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a1">IndexFromHandle</a>(h)&nbsp;&nbsp;&nbsp;((<a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>)((ULONG_PTR)h &amp; 0xFFFF))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a2">ConsoleHandleTableLocked</a>()&nbsp;&nbsp;&nbsp;(<a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a6">ConsoleHandleLock</a>.OwningThread == NtCurrentTeb()-&gt;ClientId.UniqueThread)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a8">AddProcessToList</a> (IN OUT <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console, IN OUT <a class="el" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">PCONSOLE_PROCESS_HANDLE</a> ProcessHandleRecord, IN HANDLE ProcessHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a9">FreeInputHandle</a> (IN <a class="el" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a10">InitializeConsoleHandleTable</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a11">DereferenceConsoleHandle</a> (IN HANDLE ConsoleHandle, OUT <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> *Console)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a12">GrowConsoleHandleTable</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a13">AllocateConsoleHandle</a> (OUT PHANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a14">FreeConsoleHandle</a> (IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a15">ValidateConsole</a> (IN <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a16">InitializeIoHandleTable</a> (IN OUT <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console, OUT <a class="el" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData, OUT PHANDLE StdIn, OUT PHANDLE StdOut, OUT PHANDLE StdErr)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a17">InheritIoHandleTable</a> (IN <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console, IN <a class="el" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData, IN <a class="el" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ParentProcessData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a18">ConsoleAddProcessRoutine</a> (IN PCSR_PROCESS ParentProcess, IN PCSR_PROCESS Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a19">AllocateConsole</a> (IN HANDLE ConsoleHandle, IN LPWSTR Title, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> TitleLength, IN HANDLE ClientProcessHandle, OUT PHANDLE StdIn, OUT PHANDLE StdOut, OUT PHANDLE StdErr, OUT <a class="el" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData, IN OUT <a class="el" href="../../d0/d3/struct__CONSOLE__INFO.html">PCONSOLE_INFO</a> ConsoleInfo, IN BOOLEAN WindowVisible, IN <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="el" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a9">dwConsoleThreadId</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a20">DestroyConsole</a> (IN <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a21">FreeCon</a> (IN <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a22">InsertScreenBuffer</a> (IN <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console, IN <a class="el" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a23">RemoveScreenBuffer</a> (IN <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console, IN <a class="el" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a24">GrowIoHandleTable</a> (IN <a class="el" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a25">FreeProcessData</a> (IN <a class="el" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a26">InitializeOutputHandle</a> (<a class="el" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData, <a class="el" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenBuffer)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a27">InitializeInputHandle</a> (<a class="el" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData, <a class="el" href="../../d7/d2/struct__INPUT__INFORMATION.html">PINPUT_INFORMATION</a> InputBuffer)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a28">AllocateIoHandle</a> (IN <a class="el" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData, IN ULONG HandleType, OUT PHANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a29">FreeIoHandle</a> (IN <a class="el" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData, IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a30">DereferenceIoHandleNoCheck</a> (IN <a class="el" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData, IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, OUT <a class="el" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> *HandleData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a31">DereferenceIoHandle</a> (IN <a class="el" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData, IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN ULONG HandleType, IN ACCESS_MASK Access, OUT <a class="el" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> *HandleData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a32">SrvVerifyConsoleIoHandle</a> (IN OUT PCSR_API_MSG m, IN OUT PCSR_REPLY_STATUS ReplyStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a> (IN HANDLE ConsoleHandle, OUT <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> *Console)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a34">RevalidateConsole</a> (IN HANDLE ConsoleHandle, OUT <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> *Console)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a3">InitialConsoleHandles</a> [CONSOLE_INITIAL_CONSOLES]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a4">ConsoleHandles</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a5">NumberOfConsoleHandles</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>CRITICAL_SECTION&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a6">ConsoleHandleLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a7">ConsoleId</a> = 47</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a2" doxytag="w32/ntcon/server/handle.c::ConsoleHandleTableLocked" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ConsoleHandleTableLocked          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(<a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a6">ConsoleHandleLock</a>.OwningThread == NtCurrentTeb()-&gt;ClientId.UniqueThread)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00042">42</a> of file <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">w32/ntcon/server/handle.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00269">AllocateConsoleHandle()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00175">DereferenceConsoleHandle()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00331">FreeConsoleHandle()</a>, and <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00223">GrowConsoleHandleTable()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="w32/ntcon/server/handle.c::HandleFromIndex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HandleFromIndex          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">i&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((HANDLE)((i &amp; 0xFFFF) | (<a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a7">ConsoleId</a>++ &lt;&lt; 16)))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00040">40</a> of file <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">w32/ntcon/server/handle.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00269">AllocateConsoleHandle()</a>, and <a class="el" href="../../d4/d7/handles_8c-source.html#l00075">CreateHandle()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="w32/ntcon/server/handle.c::IndexFromHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IndexFromHandle          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">h&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((<a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>)((ULONG_PTR)h &amp; 0xFFFF))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00041">41</a> of file <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">w32/ntcon/server/handle.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00789">AllocateConsole()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00175">DereferenceConsoleHandle()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01051">DestroyConsole()</a>, <a class="el" href="../../d4/d7/handles_8c-source.html#l00137">DestroyHandle()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00331">FreeConsoleHandle()</a>, <a class="el" href="../../d4/d7/handles_8c-source.html#l00165">GetHandleData()</a>, <a class="el" href="../../d4/d7/handles_8c-source.html#l00185">SetHandleData()</a>, and <a class="el" href="../../d4/d7/handles_8c-source.html#l00204">ValidateCHandle()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a8" doxytag="w32/ntcon/server/handle.c::AddProcessToList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID AddProcessToList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Console</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">PCONSOLE_PROCESS_HANDLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHandleRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHandle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00895">895</a> of file <a class="el" href="../../d1/d4/srvinit_8c-source.html">srvinit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00087">CONSOLE_HAS_FOCUS</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00100">CONSOLE_SHUTTING_DOWN</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00097">CONSOLE_TERMINATING</a>, and <a class="el" href="../../d7/d1/output_8c-source.html#l04200">SetProcessFocus()</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00705">ConsoleAddProcessRoutine()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01091">ConsoleClientConnectRoutine()</a>, and <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01537">SrvAllocConsole()</a>.
<p>
<pre class="fragment"><div>00900 {
00901     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(Console-&gt;Flags &amp; (CONSOLE_TERMINATING | CONSOLE_SHUTTING_DOWN)));
00902 
00903     ProcessHandleRecord-&gt;ProcessHandle = ProcessHandle;
00904     ProcessHandleRecord-&gt;TerminateCount = 0;
00905     InsertHeadList(&amp;Console-&gt;ProcessHandleList,&amp;ProcessHandleRecord-&gt;ListLink);
00906 
00907     <a class="code" href="../../d6/d2/output_8c.html#a72">SetProcessFocus</a>(ProcessHandleRecord-&gt;Process, Console-&gt;Flags &amp; CONSOLE_HAS_FOCUS);
00908 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="w32/ntcon/server/handle.c::AllocateConsole" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS AllocateConsole           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ConsoleHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LPWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>Title</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TitleLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientProcessHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>StdIn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>StdOut</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>StdErr</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d0/d3/struct__CONSOLE__INFO.html">PCONSOLE_INFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ConsoleInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>WindowVisible</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>dwConsoleThreadId</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00789">789</a> of file <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">w32/ntcon/server/handle.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00354">CM_CREATE_CONSOLE_WINDOW</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00378">CONSOLE_CLIENTTHREADHANDLE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00093">CONSOLE_NO_WINDOW</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00068">CONSOLE_TAG</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00029">ConsoleHandles</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00180">ConsoleHeapAlloc</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00193">ConsoleHeapFree</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00051">ConsoleOutputCP</a>, <a class="el" href="../../d9/d7/eudc_8h.html#a3">CreateEUDC()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l00103">CreateInputBuffer()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l00270">DoCreateScreenBuffer()</a>, <a class="el" href="../../d1/d4/ntcon_2conime_2conime_8c-source.html#l00040">dwConsoleThreadId</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00164">_CONSOLE_INFORMATION::Flags</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l00221">FreeInputBuffer()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l01021">FreeScreenBuffer()</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00049">HorizontalClientToWindow</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00041">IndexFromHandle</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00034">INITIALIZATION_FAILED</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00033">INITIALIZATION_SUCCEEDED</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l04700">InitializeConsoleCommandData()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00400">InitializeIoHandleTable()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00874">MapHandle()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00180">NtCreateEvent()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00163">NtDuplicateObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00025">OEMCP</a>, <a class="el" href="../../d1/d7/ntcftxt_8h-source.html#l00481">PostThreadMessage()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01474">RtlDeleteCriticalSection()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01210">RtlInitializeCriticalSection()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00066">TITLE_TAG</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01831">TranslateConsoleTitle()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d8/d5/consrv_8h.html#a77">UnProtectHandle()</a>, and <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00048">VerticalClientToWindow</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00955">SetUpConsole()</a>.
<p>
<pre class="fragment"><div>00805                    :
00806 
00807     This routine allocates and initialized a console and its associated
00808     data - input buffer and screen buffer.
00809 
00810 Arguments:
00811 
00812     ConsoleHandle - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> of console to allocate.
00813 
00814     dwWindowSize - Initial size of screen buffer window, in rows and columns.
00815 
00816     nFont - Initial number of font <a class="code" href="../../d7/d1/genuedef_8c.html#a5">text</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> displayed in.
00817 
00818     dwScreenBufferSize - Initial size of screen buffer, in rows and columns.
00819 
00820     nInputBufferSize - Initial size of input buffer, in events.
00821 
00822     dwWindowFlags -
00823 
00824     StdIn - On <span class="keywordflow">return</span>, contains handle to stdin.
00825 
00826     StdOut - On <span class="keywordflow">return</span>, contains handle to stdout.
00827 
00828     StdErr - On <span class="keywordflow">return</span>, contains handle to stderr.
00829 
00830     ProcessData - On <span class="keywordflow">return</span>, contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initialized per-process data.
00831 
00832 Return Value:
00833 
00834 Note:
00835 
00836     The console handle table lock must be held when calling <span class="keyword">this</span> routine.
00837 
00838 --*/
00839 
00840 {
00841     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
00842     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00843     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> Success;
00844 
00845     <span class="comment">//</span>
00846     <span class="comment">// allocate console data</span>
00847     <span class="comment">//</span>
00848 
00849     Console = (<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a>)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>( <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( CONSOLE_TAG ) | HEAP_ZERO_MEMORY,
00850                                               <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">CONSOLE_INFORMATION</a>));
00851     <span class="keywordflow">if</span> (Console == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00852         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00853     }
00854     <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a4">ConsoleHandles</a>[<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a1">IndexFromHandle</a>(ConsoleHandle)] = Console;
00855 
00856     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> = WindowVisible ? 0 : <a class="code" href="../../d1/d7/server_8h.html#a8">CONSOLE_NO_WINDOW</a>;
00857     Console-&gt;hIcon = ConsoleInfo-&gt;hIcon;
00858     Console-&gt;hSmIcon = ConsoleInfo-&gt;hSmIcon;
00859     Console-&gt;iIconId = ConsoleInfo-&gt;iIconId;
00860     Console-&gt;dwHotKey = ConsoleInfo-&gt;dwHotKey;
00861 <span class="preprocessor">#if !defined(FE_SB)</span>
00862 <span class="preprocessor"></span>    Console-&gt;CP = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a>;
00863     Console-&gt;OutputCP = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a22">ConsoleOutputCP</a>;
00864 <span class="preprocessor">#endif</span>
00865 <span class="preprocessor"></span>    Console-&gt;ReserveKeys = CONSOLE_NOSHORTCUTKEY;
00866     Console-&gt;ConsoleHandle = ConsoleHandle;
00867     Console-&gt;bIconInit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00868     Console-&gt;VerticalClientToWindow = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a19">VerticalClientToWindow</a>;
00869     Console-&gt;HorizontalClientToWindow = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a20">HorizontalClientToWindow</a>;
00870 <span class="preprocessor">#if defined(FE_SB)</span>
00871 <span class="preprocessor"></span>    SetConsoleCPInfo(Console,TRUE);
00872     SetConsoleCPInfo(Console,FALSE);
00873 <span class="preprocessor">#endif</span>
00874 <span class="preprocessor"></span>
00875     <span class="comment">//</span>
00876     <span class="comment">// must wait for window to be destroyed or client impersonation won't</span>
00877     <span class="comment">// work.</span>
00878     <span class="comment">//</span>
00879 
00880     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>(NtCurrentProcess(),
00881                               <a class="code" href="../../d1/d7/server_8h.html#a78">CONSOLE_CLIENTTHREADHANDLE</a>(CSR_SERVER_QUERYCLIENTTHREAD()),
00882                               NtCurrentProcess(),
00883                               &amp;Console-&gt;ClientThreadHandle,
00884                               0,
00885                               FALSE,
00886                               DUPLICATE_SAME_ACCESS
00887                              );
00888     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00889         <span class="keywordflow">goto</span> ErrorExit5;
00890     }
00891 
00892 <span class="preprocessor">#if DBG</span>
00893 <span class="preprocessor"></span>    <span class="comment">//</span>
00894     <span class="comment">// Make sure the handle isn't protected so we can close it later</span>
00895     <span class="comment">//</span>
00896     <a class="code" href="../../d8/d5/consrv_8h.html#a77">UnProtectHandle</a>(Console-&gt;ClientThreadHandle);
00897 <span class="preprocessor">#endif // DBG</span>
00898 <span class="preprocessor"></span>
00899     InitializeListHead(&amp;Console-&gt;OutputQueue);
00900     InitializeListHead(&amp;Console-&gt;ProcessHandleList);
00901     InitializeListHead(&amp;Console-&gt;ExeAliasList);
00902     InitializeListHead(&amp;Console-&gt;MessageQueue);
00903 
00904     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/ex_2event_8c.html#a5">NtCreateEvent</a>(&amp;Console-&gt;InitEvents[INITIALIZATION_SUCCEEDED],
00905                            EVENT_ALL_ACCESS, NULL, NotificationEvent, FALSE);
00906     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00907         <span class="keywordflow">goto</span> ErrorExit4a;
00908     }
00909     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/ex_2event_8c.html#a5">NtCreateEvent</a>(&amp;Console-&gt;InitEvents[INITIALIZATION_FAILED],
00910                            EVENT_ALL_ACCESS, NULL, NotificationEvent, FALSE);
00911     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00912         <span class="keywordflow">goto</span> ErrorExit4;
00913     }
00914     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a24">RtlInitializeCriticalSection</a>(&amp;Console-&gt;ConsoleLock);
00915     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00916         <span class="keywordflow">goto</span> ErrorExit3a;
00917     }
00918     <a class="code" href="../../d8/d5/consrv_8h.html#a239">InitializeConsoleCommandData</a>(Console);
00919 
00920     <span class="comment">//</span>
00921     <span class="comment">// initialize input buffer</span>
00922     <span class="comment">//</span>
00923 
00924 <span class="preprocessor">#if defined(FE_SB)</span>
00925 <span class="preprocessor"></span>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a16">CreateInputBuffer</a>(ConsoleInfo-&gt;nInputBufferSize,
00926                                &amp;Console-&gt;InputBuffer,
00927                                Console);
00928 <span class="preprocessor">#else</span>
00929 <span class="preprocessor"></span>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a16">CreateInputBuffer</a>(ConsoleInfo-&gt;nInputBufferSize,
00930                                &amp;Console-&gt;InputBuffer);
00931 <span class="preprocessor">#endif</span>
00932 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00933         <span class="keywordflow">goto</span> ErrorExit3;
00934     }
00935 
00936     Console-&gt;Title = (PWCHAR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TITLE_TAG ),TitleLength+<span class="keyword">sizeof</span>(WCHAR));
00937     <span class="keywordflow">if</span> (Console-&gt;Title == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00938         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00939         <span class="keywordflow">goto</span> ErrorExit2;
00940     }
00941     RtlCopyMemory(Console-&gt;Title,Title,TitleLength);
00942     Console-&gt;Title[TitleLength/<span class="keyword">sizeof</span>(WCHAR)] = (WCHAR)0;   <span class="comment">// NULL terminate</span>
00943     Console-&gt;TitleLength = TitleLength;
00944 
00945     Console-&gt;OriginalTitle = <a class="code" href="../../d0/d5/srvinit_8c.html#a42">TranslateConsoleTitle</a>(Console-&gt;Title, &amp;Console-&gt;OriginalTitleLength, TRUE, FALSE);
00946     <span class="keywordflow">if</span> (Console-&gt;OriginalTitle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00947         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00948         <span class="keywordflow">goto</span> ErrorExit1;
00949     }
00950 
00951     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/ex_2event_8c.html#a5">NtCreateEvent</a>(&amp;Console-&gt;TerminationEvent,
00952                            EVENT_ALL_ACCESS, NULL, NotificationEvent, FALSE);
00953     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00954         <span class="keywordflow">goto</span> ErrorExit1a;
00955     }
00956 
00957     <span class="comment">//</span>
00958     <span class="comment">// initialize screen buffer. we don't call OpenConsole to do this</span>
00959     <span class="comment">// because we need to specify the font, windowsize, etc.</span>
00960     <span class="comment">//</span>
00961 
00962     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d2/output_8c.html#a41">DoCreateScreenBuffer</a>(Console,
00963                                   ConsoleInfo);
00964     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)){
00965         <span class="keywordflow">goto</span> ErrorExit1b;
00966     }
00967 
00968 
00969     Console-&gt;CurrentScreenBuffer = Console-&gt;ScreenBuffers;
00970 <span class="preprocessor">#if defined(FE_SB)</span>
00971 <span class="preprocessor"></span><span class="preprocessor">#if defined(FE_IME)</span>
00972 <span class="preprocessor"></span>    SetUndetermineAttribute(Console) ;
00973 <span class="preprocessor">#endif</span>
00974 <span class="preprocessor"></span>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d7/eudc_8h.html#a3">CreateEUDC</a>(Console);
00975     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)){
00976         <span class="keywordflow">goto</span> ErrorExit1c;
00977     }
00978 <span class="preprocessor">#endif</span>
00979 <span class="preprocessor"></span>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a16">InitializeIoHandleTable</a>(Console,
00980                                      ProcessData,
00981                                      StdIn,
00982                                      StdOut,
00983                                      StdErr
00984                                     );
00985     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00986         <span class="keywordflow">goto</span> ErrorExit0;
00987     }
00988 
00989     <span class="comment">//</span>
00990     <span class="comment">// map event handles</span>
00991     <span class="comment">//</span>
00992 
00993     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d5/srvinit_8c.html#a32">MapHandle</a>(ClientProcessHandle,
00994                    Console-&gt;InitEvents[INITIALIZATION_SUCCEEDED],
00995                    &amp;ConsoleInfo-&gt;InitEvents[INITIALIZATION_SUCCEEDED]
00996                   )) {
00997         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00998         <span class="keywordflow">goto</span> ErrorExit0;
00999     }
01000     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d5/srvinit_8c.html#a32">MapHandle</a>(ClientProcessHandle,
01001                    Console-&gt;InitEvents[INITIALIZATION_FAILED],
01002                    &amp;ConsoleInfo-&gt;InitEvents[INITIALIZATION_FAILED]
01003                   )) {
01004         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
01005         <span class="keywordflow">goto</span> ErrorExit0;
01006     }
01007     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d5/srvinit_8c.html#a32">MapHandle</a>(ClientProcessHandle,
01008                    Console-&gt;InputBuffer.InputWaitEvent,
01009                    &amp;ConsoleInfo-&gt;InputWaitHandle
01010                   )) {
01011         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
01012         <span class="keywordflow">goto</span> ErrorExit0;
01013     }
01014 
01015     Success = <a class="code" href="../../d0/d8/ntcftxt_8h.html#a21">PostThreadMessage</a>(dwConsoleThreadId,
01016                                 CM_CREATE_CONSOLE_WINDOW,
01017                                 (WPARAM)ConsoleHandle,
01018                                 (LPARAM)ClientProcessHandle
01019                                );
01020     <span class="keywordflow">if</span> (!Success) {
01021         KdPrint((<span class="stringliteral">"CONSRV: PostThreadMessage failed %d\n"</span>,GetLastError()));
01022         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
01023         <span class="keywordflow">goto</span> ErrorExit0;
01024     }
01025 
01026     <span class="keywordflow">return</span> STATUS_SUCCESS;
01027 
01028 ErrorExit0: Console-&gt;ScreenBuffers-&gt;RefCount = 0;
01029 <span class="preprocessor">#if defined(FE_SB)</span>
01030 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (Console-&gt;EudcInformation != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01031                 <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Console-&gt;EudcInformation);
01032             }
01033 ErrorExit1c:
01034 <span class="preprocessor">#endif</span>
01035 <span class="preprocessor"></span>            <a class="code" href="../../d6/d2/output_8c.html#a46">FreeScreenBuffer</a>(Console-&gt;ScreenBuffers);
01036 ErrorExit1b: <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Console-&gt;TerminationEvent);
01037 ErrorExit1a: <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Console-&gt;OriginalTitle);
01038 ErrorExit1: <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Console-&gt;Title);
01039 ErrorExit2: Console-&gt;InputBuffer.RefCount = 0;
01040             <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a18">FreeInputBuffer</a>(&amp;Console-&gt;InputBuffer);
01041 ErrorExit3: <a class="code" href="../../d7/d8/dll_2resource_8c.html#a29">RtlDeleteCriticalSection</a>(&amp;Console-&gt;ConsoleLock);
01042 
01043 ErrorExit3a: <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Console-&gt;InitEvents[INITIALIZATION_FAILED]);
01044 ErrorExit4: <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Console-&gt;InitEvents[INITIALIZATION_SUCCEEDED]);
01045 ErrorExit4a: <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Console-&gt;ClientThreadHandle);
01046 ErrorExit5:  <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Console);
01047     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01048 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="w32/ntcon/server/handle.c::AllocateConsoleHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS AllocateConsoleHandle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Handle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00269">269</a> of file <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">w32/ntcon/server/handle.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00337">CONSOLE_HANDLE_ALLOCATED</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00029">ConsoleHandles</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00042">ConsoleHandleTableLocked</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00223">GrowConsoleHandleTable()</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00040">HandleFromIndex</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00030">NumberOfConsoleHandles</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00955">SetUpConsole()</a>.
<p>
<pre class="fragment"><div>00275                    :
00276 
00277     This routine allocates a console handle from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> global table.
00278 
00279 Arguments:
00280 
00281     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Pointer to store handle in.
00282 
00283 Return Value:
00284 
00285 Note:
00286 
00287     The console handle table lock must be held when calling <span class="keyword">this</span> routine.
00288 
00289 --*/
00290 
00291 {
00292     ULONG i;
00293     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00294 
00295     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a2">ConsoleHandleTableLocked</a>());
00296 
00297     <span class="comment">//</span>
00298     <span class="comment">// have to start allocation at 1 because 0 indicates no console handle</span>
00299     <span class="comment">// in ConDllInitialize.</span>
00300     <span class="comment">//</span>
00301 
00302     <span class="keywordflow">for</span> (i=1;i&lt;<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a5">NumberOfConsoleHandles</a>;i++) {
00303         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a4">ConsoleHandles</a>[i] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00304             <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a4">ConsoleHandles</a>[i] = (<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a>) <a class="code" href="../../d1/d7/server_8h.html#a56">CONSOLE_HANDLE_ALLOCATED</a>;
00305             *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a0">HandleFromIndex</a>(i);
00306             <span class="keywordflow">return</span> STATUS_SUCCESS;
00307         }
00308     }
00309 
00310     <span class="comment">//</span>
00311     <span class="comment">// grow console handle table</span>
00312     <span class="comment">//</span>
00313 
00314     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a12">GrowConsoleHandleTable</a>();
00315     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
00316         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00317     <span class="keywordflow">for</span> ( ;i&lt;<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a5">NumberOfConsoleHandles</a>;i++) {
00318         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a4">ConsoleHandles</a>[i] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00319             <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a4">ConsoleHandles</a>[i] = (<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a>) <a class="code" href="../../d1/d7/server_8h.html#a56">CONSOLE_HANDLE_ALLOCATED</a>;
00320             *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a0">HandleFromIndex</a>(i);
00321             <span class="keywordflow">return</span> STATUS_SUCCESS;
00322         }
00323     }
00324     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FALSE);
00325     <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00326 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="w32/ntcon/server/handle.c::AllocateIoHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS AllocateIoHandle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01390">1390</a> of file <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">w32/ntcon/server/handle.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00295">CONSOLE_FREE_HANDLE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01234">GrowIoHandleTable()</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00400">InitializeIoHandleTable()</a>, <a class="el" href="../../d3/d7/directio_8c-source.html#l01607">SrvCreateConsoleScreenBuffer()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l02603">SrvDuplicateHandle()</a>, and <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l00080">SrvOpenConsole()</a>.
<p>
<pre class="fragment"><div>01398                    :
01399 
01400     This routine allocates an input or output handle from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process's
01401     handle table.
01402 
01403     This routine initializes all non-<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> specific fields in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle
01404     data structure.
01405 
01406 Arguments:
01407 
01408     ProcessData - Pointer to per process data structure.
01409 
01410     HandleType - Flag indicating input or output handle.
01411 
01412     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - On <span class="keywordflow">return</span>, contains allocated handle.  <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an index
01413     internally.  When returned to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> API caller, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> translated into
01414     a handle.
01415 
01416 Return Value:
01417 
01418 Note:
01419 
01420     The console lock must be held when calling <span class="keyword">this</span> routine.  The handle
01421     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allocated from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> per-process handle table.  Holding <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> console
01422     lock serializes both threads within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling process and any other
01423     process that shares <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> console.
01424 
01425 --*/
01426 
01427 {
01428     ULONG i;
01429     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01430 
01431     <span class="keywordflow">for</span> (i=0;i&lt;ProcessData-&gt;HandleTableSize;i++) {
01432         <span class="keywordflow">if</span> (ProcessData-&gt;HandleTablePtr[i].HandleType == <a class="code" href="../../d1/d7/server_8h.html#a47">CONSOLE_FREE_HANDLE</a>) {
01433             ProcessData-&gt;HandleTablePtr[i].HandleType = HandleType;
01434             *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = (HANDLE) i;
01435 
01436             <span class="keywordflow">return</span> STATUS_SUCCESS;
01437         }
01438     }
01439     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a24">GrowIoHandleTable</a>(ProcessData);
01440     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01441         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01442     <span class="keywordflow">for</span> ( ;i&lt;ProcessData-&gt;HandleTableSize;i++) {
01443         <span class="keywordflow">if</span> (ProcessData-&gt;HandleTablePtr[i].HandleType == <a class="code" href="../../d1/d7/server_8h.html#a47">CONSOLE_FREE_HANDLE</a>) {
01444             ProcessData-&gt;HandleTablePtr[i].HandleType = HandleType;
01445             *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = (HANDLE) i;
01446             <span class="keywordflow">return</span> STATUS_SUCCESS;
01447         }
01448     }
01449     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FALSE);
01450     <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01451 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="w32/ntcon/server/handle.c::ApiPreamble" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ApiPreamble           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ConsoleHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>Console</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01627">1627</a> of file <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">w32/ntcon/server/handle.c</a>.
<p>
References <a class="el" href="../../d2/d6/server_8h-source.html#l00383">CONSOLE_CLIENTPROCESSID</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00403">CONSOLE_GETCONSOLEHANDLE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00097">CONSOLE_TERMINATING</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00221">_CONSOLE_INFORMATION::ConsoleHandle</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00040">ConsoleVDMCriticalSection</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00041">ConsoleVDMOnSwitching</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01686">RevalidateConsole()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l04103">UnlockConsole()</a>, and <a class="el" href="../../d2/d6/server_8h-source.html#l00196">_CONSOLE_INFORMATION::VDMProcessId</a>.
<p>
Referenced by <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l00608">SrvAddConsoleAlias()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l02997">SrvCloseHandle()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00373">SrvConsoleMenuControl()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01346">SrvConsoleNotifyLastClose()</a>, <a class="el" href="../../d3/d7/directio_8c-source.html#l01607">SrvCreateConsoleScreenBuffer()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l02603">SrvDuplicateHandle()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l01393">SrvExpungeConsoleCommandHistory()</a>, <a class="el" href="../../d3/d7/directio_8c-source.html#l01568">SrvFillConsoleOutput()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00524">SrvFlushConsoleInputBuffer()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00444">SrvGenerateConsoleCtrlEvent()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l00731">SrvGetConsoleAlias()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l00903">SrvGetConsoleAliases()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l00834">SrvGetConsoleAliasesLength()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l01029">SrvGetConsoleAliasExes()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l00994">SrvGetConsoleAliasExesLength()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l01500">SrvGetConsoleCommandHistory()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l01458">SrvGetConsoleCommandHistoryLength()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l01359">SrvGetConsoleCP()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00315">SrvGetConsoleCurrentFont()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00179">SrvGetConsoleCursorInfo()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l02355">SrvGetConsoleDisplayMode()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00233">SrvGetConsoleFontInfo()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00278">SrvGetConsoleFontSize()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l02232">SrvGetConsoleHardwareState()</a>, <a class="el" href="../../d3/d7/directio_8c-source.html#l00556">SrvGetConsoleInput()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l01385">SrvGetConsoleKeyboardLayoutName()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l02680">SrvGetConsoleLangId()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00033">SrvGetConsoleMode()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00211">SrvGetConsoleMouseInfo()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00082">SrvGetConsoleNumberOfFonts()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00108">SrvGetConsoleNumberOfInputEvents()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00141">SrvGetConsoleScreenBufferInfo()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l04879">SrvGetConsoleTitle()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l01424">SrvGetConsoleWindow()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l02747">SrvGetHandleInformation()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00555">SrvGetLargestConsoleWindowSize()</a>, <a class="el" href="../../d6/d0/w32_2ntcon_2server_2bitmap_8c-source.html#l00168">SrvInvalidateBitMapRect()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l00080">SrvOpenConsole()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l02263">SrvReadConsole()</a>, <a class="el" href="../../d3/d7/directio_8c-source.html#l01207">SrvReadConsoleOutput()</a>, <a class="el" href="../../d3/d7/directio_8c-source.html#l01448">SrvReadConsoleOutputString()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01094">SrvRegisterConsoleVDM()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00882">SrvScrollConsoleScreenBuffer()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00492">SrvSetConsoleActiveScreenBuffer()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l01575">SrvSetConsoleCommandHistoryMode()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l01229">SrvSetConsoleCP()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00213">SrvSetConsoleCursor()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00738">SrvSetConsoleCursorInfo()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00662">SrvSetConsoleCursorPosition()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00853">SrvSetConsoleDisplayMode()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l01118">SrvSetConsoleFont()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l02280">SrvSetConsoleHardwareState()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l01164">SrvSetConsoleIcon()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l02423">SrvSetConsoleKeyShortcuts()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l02376">SrvSetConsoleMenuClose()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00354">SrvSetConsoleMode()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l01424">SrvSetConsoleNumberOfCommands()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00432">SrvSetConsolePalette()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00608">SrvSetConsoleScreenBufferSize()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l01078">SrvSetConsoleTextAttribute()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l04929">SrvSetConsoleTitle()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00773">SrvSetConsoleWindowInfo()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l02794">SrvSetHandleInformation()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00298">SrvShowConsoleCursor()</a>, <a class="el" href="../../d3/d4/srvvdm_8c-source.html#l00024">SrvVDMConsoleOperation()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01582">SrvVerifyConsoleIoHandle()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l02463">SrvWriteConsole()</a>, <a class="el" href="../../d3/d7/directio_8c-source.html#l00730">SrvWriteConsoleInput()</a>, <a class="el" href="../../d3/d7/directio_8c-source.html#l01284">SrvWriteConsoleOutput()</a>, and <a class="el" href="../../d3/d7/directio_8c-source.html#l01508">SrvWriteConsoleOutputString()</a>.
<p>
<pre class="fragment"><div>01631 {
01632     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01633 
01634     <span class="comment">//</span>
01635     <span class="comment">// If this process doesn't have a console handle, bail immediately.</span>
01636     <span class="comment">//</span>
01637 
01638     <span class="keywordflow">if</span> (ConsoleHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || ConsoleHandle != <a class="code" href="../../d1/d7/server_8h.html#a89">CONSOLE_GETCONSOLEHANDLE</a>()) {
01639         <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
01640     }
01641 
01642 <span class="preprocessor">#ifdef i386</span>
01643 <span class="preprocessor"></span>    <span class="comment">//Do not lock the console if we are in the special case:</span>
01644     <span class="comment">//(1). we are in the middle of handshaking with ntvdm doing</span>
01645     <span class="comment">//     full-screen to windowed mode transition</span>
01646     <span class="comment">//(2). the calling process is THE ntvdm process(this implies that the</span>
01647     <span class="comment">//     the console has vdm registered.</span>
01648     <span class="comment">//(3). the console handle is the same one.</span>
01649     <span class="comment">// if (1), (2) and (3) are true then the console is already locked</span>
01650     <span class="comment">// (locked by the windowproc while processing the WM_FULLSCREEN</span>
01651     <span class="comment">// message)</span>
01652 
01653     RtlEnterCriticalSection(&amp;ConsoleVDMCriticalSection);
01654     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a14">ConsoleVDMOnSwitching</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
01655         <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a14">ConsoleVDMOnSwitching</a>-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o65">ConsoleHandle</a> == ConsoleHandle &amp;&amp;
01656         <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a14">ConsoleVDMOnSwitching</a>-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o52">VDMProcessId</a> == <a class="code" href="../../d1/d7/server_8h.html#a80">CONSOLE_CLIENTPROCESSID</a>())
01657     {
01658         KdPrint((<span class="stringliteral">"    ApiPreamble - Thread %lx Entered VDM CritSec\n"</span>, GetCurrentThreadId()));
01659         *Console = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a14">ConsoleVDMOnSwitching</a>;
01660         <span class="keywordflow">return</span> STATUS_SUCCESS;
01661     }
01662     RtlLeaveCriticalSection(&amp;ConsoleVDMCriticalSection);
01663 <span class="preprocessor">#endif</span>
01664 <span class="preprocessor"></span>
01665     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a34">RevalidateConsole</a>(ConsoleHandle,
01666                                Console
01667                               );
01668     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01669         <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01670     }
01671 
01672     <span class="comment">//</span>
01673     <span class="comment">// Make sure the console has been initialized and the window is valid</span>
01674     <span class="comment">//</span>
01675 
01676     <span class="keywordflow">if</span> ((*Console)-&gt;hWnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || ((*Console)-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a12">CONSOLE_TERMINATING</a>)) {
01677         KdPrint((<span class="stringliteral">"CONSRV: bogus window for console %lx\n"</span>, *Console));
01678         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(*Console);
01679         <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
01680     }
01681 
01682     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01683 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="w32/ntcon/server/handle.c::ConsoleAddProcessRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ConsoleAddProcessRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCSR_PROCESS&nbsp;</td>
          <td class="mdname" nowrap> <em>ParentProcess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCSR_PROCESS&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00705">705</a> of file <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">w32/ntcon/server/handle.c</a>.
<p>
References <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00895">AddProcessToList()</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00295">CONSOLE_FREE_HANDLE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00389">CONSOLE_FROMPROCESSPERPROCESSDATA</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00292">CONSOLE_INITIAL_IO_HANDLES</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00401">CONSOLE_SETCONSOLEAPPFROMPROCESSDATA</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00100">CONSOLE_SHUTTING_DOWN</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00322">_CONSOLE_PER_PROCESS_DATA::ConsoleHandle</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00180">ConsoleHeapAlloc</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00193">ConsoleHeapFree</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00050">_CONSOLE_PROCESS_HANDLE::CtrlRoutine</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00164">_CONSOLE_INFORMATION::Flags</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00325">_CONSOLE_PER_PROCESS_DATA::Foo</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00067">HANDLE_TAG</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00323">_CONSOLE_PER_PROCESS_DATA::HandleTable</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00326">_CONSOLE_PER_PROCESS_DATA::HandleTablePtr</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00324">_CONSOLE_PER_PROCESS_DATA::HandleTableSize</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00311">_HANDLE_DATA::HandleType</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00561">InheritIoHandleTable()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00048">_CONSOLE_PROCESS_HANDLE::Process</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00047">_CONSOLE_PROCESS_HANDLE::ProcessHandle</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00051">_CONSOLE_PROCESS_HANDLE::PropRoutine</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00130">_CONSOLE_INFORMATION::RefCount</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01686">RevalidateConsole()</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00328">_CONSOLE_PER_PROCESS_DATA::RootProcess</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l04103">UnlockConsole()</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00737">ConServerDllInitialization()</a>.
<p>
<pre class="fragment"><div>00709 {
00710     <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData, ParentProcessData;
00711     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
00712     <a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">PCONSOLE_PROCESS_HANDLE</a> ProcessHandleRecord;
00713     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00714     ULONG i;
00715 
00716     ProcessData = <a class="code" href="../../d1/d7/server_8h.html#a82">CONSOLE_FROMPROCESSPERPROCESSDATA</a>(Process);
00717     ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o4">HandleTablePtr</a> = ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o1">HandleTable</a>;
00718     ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o2">HandleTableSize</a> = <a class="code" href="../../d1/d7/server_8h.html#a45">CONSOLE_INITIAL_IO_HANDLES</a>;
00719     <a class="code" href="../../d1/d7/server_8h.html#a88">CONSOLE_SETCONSOLEAPPFROMPROCESSDATA</a>(ProcessData,FALSE);
00720 
00721     <span class="keywordflow">if</span> (ParentProcess) {
00722 
00723         ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o6">RootProcess</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00724         ParentProcessData = <a class="code" href="../../d1/d7/server_8h.html#a82">CONSOLE_FROMPROCESSPERPROCESSDATA</a>(ParentProcess);
00725 
00726         <span class="comment">//</span>
00727         <span class="comment">// If both the parent and new processes are console apps,</span>
00728         <span class="comment">// inherit handles from the parent process.</span>
00729         <span class="comment">//</span>
00730 
00731         <span class="keywordflow">if</span> (ParentProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o0">ConsoleHandle</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00732                 (Process-&gt;Flags &amp; CSR_PROCESS_CONSOLEAPP)) {
00733             <span class="keywordflow">if</span> (!(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a34">RevalidateConsole</a>(ParentProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o0">ConsoleHandle</a>,
00734                                                &amp;Console)))) {
00735                 ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o0">ConsoleHandle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00736                 <span class="keywordflow">return</span> STATUS_PROCESS_IS_TERMINATING;
00737             }
00738 
00739             <span class="comment">//</span>
00740             <span class="comment">// Don't add the process if the console is being shutdown.</span>
00741             <span class="comment">//</span>
00742 
00743             <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a15">CONSOLE_SHUTTING_DOWN</a>) {
00744                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PROCESS_IS_TERMINATING;
00745             } <span class="keywordflow">else</span> {
00746                 ProcessHandleRecord = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( HANDLE_TAG ),<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">CONSOLE_PROCESS_HANDLE</a>));
00747                 <span class="keywordflow">if</span> (ProcessHandleRecord == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00748                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00749                 } <span class="keywordflow">else</span> {
00750 
00751                     <span class="comment">//</span>
00752                     <span class="comment">// duplicate parent's handle table</span>
00753                     <span class="comment">//</span>
00754 
00755                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o3">Foo</a> == 0xF00);
00756                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a17">InheritIoHandleTable</a>(Console, ProcessData, ParentProcessData);
00757                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00758                         ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o2">Process</a> = Process;
00759                         ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o4">CtrlRoutine</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00760                         ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o5">PropRoutine</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00761                         <a class="code" href="../../d0/d5/srvinit_8c.html#a33">AddProcessToList</a>(Console,ProcessHandleRecord,Process-&gt;ProcessHandle);
00762 
00763                         <span class="comment">//</span>
00764                         <span class="comment">// increment console reference count</span>
00765                         <span class="comment">//</span>
00766 
00767                         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o1">RefCount</a>++;
00768                     } <span class="keywordflow">else</span> {
00769                         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ProcessHandleRecord);
00770                     }
00771                 }
00772             }
00773             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00774                 ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o0">ConsoleHandle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00775                 <span class="keywordflow">for</span> (i=0;i&lt;<a class="code" href="../../d1/d7/server_8h.html#a45">CONSOLE_INITIAL_IO_HANDLES</a>;i++) {
00776                     ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o1">HandleTable</a>[i].<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a> = <a class="code" href="../../d1/d7/server_8h.html#a47">CONSOLE_FREE_HANDLE</a>;
00777                 }
00778             }
00779             <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00780         } <span class="keywordflow">else</span>
00781             ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o0">ConsoleHandle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00782     } <span class="keywordflow">else</span> {
00783         ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o0">ConsoleHandle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00784     }
00785     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00786 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="w32/ntcon/server/handle.c::DereferenceConsoleHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS DereferenceConsoleHandle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ConsoleHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>Console</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00175">175</a> of file <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">w32/ntcon/server/handle.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00097">CONSOLE_TERMINATING</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00029">ConsoleHandles</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00042">ConsoleHandleTableLocked</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00041">IndexFromHandle</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00030">NumberOfConsoleHandles</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01686">RevalidateConsole()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00955">SetUpConsole()</a>, and <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l02529">WriteConsoleWaitRoutine()</a>.
<p>
<pre class="fragment"><div>00182                    :
00183 
00184     This routine converts a console handle value into a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00185     console data structure.
00186 
00187 Arguments:
00188 
00189     ConsoleHandle - console handle to convert.
00190 
00191     Console - On output, contains pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> console data structure.
00192 
00193 Return Value:
00194 
00195     none.
00196 
00197 Note:
00198 
00199     The console handle table lock must be held when calling <span class="keyword">this</span> routine.
00200 
00201 --*/
00202 
00203 {
00204     ULONG i;
00205 
00206     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a2">ConsoleHandleTableLocked</a>());
00207 
00208     i = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a1">IndexFromHandle</a>(ConsoleHandle);
00209     <span class="keywordflow">if</span> ((i &gt;= <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a5">NumberOfConsoleHandles</a>) ||
00210         ((*Console = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a4">ConsoleHandles</a>[i]) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00211         ((*Console)-&gt;ConsoleHandle != ConsoleHandle)) {
00212         *Console = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00213         <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
00214     }
00215     <span class="keywordflow">if</span> ((*Console)-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a12">CONSOLE_TERMINATING</a>) {
00216         *Console = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00217         <span class="keywordflow">return</span> STATUS_PROCESS_IS_TERMINATING;
00218     }
00219     <span class="keywordflow">return</span> STATUS_SUCCESS;
00220 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="w32/ntcon/server/handle.c::DereferenceIoHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS DereferenceIoHandle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>Access</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleData</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01536">1536</a> of file <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">w32/ntcon/server/handle.c</a>.
<p>
References <a class="el" href="../../d2/d6/server_8h-source.html#l00295">CONSOLE_FREE_HANDLE</a>, <a class="el" href="../../d6/d4/rdwr_8c-source.html#l00044">CONSOLE_HANDLE</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00340">HANDLE_TO_INDEX</a>, and <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>.
<p>
Referenced by <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00373">SrvConsoleMenuControl()</a>, <a class="el" href="../../d3/d7/directio_8c-source.html#l01568">SrvFillConsoleOutput()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00524">SrvFlushConsoleInputBuffer()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00315">SrvGetConsoleCurrentFont()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00179">SrvGetConsoleCursorInfo()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00233">SrvGetConsoleFontInfo()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00278">SrvGetConsoleFontSize()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l02232">SrvGetConsoleHardwareState()</a>, <a class="el" href="../../d3/d7/directio_8c-source.html#l00556">SrvGetConsoleInput()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00033">SrvGetConsoleMode()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00108">SrvGetConsoleNumberOfInputEvents()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00141">SrvGetConsoleScreenBufferInfo()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00555">SrvGetLargestConsoleWindowSize()</a>, <a class="el" href="../../d6/d0/w32_2ntcon_2server_2bitmap_8c-source.html#l00168">SrvInvalidateBitMapRect()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l02263">SrvReadConsole()</a>, <a class="el" href="../../d3/d7/directio_8c-source.html#l01207">SrvReadConsoleOutput()</a>, <a class="el" href="../../d3/d7/directio_8c-source.html#l01448">SrvReadConsoleOutputString()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00882">SrvScrollConsoleScreenBuffer()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00492">SrvSetConsoleActiveScreenBuffer()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00213">SrvSetConsoleCursor()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00738">SrvSetConsoleCursorInfo()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00662">SrvSetConsoleCursorPosition()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00853">SrvSetConsoleDisplayMode()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l01118">SrvSetConsoleFont()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l02280">SrvSetConsoleHardwareState()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00354">SrvSetConsoleMode()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00432">SrvSetConsolePalette()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00608">SrvSetConsoleScreenBufferSize()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l01078">SrvSetConsoleTextAttribute()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l00773">SrvSetConsoleWindowInfo()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00298">SrvShowConsoleCursor()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l02463">SrvWriteConsole()</a>, <a class="el" href="../../d3/d7/directio_8c-source.html#l00730">SrvWriteConsoleInput()</a>, <a class="el" href="../../d3/d7/directio_8c-source.html#l01284">SrvWriteConsoleOutput()</a>, <a class="el" href="../../d3/d7/directio_8c-source.html#l01508">SrvWriteConsoleOutputString()</a>, and <a class="el" href="../../d1/d2/__stream_8h-source.html#l00809">WWSB_DoWriteConsole()</a>.
<p>
<pre class="fragment"><div>01546                    :
01547 
01548     This routine verifies a handle's validity, then returns a pointer to
01549     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle data structure.
01550 
01551 Arguments:
01552 
01553     ProcessData - Pointer to per process data structure.
01554 
01555     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> to dereference.
01556 
01557     HandleData - On <span class="keywordflow">return</span>, pointer to handle data structure.
01558 
01559 Return Value:
01560 
01561 --*/
01562 
01563 {
01564     ULONG_PTR <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01565 
01566     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/rdwr_8c.html#a8">CONSOLE_HANDLE</a>(Handle)) {
01567         <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
01568     }
01569     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (ULONG_PTR)<a class="code" href="../../d1/d7/server_8h.html#a58">HANDLE_TO_INDEX</a>(Handle);
01570     <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt;= ProcessData-&gt;HandleTableSize) ||
01571         (ProcessData-&gt;HandleTablePtr[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].HandleType == <a class="code" href="../../d1/d7/server_8h.html#a47">CONSOLE_FREE_HANDLE</a>) ||
01572         !(ProcessData-&gt;HandleTablePtr[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].HandleType &amp; HandleType) ||
01573         !(ProcessData-&gt;HandleTablePtr[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Access &amp; Access) ) {
01574         <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
01575     }
01576     *HandleData = &amp;ProcessData-&gt;HandleTablePtr[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01577     <span class="keywordflow">return</span> STATUS_SUCCESS;
01578 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="w32/ntcon/server/handle.c::DereferenceIoHandleNoCheck" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS DereferenceIoHandleNoCheck           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleData</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01501">1501</a> of file <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">w32/ntcon/server/handle.c</a>.
<p>
References <a class="el" href="../../d2/d6/server_8h-source.html#l00295">CONSOLE_FREE_HANDLE</a>, and <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l01237">CookedRead()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l01541">CookedReadWaitRoutine()</a>, <a class="el" href="../../d3/d7/directio_8c-source.html#l00267">DirectReadWaitRoutine()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l00053">FindActiveScreenBufferHandle()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01455">FreeIoHandle()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00400">InitializeIoHandleTable()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l02287">ProcessCommandListInput()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l02793">ProcessCommandNumberInput()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l02546">ProcessCopyFromCharInput()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l02677">ProcessCopyToCharInput()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l00471">RawReadWaitRoutine()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01355">RemoveConsole()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l02997">SrvCloseHandle()</a>, <a class="el" href="../../d3/d7/directio_8c-source.html#l01607">SrvCreateConsoleScreenBuffer()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l02603">SrvDuplicateHandle()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l02747">SrvGetHandleInformation()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l00080">SrvOpenConsole()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l02794">SrvSetHandleInformation()</a>, and <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01582">SrvVerifyConsoleIoHandle()</a>.
<p>
<pre class="fragment"><div>01509                    :
01510 
01511     This routine verifies a handle's validity, then returns a pointer to
01512     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle data structure.
01513 
01514 Arguments:
01515 
01516     ProcessData - Pointer to per process data structure.
01517 
01518     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> to dereference.
01519 
01520     HandleData - On <span class="keywordflow">return</span>, pointer to handle data structure.
01521 
01522 Return Value:
01523 
01524 --*/
01525 
01526 {
01527     <span class="keywordflow">if</span> (((ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> &gt;= ProcessData-&gt;HandleTableSize) ||
01528         (ProcessData-&gt;HandleTablePtr[(ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>].HandleType == <a class="code" href="../../d1/d7/server_8h.html#a47">CONSOLE_FREE_HANDLE</a>) ) {
01529         <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
01530     }
01531     *HandleData = &amp;ProcessData-&gt;HandleTablePtr[(ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>];
01532     <span class="keywordflow">return</span> STATUS_SUCCESS;
01533 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="w32/ntcon/server/handle.c::DestroyConsole" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID DestroyConsole           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Console</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01051">1051</a> of file <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">w32/ntcon/server/handle.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00107">CONSOLE_IN_DESTRUCTION</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00221">_CONSOLE_INFORMATION::ConsoleHandle</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00029">ConsoleHandles</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00193">ConsoleHeapFree</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00348">ConsoleLocked</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00331">FreeConsoleHandle()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00041">IndexFromHandle</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00258">LockConsoleHandleTable</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01474">RtlDeleteCriticalSection()</a>, and <a class="el" href="../../d9/d4/consrv_8h-source.html#l00259">UnlockConsoleHandleTable</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/output_8c-source.html#l04423">AbortCreateConsole()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l04454">DestroyWindowsWindow()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l03865">ProcessCtrlEvents()</a>, and <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01686">RevalidateConsole()</a>.
<p>
<pre class="fragment"><div>01057                    :
01058 
01059     This routine frees a console structure <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>'s not being referenced.
01060 
01061 Arguments:
01062 
01063     Console - Console to free.
01064 
01065 Return Value:
01066 
01067 
01068 --*/
01069 
01070 {
01071     HANDLE ConsoleHandle = Console-&gt;ConsoleHandle;
01072 
01073     <span class="comment">//</span>
01074     <span class="comment">// Make sure we have the console locked and it really is going away.</span>
01075     <span class="comment">//</span>
01076 
01077     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d7/server_8h.html#a63">ConsoleLocked</a>(Console));
01078     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Console-&gt;hWnd == NULL);
01079 
01080     <span class="comment">//</span>
01081     <span class="comment">// Mark this console as being destroyed.</span>
01082     <span class="comment">//</span>
01083 
01084     Console-&gt;Flags |= <a class="code" href="../../d1/d7/server_8h.html#a22">CONSOLE_IN_DESTRUCTION</a>;
01085 
01086     <span class="comment">//</span>
01087     <span class="comment">// Unlock this console.</span>
01088     <span class="comment">//</span>
01089 
01090     RtlLeaveCriticalSection(&amp;Console-&gt;ConsoleLock);
01091 
01092     <span class="comment">//</span>
01093     <span class="comment">// If the console still exists and no one is waiting on it, free it.</span>
01094     <span class="comment">//</span>
01095 
01096     <a class="code" href="../../d8/d5/consrv_8h.html#a40">LockConsoleHandleTable</a>();
01097     <span class="keywordflow">if</span> (Console == <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a4">ConsoleHandles</a>[<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a1">IndexFromHandle</a>(ConsoleHandle)] &amp;&amp;
01098         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o65">ConsoleHandle</a> == ConsoleHandle &amp;&amp;
01099         Console-&gt;ConsoleLock.OwningThread == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
01100         Console-&gt;WaitCount == 0) {
01101 
01102         <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a14">FreeConsoleHandle</a>(ConsoleHandle);
01103         <a class="code" href="../../d7/d8/dll_2resource_8c.html#a29">RtlDeleteCriticalSection</a>(&amp;Console-&gt;ConsoleLock);
01104         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Console);
01105     }
01106     <a class="code" href="../../d8/d5/consrv_8h.html#a41">UnlockConsoleHandleTable</a>();
01107 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="w32/ntcon/server/handle.c::FreeCon" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FreeCon           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Console</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01110">1110</a> of file <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">w32/ntcon/server/handle.c</a>.
<p>
References <a class="el" href="../../d7/d1/output_8c-source.html#l04423">AbortCreateConsole()</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00355">CM_DESTROY_WINDOW</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00097">CONSOLE_TERMINATING</a>, <a class="el" href="../../d4/d7/aug98_2test_2main_8c-source.html#l00110">hWnd</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00748">NtSetEvent()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d8/cltxt_8h-source.html#l00697">SendMessageTimeout()</a>, and <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l04103">UnlockConsole()</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01355">RemoveConsole()</a>.
<p>
<pre class="fragment"><div>01116                    :
01117 
01118     This routine frees a console and its associated
01119     data - input buffer and screen buffer.
01120 
01121 Arguments:
01122 
01123     ConsoleHandle - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> of console to free.
01124 
01125 Return Value:
01126 
01127 Note:
01128 
01129     The console handle table lock must be held when calling <span class="keyword">this</span> routine.
01130 
01131 --*/
01132 
01133 {
01134     HWND <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>;
01135 
01136     Console-&gt;Flags |= <a class="code" href="../../d1/d7/server_8h.html#a12">CONSOLE_TERMINATING</a>;
01137     <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>(Console-&gt;TerminationEvent,NULL);
01138     <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> = Console-&gt;hWnd;
01139 
01140     <span class="comment">//</span>
01141     <span class="comment">// Wait 10 seconds or until the input thread replies</span>
01142     <span class="comment">// to synchronize the window destruction with</span>
01143     <span class="comment">// the termination of the thread</span>
01144     <span class="comment">//</span>
01145 
01146     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01147         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01148         <a class="code" href="../../d5/d9/cltxt_8h.html#a17">SendMessageTimeout</a>(hWnd, CM_DESTROY_WINDOW, 0, 0, SMTO_BLOCK, 10000, NULL);
01149     } <span class="keywordflow">else</span> {
01150         <a class="code" href="../../d6/d2/output_8c.html#a79">AbortCreateConsole</a>(Console);
01151     }
01152 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="w32/ntcon/server/handle.c::FreeConsoleHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FreeConsoleHandle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Handle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00331">331</a> of file <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">w32/ntcon/server/handle.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00029">ConsoleHandles</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00042">ConsoleHandleTableLocked</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00041">IndexFromHandle</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00030">NumberOfConsoleHandles</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01051">DestroyConsole()</a>, and <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00955">SetUpConsole()</a>.
<p>
<pre class="fragment"><div>00337                    :
00338 
00339     This routine frees a console handle from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> global table.
00340 
00341 Arguments:
00342 
00343     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> to free.
00344 
00345 Return Value:
00346 
00347 Note:
00348 
00349     The console handle table lock must be held when calling <span class="keyword">this</span> routine.
00350 
00351 --*/
00352 
00353 {
00354     ULONG i;
00355 
00356     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a2">ConsoleHandleTableLocked</a>());
00357 
00358     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Handle != NULL);
00359     i = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a1">IndexFromHandle</a>(Handle);
00360     <span class="keywordflow">if</span> ((i &gt;= <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a5">NumberOfConsoleHandles</a>) || (<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a4">ConsoleHandles</a>[i] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00361         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FALSE);
00362     } <span class="keywordflow">else</span> {
00363         <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a4">ConsoleHandles</a>[i] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00364     }
00365     <span class="keywordflow">return</span> STATUS_SUCCESS;
00366 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="w32/ntcon/server/handle.c::FreeInputHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FreeInputHandle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>HandleData</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01378">1378</a> of file <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">w32/ntcon/server/handle.c</a>.
<p>
References <a class="el" href="../../d9/d4/consrv_8h-source.html#l00193">ConsoleHeapFree</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01474">RtlDeleteCriticalSection()</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01455">FreeIoHandle()</a>, and <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00561">InheritIoHandleTable()</a>.
<p>
<pre class="fragment"><div>01381 {
01382     <span class="keywordflow">if</span> (HandleData-&gt;InputReadData) {
01383         <a class="code" href="../../d7/d8/dll_2resource_8c.html#a29">RtlDeleteCriticalSection</a>(&amp;HandleData-&gt;InputReadData-&gt;ReadCountLock);
01384         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(HandleData-&gt;InputReadData);
01385         HandleData-&gt;InputReadData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01386     }
01387 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="w32/ntcon/server/handle.c::FreeIoHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FreeIoHandle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01455">1455</a> of file <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">w32/ntcon/server/handle.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00295">CONSOLE_FREE_HANDLE</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00026">CONSOLE_INPUT_HANDLE</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01501">DereferenceIoHandleNoCheck()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01378">FreeInputHandle()</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00311">_HANDLE_DATA::HandleType</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l02844">CloseInputHandle()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l02929">CloseOutputHandle()</a>, <a class="el" href="../../d3/d7/directio_8c-source.html#l01607">SrvCreateConsoleScreenBuffer()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l02603">SrvDuplicateHandle()</a>, and <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l00080">SrvOpenConsole()</a>.
<p>
<pre class="fragment"><div>01462                    :
01463 
01464     This routine frees an input or output handle from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process's
01465     handle table.
01466 
01467 Arguments:
01468 
01469     ProcessData - Pointer to per process data structure.
01470 
01471     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> to free.
01472 
01473 Return Value:
01474 
01475 Note:
01476 
01477     The console lock must be held when calling <span class="keyword">this</span> routine.  The handle
01478     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> freed from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> per-process handle table.  Holding <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> console
01479     lock serializes both threads within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling process and any other
01480     process that shares <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> console.
01481 
01482 --*/
01483 
01484 {
01485     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01486     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
01487 
01488     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a30">DereferenceIoHandleNoCheck</a>(ProcessData,
01489                                  Handle,
01490                                  &amp;HandleData
01491                                 );
01492     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
01493     <span class="keywordflow">if</span> (HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a> &amp; <a class="code" href="../../d5/d5/conmsg_8h.html#a0">CONSOLE_INPUT_HANDLE</a>) {
01494         <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a9">FreeInputHandle</a>(HandleData);
01495     }
01496     HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a> = <a class="code" href="../../d1/d7/server_8h.html#a47">CONSOLE_FREE_HANDLE</a>;
01497     <span class="keywordflow">return</span> STATUS_SUCCESS;
01498 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="w32/ntcon/server/handle.c::FreeProcessData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FreeProcessData           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ProcessData</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01280">1280</a> of file <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">w32/ntcon/server/handle.c</a>.
<p>
References <a class="el" href="../../d2/d6/server_8h-source.html#l00292">CONSOLE_INITIAL_IO_HANDLES</a>, and <a class="el" href="../../d9/d4/consrv_8h-source.html#l00193">ConsoleHeapFree</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01355">RemoveConsole()</a>.
<p>
<pre class="fragment"><div>01286                    :
01287 
01288     This routine frees any per-process data allocated by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> console.
01289 
01290 Arguments:
01291 
01292     ProcessData - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> per-process data structure.
01293 
01294 Return Value:
01295 
01296 --*/
01297 
01298 {
01299     <span class="keywordflow">if</span> (ProcessData-&gt;HandleTableSize != <a class="code" href="../../d1/d7/server_8h.html#a45">CONSOLE_INITIAL_IO_HANDLES</a>) {
01300         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ProcessData-&gt;HandleTablePtr);
01301         ProcessData-&gt;HandleTablePtr = ProcessData-&gt;HandleTable;
01302         ProcessData-&gt;HandleTableSize = <a class="code" href="../../d1/d7/server_8h.html#a45">CONSOLE_INITIAL_IO_HANDLES</a>;
01303     }
01304 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="w32/ntcon/server/handle.c::GrowConsoleHandleTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS GrowConsoleHandleTable           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00223">223</a> of file <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">w32/ntcon/server/handle.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00336">CONSOLE_CONSOLE_HANDLE_INCREMENT</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00029">ConsoleHandles</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00042">ConsoleHandleTableLocked</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00180">ConsoleHeapAlloc</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00193">ConsoleHeapFree</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00067">HANDLE_TAG</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00028">InitialConsoleHandles</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00030">NumberOfConsoleHandles</a>, and <a class="el" href="../../d1/d7/server_8h.html#a111">PCONSOLE_INFORMATION</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00269">AllocateConsoleHandle()</a>.
<p>
<pre class="fragment"><div>00227                    :
00228 
00229     This routine grows <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> console handle table.
00230 
00231 Arguments:
00232 
00233     none
00234 
00235 Return Value:
00236 
00237 --*/
00238 
00239 {
00240     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> *NewTable;
00241     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> *OldTable;
00242     ULONG i;
00243     ULONG MaxConsoleHandles;
00244 
00245     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a2">ConsoleHandleTableLocked</a>());
00246 
00247     MaxConsoleHandles = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a5">NumberOfConsoleHandles</a> + <a class="code" href="../../d1/d7/server_8h.html#a55">CONSOLE_CONSOLE_HANDLE_INCREMENT</a>;
00248     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(MaxConsoleHandles &lt;= 0xFFFF);
00249     NewTable = (<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> *)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( HANDLE_TAG ),MaxConsoleHandles * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a>));
00250     <span class="keywordflow">if</span> (NewTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00251         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00252     }
00253     RtlCopyMemory(NewTable, ConsoleHandles,
00254                   NumberOfConsoleHandles * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a>));
00255     <span class="keywordflow">for</span> (i=<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a5">NumberOfConsoleHandles</a>;i&lt;MaxConsoleHandles;i++) {
00256         NewTable[i] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00257     }
00258     OldTable = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a4">ConsoleHandles</a>;
00259     <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a4">ConsoleHandles</a> = NewTable;
00260     <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a5">NumberOfConsoleHandles</a> = MaxConsoleHandles;
00261     <span class="keywordflow">if</span> (OldTable != <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a3">InitialConsoleHandles</a>) {
00262         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(OldTable);
00263     }
00264     <span class="keywordflow">return</span> STATUS_SUCCESS;
00265 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="w32/ntcon/server/handle.c::GrowIoHandleTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS GrowIoHandleTable           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ProcessData</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01234">1234</a> of file <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">w32/ntcon/server/handle.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00295">CONSOLE_FREE_HANDLE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00292">CONSOLE_INITIAL_IO_HANDLES</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00293">CONSOLE_IO_HANDLE_INCREMENT</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00180">ConsoleHeapAlloc</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00193">ConsoleHeapFree</a>, <a class="el" href="../../d1/d7/server_8h.html#a112">HANDLE_DATA</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00067">HANDLE_TAG</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00311">_HANDLE_DATA::HandleType</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01390">AllocateIoHandle()</a>.
<p>
<pre class="fragment"><div>01240                    :
01241 
01242     This routine grows <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> per-process io handle table.
01243 
01244 Arguments:
01245 
01246     ProcessData - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> per-process data structure.
01247 
01248 Return Value:
01249 
01250 --*/
01251 
01252 {
01253     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> NewTable;
01254     ULONG i;
01255     ULONG MaxFileHandles;
01256 
01257     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ProcessData-&gt;Foo == 0xF00);
01258     MaxFileHandles = ProcessData-&gt;HandleTableSize + <a class="code" href="../../d1/d7/server_8h.html#a46">CONSOLE_IO_HANDLE_INCREMENT</a>;
01259     NewTable = (<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a>)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( HANDLE_TAG ),MaxFileHandles * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">HANDLE_DATA</a>));
01260     <span class="keywordflow">if</span> (NewTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01261         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01262     }
01263     RtlCopyMemory(NewTable, ProcessData-&gt;HandleTablePtr,
01264                   ProcessData-&gt;HandleTableSize * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">HANDLE_DATA</a>));
01265     <span class="keywordflow">for</span> (i=ProcessData-&gt;HandleTableSize;i&lt;MaxFileHandles;i++) {
01266         NewTable[i].<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a> = <a class="code" href="../../d1/d7/server_8h.html#a47">CONSOLE_FREE_HANDLE</a>;
01267     }
01268     <span class="keywordflow">if</span> (ProcessData-&gt;HandleTableSize != <a class="code" href="../../d1/d7/server_8h.html#a45">CONSOLE_INITIAL_IO_HANDLES</a>) {
01269         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ProcessData-&gt;HandleTablePtr);
01270     }
01271     ProcessData-&gt;HandleTablePtr = NewTable;
01272     ProcessData-&gt;HandleTableSize = MaxFileHandles;
01273     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ProcessData-&gt;Foo == 0xF00);
01274     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ProcessData-&gt;HandleTableSize != 0);
01275     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ProcessData-&gt;HandleTableSize &lt;= 0x0000FFFF);
01276     <span class="keywordflow">return</span> STATUS_SUCCESS;
01277 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="w32/ntcon/server/handle.c::InheritIoHandleTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS InheritIoHandleTable           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Console</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ParentProcessData</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00561">561</a> of file <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">w32/ntcon/server/handle.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00295">CONSOLE_FREE_HANDLE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00299">CONSOLE_INHERITABLE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00292">CONSOLE_INITIAL_IO_HANDLES</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00026">CONSOLE_INPUT_HANDLE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00100">CONSOLE_SHUTTING_DOWN</a>, <a class="el" href="../../d8/d7/share_8c-source.html#l00095">ConsoleDupShare()</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00180">ConsoleHeapAlloc</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00193">ConsoleHeapFree</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01378">FreeInputHandle()</a>, <a class="el" href="../../d1/d7/server_8h.html#a112">HANDLE_DATA</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00067">HANDLE_TAG</a>, <a class="el" href="../../d9/d3/input_8h.html#a30">INPUT_READ_HANDLE_DATA</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01210">RtlInitializeCriticalSection()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00705">ConsoleAddProcessRoutine()</a>.
<p>
<pre class="fragment"><div>00569                    :
00570 
00571     This routine creates a process's handle table from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent
00572     process's handle table.  ProcessData contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process data
00573     copied directly from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> child process by CSR.
00574     This routine allocates a <span class="keyword">new</span> handle table, <span class="keywordflow">if</span> necessary, then
00575     invalidates non-inherited handles and increments <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> sharing
00576     and reference counts <span class="keywordflow">for</span> inherited handles.
00577 
00578 Arguments:
00579 
00580     ProcessData - Pointer to per process data structure.
00581 
00582 Return Value:
00583 
00584 Note:
00585 
00586     The console lock must be held when calling <span class="keyword">this</span> routine.
00587 
00588 --*/
00589 
00590 {
00591     ULONG i;
00592     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00593 
00594     <span class="comment">//</span>
00595     <span class="comment">// Copy handles from parent process.  If the table size</span>
00596     <span class="comment">// is CONSOLE_INITIAL_IO_HANDLES, CSR has done the copy</span>
00597     <span class="comment">// for us.</span>
00598     <span class="comment">//</span>
00599 
00600     UNREFERENCED_PARAMETER(Console);
00601 
00602     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ParentProcessData-&gt;Foo == 0xF00);
00603     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ParentProcessData-&gt;HandleTableSize != 0);
00604     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ParentProcessData-&gt;HandleTableSize &lt;= 0x0000FFFF);
00605 
00606     <span class="keywordflow">if</span> (ParentProcessData-&gt;HandleTableSize != <a class="code" href="../../d1/d7/server_8h.html#a45">CONSOLE_INITIAL_IO_HANDLES</a>) {
00607         ProcessData-&gt;HandleTableSize = ParentProcessData-&gt;HandleTableSize;
00608         ProcessData-&gt;HandleTablePtr = (<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a>)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( HANDLE_TAG ),ProcessData-&gt;HandleTableSize * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">HANDLE_DATA</a>));
00609 
00610         <span class="keywordflow">if</span> (ProcessData-&gt;HandleTablePtr == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00611             ProcessData-&gt;HandleTablePtr = ProcessData-&gt;HandleTable;
00612             ProcessData-&gt;HandleTableSize = <a class="code" href="../../d1/d7/server_8h.html#a45">CONSOLE_INITIAL_IO_HANDLES</a>;
00613             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00614         }
00615         RtlCopyMemory(ProcessData-&gt;HandleTablePtr,
00616             ParentProcessData-&gt;HandleTablePtr,
00617             ProcessData-&gt;HandleTableSize * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">HANDLE_DATA</a>));
00618     }
00619 
00620     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(Console-&gt;Flags &amp; CONSOLE_SHUTTING_DOWN));
00621 
00622     <span class="comment">//</span>
00623     <span class="comment">// Allocate any memory associated with each handle.</span>
00624     <span class="comment">//</span>
00625 
00626     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00627     <span class="keywordflow">for</span> (i=0;i&lt;ProcessData-&gt;HandleTableSize;i++) {
00628 
00629         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) &amp;&amp; ProcessData-&gt;HandleTablePtr[i].HandleType &amp; <a class="code" href="../../d1/d7/server_8h.html#a49">CONSOLE_INHERITABLE</a>) {
00630 
00631             <span class="keywordflow">if</span> (ProcessData-&gt;HandleTablePtr[i].HandleType &amp; <a class="code" href="../../d5/d5/conmsg_8h.html#a0">CONSOLE_INPUT_HANDLE</a>) {
00632                 ProcessData-&gt;HandleTablePtr[i].InputReadData = (<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html">PINPUT_READ_HANDLE_DATA</a>)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( HANDLE_TAG ),<span class="keyword">sizeof</span>(<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html">INPUT_READ_HANDLE_DATA</a>));
00633                 <span class="keywordflow">if</span> (!ProcessData-&gt;HandleTablePtr[i].InputReadData) {
00634                     ProcessData-&gt;HandleTablePtr[i].HandleType = <a class="code" href="../../d1/d7/server_8h.html#a47">CONSOLE_FREE_HANDLE</a>;
00635                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00636                     <span class="keywordflow">continue</span>;
00637                 }
00638                 ProcessData-&gt;HandleTablePtr[i].InputReadData-&gt;InputHandleFlags = 0;
00639                 ProcessData-&gt;HandleTablePtr[i].InputReadData-&gt;ReadCount = 0;
00640                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a24">RtlInitializeCriticalSection</a>(&amp;ProcessData-&gt;HandleTablePtr[i].InputReadData-&gt;ReadCountLock);
00641                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00642                     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ProcessData-&gt;HandleTablePtr[i].InputReadData);
00643                     ProcessData-&gt;HandleTablePtr[i].InputReadData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00644                     ProcessData-&gt;HandleTablePtr[i].HandleType = <a class="code" href="../../d1/d7/server_8h.html#a47">CONSOLE_FREE_HANDLE</a>;
00645                     <span class="keywordflow">continue</span>;
00646                 }
00647             }
00648         }
00649         <span class="keywordflow">else</span> {
00650             ProcessData-&gt;HandleTablePtr[i].HandleType = <a class="code" href="../../d1/d7/server_8h.html#a47">CONSOLE_FREE_HANDLE</a>;
00651         }
00652     }
00653 
00654     <span class="comment">//</span>
00655     <span class="comment">// If something failed, we need to free any input data we allocated and</span>
00656     <span class="comment">// free the handle table.</span>
00657     <span class="comment">//</span>
00658 
00659     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00660         <span class="keywordflow">for</span> (i=0;i&lt;ProcessData-&gt;HandleTableSize;i++) {
00661             <span class="keywordflow">if</span> (ProcessData-&gt;HandleTablePtr[i].HandleType &amp; <a class="code" href="../../d5/d5/conmsg_8h.html#a0">CONSOLE_INPUT_HANDLE</a>) {
00662                 <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a9">FreeInputHandle</a>(&amp;ProcessData-&gt;HandleTablePtr[i]);
00663             }
00664         }
00665         <span class="keywordflow">if</span> (ProcessData-&gt;HandleTableSize != <a class="code" href="../../d1/d7/server_8h.html#a45">CONSOLE_INITIAL_IO_HANDLES</a>) {
00666             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ProcessData-&gt;HandleTablePtr);
00667             ProcessData-&gt;HandleTablePtr = ProcessData-&gt;HandleTable;
00668             ProcessData-&gt;HandleTableSize = <a class="code" href="../../d1/d7/server_8h.html#a45">CONSOLE_INITIAL_IO_HANDLES</a>;
00669         }
00670         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00671     }
00672 
00673     <span class="comment">//</span>
00674     <span class="comment">// All the memory allocations succeeded. Now go through and increment the</span>
00675     <span class="comment">// object reference counts and dup the shares.</span>
00676     <span class="comment">//</span>
00677 
00678     <span class="keywordflow">for</span> (i=0;i&lt;ProcessData-&gt;HandleTableSize;i++) {
00679         <span class="keywordflow">if</span> (ProcessData-&gt;HandleTablePtr[i].HandleType != <a class="code" href="../../d1/d7/server_8h.html#a47">CONSOLE_FREE_HANDLE</a>) {
00680             <a class="code" href="../../d8/d6/struct__CONSOLE__SHARE__ACCESS.html">PCONSOLE_SHARE_ACCESS</a> ShareAccess;
00681 
00682             <span class="keywordflow">if</span> (ProcessData-&gt;HandleTablePtr[i].HandleType &amp; <a class="code" href="../../d5/d5/conmsg_8h.html#a0">CONSOLE_INPUT_HANDLE</a>) {
00683                 ProcessData-&gt;HandleTablePtr[i].Buffer.InputBuffer-&gt;RefCount++;
00684                 ShareAccess = &amp;ProcessData-&gt;HandleTablePtr[i].Buffer.InputBuffer-&gt;ShareAccess;
00685             }
00686             <span class="keywordflow">else</span> {
00687                 ProcessData-&gt;HandleTablePtr[i].Buffer.ScreenBuffer-&gt;RefCount++;
00688                 ShareAccess = &amp;ProcessData-&gt;HandleTablePtr[i].Buffer.ScreenBuffer-&gt;ShareAccess;
00689             }
00690 
00691             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/share_8c.html#a1">ConsoleDupShare</a>(ProcessData-&gt;HandleTablePtr[i].Access,
00692                                      ProcessData-&gt;HandleTablePtr[i].ShareAccess,
00693                                      ShareAccess,
00694                                      &amp;ProcessData-&gt;HandleTablePtr[i]
00695                                     );
00696             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
00697         }
00698     }
00699     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ProcessData-&gt;Foo == 0xF00);
00700 
00701     <span class="keywordflow">return</span> STATUS_SUCCESS;
00702 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="w32/ntcon/server/handle.c::InitializeConsoleHandleTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS InitializeConsoleHandleTable           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00057">57</a> of file <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">w32/ntcon/server/handle.c</a>.
<p>
References <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00031">ConsoleHandleLock</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00029">ConsoleHandles</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00028">InitialConsoleHandles</a>, <a class="el" href="../../d3/d2/tnlsxlat_8c-source.html#l00026">NELEM</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00030">NumberOfConsoleHandles</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01266">RtlInitializeCriticalSectionAndSpinCount()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00737">ConServerDllInitialization()</a>.
<p>
<pre class="fragment"><div>00061                    :
00062 
00063     This routine initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> global console handle table.
00064 
00065 Arguments:
00066 
00067     none.
00068 
00069 Return Value:
00070 
00071     none.
00072 
00073 --*/
00074 
00075 {
00076     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00077 
00078     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a26">RtlInitializeCriticalSectionAndSpinCount</a>(&amp;ConsoleHandleLock,
00079                                                       0x80000000);
00080 
00081     RtlZeroMemory(InitialConsoleHandles, <span class="keyword">sizeof</span>(InitialConsoleHandles));
00082     <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a4">ConsoleHandles</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a3">InitialConsoleHandles</a>;
00083     <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a5">NumberOfConsoleHandles</a> = <a class="code" href="../../d2/d3/tnlsxlat_8c.html#a0">NELEM</a>(InitialConsoleHandles);
00084 
00085     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00086 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="w32/ntcon/server/handle.c::InitializeInputHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN InitializeInputHandle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d2/struct__INPUT__INFORMATION.html">PINPUT_INFORMATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>InputBuffer</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01335">1335</a> of file <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">w32/ntcon/server/handle.c</a>.
<p>
References <a class="el" href="../../d4/d3/struct__HANDLE__DATA.html#o5">_HANDLE_DATA::Buffer</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00180">ConsoleHeapAlloc</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00193">ConsoleHeapFree</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00067">HANDLE_TAG</a>, <a class="el" href="../../d0/d3/input_8h-source.html#l00066">_INPUT_READ_HANDLE_DATA::InputHandleFlags</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00318">_HANDLE_DATA::InputReadData</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d3/input_8h-source.html#l00065">_INPUT_READ_HANDLE_DATA::ReadCount</a>, <a class="el" href="../../d0/d3/input_8h-source.html#l00064">_INPUT_READ_HANDLE_DATA::ReadCountLock</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01210">RtlInitializeCriticalSection()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00400">InitializeIoHandleTable()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l02603">SrvDuplicateHandle()</a>, and <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l00080">SrvOpenConsole()</a>.
<p>
<pre class="fragment"><div>01342                    :
01343 
01344     This routine initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input-specific fields of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle data
01345     structure.
01346 
01347 Arguments:
01348 
01349     HandleData - Pointer to handle data structure.
01350 
01351     InputBuffer - Pointer to input buffer data structure.
01352 
01353 Return Value:
01354 
01355 --*/
01356 
01357 {
01358     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01359 
01360     HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a> = (<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html">PINPUT_READ_HANDLE_DATA</a>)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( HANDLE_TAG ),<span class="keyword">sizeof</span>(<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html">INPUT_READ_HANDLE_DATA</a>));
01361     <span class="keywordflow">if</span> (!HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>) {
01362         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01363     }
01364     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a24">RtlInitializeCriticalSection</a>(&amp;HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>-&gt;<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html#o0">ReadCountLock</a>);
01365     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01366         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>);
01367         HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01368         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01369     }
01370     HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>-&gt;<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html#o1">ReadCount</a> = 0;
01371     HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>-&gt;<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html#o2">InputHandleFlags</a> = 0;
01372     HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer = InputBuffer;
01373     HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;RefCount++;
01374     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01375 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="w32/ntcon/server/handle.c::InitializeIoHandleTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS InitializeIoHandleTable           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Console</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>StdIn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>StdOut</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>StdErr</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00400">400</a> of file <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">w32/ntcon/server/handle.c</a>.
<p>
References <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01390">AllocateIoHandle()</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00295">CONSOLE_FREE_HANDLE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00299">CONSOLE_INHERITABLE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00292">CONSOLE_INITIAL_IO_HANDLES</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00026">CONSOLE_INPUT_HANDLE</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00027">CONSOLE_OUTPUT_HANDLE</a>, <a class="el" href="../../d8/d7/share_8c-source.html#l00025">ConsoleAddShare()</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00193">ConsoleHeapFree</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01501">DereferenceIoHandleNoCheck()</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00311">_HANDLE_DATA::HandleType</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00339">INDEX_TO_HANDLE</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01335">InitializeInputHandle()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01307">InitializeOutputHandle()</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00316">_HANDLE_DATA::InputBuffer</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00789">AllocateConsole()</a>.
<p>
<pre class="fragment"><div>00410                    :
00411 
00412     This routine initializes a process's handle table <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first
00413     time (there is no parent process).  It also sets up stdin, stdout,
00414     and stderr.
00415 
00416 Arguments:
00417 
00418     Console - Pointer to console information structure.
00419 
00420     ProcessData - Pointer to per process data structure.
00421 
00422     Stdin - Pointer in which to <span class="keywordflow">return</span> StdIn handle.
00423 
00424     StdOut - Pointer in which to <span class="keywordflow">return</span> StdOut handle.
00425 
00426     StdErr - Pointer in which to <span class="keywordflow">return</span> StdErr handle.
00427 
00428 Return Value:
00429 
00430 --*/
00431 
00432 {
00433     ULONG i;
00434     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00435     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00436     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
00437 
00438     <span class="comment">// HandleTablePtr gets set up by ConsoleAddProcessRoutine.</span>
00439     <span class="comment">// it will be != to HandleTable if the new process was created</span>
00440     <span class="comment">// using "start xxx" at the command line and cmd.exe has &gt;</span>
00441     <span class="comment">// CONSOLE_INITIAL_IO_HANDLES.</span>
00442 
00443     <span class="keywordflow">if</span> (ProcessData-&gt;HandleTablePtr != ProcessData-&gt;HandleTable) {
00444         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ProcessData-&gt;HandleTableSize != CONSOLE_INITIAL_IO_HANDLES);
00445         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ProcessData-&gt;HandleTablePtr);
00446         ProcessData-&gt;HandleTablePtr = ProcessData-&gt;HandleTable;
00447     }
00448 
00449     <span class="keywordflow">for</span> (i=0;i&lt;<a class="code" href="../../d1/d7/server_8h.html#a45">CONSOLE_INITIAL_IO_HANDLES</a>;i++) {
00450         ProcessData-&gt;HandleTable[i].HandleType = <a class="code" href="../../d1/d7/server_8h.html#a47">CONSOLE_FREE_HANDLE</a>;
00451     }
00452 
00453     ProcessData-&gt;HandleTableSize = <a class="code" href="../../d1/d7/server_8h.html#a45">CONSOLE_INITIAL_IO_HANDLES</a>;
00454     ProcessData-&gt;Foo = 0xF00;
00455 
00456     <span class="comment">//</span>
00457     <span class="comment">// set up stdin, stdout, stderr.  we don't do any cleanup in case</span>
00458     <span class="comment">// of errors because we're going to fail the console creation.</span>
00459     <span class="comment">//</span>
00460     <span class="comment">// stdin</span>
00461     <span class="comment">//</span>
00462 
00463     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a28">AllocateIoHandle</a>(ProcessData,
00464                               CONSOLE_INPUT_HANDLE,
00465                               &amp;Handle
00466                              );
00467     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00468         <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00469     }
00470     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a30">DereferenceIoHandleNoCheck</a>(ProcessData,
00471                                  Handle,
00472                                  &amp;HandleData
00473                                 );
00474     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
00475     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00476         <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00477     }
00478     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a27">InitializeInputHandle</a>(HandleData,
00479                                &amp;Console-&gt;InputBuffer)) {
00480         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00481     }
00482     HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a> |= <a class="code" href="../../d1/d7/server_8h.html#a49">CONSOLE_INHERITABLE</a>;
00483     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/share_8c.html#a0">ConsoleAddShare</a>(GENERIC_READ | GENERIC_WRITE,
00484                              FILE_SHARE_READ | FILE_SHARE_WRITE,
00485                              &amp;Console-&gt;InputBuffer.ShareAccess,
00486                              HandleData
00487                             );
00488     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
00489     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00490         <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00491     }
00492     *StdIn = <a class="code" href="../../d1/d7/server_8h.html#a57">INDEX_TO_HANDLE</a>(Handle);
00493 
00494     <span class="comment">//</span>
00495     <span class="comment">// stdout</span>
00496     <span class="comment">//</span>
00497 
00498     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a28">AllocateIoHandle</a>(ProcessData,
00499                               CONSOLE_OUTPUT_HANDLE,
00500                               &amp;Handle
00501                              );
00502     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00503         <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00504     }
00505     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a30">DereferenceIoHandleNoCheck</a>(ProcessData,
00506                                  Handle,
00507                                  &amp;HandleData
00508                                 );
00509     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
00510     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00511         <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00512     }
00513     <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a26">InitializeOutputHandle</a>(HandleData,Console-&gt;CurrentScreenBuffer);
00514     HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a> |= <a class="code" href="../../d1/d7/server_8h.html#a49">CONSOLE_INHERITABLE</a>;
00515     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/share_8c.html#a0">ConsoleAddShare</a>(GENERIC_READ | GENERIC_WRITE,
00516                              FILE_SHARE_READ | FILE_SHARE_WRITE,
00517                              &amp;Console-&gt;ScreenBuffers-&gt;ShareAccess,
00518                              HandleData
00519                             );
00520     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
00521     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00522         <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00523     }
00524     *StdOut = <a class="code" href="../../d1/d7/server_8h.html#a57">INDEX_TO_HANDLE</a>(Handle);
00525 
00526     <span class="comment">//</span>
00527     <span class="comment">// stderr</span>
00528     <span class="comment">//</span>
00529 
00530     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a28">AllocateIoHandle</a>(ProcessData,
00531                               CONSOLE_OUTPUT_HANDLE,
00532                               &amp;Handle
00533                              );
00534     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00535         <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00536     }
00537     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a30">DereferenceIoHandleNoCheck</a>(ProcessData,
00538                                  Handle,
00539                                  &amp;HandleData
00540                                 );
00541     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
00542     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00543         <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00544     }
00545     <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a26">InitializeOutputHandle</a>(HandleData,Console-&gt;CurrentScreenBuffer);
00546     HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a> |= <a class="code" href="../../d1/d7/server_8h.html#a49">CONSOLE_INHERITABLE</a>;
00547     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/share_8c.html#a0">ConsoleAddShare</a>(GENERIC_READ | GENERIC_WRITE,
00548                              FILE_SHARE_READ | FILE_SHARE_WRITE,
00549                              &amp;Console-&gt;ScreenBuffers-&gt;ShareAccess,
00550                              HandleData
00551                             );
00552     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
00553     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00554         <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00555     }
00556     *StdErr = <a class="code" href="../../d1/d7/server_8h.html#a57">INDEX_TO_HANDLE</a>(Handle);
00557     <span class="keywordflow">return</span> STATUS_SUCCESS;
00558 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="w32/ntcon/server/handle.c::InitializeOutputHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID InitializeOutputHandle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ScreenBuffer</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01307">1307</a> of file <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">w32/ntcon/server/handle.c</a>.
<p>
References <a class="el" href="../../d4/d3/struct__HANDLE__DATA.html#o5">_HANDLE_DATA::Buffer</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00400">InitializeIoHandleTable()</a>, <a class="el" href="../../d3/d7/directio_8c-source.html#l01607">SrvCreateConsoleScreenBuffer()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l02603">SrvDuplicateHandle()</a>, and <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l00080">SrvOpenConsole()</a>.
<p>
<pre class="fragment"><div>01314                    :
01315 
01316     This routine initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> output-specific fields of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle data
01317     structure.
01318 
01319 Arguments:
01320 
01321     HandleData - Pointer to handle data structure.
01322 
01323     ScreenBuffer - Pointer to screen buffer data structure.
01324 
01325 Return Value:
01326 
01327 --*/
01328 
01329 {
01330     HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer = ScreenBuffer;
01331     HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;RefCount++;
01332 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="w32/ntcon/server/handle.c::InsertScreenBuffer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID InsertScreenBuffer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Console</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ScreenInfo</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01155">1155</a> of file <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">w32/ntcon/server/handle.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/directio_8c-source.html#l01607">SrvCreateConsoleScreenBuffer()</a>.
<p>
<pre class="fragment"><div>01162                    :
01163 
01164     This routine inserts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> screen buffer pointer into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> console's
01165     list of screen buffers.
01166 
01167 Arguments:
01168 
01169     Console - Pointer to console information structure.
01170 
01171     ScreenInfo - Pointer to screen information structure.
01172 
01173 Return Value:
01174 
01175 Note:
01176 
01177     The console lock must be held when calling <span class="keyword">this</span> routine.
01178 
01179 --*/
01180 
01181 {
01182     ScreenInfo-&gt;Next = Console-&gt;ScreenBuffers;
01183     Console-&gt;ScreenBuffers = ScreenInfo;
01184 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="w32/ntcon/server/handle.c::RemoveScreenBuffer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RemoveScreenBuffer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Console</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ScreenInfo</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01187">1187</a> of file <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">w32/ntcon/server/handle.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d1/output_8h-source.html#l00177">_SCREEN_INFORMATION::Next</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l02929">CloseOutputHandle()</a>.
<p>
<pre class="fragment"><div>01194                    :
01195 
01196     This routine removes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> screen buffer pointer from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> console's
01197     list of screen buffers.
01198 
01199 Arguments:
01200 
01201     Console - Pointer to console information structure.
01202 
01203     ScreenInfo - Pointer to screen information structure.
01204 
01205 Return Value:
01206 
01207 Note:
01208 
01209     The console lock must be held when calling <span class="keyword">this</span> routine.
01210 
01211 --*/
01212 
01213 {
01214     <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> Prev,Cur;
01215 
01216     <span class="keywordflow">if</span> (ScreenInfo == Console-&gt;ScreenBuffers) {
01217         Console-&gt;ScreenBuffers = ScreenInfo-&gt;Next;
01218         <span class="keywordflow">return</span>;
01219     }
01220     Prev = Cur = Console-&gt;ScreenBuffers;
01221     <span class="keywordflow">while</span> (Cur != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01222         <span class="keywordflow">if</span> (ScreenInfo == Cur)
01223             <span class="keywordflow">break</span>;
01224         Prev = Cur;
01225         Cur = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o23">Next</a>;
01226     }
01227     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Cur != NULL);
01228     <span class="keywordflow">if</span> (Cur != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01229         Prev-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o23">Next</a> = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o23">Next</a>;
01230     }
01231 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="w32/ntcon/server/handle.c::RevalidateConsole" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RevalidateConsole           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ConsoleHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>Console</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01686">1686</a> of file <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">w32/ntcon/server/handle.c</a>.
<p>
References <a class="el" href="../../d2/d6/server_8h-source.html#l00107">CONSOLE_IN_DESTRUCTION</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00097">CONSOLE_TERMINATING</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00175">DereferenceConsoleHandle()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01051">DestroyConsole()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00260">LockConsole</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00258">LockConsoleHandleTable</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l04103">UnlockConsole()</a>, and <a class="el" href="../../d9/d4/consrv_8h-source.html#l00259">UnlockConsoleHandleTable</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01627">ApiPreamble()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00705">ConsoleAddProcessRoutine()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01091">ConsoleClientConnectRoutine()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01912">ConsoleClientShutdown()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l00821">ConsoleSetActiveWindow()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l04700">ConsoleWindowProc()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l03139">GetThreadConsoleDesktop()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l01657">ProcessCreateConsoleWindow()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01355">RemoveConsole()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01537">SrvAllocConsole()</a>, and <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l04103">UnlockConsole()</a>.
<p>
<pre class="fragment"><div>01690 {
01691     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01692 
01693     <a class="code" href="../../d8/d5/consrv_8h.html#a40">LockConsoleHandleTable</a>();
01694     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a11">DereferenceConsoleHandle</a>(ConsoleHandle,
01695                                       Console
01696                                      );
01697     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01698         <a class="code" href="../../d8/d5/consrv_8h.html#a41">UnlockConsoleHandleTable</a>();
01699         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01700     }
01701 
01702     <span class="comment">//</span>
01703     <span class="comment">// The WaitCount ensures the console won't go away between the time</span>
01704     <span class="comment">// we unlock the console handle table and we lock the console.</span>
01705     <span class="comment">//</span>
01706 
01707     InterlockedIncrement(&amp;(*Console)-&gt;WaitCount);
01708     <a class="code" href="../../d8/d5/consrv_8h.html#a41">UnlockConsoleHandleTable</a>();
01709     <span class="keywordflow">try</span> {
01710         <a class="code" href="../../d8/d5/consrv_8h.html#a42">LockConsole</a>(*Console);
01711     } except (EXCEPTION_EXECUTE_HANDLER) {
01712         InterlockedDecrement(&amp;(*Console)-&gt;WaitCount);
01713         <span class="keywordflow">return</span> GetExceptionCode();
01714     }
01715     InterlockedDecrement(&amp;(*Console)-&gt;WaitCount);
01716 
01717     <span class="comment">//</span>
01718     <span class="comment">// If the console was marked for destruction while we were waiting to</span>
01719     <span class="comment">// lock it, try to destroy it and return.</span>
01720     <span class="comment">//</span>
01721 
01722     <span class="keywordflow">if</span> ((*Console)-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a22">CONSOLE_IN_DESTRUCTION</a>) {
01723         <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a20">DestroyConsole</a>(*Console);
01724         *Console = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01725         <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
01726     }
01727 
01728     <span class="comment">//</span>
01729     <span class="comment">// If the console was marked for termination while we were waiting to</span>
01730     <span class="comment">// lock it, bail out.</span>
01731     <span class="comment">//</span>
01732 
01733     <span class="keywordflow">if</span> ((*Console)-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a12">CONSOLE_TERMINATING</a>) {
01734         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(*Console);
01735         *Console = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01736         <span class="keywordflow">return</span> STATUS_PROCESS_IS_TERMINATING;
01737     }
01738 
01739     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01740 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="w32/ntcon/server/handle.c::SrvVerifyConsoleIoHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG SrvVerifyConsoleIoHandle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PCSR_API_MSG&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCSR_REPLY_STATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>ReplyStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01582">1582</a> of file <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">w32/ntcon/server/handle.c</a>.
<p>
References <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01627">ApiPreamble()</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00395">CONSOLE_PERPROCESSDATA</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00589">_CONSOLE_VERIFYIOHANDLE_MSG::ConsoleHandle</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01501">DereferenceIoHandleNoCheck()</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00590">_CONSOLE_VERIFYIOHANDLE_MSG::Handle</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00340">HANDLE_TO_INDEX</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l04103">UnlockConsole()</a>, and <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00588">_CONSOLE_VERIFYIOHANDLE_MSG::Valid</a>.
<p>
<pre class="fragment"><div>01589                    :
01590 
01591     This routine verifies that a console io handle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid.
01592 
01593 Arguments:
01594 
01595     ApiMessageData - Points to parameter structure.
01596 
01597 Return Value:
01598 
01599 --*/
01600 
01601 {
01602     <a class="code" href="../../d3/d7/struct__CONSOLE__VERIFYIOHANDLE__MSG.html">PCONSOLE_VERIFYIOHANDLE_MSG</a> a = (<a class="code" href="../../d3/d7/struct__CONSOLE__VERIFYIOHANDLE__MSG.html">PCONSOLE_VERIFYIOHANDLE_MSG</a>)&amp;m-&gt;u.ApiMessageData;
01603     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
01604     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01605     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
01606     <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData;
01607 
01608     UNREFERENCED_PARAMETER(ReplyStatus);
01609 
01610     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d3/d7/struct__CONSOLE__VERIFYIOHANDLE__MSG.html#o1">ConsoleHandle</a>,
01611                          &amp;Console
01612                         );
01613     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01614         ProcessData = <a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>();
01615         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a30">DereferenceIoHandleNoCheck</a>(ProcessData,
01616                                      <a class="code" href="../../d1/d7/server_8h.html#a58">HANDLE_TO_INDEX</a>(a-&gt;<a class="code" href="../../d3/d7/struct__CONSOLE__VERIFYIOHANDLE__MSG.html#o2">Handle</a>),
01617                                      &amp;HandleData
01618                                     );
01619         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01620     }
01621     a-&gt;<a class="code" href="../../d3/d7/struct__CONSOLE__VERIFYIOHANDLE__MSG.html#o0">Valid</a> = (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
01622     <span class="keywordflow">return</span> STATUS_SUCCESS;
01623 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="w32/ntcon/server/handle.c::ValidateConsole" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ValidateConsole           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Console</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00370">370</a> of file <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">w32/ntcon/server/handle.c</a>.
<p>
References <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00029">ConsoleHandles</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00030">NumberOfConsoleHandles</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/output_8c-source.html#l04700">ConsoleWindowProc()</a>, and <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l04103">UnlockConsole()</a>.
<p>
<pre class="fragment"><div>00376                    :
00377 
00378     This routine ensures that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given console pointer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid.
00379 
00380 Arguments:
00381 
00382     Console - Console pointer to validate.
00383 
00384 --*/
00385 
00386 {
00387     ULONG i;
00388 
00389     <span class="keywordflow">if</span> (Console != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00390         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a5">NumberOfConsoleHandles</a>; i++) {
00391             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a4">ConsoleHandles</a>[i] == Console)
00392                 <span class="keywordflow">return</span> STATUS_SUCCESS;
00393         }
00394     }
00395     <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00396 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a6" doxytag="w32/ntcon/server/handle.c::ConsoleHandleLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> CRITICAL_SECTION <a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a6">ConsoleHandleLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00032">32</a> of file <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">w32/ntcon/server/handle.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00057">InitializeConsoleHandleTable()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="w32/ntcon/server/handle.c::ConsoleHandles" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a>* <a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a4">ConsoleHandles</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00029">29</a> of file <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">w32/ntcon/server/handle.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00789">AllocateConsole()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00269">AllocateConsoleHandle()</a>, <a class="el" href="../../d8/d3/conexts_8c-source.html#l00334">dc()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00175">DereferenceConsoleHandle()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01051">DestroyConsole()</a>, <a class="el" href="../../d8/d3/conexts_8c-source.html#l00938">di()</a>, <a class="el" href="../../d8/d3/conexts_8c-source.html#l01556">dmem()</a>, <a class="el" href="../../d8/d3/conexts_8c-source.html#l00650">dt()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00331">FreeConsoleHandle()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00223">GrowConsoleHandleTable()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00057">InitializeConsoleHandleTable()</a>, and <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00370">ValidateConsole()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="w32/ntcon/server/handle.c::ConsoleId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a7">ConsoleId</a> = 47          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00034">34</a> of file <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">w32/ntcon/server/handle.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="w32/ntcon/server/handle.c::InitialConsoleHandles" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> <a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a3">InitialConsoleHandles</a>[CONSOLE_INITIAL_CONSOLES]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00028">28</a> of file <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">w32/ntcon/server/handle.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00223">GrowConsoleHandleTable()</a>, and <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00057">InitializeConsoleHandleTable()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="w32/ntcon/server/handle.c::NumberOfConsoleHandles" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a5">NumberOfConsoleHandles</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00030">30</a> of file <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html">w32/ntcon/server/handle.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00269">AllocateConsoleHandle()</a>, <a class="el" href="../../d8/d3/conexts_8c-source.html#l00334">dc()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00175">DereferenceConsoleHandle()</a>, <a class="el" href="../../d8/d3/conexts_8c-source.html#l00938">di()</a>, <a class="el" href="../../d8/d3/conexts_8c-source.html#l01556">dmem()</a>, <a class="el" href="../../d8/d3/conexts_8c-source.html#l00650">dt()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00331">FreeConsoleHandle()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00223">GrowConsoleHandleTable()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00057">InitializeConsoleHandleTable()</a>, and <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00370">ValidateConsole()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:01 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
