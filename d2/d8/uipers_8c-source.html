<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: uipers.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>uipers.c</h1><a href="../../d1/d9/uipers_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    uipers.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    Temporary security context display command.</span>
00012 <span class="comment"></span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Jim Kelly (JimK) 23-May-1991</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include &lt;nt.h&gt;</span>
00023 <span class="preprocessor">#include &lt;ntrtl.h&gt;</span>
00024 <span class="preprocessor">#include &lt;nturtl.h&gt;</span>
00025 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00026 <span class="preprocessor">#include &lt;string.h&gt;</span>
00027 
<a name="l00028"></a><a class="code" href="../../d1/d9/uipers_8c.html#a0">00028</a> <span class="preprocessor">#define _TST_USER_  // User mode test</span>
00029 <span class="preprocessor"></span>
00030 
00031 <span class="preprocessor">#include "<a class="code" href="../../d4/d6/tsevars_8c.html">tsevars.c</a>"</span>    <span class="comment">// Common test variables</span>
00032 <span class="preprocessor">#include "<a class="code" href="../../d2/d6/tsecomm_8c.html">tsecomm.c</a>"</span>    <span class="comment">// Mode dependent macros and routines.</span>
00033 
00034 
<a name="l00035"></a><a class="code" href="../../d1/d9/uipers_8c.html#a3">00035</a>     GUID <a class="code" href="../../d6/d0/ctaccess_8c.html#a51">SystemAuthenticationId</a> = SYSTEM_GUID;
00036 
00037 
00038 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00039 <a class="code" href="../../d1/d9/uipers_8c.html#a4">DisplaySecurityContext</a>(
00040     IN HANDLE TokenHandle
00041     );
00042 
00043 
00044 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00045 <a class="code" href="../../d1/d9/uipers_8c.html#a5">DisplayAccountSid</a>(
00046     PISID Sid
00047     );
00048 
00049 
00050 BOOLEAN
00051 <a class="code" href="../../d1/d9/uipers_8c.html#a6">SidTranslation</a>(
00052     PSID Sid,
00053     PSTRING AccountName
00054     );
00055 
00056 
00057 
00058 
00060 <span class="comment">//                                                            //</span>
00061 <span class="comment">// Private Macros                                             //</span>
00062 <span class="comment">//                                                            //</span>
00064 <span class="comment"></span>
00065 
<a name="l00066"></a><a class="code" href="../../d1/d9/uipers_8c.html#a1">00066</a> <span class="preprocessor">#define PrintGuid(G)                                                     \</span>
00067 <span class="preprocessor">            printf( "(0x%lx-%hx-%hx-%hx-%hx-%hx-%hx-%hx-%hx-%hx-%hx)\n", \</span>
00068 <span class="preprocessor">                         (G)-&gt;Data1,    (G)-&gt;Data2,    (G)-&gt;Data3,               \</span>
00069 <span class="preprocessor">                         (G)-&gt;Data4[0], (G)-&gt;Data4[1], (G)-&gt;Data4[2],            \</span>
00070 <span class="preprocessor">                         (G)-&gt;Data4[3], (G)-&gt;Data4[4], (G)-&gt;Data4[5],            \</span>
00071 <span class="preprocessor">                         (G)-&gt;Data4[6], (G)-&gt;Data4[7]);                         \</span>
00072 <span class="preprocessor"></span>
00073 <span class="preprocessor"></span>
00074 BOOLEAN
00075 <a class="code" href="../../d1/d9/uipers_8c.html#a6">SidTranslation</a>(
00076     PSID Sid,
00077     PSTRING AccountName
00078     )
00079 <span class="comment">// AccountName is expected to have a large maximum length</span>
00080 
00081 {
00082     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(Sid, <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>)) {
00083         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( AccountName, <span class="stringliteral">"WORLD"</span>);
00084         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00085     }
00086 
00087     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(Sid, <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a9">LocalSid</a>)) {
00088         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( AccountName, <span class="stringliteral">"LOCAL"</span>);
00089 
00090         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00091     }
00092 
00093     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(Sid, <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a13">NetworkSid</a>)) {
00094         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( AccountName, <span class="stringliteral">"NETWORK"</span>);
00095 
00096         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00097     }
00098 
00099     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(Sid, <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a14">BatchSid</a>)) {
00100         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( AccountName, <span class="stringliteral">"BATCH"</span>);
00101 
00102         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00103     }
00104 
00105     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(Sid, <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a15">InteractiveSid</a>)) {
00106         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( AccountName, <span class="stringliteral">"INTERACTIVE"</span>);
00107         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00108     }
00109 
00110     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(Sid, <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a16">LocalSystemSid</a>)) {
00111         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( AccountName, <span class="stringliteral">"SYSTEM"</span>);
00112         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00113     }
00114 
00115     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(Sid, LocalManagerSid)) {
00116         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( AccountName, <span class="stringliteral">"LOCAL MANAGER"</span>);
00117         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00118     }
00119 
00120     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(Sid, LocalAdminSid)) {
00121         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( AccountName, <span class="stringliteral">"LOCAL ADMIN"</span>);
00122         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00123     }
00124 
00125     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00126 
00127 }
00128 
00129 
00130 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00131"></a><a class="code" href="../../d1/d9/uipers_8c.html#a5">00131</a> <a class="code" href="../../d1/d9/uipers_8c.html#a5">DisplayAccountSid</a>(
00132     PISID Sid
00133     )
00134 {
00135     UCHAR <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[128];
00136     STRING AccountName;
00137     UCHAR i;
00138     ULONG Tmp;
00139 
00140     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[0] = 0;
00141 
00142     AccountName.MaximumLength = 127;
00143     AccountName.Length = 0;
00144     AccountName.Buffer = (PVOID)&amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[0];
00145 
00146 
00147 
00148     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/uipers_8c.html#a6">SidTranslation</a>( (PSID)Sid, &amp;AccountName) ) {
00149 
00150         printf(<span class="stringliteral">"%s\n"</span>, AccountName.Buffer );
00151 
00152     } <span class="keywordflow">else</span> {
00153         printf(<span class="stringliteral">"S-%lu-"</span>, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Sid-&gt;Revision );
00154         <span class="keywordflow">if</span> (  (Sid-&gt;IdentifierAuthority.Value[0] != 0)  ||
00155               (Sid-&gt;IdentifierAuthority.Value[1] != 0)     ){
00156             printf(<span class="stringliteral">"0x%02hx%02hx%02hx%02hx%02hx%02hx"</span>,
00157                         (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Sid-&gt;IdentifierAuthority.Value[0],
00158                         (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Sid-&gt;IdentifierAuthority.Value[1],
00159                         (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Sid-&gt;IdentifierAuthority.Value[2],
00160                         (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Sid-&gt;IdentifierAuthority.Value[3],
00161                         (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Sid-&gt;IdentifierAuthority.Value[4],
00162                         (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Sid-&gt;IdentifierAuthority.Value[5] );
00163         } <span class="keywordflow">else</span> {
00164             Tmp = (ULONG)Sid-&gt;IdentifierAuthority.Value[5]          +
00165                   (ULONG)(Sid-&gt;IdentifierAuthority.Value[4] &lt;&lt;  8)  +
00166                   (ULONG)(Sid-&gt;IdentifierAuthority.Value[3] &lt;&lt; 16)  +
00167                   (ULONG)(Sid-&gt;IdentifierAuthority.Value[2] &lt;&lt; 24);
00168             printf(<span class="stringliteral">"%lu"</span>, Tmp);
00169         }
00170 
00171 
00172         <span class="keywordflow">for</span> (i=0;i&lt;Sid-&gt;SubAuthorityCount ;i++ ) {
00173             printf(<span class="stringliteral">"-%lu"</span>, Sid-&gt;SubAuthority[i]);
00174         }
00175         printf(<span class="stringliteral">"\n"</span>);
00176 
00177     }
00178 
00179 }
00180 
00181 
00182 
00183 BOOLEAN
<a name="l00184"></a><a class="code" href="../../d1/d9/uipers_8c.html#a7">00184</a> <a class="code" href="../../d1/d9/uipers_8c.html#a7">DisplayPrivilegeName</a>(
00185     PLUID Privilege
00186     )
00187 {
00188 
00189     <span class="comment">//</span>
00190     <span class="comment">// This should be rewritten to use RtlLookupPrivilegeName.</span>
00191     <span class="comment">//</span>
00192     <span class="comment">// First we should probably spec and write RtlLookupPrivilegeName.</span>
00193     <span class="comment">//</span>
00194 
00195     <span class="keywordflow">if</span> ( ((*Privilege)QuadPart == <a class="code" href="../../d4/d6/tsevars_8c.html#a40">CreateTokenPrivilege</a>.QuadPart))  {
00196         printf(<span class="stringliteral">"SeCreateTokenPrivilege         "</span>);
00197         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00198     }
00199 
00200     <span class="keywordflow">if</span> ( ((*Privilege).QuadPart == <a class="code" href="../../d4/d6/tsevars_8c.html#a41">AssignPrimaryTokenPrivilege</a>.QuadPart))  {
00201         printf(<span class="stringliteral">"SeAssignPrimaryTokenPrivilege  "</span>);
00202         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00203     }
00204 
00205     <span class="keywordflow">if</span> ( ((*Privilege).QuadPart == <a class="code" href="../../d4/d6/tsevars_8c.html#a42">LockMemoryPrivilege</a>.QuadPart))  {
00206         printf(<span class="stringliteral">"SeLockMemoryPrivilege          "</span>);
00207         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00208     }
00209 
00210     <span class="keywordflow">if</span> ( ((*Privilege).QuadPart == <a class="code" href="../../d4/d6/tsevars_8c.html#a43">IncreaseQuotaPrivilege</a>.QuadPart))  {
00211         printf(<span class="stringliteral">"SeIncreaseQuotaPrivilege       "</span>);
00212         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00213     }
00214 
00215     <span class="keywordflow">if</span> ( ((*Privilege).QuadPart == <a class="code" href="../../d4/d6/tsevars_8c.html#a44">UnsolicitedInputPrivilege</a>.QuadPart))  {
00216         printf(<span class="stringliteral">"SeUnsolicitedInputPrivilege    "</span>);
00217         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00218     }
00219 
00220     <span class="keywordflow">if</span> ( ((*Privilege).QuadPart == <a class="code" href="../../d4/d6/tsevars_8c.html#a45">TcbPrivilege</a>.QuadPart))  {
00221         printf(<span class="stringliteral">"SeTcbPrivilege                 "</span>);
00222         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00223     }
00224 
00225     <span class="keywordflow">if</span> ( ((*Privilege).QuadPart == <a class="code" href="../../d4/d6/tsevars_8c.html#a46">SecurityPrivilege</a>.QuadPart))  {
00226         printf(<span class="stringliteral">"SeSecurityPrivilege (Security Operator)  "</span>);
00227         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00228     }
00229 
00230 
00231     <span class="keywordflow">if</span> ( ((*Privilege).QuadPart == <a class="code" href="../../d4/d6/tsevars_8c.html#a47">TakeOwnershipPrivilege</a>.QuadPart)) {
00232         printf(<span class="stringliteral">"SeTakeOwnershipPrivilege              "</span>);
00233         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00234     }
00235 
00236     <span class="keywordflow">if</span> ( ((*Privilege).QuadPart == LpcReplyBoostPrivilege.QuadPart)) {
00237         printf(<span class="stringliteral">"SeLpcReplyBoostPrivilege              "</span>);
00238         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00239     }
00240 
00241     <span class="keywordflow">if</span> ( ((*Privilege).QuadPart == <a class="code" href="../../d4/d6/tsevars_8c.html#a48">CreatePagefilePrivilege</a>.QuadPart)) {
00242         printf(<span class="stringliteral">"SeCreatePagefilePrivilege              "</span>);
00243         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00244     }
00245 
00246     <span class="keywordflow">if</span> ( ((*Privilege).QuadPart == <a class="code" href="../../d4/d6/tsevars_8c.html#a49">IncreaseBasePriorityPrivilege</a>.QuadPart)) {
00247         printf(<span class="stringliteral">"SeIncreaseBasePriorityPrivilege              "</span>);
00248         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00249     }
00250 
00251     <span class="keywordflow">if</span> ( ((*Privilege).QuadPart == <a class="code" href="../../d4/d6/tsevars_8c.html#a50">SystemProfilePrivilege</a>.QuadPart)) {
00252         printf(<span class="stringliteral">"SeSystemProfilePrivilege              "</span>);
00253         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00254     }
00255 
00256     <span class="keywordflow">if</span> ( ((*Privilege).QuadPart == <a class="code" href="../../d4/d6/tsevars_8c.html#a51">SystemtimePrivilege</a>.QuadPart)) {
00257         printf(<span class="stringliteral">"SeSystemtimePrivilege              "</span>);
00258         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00259     }
00260 
00261     <span class="keywordflow">if</span> ( ((*Privilege).QuadPart == <a class="code" href="../../d4/d6/tsevars_8c.html#a52">ProfileSingleProcessPrivilege</a>.QuadPart)) {
00262         printf(<span class="stringliteral">"SeProfileSingleProcessPrivilege              "</span>);
00263         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00264     }
00265 
00266     <span class="keywordflow">if</span> ( ((*Privilege).QuadPart == <a class="code" href="../../d4/d6/tsevars_8c.html#a55">CreatePermanentPrivilege</a>.QuadPart)) {
00267         printf(<span class="stringliteral">"SeCreatePermanentPrivilege              "</span>);
00268         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00269     }
00270 
00271     <span class="keywordflow">if</span> ( ((*Privilege).QuadPart == <a class="code" href="../../d4/d6/tsevars_8c.html#a54">BackupPrivilege</a>.QuadPart)) {
00272         printf(<span class="stringliteral">"SeBackupPrivilege              "</span>);
00273         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00274     }
00275 
00276     <span class="keywordflow">if</span> ( ((*Privilege).QuadPart == <a class="code" href="../../d4/d6/tsevars_8c.html#a53">RestorePrivilege</a>.QuadPart)) {
00277         printf(<span class="stringliteral">"SeRestorePrivilege              "</span>);
00278         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00279     }
00280 
00281     <span class="keywordflow">if</span> ( ((*Privilege).QuadPart == <a class="code" href="../../d4/d6/tsevars_8c.html#a56">ShutdownPrivilege</a>.QuadPart)) {
00282         printf(<span class="stringliteral">"SeShutdownPrivilege             "</span>);
00283         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00284     }
00285 
00286     <span class="keywordflow">if</span> ( ((*Privilege).QuadPart == <a class="code" href="../../d4/d6/tsevars_8c.html#a57">DebugPrivilege</a>.QuadPart)) {
00287         printf(<span class="stringliteral">"SeDebugPrivilege                "</span>);
00288         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00289     }
00290 
00291     <span class="keywordflow">if</span> ( ((*Privilege).QuadPart == SystemEnvironmentPrivilege.QuadPart)) {
00292         printf(<span class="stringliteral">"SeSystemEnvironmentPrivilege    "</span>);
00293         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00294     }
00295 
00296     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00297 
00298 }
00299 
00300 
00301 
00302 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00303"></a><a class="code" href="../../d1/d9/uipers_8c.html#a8">00303</a> <a class="code" href="../../d1/d9/uipers_8c.html#a8">DisplayPrivilege</a>(
00304     PLUID_AND_ATTRIBUTES Privilege
00305     )
00306 {
00307 
00308 
00309     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d9/uipers_8c.html#a7">DisplayPrivilegeName</a>(&amp;Privilege-&gt;Luid)) {
00310         printf(<span class="stringliteral">"(Unknown Privilege.  Value is: (0x%lx,0x%lx))"</span>,
00311                Privilege-&gt;Luid.HighPart,
00312                Privilege-&gt;Luid.LowPart
00313                );
00314     }
00315 
00316 
00317 
00318     <span class="comment">//</span>
00319     <span class="comment">// Display the attributes assigned to the privilege.</span>
00320     <span class="comment">//</span>
00321 
00322     printf(<span class="stringliteral">"\n                           ["</span>);
00323     <span class="keywordflow">if</span> (!(Privilege-&gt;Attributes &amp; SE_PRIVILEGE_ENABLED)) {
00324         printf(<span class="stringliteral">"Not "</span>);
00325     }
00326     printf(<span class="stringliteral">"Enabled"</span>);
00327 
00328     <span class="comment">//printf(" / ");</span>
00329     <span class="comment">//if (!(Privilege-&gt;Attributes &amp; SE_PRIVILEGE_ENABLED_BY_DEFAULT)) {</span>
00330     <span class="comment">//    printf("Not ");</span>
00331     <span class="comment">//}</span>
00332     <span class="comment">//printf("Enabled By Default");</span>
00333 
00334 
00335     printf(<span class="stringliteral">"]\n"</span>);
00336     printf(<span class="stringliteral">"                           "</span>);
00337 
00338 
00339     <span class="keywordflow">return</span>;
00340 
00341 }
00342 
00343 
00344 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00345"></a><a class="code" href="../../d1/d9/uipers_8c.html#a4">00345</a> <a class="code" href="../../d1/d9/uipers_8c.html#a4">DisplaySecurityContext</a>(
00346     IN HANDLE TokenHandle
00347     )
00348 {
00349 
00350 <span class="preprocessor">#define BUFFER_SIZE (2048)</span>
00351 <span class="preprocessor"></span>
00352     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00353     ULONG i;
00354     ULONG ReturnLength;
00355     TOKEN_STATISTICS ProcessTokenStatistics;
00356     GUID AuthenticationId;
00357     UCHAR <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[<a class="code" href="../../d9/d9/tcmpmem_8c.html#a0">BUFFER_SIZE</a>];
00358 
00359 
00360     PTOKEN_USER UserId;
00361     PTOKEN_OWNER DefaultOwner;
00362     PTOKEN_PRIMARY_GROUP PrimaryGroup;
00363     PTOKEN_GROUPS GroupIds;
00364     PTOKEN_PRIVILEGES Privileges;
00365 
00366 
00367 
00368 
00370     <span class="comment">//                                                                     //</span>
00371     <span class="comment">// Logon ID                                                            //</span>
00372     <span class="comment">//                                                                     //</span>
00374 <span class="comment"></span>
00375     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
00376                  TokenHandle,                  <span class="comment">// Handle</span>
00377                  TokenStatistics,              <span class="comment">// TokenInformationClass</span>
00378                  &amp;ProcessTokenStatistics,      <span class="comment">// TokenInformation</span>
00379                  <span class="keyword">sizeof</span>(TOKEN_STATISTICS),     <span class="comment">// TokenInformationLength</span>
00380                  &amp;ReturnLength                 <span class="comment">// ReturnLength</span>
00381                  );
00382     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00383     AuthenticationId = ProcessTokenStatistics.AuthenticationId;
00384 
00385     printf(<span class="stringliteral">"     Logon Session:        "</span>);
00386     <span class="keywordflow">if</span> (RtlEqualGuid(&amp;AuthenticationId, &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a51">SystemAuthenticationId</a> )) {
00387         printf(<span class="stringliteral">"(System Logon Session)\n"</span>);
00388     } <span class="keywordflow">else</span> {
00389         <a class="code" href="../../d1/d9/uipers_8c.html#a1">PrintGuid</a>( &amp;AuthenticationId );
00390     }
00391 
00392 
00393 
00394 
00396     <span class="comment">//                                                                     //</span>
00397     <span class="comment">// User Id                                                             //</span>
00398     <span class="comment">//                                                                     //</span>
00400 <span class="comment"></span>
00401     UserId = (PTOKEN_USER)&amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[0];
00402     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
00403                  TokenHandle,              <span class="comment">// Handle</span>
00404                  TokenUser,                <span class="comment">// TokenInformationClass</span>
00405                  UserId,                   <span class="comment">// TokenInformation</span>
00406                  <a class="code" href="../../d9/d9/tcmpmem_8c.html#a0">BUFFER_SIZE</a>,              <span class="comment">// TokenInformationLength</span>
00407                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
00408                  );
00409 
00410 
00411     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00412 
00413     printf(<span class="stringliteral">"           User id:        "</span>);
00414     <a class="code" href="../../d1/d9/uipers_8c.html#a5">DisplayAccountSid</a>( (PISID)UserId-&gt;User.Sid );
00415 
00416 
00417 
00418 
00419 
00421     <span class="comment">//                                                                     //</span>
00422     <span class="comment">// Default Owner                                                       //</span>
00423     <span class="comment">//                                                                     //</span>
00425 <span class="comment"></span>
00426     DefaultOwner = (PTOKEN_OWNER)&amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[0];
00427 
00428     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
00429                  TokenHandle,              <span class="comment">// Handle</span>
00430                  TokenOwner,               <span class="comment">// TokenInformationClass</span>
00431                  DefaultOwner,             <span class="comment">// TokenInformation</span>
00432                  <a class="code" href="../../d9/d9/tcmpmem_8c.html#a0">BUFFER_SIZE</a>,              <span class="comment">// TokenInformationLength</span>
00433                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
00434                  );
00435 
00436 
00437     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00438 
00439     printf(<span class="stringliteral">"     Default Owner:        "</span>);
00440     <a class="code" href="../../d1/d9/uipers_8c.html#a5">DisplayAccountSid</a>( (PISID)DefaultOwner-&gt;Owner );
00441 
00442 
00443 
00444 
00445 
00446 
00448     <span class="comment">//                                                                     //</span>
00449     <span class="comment">// Primary Group                                                       //</span>
00450     <span class="comment">//                                                                     //</span>
00452 <span class="comment"></span>
00453     PrimaryGroup = (PTOKEN_PRIMARY_GROUP)&amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[0];
00454 
00455     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
00456                  TokenHandle,              <span class="comment">// Handle</span>
00457                  TokenPrimaryGroup,        <span class="comment">// TokenInformationClass</span>
00458                  PrimaryGroup,             <span class="comment">// TokenInformation</span>
00459                  <a class="code" href="../../d9/d9/tcmpmem_8c.html#a0">BUFFER_SIZE</a>,              <span class="comment">// TokenInformationLength</span>
00460                  &amp;ReturnLength             <span class="comment">// ReturnLength</span>
00461                  );
00462 
00463 
00464     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00465 
00466     printf(<span class="stringliteral">"     Primary Group:        "</span>);
00467     <a class="code" href="../../d1/d9/uipers_8c.html#a5">DisplayAccountSid</a>( (PISID)PrimaryGroup-&gt;PrimaryGroup );
00468 
00469 
00470 
00471 
00472 
00473 
00475     <span class="comment">//                                                                     //</span>
00476     <span class="comment">// Group Ids                                                           //</span>
00477     <span class="comment">//                                                                     //</span>
00479 <span class="comment"></span>
00480     printf(<span class="stringliteral">"\n"</span>);
00481     GroupIds = (PTOKEN_GROUPS)&amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[0];
00482     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>   = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
00483                    TokenHandle,              <span class="comment">// Handle</span>
00484                    TokenGroups,              <span class="comment">// TokenInformationClass</span>
00485                    GroupIds,                 <span class="comment">// TokenInformation</span>
00486                    <a class="code" href="../../d9/d9/tcmpmem_8c.html#a0">BUFFER_SIZE</a>,              <span class="comment">// TokenInformationLength</span>
00487                    &amp;ReturnLength             <span class="comment">// ReturnLength</span>
00488                    );
00489 
00490 
00491     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00492 
00493     <span class="comment">//printf("  Number of groups:        %ld\n", GroupIds-&gt;GroupCount);</span>
00494     printf(<span class="stringliteral">"            Groups:        "</span>);
00495 
00496     <span class="keywordflow">for</span> (i=0; i &lt; GroupIds-&gt;GroupCount; i++ ) {
00497         <span class="comment">//printf("                           Group %ld: ", i);</span>
00498         <a class="code" href="../../d1/d9/uipers_8c.html#a5">DisplayAccountSid</a>( (PISID)GroupIds-&gt;Groups[i].Sid );
00499         printf(<span class="stringliteral">"                           "</span>);
00500     }
00501 
00502 
00503 
00504 
00505 
00507     <span class="comment">//                                                                     //</span>
00508     <span class="comment">// Privileges                                                          //</span>
00509     <span class="comment">//                                                                     //</span>
00511 <span class="comment"></span>
00512     printf(<span class="stringliteral">"\n"</span>);
00513     Privileges = (PTOKEN_PRIVILEGES)&amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[0];
00514     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>   = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
00515                    TokenHandle,              <span class="comment">// Handle</span>
00516                    TokenPrivileges,          <span class="comment">// TokenInformationClass</span>
00517                    Privileges,               <span class="comment">// TokenInformation</span>
00518                    <a class="code" href="../../d9/d9/tcmpmem_8c.html#a0">BUFFER_SIZE</a>,              <span class="comment">// TokenInformationLength</span>
00519                    &amp;ReturnLength             <span class="comment">// ReturnLength</span>
00520                    );
00521 
00522 
00523     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00524 
00525     printf(<span class="stringliteral">"        Privileges:        "</span>);
00526     <span class="keywordflow">if</span> (Privileges-&gt;PrivilegeCount &gt; 0) {
00527 
00528         <span class="keywordflow">for</span> (i=0; i &lt; Privileges-&gt;PrivilegeCount; i++ ) {
00529             <a class="code" href="../../d1/d9/uipers_8c.html#a8">DisplayPrivilege</a>( &amp;(Privileges-&gt;Privileges[i]) );
00530         }
00531     } <span class="keywordflow">else</span> {
00532         printf(<span class="stringliteral">"(none assigned)\n"</span>);
00533     }
00534 
00535 
00536 
00537     <span class="keywordflow">return</span>;
00538 
00539 }
00540 
00541 
00542 BOOLEAN
<a name="l00543"></a><a class="code" href="../../d1/d9/uipers_8c.html#a9">00543</a> <a class="code" href="../../d2/d5/editreg_8c.html#a87">main</a>()
00544 {
00545 
00546     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00547     HANDLE <a class="code" href="../../d2/d1/cttoken_8c.html#a29">ProcessToken</a>;
00548 
00549 
00550     <a class="code" href="../../d4/d6/tsevars_8c.html#a65">TSeVariableInitialization</a>();    <span class="comment">// Initialize global variables</span>
00551 
00552     printf(<span class="stringliteral">"\n"</span>);
00553 
00554 
00555     <span class="comment">//</span>
00556     <span class="comment">// Open our process token</span>
00557     <span class="comment">//</span>
00558 
00559     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a1">NtOpenProcessToken</a>(
00560                  NtCurrentProcess(),
00561                  TOKEN_QUERY,
00562                  &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a29">ProcessToken</a>
00563                  );
00564     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00565         printf(<span class="stringliteral">"I'm terribly sorry, but you don't seem to have access to\n"</span>);
00566         printf(<span class="stringliteral">"open your own process's token.\n"</span>);
00567         printf(<span class="stringliteral">"\n"</span>);
00568         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00569     }
00570 
00571     printf(<span class="stringliteral">"Your process level security context is:\n"</span>);
00572     printf(<span class="stringliteral">"\n"</span>);
00573     <a class="code" href="../../d1/d9/uipers_8c.html#a4">DisplaySecurityContext</a>( <a class="code" href="../../d2/d1/cttoken_8c.html#a29">ProcessToken</a> );
00574 
00575 
00576     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( <a class="code" href="../../d2/d1/cttoken_8c.html#a29">ProcessToken</a> );
00577 
00578     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00579 }
00580 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:11 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
