<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ddemlsvr.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ddemlsvr.c</h1><a href="../../d1/d4/ddemlsvr_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: ddemlsvr.C</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* DDE Manager main module - Contains all server side ddeml functions.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* 27-Aug-1991 Sanford Staab   Created</span>
00009 <span class="comment">* 21-Jan-1992 IanJa           ANSI/Unicode neutralized</span>
00010 <span class="comment">\***************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span>
00015 <span class="comment">// globals</span>
00016 
<a name="l00017"></a><a class="code" href="../../d1/d4/ddemlsvr_8c.html#a0">00017</a> <a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html">PSVR_INSTANCE_INFO</a> <a class="code" href="../../d1/d4/ddemlsvr_8c.html#a0">psiiList</a>;
00018 
<a name="l00019"></a><a class="code" href="../../d2/d4/ddemlsvr_8h.html#a8">00019</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d2/d4/ddemlsvr_8h.html#a8">xxxCsDdeInitialize</a>(
00020 PHANDLE phInst,
00021 HWND *phwndEvent,
00022 LPDWORD pMonitorFlags,
00023 DWORD afCmd,
00024 PVOID pcii)
00025 {
00026     <a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html">PSVR_INSTANCE_INFO</a> psii;
00027     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>        ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00028 
00029     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00030 
00031     psii = (<a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html">PSVR_INSTANCE_INFO</a>)<a class="code" href="../../d4/d1/userk_8h.html#a969">HMAllocObject</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00032             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a245">TYPE_DDEACCESS</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html">SVR_INSTANCE_INFO</a>));
00033     <span class="keywordflow">if</span> (psii == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00034         <span class="keywordflow">return</span> DMLERR_SYS_ERROR;
00035     }
00036 
00037     <span class="comment">/*</span>
00038 <span class="comment">     * We have to tell CreateWindow that window is not created for the same</span>
00039 <span class="comment">     * module has the app, (CW_FLAGS_DIFFHMOD), so CreateWindow doesn't</span>
00040 <span class="comment">     * assign a hotkey to this window.  Other window are done in the</span>
00041 <span class="comment">     * client-server thunk</span>
00042 <span class="comment">     */</span>
00043     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(psii-&gt;<a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html#o4">spwndEvent</a>), <a class="code" href="../../d4/d8/createw_8c.html#a1">xxxCreateWindowEx</a>(
00044             0,
00045             (<a class="code" href="../../d1/d9/struct__LARGE__STRING.html">PLARGE_STRING</a>)<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a82">ICLS_DDEMLEVENT</a>],
00046             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00047             WS_POPUP | WS_CHILD,
00048             0, 0, 0, 0,
00049             (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00050             (<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00051             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a273">hModuleWin</a>,
00052             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00053             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a771">CW_FLAGS_DIFFHMOD</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a102">VER31</a>));
00054 
00055     <span class="keywordflow">if</span> (psii-&gt;<a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html#o4">spwndEvent</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00056         <a class="code" href="../../d4/d1/userk_8h.html#a970">HMFreeObject</a>((PVOID)psii);
00057         <span class="keywordflow">return</span> DMLERR_SYS_ERROR;
00058     }
00059     <span class="comment">/*</span>
00060 <span class="comment">     * This GWL offset does NOT leave the critical section!</span>
00061 <span class="comment">     */</span>
00062     <a class="code" href="../../d4/d1/userk_8h.html#a586">xxxSetWindowLongPtr</a>(psii-&gt;<a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html#o4">spwndEvent</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a161">GWLP_PSII</a>, (LONG_PTR)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(psii), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00063     psii-&gt;afCmd = 0;
00064     psii-&gt;pcii = pcii;
00065     <span class="comment">//</span>
00066     <span class="comment">// Link into global list</span>
00067     <span class="comment">//</span>
00068     psii-&gt;next = <a class="code" href="../../d1/d4/ddemlsvr_8c.html#a0">psiiList</a>;
00069     <a class="code" href="../../d1/d4/ddemlsvr_8c.html#a0">psiiList</a> = psii;
00070 
00071     <span class="comment">//</span>
00072     <span class="comment">// Link into per-process list</span>
00073     <span class="comment">//</span>
00074     psii-&gt;<a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html#o2">nextInThisThread</a> = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o24">psiiList</a>;
00075     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o24">psiiList</a> = psii;
00076 
00077     *phInst = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(psii);
00078     *phwndEvent = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(psii-&gt;spwndEvent);
00079     <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a8">xxxChangeMonitorFlags</a>(psii, afCmd);        <span class="comment">// sets psii-&gt;afCmd;</span>
00080     *pMonitorFlags = <a class="code" href="../../d2/d4/ddemlsvr_8h.html#a2">MonitorFlags</a>;
00081     <span class="keywordflow">return</span> DMLERR_NO_ERROR;
00082 }
00083 
00084 
00085 
00086 
00087 
<a name="l00088"></a><a class="code" href="../../d2/d4/ddemlsvr_8h.html#a9">00088</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d2/d4/ddemlsvr_8h.html#a9">_CsUpdateInstance</a>(
00089 HANDLE hInst,
00090 LPDWORD pMonitorFlags,
00091 DWORD afCmd)
00092 {
00093     <a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html">PSVR_INSTANCE_INFO</a> psii;
00094 
00095     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00096 
00097     psii = (<a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html">PSVR_INSTANCE_INFO</a>)<a class="code" href="../../d6/d9/rtl_2wow_8c.html#a8">HMValidateHandleNoRip</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a0">hInst</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a245">TYPE_DDEACCESS</a>);
00098     <span class="keywordflow">if</span> (psii == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00099         <span class="keywordflow">return</span> DMLERR_INVALIDPARAMETER;
00100     }
00101     <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a8">xxxChangeMonitorFlags</a>(psii, afCmd);
00102     *pMonitorFlags = <a class="code" href="../../d2/d4/ddemlsvr_8h.html#a2">MonitorFlags</a>;
00103     <span class="keywordflow">return</span> DMLERR_NO_ERROR;
00104 }
00105 
00106 
00107 
00108 
00109 
<a name="l00110"></a><a class="code" href="../../d2/d4/ddemlsvr_8h.html#a10">00110</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d4/ddemlsvr_8h.html#a10">_CsDdeUninitialize</a>(
00111 HANDLE hInst)
00112 {
00113     <a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html">PSVR_INSTANCE_INFO</a> psii;
00114 
00115     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00116 
00117     psii = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a8">HMValidateHandleNoRip</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a0">hInst</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a245">TYPE_DDEACCESS</a>);
00118     <span class="keywordflow">if</span> (psii == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00119         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00120     }
00121 
00122     <a class="code" href="../../d2/d4/ddemlsvr_8h.html#a11">xxxDestroyThreadDDEObject</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), psii);
00123     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00124 }
00125 
00126 
<a name="l00127"></a><a class="code" href="../../d2/d4/ddemlsvr_8h.html#a11">00127</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d2/d4/ddemlsvr_8h.html#a11">xxxDestroyThreadDDEObject</a>(
00128 <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti,
00129 <a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html">PSVR_INSTANCE_INFO</a> psii)
00130 {
00131     <a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html">PSVR_INSTANCE_INFO</a> psiiT;
00132 
00133     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00134 
00135     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a438">HMIsMarkDestroy</a>(psii)) {
00136         <span class="keywordflow">return</span>;
00137     }
00138 
00139     <span class="comment">//</span>
00140     <span class="comment">// Unlink psii from the global list.</span>
00141     <span class="comment">//</span>
00142     <span class="keywordflow">if</span> (psii == <a class="code" href="../../d1/d4/ddemlsvr_8c.html#a0">psiiList</a>) {
00143         <a class="code" href="../../d1/d4/ddemlsvr_8c.html#a0">psiiList</a> = psii-&gt;<a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html#o1">next</a>;
00144     } <span class="keywordflow">else</span> {
00145         <span class="keywordflow">for</span> (psiiT = <a class="code" href="../../d1/d4/ddemlsvr_8c.html#a0">psiiList</a>; psiiT-&gt;<a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html#o1">next</a> != psii; psiiT = psiiT-&gt;<a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html#o1">next</a>) {
00146             UserAssert(psiiT-&gt;<a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html#o1">next</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00147         }
00148         psiiT-&gt;<a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html#o1">next</a> = psii-&gt;<a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html#o1">next</a>;
00149     }
00150     <span class="comment">// psii-&gt;next = NULL;</span>
00151 
00152     <span class="comment">//</span>
00153     <span class="comment">// Unlink psii from the per-process list.</span>
00154     <span class="comment">//</span>
00155     <span class="keywordflow">if</span> (psii == pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o24">psiiList</a>) {
00156         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o24">psiiList</a> = psii-&gt;<a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html#o2">nextInThisThread</a>;
00157     } <span class="keywordflow">else</span> {
00158         <span class="keywordflow">for</span> (psiiT = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o24">psiiList</a>; psiiT-&gt;<a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html#o2">nextInThisThread</a> != psii; psiiT = psiiT-&gt;<a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html#o2">nextInThisThread</a>) {
00159             UserAssert(psiiT-&gt;<a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html#o2">nextInThisThread</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00160         }
00161         psiiT-&gt;<a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html#o2">nextInThisThread</a> = psii-&gt;<a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html#o2">nextInThisThread</a>;
00162     }
00163     <span class="comment">// psii-&gt;nextInThisThread = NULL;</span>
00164 
00165     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a971">HMMarkObjectDestroy</a>(psii)) {
00166         <a class="code" href="../../d4/d1/userk_8h.html#a1575">xxxDestroyWindow</a>(psii-&gt;<a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html#o4">spwndEvent</a>);
00167         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;(psii-&gt;<a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html#o4">spwndEvent</a>));
00168 
00169         <a class="code" href="../../d4/d1/userk_8h.html#a970">HMFreeObject</a>(psii);
00170     }
00171 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:39 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
