<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: io/query.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>query.c File Reference</h1><code>#include "<a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>"</code><br>

<p>
<a href="../../d3/d2/io_2query_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d4/struct__IO__QUERY__DESC.html">_IO_QUERY_DESC</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/io_2query_8c.html#a0">UNICODE_NUM_LENGTH</a>&nbsp;&nbsp;&nbsp;14</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/io_2query_8c.html#a1">UNICODE_REGISTRY_PATH_LENGTH</a>&nbsp;&nbsp;&nbsp;1024</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d5/d4/struct__IO__QUERY__DESC.html">_IO_QUERY_DESC</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/io_2query_8c.html#a2">IO_QUERY_DESC</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d5/d4/struct__IO__QUERY__DESC.html">_IO_QUERY_DESC</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/io_2query_8c.html#a3">PIO_QUERY_DESC</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/io_2query_8c.html#a4">pIoQueryBusDescription</a> (<a class="el" href="../../d5/d4/struct__IO__QUERY__DESC.html">PIO_QUERY_DESC</a> QueryDescription, UNICODE_STRING PathName, HANDLE RootHandle, PULONG BusNum, BOOLEAN HighKey)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/io_2query_8c.html#a5">pIoQueryDeviceDescription</a> (<a class="el" href="../../d5/d4/struct__IO__QUERY__DESC.html">PIO_QUERY_DESC</a> QueryDescription, UNICODE_STRING PathName, HANDLE RootHandle, ULONG BusNum, PKEY_VALUE_FULL_INFORMATION *BusValueInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/io_2query_8c.html#a6">IoQueryDeviceDescription</a> (IN PINTERFACE_TYPE BusType OPTIONAL, IN PULONG <a class="el" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> OPTIONAL, IN <a class="el" href="../../d1/d9/arc_8h.html#a57">PCONFIGURATION_TYPE</a> ControllerType OPTIONAL, IN PULONG ControllerNumber OPTIONAL, IN <a class="el" href="../../d1/d9/arc_8h.html#a57">PCONFIGURATION_TYPE</a> PeripheralType OPTIONAL, IN PULONG PeripheralNumber OPTIONAL, IN <a class="el" href="../../d0/d5/io_8h.html#a272">PIO_QUERY_DEVICE_ROUTINE</a> CalloutRoutine, IN PVOID Context)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="io/query.c::UNICODE_NUM_LENGTH" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UNICODE_NUM_LENGTH&nbsp;&nbsp;&nbsp;14          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00565">pIoQueryDeviceDescription()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="io/query.c::UNICODE_REGISTRY_PATH_LENGTH" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UNICODE_REGISTRY_PATH_LENGTH&nbsp;&nbsp;&nbsp;1024          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00070">IoQueryDeviceDescription()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a2" doxytag="io/query.c::IO_QUERY_DESC" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d5/d4/struct__IO__QUERY__DESC.html">_IO_QUERY_DESC</a>  <a class="el" href="../../d5/d4/struct__IO__QUERY__DESC.html">IO_QUERY_DESC</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="io/query.c::PIO_QUERY_DESC" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d5/d4/struct__IO__QUERY__DESC.html">_IO_QUERY_DESC</a> * <a class="el" href="../../d5/d4/struct__IO__QUERY__DESC.html">PIO_QUERY_DESC</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a6" doxytag="io/query.c::IoQueryDeviceDescription" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IoQueryDeviceDescription           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PINTERFACE_TYPE BusType&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG <a class="el" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d9/arc_8h.html#a57">PCONFIGURATION_TYPE</a> ControllerType&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG ControllerNumber&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d9/arc_8h.html#a57">PCONFIGURATION_TYPE</a> PeripheralType&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG PeripheralNumber&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d5/io_8h.html#a272">PIO_QUERY_DEVICE_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CalloutRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00070">70</a> of file <a class="el" href="../../d3/d2/io_2query_8c-source.html">io/query.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d6/hal_8h-source.html#l01170">BusNumber</a>, <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00031">_IO_QUERY_DESC::BusNumber</a>, <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00030">_IO_QUERY_DESC::BusType</a>, <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00036">_IO_QUERY_DESC::CalloutRoutine</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00170">CmRegistryMachineHardwareDescriptionSystemName</a>, <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00037">_IO_QUERY_DESC::Context</a>, <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00033">_IO_QUERY_DESC::ControllerNumber</a>, <a class="el" href="../../d4/d9/arcinst_8h.html#a174a65">ControllerType</a>, <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00032">_IO_QUERY_DESC::ControllerType</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00035">_IO_QUERY_DESC::PeripheralNumber</a>, <a class="el" href="../../d4/d9/arcinst_8h.html#a174a66">PeripheralType</a>, <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00034">_IO_QUERY_DESC::PeripheralType</a>, <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00223">pIoQueryBusDescription()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01883">RtlAppendUnicodeStringToString()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d3/io_2query_8c.html#a1">UNICODE_REGISTRY_PATH_LENGTH</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/fsvga_8c-source.html#l00649">FsVgaConfiguration()</a>, <a class="el" href="../../d3/d4/mapper_8c-source.html#l00658">MapperCallback()</a>, and <a class="el" href="../../d3/d4/mapper_8c-source.html#l01009">MapperProcessFirmwareTree()</a>.
<p>
<pre class="fragment"><div>00083                    :
00084 
00085 
00086 Arguments:
00087 
00088     BusType - Supplies an optional bus <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> being searched <span class="keywordflow">for</span> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00089         description tree. Valid types are Mca, Isa, Eisa ... If no bus <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>
00090         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system information (i.e. machine BIOS) <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00091 
00092     <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> - Supplies an optional value determining which bus should be
00093         queried.
00094 
00095     <a class="code" href="../../d4/d9/arcinst_8h.html#a174a65">ControllerType</a> - Supplies an optional controller <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> being searched <span class="keywordflow">for</span>.
00096         If no Controller <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified, <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Bus information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00097         returned.
00098 
00099     ControllerNumber - Supplies an optional value determining which
00100         controller should be queried.
00101 
00102     <a class="code" href="../../d4/d9/arcinst_8h.html#a174a66">PeripheralType</a> - Supplies an optional peripheral <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> being searched <span class="keywordflow">for</span>.
00103         If no Controller <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified, <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Bus information and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00104         controller information are returned.
00105 
00106     PeripheralNumber - Supplies an optional value determining which
00107         peripheral should be queried.
00108 
00109     CalloutRoutine - Supplies a pointer to a routine that gets called
00110        <span class="keywordflow">for</span> each successful match of <a class="code" href="../../d4/d9/arcinst_8h.html#a174a66">PeripheralType</a>.
00111 
00112     Context - Supplies a context value that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> passed back to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback
00113         routine.
00114 
00115 Return Value:
00116 
00117     The status returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> completion status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
00118 
00119 Notes:
00120 
00121 --*/
00122 
00123 {
00124 
00125 <span class="preprocessor">#define UNICODE_NUM_LENGTH 14</span>
00126 <span class="preprocessor"></span><span class="preprocessor">#define UNICODE_REGISTRY_PATH_LENGTH 1024</span>
00127 <span class="preprocessor"></span>
00128     <a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html">IO_QUERY_DESC</a> queryDesc;
00129 
00130     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00131     UNICODE_STRING registryPathName;
00132     HANDLE rootHandle;
00133     ULONG busNumber = (ULONG) -1;
00134 
00135 
00136     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00137 
00138     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( CalloutRoutine != NULL );
00139 
00140     <span class="comment">//</span>
00141     <span class="comment">// Check if we need to return the machine information</span>
00142     <span class="comment">//</span>
00143 
00144     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( BusType )) {
00145         <span class="keywordflow">return</span> STATUS_NOT_IMPLEMENTED;
00146     }
00147 
00148     queryDesc.<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o0">BusType</a> = BusType;
00149     queryDesc.<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o1">BusNumber</a> = <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>;
00150     queryDesc.<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o2">ControllerType</a> = <a class="code" href="../../d4/d9/arcinst_8h.html#a174a65">ControllerType</a>;
00151     queryDesc.<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o3">ControllerNumber</a> = ControllerNumber;
00152     queryDesc.<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o4">PeripheralType</a> = <a class="code" href="../../d4/d9/arcinst_8h.html#a174a66">PeripheralType</a>;
00153     queryDesc.<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o5">PeripheralNumber</a> = PeripheralNumber;
00154     queryDesc.<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o6">CalloutRoutine</a> = CalloutRoutine;
00155     queryDesc.<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o7">Context</a> = Context;
00156 
00157 
00158     <span class="comment">//</span>
00159     <span class="comment">// Set up a string with the pathname to the hardware description</span>
00160     <span class="comment">// portion of the registry.</span>
00161     <span class="comment">//</span>
00162 
00163     registryPathName.Length = 0;
00164     registryPathName.MaximumLength = <a class="code" href="../../d2/d3/io_2query_8c.html#a1">UNICODE_REGISTRY_PATH_LENGTH</a> *
00165                                      <span class="keyword">sizeof</span>(WCHAR);
00166 
00167     registryPathName.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool,
00168                                                      UNICODE_REGISTRY_PATH_LENGTH,
00169                                                      'mNoI' );
00170 
00171     <span class="keywordflow">if</span> (!registryPathName.Buffer) {
00172 
00173         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00174 
00175     }
00176 
00177     <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>( &amp;registryPathName,
00178                                     &amp;CmRegistryMachineHardwareDescriptionSystemName );
00179 
00180 
00181     <span class="comment">//</span>
00182     <span class="comment">// Open a handle to the root path we have.</span>
00183     <span class="comment">//</span>
00184 
00185     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>( &amp;rootHandle,
00186                                  (HANDLE) NULL,
00187                                  &amp;registryPathName,
00188                                  KEY_READ,
00189                                  FALSE );
00190 
00191     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00192 
00193         status = <a class="code" href="../../d2/d3/io_2query_8c.html#a4">pIoQueryBusDescription</a>(&amp;queryDesc,
00194                                         registryPathName,
00195                                         rootHandle,
00196                                         &amp;busNumber,
00197                                         TRUE );
00198 
00199         ZwClose( rootHandle );
00200 
00201     }
00202 
00203     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( registryPathName.Buffer );
00204 
00205     <span class="comment">//</span>
00206     <span class="comment">// For compatibility with old version of the function.</span>
00207     <span class="comment">//</span>
00208 
00209     <span class="keywordflow">if</span> (status == STATUS_NO_MORE_ENTRIES) {
00210 
00211         <span class="keywordflow">return</span> STATUS_OBJECT_NAME_NOT_FOUND;
00212 
00213 
00214     } <span class="keywordflow">else</span> {
00215 
00216         <span class="keywordflow">return</span> status;
00217 
00218     }
00219 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="io/query.c::pIoQueryBusDescription" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS pIoQueryBusDescription           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d4/struct__IO__QUERY__DESC.html">PIO_QUERY_DESC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>QueryDescription</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>PathName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>RootHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BusNum</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>HighKey</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00223">223</a> of file <a class="el" href="../../d3/d2/io_2query_8c-source.html">io/query.c</a>.
<p>
References <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00031">_IO_QUERY_DESC::BusNumber</a>, <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00030">_IO_QUERY_DESC::BusType</a>, <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00036">_IO_QUERY_DESC::CalloutRoutine</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00338">CmTypeString</a>, <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00037">_IO_QUERY_DESC::Context</a>, <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00032">_IO_QUERY_DESC::ControllerType</a>, <a class="el" href="../../d1/d9/arc_8h.html#a315a195">EisaAdapter</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02462">IopGetRegistryKeyInformation()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02637">IopGetRegistryValues()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d0/d5/io_8h.html#a599a403">IoQueryDeviceConfigurationData</a>, <a class="el" href="../../d0/d5/io_8h.html#a599a405">IoQueryDeviceMaxData</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d1/d9/arc_8h.html#a315a199">MultiFunctionAdapter</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00565">pIoQueryDeviceDescription()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01883">RtlAppendUnicodeStringToString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01821">RtlAppendUnicodeToString()</a>, <a class="el" href="../../d1/d9/arc_8h.html#a315a196">TcAdapter</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00070">IoQueryDeviceDescription()</a>.
<p>
<pre class="fragment"><div>00233                    :
00234 
00235 
00236 Arguments:
00237 
00238     QueryDescription - <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> containing all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query information requested
00239         by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver.
00240 
00241     PathName - Registry <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key we are dealing with.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00242         a unicode strig so that we don'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> have to bother with resetting NULLs
00243         at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> string - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length determines how much of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00244         string <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid.
00245 
00246     RootHandle - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> equivalent to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.
00247 
00248     BusNum - Pointer to a variable that keeps track of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bus number we are
00249         searching <span class="keywordflow">for</span> (buses have to be accumulated.
00250 
00251     HighKey - Determines <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a <a class="code" href="../../d2/d3/fetypes_8h.html#a457a417">high</a> key (a root key with a list of
00252         bus types) or a <a class="code" href="../../d2/d3/fetypes_8h.html#a457a418">low</a> level key (under which the number of the various
00253         buses will be little).
00254 
00255 Return Value:
00256 
00257     The status returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> completion status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
00258 
00259 Notes:
00260 
00261 --*/
00262 
00263 {
00264     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00265     ULONG i;
00266     UNICODE_STRING unicodeString;
00267 
00268     UNICODE_STRING registryPathName;
00269 
00270     ULONG keyBasicInformationSize;
00271     PKEY_BASIC_INFORMATION keyBasicInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00272     HANDLE handle;
00273 
00274     PKEY_FULL_INFORMATION keyInformation;
00275     ULONG size;
00276 
00277     PKEY_VALUE_FULL_INFORMATION busValueInfo[<a class="code" href="../../d0/d5/io_8h.html#a599a405">IoQueryDeviceMaxData</a>];
00278 
00279 
00280     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00281 
00282     status = <a class="code" href="../../d0/d6/iop_8h.html#a179">IopGetRegistryKeyInformation</a>( RootHandle,
00283                                            &amp;keyInformation );
00284 
00285     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00286 
00287         <span class="comment">//</span>
00288         <span class="comment">// With the keyInformation, allocate a buffer that will be large</span>
00289         <span class="comment">// enough for all the subkeys</span>
00290         <span class="comment">//</span>
00291 
00292         keyBasicInformationSize = keyInformation-&gt;MaxNameLen +
00293                                   <span class="keyword">sizeof</span>(KEY_NODE_INFORMATION);
00294 
00295         keyBasicInformation = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool,
00296                                                      keyBasicInformationSize,
00297                                                      'mNoI' );
00298 
00299         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyInformation);
00300 
00301         <span class="keywordflow">if</span> (keyBasicInformation == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00302 
00303             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00304 
00305         }
00306     }
00307 
00308     <span class="comment">//</span>
00309     <span class="comment">// Now we need to enumerate the keys and see if one of them is a bus</span>
00310     <span class="comment">//</span>
00311 
00312     <span class="keywordflow">for</span> (i = 0; <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ); i++) {
00313 
00314 
00315         <span class="comment">//</span>
00316         <span class="comment">// If we have found the Bus we are looking for, break</span>
00317         <span class="comment">//</span>
00318 
00319         <span class="keywordflow">if</span> ((ARGUMENT_PRESENT( QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o1">BusNumber</a> )) &amp;&amp;
00320             (*(QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o1">BusNumber</a>) == *BusNum)) {
00321 
00322             <span class="keywordflow">break</span>;
00323 
00324         }
00325 
00326         status = ZwEnumerateKey( RootHandle,
00327                                  i,
00328                                  KeyBasicInformation,
00329                                  keyBasicInformation,
00330                                  keyBasicInformationSize,
00331                                  &amp;size );
00332 
00333         <span class="comment">//</span>
00334         <span class="comment">// If the sub function enumerated all the buses till the end, then</span>
00335         <span class="comment">// treat that as success.</span>
00336         <span class="comment">//</span>
00337 
00338         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00339 
00340             <span class="keywordflow">break</span>;
00341 
00342         }
00343 
00344         <span class="comment">//</span>
00345         <span class="comment">// Only if this is a high key (otherwise we are in the callback</span>
00346         <span class="comment">// pass which we will process later on).</span>
00347         <span class="comment">//</span>
00348         <span class="comment">// If the string is any valid bus string, then we have to go down</span>
00349         <span class="comment">// the tree recursively.</span>
00350         <span class="comment">// Otherwise, go on to the next key.</span>
00351         <span class="comment">//</span>
00352 
00353         <span class="keywordflow">if</span> (HighKey) {
00354 
00355             <span class="keywordflow">if</span> (wcsncmp( keyBasicInformation-&gt;Name,
00356                          CmTypeString[MultiFunctionAdapter],
00357                          keyBasicInformation-&gt;NameLength / <span class="keyword">sizeof</span>(WCHAR) )  &amp;&amp;
00358                 wcsncmp( keyBasicInformation-&gt;Name,
00359                          CmTypeString[EisaAdapter],
00360                          keyBasicInformation-&gt;NameLength / <span class="keyword">sizeof</span>(WCHAR) )  &amp;&amp;
00361                 wcsncmp( keyBasicInformation-&gt;Name,
00362                          CmTypeString[TcAdapter],
00363                          keyBasicInformation-&gt;NameLength / <span class="keyword">sizeof</span>(WCHAR) )) {
00364 
00365                 <span class="comment">//</span>
00366                 <span class="comment">// All the comparisons returned 1 (which means they all were</span>
00367                 <span class="comment">// unsuccessful) so we do not have a bus.</span>
00368                 <span class="comment">//</span>
00369                 <span class="comment">// Go on to the next key.</span>
00370                 <span class="comment">//</span>
00371 
00372                 <span class="keywordflow">continue</span>;
00373             }
00374         }
00375 
00376         <span class="comment">//</span>
00377         <span class="comment">// We have a bus. Open that key and enumerate it's clidren</span>
00378         <span class="comment">// (which should be numbers)</span>
00379         <span class="comment">//</span>
00380 
00381         unicodeString.Buffer = keyBasicInformation-&gt;Name;
00382         unicodeString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) keyBasicInformation-&gt;NameLength;
00383         unicodeString.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) keyBasicInformation-&gt;NameLength;
00384 
00385         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>( &amp;handle,
00386                                              RootHandle,
00387                                              &amp;unicodeString,
00388                                              KEY_READ,
00389                                              FALSE ) )) {
00390 
00391             <span class="comment">//</span>
00392             <span class="comment">// The key could not be opened. Go to the next key</span>
00393             <span class="comment">//</span>
00394 
00395             <span class="keywordflow">continue</span>;
00396 
00397         }
00398 
00399         <span class="comment">//</span>
00400         <span class="comment">// We have the key. now build the name for this path.</span>
00401         <span class="comment">//</span>
00402         <span class="comment">// Reset the string to its original value</span>
00403         <span class="comment">//</span>
00404 
00405         registryPathName = PathName;
00406 
00407         <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>( &amp;registryPathName,
00408                                   L<span class="stringliteral">"\\"</span> );
00409 
00410         <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>( &amp;registryPathName,
00411                                         &amp;unicodeString );
00412 
00413 
00414         <span class="keywordflow">if</span> (!HighKey) {
00415 
00416             <span class="comment">//</span>
00417             <span class="comment">// We have a Key. Get the information for that key</span>
00418             <span class="comment">//</span>
00419 
00420             status = <a class="code" href="../../d0/d6/iop_8h.html#a181">IopGetRegistryValues</a>( handle,
00421                                            &amp;busValueInfo[0] );
00422 
00423             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00424 
00425                 <span class="comment">//</span>
00426                 <span class="comment">// Verify that the identifier value for this bus</span>
00427                 <span class="comment">// sub-key matches the user-specified bus type.</span>
00428                 <span class="comment">// If not, do not increment the number of *found*</span>
00429                 <span class="comment">// buses.</span>
00430                 <span class="comment">//</span>
00431 
00432                 <span class="keywordflow">if</span> (( busValueInfo[<a class="code" href="../../d0/d5/io_8h.html#a599a403">IoQueryDeviceConfigurationData</a>] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) &amp;&amp;
00433                     ( busValueInfo[<a class="code" href="../../d0/d5/io_8h.html#a599a403">IoQueryDeviceConfigurationData</a>]-&gt;DataLength != 0 ) &amp;&amp;
00434                     ( ((PCM_FULL_RESOURCE_DESCRIPTOR)
00435                         ((PCCHAR) busValueInfo[<a class="code" href="../../d0/d5/io_8h.html#a599a403">IoQueryDeviceConfigurationData</a>] +
00436                         busValueInfo[<a class="code" href="../../d0/d5/io_8h.html#a599a403">IoQueryDeviceConfigurationData</a>]-&gt;DataOffset))
00437                         -&gt;InterfaceType == *(QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o0">BusType</a>) )) {
00438 
00439                     <span class="comment">//</span>
00440                     <span class="comment">// Increment the number of buses of desired type we</span>
00441                     <span class="comment">// have found.</span>
00442                     <span class="comment">//</span>
00443 
00444                     (*BusNum)++;
00445 
00446                     <span class="comment">//</span>
00447                     <span class="comment">// If we are looking for a specific bus number,</span>
00448                     <span class="comment">// check to see if we are at the right number.</span>
00449                     <span class="comment">// If we are not goto the next bus.  Otherwise</span>
00450                     <span class="comment">// (i.e we have the right bus number, or we</span>
00451                     <span class="comment">// specified all buses), then go on so the</span>
00452                     <span class="comment">// information can be reported.</span>
00453                     <span class="comment">//</span>
00454 
00455                     <span class="keywordflow">if</span> ( (QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o1">BusNumber</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00456                          (*(QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o1">BusNumber</a>) == *BusNum) ) {
00457 
00458 
00459                         <span class="comment">//</span>
00460                         <span class="comment">// If we want controller information, call</span>
00461                         <span class="comment">// the controller function.</span>
00462                         <span class="comment">// Otherwise just return the bus information.</span>
00463                         <span class="comment">//</span>
00464 
00465                         <span class="keywordflow">if</span> (QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o2">ControllerType</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00466 
00467                             status = <a class="code" href="../../d2/d3/io_2query_8c.html#a5">pIoQueryDeviceDescription</a>(
00468                                          QueryDescription,
00469                                          registryPathName,
00470                                          handle,
00471                                          *BusNum,
00472                                          (PKEY_VALUE_FULL_INFORMATION *) busValueInfo );
00473 
00474                         } <span class="keywordflow">else</span> {
00475 
00476                             status = QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o6">CalloutRoutine</a>(
00477                                          QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o7">Context</a>,
00478                                          &amp;registryPathName,
00479                                          *(QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o0">BusType</a>),
00480                                          *BusNum,
00481                                          (PKEY_VALUE_FULL_INFORMATION *) busValueInfo,
00482                                          0,
00483                                          0,
00484                                          NULL,
00485                                          0,
00486                                          0,
00487                                          NULL );
00488 
00489                         }
00490                     }
00491                 }
00492 
00493                 <span class="comment">//</span>
00494                 <span class="comment">// Free the pool allocated for the controller value data.</span>
00495                 <span class="comment">//</span>
00496 
00497                 <span class="keywordflow">if</span> (busValueInfo[0]) {
00498                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( busValueInfo[0] );
00499                     busValueInfo[0] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00500                 }
00501                 <span class="keywordflow">if</span> (busValueInfo[1]) {
00502                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( busValueInfo[1] );
00503                     busValueInfo[1] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00504                 }
00505                 <span class="keywordflow">if</span> (busValueInfo[2]) {
00506                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( busValueInfo[2] );
00507                     busValueInfo[2] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00508                 }
00509 
00510             }
00511 
00512 
00513             <span class="comment">//</span>
00514             <span class="comment">// Shortcurt exit to avoid the recursive call.</span>
00515             <span class="comment">//</span>
00516 
00517             <span class="keywordflow">if</span> ((QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o1">BusNumber</a> !=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) &amp;&amp;
00518                 (*(QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o1">BusNumber</a>) == *BusNum)) {
00519                 ZwClose( handle );
00520                 handle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00521                 <span class="keywordflow">continue</span>;
00522 
00523             }
00524         }
00525 
00526         <span class="comment">//</span>
00527         <span class="comment">// If we have the key handle, do recursive enumeration.</span>
00528         <span class="comment">// enumaration (for both high and low keys)</span>
00529         <span class="comment">//</span>
00530 
00531         status = <a class="code" href="../../d2/d3/io_2query_8c.html#a4">pIoQueryBusDescription</a>(
00532                      QueryDescription,
00533                      registryPathName,
00534                      handle,
00535                      BusNum,
00536                      (BOOLEAN)!HighKey );
00537 
00538         <span class="comment">//</span>
00539         <span class="comment">// If the sub function enumerated all the buses till the end, then</span>
00540         <span class="comment">// treat that as success.</span>
00541         <span class="comment">//</span>
00542 
00543         <span class="keywordflow">if</span> (status == STATUS_NO_MORE_ENTRIES) {
00544 
00545             status = STATUS_SUCCESS;
00546 
00547         }
00548 
00549         ZwClose( handle );
00550         handle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00551 
00552     }
00553 
00554     <span class="keywordflow">if</span> (keyBasicInformation) {
00555         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyBasicInformation );
00556     }
00557 
00558     <span class="keywordflow">return</span> status;
00559 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="io/query.c::pIoQueryDeviceDescription" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS pIoQueryDeviceDescription           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d4/struct__IO__QUERY__DESC.html">PIO_QUERY_DESC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>QueryDescription</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>PathName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>RootHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BusNum</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PKEY_VALUE_FULL_INFORMATION *&nbsp;</td>
          <td class="mdname" nowrap> <em>BusValueInfo</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00565">565</a> of file <a class="el" href="../../d3/d2/io_2query_8c-source.html">io/query.c</a>.
<p>
References <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00030">_IO_QUERY_DESC::BusType</a>, <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00036">_IO_QUERY_DESC::CalloutRoutine</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00338">CmTypeString</a>, <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00037">_IO_QUERY_DESC::Context</a>, <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00033">_IO_QUERY_DESC::ControllerNumber</a>, <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00032">_IO_QUERY_DESC::ControllerType</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02462">IopGetRegistryKeyInformation()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02637">IopGetRegistryValues()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d0/d5/io_8h.html#a599a405">IoQueryDeviceMaxData</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00035">_IO_QUERY_DESC::PeripheralNumber</a>, <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00034">_IO_QUERY_DESC::PeripheralType</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01883">RtlAppendUnicodeStringToString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01821">RtlAppendUnicodeToString()</a>, <a class="el" href="../../d0/d3/cnvint_8c-source.html#l00433">RtlIntegerToUnicodeString()</a>, and <a class="el" href="../../d2/d3/io_2query_8c.html#a0">UNICODE_NUM_LENGTH</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/io_2query_8c-source.html#l00223">pIoQueryBusDescription()</a>.
<p>
<pre class="fragment"><div>00573 {
00574 
00575     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00576     UNICODE_STRING registryPathName = PathName;
00577     UNICODE_STRING controllerBackupRegistryPathName;
00578     UNICODE_STRING peripheralBackupRegistryPathName;
00579     HANDLE controllerHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00580     HANDLE peripheralHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00581     PKEY_FULL_INFORMATION controllerTypeInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00582     PKEY_FULL_INFORMATION peripheralTypeInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00583     ULONG maxControllerNum;
00584     ULONG maxPeripheralNum;
00585     ULONG controllerNum;
00586     ULONG peripheralNum;
00587     WCHAR numBuffer[<a class="code" href="../../d2/d3/io_2query_8c.html#a0">UNICODE_NUM_LENGTH</a>];
00588     UNICODE_STRING bufferUnicodeString;
00589     PKEY_VALUE_FULL_INFORMATION controllerValueInfo[<a class="code" href="../../d0/d5/io_8h.html#a599a405">IoQueryDeviceMaxData</a>];
00590     PKEY_VALUE_FULL_INFORMATION peripheralValueInfo[<a class="code" href="../../d0/d5/io_8h.html#a599a405">IoQueryDeviceMaxData</a>];
00591 
00592 
00593     <span class="comment">//</span>
00594     <span class="comment">// Set up a string for the number translation.</span>
00595     <span class="comment">//</span>
00596 
00597     bufferUnicodeString.MaximumLength = <a class="code" href="../../d2/d3/io_2query_8c.html#a0">UNICODE_NUM_LENGTH</a> * <span class="keyword">sizeof</span>(WCHAR);
00598     bufferUnicodeString.Buffer = &amp;numBuffer[0];
00599 
00600 
00601     <span class="comment">//         For each controller of the specified type (subkeys 0..M)</span>
00602     <span class="comment">//             if we are looking for controller information</span>
00603     <span class="comment">//                 call the specified callout routine</span>
00604     <span class="comment">//             else</span>
00605     <span class="comment">//                 For each peripheral of the specified type (subkeys 0..N)</span>
00606     <span class="comment">//                     call the specified callout routine</span>
00607 
00608     <span class="comment">//</span>
00609     <span class="comment">// Add the controller name to the registry path name.</span>
00610     <span class="comment">//</span>
00611 
00612     status = <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>( &amp;registryPathName,
00613                                        L<span class="stringliteral">"\\"</span> );
00614 
00615     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00616 
00617         status = <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>( &amp;registryPathName,
00618                                            CmTypeString[*(QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o2">ControllerType</a>)] );
00619 
00620     }
00621 
00622     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00623         <span class="keywordflow">return</span> status;
00624     }
00625 
00626     <span class="comment">//</span>
00627     <span class="comment">// If a Contoller number was specified by the caller, use that</span>
00628     <span class="comment">// controller number. Otherwise, find out how many buses are present</span>
00629     <span class="comment">// by querying the key.</span>
00630     <span class="comment">//</span>
00631 
00632     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o3">ControllerNumber</a> )) {
00633 
00634         controllerNum = *(QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o3">ControllerNumber</a>);
00635         maxControllerNum = controllerNum + 1;
00636 
00637     } <span class="keywordflow">else</span> {
00638 
00639         <span class="comment">//</span>
00640         <span class="comment">// Open the registry key for the controller and</span>
00641         <span class="comment">// Get the full key information for the controller key to</span>
00642         <span class="comment">// determine the number of sub-keys (controller numbers).</span>
00643         <span class="comment">// And we fail, then go on to the next bus.</span>
00644         <span class="comment">// Note the memory allocated by the query must be freed.</span>
00645         <span class="comment">//</span>
00646 
00647         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>( &amp;controllerHandle,
00648                                      (HANDLE) NULL,
00649                                      &amp;registryPathName,
00650                                      KEY_READ,
00651                                      FALSE );
00652 
00653         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00654 
00655             status = <a class="code" href="../../d0/d6/iop_8h.html#a179">IopGetRegistryKeyInformation</a>( controllerHandle,
00656                                                    &amp;controllerTypeInfo );
00657 
00658             ZwClose( controllerHandle );
00659             controllerHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00660         }
00661 
00662         <span class="comment">//</span>
00663         <span class="comment">// If no controller of this type was found on the bus, go on to</span>
00664         <span class="comment">// the next bus; goto the end of the loop with a successful status</span>
00665         <span class="comment">// so that the memory gets freed, but we continue looping.</span>
00666         <span class="comment">//</span>
00667 
00668         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00669 
00670             <span class="keywordflow">return</span> status;
00671 
00672         }
00673 
00674         <span class="comment">//</span>
00675         <span class="comment">// Get the number of controller sub-keys for this controller</span>
00676         <span class="comment">// type and free the pool.</span>
00677         <span class="comment">//</span>
00678 
00679         maxControllerNum = controllerTypeInfo-&gt;SubKeys;
00680         controllerNum = 0;
00681 
00682         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( controllerTypeInfo );
00683         controllerTypeInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00684     }
00685 
00686     <span class="comment">//</span>
00687     <span class="comment">// Make a backup of the string since we want to start where we were</span>
00688     <span class="comment">// on the next loop iteration.</span>
00689     <span class="comment">//</span>
00690 
00691     controllerBackupRegistryPathName = registryPathName;
00692 
00693     <span class="comment">//</span>
00694     <span class="comment">// For each controller of the specified type (subkeys 0..M).</span>
00695     <span class="comment">// We use BusNumber as the initial value since it is zero if we want</span>
00696     <span class="comment">// all buses, and we only want the bus specified if the value  is not</span>
00697     <span class="comment">// zero.</span>
00698     <span class="comment">//</span>
00699 
00700     <span class="keywordflow">for</span> ( ; controllerNum &lt; maxControllerNum; controllerNum++) {
00701 
00702         <span class="comment">//</span>
00703         <span class="comment">// Reset the string to its original value</span>
00704         <span class="comment">//</span>
00705 
00706         registryPathName = controllerBackupRegistryPathName;
00707 
00708         <span class="comment">//</span>
00709         <span class="comment">// Convert the controller number to a unicode string and append</span>
00710         <span class="comment">// it to the registry path name.</span>
00711         <span class="comment">//</span>
00712 
00713         bufferUnicodeString.Length = (<a class="code" href="../../d2/d3/io_2query_8c.html#a0">UNICODE_NUM_LENGTH</a>-1) * <span class="keyword">sizeof</span>(WCHAR);
00714         status = <a class="code" href="../../d9/d3/cnvint_8c.html#a6">RtlIntegerToUnicodeString</a>( controllerNum,
00715                                             10,
00716                                             &amp;bufferUnicodeString );
00717 
00718         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00719 
00720             status = <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>( &amp;registryPathName,
00721                                                L<span class="stringliteral">"\\"</span> );
00722 
00723             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00724 
00725                 status = <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(
00726                                                      &amp;registryPathName,
00727                                                      &amp;bufferUnicodeString );
00728 
00729             }
00730         }
00731 
00732         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00733             <span class="keywordflow">break</span>;
00734         }
00735 
00736         <span class="comment">//</span>
00737         <span class="comment">// Open the registry key for the controller number and</span>
00738         <span class="comment">// Get the value data for this controller and save it for later.</span>
00739         <span class="comment">//</span>
00740 
00741 
00742         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>( &amp;controllerHandle,
00743                                      (HANDLE) NULL,
00744                                      &amp;registryPathName,
00745                                      KEY_READ,
00746                                      FALSE );
00747 
00748         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00749 
00750             status = <a class="code" href="../../d0/d6/iop_8h.html#a181">IopGetRegistryValues</a>( controllerHandle,
00751                                            &amp;controllerValueInfo[0] );
00752 
00753             ZwClose( controllerHandle );
00754             controllerHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00755         }
00756 
00757         <span class="comment">//</span>
00758         <span class="comment">// If we could not open the key and get the info, just continue</span>
00759         <span class="comment">// since there is no memory to free and we are using the for</span>
00760         <span class="comment">// loop to determine when we get to the last controller.</span>
00761         <span class="comment">//</span>
00762 
00763         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00764             <span class="keywordflow">continue</span>;
00765         }
00766 
00767         <span class="comment">//</span>
00768         <span class="comment">// Check if we want the controller and bus information only. If</span>
00769         <span class="comment">// it is the case, invoque the callout routine and go on to the</span>
00770         <span class="comment">// next loop (unless an error occurs in the callout).</span>
00771         <span class="comment">//</span>
00772 
00773         <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( (QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o4">PeripheralType</a>) )) {
00774 
00775             status = QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o6">CalloutRoutine</a>(
00776                          QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o7">Context</a>,
00777                          &amp;registryPathName,
00778                          *(QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o0">BusType</a>),
00779                          BusNum,
00780                          BusValueInfo,
00781                          *(QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o2">ControllerType</a>),
00782                          controllerNum,
00783                          (PKEY_VALUE_FULL_INFORMATION *) controllerValueInfo,
00784                          0,
00785                          0,
00786                          NULL );
00787 
00788             <span class="keywordflow">goto</span> IoQueryDeviceControllerLoop;
00789         }
00790 
00791         <span class="comment">//</span>
00792         <span class="comment">// Add the peripheral name to the registry path name.</span>
00793         <span class="comment">//</span>
00794 
00795         status = <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>( &amp;registryPathName,
00796                                            L<span class="stringliteral">"\\"</span> );
00797 
00798         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00799 
00800             status = <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(
00801                                              &amp;registryPathName,
00802                                              CmTypeString[*(QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o4">PeripheralType</a>)] );
00803 
00804         }
00805 
00806         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00807             <span class="keywordflow">goto</span> IoQueryDeviceControllerLoop;
00808         }
00809 
00810         <span class="comment">//</span>
00811         <span class="comment">// If a Peripheralnumber was specified by the caller, use that</span>
00812         <span class="comment">// peripheral number. Otherwise, find out how many buses are</span>
00813         <span class="comment">// present by querying the key.</span>
00814         <span class="comment">//</span>
00815 
00816         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( (QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o5">PeripheralNumber</a>) )) {
00817 
00818             peripheralNum = *(QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o5">PeripheralNumber</a>);
00819             maxPeripheralNum = peripheralNum + 1;
00820 
00821         } <span class="keywordflow">else</span> {
00822 
00823             <span class="comment">//</span>
00824             <span class="comment">// Open the registry key for the peripheral and</span>
00825             <span class="comment">// Get the full key information for the peripheral key to</span>
00826             <span class="comment">// determine the number of sub-keys (peripheral numbers).</span>
00827             <span class="comment">// And we fail, then go on to the next controller.</span>
00828             <span class="comment">// Note the memory allocated by the query must be freed.</span>
00829             <span class="comment">//</span>
00830 
00831             status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>( &amp;peripheralHandle,
00832                                          (HANDLE) NULL,
00833                                          &amp;registryPathName,
00834                      KEY_READ,
00835                      FALSE );
00836 
00837             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00838 
00839                 status = <a class="code" href="../../d0/d6/iop_8h.html#a179">IopGetRegistryKeyInformation</a>( peripheralHandle,
00840                            &amp;peripheralTypeInfo );
00841 
00842                 ZwClose( peripheralHandle );
00843                 peripheralHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00844             }
00845 
00846             <span class="comment">//</span>
00847             <span class="comment">// If no controller of this type was found on the bus, go on to</span>
00848             <span class="comment">// the next bus; goto the end of the loop with a successful</span>
00849             <span class="comment">// status so that the memory gets freed, but we continue looping.</span>
00850             <span class="comment">//</span>
00851 
00852             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00853                 status = STATUS_SUCCESS;
00854                 <span class="keywordflow">goto</span> IoQueryDeviceControllerLoop;
00855             }
00856 
00857             <span class="comment">//</span>
00858             <span class="comment">// Get the number of peripheral sub-keys for this peripheral</span>
00859             <span class="comment">// type and free the pool.</span>
00860             <span class="comment">//</span>
00861 
00862             maxPeripheralNum = peripheralTypeInfo-&gt;SubKeys;
00863             peripheralNum = 0;
00864 
00865             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( peripheralTypeInfo );
00866             peripheralTypeInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00867         }
00868 
00869         <span class="comment">//</span>
00870         <span class="comment">// Make a backup of the string since we want to start where we</span>
00871         <span class="comment">// were on the next loop iteration.</span>
00872         <span class="comment">//</span>
00873 
00874         peripheralBackupRegistryPathName = registryPathName;
00875 
00876         <span class="comment">//</span>
00877         <span class="comment">// For each peripheral of the specified type (subkeys 0..N).</span>
00878         <span class="comment">// We use BusNumber as the initial value since it is zero if we</span>
00879         <span class="comment">// want all buses, and we only want the bus specified if the</span>
00880         <span class="comment">// value is not zero.</span>
00881         <span class="comment">//</span>
00882 
00883         <span class="keywordflow">for</span> ( ; peripheralNum &lt; maxPeripheralNum; peripheralNum++) {
00884 
00885             <span class="comment">//</span>
00886             <span class="comment">// Reset the string to its original value.</span>
00887             <span class="comment">//</span>
00888 
00889             registryPathName = peripheralBackupRegistryPathName;
00890 
00891             <span class="comment">//</span>
00892             <span class="comment">// Convert the peripheral number to a unicode string and append</span>
00893             <span class="comment">// it to the registry path name.</span>
00894             <span class="comment">//</span>
00895 
00896             bufferUnicodeString.Length =
00897                 (<a class="code" href="../../d2/d3/io_2query_8c.html#a0">UNICODE_NUM_LENGTH</a>-1) * <span class="keyword">sizeof</span>(WCHAR);
00898             status = <a class="code" href="../../d9/d3/cnvint_8c.html#a6">RtlIntegerToUnicodeString</a>( peripheralNum,
00899                                                 10,
00900                                                 &amp;bufferUnicodeString );
00901 
00902             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00903 
00904                 status = <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>( &amp;registryPathName,
00905                                                    L<span class="stringliteral">"\\"</span> );
00906 
00907                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00908 
00909                     status = <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(
00910                                                      &amp;registryPathName,
00911                                                      &amp;bufferUnicodeString );
00912 
00913                 }
00914             }
00915 
00916             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00917                 <span class="keywordflow">break</span>;
00918             }
00919 
00920             <span class="comment">//</span>
00921             <span class="comment">// Open the registry key for the peripheral number and</span>
00922             <span class="comment">// Get the value data for this peripheral and save it for</span>
00923             <span class="comment">// later.</span>
00924             <span class="comment">//</span>
00925 
00926             status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>( &amp;peripheralHandle,
00927                                          (HANDLE) NULL,
00928                                          &amp;registryPathName,
00929                                          KEY_READ,
00930                                          FALSE );
00931 
00932             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00933 
00934                 status = <a class="code" href="../../d0/d6/iop_8h.html#a181">IopGetRegistryValues</a>( peripheralHandle,
00935                                                &amp;peripheralValueInfo[0] );
00936 
00937                 ZwClose( peripheralHandle );
00938                 peripheralHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00939             }
00940 
00941             <span class="comment">//</span>
00942             <span class="comment">// If getting the peripheral information worked properly,</span>
00943             <span class="comment">// call the user-specified callout routine.</span>
00944             <span class="comment">//</span>
00945 
00946             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00947 
00948                 status = QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o6">CalloutRoutine</a>(
00949                              QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o7">Context</a>,
00950                              &amp;registryPathName,
00951                              *(QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o0">BusType</a>),
00952                              BusNum,
00953                              BusValueInfo,
00954                              *(QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o2">ControllerType</a>),
00955                              controllerNum,
00956                              (PKEY_VALUE_FULL_INFORMATION *) controllerValueInfo,
00957                              *(QueryDescription-&gt;<a class="code" href="../../d5/d4/struct__IO__QUERY__DESC.html#o4">PeripheralType</a>),
00958                              peripheralNum,
00959                              (PKEY_VALUE_FULL_INFORMATION *) peripheralValueInfo );
00960 
00961                 <span class="comment">//</span>
00962                 <span class="comment">// Free the pool allocated for the peripheral value data.</span>
00963                 <span class="comment">//</span>
00964 
00965                 <span class="keywordflow">if</span> (peripheralValueInfo[0]) {
00966                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( peripheralValueInfo[0] );
00967                     peripheralValueInfo[0] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00968                 }
00969                 <span class="keywordflow">if</span> (peripheralValueInfo[1]) {
00970                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( peripheralValueInfo[1] );
00971                     peripheralValueInfo[1] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00972                 }
00973                 <span class="keywordflow">if</span> (peripheralValueInfo[2]) {
00974                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( peripheralValueInfo[2] );
00975                     peripheralValueInfo[2] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00976                 }
00977 
00978                 <span class="comment">//</span>
00979                 <span class="comment">// If the user-specified callout routine returned with</span>
00980                 <span class="comment">// an unsuccessful status, quit.</span>
00981                 <span class="comment">//</span>
00982 
00983                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00984                     <span class="keywordflow">break</span>;
00985                }
00986             }
00987 
00988         } <span class="comment">// for ( ; peripheralNum &lt; maxPeripheralNum ...</span>
00989 
00990 IoQueryDeviceControllerLoop:
00991 
00992         <span class="comment">//</span>
00993         <span class="comment">// Free the pool allocated for the controller value data.</span>
00994         <span class="comment">//</span>
00995 
00996         <span class="keywordflow">if</span> (controllerValueInfo[0]) {
00997             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( controllerValueInfo[0] );
00998             controllerValueInfo[0] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00999         }
01000         <span class="keywordflow">if</span> (controllerValueInfo[1]) {
01001             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( controllerValueInfo[1] );
01002             controllerValueInfo[1] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01003         }
01004         <span class="keywordflow">if</span> (controllerValueInfo[2]) {
01005             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( controllerValueInfo[2] );
01006             controllerValueInfo[2] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01007         }
01008 
01009         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01010             <span class="keywordflow">break</span>;
01011         }
01012 
01013     } <span class="comment">// for ( ; controllerNum &lt; maxControllerNum...</span>
01014 
01015 
01016     <span class="keywordflow">return</span>( status );
01017 }
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:25 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
