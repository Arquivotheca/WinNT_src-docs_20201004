<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cmtrecpy.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cmtrecpy.c File Reference</h1><code>#include "<a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>"</code><br>

<p>
<a href="../../d3/d2/cmtrecpy_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d4/structCMP__COPY__STACK__ENTRY.html">CMP_COPY_STACK_ENTRY</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/cmtrecpy_8c.html#a0">DEBUG_TREE_SYNC</a>&nbsp;&nbsp;&nbsp;FALSE</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/cmtrecpy_8c.html#a1">CMP_INITIAL_STACK_SIZE</a>&nbsp;&nbsp;&nbsp;1024</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/cmtrecpy_8c.html#a2">PCMP_COPY_STACK_ENTRY</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/cmtrecpy_8c.html#a3">CmpCopySyncTree2</a> (<a class="el" href="../../d2/d3/cmtrecpy_8c.html#a2">PCMP_COPY_STACK_ENTRY</a> CmpCopyStack, ULONG CmpCopyStackSize, ULONG CmpCopyStackTop, <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> CmpSourceHive, <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> CmpTargetHive, BOOLEAN CopyVolatile, <a class="el" href="../../d9/d0/cmdata_8h.html#a66">CMP_COPY_TYPE</a> CopyType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/cmtrecpy_8c.html#a4">CmpFreeKeyValues</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>, <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/cmtrecpy_8c.html#a5">CmpSyncKeyValues</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> SourceHive, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> SourceKeyCell, <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> SourceKeyNode, <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> TargetHive, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> TargetKeyCell, <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> TargetKeyNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/cmtrecpy_8c.html#a6">CmpMergeKeyValues</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> SourceHive, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> SourceKeyCell, <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> SourceKeyNode, <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> TargetHive, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> TargetKeyCell, <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> TargetKeyNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/cmtrecpy_8c.html#a7">CmpSyncSubKeysAfterDelete</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> SourceHive, <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> SourceCell, <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> TargetHive, <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> TargetCell, WCHAR *NameBuffer)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/cmtrecpy_8c.html#a8">CmpMarkKeyValuesDirty</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>, <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/cmtrecpy_8c.html#a9">CmpMarkKeyParentDirty</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/cmtrecpy_8c.html#a10">CmpCopySyncTree</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> SourceHive, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> SourceCell, <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> TargetHive, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> TargetCell, BOOLEAN CopyVolatile, <a class="el" href="../../d9/d0/cmdata_8h.html#a66">CMP_COPY_TYPE</a> CopyType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/cmtrecpy_8c.html#a11">CmpCopyKeyPartial</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> SourceHive, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> SourceKeyCell, <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> TargetHive, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Parent, BOOLEAN CopyValues)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/cmtrecpy_8c.html#a12">CmpCopyValue</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> SourceHive, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> SourceValueCell, <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> TargetHive, <a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a> Type)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/cmtrecpy_8c.html#a13">CmpCopyCell</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> SourceHive, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> SourceCell, <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> TargetHive, <a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a> Type)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/cmtrecpy_8c.html#a14">CmpInitializeKeyNameString</a> (<a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>, PUNICODE_STRING <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>, WCHAR *NameBuffer)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/cmtrecpy_8c.html#a15">CmpInitializeValueNameString</a> (<a class="el" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>, PUNICODE_STRING <a class="el" href="../../d8/d2/rtrenval_8c.html#a3">ValueName</a>, WCHAR *NameBuffer)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a1" doxytag="cmtrecpy.c::CMP_INITIAL_STACK_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMP_INITIAL_STACK_SIZE&nbsp;&nbsp;&nbsp;1024          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00038">38</a> of file <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html">cmtrecpy.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00127">CmpCopySyncTree()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="cmtrecpy.c::DEBUG_TREE_SYNC" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DEBUG_TREE_SYNC&nbsp;&nbsp;&nbsp;FALSE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00031">31</a> of file <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html">cmtrecpy.c</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a2" doxytag="cmtrecpy.c::PCMP_COPY_STACK_ENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef   * <a class="el" href="../../d2/d3/cmtrecpy_8c.html#a2">PCMP_COPY_STACK_ENTRY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00127">CmpCopySyncTree()</a>, and <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00251">CmpCopySyncTree2()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a13" doxytag="cmtrecpy.c::CmpCopyCell" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> CmpCopyCell           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceCell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01009">1009</a> of file <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html">cmtrecpy.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00261">CMS_SAVRES</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00386">HvAllocateCell()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, and <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00335">HvGetCellSize()</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00686">CmpCopyKeyPartial()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00895">CmpCopyValue()</a>, and <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01338">CmpSyncKeyValues()</a>.
<p>
<pre class="fragment"><div>01017                    :
01018 
01019     <a class="code" href="../../d9/d0/cmdata_8h.html#a104a97">Copy</a> SourceHive.SourceCell to TargetHive.TargetCell.
01020 
01021 Arguments:
01022 
01023     SourceHive - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> source
01024 
01025     SourceCell - index of cell to copy from
01026 
01027     TargetHive - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> target
01028 
01029     Type - storage <a class="code" href="../../d4/d4/iafptrap_8c.html#a9">type</a> (stable or <span class="keyword">volatile</span>) of <span class="keyword">new</span> cell
01030 
01031 Return Value:
01032 
01033     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> of <span class="keyword">new</span> cell, or <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a> <span class="keywordflow">if</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
01034 
01035 --*/
01036 {
01037     PVOID   psource;
01038     PVOID   ptarget;
01039     ULONG   size;
01040     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> newcell;
01041 
01042     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_SAVRES) {
01043         KdPrint((<span class="stringliteral">"CmpCopyCell:\n"</span>));
01044         KdPrint((<span class="stringliteral">"\tSourceHive=%08lx SourceCell=%08lx\n"</span>,SourceHive,SourceCell));
01045         KdPrint((<span class="stringliteral">"\tTargetHive=%08lx\n"</span>,TargetHive));
01046     }
01047 
01048     psource = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SourceHive, SourceCell);
01049     size = <a class="code" href="../../d8/d0/hivecell_8c.html#a15">HvGetCellSize</a>(SourceHive, psource);
01050 
01051     newcell = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(TargetHive, size, Type);
01052     <span class="keywordflow">if</span> (newcell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01053         <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01054     }
01055 
01056     ptarget = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(TargetHive, newcell);
01057 
01058     RtlCopyMemory(ptarget, psource, size);
01059 
01060     <span class="keywordflow">return</span> newcell;
01061 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="cmtrecpy.c::CmpCopyKeyPartial" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> CmpCopyKeyPartial           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceKeyCell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Parent</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>CopyValues</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00686">686</a> of file <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html">cmtrecpy.c</a>.
<p>
References <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00464">_CM_KEY_NODE::Class</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00476">_CM_KEY_NODE::ClassLength</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00697">CmpAssignSecurityDescriptor()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01009">CmpCopyCell()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00895">CmpCopyValue()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00261">CMS_SAVRES</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00332">_CHILD_LIST::Count</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00526">_CM_KEY_SECURITY::Descriptor</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00386">HvAllocateCell()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00135">HvGetCellType</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00440">KEY_COMP_NAME</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00434">KEY_HIVE_ENTRY</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00437">KEY_NO_DELETE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00541">_CELL_DATA::_u::KeyList</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00537">_CELL_DATA::_u::KeyNode</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00539">_CELL_DATA::_u::KeySecurity</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00333">_CHILD_LIST::List</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00453">_CM_KEY_NODE::Parent</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00463">_CM_KEY_NODE::Security</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00454">_CM_KEY_NODE::SubKeyCounts</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00457">_CM_KEY_NODE::SubKeyLists</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00458">_CM_KEY_NODE::ValueList</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00251">CmpCopySyncTree2()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00484">CmpLoadHiveVolatile()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00097">CmRestoreKey()</a>, <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l00862">CmSaveKey()</a>, and <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01047">CmSaveMergedKeys()</a>.
<p>
<pre class="fragment"><div>00695                    :
00696 
00697     <a class="code" href="../../d9/d0/cmdata_8h.html#a104a97">Copy</a> a key body and all of its values, but NOT its subkeylist or
00698     subkey entries.  SubKeyList.Count will be set to 0.
00699 
00700 Arguments:
00701 
00702     SourceHive - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> source
00703 
00704     SourceKeyCell - value entry being copied
00705 
00706     TargetHive - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> target
00707 
00708     Parent - parent value to set into newly created key body
00709 
00710     CopyValues - <span class="keywordflow">if</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> value entries will not be copied, <span class="keywordflow">if</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, they will
00711 
00712 Return Value:
00713 
00714     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> of body of <span class="keyword">new</span> key entry, or <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>
00715         <span class="keywordflow">if</span> some error.
00716 
00717 --*/
00718 {
00719     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00720     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> newkey = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00721     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> newclass = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00722     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> newsecurity = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00723     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> newlist = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00724     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> newvalue;
00725     BOOLEAN success = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00726     ULONG   i;
00727     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> psrckey;
00728     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> ptarkey;
00729     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> psrclist;
00730     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> ptarlist;
00731     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> psrcsecurity;
00732     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> security;
00733     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <span class="keyword">class</span>;
00734     ULONG   classlength;
00735     ULONG   count;
00736     ULONG   Type;
00737 
00738     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_SAVRES) {
00739         KdPrint((<span class="stringliteral">"CmpCopyKeyPartial:\n"</span>));
00740         KdPrint((<span class="stringliteral">"\tSHive=%08lx SCell=%08lx\n"</span>,SourceHive,SourceKeyCell));
00741         KdPrint((<span class="stringliteral">"\tTHive=%08lx\n"</span>,TargetHive));
00742     }
00743 
00744 
00745     <span class="comment">//</span>
00746     <span class="comment">// get description of source</span>
00747     <span class="comment">//</span>
00748     <span class="keywordflow">if</span> (Parent == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00749         <span class="comment">//</span>
00750         <span class="comment">// This is a root node we are creating, so don't make it volatile.</span>
00751         <span class="comment">//</span>
00752         Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>;
00753     } <span class="keywordflow">else</span> {
00754         Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Parent);
00755     }
00756     psrckey = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SourceHive, SourceKeyCell);
00757     security = psrckey-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a>;
00758     <span class="keyword">class </span>= psrckey-&gt;u.KeyNode.Class;
00759     classlength = psrckey-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a>;
00760 
00761     <span class="comment">//</span>
00762     <span class="comment">// Allocate and copy the body</span>
00763     <span class="comment">//</span>
00764     newkey = <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a13">CmpCopyCell</a>(SourceHive, SourceKeyCell, TargetHive, Type);
00765     <span class="keywordflow">if</span> (newkey == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00766         <span class="keywordflow">goto</span> DoFinally;
00767     }
00768 
00769     <span class="comment">//</span>
00770     <span class="comment">// Allocate and copy class</span>
00771     <span class="comment">//</span>
00772     <span class="keywordflow">if</span> (classlength &gt; 0) {
00773         newclass = <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a13">CmpCopyCell</a>(SourceHive, <span class="keyword">class</span>, TargetHive, Type);
00774         <span class="keywordflow">if</span> (newclass == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00775             <span class="keywordflow">goto</span> DoFinally;
00776         }
00777     }
00778 
00779     <span class="comment">//</span>
00780     <span class="comment">// Fill in the target body</span>
00781     <span class="comment">//</span>
00782     ptarkey = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(TargetHive, newkey);
00783 
00784     ptarkey-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o10">Class</a> = newclass;
00785     ptarkey-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00786     ptarkey-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00787     ptarkey-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00788     ptarkey-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] = 0;
00789     ptarkey-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>] = 0;
00790     ptarkey-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a> = Parent;
00791 
00792     ptarkey-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> = (psrckey-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>);
00793     <span class="keywordflow">if</span> (Parent == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00794         ptarkey-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/cmdata_8h.html#a29">KEY_HIVE_ENTRY</a> + <a class="code" href="../../d9/d0/cmdata_8h.html#a30">KEY_NO_DELETE</a>;
00795     }
00796 
00797     <span class="comment">//</span>
00798     <span class="comment">// Allocate and copy security</span>
00799     <span class="comment">//</span>
00800     psrcsecurity = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SourceHive, security);
00801 
00802     status = <a class="code" href="../../d7/d2/cmse_8c.html#a10">CmpAssignSecurityDescriptor</a>(TargetHive,
00803                                          newkey,
00804                                          ptarkey,
00805                                          &amp;(psrcsecurity-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o2">KeySecurity</a>.<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o6">Descriptor</a>));
00806     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00807         <span class="keywordflow">goto</span> DoFinally;
00808     }
00809 
00810 
00811     <span class="comment">//</span>
00812     <span class="comment">// Set up the value list</span>
00813     <span class="comment">//</span>
00814     count = psrckey-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a>;
00815 
00816     <span class="keywordflow">if</span> ((count == 0) || (CopyValues == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00817         ptarkey-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00818         ptarkey-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> = 0;
00819         success = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00820     } <span class="keywordflow">else</span> {
00821 
00822         psrclist = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SourceHive, psrckey-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>);
00823 
00824         newlist = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(
00825                     TargetHive,
00826                     count * <span class="keyword">sizeof</span>(HCELL_INDEX),
00827                     Type
00828                     );
00829         <span class="keywordflow">if</span> (newlist == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00830             <span class="keywordflow">goto</span> DoFinally;
00831         }
00832         ptarkey-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a> = newlist;
00833         ptarlist = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(TargetHive, newlist);
00834 
00835 
00836         <span class="comment">//</span>
00837         <span class="comment">// Copy the values</span>
00838         <span class="comment">//</span>
00839         <span class="keywordflow">for</span> (i = 0; i &lt; count; i++) {
00840 
00841             newvalue = <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a12">CmpCopyValue</a>(
00842                             SourceHive,
00843                             psrclist-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o4">KeyList</a>[i],
00844                             TargetHive,
00845                             Type
00846                             );
00847 
00848             <span class="keywordflow">if</span> (newvalue != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00849 
00850                 ptarlist-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o4">KeyList</a>[i] = newvalue;
00851 
00852             } <span class="keywordflow">else</span> {
00853 
00854                 <span class="keywordflow">for</span> (; i &gt; 0; i--) {
00855                     <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(
00856                         TargetHive,
00857                         ptarlist-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o4">KeyList</a>[i - 1]
00858                         );
00859                 }
00860                 <span class="keywordflow">goto</span> DoFinally;
00861             }
00862         }
00863         success = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00864     }
00865 
00866 DoFinally:
00867     <span class="keywordflow">if</span> (success == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00868 
00869         <span class="keywordflow">if</span> (newlist != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00870             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(TargetHive, newlist);
00871         }
00872 
00873         <span class="keywordflow">if</span> (newsecurity != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00874             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(TargetHive, newsecurity);
00875         }
00876 
00877         <span class="keywordflow">if</span> (newclass != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00878             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(TargetHive, newclass);
00879         }
00880 
00881         <span class="keywordflow">if</span> (newkey != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00882             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(TargetHive, newkey);
00883         }
00884 
00885         <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00886 
00887     } <span class="keywordflow">else</span> {
00888 
00889         <span class="keywordflow">return</span> newkey;
00890     }
00891 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="cmtrecpy.c::CmpCopySyncTree" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpCopySyncTree           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceCell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetCell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>CopyVolatile</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d9/d0/cmdata_8h.html#a66">CMP_COPY_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CopyType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00127">127</a> of file <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html">cmtrecpy.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00038">CMP_INITIAL_STACK_SIZE</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00251">CmpCopySyncTree2()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00261">CMS_SAVRES</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, and <a class="el" href="../../d2/d3/cmtrecpy_8c.html#a2">PCMP_COPY_STACK_ENTRY</a>.
<p>
<pre class="fragment"><div>00137                    :
00138 
00139     This routine can perform two distinct (yet similar) tasks:
00140     a tree copy or a tree synchronization (sync). Which task
00141     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> performed <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> determined by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TreeSync parameter.
00142     
00143     For both operations:
00144     --------------------
00145     
00146     The source root key and target root key must exist in advance.
00147     These root nodes and their value entries will NOT be copied/synced.                
00148     
00149     NOTE:   <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a> keys are <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> copied/synced <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CopyVolatile
00150             parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set to <span class="keyword">true</span>.
00151 
00152     
00153     For a tree copy:
00154     ----------------
00155     
00156     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> tree <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> copied from source to destination. The subkeys
00157     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source root key and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full trees under those
00158     subkeys will be copied to a <span class="keyword">new</span> tree at target root key.
00159                            
00160     NOTE:   If <span class="keyword">this</span> call fails part way through, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will NOT undo
00161             any successfully completed key copies, thus a partial
00162             tree copy CAN occur.
00163             
00164     For a tree sync:
00165     ----------------
00166     
00167     The target tree <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keyword">synchronized</span> with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source tree. It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> 
00168     assumed that <span class="keywordflow">for</span> a certain period of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> time <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target tree
00169     has remained unmodified <span class="keywordflow">while</span> modifications may have been <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a>
00170     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source tree. During a sync, any such modifications
00171     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source tree are <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target tree. Thus, at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00172     end of a successful sync, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target tree <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> identical to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00173     source tree.
00174     
00175     Since <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> things that have changed in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source tree 
00176     are modified in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target tree, a sync operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> far
00177     more efficient than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">delete</span>/copy operations necessary
00178     to accomplish <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same results.
00179     
00180     NOTE: It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed that no open handles are held
00181           on any target tree keys. Registry in-memory data
00182           structures may be corrupted <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not <span class="keyword">true</span>.
00183         
00184 Arguments:
00185 
00186     SourceHive - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> source
00187 
00188     SourceCell - index of cell at root of tree to copy/sync
00189 
00190     TargetHive - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> target
00191 
00192     TargetCell - pointer to cell at root of target tree
00193     
00194     CopyVolatile - indicates whether <span class="keyword">volatile</span> keys should be
00195                    copied/synced.
00196                    
00197     CopyType - indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> copy operation:
00198                 <a class="code" href="../../d9/d0/cmdata_8h.html#a104a97">Copy</a>  - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> copy <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> requested
00199                 <a class="code" href="../../d9/d0/cmdata_8h.html#a104a98">Sync</a>  - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> sync <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> requested
00200                 <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a91">Merge</a> - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> merge <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> requested i.e.:
00201                     1. <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target nodes that are not present on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source tree are not
00202                     deleted.
00203                     2. <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target nodes that are present in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source tree gets overrided
00204                     no matter what <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LastWriteTime value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>.
00205 Return Value:
00206 
00207     BOOLEAN - Result code from call, among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
00208         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
00209         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tree copy/sync was not completed (though more than 0
00210                 keys may have been copied/synced)
00211 
00212 --*/
00213 {
00214     BOOLEAN result;
00215     <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a2">PCMP_COPY_STACK_ENTRY</a>   CmpCopyStack;
00216 
00217     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_SAVRES) {
00218         KdPrint((<span class="stringliteral">"CmpCopyTree:\n"</span>));
00219     }
00220 
00221     CmpCopyStack = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
00222                         PagedPool,
00223                         <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d4/structCMP__COPY__STACK__ENTRY.html">CMP_COPY_STACK_ENTRY</a>)*CMP_INITIAL_STACK_SIZE
00224                         );
00225     <span class="keywordflow">if</span> (CmpCopyStack == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00226         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00227     }
00228     CmpCopyStack[0].SourceCell = SourceCell;
00229     CmpCopyStack[0].TargetCell = TargetCell;
00230 
00231     result = <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a3">CmpCopySyncTree2</a>(
00232                 CmpCopyStack,
00233                 CMP_INITIAL_STACK_SIZE,
00234                 0,
00235                 SourceHive,
00236                 TargetHive,
00237                 CopyVolatile,
00238                 CopyType
00239                 );
00240 
00241     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(CmpCopyStack);
00242     <span class="keywordflow">return</span> result;
00243 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="cmtrecpy.c::CmpCopySyncTree2" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpCopySyncTree2           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d3/cmtrecpy_8c.html#a2">PCMP_COPY_STACK_ENTRY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CmpCopyStack</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CmpCopyStackSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CmpCopyStackTop</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CmpSourceHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CmpTargetHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>CopyVolatile</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d9/d0/cmdata_8h.html#a66">CMP_COPY_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CopyType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00251">251</a> of file <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html">cmtrecpy.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00895">CmpAddSubKey()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00686">CmpCopyKeyPartial()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00186">CmpFindSubKeyByName()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00771">CmpFindSubKeyByNumber()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01515">CmpInitializeKeyNameString()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01870">CmpMarkKeyParentDirty()</a>, <a class="el" href="../../d2/d3/cmtrecpy_8c.html#a6">CmpMergeKeyValues()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01338">CmpSyncKeyValues()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01648">CmpSyncSubKeysAfterDelete()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00261">CMS_SAVRES</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00135">HvGetCellType</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00451">_CM_KEY_NODE::LastWriteTime</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00034">MAX_KEY_NAME_LENGTH</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00783">Merge</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d2/d3/cmtrecpy_8c.html#a2">PCMP_COPY_STACK_ENTRY</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00454">_CM_KEY_NODE::SubKeyCounts</a>, <a class="el" href="../../d9/d0/cmdata_8h.html#a104a98">Sync</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00127">CmpCopySyncTree()</a>.
<p>
<pre class="fragment"><div>00262                    :
00263 
00264    This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a helper routine <span class="keywordflow">for</span> <a class="code" href="../../d1/d2/cmp_8h.html#a269">CmpCopySyncTree</a>. It accomplishes
00265    <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> functionality described by that routine in a <span class="stringliteral">"virtually"</span>
00266    recursive manner which frees <span class="keyword">this</span> routine from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> limitations
00267    of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Kernel stack.
00268    
00269    This routine should not be called directly. Use <a class="code" href="../../d1/d2/cmp_8h.html#a269">CmpCopySyncTree</a>!.
00270       
00271 Arguments:
00272 
00273     (All of these are <span class="stringliteral">"virtual globals"</span>)
00274 
00275     CmpCopyStack - <span class="stringliteral">"global"</span> pointer to stack <span class="keywordflow">for</span> frames
00276 
00277     CmpCopyStackSize - alloced size of stack
00278 
00279     CmpCopyStackTop - current top
00280 
00281     CmpSourceHive, CmpTargetHive - source and target hives
00282     
00283     CopyVolatile, CopyType - same as <a class="code" href="../../d1/d2/cmp_8h.html#a269">CmpCopySyncTree</a>.
00284 
00285 
00286 Return Value:
00287 
00288     BOOLEAN - Result code from call, among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
00289         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
00290         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tree copy/sync was not completed (though more than 0
00291                 keys may have been copied/synced)
00292 
00293 --*/
00294 {
00295     <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a2">PCMP_COPY_STACK_ENTRY</a>   Frame;
00296     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>             SourceChild;
00297     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>             NewSubKey;
00298 
00299     BOOLEAN                 Ret = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, SyncNeedsTreeCopy = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00300     UNICODE_STRING          <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
00301     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>            SourceChildCell, TargetChildCell;       
00302     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>            SourceCell, TargetCell;
00303     ULONG                   SyncTreeCopyStackStart;
00304     WCHAR                   *NameBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00305     
00306     <span class="comment">// A merge is a particular case of a sync !!!</span>
00307     BOOLEAN                 TreeSync = (CopyType == <a class="code" href="../../d9/d0/cmdata_8h.html#a104a98">Sync</a> || CopyType == <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a91">Merge</a>)?<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>:<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00308 
00309     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_SAVRES) {
00310         KdPrint((<span class="stringliteral">"CmpCopyTree2:\n"</span>));
00311     }
00312 
00313     <span class="keywordflow">if</span> (TreeSync) {
00314 
00315        <span class="comment">//</span>
00316        <span class="comment">// The sync operation involves some work with key names, </span>
00317        <span class="comment">// so we must allocate a buffer used for key name decompression.</span>
00318        <span class="comment">//</span>
00319 
00320        NameBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, MAX_KEY_NAME_LENGTH);
00321        <span class="keywordflow">if</span>(!NameBuffer) <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00322 
00323     } 
00324 
00325     <span class="comment">//</span>
00326     <span class="comment">// outer loop, apply to entire tree, emulate recursion here</span>
00327     <span class="comment">// jump to here is a virtual call</span>
00328     <span class="comment">//</span>
00329     Outer: <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00330 
00331         Frame = &amp;(CmpCopyStack[CmpCopyStackTop]);
00332 
00333         Frame-&gt;i = 0;
00334                         
00335     <span class="comment">//</span>
00336     <span class="comment">// inner loop, applies to one key</span>
00337     <span class="comment">// jump to here is a virtual return</span>
00338     <span class="comment">//</span>
00339         Inner: <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00340 
00341             SourceCell = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(CmpSourceHive, Frame-&gt;SourceCell);
00342 
00343             SourceChild = <a class="code" href="../../d1/d2/cmp_8h.html#a304">CmpFindSubKeyByNumber</a>(CmpSourceHive,
00344                                                 SourceCell,
00345                                                 Frame-&gt;i);
00346             (Frame-&gt;i)++;
00347 
00348             <span class="keywordflow">if</span> ((SourceChild == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) || (!CopyVolatile &amp;&amp;
00349                                                (<a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(SourceChild) == <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>))) {                                                           
00350 
00351                 <span class="comment">//</span>
00352                 <span class="comment">// we've stepped through all the children (or we are only</span>
00353                 <span class="comment">// interested in stable children and have just stepped through</span>
00354                 <span class="comment">// the stable children and into the volatile ones)</span>
00355                 <span class="comment">//                </span>
00356                 
00357                 <span class="keywordflow">if</span>(TreeSync &amp;&amp; (CopyType != <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a91">Merge</a>))
00358                 { 
00359                    <span class="comment">//</span>
00360                    <span class="comment">// If we are here during a sync, that means most of sync operations</span>
00361                    <span class="comment">// applied to the current SourceCell have been completed.</span>
00362                    <span class="comment">// That is, we have:</span>
00363                    <span class="comment">//   1) Synchronized SourceCell's values with its counterpart in the</span>
00364                    <span class="comment">//      target tree.</span>
00365                    <span class="comment">//   2) Synchronized any new SourceCell subkeys (subkeys present</span>
00366                    <span class="comment">//      in SourceCell but not its counterpart) by creating</span>
00367                    <span class="comment">//      and copying them to the proper place in the target tree.</span>
00368                    <span class="comment">//</span>
00369                    <span class="comment">// What this means is that SourceCell's counterpart in the target tree</span>
00370                    <span class="comment">// (TargetCell) now has at least as many subkeys as SourceCell.</span>
00371                    <span class="comment">//</span>
00372                    <span class="comment">// This implies that if TargetCell now has more subkeys that SourceCell</span>
00373                    <span class="comment">// than some subkeys of TargetCell are not present in the source tree</span>
00374                    <span class="comment">// (probably because those keys were deleted from the source tree </span>
00375                    <span class="comment">//  during the period between the previous sync and now).</span>
00376                    <span class="comment">//</span>
00377                    <span class="comment">// If such keys exist, then they must be delete them from TargetCell</span>
00378                    <span class="comment">// in order to complete the sync. We do this below.</span>
00379                    <span class="comment">//</span>
00380 
00381                    TargetCell = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(CmpTargetHive, Frame-&gt;TargetCell);
00382 
00383                    <span class="comment">//</span>
00384                    <span class="comment">// Does TargetCell have more subkeys than SourceCell?</span>
00385                    <span class="comment">//</span>
00386 
00387                    <span class="keywordflow">if</span>((TargetCell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] + 
00388                        TargetCell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>]) &gt;
00389                       (SourceCell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] + 
00390 
00391                        <span class="comment">// We only count the volatile keys if we are actually</span>
00392                        <span class="comment">// syncing them. Note, however, that we always use</span>
00393                        <span class="comment">// the volatile counts in TargetCell since we may</span>
00394                        <span class="comment">// be syncing to a volatile tree where all keys are volatile.</span>
00395                        
00396                        (CopyVolatile ? SourceCell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>] : 0)))  
00397                            
00398                    {
00399 <span class="preprocessor">#if DEBUG_TREE_SYNC</span>
00400 <span class="preprocessor"></span>                      KdPrint((<span class="stringliteral">"CONFIG: SubKey Deletion from Source Cell #%lu.\n"</span>, 
00401                                Frame-&gt;SourceCell));
00402 <span class="preprocessor">#endif</span>
00403 <span class="preprocessor"></span>
00404                       <span class="comment">//</span>
00405                       <span class="comment">// Delete what should be deleted from TargetCell</span>
00406                       <span class="comment">//</span>
00407 
00408                       <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a7">CmpSyncSubKeysAfterDelete</a>(CmpSourceHive,
00409                                                 SourceCell, 
00410                                                 CmpTargetHive,
00411                                                 TargetCell,
00412                                                 NameBuffer);
00413                    }                                      
00414                 }
00415                   
00416                 <span class="keywordflow">break</span>;
00417             }           
00418                                                 
00419             <span class="keywordflow">if</span> (TreeSync) {
00420 
00421                <span class="comment">//</span>
00422                <span class="comment">// For a sync, we want to check if the current child (subkey)</span>
00423                <span class="comment">// of SourceCell is also a child of TargetCell - i.e. if</span>
00424                <span class="comment">// the subkey in question has a counterpart in the target tree.</span>
00425                <span class="comment">//</span>
00426                <span class="comment">// There is no guarantee that the counterpart's index number</span>
00427                <span class="comment">// will be the same so we must perform this check using</span>
00428                <span class="comment">// the subkey name.</span>
00429                <span class="comment">//</span>
00430 
00431                <span class="comment">//</span>
00432                <span class="comment">// Get the name of the current child</span>
00433                <span class="comment">//</span>
00434                      
00435                SourceChildCell = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(CmpSourceHive,                                                               
00436                                                          SourceChild);                                         
00437                      
00438                <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a14">CmpInitializeKeyNameString</a>(SourceChildCell,
00439                                           &amp;KeyName, 
00440                                           NameBuffer);                     
00441 
00442                <span class="comment">//</span>
00443                <span class="comment">// Try to find the current child's counterpart in</span>
00444                <span class="comment">// in the target tree using the child's name.</span>
00445                <span class="comment">//</span>
00446                      
00447                NewSubKey = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(CmpTargetHive,
00448                                                (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(CmpTargetHive, 
00449                                                                        Frame-&gt;TargetCell),
00450                                                &amp;KeyName);
00451                                    
00452                      
00453                <span class="keywordflow">if</span> (NewSubKey != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00454 
00455                   <span class="comment">//</span>
00456                   <span class="comment">// Found it, the current child (subkey) has a counterpart</span>
00457                   <span class="comment">// in the target tree. Thus, we just need to check if </span>
00458                   <span class="comment">// the counterpart's values are out of date and should</span>
00459                   <span class="comment">// be updated.</span>
00460                   <span class="comment">//</span>
00461 
00462                   TargetChildCell = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(CmpTargetHive,
00463                                                             NewSubKey);
00464                         
00465                   <span class="comment">//</span>
00466                   <span class="comment">// Check if the current subkey has been modified</span>
00467                   <span class="comment">// more recently than its target tree counterpart.</span>
00468                   <span class="comment">// When we are doing a tree merge, always override the target.</span>
00469                   <span class="comment">//</span>
00470                         
00471                   <span class="keywordflow">if</span> ( (CopyType == <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a91">Merge</a>) ||
00472                       ((TargetChildCell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o2">LastWriteTime</a>.QuadPart) &lt; 
00473                       (SourceChildCell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o2">LastWriteTime</a>.QuadPart))) {
00474 
00475                      <span class="comment">//</span>
00476                      <span class="comment">// The counterpart is out of date. Its values</span>
00477                      <span class="comment">// must be synchornized with the current subkey.</span>
00478                      <span class="comment">//</span>
00479 <span class="preprocessor">#if DEBUG_TREE_SYNC</span>
00480 <span class="preprocessor"></span>                     KdPrint((<span class="stringliteral">"CONFIG: Target Refresh.\n"</span>));
00481                      KdPrint((<span class="stringliteral">"CONFIG: Source Cell %lu = %.*S\n"</span>, 
00482                               SourceChild,
00483                               <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length / <span class="keyword">sizeof</span>(WCHAR),
00484                               <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer));
00485 <span class="preprocessor">#endif</span>
00486 <span class="preprocessor"></span>
00487                      <span class="comment">//</span>
00488                      <span class="comment">// Sync up the key's values, sd, &amp; class                     </span>
00489                      <span class="comment">//</span>
00490 
00491                      <span class="keywordflow">if</span>(CopyType == <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a91">Merge</a>) {
00492                          <span class="keywordflow">if</span>(!<a class="code" href="../../d2/d3/cmtrecpy_8c.html#a6">CmpMergeKeyValues</a>(CmpSourceHive, SourceChild, SourceChildCell,
00493                                               CmpTargetHive, NewSubKey, TargetChildCell)) {
00494                             <span class="keywordflow">goto</span> CopyEnd;                              
00495                          }
00496                      } <span class="keywordflow">else</span> {
00497                          <span class="keywordflow">if</span>(!<a class="code" href="../../d2/d3/cmtrecpy_8c.html#a5">CmpSyncKeyValues</a>(CmpSourceHive, SourceChild, SourceChildCell,
00498                                               CmpTargetHive, NewSubKey, TargetChildCell)) {
00499                             <span class="keywordflow">goto</span> CopyEnd;                              
00500                         }
00501                      }
00502 
00503                      <span class="comment">//</span>
00504                      <span class="comment">// Sync the timestamps so that we don't do this again.</span>
00505                      <span class="comment">//</span>
00506 
00507                      TargetChildCell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o2">LastWriteTime</a>.QuadPart =
00508                         SourceChildCell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o2">LastWriteTime</a>.QuadPart;
00509                         
00510                   }
00511                            
00512                   <span class="comment">//</span>
00513                   <span class="comment">// If we are here, then the current subkey's target</span>
00514                   <span class="comment">// tree counterpart has been synchronized (or did not need</span>
00515                   <span class="comment">// to be). Transfer control to the code that will apply</span>
00516                   <span class="comment">// this function "recursively" to the current subkey in order</span>
00517                   <span class="comment">// to continue the sync.</span>
00518                   <span class="comment">//</span>
00519 
00520                   <span class="keywordflow">goto</span> NewKeyCreated;
00521                      
00522                }   
00523 
00524                <span class="comment">//</span>
00525                <span class="comment">// If we are here, it means that the current child (subkey)</span>
00526                <span class="comment">// does not have a counterpart in the target tree. This means</span>
00527                <span class="comment">// we have encountered a new subkey in the source tree and must</span>
00528                <span class="comment">// create it in the target tree. </span>
00529                <span class="comment">//</span>
00530                <span class="comment">// The standard copy code below will create this subkey. However,</span>
00531                <span class="comment">// we must also make sure that the tree under this subkey is properly</span>
00532                <span class="comment">// copied from source to target. The most efficient way of doing</span>
00533                <span class="comment">// this is to temporarily forget that we are in a sync operation</span>
00534                <span class="comment">// and merely perform a copy until the desired result is achieved.</span>
00535                <span class="comment">// </span>
00536 
00537 <span class="preprocessor">#if DEBUG_TREE_SYNC</span>
00538 <span class="preprocessor"></span>               KdPrint((<span class="stringliteral">"CONFIG: New SubKey.\n"</span>));
00539                KdPrint((<span class="stringliteral">"CONFIG: Source Cell %lu = %.*S\n"</span>, 
00540                         SourceChild,
00541                         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length / <span class="keyword">sizeof</span>(WCHAR),
00542                         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer));
00543 <span class="preprocessor">#endif</span>
00544 <span class="preprocessor"></span>
00545                <span class="comment">//</span>
00546                <span class="comment">// Indicate that we will just copy and not sync for a while</span>
00547                <span class="comment">//</span>
00548                                              
00549                SyncNeedsTreeCopy = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;                                          
00550                 
00551             }
00552 
00553             NewSubKey = <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a11">CmpCopyKeyPartial</a>(
00554                                           CmpSourceHive,
00555                                           SourceChild,
00556                                           CmpTargetHive,
00557                                           Frame-&gt;TargetCell,
00558                                           TRUE
00559                                           );
00560 
00561                 
00562             <span class="keywordflow">if</span> (NewSubKey == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00563                
00564                <span class="keywordflow">goto</span> CopyEnd;
00565             }
00566                 
00567             <span class="keywordflow">if</span> ( !  <a class="code" href="../../d1/d2/cmp_8h.html#a305">CmpAddSubKey</a>(
00568                                  CmpTargetHive,
00569                                  Frame-&gt;TargetCell,
00570                                  NewSubKey
00571                                  )
00572                  ) {
00573 
00574                <span class="keywordflow">goto</span> CopyEnd;
00575             }
00576 
00577             <span class="comment">//</span>
00578             <span class="comment">// Check if the sync operation determined that this</span>
00579             <span class="comment">// subtree should be copied</span>
00580             <span class="comment">//</span>
00581                 
00582             <span class="keywordflow">if</span>(TreeSync &amp;&amp; SyncNeedsTreeCopy) {
00583 
00584                <span class="comment">//</span>
00585                <span class="comment">// We have just created a new key in the target tree</span>
00586                <span class="comment">// with the above code. However, since this is a sync,</span>
00587                <span class="comment">// the parent of that new key has not been created by our</span>
00588                <span class="comment">// code and thus may not have been modified at all before</span>
00589                <span class="comment">// the creation of the new key. But this parent now </span>
00590                <span class="comment">// has a new child, and must therefore be marked as dirty.</span>
00591                <span class="comment">//</span>
00592                    
00593                <span class="keywordflow">if</span> (! <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a9">CmpMarkKeyParentDirty</a>(CmpTargetHive, NewSubKey)) {
00594 
00595                   <span class="keywordflow">goto</span> CopyEnd;
00596                }
00597                    
00598                <span class="comment">//</span>
00599                <span class="comment">// Record the stack level where we start the copy </span>
00600                <span class="comment">// (and temporarily abandon the sync)</span>
00601                <span class="comment">// so that we can return to the sync operation when this</span>
00602                <span class="comment">// stack level is reached again (i.e. when the tree</span>
00603                <span class="comment">// under the current subkey is fully copied)</span>
00604                <span class="comment">//</span>
00605 
00606                SyncTreeCopyStackStart = CmpCopyStackTop;
00607 
00608                <span class="comment">//</span>
00609                <span class="comment">// Pretend that this is not a sync in order</span>
00610                <span class="comment">// to simply start copying</span>
00611                <span class="comment">//</span>
00612 
00613                TreeSync = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00614             }
00615 
00616 NewKeyCreated:
00617                     
00618                     <span class="comment">//</span>
00619                     <span class="comment">// We succeeded in copying/syncing the subkey, apply</span>
00620                     <span class="comment">// ourselves to it</span>
00621                     <span class="comment">//</span>
00622                     CmpCopyStackTop++;
00623 
00624                     <span class="keywordflow">if</span> (CmpCopyStackTop &gt;= CmpCopyStackSize) {
00625 
00626                         <span class="comment">//</span>
00627                         <span class="comment">// if we're here, it means that the tree</span>
00628                         <span class="comment">// we're trying to copy is more than 1024</span>
00629                         <span class="comment">// COMPONENTS deep (from 2048 to 256k bytes)</span>
00630                         <span class="comment">// we could grow the stack, but this is pretty</span>
00631                         <span class="comment">// severe, so return FALSE and fail the copy</span>
00632                         <span class="comment">//</span>
00633                         
00634                         <span class="keywordflow">goto</span> CopyEnd;
00635                     }
00636 
00637                     CmpCopyStack[CmpCopyStackTop].SourceCell =
00638                             SourceChild;
00639 
00640                     CmpCopyStack[CmpCopyStackTop].TargetCell =
00641                             NewSubKey;
00642 
00643                     <span class="keywordflow">goto</span> Outer;
00644 
00645                     
00646         } <span class="comment">// Inner: while</span>
00647 
00648         <span class="keywordflow">if</span> (CmpCopyStackTop == 0) {            
00649             Ret = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00650             <span class="keywordflow">goto</span> CopyEnd;
00651         }
00652 
00653         CmpCopyStackTop--;
00654         Frame = &amp;(CmpCopyStack[CmpCopyStackTop]);
00655 
00656         <span class="comment">//</span>
00657         <span class="comment">// We have just completed working at a certain stack level.</span>
00658         <span class="comment">// This is a good time to check if we need to resume a temporarily</span>
00659         <span class="comment">// suspended sync operation.</span>
00660         <span class="comment">//</span>
00661 
00662         <span class="keywordflow">if</span>(SyncNeedsTreeCopy &amp;&amp; (CmpCopyStackTop == SyncTreeCopyStackStart))
00663         {
00664            <span class="comment">//</span>
00665            <span class="comment">// We've been copying a tree for a sync. But now, that tree is fully</span>
00666            <span class="comment">// copied. So, let's resume the sync once again.</span>
00667            <span class="comment">//</span>
00668 
00669            TreeSync = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;               
00670            SyncNeedsTreeCopy = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00671         }
00672 
00673 
00674         <span class="keywordflow">goto</span> Inner;
00675 
00676     } <span class="comment">// Outer: while</span>
00677 
00678 CopyEnd:
00679 
00680    <span class="keywordflow">if</span> (NameBuffer) <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(NameBuffer);
00681    <span class="keywordflow">return</span> Ret;
00682 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="cmtrecpy.c::CmpCopyValue" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> CmpCopyValue           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceValueCell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00895">895</a> of file <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html">cmtrecpy.c</a>.
<p>
References <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00489">CM_KEY_VALUE_SMALL</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00487">CM_KEY_VALUE_SPECIAL_SIZE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01009">CmpCopyCell()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00508">CmpIsHKeyValueSmall</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00261">CMS_SAVRES</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00498">_CM_KEY_VALUE::Data</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00497">_CM_KEY_VALUE::DataLength</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00538">_CELL_DATA::_u::KeyValue</a>, and <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00686">CmpCopyKeyPartial()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01150">CmpMergeKeyValues()</a>, and <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01338">CmpSyncKeyValues()</a>.
<p>
<pre class="fragment"><div>00903                    :
00904 
00905     <a class="code" href="../../d9/d0/cmdata_8h.html#a104a97">Copy</a> a value entry.  Copies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> body of a value entry and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00906     data.  Returns cell of <span class="keyword">new</span> value entry.
00907 
00908 Arguments:
00909 
00910     SourceHive - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> source
00911 
00912     SourceValueCell - value entry being copied
00913 
00914     TargetHive - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> target
00915 
00916     Type - storage <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> to allocate <span class="keywordflow">for</span> target (stable or <span class="keyword">volatile</span>)
00917 
00918 Return Value:
00919 
00920     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> of body of <span class="keyword">new</span> value entry, or <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>
00921         <span class="keywordflow">if</span> some error.
00922 
00923 --*/
00924 {
00925     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> newvalue;
00926     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> newdata;
00927     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> pvalue;
00928     ULONG       datalength;
00929     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> olddata;
00930     ULONG       tempdata;
00931     BOOLEAN     small;
00932 
00933     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_SAVRES) {
00934         KdPrint((<span class="stringliteral">"CmpCopyValue:\n"</span>));
00935         KdPrint((<span class="stringliteral">"\tSHive=%08lx SCell=%08lx\n"</span>,SourceHive,SourceValueCell));
00936         KdPrint((<span class="stringliteral">"\tTargetHive=%08lx\n"</span>,TargetHive));
00937     }
00938 
00939     <span class="comment">//</span>
00940     <span class="comment">// get source data</span>
00941     <span class="comment">//</span>
00942     pvalue = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SourceHive, SourceValueCell);
00943     small = <a class="code" href="../../d9/d0/cmdata_8h.html#a38">CmpIsHKeyValueSmall</a>(datalength, pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o2">DataLength</a>);
00944     olddata = pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a>;
00945 
00946     <span class="comment">//</span>
00947     <span class="comment">// Copy body</span>
00948     <span class="comment">//</span>
00949     newvalue = <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a13">CmpCopyCell</a>(SourceHive, SourceValueCell, TargetHive, Type);
00950     <span class="keywordflow">if</span> (newvalue == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00951         <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00952     }
00953 
00954     <span class="comment">//</span>
00955     <span class="comment">// Copy data (if any)</span>
00956     <span class="comment">//</span>
00957     <span class="keywordflow">if</span> (datalength &gt; 0) {
00958 
00959         <span class="keywordflow">if</span> (datalength &gt; <a class="code" href="../../d9/d0/cmdata_8h.html#a36">CM_KEY_VALUE_SMALL</a>) {
00960 
00961             <span class="comment">//</span>
00962             <span class="comment">// there's data, and it's "big", so do standard copy</span>
00963             <span class="comment">//</span>
00964             newdata = <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a13">CmpCopyCell</a>(SourceHive, olddata, TargetHive, Type);
00965 
00966             <span class="keywordflow">if</span> (newdata == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00967                 <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(TargetHive, newvalue);
00968                 <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00969             }
00970 
00971             pvalue = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(TargetHive, newvalue);
00972             pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a> = newdata;
00973             pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o2">DataLength</a> = datalength;
00974 
00975         } <span class="keywordflow">else</span> {
00976 
00977             <span class="comment">//</span>
00978             <span class="comment">// the data is small, but may be stored in either large or</span>
00979             <span class="comment">// small format for historical reasons</span>
00980             <span class="comment">//</span>
00981             <span class="keywordflow">if</span> (small) {
00982 
00983                 <span class="comment">//</span>
00984                 <span class="comment">// data is already small, so just do a body to body copy</span>
00985                 <span class="comment">//</span>
00986                 tempdata = pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a>;
00987 
00988             } <span class="keywordflow">else</span> {
00989 
00990                 <span class="comment">//</span>
00991                 <span class="comment">// data is stored externally in old cell, will be internal in new</span>
00992                 <span class="comment">//</span>
00993                 pvalue = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SourceHive, pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a>);
00994                 tempdata = *((PULONG)pvalue);
00995             }
00996             pvalue = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(TargetHive, newvalue);
00997             pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a> = tempdata;
00998             pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o2">DataLength</a> =
00999                 datalength + <a class="code" href="../../d9/d0/cmdata_8h.html#a35">CM_KEY_VALUE_SPECIAL_SIZE</a>;
01000 
01001         }
01002     }
01003 
01004     <span class="keywordflow">return</span> newvalue;
01005 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="cmtrecpy.c::CmpFreeKeyValues" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpFreeKeyValues           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Node</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01064">1064</a> of file <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html">cmtrecpy.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00464">_CM_KEY_NODE::Class</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00476">_CM_KEY_NODE::ClassLength</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00105">CmpFreeSecurityDescriptor()</a>, <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00053">CmpFreeValue()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01767">CmpMarkKeyValuesDirty()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00332">_CHILD_LIST::Count</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00428">KEY_HIVE_EXIT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00541">_CELL_DATA::_u::KeyList</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00333">_CHILD_LIST::List</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00458">_CM_KEY_NODE::ValueList</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01338">CmpSyncKeyValues()</a>.
<p>
<pre class="fragment"><div>01071                    :
01072 
01073    Free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cells associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value entries, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor,
01074    and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">class </span>of a particular key.   
01075 
01076 Arguments:
01077 
01078    <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>        - The hive of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key in question
01079    <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>        - The cell of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key in question
01080    Node        - The key body of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key in question
01081 
01082 Return Value:
01083 
01084    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> if successful, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
01085 
01086 --*/
01087 {    
01088     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  plist;
01089     ULONG       i;
01090 
01091     <span class="comment">//</span>
01092     <span class="comment">// Mark all the value-related cells dirty </span>
01093     <span class="comment">//</span>
01094 
01095     <span class="keywordflow">if</span> (! <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a8">CmpMarkKeyValuesDirty</a>(Hive, Cell, Node)) {
01096         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01097     }
01098     
01099     <span class="comment">//</span>
01100     <span class="comment">// Link nodes don't have things that we need to free</span>
01101     <span class="comment">//</span>
01102 
01103     <span class="keywordflow">if</span> (!(Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a28">KEY_HIVE_EXIT</a>)) {
01104 
01105         <span class="comment">//</span>
01106         <span class="comment">// First, free the value entries</span>
01107         <span class="comment">//</span>
01108         <span class="keywordflow">if</span> (Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> &gt; 0) {
01109 
01110             <span class="comment">// Get value list</span>
01111             plist = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>);
01112 
01113             <span class="comment">// Free each value</span>
01114             <span class="keywordflow">for</span> (i = 0; i &lt; Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a>; i++) {
01115                 <a class="code" href="../../d9/d2/cmsubs2_8c.html#a3">CmpFreeValue</a>(Hive, plist-&gt;u.KeyList[i]);
01116             }
01117 
01118             <span class="comment">// Free the value list</span>
01119             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>);
01120         }
01121 
01122         <span class="comment">//</span>
01123         <span class="comment">// Make this key value-less</span>
01124         <span class="comment">//</span>
01125 
01126         Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01127         Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> = 0;
01128 
01129         <span class="comment">//</span>
01130         <span class="comment">// Free the security descriptor</span>
01131         <span class="comment">//</span>
01132         <a class="code" href="../../d6/d3/cmwraper_8c.html#a12">CmpFreeSecurityDescriptor</a>(Hive, Cell);
01133 
01134         <span class="comment">//</span>
01135         <span class="comment">// Free the Class information</span>
01136         <span class="comment">//</span>
01137 
01138         <span class="keywordflow">if</span> (Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a> &gt; 0) {
01139             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o10">Class</a>);
01140             Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o10">Class</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01141             Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a> = 0;
01142         }
01143         
01144     }
01145 
01146     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01147 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="cmtrecpy.c::CmpInitializeKeyNameString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpInitializeKeyNameString           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>NameBuffer</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01515">1515</a> of file <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html">cmtrecpy.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00121">CmpCompressedNameSize()</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00151">CmpCopyCompressedName()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00440">KEY_COMP_NAME</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00034">MAX_KEY_NAME_LENGTH</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00251">CmpCopySyncTree2()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01235">CmpFlushNotify()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03764">CmpFreePostBlock()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01378">CmpNotifyChangeKey()</a>, <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00487">CmpPostNotify()</a>, and <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01648">CmpSyncSubKeysAfterDelete()</a>.
<p>
<pre class="fragment"><div>01521                    :
01522 
01523    Initializes a UNICODE_STRING with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of a given key.
01524    
01525    N.B. The initialized string's buffer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not meant
01526          to be modified.   
01527 
01528 Arguments:
01529 
01530    <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>       - The body of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key in question
01531    <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>    - The UNICODE_STRING to initialize
01532    NameBuffer - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> buffer <a class="code" href="../../d9/d0/cmdata_8h.html#a1">MAX_KEY_NAME_LENGTH</a> bytes in size 
01533                 that will possibly be used as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> UNICODE_STRING's 
01534                 buffer.
01535 
01536 Return Value:
01537 
01538    NONE.
01539 
01540 --*/
01541 {                        
01542    <span class="comment">// is the name stored in compressed form?</span>
01543 
01544    <span class="keywordflow">if</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Flags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>) {
01545 
01546       <span class="comment">// Name is compressed. </span>
01547 
01548       <span class="comment">// Get the uncompressed length.</span>
01549                         
01550       <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>-&gt;Length = <a class="code" href="../../d1/d2/cmp_8h.html#a320">CmpCompressedNameSize</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Name,
01551                                               <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;NameLength);
01552                         
01553       <span class="comment">// Decompress the name into a buffer.</span>
01554 
01555       <a class="code" href="../../d1/d2/cmp_8h.html#a318">CmpCopyCompressedName</a>(NameBuffer, 
01556                             MAX_KEY_NAME_LENGTH,
01557                             <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Name,                                            
01558                             <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;NameLength);
01559 
01560       <span class="comment">//</span>
01561       <span class="comment">// Use the decompression buffer as the string buffer</span>
01562       <span class="comment">//</span>
01563                         
01564       <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>-&gt;Buffer = NameBuffer;      
01565       <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>-&gt;MaximumLength = <a class="code" href="../../d9/d0/cmdata_8h.html#a1">MAX_KEY_NAME_LENGTH</a>;
01566 
01567    } <span class="keywordflow">else</span> {
01568 
01569       <span class="comment">//</span>
01570       <span class="comment">// Name is not compressed. Just use the name string </span>
01571       <span class="comment">// from the key buffer as the string buffer.</span>
01572       <span class="comment">//</span>
01573                         
01574       <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>-&gt;Length = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;NameLength;                        
01575       <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>-&gt;Buffer = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Name;
01576       <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;MaxNameLen;
01577                      
01578    }                                             
01579 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="cmtrecpy.c::CmpInitializeValueNameString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpInitializeValueNameString           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>NameBuffer</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01582">1582</a> of file <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html">cmtrecpy.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00121">CmpCompressedNameSize()</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00151">CmpCopyCompressedName()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00036">MAX_KEY_VALUE_NAME_LENGTH</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00491">VALUE_COMP_NAME</a>, and <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00047">ValueName</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01150">CmpMergeKeyValues()</a>.
<p>
<pre class="fragment"><div>01587                    :
01588 
01589    Initializes a UNICODE_STRING with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of a given value key.
01590    
01591    N.B. The initialized string's buffer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not meant
01592          to be modified.   
01593 
01594 Arguments:
01595 
01596    <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>       - The value key in question
01597    <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>    - The UNICODE_STRING to initialize
01598    NameBuffer - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> buffer <a class="code" href="../../d9/d0/cmdata_8h.html#a1">MAX_KEY_NAME_LENGTH</a> bytes in size 
01599                 that will possibly be used as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> UNICODE_STRING's 
01600                 buffer.
01601 
01602 Return Value:
01603 
01604    NONE.
01605 */
01606 
01607 {                        
01608    <span class="comment">// is the name stored in compressed form?</span>
01609 
01610    <span class="keywordflow">if</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Flags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a37">VALUE_COMP_NAME</a>) {
01611 
01612       <span class="comment">// Name is compressed. </span>
01613 
01614       <span class="comment">// Get the uncompressed length.</span>
01615                         
01616       <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>-&gt;Length = <a class="code" href="../../d1/d2/cmp_8h.html#a320">CmpCompressedNameSize</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Name,
01617                                               <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;NameLength);
01618                         
01619       <span class="comment">// Decompress the name into a buffer.</span>
01620 
01621       <a class="code" href="../../d1/d2/cmp_8h.html#a318">CmpCopyCompressedName</a>(NameBuffer, 
01622                             MAX_KEY_VALUE_NAME_LENGTH,
01623                             <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Name,                                            
01624                             <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;NameLength);
01625 
01626       <span class="comment">//</span>
01627       <span class="comment">// Use the decompression buffer as the string buffer</span>
01628       <span class="comment">//</span>
01629                         
01630       <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>-&gt;Buffer = NameBuffer;      
01631       <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>-&gt;MaximumLength = <a class="code" href="../../d9/d0/cmdata_8h.html#a3">MAX_KEY_VALUE_NAME_LENGTH</a>;
01632 
01633    } <span class="keywordflow">else</span> {
01634 
01635       <span class="comment">//</span>
01636       <span class="comment">// Name is not compressed. Just use the name string </span>
01637       <span class="comment">// from the ValueName buffer as the string buffer.</span>
01638       <span class="comment">//</span>
01639                         
01640       <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>-&gt;Length = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;NameLength;                        
01641       <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>-&gt;Buffer = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Name;
01642       <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>-&gt;MaximumLength = <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>-&gt;Length;
01643                      
01644    }                                             
01645 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="cmtrecpy.c::CmpMarkKeyParentDirty" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpMarkKeyParentDirty           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01870">1870</a> of file <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html">cmtrecpy.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01608">CmpMarkIndexDirty()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00117">HvMarkCellDirty()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00434">KEY_HIVE_ENTRY</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00537">_CELL_DATA::_u::KeyNode</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00453">_CM_KEY_NODE::Parent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00251">CmpCopySyncTree2()</a>.
<p>
<pre class="fragment"><div>01876                    :
01877 
01878    Marks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent of a given key and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent's subkey list as dirty.
01879    
01880 Arguments:
01881 
01882    <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>     - The hive of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key in question.
01883    <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>     - The cell of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key in question.
01884 
01885 
01886 Return Value:
01887 
01888    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> successful, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
01889    
01890    <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> probably indicates that no log space was available.
01891 
01892 --*/
01893 {
01894 
01895     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> ptarget;
01896 
01897     <span class="comment">//</span>
01898     <span class="comment">// Map in the target</span>
01899     <span class="comment">//</span>
01900     ptarget = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Cell);    
01901 
01902 
01903     <span class="keywordflow">if</span> (ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a29">KEY_HIVE_ENTRY</a>) {
01904 
01905         <span class="comment">//</span>
01906         <span class="comment">// if this is an entry node, we are done.  our parent will</span>
01907         <span class="comment">// be in the master hive (and thus volatile)</span>
01908         <span class="comment">//</span>
01909         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01910     }
01911 
01912     <span class="comment">//</span>
01913     <span class="comment">// Mark the parent's Subkey list</span>
01914     <span class="comment">//</span>
01915     <span class="keywordflow">if</span> (! <a class="code" href="../../d1/d2/cmp_8h.html#a306">CmpMarkIndexDirty</a>(Hive, ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a>, Cell)) {
01916         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01917     }
01918 
01919     <span class="comment">//</span>
01920     <span class="comment">// Mark the parent</span>
01921     <span class="comment">//</span>
01922     <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a>)) {
01923         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01924     }
01925 
01926     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01927 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="cmtrecpy.c::CmpMarkKeyValuesDirty" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpMarkKeyValuesDirty           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Node</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01767">1767</a> of file <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html">cmtrecpy.c</a>.
<p>
References <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00523">_CM_KEY_SECURITY::Blink</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00464">_CM_KEY_NODE::Class</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00508">CmpIsHKeyValueSmall</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00332">_CHILD_LIST::Count</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00498">_CM_KEY_VALUE::Data</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00497">_CM_KEY_VALUE::DataLength</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00522">_CM_KEY_SECURITY::Flink</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00117">HvMarkCellDirty()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00428">KEY_HIVE_EXIT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00541">_CELL_DATA::_u::KeyList</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00539">_CELL_DATA::_u::KeySecurity</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00538">_CELL_DATA::_u::KeyValue</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00333">_CHILD_LIST::List</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00463">_CM_KEY_NODE::Security</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00458">_CM_KEY_NODE::ValueList</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01064">CmpFreeKeyValues()</a>.
<p>
<pre class="fragment"><div>01774                    :
01775 
01776    
01777    Marks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cells associated with a key's value entries, security descriptor,
01778    and <span class="keyword">class </span>information as dirty.
01779                         
01780 Arguments:
01781 
01782    <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>     - The hive of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key in question
01783    <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>     - The cell of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key in question
01784    Node     - The body of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key in question
01785 
01786 
01787 Return Value:
01788 
01789    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> if successful, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
01790    
01791    <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> probably indicates that no log space was available.
01792 
01793 --*/
01794 {    
01795     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  plist, security, pvalue;
01796     ULONG       i, realsize;    
01797 
01798     <span class="keywordflow">if</span> (Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a28">KEY_HIVE_EXIT</a>) {
01799 
01800         <span class="comment">//</span>
01801         <span class="comment">// If this is a link node, we are done.  Link nodes never have</span>
01802         <span class="comment">// classes, values, subkeys, or security descriptors.  Since</span>
01803         <span class="comment">// they always reside in the master hive, they're always volatile.</span>
01804         <span class="comment">//</span>
01805         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01806     }
01807 
01808     <span class="comment">//</span>
01809     <span class="comment">// mark cell itself</span>
01810     <span class="comment">//</span>
01811     <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, Cell)) {
01812         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01813     }
01814 
01815     <span class="comment">//</span>
01816     <span class="comment">// Mark the class</span>
01817     <span class="comment">//</span>
01818     <span class="keywordflow">if</span> (Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o10">Class</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01819         <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o10">Class</a>)) {
01820             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01821         }
01822     }
01823 
01824     <span class="comment">//</span>
01825     <span class="comment">// Mark security</span>
01826     <span class="comment">//</span>
01827     <span class="keywordflow">if</span> (Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01828         <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a>)) {
01829             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01830         }
01831 
01832         security = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a>);
01833         <span class="keywordflow">if</span> (! (<a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, security-&gt;u.KeySecurity.Flink) &amp;&amp;
01834                <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, security-&gt;u.KeySecurity.Blink)))
01835         {
01836             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01837         }
01838     }
01839 
01840     <span class="comment">//</span>
01841     <span class="comment">// Mark the value entries and their data</span>
01842     <span class="comment">//</span>
01843     <span class="keywordflow">if</span> (Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> &gt; 0) {
01844 
01845         <span class="comment">// Value list</span>
01846         <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>)) {
01847             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01848         }
01849         plist = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>);
01850 
01851         <span class="keywordflow">for</span> (i = 0; i &lt; Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a>; i++) {
01852             <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, plist-&gt;u.KeyList[i])) {
01853                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01854             }
01855 
01856             pvalue = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, plist-&gt;u.KeyList[i]);
01857             
01858             <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/cmdata_8h.html#a38">CmpIsHKeyValueSmall</a>(realsize, pvalue-&gt;u.KeyValue.DataLength)) {
01859                 <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, pvalue-&gt;u.KeyValue.Data)) {
01860                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01861                 }
01862             }
01863         }
01864     }
01865 
01866     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01867 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="cmtrecpy.c::CmpMergeKeyValues" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpMergeKeyValues           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceKeyCell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceKeyNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetKeyCell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetKeyNode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00251">CmpCopySyncTree2()</a>, and <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01047">CmSaveMergedKeys()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="cmtrecpy.c::CmpSyncKeyValues" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpSyncKeyValues           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceKeyCell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceKeyNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetKeyCell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetKeyNode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01338">1338</a> of file <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html">cmtrecpy.c</a>.
<p>
References <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00464">_CM_KEY_NODE::Class</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00476">_CM_KEY_NODE::ClassLength</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00697">CmpAssignSecurityDescriptor()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01009">CmpCopyCell()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00895">CmpCopyValue()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01064">CmpFreeKeyValues()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00332">_CHILD_LIST::Count</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00526">_CM_KEY_SECURITY::Descriptor</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00386">HvAllocateCell()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00135">HvGetCellType</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00541">_CELL_DATA::_u::KeyList</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00539">_CELL_DATA::_u::KeySecurity</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00333">_CHILD_LIST::List</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00463">_CM_KEY_NODE::Security</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00458">_CM_KEY_NODE::ValueList</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00251">CmpCopySyncTree2()</a>, and <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01150">CmpMergeKeyValues()</a>.
<p>
<pre class="fragment"><div>01348                    :
01349 
01350     Synchronizes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value entries, security descriptor, and <span class="keyword">class </span>of a 
01351     target key with that of a source key - ensuring that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> keys are 
01352     identical with respect to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> synchronized information.
01353 
01354 Arguments:
01355 
01356    SourceHive     - <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source key
01357    SourceKeyCell  - The source key's cell
01358    SourceKeyNode  - The source key's body
01359    
01360    TargetHive     - <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target key
01361    TargetKeyCell  - The target key's cell
01362    TargetKeyNode  - The target key's body
01363 
01364 Return Value:
01365 
01366    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> of successful, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
01367 
01368 --*/
01369 {
01370     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;    
01371     BOOLEAN success = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;    
01372     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> psrclist, ptarlist, psrcsecurity;
01373     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> newvalue, newlist = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>, newclass = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>, newsecurity = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;    
01374     ULONG i, count, Type;
01375 
01376     <span class="comment">//</span>
01377     <span class="comment">// First, free the target key's values, sd, and class info.</span>
01378     <span class="comment">//</span>
01379 
01380     <span class="keywordflow">if</span>(!<a class="code" href="../../d2/d3/cmtrecpy_8c.html#a4">CmpFreeKeyValues</a>(TargetHive, TargetKeyCell, TargetKeyNode))
01381        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01382 
01383     <span class="comment">//</span>
01384     <span class="comment">// Now, copy the values, class, &amp; sd from the source cell</span>
01385     <span class="comment">//</span>
01386 
01387     <span class="comment">//</span>
01388     <span class="comment">// The type of the new cells will be the same as that</span>
01389     <span class="comment">// of the target cell.</span>
01390     <span class="comment">//</span>
01391 
01392     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(TargetKeyCell);    
01393     
01394     <span class="comment">//</span>
01395     <span class="comment">// Allocate and copy class</span>
01396     <span class="comment">//</span>
01397     <span class="keywordflow">if</span> ((SourceKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a> &gt; 0) &amp;&amp; (SourceKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o10">Class</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>)) {
01398         newclass = <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a13">CmpCopyCell</a>(SourceHive, SourceKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o10">Class</a>, TargetHive, Type);
01399         <span class="keywordflow">if</span> (newclass == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01400             <span class="keywordflow">goto</span> EndValueSync;
01401         }
01402         
01403         <span class="comment">// only if class is valid. Otherwise remains 0 (set by CmpFreeKeyValues)</span>
01404         TargetKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a> = SourceKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a>;
01405     }
01406 
01407     <span class="comment">//</span>
01408     <span class="comment">// Associate the new class with the target key</span>
01409     <span class="comment">// and prepare and security descriptor assignment.</span>
01410     <span class="comment">//</span>
01411 
01412     TargetKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o10">Class</a> = newclass;
01413     TargetKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;            
01414 
01415     <span class="comment">//</span>
01416     <span class="comment">// Allocate and assign security</span>
01417     <span class="comment">//</span>
01418     psrcsecurity = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SourceHive, SourceKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a>);
01419 
01420     status = <a class="code" href="../../d7/d2/cmse_8c.html#a10">CmpAssignSecurityDescriptor</a>(TargetHive,
01421                                          TargetKeyCell,
01422                                          TargetKeyNode,
01423                                          &amp;(psrcsecurity-&gt;u.KeySecurity.Descriptor));
01424     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01425         <span class="keywordflow">goto</span> EndValueSync;
01426     }
01427 
01428     <span class="comment">//</span>
01429     <span class="comment">// Set up the value list</span>
01430     <span class="comment">//</span>
01431     count = SourceKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a>;
01432 
01433     <span class="keywordflow">if</span> (count == 0) {
01434 
01435         <span class="comment">// No values in source, no list needed.</span>
01436 
01437         TargetKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01438         TargetKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> = 0;
01439         success = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01440     } <span class="keywordflow">else</span> {        
01441 
01442         <span class="comment">// Allocate the value list for target</span>
01443 
01444         psrclist = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SourceHive, SourceKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>);
01445 
01446         newlist = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(
01447                     TargetHive,
01448                     count * <span class="keyword">sizeof</span>(HCELL_INDEX),
01449                     Type
01450                     );
01451         <span class="keywordflow">if</span> (newlist == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01452             <span class="keywordflow">goto</span> EndValueSync;
01453         }
01454         TargetKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a> = newlist;
01455         ptarlist = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(TargetHive, newlist);
01456 
01457 
01458         <span class="comment">//</span>
01459         <span class="comment">// Copy the values</span>
01460         <span class="comment">//</span>
01461         <span class="keywordflow">for</span> (i = 0; i &lt; count; i++) {
01462 
01463             newvalue = <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a12">CmpCopyValue</a>(
01464                             SourceHive,
01465                             psrclist-&gt;u.KeyList[i],
01466                             TargetHive,
01467                             Type
01468                             );
01469 
01470             <span class="keywordflow">if</span> (newvalue != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01471 
01472                 ptarlist-&gt;u.KeyList[i] = newvalue;
01473 
01474             } <span class="keywordflow">else</span> {
01475 
01476                 <span class="comment">// Delete all the copied values on an error.</span>
01477 
01478                 <span class="keywordflow">for</span> (; i &gt; 0; i--) {
01479                     <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(
01480                         TargetHive,
01481                         ptarlist-&gt;u.KeyList[i - 1]
01482                         );
01483                 }
01484                 <span class="keywordflow">goto</span> EndValueSync;
01485             }
01486         }
01487 
01488         TargetKeyNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> = count;
01489         success = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01490     }
01491 
01492 EndValueSync:
01493     <span class="keywordflow">if</span> (success == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01494 
01495         <span class="comment">// Clean-up on failure</span>
01496 
01497         <span class="keywordflow">if</span> (newlist != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01498             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(TargetHive, newlist);
01499         }
01500 
01501         <span class="keywordflow">if</span> (newsecurity != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01502             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(TargetHive, newsecurity);
01503         }
01504 
01505         <span class="keywordflow">if</span> (newclass != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01506             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(TargetHive, newclass);
01507         }
01508 
01509     }
01510 
01511     <span class="keywordflow">return</span> success;
01512 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="cmtrecpy.c::CmpSyncSubKeysAfterDelete" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpSyncSubKeysAfterDelete           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceCell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetCell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WCHAR *&nbsp;</td>
          <td class="mdname" nowrap> <em>NameBuffer</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01648">1648</a> of file <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html">cmtrecpy.c</a>.
<p>
References <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00034">CmpDeleteTree()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00186">CmpFindSubKeyByName()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00771">CmpFindSubKeyByNumber()</a>, <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00140">CmpFreeKeyByCell()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01515">CmpInitializeKeyNameString()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00454">_CM_KEY_NODE::SubKeyCounts</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00251">CmpCopySyncTree2()</a>.
<p>
<pre class="fragment"><div>01655                    :
01656 
01657    This routine makes sure that any subkeys present in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target key
01658    but not present in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source key are deleted from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target key
01659    along with any trees under those subkeys.
01660    
01661    This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> useful <span class="keywordflow">for</span> synchronizing key deletion changes
01662    in a source cell with a target cell. It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used in <span class="keyword">this</span> way
01663    from <a class="code" href="../../d1/d2/cmp_8h.html#a269">CmpCopySyncTree</a>.
01664    
01665    NOTE: It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed that no open handles are held <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> keys
01666          being deleted. If <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not so, registry in-memory
01667          data structures may become corrupted.
01668    
01669 Arguments:
01670 
01671    SourceHive  - The hive of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source key
01672    SourceCell  - The body of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source key
01673    TargetHive  - The hive of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target key
01674    TargetCell  - The body of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target key
01675    NameBuffer  - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> buffer <a class="code" href="../../d9/d0/cmdata_8h.html#a1">MAX_KEY_NAME_LENGTH</a> bytes in size
01676 
01677 Return Value:
01678 
01679    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> successful, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
01680 
01681 --*/
01682 {
01683    <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> TargetSubKey, SourceSubKey;
01684    ULONG i = 0;   
01685    <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> SubKeyCell;
01686    UNICODE_STRING SubKeyName;
01687 
01688    <span class="comment">//</span>
01689    <span class="comment">// Run through all of the target cell's subkeys</span>
01690    <span class="comment">//</span>
01691 
01692    <span class="keywordflow">while</span>((TargetSubKey = <a class="code" href="../../d1/d2/cmp_8h.html#a304">CmpFindSubKeyByNumber</a>(
01693                                                TargetHive,
01694                                                TargetCell,
01695                                                i)) != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>)
01696    {
01697       
01698       <span class="comment">//</span>
01699       <span class="comment">// Check if the current subkey has a counterpart</span>
01700       <span class="comment">// subkey of the source cell.</span>
01701       <span class="comment">// (Note that we use similar techniques as in the code</span>
01702       <span class="comment">//  of CmpCopySyncTree2)</span>
01703       <span class="comment">//</span>
01704 
01705       SubKeyCell = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(TargetHive, TargetSubKey);
01706 
01707       <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a14">CmpInitializeKeyNameString</a>(SubKeyCell,
01708                                  &amp;SubKeyName,
01709                                  NameBuffer);
01710 
01711       SourceSubKey = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(SourceHive, 
01712                                          SourceCell,
01713                                          &amp;SubKeyName);
01714 
01715       <span class="keywordflow">if</span>(SourceSubKey == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>)
01716       { 
01717          <span class="comment">//</span>
01718          <span class="comment">// The current subkey has no counterpart, </span>
01719          <span class="comment">// it must therefore be deleted from the target cell.</span>
01720          <span class="comment">//</span>
01721 
01722 <span class="preprocessor">#if DEBUG_TREE_SYNC</span>
01723 <span class="preprocessor"></span>         KdPrint((<span class="stringliteral">"CONFIG: SubKey Deletion of %.*S\n"</span>,                         
01724                SubKeyName.Length / <span class="keyword">sizeof</span>(WCHAR),
01725                SubKeyName.Buffer));         
01726 <span class="preprocessor">#endif</span>
01727 <span class="preprocessor"></span>         
01728          <span class="keywordflow">if</span>(SubKeyCell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] + SubKeyCell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>])
01729          {
01730             <span class="comment">// The subkey we are deleting has subkeys - use delete tree to get rid of them            </span>
01731 
01732             <a class="code" href="../../d3/d3/cmtredel_8c.html#a0">CmpDeleteTree</a>(TargetHive, TargetSubKey);
01733 
01734 <span class="preprocessor">#if DEBUG_TREE_SYNC</span>
01735 <span class="preprocessor"></span>            KdPrint((<span class="stringliteral">"CONFIG: Delete TREE performed.\n"</span>));
01736 <span class="preprocessor">#endif</span>
01737 <span class="preprocessor"></span>         }
01738          
01739          <span class="comment">// The subkey we are deleting is now a leaf (or has always been one), </span>
01740          <span class="comment">// just delete it.</span>
01741 
01742          <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d3/d3/cmtredel_8c.html#a1">CmpFreeKeyByCell</a>(TargetHive, TargetSubKey, TRUE)))
01743          {
01744             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01745          }
01746          
01747          <span class="comment">//</span>
01748          <span class="comment">// We have deleted a subkey, so *i* does not need to get incremented</span>
01749          <span class="comment">// here because it now refers to the next subkey.</span>
01750          <span class="comment">//         </span>
01751       }
01752       <span class="keywordflow">else</span>
01753       {
01754          <span class="comment">//</span>
01755          <span class="comment">// Counterpart found. No deletion necessary. Move on to the next subkey</span>
01756          <span class="comment">//</span>
01757 
01758          i++;
01759       }
01760    }
01761          
01762    <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01763 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:12 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
