<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: kdbreak.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>kdbreak.c</h1><a href="../../d1/d4/4_2kdbreak_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    kdbreak.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements machine dependent functions to add and delete</span>
00012 <span class="comment">    breakpoints from the kernel debugger breakpoint table.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    David N. Cutler 2-Aug-1990</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include "<a class="code" href="../../d1/d7/4_2kdp_8h.html">kdp.h</a>"</span>
00023 
00024 <span class="comment">//</span>
00025 <span class="comment">// Define external references.</span>
00026 <span class="comment">//</span>
00027 
00028 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00029 <a class="code" href="../../d1/d4/4_2kdbreak_8c.html#a0">KdSetOwedBreakpoints</a>(
00030     VOID
00031     );
00032 
00033 BOOLEAN
00034 <a class="code" href="../../d1/d4/4_2kdbreak_8c.html#a4">KdpLowWriteContent</a>(
00035     ULONG Index
00036     );
00037 
00038 BOOLEAN
00039 <a class="code" href="../../d1/d4/4_2kdbreak_8c.html#a9">KdpLowRestoreBreakpoint</a>(
00040     ULONG Index
00041     );
00042 
00043 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00044 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEKD, KdpAddBreakpoint)</span>
00045 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEKD, KdpDeleteBreakpoint)</span>
00046 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEKD, KdpDeleteBreakpointRange)</span>
00047 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEKD, KdpSuspendBreakpoint)</span>
00048 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEKD, KdpSuspendAllBreakpoints)</span>
00049 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEKD, KdpRestoreAllBreakpoints)</span>
00050 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEKD, KdpLowWriteContent)</span>
00051 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEKD, KdpLowRestoreBreakpoint)</span>
00052 <span class="preprocessor"></span><span class="preprocessor">#if defined(_IA64_)</span>
00053 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEKD, KdpSuspendBreakpointRange)</span>
00054 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEKD, KdpRestoreBreakpointRange)</span>
00055 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00056 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00057 <span class="preprocessor"></span>
00058 
00059 ULONG
<a name="l00060"></a><a class="code" href="../../d1/d4/4_2kdbreak_8c.html#a3">00060</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a104">KdpAddBreakpoint</a> (
00061     IN PVOID Address
00062     )
00063 
00064 <span class="comment">/*++</span>
00065 <span class="comment"></span>
00066 <span class="comment">Routine Description:</span>
00067 <span class="comment"></span>
00068 <span class="comment">    This routine adds an entry to the breakpoint table and returns a handle</span>
00069 <span class="comment">    to the breakpoint table entry.</span>
00070 <span class="comment"></span>
00071 <span class="comment">Arguments:</span>
00072 <span class="comment"></span>
00073 <span class="comment">    Address - Supplies the address where to set the breakpoint.</span>
00074 <span class="comment"></span>
00075 <span class="comment">Return Value:</span>
00076 <span class="comment"></span>
00077 <span class="comment">    A value of zero is returned if the specified address is already in the</span>
00078 <span class="comment">    breakpoint table, there are no free entries in the breakpoint table, the</span>
00079 <span class="comment">    specified address is not correctly aligned, or the specified address is</span>
00080 <span class="comment">    not valid. Otherwise, the index of the assigned breakpoint table entry</span>
00081 <span class="comment">    plus one is returned as the function value.</span>
00082 <span class="comment"></span>
00083 <span class="comment">--*/</span>
00084 
00085 {
00086 
00087     <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a> Content;
00088     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00089     HARDWARE_PTE Opaque;
00090     PVOID AccessAddress;
00091 
00092     <span class="comment">//DPRINT(("KD: Setting breakpoint at 0x%08x\n", Address));</span>
00093 
00094     <span class="comment">//</span>
00095     <span class="comment">// If the specified address is not properly aligned, then return zero.</span>
00096     <span class="comment">//</span>
00097 
00098     <span class="keywordflow">if</span> (((ULONG_PTR)Address &amp; <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a5">KDP_BREAKPOINT_ALIGN</a>) != 0) {
00099         <span class="keywordflow">return</span> 0;
00100     }
00101 
00102 
00103     <span class="comment">//</span>
00104     <span class="comment">// Don't allow setting the same breakpoint twice.</span>
00105     <span class="comment">//</span>
00106 
00107     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; BREAKPOINT_TABLE_SIZE; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00108         <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a1">KD_BREAKPOINT_IN_USE</a>) != 0 &amp;&amp;
00109             <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> == Address) {
00110 
00111             <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a4">KD_BREAKPOINT_NEEDS_REPLACE</a>) != 0) {
00112 
00113                 <span class="comment">//</span>
00114                 <span class="comment">// Breakpoint was set, the page was written out and was not</span>
00115                 <span class="comment">// accessible when the breakpoint was cleared.  Now the breakpoint</span>
00116                 <span class="comment">// is being set again.  Just clear the defer flag:</span>
00117                 <span class="comment">//</span>
00118                 <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp;= ~<a class="code" href="../../d0/d7/kdp_8h.html#a4">KD_BREAKPOINT_NEEDS_REPLACE</a>;
00119                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> + 1;
00120 
00121             } <span class="keywordflow">else</span> {
00122 
00123                 <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: Attempt to set breakpoint %08x twice!\n"</span>, Address));
00124                 <span class="keywordflow">return</span> 0;
00125 
00126             }
00127         }
00128     }
00129 
00130     <span class="comment">//</span>
00131     <span class="comment">// Search the breakpoint table for a free entry.</span>
00132     <span class="comment">//</span>
00133 
00134     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; BREAKPOINT_TABLE_SIZE; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00135         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> == 0) {
00136             <span class="keywordflow">break</span>;
00137         }
00138     }
00139 
00140     <span class="comment">//</span>
00141     <span class="comment">// If a free entry was found, then write breakpoint and return the handle</span>
00142     <span class="comment">// value plus one. Otherwise, return zero.</span>
00143     <span class="comment">//</span>
00144 
00145     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> == BREAKPOINT_TABLE_SIZE) {
00146         <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: ran out of breakpoints!\n"</span>));
00147         <span class="keywordflow">return</span> 0;
00148     }
00149 
00150 
00151     <span class="comment">//DPRINT(("KD: using Index %d\n", Index));</span>
00152 
00153     <span class="comment">//</span>
00154     <span class="comment">// Get the instruction to be replaced. If the instruction cannot be read,</span>
00155     <span class="comment">// then mark breakpoint as not accessible.</span>
00156     <span class="comment">//</span>
00157 
00158     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00159             (PCHAR)&amp;Content,
00160             (PCHAR)Address,
00161             <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>) ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00162         AccessAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00163         <span class="comment">//DPRINT(("KD: memory inaccessible\n"));</span>
00164     } <span class="keywordflow">else</span> {
00165         <span class="comment">//DPRINT(("KD: memory readable...\n"));</span>
00166 
00167         <span class="comment">//</span>
00168         <span class="comment">// If the specified address is not write accessible, then return zero.</span>
00169         <span class="comment">// All references must be made through AccessAddress.</span>
00170         <span class="comment">//</span>
00171 
00172         AccessAddress = <a class="code" href="../../d4/d6/ppc_2debugsup_8c.html#a1">MmDbgWriteCheck</a>((PVOID)Address, &amp;Opaque);
00173         <span class="keywordflow">if</span> (AccessAddress == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00174             <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: memory not writable!\n"</span>));
00175             <span class="keywordflow">return</span> 0;
00176         }
00177     }
00178 
00179 <span class="preprocessor">#if defined(_IA64_)</span>
00180 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( AccessAddress != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00181         <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a> mBuf;
00182         PVOID BundleAddress;
00183 
00184         <span class="comment">// change template to type 0 if current instruction is MLI</span>
00185 
00186         <span class="comment">// read in intruction template if current instruction is NOT slot 0.</span>
00187         <span class="comment">// check for two-slot MOVL instruction. Reject request if attempt to</span>
00188         <span class="comment">// set break in slot 2 of MLI template.</span>
00189 
00190         <span class="keywordflow">if</span> (((ULONG_PTR)Address &amp; 0xf) != 0) {
00191             (ULONG_PTR)BundleAddress = (ULONG_PTR)AccessAddress &amp; ~(0xf);
00192             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00193                     (PCHAR)&amp;mBuf,
00194                     (PCHAR)BundleAddress,
00195                     <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)
00196                     ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00197                 <span class="comment">//DPRINT(("KD: read 0x%08x template failed\n", BundleAddress));</span>
00198                 <a class="code" href="../../d2/d6/ia64_2debugsup_8c.html#a2">MmDbgReleaseAddress</a>(AccessAddress, &amp;Opaque);
00199                 <span class="keywordflow">return</span> 0;
00200             } <span class="keywordflow">else</span> {
00201                 <span class="keywordflow">if</span> (((mBuf &amp; INST_TEMPL_MASK) &gt;&gt; 1) == 0x2) {
00202                     <span class="keywordflow">if</span> (((ULONG_PTR)Address &amp; 0xf) == 4) {
00203                         <span class="comment">// if template= type 2 MLI, change to type 0</span>
00204                         mBuf &amp;= ~((INST_TEMPL_MASK &gt;&gt; 1) &lt;&lt; 1);
00205                         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a8">KD_BREAKPOINT_IA64_MOVL</a>;
00206                         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00207                                 (PCHAR)BundleAddress,
00208                                 (PCHAR)&amp;mBuf,
00209                                 <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)
00210                                 ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00211                             <span class="comment">//DPRINT(("KD: write to 0x%08x template failed\n", BundleAddress));</span>
00212                             <a class="code" href="../../d2/d6/ia64_2debugsup_8c.html#a2">MmDbgReleaseAddress</a>(AccessAddress, &amp;Opaque);
00213                             <span class="keywordflow">return</span> 0;
00214                          }
00215                          <span class="keywordflow">else</span> {
00216                              <span class="comment">//DPRINT(("KD: change MLI template to type 0 at 0x%08x set\n", Address));</span>
00217                          }
00218                     } <span class="keywordflow">else</span> {
00219                          <span class="comment">// set breakpoint at slot 2 of MOVL is illegal</span>
00220                          <span class="comment">//DPRINT(("KD: illegal to set BP at slot 2 of MOVL at 0x%08x\n", BundleAddress));</span>
00221                          <a class="code" href="../../d2/d6/ia64_2debugsup_8c.html#a2">MmDbgReleaseAddress</a>(AccessAddress, &amp;Opaque);
00222                          <span class="keywordflow">return</span> 0;
00223                     }
00224                 }
00225             }
00226         }
00227 
00228         <span class="comment">// insert break instruction</span>
00229 
00230         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> = Address;
00231         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o3">Content</a> = Content;
00232         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp;= ~(<a class="code" href="../../d0/d7/kdp_8h.html#a5">KD_BREAKPOINT_STATE_MASK</a>);
00233         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a1">KD_BREAKPOINT_IN_USE</a>;
00234         <span class="keywordflow">if</span> (Address &lt; (PVOID)<a class="code" href="../../d0/d7/kdp_8h.html#a0">GLOBAL_BREAKPOINT_LIMIT</a>) {
00235             <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o1">DirectoryTableBase</a> =
00236                 <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;ApcState.Process-&gt;DirectoryTableBase[0];
00237             }
00238             <span class="keywordflow">switch</span> ((ULONG_PTR)Address &amp; 0xf) {
00239             <span class="keywordflow">case</span> 0:
00240                 Content = (Content &amp; ~(INST_SLOT0_MASK)) | (<a class="code" href="../../d8/d5/kddata_8c.html#a91">KdpBreakpointInstruction</a> &lt;&lt; 5);
00241                 <span class="keywordflow">break</span>;
00242 
00243             <span class="keywordflow">case</span> 4:
00244                 Content = (Content &amp; ~(INST_SLOT1_MASK)) | (<a class="code" href="../../d8/d5/kddata_8c.html#a91">KdpBreakpointInstruction</a> &lt;&lt; 14);
00245                 <span class="keywordflow">break</span>;
00246 
00247             <span class="keywordflow">case</span> 8:
00248                 Content = (Content &amp; ~(INST_SLOT2_MASK)) | (<a class="code" href="../../d8/d5/kddata_8c.html#a91">KdpBreakpointInstruction</a> &lt;&lt; 23);
00249                 <span class="keywordflow">break</span>;
00250 
00251             <span class="keywordflow">default</span>:
00252                 <a class="code" href="../../d2/d6/ia64_2debugsup_8c.html#a2">MmDbgReleaseAddress</a>(AccessAddress, &amp;Opaque);
00253                 <span class="comment">//DPRINT(("KD: KdpAddBreakpoint bad instruction slot#\n"));</span>
00254                 <span class="keywordflow">return</span> 0;
00255             }
00256             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00257                     (PCHAR)AccessAddress,
00258                     (PCHAR)&amp;Content,
00259                     <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)
00260                     ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00261 
00262                 <a class="code" href="../../d2/d6/ia64_2debugsup_8c.html#a2">MmDbgReleaseAddress</a>(AccessAddress, &amp;Opaque);
00263                 <span class="comment">//DPRINT(("KD: KdpMoveMemory failed writing BP!\n"));</span>
00264                 <span class="keywordflow">return</span> 0;
00265             }
00266             <span class="keywordflow">else</span> {
00267                 <span class="comment">//DPRINT(("KD: breakpoint at 0x%08x set\n", Address));</span>
00268             }
00269         <a class="code" href="../../d2/d6/ia64_2debugsup_8c.html#a2">MmDbgReleaseAddress</a>(AccessAddress, &amp;Opaque);
00270 
00271     } <span class="keywordflow">else</span> {  <span class="comment">// memory not accessible</span>
00272         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> = Address;
00273         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp;= ~(<a class="code" href="../../d0/d7/kdp_8h.html#a5">KD_BREAKPOINT_STATE_MASK</a>);
00274         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a1">KD_BREAKPOINT_IN_USE</a>;
00275         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a2">KD_BREAKPOINT_NEEDS_WRITE</a>;
00276         <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00277         <span class="comment">//DPRINT(("KD: breakpoint write deferred\n"));</span>
00278         <span class="keywordflow">if</span> (Address &lt; (PVOID)<a class="code" href="../../d0/d7/kdp_8h.html#a0">GLOBAL_BREAKPOINT_LIMIT</a>) {
00279             <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o1">DirectoryTableBase</a> =
00280                 <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;ApcState.Process-&gt;DirectoryTableBase[0];
00281         }
00282     }
00283 <span class="preprocessor">#else</span>
00284 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( AccessAddress != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00285         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> = Address;
00286         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o3">Content</a> = Content;
00287         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> = <a class="code" href="../../d0/d7/kdp_8h.html#a1">KD_BREAKPOINT_IN_USE</a>;
00288         <span class="keywordflow">if</span> (Address &lt; (PVOID)<a class="code" href="../../d0/d7/kdp_8h.html#a0">GLOBAL_BREAKPOINT_LIMIT</a>) {
00289             <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o1">DirectoryTableBase</a> =
00290                 <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;ApcState.Process-&gt;DirectoryTableBase[0];
00291         }
00292         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00293                 (PCHAR)AccessAddress,
00294                 (PCHAR)&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a91">KdpBreakpointInstruction</a>,
00295                 <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)
00296                 ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00297 
00298             <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: KdpMoveMemory failed writing BP!\n"</span>));
00299         }
00300         <a class="code" href="../../d2/d6/ia64_2debugsup_8c.html#a2">MmDbgReleaseAddress</a>(AccessAddress, &amp;Opaque);
00301     } <span class="keywordflow">else</span> {
00302         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> = Address;
00303         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> = <a class="code" href="../../d0/d7/kdp_8h.html#a1">KD_BREAKPOINT_IN_USE</a> | <a class="code" href="../../d0/d7/kdp_8h.html#a2">KD_BREAKPOINT_NEEDS_WRITE</a>;
00304         <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00305         <span class="comment">//DPRINT(("KD: breakpoint write deferred\n"));</span>
00306         <span class="keywordflow">if</span> (Address &lt; (PVOID)<a class="code" href="../../d0/d7/kdp_8h.html#a0">GLOBAL_BREAKPOINT_LIMIT</a>) {
00307             <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o1">DirectoryTableBase</a> =
00308                 <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;ApcState.Process-&gt;DirectoryTableBase[0];
00309         }
00310     }
00311 <span class="preprocessor">#endif  // IA64</span>
00312 <span class="preprocessor"></span>
00313     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> + 1;
00314 
00315 }
00316 
00317 
00318 
00319 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00320 <a class="code" href="../../d1/d4/4_2kdbreak_8c.html#a0">KdSetOwedBreakpoints</a>(
00321     VOID
00322     )
00323 
00324 <span class="comment">/*++</span>
00325 <span class="comment"></span>
00326 <span class="comment">Routine Description:</span>
00327 <span class="comment"></span>
00328 <span class="comment">    This function is called after returning from memory management calls</span>
00329 <span class="comment">    that may cause an inpage.  Its purpose is to store pending</span>
00330 <span class="comment">    breakpoints in pages just made valid.</span>
00331 <span class="comment"></span>
00332 <span class="comment">Arguments:</span>
00333 <span class="comment"></span>
00334 <span class="comment">    None.</span>
00335 <span class="comment"></span>
00336 <span class="comment">Return Value:</span>
00337 <span class="comment"></span>
00338 <span class="comment">    None.</span>
00339 <span class="comment"></span>
00340 <span class="comment">--*/</span>
00341 
00342 {
00343 
00344     <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a> Content;
00345     BOOLEAN Enable;
00346     LONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00347     HARDWARE_PTE Opaque;
00348     PVOID AccessAddress;
00349 
00350     <span class="comment">//</span>
00351     <span class="comment">// If we don't owe any breakpoints then return</span>
00352     <span class="comment">//</span>
00353 
00354     <span class="keywordflow">if</span> ( !<a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> ) {
00355         <span class="keywordflow">return</span>;
00356     }
00357 
00358 
00359     <span class="comment">//</span>
00360     <span class="comment">// Freeze all other processors, disable interrupts, and save debug</span>
00361     <span class="comment">// port state.</span>
00362     <span class="comment">//</span>
00363 
00364     Enable = <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a17">KdEnterDebugger</a>(NULL, NULL);
00365     <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00366     AccessAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00367 
00368     <span class="comment">//</span>
00369     <span class="comment">// Search the breakpoint table for breakpoints that need to be</span>
00370     <span class="comment">// written or replaced.</span>
00371     <span class="comment">//</span>
00372 
00373     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; BREAKPOINT_TABLE_SIZE; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00374         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp;
00375                 (<a class="code" href="../../d0/d7/kdp_8h.html#a2">KD_BREAKPOINT_NEEDS_WRITE</a> | <a class="code" href="../../d0/d7/kdp_8h.html#a4">KD_BREAKPOINT_NEEDS_REPLACE</a>) ) {
00376 
00377             <span class="comment">//</span>
00378             <span class="comment">// Breakpoint needs to be written</span>
00379             <span class="comment">//</span>
00380             <span class="comment">//DPRINT(("KD: Breakpoint %d at 0x%08x: trying to %s after page in.\n",</span>
00381             <span class="comment">//    Index,</span>
00382             <span class="comment">//    KdpBreakpointTable[Index].Address,</span>
00383             <span class="comment">//    (KdpBreakpointTable[Index].Flags &amp; KD_BREAKPOINT_NEEDS_WRITE) ?</span>
00384             <span class="comment">//        "set" : "clear"));</span>
00385 
00386             <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> &gt;= (PVOID)<a class="code" href="../../d0/d7/kdp_8h.html#a0">GLOBAL_BREAKPOINT_LIMIT</a>) ||
00387                 (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o1">DirectoryTableBase</a> ==
00388                  <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;ApcState.Process-&gt;DirectoryTableBase[0])) {
00389 
00390                 <span class="comment">//</span>
00391                 <span class="comment">// Check to see if we have write access to the memory</span>
00392                 <span class="comment">//</span>
00393 
00394                 AccessAddress = <a class="code" href="../../d4/d6/ppc_2debugsup_8c.html#a1">MmDbgWriteCheck</a>((PVOID)KdpBreakpointTable[Index].Address, &amp;Opaque);
00395 
00396                 <span class="keywordflow">if</span> (AccessAddress == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00397                     <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00398                     <span class="comment">//DPRINT(("KD: address not writeable.\n"));</span>
00399                     <span class="keywordflow">break</span>;
00400                 }
00401 
00402                 <span class="comment">//</span>
00403                 <span class="comment">// Breakpoint is global, or its directory base matches</span>
00404                 <span class="comment">//</span>
00405 
00406                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00407                         (PCHAR)&amp;Content,
00408                         (PCHAR)AccessAddress,
00409                         <span class="keyword">sizeof</span>(KDP_BREAKPOINT_TYPE)
00410                         ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00411 
00412                     <span class="comment">//</span>
00413                     <span class="comment">// Memory is still inaccessible (is this possible after</span>
00414                     <span class="comment">// the call above to MmDbgWriteCheck?)</span>
00415                     <span class="comment">//</span>
00416 
00417                     <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: read from 0x%08x failed\n"</span>, KdpBreakpointTable[Index].Address));
00418 
00419                     <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00420 
00421                 } <span class="keywordflow">else</span> {
00422                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a2">KD_BREAKPOINT_NEEDS_WRITE</a>) {
00423                         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o3">Content</a> = Content;
00424 <span class="preprocessor">#if defined(_IA64_)</span>
00425 <span class="preprocessor"></span>                        <span class="keywordflow">switch</span> ((ULONG_PTR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> &amp; 0xf) {
00426                         <span class="keywordflow">case</span> 0:
00427                             Content = (Content &amp; ~(INST_SLOT0_MASK)) | (<a class="code" href="../../d8/d5/kddata_8c.html#a91">KdpBreakpointInstruction</a> &lt;&lt; 5);
00428                             <span class="keywordflow">break</span>;
00429 
00430                         <span class="keywordflow">case</span> 4:
00431                             Content = (Content &amp; ~(INST_SLOT1_MASK)) | (<a class="code" href="../../d8/d5/kddata_8c.html#a91">KdpBreakpointInstruction</a> &lt;&lt; 14);
00432                             <span class="keywordflow">break</span>;
00433 
00434                         <span class="keywordflow">case</span> 8:
00435                             Content = (Content &amp; ~(INST_SLOT2_MASK)) | (<a class="code" href="../../d8/d5/kddata_8c.html#a91">KdpBreakpointInstruction</a> &lt;&lt; 23);
00436                             <span class="keywordflow">break</span>;
00437 
00438                         <span class="keywordflow">default</span>:
00439                             <span class="comment">//DPRINT(("KD: illegal instruction address 0x%08x\n", KdpBreakpointTable[Index].Address));</span>
00440                             <span class="keywordflow">break</span>;
00441                         }
00442                         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00443                                 (PCHAR)AccessAddress,
00444                                 (PCHAR)&amp;Content,
00445                                 <span class="keyword">sizeof</span>(KDP_BREAKPOINT_TYPE)
00446                                 ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00447                             <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00448                             <span class="comment">//DPRINT(("KD: write to 0x%08x failed\n", KdpBreakpointTable[Index].Address));</span>
00449                         }
00450 
00451                         <span class="comment">// read in intruction template if current instruction is NOT slot 0.</span>
00452                         <span class="comment">// check for two-slot MOVL instruction. Reject request if attempt to</span>
00453                         <span class="comment">// set break in slot 2 of MLI template.</span>
00454 
00455                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (((ULONG_PTR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> &amp; 0xf) != 0) {
00456                             <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a> mBuf;
00457                             PVOID BundleAddress;
00458 
00459                             (ULONG_PTR)BundleAddress = (ULONG_PTR)AccessAddress  &amp; ~(0xf);
00460                             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00461                                     (PCHAR)&amp;mBuf,
00462                                     (PCHAR)BundleAddress,
00463                                     <span class="keyword">sizeof</span>(KDP_BREAKPOINT_TYPE)
00464                                     ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00465                                 <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00466                                 <span class="comment">//DPRINT(("KD: read 0x%08x template failed\n", KdpBreakpointTable[Index].Address));</span>
00467                             } <span class="keywordflow">else</span> {
00468                                 <span class="keywordflow">if</span> (((mBuf &amp; INST_TEMPL_MASK) &gt;&gt; 1) == 0x2) {
00469                                     <span class="keywordflow">if</span> (((ULONG_PTR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a>  &amp; 0xf) == 4) {
00470                                         <span class="comment">// if template= type 2 MLI, change to type 0</span>
00471                                         mBuf &amp;= ~((INST_TEMPL_MASK &gt;&gt; 1) &lt;&lt; 1);
00472                                         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a8">KD_BREAKPOINT_IA64_MOVL</a>;
00473                                         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00474                                             (PCHAR)BundleAddress,
00475                                             (PCHAR)&amp;mBuf,
00476                                             <span class="keyword">sizeof</span>(KDP_BREAKPOINT_TYPE)
00477                                             ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00478                                             <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00479                                             <span class="comment">//DPRINT(("KD: write to 0x%08x template failed\n", KdpBreakpointTable[Index].Address));</span>
00480                                         }
00481                                         <span class="keywordflow">else</span> {
00482                                             <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp;= ~(<a class="code" href="../../d0/d7/kdp_8h.html#a5">KD_BREAKPOINT_STATE_MASK</a>);
00483                                             <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a1">KD_BREAKPOINT_IN_USE</a>;
00484                                             <span class="comment">//DPRINT(("KD: write to 0x%08x ok\n", KdpBreakpointTable[Index].Address));</span>
00485                                         }
00486                                     } <span class="keywordflow">else</span> {
00487                                         <span class="comment">// set breakpoint at slot 2 of MOVL is illegal</span>
00488                                         <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00489                                         <span class="comment">//DPRINT(("KD: illegal attempt to set BP at slot 2 of 0x%08x\n", KdpBreakpointTable[Index].Address));</span>
00490                                     }
00491                                 }
00492                                 <span class="keywordflow">else</span> {
00493                                     <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp;= ~(<a class="code" href="../../d0/d7/kdp_8h.html#a5">KD_BREAKPOINT_STATE_MASK</a>);
00494                                     <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a1">KD_BREAKPOINT_IN_USE</a>;
00495                                     <span class="comment">//DPRINT(("KD: write to 0x%08x ok\n", KdpBreakpointTable[Index].Address));</span>
00496                                 }
00497                             }
00498                         }
00499 <span class="preprocessor">#else</span>
00500 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00501                                 (PCHAR)AccessAddress,
00502                                 (PCHAR)&amp;KdpBreakpointInstruction,
00503                                 <span class="keyword">sizeof</span>(KDP_BREAKPOINT_TYPE)
00504                                 ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00505                             <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00506                             <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: write to 0x%08x failed\n"</span>, KdpBreakpointTable[Index].Address));
00507                         } <span class="keywordflow">else</span> {
00508                             <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> = <a class="code" href="../../d0/d7/kdp_8h.html#a1">KD_BREAKPOINT_IN_USE</a>;
00509                             <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: write to 0x%08x ok\n"</span>, KdpBreakpointTable[Index].Address));
00510                         }
00511 <span class="preprocessor">#endif</span>
00512 <span class="preprocessor"></span>                    } <span class="keywordflow">else</span> {
00513 <span class="preprocessor">#if defined(_IA64_)</span>
00514 <span class="preprocessor"></span>
00515                         <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a> mBuf;
00516                         PVOID BundleAddress;
00517 
00518                         <span class="comment">// restore original instruction content</span>
00519 
00520                         <span class="comment">// Read in memory since adjancent instructions in the same bundle may have</span>
00521                         <span class="comment">// been modified after we save them.</span>
00522                         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00523                                 (PCHAR)&amp;mBuf,
00524                                 (PCHAR)AccessAddress,
00525                                 <span class="keyword">sizeof</span>(KDP_BREAKPOINT_TYPE)) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00526                             <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00527                             <span class="comment">//DPRINT(("KD: read 0x%08x template failed\n", KdpBreakpointTable[Index].Address));</span>
00528                         }
00529                         <span class="keywordflow">else</span> {
00530                             <span class="keywordflow">switch</span> ((ULONG_PTR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> &amp; 0xf) {
00531                             <span class="keywordflow">case</span> 0:
00532                                 mBuf = (mBuf &amp; ~(INST_SLOT0_MASK))
00533                                              | (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o3">Content</a> &amp; INST_SLOT0_MASK);
00534                                 <span class="keywordflow">break</span>;
00535 
00536                             <span class="keywordflow">case</span> 4:
00537                                 mBuf = (mBuf &amp; ~(INST_SLOT1_MASK))
00538                                              | (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o3">Content</a> &amp; INST_SLOT1_MASK);
00539                                 <span class="keywordflow">break</span>;
00540 
00541                             <span class="keywordflow">case</span> 8:
00542                                 mBuf = (mBuf &amp; ~(INST_SLOT2_MASK))
00543                                              | (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o3">Content</a> &amp; INST_SLOT2_MASK);
00544                                 <span class="keywordflow">break</span>;
00545 
00546                             <span class="keywordflow">default</span>:
00547                                 <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00548                                 <span class="comment">//DPRINT(("KD: illegal instruction address 0x%08x\n", KdpBreakpointTable[Index].Address));</span>
00549                             }
00550 
00551                             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00552                                     (PCHAR)AccessAddress,
00553                                     (PCHAR)&amp;mBuf,
00554                                     <span class="keyword">sizeof</span>(KDP_BREAKPOINT_TYPE)) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00555                                 <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00556                                 <span class="comment">//DPRINT(("KD: write to 0x%08x failed\n", KdpBreakpointTable[Index].Address));</span>
00557                             }
00558                             <span class="keywordflow">else</span> {
00559                                  <span class="comment">// restore template to MLI if displaced instruction was MOVL</span>
00560 
00561                                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a8">KD_BREAKPOINT_IA64_MOVL</a>) {
00562                                     (ULONG_PTR)BundleAddress = (ULONG_PTR)AccessAddress &amp; ~(0xf);
00563                                     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00564                                             (PCHAR)&amp;mBuf,
00565                                             (PCHAR)BundleAddress,
00566                                             <span class="keyword">sizeof</span>(KDP_BREAKPOINT_TYPE)
00567                                             ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00568                                         <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00569                                         <span class="comment">//DPRINT(("KD: read template 0x%08x failed\n", KdpBreakpointTable[Index].Address));</span>
00570                                     }
00571                                     <span class="keywordflow">else</span> {
00572                                         mBuf &amp;= ~((INST_TEMPL_MASK &gt;&gt; 1) &lt;&lt; 1); <span class="comment">// set template to MLI</span>
00573                                         mBuf |= 0x4;
00574 
00575                                         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00576                                               (PCHAR)BundleAddress,
00577                                               (PCHAR)&amp;mBuf,
00578                                               <span class="keyword">sizeof</span>(KDP_BREAKPOINT_TYPE)
00579                                               ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00580                                             <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00581                                             <span class="comment">//DPRINT(("KD: write template to 0x%08x failed\n", KdpBreakpointTable[Index].Address));</span>
00582                                         } <span class="keywordflow">else</span> {
00583                                             <span class="comment">//DPRINT(("KD: write to 0x%08x ok\n", KdpBreakpointTable[Index].Address));</span>
00584                                             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a3">KD_BREAKPOINT_SUSPENDED</a>) {
00585                                                 <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= (<a class="code" href="../../d0/d7/kdp_8h.html#a3">KD_BREAKPOINT_SUSPENDED</a> | <a class="code" href="../../d0/d7/kdp_8h.html#a1">KD_BREAKPOINT_IN_USE</a>);
00586                                             } <span class="keywordflow">else</span> {
00587                                                 <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> = 0;
00588                                             }
00589                                         }
00590                                     }
00591                                 } <span class="keywordflow">else</span> {
00592                                     <span class="comment">//DPRINT(("KD: write to 0x%08x ok\n", KdpBreakpointTable[Index].Address));</span>
00593                                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a3">KD_BREAKPOINT_SUSPENDED</a>) {
00594                                         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= (<a class="code" href="../../d0/d7/kdp_8h.html#a3">KD_BREAKPOINT_SUSPENDED</a> | <a class="code" href="../../d0/d7/kdp_8h.html#a1">KD_BREAKPOINT_IN_USE</a>);
00595                                     } <span class="keywordflow">else</span> {
00596                                         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> = 0;
00597                                     }
00598                                 }
00599                             }
00600                         }
00601 <span class="preprocessor">#else</span>
00602 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00603                                 (PCHAR)AccessAddress,
00604                                 (PCHAR)&amp;KdpBreakpointTable[Index].Content,
00605                                 <span class="keyword">sizeof</span>(KDP_BREAKPOINT_TYPE)
00606                                 ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00607                             <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00608                             <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: write to 0x%08x failed\n"</span>, KdpBreakpointTable[Index].Address));
00609                         } <span class="keywordflow">else</span> {
00610                             <span class="comment">//DPRINT(("KD: write to 0x%08x ok\n", KdpBreakpointTable[Index].Address));</span>
00611                             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a3">KD_BREAKPOINT_SUSPENDED</a>) {
00612                                 <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> = <a class="code" href="../../d0/d7/kdp_8h.html#a3">KD_BREAKPOINT_SUSPENDED</a> | <a class="code" href="../../d0/d7/kdp_8h.html#a1">KD_BREAKPOINT_IN_USE</a>;
00613                             } <span class="keywordflow">else</span> {
00614                                 <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> = 0;
00615                             }
00616                         }
00617 <span class="preprocessor">#endif // _IA64_</span>
00618 <span class="preprocessor"></span>
00619                     }
00620                 }
00621 
00622                 <span class="keywordflow">if</span> (AccessAddress != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00623                     <a class="code" href="../../d2/d6/ia64_2debugsup_8c.html#a2">MmDbgReleaseAddress</a>(
00624                             AccessAddress,
00625                             &amp;Opaque
00626                             );
00627                     AccessAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00628                 }
00629 
00630             } <span class="keywordflow">else</span> {
00631 
00632                 <span class="comment">//</span>
00633                 <span class="comment">// Breakpoint is local and its directory base does not match</span>
00634                 <span class="comment">//</span>
00635 
00636                 <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00637             }
00638         }
00639     }
00640 
00641     <span class="keywordflow">if</span> (AccessAddress != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00642         <a class="code" href="../../d2/d6/ia64_2debugsup_8c.html#a2">MmDbgReleaseAddress</a>(
00643                 AccessAddress,
00644                 &amp;Opaque
00645                 );
00646     }
00647 
00648     <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a18">KdExitDebugger</a>(Enable);
00649     <span class="keywordflow">return</span>;
00650 }
00651 
00652 
00653 BOOLEAN
<a name="l00654"></a><a class="code" href="../../d1/d4/4_2kdbreak_8c.html#a4">00654</a> <a class="code" href="../../d1/d4/4_2kdbreak_8c.html#a4">KdpLowWriteContent</a> (
00655     IN ULONG Index
00656     )
00657 
00658 <span class="comment">/*++</span>
00659 <span class="comment"></span>
00660 <span class="comment">Routine Description:</span>
00661 <span class="comment"></span>
00662 <span class="comment">    This routine attempts to replace the code that a breakpoint is</span>
00663 <span class="comment">    written over.  This routine, KdpAddBreakpoint,</span>
00664 <span class="comment">    KdpLowRestoreBreakpoint and KdSetOwedBreakpoints are responsible</span>
00665 <span class="comment">    for getting data written as requested.  Callers should not</span>
00666 <span class="comment">    examine or use KdpOweBreakpoints, and they should not set the</span>
00667 <span class="comment">    NEEDS_WRITE or NEEDS_REPLACE flags.</span>
00668 <span class="comment"></span>
00669 <span class="comment">    Callers must still look at the return value from this function,</span>
00670 <span class="comment">    however: if it returns FALSE, the breakpoint record must not be</span>
00671 <span class="comment">    reused until KdSetOwedBreakpoints has finished with it.</span>
00672 <span class="comment"></span>
00673 <span class="comment">Arguments:</span>
00674 <span class="comment"></span>
00675 <span class="comment">    Index - Supplies the index of the breakpoint table entry</span>
00676 <span class="comment">        which is to be deleted.</span>
00677 <span class="comment"></span>
00678 <span class="comment">Return Value:</span>
00679 <span class="comment"></span>
00680 <span class="comment">    Returns TRUE if the breakpoint was removed, FALSE if it was deferred.</span>
00681 <span class="comment"></span>
00682 <span class="comment">--*/</span>
00683 
00684 {
00685 <span class="preprocessor">#if defined(_IA64_)</span>
00686 <span class="preprocessor"></span>    <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a> mBuf;
00687     PVOID BundleAddress;
00688 <span class="preprocessor">#endif</span>
00689 <span class="preprocessor"></span>
00690     <span class="comment">//</span>
00691     <span class="comment">// Do the contents need to be replaced at all?</span>
00692     <span class="comment">//</span>
00693 
00694     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a2">KD_BREAKPOINT_NEEDS_WRITE</a>) {
00695 
00696         <span class="comment">//</span>
00697         <span class="comment">// The breakpoint was never written out.  Clear the flag</span>
00698         <span class="comment">// and we are done.</span>
00699         <span class="comment">//</span>
00700 
00701         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp;= ~<a class="code" href="../../d0/d7/kdp_8h.html#a2">KD_BREAKPOINT_NEEDS_WRITE</a>;
00702         <span class="comment">//DPRINT(("KD: Breakpoint at 0x%08x never written; flag cleared.\n",</span>
00703         <span class="comment">//    KdpBreakpointTable[Index].Address));</span>
00704         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00705     }
00706 
00707 <span class="preprocessor">#if !defined(_IA64_)</span>
00708 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o3">Content</a> == <a class="code" href="../../d8/d5/kddata_8c.html#a91">KdpBreakpointInstruction</a>) {
00709 
00710         <span class="comment">//</span>
00711         <span class="comment">// The instruction is a breakpoint anyway.</span>
00712         <span class="comment">//</span>
00713 
00714         <span class="comment">//DPRINT(("KD: Breakpoint at 0x%08x; instr is really BP; flag cleared.\n",</span>
00715         <span class="comment">//    KdpBreakpointTable[Index].Address));</span>
00716 
00717         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00718     }
00719 <span class="preprocessor">#endif</span>
00720 <span class="preprocessor"></span>
00721 
00722     <span class="comment">//</span>
00723     <span class="comment">// Restore the instruction contents.</span>
00724     <span class="comment">//</span>
00725 
00726 <span class="preprocessor">#if defined(_IA64_)</span>
00727 <span class="preprocessor"></span>    <span class="comment">// Read in memory since adjancent instructions in the same bundle may have</span>
00728     <span class="comment">// been modified after we save them.</span>
00729     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00730             (PCHAR)&amp;mBuf,
00731             (PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address,
00732             <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00733         <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00734         <span class="comment">//DPRINT(("KD: read 0x%08x failed\n", KdpBreakpointTable[Index].Address));</span>
00735         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a4">KD_BREAKPOINT_NEEDS_REPLACE</a>;
00736         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00737     }
00738     <span class="keywordflow">else</span> {
00739 
00740         <span class="keywordflow">switch</span> ((ULONG_PTR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> &amp; 0xf) {
00741         <span class="keywordflow">case</span> 0:
00742             mBuf = (mBuf &amp; ~(INST_SLOT0_MASK))
00743                          | (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o3">Content</a> &amp; INST_SLOT0_MASK);
00744             <span class="keywordflow">break</span>;
00745 
00746         <span class="keywordflow">case</span> 4:
00747             mBuf = (mBuf &amp; ~(INST_SLOT1_MASK))
00748                          | (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o3">Content</a> &amp; INST_SLOT1_MASK);
00749             <span class="keywordflow">break</span>;
00750 
00751         <span class="keywordflow">case</span> 8:
00752             mBuf = (mBuf &amp; ~(INST_SLOT2_MASK))
00753                          | (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o3">Content</a> &amp; INST_SLOT2_MASK);
00754             <span class="keywordflow">break</span>;
00755 
00756         <span class="keywordflow">default</span>:
00757             <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00758             <span class="comment">//DPRINT(("KD: illegal instruction address 0x%08x\n", KdpBreakpointTable[Index].Address));</span>
00759             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00760         }
00761 
00762         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00763                 (PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address,
00764                 (PCHAR)&amp;mBuf,
00765                 <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00766             <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00767             <span class="comment">//DPRINT(("KD: write to 0x%08x failed\n", KdpBreakpointTable[Index].Address));</span>
00768             <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a4">KD_BREAKPOINT_NEEDS_REPLACE</a>;
00769             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00770         }
00771         <span class="keywordflow">else</span> {
00772 
00773             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00774                     (PCHAR)&amp;mBuf,
00775                     (PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address,
00776                     <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) == <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00777                 <span class="comment">//DPRINT(("\tcontent after memory move = 0x%08x 0x%08x\n", (ULONG)(mBuf &gt;&gt; 32), (ULONG)mBuf));</span>
00778             }
00779 
00780             <span class="comment">// restore template to MLI if displaced instruction was MOVL</span>
00781 
00782             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a8">KD_BREAKPOINT_IA64_MOVL</a>) {
00783                 (ULONG_PTR)BundleAddress = (ULONG_PTR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> &amp; ~(0xf);
00784                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00785                         (PCHAR)&amp;mBuf,
00786                         (PCHAR)BundleAddress,
00787                         <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)
00788                         ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00789                     <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00790                     <span class="comment">//DPRINT(("KD: read template 0x%08x failed\n", KdpBreakpointTable[Index].Address));</span>
00791                     <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a4">KD_BREAKPOINT_NEEDS_REPLACE</a>;
00792                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00793                 }
00794                 <span class="keywordflow">else</span> {
00795                     mBuf &amp;= ~((INST_TEMPL_MASK &gt;&gt; 1) &lt;&lt; 1); <span class="comment">// set template to MLI</span>
00796                     mBuf |= 0x4;
00797 
00798                     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00799                           (PCHAR)BundleAddress,
00800                           (PCHAR)&amp;mBuf,
00801                           <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)
00802                           ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00803                         <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00804                         <span class="comment">//DPRINT(("KD: write template to 0x%08x failed\n", KdpBreakpointTable[Index].Address));</span>
00805                         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a4">KD_BREAKPOINT_NEEDS_REPLACE</a>;
00806                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00807                     } <span class="keywordflow">else</span> {
00808                         <span class="comment">//DPRINT(("KD: Breakpoint at 0x%08x cleared.\n",</span>
00809                          <span class="comment">//   KdpBreakpointTable[Index].Address));</span>
00810                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00811                     }
00812                 }
00813             }
00814             <span class="keywordflow">else</span> {   <span class="comment">// not MOVL</span>
00815                 <span class="comment">//DPRINT(("KD: Breakpoint at 0x%08x cleared.\n",</span>
00816                  <span class="comment">//  KdpBreakpointTable[Index].Address));</span>
00817                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00818             }
00819         }
00820     }
00821 <span class="preprocessor">#else</span>
00822 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>( (PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address,
00823                         (PCHAR)&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Content,
00824                         <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>) ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00825 
00826         <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00827         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a4">KD_BREAKPOINT_NEEDS_REPLACE</a>;
00828         <span class="comment">//DPRINT(("KD: Breakpoint at 0x%08x; unable to clear, flag set.\n",</span>
00829             <span class="comment">//KdpBreakpointTable[Index].Address));</span>
00830         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00831     } <span class="keywordflow">else</span> {
00832         <span class="comment">//DPRINT(("KD: Breakpoint at 0x%08x cleared.\n",</span>
00833             <span class="comment">//KdpBreakpointTable[Index].Address));</span>
00834         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00835     }
00836 <span class="preprocessor">#endif</span>
00837 <span class="preprocessor"></span>
00838 }
00839 
00840 
00841 
00842 BOOLEAN
<a name="l00843"></a><a class="code" href="../../d1/d4/4_2kdbreak_8c.html#a5">00843</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a105">KdpDeleteBreakpoint</a> (
00844     IN ULONG Handle
00845     )
00846 
00847 <span class="comment">/*++</span>
00848 <span class="comment"></span>
00849 <span class="comment">Routine Description:</span>
00850 <span class="comment"></span>
00851 <span class="comment">    This routine deletes an entry from the breakpoint table.</span>
00852 <span class="comment"></span>
00853 <span class="comment">Arguments:</span>
00854 <span class="comment"></span>
00855 <span class="comment">    Handle - Supplies the index plus one of the breakpoint table entry</span>
00856 <span class="comment">        which is to be deleted.</span>
00857 <span class="comment"></span>
00858 <span class="comment">Return Value:</span>
00859 <span class="comment"></span>
00860 <span class="comment">    A value of FALSE is returned if the specified handle is not a valid</span>
00861 <span class="comment">    value or the breakpoint cannot be deleted because the old instruction</span>
00862 <span class="comment">    cannot be replaced. Otherwise, a value of TRUE is returned.</span>
00863 <span class="comment"></span>
00864 <span class="comment">--*/</span>
00865 
00866 {
00867     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - 1;
00868 
00869     <span class="comment">//</span>
00870     <span class="comment">// If the specified handle is not valid, then return FALSE.</span>
00871     <span class="comment">//</span>
00872 
00873     <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> == 0) || (<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> &gt; BREAKPOINT_TABLE_SIZE)) {
00874         <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: Breakpoint %d invalid.\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>));
00875         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00876     }
00877 
00878     <span class="comment">//</span>
00879     <span class="comment">// If the specified breakpoint table entry is not valid, then return FALSE.</span>
00880     <span class="comment">//</span>
00881 
00882     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> == 0) {
00883         <span class="comment">//DPRINT(("KD: Breakpoint %d already clear.\n", Index));</span>
00884         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00885     }
00886 
00887     <span class="comment">//</span>
00888     <span class="comment">// If the breakpoint is already suspended, just delete it from the table.</span>
00889     <span class="comment">//</span>
00890 
00891     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a3">KD_BREAKPOINT_SUSPENDED</a>) {
00892         <span class="comment">//DPRINT(("KD: Deleting suspended breakpoint %d \n", Index));</span>
00893         <span class="keywordflow">if</span> ( !(<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a4">KD_BREAKPOINT_NEEDS_REPLACE</a>) ) {
00894             <span class="comment">//DPRINT(("KD: already clear.\n"));</span>
00895             <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> = 0;
00896             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00897         }
00898     }
00899 
00900     <span class="comment">//</span>
00901     <span class="comment">// Replace the instruction contents.</span>
00902     <span class="comment">//</span>
00903 
00904     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d4/4_2kdbreak_8c.html#a4">KdpLowWriteContent</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>)) {
00905 
00906         <span class="comment">//</span>
00907         <span class="comment">// Delete breakpoint table entry</span>
00908         <span class="comment">//</span>
00909 
00910         <span class="comment">//DPRINT(("KD: Breakpoint %d deleted successfully.\n", Index));</span>
00911         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> = 0;
00912     }
00913 
00914     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00915 }
00916 
00917 
00918 BOOLEAN
<a name="l00919"></a><a class="code" href="../../d1/d4/4_2kdbreak_8c.html#a6">00919</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a106">KdpDeleteBreakpointRange</a> (
00920     IN PVOID Lower,
00921     IN PVOID Upper
00922     )
00923 
00924 <span class="comment">/*++</span>
00925 <span class="comment"></span>
00926 <span class="comment">Routine Description:</span>
00927 <span class="comment"></span>
00928 <span class="comment">    This routine deletes all breakpoints falling in a given range</span>
00929 <span class="comment">    from the breakpoint table.</span>
00930 <span class="comment"></span>
00931 <span class="comment">Arguments:</span>
00932 <span class="comment"></span>
00933 <span class="comment">    Lower - inclusive lower address of range from which to remove BPs.</span>
00934 <span class="comment"></span>
00935 <span class="comment">    Upper - include upper address of range from which to remove BPs.</span>
00936 <span class="comment"></span>
00937 <span class="comment">Return Value:</span>
00938 <span class="comment"></span>
00939 <span class="comment">    TRUE if any breakpoints removed, FALSE otherwise.</span>
00940 <span class="comment"></span>
00941 <span class="comment">--*/</span>
00942 
00943 {
00944     ULONG   <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00945     BOOLEAN ReturnStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00946 
00947     <span class="comment">//</span>
00948     <span class="comment">// Examine each entry in the table in turn</span>
00949     <span class="comment">//</span>
00950 
00951     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; BREAKPOINT_TABLE_SIZE; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++) {
00952 
00953         <span class="keywordflow">if</span> ( (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a1">KD_BREAKPOINT_IN_USE</a>) &amp;&amp;
00954              ((<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> &gt;= Lower) &amp;&amp;
00955               (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> &lt;= Upper))
00956            ) {
00957 
00958             <span class="comment">//</span>
00959             <span class="comment">// Breakpoint is in use and falls in range, clear it.</span>
00960             <span class="comment">//</span>
00961 
00962             ReturnStatus = ReturnStatus || <a class="code" href="../../d1/d7/4_2kdp_8h.html#a105">KdpDeleteBreakpoint</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>+1);
00963         }
00964     }
00965 
00966     <span class="keywordflow">return</span> ReturnStatus;
00967 
00968 }
00969 
00970 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00971"></a><a class="code" href="../../d1/d4/4_2kdbreak_8c.html#a7">00971</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a138">KdpSuspendBreakpoint</a> (
00972     ULONG Handle
00973     )
00974 {
00975     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - 1;
00976 
00977     <span class="keywordflow">if</span> ( (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a1">KD_BREAKPOINT_IN_USE</a>) &amp;&amp;
00978         !(<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a3">KD_BREAKPOINT_SUSPENDED</a>) ) {
00979 
00980         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a3">KD_BREAKPOINT_SUSPENDED</a>;
00981         <a class="code" href="../../d1/d4/4_2kdbreak_8c.html#a4">KdpLowWriteContent</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>);
00982     }
00983 
00984     <span class="keywordflow">return</span>;
00985 
00986 } <span class="comment">// KdpSuspendBreakpoint</span>
00987 
00988 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00989"></a><a class="code" href="../../d1/d4/4_2kdbreak_8c.html#a8">00989</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a139">KdpSuspendAllBreakpoints</a> (
00990     VOID
00991     )
00992 {
00993     ULONG <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00994 
00995     <a class="code" href="../../d8/d5/kddata_8c.html#a86">BreakpointsSuspended</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00996 
00997     <span class="keywordflow">for</span> ( <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = 1; <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> &lt;= BREAKPOINT_TABLE_SIZE; <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>++ ) {
00998         <a class="code" href="../../d1/d7/4_2kdp_8h.html#a138">KdpSuspendBreakpoint</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
00999     }
01000 
01001     <span class="keywordflow">return</span>;
01002 
01003 } <span class="comment">// KdpSuspendAllBreakpoints</span>
01004 
01005 <span class="preprocessor">#if defined(_IA64_)</span>
01006 <span class="preprocessor"></span>
01007 
01008 BOOLEAN
01009 KdpSuspendBreakpointRange (
01010     IN PVOID Lower,
01011     IN PVOID Upper
01012     )
01013 
01014 <span class="comment">/*++</span>
01015 <span class="comment"></span>
01016 <span class="comment">Routine Description:</span>
01017 <span class="comment"></span>
01018 <span class="comment">    This routine suspend all breakpoints falling in a given range</span>
01019 <span class="comment">    from the breakpoint table.</span>
01020 <span class="comment"></span>
01021 <span class="comment">Arguments:</span>
01022 <span class="comment"></span>
01023 <span class="comment">    Lower - inclusive lower address of range from which to suspend BPs.</span>
01024 <span class="comment"></span>
01025 <span class="comment">    Upper - include upper address of range from which to suspend BPs.</span>
01026 <span class="comment"></span>
01027 <span class="comment">Return Value:</span>
01028 <span class="comment"></span>
01029 <span class="comment">    TRUE if any breakpoints suspended, FALSE otherwise.</span>
01030 <span class="comment"></span>
01031 <span class="comment">Notes:</span>
01032 <span class="comment">    The order of suspending breakpoints is opposite that of setting</span>
01033 <span class="comment">    them in KdpAddBreakpoint() in case of duplicate addresses.</span>
01034 <span class="comment"></span>
01035 <span class="comment">--*/</span>
01036 
01037 {
01038     ULONG   <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01039     BOOLEAN ReturnStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01040 
01041     <span class="comment">//DPRINT(("\nKD: entering KdpSuspendBreakpointRange() at 0x%08x 0x%08x\n", Lower, Upper));</span>
01042 
01043     <span class="comment">//</span>
01044     <span class="comment">// Examine each entry in the table in turn</span>
01045     <span class="comment">//</span>
01046 
01047     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = BREAKPOINT_TABLE_SIZE - 1; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> != -1; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>--) {
01048 
01049         <span class="keywordflow">if</span> ( (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a1">KD_BREAKPOINT_IN_USE</a>) &amp;&amp;
01050              ((<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> &gt;= Lower) &amp;&amp;
01051               (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> &lt;= Upper))
01052            ) {
01053 
01054             <span class="comment">//</span>
01055             <span class="comment">// Breakpoint is in use and falls in range, suspend it.</span>
01056             <span class="comment">//</span>
01057 
01058             <a class="code" href="../../d1/d7/4_2kdp_8h.html#a138">KdpSuspendBreakpoint</a>(Index+1);
01059             ReturnStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01060         }
01061     }
01062     <span class="comment">//DPRINT(("KD: exiting KdpSuspendBreakpointRange() return 0x%d\n", ReturnStatus));</span>
01063 
01064     <span class="keywordflow">return</span> ReturnStatus;
01065 
01066 } <span class="comment">// KdpSuspendBreakpointRange</span>
01067 
01068 
01069 
01070 BOOLEAN
01071 KdpRestoreBreakpointRange (
01072     IN PVOID Lower,
01073     IN PVOID Upper
01074     )
01075 
01076 <span class="comment">/*++</span>
01077 <span class="comment"></span>
01078 <span class="comment">Routine Description:</span>
01079 <span class="comment"></span>
01080 <span class="comment">    This routine writes back breakpoints falling in a given range</span>
01081 <span class="comment">    from the breakpoint table.</span>
01082 <span class="comment"></span>
01083 <span class="comment">Arguments:</span>
01084 <span class="comment"></span>
01085 <span class="comment">    Lower - inclusive lower address of range from which to rewrite BPs.</span>
01086 <span class="comment"></span>
01087 <span class="comment">    Upper - include upper address of range from which to rewrite BPs.</span>
01088 <span class="comment"></span>
01089 <span class="comment">Return Value:</span>
01090 <span class="comment"></span>
01091 <span class="comment">    TRUE if any breakpoints written, FALSE otherwise.</span>
01092 <span class="comment"></span>
01093 <span class="comment">Notes:</span>
01094 <span class="comment">    The order of writing breakpoints is opposite that of removing</span>
01095 <span class="comment">    them in KdpSuspendBreakpointRange() in case of duplicate addresses.</span>
01096 <span class="comment"></span>
01097 <span class="comment">--*/</span>
01098 
01099 {
01100     ULONG   <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01101     BOOLEAN ReturnStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01102 
01103     <span class="comment">//DPRINT(("\nKD: entering KdpRestoreBreakpointRange() at 0x%08x 0x%08x\n", Lower, Upper));</span>
01104 
01105     <span class="comment">//</span>
01106     <span class="comment">// Examine each entry in the table in turn</span>
01107     <span class="comment">//</span>
01108 
01109     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; BREAKPOINT_TABLE_SIZE; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++) {
01110 
01111         <span class="keywordflow">if</span> ( (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a1">KD_BREAKPOINT_IN_USE</a>) &amp;&amp;
01112              ((<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> &gt;= Lower) &amp;&amp;
01113               (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> &lt;= Upper))
01114            ) {
01115 
01116             <span class="comment">//</span>
01117             <span class="comment">// suspended breakpoint that falls in range, unsuspend it.</span>
01118             <span class="comment">//</span>
01119 
01120             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a3">KD_BREAKPOINT_SUSPENDED</a>) {
01121 
01122                 <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp;= ~<a class="code" href="../../d0/d7/kdp_8h.html#a3">KD_BREAKPOINT_SUSPENDED</a>;
01123                 ReturnStatus = ReturnStatus || <a class="code" href="../../d1/d4/4_2kdbreak_8c.html#a9">KdpLowRestoreBreakpoint</a>(Index);
01124             }
01125         }
01126     }
01127 
01128     <span class="comment">//DPRINT(("KD: exiting KdpRestoreBreakpointRange() return 0x%d\n", ReturnStatus));</span>
01129 
01130     <span class="keywordflow">return</span> ReturnStatus;
01131 
01132 } <span class="comment">// KdpRestoreBreakpointRange</span>
01133 
01134 <span class="preprocessor">#endif // _IA64_</span>
01135 <span class="preprocessor"></span>
01136 
01137 BOOLEAN
<a name="l01138"></a><a class="code" href="../../d1/d4/4_2kdbreak_8c.html#a9">01138</a> <a class="code" href="../../d1/d4/4_2kdbreak_8c.html#a9">KdpLowRestoreBreakpoint</a> (
01139     IN ULONG Index
01140     )
01141 
01142 <span class="comment">/*++</span>
01143 <span class="comment"></span>
01144 <span class="comment">Routine Description:</span>
01145 <span class="comment"></span>
01146 <span class="comment">    This routine attempts to write a breakpoint instruction.</span>
01147 <span class="comment">    The old contents must have already been stored in the</span>
01148 <span class="comment">    breakpoint record.</span>
01149 <span class="comment"></span>
01150 <span class="comment">Arguments:</span>
01151 <span class="comment"></span>
01152 <span class="comment">    Index - Supplies the index of the breakpoint table entry</span>
01153 <span class="comment">        which is to be written.</span>
01154 <span class="comment"></span>
01155 <span class="comment">Return Value:</span>
01156 <span class="comment"></span>
01157 <span class="comment">    Returns TRUE if the breakpoint was written, FALSE if it was</span>
01158 <span class="comment">    not and has been marked for writing later.</span>
01159 <span class="comment"></span>
01160 <span class="comment">--*/</span>
01161 
01162 {
01163     <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a> Content;
01164 
01165 <span class="preprocessor">#if defined(_IA64_)</span>
01166 <span class="preprocessor"></span>    <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a> mBuf;
01167     PVOID BundleAddress;
01168 <span class="preprocessor">#endif</span>
01169 <span class="preprocessor"></span>    <span class="comment">//</span>
01170     <span class="comment">// Does the breakpoint need to be written at all?</span>
01171     <span class="comment">//</span>
01172 
01173     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a4">KD_BREAKPOINT_NEEDS_REPLACE</a>) {
01174 
01175         <span class="comment">//</span>
01176         <span class="comment">// The breakpoint was never removed.  Clear the flag</span>
01177         <span class="comment">// and we are done.</span>
01178         <span class="comment">//</span>
01179 
01180         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp;= ~<a class="code" href="../../d0/d7/kdp_8h.html#a4">KD_BREAKPOINT_NEEDS_REPLACE</a>;
01181         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01182     }
01183 
01184     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o3">Content</a> == <a class="code" href="../../d8/d5/kddata_8c.html#a91">KdpBreakpointInstruction</a>) {
01185 
01186         <span class="comment">//</span>
01187         <span class="comment">// The instruction is a breakpoint anyway.</span>
01188         <span class="comment">//</span>
01189 
01190         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01191     }
01192 
01193     <span class="comment">//</span>
01194     <span class="comment">// Replace the instruction contents.</span>
01195     <span class="comment">//</span>
01196 
01197 <span class="preprocessor">#if !defined(_IA64_)</span>
01198 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o3">Content</a> == <a class="code" href="../../d8/d5/kddata_8c.html#a91">KdpBreakpointInstruction</a>) {
01199 
01200         <span class="comment">//</span>
01201         <span class="comment">// The instruction is a breakpoint anyway.</span>
01202         <span class="comment">//</span>
01203 
01204         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01205     }
01206 <span class="preprocessor">#endif</span>
01207 <span class="preprocessor"></span>
01208     <span class="comment">//</span>
01209     <span class="comment">// Replace the instruction contents.</span>
01210     <span class="comment">//</span>
01211 
01212 <span class="preprocessor">#if defined(_IA64_)</span>
01213 <span class="preprocessor"></span>
01214     <span class="comment">// read in intruction in case the adjacent instruction has been modified.</span>
01215 
01216     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
01217             (PCHAR)&amp;mBuf,
01218             (PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address,
01219             <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)
01220             ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
01221         <span class="comment">//DPRINT(("KD: read 0x%p template failed\n", KdpBreakpointTable[Index].Address));</span>
01222         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a2">KD_BREAKPOINT_NEEDS_WRITE</a>;
01223         <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01224         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01225     }
01226 
01227     <span class="keywordflow">switch</span> ((ULONG_PTR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> &amp; 0xf) {
01228         <span class="keywordflow">case</span> 0:
01229             mBuf = (mBuf &amp; ~(INST_SLOT0_MASK)) | (<a class="code" href="../../d8/d5/kddata_8c.html#a91">KdpBreakpointInstruction</a> &lt;&lt; 5);
01230             <span class="keywordflow">break</span>;
01231 
01232         <span class="keywordflow">case</span> 4:
01233             mBuf = (mBuf &amp; ~(INST_SLOT1_MASK)) | (<a class="code" href="../../d8/d5/kddata_8c.html#a91">KdpBreakpointInstruction</a> &lt;&lt; 14);
01234             <span class="keywordflow">break</span>;
01235 
01236         <span class="keywordflow">case</span> 8:
01237             mBuf = (mBuf &amp; ~(INST_SLOT2_MASK)) | (<a class="code" href="../../d8/d5/kddata_8c.html#a91">KdpBreakpointInstruction</a> &lt;&lt; 23);
01238             <span class="keywordflow">break</span>;
01239 
01240         <span class="keywordflow">default</span>:
01241             <span class="comment">//DPRINT(("KD: KdpAddBreakpoint bad instruction slot#\n"));</span>
01242             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01243     }
01244     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
01245             (PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address,
01246             (PCHAR)&amp;mBuf,
01247             <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)
01248             ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
01249 
01250         <span class="comment">//DPRINT(("KD: KdpMoveMemory failed writing BP!\n"));</span>
01251         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a2">KD_BREAKPOINT_NEEDS_WRITE</a>;
01252         <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01253         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01254     }
01255     <span class="keywordflow">else</span> {
01256 
01257         <span class="comment">// check for two-slot MOVL instruction. Reject request if attempt to</span>
01258         <span class="comment">// set break in slot 2 of MLI template.</span>
01259         <span class="comment">// change template to type 0 if current instruction is MLI</span>
01260 
01261         <span class="keywordflow">if</span> (((ULONG_PTR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> &amp; 0xf) != 0) {
01262             (ULONG_PTR)BundleAddress = (ULONG_PTR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> &amp; ~(0xf);
01263             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
01264                     (PCHAR)&amp;mBuf,
01265                     (PCHAR)BundleAddress,
01266                     <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)
01267                     ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
01268                 <span class="comment">//DPRINT(("KD: read template failed at 0x%08x\n", BundleAddress));</span>
01269                 <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a2">KD_BREAKPOINT_NEEDS_WRITE</a>;
01270                 <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01271                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01272             }
01273             <span class="keywordflow">else</span> {
01274                 <span class="keywordflow">if</span> (((mBuf &amp; INST_TEMPL_MASK) &gt;&gt; 1) == 0x2) {
01275                     <span class="keywordflow">if</span> (((ULONG_PTR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> &amp; 0xf) == 4) {
01276                         <span class="comment">// if template= type 2 MLI, change to type 0</span>
01277                         mBuf &amp;= ~((INST_TEMPL_MASK &gt;&gt; 1) &lt;&lt; 1);
01278                         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a8">KD_BREAKPOINT_IA64_MOVL</a>;
01279                         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
01280                                 (PCHAR)BundleAddress,
01281                                 (PCHAR)&amp;mBuf,
01282                                 <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)
01283                                 ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
01284                             <span class="comment">//DPRINT(("KD: write to 0x%08x template failed\n", BundleAddress));</span>
01285                             <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a2">KD_BREAKPOINT_NEEDS_WRITE</a>;
01286                             <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01287                             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01288                         }
01289                         <span class="keywordflow">else</span> {
01290                              <span class="comment">//DPRINT(("KD: change MLI template to type 0 at 0x%08x set\n", Address));</span>
01291                         }
01292                     } <span class="keywordflow">else</span> {
01293                          <span class="comment">// set breakpoint at slot 2 of MOVL is illegal</span>
01294                          <span class="comment">//DPRINT(("KD: illegal to set BP at slot 2 of MOVL at 0x%08x\n", BundleAddress));</span>
01295                          <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a2">KD_BREAKPOINT_NEEDS_WRITE</a>;
01296                          <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01297                          <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01298                     }
01299                 }
01300             }
01301         }
01302         <span class="comment">//DPRINT(("KD: breakpoint at 0x%08x set\n", Address));</span>
01303         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01304     }
01305 
01306 <span class="preprocessor">#else</span>
01307 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>( (PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address,
01308                        (PCHAR)&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a91">KdpBreakpointInstruction</a>,
01309                        <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>) ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
01310 
01311         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a2">KD_BREAKPOINT_NEEDS_WRITE</a>;
01312         <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01313         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01314 
01315     } <span class="keywordflow">else</span> {
01316 
01317         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp;= ~<a class="code" href="../../d0/d7/kdp_8h.html#a2">KD_BREAKPOINT_NEEDS_WRITE</a>;
01318         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01319     }
01320 <span class="preprocessor">#endif</span>
01321 <span class="preprocessor"></span>
01322 }
01323 
01324 
01325 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01326"></a><a class="code" href="../../d1/d4/4_2kdbreak_8c.html#a10">01326</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a140">KdpRestoreAllBreakpoints</a> (
01327     VOID
01328     )
01329 {
01330     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01331 
01332     <a class="code" href="../../d8/d5/kddata_8c.html#a86">BreakpointsSuspended</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01333 
01334     <span class="keywordflow">for</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; BREAKPOINT_TABLE_SIZE; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++ ) {
01335 
01336         <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a1">KD_BREAKPOINT_IN_USE</a>) &amp;&amp;
01337             (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a3">KD_BREAKPOINT_SUSPENDED</a>) ) {
01338 
01339             <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp;= ~<a class="code" href="../../d0/d7/kdp_8h.html#a3">KD_BREAKPOINT_SUSPENDED</a>;
01340             <a class="code" href="../../d1/d4/4_2kdbreak_8c.html#a9">KdpLowRestoreBreakpoint</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>);
01341         }
01342     }
01343 
01344     <span class="keywordflow">return</span>;
01345 
01346 } <span class="comment">// KdpRestoreAllBreakpoints</span>
01347 
01348 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01349"></a><a class="code" href="../../d1/d4/4_2kdbreak_8c.html#a11">01349</a> <a class="code" href="../../d1/d4/4_2kdbreak_8c.html#a11">KdDeleteAllBreakpoints</a>(
01350     VOID
01351     )
01352 {
01353     ULONG <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
01354 
01355     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/kd_8h.html#a13">KdDebuggerEnabled</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> || <a class="code" href="../../d7/d3/kd_8h.html#a7">KdPitchDebugger</a> != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01356         <span class="keywordflow">return</span>;
01357     }
01358 
01359     <a class="code" href="../../d8/d5/kddata_8c.html#a86">BreakpointsSuspended</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01360 
01361     <span class="keywordflow">for</span> ( <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = 1; <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> &lt;= BREAKPOINT_TABLE_SIZE; <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>++ ) {
01362         <a class="code" href="../../d1/d7/4_2kdp_8h.html#a105">KdpDeleteBreakpoint</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
01363     }
01364 
01365     <span class="keywordflow">return</span>;
01366 } <span class="comment">// KdDeleteAllBreakpoints</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:34 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
