<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: tooltips.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>tooltips.c</h1><a href="../../d1/d4/tooltips_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: tooltips.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Implements system tooltips.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 25-Aug-1996 vadimg    created</span>
00010 <span class="comment">\***************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span>
<a name="l00015"></a><a class="code" href="../../d1/d4/tooltips_8c.html#a0">00015</a> <span class="preprocessor">#define TT_XOFFSET          2</span>
<a name="l00016"></a><a class="code" href="../../d1/d4/tooltips_8c.html#a1">00016</a> <span class="preprocessor"></span><span class="preprocessor">#define TT_YOFFSET          1</span>
<a name="l00017"></a><a class="code" href="../../d1/d4/tooltips_8c.html#a2">00017</a> <span class="preprocessor"></span><span class="preprocessor">#define TTT_SHOW            1</span>
<a name="l00018"></a><a class="code" href="../../d1/d4/tooltips_8c.html#a3">00018</a> <span class="preprocessor"></span><span class="preprocessor">#define TTT_HIDE            2</span>
<a name="l00019"></a><a class="code" href="../../d1/d4/tooltips_8c.html#a4">00019</a> <span class="preprocessor"></span><span class="preprocessor">#define TTT_ANIMATE         3</span>
<a name="l00020"></a><a class="code" href="../../d1/d4/tooltips_8c.html#a5">00020</a> <span class="preprocessor"></span><span class="preprocessor">#define TT_ANIMATEDELAY     20</span>
00021 <span class="preprocessor"></span>
<a name="l00022"></a><a class="code" href="../../d1/d4/tooltips_8c.html#a6">00022</a> <span class="preprocessor">#define TTF_POSITIVE        0x00000001</span>
00023 <span class="preprocessor"></span>
<a name="l00024"></a><a class="code" href="../../d1/d4/tooltips_8c.html#a7">00024</a> <span class="preprocessor">#define bitsizeof(x) (sizeof(x) * 8)</span>
00025 <span class="preprocessor"></span>
00026 <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d1/d4/tooltips_8c.html#a8">MNItemHitTest</a>(<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a>, <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>, POINT);
00027 HANDLE <a class="code" href="../../d1/d4/tooltips_8c.html#a9">NtGdiGetDCObject</a>(HDC, <span class="keywordtype">int</span>);
00028 LONG <a class="code" href="../../d1/d4/tooltips_8c.html#a10">GreGetBitmapBits</a>(HBITMAP, ULONG, PBYTE, PLONG);
00029 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d1/d4/tooltips_8c.html#a11">CalcCaptionButton</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, <span class="keywordtype">int</span> hit, LPWORD pcmd, LPRECT prcBtn, LPWORD pbm);
00030 <span class="keywordtype">int</span> <a class="code" href="../../d1/d4/tooltips_8c.html#a12">HitTestScrollBar</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, <span class="keywordtype">int</span> ht, POINT pt);
00031 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d1/d4/tooltips_8c.html#a13">xxxHotTrackSB</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, <span class="keywordtype">int</span> htEx, BOOL fDraw);
00032 
<a name="l00033"></a><a class="code" href="../../d1/d4/tooltips_8c.html#a14">00033</a> __inline <span class="keywordtype">void</span> <a class="code" href="../../d1/d4/tooltips_8c.html#a14">ZeroTooltip</a>(<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html">PTOOLTIPWND</a> pttwnd)
00034 {
00035     RtlZeroMemory((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pttwnd + (<span class="keyword">sizeof</span>(<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html">TOOLTIPWND</a>) - <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d8/structtagTOOLTIP.html">TOOLTIP</a>)),
00036             <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/userk_8h.html#a955">TOOLTIP</a>));
00037 }
00038 
00039 <span class="comment">/***************************************************************************\</span>
00040 <span class="comment">* GetTooltipDC</span>
00041 <span class="comment">*</span>
00042 <span class="comment">* 2/3/1998   vadimg          created</span>
00043 <span class="comment">\***************************************************************************/</span>
00044 
<a name="l00045"></a><a class="code" href="../../d1/d4/tooltips_8c.html#a15">00045</a> HDC <a class="code" href="../../d1/d4/tooltips_8c.html#a15">GetTooltipDC</a>(<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html">PTOOLTIPWND</a> pttwnd)
00046 {
00047     HDC hdc = <a class="code" href="../../d4/d1/userk_8h.html#a1695">_GetDCEx</a>((<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)pttwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, DCX_WINDOW | DCX_CACHE |
00048             DCX_USESTYLE);
00049 
00050     <span class="keywordflow">if</span> (hdc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00051         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00052 
00053     GreSelectFont(hdc, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a147">ghStatusFont</a>);
00054     <span class="keywordflow">return</span> hdc;
00055 }
00056 
00057 <span class="comment">/***************************************************************************\</span>
00058 <span class="comment">* InitTooltipAnimation</span>
00059 <span class="comment">*</span>
00060 <span class="comment">* Creates memory bitmap and DC for use by system tooltips. Gets the screen</span>
00061 <span class="comment">* DC used throughout.</span>
00062 <span class="comment">*</span>
00063 <span class="comment">* 12-Sep-96 vadimg      created</span>
00064 <span class="comment">\***************************************************************************/</span>
00065 
<a name="l00066"></a><a class="code" href="../../d1/d4/tooltips_8c.html#a16">00066</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d4/tooltips_8c.html#a16">InitTooltipAnimation</a>(<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html">PTOOLTIPWND</a> pttwnd)
00067 {
00068     HDC hdc = <a class="code" href="../../d1/d4/tooltips_8c.html#a15">GetTooltipDC</a>(pttwnd);
00069 
00070     <span class="keywordflow">if</span> ((pttwnd-&gt;<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html#o3">hdcMem</a> = GreCreateCompatibleDC(hdc)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00071         <span class="keywordflow">return</span>;
00072     }
00073     <a class="code" href="../../d4/d1/userk_8h.html#a1697">_ReleaseDC</a>(hdc);
00074     GreSetDCOwner(pttwnd-&gt;<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html#o3">hdcMem</a>, OBJECT_OWNER_PUBLIC);
00075 }
00076 
00077 <span class="comment">/***************************************************************************\</span>
00078 <span class="comment">* DestroyTooltipBitmap</span>
00079 <span class="comment">*</span>
00080 <span class="comment">\***************************************************************************/</span>
00081 
<a name="l00082"></a><a class="code" href="../../d1/d4/tooltips_8c.html#a17">00082</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d4/tooltips_8c.html#a17">DestroyTooltipBitmap</a>(<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html">PTOOLTIPWND</a> pttwnd)
00083 {
00084     <span class="keywordflow">if</span> (pttwnd-&gt;<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html#o4">hbmMem</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00085         <span class="keywordflow">return</span>;
00086 
00087     GreSelectBitmap(pttwnd-&gt;<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html#o3">hdcMem</a>, GreGetStockObject(PRIV_STOCK_BITMAP));
00088     GreDeleteObject(pttwnd-&gt;<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html#o4">hbmMem</a>);
00089     pttwnd-&gt;<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html#o4">hbmMem</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00090 }
00091 
00092 <span class="comment">/***************************************************************************\</span>
00093 <span class="comment">* CreateTooltipBitmap</span>
00094 <span class="comment">*</span>
00095 <span class="comment">\***************************************************************************/</span>
00096 
<a name="l00097"></a><a class="code" href="../../d1/d4/tooltips_8c.html#a18">00097</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d1/d4/tooltips_8c.html#a18">CreateTooltipBitmap</a>(<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html">PTOOLTIPWND</a> pttwnd, UINT cx, UINT cy)
00098 {
00099     HDC hdc;
00100 
00101     <span class="keywordflow">if</span> (pttwnd-&gt;<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html#o3">hdcMem</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00102         RIPMSG0(RIP_WARNING, <span class="stringliteral">"CreateTooltipBitmap: pttwnd-&gt;hdcMem is NULL"</span>);
00103         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00104     }
00105 
00106     <a class="code" href="../../d1/d4/tooltips_8c.html#a17">DestroyTooltipBitmap</a>(pttwnd);
00107 
00108     hdc = <a class="code" href="../../d1/d4/tooltips_8c.html#a15">GetTooltipDC</a>(pttwnd);
00109     pttwnd-&gt;<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html#o4">hbmMem</a> = GreCreateCompatibleBitmap(hdc, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>);
00110     <a class="code" href="../../d4/d1/userk_8h.html#a1697">_ReleaseDC</a>(hdc);
00111 
00112     <span class="keywordflow">if</span> (pttwnd-&gt;<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html#o4">hbmMem</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00113         RIPMSG0(RIP_WARNING, <span class="stringliteral">"CreateTooltipBitmap: hbmMem is NULL"</span>);
00114         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00115     }
00116     GreSelectBitmap(pttwnd-&gt;<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html#o3">hdcMem</a>, pttwnd-&gt;<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html#o4">hbmMem</a>);
00117     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00118 }
00119 
00120 <span class="comment">/***************************************************************************\</span>
00121 <span class="comment">* CleanupTooltipAnimation</span>
00122 <span class="comment">*</span>
00123 <span class="comment">* Deletes memory bitmap and DC for use by system tooltips. Release the</span>
00124 <span class="comment">* screen DC.</span>
00125 <span class="comment">*</span>
00126 <span class="comment">* 12-Sep-96 vadimg      created</span>
00127 <span class="comment">\***************************************************************************/</span>
00128 
<a name="l00129"></a><a class="code" href="../../d1/d4/tooltips_8c.html#a19">00129</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d4/tooltips_8c.html#a19">CleanupTooltipAnimation</a>(<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html">PTOOLTIPWND</a> pttwnd)
00130 {
00131     <a class="code" href="../../d1/d4/tooltips_8c.html#a17">DestroyTooltipBitmap</a>(pttwnd);
00132 
00133     <span class="keywordflow">if</span> (pttwnd-&gt;<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html#o3">hdcMem</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00134         GreSetDCOwner(pttwnd-&gt;<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html#o3">hdcMem</a>, OBJECT_OWNER_CURRENT);
00135         GreDeleteDC(pttwnd-&gt;<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html#o3">hdcMem</a>);
00136     }
00137 }
00138 
00139 <span class="comment">/***************************************************************************\</span>
00140 <span class="comment">* TooltipAnimate</span>
00141 <span class="comment">*</span>
00142 <span class="comment">* Perform one frame of window animation. Just a simplified version of</span>
00143 <span class="comment">* the AnimateWindow API.</span>
00144 <span class="comment">*</span>
00145 <span class="comment">* 12-Sep-96 vadimg      created</span>
00146 <span class="comment">\***************************************************************************/</span>
00147 
<a name="l00148"></a><a class="code" href="../../d1/d4/tooltips_8c.html#a20">00148</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d1/d4/tooltips_8c.html#a20">TooltipAnimate</a>(<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html">PTOOLTIPWND</a> pttwnd)
00149 {
00150     <span class="keywordtype">int</span> y, yMem, yReal, ny, iy, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
00151     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwElapsed;
00152     HDC hdc;
00153     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00154 
00155     <span class="keywordflow">if</span> (pttwnd-&gt;pstr == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00156         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00157 
00158     hdc = <a class="code" href="../../d1/d4/tooltips_8c.html#a15">GetTooltipDC</a>(pttwnd);
00159     cx = pttwnd-&gt;rcWindow.right - pttwnd-&gt;rcWindow.left;
00160     <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> = pttwnd-&gt;rcWindow.bottom - pttwnd-&gt;rcWindow.top;
00161     dwElapsed = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>() - pttwnd-&gt;dwAnimStart;
00162     iy = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a141">MultDiv</a>(<a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>, dwElapsed, <a class="code" href="../../d1/d0/inc_2user_8h.html#a892">CMS_TOOLTIP</a>);
00163 
00164     <span class="keywordflow">if</span> (dwElapsed &gt; <a class="code" href="../../d1/d0/inc_2user_8h.html#a892">CMS_TOOLTIP</a> || iy == <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>) {
00165         GreBitBlt(hdc, 0, 0, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>, pttwnd-&gt;<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html#o3">hdcMem</a>, 0, 0, SRCCOPY | NOMIRRORBITMAP, 0);
00166         fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00167         <span class="keywordflow">goto</span> Cleanup;
00168     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pttwnd-&gt;iyAnim == iy) {
00169         <span class="keywordflow">goto</span> Cleanup;
00170     }
00171 
00172     <span class="keywordflow">if</span> (pttwnd-&gt;dwFlags &amp; <a class="code" href="../../d1/d4/tooltips_8c.html#a6">TTF_POSITIVE</a>) {
00173         y = 0;
00174         ny = 0;
00175     } <span class="keywordflow">else</span> {
00176         y = <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
00177         ny = -1;
00178     }
00179 
00180     yReal = y + ny * iy;
00181     yMem = (pttwnd-&gt;dwFlags &amp; <a class="code" href="../../d1/d4/tooltips_8c.html#a6">TTF_POSITIVE</a>) ? <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> - iy : 0;
00182     pttwnd-&gt;iyAnim = iy;
00183 
00184     GreBitBlt(hdc, 0, yReal, cx, iy, pttwnd-&gt;<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html#o3">hdcMem</a>, 0, yMem, SRCCOPY | NOMIRRORBITMAP, 0);
00185 
00186 Cleanup:
00187     <a class="code" href="../../d4/d1/userk_8h.html#a1697">_ReleaseDC</a>(hdc);
00188     <span class="keywordflow">return</span> fRet;
00189 }
00190 
00191 <span class="comment">/***************************************************************************\</span>
00192 <span class="comment">* GetCursorHeight</span>
00193 <span class="comment">*</span>
00194 <span class="comment">* This is tricky. We need to get the actual cursor size from the hotspot</span>
00195 <span class="comment">* down to the end. There is no API in windows to do this, CYCURSOR is</span>
00196 <span class="comment">* just the metric for the size of the bitmap, the cursor starts at the top</span>
00197 <span class="comment">* of the bitmap and may be smaller than the bitmap itself.</span>
00198 <span class="comment">*</span>
00199 <span class="comment">* 12-Sep-96 vadimg      ported from common controls</span>
00200 <span class="comment">\***************************************************************************/</span>
00201 
<a name="l00202"></a><a class="code" href="../../d1/d4/tooltips_8c.html#a21">00202</a> <span class="keywordtype">int</span> <a class="code" href="../../d1/d4/tooltips_8c.html#a21">GetCursorHeight</a>(<span class="keywordtype">void</span>)
00203 {
00204     <span class="keywordtype">int</span> iAnd, iXor, dy = 16;
00205     WORD wMask[128];
00206     ICONINFO ii;
00207     BITMAP bm;
00208     <a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcur;
00209     <span class="keywordtype">long</span> lOffset = 0;
00210 
00211     <span class="keywordflow">if</span> ((pcur = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;pq-&gt;spcurCurrent) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00212         <span class="keywordflow">return</span> dy;
00213     }
00214 
00215     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1112">_InternalGetIconInfo</a>(pcur, &amp;ii, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00216         <span class="keywordflow">return</span> dy;
00217     }
00218 
00219     <span class="keywordflow">if</span> (!GreExtGetObjectW(ii.hbmMask, <span class="keyword">sizeof</span>(bm), (LPSTR)&amp;bm)) {
00220         <span class="keywordflow">goto</span> Bail;
00221     }
00222 
00223     <span class="comment">/*</span>
00224 <span class="comment">     * Use the AND mask to get the cursor height if the XOR mask is there.</span>
00225 <span class="comment">     */</span>
00226     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d4/tooltips_8c.html#a10">GreGetBitmapBits</a>(ii.hbmMask, <span class="keyword">sizeof</span>(wMask), (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>*)wMask, &amp;lOffset)) {
00227         <span class="keywordflow">goto</span> Bail;
00228     }
00229 
00230     iAnd = (<span class="keywordtype">int</span>)(bm.bmWidth * bm.bmHeight / <a class="code" href="../../d1/d4/tooltips_8c.html#a7">bitsizeof</a>(WORD));
00231 
00232     <span class="keywordflow">if</span> (ii.hbmColor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00233         <span class="comment">/*</span>
00234 <span class="comment">         * if no color (XOR) bitmap, then the hbmMask is a double height bitmap</span>
00235 <span class="comment">         * with the cursor and the mask stacked.</span>
00236 <span class="comment">         */</span>
00237 
00238         iXor = iAnd - 1;
00239         iAnd /= 2;
00240     } <span class="keywordflow">else</span> {
00241         iXor = 0;
00242     }
00243 
00244     <span class="keywordflow">if</span> (iAnd &gt;= <span class="keyword">sizeof</span>(wMask)) {
00245         iAnd = <span class="keyword">sizeof</span>(wMask) - 1;
00246     }
00247 
00248     <span class="keywordflow">if</span> (iXor &gt;= <span class="keyword">sizeof</span>(wMask)) {
00249         iXor = 0;
00250     }
00251 
00252     <span class="keywordflow">for</span> (iAnd--; iAnd &gt;= 0; iAnd--) {
00253         <span class="keywordflow">if</span> ((iXor != 0 &amp;&amp; wMask[iXor--] != 0) || wMask[iAnd] != 0xFFFF) {
00254             <span class="keywordflow">break</span>;
00255         }
00256     }
00257 
00258     <span class="comment">/*</span>
00259 <span class="comment">     * Compute the distance between the pointer's lowest point and hotspot.</span>
00260 <span class="comment">     */</span>
00261     dy = (iAnd + 1) * <a class="code" href="../../d1/d4/tooltips_8c.html#a7">bitsizeof</a>(WORD) / (<span class="keywordtype">int</span>)bm.bmWidth - (<span class="keywordtype">int</span>)ii.yHotspot;
00262 
00263 Bail:
00264     <span class="keywordflow">if</span> (ii.hbmColor) {
00265         GreDeleteObject(ii.hbmColor);
00266     }
00267 
00268     <span class="keywordflow">if</span> (ii.hbmMask) {
00269         GreDeleteObject(ii.hbmMask);
00270     }
00271 
00272     <span class="keywordflow">return</span> dy;
00273 }
00274 
00275 <span class="comment">/***************************************************************************\</span>
00276 <span class="comment">* TooltipGetPosition</span>
00277 <span class="comment">*</span>
00278 <span class="comment">* Get the tooltip position on the screen taking into account the size of</span>
00279 <span class="comment">* the tooltip and the screen. The TTF_POSITIVE flag determines if positive</span>
00280 <span class="comment">* or negative animation is used.</span>
00281 <span class="comment">*</span>
00282 <span class="comment">* 12-Sep-96 vadimg      created</span>
00283 <span class="comment">\***************************************************************************/</span>
00284 
<a name="l00285"></a><a class="code" href="../../d1/d4/tooltips_8c.html#a22">00285</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d4/tooltips_8c.html#a22">TooltipGetPosition</a>(<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html">PTOOLTIPWND</a> pttwnd, SIZE *psize, POINT *ppt)
00286 {
00287     <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>    pMonitor;
00288 
00289     *ppt = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor;
00290     pMonitor = <a class="code" href="../../d9/d1/mmrtl_8c.html#a6">_MonitorFromPoint</a>(*ppt, MONITOR_DEFAULTTONULL);
00291     UserAssert(pMonitor);
00292 
00293     <span class="keywordflow">if</span> (ppt-&gt;y + psize-&gt;cy &gt;= pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.bottom) {
00294         ppt-&gt;y = ppt-&gt;y - psize-&gt;cy;
00295         pttwnd-&gt;dwFlags &amp;= ~<a class="code" href="../../d1/d4/tooltips_8c.html#a6">TTF_POSITIVE</a>;
00296     } <span class="keywordflow">else</span> {
00297         ppt-&gt;y += <a class="code" href="../../d1/d4/tooltips_8c.html#a21">GetCursorHeight</a>();
00298         pttwnd-&gt;dwFlags |= <a class="code" href="../../d1/d4/tooltips_8c.html#a6">TTF_POSITIVE</a>;
00299     }
00300 
00301     <span class="keywordflow">if</span> (ppt-&gt;x + psize-&gt;cx &gt;= pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.right) {
00302         ppt-&gt;x = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.right - psize-&gt;cx;
00303     }
00304 
00305     <span class="keywordflow">if</span> (ppt-&gt;x &lt; pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.left) {
00306         ppt-&gt;x = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.left;
00307     }
00308 }
00309 
00310 <span class="comment">/***************************************************************************\</span>
00311 <span class="comment">* TooltipGetSize</span>
00312 <span class="comment">*</span>
00313 <span class="comment">* Estimate the size of the tooltip window based on the size of the text.</span>
00314 <span class="comment">*</span>
00315 <span class="comment">* 12-Sep-96 vadimg      created</span>
00316 <span class="comment">\***************************************************************************/</span>
00317 
<a name="l00318"></a><a class="code" href="../../d1/d4/tooltips_8c.html#a23">00318</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d4/tooltips_8c.html#a23">TooltipGetSize</a>(<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html">PTOOLTIPWND</a> pttwnd, SIZE *psize)
00319 {
00320     HDC hdc = <a class="code" href="../../d1/d4/tooltips_8c.html#a15">GetTooltipDC</a>(pttwnd);
00321     GreGetTextExtentW(hdc, pttwnd-&gt;pstr, wcslen(pttwnd-&gt;pstr),
00322             psize, GGTE_WIN3_EXTENT);
00323     <a class="code" href="../../d4/d1/userk_8h.html#a1697">_ReleaseDC</a>(hdc);
00324     psize-&gt;cx += <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXEDGE) + 2 * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXBORDER) * <a class="code" href="../../d1/d4/tooltips_8c.html#a0">TT_XOFFSET</a>;
00325     psize-&gt;cy += <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYEDGE) + 2 * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYBORDER) * <a class="code" href="../../d1/d4/tooltips_8c.html#a1">TT_YOFFSET</a>;
00326 }
00327 
00328 <span class="comment">/***************************************************************************\</span>
00329 <span class="comment">* TooltipRender</span>
00330 <span class="comment">*</span>
00331 <span class="comment">* Render the tooltip window into the provided DC.</span>
00332 <span class="comment">*</span>
00333 <span class="comment">* 12-Sep-96 vadimg      created</span>
00334 <span class="comment">\***************************************************************************/</span>
00335 
<a name="l00336"></a><a class="code" href="../../d1/d4/tooltips_8c.html#a24">00336</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d4/tooltips_8c.html#a24">TooltipRender</a>(<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html">PTOOLTIPWND</a> pttwnd, HDC hdc)
00337 {
00338     COLORREF crBk;
00339     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uFlags;
00340     RECT rc;
00341 
00342     <span class="keywordflow">if</span> (pttwnd-&gt;pstr == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00343         <span class="keywordflow">return</span>;
00344 
00345     GreSelectFont(hdc, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a147">ghStatusFont</a>);
00346     GreSetTextColor(hdc, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;argbSystem[COLOR_INFOTEXT]);
00347     crBk = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;argbSystem[COLOR_INFOBK];
00348 
00349     <a class="code" href="../../d3/d6/rect_8c.html#a3">CopyOffsetRect</a>(&amp;rc, &amp;pttwnd-&gt;rcClient, -pttwnd-&gt;rcClient.left,
00350            -pttwnd-&gt;rcClient.top);
00351 
00352     <span class="comment">/*</span>
00353 <span class="comment">     * We don't want dithered colors, so FillRect with the nearest color.</span>
00354 <span class="comment">     */</span>
00355     <span class="keywordflow">if</span> (crBk == GreGetNearestColor(hdc, crBk)) {
00356         GreSetBkColor(hdc, crBk);
00357         uFlags = ETO_OPAQUE;
00358     } <span class="keywordflow">else</span> {
00359         <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a3">FillRect</a>(hdc, &amp;rc, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a22">SYSHBR</a>(INFOBK));
00360         GreSetBkMode(hdc, TRANSPARENT);
00361         uFlags = ETO_CLIPPED;
00362     }
00363 
00364     GreExtTextOutW(hdc, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXBORDER) * <a class="code" href="../../d1/d4/tooltips_8c.html#a0">TT_XOFFSET</a>,
00365             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYBORDER) * <a class="code" href="../../d1/d4/tooltips_8c.html#a1">TT_YOFFSET</a>, uFlags, &amp;rc, pttwnd-&gt;pstr,
00366             wcslen(pttwnd-&gt;pstr), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00367 }
00368 
00369 <span class="comment">/***************************************************************************\</span>
00370 <span class="comment">* FindNcHitEx</span>
00371 <span class="comment">*</span>
00372 <span class="comment">* 12-Sep-96 vadimg      created</span>
00373 <span class="comment">\***************************************************************************/</span>
00374 
<a name="l00375"></a><a class="code" href="../../d4/d1/userk_8h.html#a1970">00375</a> <span class="keywordtype">int</span> <a class="code" href="../../d4/d1/userk_8h.html#a1970">FindNCHitEx</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, <span class="keywordtype">int</span> ht, POINT pt)
00376 {
00377     <span class="comment">/*</span>
00378 <span class="comment">     * Bug 263057 joejo</span>
00379 <span class="comment">     * It seems that pwnd-&gt;spmenu can be released and set to null,</span>
00380 <span class="comment">     * without the WFMPRESENT flag being cleared. Make sure that</span>
00381 <span class="comment">     * we have a good pwnd-&gt;spmenu before continuing.</span>
00382 <span class="comment">     */</span>
00383     <span class="keywordflow">if</span> (ht == HTMENU &amp;&amp; pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a> &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a550">WFMPRESENT</a>)) {
00384         <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> spmenu = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>;
00385         <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pitem;
00386         <span class="keywordtype">int</span> nItem;
00387 
00388         nItem = <a class="code" href="../../d1/d4/tooltips_8c.html#a8">MNItemHitTest</a>(spmenu, pwnd, pt);
00389         <span class="keywordflow">if</span> (nItem &gt;= 0) {
00390             pitem = (<a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a>)&amp;spmenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>[nItem];
00391             <span class="keywordflow">switch</span> ((ULONG_PTR)pitem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o16">hbmp</a>) {
00392             <span class="keywordflow">case</span> (ULONG_PTR)HBMMENU_SYSTEM:
00393                 ht = <a class="code" href="../../d4/d1/userk_8h.html#a675">HTMDISYSMENU</a>;
00394                 <span class="keywordflow">break</span>;
00395             <span class="keywordflow">case</span> (ULONG_PTR)HBMMENU_MBAR_RESTORE:
00396                 ht = <a class="code" href="../../d4/d1/userk_8h.html#a676">HTMDIMAXBUTTON</a>;
00397                 <span class="keywordflow">break</span>;
00398             <span class="keywordflow">case</span> (ULONG_PTR)HBMMENU_MBAR_MINIMIZE:
00399             <span class="keywordflow">case</span> (ULONG_PTR)HBMMENU_MBAR_MINIMIZE_D:
00400                 ht = <a class="code" href="../../d4/d1/userk_8h.html#a677">HTMDIMINBUTTON</a>;
00401                 <span class="keywordflow">break</span>;
00402             <span class="keywordflow">case</span> (ULONG_PTR)HBMMENU_MBAR_CLOSE:
00403             <span class="keywordflow">case</span> (ULONG_PTR)HBMMENU_MBAR_CLOSE_D:
00404                 ht = <a class="code" href="../../d4/d1/userk_8h.html#a678">HTMDICLOSE</a>;
00405                 <span class="keywordflow">break</span>;
00406             <span class="keywordflow">case</span> (ULONG_PTR)HBMMENU_CALLBACK:
00407                 ht = HTERROR;
00408                 <span class="keywordflow">break</span>;
00409             <span class="keywordflow">default</span>:
00410                 ht = <a class="code" href="../../d4/d1/userk_8h.html#a679">HTMENUITEM</a>;
00411                 <span class="keywordflow">break</span>;
00412             }
00413         }
00414         <span class="keywordflow">return</span> MAKELONG(ht, nItem);
00415     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ht == HTVSCROLL &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a551">WFVPRESENT</a>)) {
00416         <span class="keywordflow">return</span> MAKELONG(<a class="code" href="../../d1/d4/tooltips_8c.html#a12">HitTestScrollBar</a>(pwnd, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, pt), 1);
00417     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ht == HTHSCROLL &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a552">WFHPRESENT</a>)) {
00418         <span class="keywordflow">return</span> MAKELONG(<a class="code" href="../../d1/d4/tooltips_8c.html#a12">HitTestScrollBar</a>(pwnd, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, pt), 0);
00419     }
00420 
00421     <span class="keywordflow">return</span> ht;
00422 }
00423 
00424 <span class="comment">/***************************************************************************\</span>
00425 <span class="comment">* KillTooltipTimer</span>
00426 <span class="comment">*</span>
00427 <span class="comment">* Kill the timer and zero out the timer id.</span>
00428 <span class="comment">\***************************************************************************/</span>
<a name="l00429"></a><a class="code" href="../../d1/d4/tooltips_8c.html#a26">00429</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d4/tooltips_8c.html#a26">KillTooltipTimer</a> (<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html">PTOOLTIPWND</a> pttwnd)
00430 {
00431     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uTID = pttwnd-&gt;uTID;
00432     <span class="keywordflow">if</span> (uTID != 0) {
00433         pttwnd-&gt;uTID = 0;
00434         <a class="code" href="../../d4/d1/userk_8h.html#a1720">_KillTimer</a>((<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)pttwnd, uTID);
00435     }
00436 }
00437 <span class="comment">/***************************************************************************\</span>
00438 <span class="comment">* SetTooltipTimer</span>
00439 <span class="comment">*</span>
00440 <span class="comment">\***************************************************************************/</span>
<a name="l00441"></a><a class="code" href="../../d1/d4/tooltips_8c.html#a27">00441</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d4/tooltips_8c.html#a27">SetTooltipTimer</a> (<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html">PTOOLTIPWND</a> pttwnd, UINT uTID, UINT uDelay)
00442 {
00443     <a class="code" href="../../d1/d4/tooltips_8c.html#a26">KillTooltipTimer</a>(pttwnd);
00444     pttwnd-&gt;uTID = uTID;
00445     <a class="code" href="../../d4/d1/userk_8h.html#a1044">InternalSetTimer</a>((<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)pttwnd, uTID, uDelay, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
00446 }
00447 <span class="comment">/***************************************************************************\</span>
00448 <span class="comment">* xxxResetTooltip</span>
00449 <span class="comment">*</span>
00450 <span class="comment">* Hide the tooltip, kill the timer, and zero out most of the struct members.</span>
00451 <span class="comment">\***************************************************************************/</span>
00452 
<a name="l00453"></a><a class="code" href="../../d4/d1/userk_8h.html#a1973">00453</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1973">xxxResetTooltip</a>(<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html">PTOOLTIPWND</a> pttwnd)
00454 {
00455     <a class="code" href="../../d1/d4/tooltips_8c.html#a26">KillTooltipTimer</a>(pttwnd);
00456 
00457     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pttwnd);
00458 
00459     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pttwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)) {
00460         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> spwndMessage;
00461         <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
00462 
00463         <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>((<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)pttwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, 0, 0, 0, SWP_NOSIZE |
00464                 SWP_NOMOVE | SWP_HIDEWINDOW | SWP_NOACTIVATE | SWP_NOZORDER);
00465 
00466         spwndMessage = <a class="code" href="../../d4/d1/userk_8h.html#a323">PWNDMESSAGE</a>(pttwnd);
00467         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(spwndMessage, &amp;tlpwnd);
00468         <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a6">xxxSetParent</a>((<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)pttwnd, spwndMessage);
00469         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
00470     }
00471 
00472     <a class="code" href="../../d1/d4/tooltips_8c.html#a14">ZeroTooltip</a>(pttwnd);
00473     pttwnd-&gt;head.rpdesk-&gt;dwDTFlags &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a291">DF_TOOLTIP</a>;
00474 }
00475 
00476 <span class="comment">/***************************************************************************\</span>
00477 <span class="comment">* xxxShowTooltip</span>
00478 <span class="comment">*</span>
00479 <span class="comment">* Show the tooltip window.</span>
00480 <span class="comment">*</span>
00481 <span class="comment">* 12-Sep-96 vadimg      created</span>
00482 <span class="comment">\***************************************************************************/</span>
00483 
<a name="l00484"></a><a class="code" href="../../d1/d4/tooltips_8c.html#a29">00484</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d4/tooltips_8c.html#a29">xxxShowTooltip</a>(<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html">PTOOLTIPWND</a> pttwnd)
00485 {
00486     SIZE size;
00487     POINT pt;
00488     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>;
00489 
00490     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pttwnd);
00491 
00492     <span class="keywordflow">if</span> (pttwnd-&gt;pstr == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00493         <span class="keywordflow">return</span>;
00494 
00495     <span class="keywordflow">if</span> (pttwnd-&gt;pstr == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a319">gszCAPTIONTOOLTIP</a>) {
00496 
00497         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;rpdesk-&gt;spwndTrack;
00498         <span class="comment">/*</span>
00499 <span class="comment">         * The window text might have changed in callbacks, retrieve it now</span>
00500 <span class="comment">         */</span>
00501         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d1/d0/inc_2user_8h.html#a598">WEFTRUNCATEDCAPTION</a>) &amp;&amp; pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o17">strName</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o0">Length</a>) {
00502             <a class="code" href="../../d1/d5/w32_2ntuser_2rtl_2random_8c.html#a3">wcsncpycch</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a319">gszCAPTIONTOOLTIP</a>, pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o17">strName</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o3">Buffer</a>, <a class="code" href="../../d4/d1/userk_8h.html#a299">CAPTIONTOOLTIPLEN</a>-1);
00503             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a319">gszCAPTIONTOOLTIP</a>[<a class="code" href="../../d4/d1/userk_8h.html#a299">CAPTIONTOOLTIPLEN</a>-1] = 0;
00504         } <span class="keywordflow">else</span> {
00505             <span class="keywordflow">return</span>;
00506         }
00507     }
00508 
00509     <a class="code" href="../../d1/d4/tooltips_8c.html#a23">TooltipGetSize</a>(pttwnd, &amp;size);
00510     <a class="code" href="../../d1/d4/tooltips_8c.html#a22">TooltipGetPosition</a>(pttwnd, &amp;size, &amp;pt);
00511 
00512     <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> = SWP_CREATESPB | SWP_SHOWWINDOW | SWP_NOACTIVATE;
00513     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a567">TestEffectUP</a>(TOOLTIPANIMATION)) {
00514         <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> |= SWP_NOREDRAW;
00515     }
00516     <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>((<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)pttwnd, <a class="code" href="../../d4/d1/userk_8h.html#a452">PWND_TOP</a>, pt.x, pt.y, size.cx, size.cy,
00517             <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
00518 }
00519 
00520 <span class="comment">/***************************************************************************\</span>
00521 <span class="comment">* xxxTooltipHandleTimer</span>
00522 <span class="comment">*</span>
00523 <span class="comment">* 12-Sep-96 vadimg      created</span>
00524 <span class="comment">\***************************************************************************/</span>
00525 
<a name="l00526"></a><a class="code" href="../../d1/d4/tooltips_8c.html#a30">00526</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d4/tooltips_8c.html#a30">xxxTooltipHandleTimer</a>(<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html">PTOOLTIPWND</a> pttwnd, UINT uTID)
00527 {
00528 
00529     <span class="keywordflow">switch</span>(uTID) {
00530         <span class="keywordflow">case</span> <a class="code" href="../../d1/d4/tooltips_8c.html#a2">TTT_SHOW</a>: {
00531             <span class="comment">/*</span>
00532 <span class="comment">             * Move the tooltip window to the desktop so it can</span>
00533 <span class="comment">             *  be shown. Then show it.</span>
00534 <span class="comment">             */</span>
00535             <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndDesktop = <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pttwnd);
00536             <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
00537             <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwndDesktop, &amp;tlpwnd);
00538             <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a6">xxxSetParent</a>((<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)pttwnd, pwndDesktop);
00539             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
00540 
00541             <a class="code" href="../../d1/d4/tooltips_8c.html#a29">xxxShowTooltip</a>(pttwnd);
00542             <span class="keywordflow">break</span>;
00543         }
00544 
00545         <span class="keywordflow">case</span> <a class="code" href="../../d1/d4/tooltips_8c.html#a4">TTT_ANIMATE</a>:
00546            <span class="comment">/*</span>
00547 <span class="comment">            * If animation is completed, set timer to hide</span>
00548 <span class="comment">            */</span>
00549            <span class="keywordflow">if</span> (<a class="code" href="../../d1/d4/tooltips_8c.html#a20">TooltipAnimate</a>(pttwnd)) {
00550                <a class="code" href="../../d1/d4/tooltips_8c.html#a27">SetTooltipTimer</a>(pttwnd, <a class="code" href="../../d1/d4/tooltips_8c.html#a3">TTT_HIDE</a>, pttwnd-&gt;<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html#o2">dwHideDelay</a>);
00551            }
00552            <span class="keywordflow">break</span>;
00553 
00554         <span class="keywordflow">case</span> <a class="code" href="../../d1/d4/tooltips_8c.html#a3">TTT_HIDE</a>:
00555            <span class="comment">/*</span>
00556 <span class="comment">            * Hide it</span>
00557 <span class="comment">            */</span>
00558            <a class="code" href="../../d4/d1/userk_8h.html#a1973">xxxResetTooltip</a>(pttwnd);
00559            <span class="keywordflow">break</span>;
00560     }
00561 }
00562 <span class="comment">/***************************************************************************\</span>
00563 <span class="comment">* xxxTooltipWndProc</span>
00564 <span class="comment">*</span>
00565 <span class="comment">* The actual WndProc for the tooltip window.</span>
00566 <span class="comment">*</span>
00567 <span class="comment">* 12-Sep-96 vadimg      created</span>
00568 <span class="comment">\***************************************************************************/</span>
00569 
<a name="l00570"></a><a class="code" href="../../d4/d1/userk_8h.html#a1481">00570</a> LRESULT <a class="code" href="../../d4/d1/userk_8h.html#a1481">xxxTooltipWndProc</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, UINT uMsg, WPARAM wParam, LPARAM lParam)
00571 {
00572     PAINTSTRUCT ps;
00573     <a class="code" href="../../d8/d8/structtagTOOLTIPWND.html">PTOOLTIPWND</a> pttwnd;
00574 
00575     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00576     <a class="code" href="../../d6/d0/usercli_8h.html#a28">VALIDATECLASSANDSIZE</a>(pwnd, uMsg, wParam, lParam, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a222">FNID_TOOLTIP</a>, WM_NCCREATE);
00577     pttwnd = (<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html">PTOOLTIPWND</a>)pwnd;
00578 
00579     <span class="keywordflow">switch</span>(uMsg) {
00580     <span class="keywordflow">case</span> WM_TIMER:
00581         <a class="code" href="../../d1/d4/tooltips_8c.html#a30">xxxTooltipHandleTimer</a>(pttwnd, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)wParam);
00582         <span class="keywordflow">break</span>;
00583 
00584     <span class="keywordflow">case</span> WM_PAINT:
00585         <a class="code" href="../../d4/d1/userk_8h.html#a1710">xxxBeginPaint</a>(pwnd, &amp;ps);
00586         <a class="code" href="../../d1/d4/tooltips_8c.html#a24">TooltipRender</a>(pttwnd, ps.hdc);
00587         <a class="code" href="../../d4/d1/userk_8h.html#a1711">xxxEndPaint</a>(pwnd, &amp;ps);
00588         <span class="keywordflow">break</span>;
00589 
00590     <span class="keywordflow">case</span> WM_PRINTCLIENT:
00591         <a class="code" href="../../d1/d4/tooltips_8c.html#a24">TooltipRender</a>(pttwnd, (HDC)wParam);
00592         <span class="keywordflow">break</span>;
00593 
00594     <span class="keywordflow">case</span> WM_ERASEBKGND:
00595         <span class="keywordflow">break</span>;
00596 
00597     <span class="keywordflow">case</span> WM_NCCREATE:
00598         <a class="code" href="../../d4/d1/userk_8h.html#a2018">InitTooltipDelay</a>(pttwnd);
00599         <a class="code" href="../../d1/d4/tooltips_8c.html#a16">InitTooltipAnimation</a>(pttwnd);
00600         <span class="keywordflow">goto</span> CallDWP;
00601 
00602     <span class="keywordflow">case</span> WM_NCDESTROY:
00603         <a class="code" href="../../d1/d4/tooltips_8c.html#a19">CleanupTooltipAnimation</a>(pttwnd);
00604         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a456">GETPDESK</a>(pttwnd)-&gt;dwDTFlags &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a291">DF_TOOLTIP</a>;
00605         <span class="keywordflow">goto</span> CallDWP;
00606 
00607     <span class="keywordflow">case</span> WM_WINDOWPOSCHANGED:
00608         <span class="keywordflow">if</span> (((LPWINDOWPOS)lParam)-&gt;flags &amp; SWP_SHOWWINDOW) {
00609             HDC hdc;
00610             <span class="keywordtype">int</span> cx;
00611             <span class="keywordtype">int</span> <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
00612 
00613             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a567">TestEffectUP</a>(TOOLTIPANIMATION)) {
00614                 <a class="code" href="../../d1/d4/tooltips_8c.html#a27">SetTooltipTimer</a>(pttwnd, <a class="code" href="../../d1/d4/tooltips_8c.html#a3">TTT_HIDE</a>, pttwnd-&gt;<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html#o2">dwHideDelay</a>);
00615                 <span class="keywordflow">goto</span> CallDWP;
00616             }
00617 
00618             hdc = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00619             cx = pttwnd-&gt;rcWindow.right - pttwnd-&gt;rcWindow.left;
00620             <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> = pttwnd-&gt;rcWindow.bottom - pttwnd-&gt;rcWindow.top;
00621 
00622             <span class="comment">/*</span>
00623 <span class="comment">             * At this point we're sure that the window is showing and the size</span>
00624 <span class="comment">             * has been changed and we're in the context of the desktop thread.</span>
00625 <span class="comment">             */</span>
00626             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a666">TestALPHA</a>(TOOLTIPFADE)) {
00627                 hdc = <a class="code" href="../../d4/d1/userk_8h.html#a1977">CreateFade</a>((<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)pttwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d1/d0/inc_2user_8h.html#a892">CMS_TOOLTIP</a>,
00628                         <a class="code" href="../../d4/d1/userk_8h.html#a684">FADE_SHOW</a> | <a class="code" href="../../d4/d1/userk_8h.html#a689">FADE_TOOLTIP</a>);
00629             } <span class="keywordflow">else</span> {
00630                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d4/tooltips_8c.html#a18">CreateTooltipBitmap</a>(pttwnd, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>)) {
00631                     hdc = pttwnd-&gt;<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html#o3">hdcMem</a>;
00632                 }
00633             }
00634 
00635             <span class="keywordflow">if</span> (hdc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00636                 <a class="code" href="../../d1/d4/tooltips_8c.html#a27">SetTooltipTimer</a>(pttwnd, <a class="code" href="../../d1/d4/tooltips_8c.html#a3">TTT_HIDE</a>, 0);
00637                 <span class="keywordflow">goto</span> CallDWP;
00638             }
00639 
00640             <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>((<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)pttwnd, WM_PRINT, (WPARAM)hdc,
00641                     PRF_CLIENT | PRF_NONCLIENT | PRF_CHILDREN | PRF_ERASEBKGND);
00642 
00643             <span class="comment">/*</span>
00644 <span class="comment">             * Start animation timer</span>
00645 <span class="comment">             */</span>
00646 
00647             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1982">TestFadeFlags</a>(<a class="code" href="../../d4/d1/userk_8h.html#a689">FADE_TOOLTIP</a>)) {
00648                 <a class="code" href="../../d8/d4/sprite_8c.html#a21">StartFade</a>();
00649                 <a class="code" href="../../d1/d4/tooltips_8c.html#a27">SetTooltipTimer</a>(pttwnd, <a class="code" href="../../d1/d4/tooltips_8c.html#a3">TTT_HIDE</a>, pttwnd-&gt;dwHideDelay);
00650             } <span class="keywordflow">else</span> {
00651                 pttwnd-&gt;dwAnimStart = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>();
00652                 <a class="code" href="../../d1/d4/tooltips_8c.html#a27">SetTooltipTimer</a>(pttwnd, <a class="code" href="../../d1/d4/tooltips_8c.html#a4">TTT_ANIMATE</a>, <a class="code" href="../../d1/d4/tooltips_8c.html#a5">TT_ANIMATEDELAY</a>);
00653             }
00654         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (((LPWINDOWPOS)lParam)-&gt;flags &amp; SWP_HIDEWINDOW) {
00655             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1982">TestFadeFlags</a>(<a class="code" href="../../d4/d1/userk_8h.html#a689">FADE_TOOLTIP</a>)) {
00656                 <a class="code" href="../../d8/d4/sprite_8c.html#a22">StopFade</a>();
00657             } <span class="keywordflow">else</span> {
00658                 <a class="code" href="../../d1/d4/tooltips_8c.html#a17">DestroyTooltipBitmap</a>(pttwnd);
00659             }
00660         }
00661         <span class="keywordflow">goto</span> CallDWP;
00662 
00663     <span class="keywordflow">default</span>:
00664 CallDWP:
00665         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1632">xxxDefWindowProc</a>(pwnd, uMsg, wParam, lParam);
00666     }
00667 
00668     <span class="keywordflow">return</span> 0;
00669 }
00670 
00671 <span class="comment">/***************************************************************************\</span>
00672 <span class="comment">* IsTrackedHittest</span>
00673 <span class="comment">*</span>
00674 <span class="comment">* Should we be tracking this hittest code? Return the track string if yes.</span>
00675 <span class="comment">* If on caption returning the window strName.Buffer could</span>
00676 <span class="comment">* make the system bugcheck if there is a SetWindowText in the callback.</span>
00677 <span class="comment">\***************************************************************************/</span>
<a name="l00678"></a><a class="code" href="../../d1/d4/tooltips_8c.html#a32">00678</a> LPWSTR <a class="code" href="../../d1/d4/tooltips_8c.html#a32">IsTooltipHittest</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, UINT ht)
00679 {
00680     <span class="keywordflow">switch</span> (ht) {
00681     <span class="keywordflow">case</span> HTMINBUTTON:
00682         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a636">WFMINBOX</a>)) {
00683             <span class="keywordflow">return</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>)) ? <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a316">gszRESUP</a> : <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a314">gszMIN</a>;
00684         }
00685         <span class="keywordflow">break</span>;
00686 
00687     <span class="keywordflow">case</span> HTMAXBUTTON:
00688         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a634">WFMAXBOX</a>)) {
00689             <span class="keywordflow">return</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a648">WFMAXIMIZED</a>)) ? <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a317">gszRESDOWN</a> : <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a315">gszMAX</a>;
00690         }
00691         <span class="keywordflow">break</span>;
00692 
00693     <span class="keywordflow">case</span> HTCLOSE:
00694     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a678">HTMDICLOSE</a>:
00695         <span class="keywordflow">return</span> <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a318">gszSCLOSE</a>;
00696 
00697 <span class="comment">/*  Commented out due to TandyT ...</span>
00698 <span class="comment">    case HTSYSMENU:</span>
00699 <span class="comment">    case HTMDISYSMENU:</span>
00700 <span class="comment">        return gszSMENU;</span>
00701 <span class="comment">*/</span>
00702     <span class="keywordflow">case</span> HTHELP:
00703         <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a406">GETGPSIMBPSTR</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a889">SEB_HELP</a>);
00704 
00705     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a677">HTMDIMINBUTTON</a>:
00706         <span class="keywordflow">return</span> <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a314">gszMIN</a>;
00707 
00708     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a676">HTMDIMAXBUTTON</a>:
00709         <span class="keywordflow">return</span> <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a317">gszRESDOWN</a>;
00710 
00711     <span class="keywordflow">case</span> HTCAPTION:
00712         <span class="comment">/*</span>
00713 <span class="comment">         * We only show the caption tooltip if the window text</span>
00714 <span class="comment">         * doesn't fit entirely on the caption.  We will fill</span>
00715 <span class="comment">         * gszCAPTIONTOOLTIP right before showing the text</span>
00716 <span class="comment">         */</span>
00717         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d1/d0/inc_2user_8h.html#a598">WEFTRUNCATEDCAPTION</a>)) {
00718             <span class="keywordflow">return</span> <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a319">gszCAPTIONTOOLTIP</a>;
00719         }
00720         <span class="keywordflow">break</span>;
00721 
00722     <span class="keywordflow">default</span>:
00723         <span class="keywordflow">break</span>;
00724     }
00725     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00726 }
00727 
00728 <span class="comment">/***************************************************************************\</span>
00729 <span class="comment">* xxxHotTrackMenu</span>
00730 <span class="comment">*</span>
00731 <span class="comment">* Hot-track a menu item in the menu bar.</span>
00732 <span class="comment">\***************************************************************************/</span>
<a name="l00733"></a><a class="code" href="../../d1/d4/tooltips_8c.html#a33">00733</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d1/d4/tooltips_8c.html#a33">xxxHotTrackMenu</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, UINT nItem, BOOL fDraw)
00734 {
00735     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenu = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>;
00736     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pItem;
00737     HDC   hdc;
00738     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>  oldAlign;
00739     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpmenu;
00740 
00741     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00742 
00743     <span class="comment">/*</span>
00744 <span class="comment">     * The window may have lied about the hit-test code on</span>
00745 <span class="comment">     * WM_NCHITTEST. Make sure it does indeed have a menu.</span>
00746 <span class="comment">     */</span>
00747     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a550">WFMPRESENT</a>) || pmenu == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00748         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00749 
00750     <span class="keywordflow">if</span> (nItem &gt;= pmenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>) {
00751         RIPMSG0(RIP_WARNING, <span class="stringliteral">"xxxHotTrackMenu: menu too large"</span>);
00752         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00753     }
00754 
00755     pItem = &amp;pmenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>[nItem];
00756 
00757     <span class="comment">/*</span>
00758 <span class="comment">     * Make sure we draw on the right spot</span>
00759 <span class="comment">     */</span>
00760     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pmenu, &amp;tlpmenu);
00761     <a class="code" href="../../d4/d1/userk_8h.html#a1382">xxxMNRecomputeBarIfNeeded</a>(pwnd, pmenu);
00762     ValidateThreadLocks(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;ptl, (ULONG_PTR)&amp;tlpmenu, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00763 
00764     <span class="keywordflow">if</span> (fDraw) {
00765         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a788">TestMFS</a>(pItem, MF_GRAYED)) {
00766             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpmenu);
00767             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00768         }
00769         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a787">SetMFS</a>(pItem, MFS_HOTTRACK);
00770     } <span class="keywordflow">else</span> {
00771         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a789">ClearMFS</a>(pItem, MFS_HOTTRACK);
00772     }
00773 
00774     hdc = <a class="code" href="../../d4/d1/userk_8h.html#a1695">_GetDCEx</a>(pwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, DCX_WINDOW | DCX_USESTYLE | DCX_CACHE);
00775     GreSelectBrush(hdc, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a22">SYSHBR</a>(MENUTEXT));
00776     GreSelectFont(hdc, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a137">ghMenuFont</a>);
00777 
00778     oldAlign = <a class="code" href="../../d4/d1/userk_8h.html#a1136">GreGetTextAlign</a>(hdc);
00779     <span class="keywordflow">if</span> (pmenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a> &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a791">TestMFT</a>(pmenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>, MFT_RIGHTORDER))
00780         <a class="code" href="../../d4/d1/userk_8h.html#a1135">GreSetTextAlign</a>(hdc, oldAlign | TA_RTLREADING);
00781 
00782     <span class="comment">/*</span>
00783 <span class="comment">     * When the item is not owner draw, xxxDrawMenuItem does not</span>
00784 <span class="comment">     * call back and does not leave the critical section.</span>
00785 <span class="comment">     */</span>
00786     <a class="code" href="../../d4/d1/userk_8h.html#a1315">xxxDrawMenuItem</a>(hdc, pmenu, pItem, 0);
00787     <a class="code" href="../../d4/d1/userk_8h.html#a1135">GreSetTextAlign</a>(hdc, oldAlign);
00788     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpmenu);
00789 
00790     <a class="code" href="../../d4/d1/userk_8h.html#a1697">_ReleaseDC</a>(hdc);
00791     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00792 }
00793 
00794 
00795 <span class="comment">/***************************************************************************\</span>
00796 <span class="comment">* HotTrackCaption</span>
00797 <span class="comment">*</span>
00798 <span class="comment">* Hot-track a caption button.</span>
00799 <span class="comment">\***************************************************************************/</span>
00800 
00801 <span class="preprocessor">#ifdef COLOR_HOTTRACKING</span>
00802 <span class="preprocessor"></span>
00803 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> xxxHotTrackCaption(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, <span class="keywordtype">int</span> ht, BOOL fDraw)
00804 {
00805     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwWhere;
00806     <span class="keywordtype">int</span>   x, y;
00807     WORD  bm, cmd;
00808     RECT  rcBtn;
00809     HDC   hdc;
00810 
00811     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00812 
00813     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFCPRESENT))
00814         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00815 
00816     dwWhere = <a class="code" href="../../d1/d5/caption_8c.html#a8">xxxCalcCaptionButton</a>(pwnd, ht, &amp;cmd, &amp;rcBtn, &amp;bm);
00817     x = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a7">GET_X_LPARAM</a>(dwWhere);
00818     y = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a8">GET_Y_LPARAM</a>(dwWhere);
00819 
00820     <span class="keywordflow">if</span> (!cmd)
00821         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00822 
00823     hdc = <a class="code" href="../../d4/d1/userk_8h.html#a1695">_GetDCEx</a>(pwnd, NULL, DCX_WINDOW | DCX_USESTYLE | DCX_CACHE);
00824     <a class="code" href="../../d4/d1/userk_8h.html#a1773">BitBltSysBmp</a>(hdc, x, y, bm + (fDraw ? DOBI_HOT : 0));
00825     <a class="code" href="../../d4/d1/userk_8h.html#a1697">_ReleaseDC</a>(hdc);
00826     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00827 }
00828 
00829 <span class="preprocessor">#endif // COLOR_HOTTRACKING</span>
00830 <span class="preprocessor"></span>
00831 <span class="comment">/***************************************************************************\</span>
00832 <span class="comment">* xxxHotTrack</span>
00833 <span class="comment">*</span>
00834 <span class="comment">\***************************************************************************/</span>
00835 
<a name="l00836"></a><a class="code" href="../../d4/d1/userk_8h.html#a1972">00836</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1972">xxxHotTrack</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, <span class="keywordtype">int</span> htEx, BOOL fDraw)
00837 {
00838     <span class="keywordtype">int</span> ht = LOWORD(htEx);
00839 
00840     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00841 
00842     <span class="keywordflow">switch</span>(ht) {
00843 <span class="preprocessor">#ifdef COLOR_HOTTRACKING</span>
00844 <span class="preprocessor"></span>    <span class="keywordflow">case</span> HTMINBUTTON:
00845     <span class="keywordflow">case</span> HTMAXBUTTON:
00846     <span class="keywordflow">case</span> HTHELP:
00847     <span class="keywordflow">case</span> HTCLOSE:
00848         <span class="keywordflow">return</span> xxxHotTrackCaption(pwnd, ht, fDraw);
00849 
00850     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a668">HTSCROLLUP</a>:
00851     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a669">HTSCROLLDOWN</a>:
00852     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a670">HTSCROLLUPPAGE</a>:
00853     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a671">HTSCROLLDOWNPAGE</a>:
00854     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a672">HTSCROLLTHUMB</a>:
00855         <span class="keywordflow">return</span> <a class="code" href="../../d1/d4/tooltips_8c.html#a13">xxxHotTrackSB</a>(pwnd, htEx, fDraw);
00856 
00857     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a677">HTMDIMINBUTTON</a>:
00858     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a676">HTMDIMAXBUTTON</a>:
00859     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a678">HTMDICLOSE</a>:
00860 <span class="preprocessor">#endif // COLOR_HOTTRACKING</span>
00861 <span class="preprocessor"></span>    <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a679">HTMENUITEM</a>:
00862         <span class="keywordflow">return</span> <a class="code" href="../../d1/d4/tooltips_8c.html#a33">xxxHotTrackMenu</a>(pwnd, HIWORD(htEx), fDraw);
00863 
00864     }
00865 
00866     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00867 }
00868 
00869 <span class="comment">/***************************************************************************\</span>
00870 <span class="comment">* xxxCreateTooltip</span>
00871 <span class="comment">*</span>
00872 <span class="comment">* Call this to show a new tooltip with a new string and delay.</span>
00873 <span class="comment">\***************************************************************************/</span>
00874 
<a name="l00875"></a><a class="code" href="../../d1/d4/tooltips_8c.html#a35">00875</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d4/tooltips_8c.html#a35">xxxCreateTooltip</a>(<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html">PTOOLTIPWND</a> pttwnd, LPWSTR pstr)
00876 {
00877     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pttwnd);
00878 
00879     <span class="comment">/*</span>
00880 <span class="comment">     * Store new text</span>
00881 <span class="comment">     */</span>
00882     pttwnd-&gt;pstr = pstr;
00883     <span class="comment">/*</span>
00884 <span class="comment">     * If already visible, hide it and show it in new place.</span>
00885 <span class="comment">     *  Otherwise, set timer to show.</span>
00886 <span class="comment">     */</span>
00887     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pttwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)) {
00888         <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>((<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)pttwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, 0, 0, 0, SWP_NOSIZE |
00889                 SWP_NOMOVE | SWP_HIDEWINDOW | SWP_NOACTIVATE | SWP_NOZORDER | SWP_NOSENDCHANGING);
00890         <a class="code" href="../../d1/d4/tooltips_8c.html#a29">xxxShowTooltip</a>(pttwnd);
00891     } <span class="keywordflow">else</span> {
00892         <a class="code" href="../../d1/d4/tooltips_8c.html#a27">SetTooltipTimer</a>(pttwnd, <a class="code" href="../../d1/d4/tooltips_8c.html#a2">TTT_SHOW</a>, pttwnd-&gt;<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html#o1">dwShowDelay</a>);
00893     }
00894 }
00895 
00896 <span class="comment">/***************************************************************************\</span>
00897 <span class="comment">* xxxTrackMouseMove</span>
00898 <span class="comment">*</span>
00899 <span class="comment">* This is the entry point for the system tooltips and hot-tracking.</span>
00900 <span class="comment">*</span>
00901 <span class="comment">* 12-Sep-96 vadimg      created</span>
00902 <span class="comment">\***************************************************************************/</span>
00903 
<a name="l00904"></a><a class="code" href="../../d4/d1/userk_8h.html#a1971">00904</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1971">xxxTrackMouseMove</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, <span class="keywordtype">int</span> htEx, UINT message)
00905 {
00906     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fNewpwndTrack;
00907     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwDTCancel = 0;
00908     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
00909     LPWSTR pstr;
00910     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;rpdesk;
00911     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiTrack;
00912 
00913 
00914 <span class="preprocessor">#if DBG</span>
00915 <span class="preprocessor"></span>    <span class="comment">/*</span>
00916 <span class="comment">     * Let's warn if this function gets reenterd so we can make sure</span>
00917 <span class="comment">     * nothing bad will follow. This should be a rare situation.</span>
00918 <span class="comment">     * Look in gptiReEntered to find out who is already here.</span>
00919 <span class="comment">     */</span>
00920     <span class="keyword">static</span> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> gcReEntered = 0;
00921     <span class="keyword">static</span> <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> gptiReEntered;
00922     <span class="keywordflow">if</span>(gcReEntered++ != 0){
00923       RIPMSG2(RIP_WARNING, <span class="stringliteral">"Reentered xxxTrackMouseMove; previous thread was %#p, current thread is %#p"</span>, gptiReEntered, <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
00924     }
00925     gptiReEntered = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00926 
00927     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00928 
00929     <span class="comment">/*</span>
00930 <span class="comment">     * We must be on an interactive window station.</span>
00931 <span class="comment">     */</span>
00932     <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00933             pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>) {
00934         RIPMSG0(RIP_ERROR, <span class="stringliteral">"Can't use tooltips on non-interactive winsta"</span>);
00935     }
00936 
00937      {
00938         <span class="keyword">static</span> POINT pt = {0, 0};
00939 
00940 <span class="preprocessor">#ifdef UNDONE</span>
00941 <span class="preprocessor"></span>        <span class="comment">/*</span>
00942 <span class="comment">         * We might have taken a guess on the hit test (see FindNCHitEx)</span>
00943 <span class="comment">         *  so if we're at the same point and same window, something</span>
00944 <span class="comment">         *  might be fishy</span>
00945 <span class="comment">         */</span>
00946         <span class="keywordflow">if</span> ((pt.x == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor.x)
00947                     &amp;&amp; (pt.y == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor.y)
00948                     &amp;&amp; (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o21">spwndTrack</a> == pwnd)) {
00949             RIPMSG1(RIP_WARNING, <span class="stringliteral">"xxxTrackMouseMove: Same point &amp; window. %#p"</span>, pwnd);
00950         }
00951 <span class="preprocessor">#endif</span>
00952 <span class="preprocessor"></span>
00953         <span class="comment">/*</span>
00954 <span class="comment">         * Something is supposed to have changed or we're wasting time</span>
00955 <span class="comment">         */</span>
00956         UserAssert((pt.x != <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor.x)
00957                     || (pt.y != <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor.y)
00958                     || (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o21">spwndTrack</a> != pwnd)
00959                     || (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o22">htEx</a> != htEx)
00960                     || (message != WM_MOUSEMOVE));
00961         <span class="comment">/*</span>
00962 <span class="comment">         * Remember last tracked point</span>
00963 <span class="comment">         */</span>
00964         pt = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor;
00965      }
00966     <span class="comment">/*</span>
00967 <span class="comment">     * pwnd is supposed to be on the current thread and queue</span>
00968 <span class="comment">     */</span>
00969     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>() == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd));
00970     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;pq == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq);
00971 <span class="preprocessor">#endif</span>
00972 <span class="preprocessor"></span>
00973     <span class="comment">/*</span>
00974 <span class="comment">     * Have we switched windows?</span>
00975 <span class="comment">     */</span>
00976     fNewpwndTrack = (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o21">spwndTrack</a> != pwnd);
00977     <span class="comment">/*</span>
00978 <span class="comment">     * If no tracking is taking place, just go set the new</span>
00979 <span class="comment">     *  tracking state</span>
00980 <span class="comment">     */</span>
00981     <span class="keywordflow">if</span> (!(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a295">DF_MOUSEMOVETRK</a>)) {
00982         <span class="keywordflow">goto</span> SetNewState;
00983     }
00984     <span class="comment">/*</span>
00985 <span class="comment">     * Potentially while we leave the critical section below in</span>
00986 <span class="comment">     * xxxCancelMouseMoveTracking, spwndTrack could be destroyed and unlocked</span>
00987 <span class="comment">     * and then we go and create the tooltip. This would mean that</span>
00988 <span class="comment">     * DF_TOOLTIPACTIVE (part of DF_MOUSEMOVETRK test above) would be set,</span>
00989 <span class="comment">     * but pdesk-&gt;spwndTrack would be NULL and we can AV dereferencing</span>
00990 <span class="comment">     * pdesk-&gt;spwndTrack below. Prevent this by making the check here.</span>
00991 <span class="comment">     */</span>
00992     <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o21">spwndTrack</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00993         <span class="keywordflow">goto</span> SetNewState;
00994     }
00995 
00996     <span class="comment">/*</span>
00997 <span class="comment">     * Nuke hottracking and deactivate tooltip state, if any.</span>
00998 <span class="comment">     * Do it sychronously if we're tracking on the current queue;</span>
00999 <span class="comment">     *  Otherwise, post an event and let it happen later.</span>
01000 <span class="comment">     */</span>
01001     ptiTrack = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o21">spwndTrack</a>);
01002     <span class="keywordflow">if</span>  (<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;pq == ptiTrack-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>) {
01003         dwDTCancel |= <a class="code" href="../../d4/d1/userk_8h.html#a288">DF_HOTTRACKING</a>;
01004     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; (<a class="code" href="../../d4/d1/userk_8h.html#a288">DF_HOTTRACKING</a> | <a class="code" href="../../d4/d1/userk_8h.html#a290">DF_TOOLTIPACTIVE</a>)) {
01005         <a class="code" href="../../d4/d1/userk_8h.html#a1217">PostEventMessage</a>(ptiTrack, ptiTrack-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>,
01006                         <a class="code" href="../../d4/d1/userk_8h.html#a346">QEVENT_CANCELMOUSEMOVETRK</a>,
01007                         pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o21">spwndTrack</a>,
01008                         pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a>,
01009                         pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o22">htEx</a>, <a class="code" href="../../d4/d1/userk_8h.html#a288">DF_HOTTRACKING</a>);
01010        <span class="comment">/*</span>
01011 <span class="comment">        * Paranoid assertion. If we're switching queues, we must</span>
01012 <span class="comment">        *  be switching windows. Did we just go through</span>
01013 <span class="comment">        *  ReattachThreads?</span>
01014 <span class="comment">        */</span>
01015         UserAssert(pwnd != pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o21">spwndTrack</a>);
01016         pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp;= ~(<a class="code" href="../../d4/d1/userk_8h.html#a288">DF_HOTTRACKING</a> | <a class="code" href="../../d4/d1/userk_8h.html#a290">DF_TOOLTIPACTIVE</a>);
01017     }
01018     <span class="comment">/*</span>
01019 <span class="comment">     * If we're on the client area or the user clicked,</span>
01020 <span class="comment">     *  nuke the tooltip (if any).</span>
01021 <span class="comment">     * Since we might want to re-show the tooltip, we don't nuke it</span>
01022 <span class="comment">     *  now if we swichted windows (we'll nuke it later if needed)</span>
01023 <span class="comment">     */</span>
01024     <span class="keywordflow">if</span> ((htEx == HTCLIENT) || (message != WM_MOUSEMOVE)) {
01025         dwDTCancel |= <a class="code" href="../../d4/d1/userk_8h.html#a290">DF_TOOLTIPACTIVE</a>;
01026     }
01027     <span class="comment">/*</span>
01028 <span class="comment">     * If we switched windows or crossed client/nonclinet boundaries,</span>
01029 <span class="comment">     *  end track mouse leave/hover.</span>
01030 <span class="comment">     */</span>
01031     <span class="keywordflow">if</span> (fNewpwndTrack || ((pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o22">htEx</a> == HTCLIENT) ^ (htEx == HTCLIENT))) {
01032         dwDTCancel |= <a class="code" href="../../d4/d1/userk_8h.html#a294">DF_TRACKMOUSEEVENT</a>;
01033     }
01034     <span class="comment">/*</span>
01035 <span class="comment">     * Cancel whatever is active and needs to go away</span>
01036 <span class="comment">     */</span>
01037     <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o21">spwndTrack</a>, &amp;tlpwnd);
01038     <a class="code" href="../../d4/d1/userk_8h.html#a1974">xxxCancelMouseMoveTracking</a>(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a>,
01039                            pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o21">spwndTrack</a>,
01040                            pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o22">htEx</a>,
01041                            dwDTCancel);
01042     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
01043     pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp;= ~dwDTCancel;
01044 
01045 
01046 
01047 SetNewState:
01048     <span class="comment">/*</span>
01049 <span class="comment">     * Hottracking/tooltip on mouse move if on NC hitest and enabled</span>
01050 <span class="comment">     */</span>
01051     <span class="keywordflow">if</span> ((htEx != HTCLIENT) &amp;&amp; (message == WM_MOUSEMOVE) &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a567">TestEffectUP</a>(HOTTRACKING)) {
01052         <span class="comment">/*</span>
01053 <span class="comment">         * Hottrack the new hit test area</span>
01054 <span class="comment">         */</span>
01055         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1972">xxxHotTrack</a>(pwnd, htEx, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
01056             pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a288">DF_HOTTRACKING</a>;
01057         }
01058 
01059         <span class="comment">/*</span>
01060 <span class="comment">         * Remove/set the tool tip.</span>
01061 <span class="comment">         * We always do this synchronously because it doesn't mess</span>
01062 <span class="comment">         *  with pwnd's or spwnTrack's queue</span>
01063 <span class="comment">         */</span>
01064         <span class="keywordflow">if</span> ((pstr = <a class="code" href="../../d1/d4/tooltips_8c.html#a32">IsTooltipHittest</a>(pwnd, LOWORD(htEx))) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01065             <a class="code" href="../../d8/d8/structtagTOOLTIPWND.html">PTOOLTIPWND</a> pttwnd = (<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html">PTOOLTIPWND</a>)pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o14">spwndTooltip</a>;
01066             <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pttwnd, &amp;tlpwnd);
01067             <a class="code" href="../../d1/d4/tooltips_8c.html#a35">xxxCreateTooltip</a>(pttwnd, pstr);
01068             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
01069             pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a291">DF_TOOLTIP</a>;
01070         } <span class="keywordflow">else</span>  {
01071             <a class="code" href="../../d8/d8/structtagTOOLTIPWND.html">PTOOLTIPWND</a> pttwnd = (<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html">PTOOLTIPWND</a>)pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o14">spwndTooltip</a>;
01072             <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pttwnd, &amp;tlpwnd);
01073             <a class="code" href="../../d4/d1/userk_8h.html#a1973">xxxResetTooltip</a>(pttwnd);
01074             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
01075         }
01076     } <span class="comment">/* if (htEx != HTCLIENT) */</span>
01077 
01078 
01079     ValidateThreadLocks(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;ptl, (ULONG_PTR)&amp;pwnd, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01080 
01081     <span class="comment">/*</span>
01082 <span class="comment">     * Update new track window if needed.</span>
01083 <span class="comment">     */</span>
01084     <span class="keywordflow">if</span> (fNewpwndTrack) {
01085         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndActivate;
01086 
01087          <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o21">spwndTrack</a>, pwnd);
01088         <span class="comment">/*</span>
01089 <span class="comment">         * Active window tracking.</span>
01090 <span class="comment">         * If there is non-zero timeout, get the window we're supposed to activate</span>
01091 <span class="comment">         *  and set the timer. Otherwise, set the queue flag so</span>
01092 <span class="comment">         *  xxxActiveWindowTracking can do its thing.</span>
01093 <span class="comment">         */</span>
01094          <span class="keywordflow">if</span> ((message == WM_MOUSEMOVE) &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a563">TestUP</a>(ACTIVEWINDOWTRACKING)) {
01095              <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a743">UP</a>(ACTIVEWNDTRKTIMEOUT) != 0) {
01096                  pwndActivate = <a class="code" href="../../d4/d1/userk_8h.html#a1654">GetActiveTrackPwnd</a>(pwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01097                  <span class="keywordflow">if</span> (pwndActivate != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01098                      <a class="code" href="../../d4/d1/userk_8h.html#a1044">InternalSetTimer</a>(pwndActivate, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a46">IDSYS_WNDTRACKING</a>,
01099                                      <a class="code" href="../../d4/d1/userk_8h.html#a743">UP</a>(ACTIVEWNDTRKTIMEOUT),
01100                                      <a class="code" href="../../d4/d2/timers_8c.html#a22">xxxSystemTimerProc</a>, TMRF_SYSTEM);
01101                  }
01102              } <span class="keywordflow">else</span> {
01103                  <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;pq-&gt;QF_flags |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a870">QF_ACTIVEWNDTRACKING</a>;
01104              } <span class="comment">/* if (TestUP(ACTIVEWNDTRKZORDER)) */</span>
01105          } <span class="comment">/* if (TestUP(ACTIVEWINDOWTRACKING)) */</span>
01106 
01107     }
01108 
01109     <span class="comment">/*</span>
01110 <span class="comment">     * Save new hit test code</span>
01111 <span class="comment">     */</span>
01112     pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o22">htEx</a> = htEx;
01113 
01114 <span class="preprocessor">#if DBG</span>
01115 <span class="preprocessor"></span>    --gcReEntered;
01116 <span class="preprocessor">#endif</span>
01117 <span class="preprocessor"></span>}
01118 
01119 <span class="comment">/***************************************************************************\</span>
01120 <span class="comment">* xxxCancelMouseMoveTracking</span>
01121 <span class="comment">*</span>
01122 <span class="comment">* History</span>
01123 <span class="comment">* 12/07/96 GerardoB  Created</span>
01124 <span class="comment">\***************************************************************************/</span>
<a name="l01125"></a><a class="code" href="../../d4/d1/userk_8h.html#a1974">01125</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1974">xxxCancelMouseMoveTracking</a> (DWORD dwDTFlags, <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndTrack, <span class="keywordtype">int</span> htEx, DWORD dwDTCancel)
01126 {
01127 
01128     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwndTrack);
01129     <span class="comment">/*</span>
01130 <span class="comment">     * Hottracking</span>
01131 <span class="comment">     */</span>
01132     <span class="keywordflow">if</span> ((dwDTFlags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a288">DF_HOTTRACKING</a>) &amp;&amp; (dwDTCancel &amp; <a class="code" href="../../d4/d1/userk_8h.html#a288">DF_HOTTRACKING</a>)) {
01133         <span class="comment">/*</span>
01134 <span class="comment">         * The current state must be owned by the current queue.</span>
01135 <span class="comment">         * Otherwise, we're about to do an inter-queue cancelation.</span>
01136 <span class="comment">         */</span>
01137         UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;pq == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndTrack)-&gt;pq);
01138 
01139         <a class="code" href="../../d4/d1/userk_8h.html#a1972">xxxHotTrack</a>(pwndTrack, htEx, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01140     }
01141 
01142     <span class="comment">/*</span>
01143 <span class="comment">     * Tooltips</span>
01144 <span class="comment">     */</span>
01145     <span class="keywordflow">if</span> ((dwDTFlags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a289">DF_TOOLTIPSHOWING</a>) &amp;&amp; (dwDTCancel &amp; <a class="code" href="../../d4/d1/userk_8h.html#a291">DF_TOOLTIP</a>)) {
01146         <a class="code" href="../../d8/d8/structtagTOOLTIPWND.html">PTOOLTIPWND</a> pttwnd = (<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html">PTOOLTIPWND</a>)<a class="code" href="../../d4/d1/userk_8h.html#a324">PWNDTOOLTIP</a>(pwndTrack);
01147         <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
01148 
01149         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pttwnd, &amp;tlpwnd);
01150         <a class="code" href="../../d4/d1/userk_8h.html#a1973">xxxResetTooltip</a>(pttwnd);
01151         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
01152     }
01153 
01154     <span class="comment">/*</span>
01155 <span class="comment">     * Mouse Leave</span>
01156 <span class="comment">     */</span>
01157     <span class="keywordflow">if</span> ((dwDTFlags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a292">DF_TRACKMOUSELEAVE</a>) &amp;&amp; (dwDTCancel &amp; <a class="code" href="../../d4/d1/userk_8h.html#a292">DF_TRACKMOUSELEAVE</a>)) {
01158         <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pwndTrack,
01159                      ((htEx == HTCLIENT) ? WM_MOUSELEAVE : WM_NCMOUSELEAVE),
01160                      0, 0);
01161     }
01162 
01163     <span class="comment">/*</span>
01164 <span class="comment">     * Mouse Hover</span>
01165 <span class="comment">     */</span>
01166     <span class="keywordflow">if</span> ((dwDTFlags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a293">DF_TRACKMOUSEHOVER</a>) &amp;&amp; (dwDTCancel &amp; <a class="code" href="../../d4/d1/userk_8h.html#a293">DF_TRACKMOUSEHOVER</a>)) {
01167         <a class="code" href="../../d4/d1/userk_8h.html#a1567">_KillSystemTimer</a>(pwndTrack, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a49">IDSYS_MOUSEHOVER</a>);
01168     }
01169 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:02 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
