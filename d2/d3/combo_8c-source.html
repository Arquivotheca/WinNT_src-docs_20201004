<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: combo.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>combo.c</h1><a href="../../d1/d4/combo_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/**************************** Module Header ********************************\</span>
00002 <span class="comment">* Module Name: combo.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* The WndProc for combo boxes and other often used combo routines</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* ??-???-???? ??????    Ported from Win 3.0 sources</span>
00010 <span class="comment">* 01-Feb-1991 mikeke    Added Revalidation code</span>
00011 <span class="comment">\***************************************************************************/</span>
00012 
00013 <span class="preprocessor">#include "<a class="code" href="../../d7/d3/w32_2ntuser_2client_2precomp_8h.html">precomp.h</a>"</span>
00014 <span class="preprocessor">#pragma hdrstop</span>
00015 <span class="preprocessor"></span>
<a name="l00016"></a><a class="code" href="../../d1/d4/combo_8c.html#a0">00016</a> <a class="code" href="../../d2/d4/struct__LOOKASIDE.html">LOOKASIDE</a> <a class="code" href="../../d1/d4/combo_8c.html#a0">ComboboxLookaside</a>;
00017 
00018 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a238">NtUserTrackMouseEvent</a>(TRACKMOUSEEVENT *ptme);
00019 LONG <a class="code" href="../../d1/d4/combo_8c.html#a2">xxxCBGetTextLengthHelper</a>(<a class="code" href="../../d7/d9/structtagCBox.html">PCBOX</a> pcbox, BOOL fAnsi);
00020 LONG <a class="code" href="../../d1/d4/combo_8c.html#a3">xxxCBGetTextHelper</a>(<a class="code" href="../../d7/d9/structtagCBox.html">PCBOX</a> pcbox, <span class="keywordtype">int</span> len, LPWSTR lpstr, BOOL fAnsi);
00021 
00022 <span class="comment">/***************************************************************************\</span>
00023 <span class="comment">*</span>
00024 <span class="comment">*  PressButton()</span>
00025 <span class="comment">*</span>
00026 <span class="comment">*  Pops combobox button back up.</span>
00027 <span class="comment">*</span>
00028 <span class="comment">\***************************************************************************/</span>
<a name="l00029"></a><a class="code" href="../../d1/d4/combo_8c.html#a4">00029</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d4/combo_8c.html#a4">xxxPressButton</a>(<a class="code" href="../../d7/d9/structtagCBox.html">PCBOX</a> pcbox, BOOL fPress)
00030 {
00031     <span class="comment">//</span>
00032     <span class="comment">// Publisher relies on getting a WM_PAINT message after the combo list</span>
00033     <span class="comment">// pops back up.  On a WM_PAINT they change the focus, which causes</span>
00034     <span class="comment">// toolbar combos to send CBN_SELENDCANCEL notifications.  On this</span>
00035     <span class="comment">// notification they apply the font/pt size change you made to the</span>
00036     <span class="comment">// selection.</span>
00037     <span class="comment">//</span>
00038     <span class="comment">// This happened in 3.1 because the dropdown list overlapped the button</span>
00039     <span class="comment">// on the bottom or top by a pixel.  Since we'd end up painting under</span>
00040     <span class="comment">// the list SPB, when it went away USER would reinvalidate the dirty</span>
00041     <span class="comment">// area.  This would cause a paint message.</span>
00042     <span class="comment">//</span>
00043     <span class="comment">// In 4.0, this doesn't happen because the dropdown doesn't overlap.  So</span>
00044     <span class="comment">// we need to make sure Publisher gets a WM_PAINT anyway.  We do this</span>
00045     <span class="comment">// by changing where the dropdown shows up for 3.x apps</span>
00046     <span class="comment">//</span>
00047     <span class="comment">//</span>
00048 
00049     <span class="keywordflow">if</span> ((pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o14">fButtonPressed</a> != 0) != (fPress != 0)) {
00050 
00051         HWND hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>);
00052 
00053         pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o14">fButtonPressed</a> = (fPress != 0);
00054         <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o20">f3DCombo</a>)
00055             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a206">NtUserInvalidateRect</a>(hwnd, &amp;pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o3">buttonrc</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00056         <span class="keywordflow">else</span>
00057         {
00058             RECT    rc;
00059 
00060             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rc, &amp;pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o3">buttonrc</a>);
00061             <a class="code" href="../../d3/d6/rect_8c.html#a7">InflateRect</a>(&amp;rc, 0, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYEDGE));
00062             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a206">NtUserInvalidateRect</a>(hwnd, &amp;rc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00063         }
00064         <a class="code" href="../../d3/d8/client_8c.html#a140">UpdateWindow</a>(hwnd);
00065 
00066         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
00067             <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a12">NotifyWinEvent</a>(EVENT_OBJECT_STATECHANGE, hwnd, OBJID_CLIENT, INDEX_COMBOBOX_BUTTON);
00068         }
00069     }
00070 }
00071 
00072 <span class="comment">/***************************************************************************\</span>
00073 <span class="comment">* HotTrack</span>
00074 <span class="comment">*</span>
00075 <span class="comment">* If we're not already hot-tracking and the mouse is over the combobox,</span>
00076 <span class="comment">* turn on hot-tracking and invalidate the drop-down button.</span>
00077 <span class="comment">*</span>
00078 <span class="comment">\***************************************************************************/</span>
00079 
00080 <span class="preprocessor">#ifdef COLOR_HOTTRACKING</span>
00081 <span class="preprocessor"></span>
00082 <span class="keywordtype">void</span> HotTrack(<a class="code" href="../../d7/d9/structtagCBox.html">PCBOX</a> pcbox)
00083 {
00084     <span class="keywordflow">if</span> (!pcbox-&gt;fButtonHotTracked &amp;&amp; !pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o13">fMouseDown</a>) {
00085         HWND hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>);
00086         TRACKMOUSEEVENT tme = {<span class="keyword">sizeof</span>(TRACKMOUSEEVENT), TME_LEAVE, hwnd, 0};
00087         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a238">NtUserTrackMouseEvent</a>(&amp;tme)) {
00088             pcbox-&gt;fButtonHotTracked = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00089             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a206">NtUserInvalidateRect</a>(hwnd, &amp;pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o3">buttonrc</a>, TRUE);
00090         }
00091     }
00092 }
00093 
00094 <span class="preprocessor">#endif // COLOR_HOTTRACKING</span>
00095 <span class="preprocessor"></span>
00096 <span class="comment">/***************************************************************************\</span>
00097 <span class="comment">* xxxComboBoxDBCharHandler</span>
00098 <span class="comment">*</span>
00099 <span class="comment">* Double Byte character handler for ANSI ComboBox</span>
00100 <span class="comment">*</span>
00101 <span class="comment">* History:</span>
00102 <span class="comment">\***************************************************************************/</span>
00103 
<a name="l00104"></a><a class="code" href="../../d1/d4/combo_8c.html#a5">00104</a> LRESULT <a class="code" href="../../d1/d4/combo_8c.html#a5">ComboBoxDBCharHandler</a>(
00105     <a class="code" href="../../d7/d9/structtagCBox.html">PCBOX</a> pcbox,
00106     HWND hwnd,
00107     UINT message,
00108     WPARAM wParam,
00109     LPARAM lParam)
00110 {
00111     WORD w;
00112     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndSend;
00113 
00114     w = <a class="code" href="../../d6/d0/usercli_8h.html#a460">DbcsCombine</a>(hwnd, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)wParam);
00115     <span class="keywordflow">if</span> (w == 0) {
00116         <span class="keywordflow">return</span> CB_ERR;  <span class="comment">// Failed to assemble DBCS</span>
00117     }
00118 
00119     UserAssert(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>);
00120     <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o21">fNoEdit</a>) {
00121         pwndSend = pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>;
00122     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>) {
00123         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ComboBoxWndProcWorker: WM_CHAR is posted to Combobox itself(%08x)."</span>,
00124                 hwnd);
00125         pwndSend = pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>;
00126     } <span class="keywordflow">else</span> {
00127         <span class="keywordflow">return</span> CB_ERR;
00128     }
00129 
00130     RIPMSG1(RIP_VERBOSE, <span class="stringliteral">"ComboBoxWndProcWorker: sending WM_CHAR %04x"</span>, w);
00131 
00132     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndSend, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a570">WFANSIPROC</a>)) {
00133         <span class="comment">//</span>
00134         <span class="comment">// If receiver is not ANSI WndProc (may be subclassed?),</span>
00135         <span class="comment">// send a UNICODE message.</span>
00136         <span class="comment">//</span>
00137         WCHAR wChar;
00138         LPWSTR lpwstr = &amp;wChar;
00139 
00140         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/chartran_8c.html#a3">MBToWCSEx</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a118">THREAD_CODEPAGE</a>(), (LPCSTR)&amp;w, 2, &amp;lpwstr, 1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) == 0) {
00141             RIPMSG1(RIP_WARNING, <span class="stringliteral">"ComboBoxWndProcWorker: cannot convert 0x%04x to UNICODE."</span>, w);
00142             <span class="keywordflow">return</span> CB_ERR;
00143         }
00144         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pwndSend, message, wChar, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00145     }
00146 
00147     <span class="comment">/*</span>
00148 <span class="comment">     * Post the Trailing byte to the target</span>
00149 <span class="comment">     * so that they can peek the second WM_CHAR</span>
00150 <span class="comment">     * message later.</span>
00151 <span class="comment">     * Note: it's safe since sender is A and receiver is A,</span>
00152 <span class="comment">     * translation layer does not perform any DBCS combining and cracking.</span>
00153 <span class="comment">     */</span>
00154     PostMessageA(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwndSend), message, <a class="code" href="../../d6/d0/usercli_8h.html#a145">CrackCombinedDbcsTB</a>(w), lParam);
00155     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pwndSend, message, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00156 }
00157 
<a name="l00158"></a><a class="code" href="../../d1/d4/combo_8c.html#a6">00158</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d1/d4/combo_8c.html#a6">ComboBoxMsgOKInInit</a>(UINT message, LRESULT* plRet)
00159 {
00160     <span class="keywordflow">switch</span> (message) {
00161     <span class="keywordflow">default</span>:
00162         <span class="keywordflow">break</span>;
00163     <span class="keywordflow">case</span> WM_SIZE:
00164         *plRet = 0;
00165         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00166     <span class="keywordflow">case</span> WM_STYLECHANGED:
00167     <span class="keywordflow">case</span> WM_GETTEXT:
00168     <span class="keywordflow">case</span> WM_GETTEXTLENGTH:
00169     <span class="keywordflow">case</span> WM_PRINT:
00170     <span class="keywordflow">case</span> WM_COMMAND:
00171     <span class="keywordflow">case</span> CBEC_KILLCOMBOFOCUS:
00172     <span class="keywordflow">case</span> WM_PRINTCLIENT:
00173     <span class="keywordflow">case</span> WM_SETFONT:
00174     <span class="keywordflow">case</span> WM_SYSKEYDOWN:
00175     <span class="keywordflow">case</span> WM_KEYDOWN:
00176     <span class="keywordflow">case</span> WM_CHAR:
00177     <span class="keywordflow">case</span> WM_LBUTTONDBLCLK:
00178     <span class="keywordflow">case</span> WM_LBUTTONDOWN:
00179     <span class="keywordflow">case</span> WM_MOUSEWHEEL:
00180     <span class="keywordflow">case</span> WM_CAPTURECHANGED:
00181     <span class="keywordflow">case</span> WM_LBUTTONUP:
00182     <span class="keywordflow">case</span> WM_MOUSEMOVE:
00183     <span class="keywordflow">case</span> WM_SETFOCUS:
00184     <span class="keywordflow">case</span> WM_KILLFOCUS:
00185     <span class="keywordflow">case</span> WM_SETREDRAW:
00186     <span class="keywordflow">case</span> WM_ENABLE:
00187     <span class="keywordflow">case</span> CB_SETDROPPEDWIDTH:
00188     <span class="keywordflow">case</span> CB_DIR:
00189     <span class="keywordflow">case</span> CB_ADDSTRING:
00190         <span class="comment">/*</span>
00191 <span class="comment">         * Cannot handle those messages yet. Bail out.</span>
00192 <span class="comment">         */</span>
00193         *plRet = CB_ERR;
00194         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00195     }
00196     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00197 }
00198 
00199 <span class="comment">/***************************************************************************\</span>
00200 <span class="comment">* xxxComboBoxCtlWndProc</span>
00201 <span class="comment">*</span>
00202 <span class="comment">* Class procedure for all combo boxes</span>
00203 <span class="comment">*</span>
00204 <span class="comment">* History:</span>
00205 <span class="comment">\***************************************************************************/</span>
00206 
<a name="l00207"></a><a class="code" href="../../d6/d0/usercli_8h.html#a614">00207</a> LRESULT <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a> <a class="code" href="../../d6/d0/usercli_8h.html#a614">ComboBoxWndProcWorker</a>(
00208     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00209     UINT message,
00210     WPARAM wParam,
00211     LPARAM lParam,
00212     DWORD fAnsi)
00213 {
00214     HWND hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd);
00215     <a class="code" href="../../d7/d9/structtagCBox.html">PCBOX</a> pcbox;
00216     POINT pt;
00217     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndEdit;
00218     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndList;
00219     PAINTSTRUCT ps;
00220     LPWSTR lpwsz = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00221     LRESULT lReturn;
00222     <span class="keyword">static</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fInit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00223     <span class="keywordtype">int</span>  i;
00224 
00225     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00226 
00227     <a class="code" href="../../d6/d0/usercli_8h.html#a28">VALIDATECLASSANDSIZE</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a201">FNID_COMBOBOX</a>);
00228     <a class="code" href="../../d6/d0/usercli_8h.html#a29">INITCONTROLLOOKASIDE</a>(&amp;<a class="code" href="../../d1/d4/combo_8c.html#a0">ComboboxLookaside</a>, <a class="code" href="../../d7/d9/structtagCBox.html">CBOX</a>, spwnd, 8);
00229 
00230     <span class="comment">/*</span>
00231 <span class="comment">     * Get the pcbox for the given window now since we will use it a lot in</span>
00232 <span class="comment">     * various handlers.  This is stored by NtUserSetWindowLongPtr() in the</span>
00233 <span class="comment">     * INITCONTROLLOOKASIDE macro above.</span>
00234 <span class="comment">     */</span>
00235     pcbox = ((<a class="code" href="../../d0/d1/structtagCOMBOWND.html">PCOMBOWND</a>)pwnd)-&gt;pcbox;
00236 
00237     <span class="comment">/*</span>
00238 <span class="comment">     * Protect the combobox during the initialization.</span>
00239 <span class="comment">     */</span>
00240     <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00241         LRESULT lRet;
00242 
00243         <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d4/combo_8c.html#a6">ComboBoxMsgOKInInit</a>(message, &amp;lRet)) {
00244             RIPMSG2(RIP_WARNING, <span class="stringliteral">"ComboBoxWndProcWorker: msg=%04x is sent to hwnd=%08x in the middle of initialization."</span>,
00245                     message, hwnd);
00246             <span class="keywordflow">return</span> lRet;
00247         }
00248     }
00249 
00250     <span class="comment">/*</span>
00251 <span class="comment">     * Dispatch the various messages we can receive</span>
00252 <span class="comment">     */</span>
00253     <span class="keywordflow">switch</span> (message) {
00254     <span class="keywordflow">case</span> CBEC_KILLCOMBOFOCUS:
00255 
00256         <span class="comment">/*</span>
00257 <span class="comment">         * Private message coming from editcontrol informing us that the combo</span>
00258 <span class="comment">         * box is losing the focus to a window which isn't in this combo box.</span>
00259 <span class="comment">         */</span>
00260         <a class="code" href="../../d6/d0/usercli_8h.html#a678">xxxCBKillFocusHelper</a>(pcbox);
00261         <span class="keywordflow">break</span>;
00262 
00263     <span class="keywordflow">case</span> WM_COMMAND:
00264 
00265         <span class="comment">/*</span>
00266 <span class="comment">         * So that we can handle notification messages from the listbox and</span>
00267 <span class="comment">         * edit control.</span>
00268 <span class="comment">         */</span>
00269         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a662">xxxCBCommandHandler</a>(pcbox, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)wParam, (HWND)lParam);
00270 
00271     <span class="keywordflow">case</span> WM_STYLECHANGED:
00272         UserAssert(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00273         {
00274             LONG OldStyle;
00275             LONG NewStyle = 0;
00276 
00277             pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o23">fRtoLReading</a> = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a625">WEFRTLREADING</a>) != 0);
00278             pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o22">fRightAlign</a>  = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a624">WEFRIGHT</a>) != 0);
00279             <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o23">fRtoLReading</a>)
00280                 NewStyle |= (WS_EX_RTLREADING | WS_EX_LEFTSCROLLBAR);
00281             <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o22">fRightAlign</a>)
00282                 NewStyle |= WS_EX_RIGHT;
00283 
00284             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, &amp;tlpwndList);
00285             OldStyle = GetWindowLong(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>), GWL_EXSTYLE) &amp; ~(WS_EX_RIGHT|WS_EX_RTLREADING|WS_EX_LEFTSCROLLBAR);
00286             SetWindowLong(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>), GWL_EXSTYLE, OldStyle|NewStyle);
00287             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndList);
00288 
00289             <span class="keywordflow">if</span> (!pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o21">fNoEdit</a> &amp;&amp; pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>) {
00290                 <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>, &amp;tlpwndEdit);
00291                 OldStyle = GetWindowLong(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>), GWL_EXSTYLE) &amp; ~(WS_EX_RIGHT|WS_EX_RTLREADING|WS_EX_LEFTSCROLLBAR);
00292                 SetWindowLong(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>), GWL_EXSTYLE, OldStyle|NewStyle);
00293                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndEdit);
00294             }
00295             <a class="code" href="../../d6/d0/usercli_8h.html#a669">xxxCBPosition</a>(pcbox);
00296             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a206">NtUserInvalidateRect</a>(hwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00297         }
00298         <span class="keywordflow">break</span>;
00299 
00300     <span class="keywordflow">case</span> WM_CTLCOLORMSGBOX:
00301     <span class="keywordflow">case</span> WM_CTLCOLOREDIT:
00302     <span class="keywordflow">case</span> WM_CTLCOLORLISTBOX:
00303     <span class="keywordflow">case</span> WM_CTLCOLORBTN:
00304     <span class="keywordflow">case</span> WM_CTLCOLORDLG:
00305     <span class="keywordflow">case</span> WM_CTLCOLORSCROLLBAR:
00306     <span class="keywordflow">case</span> WM_CTLCOLORSTATIC:
00307     <span class="keywordflow">case</span> WM_CTLCOLOR:
00308         <span class="comment">//</span>
00309         <span class="comment">// Causes compatibility problems for 3.X apps.  Forward only</span>
00310         <span class="comment">// for 4.0</span>
00311         <span class="comment">//</span>
00312         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>)) {
00313             <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndParent;
00314             LRESULT ret;
00315             <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndParent;
00316 
00317             pwndParent = <a class="code" href="../../d6/d0/usercli_8h.html#a27">REBASEPWND</a>(pwnd, spwndParent);
00318             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndParent, &amp;tlpwndParent);
00319             ret = <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwndParent), message, wParam, lParam);
00320             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(tlpwndParent);
00321             <span class="keywordflow">return</span> ret;
00322         } <span class="keywordflow">else</span>
00323             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d0/usercli_8h.html#a610">DefWindowProcWorker</a>(pwnd, message, wParam, lParam, fAnsi));
00324         <span class="keywordflow">break</span>;
00325 
00326     <span class="keywordflow">case</span> WM_GETTEXT:
00327         <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o21">fNoEdit</a>) {
00328             <span class="keywordflow">return</span> <a class="code" href="../../d1/d4/combo_8c.html#a3">xxxCBGetTextHelper</a>(pcbox, (<span class="keywordtype">int</span>)wParam, (LPWSTR)lParam, fAnsi);
00329         }
00330         <span class="keywordflow">goto</span> CallEditSendMessage;
00331         <span class="keywordflow">break</span>;
00332 
00333     <span class="keywordflow">case</span> WM_GETTEXTLENGTH:
00334 
00335         <span class="comment">/*</span>
00336 <span class="comment">         * If the is not edit control, CBS_DROPDOWNLIST, then we have to</span>
00337 <span class="comment">         * ask the list box for the size</span>
00338 <span class="comment">         */</span>
00339 
00340         <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o21">fNoEdit</a>) {
00341             <span class="keywordflow">return</span> <a class="code" href="../../d1/d4/combo_8c.html#a2">xxxCBGetTextLengthHelper</a>(pcbox, fAnsi);
00342         }
00343 
00344         <span class="comment">// FALL THROUGH</span>
00345 
00346     <span class="keywordflow">case</span> WM_CLEAR:
00347     <span class="keywordflow">case</span> WM_CUT:
00348     <span class="keywordflow">case</span> WM_PASTE:
00349     <span class="keywordflow">case</span> WM_COPY:
00350     <span class="keywordflow">case</span> WM_SETTEXT:
00351         <span class="keywordflow">goto</span> CallEditSendMessage;
00352         <span class="keywordflow">break</span>;
00353 
00354     <span class="keywordflow">case</span> WM_CREATE:
00355 
00356         <span class="comment">/*</span>
00357 <span class="comment">         * wParam - not used</span>
00358 <span class="comment">         * lParam - Points to the CREATESTRUCT data structure for the window.</span>
00359 <span class="comment">         */</span>
00360         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a671">xxxCBCreateHandler</a>(pcbox, pwnd);
00361 
00362     <span class="keywordflow">case</span> WM_ERASEBKGND:
00363 
00364         <span class="comment">/*</span>
00365 <span class="comment">         * Just return 1L so that the background isn't erased</span>
00366 <span class="comment">         */</span>
00367         <span class="keywordflow">return</span> 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00368 
00369     <span class="keywordflow">case</span> WM_GETFONT:
00370         <span class="keywordflow">return</span> (LRESULT)pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o24">hFont</a>;
00371 
00372     <span class="keywordflow">case</span> WM_PRINT:
00373         <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a610">DefWindowProcWorker</a>(pwnd, message, wParam, lParam, fAnsi))
00374             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00375 
00376         <span class="keywordflow">if</span> ((lParam &amp; PRF_OWNED) &amp;&amp; (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o10">CBoxStyle</a> &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a57">SDROPPABLE</a>) &amp;&amp;
00377             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)) {
00378             <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tpwndList;
00379             <span class="keywordtype">int</span> iDC = SaveDC((HDC) wParam);
00380             OffsetWindowOrgEx((HDC) wParam, 0, pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top - pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00381             lParam &amp;= ~PRF_CHECKVISIBLE;
00382             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, &amp;tpwndList);
00383             <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, WM_PRINT, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00384             RestoreDC((HDC) wParam, iDC);
00385         }
00386         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00387 
00388     <span class="keywordflow">case</span> WM_PRINTCLIENT:
00389         <a class="code" href="../../d6/d0/usercli_8h.html#a665">xxxCBPaint</a>(pcbox, (HDC) wParam);
00390         <span class="keywordflow">break</span>;
00391 
00392     <span class="keywordflow">case</span> WM_PAINT: {
00393         HDC hdc;
00394 
00395         <span class="comment">/*</span>
00396 <span class="comment">         * wParam - perhaps a hdc</span>
00397 <span class="comment">         */</span>
00398         hdc = (wParam) ? (HDC) wParam : <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a246">NtUserBeginPaint</a>(hwnd, &amp;ps);
00399 
00400         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a69">IsComboVisible</a>(pcbox))
00401             <a class="code" href="../../d6/d0/usercli_8h.html#a665">xxxCBPaint</a>(pcbox, hdc);
00402 
00403         <span class="keywordflow">if</span> (!wParam)
00404             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a248">NtUserEndPaint</a>(hwnd, &amp;ps);
00405         <span class="keywordflow">break</span>;
00406     }
00407     <span class="keywordflow">case</span> WM_GETDLGCODE:
00408 
00409         <span class="comment">/*</span>
00410 <span class="comment">         * wParam - not used</span>
00411 <span class="comment">         * lParam - not used</span>
00412 <span class="comment">         */</span>
00413         {
00414             LRESULT code = DLGC_WANTCHARS | DLGC_WANTARROWS;
00415 
00416             <span class="comment">// If the listbox is dropped and the ENTER key is pressed,</span>
00417             <span class="comment">// we want this message so we can close up the listbox</span>
00418             <span class="keywordflow">if</span> ((lParam != 0) &amp;&amp;
00419                 (((LPMSG)lParam)-&gt;message == WM_KEYDOWN) &amp;&amp;
00420                 pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o15">fLBoxVisible</a> &amp;&amp;
00421                 ((wParam == VK_RETURN) || (wParam == VK_ESCAPE)))
00422             {
00423                 code |= DLGC_WANTMESSAGE;
00424             }
00425             <span class="keywordflow">return</span> code;
00426         }
00427         <span class="comment">/*</span>
00428 <span class="comment">         * No fall through</span>
00429 <span class="comment">         */</span>
00430 
00431     <span class="keywordflow">case</span> WM_SETFONT:
00432         <a class="code" href="../../d6/d0/usercli_8h.html#a680">xxxCBSetFontHandler</a>(pcbox, (HANDLE)wParam, LOWORD(lParam));
00433         <span class="keywordflow">break</span>;
00434 
00435     <span class="keywordflow">case</span> WM_SYSKEYDOWN:
00436         <span class="keywordflow">if</span> (lParam &amp; 0x20000000<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>)  <span class="comment">/* Check if the alt key is down */</span> {
00437 
00438             <span class="comment">/*</span>
00439 <span class="comment">             * Handle Combobox support.  We want alt up or down arrow to behave</span>
00440 <span class="comment">             * like F4 key which completes the combo box selection</span>
00441 <span class="comment">             */</span>
00442             <span class="keywordflow">if</span> (lParam &amp; 0x1000000) {
00443 
00444                 <span class="comment">/*</span>
00445 <span class="comment">                 * This is an extended key such as the arrow keys not on the</span>
00446 <span class="comment">                 * numeric keypad so just drop the combobox.</span>
00447 <span class="comment">                 */</span>
00448                 <span class="keywordflow">if</span> (wParam == VK_DOWN || wParam == VK_UP)
00449                     <span class="keywordflow">goto</span> DropCombo;
00450 
00451                 <span class="keywordflow">goto</span> CallDWP;
00452             }
00453 
00454             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a16">GetKeyState</a>(VK_NUMLOCK) &amp; 0x1) {
00455                 <span class="comment">/*</span>
00456 <span class="comment">                 * If numlock down, just send all system keys to dwp</span>
00457 <span class="comment">                 */</span>
00458                 <span class="keywordflow">goto</span> CallDWP;
00459             } <span class="keywordflow">else</span> {
00460 
00461                 <span class="comment">/*</span>
00462 <span class="comment">                 * We just want to ignore keys on the number pad...</span>
00463 <span class="comment">                 */</span>
00464                 <span class="keywordflow">if</span> (!(wParam == VK_DOWN || wParam == VK_UP))
00465                     <span class="keywordflow">goto</span> CallDWP;
00466             }
00467 DropCombo:
00468             <span class="keywordflow">if</span> (!pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o15">fLBoxVisible</a>) {
00469 
00470                 <span class="comment">/*</span>
00471 <span class="comment">                 * If the listbox isn't visible, just show it</span>
00472 <span class="comment">                 */</span>
00473                 <a class="code" href="../../d6/d0/usercli_8h.html#a668">xxxCBShowListBoxWindow</a>(pcbox, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00474             } <span class="keywordflow">else</span> {
00475 
00476                 <span class="comment">/*</span>
00477 <span class="comment">                 * Ok, the listbox is visible.  So hide the listbox window.</span>
00478 <span class="comment">                 */</span>
00479                 <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a667">xxxCBHideListBoxWindow</a>(pcbox, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))
00480                     <span class="keywordflow">return</span>(0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00481             }
00482         }
00483         <span class="keywordflow">goto</span> CallDWP;
00484         <span class="keywordflow">break</span>;
00485 
00486     <span class="keywordflow">case</span> WM_KEYDOWN:
00487         <span class="comment">/*</span>
00488 <span class="comment">         * If the listbox is dropped and the ENTER key is pressed,</span>
00489 <span class="comment">         * close up the listbox successfully.  If ESCAPE is pressed,</span>
00490 <span class="comment">         * close it up like cancel.</span>
00491 <span class="comment">         */</span>
00492         <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o15">fLBoxVisible</a>) {
00493             <span class="keywordflow">if</span> ((wParam == VK_RETURN) || (wParam == VK_ESCAPE)) {
00494                 <a class="code" href="../../d6/d0/usercli_8h.html#a667">xxxCBHideListBoxWindow</a>(pcbox, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, (wParam != VK_ESCAPE));
00495                 <span class="keywordflow">break</span>;
00496             }
00497         }
00498         <span class="comment">// FALL THROUGH</span>
00499 
00500     <span class="keywordflow">case</span> WM_CHAR:
00501         <span class="keywordflow">if</span> (fAnsi &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a125">IS_DBCS_ENABLED</a>() &amp;&amp; IsDBCSLeadByteEx(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a118">THREAD_CODEPAGE</a>(), (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)wParam)) {
00502             <span class="keywordflow">return</span> <a class="code" href="../../d1/d4/combo_8c.html#a5">ComboBoxDBCharHandler</a>(pcbox, hwnd, message, wParam, lParam);
00503         }
00504 
00505         <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o21">fNoEdit</a>) {
00506             <span class="keywordflow">goto</span> CallListSendMessage;
00507         }
00508         <span class="keywordflow">else</span>
00509             <span class="keywordflow">goto</span> CallEditSendMessage;
00510         <span class="keywordflow">break</span>;
00511 
00512     <span class="keywordflow">case</span> WM_LBUTTONDBLCLK:
00513     <span class="keywordflow">case</span> WM_LBUTTONDOWN:
00514 
00515 <span class="preprocessor">#ifdef COLOR_HOTTRACKING</span>
00516 <span class="preprocessor"></span>        pcbox-&gt;fButtonHotTracked = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00517 <span class="preprocessor">#endif // COLOR_HOTTRACKING</span>
00518 <span class="preprocessor"></span>
00519         <span class="comment">/*</span>
00520 <span class="comment">         * Set the focus to the combo box if we get a mouse click on it.</span>
00521 <span class="comment">         */</span>
00522         <span class="keywordflow">if</span> (!pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o11">fFocus</a>) {
00523             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a225">NtUserSetFocus</a>(hwnd);
00524             <span class="keywordflow">if</span> (!pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o11">fFocus</a>) {
00525 
00526                 <span class="comment">/*</span>
00527 <span class="comment">                 * Don't do anything if we still don't have the focus.</span>
00528 <span class="comment">                 */</span>
00529                 <span class="keywordflow">break</span>;
00530             }
00531         }
00532 
00533         <span class="comment">/*</span>
00534 <span class="comment">         * If user clicked in button rect and we are a combobox with edit, then</span>
00535 <span class="comment">         * drop the listbox.  (The button rect is 0 if there is no button so the</span>
00536 <span class="comment">         * ptinrect will return false.) If a drop down list (no edit), clicking</span>
00537 <span class="comment">         * anywhere on the face causes the list to drop.</span>
00538 <span class="comment">         */</span>
00539 
00540         POINTSTOPOINT(pt, lParam);
00541         <span class="keywordflow">if</span> ((pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o10">CBoxStyle</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a61">SDROPDOWN</a> &amp;&amp;
00542                 <a class="code" href="../../d3/d6/rect_8c.html#a5">PtInRect</a>(&amp;pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o3">buttonrc</a>, pt)) ||
00543                 pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o10">CBoxStyle</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a60">SDROPDOWNLIST</a>) {
00544 
00545             <span class="comment">/*</span>
00546 <span class="comment">             * Set the fMouseDown flag so that we can handle clicking on</span>
00547 <span class="comment">             * the popdown button and dragging into the listbox (when it just</span>
00548 <span class="comment">             * dropped down) to make a selection.</span>
00549 <span class="comment">             */</span>
00550             pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o14">fButtonPressed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00551             <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o15">fLBoxVisible</a>) {
00552                 <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o13">fMouseDown</a>) {
00553                     pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o13">fMouseDown</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00554                     <a class="code" href="../../d6/d0/usercli_8h.html#a225">NtUserReleaseCapture</a>();
00555                 }
00556                 <a class="code" href="../../d1/d4/combo_8c.html#a4">xxxPressButton</a>(pcbox, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00557 
00558                 <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a667">xxxCBHideListBoxWindow</a>(pcbox, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))
00559                     <span class="keywordflow">return</span>(0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00560             } <span class="keywordflow">else</span> {
00561                 <a class="code" href="../../d6/d0/usercli_8h.html#a668">xxxCBShowListBoxWindow</a>(pcbox, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00562 
00563                 <span class="comment">// Setting and resetting this flag must always be followed</span>
00564                 <span class="comment">// imediately by SetCapture or ReleaseCapture</span>
00565                 <span class="comment">//</span>
00566                 pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o13">fMouseDown</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00567                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a221">NtUserSetCapture</a>(hwnd);
00568                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
00569                     <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a12">NotifyWinEvent</a>(EVENT_OBJECT_STATECHANGE, hwnd, OBJID_CLIENT, INDEX_COMBOBOX_BUTTON);
00570                 }
00571             }
00572         }
00573         <span class="keywordflow">break</span>;
00574 
00575     <span class="keywordflow">case</span> WM_MOUSEWHEEL:
00576         <span class="comment">/*</span>
00577 <span class="comment">         * Handle only scrolling.</span>
00578 <span class="comment">         */</span>
00579         <span class="keywordflow">if</span> (wParam &amp; (MK_CONTROL | MK_SHIFT))
00580             <span class="keywordflow">goto</span> CallDWP;
00581 
00582         <span class="comment">/*</span>
00583 <span class="comment">         * If the listbox is visible, send it the message to scroll.</span>
00584 <span class="comment">         */</span>
00585         <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o15">fLBoxVisible</a>)
00586             <span class="keywordflow">goto</span> CallListSendMessage;
00587 
00588         <span class="comment">/*</span>
00589 <span class="comment">         * If we're in extended UI mode or the edit control isn't yet created,</span>
00590 <span class="comment">         * bail.</span>
00591 <span class="comment">         */</span>
00592         <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o18">fExtendedUI</a> || pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00593             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00594 
00595         <span class="comment">/*</span>
00596 <span class="comment">         * Emulate arrow up/down messages to the edit control.</span>
00597 <span class="comment">         */</span>
00598         i = <a class="code" href="../../d4/d1/userk_8h.html#a259">abs</a>(((<span class="keywordtype">short</span>)HIWORD(wParam))/WHEEL_DELTA);
00599         wParam = ((<span class="keywordtype">short</span>)HIWORD(wParam) &gt; 0) ? VK_UP : VK_DOWN;
00600 
00601         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>, &amp;tlpwndEdit);
00602         <span class="keywordflow">while</span> (i-- &gt; 0) {
00603             <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(
00604                     pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>, WM_KEYDOWN, wParam, 0, fAnsi);
00605         }
00606         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndEdit);
00607         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00608 
00609     <span class="keywordflow">case</span> WM_CAPTURECHANGED:
00610         <span class="keywordflow">if</span> (!(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>)))
00611             <span class="keywordflow">return</span> 0;
00612 
00613         <span class="keywordflow">if</span> ((pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o13">fMouseDown</a>)) {
00614             pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o13">fMouseDown</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00615             <a class="code" href="../../d1/d4/combo_8c.html#a4">xxxPressButton</a>(pcbox, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00616 
00617             <span class="comment">//</span>
00618             <span class="comment">// Pop combo listbox back up, canceling.</span>
00619             <span class="comment">//</span>
00620             <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o15">fLBoxVisible</a>)
00621                 <a class="code" href="../../d6/d0/usercli_8h.html#a667">xxxCBHideListBoxWindow</a>(pcbox, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00622         }
00623         <span class="keywordflow">break</span>;
00624 
00625     <span class="keywordflow">case</span> WM_LBUTTONUP:
00626         <a class="code" href="../../d1/d4/combo_8c.html#a4">xxxPressButton</a>(pcbox, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00627 
00628         <span class="comment">/*</span>
00629 <span class="comment">         * Clear this flag so that mouse moves aren't sent to the listbox</span>
00630 <span class="comment">         */</span>
00631         <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o13">fMouseDown</a>) {
00632             pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o13">fMouseDown</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00633 
00634             <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o10">CBoxStyle</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a61">SDROPDOWN</a>) {
00635                 <span class="comment">// If an item in the listbox matches the text in the edit</span>
00636                 <span class="comment">// control, scroll it to the top of the listbox. Select the</span>
00637                 <span class="comment">// item only if the mouse button isn't down otherwise we</span>
00638                 <span class="comment">// will select the item when the mouse button goes up.</span>
00639                 <a class="code" href="../../d6/d0/usercli_8h.html#a675">xxxCBUpdateListBoxWindow</a>(pcbox, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00640                 <a class="code" href="../../d6/d0/usercli_8h.html#a666">xxxCBCompleteEditWindow</a>(pcbox);
00641             }
00642             <a class="code" href="../../d6/d0/usercli_8h.html#a225">NtUserReleaseCapture</a>();
00643 
00644             <span class="comment">// Now, we want listbox to track mouse moves while mouse up</span>
00645             <span class="comment">// until mouse down, and select items as though they were</span>
00646             <span class="comment">// clicked on.</span>
00647             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>)) {
00648 
00649                 <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, &amp;tlpwndList);
00650                 <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, LBCB_STARTTRACK, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00651                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndList);
00652             }
00653         }
00654 <span class="preprocessor">#ifdef COLOR_HOTTRACKING</span>
00655 <span class="preprocessor"></span>        HotTrack(pcbox);
00656         <span class="keywordflow">break</span>;
00657 
00658     <span class="keywordflow">case</span> WM_MOUSELEAVE:
00659         pcbox-&gt;fButtonHotTracked = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00660         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a206">NtUserInvalidateRect</a>(hwnd, &amp;pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o3">buttonrc</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00661 <span class="preprocessor">#endif // COLOR_HOTTRACKING</span>
00662 <span class="preprocessor"></span>        <span class="keywordflow">break</span>;
00663 
00664     <span class="keywordflow">case</span> WM_MOUSEMOVE:
00665         <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o13">fMouseDown</a>) {
00666             POINTSTOPOINT(pt, lParam);
00667 
00668             <span class="comment">// Note conversion of INT bit field to BOOL (1 or 0)</span>
00669 
00670             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/rect_8c.html#a5">PtInRect</a>(&amp;pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o3">buttonrc</a>, pt) != !!pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o14">fButtonPressed</a>) {
00671                 <a class="code" href="../../d1/d4/combo_8c.html#a4">xxxPressButton</a>(pcbox, (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o14">fButtonPressed</a> == 0));
00672             }
00673 
00674             <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a18">_ClientToScreen</a>(pwnd, &amp;pt);
00675             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/rect_8c.html#a5">PtInRect</a>(&amp;pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>, pt)) {
00676 
00677                 <span class="comment">/*</span>
00678 <span class="comment">                 * This handles dropdown comboboxes/listboxes so that clicking</span>
00679 <span class="comment">                 * on the dropdown button and dragging into the listbox window</span>
00680 <span class="comment">                 * will let the user make a listbox selection.</span>
00681 <span class="comment">                 */</span>
00682                 pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o13">fMouseDown</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00683                 <a class="code" href="../../d6/d0/usercli_8h.html#a225">NtUserReleaseCapture</a>();
00684 
00685                 <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o10">CBoxStyle</a> &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a58">SEDITABLE</a>) {
00686 
00687                     <span class="comment">/*</span>
00688 <span class="comment">                     * If an item in the listbox matches the text in the edit</span>
00689 <span class="comment">                     * control, scroll it to the top of the listbox.  Select the</span>
00690 <span class="comment">                     * item only if the mouse button isn't down otherwise we</span>
00691 <span class="comment">                     * will select the item when the mouse button goes up.</span>
00692 <span class="comment">                     */</span>
00693 
00694                     <span class="comment">/*</span>
00695 <span class="comment">                     * We need to select the item which matches the editcontrol</span>
00696 <span class="comment">                     * so that if the user drags out of the listbox, we don't</span>
00697 <span class="comment">                     * cancel back to his origonal selection</span>
00698 <span class="comment">                     */</span>
00699                     <a class="code" href="../../d6/d0/usercli_8h.html#a675">xxxCBUpdateListBoxWindow</a>(pcbox, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00700                 }
00701 
00702                 <span class="comment">/*</span>
00703 <span class="comment">                 * Convert point to listbox coordinates and send a buttondown</span>
00704 <span class="comment">                 * message to the listbox window.</span>
00705 <span class="comment">                 */</span>
00706                 <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a21">_ScreenToClient</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, &amp;pt);
00707                 lParam = POINTTOPOINTS(pt);
00708                 message = WM_LBUTTONDOWN;
00709                 <span class="keywordflow">goto</span> CallListSendMessage;
00710             }
00711         }
00712 <span class="preprocessor">#ifdef COLOR_HOTTRACKING</span>
00713 <span class="preprocessor"></span>        HotTrack(pcbox);
00714 <span class="preprocessor">#endif // COLOR_HOTTRACKING</span>
00715 <span class="preprocessor"></span>        <span class="keywordflow">break</span>;
00716 
00717     <span class="keywordflow">case</span> WM_NCDESTROY:
00718     <span class="keywordflow">case</span> WM_FINALDESTROY:
00719         <a class="code" href="../../d6/d0/usercli_8h.html#a673">xxxCBNcDestroyHandler</a>(pwnd, pcbox);
00720         <span class="keywordflow">break</span>;
00721 
00722     <span class="keywordflow">case</span> WM_SETFOCUS:
00723         <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o21">fNoEdit</a>) {
00724 
00725             <span class="comment">/*</span>
00726 <span class="comment">             * There is no editcontrol so set the focus to the combo box itself.</span>
00727 <span class="comment">             */</span>
00728             <a class="code" href="../../d6/d0/usercli_8h.html#a677">xxxCBGetFocusHelper</a>(pcbox);
00729         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>) {
00730             <span class="comment">/*</span>
00731 <span class="comment">             * Set the focus to the edit control window if there is one</span>
00732 <span class="comment">             */</span>
00733             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>, &amp;tlpwndEdit);
00734             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a225">NtUserSetFocus</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>));
00735             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndEdit);
00736         }
00737         <span class="keywordflow">break</span>;
00738 
00739     <span class="keywordflow">case</span> WM_KILLFOCUS:
00740 
00741         <span class="comment">/*</span>
00742 <span class="comment">         * wParam has the new focus hwnd</span>
00743 <span class="comment">         */</span>
00744         <span class="keywordflow">if</span> (wParam != 0)
00745             wParam = (WPARAM)<a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>((HWND)wParam);
00746         <span class="keywordflow">if</span> ((wParam == 0) || !<a class="code" href="../../d6/d9/rtl_2wow_8c.html#a16">_IsChild</a>(pwnd, (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)wParam)) {
00747 
00748             <span class="comment">/*</span>
00749 <span class="comment">             * We only give up the focus if the new window getting the focus</span>
00750 <span class="comment">             * doesn't belong to the combo box.</span>
00751 <span class="comment">             */</span>
00752             <a class="code" href="../../d6/d0/usercli_8h.html#a678">xxxCBKillFocusHelper</a>(pcbox);
00753         }
00754 
00755         UserAssert(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>);
00756         {
00757             <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb = ((<a class="code" href="../../d9/d9/structtagLBWND.html">PLBWND</a>)pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>)-&gt;pLBIV;
00758 
00759             <span class="keywordflow">if</span> ((plb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (plb != (<a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a>)-1)) {
00760                 plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o61">iTypeSearch</a> = 0;
00761                 <span class="keywordflow">if</span> (plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o62">pszTypeSearch</a>) {
00762                     <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o62">pszTypeSearch</a>);
00763                     plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o62">pszTypeSearch</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00764                 }
00765             }
00766         }
00767         <span class="keywordflow">break</span>;
00768 
00769     <span class="keywordflow">case</span> WM_SETREDRAW:
00770 
00771         <span class="comment">/*</span>
00772 <span class="comment">         * wParam - specifies state of the redraw flag.  nonzero = redraw</span>
00773 <span class="comment">         * lParam - not used</span>
00774 <span class="comment">         */</span>
00775 
00776         <span class="comment">/*</span>
00777 <span class="comment">         * effects: Sets the state of the redraw flag for this combo box</span>
00778 <span class="comment">         * and its children.</span>
00779 <span class="comment">         */</span>
00780         pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o12">fNoRedraw</a> = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)!((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)wParam);
00781 
00782         <span class="comment">/*</span>
00783 <span class="comment">         * Must check pcbox-&gt;spwnEdit in case we get this message before</span>
00784 <span class="comment">         * WM_CREATE - PCBOX won't be initialized yet. (Eudora does this)</span>
00785 <span class="comment">         */</span>
00786         <span class="keywordflow">if</span> (!pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o21">fNoEdit</a> &amp;&amp; pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>) {
00787             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>, &amp;tlpwndEdit);
00788             <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>, message, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00789             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndEdit);
00790         }
00791         <span class="keywordflow">goto</span> CallListSendMessage;
00792         <span class="keywordflow">break</span>;
00793 
00794     <span class="keywordflow">case</span> WM_ENABLE:
00795 
00796         <span class="comment">/*</span>
00797 <span class="comment">         * Invalidate the rect to cause it to be drawn in grey for its</span>
00798 <span class="comment">         * disabled view or ungreyed for non-disabled view.</span>
00799 <span class="comment">         */</span>
00800         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a206">NtUserInvalidateRect</a>(hwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00801         <span class="keywordflow">if</span> ((pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o10">CBoxStyle</a> &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a58">SEDITABLE</a>) &amp;&amp; pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>) {
00802 
00803             <span class="comment">/*</span>
00804 <span class="comment">             * Enable/disable the edit control window</span>
00805 <span class="comment">             */</span>
00806             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>, &amp;tlpwndEdit);
00807             <a class="code" href="../../d6/d0/usercli_8h.html#a216">NtUserEnableWindow</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>), (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a651">WFDISABLED</a>) == 0));
00808             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndEdit);
00809         }
00810 
00811         <span class="comment">/*</span>
00812 <span class="comment">         * Enable/disable the listbox window</span>
00813 <span class="comment">         */</span>
00814         UserAssert(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>);
00815         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, &amp;tlpwndList);
00816         <a class="code" href="../../d6/d0/usercli_8h.html#a216">NtUserEnableWindow</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>), (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a651">WFDISABLED</a>) == 0));
00817         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndList);
00818       <span class="keywordflow">break</span>;
00819 
00820     <span class="keywordflow">case</span> WM_SIZE:
00821 
00822         <span class="comment">/*</span>
00823 <span class="comment">         * wParam - defines the type of resizing fullscreen, sizeiconic,</span>
00824 <span class="comment">         *          sizenormal etc.</span>
00825 <span class="comment">         * lParam - new width in LOWORD, new height in HIGHUINT of client area</span>
00826 <span class="comment">         */</span>
00827         UserAssert(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>);
00828         <span class="keywordflow">if</span> (LOWORD(lParam) == 0 || HIWORD(lParam) == 0) {
00829 
00830             <span class="comment">/*</span>
00831 <span class="comment">             * If being sized to a zero width or to a zero height or we aren't</span>
00832 <span class="comment">             * fully initialized, just return.</span>
00833 <span class="comment">             */</span>
00834             <span class="keywordflow">return</span> 0;
00835         }
00836 
00837         <span class="comment">// OPTIMIZATIONS -- first check if old and new widths are the same</span>
00838         <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o4">cxCombo</a> == pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.right - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left) {
00839             <span class="keywordtype">int</span> iNewHeight = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.bottom - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top;
00840 
00841             <span class="comment">// now check if new height is the dropped down height</span>
00842             <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o15">fLBoxVisible</a>) {
00843                 <span class="comment">// Check if new height is the full size height</span>
00844                 <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o7">cyDrop</a> + pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o5">cyCombo</a> == iNewHeight)
00845                     <span class="keywordflow">return</span>(0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00846             } <span class="keywordflow">else</span> {
00847                 <span class="comment">// Check if new height is the closed up height</span>
00848                 <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o5">cyCombo</a> == iNewHeight)
00849                     <span class="keywordflow">return</span>(0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00850             }
00851         }
00852 
00853         <a class="code" href="../../d6/d0/usercli_8h.html#a681">xxxCBSizeHandler</a>(pcbox);
00854         <span class="keywordflow">break</span>;
00855 
00856     <span class="keywordflow">case</span> CB_GETDROPPEDSTATE:
00857 
00858         <span class="comment">/*</span>
00859 <span class="comment">         * returns 1 if combo is dropped down else 0</span>
00860 <span class="comment">         * wParam - not used</span>
00861 <span class="comment">         * lParam - not used</span>
00862 <span class="comment">         */</span>
00863         <span class="keywordflow">return</span> pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o15">fLBoxVisible</a>;
00864 
00865     <span class="keywordflow">case</span> CB_GETDROPPEDCONTROLRECT:
00866 
00867         <span class="comment">/*</span>
00868 <span class="comment">         * wParam - not used</span>
00869 <span class="comment">         * lParam - lpRect which will get the dropped down window rect in</span>
00870 <span class="comment">         *          screen coordinates.</span>
00871 <span class="comment">         */</span>
00872         ((LPRECT)lParam)-&gt;left      = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left;
00873         ((LPRECT)lParam)-&gt;top       = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top;
00874         ((LPRECT)lParam)-&gt;right     = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left + <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o6">cxDrop</a>, pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o4">cxCombo</a>);
00875         ((LPRECT)lParam)-&gt;bottom    = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top + pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o5">cyCombo</a> + pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o7">cyDrop</a>;
00876         <span class="keywordflow">break</span>;
00877 
00878     <span class="keywordflow">case</span> CB_SETDROPPEDWIDTH:
00879         <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o10">CBoxStyle</a> &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a57">SDROPPABLE</a>) {
00880             <span class="keywordflow">if</span> (wParam) {
00881                 wParam = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(wParam, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o4">cxCombo</a>);
00882 
00883                 <span class="keywordflow">if</span> (wParam != (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>) pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o6">cxDrop</a>)
00884                 {
00885                     pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o6">cxDrop</a> = (<span class="keywordtype">int</span>)wParam;
00886                     <a class="code" href="../../d6/d0/usercli_8h.html#a669">xxxCBPosition</a>(pcbox);
00887                 }
00888             }
00889         }
00890         <span class="comment">// fall thru</span>
00891 
00892     <span class="keywordflow">case</span> CB_GETDROPPEDWIDTH:
00893         <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o10">CBoxStyle</a> &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a57">SDROPPABLE</a>)
00894             <span class="keywordflow">return</span>((LRESULT) <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o6">cxDrop</a>, pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o4">cxCombo</a>));
00895         <span class="keywordflow">else</span>
00896             <span class="keywordflow">return</span>(CB_ERR);
00897         <span class="keywordflow">break</span>;
00898 
00899     <span class="keywordflow">case</span> CB_DIR:
00900         <span class="comment">/*</span>
00901 <span class="comment">         * wParam - Dos attribute value.</span>
00902 <span class="comment">         * lParam - Points to a file specification string</span>
00903 <span class="comment">         */</span>
00904         <span class="keywordflow">if</span> (fAnsi &amp;&amp; lParam != 0) {
00905             <span class="keywordflow">if</span> (MBToWCS((LPSTR)lParam, -1, &amp;lpwsz, -1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) == 0)
00906                 <span class="keywordflow">return</span> CB_ERR;
00907             lParam = (LPARAM)lpwsz;
00908         }
00909         lReturn = <a class="code" href="../../d6/d0/usercli_8h.html#a664">xxxCBDir</a>(pcbox, LOWORD(wParam), (LPWSTR)lParam);
00910         <span class="keywordflow">if</span> (fAnsi &amp;&amp; lParam != 0) {
00911             <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(lpwsz);
00912         }
00913         <span class="keywordflow">return</span> lReturn;
00914 
00915     <span class="keywordflow">case</span> CB_SETEXTENDEDUI:
00916 
00917         <span class="comment">/*</span>
00918 <span class="comment">         * wParam - specifies state to set extendui flag to.</span>
00919 <span class="comment">         * Currently only 1 is allowed.  Return CB_ERR (-1) if</span>
00920 <span class="comment">         * failure else 0 if success.</span>
00921 <span class="comment">         */</span>
00922         <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o10">CBoxStyle</a> &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a57">SDROPPABLE</a>) {
00923             <span class="keywordflow">if</span> (!wParam) {
00924                 pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o18">fExtendedUI</a> = 0;
00925                 <span class="keywordflow">return</span> 0;
00926             }
00927 
00928             <span class="keywordflow">if</span> (wParam == 1) {
00929               pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o18">fExtendedUI</a> = 1;
00930               <span class="keywordflow">return</span> 0;
00931             }
00932 
00933             RIPERR1(ERROR_INVALID_PARAMETER,
00934                     RIP_WARNING,
00935                     <span class="stringliteral">"Invalid parameter \"wParam\" (%ld) to ComboBoxWndProcWorker"</span>,
00936                     wParam);
00937 
00938         } <span class="keywordflow">else</span> {
00939             RIPERR1(ERROR_INVALID_MESSAGE,
00940                     RIP_WARNING,
00941                     <span class="stringliteral">"Invalid message (%ld) sent to ComboBoxWndProcWorker"</span>,
00942                     message);
00943         }
00944 
00945         <span class="keywordflow">return</span> CB_ERR;
00946 
00947     <span class="keywordflow">case</span> CB_GETEXTENDEDUI:
00948         <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o10">CBoxStyle</a> &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a57">SDROPPABLE</a>) {
00949             <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o18">fExtendedUI</a>)
00950                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00951         }
00952         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00953 
00954     <span class="keywordflow">case</span> CB_GETEDITSEL:
00955 
00956         <span class="comment">/*</span>
00957 <span class="comment">         * wParam - not used</span>
00958 <span class="comment">         * lParam - not used</span>
00959 <span class="comment">         * effects: Gets the selection range for the given edit control.  The</span>
00960 <span class="comment">         * starting BYTE-position is in the low order word.  It contains the</span>
00961 <span class="comment">         * the BYTE-position of the first nonselected character after the end</span>
00962 <span class="comment">         * of the selection in the high order word.  Returns CB_ERR if no</span>
00963 <span class="comment">         * editcontrol.</span>
00964 <span class="comment">         */</span>
00965         message = EM_GETSEL;
00966         <span class="keywordflow">goto</span> CallEditSendMessage;
00967         <span class="keywordflow">break</span>;
00968 
00969     <span class="keywordflow">case</span> CB_LIMITTEXT:
00970 
00971         <span class="comment">/*</span>
00972 <span class="comment">         * wParam - max number of bytes that can be entered</span>
00973 <span class="comment">         * lParam - not used</span>
00974 <span class="comment">         * effects: Specifies the maximum number of bytes of text the user may</span>
00975 <span class="comment">         * enter.  If maxLength is 0, we may enter MAXINT number of BYTES.</span>
00976 <span class="comment">         */</span>
00977         message = EM_LIMITTEXT;
00978         <span class="keywordflow">goto</span> CallEditSendMessage;
00979         <span class="keywordflow">break</span>;
00980 
00981     <span class="keywordflow">case</span> CB_SETEDITSEL:
00982 
00983         <span class="comment">/*</span>
00984 <span class="comment">         * wParam - ichStart</span>
00985 <span class="comment">         * lParam - ichEnd</span>
00986 <span class="comment">         *</span>
00987 <span class="comment">         */</span>
00988         message = EM_SETSEL;
00989 
00990         wParam = (<span class="keywordtype">int</span>)(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)LOWORD(lParam);
00991         lParam = (<span class="keywordtype">int</span>)(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)HIWORD(lParam);
00992         <span class="keywordflow">goto</span> CallEditSendMessage;
00993         <span class="keywordflow">break</span>;
00994 
00995     <span class="keywordflow">case</span> CB_ADDSTRING:
00996 
00997         <span class="comment">/*</span>
00998 <span class="comment">         * wParam - not used</span>
00999 <span class="comment">         * lParam - Points to null terminated string to be added to listbox</span>
01000 <span class="comment">         */</span>
01001         <span class="keywordflow">if</span> (!pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o19">fCase</a>)
01002             message = LB_ADDSTRING;
01003         <span class="keywordflow">else</span>
01004             message = (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o19">fCase</a> &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a64">UPPERCASE</a>) ? LB_ADDSTRINGUPPER : LB_ADDSTRINGLOWER;
01005         <span class="keywordflow">goto</span> CallListSendMessage;
01006         <span class="keywordflow">break</span>;
01007 
01008     <span class="keywordflow">case</span> CB_DELETESTRING:
01009 
01010         <span class="comment">/*</span>
01011 <span class="comment">         * wParam - index to string to be deleted</span>
01012 <span class="comment">         * lParam - not used</span>
01013 <span class="comment">         */</span>
01014         message = LB_DELETESTRING;
01015         <span class="keywordflow">goto</span> CallListSendMessage;
01016         <span class="keywordflow">break</span>;
01017 
01018     <span class="keywordflow">case</span> CB_INITSTORAGE:
01019         <span class="comment">// wParamLo - number of items</span>
01020         <span class="comment">// lParam - number of bytes of string space</span>
01021         message = LB_INITSTORAGE;
01022         <span class="keywordflow">goto</span> CallListSendMessage;
01023 
01024     <span class="keywordflow">case</span> CB_SETTOPINDEX:
01025         <span class="comment">// wParamLo - index to make top</span>
01026         <span class="comment">// lParam - not used</span>
01027         message = LB_SETTOPINDEX;
01028         <span class="keywordflow">goto</span> CallListSendMessage;
01029 
01030     <span class="keywordflow">case</span> CB_GETTOPINDEX:
01031         <span class="comment">// wParamLo / lParam - not used</span>
01032         message = LB_GETTOPINDEX;
01033         <span class="keywordflow">goto</span> CallListSendMessage;
01034 
01035     <span class="keywordflow">case</span> CB_GETCOUNT:
01036 
01037         <span class="comment">/*</span>
01038 <span class="comment">         * wParam - not used</span>
01039 <span class="comment">         * lParam - not used</span>
01040 <span class="comment">         */</span>
01041         message = LB_GETCOUNT;
01042         <span class="keywordflow">goto</span> CallListSendMessage;
01043         <span class="keywordflow">break</span>;
01044 
01045     <span class="keywordflow">case</span> CB_GETCURSEL:
01046 
01047         <span class="comment">/*</span>
01048 <span class="comment">         * wParam - not used</span>
01049 <span class="comment">         * lParam - not used</span>
01050 <span class="comment">         */</span>
01051         message = LB_GETCURSEL;
01052         <span class="keywordflow">goto</span> CallListSendMessage;
01053         <span class="keywordflow">break</span>;
01054 
01055     <span class="keywordflow">case</span> CB_GETLBTEXT:
01056 
01057         <span class="comment">/*</span>
01058 <span class="comment">         * wParam - index of string to be copied</span>
01059 <span class="comment">         * lParam - buffer that is to receive the string</span>
01060 <span class="comment">         */</span>
01061         message = LB_GETTEXT;
01062         <span class="keywordflow">goto</span> CallListSendMessage;
01063         <span class="keywordflow">break</span>;
01064 
01065     <span class="keywordflow">case</span> CB_GETLBTEXTLEN:
01066 
01067         <span class="comment">/*</span>
01068 <span class="comment">         * wParam - index to string</span>
01069 <span class="comment">         * lParam - now used for cbANSI</span>
01070 <span class="comment">         */</span>
01071         message = LB_GETTEXTLEN;
01072         <span class="keywordflow">goto</span> CallListSendMessage;
01073         <span class="keywordflow">break</span>;
01074 
01075     <span class="keywordflow">case</span> CB_INSERTSTRING:
01076 
01077         <span class="comment">/*</span>
01078 <span class="comment">         * wParam - position to receive the string</span>
01079 <span class="comment">         * lParam - points to the string</span>
01080 <span class="comment">         */</span>
01081         <span class="keywordflow">if</span> (!pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o19">fCase</a>)
01082             message = LB_INSERTSTRING;
01083         <span class="keywordflow">else</span>
01084             message = (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o19">fCase</a> &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a64">UPPERCASE</a>) ? LB_INSERTSTRINGUPPER : LB_INSERTSTRINGLOWER;
01085         <span class="keywordflow">goto</span> CallListSendMessage;
01086         <span class="keywordflow">break</span>;
01087 
01088     <span class="keywordflow">case</span> CB_RESETCONTENT:
01089 
01090         <span class="comment">/*</span>
01091 <span class="comment">         * wParam - not used</span>
01092 <span class="comment">         * lParam - not used</span>
01093 <span class="comment">         * If we come here before WM_CREATE has been processed,</span>
01094 <span class="comment">         * pcbox-&gt;spwndList will be NULL.</span>
01095 <span class="comment">         */</span>
01096         UserAssert(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>);
01097         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, &amp;tlpwndList);
01098         <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, LB_RESETCONTENT, 0, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01099         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndList);
01100         <a class="code" href="../../d6/d0/usercli_8h.html#a676">xxxCBInternalUpdateEditWindow</a>(pcbox, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01101         <span class="keywordflow">break</span>;
01102 
01103     <span class="keywordflow">case</span> CB_GETHORIZONTALEXTENT:
01104         message = LB_GETHORIZONTALEXTENT;
01105         <span class="keywordflow">goto</span> CallListSendMessage;
01106 
01107     <span class="keywordflow">case</span> CB_SETHORIZONTALEXTENT:
01108         message = LB_SETHORIZONTALEXTENT;
01109         <span class="keywordflow">goto</span> CallListSendMessage;
01110 
01111     <span class="keywordflow">case</span> CB_FINDSTRING:
01112 
01113         <span class="comment">/*</span>
01114 <span class="comment">         * wParam - index of starting point for search</span>
01115 <span class="comment">         * lParam - points to prefix string</span>
01116 <span class="comment">         */</span>
01117         message = LB_FINDSTRING;
01118         <span class="keywordflow">goto</span> CallListSendMessage;
01119         <span class="keywordflow">break</span>;
01120 
01121     <span class="keywordflow">case</span> CB_FINDSTRINGEXACT:
01122 
01123         <span class="comment">/*</span>
01124 <span class="comment">         * wParam - index of starting point for search</span>
01125 <span class="comment">         * lParam - points to a exact string</span>
01126 <span class="comment">         */</span>
01127         message = LB_FINDSTRINGEXACT;
01128         <span class="keywordflow">goto</span> CallListSendMessage;
01129         <span class="keywordflow">break</span>;
01130 
01131     <span class="keywordflow">case</span> CB_SELECTSTRING:
01132 
01133         <span class="comment">/*</span>
01134 <span class="comment">         * wParam - index of starting point for search</span>
01135 <span class="comment">         * lParam - points to prefix string</span>
01136 <span class="comment">         */</span>
01137         UserAssert(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>);
01138         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, &amp;tlpwndList);
01139         lParam = <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, LB_SELECTSTRING,
01140                 wParam, lParam, fAnsi);
01141         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndList);
01142         <a class="code" href="../../d6/d0/usercli_8h.html#a676">xxxCBInternalUpdateEditWindow</a>(pcbox, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01143         <span class="keywordflow">return</span> lParam;
01144 
01145     <span class="keywordflow">case</span> CB_SETCURSEL:
01146 
01147         <span class="comment">/*</span>
01148 <span class="comment">         * wParam - Contains index to be selected</span>
01149 <span class="comment">         * lParam - not used</span>
01150 <span class="comment">         * If we come here before WM_CREATE has been processed,</span>
01151 <span class="comment">         * pcbox-&gt;spwndList will be NULL.</span>
01152 <span class="comment">         */</span>
01153 
01154         UserAssert(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>);
01155 
01156         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, &amp;tlpwndList);
01157         lParam = <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, LB_SETCURSEL, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01158         <span class="keywordflow">if</span> (lParam != -1) {
01159             <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, LB_SETTOPINDEX, wParam, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01160         }
01161         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndList);
01162         <a class="code" href="../../d6/d0/usercli_8h.html#a676">xxxCBInternalUpdateEditWindow</a>(pcbox, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01163         <span class="keywordflow">return</span> lParam;
01164 
01165     <span class="keywordflow">case</span> CB_GETITEMDATA:
01166         message = LB_GETITEMDATA;
01167         <span class="keywordflow">goto</span> CallListSendMessage;
01168         <span class="keywordflow">break</span>;
01169 
01170     <span class="keywordflow">case</span> CB_SETITEMDATA:
01171         message = LB_SETITEMDATA;
01172         <span class="keywordflow">goto</span> CallListSendMessage;
01173         <span class="keywordflow">break</span>;
01174 
01175     <span class="keywordflow">case</span> CB_SETITEMHEIGHT:
01176         <span class="keywordflow">if</span> (wParam == -1) {
01177             <span class="keywordflow">if</span> (HIWORD(lParam) != 0)
01178                 <span class="keywordflow">return</span> CB_ERR;
01179             <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a682">xxxCBSetEditItemHeight</a>(pcbox, LOWORD(lParam));
01180         }
01181 
01182         message = LB_SETITEMHEIGHT;
01183         <span class="keywordflow">goto</span> CallListSendMessage;
01184         <span class="keywordflow">break</span>;
01185 
01186     <span class="keywordflow">case</span> CB_GETITEMHEIGHT:
01187         <span class="keywordflow">if</span> (wParam == -1)
01188             <span class="keywordflow">return</span> pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o2">editrc</a>.bottom - pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o2">editrc</a>.top;
01189 
01190         message = LB_GETITEMHEIGHT;
01191         <span class="keywordflow">goto</span> CallListSendMessage;
01192         <span class="keywordflow">break</span>;
01193 
01194     <span class="keywordflow">case</span> CB_SHOWDROPDOWN:
01195 
01196         <span class="comment">/*</span>
01197 <span class="comment">         * wParam - True then drop down the listbox if possible else hide it</span>
01198 <span class="comment">         * lParam - not used</span>
01199 <span class="comment">         */</span>
01200         <span class="keywordflow">if</span> (wParam &amp;&amp; !pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o15">fLBoxVisible</a>) {
01201             <a class="code" href="../../d6/d0/usercli_8h.html#a668">xxxCBShowListBoxWindow</a>(pcbox, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01202         } <span class="keywordflow">else</span> {
01203             <span class="keywordflow">if</span> (!wParam &amp;&amp; pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o15">fLBoxVisible</a>) {
01204                 <a class="code" href="../../d6/d0/usercli_8h.html#a667">xxxCBHideListBoxWindow</a>(pcbox, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01205             }
01206         }
01207         <span class="keywordflow">break</span>;
01208 
01209     <span class="keywordflow">case</span> CB_SETLOCALE:
01210 
01211         <span class="comment">/*</span>
01212 <span class="comment">         * wParam - locale id</span>
01213 <span class="comment">         * lParam - not used</span>
01214 <span class="comment">         */</span>
01215         message = LB_SETLOCALE;
01216         <span class="keywordflow">goto</span> CallListSendMessage;
01217         <span class="keywordflow">break</span>;
01218 
01219     <span class="keywordflow">case</span> CB_GETLOCALE:
01220 
01221         <span class="comment">/*</span>
01222 <span class="comment">         * wParam - not used</span>
01223 <span class="comment">         * lParam - not used</span>
01224 <span class="comment">         */</span>
01225         message = LB_GETLOCALE;
01226         <span class="keywordflow">goto</span> CallListSendMessage;
01227         <span class="keywordflow">break</span>;
01228 
01229     <span class="keywordflow">case</span> WM_MEASUREITEM:
01230     <span class="keywordflow">case</span> WM_DELETEITEM:
01231     <span class="keywordflow">case</span> WM_DRAWITEM:
01232     <span class="keywordflow">case</span> WM_COMPAREITEM:
01233         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a663">xxxCBMessageItemHandler</a>(pcbox, message, (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)lParam);
01234 
01235     <span class="keywordflow">case</span> WM_NCCREATE:
01236 
01237         <span class="comment">/*</span>
01238 <span class="comment">         * wParam - Contains a handle to the window being created</span>
01239 <span class="comment">         * lParam - Points to the CREATESTRUCT data structure for the window.</span>
01240 <span class="comment">         */</span>
01241         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a670">CBNcCreateHandler</a>(pcbox, pwnd);
01242 
01243     <span class="keywordflow">case</span> WM_PARENTNOTIFY:
01244         <span class="keywordflow">if</span> (LOWORD(wParam) == WM_DESTROY) {
01245             <span class="keywordflow">if</span> ((HWND)lParam == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>)) {
01246                 pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o10">CBoxStyle</a> &amp;= ~<a class="code" href="../../d6/d0/usercli_8h.html#a58">SEDITABLE</a>;
01247                 pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o21">fNoEdit</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01248                 pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a> = pwnd;
01249             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((HWND)lParam == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>)) {
01250                 pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o10">CBoxStyle</a> &amp;= ~<a class="code" href="../../d6/d0/usercli_8h.html#a57">SDROPPABLE</a>;
01251                 pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01252             }
01253         }
01254         <span class="keywordflow">break</span>;
01255 
01256     <span class="keywordflow">case</span> WM_UPDATEUISTATE:
01257         <span class="comment">/*</span>
01258 <span class="comment">         * Propagate the change to the list control, if any</span>
01259 <span class="comment">         */</span>
01260         UserAssert(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>);
01261         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, &amp;tlpwndList);
01262         <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, WM_UPDATEUISTATE,
01263                           wParam, lParam, fAnsi);
01264         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndList);
01265         <span class="keywordflow">goto</span> CallDWP;
01266 
01267     <span class="keywordflow">case</span> WM_HELP:
01268         {
01269             LPHELPINFO lpHelpInfo;
01270 
01271             <span class="comment">/* Check if this message is form a child of this combo</span>
01272 <span class="comment">             */</span>
01273             <span class="keywordflow">if</span> ((lpHelpInfo = (LPHELPINFO)lParam) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
01274                 ((pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a> &amp;&amp; lpHelpInfo-&gt;iCtrlId == (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>))) ||
01275                  lpHelpInfo-&gt;iCtrlId == (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>)) )) {
01276 
01277                 <span class="comment">// BUGBUG - What to do here?</span>
01278                 lpHelpInfo-&gt;iCtrlId = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>));
01279                 lpHelpInfo-&gt;hItemHandle = hwnd;
01280                 lpHelpInfo-&gt;dwContextId = <a class="code" href="../../d4/d0/rtl_2help_8c.html#a1">GetContextHelpId</a>(pwnd);
01281             }
01282         }
01283         <span class="comment">/*</span>
01284 <span class="comment">         * Fall through to DefWindowProc</span>
01285 <span class="comment">         */</span>
01286 
01287     <span class="keywordflow">default</span>:
01288 
01289         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(PENWINDOWS) &amp;&amp;
01290                 (message &gt;= WM_PENWINFIRST &amp;&amp; message &lt;= WM_PENWINLAST))
01291             <span class="keywordflow">goto</span> CallEditSendMessage;
01292 
01293 CallDWP:
01294         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a610">DefWindowProcWorker</a>(pwnd, message, wParam, lParam, fAnsi);
01295     }  <span class="comment">/* switch (message) */</span>
01296 
01297     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01298 
01299 <span class="comment">/*</span>
01300 <span class="comment"> * The following forward messages off to the child controls.</span>
01301 <span class="comment"> */</span>
01302 CallEditSendMessage:
01303     <span class="keywordflow">if</span> (!pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o21">fNoEdit</a> &amp;&amp; pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>) {
01304         <span class="comment">/*</span>
01305 <span class="comment">         * pcbox-&gt;spwndEdit will be NULL if we haven't done WM_CREATE yet!</span>
01306 <span class="comment">         */</span>
01307         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>, &amp;tlpwndEdit);
01308         lReturn = <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>, message,
01309                 wParam, lParam, fAnsi);
01310         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndEdit);
01311     }
01312     <span class="keywordflow">else</span> {
01313         RIPERR0(ERROR_INVALID_COMBOBOX_MESSAGE, RIP_VERBOSE, <span class="stringliteral">""</span>);
01314         lReturn = CB_ERR;
01315     }
01316     <span class="keywordflow">return</span> lReturn;
01317 
01318 CallListSendMessage:
01319     <span class="comment">/*</span>
01320 <span class="comment">     * pcbox-&gt;spwndList will be NULL if we haven't done WM_CREATE yet!</span>
01321 <span class="comment">     */</span>
01322     UserAssert(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>);
01323     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, &amp;tlpwndList);
01324     lReturn = <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, message,
01325             wParam, lParam, fAnsi);
01326     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndList);
01327     <span class="keywordflow">return</span> lReturn;
01328 
01329 }  <span class="comment">/* ComboBoxWndProcWorker */</span>
01330 
01331 
01332 <span class="comment">/***************************************************************************\</span>
01333 <span class="comment">\***************************************************************************/</span>
01334 
<a name="l01335"></a><a class="code" href="../../d6/d0/usercli_8h.html#a586">01335</a> LRESULT WINAPI <a class="code" href="../../d6/d0/usercli_8h.html#a586">ComboBoxWndProcA</a>(
01336     HWND hwnd,
01337     UINT message,
01338     WPARAM wParam,
01339     LPARAM lParam)
01340 {
01341     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
01342 
01343     <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01344         <span class="keywordflow">return</span> (0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01345     }
01346 
01347     <span class="comment">/*</span>
01348 <span class="comment">     * If the control is not interested in this message,</span>
01349 <span class="comment">     * pass it to DefWindowProc.</span>
01350 <span class="comment">     */</span>
01351     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a10">FWINDOWMSG</a>(message, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a201">FNID_COMBOBOX</a>) &amp;&amp;
01352             !(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(PENWINDOWS) &amp;&amp;
01353                     (message &gt;= WM_PENWINFIRST &amp;&amp; message &lt;= WM_PENWINLAST)))
01354         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a610">DefWindowProcWorker</a>(pwnd, message, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01355 
01356     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a614">ComboBoxWndProcWorker</a>(pwnd, message, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01357 }
01358 
<a name="l01359"></a><a class="code" href="../../d6/d0/usercli_8h.html#a587">01359</a> LRESULT WINAPI <a class="code" href="../../d6/d0/usercli_8h.html#a587">ComboBoxWndProcW</a>(
01360     HWND hwnd,
01361     UINT message,
01362     WPARAM wParam,
01363     LPARAM lParam)
01364 {
01365     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
01366 
01367     <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01368         <span class="keywordflow">return</span> (0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01369     }
01370 
01371     <span class="comment">/*</span>
01372 <span class="comment">     * If the control is not interested in this message,</span>
01373 <span class="comment">     * pass it to DefWindowProc.</span>
01374 <span class="comment">     */</span>
01375     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a10">FWINDOWMSG</a>(message, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a201">FNID_COMBOBOX</a>) &amp;&amp;
01376             !(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(PENWINDOWS) &amp;&amp;
01377                     (message &gt;= WM_PENWINFIRST &amp;&amp; message &lt;= WM_PENWINLAST)))
01378         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a610">DefWindowProcWorker</a>(pwnd, message, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01379 
01380     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a614">ComboBoxWndProcWorker</a>(pwnd, message, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01381 }
01382 
01383 
01384 <span class="comment">/***************************************************************************\</span>
01385 <span class="comment">* xxxCBMessageItemHandler</span>
01386 <span class="comment">*</span>
01387 <span class="comment">* Handles WM_DRAWITEM,WM_MEASUREITEM,WM_DELETEITEM,WM_COMPAREITEM</span>
01388 <span class="comment">* messages from the listbox.</span>
01389 <span class="comment">*</span>
01390 <span class="comment">* History:</span>
01391 <span class="comment">\***************************************************************************/</span>
01392 
<a name="l01393"></a><a class="code" href="../../d6/d0/usercli_8h.html#a663">01393</a> LRESULT <a class="code" href="../../d6/d0/usercli_8h.html#a663">xxxCBMessageItemHandler</a>(
01394     <a class="code" href="../../d7/d9/structtagCBox.html">PCBOX</a> pcbox,
01395     UINT message,
01396     LPVOID lpfoo)  <span class="comment">/* Actually can be any of the structs below */</span>
01397 {
01398     LRESULT lRet;
01399     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndParent;
01400 
01401     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>);
01402 
01403     <span class="comment">/*</span>
01404 <span class="comment">     * Send the &lt;foo&gt;item message back to the application after changing some</span>
01405 <span class="comment">     * parameters to their combo box specific versions.</span>
01406 <span class="comment">     */</span>
01407     ((LPMEASUREITEMSTRUCT)lpfoo)-&gt;CtlType = ODT_COMBOBOX;
01408     ((LPMEASUREITEMSTRUCT)lpfoo)-&gt;CtlID = PtrToUlong(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>);
01409     <span class="keywordflow">if</span> (message == WM_DRAWITEM)
01410         ((LPDRAWITEMSTRUCT)lpfoo)-&gt;hwndItem = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>);
01411     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (message == WM_DELETEITEM)
01412         ((LPDELETEITEMSTRUCT)lpfoo)-&gt;hwndItem = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>);
01413     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (message == WM_COMPAREITEM)
01414         ((LPCOMPAREITEMSTRUCT)lpfoo)-&gt;hwndItem = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>);
01415 
01416     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o1">spwndParent</a>, &amp;tlpwndParent);
01417     lRet = <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o1">spwndParent</a>), message,
01418             (WPARAM)pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>, (LPARAM)lpfoo);
01419     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndParent);
01420 
01421     <span class="keywordflow">return</span> lRet;
01422 }
01423 
01424 
01425 <span class="comment">/***************************************************************************\</span>
01426 <span class="comment">* xxxCBPaint</span>
01427 <span class="comment">*</span>
01428 <span class="comment">* History:</span>
01429 <span class="comment">\***************************************************************************/</span>
01430 
<a name="l01431"></a><a class="code" href="../../d6/d0/usercli_8h.html#a665">01431</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a665">xxxCBPaint</a>(
01432     <a class="code" href="../../d7/d9/structtagCBox.html">PCBOX</a> pcbox,
01433     HDC hdc)
01434 {
01435     RECT rc;
01436     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
01437     HBRUSH hbr;
01438 
01439     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>);
01440 
01441     rc.left = rc.top = 0;
01442     rc.right = pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o4">cxCombo</a>;
01443     rc.bottom = pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o5">cyCombo</a>;
01444     <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o20">f3DCombo</a>)
01445         <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a15">DrawEdge</a>(hdc, &amp;rc, EDGE_SUNKEN, BF_RECT | BF_ADJUST);
01446     <span class="keywordflow">else</span>
01447         <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a15">DrawEdge</a>(hdc, &amp;rc, EDGE_SUNKEN, BF_RECT | BF_ADJUST | BF_FLAT | BF_MONO);
01448 
01449     <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o3">buttonrc</a>.left != 0) {
01450     <span class="comment">// Draw in the dropdown arrow button</span>
01451         <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a14">DrawFrameControl</a>(hdc, &amp;pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o3">buttonrc</a>, DFC_SCROLL,
01452             DFCS_SCROLLCOMBOBOX |
01453             (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o14">fButtonPressed</a> ? DFCS_PUSHED | DFCS_FLAT : 0) |
01454             (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a651">WFDISABLED</a>) ? DFCS_INACTIVE : 0));
01455 <span class="preprocessor">#ifdef COLOR_HOTTRACKING</span>
01456 <span class="preprocessor"></span>            (pcbox-&gt;fButtonHotTracked ? DFCS_HOT: 0)));
01457 <span class="preprocessor">#endif // COLOR_HOTTRACKING</span>
01458 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o22">fRightAlign</a> )
01459             rc.left = pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o3">buttonrc</a>.right;
01460         <span class="keywordflow">else</span>
01461             rc.right = pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o3">buttonrc</a>.left;
01462     }
01463 
01464     <span class="comment">// Erase the background behind the edit/static item.  Since a combo</span>
01465     <span class="comment">// is an edit field/list box hybrid, we use the same coloring</span>
01466     <span class="comment">// conventions.</span>
01467     <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> = WM_CTLCOLOREDIT;
01468     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>)) {
01469         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a651">WFDISABLED</a>) ||
01470             (!pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o21">fNoEdit</a> &amp;&amp; pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a> &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a710">EFREADONLY</a>)))
01471             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> = WM_CTLCOLORSTATIC;
01472     } <span class="keywordflow">else</span>
01473         <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> = WM_CTLCOLORLISTBOX;
01474 
01475     hbr = <a class="code" href="../../d6/d0/usercli_8h.html#a235">GetControlBrush</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>), hdc, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>);
01476 
01477     <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o21">fNoEdit</a>)
01478         <a class="code" href="../../d6/d0/usercli_8h.html#a676">xxxCBInternalUpdateEditWindow</a>(pcbox, hdc);
01479     <span class="keywordflow">else</span>
01480         <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a3">FillRect</a>(hdc, &amp;rc, hbr);
01481 }
01482 
01483 
01484 <span class="comment">/***************************************************************************\</span>
01485 <span class="comment">* xxxCBCommandHandler</span>
01486 <span class="comment">*</span>
01487 <span class="comment">* Check the various notification codes from the controls and do the</span>
01488 <span class="comment">* proper thing.</span>
01489 <span class="comment">* always returns 0L</span>
01490 <span class="comment">*</span>
01491 <span class="comment">* History:</span>
01492 <span class="comment">\***************************************************************************/</span>
01493 
<a name="l01494"></a><a class="code" href="../../d6/d0/usercli_8h.html#a662">01494</a> <span class="keywordtype">long</span> <a class="code" href="../../d6/d0/usercli_8h.html#a662">xxxCBCommandHandler</a>(
01495     <a class="code" href="../../d7/d9/structtagCBox.html">PCBOX</a> pcbox,
01496     DWORD wParam,
01497     HWND hwndControl)
01498 {
01499 
01500     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>);
01501 
01502     <span class="comment">/*</span>
01503 <span class="comment">     * Check the edit control notification codes.  Note that currently, edit</span>
01504 <span class="comment">     * controls don't send EN_KILLFOCUS messages to the parent.</span>
01505 <span class="comment">     */</span>
01506     <span class="keywordflow">if</span> (!pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o21">fNoEdit</a> &amp;&amp;
01507             <a class="code" href="../../d6/d0/usercli_8h.html#a15">SAMEWOWHANDLE</a>(hwndControl, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>))) {
01508 
01509         <span class="comment">/*</span>
01510 <span class="comment">         * Edit control notification codes</span>
01511 <span class="comment">         */</span>
01512         <span class="keywordflow">switch</span> (HIWORD(wParam)) {
01513         <span class="keywordflow">case</span> EN_SETFOCUS:
01514             <span class="keywordflow">if</span> (!pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o11">fFocus</a>) {
01515 
01516                 <span class="comment">/*</span>
01517 <span class="comment">                 * The edit control has the focus for the first time which means</span>
01518 <span class="comment">                 * this is the first time the combo box has received the focus</span>
01519 <span class="comment">                 * and the parent must be notified that we have the focus.</span>
01520 <span class="comment">                 */</span>
01521                 <a class="code" href="../../d6/d0/usercli_8h.html#a677">xxxCBGetFocusHelper</a>(pcbox);
01522             }
01523             <span class="keywordflow">break</span>;
01524 
01525         <span class="keywordflow">case</span> EN_CHANGE:
01526             <a class="code" href="../../d6/d0/usercli_8h.html#a674">xxxCBNotifyParent</a>(pcbox, CBN_EDITCHANGE);
01527             <a class="code" href="../../d6/d0/usercli_8h.html#a675">xxxCBUpdateListBoxWindow</a>(pcbox, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01528             <span class="keywordflow">break</span>;
01529 
01530         <span class="keywordflow">case</span> EN_UPDATE:
01531             <a class="code" href="../../d6/d0/usercli_8h.html#a674">xxxCBNotifyParent</a>(pcbox, CBN_EDITUPDATE);
01532             <span class="keywordflow">break</span>;
01533 
01534         <span class="keywordflow">case</span> EN_ERRSPACE:
01535             <a class="code" href="../../d6/d0/usercli_8h.html#a674">xxxCBNotifyParent</a>(pcbox, CBN_ERRSPACE);
01536             <span class="keywordflow">break</span>;
01537         }
01538     }
01539 
01540     <span class="comment">/*</span>
01541 <span class="comment">     * Check listbox control notification codes</span>
01542 <span class="comment">     */</span>
01543     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a15">SAMEWOWHANDLE</a>(hwndControl, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>))) {
01544 
01545         <span class="comment">/*</span>
01546 <span class="comment">         * Listbox control notification codes</span>
01547 <span class="comment">         */</span>
01548         <span class="keywordflow">switch</span> ((<span class="keywordtype">int</span>)HIWORD(wParam)) {
01549         <span class="keywordflow">case</span> LBN_DBLCLK:
01550             <a class="code" href="../../d6/d0/usercli_8h.html#a674">xxxCBNotifyParent</a>(pcbox, CBN_DBLCLK);
01551             <span class="keywordflow">break</span>;
01552 
01553         <span class="keywordflow">case</span> LBN_ERRSPACE:
01554             <a class="code" href="../../d6/d0/usercli_8h.html#a674">xxxCBNotifyParent</a>(pcbox, CBN_ERRSPACE);
01555             <span class="keywordflow">break</span>;
01556 
01557         <span class="keywordflow">case</span> LBN_SELCHANGE:
01558         <span class="keywordflow">case</span> LBN_SELCANCEL:
01559             <span class="keywordflow">if</span> (!pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o17">fKeyboardSelInListBox</a>) {
01560 
01561                 <span class="comment">/*</span>
01562 <span class="comment">                 * If the selchange is caused by the user keyboarding through,</span>
01563 <span class="comment">                 * we don't want to hide the listbox.</span>
01564 <span class="comment">                 */</span>
01565                 <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a667">xxxCBHideListBoxWindow</a>(pcbox, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))
01566                     <span class="keywordflow">return</span>(0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01567             } <span class="keywordflow">else</span> {
01568                 pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o17">fKeyboardSelInListBox</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01569             }
01570 
01571             <a class="code" href="../../d6/d0/usercli_8h.html#a674">xxxCBNotifyParent</a>(pcbox, CBN_SELCHANGE);
01572             <a class="code" href="../../d6/d0/usercli_8h.html#a676">xxxCBInternalUpdateEditWindow</a>(pcbox, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01573             <span class="keywordflow">break</span>;
01574         }
01575     }
01576 
01577     <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
01578 }
01579 
01580 
01581 <span class="comment">/***************************************************************************\</span>
01582 <span class="comment">* xxxCBNotifyParent</span>
01583 <span class="comment">*</span>
01584 <span class="comment">* Sends the notification code to the parent of the combo box control</span>
01585 <span class="comment">*</span>
01586 <span class="comment">* History:</span>
01587 <span class="comment">\***************************************************************************/</span>
01588 
<a name="l01589"></a><a class="code" href="../../d1/d4/combo_8c.html#a13">01589</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a674">xxxCBNotifyParent</a>(
01590     <a class="code" href="../../d7/d9/structtagCBox.html">PCBOX</a> pcbox,
01591     <span class="keywordtype">short</span> notificationCode)
01592 {
01593     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndParent;            <span class="comment">// Parent if it exists</span>
01594     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndParent;
01595 
01596     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>);
01597 
01598     <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o1">spwndParent</a>)
01599         pwndParent = pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o1">spwndParent</a>;
01600     <span class="keywordflow">else</span>
01601         pwndParent = pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>;
01602 
01603     <span class="comment">/*</span>
01604 <span class="comment">     * wParam contains Control ID and notification code.</span>
01605 <span class="comment">     * lParam contains Handle to window</span>
01606 <span class="comment">     */</span>
01607     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndParent, &amp;tlpwndParent);
01608     <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pwndParent, WM_COMMAND,
01609             MAKELONG(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>), notificationCode),
01610             (LPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01611     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndParent);
01612 }
01613 
01614 <span class="comment">/***************************************************************************\</span>
01615 <span class="comment">*</span>
01616 <span class="comment">*</span>
01617 <span class="comment">* Completes the text in the edit box with the closest match from the</span>
01618 <span class="comment">* listbox.  If a prefix match can't be found, the edit control text isn't</span>
01619 <span class="comment">* updated. Assume a DROPDOWN style combo box.</span>
01620 <span class="comment">*</span>
01621 <span class="comment">*</span>
01622 <span class="comment">* History:</span>
01623 <span class="comment">\***************************************************************************/</span>
<a name="l01624"></a><a class="code" href="../../d6/d0/usercli_8h.html#a666">01624</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a666">xxxCBCompleteEditWindow</a>(
01625     <a class="code" href="../../d7/d9/structtagCBox.html">PCBOX</a> pcbox)
01626 {
01627     <span class="keywordtype">int</span> cchText;
01628     <span class="keywordtype">int</span> cchItemText;
01629     <span class="keywordtype">int</span> itemNumber;
01630     LPWSTR pText;
01631     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndEdit;
01632     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndList;
01633 
01634     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>);
01635 
01636     <span class="comment">/*</span>
01637 <span class="comment">     * Firstly check the edit control.</span>
01638 <span class="comment">     */</span>
01639     <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01640         <span class="keywordflow">return</span>;
01641     }
01642 
01643     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>, &amp;tlpwndEdit);
01644     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, &amp;tlpwndList);
01645 
01646     <span class="comment">/*</span>
01647 <span class="comment">     * +1 for null terminator</span>
01648 <span class="comment">     */</span>
01649     cchText = (<span class="keywordtype">int</span>)<a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>, WM_GETTEXTLENGTH, 0, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01650 
01651     <span class="keywordflow">if</span> (cchText) {
01652         cchText++;
01653         <span class="keywordflow">if</span> (!(pText = (LPWSTR)<a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(HEAP_ZERO_MEMORY, cchText*<span class="keyword">sizeof</span>(WCHAR))))
01654             <span class="keywordflow">goto</span> <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>;
01655 
01656         <span class="comment">/*</span>
01657 <span class="comment">         * We want to be sure to free the above allocated memory even if</span>
01658 <span class="comment">         * the client dies during callback (xxx) or some of the following</span>
01659 <span class="comment">         * window revalidation fails.</span>
01660 <span class="comment">         */</span>
01661         <span class="keywordflow">try</span> {
01662             <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>, WM_GETTEXT, cchText, (LPARAM)pText, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01663             itemNumber = (<span class="keywordtype">int</span>)<a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>,
01664                     LB_FINDSTRINGEXACT, (WPARAM)-1, (LPARAM)pText, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01665             <span class="keywordflow">if</span> (itemNumber == -1)
01666                 itemNumber = (<span class="keywordtype">int</span>)<a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>,
01667                         LB_FINDSTRING, (WPARAM)-1, (LPARAM)pText, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01668         } finally {
01669             <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>((HANDLE)pText);
01670         }
01671 
01672         <span class="keywordflow">if</span> (itemNumber == -1) {
01673 
01674             <span class="comment">/*</span>
01675 <span class="comment">             * No close match.  Blow off.</span>
01676 <span class="comment">             */</span>
01677             <span class="keywordflow">goto</span> <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>;
01678         }
01679 
01680         cchItemText = (<span class="keywordtype">int</span>)<a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, LB_GETTEXTLEN,
01681                 itemNumber, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01682         <span class="keywordflow">if</span> (cchItemText) {
01683             cchItemText++;
01684             <span class="keywordflow">if</span> (!(pText = (LPWSTR)<a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(HEAP_ZERO_MEMORY, cchItemText*<span class="keyword">sizeof</span>(WCHAR))))
01685                 <span class="keywordflow">goto</span> <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>;
01686 
01687             <span class="comment">/*</span>
01688 <span class="comment">             * We want to be sure to free the above allocated memory even if</span>
01689 <span class="comment">             * the client dies during callback (xxx) or some of the following</span>
01690 <span class="comment">             * window revalidation fails.</span>
01691 <span class="comment">             */</span>
01692             <span class="keywordflow">try</span> {
01693                 <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, LB_GETTEXT,
01694                         itemNumber, (LPARAM)pText, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01695                 <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>, WM_SETTEXT,
01696                         0, (LPARAM)pText, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01697             } finally {
01698                 <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>((HANDLE)pText);
01699             }
01700 
01701             <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>, EM_SETSEL, 0, MAXLONG, !!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a570">WFANSIPROC</a>));
01702         }
01703     }
01704 
01705 <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>:
01706     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndList);
01707     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndEdit);
01708 }
01709 
01710 
01711 <span class="comment">/***************************************************************************\</span>
01712 <span class="comment">* xxxCBHideListBoxWindow</span>
01713 <span class="comment">*</span>
01714 <span class="comment">* Hides the dropdown listbox window if it is a dropdown style.</span>
01715 <span class="comment">*</span>
01716 <span class="comment">* History:</span>
01717 <span class="comment">\***************************************************************************/</span>
01718 
<a name="l01719"></a><a class="code" href="../../d6/d0/usercli_8h.html#a667">01719</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d0/usercli_8h.html#a667">xxxCBHideListBoxWindow</a>(
01720     <a class="code" href="../../d7/d9/structtagCBox.html">PCBOX</a> pcbox,
01721     BOOL fNotifyParent,
01722     BOOL fSelEndOK)
01723 {
01724     HWND hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>);
01725     HWND hwndList = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>);
01726     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndList;
01727 
01728 
01729     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>);
01730 
01731     <span class="comment">// For 3.1+ apps, send CBN_SELENDOK to all types of comboboxes but only</span>
01732     <span class="comment">// allow CBN_SELENDCANCEL to be sent for droppable comboboxes</span>
01733     <span class="keywordflow">if</span> (fNotifyParent &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a592">WFWIN31COMPAT</a>) &amp;&amp;
01734         ((pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o10">CBoxStyle</a> &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a57">SDROPPABLE</a>) || fSelEndOK)) {
01735         <span class="keywordflow">if</span> (fSelEndOK)
01736         {
01737             <a class="code" href="../../d6/d0/usercli_8h.html#a674">xxxCBNotifyParent</a>(pcbox, CBN_SELENDOK);
01738         }
01739         <span class="keywordflow">else</span>
01740         {
01741             <a class="code" href="../../d6/d0/usercli_8h.html#a674">xxxCBNotifyParent</a>(pcbox, CBN_SELENDCANCEL);
01742         }
01743         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(hwnd))
01744             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01745     }
01746 
01747     <span class="comment">/*</span>
01748 <span class="comment">     * return, we don't hide simple combo boxes.</span>
01749 <span class="comment">     */</span>
01750     <span class="keywordflow">if</span> (!(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o10">CBoxStyle</a> &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a57">SDROPPABLE</a>)) {
01751         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01752     }
01753 
01754     <span class="comment">/*</span>
01755 <span class="comment">     * Send a faked buttonup message to the listbox so that it can release</span>
01756 <span class="comment">     * the capture and all.</span>
01757 <span class="comment">     */</span>
01758     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, &amp;tlpwndList);
01759 
01760     <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, LBCB_ENDTRACK, fSelEndOK, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01761 
01762     <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o15">fLBoxVisible</a>) {
01763         WORD swpFlags = SWP_NOMOVE | SWP_NOZORDER | SWP_NOACTIVATE;
01764 
01765         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a592">WFWIN31COMPAT</a>))
01766             swpFlags |= SWP_FRAMECHANGED;
01767 
01768         pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o15">fLBoxVisible</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01769 
01770         <span class="comment">/*</span>
01771 <span class="comment">         * Hide the listbox window</span>
01772 <span class="comment">         */</span>
01773         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a237">NtUserShowWindow</a>(hwndList, SW_HIDE);
01774 
01775         <span class="comment">//</span>
01776         <span class="comment">// Invalidate the item area now since SWP() might update stuff.</span>
01777         <span class="comment">// Since the combo is CS_VREDRAW/CS_HREDRAW, a size change will</span>
01778         <span class="comment">// redraw the whole thing, including the item rect.  But if it</span>
01779         <span class="comment">// isn't changing size, we still want to redraw the item anyway</span>
01780         <span class="comment">// to show focus/selection.</span>
01781         <span class="comment">//</span>
01782         <span class="keywordflow">if</span> (!(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o10">CBoxStyle</a> &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a58">SEDITABLE</a>))
01783             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a206">NtUserInvalidateRect</a>(hwnd, &amp;pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o2">editrc</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01784 
01785         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a115">NtUserSetWindowPos</a>(hwnd, HWND_TOP, 0, 0,
01786                 pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o4">cxCombo</a>, pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o5">cyCombo</a>, swpFlags);
01787 
01788         <span class="comment">// In case size didn't change</span>
01789         <a class="code" href="../../d3/d8/client_8c.html#a140">UpdateWindow</a>(hwnd);
01790 
01791         <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o10">CBoxStyle</a> &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a58">SEDITABLE</a>) {
01792             <a class="code" href="../../d6/d0/usercli_8h.html#a666">xxxCBCompleteEditWindow</a>(pcbox);
01793         }
01794 
01795         <span class="keywordflow">if</span> (fNotifyParent) {
01796 
01797             <span class="comment">/*</span>
01798 <span class="comment">             * Notify parent we will be popping up the combo box.</span>
01799 <span class="comment">             */</span>
01800             <a class="code" href="../../d6/d0/usercli_8h.html#a674">xxxCBNotifyParent</a>(pcbox, CBN_CLOSEUP);
01801             <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(hwnd))
01802                 <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01803         }
01804     }
01805 
01806     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndList);
01807 
01808     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01809 }
01810 
01811 <span class="comment">/***************************************************************************\</span>
01812 <span class="comment">* xxxCBShowListBoxWindow</span>
01813 <span class="comment">*</span>
01814 <span class="comment">* Lowers the dropdown listbox window.</span>
01815 <span class="comment">*</span>
01816 <span class="comment">* History:</span>
01817 <span class="comment">\***************************************************************************/</span>
01818 
<a name="l01819"></a><a class="code" href="../../d6/d0/usercli_8h.html#a668">01819</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a668">xxxCBShowListBoxWindow</a>(
01820     <a class="code" href="../../d7/d9/structtagCBox.html">PCBOX</a> pcbox, BOOL fTrack)
01821 {
01822     RECT        editrc;
01823     <span class="keywordtype">int</span>         itemNumber;
01824     <span class="keywordtype">int</span>         iHeight;
01825     <span class="keywordtype">int</span>         yTop;
01826     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       dwMult;
01827     <span class="keywordtype">int</span>         cyItem;
01828     HWND        hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>);
01829     HWND        hwndList = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>);
01830     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fAnimPos;
01831     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlpwndList;
01832     <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>    pMonitor;
01833 
01834     <span class="comment">//</span>
01835     <span class="comment">// THIS FUNCTION IS ONLY CALLED FOR DROPPABLE LIST COMBOBOXES</span>
01836     <span class="comment">//</span>
01837     UserAssert(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o10">CBoxStyle</a> &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a57">SDROPPABLE</a>);
01838 
01839     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>);
01840 
01841     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, &amp;tlpwndList);
01842 
01843     <span class="comment">/*</span>
01844 <span class="comment">     * Notify parent we will be dropping down the combo box.</span>
01845 <span class="comment">     */</span>
01846 
01847     <a class="code" href="../../d6/d0/usercli_8h.html#a674">xxxCBNotifyParent</a>(pcbox, CBN_DROPDOWN);
01848     <span class="comment">/*</span>
01849 <span class="comment">     * Invalidate the button rect so that the depressed arrow is drawn.</span>
01850 <span class="comment">     */</span>
01851     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a206">NtUserInvalidateRect</a>(hwnd, &amp;pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o3">buttonrc</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01852 
01853     pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o15">fLBoxVisible</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01854 
01855     <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o10">CBoxStyle</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a61">SDROPDOWN</a>) {
01856 
01857         <span class="comment">/*</span>
01858 <span class="comment">         * If an item in the listbox matches the text in the edit control,</span>
01859 <span class="comment">         * scroll it to the top of the listbox.  Select the item only if the</span>
01860 <span class="comment">         * mouse button isn't down otherwise we will select the item when the</span>
01861 <span class="comment">         * mouse button goes up.</span>
01862 <span class="comment">         */</span>
01863         <a class="code" href="../../d6/d0/usercli_8h.html#a675">xxxCBUpdateListBoxWindow</a>(pcbox, !pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o13">fMouseDown</a>);
01864         <span class="keywordflow">if</span> (!pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o13">fMouseDown</a>)
01865             <a class="code" href="../../d6/d0/usercli_8h.html#a666">xxxCBCompleteEditWindow</a>(pcbox);
01866     } <span class="keywordflow">else</span> {
01867 
01868         <span class="comment">/*</span>
01869 <span class="comment">         * Scroll the currently selected item to the top of the listbox.</span>
01870 <span class="comment">         */</span>
01871         itemNumber = (<span class="keywordtype">int</span>)<a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, LB_GETCURSEL,
01872                 0, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01873         <span class="keywordflow">if</span> (itemNumber == -1) {
01874             itemNumber = 0;
01875         }
01876         <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, LB_SETTOPINDEX, itemNumber, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01877         <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, LBCB_CARETON, 0, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01878 
01879         <span class="comment">/*</span>
01880 <span class="comment">         * We need to invalidate the edit rect so that the focus frame/invert</span>
01881 <span class="comment">         * will be turned off when the listbox is visible.  Tandy wants this for</span>
01882 <span class="comment">         * his typical reasons...</span>
01883 <span class="comment">         */</span>
01884         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a206">NtUserInvalidateRect</a>(hwnd, &amp;pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o2">editrc</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01885     }
01886 
01887     <span class="comment">//</span>
01888     <span class="comment">// Figure out where to position the dropdown listbox.  We want it just</span>
01889     <span class="comment">// touching the edge around the edit rectangle.  Note that since the</span>
01890     <span class="comment">// listbox is a popup, we need the position in screen coordinates.</span>
01891     <span class="comment">//</span>
01892 
01893     <span class="comment">// We want the dropdown to pop below or above the combo</span>
01894 
01895     <span class="comment">// Get screen coords</span>
01896     editrc.left   = pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left;
01897     editrc.top    = pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top;
01898     editrc.right  = pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left + pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o4">cxCombo</a>;
01899     editrc.bottom = pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top  + pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o5">cyCombo</a>;
01900 
01901     <span class="comment">// List area</span>
01902     cyItem = (<span class="keywordtype">int</span>)<a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, LB_GETITEMHEIGHT, 0, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01903 
01904     <span class="keywordflow">if</span> (cyItem == 0) {
01905         <span class="comment">// Make sure that it's not 0</span>
01906         RIPMSG0( RIP_WARNING, <span class="stringliteral">"LB_GETITEMHEIGHT is returning 0\n"</span> );
01907 
01908         cyItem = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cySysFontChar;
01909     }
01910 
01911     <span class="comment">//  we shoulda' just been able to use cyDrop here, but thanks to VB's need</span>
01912     <span class="comment">//  to do things their OWN SPECIAL WAY, we have to keep monitoring the size</span>
01913     <span class="comment">//  of the listbox 'cause VB changes it directly (jeffbog 03/21/94)</span>
01914     iHeight = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o7">cyDrop</a>, pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.bottom -
01915                                  pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top);
01916 
01917     <span class="keywordflow">if</span> (dwMult = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, LB_GETCOUNT, 0, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
01918         dwMult = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(LOWORD(dwMult) * cyItem);
01919         dwMult += <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYEDGE);
01920 
01921         <span class="keywordflow">if</span> (dwMult &lt; 0x7FFF)
01922             iHeight = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(LOWORD(dwMult), iHeight);
01923     }
01924 
01925     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a690">CBFNOINTEGRALHEIGHT</a>)) {
01926         UserAssert(cyItem);
01927         iHeight = ((iHeight - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYEDGE)) / cyItem) * cyItem + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYEDGE);
01928     }
01929 
01930     <span class="comment">//</span>
01931     <span class="comment">// Other 1/2 of old app combo fix.  Make dropdown overlap combo window</span>
01932     <span class="comment">// a little.  That way we can have a chance of invalidating the overlap</span>
01933     <span class="comment">// and causing a repaint to help out Publisher 2.0's toolbar combos.</span>
01934     <span class="comment">// See comments for PressButton() above.</span>
01935     <span class="comment">//</span>
01936     pMonitor = <a class="code" href="../../d9/d1/mmrtl_8c.html#a8">_MonitorFromWindow</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>, MONITOR_DEFAULTTOPRIMARY);
01937     <span class="keywordflow">if</span> (editrc.bottom + iHeight &lt;= pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.bottom) {
01938         yTop = editrc.bottom;
01939         <span class="keywordflow">if</span> (!pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o20">f3DCombo</a>)
01940             yTop -= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYBORDER);
01941 
01942         fAnimPos = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01943     } <span class="keywordflow">else</span> {
01944         yTop = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(editrc.top - iHeight, pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.top);
01945         <span class="keywordflow">if</span> (!pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o20">f3DCombo</a>)
01946             yTop += <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYBORDER);
01947 
01948         fAnimPos = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01949     }
01950 
01951     <span class="keywordflow">if</span> ( ! <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>( pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>) )
01952     {
01953       <span class="comment">// fix for Winword B#7504, Combo-ListBox text gets</span>
01954       <span class="comment">// truncated by a small width, this is do to us</span>
01955       <span class="comment">// now setting size here in SetWindowPos, rather than</span>
01956       <span class="comment">// earlier where we did this in Win3.1</span>
01957 
01958       <span class="keywordflow">if</span> ( (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.right - pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left ) &gt;
01959             pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o6">cxDrop</a> )
01960 
01961             pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o6">cxDrop</a> = pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.right - pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left;
01962     }
01963 
01964     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a115">NtUserSetWindowPos</a>(hwndList, HWND_TOPMOST, editrc.left,
01965         yTop, <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o6">cxDrop</a>, pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o4">cxCombo</a>), iHeight, SWP_NOACTIVATE);
01966 
01967     <span class="comment">/*</span>
01968 <span class="comment">     * Get any drawing in the combo box window out of the way so it doesn't</span>
01969 <span class="comment">     * invalidate any of the SPB underneath the list window.</span>
01970 <span class="comment">     */</span>
01971     <a class="code" href="../../d3/d8/client_8c.html#a140">UpdateWindow</a>(hwnd);
01972 
01973     <span class="keywordflow">if</span> (!(<a class="code" href="../../d1/d0/inc_2user_8h.html#a382">TEST_EffectPUSIF</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a366">PUSIF_COMBOBOXANIMATION</a>))
01974         || (<a class="code" href="../../d6/d3/queue_8c.html#a35">GetAppCompatFlags2</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>) &amp; GACF2_ANIMATIONOFF)) {
01975         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a237">NtUserShowWindow</a>(hwndList, SW_SHOWNA);
01976     } <span class="keywordflow">else</span> {
01977         <a class="code" href="../../d3/d8/winmgrc_8c.html#a36">AnimateWindow</a>(hwndList, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a916">CMS_QANIMATION</a>, (fAnimPos ? AW_VER_POSITIVE :
01978                 AW_VER_NEGATIVE) | AW_SLIDE);
01979     }
01980 
01981 <span class="preprocessor">#ifdef LATER</span>
01982 <span class="preprocessor"></span><span class="comment">//</span>
01983 <span class="comment">// we don't have sys modal windows.</span>
01984 <span class="comment">//</span>
01985     <span class="keywordflow">if</span> (pwndSysModal) {
01986 
01987         <span class="comment">/*</span>
01988 <span class="comment">         * If this combo is in a system modal dialog box, we need to explicitly</span>
01989 <span class="comment">         * call update window otherwise we won't automatically send paint</span>
01990 <span class="comment">         * messages to the toplevel listbox window.  This is especially</span>
01991 <span class="comment">         * noticeable in the File Open/Save sys modal dlgs which are put up at</span>
01992 <span class="comment">         * ExitWindows time.</span>
01993 <span class="comment">         */</span>
01994         <a class="code" href="../../d3/d8/client_8c.html#a140">UpdateWindow</a>(hwndList);
01995     }
01996 <span class="preprocessor">#endif</span>
01997 <span class="preprocessor"></span>
01998     <span class="comment">/*</span>
01999 <span class="comment">     * Restart search buffer from first char</span>
02000 <span class="comment">     */</span>
02001     {
02002     <a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a> plb = ((<a class="code" href="../../d9/d9/structtagLBWND.html">PLBWND</a>)pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>)-&gt;pLBIV;
02003 
02004         <span class="keywordflow">if</span> ((plb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (plb != (<a class="code" href="../../d7/d9/structtagLBIV.html">PLBIV</a>)-1)) {
02005             plb-&gt;<a class="code" href="../../d7/d9/structtagLBIV.html#o61">iTypeSearch</a> = 0;
02006         }
02007     }
02008 
02009     <span class="keywordflow">if</span> (fTrack &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>))
02010         <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, LBCB_STARTTRACK, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02011 
02012     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndList);
02013 }
02014 
02015 <span class="comment">/***************************************************************************\</span>
02016 <span class="comment">* xxxCBInternalUpdateEditWindow</span>
02017 <span class="comment">*</span>
02018 <span class="comment">* Updates the editcontrol/statictext window so that it contains the text</span>
02019 <span class="comment">* given by the current selection in the listbox.  If the listbox has no</span>
02020 <span class="comment">* selection (ie. -1), then we erase all the text in the editcontrol.</span>
02021 <span class="comment">*</span>
02022 <span class="comment">* hdcPaint is from WM_PAINT messages Begin/End Paint hdc. If null, we should</span>
02023 <span class="comment">* get our own dc.</span>
02024 <span class="comment">*</span>
02025 <span class="comment">* History:</span>
02026 <span class="comment">\***************************************************************************/</span>
02027 
<a name="l02028"></a><a class="code" href="../../d6/d0/usercli_8h.html#a676">02028</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a676">xxxCBInternalUpdateEditWindow</a>(
02029     <a class="code" href="../../d7/d9/structtagCBox.html">PCBOX</a> pcbox,
02030     HDC hdcPaint)
02031 {
02032     <span class="keywordtype">int</span> cchText = 0;
02033     LPWSTR pText = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02034     <span class="keywordtype">int</span> sItem;
02035     HDC hdc;
02036     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
02037     HBRUSH hbrSave;
02038     HBRUSH hbrControl;
02039     HANDLE hOldFont;
02040     DRAWITEMSTRUCT dis;
02041     RECT rc;
02042     HWND hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>);
02043     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndList;
02044     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndEdit;
02045     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndParent;
02046 
02047     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>);
02048 
02049     <span class="comment">/* This check is also commented out in Win3.1 and Win95 */</span>
02050     <span class="comment">// if (!TestWF(pcbox-&gt;spwnd, WFVISIBLE)) {</span>
02051     <span class="comment">//    return;</span>
02052     <span class="comment">// }</span>
02053 
02054     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o1">spwndParent</a>, &amp;tlpwndParent);
02055     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, &amp;tlpwndList);
02056     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>, &amp;tlpwndEdit);
02057 
02058     sItem = (<span class="keywordtype">int</span>)<a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, LB_GETCURSEL, 0, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02059 
02060     <span class="comment">/*</span>
02061 <span class="comment">     * This 'try-finally' block ensures that the allocated 'pText' will</span>
02062 <span class="comment">     * be freed no matter how this routine is exited.</span>
02063 <span class="comment">     */</span>
02064     <span class="keywordflow">try</span> {
02065         <span class="keywordflow">if</span> (sItem != -1) {
02066             cchText = (<span class="keywordtype">int</span>)<a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, LB_GETTEXTLEN,
02067                     (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)sItem, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02068             <span class="keywordflow">if</span> ((pText = (LPWSTR)<a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(HEAP_ZERO_MEMORY, (cchText+1) * <span class="keyword">sizeof</span>(WCHAR)))) {
02069                 cchText = (<span class="keywordtype">int</span>)<a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, LB_GETTEXT,
02070                         (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)sItem, (LPARAM)pText, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02071             }
02072         }
02073 
02074         <span class="keywordflow">if</span> (!pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o21">fNoEdit</a>) {
02075 
02076             <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>) {
02077                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a689">CBFHASSTRINGS</a>))
02078                     <a class="code" href="../../d5/d9/cltxt_8h.html#a23">SetWindowText</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>), pText ? pText : TEXT(<span class="stringliteral">""</span>));
02079 
02080                 <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o11">fFocus</a>) {
02081                     <span class="comment">/*</span>
02082 <span class="comment">                     * Only hilite the text if we have the focus.</span>
02083 <span class="comment">                     */</span>
02084                     <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>, EM_SETSEL, 0, MAXLONG, !!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a570">WFANSIPROC</a>));
02085                 }
02086             }
02087         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a69">IsComboVisible</a>(pcbox)) {
02088             <span class="keywordflow">if</span> (hdcPaint) {
02089                 hdc = hdcPaint;
02090             } <span class="keywordflow">else</span> {
02091                 hdc = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a250">NtUserGetDC</a>(hwnd);
02092             }
02093 
02094             SetBkMode(hdc, OPAQUE);
02095             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>)) {
02096                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a651">WFDISABLED</a>))
02097                     <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> = WM_CTLCOLORSTATIC;
02098                 <span class="keywordflow">else</span>
02099                     <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> = WM_CTLCOLOREDIT;
02100             } <span class="keywordflow">else</span>
02101                 <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> = WM_CTLCOLORLISTBOX;
02102 
02103             hbrControl = <a class="code" href="../../d6/d0/usercli_8h.html#a235">GetControlBrush</a>(hwnd, hdc, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>);
02104             hbrSave = SelectObject(hdc, hbrControl);
02105 
02106             <a class="code" href="../../d3/d6/rect_8c.html#a2">CopyInflateRect</a>(&amp;rc, &amp;pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o2">editrc</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXBORDER), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYBORDER));
02107             PatBlt(hdc, rc.left, rc.top, rc.right - rc.left,
02108                 rc.bottom - rc.top, PATCOPY);
02109             <a class="code" href="../../d3/d6/rect_8c.html#a7">InflateRect</a>(&amp;rc, -<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXBORDER), -<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYBORDER));
02110 
02111             <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o11">fFocus</a> &amp;&amp; !pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o15">fLBoxVisible</a>) {
02112                 <span class="comment">//</span>
02113                 <span class="comment">// Fill in the selected area</span>
02114                 <span class="comment">//</span>
02115 
02116 
02117                 <span class="comment">// only do the FillRect if we know its not</span>
02118                 <span class="comment">// ownerdraw item, otherwise we mess up people up</span>
02119                 <span class="comment">// BUT: for Compat's sake we still do this for Win 3.1 guys</span>
02120 
02121                 <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>( pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>) || !pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o16">OwnerDraw</a>)
02122                     <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a3">FillRect</a>(hdc, &amp;rc, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a22">SYSHBR</a>(HIGHLIGHT));
02123 
02124                 SetBkColor(hdc, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(HIGHLIGHT));
02125                 SetTextColor(hdc, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(HIGHLIGHTTEXT));
02126             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a651">WFDISABLED</a>) &amp;&amp; !pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o16">OwnerDraw</a>) {
02127                 <span class="keywordflow">if</span> ((COLORREF)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(GRAYTEXT) != GetBkColor(hdc))
02128                     SetTextColor(hdc, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a20">SYSRGB</a>(GRAYTEXT));
02129             }
02130 
02131             <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o24">hFont</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02132                 hOldFont = SelectObject(hdc, pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o24">hFont</a>);
02133 
02134             <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o16">OwnerDraw</a>) {
02135 
02136                 <span class="comment">/*</span>
02137 <span class="comment">                 * Let the app draw the stuff in the static text box.</span>
02138 <span class="comment">                 */</span>
02139                 dis.CtlType = ODT_COMBOBOX;
02140                 dis.CtlID = PtrToUlong(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>);
02141                 dis.itemID = sItem;
02142                 dis.itemAction = ODA_DRAWENTIRE;
02143                 dis.itemState = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)
02144                     ((pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o11">fFocus</a> &amp;&amp; !pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o15">fLBoxVisible</a> ? ODS_SELECTED : 0) |
02145                     (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a651">WFDISABLED</a>) ? ODS_DISABLED : 0) |
02146                     (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o11">fFocus</a> &amp;&amp; !pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o15">fLBoxVisible</a> ? ODS_FOCUS : 0) |
02147                     (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>) ? ODS_COMBOBOXEDIT : 0) |
02148                     (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>, <a class="code" href="../../d1/d0/inc_2user_8h.html#a622">WEFPUIFOCUSHIDDEN</a>) ? ODS_NOFOCUSRECT : 0) |
02149                     (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>, <a class="code" href="../../d1/d0/inc_2user_8h.html#a623">WEFPUIACCELHIDDEN</a>) ? ODS_NOACCEL : 0));
02150 
02151                 dis.hwndItem = hwnd;
02152                 dis.hDC = hdc;
02153                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;dis.rcItem, &amp;rc);
02154 
02155                 <span class="comment">// Don't let ownerdraw dudes draw outside of the combo client</span>
02156                 <span class="comment">// bounds.</span>
02157                 IntersectClipRect(hdc, rc.left, rc.top, rc.right, rc.bottom);
02158 
02159                 dis.itemData = (ULONG_PTR)<a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>,
02160                         LB_GETITEMDATA, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)sItem, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02161 
02162                 <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o1">spwndParent</a>), WM_DRAWITEM, dis.CtlID,
02163                         (LPARAM)&amp;dis);
02164             } <span class="keywordflow">else</span> {
02165 
02166                 <span class="comment">/*</span>
02167 <span class="comment">                 * Start the text one pixel within the rect so that we leave a</span>
02168 <span class="comment">                 * nice hilite border around the text.</span>
02169 <span class="comment">                 */</span>
02170 
02171                 <span class="keywordtype">int</span> x ;
02172                 <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> align ;
02173 
02174                 <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o22">fRightAlign</a> ) {
02175                     align = TA_RIGHT;
02176                     x = rc.right - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXBORDER);
02177                 } <span class="keywordflow">else</span> {
02178                     x = rc.left + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXBORDER);
02179                     align = 0;
02180                 }
02181 
02182                 <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o23">fRtoLReading</a> )
02183                     align |= TA_RTLREADING;
02184 
02185                 <span class="keywordflow">if</span> (align)
02186                     SetTextAlign(hdc, GetTextAlign(hdc) | align);
02187 
02188                 <span class="comment">// Draw the text, leaving a gap on the left &amp; top for selection.</span>
02189                 ExtTextOut(hdc, x, rc.top + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYBORDER), ETO_CLIPPED | ETO_OPAQUE,
02190                        &amp;rc, pText ? pText : TEXT(<span class="stringliteral">""</span>), cchText, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02191                 <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o11">fFocus</a> &amp;&amp; !pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o15">fLBoxVisible</a>) {
02192                     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>, <a class="code" href="../../d1/d0/inc_2user_8h.html#a622">WEFPUIFOCUSHIDDEN</a>)) {
02193                         <a class="code" href="../../d3/d9/clrect_8c.html#a0">DrawFocusRect</a>(hdc, &amp;rc);
02194                     }
02195                 }
02196             }
02197 
02198             <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o24">hFont</a> &amp;&amp; hOldFont) {
02199                 SelectObject(hdc, hOldFont);
02200             }
02201 
02202             <span class="keywordflow">if</span> (hbrSave) {
02203                 SelectObject(hdc, hbrSave);
02204             }
02205 
02206             <span class="keywordflow">if</span> (!hdcPaint) {
02207                 <a class="code" href="../../d6/d0/usercli_8h.html#a211">NtUserReleaseDC</a>(hwnd, hdc);
02208             }
02209         }
02210 
02211     } finally {
02212         <span class="keywordflow">if</span> (pText != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02213             <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>((HANDLE)pText);
02214     }
02215 
02216     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndEdit);
02217     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndList);
02218     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndParent);
02219 }
02220 
02221 <span class="comment">/***************************************************************************\</span>
02222 <span class="comment">* xxxCBInvertStaticWindow</span>
02223 <span class="comment">*</span>
02224 <span class="comment">* Inverts the static text/picture window associated with the combo</span>
02225 <span class="comment">* box.  Gets its own hdc, if the one given is null.</span>
02226 <span class="comment">*</span>
02227 <span class="comment">* History:</span>
02228 <span class="comment">\***************************************************************************/</span>
02229 
<a name="l02230"></a><a class="code" href="../../d6/d0/usercli_8h.html#a679">02230</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a679">xxxCBInvertStaticWindow</a>(
02231     <a class="code" href="../../d7/d9/structtagCBox.html">PCBOX</a> pcbox,
02232     BOOL fNewSelectionState,  <span class="comment">/* True if inverted else false */</span>
02233     HDC hdc)
02234 {
02235     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> focusSave = pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o11">fFocus</a>;
02236 
02237     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>);
02238 
02239     pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o11">fFocus</a> = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)fNewSelectionState;
02240     <a class="code" href="../../d6/d0/usercli_8h.html#a676">xxxCBInternalUpdateEditWindow</a>(pcbox, hdc);
02241 
02242     pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o11">fFocus</a> = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)focusSave;
02243 }
02244 
02245 <span class="comment">/***************************************************************************\</span>
02246 <span class="comment">* xxxCBUpdateListBoxWindow</span>
02247 <span class="comment">*</span>
02248 <span class="comment">* matches the text in the editcontrol. If fSelectionAlso is false, then we</span>
02249 <span class="comment">* unselect the current listbox selection and just move the caret to the item</span>
02250 <span class="comment">* which is the closest match to the text in the editcontrol.</span>
02251 <span class="comment">*</span>
02252 <span class="comment">* History:</span>
02253 <span class="comment">\***************************************************************************/</span>
02254 
<a name="l02255"></a><a class="code" href="../../d6/d0/usercli_8h.html#a675">02255</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a675">xxxCBUpdateListBoxWindow</a>(
02256     <a class="code" href="../../d7/d9/structtagCBox.html">PCBOX</a> pcbox,
02257     BOOL fSelectionAlso)
02258 {
02259     <span class="keywordtype">int</span> cchText;
02260     <span class="keywordtype">int</span> sItem, sSel;
02261     LPWSTR pText = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02262     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndEdit;
02263     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndList;
02264 
02265     <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02266         <span class="keywordflow">return</span>;
02267     }
02268 
02269     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>);
02270 
02271     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, &amp;tlpwndList);
02272     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>, &amp;tlpwndEdit);
02273 
02274     <span class="comment">/*</span>
02275 <span class="comment">     * +1 for null terminator</span>
02276 <span class="comment">     */</span>
02277 
02278     cchText = (<span class="keywordtype">int</span>)<a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>, WM_GETTEXTLENGTH, 0, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02279 
02280     <span class="keywordflow">if</span> (cchText) {
02281         cchText++;
02282         pText = (LPWSTR)<a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(HEAP_ZERO_MEMORY, cchText*<span class="keyword">sizeof</span>(WCHAR));
02283         <span class="keywordflow">if</span> (pText != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02284             <span class="keywordflow">try</span> {
02285                 <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>, WM_GETTEXT, cchText, (LPARAM)pText, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02286                 sItem = (<span class="keywordtype">int</span>)<a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, LB_FINDSTRING,
02287                         (WPARAM)-1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, (LPARAM)pText, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02288             } finally {
02289                 <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>((HANDLE)pText);
02290             }
02291         }
02292     }
02293     <span class="keywordflow">else</span>
02294         sItem = -1;
02295 
02296     <span class="keywordflow">if</span> (fSelectionAlso) {
02297         sSel = sItem;
02298     } <span class="keywordflow">else</span> {
02299         sSel = -1;
02300     }
02301 
02302     <span class="keywordflow">if</span> (sItem == -1)
02303     {
02304         sItem = 0;
02305 
02306         <span class="comment">//</span>
02307         <span class="comment">// Old apps:  w/ editable combos, selected 1st item in list even if</span>
02308         <span class="comment">// it didn't match text in edit field.  This is not desirable</span>
02309         <span class="comment">// behavior for 4.0 dudes esp. with cancel allowed.  Reason:</span>
02310         <span class="comment">//      (1) User types in text that doesn't match list choices</span>
02311         <span class="comment">//      (2) User drops combo</span>
02312         <span class="comment">//      (3) User pops combo back up</span>
02313         <span class="comment">//      (4) User presses OK in dialog that does stuff w/ combo</span>
02314         <span class="comment">//          contents.</span>
02315         <span class="comment">// In 3.1, when the combo dropped, we'd select the 1st item anyway.</span>
02316         <span class="comment">// So the last CBN_SELCHANGE the owner got would be 0--which is</span>
02317         <span class="comment">// bogus because it really should be -1.  In fact if you type anything</span>
02318         <span class="comment">// into the combo afterwards it will reset itself to -1.</span>
02319         <span class="comment">//</span>
02320         <span class="comment">// 4.0 dudes won't get this bogus 0 selection.</span>
02321         <span class="comment">//</span>
02322         <span class="keywordflow">if</span> (fSelectionAlso &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>))
02323             sSel = 0;
02324     }
02325 
02326 
02327     <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, LB_SETCURSEL, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)sSel, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02328     <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, LB_SETCARETINDEX, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)sItem, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02329     <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, LB_SETTOPINDEX, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)sItem, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02330 
02331     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndEdit);
02332     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndList);
02333 }
02334 
02335 <span class="comment">/***************************************************************************\</span>
02336 <span class="comment">* xxxCBGetFocusHelper</span>
02337 <span class="comment">*</span>
02338 <span class="comment">* Handles getting the focus for the combo box</span>
02339 <span class="comment">*</span>
02340 <span class="comment">* History:</span>
02341 <span class="comment">\***************************************************************************/</span>
02342 
<a name="l02343"></a><a class="code" href="../../d6/d0/usercli_8h.html#a677">02343</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a677">xxxCBGetFocusHelper</a>(
02344     <a class="code" href="../../d7/d9/structtagCBox.html">PCBOX</a> pcbox)
02345 {
02346     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndList;
02347     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndEdit;
02348 
02349     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>);
02350 
02351     <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o11">fFocus</a>)
02352         <span class="keywordflow">return</span>;
02353 
02354     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, &amp;tlpwndList);
02355     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>, &amp;tlpwndEdit);
02356 
02357     <span class="comment">/*</span>
02358 <span class="comment">     * The combo box has gotten the focus for the first time.</span>
02359 <span class="comment">     */</span>
02360 
02361     <span class="comment">/*</span>
02362 <span class="comment">     * First turn on the listbox caret</span>
02363 <span class="comment">     */</span>
02364 
02365     <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o10">CBoxStyle</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a60">SDROPDOWNLIST</a>)
02366        <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, LBCB_CARETON, 0, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02367 
02368     <span class="comment">/*</span>
02369 <span class="comment">     * and select all the text in the editcontrol or static text rectangle.</span>
02370 <span class="comment">     */</span>
02371 
02372     <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o21">fNoEdit</a>) {
02373 
02374         <span class="comment">/*</span>
02375 <span class="comment">         * Invert the static text rectangle</span>
02376 <span class="comment">         */</span>
02377         <a class="code" href="../../d6/d0/usercli_8h.html#a679">xxxCBInvertStaticWindow</a>(pcbox, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, (HDC)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02378     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>) {
02379         UserAssert(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>);
02380         <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>, EM_SETSEL, 0, MAXLONG, !!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a570">WFANSIPROC</a>));
02381     }
02382 
02383     pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o11">fFocus</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02384 
02385     <span class="comment">/*</span>
02386 <span class="comment">     * Notify the parent we have the focus</span>
02387 <span class="comment">     */</span>
02388     <a class="code" href="../../d6/d0/usercli_8h.html#a674">xxxCBNotifyParent</a>(pcbox, CBN_SETFOCUS);
02389 
02390     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndEdit);
02391     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndList);
02392 }
02393 
02394 <span class="comment">/***************************************************************************\</span>
02395 <span class="comment">* xxxCBKillFocusHelper</span>
02396 <span class="comment">*</span>
02397 <span class="comment">* Handles losing the focus for the combo box.</span>
02398 <span class="comment">*</span>
02399 <span class="comment">* History:</span>
02400 <span class="comment">\***************************************************************************/</span>
02401 
<a name="l02402"></a><a class="code" href="../../d6/d0/usercli_8h.html#a678">02402</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a678">xxxCBKillFocusHelper</a>(
02403     <a class="code" href="../../d7/d9/structtagCBox.html">PCBOX</a> pcbox)
02404 {
02405     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndList;
02406     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndEdit;
02407 
02408     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>);
02409 
02410     <span class="keywordflow">if</span> (!pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o11">fFocus</a> || pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02411         <span class="keywordflow">return</span>;
02412 
02413     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, &amp;tlpwndList);
02414     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>, &amp;tlpwndEdit);
02415 
02416     <span class="comment">/*</span>
02417 <span class="comment">     * The combo box is losing the focus.  Send buttonup clicks so that</span>
02418 <span class="comment">     * things release the mouse capture if they have it...  If the</span>
02419 <span class="comment">     * pwndListBox is null, don't do anything.  This occurs if the combo box</span>
02420 <span class="comment">     * is destroyed while it has the focus.</span>
02421 <span class="comment">     */</span>
02422     <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>, WM_LBUTTONUP, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, 0xFFFFFFFFL, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02423      <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a667">xxxCBHideListBoxWindow</a>(pcbox, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>))
02424          <span class="keywordflow">return</span>;
02425 
02426     <span class="comment">/*</span>
02427 <span class="comment">     * Turn off the listbox caret</span>
02428 <span class="comment">     */</span>
02429 
02430     <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o10">CBoxStyle</a> == <a class="code" href="../../d6/d0/usercli_8h.html#a60">SDROPDOWNLIST</a>)
02431        <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, LBCB_CARETOFF, 0, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02432 
02433     <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o21">fNoEdit</a>) {
02434 
02435         <span class="comment">/*</span>
02436 <span class="comment">         * Invert the static text rectangle</span>
02437 <span class="comment">         */</span>
02438         <a class="code" href="../../d6/d0/usercli_8h.html#a679">xxxCBInvertStaticWindow</a>(pcbox, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, (HDC)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02439     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>) {
02440         <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o8">spwndEdit</a>, EM_SETSEL, 0, 0, !!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a570">WFANSIPROC</a>));
02441     }
02442 
02443     pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o11">fFocus</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02444     <a class="code" href="../../d6/d0/usercli_8h.html#a674">xxxCBNotifyParent</a>(pcbox, CBN_KILLFOCUS);
02445 
02446     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndEdit);
02447     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndList);
02448 }
02449 
02450 
02451 <span class="comment">/***************************************************************************\</span>
02452 <span class="comment">* xxxCBGetTextLengthHelper</span>
02453 <span class="comment">*</span>
02454 <span class="comment">* For the combo box without an edit control, returns size of current selected</span>
02455 <span class="comment">* item</span>
02456 <span class="comment">*</span>
02457 <span class="comment">* History:</span>
02458 <span class="comment">\***************************************************************************/</span>
02459 
<a name="l02460"></a><a class="code" href="../../d1/d4/combo_8c.html#a2">02460</a> LONG <a class="code" href="../../d1/d4/combo_8c.html#a2">xxxCBGetTextLengthHelper</a>(
02461     <a class="code" href="../../d7/d9/structtagCBox.html">PCBOX</a> pcbox,
02462     BOOL fAnsi)
02463 {
02464     <span class="keywordtype">int</span> item;
02465     <span class="keywordtype">int</span> cchText;
02466     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndList;
02467 
02468     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, &amp;tlpwndList);
02469     item = (<span class="keywordtype">int</span>)<a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, LB_GETCURSEL, 0, 0, fAnsi);
02470 
02471     <span class="keywordflow">if</span> (item == LB_ERR) {
02472 
02473         <span class="comment">/*</span>
02474 <span class="comment">         * No selection so no text.</span>
02475 <span class="comment">         */</span>
02476         cchText = 0;
02477     } <span class="keywordflow">else</span> {
02478         cchText = (<span class="keywordtype">int</span>)<a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, LB_GETTEXTLEN,
02479                 item, 0, fAnsi);
02480     }
02481 
02482     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndList);
02483 
02484     <span class="keywordflow">return</span> cchText;
02485 }
02486 
02487 <span class="comment">/***************************************************************************\</span>
02488 <span class="comment">* xxxCBGetTextHelper</span>
02489 <span class="comment">*</span>
02490 <span class="comment">* For the combo box without an edit control, copies cbString bytes of the</span>
02491 <span class="comment">* string in the static text box to the buffer given by pString.</span>
02492 <span class="comment">*</span>
02493 <span class="comment">* History:</span>
02494 <span class="comment">\***************************************************************************/</span>
02495 
<a name="l02496"></a><a class="code" href="../../d1/d4/combo_8c.html#a3">02496</a> LONG <a class="code" href="../../d1/d4/combo_8c.html#a3">xxxCBGetTextHelper</a>(
02497     <a class="code" href="../../d7/d9/structtagCBox.html">PCBOX</a> pcbox,
02498     <span class="keywordtype">int</span> cchString,
02499     LPWSTR pString,
02500     BOOL fAnsi)
02501 {
02502     <span class="keywordtype">int</span> item;
02503     <span class="keywordtype">int</span> cchText;
02504     LPWSTR pText;
02505     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dw;
02506     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndList;
02507 
02508     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>);
02509 
02510     <span class="keywordflow">if</span> (!cchString || !pString)
02511         <span class="keywordflow">return</span> 0;
02512 
02513     <span class="comment">/*</span>
02514 <span class="comment">     * Null the buffer to be nice.</span>
02515 <span class="comment">     */</span>
02516     <span class="keywordflow">if</span> (fAnsi) {
02517         *((LPSTR)pString) = 0;
02518     } <span class="keywordflow">else</span> {
02519         *((LPWSTR)pString) = 0;
02520     }
02521 
02522     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, &amp;tlpwndList);
02523     item = (<span class="keywordtype">int</span>)<a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, LB_GETCURSEL, 0, 0, fAnsi);
02524 
02525     <span class="keywordflow">if</span> (item == LB_ERR) {
02526 
02527         <span class="comment">/*</span>
02528 <span class="comment">         * No selection so no text.</span>
02529 <span class="comment">         */</span>
02530         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndList);
02531         <span class="keywordflow">return</span> 0;
02532     }
02533 
02534     cchText = (<span class="keywordtype">int</span>)<a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, LB_GETTEXTLEN, item, 0, fAnsi);
02535 
02536     cchText++;
02537     <span class="keywordflow">if</span> ((cchText &lt;= cchString) ||
02538             (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o0">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a592">WFWIN31COMPAT</a>) &amp;&amp; cchString == 2)) {
02539         <span class="comment">/*</span>
02540 <span class="comment">         * Just do the copy if the given buffer size is large enough to hold</span>
02541 <span class="comment">         * everything.  Or if old 3.0 app.  (Norton used to pass 2 &amp; expect 3</span>
02542 <span class="comment">         * chars including the \0 in 3.0; Bug #7018 win31: vatsanp)</span>
02543 <span class="comment">         */</span>
02544         dw = (<span class="keywordtype">int</span>)<a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, LB_GETTEXT, item,
02545                 (LPARAM)pString, fAnsi);
02546         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndList);
02547         <span class="keywordflow">return</span> dw;
02548     }
02549 
02550     <span class="keywordflow">if</span> (!(pText = (LPWSTR)<a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(HEAP_ZERO_MEMORY, cchText*<span class="keyword">sizeof</span>(WCHAR)))) {
02551 
02552         <span class="comment">/*</span>
02553 <span class="comment">         * Bail.  Not enough memory to chop up the text.</span>
02554 <span class="comment">         */</span>
02555         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndList);
02556         <span class="keywordflow">return</span> 0;
02557     }
02558 
02559     <span class="keywordflow">try</span> {
02560         <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pcbox-&gt;<a class="code" href="../../d7/d9/structtagCBox.html#o9">spwndList</a>, LB_GETTEXT, item, (LPARAM)pText, fAnsi);
02561         <span class="keywordflow">if</span> (fAnsi) {
02562             RtlCopyMemory((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pString, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pText, cchString);
02563             ((LPSTR)pString)[cchString - 1] = 0;
02564         } <span class="keywordflow">else</span> {
02565             RtlCopyMemory((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pString, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pText, cchString * <span class="keyword">sizeof</span>(WCHAR));
02566             ((LPWSTR)pString)[cchString - 1] = 0;
02567         }
02568     } finally {
02569         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>((HANDLE)pText);
02570     }
02571 
02572     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndList);
02573     <span class="keywordflow">return</span> cchString;
02574 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:30 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
